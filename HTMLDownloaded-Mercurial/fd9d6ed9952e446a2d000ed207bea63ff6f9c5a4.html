<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 23806:fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4" />
<meta property="og:url" content="/comm-central/rev/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4" />
<meta property="og:description" content="Bug 1378089 - Part 4. Replace the Bookmarks Manager and the History viewer with the Firefox library. r=IanN" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4">shortlog</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4">files</a> |
changeset |
<a href="/comm-central/raw-rev/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4">raw</a>  | <a href="/comm-central/archive/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1378089">Bug 1378089</a> - Part 4. Replace the Bookmarks Manager and the History viewer with the Firefox library. r=IanN
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#114;&#97;&#110;&#107;&#45;&#82;&#97;&#105;&#110;&#101;&#114;&#32;&#71;&#114;&#97;&#104;&#108;&#32;&#60;&#102;&#114;&#103;&#114;&#97;&#104;&#108;&#64;&#103;&#109;&#120;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 24 Apr 2018 19:29:31 +0200</td></tr>

<tr>
 <td>changeset 23806</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4">fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4</a></td>
</tr>



<tr>
<td>parent 23805</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f000c3a844b1fe4741b8933fccad8832dba85a7a">f000c3a844b1fe4741b8933fccad8832dba85a7a</a>
</td>
</tr>

<tr>
<td>child 23807</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/838853b3bbab23d8bec184368781e2f741b11943">838853b3bbab23d8bec184368781e2f741b11943</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4">14348</a></td></tr>
<tr><td>push user</td><td>frgrahl@gmx.net</td></tr>
<tr><td>push date</td><td class="date age">Tue, 24 Apr 2018 17:31:46 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1ad208ac3369 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1ad208ac3369666fd6923b8856d8f05a9172e364">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1ad208ac3369666fd6923b8856d8f05a9172e364&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1ad208ac3369666fd6923b8856d8f05a9172e364&newProject=comm-central&newRevision=b9a5db2726f3acdf694432d7a182c967d847e5d5&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1ad208ac3369666fd6923b8856d8f05a9172e364&newProject=comm-central&newRevision=b9a5db2726f3acdf694432d7a182c967d847e5d5&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1ad208ac3369666fd6923b8856d8f05a9172e364&newProject=comm-central&newRevision=b9a5db2726f3acdf694432d7a182c967d847e5d5&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28IanN%29&revcount=50">IanN</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1378089">1378089</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1383138">1383138</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1427366">1427366</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1378089">Bug 1378089</a> - Part 4. Replace the Bookmarks Manager and the History viewer with the Firefox library. r=IanN
From Fx 56 up to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1383138">Bug 1383138</a> in m-c to Fx 60 up to 63c152ad62b0 <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1427366">Bug 1427366</a> - Use richlistbox autocomplete by default.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/FIXME-PLACES.TXT">suite/FIXME-PLACES.TXT</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/FIXME-PLACES.TXT">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/FIXME-PLACES.TXT">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/FIXME-PLACES.TXT">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/FIXME-PLACES.TXT">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/FIXME-PLACES.TXT">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/browser-places.js">suite/browser/browser-places.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/browser-places.js">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/browser-places.js">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/browser-places.js">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/browser-places.js">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/browser-places.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/navigator.js">suite/browser/navigator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/navigator.js">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/navigator.js">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/navigator.js">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/navigator.js">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/navigator.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/navigatorOverlay.xul">suite/browser/navigatorOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/navigatorOverlay.xul">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/navigatorOverlay.xul">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/navigatorOverlay.xul">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/navigatorOverlay.xul">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/browser/navigatorOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/nsContextMenu.js">suite/common/nsContextMenu.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/nsContextMenu.js">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/nsContextMenu.js">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/nsContextMenu.js">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/nsContextMenu.js">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/nsContextMenu.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/PlacesUIUtils.jsm">suite/common/places/PlacesUIUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/PlacesUIUtils.jsm">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/PlacesUIUtils.jsm">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/PlacesUIUtils.jsm">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/PlacesUIUtils.jsm">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/PlacesUIUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/bookmarkProperties.js">suite/common/places/content/bookmarkProperties.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/bookmarkProperties.js">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/bookmarkProperties.js">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/bookmarkProperties.js">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/bookmarkProperties.js">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/bookmarkProperties.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/bookmarksPanel.xul">suite/common/places/content/bookmarksPanel.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/bookmarksPanel.xul">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/bookmarksPanel.xul">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/bookmarksPanel.xul">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/bookmarksPanel.xul">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/bookmarksPanel.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/browserPlacesViews.js">suite/common/places/content/browserPlacesViews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/browserPlacesViews.js">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/browserPlacesViews.js">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/browserPlacesViews.js">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/browserPlacesViews.js">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/browserPlacesViews.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/controller.js">suite/common/places/content/controller.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/controller.js">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/controller.js">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/controller.js">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/controller.js">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/controller.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/editBookmarkOverlay.js">suite/common/places/content/editBookmarkOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/editBookmarkOverlay.js">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/editBookmarkOverlay.js">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/editBookmarkOverlay.js">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/editBookmarkOverlay.js">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/editBookmarkOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/editBookmarkOverlay.xul">suite/common/places/content/editBookmarkOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/editBookmarkOverlay.xul">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/editBookmarkOverlay.xul">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/editBookmarkOverlay.xul">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/editBookmarkOverlay.xul">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/editBookmarkOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/history-panel.xul">suite/common/places/content/history-panel.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/history-panel.xul">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/history-panel.xul">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/history-panel.xul">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/history-panel.xul">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/history-panel.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/menu.xml">suite/common/places/content/menu.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/menu.xml">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/menu.xml">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/menu.xml">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/menu.xml">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/menu.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/places.js">suite/common/places/content/places.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/places.js">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/places.js">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/places.js">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/places.js">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/places.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/places.xul">suite/common/places/content/places.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/places.xul">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/places.xul">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/places.xul">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/places.xul">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/places.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/placesOverlay.xul">suite/common/places/content/placesOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/placesOverlay.xul">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/placesOverlay.xul">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/placesOverlay.xul">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/placesOverlay.xul">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/placesOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/sidebarUtils.js">suite/common/places/content/sidebarUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/sidebarUtils.js">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/sidebarUtils.js">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/sidebarUtils.js">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/sidebarUtils.js">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/sidebarUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/tree.xml">suite/common/places/content/tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/tree.xml">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/tree.xml">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/tree.xml">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/tree.xml">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/tree.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/treeView.js">suite/common/places/content/treeView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/treeView.js">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/treeView.js">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/treeView.js">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/treeView.js">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/common/places/content/treeView.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/locales/en-US/chrome/browser/navigator.properties">suite/locales/en-US/chrome/browser/navigator.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/locales/en-US/chrome/browser/navigator.properties">file</a> |
<a href="/comm-central/annotate/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/locales/en-US/chrome/browser/navigator.properties">annotate</a> |
<a href="/comm-central/diff/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/locales/en-US/chrome/browser/navigator.properties">diff</a> |
<a href="/comm-central/comparison/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/locales/en-US/chrome/browser/navigator.properties">comparison</a> |
<a href="/comm-central/log/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4/suite/locales/en-US/chrome/browser/navigator.properties">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/FIXME-PLACES.TXT</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/FIXME-PLACES.TXT</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,5 +1,20 @@</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineplus">+Check:</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+comm-central/mozilla/browser/base/content/nsContextMenu.js</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+suite/common/nsContextMenu.js</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+addBookmarkForFrame: function CM_addBookmarkForFrame() {</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+Not ported yet:</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+Bug 1401238 - Deprecate Recent Bookmarks, and Pocket List from the Bookmarks Menu.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+https://bugzilla.mozilla.org/show_bug.cgi?id=1401238</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+Non working:</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+</span>
<a href="#l1.19"></a><span id="l1.19"> Load in sidebar disabled because of:</span>
<a href="#l1.20"></a><span id="l1.20"> Timestamp: 1/29/2018, 9:56:54 PM</span>
<a href="#l1.21"></a><span id="l1.21"> Error: TypeError: browserWin.openWebPanel is not a function</span>
<a href="#l1.22"></a><span id="l1.22"> Source File: resource:///modules/PlacesUIUtils.jsm</span>
<a href="#l1.23"></a><span id="l1.23"> Line: 1053</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/suite/browser/browser-places.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/suite/browser/browser-places.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> XPCOMUtils.defineLazyScriptGetter(this, [&quot;PlacesToolbar&quot;, &quot;PlacesMenu&quot;,</span>
<a href="#l2.8"></a><span id="l2.8">                                          &quot;PlacesPanelview&quot;, &quot;PlacesPanelMenuView&quot;],</span>
<a href="#l2.9"></a><span id="l2.9">                                   &quot;chrome://communicator/content/places/browserPlacesViews.js&quot;);</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> var StarUI = {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  _itemGuids: -1,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  _itemGuids: null,</span>
<a href="#l2.14"></a><span id="l2.14">   uri: null,</span>
<a href="#l2.15"></a><span id="l2.15">   _batching: false,</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">   _element: function(aID) {</span>
<a href="#l2.18"></a><span id="l2.18">     return document.getElementById(aID);</span>
<a href="#l2.19"></a><span id="l2.19">   },</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">   // Edit-bookmark panel</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -71,38 +71,31 @@ var StarUI = {</span>
<a href="#l2.23"></a><span id="l2.23">   handleEvent: function SU_handleEvent(aEvent) {</span>
<a href="#l2.24"></a><span id="l2.24">     switch (aEvent.type) {</span>
<a href="#l2.25"></a><span id="l2.25">       case &quot;popuphidden&quot;:</span>
<a href="#l2.26"></a><span id="l2.26">         if (aEvent.originalTarget == this.panel) {</span>
<a href="#l2.27"></a><span id="l2.27">           if (!this._element(&quot;editBookmarkPanelContent&quot;).hidden)</span>
<a href="#l2.28"></a><span id="l2.28">             this.quitEditMode();</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30">           this._restoreCommandsState();</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-          this._itemId = -1;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+          let guidsForRemoval = this._itemGuids;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+          this._itemGuids = null;</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+</span>
<a href="#l2.35"></a><span id="l2.35">           if (this._batching) {</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-            PlacesUtils.transactionManager.endBatch(false);</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-            this._batching = false;</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+            this.endBatch();</span>
<a href="#l2.39"></a><span id="l2.39">           }</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41">           switch (this._actionOnHide) {</span>
<a href="#l2.42"></a><span id="l2.42">             case &quot;cancel&quot;: {</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-              PlacesUtils.transactionManager.undoTransaction();</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+              PlacesTransactions.undo().catch(Cu.reportError);</span>
<a href="#l2.45"></a><span id="l2.45">               break;</span>
<a href="#l2.46"></a><span id="l2.46">             }</span>
<a href="#l2.47"></a><span id="l2.47">             case &quot;remove&quot;: {</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-              // Remove all bookmarks for the bookmark's url, this also removes</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-              // the tags for the url.</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-              PlacesUtils.transactionManager.beginBatch(null);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-              let itemIds = PlacesUtils.getBookmarksForURI(this._uriForRemoval);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-              for (let i = 0; i &lt; itemIds.length; i++) {</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-                let txn = new PlacesRemoveItemTransaction(itemIds[i]);</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-                PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-              }</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-              PlacesUtils.transactionManager.endBatch(false);</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-              this._uriForRemoval = null;</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+              PlacesTransactions.Remove(guidsForRemoval)</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+                                .transact().catch(Cu.reportError);</span>
<a href="#l2.60"></a><span id="l2.60">               break;</span>
<a href="#l2.61"></a><span id="l2.61">             }</span>
<a href="#l2.62"></a><span id="l2.62">           }</span>
<a href="#l2.63"></a><span id="l2.63">           this._actionOnHide = &quot;&quot;;</span>
<a href="#l2.64"></a><span id="l2.64">         }</span>
<a href="#l2.65"></a><span id="l2.65">         break;</span>
<a href="#l2.66"></a><span id="l2.66">       case &quot;keypress&quot;:</span>
<a href="#l2.67"></a><span id="l2.67">         if (aEvent.defaultPrevented) {</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineat">@@ -117,73 +110,66 @@ var StarUI = {</span>
<a href="#l2.69"></a><span id="l2.69">           case KeyEvent.DOM_VK_RETURN:</span>
<a href="#l2.70"></a><span id="l2.70">             if (aEvent.target.className == &quot;expander-up&quot; ||</span>
<a href="#l2.71"></a><span id="l2.71">                 aEvent.target.className == &quot;expander-down&quot; ||</span>
<a href="#l2.72"></a><span id="l2.72">                 aEvent.target.id == &quot;editBMPanel_newFolderButton&quot;) {</span>
<a href="#l2.73"></a><span id="l2.73">               //XXX Why is this necessary? The defaultPrevented check should</span>
<a href="#l2.74"></a><span id="l2.74">               //    be enough.</span>
<a href="#l2.75"></a><span id="l2.75">               break;</span>
<a href="#l2.76"></a><span id="l2.76">             }</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-            this.panel.hidePopup();</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+            this.panel.hidePopup(true);</span>
<a href="#l2.79"></a><span id="l2.79">             break;</span>
<a href="#l2.80"></a><span id="l2.80">         }</span>
<a href="#l2.81"></a><span id="l2.81">         break;</span>
<a href="#l2.82"></a><span id="l2.82">     }</span>
<a href="#l2.83"></a><span id="l2.83">   },</span>
<a href="#l2.84"></a><span id="l2.84"> </span>
<a href="#l2.85"></a><span id="l2.85">   _overlayLoaded: false,</span>
<a href="#l2.86"></a><span id="l2.86">   _overlayLoading: false,</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-  async showEditBookmarkPopup(aNode, aAnchorElement, aPosition, aIsNewBookmark) {</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+  async showEditBookmarkPopup(aNode, aAnchorElement, aPosition, aIsNewBookmark, aUrl) {</span>
<a href="#l2.89"></a><span id="l2.89">     // Slow double-clicks (not true double-clicks) shouldn't</span>
<a href="#l2.90"></a><span id="l2.90">     // cause the panel to flicker.</span>
<a href="#l2.91"></a><span id="l2.91">     if (this.panel.state == &quot;showing&quot; ||</span>
<a href="#l2.92"></a><span id="l2.92">         this.panel.state == &quot;open&quot;) {</span>
<a href="#l2.93"></a><span id="l2.93">       return;</span>
<a href="#l2.94"></a><span id="l2.94">     }</span>
<a href="#l2.95"></a><span id="l2.95"> </span>
<a href="#l2.96"></a><span id="l2.96">     this._isNewBookmark = aIsNewBookmark;</span>
<a href="#l2.97"></a><span id="l2.97">     this._uriForRemoval = &quot;&quot;;</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-    // TODO (bug 1131491): Deprecate this once async transactions are enabled</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-    // and the legacy transactions code is gone.</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-    if (typeof(aNode) == &quot;number&quot;) {</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-      let itemId = aNode;</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-      let guid = await PlacesUtils.promiseItemGuid(itemId);</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-      aNode = await PlacesUIUtils.fetchNodeLike(guid);</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-    }</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+    this._itemGuids = null;</span>
<a href="#l2.106"></a><span id="l2.106"> </span>
<a href="#l2.107"></a><span id="l2.107">     // Performance: load the overlay the first time the panel is opened</span>
<a href="#l2.108"></a><span id="l2.108">     // (see bug 392443).</span>
<a href="#l2.109"></a><span id="l2.109">     if (this._overlayLoading)</span>
<a href="#l2.110"></a><span id="l2.110">       return;</span>
<a href="#l2.111"></a><span id="l2.111"> </span>
<a href="#l2.112"></a><span id="l2.112">     if (this._overlayLoaded) {</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-      this._doShowEditBookmarkPanel(aNode, aAnchorElement, aPosition);</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+      await this._doShowEditBookmarkPanel(aNode, aAnchorElement, aPosition, aUrl);</span>
<a href="#l2.115"></a><span id="l2.115">       return;</span>
<a href="#l2.116"></a><span id="l2.116">     }</span>
<a href="#l2.117"></a><span id="l2.117"> </span>
<a href="#l2.118"></a><span id="l2.118">     this._overlayLoading = true;</span>
<a href="#l2.119"></a><span id="l2.119">     document.loadOverlay(</span>
<a href="#l2.120"></a><span id="l2.120">       &quot;chrome://communicator/content/places/editBookmarkOverlay.xul&quot;,</span>
<a href="#l2.121"></a><span id="l2.121">       (aSubject, aTopic, aData) =&gt; {</span>
<a href="#l2.122"></a><span id="l2.122">         // Move the header (star, title, button) into the grid,</span>
<a href="#l2.123"></a><span id="l2.123">         // so that it aligns nicely with the other items (bug 484022).</span>
<a href="#l2.124"></a><span id="l2.124">         let header = this._element(&quot;editBookmarkPanelHeader&quot;);</span>
<a href="#l2.125"></a><span id="l2.125">         let rows = this._element(&quot;editBookmarkPanelGrid&quot;).lastChild;</span>
<a href="#l2.126"></a><span id="l2.126">         rows.insertBefore(header, rows.firstChild);</span>
<a href="#l2.127"></a><span id="l2.127">         header.hidden = false;</span>
<a href="#l2.128"></a><span id="l2.128"> </span>
<a href="#l2.129"></a><span id="l2.129">         this._overlayLoading = false;</span>
<a href="#l2.130"></a><span id="l2.130">         this._overlayLoaded = true;</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-        this._doShowEditBookmarkPanel(aNode, aAnchorElement, aPosition);</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+        this._doShowEditBookmarkPanel(aNode, aAnchorElement, aPosition, aUrl);</span>
<a href="#l2.133"></a><span id="l2.133">       }</span>
<a href="#l2.134"></a><span id="l2.134">     );</span>
<a href="#l2.135"></a><span id="l2.135">   },</span>
<a href="#l2.136"></a><span id="l2.136"> </span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-  _doShowEditBookmarkPanel:</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-  function SU__doShowEditBookmarkPanel(aNode, aAnchorElement, aPosition) {</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+  async _doShowEditBookmarkPanel(aNode, aAnchorElement, aPosition, aUrl) {</span>
<a href="#l2.140"></a><span id="l2.140">     if (this.panel.state != &quot;closed&quot;)</span>
<a href="#l2.141"></a><span id="l2.141">       return;</span>
<a href="#l2.142"></a><span id="l2.142"> </span>
<a href="#l2.143"></a><span id="l2.143">     this._blockCommands(); // un-done in the popuphiding handler</span>
<a href="#l2.144"></a><span id="l2.144"> </span>
<a href="#l2.145"></a><span id="l2.145">     // Set panel title:</span>
<a href="#l2.146"></a><span id="l2.146">     // if we are batching, i.e. the bookmark has been added now,</span>
<a href="#l2.147"></a><span id="l2.147">     // then show Page Bookmarked, else if the bookmark did already exist,</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineat">@@ -193,22 +179,27 @@ var StarUI = {</span>
<a href="#l2.149"></a><span id="l2.149">         gNavigatorBundle.getString(&quot;editBookmarkPanel.pageBookmarkedTitle&quot;) :</span>
<a href="#l2.150"></a><span id="l2.150">         gNavigatorBundle.getString(&quot;editBookmarkPanel.editBookmarkTitle&quot;);</span>
<a href="#l2.151"></a><span id="l2.151"> </span>
<a href="#l2.152"></a><span id="l2.152">     this._element(&quot;editBookmarkPanelBottomButtons&quot;).hidden = false;</span>
<a href="#l2.153"></a><span id="l2.153">     this._element(&quot;editBookmarkPanelContent&quot;).hidden = false;</span>
<a href="#l2.154"></a><span id="l2.154"> </span>
<a href="#l2.155"></a><span id="l2.155">     // The label of the remove button differs if the URI is bookmarked</span>
<a href="#l2.156"></a><span id="l2.156">     // multiple times.</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-    let bookmarks = PlacesUtils.getBookmarksForURI(gBrowser.currentURI);</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+    this._itemGuids = [];</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+    await PlacesUtils.bookmarks.fetch({url: aUrl},</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+      bookmark =&gt; this._itemGuids.push(bookmark.guid));</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+</span>
<a href="#l2.163"></a><span id="l2.163">     let forms = gNavigatorBundle.getString(&quot;editBookmark.removeBookmarks.label&quot;);</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-    let label = PluralForm.get(bookmarks.length, forms).replace(&quot;#1&quot;, bookmarks.length);</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+    let bookmarksCount = this._itemGuids.length;</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+    let label = PluralForm.get(bookmarksCount, forms)</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+                          .replace(&quot;#1&quot;, bookmarksCount);</span>
<a href="#l2.168"></a><span id="l2.168">     this._element(&quot;editBookmarkPanelRemoveButton&quot;).label = label;</span>
<a href="#l2.169"></a><span id="l2.169"> </span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-    this._itemId = aNode.itemId;</span>
<a href="#l2.171"></a><span id="l2.171">     this.beginBatch();</span>
<a href="#l2.172"></a><span id="l2.172"> </span>
<a href="#l2.173"></a><span id="l2.173">     let onPanelReady = fn =&gt; {</span>
<a href="#l2.174"></a><span id="l2.174">       let target = this.panel;</span>
<a href="#l2.175"></a><span id="l2.175">       if (target.parentNode) {</span>
<a href="#l2.176"></a><span id="l2.176">         // By targeting the panel's parent and using a capturing listener, we</span>
<a href="#l2.177"></a><span id="l2.177">         // can have our listener called before others waiting for the panel to</span>
<a href="#l2.178"></a><span id="l2.178">         // be shown (which probably expect the panel to be fully initialized)</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineat">@@ -218,17 +209,16 @@ var StarUI = {</span>
<a href="#l2.180"></a><span id="l2.180">         fn();</span>
<a href="#l2.181"></a><span id="l2.181">       }, {&quot;capture&quot;: true, &quot;once&quot;: true});</span>
<a href="#l2.182"></a><span id="l2.182">     };</span>
<a href="#l2.183"></a><span id="l2.183">     gEditItemOverlay.initPanel({ node: aNode,</span>
<a href="#l2.184"></a><span id="l2.184">                                  onPanelReady,</span>
<a href="#l2.185"></a><span id="l2.185">                                  hiddenRows: [&quot;description&quot;, &quot;location&quot;,</span>
<a href="#l2.186"></a><span id="l2.186">                                               &quot;loadInSidebar&quot;, &quot;keyword&quot;],</span>
<a href="#l2.187"></a><span id="l2.187">                                  focusedElement: &quot;preferred&quot;});</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-</span>
<a href="#l2.189"></a><span id="l2.189">     this.panel.openPopup(aAnchorElement, aPosition);</span>
<a href="#l2.190"></a><span id="l2.190">   },</span>
<a href="#l2.191"></a><span id="l2.191"> </span>
<a href="#l2.192"></a><span id="l2.192">   panelShown:</span>
<a href="#l2.193"></a><span id="l2.193">   function SU_panelShown(aEvent) {</span>
<a href="#l2.194"></a><span id="l2.194">     if (aEvent.target == this.panel) {</span>
<a href="#l2.195"></a><span id="l2.195">       if (!this._element(&quot;editBookmarkPanelContent&quot;).hidden) {</span>
<a href="#l2.196"></a><span id="l2.196">         let fieldToFocus = &quot;editBMPanel_&quot; +</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineat">@@ -256,169 +246,87 @@ var StarUI = {</span>
<a href="#l2.198"></a><span id="l2.198">   },</span>
<a href="#l2.199"></a><span id="l2.199"> </span>
<a href="#l2.200"></a><span id="l2.200">   cancelButtonOnCommand: function SU_cancelButtonOnCommand() {</span>
<a href="#l2.201"></a><span id="l2.201">     this._actionOnHide = &quot;cancel&quot;;</span>
<a href="#l2.202"></a><span id="l2.202">     this.panel.hidePopup();</span>
<a href="#l2.203"></a><span id="l2.203">   },</span>
<a href="#l2.204"></a><span id="l2.204"> </span>
<a href="#l2.205"></a><span id="l2.205">   removeBookmarkButtonCommand: function SU_removeBookmarkButtonCommand() {</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-    this._uriForRemoval = PlacesUtils.bookmarks.getBookmarkURI(this._itemId);</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+    this._removeBookmarksOnPopupHidden = true;</span>
<a href="#l2.208"></a><span id="l2.208">     this._actionOnHide = &quot;remove&quot;;</span>
<a href="#l2.209"></a><span id="l2.209">     this.panel.hidePopup();</span>
<a href="#l2.210"></a><span id="l2.210">   },</span>
<a href="#l2.211"></a><span id="l2.211"> </span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-  beginBatch: function SU_beginBatch() {</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-    if (!this._batching) {</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-      PlacesUtils.transactionManager.beginBatch(null);</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-      this._batching = true;</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-    }</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-  }</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-}</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+  _batchBlockingDeferred: null,</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+  beginBatch() {</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+    if (this._batching)</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+      return;</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+    this._batchBlockingDeferred = PromiseUtils.defer();</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+    PlacesTransactions.batch(async () =&gt; {</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+      await this._batchBlockingDeferred.promise;</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+    });</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+    this._batching = true;</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+  },</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+  endBatch() {</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+    if (!this._batching)</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineplus">+      return;</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineplus">+</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+    this._batchBlockingDeferred.resolve();</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+    this._batchBlockingDeferred = null;</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+    this._batching = false;</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+  },</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+};</span>
<a href="#l2.239"></a><span id="l2.239"> </span>
<a href="#l2.240"></a><span id="l2.240"> var PlacesCommandHook = {</span>
<a href="#l2.241"></a><span id="l2.241"> </span>
<a href="#l2.242"></a><span id="l2.242">   /**</span>
<a href="#l2.243"></a><span id="l2.243">    * Adds a bookmark to the page loaded in the given browser using the</span>
<a href="#l2.244"></a><span id="l2.244">    * properties dialog.</span>
<a href="#l2.245"></a><span id="l2.245">    *</span>
<a href="#l2.246"></a><span id="l2.246">    * @param aBrowser</span>
<a href="#l2.247"></a><span id="l2.247">    *        a &lt;browser&gt; element.</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-   * @param [optional] aParent</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-   *        The folder in which to create a new bookmark if the page loaded in</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-   *        aBrowser isn't bookmarked yet, defaults to the unfiled root.</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-   */</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-  bookmarkPageAs: function PCH_bookmarkPageAs(aBrowser, aParent) {</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-    var uri = aBrowser.currentURI;</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-    var webNav = aBrowser.webNavigation;</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-    var url = webNav.currentURI;</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-    var title;</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-    var description;</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineminus">-    try {</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-      title = webNav.document.title || url.spec;</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-      description = PlacesUIUtils.getDescriptionFromDocument(webNav.document);</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-    }</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-    catch (e) { }</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-    var parent = aParent || PlacesUtils.bookmarksMenuFolderId;</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-    var insertPoint = new InsertionPoint(parent,</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-                                         PlacesUtils.bookmarks.DEFAULT_INDEX);</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-    var hiddenRows = [];</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-    PlacesUIUtils.showAddBookmarkUI(uri, title, description, insertPoint, true,</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-                                    null, null, null, null, hiddenRows);</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-  },</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">-</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-  /**</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">-   * Adds a bookmark to the page loaded in the given browser.</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineminus">-   *</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineminus">-   * @param aBrowser</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-   *        a &lt;browser&gt; element.</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-   * @param [optional] aParent</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-   *        The folder in which to create a new bookmark if the page loaded in</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-   *        aBrowser isn't bookmarked yet, defaults to the unfiled root.</span>
<a href="#l2.281"></a><span id="l2.281">    * @param [optional] aShowEditUI</span>
<a href="#l2.282"></a><span id="l2.282">    *        whether or not to show the edit-bookmark UI for the bookmark item</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+   * @param [optional] aUrl</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+   *        Option to provide a URL to bookmark rather than the current page</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineplus">+   * @param [optional] aTitle</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+   *        Option to provide a title for a bookmark to use rather than the</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+   *        getting the current page's title</span>
<a href="#l2.288"></a><span id="l2.288">    */</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-  async bookmarkPage(aBrowser, aParent, aShowEditUI) {</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-    if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineminus">-      await this._bookmarkPagePT(aBrowser, aParent, aShowEditUI);</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineminus">-      return;</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-    }</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineminus">-    var uri = aBrowser.currentURI;</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineminus">-    var itemId = PlacesUtils.getMostRecentBookmarkForURI(uri);</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineminus">-    let isNewBookmark = itemId == -1;</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineminus">-    if (isNewBookmark) {</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineminus">-      // Bug 1148838 - Make this code work for full page plugins.</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineminus">-      var title;</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineminus">-      var description;</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineminus">-      var charset;</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineminus">-</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-      let docInfo = await this._getPageDetails(aBrowser);</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-      try {</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-        title = docInfo.isErrorPage ? PlacesUtils.history.getPageTitle(uri)</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-                                    : aBrowser.contentTitle;</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineminus">-        title = title || uri.spec;</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineminus">-        description = docInfo.description;</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineminus">-        charset = aBrowser.characterSet;</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-      } catch (e) { }</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineminus">-</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineminus">-      if (aShowEditUI) {</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineminus">-        // If we bookmark the page here but open right into a cancelable</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-        // state (i.e. new bookmark in Library), start batching here so</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineminus">-        // all of the actions can be undone in a single undo step.</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineminus">-        StarUI.beginBatch();</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineminus">-      }</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineminus">-</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineminus">-      var parent = aParent !== undefined ?</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineminus">-                   aParent : PlacesUtils.unfiledBookmarksFolderId;</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineminus">-      var descAnno = { name: PlacesUIUtils.DESCRIPTION_ANNO, value: description };</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineminus">-      var txn = new PlacesCreateBookmarkTransaction(uri, parent,</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineminus">-                                                    PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineminus">-                                                    title, null, [descAnno]);</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineminus">-      itemId = txn.item.id;</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineminus">-      // Set the character-set.</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-      if (charset &amp;&amp; !PrivateBrowsingUtils.isBrowserPrivate(aBrowser))</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-        PlacesUtils.setCharsetForURI(uri, charset);</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineminus">-    }</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineminus">-</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-    // If it was not requested to open directly in &quot;edit&quot; mode, we are done.</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-    if (!aShowEditUI)</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-      return;</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineminus">-</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineminus">-    // Dock the panel to the star icon when possible, otherwise dock</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineminus">-    // it to the content area.</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineminus">-    if (aBrowser.contentWindow == window.content) {</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineminus">-      let ubIcons = aBrowser.ownerDocument.getElementById(&quot;urlbar-icons&quot;);</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineminus">-      if (ubIcons) {</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineminus">-        await StarUI.showEditBookmarkPopup(itemId, ubIcons,</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineminus">-                                           &quot;bottomcenter topright&quot;,</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineminus">-                                           isNewBookmark);</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineminus">-        return;</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineminus">-      }</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineminus">-    }</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineminus">-</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineminus">-    await StarUI.showEditBookmarkPopup(itemId, aBrowser, &quot;overlap&quot;,</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineminus">-                                       isNewBookmark);</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineminus">-  },</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">-</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineminus">-  // TODO: Replace bookmarkPage code with this function once legacy</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineminus">-  // transactions are removed.</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineminus">-  async _bookmarkPagePT(aBrowser, aParentId, aShowEditUI) {</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineminus">-    let url = new URL(aBrowser.currentURI.spec);</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineplus">+  async bookmarkPage(aBrowser, aShowEditUI, aUrl = null, aTitle = null) {</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineplus">+    // If aUrl is provided, we want to bookmark that url rather than the</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineplus">+    // the current page</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineplus">+    let url = aUrl ? new URL(aUrl) : new URL(aBrowser.currentURI.spec);</span>
<a href="#l2.362"></a><span id="l2.362">     let info = await PlacesUtils.bookmarks.fetch({ url });</span>
<a href="#l2.363"></a><span id="l2.363">     let isNewBookmark = !info;</span>
<a href="#l2.364"></a><span id="l2.364">     if (!info) {</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-      let parentGuid = aParentId !== undefined ?</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineminus">-                         await PlacesUtils.promiseItemGuid(aParentId) :</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineminus">-                         PlacesUtils.bookmarks.unfiledGuid;</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineplus">+      let parentGuid = PlacesUtils.bookmarks.unfiledGuid;</span>
<a href="#l2.369"></a><span id="l2.369">       info = { url, parentGuid };</span>
<a href="#l2.370"></a><span id="l2.370">       // Bug 1148838 - Make this code work for full page plugins.</span>
<a href="#l2.371"></a><span id="l2.371">       let description = null;</span>
<a href="#l2.372"></a><span id="l2.372">       let charset = null;</span>
<a href="#l2.373"></a><span id="l2.373"> </span>
<a href="#l2.374"></a><span id="l2.374" class="difflineminus">-      let docInfo = await this._getPageDetails(aBrowser);</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+      let docInfo = aUrl ? {} : await this._getPageDetails(aBrowser);</span>
<a href="#l2.376"></a><span id="l2.376"> </span>
<a href="#l2.377"></a><span id="l2.377">       try {</span>
<a href="#l2.378"></a><span id="l2.378">         if (docInfo.isErrorPage) {</span>
<a href="#l2.379"></a><span id="l2.379">           let entry = await PlacesUtils.history.fetch(aBrowser.currentURI);</span>
<a href="#l2.380"></a><span id="l2.380">           if (entry) {</span>
<a href="#l2.381"></a><span id="l2.381">             info.title = entry.title;</span>
<a href="#l2.382"></a><span id="l2.382">           }</span>
<a href="#l2.383"></a><span id="l2.383">         } else {</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineminus">-          info.title = aBrowser.contentTitle;</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+          info.title = aTitle || aBrowser.contentTitle;</span>
<a href="#l2.386"></a><span id="l2.386">         }</span>
<a href="#l2.387"></a><span id="l2.387">         info.title = info.title || url.href;</span>
<a href="#l2.388"></a><span id="l2.388">         description = docInfo.description;</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineminus">-        charset = aBrowser.characterSet;</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+        charset = aUrl ? null : aBrowser.characterSet;</span>
<a href="#l2.391"></a><span id="l2.391">       } catch (e) {</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-        Cu..reportError(e);</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+        Cu.reportError(e);</span>
<a href="#l2.394"></a><span id="l2.394">       }</span>
<a href="#l2.395"></a><span id="l2.395"> </span>
<a href="#l2.396"></a><span id="l2.396">       if (aShowEditUI &amp;&amp; isNewBookmark) {</span>
<a href="#l2.397"></a><span id="l2.397">         // If we bookmark the page here but open right into a cancelable</span>
<a href="#l2.398"></a><span id="l2.398">         // state (i.e. new bookmark in Library), start batching here so</span>
<a href="#l2.399"></a><span id="l2.399">         // all of the actions can be undone in a single undo step.</span>
<a href="#l2.400"></a><span id="l2.400">         StarUI.beginBatch();</span>
<a href="#l2.401"></a><span id="l2.401">       }</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineat">@@ -443,118 +351,113 @@ var PlacesCommandHook = {</span>
<a href="#l2.403"></a><span id="l2.403"> </span>
<a href="#l2.404"></a><span id="l2.404">     // Dock the panel to the star icon when possible, otherwise dock</span>
<a href="#l2.405"></a><span id="l2.405">     // it to the content area.</span>
<a href="#l2.406"></a><span id="l2.406">     if (aBrowser.contentWindow == window.content) {</span>
<a href="#l2.407"></a><span id="l2.407">       let ubIcons = aBrowser.ownerDocument.getElementById(&quot;urlbar-icons&quot;);</span>
<a href="#l2.408"></a><span id="l2.408">       if (ubIcons) {</span>
<a href="#l2.409"></a><span id="l2.409">         await StarUI.showEditBookmarkPopup(node, ubIcons,</span>
<a href="#l2.410"></a><span id="l2.410">                                            &quot;bottomcenter topright&quot;,</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineminus">-                                           isNewBookmark);</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineplus">+                                           isNewBookmark, url);</span>
<a href="#l2.413"></a><span id="l2.413">         return;</span>
<a href="#l2.414"></a><span id="l2.414">       }</span>
<a href="#l2.415"></a><span id="l2.415">     }</span>
<a href="#l2.416"></a><span id="l2.416"> </span>
<a href="#l2.417"></a><span id="l2.417">     await StarUI.showEditBookmarkPopup(node, aBrowser, &quot;overlap&quot;,</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineminus">-                                       isNewBookmark);</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineplus">+                                       isNewBookmark, url);</span>
<a href="#l2.420"></a><span id="l2.420">   },</span>
<a href="#l2.421"></a><span id="l2.421"> </span>
<a href="#l2.422"></a><span id="l2.422">   _getPageDetails(browser) {</span>
<a href="#l2.423"></a><span id="l2.423">     return new Promise(resolve =&gt; {</span>
<a href="#l2.424"></a><span id="l2.424">       let mm = browser.messageManager;</span>
<a href="#l2.425"></a><span id="l2.425">       mm.addMessageListener(&quot;Bookmarks:GetPageDetails:Result&quot;, function listener(msg) {</span>
<a href="#l2.426"></a><span id="l2.426">         mm.removeMessageListener(&quot;Bookmarks:GetPageDetails:Result&quot;, listener);</span>
<a href="#l2.427"></a><span id="l2.427">         resolve(msg.data);</span>
<a href="#l2.428"></a><span id="l2.428">       });</span>
<a href="#l2.429"></a><span id="l2.429"> </span>
<a href="#l2.430"></a><span id="l2.430" class="difflineminus">-      mm.sendAsyncMessage(&quot;Bookmarks:GetPageDetails&quot;, { })</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineplus">+      mm.sendAsyncMessage(&quot;Bookmarks:GetPageDetails&quot;, { });</span>
<a href="#l2.432"></a><span id="l2.432">     });</span>
<a href="#l2.433"></a><span id="l2.433">   },</span>
<a href="#l2.434"></a><span id="l2.434"> </span>
<a href="#l2.435"></a><span id="l2.435">   /**</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineminus">-   * Adds a bookmark to the page loaded in the current tab.</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineminus">-   */</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineminus">-  bookmarkCurrentPage: function PCH_bookmarkCurrentPage(aShowEditUI, aParent) {</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineminus">-    this.bookmarkPage(gBrowser.selectedBrowser, aParent, aShowEditUI)</span>
<a href="#l2.440"></a><span id="l2.440" class="difflineminus">-        .catch(Cu..reportError);</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineminus">-  },</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineminus">-</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineminus">-  /**</span>
<a href="#l2.444"></a><span id="l2.444">    * Adds a bookmark to the page targeted by a link.</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineminus">-   * @param aParent</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineplus">+   * @param parentId</span>
<a href="#l2.447"></a><span id="l2.447">    *        The folder in which to create a new bookmark if aURL isn't</span>
<a href="#l2.448"></a><span id="l2.448">    *        bookmarked.</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineminus">-   * @param aURL (string)</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineplus">+   * @param url (string)</span>
<a href="#l2.451"></a><span id="l2.451">    *        the address of the link target</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineminus">-   * @param aTitle</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineplus">+   * @param title</span>
<a href="#l2.454"></a><span id="l2.454">    *        The link text</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineminus">-   * @param [optional] aDescription</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineplus">+   * @param [optional] description</span>
<a href="#l2.457"></a><span id="l2.457">    *        The linked page description, if available</span>
<a href="#l2.458"></a><span id="l2.458">    */</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineminus">-  async bookmarkLink(aParentId, aURL, aTitle, aDescription = &quot;&quot;) {</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineminus">-    let node = await PlacesUIUtils.fetchNodeLike({ url: aURL });</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineminus">-    if (node) {</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineminus">-      PlacesUIUtils.showBookmarkDialog({ action: &quot;edit&quot;,</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineminus">-                                         node</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineminus">-                                       }, window.top);</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineplus">+  async bookmarkLink(parentId, url, title, description = &quot;&quot;) {</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineplus">+    let bm = await PlacesUtils.bookmarks.fetch({url});</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineplus">+    if (bm) {</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineplus">+      let node = await PlacesUIUtils.promiseNodeLikeFromFetchInfo(bm);</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineplus">+      PlacesUIUtils.showBookmarkDialog({ action: &quot;edit&quot;, node },</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineplus">+                                       window.top);</span>
<a href="#l2.471"></a><span id="l2.471">       return;</span>
<a href="#l2.472"></a><span id="l2.472">     }</span>
<a href="#l2.473"></a><span id="l2.473"> </span>
<a href="#l2.474"></a><span id="l2.474" class="difflineminus">-    let ip = new InsertionPoint(aParentId,</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineminus">-                                PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineminus">-                                Ci.nsITreeView.DROP_ON);</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineplus">+    let parentGuid = parentId == PlacesUtils.bookmarksMenuFolderId ?</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineplus">+                       PlacesUtils.bookmarks.menuGuid :</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineplus">+                       await PlacesUtils.promiseItemGuid(parentId);</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineplus">+    let defaultInsertionPoint = new InsertionPoint({ parentId, parentGuid });</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineplus">+</span>
<a href="#l2.482"></a><span id="l2.482">     PlacesUIUtils.showBookmarkDialog({ action: &quot;add&quot;,</span>
<a href="#l2.483"></a><span id="l2.483">                                        type: &quot;bookmark&quot;,</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineminus">-                                       uri: makeURI(aURL),</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineminus">-                                       title: aTitle,</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineminus">-                                       description: aDescription,</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineminus">-                                       defaultInsertionPoint: ip,</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineplus">+                                       uri: makeURI(url),</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineplus">+                                       title,</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineplus">+                                       description,</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineplus">+                                       defaultInsertionPoint,</span>
<a href="#l2.492"></a><span id="l2.492">                                        hiddenRows: [ &quot;description&quot;,</span>
<a href="#l2.493"></a><span id="l2.493">                                                      &quot;location&quot;,</span>
<a href="#l2.494"></a><span id="l2.494">                                                      &quot;loadInSidebar&quot;,</span>
<a href="#l2.495"></a><span id="l2.495">                                                      &quot;keyword&quot; ]</span>
<a href="#l2.496"></a><span id="l2.496">                                      }, window.top);</span>
<a href="#l2.497"></a><span id="l2.497">   },</span>
<a href="#l2.498"></a><span id="l2.498"> </span>
<a href="#l2.499"></a><span id="l2.499">   /**</span>
<a href="#l2.500"></a><span id="l2.500">    * List of nsIURI objects characterizing the tabs currently open in the</span>
<a href="#l2.501"></a><span id="l2.501">    * browser. The URIs will be in the order in which their</span>
<a href="#l2.502"></a><span id="l2.502">    * corresponding tabs appeared and duplicates are discarded.</span>
<a href="#l2.503"></a><span id="l2.503">    */</span>
<a href="#l2.504"></a><span id="l2.504">   get uniqueCurrentPages() {</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineminus">-    var tabList = [];</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineminus">-    var seenURIs = {};</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineminus">-</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineminus">-    var browsers = gBrowser.browsers;</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineminus">-    for (var i = 0; i &lt; browsers.length; ++i) {</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineminus">-      let uri = browsers[i].currentURI;</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineplus">+    let seenURIs = {};</span>
<a href="#l2.512"></a><span id="l2.512" class="difflineplus">+    let URIs = [];</span>
<a href="#l2.513"></a><span id="l2.513"> </span>
<a href="#l2.514"></a><span id="l2.514" class="difflineminus">-      // skip redundant entries</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineminus">-      if (uri.spec in seenURIs)</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineminus">-        continue;</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineplus">+    gBrowser.tabs.forEach(tab =&gt; {</span>
<a href="#l2.518"></a><span id="l2.518" class="difflineplus">+      let browser = tab.linkedBrowser;</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineplus">+      let uri = browser.currentURI;</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineplus">+      // contentTitle is usually empty.</span>
<a href="#l2.521"></a><span id="l2.521" class="difflineplus">+      let title = browser.contentTitle || tab.label;</span>
<a href="#l2.522"></a><span id="l2.522" class="difflineplus">+      let spec = uri.spec;</span>
<a href="#l2.523"></a><span id="l2.523" class="difflineplus">+      if (!(spec in seenURIs)) {</span>
<a href="#l2.524"></a><span id="l2.524" class="difflineplus">+        // add to the set of seen URIs</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineplus">+        seenURIs[uri.spec] = null;</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineplus">+        URIs.push({ uri, title });</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineplus">+      }</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineplus">+    });</span>
<a href="#l2.529"></a><span id="l2.529"> </span>
<a href="#l2.530"></a><span id="l2.530" class="difflineminus">-      // add to the set of seen URIs</span>
<a href="#l2.531"></a><span id="l2.531" class="difflineminus">-      seenURIs[uri.spec] = null;</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineminus">-      tabList.push(uri);</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineminus">-    }</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineminus">-    return tabList;</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineplus">+    return URIs;</span>
<a href="#l2.536"></a><span id="l2.536">   },</span>
<a href="#l2.537"></a><span id="l2.537"> </span>
<a href="#l2.538"></a><span id="l2.538">   /**</span>
<a href="#l2.539"></a><span id="l2.539">    * Adds a folder with bookmarks to all of the currently open tabs in this</span>
<a href="#l2.540"></a><span id="l2.540">    * window.</span>
<a href="#l2.541"></a><span id="l2.541">    */</span>
<a href="#l2.542"></a><span id="l2.542">   bookmarkCurrentPages: function PCH_bookmarkCurrentPages() {</span>
<a href="#l2.543"></a><span id="l2.543">     let pages = this.uniqueCurrentPages;</span>
<a href="#l2.544"></a><span id="l2.544">     if (pages.length &gt; 1) {</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineminus">-    PlacesUIUtils.showBookmarkDialog({ action: &quot;add&quot;,</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineminus">-                                       type: &quot;folder&quot;,</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineminus">-                                       URIList: pages,</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineminus">-                                       hiddenRows: [ &quot;description&quot; ]</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineminus">-                                     }, window);</span>
<a href="#l2.550"></a><span id="l2.550" class="difflineplus">+      PlacesUIUtils.showBookmarkDialog({ action: &quot;add&quot;,</span>
<a href="#l2.551"></a><span id="l2.551" class="difflineplus">+                                         type: &quot;folder&quot;,</span>
<a href="#l2.552"></a><span id="l2.552" class="difflineplus">+                                         URIList: pages,</span>
<a href="#l2.553"></a><span id="l2.553" class="difflineplus">+                                         hiddenRows: [ &quot;description&quot; ]</span>
<a href="#l2.554"></a><span id="l2.554" class="difflineplus">+                                       }, window);</span>
<a href="#l2.555"></a><span id="l2.555">     }</span>
<a href="#l2.556"></a><span id="l2.556">   },</span>
<a href="#l2.557"></a><span id="l2.557"> </span>
<a href="#l2.558"></a><span id="l2.558">   /**</span>
<a href="#l2.559"></a><span id="l2.559">    * Updates disabled state for the &quot;Bookmark All Tabs&quot; command.</span>
<a href="#l2.560"></a><span id="l2.560">    */</span>
<a href="#l2.561"></a><span id="l2.561">   updateBookmarkAllTabsCommand:</span>
<a href="#l2.562"></a><span id="l2.562">   function PCH_updateBookmarkAllTabsCommand() {</span>
<a href="#l2.563"></a><span id="l2.563" class="difflineat">@@ -573,19 +476,20 @@ var PlacesCommandHook = {</span>
<a href="#l2.564"></a><span id="l2.564">    * @param     url</span>
<a href="#l2.565"></a><span id="l2.565">    *            The nsIURI of the page the feed was attached to</span>
<a href="#l2.566"></a><span id="l2.566">    * @title     title</span>
<a href="#l2.567"></a><span id="l2.567">    *            The title of the feed. Optional.</span>
<a href="#l2.568"></a><span id="l2.568">    * @subtitle  subtitle</span>
<a href="#l2.569"></a><span id="l2.569">    *            A short description of the feed. Optional.</span>
<a href="#l2.570"></a><span id="l2.570">    */</span>
<a href="#l2.571"></a><span id="l2.571">   async addLiveBookmark(url, feedTitle, feedSubtitle) {</span>
<a href="#l2.572"></a><span id="l2.572" class="difflineminus">-    let toolbarIP = new InsertionPoint(PlacesUtils.toolbarFolderId,</span>
<a href="#l2.573"></a><span id="l2.573" class="difflineminus">-                                       PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l2.574"></a><span id="l2.574" class="difflineminus">-                                       Ci.nsITreeView.DROP_ON);</span>
<a href="#l2.575"></a><span id="l2.575" class="difflineplus">+    let toolbarIP = new InsertionPoint({</span>
<a href="#l2.576"></a><span id="l2.576" class="difflineplus">+      parentId: PlacesUtils.toolbarFolderId,</span>
<a href="#l2.577"></a><span id="l2.577" class="difflineplus">+      parentGuid: PlacesUtils.bookmarks.toolbarGuid</span>
<a href="#l2.578"></a><span id="l2.578" class="difflineplus">+    });</span>
<a href="#l2.579"></a><span id="l2.579"> </span>
<a href="#l2.580"></a><span id="l2.580">     let feedURI = makeURI(url);</span>
<a href="#l2.581"></a><span id="l2.581">     let title = feedTitle || gBrowser.contentTitle;</span>
<a href="#l2.582"></a><span id="l2.582">     let description = feedSubtitle;</span>
<a href="#l2.583"></a><span id="l2.583">     if (!description) {</span>
<a href="#l2.584"></a><span id="l2.584">       description = (await this._getPageDetails(gBrowser.selectedBrowser)).description;</span>
<a href="#l2.585"></a><span id="l2.585">     }</span>
<a href="#l2.586"></a><span id="l2.586"> </span>
<a href="#l2.587"></a><span id="l2.587" class="difflineat">@@ -631,32 +535,55 @@ var BookmarksEventHandler = {</span>
<a href="#l2.588"></a><span id="l2.588">    * Handler for click event for an item in the bookmarks toolbar or menu.</span>
<a href="#l2.589"></a><span id="l2.589">    * Menus and submenus from the folder buttons bubble up to this handler.</span>
<a href="#l2.590"></a><span id="l2.590">    * Left-click is handled in the onCommand function.</span>
<a href="#l2.591"></a><span id="l2.591">    * When items are middle-clicked (or clicked with modifier), open in tabs.</span>
<a href="#l2.592"></a><span id="l2.592">    * If the click came through a menu, close the menu.</span>
<a href="#l2.593"></a><span id="l2.593">    * @param aEvent</span>
<a href="#l2.594"></a><span id="l2.594">    *        DOMEvent for the click</span>
<a href="#l2.595"></a><span id="l2.595">    */</span>
<a href="#l2.596"></a><span id="l2.596" class="difflineplus">+</span>
<a href="#l2.597"></a><span id="l2.597" class="difflineplus">+  onMouseUp(aEvent) {</span>
<a href="#l2.598"></a><span id="l2.598" class="difflineplus">+    // Handles left-click with modifier if not browser.bookmarks.openInTabClosesMenu.</span>
<a href="#l2.599"></a><span id="l2.599" class="difflineplus">+    if (aEvent.button != 0 || PlacesUIUtils.openInTabClosesMenu)</span>
<a href="#l2.600"></a><span id="l2.600" class="difflineplus">+      return;</span>
<a href="#l2.601"></a><span id="l2.601" class="difflineplus">+    let target = aEvent.originalTarget;</span>
<a href="#l2.602"></a><span id="l2.602" class="difflineplus">+    if (target.tagName != &quot;menuitem&quot;)</span>
<a href="#l2.603"></a><span id="l2.603" class="difflineplus">+      return;</span>
<a href="#l2.604"></a><span id="l2.604" class="difflineplus">+    let modifKey = AppConstants.platform === &quot;macosx&quot; ? aEvent.metaKey</span>
<a href="#l2.605"></a><span id="l2.605" class="difflineplus">+                                                      : aEvent.ctrlKey;</span>
<a href="#l2.606"></a><span id="l2.606" class="difflineplus">+    // Don't keep menu open for 'Open all in Tabs'.</span>
<a href="#l2.607"></a><span id="l2.607" class="difflineplus">+    if (modifKey &amp;&amp; !target.classList.contains(&quot;openintabs-menuitem&quot;)) {</span>
<a href="#l2.608"></a><span id="l2.608" class="difflineplus">+      target.setAttribute(&quot;closemenu&quot;, &quot;none&quot;);</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineplus">+    }</span>
<a href="#l2.610"></a><span id="l2.610" class="difflineplus">+  },</span>
<a href="#l2.611"></a><span id="l2.611" class="difflineplus">+</span>
<a href="#l2.612"></a><span id="l2.612">   onClick: function BEH_onClick(aEvent) {</span>
<a href="#l2.613"></a><span id="l2.613">     // Only handle middle-click or left-click with modifiers.</span>
<a href="#l2.614"></a><span id="l2.614">     if (aEvent.button == 2 || (aEvent.button == 0 &amp;&amp; !aEvent.shiftKey &amp;&amp;</span>
<a href="#l2.615"></a><span id="l2.615">                                !aEvent.ctrlKey &amp;&amp; !aEvent.metaKey))</span>
<a href="#l2.616"></a><span id="l2.616">       return;</span>
<a href="#l2.617"></a><span id="l2.617"> </span>
<a href="#l2.618"></a><span id="l2.618">     var target = aEvent.originalTarget;</span>
<a href="#l2.619"></a><span id="l2.619" class="difflineminus">-    // If this event bubbled up from a menu or menuitem, close the menus.</span>
<a href="#l2.620"></a><span id="l2.620" class="difflineminus">-    // Do this before opening tabs, to avoid hiding the open tabs confirm-dialog.</span>
<a href="#l2.621"></a><span id="l2.621" class="difflineminus">-    if (target.localName == &quot;menu&quot; || target.localName == &quot;menuitem&quot;) {</span>
<a href="#l2.622"></a><span id="l2.622" class="difflineminus">-      for (node = target.parentNode; node; node = node.parentNode) {</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineminus">-        if (node.localName == &quot;menupopup&quot;)</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineminus">-          node.hidePopup();</span>
<a href="#l2.625"></a><span id="l2.625" class="difflineminus">-        else if (node.localName != &quot;menu&quot;)</span>
<a href="#l2.626"></a><span id="l2.626" class="difflineminus">-          break;</span>
<a href="#l2.627"></a><span id="l2.627" class="difflineminus">-      }</span>
<a href="#l2.628"></a><span id="l2.628" class="difflineplus">+    // If this event bubbled up from a menu or menuitem,</span>
<a href="#l2.629"></a><span id="l2.629" class="difflineplus">+    // close the menus if browser.bookmarks.openInTabClosesMenu.</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineplus">+    if ((PlacesUIUtils.openInTabClosesMenu &amp;&amp; target.tagName == &quot;menuitem&quot;) ||</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineplus">+        target.tagName == &quot;menu&quot; ||</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineplus">+        target.classList.contains(&quot;openintabs-menuitem&quot;)) {</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineplus">+      closeMenus(aEvent.target);</span>
<a href="#l2.634"></a><span id="l2.634" class="difflineplus">+    }</span>
<a href="#l2.635"></a><span id="l2.635" class="difflineplus">+    // Command already precesssed so remove any closemenu attr set in onMouseUp.</span>
<a href="#l2.636"></a><span id="l2.636" class="difflineplus">+    if (aEvent.button == 0 &amp;&amp;</span>
<a href="#l2.637"></a><span id="l2.637" class="difflineplus">+        target.tagName == &quot;menuitem&quot; &amp;&amp;</span>
<a href="#l2.638"></a><span id="l2.638" class="difflineplus">+        target.getAttribute(&quot;closemenu&quot;) == &quot;none&quot;) {</span>
<a href="#l2.639"></a><span id="l2.639" class="difflineplus">+      // On Mac we need to extend when we remove the flag, to avoid any pre-close</span>
<a href="#l2.640"></a><span id="l2.640" class="difflineplus">+      // animations.</span>
<a href="#l2.641"></a><span id="l2.641" class="difflineplus">+      setTimeout(() =&gt; {</span>
<a href="#l2.642"></a><span id="l2.642" class="difflineplus">+        target.removeAttribute(&quot;closemenu&quot;);</span>
<a href="#l2.643"></a><span id="l2.643" class="difflineplus">+      }, 500);</span>
<a href="#l2.644"></a><span id="l2.644">     }</span>
<a href="#l2.645"></a><span id="l2.645"> </span>
<a href="#l2.646"></a><span id="l2.646">     if (target._placesNode &amp;&amp; PlacesUtils.nodeIsContainer(target._placesNode)) {</span>
<a href="#l2.647"></a><span id="l2.647">       // Don't open the root folder in tabs when the empty area on the toolbar</span>
<a href="#l2.648"></a><span id="l2.648">       // is middle-clicked or when a non-bookmark item except for Open in Tabs)</span>
<a href="#l2.649"></a><span id="l2.649">       // in a bookmarks menupopup is middle-clicked.</span>
<a href="#l2.650"></a><span id="l2.650">       if (target.localName == &quot;menu&quot; || target.localName == &quot;toolbarbutton&quot;)</span>
<a href="#l2.651"></a><span id="l2.651">         PlacesUIUtils.openContainerNodeInTabs(target._placesNode, aEvent);</span>
<a href="#l2.652"></a><span id="l2.652" class="difflineat">@@ -757,18 +684,17 @@ var PlacesMenuDNDHandler = {</span>
<a href="#l2.653"></a><span id="l2.653">    * @param   event</span>
<a href="#l2.654"></a><span id="l2.654">    *          The DragEnter event that spawned the opening.</span>
<a href="#l2.655"></a><span id="l2.655">    */</span>
<a href="#l2.656"></a><span id="l2.656">   onDragEnter: function PMDH_onDragEnter(event) {</span>
<a href="#l2.657"></a><span id="l2.657">     // Opening menus in a Places popup is handled by the view itself.</span>
<a href="#l2.658"></a><span id="l2.658">     if (!this._isStaticContainer(event.target))</span>
<a href="#l2.659"></a><span id="l2.659">       return;</span>
<a href="#l2.660"></a><span id="l2.660"> </span>
<a href="#l2.661"></a><span id="l2.661" class="difflineminus">-    this._loadTimer = Cc[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l2.662"></a><span id="l2.662" class="difflineminus">-                        .createInstance(Ci.nsITimer);</span>
<a href="#l2.663"></a><span id="l2.663" class="difflineplus">+    this._loadTimer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l2.664"></a><span id="l2.664">     this._loadTimer.initWithCallback(function() {</span>
<a href="#l2.665"></a><span id="l2.665">       PlacesMenuDNDHandler._loadTimer = null;</span>
<a href="#l2.666"></a><span id="l2.666">       event.target.lastChild.setAttribute(&quot;autoopened&quot;, &quot;true&quot;);</span>
<a href="#l2.667"></a><span id="l2.667">       event.target.lastChild.showPopup(event.target.lastChild);</span>
<a href="#l2.668"></a><span id="l2.668">     }, this._springLoadDelay, Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l2.669"></a><span id="l2.669">     event.preventDefault();</span>
<a href="#l2.670"></a><span id="l2.670">     event.stopPropagation();</span>
<a href="#l2.671"></a><span id="l2.671">   },</span>
<a href="#l2.672"></a><span id="l2.672" class="difflineat">@@ -782,18 +708,17 @@ var PlacesMenuDNDHandler = {</span>
<a href="#l2.673"></a><span id="l2.673">     // Closing menus in a Places popup is handled by the view itself.</span>
<a href="#l2.674"></a><span id="l2.674">     if (!this._isStaticContainer(event.target))</span>
<a href="#l2.675"></a><span id="l2.675">       return;</span>
<a href="#l2.676"></a><span id="l2.676"> </span>
<a href="#l2.677"></a><span id="l2.677">     if (this._loadTimer) {</span>
<a href="#l2.678"></a><span id="l2.678">       this._loadTimer.cancel();</span>
<a href="#l2.679"></a><span id="l2.679">       this._loadTimer = null;</span>
<a href="#l2.680"></a><span id="l2.680">     }</span>
<a href="#l2.681"></a><span id="l2.681" class="difflineminus">-    let closeTimer = Cc[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l2.682"></a><span id="l2.682" class="difflineminus">-                       .createInstance(Ci.nsITimer);</span>
<a href="#l2.683"></a><span id="l2.683" class="difflineplus">+    let closeTimer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l2.684"></a><span id="l2.684">     closeTimer.initWithCallback(function() {</span>
<a href="#l2.685"></a><span id="l2.685">       let node = PlacesControllerDragHelper.currentDropTarget;</span>
<a href="#l2.686"></a><span id="l2.686">       let inHierarchy = false;</span>
<a href="#l2.687"></a><span id="l2.687">       while (node &amp;&amp; !inHierarchy) {</span>
<a href="#l2.688"></a><span id="l2.688">         inHierarchy = node == event.target;</span>
<a href="#l2.689"></a><span id="l2.689">         node = node.parentNode;</span>
<a href="#l2.690"></a><span id="l2.690">       }</span>
<a href="#l2.691"></a><span id="l2.691">       if (!inHierarchy &amp;&amp; event.target.lastChild &amp;&amp;</span>
<a href="#l2.692"></a><span id="l2.692" class="difflineat">@@ -820,35 +745,37 @@ var PlacesMenuDNDHandler = {</span>
<a href="#l2.693"></a><span id="l2.693">   },</span>
<a href="#l2.694"></a><span id="l2.694"> </span>
<a href="#l2.695"></a><span id="l2.695">   /**</span>
<a href="#l2.696"></a><span id="l2.696">    * Called when the user drags over the &lt;menu&gt; element.</span>
<a href="#l2.697"></a><span id="l2.697">    * @param   event</span>
<a href="#l2.698"></a><span id="l2.698">    *          The DragOver event.</span>
<a href="#l2.699"></a><span id="l2.699">    */</span>
<a href="#l2.700"></a><span id="l2.700">   onDragOver: function PMDH_onDragOver(event) {</span>
<a href="#l2.701"></a><span id="l2.701" class="difflineminus">-    let ip = new InsertionPoint(PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l2.702"></a><span id="l2.702" class="difflineminus">-                                PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l2.703"></a><span id="l2.703" class="difflineminus">-                                Ci.nsITreeView.DROP_ON);</span>
<a href="#l2.704"></a><span id="l2.704" class="difflineplus">+    let ip = new InsertionPoint({</span>
<a href="#l2.705"></a><span id="l2.705" class="difflineplus">+      parentId: PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l2.706"></a><span id="l2.706" class="difflineplus">+      parentGuid: PlacesUtils.bookmarks.menuGuid</span>
<a href="#l2.707"></a><span id="l2.707" class="difflineplus">+    });</span>
<a href="#l2.708"></a><span id="l2.708">     if (ip &amp;&amp; PlacesControllerDragHelper.canDrop(ip, event.dataTransfer))</span>
<a href="#l2.709"></a><span id="l2.709">       event.preventDefault();</span>
<a href="#l2.710"></a><span id="l2.710"> </span>
<a href="#l2.711"></a><span id="l2.711">     event.stopPropagation();</span>
<a href="#l2.712"></a><span id="l2.712">   },</span>
<a href="#l2.713"></a><span id="l2.713"> </span>
<a href="#l2.714"></a><span id="l2.714">   /**</span>
<a href="#l2.715"></a><span id="l2.715">    * Called when the user drops on the &lt;menu&gt; element.</span>
<a href="#l2.716"></a><span id="l2.716">    * @param   event</span>
<a href="#l2.717"></a><span id="l2.717">    *          The Drop event.</span>
<a href="#l2.718"></a><span id="l2.718">    */</span>
<a href="#l2.719"></a><span id="l2.719">   onDrop: function PMDH_onDrop(event) {</span>
<a href="#l2.720"></a><span id="l2.720">     // Put the item at the end of bookmark menu.</span>
<a href="#l2.721"></a><span id="l2.721" class="difflineminus">-    let ip = new InsertionPoint(PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l2.722"></a><span id="l2.722" class="difflineminus">-                                PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l2.723"></a><span id="l2.723" class="difflineminus">-                                Ci.nsITreeView.DROP_ON);</span>
<a href="#l2.724"></a><span id="l2.724" class="difflineplus">+    let ip = new InsertionPoint({</span>
<a href="#l2.725"></a><span id="l2.725" class="difflineplus">+      parentId: PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l2.726"></a><span id="l2.726" class="difflineplus">+      parentGuid: PlacesUtils.bookmarks.menuGuid</span>
<a href="#l2.727"></a><span id="l2.727" class="difflineplus">+    });</span>
<a href="#l2.728"></a><span id="l2.728">     PlacesControllerDragHelper.onDrop(ip, event.dataTransfer);</span>
<a href="#l2.729"></a><span id="l2.729">     event.stopPropagation();</span>
<a href="#l2.730"></a><span id="l2.730">   }</span>
<a href="#l2.731"></a><span id="l2.731"> };</span>
<a href="#l2.732"></a><span id="l2.732"> </span>
<a href="#l2.733"></a><span id="l2.733"> </span>
<a href="#l2.734"></a><span id="l2.734"> var BookmarkingUI = {</span>
<a href="#l2.735"></a><span id="l2.735">   _hasBookmarksObserver: false,</span>
<a href="#l2.736"></a><span id="l2.736" class="difflineat">@@ -888,17 +815,17 @@ var BookmarkingUI = {</span>
<a href="#l2.737"></a><span id="l2.737">     this._itemGuids = [];</span>
<a href="#l2.738"></a><span id="l2.738">     let aItemGuids = [];</span>
<a href="#l2.739"></a><span id="l2.739"> </span>
<a href="#l2.740"></a><span id="l2.740">     // those objects are use to check if we are in the current iteration before</span>
<a href="#l2.741"></a><span id="l2.741">     // returning any result.</span>
<a href="#l2.742"></a><span id="l2.742">     let pendingUpdate = this._pendingUpdate = {};</span>
<a href="#l2.743"></a><span id="l2.743"> </span>
<a href="#l2.744"></a><span id="l2.744">     PlacesUtils.bookmarks.fetch({url: this._uri}, b =&gt; aItemGuids.push(b.guid))</span>
<a href="#l2.745"></a><span id="l2.745" class="difflineminus">-      .catch(Cu..reportError)</span>
<a href="#l2.746"></a><span id="l2.746" class="difflineplus">+      .catch(Cu.reportError)</span>
<a href="#l2.747"></a><span id="l2.747">       .then(() =&gt; {</span>
<a href="#l2.748"></a><span id="l2.748">          if (pendingUpdate != this._pendingUpdate) {</span>
<a href="#l2.749"></a><span id="l2.749">            return;</span>
<a href="#l2.750"></a><span id="l2.750">          }</span>
<a href="#l2.751"></a><span id="l2.751"> </span>
<a href="#l2.752"></a><span id="l2.752">          // It's possible that onItemAdded gets called before the async statement</span>
<a href="#l2.753"></a><span id="l2.753">          // calls back.  For such an edge case, retain all unique entries from the</span>
<a href="#l2.754"></a><span id="l2.754">          // array.</span>
<a href="#l2.755"></a><span id="l2.755" class="difflineat">@@ -909,17 +836,17 @@ var BookmarkingUI = {</span>
<a href="#l2.756"></a><span id="l2.756">          this._updateStar();</span>
<a href="#l2.757"></a><span id="l2.757"> </span>
<a href="#l2.758"></a><span id="l2.758">          // Start observing bookmarks if needed.</span>
<a href="#l2.759"></a><span id="l2.759">          if (!this._hasBookmarksObserver) {</span>
<a href="#l2.760"></a><span id="l2.760">            try {</span>
<a href="#l2.761"></a><span id="l2.761">              PlacesUtils.bookmarks.addObserver(this);</span>
<a href="#l2.762"></a><span id="l2.762">              this._hasBookmarksObserver = true;</span>
<a href="#l2.763"></a><span id="l2.763">            } catch (ex) {</span>
<a href="#l2.764"></a><span id="l2.764" class="difflineminus">-             Cu..reportError(&quot;BookmarkingUI failed adding a bookmarks observer: &quot; + ex);</span>
<a href="#l2.765"></a><span id="l2.765" class="difflineplus">+             Cu.reportError(&quot;BookmarkingUI failed adding a bookmarks observer: &quot; + ex);</span>
<a href="#l2.766"></a><span id="l2.766">            }</span>
<a href="#l2.767"></a><span id="l2.767">          }</span>
<a href="#l2.768"></a><span id="l2.768"> </span>
<a href="#l2.769"></a><span id="l2.769">          delete this._pendingUpdate;</span>
<a href="#l2.770"></a><span id="l2.770">        });</span>
<a href="#l2.771"></a><span id="l2.771">   },</span>
<a href="#l2.772"></a><span id="l2.772"> </span>
<a href="#l2.773"></a><span id="l2.773">   _updateStar: function BUI__updateStar()</span>
<a href="#l2.774"></a><span id="l2.774" class="difflineat">@@ -934,17 +861,19 @@ var BookmarkingUI = {</span>
<a href="#l2.775"></a><span id="l2.775">       starIcon.setAttribute(&quot;tooltiptext&quot;, this._unstarredTooltip);</span>
<a href="#l2.776"></a><span id="l2.776">     }</span>
<a href="#l2.777"></a><span id="l2.777">   },</span>
<a href="#l2.778"></a><span id="l2.778"> </span>
<a href="#l2.779"></a><span id="l2.779">   onClick: function BUI_onClick(aEvent)</span>
<a href="#l2.780"></a><span id="l2.780">   {</span>
<a href="#l2.781"></a><span id="l2.781">     // Ignore clicks on the star while we update its state.</span>
<a href="#l2.782"></a><span id="l2.782">     if (aEvent.button == 0 &amp;&amp; !this._pendingUpdate)</span>
<a href="#l2.783"></a><span id="l2.783" class="difflineminus">-      PlacesCommandHook.bookmarkCurrentPage(this._itemGuids.length &gt; 0);</span>
<a href="#l2.784"></a><span id="l2.784" class="difflineplus">+      PlacesCommandHook.bookmarkPage(gBrowser.selectedBrowser,</span>
<a href="#l2.785"></a><span id="l2.785" class="difflineplus">+                                     this._itemGuids.length &gt; 0);</span>
<a href="#l2.786"></a><span id="l2.786" class="difflineplus">+</span>
<a href="#l2.787"></a><span id="l2.787">   },</span>
<a href="#l2.788"></a><span id="l2.788"> </span>
<a href="#l2.789"></a><span id="l2.789">   // nsINavBookmarkObserver</span>
<a href="#l2.790"></a><span id="l2.790">   onItemAdded(aItemId, aParentId, aIndex, aItemType, aURI, aTitle, aDateAdded, aGuid) {</span>
<a href="#l2.791"></a><span id="l2.791">     if (aURI &amp;&amp; aURI.equals(this._uri)) {</span>
<a href="#l2.792"></a><span id="l2.792">       // If a new bookmark has been added to the tracked uri, register it.</span>
<a href="#l2.793"></a><span id="l2.793">       if (!this._itemGuids.includes(aGuid)) {</span>
<a href="#l2.794"></a><span id="l2.794">         this._itemGuids.push(aGuid);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/suite/browser/navigator.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/suite/browser/navigator.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -3,28 +3,23 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.5"></a><span id="l3.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l3.8"></a><span id="l3.8"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.9"></a><span id="l3.9"> ChromeUtils.import(&quot;resource://gre/modules/DownloadTaskbarProgress.jsm&quot;);</span>
<a href="#l3.10"></a><span id="l3.10"> ChromeUtils.import(&quot;resource:///modules/WindowsPreviewPerTab.jsm&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-this.__defineGetter__(&quot;PluralForm&quot;, function() {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-  return this.PluralForm;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+XPCOMUtils.defineLazyModuleGetters(this, {</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  PluralForm: &quot;resource://gre/modules/PluralForm.jsm&quot;,</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  PrivateBrowsingUtils: &quot;resource://gre/modules/PrivateBrowsingUtils.jsm&quot;,</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  PromiseUtils: &quot;resource://gre/modules/PromiseUtils.jsm&quot;,</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  SafeBrowsing: &quot;resource://gre/modules/SafeBrowsing.jsm&quot;,</span>
<a href="#l3.20"></a><span id="l3.20"> });</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-this.__defineSetter__(&quot;PluralForm&quot;, function (val) {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-  delete this.PluralForm;</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-  return this.PluralForm = val;</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-});</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;SafeBrowsing&quot;,</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-  &quot;resource://gre/modules/SafeBrowsing.jsm&quot;);</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-  </span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+</span>
<a href="#l3.30"></a><span id="l3.30"> XPCOMUtils.defineLazyScriptGetter(this, &quot;gEditItemOverlay&quot;,</span>
<a href="#l3.31"></a><span id="l3.31">                                   &quot;chrome://communicator/content/places/editBookmarkOverlay.js&quot;);</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33"> const REMOTESERVICE_CONTRACTID = &quot;@mozilla.org/toolkit/remote-service;1&quot;;</span>
<a href="#l3.34"></a><span id="l3.34"> const XUL_NS = &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;;</span>
<a href="#l3.35"></a><span id="l3.35"> </span>
<a href="#l3.36"></a><span id="l3.36"> var gURLBar = null;</span>
<a href="#l3.37"></a><span id="l3.37"> var gProxyButton = null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/suite/browser/navigatorOverlay.xul</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/suite/browser/navigatorOverlay.xul</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -174,20 +174,22 @@</span>
<a href="#l4.4"></a><span id="l4.4">              oncommand=&quot;BrowserFindAgain(true);&quot;</span>
<a href="#l4.5"></a><span id="l4.5">              observes=&quot;isImage&quot;/&gt;</span>
<a href="#l4.6"></a><span id="l4.6">     &lt;command id=&quot;cmd_findTypeText&quot; observes=&quot;isImage&quot;/&gt;</span>
<a href="#l4.7"></a><span id="l4.7">     &lt;command id=&quot;cmd_findTypeLinks&quot; observes=&quot;isImage&quot;/&gt;</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9">     &lt;!-- Bookmarks Menu --&gt;</span>
<a href="#l4.10"></a><span id="l4.10">     &lt;command id=&quot;Browser:AddBookmark&quot;</span>
<a href="#l4.11"></a><span id="l4.11">              label=&quot;&amp;addCurPageCmd.label;&quot; accesskey=&quot;&amp;addCurPageCmd.accesskey;&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-             oncommand=&quot;PlacesCommandHook.bookmarkCurrentPage(false, PlacesUtils.bookmarksMenuFolderId);&quot;/&gt;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+             oncommand=&quot;PlacesCommandHook.bookmarkPage(gBrowser.selectedBrowser,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+                                                       false);&quot;/&gt;</span>
<a href="#l4.15"></a><span id="l4.15">     &lt;command id=&quot;Browser:AddBookmarkAs&quot;</span>
<a href="#l4.16"></a><span id="l4.16">              label=&quot;&amp;addCurPageAsCmd.label;&quot; accesskey=&quot;&amp;addCurPageAsCmd.accesskey;&quot;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-             oncommand=&quot;PlacesCommandHook.bookmarkPage(gBrowser.selectedBrowser, PlacesUtils.bookmarksMenuFolderId, true);&quot;/&gt;</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+             oncommand=&quot;PlacesCommandHook.bookmarkPage(gBrowser.selectedBrowser,</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+                                                       true);&quot;/&gt;</span>
<a href="#l4.20"></a><span id="l4.20">     &lt;!-- The command is disabled for the hidden window. Otherwise its enabled</span>
<a href="#l4.21"></a><span id="l4.21">          state is handled by BookmarksEventHandler.onPopupShowing. --&gt;</span>
<a href="#l4.22"></a><span id="l4.22">     &lt;command id=&quot;Browser:BookmarkAllTabs&quot;</span>
<a href="#l4.23"></a><span id="l4.23">              label=&quot;&amp;addCurTabsAsCmd.label;&quot; accesskey=&quot;&amp;addCurTabsAsCmd.accesskey;&quot;</span>
<a href="#l4.24"></a><span id="l4.24">              oncommand=&quot;PlacesCommandHook.bookmarkCurrentPages();&quot;</span>
<a href="#l4.25"></a><span id="l4.25">              disabled=&quot;true&quot;/&gt;</span>
<a href="#l4.26"></a><span id="l4.26">     &lt;command id=&quot;Browser:ManageBookmark&quot;</span>
<a href="#l4.27"></a><span id="l4.27">              label=&quot;&amp;manBookmarksCmd.label;&quot; accesskey=&quot;&amp;manBookmarksCmd.accesskey;&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/suite/common/nsContextMenu.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/suite/common/nsContextMenu.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1186,17 +1186,16 @@ nsContextMenu.prototype = {</span>
<a href="#l5.4"></a><span id="l5.4">   copyEmail: function() {</span>
<a href="#l5.5"></a><span id="l5.5">     var clipboard = this.getService(&quot;@mozilla.org/widget/clipboardhelper;1&quot;,</span>
<a href="#l5.6"></a><span id="l5.6">                                     Ci.nsIClipboardHelper);</span>
<a href="#l5.7"></a><span id="l5.7">     clipboard.copyString(this.getEmail());</span>
<a href="#l5.8"></a><span id="l5.8">   },</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10">   bookmarkThisPage : function() {</span>
<a href="#l5.11"></a><span id="l5.11">     window.top.PlacesCommandHook.bookmarkPage(this.browser,</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-                                              PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l5.13"></a><span id="l5.13">                                               true);</span>
<a href="#l5.14"></a><span id="l5.14">   },</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16">   bookmarkLink: function CM_bookmarkLink() {</span>
<a href="#l5.17"></a><span id="l5.17">     window.top.PlacesCommandHook.bookmarkLink(PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l5.18"></a><span id="l5.18">                                               this.linkURL,</span>
<a href="#l5.19"></a><span id="l5.19">                                               this.linkText());</span>
<a href="#l5.20"></a><span id="l5.20">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/suite/common/places/PlacesUIUtils.jsm</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/suite/common/places/PlacesUIUtils.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -3,77 +3,41 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.5"></a><span id="l6.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> this.EXPORTED_SYMBOLS = [&quot;PlacesUIUtils&quot;];</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l6.10"></a><span id="l6.10"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.11"></a><span id="l6.11"> ChromeUtils.import(&quot;resource://gre/modules/Timer.jsm&quot;);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-// PlacesUtils exposes multiple symbols, so we can't use defineModuleGetter.</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/PlacesUtils.jsm&quot;);</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;PluralForm&quot;,</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-                               &quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;PrivateBrowsingUtils&quot;,</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-                               &quot;resource://gre/modules/PrivateBrowsingUtils.jsm&quot;);</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;NetUtil&quot;,</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-                               &quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;RecentWindow&quot;,</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-                               &quot;resource:///modules/RecentWindow.jsm&quot;);</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;PlacesTransactions&quot;,</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-                               &quot;resource://gre/modules/PlacesTransactions.jsm&quot;);</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+XPCOMUtils.defineLazyModuleGetters(this, {</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+  PlacesUtils: &quot;resource://gre/modules/PlacesUtils.jsm&quot;,</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+  PluralForm: &quot;resource://gre/modules/PluralForm.jsm&quot;,</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+  PrivateBrowsingUtils: &quot;resource://gre/modules/PrivateBrowsingUtils.jsm&quot;,</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+  RecentWindow: &quot;resource:///modules/RecentWindow.jsm&quot;,</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+  PromiseUtils: &quot;resource://gre/modules/PromiseUtils.jsm&quot;,</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  PlacesTransactions: &quot;resource://gre/modules/PlacesTransactions.jsm&quot;,</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+});</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;Weave&quot;,</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-                               &quot;resource://services-sync/main.js&quot;);</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;bundle&quot;, function() {</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+  return Services.strings.createBundle(&quot;chrome://communicator/locale/places/places.properties&quot;);</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+});</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40"> const gInContentProcess = Services.appinfo.processType == Ci.nsIXULRuntime.PROCESS_TYPE_CONTENT;</span>
<a href="#l6.41"></a><span id="l6.41"> const FAVICON_REQUEST_TIMEOUT = 60 * 1000;</span>
<a href="#l6.42"></a><span id="l6.42"> // Map from windows to arrays of data about pending favicon loads.</span>
<a href="#l6.43"></a><span id="l6.43"> let gFaviconLoadDataMap = new Map();</span>
<a href="#l6.44"></a><span id="l6.44"> </span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+const ITEM_CHANGED_BATCH_NOTIFICATION_THRESHOLD = 10;</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+</span>
<a href="#l6.47"></a><span id="l6.47"> // copied from utilityOverlay.js</span>
<a href="#l6.48"></a><span id="l6.48"> const TAB_DROP_TYPE = &quot;application/x-moz-tabbrowser-tab&quot;;</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-// This function isn't public both because it's synchronous and because it is</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-// going to be removed in bug 1072833.</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-function IsLivemark(aItemId) {</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-  // Since this check may be done on each dragover event, it's worth maintaining</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-  // a cache.</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-  let self = IsLivemark;</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-  if (!(&quot;ids&quot; in self)) {</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-    const LIVEMARK_ANNO = PlacesUtils.LMANNO_FEEDURI;</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-    let idsVec = PlacesUtils.annotations.getItemsWithAnnotation(LIVEMARK_ANNO);</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-    self.ids = new Set(idsVec);</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-    let obs = Object.freeze({</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-      QueryInterface: XPCOMUtils.generateQI(Ci.nsIAnnotationObserver),</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-      onItemAnnotationSet(itemId, annoName) {</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-        if (annoName == LIVEMARK_ANNO)</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-          self.ids.add(itemId);</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-      },</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-      onItemAnnotationRemoved(itemId, annoName) {</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-        // If annoName is set to an empty string, the item is gone.</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-        if (annoName == LIVEMARK_ANNO || annoName == &quot;&quot;)</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-          self.ids.delete(itemId);</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-      },</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-      onPageAnnotationSet() { },</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-      onPageAnnotationRemoved() { },</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-    });</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-    PlacesUtils.annotations.addObserver(obs);</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-    PlacesUtils.registerShutdownFunction(() =&gt; {</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-      PlacesUtils.annotations.removeObserver(obs);</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-    });</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-  }</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-  return self.ids.has(aItemId);</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-}</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+const PREF_LOAD_BOOKMARKS_IN_BACKGROUND = &quot;browser.tabs.loadBookmarksInBackground&quot;;</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+const PREF_LOAD_BOOKMARKS_IN_TABS = &quot;browser.tabs.loadBookmarksInTabs&quot;;</span>
<a href="#l6.88"></a><span id="l6.88"> </span>
<a href="#l6.89"></a><span id="l6.89"> let InternalFaviconLoader = {</span>
<a href="#l6.90"></a><span id="l6.90">   /**</span>
<a href="#l6.91"></a><span id="l6.91">    * This gets called for every inner window that is destroyed.</span>
<a href="#l6.92"></a><span id="l6.92">    * In the parent process, we process the destruction ourselves. In the child process,</span>
<a href="#l6.93"></a><span id="l6.93">    * we notify the parent which will then process it based on that message.</span>
<a href="#l6.94"></a><span id="l6.94">    */</span>
<a href="#l6.95"></a><span id="l6.95">   observe(subject, topic, data) {</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineat">@@ -189,17 +153,17 @@ let InternalFaviconLoader = {</span>
<a href="#l6.97"></a><span id="l6.97">     this._initialized = true;</span>
<a href="#l6.98"></a><span id="l6.98"> </span>
<a href="#l6.99"></a><span id="l6.99">     Services.obs.addObserver(this, &quot;inner-window-destroyed&quot;);</span>
<a href="#l6.100"></a><span id="l6.100">     Services.ppmm.addMessageListener(&quot;Toolkit:inner-window-destroyed&quot;, msg =&gt; {</span>
<a href="#l6.101"></a><span id="l6.101">       this.removeRequestsForInner(msg.data);</span>
<a href="#l6.102"></a><span id="l6.102">     });</span>
<a href="#l6.103"></a><span id="l6.103">   },</span>
<a href="#l6.104"></a><span id="l6.104"> </span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-  loadFavicon(browser, principal, uri) {</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+  loadFavicon(browser, principal, uri, requestContextID) {</span>
<a href="#l6.107"></a><span id="l6.107">     this.ensureInitialized();</span>
<a href="#l6.108"></a><span id="l6.108">     let win = browser.ownerGlobal;</span>
<a href="#l6.109"></a><span id="l6.109">     if (!gFaviconLoadDataMap.has(win)) {</span>
<a href="#l6.110"></a><span id="l6.110">       gFaviconLoadDataMap.set(win, []);</span>
<a href="#l6.111"></a><span id="l6.111">       let unloadHandler = event =&gt; {</span>
<a href="#l6.112"></a><span id="l6.112">         let doc = event.target;</span>
<a href="#l6.113"></a><span id="l6.113">         let eventWin = doc.defaultView;</span>
<a href="#l6.114"></a><span id="l6.114">         if (eventWin == win) {</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineat">@@ -207,26 +171,24 @@ let InternalFaviconLoader = {</span>
<a href="#l6.116"></a><span id="l6.116">           this.onUnload(win);</span>
<a href="#l6.117"></a><span id="l6.117">         }</span>
<a href="#l6.118"></a><span id="l6.118">       };</span>
<a href="#l6.119"></a><span id="l6.119">       win.addEventListener(&quot;unload&quot;, unloadHandler, true);</span>
<a href="#l6.120"></a><span id="l6.120">     }</span>
<a href="#l6.121"></a><span id="l6.121"> </span>
<a href="#l6.122"></a><span id="l6.122">     let {innerWindowID, currentURI} = browser;</span>
<a href="#l6.123"></a><span id="l6.123"> </span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-    // Immediately cancel any earlier requests</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-    this.removeRequestsForInner(innerWindowID);</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-</span>
<a href="#l6.127"></a><span id="l6.127">     // First we do the actual setAndFetch call:</span>
<a href="#l6.128"></a><span id="l6.128">     let loadType = PrivateBrowsingUtils.isWindowPrivate(win)</span>
<a href="#l6.129"></a><span id="l6.129">       ? PlacesUtils.favicons.FAVICON_LOAD_PRIVATE</span>
<a href="#l6.130"></a><span id="l6.130">       : PlacesUtils.favicons.FAVICON_LOAD_NON_PRIVATE;</span>
<a href="#l6.131"></a><span id="l6.131">     let callback = this._makeCompletionCallback(win, innerWindowID);</span>
<a href="#l6.132"></a><span id="l6.132">     let request = PlacesUtils.favicons.setAndFetchFaviconForPage(currentURI, uri, false,</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-                                                                 loadType, callback, principal);</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+                                                                 loadType, callback, principal,</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+                                                                 requestContextID);</span>
<a href="#l6.136"></a><span id="l6.136"> </span>
<a href="#l6.137"></a><span id="l6.137">     // Now register the result so we can cancel it if/when necessary.</span>
<a href="#l6.138"></a><span id="l6.138">     if (!request) {</span>
<a href="#l6.139"></a><span id="l6.139">       // The favicon service can return with success but no-op (and leave request</span>
<a href="#l6.140"></a><span id="l6.140">       // as null) if the icon is the same as the page (e.g. for images) or if it is</span>
<a href="#l6.141"></a><span id="l6.141">       // the favicon for an error page. In this case, we do not need to do anything else.</span>
<a href="#l6.142"></a><span id="l6.142">       return;</span>
<a href="#l6.143"></a><span id="l6.143">     }</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineat">@@ -251,17 +213,17 @@ this.PlacesUIUtils = {</span>
<a href="#l6.145"></a><span id="l6.145"> </span>
<a href="#l6.146"></a><span id="l6.146">   /**</span>
<a href="#l6.147"></a><span id="l6.147">    * Makes a URI from a spec, and do fixup</span>
<a href="#l6.148"></a><span id="l6.148">    * @param   aSpec</span>
<a href="#l6.149"></a><span id="l6.149">    *          The string spec of the URI</span>
<a href="#l6.150"></a><span id="l6.150">    * @return A URI object for the spec.</span>
<a href="#l6.151"></a><span id="l6.151">    */</span>
<a href="#l6.152"></a><span id="l6.152">   createFixedURI: function PUIU_createFixedURI(aSpec) {</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-    return URIFixup.createFixupURI(aSpec, Ci.nsIURIFixup.FIXUP_FLAG_NONE);</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+    return Services.uriFixup.createFixupURI(aSpec, Ci.nsIURIFixup.FIXUP_FLAG_NONE);</span>
<a href="#l6.155"></a><span id="l6.155">   },</span>
<a href="#l6.156"></a><span id="l6.156"> </span>
<a href="#l6.157"></a><span id="l6.157">   getFormattedString: function PUIU_getFormattedString(key, params) {</span>
<a href="#l6.158"></a><span id="l6.158">     return bundle.formatStringFromName(key, params, params.length);</span>
<a href="#l6.159"></a><span id="l6.159">   },</span>
<a href="#l6.160"></a><span id="l6.160"> </span>
<a href="#l6.161"></a><span id="l6.161">   /**</span>
<a href="#l6.162"></a><span id="l6.162">    * Get a localized plural string for the specified key name and numeric value</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineat">@@ -287,292 +249,38 @@ this.PlacesUIUtils = {</span>
<a href="#l6.164"></a><span id="l6.164">       return param !== undefined ? param : matchedId;</span>
<a href="#l6.165"></a><span id="l6.165">     });</span>
<a href="#l6.166"></a><span id="l6.166">   },</span>
<a href="#l6.167"></a><span id="l6.167"> </span>
<a href="#l6.168"></a><span id="l6.168">   getString: function PUIU_getString(key) {</span>
<a href="#l6.169"></a><span id="l6.169">     return bundle.GetStringFromName(key);</span>
<a href="#l6.170"></a><span id="l6.170">   },</span>
<a href="#l6.171"></a><span id="l6.171"> </span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-  get _copyableAnnotations() {</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-    return [</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-      this.DESCRIPTION_ANNO,</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-      this.LOAD_IN_SIDEBAR_ANNO,</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-      PlacesUtils.READ_ONLY_ANNO,</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-    ];</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-  },</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-</span>
<a href="#l6.180"></a><span id="l6.180">   /**</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">-   * Get a transaction for copying a uri item (either a bookmark or a history</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-   * entry) from one container to another.</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-   *</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-   * @param   aData</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-   *          JSON object of dropped or pasted item properties</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-   * @param   aContainer</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-   *          The container being copied into</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-   * @param   aIndex</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-   *          The index within the container the item is copied to</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-   * @return A nsITransaction object that performs the copy.</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-   *</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-   * @note Since a copy creates a completely new item, only some internal</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-   *       annotations are synced from the old one.</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-   * @see this._copyableAnnotations for the list of copyable annotations.</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-   */</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-  _getURIItemCopyTransaction:</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-  function PUIU__getURIItemCopyTransaction(aData, aContainer, aIndex) {</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-    let transactions = [];</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-    if (aData.dateAdded) {</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-      transactions.push(</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-        new PlacesEditItemDateAddedTransaction(null, aData.dateAdded)</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-      );</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-    }</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-    if (aData.lastModified) {</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-      transactions.push(</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-        new PlacesEditItemLastModifiedTransaction(null, aData.lastModified)</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-      );</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-    }</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-    let annos = [];</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-    if (aData.annos) {</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-      annos = aData.annos.filter(function(aAnno) {</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-        return this._copyableAnnotations.includes(aAnno.name);</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-      }, this);</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-    }</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-    // There's no need to copy the keyword since it's bound to the bookmark url.</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-    return new PlacesCreateBookmarkTransaction(PlacesUtils._uri(aData.uri),</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-                                               aContainer, aIndex, aData.title,</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-                                               null, annos, transactions);</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">-  },</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-  /**</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-   * Gets a transaction for copying (recursively nesting to include children)</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-   * a folder (or container) and its contents from one folder to another.</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-   *</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineminus">-   * @param   aData</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-   *          Unwrapped dropped folder data - Obj containing folder and children</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-   * @param   aContainer</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-   *          The container we are copying into</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-   * @param   aIndex</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-   *          The index in the destination container to insert the new items</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-   * @return A nsITransaction object that will perform the copy.</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-   *</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-   * @note Since a copy creates a completely new item, only some internal</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-   *       annotations are synced from the old one.</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-   * @see this._copyableAnnotations for the list of copyable annotations.</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-   */</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-  _getFolderCopyTransaction(aData, aContainer, aIndex) {</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-    function getChildItemsTransactions(aRoot) {</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineminus">-      let transactions = [];</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-      let index = aIndex;</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-      for (let i = 0; i &lt; aRoot.childCount; ++i) {</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineminus">-        let child = aRoot.getChild(i);</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-        // Temporary hacks until we switch to PlacesTransactions.jsm.</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-        let isLivemark =</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-          PlacesUtils.annotations.itemHasAnnotation(child.itemId,</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-                                                    PlacesUtils.LMANNO_FEEDURI);</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-        let [node] = PlacesUtils.unwrapNodes(</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-          PlacesUtils.wrapNode(child, PlacesUtils.TYPE_X_MOZ_PLACE, isLivemark),</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-          PlacesUtils.TYPE_X_MOZ_PLACE</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-        );</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineminus">-        // Make sure that items are given the correct index, this will be</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-        // passed by the transaction manager to the backend for the insertion.</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-        // Insertion behaves differently for DEFAULT_INDEX (append).</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-        if (aIndex != PlacesUtils.bookmarks.DEFAULT_INDEX) {</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-          index = i;</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-        }</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-        if (node.type == PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER) {</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-          if (node.livemark &amp;&amp; node.annos) {</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-            transactions.push(</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineminus">-              PlacesUIUtils._getLivemarkCopyTransaction(node, aContainer, index)</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineminus">-            );</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineminus">-          } else {</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineminus">-            transactions.push(</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineminus">-              PlacesUIUtils._getFolderCopyTransaction(node, aContainer, index)</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineminus">-            );</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineminus">-          }</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-        } else if (node.type == PlacesUtils.TYPE_X_MOZ_PLACE_SEPARATOR) {</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineminus">-          transactions.push(new PlacesCreateSeparatorTransaction(-1, index));</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineminus">-        } else if (node.type == PlacesUtils.TYPE_X_MOZ_PLACE) {</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineminus">-          transactions.push(</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineminus">-            PlacesUIUtils._getURIItemCopyTransaction(node, -1, index)</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-          );</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-        } else {</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-          throw new Error(&quot;Unexpected item under a bookmarks folder&quot;);</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineminus">-        }</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineminus">-      }</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-      return transactions;</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-    }</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-    if (aContainer == PlacesUtils.tagsFolderId) { // Copying into a tag folder.</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-      let transactions = [];</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-      if (!aData.livemark &amp;&amp; aData.type == PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER) {</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineminus">-        let {root} = PlacesUtils.getFolderContents(aData.id, false, false);</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineminus">-        let urls = PlacesUtils.getURLsForContainerNode(root);</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-        root.containerOpen = false;</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineminus">-        for (let { uri } of urls) {</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineminus">-          transactions.push(</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineminus">-            new PlacesTagURITransaction(NetUtil.newURI(uri), [aData.title])</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineminus">-          );</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineminus">-        }</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-      }</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineminus">-      return new PlacesAggregatedTransaction(&quot;addTags&quot;, transactions);</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineminus">-    }</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineminus">-    if (aData.livemark &amp;&amp; aData.annos) { // Copying a livemark.</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-      return this._getLivemarkCopyTransaction(aData, aContainer, aIndex);</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineminus">-    }</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineminus">-</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineminus">-    let {root} = PlacesUtils.getFolderContents(aData.id, false, false);</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-    let transactions = getChildItemsTransactions(root);</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-    root.containerOpen = false;</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineminus">-    if (aData.dateAdded) {</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineminus">-      transactions.push(</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineminus">-        new PlacesEditItemDateAddedTransaction(null, aData.dateAdded)</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineminus">-      );</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineminus">-    }</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineminus">-    if (aData.lastModified) {</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineminus">-      transactions.push(</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineminus">-        new PlacesEditItemLastModifiedTransaction(null, aData.lastModified)</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineminus">-      );</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineminus">-    }</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineminus">-    let annos = [];</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineminus">-    if (aData.annos) {</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineminus">-      annos = aData.annos.filter(function(aAnno) {</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-        return this._copyableAnnotations.includes(aAnno.name);</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineminus">-      }, this);</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineminus">-    }</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-    return new PlacesCreateFolderTransaction(aData.title, aContainer, aIndex,</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-                                             annos, transactions);</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineminus">-  },</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineminus">-</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-  /**</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineminus">-   * Gets a transaction for copying a live bookmark item from one container to</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineminus">-   * another.</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-   *</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-   * @param   aData</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-   *          Unwrapped live bookmarkmark data</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineminus">-   * @param   aContainer</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineminus">-   *          The container we are copying into</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineminus">-   * @param   aIndex</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineminus">-   *          The index in the destination container to insert the new items</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineminus">-   * @return A nsITransaction object that will perform the copy.</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineminus">-   *</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-   * @note Since a copy creates a completely new item, only some internal</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineminus">-   *       annotations are synced from the old one.</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineminus">-   * @see this._copyableAnnotations for the list of copyable annotations.</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineminus">-   */</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineminus">-  _getLivemarkCopyTransaction:</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineminus">-  function PUIU__getLivemarkCopyTransaction(aData, aContainer, aIndex) {</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-    if (!aData.livemark || !aData.annos) {</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineminus">-      throw new Error(&quot;node is not a livemark&quot;);</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineminus">-    }</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineminus">-</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-    let feedURI, siteURI;</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineminus">-    let annos = [];</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineminus">-    if (aData.annos) {</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineminus">-      annos = aData.annos.filter(function(aAnno) {</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineminus">-        if (aAnno.name == PlacesUtils.LMANNO_FEEDURI) {</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineminus">-          feedURI = PlacesUtils._uri(aAnno.value);</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineminus">-        } else if (aAnno.name == PlacesUtils.LMANNO_SITEURI) {</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineminus">-          siteURI = PlacesUtils._uri(aAnno.value);</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineminus">-        }</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineminus">-        return this._copyableAnnotations.includes(aAnno.name)</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineminus">-      }, this);</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineminus">-    }</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineminus">-</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineminus">-    return new PlacesCreateLivemarkTransaction(feedURI, siteURI, aData.title,</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineminus">-                                               aContainer, aIndex, annos);</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineminus">-  },</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineminus">-</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineminus">-  /**</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineminus">-   * Constructs a Transaction for the drop or paste of a blob of data into</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineminus">-   * a container.</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineminus">-   * @param   data</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineminus">-   *          The unwrapped data blob of dropped or pasted data.</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineminus">-   * @param   type</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineminus">-   *          The content type of the data</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineminus">-   * @param   container</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineminus">-   *          The container the data was dropped or pasted into</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineminus">-   * @param   index</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineminus">-   *          The index within the container the item was dropped or pasted at</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineminus">-   * @param   copy</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineminus">-   *          The drag action was copy, so don't move folders or links.</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineminus">-   * @return An object implementing nsITransaction that can perform</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineminus">-   *         the move/insert.</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineminus">-   */</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineminus">-  makeTransaction:</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineminus">-  function PUIU_makeTransaction(data, type, container, index, copy) {</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineminus">-    switch (data.type) {</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineminus">-      case PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER:</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineminus">-        if (copy) {</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineminus">-          return this._getFolderCopyTransaction(data, container, index);</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineminus">-        }</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineminus">-</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineminus">-        // Otherwise move the item.</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineminus">-        return new PlacesMoveItemTransaction(data.id, container, index);</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineminus">-      case PlacesUtils.TYPE_X_MOZ_PLACE:</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineminus">-        if (copy || data.id == -1) { // Id is -1 if the place is not bookmarked.</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineminus">-          return this._getURIItemCopyTransaction(data, container, index);</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineminus">-        }</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineminus">-</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineminus">-        // Otherwise move the item.</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineminus">-        return new PlacesMoveItemTransaction(data.id, container, index);</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineminus">-      case PlacesUtils.TYPE_X_MOZ_PLACE_SEPARATOR:</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineminus">-        if (copy) {</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineminus">-          // There is no data in a separator, so copying it just amounts to</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineminus">-          // inserting a new separator.</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineminus">-          return new PlacesCreateSeparatorTransaction(container, index);</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineminus">-        }</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineminus">-</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineminus">-        // Otherwise move the item.</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineminus">-        return new PlacesMoveItemTransaction(data.id, container, index);</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineminus">-      default:</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineminus">-        if (type == PlacesUtils.TYPE_X_MOZ_URL ||</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineminus">-            type == PlacesUtils.TYPE_UNICODE ||</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineminus">-            type == TAB_DROP_TYPE) {</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineminus">-          let title = type != PlacesUtils.TYPE_UNICODE ? data.title</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineminus">-                                                       : data.uri;</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineminus">-          return new PlacesCreateBookmarkTransaction(PlacesUtils._uri(data.uri),</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineminus">-                                                     container, index, title);</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineminus">-        }</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineminus">-    }</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineminus">-    return null;</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineminus">-  },</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineminus">-</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineminus">-  /**</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineminus">-   * ********* PlacesTransactions version of the function defined above ********</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineminus">-   *</span>
<a href="#l6.426"></a><span id="l6.426">    * Constructs a Places Transaction for the drop or paste of a blob of data</span>
<a href="#l6.427"></a><span id="l6.427">    * into a container.</span>
<a href="#l6.428"></a><span id="l6.428">    *</span>
<a href="#l6.429"></a><span id="l6.429">    * @param   aData</span>
<a href="#l6.430"></a><span id="l6.430">    *          The unwrapped data blob of dropped or pasted data.</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineminus">-   * @param   aType</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineminus">-   *          The content type of the data.</span>
<a href="#l6.433"></a><span id="l6.433">    * @param   aNewParentGuid</span>
<a href="#l6.434"></a><span id="l6.434">    *          GUID of the container the data was dropped or pasted into.</span>
<a href="#l6.435"></a><span id="l6.435">    * @param   aIndex</span>
<a href="#l6.436"></a><span id="l6.436">    *          The index within the container the item was dropped or pasted at.</span>
<a href="#l6.437"></a><span id="l6.437">    * @param   aCopy</span>
<a href="#l6.438"></a><span id="l6.438">    *          The drag action was copy, so don't move folders or links.</span>
<a href="#l6.439"></a><span id="l6.439">    *</span>
<a href="#l6.440"></a><span id="l6.440">    * @return  a Places Transaction that can be transacted for performing the</span>
<a href="#l6.441"></a><span id="l6.441">    *          move/insert command.</span>
<a href="#l6.442"></a><span id="l6.442">    */</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineminus">-  getTransactionForData(aData, aType, aNewParentGuid, aIndex, aCopy) {</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineplus">+  getTransactionForData(aData, aNewParentGuid, aIndex, aCopy) {</span>
<a href="#l6.445"></a><span id="l6.445">     if (!this.SUPPORTED_FLAVORS.includes(aData.type))</span>
<a href="#l6.446"></a><span id="l6.446">       throw new Error(`Unsupported '${aData.type}' data type`);</span>
<a href="#l6.447"></a><span id="l6.447"> </span>
<a href="#l6.448"></a><span id="l6.448" class="difflineminus">-    if (&quot;itemGuid&quot; in aData) {</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineplus">+    if (&quot;itemGuid&quot; in aData &amp;&amp; &quot;instanceId&quot; in aData &amp;&amp;</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineplus">+        aData.instanceId == PlacesUtils.instanceId) {</span>
<a href="#l6.451"></a><span id="l6.451">       if (!this.PLACES_FLAVORS.includes(aData.type))</span>
<a href="#l6.452"></a><span id="l6.452">         throw new Error(`itemGuid unexpectedly set on ${aData.type} data`);</span>
<a href="#l6.453"></a><span id="l6.453"> </span>
<a href="#l6.454"></a><span id="l6.454">       let info = { guid: aData.itemGuid,</span>
<a href="#l6.455"></a><span id="l6.455">                    newParentGuid: aNewParentGuid,</span>
<a href="#l6.456"></a><span id="l6.456">                    newIndex: aIndex };</span>
<a href="#l6.457"></a><span id="l6.457">       if (aCopy) {</span>
<a href="#l6.458"></a><span id="l6.458">         info.excludingAnnotation = &quot;Places/SmartBookmark&quot;;</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineat">@@ -608,48 +316,64 @@ this.PlacesUIUtils = {</span>
<a href="#l6.460"></a><span id="l6.460">    *        Describes the item to be edited/added in the dialog.</span>
<a href="#l6.461"></a><span id="l6.461">    *        See documentation at the top of bookmarkProperties.js</span>
<a href="#l6.462"></a><span id="l6.462">    * @param aWindow</span>
<a href="#l6.463"></a><span id="l6.463">    *        Owner window for the new dialog.</span>
<a href="#l6.464"></a><span id="l6.464">    *</span>
<a href="#l6.465"></a><span id="l6.465">    * @see documentation at the top of bookmarkProperties.js</span>
<a href="#l6.466"></a><span id="l6.466">    * @return true if any transaction has been performed, false otherwise.</span>
<a href="#l6.467"></a><span id="l6.467">    */</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineminus">-  showBookmarkDialog:</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineminus">-  function PUIU_showBookmarkDialog(aInfo, aParentWindow) {</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineplus">+  showBookmarkDialog(aInfo, aParentWindow) {</span>
<a href="#l6.471"></a><span id="l6.471">     // Preserve size attributes differently based on the fact the dialog has</span>
<a href="#l6.472"></a><span id="l6.472">     // a folder picker or not, since it needs more horizontal space than the</span>
<a href="#l6.473"></a><span id="l6.473">     // other controls.</span>
<a href="#l6.474"></a><span id="l6.474">     let hasFolderPicker = !(&quot;hiddenRows&quot; in aInfo) ||</span>
<a href="#l6.475"></a><span id="l6.475">                           !aInfo.hiddenRows.includes(&quot;folderPicker&quot;);</span>
<a href="#l6.476"></a><span id="l6.476">     // Use a different chrome url to persist different sizes.</span>
<a href="#l6.477"></a><span id="l6.477">     let dialogURL = hasFolderPicker ?</span>
<a href="#l6.478"></a><span id="l6.478">                     &quot;chrome://communicator/content/places/bookmarkProperties2.xul&quot; :</span>
<a href="#l6.479"></a><span id="l6.479">                     &quot;chrome://communicator/content/places/bookmarkProperties.xul&quot;;</span>
<a href="#l6.480"></a><span id="l6.480"> </span>
<a href="#l6.481"></a><span id="l6.481">     let features = &quot;centerscreen,chrome,modal,resizable=yes&quot;;</span>
<a href="#l6.482"></a><span id="l6.482" class="difflineplus">+</span>
<a href="#l6.483"></a><span id="l6.483" class="difflineplus">+    let topUndoEntry;</span>
<a href="#l6.484"></a><span id="l6.484" class="difflineplus">+    let batchBlockingDeferred;</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineplus">+</span>
<a href="#l6.486"></a><span id="l6.486" class="difflineplus">+    // Set the transaction manager into batching mode.</span>
<a href="#l6.487"></a><span id="l6.487" class="difflineplus">+    topUndoEntry = PlacesTransactions.topUndoEntry;</span>
<a href="#l6.488"></a><span id="l6.488" class="difflineplus">+    batchBlockingDeferred = PromiseUtils.defer();</span>
<a href="#l6.489"></a><span id="l6.489" class="difflineplus">+    PlacesTransactions.batch(async () =&gt; {</span>
<a href="#l6.490"></a><span id="l6.490" class="difflineplus">+      await batchBlockingDeferred.promise;</span>
<a href="#l6.491"></a><span id="l6.491" class="difflineplus">+    });</span>
<a href="#l6.492"></a><span id="l6.492" class="difflineplus">+</span>
<a href="#l6.493"></a><span id="l6.493">     aParentWindow.openDialog(dialogURL, &quot;&quot;, features, aInfo);</span>
<a href="#l6.494"></a><span id="l6.494" class="difflineminus">-    return (&quot;performed&quot; in aInfo &amp;&amp; aInfo.performed);</span>
<a href="#l6.495"></a><span id="l6.495" class="difflineminus">-  },</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineplus">+</span>
<a href="#l6.497"></a><span id="l6.497" class="difflineplus">+    let performed = (&quot;performed&quot; in aInfo &amp;&amp; aInfo.performed);</span>
<a href="#l6.498"></a><span id="l6.498" class="difflineplus">+</span>
<a href="#l6.499"></a><span id="l6.499" class="difflineplus">+    batchBlockingDeferred.resolve();</span>
<a href="#l6.500"></a><span id="l6.500"> </span>
<a href="#l6.501"></a><span id="l6.501" class="difflineminus">-  _getTopBrowserWin: function PUIU__getTopBrowserWin() {</span>
<a href="#l6.502"></a><span id="l6.502" class="difflineminus">-    return RecentWindow.getMostRecentBrowserWindow();</span>
<a href="#l6.503"></a><span id="l6.503" class="difflineplus">+    if (!performed &amp;&amp;</span>
<a href="#l6.504"></a><span id="l6.504" class="difflineplus">+        topUndoEntry != PlacesTransactions.topUndoEntry) {</span>
<a href="#l6.505"></a><span id="l6.505" class="difflineplus">+      PlacesTransactions.undo().catch(Cu.reportError);</span>
<a href="#l6.506"></a><span id="l6.506" class="difflineplus">+    }</span>
<a href="#l6.507"></a><span id="l6.507" class="difflineplus">+</span>
<a href="#l6.508"></a><span id="l6.508" class="difflineplus">+    return performed;</span>
<a href="#l6.509"></a><span id="l6.509">   },</span>
<a href="#l6.510"></a><span id="l6.510"> </span>
<a href="#l6.511"></a><span id="l6.511">   /**</span>
<a href="#l6.512"></a><span id="l6.512">    * set and fetch a favicon. Can only be used from the parent process.</span>
<a href="#l6.513"></a><span id="l6.513">    * @param browser   {Browser}   The XUL browser element for which we're fetching a favicon.</span>
<a href="#l6.514"></a><span id="l6.514">    * @param principal {Principal} The loading principal to use for the fetch.</span>
<a href="#l6.515"></a><span id="l6.515">    * @param uri       {URI}       The URI to fetch.</span>
<a href="#l6.516"></a><span id="l6.516">    */</span>
<a href="#l6.517"></a><span id="l6.517" class="difflineminus">-  loadFavicon(browser, principal, uri) {</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineplus">+  loadFavicon(browser, principal, uri, requestContextID) {</span>
<a href="#l6.519"></a><span id="l6.519">     if (gInContentProcess) {</span>
<a href="#l6.520"></a><span id="l6.520">       throw new Error(&quot;Can't track loads from within the child process!&quot;);</span>
<a href="#l6.521"></a><span id="l6.521">     }</span>
<a href="#l6.522"></a><span id="l6.522" class="difflineminus">-    InternalFaviconLoader.loadFavicon(browser, principal, uri);</span>
<a href="#l6.523"></a><span id="l6.523" class="difflineplus">+    InternalFaviconLoader.loadFavicon(browser, principal, uri, requestContextID);</span>
<a href="#l6.524"></a><span id="l6.524">   },</span>
<a href="#l6.525"></a><span id="l6.525"> </span>
<a href="#l6.526"></a><span id="l6.526">   /**</span>
<a href="#l6.527"></a><span id="l6.527">    * Returns the closet ancestor places view for the given DOM node</span>
<a href="#l6.528"></a><span id="l6.528">    * @param aNode</span>
<a href="#l6.529"></a><span id="l6.529">    *        a DOM node</span>
<a href="#l6.530"></a><span id="l6.530">    * @return the closet ancestor places view if exists, null otherwsie.</span>
<a href="#l6.531"></a><span id="l6.531">    */</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineat">@@ -720,23 +444,22 @@ this.PlacesUIUtils = {</span>
<a href="#l6.533"></a><span id="l6.533">    *        a window on which a potential error alert is shown on.</span>
<a href="#l6.534"></a><span id="l6.534">    * @return true if it's safe to open the node in the browser, false otherwise.</span>
<a href="#l6.535"></a><span id="l6.535">    *</span>
<a href="#l6.536"></a><span id="l6.536">    */</span>
<a href="#l6.537"></a><span id="l6.537">   checkURLSecurity: function PUIU_checkURLSecurity(aURINode, aWindow) {</span>
<a href="#l6.538"></a><span id="l6.538">     if (PlacesUtils.nodeIsBookmark(aURINode))</span>
<a href="#l6.539"></a><span id="l6.539">       return true;</span>
<a href="#l6.540"></a><span id="l6.540"> </span>
<a href="#l6.541"></a><span id="l6.541" class="difflineminus">-    var uri = PlacesUtils._uri(aURINode.uri);</span>
<a href="#l6.542"></a><span id="l6.542" class="difflineplus">+    var uri = Services.io.newURI(aURINode.uri);</span>
<a href="#l6.543"></a><span id="l6.543">     if (uri.schemeIs(&quot;javascript&quot;) || uri.schemeIs(&quot;data&quot;)) {</span>
<a href="#l6.544"></a><span id="l6.544">       const BRANDING_BUNDLE_URI = &quot;chrome://branding/locale/brand.properties&quot;;</span>
<a href="#l6.545"></a><span id="l6.545" class="difflineminus">-      var brandShortName = Cc[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l6.546"></a><span id="l6.546" class="difflineminus">-                             .getService(Ci.nsIStringBundleService)</span>
<a href="#l6.547"></a><span id="l6.547" class="difflineminus">-                             .createBundle(BRANDING_BUNDLE_URI).</span>
<a href="#l6.548"></a><span id="l6.548" class="difflineminus">-                             .GetStringFromName(&quot;brandShortName&quot;);</span>
<a href="#l6.549"></a><span id="l6.549" class="difflineplus">+      var brandShortName = Services.strings</span>
<a href="#l6.550"></a><span id="l6.550" class="difflineplus">+                                   .createBundle(BRANDING_BUNDLE_URI)</span>
<a href="#l6.551"></a><span id="l6.551" class="difflineplus">+                                   .GetStringFromName(&quot;brandShortName&quot;);</span>
<a href="#l6.552"></a><span id="l6.552"> </span>
<a href="#l6.553"></a><span id="l6.553">       var errorStr = this.getString(&quot;load-js-data-url-error&quot;);</span>
<a href="#l6.554"></a><span id="l6.554">       Services.prompt.alert(aWindow, brandShortName, errorStr);</span>
<a href="#l6.555"></a><span id="l6.555">       return false;</span>
<a href="#l6.556"></a><span id="l6.556">     }</span>
<a href="#l6.557"></a><span id="l6.557">     return true;</span>
<a href="#l6.558"></a><span id="l6.558">   },</span>
<a href="#l6.559"></a><span id="l6.559"> </span>
<a href="#l6.560"></a><span id="l6.560" class="difflineat">@@ -773,19 +496,21 @@ this.PlacesUIUtils = {</span>
<a href="#l6.561"></a><span id="l6.561">   },</span>
<a href="#l6.562"></a><span id="l6.562"> </span>
<a href="#l6.563"></a><span id="l6.563">   /**</span>
<a href="#l6.564"></a><span id="l6.564">    * Check whether or not the given node represents a removable entry (either in</span>
<a href="#l6.565"></a><span id="l6.565">    * history or in bookmarks).</span>
<a href="#l6.566"></a><span id="l6.566">    *</span>
<a href="#l6.567"></a><span id="l6.567">    * @param aNode</span>
<a href="#l6.568"></a><span id="l6.568">    *        a node, except the root node of a query.</span>
<a href="#l6.569"></a><span id="l6.569" class="difflineplus">+   * @param aView</span>
<a href="#l6.570"></a><span id="l6.570" class="difflineplus">+   *        The view originating the request.</span>
<a href="#l6.571"></a><span id="l6.571">    * @return true if the aNode represents a removable entry, false otherwise.</span>
<a href="#l6.572"></a><span id="l6.572">    */</span>
<a href="#l6.573"></a><span id="l6.573" class="difflineminus">-  canUserRemove(aNode) {</span>
<a href="#l6.574"></a><span id="l6.574" class="difflineplus">+  canUserRemove(aNode, aView) {</span>
<a href="#l6.575"></a><span id="l6.575">     let parentNode = aNode.parent;</span>
<a href="#l6.576"></a><span id="l6.576">     if (!parentNode) {</span>
<a href="#l6.577"></a><span id="l6.577">       // canUserRemove doesn't accept root nodes.</span>
<a href="#l6.578"></a><span id="l6.578">       return false;</span>
<a href="#l6.579"></a><span id="l6.579">     }</span>
<a href="#l6.580"></a><span id="l6.580"> </span>
<a href="#l6.581"></a><span id="l6.581">     // If it's not a bookmark, we can remove it unless it's a child of a</span>
<a href="#l6.582"></a><span id="l6.582">     // livemark.</span>
<a href="#l6.583"></a><span id="l6.583" class="difflineat">@@ -796,70 +521,66 @@ this.PlacesUIUtils = {</span>
<a href="#l6.584"></a><span id="l6.584">       return !PlacesUtils.nodeIsFolder(parentNode);</span>
<a href="#l6.585"></a><span id="l6.585">     }</span>
<a href="#l6.586"></a><span id="l6.586"> </span>
<a href="#l6.587"></a><span id="l6.587">     // Generally it's always possible to remove children of a query.</span>
<a href="#l6.588"></a><span id="l6.588">     if (PlacesUtils.nodeIsQuery(parentNode))</span>
<a href="#l6.589"></a><span id="l6.589">       return true;</span>
<a href="#l6.590"></a><span id="l6.590"> </span>
<a href="#l6.591"></a><span id="l6.591">     // Otherwise it has to be a child of an editable folder.</span>
<a href="#l6.592"></a><span id="l6.592" class="difflineminus">-    return !this.isContentsReadOnly(parentNode);</span>
<a href="#l6.593"></a><span id="l6.593" class="difflineplus">+    return !this.isFolderReadOnly(parentNode, aView);</span>
<a href="#l6.594"></a><span id="l6.594">   },</span>
<a href="#l6.595"></a><span id="l6.595"> </span>
<a href="#l6.596"></a><span id="l6.596">   /**</span>
<a href="#l6.597"></a><span id="l6.597">    * DO NOT USE THIS API IN ADDONS. IT IS VERY LIKELY TO CHANGE WHEN THE SWITCH</span>
<a href="#l6.598"></a><span id="l6.598">    * TO GUIDS IS COMPLETE (BUG 1071511).</span>
<a href="#l6.599"></a><span id="l6.599">    *</span>
<a href="#l6.600"></a><span id="l6.600" class="difflineminus">-   * Check whether or not the given node or item-id points to a folder which</span>
<a href="#l6.601"></a><span id="l6.601" class="difflineplus">+   * Check whether or not the given Places node points to a folder which</span>
<a href="#l6.602"></a><span id="l6.602">    * should not be modified by the user (i.e. its children should be unremovable</span>
<a href="#l6.603"></a><span id="l6.603">    * and unmovable, new children should be disallowed, etc).</span>
<a href="#l6.604"></a><span id="l6.604">    * These semantics are not inherited, meaning that read-only folder may</span>
<a href="#l6.605"></a><span id="l6.605">    * contain editable items (for instance, the places root is read-only, but all</span>
<a href="#l6.606"></a><span id="l6.606">    * of its direct children aren't).</span>
<a href="#l6.607"></a><span id="l6.607">    *</span>
<a href="#l6.608"></a><span id="l6.608" class="difflineminus">-   * You should only pass folder item ids or folder nodes for aNodeOrItemId.</span>
<a href="#l6.609"></a><span id="l6.609" class="difflineminus">-   * While this is only enforced for the node case (if an item id of a separator</span>
<a href="#l6.610"></a><span id="l6.610" class="difflineminus">-   * or a bookmark is passed, false is returned), it's considered the caller's</span>
<a href="#l6.611"></a><span id="l6.611" class="difflineminus">-   * job to ensure that it checks a folder.</span>
<a href="#l6.612"></a><span id="l6.612" class="difflineminus">-   * Also note that folder-shortcuts should only be passed as result nodes.</span>
<a href="#l6.613"></a><span id="l6.613" class="difflineminus">-   * Otherwise they are just treated as bookmarks (i.e. false is returned).</span>
<a href="#l6.614"></a><span id="l6.614" class="difflineplus">+   * You should only pass folder nodes.</span>
<a href="#l6.615"></a><span id="l6.615">    *</span>
<a href="#l6.616"></a><span id="l6.616" class="difflineminus">-   * @param aNodeOrItemId</span>
<a href="#l6.617"></a><span id="l6.617" class="difflineminus">-   *        any item id or result node.</span>
<a href="#l6.618"></a><span id="l6.618" class="difflineminus">-   * @throws if aNodeOrItemId is neither an item id nor a folder result node.</span>
<a href="#l6.619"></a><span id="l6.619" class="difflineplus">+   * @param placesNode</span>
<a href="#l6.620"></a><span id="l6.620" class="difflineplus">+   *        any folder result node.</span>
<a href="#l6.621"></a><span id="l6.621" class="difflineplus">+   * @param view</span>
<a href="#l6.622"></a><span id="l6.622" class="difflineplus">+   *        The view originating the request.</span>
<a href="#l6.623"></a><span id="l6.623" class="difflineplus">+   * @throws if placesNode is not a folder result node or views is invalid.</span>
<a href="#l6.624"></a><span id="l6.624">    * @note livemark &quot;folders&quot; are considered read-only (but see bug 1072833).</span>
<a href="#l6.625"></a><span id="l6.625" class="difflineminus">-   * @return true if aItemId points to a read-only folder, false otherwise.</span>
<a href="#l6.626"></a><span id="l6.626" class="difflineplus">+   * @return true if placesNode is a read-only folder, false otherwise.</span>
<a href="#l6.627"></a><span id="l6.627">    */</span>
<a href="#l6.628"></a><span id="l6.628" class="difflineminus">-  isContentsReadOnly(aNodeOrItemId) {</span>
<a href="#l6.629"></a><span id="l6.629" class="difflineminus">-    let itemId;</span>
<a href="#l6.630"></a><span id="l6.630" class="difflineminus">-    if (typeof(aNodeOrItemId) == &quot;number&quot;) {</span>
<a href="#l6.631"></a><span id="l6.631" class="difflineminus">-      itemId = aNodeOrItemId;</span>
<a href="#l6.632"></a><span id="l6.632" class="difflineminus">-    } else if (PlacesUtils.nodeIsFolder(aNodeOrItemId)) {</span>
<a href="#l6.633"></a><span id="l6.633" class="difflineminus">-      itemId = PlacesUtils.getConcreteItemId(aNodeOrItemId);</span>
<a href="#l6.634"></a><span id="l6.634" class="difflineminus">-    } else {</span>
<a href="#l6.635"></a><span id="l6.635" class="difflineminus">-      throw new Error(&quot;invalid value for aNodeOrItemId&quot;);</span>
<a href="#l6.636"></a><span id="l6.636" class="difflineplus">+  isFolderReadOnly(placesNode, view) {</span>
<a href="#l6.637"></a><span id="l6.637" class="difflineplus">+    if (typeof placesNode != &quot;object&quot; || !PlacesUtils.nodeIsFolder(placesNode)) {</span>
<a href="#l6.638"></a><span id="l6.638" class="difflineplus">+      throw new Error(&quot;invalid value for placesNode&quot;);</span>
<a href="#l6.639"></a><span id="l6.639">     }</span>
<a href="#l6.640"></a><span id="l6.640" class="difflineminus">-</span>
<a href="#l6.641"></a><span id="l6.641" class="difflineminus">-    if (itemId == PlacesUtils.placesRootId || IsLivemark(itemId))</span>
<a href="#l6.642"></a><span id="l6.642" class="difflineplus">+    if (!view || typeof view != &quot;object&quot;) {</span>
<a href="#l6.643"></a><span id="l6.643" class="difflineplus">+      throw new Error(&quot;invalid value for aView&quot;);</span>
<a href="#l6.644"></a><span id="l6.644" class="difflineplus">+    }</span>
<a href="#l6.645"></a><span id="l6.645" class="difflineplus">+    let itemId = PlacesUtils.getConcreteItemId(placesNode);</span>
<a href="#l6.646"></a><span id="l6.646" class="difflineplus">+    if (itemId == PlacesUtils.placesRootId ||</span>
<a href="#l6.647"></a><span id="l6.647" class="difflineplus">+        view.controller.hasCachedLivemarkInfo(placesNode))</span>
<a href="#l6.648"></a><span id="l6.648">       return true;</span>
<a href="#l6.649"></a><span id="l6.649"> </span>
<a href="#l6.650"></a><span id="l6.650">     // leftPaneFolderId, and as a result, allBookmarksFolderId, is a lazy getter</span>
<a href="#l6.651"></a><span id="l6.651">     // performing at least a synchronous DB query (and on its very first call</span>
<a href="#l6.652"></a><span id="l6.652">     // in a fresh profile, it also creates the entire structure).</span>
<a href="#l6.653"></a><span id="l6.653">     // Therefore we don't want to this function, which is called very often by</span>
<a href="#l6.654"></a><span id="l6.654">     // isCommandEnabled, to ever be the one that invokes it first, especially</span>
<a href="#l6.655"></a><span id="l6.655">     // because isCommandEnabled may be called way before the left pane folder is</span>
<a href="#l6.656"></a><span id="l6.656">     // even created (for example, if the user only uses the bookmarks menu or</span>
<a href="#l6.657"></a><span id="l6.657">     // toolbar for managing bookmarks).  To do so, we avoid comparing to those</span>
<a href="#l6.658"></a><span id="l6.658">     // special folder if the lazy getter is still in place.  This is safe merely</span>
<a href="#l6.659"></a><span id="l6.659">     // because the only way to access the left pane contents goes through</span>
<a href="#l6.660"></a><span id="l6.660">     // &quot;resolving&quot; the leftPaneFolderId getter.</span>
<a href="#l6.661"></a><span id="l6.661" class="difflineminus">-    if (&quot;get&quot; in Object.getOwnPropertyDescriptor(this, &quot;leftPaneFolderId&quot;))</span>
<a href="#l6.662"></a><span id="l6.662" class="difflineplus">+    if (typeof Object.getOwnPropertyDescriptor(this, &quot;leftPaneFolderId&quot;).get == &quot;function&quot;) {</span>
<a href="#l6.663"></a><span id="l6.663">       return false;</span>
<a href="#l6.664"></a><span id="l6.664" class="difflineminus">-</span>
<a href="#l6.665"></a><span id="l6.665" class="difflineplus">+    }</span>
<a href="#l6.666"></a><span id="l6.666">     return itemId == this.leftPaneFolderId ||</span>
<a href="#l6.667"></a><span id="l6.667">            itemId == this.allBookmarksFolderId;</span>
<a href="#l6.668"></a><span id="l6.668">   },</span>
<a href="#l6.669"></a><span id="l6.669"> </span>
<a href="#l6.670"></a><span id="l6.670">   /**</span>
<a href="#l6.671"></a><span id="l6.671">    * Gives the user a chance to cancel loading lots of tabs at once</span>
<a href="#l6.672"></a><span id="l6.672">    */</span>
<a href="#l6.673"></a><span id="l6.673">   confirmOpenInTabs(numTabsToOpen, aWindow) {</span>
<a href="#l6.674"></a><span id="l6.674" class="difflineat">@@ -869,20 +590,19 @@ this.PlacesUIUtils = {</span>
<a href="#l6.675"></a><span id="l6.675">     if (Services.prefs.getBoolPref(WARN_ON_OPEN_PREF)) {</span>
<a href="#l6.676"></a><span id="l6.676">       if (numTabsToOpen &gt;= Services.prefs.getIntPref(&quot;browser.tabs.maxOpenBeforeWarn&quot;)) {</span>
<a href="#l6.677"></a><span id="l6.677">         // default to true: if it were false, we wouldn't get this far</span>
<a href="#l6.678"></a><span id="l6.678">         var warnOnOpen = { value: true };</span>
<a href="#l6.679"></a><span id="l6.679"> </span>
<a href="#l6.680"></a><span id="l6.680">         var messageKey = &quot;tabs.openWarningMultipleBranded&quot;;</span>
<a href="#l6.681"></a><span id="l6.681">         var openKey = &quot;tabs.openButtonMultiple&quot;;</span>
<a href="#l6.682"></a><span id="l6.682">         const BRANDING_BUNDLE_URI = &quot;chrome://branding/locale/brand.properties&quot;;</span>
<a href="#l6.683"></a><span id="l6.683" class="difflineminus">-        var brandShortName = Cc[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l6.684"></a><span id="l6.684" class="difflineminus">-                               .getService(Ci.nsIStringBundleService)</span>
<a href="#l6.685"></a><span id="l6.685" class="difflineminus">-                               .createBundle(BRANDING_BUNDLE_URI)</span>
<a href="#l6.686"></a><span id="l6.686" class="difflineminus">-                               .GetStringFromName(&quot;brandShortName&quot;);</span>
<a href="#l6.687"></a><span id="l6.687" class="difflineplus">+        var brandShortName = Services.strings</span>
<a href="#l6.688"></a><span id="l6.688" class="difflineplus">+                                     .createBundle(BRANDING_BUNDLE_URI)</span>
<a href="#l6.689"></a><span id="l6.689" class="difflineplus">+                                     .GetStringFromName(&quot;brandShortName&quot;);</span>
<a href="#l6.690"></a><span id="l6.690"> </span>
<a href="#l6.691"></a><span id="l6.691">         var buttonPressed = Services.prompt.confirmEx(</span>
<a href="#l6.692"></a><span id="l6.692">           aWindow,</span>
<a href="#l6.693"></a><span id="l6.693">           this.getString(&quot;tabs.openWarningTitle&quot;),</span>
<a href="#l6.694"></a><span id="l6.694">           this.getFormattedString(messageKey, [numTabsToOpen, brandShortName]),</span>
<a href="#l6.695"></a><span id="l6.695">           (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l6.696"></a><span id="l6.696">             (Services.prompt.BUTTON_TITLE_CANCEL * Services.prompt.BUTTON_POS_1),</span>
<a href="#l6.697"></a><span id="l6.697">           this.getString(openKey), null, null,</span>
<a href="#l6.698"></a><span id="l6.698" class="difflineat">@@ -908,17 +628,17 @@ this.PlacesUIUtils = {</span>
<a href="#l6.699"></a><span id="l6.699">     if (!aItemsToOpen.length)</span>
<a href="#l6.700"></a><span id="l6.700">       return;</span>
<a href="#l6.701"></a><span id="l6.701"> </span>
<a href="#l6.702"></a><span id="l6.702">     // Prefer the caller window if it's a browser window, otherwise use</span>
<a href="#l6.703"></a><span id="l6.703">     // the top browser window.</span>
<a href="#l6.704"></a><span id="l6.704">     var browserWindow = null;</span>
<a href="#l6.705"></a><span id="l6.705">     browserWindow =</span>
<a href="#l6.706"></a><span id="l6.706">       aWindow &amp;&amp; aWindow.document.documentElement.getAttribute(&quot;windowtype&quot;) == &quot;navigator:browser&quot; ?</span>
<a href="#l6.707"></a><span id="l6.707" class="difflineminus">-      aWindow : this._getTopBrowserWin();</span>
<a href="#l6.708"></a><span id="l6.708" class="difflineplus">+      aWindow : RecentWindow.getMostRecentBrowserWindow();</span>
<a href="#l6.709"></a><span id="l6.709"> </span>
<a href="#l6.710"></a><span id="l6.710">     var urls = [];</span>
<a href="#l6.711"></a><span id="l6.711">     let skipMarking = browserWindow &amp;&amp; PrivateBrowsingUtils.isWindowPrivate(browserWindow);</span>
<a href="#l6.712"></a><span id="l6.712">     for (let item of aItemsToOpen) {</span>
<a href="#l6.713"></a><span id="l6.713">       urls.push(item.uri);</span>
<a href="#l6.714"></a><span id="l6.714">       if (skipMarking) {</span>
<a href="#l6.715"></a><span id="l6.715">         continue;</span>
<a href="#l6.716"></a><span id="l6.716">       }</span>
<a href="#l6.717"></a><span id="l6.717" class="difflineat">@@ -1006,29 +726,37 @@ this.PlacesUIUtils = {</span>
<a href="#l6.718"></a><span id="l6.718">    * @param   aEvent</span>
<a href="#l6.719"></a><span id="l6.719">    *          The DOM mouse/key event with modifier keys set that track the</span>
<a href="#l6.720"></a><span id="l6.720">    *          user's preferred destination window or tab.</span>
<a href="#l6.721"></a><span id="l6.721">    */</span>
<a href="#l6.722"></a><span id="l6.722">   openNodeWithEvent:</span>
<a href="#l6.723"></a><span id="l6.723">   function PUIU_openNodeWithEvent(aNode, aEvent) {</span>
<a href="#l6.724"></a><span id="l6.724">     let window = aEvent.target.ownerGlobal;</span>
<a href="#l6.725"></a><span id="l6.725">     this._openNodeIn(aNode, window.whereToOpenLink(aEvent, false, true), window);</span>
<a href="#l6.726"></a><span id="l6.726" class="difflineplus">+</span>
<a href="#l6.727"></a><span id="l6.727" class="difflineplus">+    let where = window.whereToOpenLink(aEvent, false, true);</span>
<a href="#l6.728"></a><span id="l6.728" class="difflineplus">+    if (where == &quot;current&quot; &amp;&amp; this.loadBookmarksInTabs &amp;&amp;</span>
<a href="#l6.729"></a><span id="l6.729" class="difflineplus">+        PlacesUtils.nodeIsBookmark(aNode) &amp;&amp; !aNode.uri.startsWith(&quot;javascript:&quot;)) {</span>
<a href="#l6.730"></a><span id="l6.730" class="difflineplus">+      where = &quot;tab&quot;;</span>
<a href="#l6.731"></a><span id="l6.731" class="difflineplus">+    }</span>
<a href="#l6.732"></a><span id="l6.732" class="difflineplus">+</span>
<a href="#l6.733"></a><span id="l6.733" class="difflineplus">+    this._openNodeIn(aNode, where, window);</span>
<a href="#l6.734"></a><span id="l6.734">   },</span>
<a href="#l6.735"></a><span id="l6.735"> </span>
<a href="#l6.736"></a><span id="l6.736">   /**</span>
<a href="#l6.737"></a><span id="l6.737">    * Loads the node's URL in the appropriate tab or window or as a</span>
<a href="#l6.738"></a><span id="l6.738">    * web panel.</span>
<a href="#l6.739"></a><span id="l6.739">    * see also openUILinkIn</span>
<a href="#l6.740"></a><span id="l6.740">    */</span>
<a href="#l6.741"></a><span id="l6.741">   openNodeIn: function PUIU_openNodeIn(aNode, aWhere, aView, aPrivate) {</span>
<a href="#l6.742"></a><span id="l6.742">     let window = aView.ownerWindow;</span>
<a href="#l6.743"></a><span id="l6.743">     this._openNodeIn(aNode, aWhere, window, aPrivate);</span>
<a href="#l6.744"></a><span id="l6.744">   },</span>
<a href="#l6.745"></a><span id="l6.745"> </span>
<a href="#l6.746"></a><span id="l6.746" class="difflineminus">-  _openNodeIn: function PUIU_openNodeIn(aNode, aWhere, aWindow, aPrivate = false) {</span>
<a href="#l6.747"></a><span id="l6.747" class="difflineplus">+  _openNodeIn: function PUIU__openNodeIn(aNode, aWhere, aWindow, aPrivate = false) {</span>
<a href="#l6.748"></a><span id="l6.748">     if (aNode &amp;&amp; PlacesUtils.nodeIsURI(aNode) &amp;&amp;</span>
<a href="#l6.749"></a><span id="l6.749">         this.checkURLSecurity(aNode, aWindow)) {</span>
<a href="#l6.750"></a><span id="l6.750">       let isBookmark = PlacesUtils.nodeIsBookmark(aNode);</span>
<a href="#l6.751"></a><span id="l6.751"> </span>
<a href="#l6.752"></a><span id="l6.752">       if (!PrivateBrowsingUtils.isWindowPrivate(aWindow)) {</span>
<a href="#l6.753"></a><span id="l6.753">         if (isBookmark)</span>
<a href="#l6.754"></a><span id="l6.754">           this.markPageAsFollowedBookmark(aNode.uri);</span>
<a href="#l6.755"></a><span id="l6.755">         else</span>
<a href="#l6.756"></a><span id="l6.756" class="difflineat">@@ -1036,27 +764,27 @@ this.PlacesUIUtils = {</span>
<a href="#l6.757"></a><span id="l6.757">       }</span>
<a href="#l6.758"></a><span id="l6.758"> </span>
<a href="#l6.759"></a><span id="l6.759">       // Check whether the node is a bookmark which should be opened as</span>
<a href="#l6.760"></a><span id="l6.760">       // a web panel</span>
<a href="#l6.761"></a><span id="l6.761">       // Currently not supported in SeaMonkey. Please stay tuned.</span>
<a href="#l6.762"></a><span id="l6.762">       if (aWhere == &quot;current-NOT_YET_SUPPORTED&quot; &amp;&amp; isBookmark) {</span>
<a href="#l6.763"></a><span id="l6.763">         if (PlacesUtils.annotations</span>
<a href="#l6.764"></a><span id="l6.764">                        .itemHasAnnotation(aNode.itemId, this.LOAD_IN_SIDEBAR_ANNO)) {</span>
<a href="#l6.765"></a><span id="l6.765" class="difflineminus">-          let browserWin = this._getTopBrowserWin();</span>
<a href="#l6.766"></a><span id="l6.766" class="difflineplus">+          let browserWin = RecentWindow.getMostRecentBrowserWindow();</span>
<a href="#l6.767"></a><span id="l6.767">           if (browserWin) {</span>
<a href="#l6.768"></a><span id="l6.768">             browserWin.openWebPanel(aNode.title, aNode.uri);</span>
<a href="#l6.769"></a><span id="l6.769">             return;</span>
<a href="#l6.770"></a><span id="l6.770">           }</span>
<a href="#l6.771"></a><span id="l6.771">         }</span>
<a href="#l6.772"></a><span id="l6.772">       }</span>
<a href="#l6.773"></a><span id="l6.773"> </span>
<a href="#l6.774"></a><span id="l6.774">       aWindow.openUILinkIn(aNode.uri, aWhere, {</span>
<a href="#l6.775"></a><span id="l6.775">         allowPopups: aNode.uri.startsWith(&quot;javascript:&quot;),</span>
<a href="#l6.776"></a><span id="l6.776" class="difflineminus">-        inBackground: Services.prefs.getBoolPref(&quot;browser.tabs.loadBookmarksInBackground&quot;),</span>
<a href="#l6.777"></a><span id="l6.777" class="difflineplus">+        inBackground: this.loadBookmarksInBackground,</span>
<a href="#l6.778"></a><span id="l6.778">         private: aPrivate,</span>
<a href="#l6.779"></a><span id="l6.779">       });</span>
<a href="#l6.780"></a><span id="l6.780">     }</span>
<a href="#l6.781"></a><span id="l6.781">   },</span>
<a href="#l6.782"></a><span id="l6.782"> </span>
<a href="#l6.783"></a><span id="l6.783">   /**</span>
<a href="#l6.784"></a><span id="l6.784">    * Helper for guessing scheme from an url string.</span>
<a href="#l6.785"></a><span id="l6.785">    * Used to avoid nsIURI overhead in frequently called UI functions.</span>
<a href="#l6.786"></a><span id="l6.786" class="difflineat">@@ -1070,19 +798,19 @@ this.PlacesUIUtils = {</span>
<a href="#l6.787"></a><span id="l6.787">   guessUrlSchemeForUI: function PUIU_guessUrlSchemeForUI(aUrlString) {</span>
<a href="#l6.788"></a><span id="l6.788">     return aUrlString.substr(0, aUrlString.indexOf(&quot;:&quot;));</span>
<a href="#l6.789"></a><span id="l6.789">   },</span>
<a href="#l6.790"></a><span id="l6.790"> </span>
<a href="#l6.791"></a><span id="l6.791">   getBestTitle: function PUIU_getBestTitle(aNode, aDoNotCutTitle) {</span>
<a href="#l6.792"></a><span id="l6.792">     var title;</span>
<a href="#l6.793"></a><span id="l6.793">     if (!aNode.title &amp;&amp; PlacesUtils.nodeIsURI(aNode)) {</span>
<a href="#l6.794"></a><span id="l6.794">       // if node title is empty, try to set the label using host and filename</span>
<a href="#l6.795"></a><span id="l6.795" class="difflineminus">-      // PlacesUtils._uri() will throw if aNode.uri is not a valid URI</span>
<a href="#l6.796"></a><span id="l6.796" class="difflineplus">+      // Services.io.newURI() will throw if aNode.uri is not a valid URI</span>
<a href="#l6.797"></a><span id="l6.797">       try {</span>
<a href="#l6.798"></a><span id="l6.798" class="difflineminus">-        var uri = PlacesUtils._uri(aNode.uri);</span>
<a href="#l6.799"></a><span id="l6.799" class="difflineplus">+        var uri = Services.io.newURI(aNode.uri);</span>
<a href="#l6.800"></a><span id="l6.800">         var host = uri.host;</span>
<a href="#l6.801"></a><span id="l6.801">         var fileName = uri.QueryInterface(Ci.nsIURL).fileName;</span>
<a href="#l6.802"></a><span id="l6.802">         // if fileName is empty, use path to distinguish labels</span>
<a href="#l6.803"></a><span id="l6.803">         if (aDoNotCutTitle) {</span>
<a href="#l6.804"></a><span id="l6.804">           title = host + uri.pathQueryRef;</span>
<a href="#l6.805"></a><span id="l6.805">         } else {</span>
<a href="#l6.806"></a><span id="l6.806">           title = host + (fileName ?</span>
<a href="#l6.807"></a><span id="l6.807">                            (host ? &quot;/&quot; + this.ellipsis + &quot;/&quot; : &quot;&quot;) + fileName :</span>
<a href="#l6.808"></a><span id="l6.808" class="difflineat">@@ -1253,17 +981,17 @@ this.PlacesUIUtils = {</span>
<a href="#l6.809"></a><span id="l6.809">       }</span>
<a href="#l6.810"></a><span id="l6.810">     }</span>
<a href="#l6.811"></a><span id="l6.811"> </span>
<a href="#l6.812"></a><span id="l6.812">     // Create a new left pane folder.</span>
<a href="#l6.813"></a><span id="l6.813">     var callback = {</span>
<a href="#l6.814"></a><span id="l6.814">       // Helper to create an organizer special query.</span>
<a href="#l6.815"></a><span id="l6.815">       create_query: function CB_create_query(aQueryName, aParentId, aQueryUrl) {</span>
<a href="#l6.816"></a><span id="l6.816">         let itemId = bs.insertBookmark(aParentId,</span>
<a href="#l6.817"></a><span id="l6.817" class="difflineminus">-                                       PlacesUtils._uri(aQueryUrl),</span>
<a href="#l6.818"></a><span id="l6.818" class="difflineplus">+                                       Services.io.newURI(aQueryUrl),</span>
<a href="#l6.819"></a><span id="l6.819">                                        bs.DEFAULT_INDEX,</span>
<a href="#l6.820"></a><span id="l6.820">                                        queries[aQueryName].title);</span>
<a href="#l6.821"></a><span id="l6.821">         // Mark as special organizer query.</span>
<a href="#l6.822"></a><span id="l6.822">         as.setItemAnnotation(itemId, PlacesUIUtils.ORGANIZER_QUERY_ANNO, aQueryName,</span>
<a href="#l6.823"></a><span id="l6.823">                              0, as.EXPIRE_NEVER);</span>
<a href="#l6.824"></a><span id="l6.824">         // We should never backup this, since it changes between profiles.</span>
<a href="#l6.825"></a><span id="l6.825">         as.setItemAnnotation(itemId, PlacesUtils.EXCLUDE_FROM_BACKUP_ANNO, 1,</span>
<a href="#l6.826"></a><span id="l6.826">                              0, as.EXPIRE_NEVER);</span>
<a href="#l6.827"></a><span id="l6.827" class="difflineat">@@ -1340,17 +1068,17 @@ this.PlacesUIUtils = {</span>
<a href="#l6.828"></a><span id="l6.828"> </span>
<a href="#l6.829"></a><span id="l6.829">   /**</span>
<a href="#l6.830"></a><span id="l6.830">    * Get the folder id for the organizer left-pane folder.</span>
<a href="#l6.831"></a><span id="l6.831">    */</span>
<a href="#l6.832"></a><span id="l6.832">   get allBookmarksFolderId() {</span>
<a href="#l6.833"></a><span id="l6.833">     // ensure the left-pane root is initialized;</span>
<a href="#l6.834"></a><span id="l6.834">     this.leftPaneFolderId;</span>
<a href="#l6.835"></a><span id="l6.835">     delete this.allBookmarksFolderId;</span>
<a href="#l6.836"></a><span id="l6.836" class="difflineminus">-    return this.allBookmarksFolderId = this.leftPaneQueries[&quot;AllBookmarks&quot;];</span>
<a href="#l6.837"></a><span id="l6.837" class="difflineplus">+    return this.allBookmarksFolderId = this.leftPaneQueries.AllBookmarks;</span>
<a href="#l6.838"></a><span id="l6.838">   },</span>
<a href="#l6.839"></a><span id="l6.839"> </span>
<a href="#l6.840"></a><span id="l6.840">   /**</span>
<a href="#l6.841"></a><span id="l6.841">    * If an item is a left-pane query, returns the name of the query</span>
<a href="#l6.842"></a><span id="l6.842">    * or an empty string if not.</span>
<a href="#l6.843"></a><span id="l6.843">    *</span>
<a href="#l6.844"></a><span id="l6.844">    * @param aItemId id of a container</span>
<a href="#l6.845"></a><span id="l6.845">    * @return the name of the query, or empty string if not a left-pane query</span>
<a href="#l6.846"></a><span id="l6.846" class="difflineat">@@ -1524,229 +1252,66 @@ this.PlacesUIUtils = {</span>
<a href="#l6.847"></a><span id="l6.847"> </span>
<a href="#l6.848"></a><span id="l6.848">       get parent() {</span>
<a href="#l6.849"></a><span id="l6.849">         return parent;</span>
<a href="#l6.850"></a><span id="l6.850">       }</span>
<a href="#l6.851"></a><span id="l6.851">     });</span>
<a href="#l6.852"></a><span id="l6.852">   },</span>
<a href="#l6.853"></a><span id="l6.853"> </span>
<a href="#l6.854"></a><span id="l6.854">   /**</span>
<a href="#l6.855"></a><span id="l6.855" class="difflineminus">-   * Shortcut for calling promiseNodeLikeFromFetchInfo on the result of</span>
<a href="#l6.856"></a><span id="l6.856" class="difflineminus">-   * Bookmarks.fetch for the given guid/info object.</span>
<a href="#l6.857"></a><span id="l6.857" class="difflineplus">+   * This function wraps potentially large places transaction operations</span>
<a href="#l6.858"></a><span id="l6.858" class="difflineplus">+   * with batch notifications to the result node, hence switching the views</span>
<a href="#l6.859"></a><span id="l6.859" class="difflineplus">+   * to batch mode.</span>
<a href="#l6.860"></a><span id="l6.860">    *</span>
<a href="#l6.861"></a><span id="l6.861" class="difflineminus">-   * @see promiseNodeLikeFromFetchInfo above and Bookmarks.fetch in Bookmarks.jsm.</span>
<a href="#l6.862"></a><span id="l6.862" class="difflineplus">+   * @param {nsINavHistoryResult} resultNode The result node to turn on batching.</span>
<a href="#l6.863"></a><span id="l6.863" class="difflineplus">+   * @note If resultNode is not supplied, the function will pass-through to</span>
<a href="#l6.864"></a><span id="l6.864" class="difflineplus">+   *       functionToWrap.</span>
<a href="#l6.865"></a><span id="l6.865" class="difflineplus">+   * @param {Integer} itemsBeingChanged The count of items being changed. If the</span>
<a href="#l6.866"></a><span id="l6.866" class="difflineplus">+   *                                    count is lower than a threshold, then</span>
<a href="#l6.867"></a><span id="l6.867" class="difflineplus">+   *                                    batching won't be set.</span>
<a href="#l6.868"></a><span id="l6.868" class="difflineplus">+   * @param {Function} functionToWrap The function to</span>
<a href="#l6.869"></a><span id="l6.869">    */</span>
<a href="#l6.870"></a><span id="l6.870" class="difflineminus">-  async fetchNodeLike(aGuidOrInfo) {</span>
<a href="#l6.871"></a><span id="l6.871" class="difflineminus">-    let info = await PlacesUtils.bookmarks.fetch(aGuidOrInfo);</span>
<a href="#l6.872"></a><span id="l6.872" class="difflineminus">-    if (!info)</span>
<a href="#l6.873"></a><span id="l6.873" class="difflineminus">-      return null;</span>
<a href="#l6.874"></a><span id="l6.874" class="difflineminus">-    return this.promiseNodeLikeFromFetchInfo(info);</span>
<a href="#l6.875"></a><span id="l6.875" class="difflineminus">-  }</span>
<a href="#l6.876"></a><span id="l6.876" class="difflineplus">+  async batchUpdatesForNode(resultNode, itemsBeingChanged, functionToWrap) {</span>
<a href="#l6.877"></a><span id="l6.877" class="difflineplus">+    if (!resultNode) {</span>
<a href="#l6.878"></a><span id="l6.878" class="difflineplus">+      await functionToWrap();</span>
<a href="#l6.879"></a><span id="l6.879" class="difflineplus">+      return;</span>
<a href="#l6.880"></a><span id="l6.880" class="difflineplus">+    }</span>
<a href="#l6.881"></a><span id="l6.881" class="difflineplus">+</span>
<a href="#l6.882"></a><span id="l6.882" class="difflineplus">+    resultNode = resultNode.QueryInterface(Ci.nsINavBookmarkObserver);</span>
<a href="#l6.883"></a><span id="l6.883" class="difflineplus">+</span>
<a href="#l6.884"></a><span id="l6.884" class="difflineplus">+    if (itemsBeingChanged &gt; ITEM_CHANGED_BATCH_NOTIFICATION_THRESHOLD) {</span>
<a href="#l6.885"></a><span id="l6.885" class="difflineplus">+      resultNode.onBeginUpdateBatch();</span>
<a href="#l6.886"></a><span id="l6.886" class="difflineplus">+    }</span>
<a href="#l6.887"></a><span id="l6.887" class="difflineplus">+</span>
<a href="#l6.888"></a><span id="l6.888" class="difflineplus">+    try {</span>
<a href="#l6.889"></a><span id="l6.889" class="difflineplus">+      await functionToWrap();</span>
<a href="#l6.890"></a><span id="l6.890" class="difflineplus">+    } finally {</span>
<a href="#l6.891"></a><span id="l6.891" class="difflineplus">+      if (itemsBeingChanged &gt; ITEM_CHANGED_BATCH_NOTIFICATION_THRESHOLD) {</span>
<a href="#l6.892"></a><span id="l6.892" class="difflineplus">+        resultNode.onEndUpdateBatch();</span>
<a href="#l6.893"></a><span id="l6.893" class="difflineplus">+      }</span>
<a href="#l6.894"></a><span id="l6.894" class="difflineplus">+    }</span>
<a href="#l6.895"></a><span id="l6.895" class="difflineplus">+  },</span>
<a href="#l6.896"></a><span id="l6.896"> };</span>
<a href="#l6.897"></a><span id="l6.897"> </span>
<a href="#l6.898"></a><span id="l6.898"> </span>
<a href="#l6.899"></a><span id="l6.899"> PlacesUIUtils.PLACES_FLAVORS = [PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER,</span>
<a href="#l6.900"></a><span id="l6.900">                                 PlacesUtils.TYPE_X_MOZ_PLACE_SEPARATOR,</span>
<a href="#l6.901"></a><span id="l6.901">                                 PlacesUtils.TYPE_X_MOZ_PLACE];</span>
<a href="#l6.902"></a><span id="l6.902"> </span>
<a href="#l6.903"></a><span id="l6.903"> PlacesUIUtils.URI_FLAVORS = [PlacesUtils.TYPE_X_MOZ_URL,</span>
<a href="#l6.904"></a><span id="l6.904">                              TAB_DROP_TYPE,</span>
<a href="#l6.905"></a><span id="l6.905">                              PlacesUtils.TYPE_UNICODE],</span>
<a href="#l6.906"></a><span id="l6.906"> </span>
<a href="#l6.907"></a><span id="l6.907"> PlacesUIUtils.SUPPORTED_FLAVORS = [...PlacesUIUtils.PLACES_FLAVORS,</span>
<a href="#l6.908"></a><span id="l6.908">                                    ...PlacesUIUtils.URI_FLAVORS];</span>
<a href="#l6.909"></a><span id="l6.909"> </span>
<a href="#l6.910"></a><span id="l6.910" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(PlacesUIUtils, &quot;RDF&quot;,</span>
<a href="#l6.911"></a><span id="l6.911" class="difflineminus">-                                   &quot;@mozilla.org/rdf/rdf-service;1&quot;,</span>
<a href="#l6.912"></a><span id="l6.912" class="difflineminus">-                                   &quot;nsIRDFService&quot;);</span>
<a href="#l6.913"></a><span id="l6.913" class="difflineminus">-</span>
<a href="#l6.914"></a><span id="l6.914"> XPCOMUtils.defineLazyGetter(PlacesUIUtils, &quot;ellipsis&quot;, function() {</span>
<a href="#l6.915"></a><span id="l6.915">   return Services.prefs.getComplexValue(&quot;intl.ellipsis&quot;,</span>
<a href="#l6.916"></a><span id="l6.916">                                         Ci.nsIPrefLocalizedString).data;</span>
<a href="#l6.917"></a><span id="l6.917"> });</span>
<a href="#l6.918"></a><span id="l6.918"> </span>
<a href="#l6.919"></a><span id="l6.919" class="difflineminus">-XPCOMUtils.defineLazyGetter(PlacesUIUtils, &quot;useAsyncTransactions&quot;, function() {</span>
<a href="#l6.920"></a><span id="l6.920" class="difflineminus">-  try {</span>
<a href="#l6.921"></a><span id="l6.921" class="difflineminus">-    return Services.prefs.getBoolPref(&quot;browser.places.useAsyncTransactions&quot;);</span>
<a href="#l6.922"></a><span id="l6.922" class="difflineminus">-  } catch (ex) { }</span>
<a href="#l6.923"></a><span id="l6.923" class="difflineminus">-  return false;</span>
<a href="#l6.924"></a><span id="l6.924" class="difflineminus">-});</span>
<a href="#l6.925"></a><span id="l6.925" class="difflineminus">-</span>
<a href="#l6.926"></a><span id="l6.926" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(this, &quot;URIFixup&quot;,</span>
<a href="#l6.927"></a><span id="l6.927" class="difflineminus">-                                   &quot;@mozilla.org/docshell/urifixup;1&quot;,</span>
<a href="#l6.928"></a><span id="l6.928" class="difflineminus">-                                   &quot;nsIURIFixup&quot;);</span>
<a href="#l6.929"></a><span id="l6.929" class="difflineminus">-</span>
<a href="#l6.930"></a><span id="l6.930" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;bundle&quot;, function() {</span>
<a href="#l6.931"></a><span id="l6.931" class="difflineminus">-  const PLACES_STRING_BUNDLE_URI =</span>
<a href="#l6.932"></a><span id="l6.932" class="difflineminus">-    &quot;chrome://communicator/locale/places/places.properties&quot;;</span>
<a href="#l6.933"></a><span id="l6.933" class="difflineminus">-  return Cc[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l6.934"></a><span id="l6.934" class="difflineminus">-           .getService(Ci.nsIStringBundleService)</span>
<a href="#l6.935"></a><span id="l6.935" class="difflineminus">-           .createBundle(PLACES_STRING_BUNDLE_URI);</span>
<a href="#l6.936"></a><span id="l6.936" class="difflineminus">-});</span>
<a href="#l6.937"></a><span id="l6.937" class="difflineminus">-</span>
<a href="#l6.938"></a><span id="l6.938"> XPCOMUtils.defineLazyServiceGetter(this, &quot;focusManager&quot;,</span>
<a href="#l6.939"></a><span id="l6.939">                                    &quot;@mozilla.org/focus-manager;1&quot;,</span>
<a href="#l6.940"></a><span id="l6.940">                                    &quot;nsIFocusManager&quot;);</span>
<a href="#l6.941"></a><span id="l6.941" class="difflineminus">-/**</span>
<a href="#l6.942"></a><span id="l6.942" class="difflineminus">- * This is a compatibility shim for old PUIU.ptm users.</span>
<a href="#l6.943"></a><span id="l6.943" class="difflineminus">- *</span>
<a href="#l6.944"></a><span id="l6.944" class="difflineminus">- * If you're looking for transactions and writing new code using them, directly</span>
<a href="#l6.945"></a><span id="l6.945" class="difflineminus">- * use the transactions objects exported by the PlacesUtils.jsm module.</span>
<a href="#l6.946"></a><span id="l6.946" class="difflineminus">- *</span>
<a href="#l6.947"></a><span id="l6.947" class="difflineminus">- * This object will be removed once enough users are converted to the new API.</span>
<a href="#l6.948"></a><span id="l6.948" class="difflineminus">- */</span>
<a href="#l6.949"></a><span id="l6.949" class="difflineminus">-XPCOMUtils.defineLazyGetter(PlacesUIUtils, &quot;ptm&quot;, function() {</span>
<a href="#l6.950"></a><span id="l6.950" class="difflineminus">-  // Ensure PlacesUtils is imported in scope.</span>
<a href="#l6.951"></a><span id="l6.951" class="difflineminus">-  PlacesUtils;</span>
<a href="#l6.952"></a><span id="l6.952" class="difflineminus">-</span>
<a href="#l6.953"></a><span id="l6.953" class="difflineminus">-  return {</span>
<a href="#l6.954"></a><span id="l6.954" class="difflineminus">-    aggregateTransactions: (aName, aTransactions) =&gt;</span>
<a href="#l6.955"></a><span id="l6.955" class="difflineminus">-      new PlacesAggregatedTransaction(aName, aTransactions),</span>
<a href="#l6.956"></a><span id="l6.956" class="difflineminus">-</span>
<a href="#l6.957"></a><span id="l6.957" class="difflineminus">-    createFolder: (aName, aContainer, aIndex, aAnnotations,</span>
<a href="#l6.958"></a><span id="l6.958" class="difflineminus">-                   aChildItemsTransactions) =&gt;</span>
<a href="#l6.959"></a><span id="l6.959" class="difflineminus">-      new PlacesCreateFolderTransaction(aName, aContainer, aIndex, aAnnotations,</span>
<a href="#l6.960"></a><span id="l6.960" class="difflineminus">-                                        aChildItemsTransactions),</span>
<a href="#l6.961"></a><span id="l6.961" class="difflineminus">-</span>
<a href="#l6.962"></a><span id="l6.962" class="difflineminus">-    createItem: (aURI, aContainer, aIndex, aTitle, aKeyword,</span>
<a href="#l6.963"></a><span id="l6.963" class="difflineminus">-                 aAnnotations, aChildTransactions) =&gt;</span>
<a href="#l6.964"></a><span id="l6.964" class="difflineminus">-      new PlacesCreateBookmarkTransaction(aURI, aContainer, aIndex, aTitle,</span>
<a href="#l6.965"></a><span id="l6.965" class="difflineminus">-                                          aKeyword, aAnnotations,</span>
<a href="#l6.966"></a><span id="l6.966" class="difflineminus">-                                          aChildTransactions),</span>
<a href="#l6.967"></a><span id="l6.967" class="difflineminus">-</span>
<a href="#l6.968"></a><span id="l6.968" class="difflineminus">-    createSeparator: (aContainer, aIndex) =&gt;</span>
<a href="#l6.969"></a><span id="l6.969" class="difflineminus">-      new PlacesCreateSeparatorTransaction(aContainer, aIndex),</span>
<a href="#l6.970"></a><span id="l6.970" class="difflineminus">-</span>
<a href="#l6.971"></a><span id="l6.971" class="difflineminus">-    createLivemark: (aFeedURI, aSiteURI, aName, aContainer, aIndex,</span>
<a href="#l6.972"></a><span id="l6.972" class="difflineminus">-                     aAnnotations) =&gt;</span>
<a href="#l6.973"></a><span id="l6.973" class="difflineminus">-      new PlacesCreateLivemarkTransaction(aFeedURI, aSiteURI, aName, aContainer,</span>
<a href="#l6.974"></a><span id="l6.974" class="difflineminus">-                                          aIndex, aAnnotations),</span>
<a href="#l6.975"></a><span id="l6.975" class="difflineminus">-</span>
<a href="#l6.976"></a><span id="l6.976" class="difflineminus">-    moveItem: (aItemId, aNewContainer, aNewIndex) =&gt;</span>
<a href="#l6.977"></a><span id="l6.977" class="difflineminus">-      new PlacesMoveItemTransaction(aItemId, aNewContainer, aNewIndex),</span>
<a href="#l6.978"></a><span id="l6.978" class="difflineminus">-</span>
<a href="#l6.979"></a><span id="l6.979" class="difflineminus">-    removeItem: (aItemId) =&gt;</span>
<a href="#l6.980"></a><span id="l6.980" class="difflineminus">-      new PlacesRemoveItemTransaction(aItemId),</span>
<a href="#l6.981"></a><span id="l6.981" class="difflineminus">-</span>
<a href="#l6.982"></a><span id="l6.982" class="difflineminus">-    editItemTitle: (aItemId, aNewTitle) =&gt;</span>
<a href="#l6.983"></a><span id="l6.983" class="difflineminus">-      new PlacesEditItemTitleTransaction(aItemId, aNewTitle),</span>
<a href="#l6.984"></a><span id="l6.984" class="difflineminus">-</span>
<a href="#l6.985"></a><span id="l6.985" class="difflineminus">-    editBookmarkURI: (aItemId, aNewURI) =&gt;</span>
<a href="#l6.986"></a><span id="l6.986" class="difflineminus">-      new PlacesEditBookmarkURITransaction(aItemId, aNewURI),</span>
<a href="#l6.987"></a><span id="l6.987" class="difflineminus">-</span>
<a href="#l6.988"></a><span id="l6.988" class="difflineminus">-    setItemAnnotation: (aItemId, aAnnotationObject) =&gt;</span>
<a href="#l6.989"></a><span id="l6.989" class="difflineminus">-      new PlacesSetItemAnnotationTransaction(aItemId, aAnnotationObject),</span>
<a href="#l6.990"></a><span id="l6.990" class="difflineminus">-</span>
<a href="#l6.991"></a><span id="l6.991" class="difflineminus">-    setPageAnnotation: (aURI, aAnnotationObject) =&gt;</span>
<a href="#l6.992"></a><span id="l6.992" class="difflineminus">-      new PlacesSetPageAnnotationTransaction(aURI, aAnnotationObject),</span>
<a href="#l6.993"></a><span id="l6.993" class="difflineminus">-</span>
<a href="#l6.994"></a><span id="l6.994" class="difflineminus">-    editBookmarkKeyword: (aItemId, aNewKeyword) =&gt;</span>
<a href="#l6.995"></a><span id="l6.995" class="difflineminus">-      new PlacesEditBookmarkKeywordTransaction(aItemId, aNewKeyword),</span>
<a href="#l6.996"></a><span id="l6.996" class="difflineminus">-</span>
<a href="#l6.997"></a><span id="l6.997" class="difflineminus">-    editLivemarkSiteURI: (aLivemarkId, aSiteURI) =&gt;</span>
<a href="#l6.998"></a><span id="l6.998" class="difflineminus">-      new PlacesEditLivemarkSiteURITransaction(aLivemarkId, aSiteURI),</span>
<a href="#l6.999"></a><span id="l6.999" class="difflineminus">-</span>
<a href="#l6.1000"></a><span id="l6.1000" class="difflineminus">-    editLivemarkFeedURI: (aLivemarkId, aFeedURI) =&gt;</span>
<a href="#l6.1001"></a><span id="l6.1001" class="difflineminus">-      new PlacesEditLivemarkFeedURITransaction(aLivemarkId, aFeedURI),</span>
<a href="#l6.1002"></a><span id="l6.1002" class="difflineminus">-</span>
<a href="#l6.1003"></a><span id="l6.1003" class="difflineminus">-    editItemDateAdded: (aItemId, aNewDateAdded) =&gt;</span>
<a href="#l6.1004"></a><span id="l6.1004" class="difflineminus">-      new PlacesEditItemDateAddedTransaction(aItemId, aNewDateAdded),</span>
<a href="#l6.1005"></a><span id="l6.1005" class="difflineminus">-</span>
<a href="#l6.1006"></a><span id="l6.1006" class="difflineminus">-    editItemLastModified: (aItemId, aNewLastModified) =&gt;</span>
<a href="#l6.1007"></a><span id="l6.1007" class="difflineminus">-      new PlacesEditItemLastModifiedTransaction(aItemId, aNewLastModified),</span>
<a href="#l6.1008"></a><span id="l6.1008" class="difflineminus">-</span>
<a href="#l6.1009"></a><span id="l6.1009" class="difflineminus">-    sortFolderByName: (aFolderId) =&gt;</span>
<a href="#l6.1010"></a><span id="l6.1010" class="difflineminus">-      new PlacesSortFolderByNameTransaction(aFolderId),</span>
<a href="#l6.1011"></a><span id="l6.1011" class="difflineminus">-</span>
<a href="#l6.1012"></a><span id="l6.1012" class="difflineminus">-    tagURI: (aURI, aTags) =&gt;</span>
<a href="#l6.1013"></a><span id="l6.1013" class="difflineminus">-      new PlacesTagURITransaction(aURI, aTags),</span>
<a href="#l6.1014"></a><span id="l6.1014" class="difflineminus">-</span>
<a href="#l6.1015"></a><span id="l6.1015" class="difflineminus">-    untagURI: (aURI, aTags) =&gt;</span>
<a href="#l6.1016"></a><span id="l6.1016" class="difflineminus">-      new PlacesUntagURITransaction(aURI, aTags),</span>
<a href="#l6.1017"></a><span id="l6.1017" class="difflineminus">-</span>
<a href="#l6.1018"></a><span id="l6.1018" class="difflineminus">-    /**</span>
<a href="#l6.1019"></a><span id="l6.1019" class="difflineminus">-     * Transaction for setting/unsetting Load-in-sidebar annotation.</span>
<a href="#l6.1020"></a><span id="l6.1020" class="difflineminus">-     *</span>
<a href="#l6.1021"></a><span id="l6.1021" class="difflineminus">-     * @param aBookmarkId</span>
<a href="#l6.1022"></a><span id="l6.1022" class="difflineminus">-     *        id of the bookmark where to set Load-in-sidebar annotation.</span>
<a href="#l6.1023"></a><span id="l6.1023" class="difflineminus">-     * @param aLoadInSidebar</span>
<a href="#l6.1024"></a><span id="l6.1024" class="difflineminus">-     *        boolean value.</span>
<a href="#l6.1025"></a><span id="l6.1025" class="difflineminus">-     * @return nsITransaction object.</span>
<a href="#l6.1026"></a><span id="l6.1026" class="difflineminus">-     */</span>
<a href="#l6.1027"></a><span id="l6.1027" class="difflineminus">-    setLoadInSidebar(aItemId, aLoadInSidebar) {</span>
<a href="#l6.1028"></a><span id="l6.1028" class="difflineminus">-      let annoObj = { name: PlacesUIUtils.LOAD_IN_SIDEBAR_ANNO,</span>
<a href="#l6.1029"></a><span id="l6.1029" class="difflineminus">-                      type: Ci.nsIAnnotationService.TYPE_INT32,</span>
<a href="#l6.1030"></a><span id="l6.1030" class="difflineminus">-                      flags: 0,</span>
<a href="#l6.1031"></a><span id="l6.1031" class="difflineminus">-                      value: aLoadInSidebar,</span>
<a href="#l6.1032"></a><span id="l6.1032" class="difflineminus">-                      expires: Ci.nsIAnnotationService.EXPIRE_NEVER };</span>
<a href="#l6.1033"></a><span id="l6.1033" class="difflineminus">-      return new PlacesSetItemAnnotationTransaction(aItemId, annoObj);</span>
<a href="#l6.1034"></a><span id="l6.1034" class="difflineminus">-    },</span>
<a href="#l6.1035"></a><span id="l6.1035" class="difflineminus">-</span>
<a href="#l6.1036"></a><span id="l6.1036" class="difflineminus">-   /**</span>
<a href="#l6.1037"></a><span id="l6.1037" class="difflineminus">-    * Transaction for editing the description of a bookmark or a folder.</span>
<a href="#l6.1038"></a><span id="l6.1038" class="difflineminus">-    *</span>
<a href="#l6.1039"></a><span id="l6.1039" class="difflineminus">-    * @param aItemId</span>
<a href="#l6.1040"></a><span id="l6.1040" class="difflineminus">-    *        id of the item to edit.</span>
<a href="#l6.1041"></a><span id="l6.1041" class="difflineminus">-    * @param aDescription</span>
<a href="#l6.1042"></a><span id="l6.1042" class="difflineminus">-    *        new description.</span>
<a href="#l6.1043"></a><span id="l6.1043" class="difflineminus">-    * @return nsITransaction object.</span>
<a href="#l6.1044"></a><span id="l6.1044" class="difflineminus">-    */</span>
<a href="#l6.1045"></a><span id="l6.1045" class="difflineminus">-    editItemDescription(aItemId, aDescription) {</span>
<a href="#l6.1046"></a><span id="l6.1046" class="difflineminus">-      let annoObj = { name: PlacesUIUtils.DESCRIPTION_ANNO,</span>
<a href="#l6.1047"></a><span id="l6.1047" class="difflineminus">-                      type: Ci.nsIAnnotationService.TYPE_STRING,</span>
<a href="#l6.1048"></a><span id="l6.1048" class="difflineminus">-                      flags: 0,</span>
<a href="#l6.1049"></a><span id="l6.1049" class="difflineminus">-                      value: aDescription,</span>
<a href="#l6.1050"></a><span id="l6.1050" class="difflineminus">-                      expires: Ci.nsIAnnotationService.EXPIRE_NEVER };</span>
<a href="#l6.1051"></a><span id="l6.1051" class="difflineminus">-      return new PlacesSetItemAnnotationTransaction(aItemId, annoObj);</span>
<a href="#l6.1052"></a><span id="l6.1052" class="difflineminus">-    },</span>
<a href="#l6.1053"></a><span id="l6.1053" class="difflineminus">-</span>
<a href="#l6.1054"></a><span id="l6.1054" class="difflineminus">-    // nsITransactionManager forwarders.</span>
<a href="#l6.1055"></a><span id="l6.1055" class="difflineminus">-</span>
<a href="#l6.1056"></a><span id="l6.1056" class="difflineminus">-    beginBatch: () =&gt;</span>
<a href="#l6.1057"></a><span id="l6.1057" class="difflineminus">-      PlacesUtils.transactionManager.beginBatch(null),</span>
<a href="#l6.1058"></a><span id="l6.1058" class="difflineminus">-</span>
<a href="#l6.1059"></a><span id="l6.1059" class="difflineminus">-    endBatch: () =&gt;</span>
<a href="#l6.1060"></a><span id="l6.1060" class="difflineminus">-      PlacesUtils.transactionManager.endBatch(false),</span>
<a href="#l6.1061"></a><span id="l6.1061" class="difflineminus">-</span>
<a href="#l6.1062"></a><span id="l6.1062" class="difflineminus">-    doTransaction: (txn) =&gt;</span>
<a href="#l6.1063"></a><span id="l6.1063" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(txn),</span>
<a href="#l6.1064"></a><span id="l6.1064" class="difflineminus">-</span>
<a href="#l6.1065"></a><span id="l6.1065" class="difflineminus">-    undoTransaction: () =&gt;</span>
<a href="#l6.1066"></a><span id="l6.1066" class="difflineminus">-      PlacesUtils.transactionManager.undoTransaction(),</span>
<a href="#l6.1067"></a><span id="l6.1067" class="difflineminus">-</span>
<a href="#l6.1068"></a><span id="l6.1068" class="difflineminus">-    redoTransaction: () =&gt;</span>
<a href="#l6.1069"></a><span id="l6.1069" class="difflineminus">-      PlacesUtils.transactionManager.redoTransaction(),</span>
<a href="#l6.1070"></a><span id="l6.1070" class="difflineminus">-</span>
<a href="#l6.1071"></a><span id="l6.1071" class="difflineminus">-    get numberOfUndoItems() {</span>
<a href="#l6.1072"></a><span id="l6.1072" class="difflineminus">-      return PlacesUtils.transactionManager.numberOfUndoItems;</span>
<a href="#l6.1073"></a><span id="l6.1073" class="difflineminus">-    },</span>
<a href="#l6.1074"></a><span id="l6.1074" class="difflineminus">-    get numberOfRedoItems() {</span>
<a href="#l6.1075"></a><span id="l6.1075" class="difflineminus">-      return PlacesUtils.transactionManager.numberOfRedoItems;</span>
<a href="#l6.1076"></a><span id="l6.1076" class="difflineminus">-    },</span>
<a href="#l6.1077"></a><span id="l6.1077" class="difflineminus">-    get maxTransactionCount() {</span>
<a href="#l6.1078"></a><span id="l6.1078" class="difflineminus">-      return PlacesUtils.transactionManager.maxTransactionCount;</span>
<a href="#l6.1079"></a><span id="l6.1079" class="difflineminus">-    },</span>
<a href="#l6.1080"></a><span id="l6.1080" class="difflineminus">-    set maxTransactionCount(val) {</span>
<a href="#l6.1081"></a><span id="l6.1081" class="difflineminus">-      PlacesUtils.transactionManager.maxTransactionCount = val;</span>
<a href="#l6.1082"></a><span id="l6.1082" class="difflineminus">-    },</span>
<a href="#l6.1083"></a><span id="l6.1083" class="difflineminus">-</span>
<a href="#l6.1084"></a><span id="l6.1084" class="difflineminus">-    clear: () =&gt;</span>
<a href="#l6.1085"></a><span id="l6.1085" class="difflineminus">-      PlacesUtils.transactionManager.clear(),</span>
<a href="#l6.1086"></a><span id="l6.1086" class="difflineminus">-</span>
<a href="#l6.1087"></a><span id="l6.1087" class="difflineminus">-    peekUndoStack: () =&gt;</span>
<a href="#l6.1088"></a><span id="l6.1088" class="difflineminus">-      PlacesUtils.transactionManager.peekUndoStack(),</span>
<a href="#l6.1089"></a><span id="l6.1089" class="difflineminus">-</span>
<a href="#l6.1090"></a><span id="l6.1090" class="difflineminus">-    peekRedoStack: () =&gt;</span>
<a href="#l6.1091"></a><span id="l6.1091" class="difflineminus">-      PlacesUtils.transactionManager.peekRedoStack(),</span>
<a href="#l6.1092"></a><span id="l6.1092" class="difflineminus">-</span>
<a href="#l6.1093"></a><span id="l6.1093" class="difflineminus">-    getUndoStack: () =&gt;</span>
<a href="#l6.1094"></a><span id="l6.1094" class="difflineminus">-      PlacesUtils.transactionManager.getUndoStack(),</span>
<a href="#l6.1095"></a><span id="l6.1095" class="difflineminus">-</span>
<a href="#l6.1096"></a><span id="l6.1096" class="difflineminus">-    getRedoStack: () =&gt;</span>
<a href="#l6.1097"></a><span id="l6.1097" class="difflineminus">-      PlacesUtils.transactionManager.getRedoStack(),</span>
<a href="#l6.1098"></a><span id="l6.1098" class="difflineminus">-</span>
<a href="#l6.1099"></a><span id="l6.1099" class="difflineminus">-    AddListener: (aListener) =&gt;</span>
<a href="#l6.1100"></a><span id="l6.1100" class="difflineminus">-      PlacesUtils.transactionManager.AddListener(aListener),</span>
<a href="#l6.1101"></a><span id="l6.1101" class="difflineminus">-</span>
<a href="#l6.1102"></a><span id="l6.1102" class="difflineminus">-    RemoveListener: (aListener) =&gt;</span>
<a href="#l6.1103"></a><span id="l6.1103" class="difflineminus">-      PlacesUtils.transactionManager.RemoveListener(aListener)</span>
<a href="#l6.1104"></a><span id="l6.1104" class="difflineminus">-  }</span>
<a href="#l6.1105"></a><span id="l6.1105" class="difflineminus">-});</span>
<a href="#l6.1106"></a><span id="l6.1106" class="difflineplus">+XPCOMUtils.defineLazyPreferenceGetter(PlacesUIUtils, &quot;loadBookmarksInBackground&quot;,</span>
<a href="#l6.1107"></a><span id="l6.1107" class="difflineplus">+                                      PREF_LOAD_BOOKMARKS_IN_BACKGROUND, false);</span>
<a href="#l6.1108"></a><span id="l6.1108" class="difflineplus">+XPCOMUtils.defineLazyPreferenceGetter(PlacesUIUtils, &quot;loadBookmarksInTabs&quot;,</span>
<a href="#l6.1109"></a><span id="l6.1109" class="difflineplus">+                                      PREF_LOAD_BOOKMARKS_IN_TABS, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/suite/common/places/content/bookmarkProperties.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/suite/common/places/content/bookmarkProperties.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -57,18 +57,16 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * been performed by the dialog.</span>
<a href="#l7.5"></a><span id="l7.5">  */</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> /* import-globals-from editBookmarkOverlay.js */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l7.10"></a><span id="l7.10"> ChromeUtils.defineModuleGetter(this, &quot;PrivateBrowsingUtils&quot;,</span>
<a href="#l7.11"></a><span id="l7.11">                                &quot;resource://gre/modules/PrivateBrowsingUtils.jsm&quot;);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;PromiseUtils&quot;,</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-                               &quot;resource://gre/modules/PromiseUtils.jsm&quot;);</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> const BOOKMARK_ITEM = 0;</span>
<a href="#l7.16"></a><span id="l7.16"> const BOOKMARK_FOLDER = 1;</span>
<a href="#l7.17"></a><span id="l7.17"> const LIVEMARK_CONTAINER = 2;</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> const ACTION_EDIT = 0;</span>
<a href="#l7.20"></a><span id="l7.20"> const ACTION_ADD = 1;</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -96,17 +94,16 @@ var BookmarkPropertiesPanel = {</span>
<a href="#l7.23"></a><span id="l7.23">   _keyword: &quot;&quot;,</span>
<a href="#l7.24"></a><span id="l7.24">   _postData: null,</span>
<a href="#l7.25"></a><span id="l7.25">   _charSet: &quot;&quot;,</span>
<a href="#l7.26"></a><span id="l7.26">   _feedURI: null,</span>
<a href="#l7.27"></a><span id="l7.27">   _siteURI: null,</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29">   _defaultInsertionPoint: null,</span>
<a href="#l7.30"></a><span id="l7.30">   _hiddenRows: [],</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-  _batching: false,</span>
<a href="#l7.32"></a><span id="l7.32"> </span>
<a href="#l7.33"></a><span id="l7.33">   /**</span>
<a href="#l7.34"></a><span id="l7.34">    * This method returns the correct label for the dialog's &quot;accept&quot;</span>
<a href="#l7.35"></a><span id="l7.35">    * button based on the variant of the dialog.</span>
<a href="#l7.36"></a><span id="l7.36">    */</span>
<a href="#l7.37"></a><span id="l7.37">   _getAcceptLabel: function BPP__getAcceptLabel() {</span>
<a href="#l7.38"></a><span id="l7.38">     if (this._action == ACTION_ADD) {</span>
<a href="#l7.39"></a><span id="l7.39">       if (this._URIs.length)</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineat">@@ -145,48 +142,49 @@ var BookmarkPropertiesPanel = {</span>
<a href="#l7.41"></a><span id="l7.41">       return this._strings.getFormattedString(&quot;dialogTitleEdit&quot;, [this._title]);</span>
<a href="#l7.42"></a><span id="l7.42">     }</span>
<a href="#l7.43"></a><span id="l7.43">     return &quot;&quot;;</span>
<a href="#l7.44"></a><span id="l7.44">   },</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46">   /**</span>
<a href="#l7.47"></a><span id="l7.47">    * Determines the initial data for the item edited or added by this dialog</span>
<a href="#l7.48"></a><span id="l7.48">    */</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-  _determineItemInfo() {</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+  async _determineItemInfo() {</span>
<a href="#l7.51"></a><span id="l7.51">     let dialogInfo = window.arguments[0];</span>
<a href="#l7.52"></a><span id="l7.52">     this._action = dialogInfo.action == &quot;add&quot; ? ACTION_ADD : ACTION_EDIT;</span>
<a href="#l7.53"></a><span id="l7.53">     this._hiddenRows = dialogInfo.hiddenRows ? dialogInfo.hiddenRows : [];</span>
<a href="#l7.54"></a><span id="l7.54">     if (this._action == ACTION_ADD) {</span>
<a href="#l7.55"></a><span id="l7.55">       NS_ASSERT(&quot;type&quot; in dialogInfo, &quot;missing type property for add action&quot;);</span>
<a href="#l7.56"></a><span id="l7.56"> </span>
<a href="#l7.57"></a><span id="l7.57">       if (&quot;title&quot; in dialogInfo)</span>
<a href="#l7.58"></a><span id="l7.58">         this._title = dialogInfo.title;</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60">       if (&quot;defaultInsertionPoint&quot; in dialogInfo) {</span>
<a href="#l7.61"></a><span id="l7.61">         this._defaultInsertionPoint = dialogInfo.defaultInsertionPoint;</span>
<a href="#l7.62"></a><span id="l7.62">       } else {</span>
<a href="#l7.63"></a><span id="l7.63">         this._defaultInsertionPoint =</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-          new InsertionPoint(PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-                             PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-                             Ci.nsITreeView.DROP_ON);</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+          new InsertionPoint({</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+            parentId: PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+            parentGuid: PlacesUtils.bookmarks.menuGuid</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+          });</span>
<a href="#l7.71"></a><span id="l7.71">       }</span>
<a href="#l7.72"></a><span id="l7.72"> </span>
<a href="#l7.73"></a><span id="l7.73">       switch (dialogInfo.type) {</span>
<a href="#l7.74"></a><span id="l7.74">         case &quot;bookmark&quot;:</span>
<a href="#l7.75"></a><span id="l7.75">           this._itemType = BOOKMARK_ITEM;</span>
<a href="#l7.76"></a><span id="l7.76">           if (&quot;uri&quot; in dialogInfo) {</span>
<a href="#l7.77"></a><span id="l7.77">             NS_ASSERT(dialogInfo.uri instanceof Ci.nsIURI,</span>
<a href="#l7.78"></a><span id="l7.78">                       &quot;uri property should be a uri object&quot;);</span>
<a href="#l7.79"></a><span id="l7.79">             this._uri = dialogInfo.uri;</span>
<a href="#l7.80"></a><span id="l7.80">             if (typeof(this._title) != &quot;string&quot;) {</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-              this._title = this._getURITitleFromHistory(this._uri) ||</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+              this._title = await PlacesUtils.history.fetch(this._uri) ||</span>
<a href="#l7.83"></a><span id="l7.83">                             this._uri.spec;</span>
<a href="#l7.84"></a><span id="l7.84">             }</span>
<a href="#l7.85"></a><span id="l7.85">           } else {</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-            this._uri = PlacesUtils._uri(&quot;about:blank&quot;);</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+            this._uri = Services.io.newURI(&quot;about:blank&quot;);</span>
<a href="#l7.88"></a><span id="l7.88">             this._title = this._strings.getString(&quot;newBookmarkDefault&quot;);</span>
<a href="#l7.89"></a><span id="l7.89">             this._dummyItem = true;</span>
<a href="#l7.90"></a><span id="l7.90">           }</span>
<a href="#l7.91"></a><span id="l7.91"> </span>
<a href="#l7.92"></a><span id="l7.92">           if (&quot;loadBookmarkInSidebar&quot; in dialogInfo)</span>
<a href="#l7.93"></a><span id="l7.93">             this._loadInSidebar = dialogInfo.loadBookmarkInSidebar;</span>
<a href="#l7.94"></a><span id="l7.94"> </span>
<a href="#l7.95"></a><span id="l7.95">           if (&quot;keyword&quot; in dialogInfo) {</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineat">@@ -215,17 +213,17 @@ var BookmarkPropertiesPanel = {</span>
<a href="#l7.97"></a><span id="l7.97">           this._itemType = LIVEMARK_CONTAINER;</span>
<a href="#l7.98"></a><span id="l7.98">           if (&quot;feedURI&quot; in dialogInfo)</span>
<a href="#l7.99"></a><span id="l7.99">             this._feedURI = dialogInfo.feedURI;</span>
<a href="#l7.100"></a><span id="l7.100">           if (&quot;siteURI&quot; in dialogInfo)</span>
<a href="#l7.101"></a><span id="l7.101">             this._siteURI = dialogInfo.siteURI;</span>
<a href="#l7.102"></a><span id="l7.102"> </span>
<a href="#l7.103"></a><span id="l7.103">           if (!this._title) {</span>
<a href="#l7.104"></a><span id="l7.104">             if (this._feedURI) {</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-              this._title = this._getURITitleFromHistory(this._feedURI) ||</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+              this._title = await PlacesUtils.history.fetch(this._feedURI) ||</span>
<a href="#l7.107"></a><span id="l7.107">                             this._feedURI.spec;</span>
<a href="#l7.108"></a><span id="l7.108">             } else</span>
<a href="#l7.109"></a><span id="l7.109">               this._title = this._strings.getString(&quot;newLivemarkDefault&quot;);</span>
<a href="#l7.110"></a><span id="l7.110">           }</span>
<a href="#l7.111"></a><span id="l7.111">       }</span>
<a href="#l7.112"></a><span id="l7.112"> </span>
<a href="#l7.113"></a><span id="l7.113">       if (&quot;description&quot; in dialogInfo)</span>
<a href="#l7.114"></a><span id="l7.114">         this._description = dialogInfo.description;</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineat">@@ -235,43 +233,43 @@ var BookmarkPropertiesPanel = {</span>
<a href="#l7.116"></a><span id="l7.116">       if (PlacesUtils.nodeIsFolder(this._node))</span>
<a href="#l7.117"></a><span id="l7.117">         this._itemType = BOOKMARK_FOLDER;</span>
<a href="#l7.118"></a><span id="l7.118">       else if (PlacesUtils.nodeIsURI(this._node))</span>
<a href="#l7.119"></a><span id="l7.119">         this._itemType = BOOKMARK_ITEM;</span>
<a href="#l7.120"></a><span id="l7.120">     }</span>
<a href="#l7.121"></a><span id="l7.121">   },</span>
<a href="#l7.122"></a><span id="l7.122"> </span>
<a href="#l7.123"></a><span id="l7.123">   /**</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-   * This method returns the title string corresponding to a given URI.</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-   * If none is available from the bookmark service (probably because</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-   * the given URI doesn't appear in bookmarks or history), we synthesize</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-   * a title from the first 100 characters of the URI.</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-   *</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-   * @param aURI</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-   *        nsIURI object for which we want the title</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-   *</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-   * @returns a title string</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-   */</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-  _getURITitleFromHistory: function BPP__getURITitleFromHistory(aURI) {</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-    NS_ASSERT(aURI instanceof Ci.nsIURI);</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-    // get the title from History</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-    return PlacesUtils.history.getPageTitle(aURI);</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-  },</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-  /**</span>
<a href="#l7.142"></a><span id="l7.142">    * This method should be called by the onload of the Bookmark Properties</span>
<a href="#l7.143"></a><span id="l7.143">    * dialog to initialize the state of the panel.</span>
<a href="#l7.144"></a><span id="l7.144">    */</span>
<a href="#l7.145"></a><span id="l7.145">   async onDialogLoad() {</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-    this._determineItemInfo();</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+    await this._determineItemInfo();</span>
<a href="#l7.148"></a><span id="l7.148"> </span>
<a href="#l7.149"></a><span id="l7.149">     document.title = this._getDialogTitle();</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-    var acceptButton = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+    // Disable the buttons until we have all the information required.</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+    let acceptButton = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+    acceptButton.disabled = true;</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+    // Allow initialization to complete in a truely async manner so that we're</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+    // not blocking the main thread.</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+    this._initDialog().catch(ex =&gt; {</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+      Cu.reportError(`Failed to initialize dialog: ${ex}`);</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+    });</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+  },</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+  /**</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+   * Initializes the dialog, gathering the required bookmark data. This function</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+   * will enable the accept button (if appropraite) when it is complete.</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+   */</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+  async _initDialog() {</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+    let acceptButton = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l7.169"></a><span id="l7.169">     acceptButton.label = this._getAcceptLabel();</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+    let acceptButtonDisabled = false;</span>
<a href="#l7.171"></a><span id="l7.171"> </span>
<a href="#l7.172"></a><span id="l7.172">     // Do not use sizeToContent, otherwise, due to bug 90276, the dialog will</span>
<a href="#l7.173"></a><span id="l7.173">     // grow at every opening.</span>
<a href="#l7.174"></a><span id="l7.174">     // Since elements can be uncollapsed asynchronously, we must observe their</span>
<a href="#l7.175"></a><span id="l7.175">     // mutations and resize the dialog using a cached element size.</span>
<a href="#l7.176"></a><span id="l7.176">     this._height = window.outerHeight;</span>
<a href="#l7.177"></a><span id="l7.177">     this._mutationObserver = new MutationObserver(mutations =&gt; {</span>
<a href="#l7.178"></a><span id="l7.178">       for (let mutation of mutations) {</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineat">@@ -300,24 +298,22 @@ var BookmarkPropertiesPanel = {</span>
<a href="#l7.180"></a><span id="l7.180">                                    { subtree: true,</span>
<a href="#l7.181"></a><span id="l7.181">                                      attributeOldValue: true,</span>
<a href="#l7.182"></a><span id="l7.182">                                      attributeFilter: [&quot;collapsed&quot;] });</span>
<a href="#l7.183"></a><span id="l7.183"> </span>
<a href="#l7.184"></a><span id="l7.184">     // Some controls are flexible and we want to update their cached size when</span>
<a href="#l7.185"></a><span id="l7.185">     // the dialog is resized.</span>
<a href="#l7.186"></a><span id="l7.186">     window.addEventListener(&quot;resize&quot;, this);</span>
<a href="#l7.187"></a><span id="l7.187"> </span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-    this._beginBatch();</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-</span>
<a href="#l7.190"></a><span id="l7.190">     switch (this._action) {</span>
<a href="#l7.191"></a><span id="l7.191">       case ACTION_EDIT:</span>
<a href="#l7.192"></a><span id="l7.192">         gEditItemOverlay.initPanel({ node: this._node,</span>
<a href="#l7.193"></a><span id="l7.193">                                      hiddenRows: this._hiddenRows,</span>
<a href="#l7.194"></a><span id="l7.194">                                      focusedElement: &quot;first&quot; });</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-        acceptButton.disabled = gEditItemOverlay.readOnly;</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+        acceptButtonDisabled = gEditItemOverlay.readOnly;</span>
<a href="#l7.197"></a><span id="l7.197">         break;</span>
<a href="#l7.198"></a><span id="l7.198">       case ACTION_ADD:</span>
<a href="#l7.199"></a><span id="l7.199">         this._node = await this._promiseNewItem();</span>
<a href="#l7.200"></a><span id="l7.200">         // Edit the new item</span>
<a href="#l7.201"></a><span id="l7.201">         gEditItemOverlay.initPanel({ node: this._node,</span>
<a href="#l7.202"></a><span id="l7.202">                                      hiddenRows: this._hiddenRows,</span>
<a href="#l7.203"></a><span id="l7.203">                                      postData: this._postData,</span>
<a href="#l7.204"></a><span id="l7.204">                                      focusedElement: &quot;first&quot; });</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineat">@@ -327,31 +323,33 @@ var BookmarkPropertiesPanel = {</span>
<a href="#l7.206"></a><span id="l7.206">         // disabled by the input listener until the user fills the field.</span>
<a href="#l7.207"></a><span id="l7.207">         let locationField = this._element(&quot;locationField&quot;);</span>
<a href="#l7.208"></a><span id="l7.208">         if (locationField.value == &quot;about:blank&quot;)</span>
<a href="#l7.209"></a><span id="l7.209">           locationField.value = &quot;&quot;;</span>
<a href="#l7.210"></a><span id="l7.210"> </span>
<a href="#l7.211"></a><span id="l7.211">         // if this is an uri related dialog disable accept button until</span>
<a href="#l7.212"></a><span id="l7.212">         // the user fills an uri value.</span>
<a href="#l7.213"></a><span id="l7.213">         if (this._itemType == BOOKMARK_ITEM)</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-          acceptButton.disabled = !this._inputIsValid();</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+          acceptButtonDisabled = !this._inputIsValid();</span>
<a href="#l7.216"></a><span id="l7.216">         break;</span>
<a href="#l7.217"></a><span id="l7.217">     }</span>
<a href="#l7.218"></a><span id="l7.218"> </span>
<a href="#l7.219"></a><span id="l7.219">     if (!gEditItemOverlay.readOnly) {</span>
<a href="#l7.220"></a><span id="l7.220">       // Listen on uri fields to enable accept button if input is valid</span>
<a href="#l7.221"></a><span id="l7.221">       if (this._itemType == BOOKMARK_ITEM) {</span>
<a href="#l7.222"></a><span id="l7.222">         this._element(&quot;locationField&quot;)</span>
<a href="#l7.223"></a><span id="l7.223">             .addEventListener(&quot;input&quot;, this);</span>
<a href="#l7.224"></a><span id="l7.224">         if (this._isAddKeywordDialog) {</span>
<a href="#l7.225"></a><span id="l7.225">           this._element(&quot;keywordField&quot;)</span>
<a href="#l7.226"></a><span id="l7.226">               .addEventListener(&quot;input&quot;, this);</span>
<a href="#l7.227"></a><span id="l7.227">         }</span>
<a href="#l7.228"></a><span id="l7.228">       }</span>
<a href="#l7.229"></a><span id="l7.229">     }</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+    // Only enable the accept button once we've finished everything.</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+    acceptButton.disabled = acceptButtonDisabled;</span>
<a href="#l7.232"></a><span id="l7.232">   },</span>
<a href="#l7.233"></a><span id="l7.233"> </span>
<a href="#l7.234"></a><span id="l7.234">   // nsIDOMEventListener</span>
<a href="#l7.235"></a><span id="l7.235">   handleEvent: function BPP_handleEvent(aEvent) {</span>
<a href="#l7.236"></a><span id="l7.236">     var target = aEvent.target;</span>
<a href="#l7.237"></a><span id="l7.237">     switch (aEvent.type) {</span>
<a href="#l7.238"></a><span id="l7.238">       case &quot;input&quot;:</span>
<a href="#l7.239"></a><span id="l7.239">         if (target.id == &quot;editBMPanel_locationField&quot; ||</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineat">@@ -366,47 +364,16 @@ var BookmarkPropertiesPanel = {</span>
<a href="#l7.241"></a><span id="l7.241">           let newHeight = document.getElementById(id).boxObject.height;</span>
<a href="#l7.242"></a><span id="l7.242">           this._height += -oldHeight + newHeight;</span>
<a href="#l7.243"></a><span id="l7.243">           elementsHeight.set(id, newHeight);</span>
<a href="#l7.244"></a><span id="l7.244">         }</span>
<a href="#l7.245"></a><span id="l7.245">         break;</span>
<a href="#l7.246"></a><span id="l7.246">     }</span>
<a href="#l7.247"></a><span id="l7.247">   },</span>
<a href="#l7.248"></a><span id="l7.248"> </span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-  // Hack for implementing batched-Undo around the editBookmarkOverlay</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-  // instant-apply code. For all the details see the comment above beginBatch</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-  // in browser-places.js</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-  _batchBlockingDeferred: null,</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineminus">-  _beginBatch() {</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineminus">-    if (this._batching)</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">-      return;</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">-    if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-      this._batchBlockingDeferred = PromiseUtils.defer();</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-      PlacesTransactions.batch(async () =&gt; {</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-        await this._batchBlockingDeferred.promise;</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-      });</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-    } else {</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-      PlacesUtils.transactionManager.beginBatch(null);</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">-    }</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineminus">-    this._batching = true;</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineminus">-  },</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineminus">-</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineminus">-  _endBatch() {</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineminus">-    if (!this._batching)</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-      return;</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineminus">-</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-    if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-      this._batchBlockingDeferred.resolve();</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineminus">-      this._batchBlockingDeferred = null;</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineminus">-    } else {</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineminus">-      PlacesUtils.transactionManager.endBatch(false);</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineminus">-    }</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-    this._batching = false;</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-  },</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-</span>
<a href="#l7.280"></a><span id="l7.280">   // nsISupports</span>
<a href="#l7.281"></a><span id="l7.281">   QueryInterface: function BPP_QueryInterface(aIID) {</span>
<a href="#l7.282"></a><span id="l7.282">     if (aIID.equals(Ci.nsIDOMEventListener) ||</span>
<a href="#l7.283"></a><span id="l7.283">         aIID.equals(Ci.nsISupports))</span>
<a href="#l7.284"></a><span id="l7.284">       return this;</span>
<a href="#l7.285"></a><span id="l7.285"> </span>
<a href="#l7.286"></a><span id="l7.286">     throw Cr.NS_NOINTERFACE;</span>
<a href="#l7.287"></a><span id="l7.287">   },</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineat">@@ -426,33 +393,26 @@ var BookmarkPropertiesPanel = {</span>
<a href="#l7.289"></a><span id="l7.289">     // currently registered EventListener on the EventTarget has no effect.</span>
<a href="#l7.290"></a><span id="l7.290">     this._element(&quot;locationField&quot;)</span>
<a href="#l7.291"></a><span id="l7.291">         .removeEventListener(&quot;input&quot;, this);</span>
<a href="#l7.292"></a><span id="l7.292">   },</span>
<a href="#l7.293"></a><span id="l7.293"> </span>
<a href="#l7.294"></a><span id="l7.294">   onDialogAccept() {</span>
<a href="#l7.295"></a><span id="l7.295">     // We must blur current focused element to save its changes correctly</span>
<a href="#l7.296"></a><span id="l7.296">     document.commandDispatcher.focusedElement.blur();</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineminus">-    // The order here is important! We have to uninit the panel first, otherwise</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-    // late changes could force it to commit more transactions.</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+    // We have to uninit the panel first, otherwise late changes could force it</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+    // to commit more transactions.</span>
<a href="#l7.301"></a><span id="l7.301">     gEditItemOverlay.uninitPanel(true);</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineminus">-    this._endBatch();</span>
<a href="#l7.303"></a><span id="l7.303">     window.arguments[0].performed = true;</span>
<a href="#l7.304"></a><span id="l7.304">   },</span>
<a href="#l7.305"></a><span id="l7.305"> </span>
<a href="#l7.306"></a><span id="l7.306">   onDialogCancel() {</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineminus">-    // The order here is important! We have to uninit the panel first, otherwise</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineminus">-    // changes done as part of Undo may change the panel contents and by</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineminus">-    // that force it to commit more transactions.</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+    // We have to uninit the panel first, otherwise late changes could force it</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+    // to commit more transactions.</span>
<a href="#l7.312"></a><span id="l7.312">     gEditItemOverlay.uninitPanel(true);</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineminus">-    this._endBatch();</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineminus">-    if (PlacesUIUtils.useAsyncTransactions)</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineminus">-      PlacesTransactions.undo().catch(Cu.reportError);</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineminus">-    else</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineminus">-      PlacesUtils.transactionManager.undoTransaction();</span>
<a href="#l7.318"></a><span id="l7.318">     window.arguments[0].performed = false;</span>
<a href="#l7.319"></a><span id="l7.319">   },</span>
<a href="#l7.320"></a><span id="l7.320"> </span>
<a href="#l7.321"></a><span id="l7.321">   /**</span>
<a href="#l7.322"></a><span id="l7.322">    * This method checks to see if the input fields are in a valid state.</span>
<a href="#l7.323"></a><span id="l7.323">    *</span>
<a href="#l7.324"></a><span id="l7.324">    * @returns  true if the input is valid, false otherwise</span>
<a href="#l7.325"></a><span id="l7.325">    */</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineat">@@ -488,157 +448,26 @@ var BookmarkPropertiesPanel = {</span>
<a href="#l7.327"></a><span id="l7.327"> </span>
<a href="#l7.328"></a><span id="l7.328">   /**</span>
<a href="#l7.329"></a><span id="l7.329">    * [New Item Mode] Get the insertion point details for the new item, given</span>
<a href="#l7.330"></a><span id="l7.330">    * dialog state and opening arguments.</span>
<a href="#l7.331"></a><span id="l7.331">    *</span>
<a href="#l7.332"></a><span id="l7.332">    * The container-identifier and insertion-index are returned separately in</span>
<a href="#l7.333"></a><span id="l7.333">    * the form of [containerIdentifier, insertionIndex]</span>
<a href="#l7.334"></a><span id="l7.334">    */</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineminus">-  _getInsertionPointDetails: function BPP__getInsertionPointDetails() {</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineminus">-    var containerId = this._defaultInsertionPoint.itemId;</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineminus">-    var indexInContainer = this._defaultInsertionPoint.index;</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineminus">-    return [containerId, indexInContainer];</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineminus">-  },</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineminus">-</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineminus">-  /**</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineminus">-   * Returns a transaction for creating a new bookmark item representing the</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineminus">-   * various fields and opening arguments of the dialog.</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineminus">-   */</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineminus">-  _getCreateNewBookmarkTransaction:</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineminus">-  function BPP__getCreateNewBookmarkTransaction(aContainer, aIndex) {</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineminus">-    var annotations = [];</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineminus">-    var childTransactions = [];</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineminus">-</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineminus">-    if (this._description) {</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineminus">-      let annoObj = { name: PlacesUIUtils.DESCRIPTION_ANNO,</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineminus">-                      type: Ci.nsIAnnotationService.TYPE_STRING,</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineminus">-                      flags: 0,</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineminus">-                      value: this._description,</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineminus">-                      expires: Ci.nsIAnnotationService.EXPIRE_NEVER };</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineminus">-      let editItemTxn = new PlacesSetItemAnnotationTransaction(-1, annoObj);</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineminus">-      childTransactions.push(editItemTxn);</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineminus">-    }</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineminus">-</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineminus">-    if (this._loadInSidebar) {</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineminus">-      let annoObj = { name: PlacesUIUtils.LOAD_IN_SIDEBAR_ANNO,</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-                      value: true };</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineminus">-      let setLoadTxn = new PlacesSetItemAnnotationTransaction(-1, annoObj);</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineminus">-      childTransactions.push(setLoadTxn);</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineminus">-    }</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineminus">-</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineminus">-    // XXX TODO: this should be in a transaction!</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineminus">-    if (this._charSet &amp;&amp; !PrivateBrowsingUtils.isWindowPrivate(window))</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-      PlacesUtils.setCharsetForURI(this._uri, this._charSet);</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineminus">-</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineminus">-    let createTxn = new PlacesCreateBookmarkTransaction(this._uri,</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineminus">-                                                        aContainer,</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineminus">-                                                        aIndex,</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineminus">-                                                        this._title,</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineminus">-                                                        this._keyword,</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-                                                        annotations,</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineminus">-                                                        childTransactions,</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineminus">-                                                        this._postData);</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineminus">-</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineminus">-    return new PlacesAggregatedTransaction(this._getDialogTitle(),</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-                                           [createTxn]);</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineminus">-  },</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineminus">-</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineminus">-  /**</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineminus">-   * Returns a childItems-transactions array representing the URIList with</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineminus">-   * which the dialog has been opened.</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineminus">-   */</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineminus">-  _getTransactionsForURIList: function BPP__getTransactionsForURIList() {</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineminus">-    var transactions = [];</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineminus">-    for (let uri of this._URIs) {</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineminus">-      // uri should be an object in the form { uri, title }. Though add-ons</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineminus">-      // could still use the legacy form, where it's an nsIURI.</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineminus">-      // TODO: Remove This from v57 on.</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineminus">-      let [_uri, _title] = uri instanceof Ci.nsIURI ?</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineminus">-        [uri, this._getURITitleFromHistory(uri)] : [uri.uri, uri.title];</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineminus">-</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineminus">-      let createTxn =</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineminus">-        new PlacesCreateBookmarkTransaction(_uri, -1,</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineminus">-                                            PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineminus">-                                            _title);</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineminus">-      transactions.push(createTxn);</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineminus">-    }</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineminus">-    return transactions;</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineminus">-  },</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineminus">-</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineminus">-  /**</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineminus">-   * Returns a transaction for creating a new folder item representing the</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineminus">-   * various fields and opening arguments of the dialog.</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineminus">-   */</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineminus">-  _getCreateNewFolderTransaction:</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineminus">-  function BPP__getCreateNewFolderTransaction(aContainer, aIndex) {</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineminus">-    var annotations = [];</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineminus">-    var childItemsTransactions;</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineminus">-    if (this._URIs.length)</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineminus">-      childItemsTransactions = this._getTransactionsForURIList();</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineminus">-</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineminus">-    if (this._description)</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineminus">-      annotations.push(this._getDescriptionAnnotation(this._description));</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineminus">-</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineminus">-    return new PlacesCreateFolderTransaction(this._title, aContainer,</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineminus">-                                             aIndex, annotations,</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineminus">-                                             childItemsTransactions);</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineminus">-  },</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineminus">-</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineminus">-  async _createNewItem() {</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineminus">-    let [container, index] = this._getInsertionPointDetails();</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineminus">-    let txn;</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineminus">-    switch (this._itemType) {</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineminus">-      case BOOKMARK_FOLDER:</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineminus">-        txn = this._getCreateNewFolderTransaction(container, index);</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineminus">-        break;</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineminus">-      case LIVEMARK_CONTAINER:</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineminus">-        txn = new PlacesCreateLivemarkTransaction(this._feedURI, this._siteURI,</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineminus">-                                                  this._title, container, index);</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineminus">-        break;</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineminus">-      default: // BOOKMARK_ITEM</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineminus">-        txn = this._getCreateNewBookmarkTransaction(container, index);</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineminus">-    }</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineminus">-</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineminus">-    PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineminus">-    // This is a temporary hack until we use PlacesTransactions.jsm</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineminus">-    if (txn._promise) {</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineminus">-      await txn._promise;</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineminus">-    }</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineminus">-</span>
<a href="#l7.447"></a><span id="l7.447" class="difflineminus">-    let folderGuid = await PlacesUtils.promiseItemGuid(container);</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineminus">-    let bm = await PlacesUtils.bookmarks.fetch({</span>
<a href="#l7.449"></a><span id="l7.449" class="difflineminus">-      parentGuid: folderGuid,</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineminus">-      index</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineminus">-    });</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineminus">-    this._itemId = await PlacesUtils.promiseItemId(bm.guid);</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineminus">-</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineminus">-    return Object.freeze({</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineminus">-      itemId: this._itemId,</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineminus">-      bookmarkGuid: bm.guid,</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineminus">-      title: this._title,</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineminus">-      uri: this._uri ? this._uri.spec : &quot;&quot;,</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineminus">-      type: this._itemType == BOOKMARK_ITEM ?</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineminus">-              Ci.nsINavHistoryResultNode.RESULT_TYPE_URI :</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineminus">-              Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER,</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineminus">-      parent: {</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineminus">-        itemId: container,</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineminus">-        bookmarkGuid: await PlacesUtils.promiseItemGuid(container),</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineminus">-        type: Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineminus">-      }</span>
<a href="#l7.467"></a><span id="l7.467" class="difflineminus">-    });</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineplus">+  async _getInsertionPointDetails() {</span>
<a href="#l7.469"></a><span id="l7.469" class="difflineplus">+    return [</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineplus">+      this._defaultInsertionPoint.itemId,</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineplus">+      await this._defaultInsertionPoint.getIndex(),</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineplus">+      this._defaultInsertionPoint.guid,</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineplus">+    ];</span>
<a href="#l7.474"></a><span id="l7.474">   },</span>
<a href="#l7.475"></a><span id="l7.475"> </span>
<a href="#l7.476"></a><span id="l7.476">   async _promiseNewItem() {</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineminus">-    if (!PlacesUIUtils.useAsyncTransactions)</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineminus">-      return this._createNewItem();</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineminus">-</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineminus">-    let [containerId, index] = this._getInsertionPointDetails();</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineminus">-    let parentGuid = await PlacesUtils.promiseItemGuid(containerId);</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineplus">+    let [containerId, index, parentGuid] = await this._getInsertionPointDetails();</span>
<a href="#l7.483"></a><span id="l7.483">     let annotations = [];</span>
<a href="#l7.484"></a><span id="l7.484">     if (this._description) {</span>
<a href="#l7.485"></a><span id="l7.485">       annotations.push({ name: PlacesUIUtils.DESCRIPTION_ANNO,</span>
<a href="#l7.486"></a><span id="l7.486">                          value: this._description });</span>
<a href="#l7.487"></a><span id="l7.487">     }</span>
<a href="#l7.488"></a><span id="l7.488">     if (this._loadInSidebar) {</span>
<a href="#l7.489"></a><span id="l7.489">       annotations.push({ name: PlacesUIUtils.LOAD_IN_SIDEBAR_ANNO,</span>
<a href="#l7.490"></a><span id="l7.490">                          value: true });</span>
<a href="#l7.491"></a><span id="l7.491" class="difflineat">@@ -659,24 +488,21 @@ var BookmarkPropertiesPanel = {</span>
<a href="#l7.492"></a><span id="l7.492">       itemGuid = await PlacesTransactions.NewBookmark(info).transact();</span>
<a href="#l7.493"></a><span id="l7.493">     } else if (this._itemType == LIVEMARK_CONTAINER) {</span>
<a href="#l7.494"></a><span id="l7.494">       info.feedUrl = this._feedURI;</span>
<a href="#l7.495"></a><span id="l7.495">       if (this._siteURI)</span>
<a href="#l7.496"></a><span id="l7.496">         info.siteUrl = this._siteURI;</span>
<a href="#l7.497"></a><span id="l7.497"> </span>
<a href="#l7.498"></a><span id="l7.498">       itemGuid = await PlacesTransactions.NewLivemark(info).transact();</span>
<a href="#l7.499"></a><span id="l7.499">     } else if (this._itemType == BOOKMARK_FOLDER) {</span>
<a href="#l7.500"></a><span id="l7.500" class="difflineplus">+      // NewFolder requires a url rather than uri.</span>
<a href="#l7.501"></a><span id="l7.501" class="difflineplus">+      info.children = this._URIs.map(item =&gt; {</span>
<a href="#l7.502"></a><span id="l7.502" class="difflineplus">+        return { url: item.uri, title: item.title };</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineplus">+      });</span>
<a href="#l7.504"></a><span id="l7.504">       itemGuid = await PlacesTransactions.NewFolder(info).transact();</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineminus">-      // URIs is an array of objects in the form { uri, title }.  It is still</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineminus">-      // named URIs because for backwards compatibility it could also be an</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineminus">-      // array of nsIURIs. TODO: Fix the property names from v57.</span>
<a href="#l7.508"></a><span id="l7.508" class="difflineminus">-      for (let { uri: url, title } of this._URIs) {</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineminus">-        await PlacesTransactions.NewBookmark({ parentGuid: itemGuid, url, title })</span>
<a href="#l7.510"></a><span id="l7.510" class="difflineminus">-                                .transact();</span>
<a href="#l7.511"></a><span id="l7.511" class="difflineminus">-      }</span>
<a href="#l7.512"></a><span id="l7.512">     } else {</span>
<a href="#l7.513"></a><span id="l7.513">       throw new Error(`unexpected value for _itemType:  ${this._itemType}`);</span>
<a href="#l7.514"></a><span id="l7.514">     }</span>
<a href="#l7.515"></a><span id="l7.515"> </span>
<a href="#l7.516"></a><span id="l7.516">     this._itemGuid = itemGuid;</span>
<a href="#l7.517"></a><span id="l7.517">     this._itemId = await PlacesUtils.promiseItemId(itemGuid);</span>
<a href="#l7.518"></a><span id="l7.518">     return Object.freeze({</span>
<a href="#l7.519"></a><span id="l7.519">       itemId: this._itemId,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/suite/common/places/content/bookmarksPanel.xul</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/suite/common/places/content/bookmarksPanel.xul</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -29,17 +29,17 @@</span>
<a href="#l8.4"></a><span id="l8.4">   &lt;commandset id=&quot;editMenuCommands&quot;/&gt;</span>
<a href="#l8.5"></a><span id="l8.5">   &lt;menupopup id=&quot;placesContext&quot;/&gt;</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">   &lt;!-- Bookmarks and history tooltip --&gt;</span>
<a href="#l8.8"></a><span id="l8.8">   &lt;tooltip id=&quot;bhTooltip&quot;/&gt;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10">   &lt;hbox id=&quot;sidebar-search-container&quot; align=&quot;center&quot;&gt;</span>
<a href="#l8.11"></a><span id="l8.11">     &lt;textbox id=&quot;search-box&quot; flex=&quot;1&quot; type=&quot;search&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-             placeholder=&quot;&amp;search.placeholder;&quot;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+             placeholder=&quot;&amp;bookmarksSearch.placeholder;&quot;</span>
<a href="#l8.14"></a><span id="l8.14">              aria-controls=&quot;bookmarks-view&quot;</span>
<a href="#l8.15"></a><span id="l8.15">              oncommand=&quot;searchBookmarks(this.value);&quot;/&gt;</span>
<a href="#l8.16"></a><span id="l8.16">   &lt;/hbox&gt;</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18">   &lt;tree id=&quot;bookmarks-view&quot; class=&quot;sidebar-placesTree&quot; type=&quot;places&quot;</span>
<a href="#l8.19"></a><span id="l8.19">         flex=&quot;1&quot;</span>
<a href="#l8.20"></a><span id="l8.20">         hidecolumnpicker=&quot;true&quot;</span>
<a href="#l8.21"></a><span id="l8.21">         treelines=&quot;true&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/suite/common/places/content/browserPlacesViews.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/suite/common/places/content/browserPlacesViews.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -112,22 +112,24 @@ PlacesViewBase.prototype = {</span>
<a href="#l9.4"></a><span id="l9.4">     return val;</span>
<a href="#l9.5"></a><span id="l9.5">   },</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7">   /**</span>
<a href="#l9.8"></a><span id="l9.8">    * Gets the DOM node used for the given places node.</span>
<a href="#l9.9"></a><span id="l9.9">    *</span>
<a href="#l9.10"></a><span id="l9.10">    * @param aPlacesNode</span>
<a href="#l9.11"></a><span id="l9.11">    *        a places result node.</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+   * @param aAllowMissing</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+   *        whether the node may be missing</span>
<a href="#l9.14"></a><span id="l9.14">    * @throws if there is no DOM node set for aPlacesNode.</span>
<a href="#l9.15"></a><span id="l9.15">    */</span>
<a href="#l9.16"></a><span id="l9.16">   _getDOMNodeForPlacesNode:</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-  function PVB__getDOMNodeForPlacesNode(aPlacesNode) {</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+  function PVB__getDOMNodeForPlacesNode(aPlacesNode, aAllowMissing = false) {</span>
<a href="#l9.19"></a><span id="l9.19">     let node = this._domNodes.get(aPlacesNode, null);</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-    if (!node) {</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+    if (!node &amp;&amp; !aAllowMissing) {</span>
<a href="#l9.22"></a><span id="l9.22">       throw new Error(&quot;No DOM node set for aPlacesNode.\nnode.type: &quot; +</span>
<a href="#l9.23"></a><span id="l9.23">                       aPlacesNode.type + &quot;. node.parent: &quot; + aPlacesNode);</span>
<a href="#l9.24"></a><span id="l9.24">     }</span>
<a href="#l9.25"></a><span id="l9.25">     return node;</span>
<a href="#l9.26"></a><span id="l9.26">   },</span>
<a href="#l9.27"></a><span id="l9.27"> </span>
<a href="#l9.28"></a><span id="l9.28">   get controller() {</span>
<a href="#l9.29"></a><span id="l9.29">     return this._controller;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineat">@@ -210,36 +212,44 @@ PlacesViewBase.prototype = {</span>
<a href="#l9.31"></a><span id="l9.31">           tagName = container.title;</span>
<a href="#l9.32"></a><span id="l9.32">           // TODO (Bug 1160193): properly support dropping on a tag root.</span>
<a href="#l9.33"></a><span id="l9.33">           if (!tagName)</span>
<a href="#l9.34"></a><span id="l9.34">             return null;</span>
<a href="#l9.35"></a><span id="l9.35">         }</span>
<a href="#l9.36"></a><span id="l9.36">       }</span>
<a href="#l9.37"></a><span id="l9.37">     }</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-    if (PlacesControllerDragHelper.disallowInsertion(container))</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+    if (PlacesControllerDragHelper.disallowInsertion(container, this))</span>
<a href="#l9.41"></a><span id="l9.41">       return null;</span>
<a href="#l9.42"></a><span id="l9.42"> </span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-    return new InsertionPoint(PlacesUtils.getConcreteItemId(container),</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-                              index, orientation, tagName);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+    return new InsertionPoint({</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+      parentId: PlacesUtils.getConcreteItemId(container),</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+      parentGuid: PlacesUtils.getConcreteItemGuid(container),</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+      index, orientation, tagName</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+    });</span>
<a href="#l9.50"></a><span id="l9.50">   },</span>
<a href="#l9.51"></a><span id="l9.51"> </span>
<a href="#l9.52"></a><span id="l9.52">   buildContextMenu: function PVB_buildContextMenu(aPopup) {</span>
<a href="#l9.53"></a><span id="l9.53">     this._contextMenuShown = aPopup;</span>
<a href="#l9.54"></a><span id="l9.54">     window.updateCommands(&quot;places&quot;);</span>
<a href="#l9.55"></a><span id="l9.55">     return this.controller.buildContextMenu(aPopup);</span>
<a href="#l9.56"></a><span id="l9.56">   },</span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58">   destroyContextMenu: function PVB_destroyContextMenu(aPopup) {</span>
<a href="#l9.59"></a><span id="l9.59">     this._contextMenuShown = null;</span>
<a href="#l9.60"></a><span id="l9.60">   },</span>
<a href="#l9.61"></a><span id="l9.61"> </span>
<a href="#l9.62"></a><span id="l9.62">   clearAllContents(aPopup) {</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-    while (aPopup.firstChild) {</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-      aPopup.firstChild.remove();</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+    let kid = aPopup.firstChild;</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+    while (kid) {</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+      let next = kid.nextSibling;</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+      if (!kid.classList.contains(&quot;panel-header&quot;)) {</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+        kid.remove();</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+      }</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+      kid = next;</span>
<a href="#l9.72"></a><span id="l9.72">     }</span>
<a href="#l9.73"></a><span id="l9.73">     aPopup._emptyMenuitem = aPopup._startMarker = aPopup._endMarker = null;</span>
<a href="#l9.74"></a><span id="l9.74">   },</span>
<a href="#l9.75"></a><span id="l9.75"> </span>
<a href="#l9.76"></a><span id="l9.76">   _cleanPopup: function PVB_cleanPopup(aPopup, aDelay) {</span>
<a href="#l9.77"></a><span id="l9.77">     // Ensure markers are here when `invalidateContainer` is called before the</span>
<a href="#l9.78"></a><span id="l9.78">     // popup is shown, which may the case for panelviews, for example.</span>
<a href="#l9.79"></a><span id="l9.79">     this._ensureMarkers(aPopup);</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineat">@@ -275,21 +285,22 @@ PlacesViewBase.prototype = {</span>
<a href="#l9.81"></a><span id="l9.81">       return;</span>
<a href="#l9.82"></a><span id="l9.82">     }</span>
<a href="#l9.83"></a><span id="l9.83"> </span>
<a href="#l9.84"></a><span id="l9.84">     this._cleanPopup(aPopup);</span>
<a href="#l9.85"></a><span id="l9.85"> </span>
<a href="#l9.86"></a><span id="l9.86">     let cc = resultNode.childCount;</span>
<a href="#l9.87"></a><span id="l9.87">     if (cc &gt; 0) {</span>
<a href="#l9.88"></a><span id="l9.88">       this._setEmptyPopupStatus(aPopup, false);</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+      let fragment = document.createDocumentFragment();</span>
<a href="#l9.91"></a><span id="l9.91">       for (let i = 0; i &lt; cc; ++i) {</span>
<a href="#l9.92"></a><span id="l9.92">         let child = resultNode.getChild(i);</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-        this._insertNewItemToPopup(child, aPopup, null);</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+        this._insertNewItemToPopup(child, fragment);</span>
<a href="#l9.95"></a><span id="l9.95">       }</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+      aPopup.insertBefore(fragment, aPopup._endMarker);</span>
<a href="#l9.97"></a><span id="l9.97">     } else {</span>
<a href="#l9.98"></a><span id="l9.98">       this._setEmptyPopupStatus(aPopup, true);</span>
<a href="#l9.99"></a><span id="l9.99">     }</span>
<a href="#l9.100"></a><span id="l9.100">     aPopup._built = true;</span>
<a href="#l9.101"></a><span id="l9.101">   },</span>
<a href="#l9.102"></a><span id="l9.102"> </span>
<a href="#l9.103"></a><span id="l9.103">   _removeChild: function PVB__removeChild(aChild) {</span>
<a href="#l9.104"></a><span id="l9.104">     // If document.popupNode pointed to this child, null it out,</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineat">@@ -396,26 +407,25 @@ PlacesViewBase.prototype = {</span>
<a href="#l9.106"></a><span id="l9.106">     element._placesNode = aPlacesNode;</span>
<a href="#l9.107"></a><span id="l9.107">     if (!this._domNodes.has(aPlacesNode))</span>
<a href="#l9.108"></a><span id="l9.108">       this._domNodes.set(aPlacesNode, element);</span>
<a href="#l9.109"></a><span id="l9.109"> </span>
<a href="#l9.110"></a><span id="l9.110">     return element;</span>
<a href="#l9.111"></a><span id="l9.111">   },</span>
<a href="#l9.112"></a><span id="l9.112"> </span>
<a href="#l9.113"></a><span id="l9.113">   _insertNewItemToPopup:</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-  function PVB__insertNewItemToPopup(aNewChild, aPopup, aBefore) {</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+  function PVB__insertNewItemToPopup(aNewChild, aInsertionNode, aBefore = null) {</span>
<a href="#l9.116"></a><span id="l9.116">     let element = this._createDOMNodeForPlacesNode(aNewChild);</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-    let before = aBefore || aPopup._endMarker;</span>
<a href="#l9.118"></a><span id="l9.118"> </span>
<a href="#l9.119"></a><span id="l9.119">     if (element.localName == &quot;menuitem&quot; || element.localName == &quot;menu&quot;) {</span>
<a href="#l9.120"></a><span id="l9.120">       if (typeof this.options.extraClasses.entry == &quot;string&quot;)</span>
<a href="#l9.121"></a><span id="l9.121">         element.classList.add(this.options.extraClasses.entry);</span>
<a href="#l9.122"></a><span id="l9.122">     }</span>
<a href="#l9.123"></a><span id="l9.123"> </span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-    aPopup.insertBefore(element, before);</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+    aInsertionNode.insertBefore(element, aBefore);</span>
<a href="#l9.126"></a><span id="l9.126">     return element;</span>
<a href="#l9.127"></a><span id="l9.127">   },</span>
<a href="#l9.128"></a><span id="l9.128"> </span>
<a href="#l9.129"></a><span id="l9.129">   _setLivemarkSiteURIMenuItem:</span>
<a href="#l9.130"></a><span id="l9.130">   function PVB__setLivemarkSiteURIMenuItem(aPopup) {</span>
<a href="#l9.131"></a><span id="l9.131">     let livemarkInfo = this.controller.getCachedLivemarkInfo(aPopup._placesNode);</span>
<a href="#l9.132"></a><span id="l9.132">     let siteUrl = livemarkInfo &amp;&amp; livemarkInfo.siteURI ?</span>
<a href="#l9.133"></a><span id="l9.133">                   livemarkInfo.siteURI.spec : null;</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineat">@@ -438,17 +448,17 @@ PlacesViewBase.prototype = {</span>
<a href="#l9.135"></a><span id="l9.135">       // If a user middle-clicks this item we serve the oncommand event.</span>
<a href="#l9.136"></a><span id="l9.136">       // We are using checkForMiddleClick because of Bug 246720.</span>
<a href="#l9.137"></a><span id="l9.137">       // Note: stopPropagation is needed to avoid serving middle-click</span>
<a href="#l9.138"></a><span id="l9.138">       // with BT_onClick that would open all items in tabs.</span>
<a href="#l9.139"></a><span id="l9.139">       aPopup._siteURIMenuitem.setAttribute(&quot;onclick&quot;,</span>
<a href="#l9.140"></a><span id="l9.140">         &quot;checkForMiddleClick(this, event); event.stopPropagation();&quot;);</span>
<a href="#l9.141"></a><span id="l9.141">       let label =</span>
<a href="#l9.142"></a><span id="l9.142">         PlacesUIUtils.getFormattedString(&quot;menuOpenLivemarkOrigin.label&quot;,</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-                                         [aPopup.parentNode.getAttribute(&quot;label&quot;)])</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+                                         [aPopup.parentNode.getAttribute(&quot;label&quot;)]);</span>
<a href="#l9.145"></a><span id="l9.145">       aPopup._siteURIMenuitem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l9.146"></a><span id="l9.146">       aPopup.insertBefore(aPopup._siteURIMenuitem, aPopup._startMarker);</span>
<a href="#l9.147"></a><span id="l9.147"> </span>
<a href="#l9.148"></a><span id="l9.148">       aPopup._siteURIMenuseparator = document.createElement(&quot;menuseparator&quot;);</span>
<a href="#l9.149"></a><span id="l9.149">       aPopup.insertBefore(aPopup._siteURIMenuseparator, aPopup._startMarker);</span>
<a href="#l9.150"></a><span id="l9.150">     }</span>
<a href="#l9.151"></a><span id="l9.151">   },</span>
<a href="#l9.152"></a><span id="l9.152"> </span>
<a href="#l9.153"></a><span id="l9.153" class="difflineat">@@ -627,17 +637,17 @@ PlacesViewBase.prototype = {</span>
<a href="#l9.154"></a><span id="l9.154">   function PVB_nodeInserted(aParentPlacesNode, aPlacesNode, aIndex) {</span>
<a href="#l9.155"></a><span id="l9.155">     let parentElt = this._getDOMNodeForPlacesNode(aParentPlacesNode);</span>
<a href="#l9.156"></a><span id="l9.156">     if (!parentElt._built)</span>
<a href="#l9.157"></a><span id="l9.157">       return;</span>
<a href="#l9.158"></a><span id="l9.158"> </span>
<a href="#l9.159"></a><span id="l9.159">     let index = Array.prototype.indexOf.call(parentElt.childNodes, parentElt._startMarker) +</span>
<a href="#l9.160"></a><span id="l9.160">                 aIndex + 1;</span>
<a href="#l9.161"></a><span id="l9.161">     this._insertNewItemToPopup(aPlacesNode, parentElt,</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-                               parentElt.childNodes[index]);</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+                               parentElt.childNodes[index] || parentElt._endMarker);</span>
<a href="#l9.164"></a><span id="l9.164">     this._setEmptyPopupStatus(parentElt, false);</span>
<a href="#l9.165"></a><span id="l9.165">   },</span>
<a href="#l9.166"></a><span id="l9.166"> </span>
<a href="#l9.167"></a><span id="l9.167">   nodeMoved:</span>
<a href="#l9.168"></a><span id="l9.168">   function PBV_nodeMoved(aPlacesNode,</span>
<a href="#l9.169"></a><span id="l9.169">                          aOldParentPlacesNode, aOldIndex,</span>
<a href="#l9.170"></a><span id="l9.170">                          aNewParentPlacesNode, aNewIndex) {</span>
<a href="#l9.171"></a><span id="l9.171">     // Note: the current implementation of moveItem does not actually</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineat">@@ -1028,44 +1038,64 @@ PlacesToolbar.prototype = {</span>
<a href="#l9.173"></a><span id="l9.173">     if (this._overFolder.elt)</span>
<a href="#l9.174"></a><span id="l9.174">       this._clearOverFolder();</span>
<a href="#l9.175"></a><span id="l9.175"> </span>
<a href="#l9.176"></a><span id="l9.176">     this._openedMenuButton = null;</span>
<a href="#l9.177"></a><span id="l9.177">     while (this._rootElt.hasChildNodes()) {</span>
<a href="#l9.178"></a><span id="l9.178">       this._rootElt.firstChild.remove();</span>
<a href="#l9.179"></a><span id="l9.179">     }</span>
<a href="#l9.180"></a><span id="l9.180"> </span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+    let fragment = document.createDocumentFragment();</span>
<a href="#l9.182"></a><span id="l9.182">     let cc = this._resultNode.childCount;</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-    for (let i = 0; i &lt; cc; ++i) {</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineminus">-      this._insertNewItem(this._resultNode.getChild(i), null);</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineplus">+    if (cc &gt; 0) {</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+      // There could be a lot of nodes, but we only want to build the ones that</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+      // are likely to be shown, not all of them. Then we'll lazily create the</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineplus">+      // missing nodes when needed.</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineplus">+      // We don't want to cause reflows at every node insertion to calculate</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineplus">+      // a precise size, thus we guess a size from the first node.</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineplus">+      let button = this._insertNewItem(this._resultNode.getChild(0),</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineplus">+                                       this._rootElt);</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineplus">+      requestAnimationFrame(() =&gt; {</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineplus">+        // May have been destroyed in the meanwhile.</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineplus">+        if (!this._resultNode || !this._rootElt)</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineplus">+          return;</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineplus">+        // We assume a button with just the icon will be more or less a square,</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+        // then compensate the measurement error by considering a larger screen</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+        // width. Moreover the window could be bigger than the screen.</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineplus">+        let size = button.clientHeight;</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineplus">+        let limit = Math.min(cc, parseInt((window.screen.width * 1.5) / size));</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineplus">+        for (let i = 1; i &lt; limit; ++i) {</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+          this._insertNewItem(this._resultNode.getChild(i), fragment);</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+        }</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineplus">+        this._rootElt.appendChild(fragment);</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineplus">+</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineplus">+        this.updateNodesVisibility();</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineplus">+      });</span>
<a href="#l9.209"></a><span id="l9.209">     }</span>
<a href="#l9.210"></a><span id="l9.210"> </span>
<a href="#l9.211"></a><span id="l9.211">     if (this._chevronPopup.hasAttribute(&quot;type&quot;)) {</span>
<a href="#l9.212"></a><span id="l9.212">       // Chevron has already been initialized, but since we are forcing</span>
<a href="#l9.213"></a><span id="l9.213">       // a rebuild of the toolbar, it has to be rebuilt.</span>
<a href="#l9.214"></a><span id="l9.214">       // Otherwise, it will be initialized when the toolbar overflows.</span>
<a href="#l9.215"></a><span id="l9.215">       this._chevronPopup.place = this.place;</span>
<a href="#l9.216"></a><span id="l9.216">     }</span>
<a href="#l9.217"></a><span id="l9.217">   },</span>
<a href="#l9.218"></a><span id="l9.218"> </span>
<a href="#l9.219"></a><span id="l9.219">   _insertNewItem:</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineminus">-  function PT__insertNewItem(aChild, aBefore) {</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineplus">+  function PT__insertNewItem(aChild, aInsertionNode, aBefore = null) {</span>
<a href="#l9.222"></a><span id="l9.222">     this._domNodes.delete(aChild);</span>
<a href="#l9.223"></a><span id="l9.223"> </span>
<a href="#l9.224"></a><span id="l9.224">     let type = aChild.type;</span>
<a href="#l9.225"></a><span id="l9.225">     let button;</span>
<a href="#l9.226"></a><span id="l9.226">     if (type == Ci.nsINavHistoryResultNode.RESULT_TYPE_SEPARATOR) {</span>
<a href="#l9.227"></a><span id="l9.227">       button = document.createElement(&quot;toolbarseparator&quot;);</span>
<a href="#l9.228"></a><span id="l9.228">     } else {</span>
<a href="#l9.229"></a><span id="l9.229">       button = document.createElement(&quot;toolbarbutton&quot;);</span>
<a href="#l9.230"></a><span id="l9.230">       button.className = &quot;bookmark-item&quot;;</span>
<a href="#l9.231"></a><span id="l9.231">       button.setAttribute(&quot;label&quot;, aChild.title || &quot;&quot;);</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineminus">-      let icon = aChild.icon;</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineminus">-      if (icon)</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineminus">-        button.setAttribute(&quot;image&quot;, icon);</span>
<a href="#l9.235"></a><span id="l9.235"> </span>
<a href="#l9.236"></a><span id="l9.236">       if (PlacesUtils.containerTypes.includes(type)) {</span>
<a href="#l9.237"></a><span id="l9.237">         button.setAttribute(&quot;type&quot;, &quot;menu&quot;);</span>
<a href="#l9.238"></a><span id="l9.238">         button.setAttribute(&quot;container&quot;, &quot;true&quot;);</span>
<a href="#l9.239"></a><span id="l9.239"> </span>
<a href="#l9.240"></a><span id="l9.240">         if (PlacesUtils.nodeIsQuery(aChild)) {</span>
<a href="#l9.241"></a><span id="l9.241">           button.setAttribute(&quot;query&quot;, &quot;true&quot;);</span>
<a href="#l9.242"></a><span id="l9.242">           if (PlacesUtils.nodeIsTagQuery(aChild))</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineat">@@ -1091,27 +1121,30 @@ PlacesToolbar.prototype = {</span>
<a href="#l9.244"></a><span id="l9.244">       }</span>
<a href="#l9.245"></a><span id="l9.245">     }</span>
<a href="#l9.246"></a><span id="l9.246"> </span>
<a href="#l9.247"></a><span id="l9.247">     button._placesNode = aChild;</span>
<a href="#l9.248"></a><span id="l9.248">     if (!this._domNodes.has(aChild))</span>
<a href="#l9.249"></a><span id="l9.249">       this._domNodes.set(aChild, button);</span>
<a href="#l9.250"></a><span id="l9.250"> </span>
<a href="#l9.251"></a><span id="l9.251">     if (aBefore)</span>
<a href="#l9.252"></a><span id="l9.252" class="difflineminus">-      this._rootElt.insertBefore(button, aBefore);</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineplus">+      aInsertionNode.insertBefore(button, aBefore);</span>
<a href="#l9.254"></a><span id="l9.254">     else</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineminus">-      this._rootElt.appendChild(button);</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineplus">+      aInsertionNode.appendChild(button);</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineplus">+    return button;</span>
<a href="#l9.258"></a><span id="l9.258">   },</span>
<a href="#l9.259"></a><span id="l9.259"> </span>
<a href="#l9.260"></a><span id="l9.260">   _updateChevronPopupNodesVisibility:</span>
<a href="#l9.261"></a><span id="l9.261">   function PT__updateChevronPopupNodesVisibility() {</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineminus">-    for (let i = 0, node = this._chevronPopup._startMarker.nextSibling;</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineminus">-         node != this._chevronPopup._endMarker;</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineminus">-         i++, node = node.nextSibling) {</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineminus">-      node.hidden = this._rootElt.childNodes[i].style.visibility != &quot;hidden&quot;;</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineplus">+    // Note the toolbar by default builds less nodes than the chevron popup.</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineplus">+    for (let toolbarNode = this._rootElt.firstChild,</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineplus">+         node = this._chevronPopup._startMarker.nextSibling;</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineplus">+         toolbarNode &amp;&amp; node;</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+         toolbarNode = toolbarNode.nextSibling, node = node.nextSibling) {</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineplus">+      node.hidden = toolbarNode.style.visibility != &quot;hidden&quot;;</span>
<a href="#l9.272"></a><span id="l9.272">     }</span>
<a href="#l9.273"></a><span id="l9.273">   },</span>
<a href="#l9.274"></a><span id="l9.274"> </span>
<a href="#l9.275"></a><span id="l9.275">   _onChevronPopupShowing:</span>
<a href="#l9.276"></a><span id="l9.276">   function PT__onChevronPopupShowing(aEvent) {</span>
<a href="#l9.277"></a><span id="l9.277">     // Handle popupshowing only for the chevron popup, not for nested ones.</span>
<a href="#l9.278"></a><span id="l9.278">     if (aEvent.target != this._chevronPopup)</span>
<a href="#l9.279"></a><span id="l9.279">       return;</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineat">@@ -1126,31 +1159,33 @@ PlacesToolbar.prototype = {</span>
<a href="#l9.281"></a><span id="l9.281">     switch (aEvent.type) {</span>
<a href="#l9.282"></a><span id="l9.282">       case &quot;unload&quot;:</span>
<a href="#l9.283"></a><span id="l9.283">         this.uninit();</span>
<a href="#l9.284"></a><span id="l9.284">         break;</span>
<a href="#l9.285"></a><span id="l9.285">       case &quot;resize&quot;:</span>
<a href="#l9.286"></a><span id="l9.286">         // This handler updates nodes visibility in both the toolbar</span>
<a href="#l9.287"></a><span id="l9.287">         // and the chevron popup when a window resize does not change</span>
<a href="#l9.288"></a><span id="l9.288">         // the overflow status of the toolbar.</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineminus">-        this.updateChevron();</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineplus">+        if (aEvent.target == aEvent.currentTarget) {</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineplus">+          this.updateNodesVisibility();</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineplus">+        }</span>
<a href="#l9.293"></a><span id="l9.293">         break;</span>
<a href="#l9.294"></a><span id="l9.294">       case &quot;overflow&quot;:</span>
<a href="#l9.295"></a><span id="l9.295">         if (!this._isOverflowStateEventRelevant(aEvent))</span>
<a href="#l9.296"></a><span id="l9.296">           return;</span>
<a href="#l9.297"></a><span id="l9.297">         this._onOverflow();</span>
<a href="#l9.298"></a><span id="l9.298">         break;</span>
<a href="#l9.299"></a><span id="l9.299">       case &quot;underflow&quot;:</span>
<a href="#l9.300"></a><span id="l9.300">         if (!this._isOverflowStateEventRelevant(aEvent))</span>
<a href="#l9.301"></a><span id="l9.301">           return;</span>
<a href="#l9.302"></a><span id="l9.302">         this._onUnderflow();</span>
<a href="#l9.303"></a><span id="l9.303">         break;</span>
<a href="#l9.304"></a><span id="l9.304">       case &quot;TabOpen&quot;:</span>
<a href="#l9.305"></a><span id="l9.305">       case &quot;TabClose&quot;:</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineminus">-        this.updateChevron();</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineplus">+        this.updateNodesVisibility();</span>
<a href="#l9.308"></a><span id="l9.308">         break;</span>
<a href="#l9.309"></a><span id="l9.309">       case &quot;dragstart&quot;:</span>
<a href="#l9.310"></a><span id="l9.310">         this._onDragStart(aEvent);</span>
<a href="#l9.311"></a><span id="l9.311">         break;</span>
<a href="#l9.312"></a><span id="l9.312">       case &quot;dragover&quot;:</span>
<a href="#l9.313"></a><span id="l9.313">         this._onDragOver(aEvent);</span>
<a href="#l9.314"></a><span id="l9.314">         break;</span>
<a href="#l9.315"></a><span id="l9.315">       case &quot;dragexit&quot;:</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineat">@@ -1177,156 +1212,209 @@ PlacesToolbar.prototype = {</span>
<a href="#l9.317"></a><span id="l9.317">       case &quot;popuphidden&quot;:</span>
<a href="#l9.318"></a><span id="l9.318">         this._onPopupHidden(aEvent);</span>
<a href="#l9.319"></a><span id="l9.319">         break;</span>
<a href="#l9.320"></a><span id="l9.320">       default:</span>
<a href="#l9.321"></a><span id="l9.321">         throw &quot;Trying to handle unexpected event.&quot;;</span>
<a href="#l9.322"></a><span id="l9.322">     }</span>
<a href="#l9.323"></a><span id="l9.323">   },</span>
<a href="#l9.324"></a><span id="l9.324"> </span>
<a href="#l9.325"></a><span id="l9.325" class="difflineminus">-  updateOverflowStatus() {</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineminus">-    if (this._rootElt.scrollLeftMin != this._rootElt.scrollLeftMax) {</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineminus">-      this._onOverflow();</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineminus">-    } else {</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineminus">-      this._onUnderflow();</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineminus">-    }</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineminus">-  },</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineminus">-</span>
<a href="#l9.333"></a><span id="l9.333">   _isOverflowStateEventRelevant: function PT_isOverflowStateEventRelevant(aEvent) {</span>
<a href="#l9.334"></a><span id="l9.334">     // Ignore events not aimed at ourselves, as well as purely vertical ones:</span>
<a href="#l9.335"></a><span id="l9.335">     return aEvent.target == aEvent.currentTarget &amp;&amp; aEvent.detail &gt; 0;</span>
<a href="#l9.336"></a><span id="l9.336">   },</span>
<a href="#l9.337"></a><span id="l9.337"> </span>
<a href="#l9.338"></a><span id="l9.338">   _onOverflow: function PT_onOverflow() {</span>
<a href="#l9.339"></a><span id="l9.339">     // Attach the popup binding to the chevron popup if it has not yet</span>
<a href="#l9.340"></a><span id="l9.340">     // been initialized.</span>
<a href="#l9.341"></a><span id="l9.341">     if (!this._chevronPopup.hasAttribute(&quot;type&quot;)) {</span>
<a href="#l9.342"></a><span id="l9.342">       this._chevronPopup.setAttribute(&quot;place&quot;, this.place);</span>
<a href="#l9.343"></a><span id="l9.343">       this._chevronPopup.setAttribute(&quot;type&quot;, &quot;places&quot;);</span>
<a href="#l9.344"></a><span id="l9.344">     }</span>
<a href="#l9.345"></a><span id="l9.345">     this._chevron.collapsed = false;</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineminus">-    this.updateChevron();</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineplus">+    this.updateNodesVisibility();</span>
<a href="#l9.348"></a><span id="l9.348">   },</span>
<a href="#l9.349"></a><span id="l9.349"> </span>
<a href="#l9.350"></a><span id="l9.350">   _onUnderflow: function PT_onUnderflow() {</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineminus">-    this.updateChevron();</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineplus">+    this.updateNodesVisibility();</span>
<a href="#l9.353"></a><span id="l9.353">     this._chevron.collapsed = true;</span>
<a href="#l9.354"></a><span id="l9.354">   },</span>
<a href="#l9.355"></a><span id="l9.355"> </span>
<a href="#l9.356"></a><span id="l9.356" class="difflineminus">-  updateChevron: function PT_updateChevron() {</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineminus">-    // If the chevron is collapsed there's nothing to update.</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineminus">-    if (this._chevron.collapsed)</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineminus">-      return;</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineminus">-</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineplus">+  updateNodesVisibility: function PT_updateNodesVisibility() {</span>
<a href="#l9.362"></a><span id="l9.362">     // Update the chevron on a timer.  This will avoid repeated work when</span>
<a href="#l9.363"></a><span id="l9.363">     // lot of changes happen in a small timeframe.</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineminus">-    if (this._updateChevronTimer)</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineminus">-      this._updateChevronTimer.cancel();</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineplus">+    if (this._updateNodesVisibilityTimer)</span>
<a href="#l9.367"></a><span id="l9.367" class="difflineplus">+      this._updateNodesVisibilityTimer.cancel();</span>
<a href="#l9.368"></a><span id="l9.368"> </span>
<a href="#l9.369"></a><span id="l9.369" class="difflineminus">-    this._updateChevronTimer = this._setTimer(100);</span>
<a href="#l9.370"></a><span id="l9.370" class="difflineplus">+    this._updateNodesVisibilityTimer = this._setTimer(100);</span>
<a href="#l9.371"></a><span id="l9.371">   },</span>
<a href="#l9.372"></a><span id="l9.372"> </span>
<a href="#l9.373"></a><span id="l9.373" class="difflineminus">-  _updateChevronTimerCallback: function PT__updateChevronTimerCallback() {</span>
<a href="#l9.374"></a><span id="l9.374" class="difflineplus">+  _updateNodesVisibilityTimerCallback: function PT__updateNodesVisibilityTimerCallback() {</span>
<a href="#l9.375"></a><span id="l9.375">     let scrollRect = this._rootElt.getBoundingClientRect();</span>
<a href="#l9.376"></a><span id="l9.376">     let childOverflowed = false;</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineminus">-    for (let i = 0; i &lt; this._rootElt.childNodes.length; i++) {</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineminus">-      let child = this._rootElt.childNodes[i];</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineplus">+    for (let child of this._rootElt.childNodes) {</span>
<a href="#l9.380"></a><span id="l9.380">       // Once a child overflows, all the next ones will.</span>
<a href="#l9.381"></a><span id="l9.381">       if (!childOverflowed) {</span>
<a href="#l9.382"></a><span id="l9.382">         let childRect = child.getBoundingClientRect();</span>
<a href="#l9.383"></a><span id="l9.383">         childOverflowed = this.isRTL ? (childRect.left &lt; scrollRect.left)</span>
<a href="#l9.384"></a><span id="l9.384">                                      : (childRect.right &gt; scrollRect.right);</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineminus">-</span>
<a href="#l9.386"></a><span id="l9.386">       }</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineminus">-      child.style.visibility = childOverflowed ? &quot;hidden&quot; : &quot;visible&quot;;</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineplus">+</span>
<a href="#l9.389"></a><span id="l9.389" class="difflineplus">+      if (childOverflowed) {</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineplus">+        child.removeAttribute(&quot;image&quot;);</span>
<a href="#l9.391"></a><span id="l9.391" class="difflineplus">+        child.style.visibility = &quot;hidden&quot;;</span>
<a href="#l9.392"></a><span id="l9.392" class="difflineplus">+      } else {</span>
<a href="#l9.393"></a><span id="l9.393" class="difflineplus">+        let icon = child._placesNode.icon;</span>
<a href="#l9.394"></a><span id="l9.394" class="difflineplus">+        if (icon)</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineplus">+          child.setAttribute(&quot;image&quot;, icon);</span>
<a href="#l9.396"></a><span id="l9.396" class="difflineplus">+        child.style.visibility = &quot;visible&quot;;</span>
<a href="#l9.397"></a><span id="l9.397" class="difflineplus">+      }</span>
<a href="#l9.398"></a><span id="l9.398">     }</span>
<a href="#l9.399"></a><span id="l9.399"> </span>
<a href="#l9.400"></a><span id="l9.400">     // We rebuild the chevron on popupShowing, so if it is open</span>
<a href="#l9.401"></a><span id="l9.401">     // we must update it.</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineminus">-    if (this._chevron.open)</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineplus">+    if (!this._chevron.collapsed &amp;&amp; this._chevron.open)</span>
<a href="#l9.404"></a><span id="l9.404">       this._updateChevronPopupNodesVisibility();</span>
<a href="#l9.405"></a><span id="l9.405" class="difflineplus">+    let event = new CustomEvent(&quot;BookmarksToolbarVisibilityUpdated&quot;, {bubbles: true});</span>
<a href="#l9.406"></a><span id="l9.406" class="difflineplus">+    this._viewElt.dispatchEvent(event);</span>
<a href="#l9.407"></a><span id="l9.407">   },</span>
<a href="#l9.408"></a><span id="l9.408"> </span>
<a href="#l9.409"></a><span id="l9.409">   nodeInserted:</span>
<a href="#l9.410"></a><span id="l9.410">   function PT_nodeInserted(aParentPlacesNode, aPlacesNode, aIndex) {</span>
<a href="#l9.411"></a><span id="l9.411">     let parentElt = this._getDOMNodeForPlacesNode(aParentPlacesNode);</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineminus">-    if (parentElt == this._rootElt) {</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineplus">+    if (parentElt == this._rootElt) { // Node is on the toolbar.</span>
<a href="#l9.414"></a><span id="l9.414">       let children = this._rootElt.childNodes;</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineminus">-      this._insertNewItem(aPlacesNode,</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineminus">-        aIndex &lt; children.length ? children[aIndex] : null);</span>
<a href="#l9.417"></a><span id="l9.417" class="difflineminus">-      this.updateChevron();</span>
<a href="#l9.418"></a><span id="l9.418" class="difflineplus">+      // Nothing to do if it's a never-visible node, but note it's possible</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineplus">+      // we are appending.</span>
<a href="#l9.420"></a><span id="l9.420" class="difflineplus">+      if (aIndex &gt; children.length)</span>
<a href="#l9.421"></a><span id="l9.421" class="difflineplus">+        return;</span>
<a href="#l9.422"></a><span id="l9.422" class="difflineplus">+</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineplus">+      // Note that childCount is already accounting for the node being added,</span>
<a href="#l9.424"></a><span id="l9.424" class="difflineplus">+      // thus we must subtract one node from it.</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineplus">+      if (this._resultNode.childCount - 1 &gt; children.length) {</span>
<a href="#l9.426"></a><span id="l9.426" class="difflineplus">+        if (aIndex == children.length) {</span>
<a href="#l9.427"></a><span id="l9.427" class="difflineplus">+          // If we didn't build all the nodes and new node is being appended,</span>
<a href="#l9.428"></a><span id="l9.428" class="difflineplus">+          // we can skip it as well.</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineplus">+          return;</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineplus">+        }</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineplus">+        // Keep the number of built nodes consistent.</span>
<a href="#l9.432"></a><span id="l9.432" class="difflineplus">+        this._rootElt.removeChild(this._rootElt.lastChild);</span>
<a href="#l9.433"></a><span id="l9.433" class="difflineplus">+      }</span>
<a href="#l9.434"></a><span id="l9.434" class="difflineplus">+</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineplus">+      let button = this._insertNewItem(aPlacesNode, this._rootElt,</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineplus">+                                       children[aIndex] || null);</span>
<a href="#l9.437"></a><span id="l9.437" class="difflineplus">+      let prevSiblingOverflowed = aIndex &gt; 0 &amp;&amp; aIndex &lt;= children.length &amp;&amp;</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineplus">+                                  children[aIndex - 1].style.visibility == &quot;hidden&quot;;</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineplus">+      if (prevSiblingOverflowed) {</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineplus">+        button.style.visibility = &quot;hidden&quot;;</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineplus">+      } else {</span>
<a href="#l9.442"></a><span id="l9.442" class="difflineplus">+        let icon = aPlacesNode.icon;</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineplus">+        if (icon)</span>
<a href="#l9.444"></a><span id="l9.444" class="difflineplus">+          button.setAttribute(&quot;image&quot;, icon);</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineplus">+        this.updateNodesVisibility();</span>
<a href="#l9.446"></a><span id="l9.446" class="difflineplus">+      }</span>
<a href="#l9.447"></a><span id="l9.447">       return;</span>
<a href="#l9.448"></a><span id="l9.448">     }</span>
<a href="#l9.449"></a><span id="l9.449"> </span>
<a href="#l9.450"></a><span id="l9.450">     PlacesViewBase.prototype.nodeInserted.apply(this, arguments);</span>
<a href="#l9.451"></a><span id="l9.451">   },</span>
<a href="#l9.452"></a><span id="l9.452"> </span>
<a href="#l9.453"></a><span id="l9.453">   nodeRemoved:</span>
<a href="#l9.454"></a><span id="l9.454">   function PT_nodeRemoved(aParentPlacesNode, aPlacesNode, aIndex) {</span>
<a href="#l9.455"></a><span id="l9.455">     let parentElt = this._getDOMNodeForPlacesNode(aParentPlacesNode);</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineminus">-    let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineplus">+    if (parentElt == this._rootElt) { // Node is on the toolbar.</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineplus">+      let elt = this._getDOMNodeForPlacesNode(aPlacesNode, true);</span>
<a href="#l9.459"></a><span id="l9.459" class="difflineplus">+      // Nothing to do if it's a never-visible node.</span>
<a href="#l9.460"></a><span id="l9.460" class="difflineplus">+      if (!elt)</span>
<a href="#l9.461"></a><span id="l9.461" class="difflineplus">+        return;</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineplus">+</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineplus">+      // Here we need the &lt;menu&gt;.</span>
<a href="#l9.464"></a><span id="l9.464" class="difflineplus">+      if (elt.localName == &quot;menupopup&quot;)</span>
<a href="#l9.465"></a><span id="l9.465" class="difflineplus">+        elt = elt.parentNode;</span>
<a href="#l9.466"></a><span id="l9.466"> </span>
<a href="#l9.467"></a><span id="l9.467" class="difflineminus">-    // Here we need the &lt;menu&gt;.</span>
<a href="#l9.468"></a><span id="l9.468" class="difflineminus">-    if (elt.localName == &quot;menupopup&quot;)</span>
<a href="#l9.469"></a><span id="l9.469" class="difflineminus">-      elt = elt.parentNode;</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineminus">-</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineminus">-    if (parentElt == this._rootElt) {</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineplus">+      let overflowed = elt.style.visibility == &quot;hidden&quot;;</span>
<a href="#l9.473"></a><span id="l9.473">       this._removeChild(elt);</span>
<a href="#l9.474"></a><span id="l9.474" class="difflineminus">-      this.updateChevron();</span>
<a href="#l9.475"></a><span id="l9.475" class="difflineplus">+      if (this._resultNode.childCount &gt; this._rootElt.childNodes.length) {</span>
<a href="#l9.476"></a><span id="l9.476" class="difflineplus">+        // A new node should be built to keep a coherent number of children.</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineplus">+        this._insertNewItem(this._resultNode.getChild(this._rootElt.childNodes.length),</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineplus">+                            this._rootElt);</span>
<a href="#l9.479"></a><span id="l9.479" class="difflineplus">+      }</span>
<a href="#l9.480"></a><span id="l9.480" class="difflineplus">+      if (!overflowed)</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineplus">+        this.updateNodesVisibility();</span>
<a href="#l9.482"></a><span id="l9.482">       return;</span>
<a href="#l9.483"></a><span id="l9.483">     }</span>
<a href="#l9.484"></a><span id="l9.484"> </span>
<a href="#l9.485"></a><span id="l9.485">     PlacesViewBase.prototype.nodeRemoved.apply(this, arguments);</span>
<a href="#l9.486"></a><span id="l9.486">   },</span>
<a href="#l9.487"></a><span id="l9.487"> </span>
<a href="#l9.488"></a><span id="l9.488">   nodeMoved:</span>
<a href="#l9.489"></a><span id="l9.489">   function PT_nodeMoved(aPlacesNode,</span>
<a href="#l9.490"></a><span id="l9.490">                         aOldParentPlacesNode, aOldIndex,</span>
<a href="#l9.491"></a><span id="l9.491">                         aNewParentPlacesNode, aNewIndex) {</span>
<a href="#l9.492"></a><span id="l9.492">     let parentElt = this._getDOMNodeForPlacesNode(aNewParentPlacesNode);</span>
<a href="#l9.493"></a><span id="l9.493" class="difflineminus">-    if (parentElt == this._rootElt) {</span>
<a href="#l9.494"></a><span id="l9.494" class="difflineminus">-      // Container is on the toolbar.</span>
<a href="#l9.495"></a><span id="l9.495" class="difflineplus">+    if (parentElt == this._rootElt) { // Node is on the toolbar.</span>
<a href="#l9.496"></a><span id="l9.496" class="difflineplus">+      // Do nothing if the node will never be visible.</span>
<a href="#l9.497"></a><span id="l9.497" class="difflineplus">+      let lastBuiltIndex = this._rootElt.childNodes.length - 1;</span>
<a href="#l9.498"></a><span id="l9.498" class="difflineplus">+      if (aOldIndex &gt; lastBuiltIndex &amp;&amp; aNewIndex &gt; lastBuiltIndex + 1)</span>
<a href="#l9.499"></a><span id="l9.499" class="difflineplus">+        return;</span>
<a href="#l9.500"></a><span id="l9.500"> </span>
<a href="#l9.501"></a><span id="l9.501" class="difflineminus">-      // Move the element.</span>
<a href="#l9.502"></a><span id="l9.502" class="difflineminus">-      let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l9.503"></a><span id="l9.503" class="difflineplus">+      let elt = this._getDOMNodeForPlacesNode(aPlacesNode, true);</span>
<a href="#l9.504"></a><span id="l9.504" class="difflineplus">+      if (elt) {</span>
<a href="#l9.505"></a><span id="l9.505" class="difflineplus">+        // Here we need the &lt;menu&gt;.</span>
<a href="#l9.506"></a><span id="l9.506" class="difflineplus">+        if (elt.localName == &quot;menupopup&quot;)</span>
<a href="#l9.507"></a><span id="l9.507" class="difflineplus">+          elt = elt.parentNode;</span>
<a href="#l9.508"></a><span id="l9.508" class="difflineplus">+        this._removeChild(elt);</span>
<a href="#l9.509"></a><span id="l9.509" class="difflineplus">+      }</span>
<a href="#l9.510"></a><span id="l9.510"> </span>
<a href="#l9.511"></a><span id="l9.511" class="difflineminus">-      // Here we need the &lt;menu&gt;.</span>
<a href="#l9.512"></a><span id="l9.512" class="difflineminus">-      if (elt.localName == &quot;menupopup&quot;)</span>
<a href="#l9.513"></a><span id="l9.513" class="difflineminus">-        elt = elt.parentNode;</span>
<a href="#l9.514"></a><span id="l9.514" class="difflineplus">+      if (aNewIndex &gt; lastBuiltIndex + 1) {</span>
<a href="#l9.515"></a><span id="l9.515" class="difflineplus">+        if (this._resultNode.childCount &gt; this._rootElt.childNodes.length) {</span>
<a href="#l9.516"></a><span id="l9.516" class="difflineplus">+          // If the element was built and becomes non built, another node should</span>
<a href="#l9.517"></a><span id="l9.517" class="difflineplus">+          // be built to keep a coherent number of children.</span>
<a href="#l9.518"></a><span id="l9.518" class="difflineplus">+          this._insertNewItem(this._resultNode.getChild(this._rootElt.childNodes.length),</span>
<a href="#l9.519"></a><span id="l9.519" class="difflineplus">+                              this._rootElt);</span>
<a href="#l9.520"></a><span id="l9.520" class="difflineplus">+        }</span>
<a href="#l9.521"></a><span id="l9.521" class="difflineplus">+        return;</span>
<a href="#l9.522"></a><span id="l9.522" class="difflineplus">+      }</span>
<a href="#l9.523"></a><span id="l9.523"> </span>
<a href="#l9.524"></a><span id="l9.524" class="difflineminus">-      this._removeChild(elt);</span>
<a href="#l9.525"></a><span id="l9.525" class="difflineminus">-      this._rootElt.insertBefore(elt, this._rootElt.childNodes[aNewIndex]);</span>
<a href="#l9.526"></a><span id="l9.526" class="difflineplus">+      if (!elt) {</span>
<a href="#l9.527"></a><span id="l9.527" class="difflineplus">+        // The node has not been inserted yet, so we must create it.</span>
<a href="#l9.528"></a><span id="l9.528" class="difflineplus">+        elt = this._insertNewItem(aPlacesNode, this._rootElt, this._rootElt.childNodes[aNewIndex]);</span>
<a href="#l9.529"></a><span id="l9.529" class="difflineplus">+        let icon = aPlacesNode.icon;</span>
<a href="#l9.530"></a><span id="l9.530" class="difflineplus">+        if (icon)</span>
<a href="#l9.531"></a><span id="l9.531" class="difflineplus">+          elt.setAttribute(&quot;image&quot;, icon);</span>
<a href="#l9.532"></a><span id="l9.532" class="difflineplus">+      } else {</span>
<a href="#l9.533"></a><span id="l9.533" class="difflineplus">+        this._rootElt.insertBefore(elt, this._rootElt.childNodes[aNewIndex]);</span>
<a href="#l9.534"></a><span id="l9.534" class="difflineplus">+      }</span>
<a href="#l9.535"></a><span id="l9.535"> </span>
<a href="#l9.536"></a><span id="l9.536">       // The chevron view may get nodeMoved after the toolbar.  In such a case,</span>
<a href="#l9.537"></a><span id="l9.537">       // we should ensure (by manually swapping menuitems) that the actual nodes</span>
<a href="#l9.538"></a><span id="l9.538" class="difflineminus">-      // are in the final position before updateChevron tries to updates their</span>
<a href="#l9.539"></a><span id="l9.539" class="difflineminus">-      // visibility, or the chevron may go out of sync.</span>
<a href="#l9.540"></a><span id="l9.540" class="difflineminus">-      // Luckily updateChevron runs on a timer, so, by the time it updates</span>
<a href="#l9.541"></a><span id="l9.541" class="difflineplus">+      // are in the final position before updateNodesVisibility tries to update</span>
<a href="#l9.542"></a><span id="l9.542" class="difflineplus">+      // their visibility, or the chevron may go out of sync.</span>
<a href="#l9.543"></a><span id="l9.543" class="difflineplus">+      // Luckily updateNodesVisibility runs on a timer, so, by the time it updates</span>
<a href="#l9.544"></a><span id="l9.544">       // nodes, the menu has already handled the notification.</span>
<a href="#l9.545"></a><span id="l9.545"> </span>
<a href="#l9.546"></a><span id="l9.546" class="difflineminus">-      this.updateChevron();</span>
<a href="#l9.547"></a><span id="l9.547" class="difflineplus">+      this.updateNodesVisibility();</span>
<a href="#l9.548"></a><span id="l9.548">       return;</span>
<a href="#l9.549"></a><span id="l9.549">     }</span>
<a href="#l9.550"></a><span id="l9.550"> </span>
<a href="#l9.551"></a><span id="l9.551">     PlacesViewBase.prototype.nodeMoved.apply(this, arguments);</span>
<a href="#l9.552"></a><span id="l9.552">   },</span>
<a href="#l9.553"></a><span id="l9.553"> </span>
<a href="#l9.554"></a><span id="l9.554">   nodeAnnotationChanged:</span>
<a href="#l9.555"></a><span id="l9.555">   function PT_nodeAnnotationChanged(aPlacesNode, aAnno) {</span>
<a href="#l9.556"></a><span id="l9.556" class="difflineminus">-    let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l9.557"></a><span id="l9.557" class="difflineminus">-    if (elt == this._rootElt)</span>
<a href="#l9.558"></a><span id="l9.558" class="difflineplus">+    let elt = this._getDOMNodeForPlacesNode(aPlacesNode, true);</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineplus">+    // Nothing to do if it's a never-visible node.</span>
<a href="#l9.560"></a><span id="l9.560" class="difflineplus">+    if (!elt || elt == this._rootElt)</span>
<a href="#l9.561"></a><span id="l9.561">       return;</span>
<a href="#l9.562"></a><span id="l9.562"> </span>
<a href="#l9.563"></a><span id="l9.563">     // We're notified for the menupopup, not the containing toolbarbutton.</span>
<a href="#l9.564"></a><span id="l9.564">     if (elt.localName == &quot;menupopup&quot;)</span>
<a href="#l9.565"></a><span id="l9.565">       elt = elt.parentNode;</span>
<a href="#l9.566"></a><span id="l9.566"> </span>
<a href="#l9.567"></a><span id="l9.567" class="difflineminus">-    if (elt.parentNode == this._rootElt) {</span>
<a href="#l9.568"></a><span id="l9.568" class="difflineminus">-      // Node is on the toolbar.</span>
<a href="#l9.569"></a><span id="l9.569" class="difflineminus">-</span>
<a href="#l9.570"></a><span id="l9.570" class="difflineplus">+    if (elt.parentNode == this._rootElt) { // Node is on the toolbar.</span>
<a href="#l9.571"></a><span id="l9.571">       // All livemarks have a feedURI, so use it as our indicator.</span>
<a href="#l9.572"></a><span id="l9.572">       if (aAnno == PlacesUtils.LMANNO_FEEDURI) {</span>
<a href="#l9.573"></a><span id="l9.573">         elt.setAttribute(&quot;livemark&quot;, true);</span>
<a href="#l9.574"></a><span id="l9.574"> </span>
<a href="#l9.575"></a><span id="l9.575">         PlacesUtils.livemarks.getLivemark({ id: aPlacesNode.itemId })</span>
<a href="#l9.576"></a><span id="l9.576">           .then(aLivemark =&gt; {</span>
<a href="#l9.577"></a><span id="l9.577">             this.controller.cacheLivemarkInfo(aPlacesNode, aLivemark);</span>
<a href="#l9.578"></a><span id="l9.578">             this.invalidateContainer(aPlacesNode);</span>
<a href="#l9.579"></a><span id="l9.579" class="difflineat">@@ -1334,37 +1422,40 @@ PlacesToolbar.prototype = {</span>
<a href="#l9.580"></a><span id="l9.580">       }</span>
<a href="#l9.581"></a><span id="l9.581">     } else {</span>
<a href="#l9.582"></a><span id="l9.582">       // Node is in a submenu.</span>
<a href="#l9.583"></a><span id="l9.583">       PlacesViewBase.prototype.nodeAnnotationChanged.apply(this, arguments);</span>
<a href="#l9.584"></a><span id="l9.584">     }</span>
<a href="#l9.585"></a><span id="l9.585">   },</span>
<a href="#l9.586"></a><span id="l9.586"> </span>
<a href="#l9.587"></a><span id="l9.587">   nodeTitleChanged: function PT_nodeTitleChanged(aPlacesNode, aNewTitle) {</span>
<a href="#l9.588"></a><span id="l9.588" class="difflineminus">-    let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l9.589"></a><span id="l9.589" class="difflineplus">+    let elt = this._getDOMNodeForPlacesNode(aPlacesNode, true);</span>
<a href="#l9.590"></a><span id="l9.590"> </span>
<a href="#l9.591"></a><span id="l9.591" class="difflineminus">-    // There's no UI representation for the root node, thus there's</span>
<a href="#l9.592"></a><span id="l9.592" class="difflineminus">-    // nothing to be done when the title changes.</span>
<a href="#l9.593"></a><span id="l9.593" class="difflineminus">-    if (elt == this._rootElt)</span>
<a href="#l9.594"></a><span id="l9.594" class="difflineplus">+    // Nothing to do if it's a never-visible node.</span>
<a href="#l9.595"></a><span id="l9.595" class="difflineplus">+    if (!elt || elt == this._rootElt)</span>
<a href="#l9.596"></a><span id="l9.596">       return;</span>
<a href="#l9.597"></a><span id="l9.597"> </span>
<a href="#l9.598"></a><span id="l9.598">     PlacesViewBase.prototype.nodeTitleChanged.apply(this, arguments);</span>
<a href="#l9.599"></a><span id="l9.599"> </span>
<a href="#l9.600"></a><span id="l9.600">     // Here we need the &lt;menu&gt;.</span>
<a href="#l9.601"></a><span id="l9.601">     if (elt.localName == &quot;menupopup&quot;)</span>
<a href="#l9.602"></a><span id="l9.602">       elt = elt.parentNode;</span>
<a href="#l9.603"></a><span id="l9.603"> </span>
<a href="#l9.604"></a><span id="l9.604" class="difflineminus">-    if (elt.parentNode == this._rootElt) {</span>
<a href="#l9.605"></a><span id="l9.605" class="difflineminus">-      // Node is on the toolbar</span>
<a href="#l9.606"></a><span id="l9.606" class="difflineminus">-      this.updateChevron();</span>
<a href="#l9.607"></a><span id="l9.607" class="difflineplus">+    if (elt.parentNode == this._rootElt) { // Node is on the toolbar.</span>
<a href="#l9.608"></a><span id="l9.608" class="difflineplus">+      if (elt.style.visibility != &quot;hidden&quot;)</span>
<a href="#l9.609"></a><span id="l9.609" class="difflineplus">+        this.updateNodesVisibility();</span>
<a href="#l9.610"></a><span id="l9.610">     }</span>
<a href="#l9.611"></a><span id="l9.611">   },</span>
<a href="#l9.612"></a><span id="l9.612"> </span>
<a href="#l9.613"></a><span id="l9.613">   invalidateContainer: function PT_invalidateContainer(aPlacesNode) {</span>
<a href="#l9.614"></a><span id="l9.614" class="difflineminus">-    let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l9.615"></a><span id="l9.615" class="difflineplus">+    let elt = this._getDOMNodeForPlacesNode(aPlacesNode, true);</span>
<a href="#l9.616"></a><span id="l9.616" class="difflineplus">+    // Nothing to do if it's a never-visible node.</span>
<a href="#l9.617"></a><span id="l9.617" class="difflineplus">+    if (!elt)</span>
<a href="#l9.618"></a><span id="l9.618" class="difflineplus">+      return;</span>
<a href="#l9.619"></a><span id="l9.619" class="difflineplus">+</span>
<a href="#l9.620"></a><span id="l9.620">     if (elt == this._rootElt) {</span>
<a href="#l9.621"></a><span id="l9.621">       // Container is the toolbar itself.</span>
<a href="#l9.622"></a><span id="l9.622">       this._rebuild();</span>
<a href="#l9.623"></a><span id="l9.623">       return;</span>
<a href="#l9.624"></a><span id="l9.624">     }</span>
<a href="#l9.625"></a><span id="l9.625"> </span>
<a href="#l9.626"></a><span id="l9.626">     PlacesViewBase.prototype.invalidateContainer.apply(this, arguments);</span>
<a href="#l9.627"></a><span id="l9.627">   },</span>
<a href="#l9.628"></a><span id="l9.628" class="difflineat">@@ -1408,94 +1499,119 @@ PlacesToolbar.prototype = {</span>
<a href="#l9.629"></a><span id="l9.629"> </span>
<a href="#l9.630"></a><span id="l9.630">     let dropPoint = { ip: null, beforeIndex: null, folderElt: null };</span>
<a href="#l9.631"></a><span id="l9.631">     let elt = aEvent.target;</span>
<a href="#l9.632"></a><span id="l9.632">     if (elt._placesNode &amp;&amp; elt != this._rootElt &amp;&amp;</span>
<a href="#l9.633"></a><span id="l9.633">         elt.localName != &quot;menupopup&quot;) {</span>
<a href="#l9.634"></a><span id="l9.634">       let eltRect = elt.getBoundingClientRect();</span>
<a href="#l9.635"></a><span id="l9.635">       let eltIndex = Array.prototype.indexOf.call(this._rootElt.childNodes, elt);</span>
<a href="#l9.636"></a><span id="l9.636">       if (PlacesUtils.nodeIsFolder(elt._placesNode) &amp;&amp;</span>
<a href="#l9.637"></a><span id="l9.637" class="difflineminus">-          !PlacesUIUtils.isContentsReadOnly(elt._placesNode)) {</span>
<a href="#l9.638"></a><span id="l9.638" class="difflineplus">+          !PlacesUIUtils.isFolderReadOnly(elt._placesNode, this)) {</span>
<a href="#l9.639"></a><span id="l9.639">         // This is a folder.</span>
<a href="#l9.640"></a><span id="l9.640">         // If we are in the middle of it, drop inside it.</span>
<a href="#l9.641"></a><span id="l9.641">         // Otherwise, drop before it, with regards to RTL mode.</span>
<a href="#l9.642"></a><span id="l9.642">         let threshold = eltRect.width * 0.25;</span>
<a href="#l9.643"></a><span id="l9.643">         if (this.isRTL ? (aEvent.clientX &gt; eltRect.right - threshold)</span>
<a href="#l9.644"></a><span id="l9.644">                        : (aEvent.clientX &lt; eltRect.left + threshold)) {</span>
<a href="#l9.645"></a><span id="l9.645">           // Drop before this folder.</span>
<a href="#l9.646"></a><span id="l9.646">           dropPoint.ip =</span>
<a href="#l9.647"></a><span id="l9.647" class="difflineminus">-            new InsertionPoint(PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l9.648"></a><span id="l9.648" class="difflineminus">-                               eltIndex, Ci.nsITreeView.DROP_BEFORE);</span>
<a href="#l9.649"></a><span id="l9.649" class="difflineplus">+            new InsertionPoint({</span>
<a href="#l9.650"></a><span id="l9.650" class="difflineplus">+              parentId: PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l9.651"></a><span id="l9.651" class="difflineplus">+              parentGuid: PlacesUtils.getConcreteItemGuid(this._resultNode),</span>
<a href="#l9.652"></a><span id="l9.652" class="difflineplus">+              index: eltIndex,</span>
<a href="#l9.653"></a><span id="l9.653" class="difflineplus">+              orientation: Ci.nsITreeView.DROP_BEFORE</span>
<a href="#l9.654"></a><span id="l9.654" class="difflineplus">+            });</span>
<a href="#l9.655"></a><span id="l9.655">           dropPoint.beforeIndex = eltIndex;</span>
<a href="#l9.656"></a><span id="l9.656">         } else if (this.isRTL ? (aEvent.clientX &gt; eltRect.left + threshold)</span>
<a href="#l9.657"></a><span id="l9.657">                             : (aEvent.clientX &lt; eltRect.right - threshold)) {</span>
<a href="#l9.658"></a><span id="l9.658">           // Drop inside this folder.</span>
<a href="#l9.659"></a><span id="l9.659">           let tagName = PlacesUtils.nodeIsTagQuery(elt._placesNode) ?</span>
<a href="#l9.660"></a><span id="l9.660">                         elt._placesNode.title : null;</span>
<a href="#l9.661"></a><span id="l9.661">           dropPoint.ip =</span>
<a href="#l9.662"></a><span id="l9.662" class="difflineminus">-            new InsertionPoint(PlacesUtils.getConcreteItemId(elt._placesNode),</span>
<a href="#l9.663"></a><span id="l9.663" class="difflineminus">-                               -1, Ci.nsITreeView.DROP_ON,</span>
<a href="#l9.664"></a><span id="l9.664" class="difflineminus">-                               tagName);</span>
<a href="#l9.665"></a><span id="l9.665" class="difflineplus">+            new InsertionPoint({</span>
<a href="#l9.666"></a><span id="l9.666" class="difflineplus">+              parentId: PlacesUtils.getConcreteItemId(elt._placesNode),</span>
<a href="#l9.667"></a><span id="l9.667" class="difflineplus">+              parentGuid: PlacesUtils.getConcreteItemGuid(elt._placesNode),</span>
<a href="#l9.668"></a><span id="l9.668" class="difflineplus">+              tagName</span>
<a href="#l9.669"></a><span id="l9.669" class="difflineplus">+            });</span>
<a href="#l9.670"></a><span id="l9.670">           dropPoint.beforeIndex = eltIndex;</span>
<a href="#l9.671"></a><span id="l9.671">           dropPoint.folderElt = elt;</span>
<a href="#l9.672"></a><span id="l9.672">         } else {</span>
<a href="#l9.673"></a><span id="l9.673">           // Drop after this folder.</span>
<a href="#l9.674"></a><span id="l9.674">           let beforeIndex =</span>
<a href="#l9.675"></a><span id="l9.675">             (eltIndex == this._rootElt.childNodes.length - 1) ?</span>
<a href="#l9.676"></a><span id="l9.676">             -1 : eltIndex + 1;</span>
<a href="#l9.677"></a><span id="l9.677"> </span>
<a href="#l9.678"></a><span id="l9.678">           dropPoint.ip =</span>
<a href="#l9.679"></a><span id="l9.679" class="difflineminus">-            new InsertionPoint(PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l9.680"></a><span id="l9.680" class="difflineminus">-                               beforeIndex, Ci.nsITreeView.DROP_BEFORE);</span>
<a href="#l9.681"></a><span id="l9.681" class="difflineplus">+            new InsertionPoint({</span>
<a href="#l9.682"></a><span id="l9.682" class="difflineplus">+              parentId: PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l9.683"></a><span id="l9.683" class="difflineplus">+              parentGuid: PlacesUtils.getConcreteItemGuid(this._resultNode),</span>
<a href="#l9.684"></a><span id="l9.684" class="difflineplus">+              index: beforeIndex,</span>
<a href="#l9.685"></a><span id="l9.685" class="difflineplus">+              orientation: Ci.nsITreeView.DROP_BEFORE</span>
<a href="#l9.686"></a><span id="l9.686" class="difflineplus">+            });</span>
<a href="#l9.687"></a><span id="l9.687">           dropPoint.beforeIndex = beforeIndex;</span>
<a href="#l9.688"></a><span id="l9.688">         }</span>
<a href="#l9.689"></a><span id="l9.689">       } else {</span>
<a href="#l9.690"></a><span id="l9.690">         // This is a non-folder node or a read-only folder.</span>
<a href="#l9.691"></a><span id="l9.691">         // Drop before it with regards to RTL mode.</span>
<a href="#l9.692"></a><span id="l9.692">         let threshold = eltRect.width * 0.5;</span>
<a href="#l9.693"></a><span id="l9.693">         if (this.isRTL ? (aEvent.clientX &gt; eltRect.left + threshold)</span>
<a href="#l9.694"></a><span id="l9.694">                        : (aEvent.clientX &lt; eltRect.left + threshold)) {</span>
<a href="#l9.695"></a><span id="l9.695">           // Drop before this bookmark.</span>
<a href="#l9.696"></a><span id="l9.696">           dropPoint.ip =</span>
<a href="#l9.697"></a><span id="l9.697" class="difflineminus">-            new InsertionPoint(PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l9.698"></a><span id="l9.698" class="difflineminus">-                               eltIndex, Ci.nsITreeView.DROP_BEFORE);</span>
<a href="#l9.699"></a><span id="l9.699" class="difflineplus">+            new InsertionPoint({</span>
<a href="#l9.700"></a><span id="l9.700" class="difflineplus">+              parentId: PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l9.701"></a><span id="l9.701" class="difflineplus">+              parentGuid: PlacesUtils.getConcreteItemGuid(this._resultNode),</span>
<a href="#l9.702"></a><span id="l9.702" class="difflineplus">+              index: eltIndex,</span>
<a href="#l9.703"></a><span id="l9.703" class="difflineplus">+              orientation: Ci.nsITreeView.DROP_BEFORE</span>
<a href="#l9.704"></a><span id="l9.704" class="difflineplus">+            });</span>
<a href="#l9.705"></a><span id="l9.705">           dropPoint.beforeIndex = eltIndex;</span>
<a href="#l9.706"></a><span id="l9.706">         } else {</span>
<a href="#l9.707"></a><span id="l9.707">           // Drop after this bookmark.</span>
<a href="#l9.708"></a><span id="l9.708">           let beforeIndex =</span>
<a href="#l9.709"></a><span id="l9.709">             eltIndex == this._rootElt.childNodes.length - 1 ?</span>
<a href="#l9.710"></a><span id="l9.710">             -1 : eltIndex + 1;</span>
<a href="#l9.711"></a><span id="l9.711">           dropPoint.ip =</span>
<a href="#l9.712"></a><span id="l9.712" class="difflineminus">-            new InsertionPoint(PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l9.713"></a><span id="l9.713" class="difflineminus">-                               beforeIndex, Ci.nsITreeView.DROP_BEFORE);</span>
<a href="#l9.714"></a><span id="l9.714" class="difflineplus">+            new InsertionPoint({</span>
<a href="#l9.715"></a><span id="l9.715" class="difflineplus">+              parentId: PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l9.716"></a><span id="l9.716" class="difflineplus">+              parentGuid: PlacesUtils.getConcreteItemGuid(this._resultNode),</span>
<a href="#l9.717"></a><span id="l9.717" class="difflineplus">+              index: beforeIndex,</span>
<a href="#l9.718"></a><span id="l9.718" class="difflineplus">+              orientation: Ci.nsITreeView.DROP_BEFORE</span>
<a href="#l9.719"></a><span id="l9.719" class="difflineplus">+            });</span>
<a href="#l9.720"></a><span id="l9.720">           dropPoint.beforeIndex = beforeIndex;</span>
<a href="#l9.721"></a><span id="l9.721">         }</span>
<a href="#l9.722"></a><span id="l9.722">       }</span>
<a href="#l9.723"></a><span id="l9.723">     } else {</span>
<a href="#l9.724"></a><span id="l9.724">       // We are most likely dragging on the empty area of the</span>
<a href="#l9.725"></a><span id="l9.725">       // toolbar, we should drop after the last node.</span>
<a href="#l9.726"></a><span id="l9.726">       dropPoint.ip =</span>
<a href="#l9.727"></a><span id="l9.727" class="difflineminus">-        new InsertionPoint(PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l9.728"></a><span id="l9.728" class="difflineminus">-                           -1, Ci.nsITreeView.DROP_BEFORE);</span>
<a href="#l9.729"></a><span id="l9.729" class="difflineplus">+        new InsertionPoint({</span>
<a href="#l9.730"></a><span id="l9.730" class="difflineplus">+          parentId: PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l9.731"></a><span id="l9.731" class="difflineplus">+          parentGuid: PlacesUtils.getConcreteItemGuid(this._resultNode),</span>
<a href="#l9.732"></a><span id="l9.732" class="difflineplus">+          orientation: Ci.nsITreeView.DROP_BEFORE</span>
<a href="#l9.733"></a><span id="l9.733" class="difflineplus">+        });</span>
<a href="#l9.734"></a><span id="l9.734">       dropPoint.beforeIndex = -1;</span>
<a href="#l9.735"></a><span id="l9.735">     }</span>
<a href="#l9.736"></a><span id="l9.736"> </span>
<a href="#l9.737"></a><span id="l9.737">     return dropPoint;</span>
<a href="#l9.738"></a><span id="l9.738">   },</span>
<a href="#l9.739"></a><span id="l9.739"> </span>
<a href="#l9.740"></a><span id="l9.740">   _setTimer: function PT_setTimer(aTime) {</span>
<a href="#l9.741"></a><span id="l9.741">     let timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l9.742"></a><span id="l9.742">     timer.initWithCallback(this, aTime, timer.TYPE_ONE_SHOT);</span>
<a href="#l9.743"></a><span id="l9.743">     return timer;</span>
<a href="#l9.744"></a><span id="l9.744">   },</span>
<a href="#l9.745"></a><span id="l9.745"> </span>
<a href="#l9.746"></a><span id="l9.746">   notify: function PT_notify(aTimer) {</span>
<a href="#l9.747"></a><span id="l9.747" class="difflineminus">-    if (aTimer == this._updateChevronTimer) {</span>
<a href="#l9.748"></a><span id="l9.748" class="difflineminus">-      this._updateChevronTimer = null;</span>
<a href="#l9.749"></a><span id="l9.749" class="difflineminus">-      this._updateChevronTimerCallback();</span>
<a href="#l9.750"></a><span id="l9.750" class="difflineplus">+    if (aTimer == this._updateNodesVisibilityTimer) {</span>
<a href="#l9.751"></a><span id="l9.751" class="difflineplus">+      this._updateNodesVisibilityTimer = null;</span>
<a href="#l9.752"></a><span id="l9.752" class="difflineplus">+      // TODO: This should use promiseLayoutFlushed(&quot;layout&quot;), so that</span>
<a href="#l9.753"></a><span id="l9.753" class="difflineplus">+      // _updateNodesVisibilityTimerCallback can use getBoundsWithoutFlush. But</span>
<a href="#l9.754"></a><span id="l9.754" class="difflineplus">+      // for yet unknown reasons doing that causes intermittent failures,</span>
<a href="#l9.755"></a><span id="l9.755" class="difflineplus">+      // apparently due the flush not happening in a meaningful time.</span>
<a href="#l9.756"></a><span id="l9.756" class="difflineplus">+      window.requestAnimationFrame(this._updateNodesVisibilityTimerCallback.bind(this));</span>
<a href="#l9.757"></a><span id="l9.757">     } else if (aTimer == this._ibTimer) {</span>
<a href="#l9.758"></a><span id="l9.758">       // * Timer to turn off indicator bar.</span>
<a href="#l9.759"></a><span id="l9.759">       this._dropIndicator.collapsed = true;</span>
<a href="#l9.760"></a><span id="l9.760">       this._ibTimer = null;</span>
<a href="#l9.761"></a><span id="l9.761">     } else if (aTimer == this._overFolder.openTimer) {</span>
<a href="#l9.762"></a><span id="l9.762">       // * Timer to open a menubutton that's being dragged over.</span>
<a href="#l9.763"></a><span id="l9.763">       // Set the autoopen attribute on the folder's menupopup so that</span>
<a href="#l9.764"></a><span id="l9.764">       // the menu will automatically close when the mouse drags off of it.</span>
<a href="#l9.765"></a><span id="l9.765" class="difflineat">@@ -1749,17 +1865,17 @@ PlacesToolbar.prototype = {</span>
<a href="#l9.766"></a><span id="l9.766"> };</span>
<a href="#l9.767"></a><span id="l9.767"> </span>
<a href="#l9.768"></a><span id="l9.768"> /**</span>
<a href="#l9.769"></a><span id="l9.769">  * View for Places menus.  This object should be created during the first</span>
<a href="#l9.770"></a><span id="l9.770">  * popupshowing that's dispatched on the menu.</span>
<a href="#l9.771"></a><span id="l9.771">  */</span>
<a href="#l9.772"></a><span id="l9.772"> function PlacesMenu(aPopupShowingEvent, aPlace, aOptions) {</span>
<a href="#l9.773"></a><span id="l9.773">   this._rootElt = aPopupShowingEvent.target; // &lt;menupopup&gt;</span>
<a href="#l9.774"></a><span id="l9.774" class="difflineminus">-  this._viewElt = this._rootElt.parentNode;   // &lt;menu&gt;</span>
<a href="#l9.775"></a><span id="l9.775" class="difflineplus">+  this._viewElt = this._rootElt.parentNode; // &lt;menu&gt;</span>
<a href="#l9.776"></a><span id="l9.776">   this._viewElt._placesView = this;</span>
<a href="#l9.777"></a><span id="l9.777">   this._addEventListeners(this._rootElt, [&quot;popupshowing&quot;, &quot;popuphidden&quot;], true);</span>
<a href="#l9.778"></a><span id="l9.778">   this._addEventListeners(window, [&quot;unload&quot;], false);</span>
<a href="#l9.779"></a><span id="l9.779"> </span>
<a href="#l9.780"></a><span id="l9.780">   if (AppConstants.platform === &quot;macosx&quot;) {</span>
<a href="#l9.781"></a><span id="l9.781">     // Must walk up to support views in sub-menus, like Bookmarks Toolbar menu.</span>
<a href="#l9.782"></a><span id="l9.782">     for (let elt = this._viewElt.parentNode; elt; elt = elt.parentNode) {</span>
<a href="#l9.783"></a><span id="l9.783">       if (elt.localName == &quot;menubar&quot;) {</span>
<a href="#l9.784"></a><span id="l9.784" class="difflineat">@@ -1848,17 +1964,17 @@ PlacesPanelMenuView.prototype = {</span>
<a href="#l9.785"></a><span id="l9.785">     return PlacesViewBase.prototype.QueryInterface.apply(this, arguments);</span>
<a href="#l9.786"></a><span id="l9.786">   },</span>
<a href="#l9.787"></a><span id="l9.787"> </span>
<a href="#l9.788"></a><span id="l9.788">   uninit: function PAMV_uninit() {</span>
<a href="#l9.789"></a><span id="l9.789">     PlacesViewBase.prototype.uninit.apply(this, arguments);</span>
<a href="#l9.790"></a><span id="l9.790">   },</span>
<a href="#l9.791"></a><span id="l9.791"> </span>
<a href="#l9.792"></a><span id="l9.792">   _insertNewItem:</span>
<a href="#l9.793"></a><span id="l9.793" class="difflineminus">-  function PAMV__insertNewItem(aChild, aBefore) {</span>
<a href="#l9.794"></a><span id="l9.794" class="difflineplus">+  function PAMV__insertNewItem(aChild, aInsertionNode, aBefore = null) {</span>
<a href="#l9.795"></a><span id="l9.795">     this._domNodes.delete(aChild);</span>
<a href="#l9.796"></a><span id="l9.796"> </span>
<a href="#l9.797"></a><span id="l9.797">     let type = aChild.type;</span>
<a href="#l9.798"></a><span id="l9.798">     let button;</span>
<a href="#l9.799"></a><span id="l9.799">     if (type == Ci.nsINavHistoryResultNode.RESULT_TYPE_SEPARATOR) {</span>
<a href="#l9.800"></a><span id="l9.800">       button = document.createElement(&quot;toolbarseparator&quot;);</span>
<a href="#l9.801"></a><span id="l9.801">       button.setAttribute(&quot;class&quot;, &quot;small-separator&quot;);</span>
<a href="#l9.802"></a><span id="l9.802">     } else {</span>
<a href="#l9.803"></a><span id="l9.803" class="difflineat">@@ -1890,27 +2006,28 @@ PlacesPanelMenuView.prototype = {</span>
<a href="#l9.804"></a><span id="l9.804">                             PlacesUIUtils.guessUrlSchemeForUI(aChild.uri));</span>
<a href="#l9.805"></a><span id="l9.805">       }</span>
<a href="#l9.806"></a><span id="l9.806">     }</span>
<a href="#l9.807"></a><span id="l9.807"> </span>
<a href="#l9.808"></a><span id="l9.808">     button._placesNode = aChild;</span>
<a href="#l9.809"></a><span id="l9.809">     if (!this._domNodes.has(aChild))</span>
<a href="#l9.810"></a><span id="l9.810">       this._domNodes.set(aChild, button);</span>
<a href="#l9.811"></a><span id="l9.811"> </span>
<a href="#l9.812"></a><span id="l9.812" class="difflineminus">-    this._rootElt.insertBefore(button, aBefore);</span>
<a href="#l9.813"></a><span id="l9.813" class="difflineplus">+    aInsertionNode.insertBefore(button, aBefore);</span>
<a href="#l9.814"></a><span id="l9.814" class="difflineplus">+    return button;</span>
<a href="#l9.815"></a><span id="l9.815">   },</span>
<a href="#l9.816"></a><span id="l9.816"> </span>
<a href="#l9.817"></a><span id="l9.817">   nodeInserted:</span>
<a href="#l9.818"></a><span id="l9.818">   function PAMV_nodeInserted(aParentPlacesNode, aPlacesNode, aIndex) {</span>
<a href="#l9.819"></a><span id="l9.819">     let parentElt = this._getDOMNodeForPlacesNode(aParentPlacesNode);</span>
<a href="#l9.820"></a><span id="l9.820">     if (parentElt != this._rootElt)</span>
<a href="#l9.821"></a><span id="l9.821">       return;</span>
<a href="#l9.822"></a><span id="l9.822"> </span>
<a href="#l9.823"></a><span id="l9.823">     let children = this._rootElt.childNodes;</span>
<a href="#l9.824"></a><span id="l9.824" class="difflineminus">-    this._insertNewItem(aPlacesNode,</span>
<a href="#l9.825"></a><span id="l9.825" class="difflineplus">+    this._insertNewItem(aPlacesNode, this._rootElt,</span>
<a href="#l9.826"></a><span id="l9.826">       aIndex &lt; children.length ? children[aIndex] : null);</span>
<a href="#l9.827"></a><span id="l9.827">   },</span>
<a href="#l9.828"></a><span id="l9.828"> </span>
<a href="#l9.829"></a><span id="l9.829">   nodeRemoved:</span>
<a href="#l9.830"></a><span id="l9.830">   function PAMV_nodeRemoved(aParentPlacesNode, aPlacesNode, aIndex) {</span>
<a href="#l9.831"></a><span id="l9.831">     let parentElt = this._getDOMNodeForPlacesNode(aParentPlacesNode);</span>
<a href="#l9.832"></a><span id="l9.832">     if (parentElt != this._rootElt)</span>
<a href="#l9.833"></a><span id="l9.833">       return;</span>
<a href="#l9.834"></a><span id="l9.834" class="difflineat">@@ -1969,92 +2086,100 @@ PlacesPanelMenuView.prototype = {</span>
<a href="#l9.835"></a><span id="l9.835">     if (elt != this._rootElt)</span>
<a href="#l9.836"></a><span id="l9.836">       return;</span>
<a href="#l9.837"></a><span id="l9.837"> </span>
<a href="#l9.838"></a><span id="l9.838">     // Container is the toolbar itself.</span>
<a href="#l9.839"></a><span id="l9.839">     while (this._rootElt.hasChildNodes()) {</span>
<a href="#l9.840"></a><span id="l9.840">       this._rootElt.firstChild.remove();</span>
<a href="#l9.841"></a><span id="l9.841">     }</span>
<a href="#l9.842"></a><span id="l9.842"> </span>
<a href="#l9.843"></a><span id="l9.843" class="difflineplus">+    let fragment = document.createDocumentFragment();</span>
<a href="#l9.844"></a><span id="l9.844">     for (let i = 0; i &lt; this._resultNode.childCount; ++i) {</span>
<a href="#l9.845"></a><span id="l9.845" class="difflineminus">-      this._insertNewItem(this._resultNode.getChild(i), null);</span>
<a href="#l9.846"></a><span id="l9.846" class="difflineplus">+      this._insertNewItem(this._resultNode.getChild(i), fragment);</span>
<a href="#l9.847"></a><span id="l9.847">     }</span>
<a href="#l9.848"></a><span id="l9.848" class="difflineplus">+    this._rootElt.appendChild(fragment);</span>
<a href="#l9.849"></a><span id="l9.849">   }</span>
<a href="#l9.850"></a><span id="l9.850"> };</span>
<a href="#l9.851"></a><span id="l9.851"> </span>
<a href="#l9.852"></a><span id="l9.852" class="difflineminus">-var PlacesPanelview = class extends PlacesViewBase {</span>
<a href="#l9.853"></a><span id="l9.853" class="difflineplus">+this.PlacesPanelview = class extends PlacesViewBase {</span>
<a href="#l9.854"></a><span id="l9.854">   constructor(container, panelview, place, options = {}) {</span>
<a href="#l9.855"></a><span id="l9.855">     options.rootElt = container;</span>
<a href="#l9.856"></a><span id="l9.856">     options.viewElt = panelview;</span>
<a href="#l9.857"></a><span id="l9.857">     super(place, options);</span>
<a href="#l9.858"></a><span id="l9.858">     this._viewElt._placesView = this;</span>
<a href="#l9.859"></a><span id="l9.859">     // We're simulating a popup show, because a panelview may only be shown when</span>
<a href="#l9.860"></a><span id="l9.860">     // its containing popup is already shown.</span>
<a href="#l9.861"></a><span id="l9.861" class="difflineminus">-    this._onPopupShowing({ originalTarget: this._viewElt });</span>
<a href="#l9.862"></a><span id="l9.862" class="difflineplus">+    this._onPopupShowing({ originalTarget: this._rootElt });</span>
<a href="#l9.863"></a><span id="l9.863">     this._addEventListeners(window, [&quot;unload&quot;]);</span>
<a href="#l9.864"></a><span id="l9.864">     this._rootElt.setAttribute(&quot;context&quot;, &quot;placesContext&quot;);</span>
<a href="#l9.865"></a><span id="l9.865">   }</span>
<a href="#l9.866"></a><span id="l9.866"> </span>
<a href="#l9.867"></a><span id="l9.867">   get events() {</span>
<a href="#l9.868"></a><span id="l9.868">     if (this._events)</span>
<a href="#l9.869"></a><span id="l9.869">       return this._events;</span>
<a href="#l9.870"></a><span id="l9.870" class="difflineminus">-    return this._events = [&quot;command&quot;, &quot;destructed&quot;, &quot;dragend&quot;, &quot;dragstart&quot;,</span>
<a href="#l9.871"></a><span id="l9.871" class="difflineminus">-      &quot;ViewHiding&quot;, &quot;ViewShowing&quot;, &quot;ViewShown&quot;];</span>
<a href="#l9.872"></a><span id="l9.872" class="difflineplus">+    return this._events = [&quot;click&quot;, &quot;command&quot;, &quot;dragend&quot;, &quot;dragstart&quot;, &quot;ViewHiding&quot;, &quot;ViewShown&quot;];</span>
<a href="#l9.873"></a><span id="l9.873">   }</span>
<a href="#l9.874"></a><span id="l9.874"> </span>
<a href="#l9.875"></a><span id="l9.875">   get panel() {</span>
<a href="#l9.876"></a><span id="l9.876">     return this.panelMultiView.parentNode;</span>
<a href="#l9.877"></a><span id="l9.877">   }</span>
<a href="#l9.878"></a><span id="l9.878"> </span>
<a href="#l9.879"></a><span id="l9.879">   get panelMultiView() {</span>
<a href="#l9.880"></a><span id="l9.880">     return this._viewElt.panelMultiView;</span>
<a href="#l9.881"></a><span id="l9.881">   }</span>
<a href="#l9.882"></a><span id="l9.882"> </span>
<a href="#l9.883"></a><span id="l9.883">   handleEvent(event) {</span>
<a href="#l9.884"></a><span id="l9.884">     switch (event.type) {</span>
<a href="#l9.885"></a><span id="l9.885" class="difflineplus">+      case &quot;click&quot;:</span>
<a href="#l9.886"></a><span id="l9.886" class="difflineplus">+        // For middle clicks, fall through to the command handler.</span>
<a href="#l9.887"></a><span id="l9.887" class="difflineplus">+        if (event.button != 1) {</span>
<a href="#l9.888"></a><span id="l9.888" class="difflineplus">+          break;</span>
<a href="#l9.889"></a><span id="l9.889" class="difflineplus">+        }</span>
<a href="#l9.890"></a><span id="l9.890">       case &quot;command&quot;:</span>
<a href="#l9.891"></a><span id="l9.891">         this._onCommand(event);</span>
<a href="#l9.892"></a><span id="l9.892">         break;</span>
<a href="#l9.893"></a><span id="l9.893" class="difflineminus">-      case &quot;destructed&quot;:</span>
<a href="#l9.894"></a><span id="l9.894" class="difflineminus">-        this._onDestructed(event);</span>
<a href="#l9.895"></a><span id="l9.895" class="difflineminus">-        break;</span>
<a href="#l9.896"></a><span id="l9.896">       case &quot;dragend&quot;:</span>
<a href="#l9.897"></a><span id="l9.897">         this._onDragEnd(event);</span>
<a href="#l9.898"></a><span id="l9.898">         break;</span>
<a href="#l9.899"></a><span id="l9.899">       case &quot;dragstart&quot;:</span>
<a href="#l9.900"></a><span id="l9.900">         this._onDragStart(event);</span>
<a href="#l9.901"></a><span id="l9.901">         break;</span>
<a href="#l9.902"></a><span id="l9.902">       case &quot;unload&quot;:</span>
<a href="#l9.903"></a><span id="l9.903">         this.uninit(event);</span>
<a href="#l9.904"></a><span id="l9.904">         break;</span>
<a href="#l9.905"></a><span id="l9.905">       case &quot;ViewHiding&quot;:</span>
<a href="#l9.906"></a><span id="l9.906">         this._onPopupHidden(event);</span>
<a href="#l9.907"></a><span id="l9.907">         break;</span>
<a href="#l9.908"></a><span id="l9.908" class="difflineminus">-      case &quot;ViewShowing&quot;:</span>
<a href="#l9.909"></a><span id="l9.909" class="difflineminus">-        this._onPopupShowing(event);</span>
<a href="#l9.910"></a><span id="l9.910" class="difflineminus">-        break;</span>
<a href="#l9.911"></a><span id="l9.911">       case &quot;ViewShown&quot;:</span>
<a href="#l9.912"></a><span id="l9.912">         this._onViewShown(event);</span>
<a href="#l9.913"></a><span id="l9.913">         break;</span>
<a href="#l9.914"></a><span id="l9.914">     }</span>
<a href="#l9.915"></a><span id="l9.915">   }</span>
<a href="#l9.916"></a><span id="l9.916"> </span>
<a href="#l9.917"></a><span id="l9.917">   _onCommand(event) {</span>
<a href="#l9.918"></a><span id="l9.918">     let button = event.originalTarget;</span>
<a href="#l9.919"></a><span id="l9.919">     if (!button._placesNode)</span>
<a href="#l9.920"></a><span id="l9.920">       return;</span>
<a href="#l9.921"></a><span id="l9.921"> </span>
<a href="#l9.922"></a><span id="l9.922" class="difflineplus">+    let modifKey = AppConstants.platform === &quot;macosx&quot; ? event.metaKey</span>
<a href="#l9.923"></a><span id="l9.923" class="difflineplus">+                                                      : event.ctrlKey;</span>
<a href="#l9.924"></a><span id="l9.924" class="difflineplus">+    if (!PlacesUIUtils.openInTabClosesMenu &amp;&amp; modifKey) {</span>
<a href="#l9.925"></a><span id="l9.925" class="difflineplus">+      // If 'Recent Bookmarks' in Bookmarks Panel.</span>
<a href="#l9.926"></a><span id="l9.926" class="difflineplus">+      if (button.parentNode.id == &quot;panelMenu_bookmarksMenu&quot;) {</span>
<a href="#l9.927"></a><span id="l9.927" class="difflineplus">+        button.setAttribute(&quot;closemenu&quot;, &quot;none&quot;);</span>
<a href="#l9.928"></a><span id="l9.928" class="difflineplus">+      }</span>
<a href="#l9.929"></a><span id="l9.929" class="difflineplus">+    } else {</span>
<a href="#l9.930"></a><span id="l9.930" class="difflineplus">+      button.removeAttribute(&quot;closemenu&quot;);</span>
<a href="#l9.931"></a><span id="l9.931" class="difflineplus">+    }</span>
<a href="#l9.932"></a><span id="l9.932">     PlacesUIUtils.openNodeWithEvent(button._placesNode, event);</span>
<a href="#l9.933"></a><span id="l9.933" class="difflineminus">-  }</span>
<a href="#l9.934"></a><span id="l9.934" class="difflineminus">-</span>
<a href="#l9.935"></a><span id="l9.935" class="difflineminus">-  _onDestructed(event) {</span>
<a href="#l9.936"></a><span id="l9.936" class="difflineminus">-    // The panelmultiview is ephemeral, so let's keep an eye out when the root</span>
<a href="#l9.937"></a><span id="l9.937" class="difflineminus">-    // element is showing again.</span>
<a href="#l9.938"></a><span id="l9.938" class="difflineminus">-    this._removeEventListeners(event.target, this.events);</span>
<a href="#l9.939"></a><span id="l9.939" class="difflineminus">-    this._addEventListeners(this._viewElt, [&quot;ViewShowing&quot;]);</span>
<a href="#l9.940"></a><span id="l9.940" class="difflineplus">+    // Unlike left-click, middle-click requires manual menu closing.</span>
<a href="#l9.941"></a><span id="l9.941" class="difflineplus">+    if (button.parentNode.id != &quot;panelMenu_bookmarksMenu&quot; ||</span>
<a href="#l9.942"></a><span id="l9.942" class="difflineplus">+        (event.type == &quot;click&quot; &amp;&amp; event.button == 1 &amp;&amp; PlacesUIUtils.openInTabClosesMenu)) {</span>
<a href="#l9.943"></a><span id="l9.943" class="difflineplus">+      this.panelMultiView.closest(&quot;panel&quot;).hidePopup();</span>
<a href="#l9.944"></a><span id="l9.944" class="difflineplus">+    }</span>
<a href="#l9.945"></a><span id="l9.945">   }</span>
<a href="#l9.946"></a><span id="l9.946"> </span>
<a href="#l9.947"></a><span id="l9.947">   _onDragEnd() {</span>
<a href="#l9.948"></a><span id="l9.948">     this._draggedElt = null;</span>
<a href="#l9.949"></a><span id="l9.949">   }</span>
<a href="#l9.950"></a><span id="l9.950"> </span>
<a href="#l9.951"></a><span id="l9.951">   _onDragStart(event) {</span>
<a href="#l9.952"></a><span id="l9.952">     let draggedElt = event.originalTarget;</span>
<a href="#l9.953"></a><span id="l9.953" class="difflineat">@@ -2066,17 +2191,16 @@ var PlacesPanelview = class extends Plac</span>
<a href="#l9.954"></a><span id="l9.954">     this._rootElt.focus();</span>
<a href="#l9.955"></a><span id="l9.955"> </span>
<a href="#l9.956"></a><span id="l9.956">     this._controller.setDataTransfer(event);</span>
<a href="#l9.957"></a><span id="l9.957">     event.stopPropagation();</span>
<a href="#l9.958"></a><span id="l9.958">   }</span>
<a href="#l9.959"></a><span id="l9.959"> </span>
<a href="#l9.960"></a><span id="l9.960">   uninit(event) {</span>
<a href="#l9.961"></a><span id="l9.961">     this._removeEventListeners(this.panelMultiView, this.events);</span>
<a href="#l9.962"></a><span id="l9.962" class="difflineminus">-    this._removeEventListeners(this._viewElt, [&quot;ViewShowing&quot;]);</span>
<a href="#l9.963"></a><span id="l9.963">     this._removeEventListeners(window, [&quot;unload&quot;]);</span>
<a href="#l9.964"></a><span id="l9.964">     super.uninit(event);</span>
<a href="#l9.965"></a><span id="l9.965">   }</span>
<a href="#l9.966"></a><span id="l9.966"> </span>
<a href="#l9.967"></a><span id="l9.967">   _createDOMNodeForPlacesNode(placesNode) {</span>
<a href="#l9.968"></a><span id="l9.968">     this._domNodes.delete(placesNode);</span>
<a href="#l9.969"></a><span id="l9.969"> </span>
<a href="#l9.970"></a><span id="l9.970">     let element;</span>
<a href="#l9.971"></a><span id="l9.971" class="difflineat">@@ -2148,30 +2272,28 @@ var PlacesPanelview = class extends Plac</span>
<a href="#l9.972"></a><span id="l9.972">       if (!PlacesUtils.nodeIsFolder(placesNode) ||</span>
<a href="#l9.973"></a><span id="l9.973">           this.controller.hasCachedLivemarkInfo(placesNode)) {</span>
<a href="#l9.974"></a><span id="l9.974">         placesNode.containerOpen = false;</span>
<a href="#l9.975"></a><span id="l9.975">       }</span>
<a href="#l9.976"></a><span id="l9.976">     }</span>
<a href="#l9.977"></a><span id="l9.977">   }</span>
<a href="#l9.978"></a><span id="l9.978"> </span>
<a href="#l9.979"></a><span id="l9.979">   _onPopupShowing(event) {</span>
<a href="#l9.980"></a><span id="l9.980" class="difflineminus">-    // If the event came from the root element, this is a sign that the panelmultiview</span>
<a href="#l9.981"></a><span id="l9.981" class="difflineminus">-    // was just instantiated (see `_onDestructed` above) or this is the first time</span>
<a href="#l9.982"></a><span id="l9.982" class="difflineplus">+    // If the event came from the root element, this is the first time</span>
<a href="#l9.983"></a><span id="l9.983">     // we ever get here.</span>
<a href="#l9.984"></a><span id="l9.984" class="difflineminus">-    if (event.originalTarget == this._viewElt) {</span>
<a href="#l9.985"></a><span id="l9.985" class="difflineminus">-      this._removeEventListeners(this._viewElt, [&quot;ViewShowing&quot;]);</span>
<a href="#l9.986"></a><span id="l9.986" class="difflineplus">+    if (event.originalTarget == this._rootElt) {</span>
<a href="#l9.987"></a><span id="l9.987">       // Start listening for events from all panels inside the panelmultiview.</span>
<a href="#l9.988"></a><span id="l9.988">       this._addEventListeners(this.panelMultiView, this.events);</span>
<a href="#l9.989"></a><span id="l9.989">     }</span>
<a href="#l9.990"></a><span id="l9.990">     super._onPopupShowing(event);</span>
<a href="#l9.991"></a><span id="l9.991">   }</span>
<a href="#l9.992"></a><span id="l9.992"> </span>
<a href="#l9.993"></a><span id="l9.993">   _onViewShown(event) {</span>
<a href="#l9.994"></a><span id="l9.994">     if (event.originalTarget != this._viewElt)</span>
<a href="#l9.995"></a><span id="l9.995">       return;</span>
<a href="#l9.996"></a><span id="l9.996"> </span>
<a href="#l9.997"></a><span id="l9.997">     // Because PanelMultiView reparents the panelview internally, the controller</span>
<a href="#l9.998"></a><span id="l9.998">     // may get lost. In that case we'll append it again, because we certainly</span>
<a href="#l9.999"></a><span id="l9.999">     // need it later!</span>
<a href="#l9.1000"></a><span id="l9.1000">     if (!this.controllers.getControllerCount() &amp;&amp; this._controller)</span>
<a href="#l9.1001"></a><span id="l9.1001">       this.controllers.appendController(this._controller);</span>
<a href="#l9.1002"></a><span id="l9.1002">   }</span>
<a href="#l9.1003"></a><span id="l9.1003" class="difflineminus">-}</span>
<a href="#l9.1004"></a><span id="l9.1004" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/suite/common/places/content/controller.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/suite/common/places/content/controller.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,78 +1,63 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* -*- indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l10.5"></a><span id="l10.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.6"></a><span id="l10.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.7"></a><span id="l10.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineminus">-</span>
<a href="#l10.12"></a><span id="l10.12"> ChromeUtils.defineModuleGetter(this, &quot;ForgetAboutSite&quot;,</span>
<a href="#l10.13"></a><span id="l10.13">                                &quot;resource://gre/modules/ForgetAboutSite.jsm&quot;);</span>
<a href="#l10.14"></a><span id="l10.14"> ChromeUtils.defineModuleGetter(this, &quot;NetUtil&quot;,</span>
<a href="#l10.15"></a><span id="l10.15">                                &quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l10.16"></a><span id="l10.16"> ChromeUtils.defineModuleGetter(this, &quot;PrivateBrowsingUtils&quot;,</span>
<a href="#l10.17"></a><span id="l10.17">                                &quot;resource://gre/modules/PrivateBrowsingUtils.jsm&quot;);</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-// XXXmano: we should move most/all of these constants to PlacesUtils</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-const ORGANIZER_ROOT_BOOKMARKS = &quot;place:folder=BOOKMARKS_MENU&amp;excludeItems=1&amp;queryType=1&quot;;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-// No change to the view, preserve current selection</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-const RELOAD_ACTION_NOTHING = 0;</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-// Inserting items new to the view, select the inserted rows</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-const RELOAD_ACTION_INSERT = 1;</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-// Removing items from the view, select the first item after the last selected</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-const RELOAD_ACTION_REMOVE = 2;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-// Moving items within a view, don't treat the dropped items as additional</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-// rows.</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-const RELOAD_ACTION_MOVE = 3;</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-</span>
<a href="#l10.32"></a><span id="l10.32"> /**</span>
<a href="#l10.33"></a><span id="l10.33">  * Represents an insertion point within a container where we can insert</span>
<a href="#l10.34"></a><span id="l10.34">  * items.</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">- * @param   aItemId</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">- *          The identifier of the parent container</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">- * @param   aIndex</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">- *          The index within the container where we should insert</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">- * @param   aOrientation</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">- *          The orientation of the insertion. NOTE: the adjustments to the</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">- *          insertion point to accommodate the orientation should be done by</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">- *          the person who constructs the IP, not the user. The orientation</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">- *          is provided for informational purposes only!</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">- * @param   [optional] aTag</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">- *          The tag name if this IP is set to a tag, null otherwise.</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">- * @param   [optional] aDropNearItemId</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">- *          When defined we will calculate index based on this itemId</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">- * @constructor</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+ * @param {object} an object containing the following properties:</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+ *   - parentId</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+ *     The identifier of the parent container</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+ *   - parentGuid</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+ *     The unique identifier of the parent container</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+ *   - index</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+ *     The index within the container where to insert, defaults to appending</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+ *   - orientation</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+ *     The orientation of the insertion. NOTE: the adjustments to the</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+ *     insertion point to accommodate the orientation should be done by</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+ *     the person who constructs the IP, not the user. The orientation</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+ *     is provided for informational purposes only! Defaults to DROP_ON.</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+ *   - tagName</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+ *     The tag name if this IP is set to a tag, null otherwise.</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+ *   - dropNearNode</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+ *     When defined index will be calculated based on this node</span>
<a href="#l10.65"></a><span id="l10.65">  */</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-function InsertionPoint(aItemId, aIndex, aOrientation, aTagName = null,</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-                        aDropNearItemId = false) {</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-  this.itemId = aItemId;</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-  this._index = aIndex;</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-  this.orientation = aOrientation;</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-  this.isTag = aIsTag;</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-  this.tagName = aTagName;</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-  this.dropNearItemId = aDropNearItemId;</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+function InsertionPoint({ parentId, parentGuid,</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+                          index = PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+                          orientation = Ci.nsITreeView.DROP_ON,</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+                          tagName = null,</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+                          dropNearNode = null }) {</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+  this.itemId = parentId;</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+  this.guid = parentGuid;</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+  this._index = index;</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+  this.orientation = orientation;</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+  this.tagName = tagName;</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+  this.dropNearNode = dropNearNode;</span>
<a href="#l10.85"></a><span id="l10.85"> }</span>
<a href="#l10.86"></a><span id="l10.86"> </span>
<a href="#l10.87"></a><span id="l10.87"> InsertionPoint.prototype = {</span>
<a href="#l10.88"></a><span id="l10.88">   set index(val) {</span>
<a href="#l10.89"></a><span id="l10.89">     return this._index = val;</span>
<a href="#l10.90"></a><span id="l10.90">   },</span>
<a href="#l10.91"></a><span id="l10.91"> </span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-  promiseGuid() {</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-    return PlacesUtils.promiseItemGuid(this.itemId);</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-  },</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-  get index() {</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-    if (this.dropNearItemId &gt; 0) {</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-      // If dropNearItemId is set up we must calculate the real index of</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-      // the item near which we will drop.</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-      var index = PlacesUtils.bookmarks.getItemIndex(this.dropNearItemId);</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+  async getIndex() {</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+    if (this.dropNearNode) {</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+      // If dropNearNode is set up we must calculate the index of the item near</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+      // which we will drop.</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+      let index = (await PlacesUtils.bookmarks.fetch(this.dropNearNode.bookmarkGuid)).index;</span>
<a href="#l10.106"></a><span id="l10.106">       return this.orientation == Ci.nsITreeView.DROP_BEFORE ? index : index + 1;</span>
<a href="#l10.107"></a><span id="l10.107">     }</span>
<a href="#l10.108"></a><span id="l10.108">     return this._index;</span>
<a href="#l10.109"></a><span id="l10.109">   },</span>
<a href="#l10.110"></a><span id="l10.110"> </span>
<a href="#l10.111"></a><span id="l10.111">   get isTag() {</span>
<a href="#l10.112"></a><span id="l10.112">     return typeof(this.tagName) == &quot;string&quot;;</span>
<a href="#l10.113"></a><span id="l10.113">   }</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineat">@@ -130,24 +115,18 @@ PlacesController.prototype = {</span>
<a href="#l10.115"></a><span id="l10.115">     // filters out other commands that we do _not_ support (see 329587).</span>
<a href="#l10.116"></a><span id="l10.116">     const CMD_PREFIX = &quot;placesCmd_&quot;;</span>
<a href="#l10.117"></a><span id="l10.117">     return (aCommand.substr(0, CMD_PREFIX.length) == CMD_PREFIX);</span>
<a href="#l10.118"></a><span id="l10.118">   },</span>
<a href="#l10.119"></a><span id="l10.119"> </span>
<a href="#l10.120"></a><span id="l10.120">   isCommandEnabled: function PC_isCommandEnabled(aCommand) {</span>
<a href="#l10.121"></a><span id="l10.121">     switch (aCommand) {</span>
<a href="#l10.122"></a><span id="l10.122">     case &quot;cmd_undo&quot;:</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-      if (!PlacesUIUtils.useAsyncTransactions)</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-        return PlacesUtils.transactionManager.numberOfUndoItems &gt; 0;</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-</span>
<a href="#l10.126"></a><span id="l10.126">       return PlacesTransactions.topUndoEntry != null;</span>
<a href="#l10.127"></a><span id="l10.127">     case &quot;cmd_redo&quot;:</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-      if (!PlacesUIUtils.useAsyncTransactions)</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-        return PlacesUtils.transactionManager.numberOfRedoItems &gt; 0;</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-</span>
<a href="#l10.131"></a><span id="l10.131">       return PlacesTransactions.topRedoEntry != null;</span>
<a href="#l10.132"></a><span id="l10.132">     case &quot;cmd_cut&quot;:</span>
<a href="#l10.133"></a><span id="l10.133">     case &quot;placesCmd_cut&quot;:</span>
<a href="#l10.134"></a><span id="l10.134">       for (let node of this._view.selectedNodes) {</span>
<a href="#l10.135"></a><span id="l10.135">         // If selection includes history nodes or tags-as-bookmark, disallow</span>
<a href="#l10.136"></a><span id="l10.136">         // cutting.</span>
<a href="#l10.137"></a><span id="l10.137">         if (node.itemId == -1 ||</span>
<a href="#l10.138"></a><span id="l10.138">             (node.parent &amp;&amp; PlacesUtils.nodeIsTagQuery(node.parent))) {</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineat">@@ -185,53 +164,45 @@ PlacesController.prototype = {</span>
<a href="#l10.140"></a><span id="l10.140">       return this._canInsert();</span>
<a href="#l10.141"></a><span id="l10.141">     case &quot;placesCmd_new:separator&quot;:</span>
<a href="#l10.142"></a><span id="l10.142">       return this._canInsert() &amp;&amp;</span>
<a href="#l10.143"></a><span id="l10.143">              !PlacesUtils.asQuery(this._view.result.root).queryOptions.excludeItems &amp;&amp;</span>
<a href="#l10.144"></a><span id="l10.144">              this._view.result.sortingMode ==</span>
<a href="#l10.145"></a><span id="l10.145">                  Ci.nsINavHistoryQueryOptions.SORT_BY_NONE;</span>
<a href="#l10.146"></a><span id="l10.146">     case &quot;placesCmd_show:info&quot;: {</span>
<a href="#l10.147"></a><span id="l10.147">       let selectedNode = this._view.selectedNode;</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-      return selectedNode &amp;&amp; PlacesUtils.getConcreteItemId(selectedNode) != -1</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+      return selectedNode &amp;&amp; PlacesUtils.getConcreteItemId(selectedNode) != -1;</span>
<a href="#l10.150"></a><span id="l10.150">     }</span>
<a href="#l10.151"></a><span id="l10.151">     case &quot;placesCmd_reload&quot;: {</span>
<a href="#l10.152"></a><span id="l10.152">       // Livemark containers</span>
<a href="#l10.153"></a><span id="l10.153">       let selectedNode = this._view.selectedNode;</span>
<a href="#l10.154"></a><span id="l10.154">       return selectedNode &amp;&amp; this.hasCachedLivemarkInfo(selectedNode);</span>
<a href="#l10.155"></a><span id="l10.155">     }</span>
<a href="#l10.156"></a><span id="l10.156">     case &quot;placesCmd_sortBy:name&quot;: {</span>
<a href="#l10.157"></a><span id="l10.157">       let selectedNode = this._view.selectedNode;</span>
<a href="#l10.158"></a><span id="l10.158">       return selectedNode &amp;&amp;</span>
<a href="#l10.159"></a><span id="l10.159">              PlacesUtils.nodeIsFolder(selectedNode) &amp;&amp;</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineminus">-             !PlacesUIUtils.isContentsReadOnly(selectedNode) &amp;&amp;</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+             !PlacesUIUtils.isFolderReadOnly(selectedNode, this._view) &amp;&amp;</span>
<a href="#l10.162"></a><span id="l10.162">              this._view.result.sortingMode ==</span>
<a href="#l10.163"></a><span id="l10.163">                  Ci.nsINavHistoryQueryOptions.SORT_BY_NONE;</span>
<a href="#l10.164"></a><span id="l10.164">     }</span>
<a href="#l10.165"></a><span id="l10.165">     case &quot;placesCmd_createBookmark&quot;:</span>
<a href="#l10.166"></a><span id="l10.166">       var node = this._view.selectedNode;</span>
<a href="#l10.167"></a><span id="l10.167">       return node &amp;&amp; PlacesUtils.nodeIsURI(node) &amp;&amp; node.itemId == -1;</span>
<a href="#l10.168"></a><span id="l10.168">     default:</span>
<a href="#l10.169"></a><span id="l10.169">       return false;</span>
<a href="#l10.170"></a><span id="l10.170">     }</span>
<a href="#l10.171"></a><span id="l10.171">   },</span>
<a href="#l10.172"></a><span id="l10.172"> </span>
<a href="#l10.173"></a><span id="l10.173">   doCommand: function PC_doCommand(aCommand) {</span>
<a href="#l10.174"></a><span id="l10.174">     switch (aCommand) {</span>
<a href="#l10.175"></a><span id="l10.175">     case &quot;cmd_undo&quot;:</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineminus">-      if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineminus">-        PlacesUtils.transactionManager.undoTransaction();</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineminus">-        return;</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineminus">-      }</span>
<a href="#l10.180"></a><span id="l10.180">       PlacesTransactions.undo().catch(Cu.reportError);</span>
<a href="#l10.181"></a><span id="l10.181">       break;</span>
<a href="#l10.182"></a><span id="l10.182">     case &quot;cmd_redo&quot;:</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineminus">-      if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineminus">-        PlacesUtils.transactionManager.redoTransaction();</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineminus">-        return;</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineminus">-      }</span>
<a href="#l10.187"></a><span id="l10.187">       PlacesTransactions.redo().catch(Cu.reportError);</span>
<a href="#l10.188"></a><span id="l10.188">       break;</span>
<a href="#l10.189"></a><span id="l10.189">     case &quot;cmd_cut&quot;:</span>
<a href="#l10.190"></a><span id="l10.190">     case &quot;placesCmd_cut&quot;:</span>
<a href="#l10.191"></a><span id="l10.191">       this.cut();</span>
<a href="#l10.192"></a><span id="l10.192">       break;</span>
<a href="#l10.193"></a><span id="l10.193">     case &quot;cmd_copy&quot;:</span>
<a href="#l10.194"></a><span id="l10.194">     case &quot;placesCmd_copy&quot;:</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineat">@@ -266,20 +237,20 @@ PlacesController.prototype = {</span>
<a href="#l10.196"></a><span id="l10.196">       break;</span>
<a href="#l10.197"></a><span id="l10.197">     case &quot;placesCmd_open:privatewindow&quot;:</span>
<a href="#l10.198"></a><span id="l10.198">       PlacesUIUtils.openNodeIn(this._view.selectedNode, &quot;window&quot;, this._view, true);</span>
<a href="#l10.199"></a><span id="l10.199">       break;</span>
<a href="#l10.200"></a><span id="l10.200">     case &quot;placesCmd_open:tab&quot;:</span>
<a href="#l10.201"></a><span id="l10.201">       PlacesUIUtils.openNodeIn(this._view.selectedNode, &quot;tab&quot;, this._view);</span>
<a href="#l10.202"></a><span id="l10.202">       break;</span>
<a href="#l10.203"></a><span id="l10.203">     case &quot;placesCmd_new:folder&quot;:</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineminus">-      this.newItem(&quot;folder&quot;);</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineplus">+      this.newItem(&quot;folder&quot;).catch(Cu.reportError);</span>
<a href="#l10.206"></a><span id="l10.206">       break;</span>
<a href="#l10.207"></a><span id="l10.207">     case &quot;placesCmd_new:bookmark&quot;:</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineminus">-      this.newItem(&quot;bookmark&quot;);</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineplus">+      this.newItem(&quot;bookmark&quot;).catch(Cu.reportError);</span>
<a href="#l10.210"></a><span id="l10.210">       break;</span>
<a href="#l10.211"></a><span id="l10.211">     case &quot;placesCmd_new:separator&quot;:</span>
<a href="#l10.212"></a><span id="l10.212">       this.newSeparator().catch(Cu.reportError);</span>
<a href="#l10.213"></a><span id="l10.213">       break;</span>
<a href="#l10.214"></a><span id="l10.214">     case &quot;placesCmd_show:info&quot;:</span>
<a href="#l10.215"></a><span id="l10.215">       this.showBookmarkPropertiesForSelection();</span>
<a href="#l10.216"></a><span id="l10.216">       break;</span>
<a href="#l10.217"></a><span id="l10.217">     case &quot;placesCmd_reload&quot;:</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineat">@@ -325,17 +296,17 @@ PlacesController.prototype = {</span>
<a href="#l10.219"></a><span id="l10.219"> </span>
<a href="#l10.220"></a><span id="l10.220">     for (var j = 0; j &lt; ranges.length; j++) {</span>
<a href="#l10.221"></a><span id="l10.221">       var nodes = ranges[j];</span>
<a href="#l10.222"></a><span id="l10.222">       for (var i = 0; i &lt; nodes.length; ++i) {</span>
<a href="#l10.223"></a><span id="l10.223">         // Disallow removing the view's root node</span>
<a href="#l10.224"></a><span id="l10.224">         if (nodes[i] == root)</span>
<a href="#l10.225"></a><span id="l10.225">           return false;</span>
<a href="#l10.226"></a><span id="l10.226"> </span>
<a href="#l10.227"></a><span id="l10.227" class="difflineminus">-        if (!PlacesUIUtils.canUserRemove(nodes[i]))</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+        if (!PlacesUIUtils.canUserRemove(nodes[i], this._view))</span>
<a href="#l10.229"></a><span id="l10.229">           return false;</span>
<a href="#l10.230"></a><span id="l10.230">       }</span>
<a href="#l10.231"></a><span id="l10.231">     }</span>
<a href="#l10.232"></a><span id="l10.232"> </span>
<a href="#l10.233"></a><span id="l10.233">     return true;</span>
<a href="#l10.234"></a><span id="l10.234">   },</span>
<a href="#l10.235"></a><span id="l10.235"> </span>
<a href="#l10.236"></a><span id="l10.236">   /**</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineat">@@ -422,47 +393,47 @@ PlacesController.prototype = {</span>
<a href="#l10.238"></a><span id="l10.238">       var node = nodes[i];</span>
<a href="#l10.239"></a><span id="l10.239">       var nodeType = node.type;</span>
<a href="#l10.240"></a><span id="l10.240">       var uri = null;</span>
<a href="#l10.241"></a><span id="l10.241"> </span>
<a href="#l10.242"></a><span id="l10.242">       // We don't use the nodeIs* methods here to avoid going through the type</span>
<a href="#l10.243"></a><span id="l10.243">       // property way too often</span>
<a href="#l10.244"></a><span id="l10.244">       switch (nodeType) {</span>
<a href="#l10.245"></a><span id="l10.245">         case Ci.nsINavHistoryResultNode.RESULT_TYPE_QUERY:</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineminus">-          nodeData[&quot;query&quot;] = true;</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineplus">+          nodeData.query = true;</span>
<a href="#l10.248"></a><span id="l10.248">           if (node.parent) {</span>
<a href="#l10.249"></a><span id="l10.249">             switch (PlacesUtils.asQuery(node.parent).queryOptions.resultType) {</span>
<a href="#l10.250"></a><span id="l10.250">               case Ci.nsINavHistoryQueryOptions.RESULTS_AS_SITE_QUERY:</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineminus">-                nodeData[&quot;host&quot;] = true;</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+                nodeData.host = true;</span>
<a href="#l10.253"></a><span id="l10.253">                 break;</span>
<a href="#l10.254"></a><span id="l10.254">               case Ci.nsINavHistoryQueryOptions.RESULTS_AS_DATE_SITE_QUERY:</span>
<a href="#l10.255"></a><span id="l10.255">               case Ci.nsINavHistoryQueryOptions.RESULTS_AS_DATE_QUERY:</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineminus">-                nodeData[&quot;day&quot;] = true;</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineplus">+                nodeData.day = true;</span>
<a href="#l10.258"></a><span id="l10.258">                 break;</span>
<a href="#l10.259"></a><span id="l10.259">             }</span>
<a href="#l10.260"></a><span id="l10.260">           }</span>
<a href="#l10.261"></a><span id="l10.261">           break;</span>
<a href="#l10.262"></a><span id="l10.262">         case Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER:</span>
<a href="#l10.263"></a><span id="l10.263">         case Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER_SHORTCUT:</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineminus">-          nodeData[&quot;folder&quot;] = true;</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineplus">+          nodeData.folder = true;</span>
<a href="#l10.266"></a><span id="l10.266">           break;</span>
<a href="#l10.267"></a><span id="l10.267">         case Ci.nsINavHistoryResultNode.RESULT_TYPE_SEPARATOR:</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineminus">-          nodeData[&quot;separator&quot;] = true;</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineplus">+          nodeData.separator = true;</span>
<a href="#l10.270"></a><span id="l10.270">           break;</span>
<a href="#l10.271"></a><span id="l10.271">         case Ci.nsINavHistoryResultNode.RESULT_TYPE_URI:</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineminus">-          nodeData[&quot;link&quot;] = true;</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineplus">+          nodeData.link = true;</span>
<a href="#l10.274"></a><span id="l10.274">           uri = NetUtil.newURI(node.uri);</span>
<a href="#l10.275"></a><span id="l10.275">           if (PlacesUtils.nodeIsBookmark(node)) {</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineminus">-            nodeData[&quot;bookmark&quot;] = true;</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineplus">+            nodeData.bookmark = true;</span>
<a href="#l10.278"></a><span id="l10.278">             var parentNode = node.parent;</span>
<a href="#l10.279"></a><span id="l10.279">             if (parentNode) {</span>
<a href="#l10.280"></a><span id="l10.280">               if (PlacesUtils.nodeIsTagQuery(parentNode))</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineminus">-                nodeData[&quot;tagChild&quot;] = true;</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+                nodeData.tagChild = true;</span>
<a href="#l10.283"></a><span id="l10.283">               else if (this.hasCachedLivemarkInfo(parentNode))</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineminus">-                nodeData[&quot;livemarkChild&quot;] = true;</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineplus">+                nodeData.livemarkChild = true;</span>
<a href="#l10.286"></a><span id="l10.286">             }</span>
<a href="#l10.287"></a><span id="l10.287">           }</span>
<a href="#l10.288"></a><span id="l10.288">           break;</span>
<a href="#l10.289"></a><span id="l10.289">       }</span>
<a href="#l10.290"></a><span id="l10.290"> </span>
<a href="#l10.291"></a><span id="l10.291">       // annotations</span>
<a href="#l10.292"></a><span id="l10.292">       if (uri) {</span>
<a href="#l10.293"></a><span id="l10.293">         let names = PlacesUtils.annotations.getPageAnnotationNames(uri);</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineat">@@ -723,72 +694,61 @@ PlacesController.prototype = {</span>
<a href="#l10.295"></a><span id="l10.295">   },</span>
<a href="#l10.296"></a><span id="l10.296"> </span>
<a href="#l10.297"></a><span id="l10.297">   /**</span>
<a href="#l10.298"></a><span id="l10.298">    * Shows the Add Bookmark UI for the current insertion point.</span>
<a href="#l10.299"></a><span id="l10.299">    *</span>
<a href="#l10.300"></a><span id="l10.300">    * @param aType</span>
<a href="#l10.301"></a><span id="l10.301">    *        the type of the new item (bookmark/livemark/folder)</span>
<a href="#l10.302"></a><span id="l10.302">    */</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineminus">-  newItem: function PC_newItem(aType) {</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineplus">+  async newItem(aType) {</span>
<a href="#l10.305"></a><span id="l10.305">     let ip = this._view.insertionPoint;</span>
<a href="#l10.306"></a><span id="l10.306">     if (!ip)</span>
<a href="#l10.307"></a><span id="l10.307">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l10.308"></a><span id="l10.308"> </span>
<a href="#l10.309"></a><span id="l10.309">     let performed =</span>
<a href="#l10.310"></a><span id="l10.310">       PlacesUIUtils.showBookmarkDialog({ action: &quot;add&quot;,</span>
<a href="#l10.311"></a><span id="l10.311">                                          type: aType,</span>
<a href="#l10.312"></a><span id="l10.312">                                          defaultInsertionPoint: ip,</span>
<a href="#l10.313"></a><span id="l10.313">                                          hiddenRows: [ &quot;folderPicker&quot; ]</span>
<a href="#l10.314"></a><span id="l10.314">                                        }, window.top);</span>
<a href="#l10.315"></a><span id="l10.315">     if (performed) {</span>
<a href="#l10.316"></a><span id="l10.316">       // Select the new item.</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineminus">-      let insertedNodeId = PlacesUtils.bookmarks</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineminus">-                                      .getIdForItemAt(ip.itemId, ip.index);</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineminus">-      this._view.selectItems([insertedNodeId], false);</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineplus">+      // TODO (Bug 1425555): When we remove places transactions, we might be</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineplus">+      // able to improve showBookmarkDialog to return the guid direct, and</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineplus">+      // avoid the fetch.</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineplus">+      let insertedNode = await PlacesUtils.bookmarks.fetch({</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineplus">+        parentGuid: ip.guid,</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineplus">+        index: await ip.getIndex()</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineplus">+      });</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineplus">+</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineplus">+      this._view.selectItems([insertedNode.guid], false);</span>
<a href="#l10.329"></a><span id="l10.329">     }</span>
<a href="#l10.330"></a><span id="l10.330">   },</span>
<a href="#l10.331"></a><span id="l10.331"> </span>
<a href="#l10.332"></a><span id="l10.332">   /**</span>
<a href="#l10.333"></a><span id="l10.333">    * Create a new Bookmark separator somewhere.</span>
<a href="#l10.334"></a><span id="l10.334">    */</span>
<a href="#l10.335"></a><span id="l10.335">   async newSeparator() {</span>
<a href="#l10.336"></a><span id="l10.336">     var ip = this._view.insertionPoint;</span>
<a href="#l10.337"></a><span id="l10.337">     if (!ip)</span>
<a href="#l10.338"></a><span id="l10.338">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l10.339"></a><span id="l10.339"> </span>
<a href="#l10.340"></a><span id="l10.340" class="difflineminus">-    if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineminus">-      let txn = new PlacesCreateSeparatorTransaction(ip.itemId, ip.index);</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineminus">-      // Select the new item.</span>
<a href="#l10.344"></a><span id="l10.344" class="difflineminus">-      let insertedNodeId = PlacesUtils.bookmarks</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineminus">-                                      .getIdForItemAt(ip.itemId, ip.index);</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineminus">-      this._view.selectItems([insertedNodeId], false);</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineminus">-      return;</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineminus">-    }</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineminus">-</span>
<a href="#l10.350"></a><span id="l10.350" class="difflineminus">-    let txn = PlacesTransactions.NewSeparator({ parentGuid: await ip.promiseGuid(),</span>
<a href="#l10.351"></a><span id="l10.351" class="difflineminus">-                                                index: ip.index });</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineplus">+    let index = await ip.getIndex();</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineplus">+    let txn = PlacesTransactions.NewSeparator({ parentGuid: ip.guid, index });</span>
<a href="#l10.354"></a><span id="l10.354">     let guid = await txn.transact();</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineminus">-    let itemId = await PlacesUtils.promiseItemId(guid);</span>
<a href="#l10.356"></a><span id="l10.356">     // Select the new item.</span>
<a href="#l10.357"></a><span id="l10.357" class="difflineminus">-    this._view.selectItems([itemId], false);</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineplus">+    this._view.selectItems([guid], false);</span>
<a href="#l10.359"></a><span id="l10.359">   },</span>
<a href="#l10.360"></a><span id="l10.360"> </span>
<a href="#l10.361"></a><span id="l10.361">   /**</span>
<a href="#l10.362"></a><span id="l10.362">    * Sort the selected folder by name</span>
<a href="#l10.363"></a><span id="l10.363">    */</span>
<a href="#l10.364"></a><span id="l10.364">   async sortFolderByName() {</span>
<a href="#l10.365"></a><span id="l10.365" class="difflineminus">-    let itemId = PlacesUtils.getConcreteItemId(this._view.selectedNode);</span>
<a href="#l10.366"></a><span id="l10.366" class="difflineminus">-    if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l10.367"></a><span id="l10.367" class="difflineminus">-      var txn = new PlacesSortFolderByNameTransaction(itemId);</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l10.369"></a><span id="l10.369" class="difflineminus">-      return;</span>
<a href="#l10.370"></a><span id="l10.370" class="difflineminus">-    }</span>
<a href="#l10.371"></a><span id="l10.371" class="difflineminus">-    let guid = await PlacesUtils.promiseItemGuid(itemId);</span>
<a href="#l10.372"></a><span id="l10.372" class="difflineplus">+    let guid = PlacesUtils.getConcreteItemGuid(this._view.selectedNode);</span>
<a href="#l10.373"></a><span id="l10.373">     await PlacesTransactions.SortByName(guid).transact();</span>
<a href="#l10.374"></a><span id="l10.374">   },</span>
<a href="#l10.375"></a><span id="l10.375"> </span>
<a href="#l10.376"></a><span id="l10.376">   /**</span>
<a href="#l10.377"></a><span id="l10.377">    * Walk the list of folders we're removing in this delete operation, and</span>
<a href="#l10.378"></a><span id="l10.378">    * see if the selected node specified is already implicitly being removed</span>
<a href="#l10.379"></a><span id="l10.379">    * because it is a child of that folder.</span>
<a href="#l10.380"></a><span id="l10.380">    * @param   node</span>
<a href="#l10.381"></a><span id="l10.381" class="difflineat">@@ -827,59 +787,55 @@ PlacesController.prototype = {</span>
<a href="#l10.382"></a><span id="l10.382">    * Creates a set of transactions for the removal of a range of items.</span>
<a href="#l10.383"></a><span id="l10.383">    * A range is an array of adjacent nodes in a view.</span>
<a href="#l10.384"></a><span id="l10.384">    * @param   [in] range</span>
<a href="#l10.385"></a><span id="l10.385">    *          An array of nodes to remove. Should all be adjacent.</span>
<a href="#l10.386"></a><span id="l10.386">    * @param   [out] transactions</span>
<a href="#l10.387"></a><span id="l10.387">    *          An array of transactions.</span>
<a href="#l10.388"></a><span id="l10.388">    * @param   [optional] removedFolders</span>
<a href="#l10.389"></a><span id="l10.389">    *          An array of folder nodes that have already been removed.</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineplus">+   * @return {Integer} The total number of items affected.</span>
<a href="#l10.391"></a><span id="l10.391">    */</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineminus">-  _removeRange: function PC__removeRange(range, transactions, removedFolders) {</span>
<a href="#l10.393"></a><span id="l10.393" class="difflineplus">+  async _removeRange(range, transactions, removedFolders) {</span>
<a href="#l10.394"></a><span id="l10.394">     NS_ASSERT(transactions instanceof Array, &quot;Must pass a transactions array&quot;);</span>
<a href="#l10.395"></a><span id="l10.395">     if (!removedFolders)</span>
<a href="#l10.396"></a><span id="l10.396">       removedFolders = [];</span>
<a href="#l10.397"></a><span id="l10.397"> </span>
<a href="#l10.398"></a><span id="l10.398" class="difflineplus">+    let bmGuidsToRemove = [];</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineplus">+    let totalItems = 0;</span>
<a href="#l10.400"></a><span id="l10.400" class="difflineplus">+</span>
<a href="#l10.401"></a><span id="l10.401">     for (var i = 0; i &lt; range.length; ++i) {</span>
<a href="#l10.402"></a><span id="l10.402">       var node = range[i];</span>
<a href="#l10.403"></a><span id="l10.403">       if (this._shouldSkipNode(node, removedFolders))</span>
<a href="#l10.404"></a><span id="l10.404">         continue;</span>
<a href="#l10.405"></a><span id="l10.405"> </span>
<a href="#l10.406"></a><span id="l10.406" class="difflineplus">+      totalItems++;</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineplus">+</span>
<a href="#l10.408"></a><span id="l10.408">       if (PlacesUtils.nodeIsTagQuery(node.parent)) {</span>
<a href="#l10.409"></a><span id="l10.409">         // This is a uri node inside a tag container.  It needs a special</span>
<a href="#l10.410"></a><span id="l10.410">         // untag transaction.</span>
<a href="#l10.411"></a><span id="l10.411" class="difflineminus">-        var tagItemId = PlacesUtils.getConcreteItemId(node.parent);</span>
<a href="#l10.412"></a><span id="l10.412" class="difflineminus">-        var uri = NetUtil.newURI(node.uri);</span>
<a href="#l10.413"></a><span id="l10.413" class="difflineminus">-        if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l10.414"></a><span id="l10.414" class="difflineminus">-          let tag = node.parent.title;</span>
<a href="#l10.415"></a><span id="l10.415" class="difflineminus">-          if (!tag)</span>
<a href="#l10.416"></a><span id="l10.416" class="difflineminus">-            tag = PlacesUtils.bookmarks.getItemTitle(tagItemId);</span>
<a href="#l10.417"></a><span id="l10.417" class="difflineminus">-          transactions.push(PlacesTransactions.Untag({ uri, tag }));</span>
<a href="#l10.418"></a><span id="l10.418" class="difflineminus">-        } else {</span>
<a href="#l10.419"></a><span id="l10.419" class="difflineminus">-          let txn = new PlacesUntagURITransaction(uri, [tagItemId]);</span>
<a href="#l10.420"></a><span id="l10.420" class="difflineminus">-          transactions.push(txn);</span>
<a href="#l10.421"></a><span id="l10.421" class="difflineplus">+        let tag = node.parent.title;</span>
<a href="#l10.422"></a><span id="l10.422" class="difflineplus">+        if (!tag) {</span>
<a href="#l10.423"></a><span id="l10.423" class="difflineplus">+          // TODO: Bug 1432405 Try using getConcreteItemGuid.</span>
<a href="#l10.424"></a><span id="l10.424" class="difflineplus">+          let tagItemId = PlacesUtils.getConcreteItemId(node.parent);</span>
<a href="#l10.425"></a><span id="l10.425" class="difflineplus">+          let tagGuid = await PlacesUtils.promiseItemGuid(tagItemId);</span>
<a href="#l10.426"></a><span id="l10.426" class="difflineplus">+          tag = (await PlacesUtils.bookmarks.fetch(tagGuid)).title;</span>
<a href="#l10.427"></a><span id="l10.427">         }</span>
<a href="#l10.428"></a><span id="l10.428" class="difflineplus">+        transactions.push(PlacesTransactions.Untag({ urls: [node.uri], tag }));</span>
<a href="#l10.429"></a><span id="l10.429">       } else if (PlacesUtils.nodeIsTagQuery(node) &amp;&amp; node.parent &amp;&amp;</span>
<a href="#l10.430"></a><span id="l10.430">                PlacesUtils.nodeIsQuery(node.parent) &amp;&amp;</span>
<a href="#l10.431"></a><span id="l10.431">                PlacesUtils.asQuery(node.parent).queryOptions.resultType ==</span>
<a href="#l10.432"></a><span id="l10.432">                  Ci.nsINavHistoryQueryOptions.RESULTS_AS_TAG_QUERY) {</span>
<a href="#l10.433"></a><span id="l10.433">         // This is a tag container.</span>
<a href="#l10.434"></a><span id="l10.434">         // Untag all URIs tagged with this tag only if the tag container is</span>
<a href="#l10.435"></a><span id="l10.435">         // child of the &quot;Tags&quot; query in the library, in all other places we</span>
<a href="#l10.436"></a><span id="l10.436">         // must only remove the query node.</span>
<a href="#l10.437"></a><span id="l10.437">         let tag = node.title;</span>
<a href="#l10.438"></a><span id="l10.438">         let URIs = PlacesUtils.tagging.getURIsForTag(tag);</span>
<a href="#l10.439"></a><span id="l10.439" class="difflineminus">-        if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l10.440"></a><span id="l10.440" class="difflineminus">-          transactions.push(PlacesTransactions.Untag({ tag, urls: URIs }));</span>
<a href="#l10.441"></a><span id="l10.441" class="difflineminus">-        } else {</span>
<a href="#l10.442"></a><span id="l10.442" class="difflineminus">-          for (var j = 0; j &lt; URIs.length; j++) {</span>
<a href="#l10.443"></a><span id="l10.443" class="difflineminus">-            let txn = new PlacesUntagURITransaction(URIs[j], [tag]);</span>
<a href="#l10.444"></a><span id="l10.444" class="difflineminus">-            transactions.push(txn);</span>
<a href="#l10.445"></a><span id="l10.445" class="difflineminus">-          }</span>
<a href="#l10.446"></a><span id="l10.446" class="difflineminus">-        }</span>
<a href="#l10.447"></a><span id="l10.447" class="difflineplus">+        transactions.push(PlacesTransactions.Untag({ tag, urls: URIs }));</span>
<a href="#l10.448"></a><span id="l10.448">       } else if (PlacesUtils.nodeIsURI(node) &amp;&amp;</span>
<a href="#l10.449"></a><span id="l10.449">                PlacesUtils.nodeIsQuery(node.parent) &amp;&amp;</span>
<a href="#l10.450"></a><span id="l10.450">                PlacesUtils.asQuery(node.parent).queryOptions.queryType ==</span>
<a href="#l10.451"></a><span id="l10.451">                  Ci.nsINavHistoryQueryOptions.QUERY_TYPE_HISTORY) {</span>
<a href="#l10.452"></a><span id="l10.452">         // This is a uri node inside an history query.</span>
<a href="#l10.453"></a><span id="l10.453">         PlacesUtils.history.remove(node.uri).catch(Cu.reportError);</span>
<a href="#l10.454"></a><span id="l10.454">         // History deletes are not undoable, so we don't have a transaction.</span>
<a href="#l10.455"></a><span id="l10.455">       } else if (node.itemId == -1 &amp;&amp;</span>
<a href="#l10.456"></a><span id="l10.456" class="difflineat">@@ -893,47 +849,44 @@ PlacesController.prototype = {</span>
<a href="#l10.457"></a><span id="l10.457">         // History deletes are not undoable, so we don't have a transaction.</span>
<a href="#l10.458"></a><span id="l10.458">       } else {</span>
<a href="#l10.459"></a><span id="l10.459">         // This is a common bookmark item.</span>
<a href="#l10.460"></a><span id="l10.460">         if (PlacesUtils.nodeIsFolder(node)) {</span>
<a href="#l10.461"></a><span id="l10.461">           // If this is a folder we add it to our array of folders, used</span>
<a href="#l10.462"></a><span id="l10.462">           // to skip nodes that are children of an already removed folder.</span>
<a href="#l10.463"></a><span id="l10.463">           removedFolders.push(node);</span>
<a href="#l10.464"></a><span id="l10.464">         }</span>
<a href="#l10.465"></a><span id="l10.465" class="difflineminus">-        if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l10.466"></a><span id="l10.466" class="difflineminus">-          transactions.push(</span>
<a href="#l10.467"></a><span id="l10.467" class="difflineminus">-            PlacesTransactions.Remove({ guid: node.bookmarkGuid }));</span>
<a href="#l10.468"></a><span id="l10.468" class="difflineminus">-        } else {</span>
<a href="#l10.469"></a><span id="l10.469" class="difflineminus">-          let txn = new PlacesRemoveItemTransaction(node.itemId);</span>
<a href="#l10.470"></a><span id="l10.470" class="difflineminus">-          transactions.push(txn);</span>
<a href="#l10.471"></a><span id="l10.471" class="difflineminus">-        }</span>
<a href="#l10.472"></a><span id="l10.472" class="difflineplus">+        bmGuidsToRemove.push(node.bookmarkGuid);</span>
<a href="#l10.473"></a><span id="l10.473">       }</span>
<a href="#l10.474"></a><span id="l10.474">     }</span>
<a href="#l10.475"></a><span id="l10.475" class="difflineplus">+    if (bmGuidsToRemove.length) {</span>
<a href="#l10.476"></a><span id="l10.476" class="difflineplus">+      transactions.push(PlacesTransactions.Remove({ guids: bmGuidsToRemove }));</span>
<a href="#l10.477"></a><span id="l10.477" class="difflineplus">+    }</span>
<a href="#l10.478"></a><span id="l10.478" class="difflineplus">+    return totalItems;</span>
<a href="#l10.479"></a><span id="l10.479">   },</span>
<a href="#l10.480"></a><span id="l10.480"> </span>
<a href="#l10.481"></a><span id="l10.481">   /**</span>
<a href="#l10.482"></a><span id="l10.482">    * Removes the set of selected ranges from bookmarks.</span>
<a href="#l10.483"></a><span id="l10.483">    * @param   txnName</span>
<a href="#l10.484"></a><span id="l10.484">    *          See |remove|.</span>
<a href="#l10.485"></a><span id="l10.485">    */</span>
<a href="#l10.486"></a><span id="l10.486">   async _removeRowsFromBookmarks(txnName) {</span>
<a href="#l10.487"></a><span id="l10.487" class="difflineminus">-    var ranges = this._view.removableSelectionRanges;</span>
<a href="#l10.488"></a><span id="l10.488" class="difflineminus">-    var transactions = [];</span>
<a href="#l10.489"></a><span id="l10.489" class="difflineminus">-    var removedFolders = [];</span>
<a href="#l10.490"></a><span id="l10.490" class="difflineplus">+    let ranges = this._view.removableSelectionRanges;</span>
<a href="#l10.491"></a><span id="l10.491" class="difflineplus">+    let transactions = [];</span>
<a href="#l10.492"></a><span id="l10.492" class="difflineplus">+    let removedFolders = [];</span>
<a href="#l10.493"></a><span id="l10.493" class="difflineplus">+    let totalItems = 0;</span>
<a href="#l10.494"></a><span id="l10.494"> </span>
<a href="#l10.495"></a><span id="l10.495" class="difflineminus">-    for (var i = 0; i &lt; ranges.length; i++)</span>
<a href="#l10.496"></a><span id="l10.496" class="difflineminus">-      this._removeRange(ranges[i], transactions, removedFolders);</span>
<a href="#l10.497"></a><span id="l10.497" class="difflineplus">+    for (let range of ranges) {</span>
<a href="#l10.498"></a><span id="l10.498" class="difflineplus">+      totalItems += await this._removeRange(range, transactions, removedFolders);</span>
<a href="#l10.499"></a><span id="l10.499" class="difflineplus">+    }</span>
<a href="#l10.500"></a><span id="l10.500"> </span>
<a href="#l10.501"></a><span id="l10.501">     if (transactions.length &gt; 0) {</span>
<a href="#l10.502"></a><span id="l10.502" class="difflineminus">-      if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l10.503"></a><span id="l10.503" class="difflineplus">+      await PlacesUIUtils.batchUpdatesForNode(this._view.result, totalItems, async () =&gt; {</span>
<a href="#l10.504"></a><span id="l10.504">         await PlacesTransactions.batch(transactions);</span>
<a href="#l10.505"></a><span id="l10.505" class="difflineminus">-      } else {</span>
<a href="#l10.506"></a><span id="l10.506" class="difflineminus">-        var txn = new PlacesAggregatedTransaction(txnName, transactions);</span>
<a href="#l10.507"></a><span id="l10.507" class="difflineminus">-        PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l10.508"></a><span id="l10.508" class="difflineminus">-      }</span>
<a href="#l10.509"></a><span id="l10.509" class="difflineplus">+      });</span>
<a href="#l10.510"></a><span id="l10.510">     }</span>
<a href="#l10.511"></a><span id="l10.511">   },</span>
<a href="#l10.512"></a><span id="l10.512"> </span>
<a href="#l10.513"></a><span id="l10.513">   /**</span>
<a href="#l10.514"></a><span id="l10.514">    * Removes the set of selected ranges from history, asynchronously.</span>
<a href="#l10.515"></a><span id="l10.515">    *</span>
<a href="#l10.516"></a><span id="l10.516">    * @note history deletes are not undoable.</span>
<a href="#l10.517"></a><span id="l10.517">    */</span>
<a href="#l10.518"></a><span id="l10.518" class="difflineat">@@ -959,29 +912,29 @@ PlacesController.prototype = {</span>
<a href="#l10.519"></a><span id="l10.519">    * @param   [in] aContainerNode</span>
<a href="#l10.520"></a><span id="l10.520">    *          The container node to remove.</span>
<a href="#l10.521"></a><span id="l10.521">    *</span>
<a href="#l10.522"></a><span id="l10.522">    * @note history deletes are not undoable.</span>
<a href="#l10.523"></a><span id="l10.523">    */</span>
<a href="#l10.524"></a><span id="l10.524">   _removeHistoryContainer: function PC__removeHistoryContainer(aContainerNode) {</span>
<a href="#l10.525"></a><span id="l10.525">     if (PlacesUtils.nodeIsHost(aContainerNode)) {</span>
<a href="#l10.526"></a><span id="l10.526">       // Site container.</span>
<a href="#l10.527"></a><span id="l10.527" class="difflineminus">-      PlacesUtils.bhistory.removePagesFromHost(aContainerNode.title, true);</span>
<a href="#l10.528"></a><span id="l10.528" class="difflineplus">+      PlacesUtils.history.removePagesFromHost(aContainerNode.title, true);</span>
<a href="#l10.529"></a><span id="l10.529">     } else if (PlacesUtils.nodeIsDay(aContainerNode)) {</span>
<a href="#l10.530"></a><span id="l10.530">       // Day container.</span>
<a href="#l10.531"></a><span id="l10.531">       let query = aContainerNode.getQueries()[0];</span>
<a href="#l10.532"></a><span id="l10.532">       let beginTime = query.beginTime;</span>
<a href="#l10.533"></a><span id="l10.533">       let endTime = query.endTime;</span>
<a href="#l10.534"></a><span id="l10.534">       NS_ASSERT(query &amp;&amp; beginTime &amp;&amp; endTime,</span>
<a href="#l10.535"></a><span id="l10.535">                 &quot;A valid date container query should exist!&quot;);</span>
<a href="#l10.536"></a><span id="l10.536">       // We want to exclude beginTime from the removal because</span>
<a href="#l10.537"></a><span id="l10.537">       // removePagesByTimeframe includes both extremes, while date containers</span>
<a href="#l10.538"></a><span id="l10.538">       // exclude the lower extreme.  So, if we would not exclude it, we would</span>
<a href="#l10.539"></a><span id="l10.539">       // end up removing more history than requested.</span>
<a href="#l10.540"></a><span id="l10.540" class="difflineminus">-      PlacesUtils.bhistory.removePagesByTimeframe(beginTime + 1, endTime);</span>
<a href="#l10.541"></a><span id="l10.541" class="difflineplus">+      PlacesUtils.history.removePagesByTimeframe(beginTime + 1, endTime);</span>
<a href="#l10.542"></a><span id="l10.542">     }</span>
<a href="#l10.543"></a><span id="l10.543">   },</span>
<a href="#l10.544"></a><span id="l10.544"> </span>
<a href="#l10.545"></a><span id="l10.545">   /**</span>
<a href="#l10.546"></a><span id="l10.546">    * Removes the selection</span>
<a href="#l10.547"></a><span id="l10.547">    * @param   aTxnName</span>
<a href="#l10.548"></a><span id="l10.548">    *          A name for the transaction if this is being performed</span>
<a href="#l10.549"></a><span id="l10.549">    *          as part of another operation.</span>
<a href="#l10.550"></a><span id="l10.550" class="difflineat">@@ -990,27 +943,21 @@ PlacesController.prototype = {</span>
<a href="#l10.551"></a><span id="l10.551">     if (!this._hasRemovableSelection())</span>
<a href="#l10.552"></a><span id="l10.552">       return;</span>
<a href="#l10.553"></a><span id="l10.553"> </span>
<a href="#l10.554"></a><span id="l10.554">     NS_ASSERT(aTxnName !== undefined, &quot;Must supply Transaction Name&quot;);</span>
<a href="#l10.555"></a><span id="l10.555"> </span>
<a href="#l10.556"></a><span id="l10.556">     var root = this._view.result.root;</span>
<a href="#l10.557"></a><span id="l10.557"> </span>
<a href="#l10.558"></a><span id="l10.558">     if (PlacesUtils.nodeIsFolder(root)) {</span>
<a href="#l10.559"></a><span id="l10.559" class="difflineminus">-      if (PlacesUIUtils.useAsyncTransactions)</span>
<a href="#l10.560"></a><span id="l10.560" class="difflineminus">-        await this._removeRowsFromBookmarks(aTxnName);</span>
<a href="#l10.561"></a><span id="l10.561" class="difflineminus">-      else</span>
<a href="#l10.562"></a><span id="l10.562" class="difflineminus">-        this._removeRowsFromBookmarks(aTxnName);</span>
<a href="#l10.563"></a><span id="l10.563" class="difflineplus">+      await this._removeRowsFromBookmarks(aTxnName);</span>
<a href="#l10.564"></a><span id="l10.564">     } else if (PlacesUtils.nodeIsQuery(root)) {</span>
<a href="#l10.565"></a><span id="l10.565">       var queryType = PlacesUtils.asQuery(root).queryOptions.queryType;</span>
<a href="#l10.566"></a><span id="l10.566">       if (queryType == Ci.nsINavHistoryQueryOptions.QUERY_TYPE_BOOKMARKS) {</span>
<a href="#l10.567"></a><span id="l10.567" class="difflineminus">-        if (PlacesUIUtils.useAsyncTransactions)</span>
<a href="#l10.568"></a><span id="l10.568" class="difflineminus">-          await this._removeRowsFromBookmarks(aTxnName);</span>
<a href="#l10.569"></a><span id="l10.569" class="difflineminus">-        else</span>
<a href="#l10.570"></a><span id="l10.570" class="difflineminus">-          this._removeRowsFromBookmarks(aTxnName);</span>
<a href="#l10.571"></a><span id="l10.571" class="difflineplus">+        await this._removeRowsFromBookmarks(aTxnName);</span>
<a href="#l10.572"></a><span id="l10.572">       } else if (queryType == Ci.nsINavHistoryQueryOptions.QUERY_TYPE_HISTORY) {</span>
<a href="#l10.573"></a><span id="l10.573">         this._removeRowsFromHistory();</span>
<a href="#l10.574"></a><span id="l10.574">       } else {</span>
<a href="#l10.575"></a><span id="l10.575">         NS_ASSERT(false, &quot;implement support for QUERY_TYPE_UNIFIED&quot;);</span>
<a href="#l10.576"></a><span id="l10.576">       }</span>
<a href="#l10.577"></a><span id="l10.577">     } else</span>
<a href="#l10.578"></a><span id="l10.578">       NS_ASSERT(false, &quot;unexpected root&quot;);</span>
<a href="#l10.579"></a><span id="l10.579">   },</span>
<a href="#l10.580"></a><span id="l10.580" class="difflineat">@@ -1065,17 +1012,17 @@ PlacesController.prototype = {</span>
<a href="#l10.581"></a><span id="l10.581"> </span>
<a href="#l10.582"></a><span id="l10.582">   get clipboardAction() {</span>
<a href="#l10.583"></a><span id="l10.583">     let action = {};</span>
<a href="#l10.584"></a><span id="l10.584">     let actionOwner;</span>
<a href="#l10.585"></a><span id="l10.585">     try {</span>
<a href="#l10.586"></a><span id="l10.586">       let xferable = Cc[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l10.587"></a><span id="l10.587">                        .createInstance(Ci.nsITransferable);</span>
<a href="#l10.588"></a><span id="l10.588">       xferable.init(null);</span>
<a href="#l10.589"></a><span id="l10.589" class="difflineminus">-      xferable.addDataFlavor(PlacesUtils.TYPE_X_MOZ_PLACE_ACTION)</span>
<a href="#l10.590"></a><span id="l10.590" class="difflineplus">+      xferable.addDataFlavor(PlacesUtils.TYPE_X_MOZ_PLACE_ACTION);</span>
<a href="#l10.591"></a><span id="l10.591">       this.clipboard.getData(xferable, Ci.nsIClipboard.kGlobalClipboard);</span>
<a href="#l10.592"></a><span id="l10.592">       xferable.getTransferData(PlacesUtils.TYPE_X_MOZ_PLACE_ACTION, action, {});</span>
<a href="#l10.593"></a><span id="l10.593">       [action, actionOwner] =</span>
<a href="#l10.594"></a><span id="l10.594">         action.value.QueryInterface(Ci.nsISupportsString).data.split(&quot;,&quot;);</span>
<a href="#l10.595"></a><span id="l10.595">     } catch (ex) {</span>
<a href="#l10.596"></a><span id="l10.596">       // Paste from external sources don't have any associated action, just</span>
<a href="#l10.597"></a><span id="l10.597">       // fallback to a copy action.</span>
<a href="#l10.598"></a><span id="l10.598">       return &quot;copy&quot;;</span>
<a href="#l10.599"></a><span id="l10.599" class="difflineat">@@ -1251,88 +1198,18 @@ PlacesController.prototype = {</span>
<a href="#l10.600"></a><span id="l10.600">       data = data.value.QueryInterface(Ci.nsISupportsString).data;</span>
<a href="#l10.601"></a><span id="l10.601">       type = type.value;</span>
<a href="#l10.602"></a><span id="l10.602">       items = PlacesUtils.unwrapNodes(data, type);</span>
<a href="#l10.603"></a><span id="l10.603">     } catch (ex) {</span>
<a href="#l10.604"></a><span id="l10.604">       // No supported data exists or nodes unwrap failed, just bail out.</span>
<a href="#l10.605"></a><span id="l10.605">       return;</span>
<a href="#l10.606"></a><span id="l10.606">     }</span>
<a href="#l10.607"></a><span id="l10.607"> </span>
<a href="#l10.608"></a><span id="l10.608" class="difflineminus">-    let itemsToSelect = [];</span>
<a href="#l10.609"></a><span id="l10.609" class="difflineminus">-    if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l10.610"></a><span id="l10.610" class="difflineminus">-      if (ip.isTag) {</span>
<a href="#l10.611"></a><span id="l10.611" class="difflineminus">-        let urls = items.filter(item =&gt; &quot;uri&quot; in item).map(item =&gt; Services.io.newURI(item.uri));</span>
<a href="#l10.612"></a><span id="l10.612" class="difflineminus">-        await PlacesTransactions.Tag({ urls, tag: ip.tagName }).transact();</span>
<a href="#l10.613"></a><span id="l10.613" class="difflineminus">-      } else {</span>
<a href="#l10.614"></a><span id="l10.614" class="difflineminus">-        await PlacesTransactions.batch(async function() {</span>
<a href="#l10.615"></a><span id="l10.615" class="difflineminus">-          let insertionIndex = ip.index;</span>
<a href="#l10.616"></a><span id="l10.616" class="difflineminus">-          let parent = await ip.promiseGuid();</span>
<a href="#l10.617"></a><span id="l10.617" class="difflineminus">-</span>
<a href="#l10.618"></a><span id="l10.618" class="difflineminus">-          for (let item of items) {</span>
<a href="#l10.619"></a><span id="l10.619" class="difflineminus">-            let doCopy = action == &quot;copy&quot;;</span>
<a href="#l10.620"></a><span id="l10.620" class="difflineminus">-</span>
<a href="#l10.621"></a><span id="l10.621" class="difflineminus">-            // If this is not a copy, check for safety that we can move the</span>
<a href="#l10.622"></a><span id="l10.622" class="difflineminus">-            // source, otherwise report an error and fallback to a copy.</span>
<a href="#l10.623"></a><span id="l10.623" class="difflineminus">-            if (!doCopy &amp;&amp;</span>
<a href="#l10.624"></a><span id="l10.624" class="difflineminus">-                !PlacesControllerDragHelper.canMoveUnwrappedNode(item)) {</span>
<a href="#l10.625"></a><span id="l10.625" class="difflineminus">-              Cu.reportError(&quot;Tried to move an unmovable &quot; +</span>
<a href="#l10.626"></a><span id="l10.626" class="difflineminus">-                             &quot;Places node, reverting to a copy operation.&quot;);</span>
<a href="#l10.627"></a><span id="l10.627" class="difflineminus">-              doCopy = true;</span>
<a href="#l10.628"></a><span id="l10.628" class="difflineminus">-            }</span>
<a href="#l10.629"></a><span id="l10.629" class="difflineminus">-            let guid = await PlacesUIUtils.getTransactionForData(</span>
<a href="#l10.630"></a><span id="l10.630" class="difflineminus">-              item, type, parent, insertionIndex, doCopy).transact();</span>
<a href="#l10.631"></a><span id="l10.631" class="difflineminus">-            itemsToSelect.push(await PlacesUtils.promiseItemId(guid));</span>
<a href="#l10.632"></a><span id="l10.632" class="difflineminus">-</span>
<a href="#l10.633"></a><span id="l10.633" class="difflineminus">-            // Adjust index to make sure items are pasted in the correct</span>
<a href="#l10.634"></a><span id="l10.634" class="difflineminus">-            // position.  If index is DEFAULT_INDEX, items are just appended.</span>
<a href="#l10.635"></a><span id="l10.635" class="difflineminus">-            if (insertionIndex != PlacesUtils.bookmarks.DEFAULT_INDEX)</span>
<a href="#l10.636"></a><span id="l10.636" class="difflineminus">-              insertionIndex++;</span>
<a href="#l10.637"></a><span id="l10.637" class="difflineminus">-          }</span>
<a href="#l10.638"></a><span id="l10.638" class="difflineminus">-        });</span>
<a href="#l10.639"></a><span id="l10.639" class="difflineminus">-      }</span>
<a href="#l10.640"></a><span id="l10.640" class="difflineminus">-    } else {</span>
<a href="#l10.641"></a><span id="l10.641" class="difflineminus">-      let transactions = [];</span>
<a href="#l10.642"></a><span id="l10.642" class="difflineminus">-      let insertionIndex = ip.index;</span>
<a href="#l10.643"></a><span id="l10.643" class="difflineminus">-      for (let i = 0; i &lt; items.length; ++i) {</span>
<a href="#l10.644"></a><span id="l10.644" class="difflineminus">-        if (ip.isTag) {</span>
<a href="#l10.645"></a><span id="l10.645" class="difflineminus">-          // Pasting into a tag container means tagging the item, regardless of</span>
<a href="#l10.646"></a><span id="l10.646" class="difflineminus">-          // the requested action.</span>
<a href="#l10.647"></a><span id="l10.647" class="difflineminus">-          let tagTxn = new PlacesTagURITransaction(NetUtil.newURI(items[i].uri),</span>
<a href="#l10.648"></a><span id="l10.648" class="difflineminus">-                                                   [ip.itemId]);</span>
<a href="#l10.649"></a><span id="l10.649" class="difflineminus">-          transactions.push(tagTxn);</span>
<a href="#l10.650"></a><span id="l10.650" class="difflineminus">-          continue;</span>
<a href="#l10.651"></a><span id="l10.651" class="difflineminus">-        }</span>
<a href="#l10.652"></a><span id="l10.652" class="difflineminus">-</span>
<a href="#l10.653"></a><span id="l10.653" class="difflineminus">-        // Adjust index to make sure items are pasted in the correct position.</span>
<a href="#l10.654"></a><span id="l10.654" class="difflineminus">-        // If index is DEFAULT_INDEX, items are just appended.</span>
<a href="#l10.655"></a><span id="l10.655" class="difflineminus">-        if (ip.index != PlacesUtils.bookmarks.DEFAULT_INDEX)</span>
<a href="#l10.656"></a><span id="l10.656" class="difflineminus">-          insertionIndex = ip.index + i;</span>
<a href="#l10.657"></a><span id="l10.657" class="difflineminus">-</span>
<a href="#l10.658"></a><span id="l10.658" class="difflineminus">-        // If this is not a copy, check for safety that we can move the source,</span>
<a href="#l10.659"></a><span id="l10.659" class="difflineminus">-        // otherwise report an error and fallback to a copy.</span>
<a href="#l10.660"></a><span id="l10.660" class="difflineminus">-        if (action != &quot;copy&quot; &amp;&amp; !PlacesControllerDragHelper.canMoveUnwrappedNode(items[i])) {</span>
<a href="#l10.661"></a><span id="l10.661" class="difflineminus">-          Cu.reportError(&quot;Tried to move an unmovable Places &quot; +</span>
<a href="#l10.662"></a><span id="l10.662" class="difflineminus">-                                       &quot;node, reverting to a copy operation.&quot;);</span>
<a href="#l10.663"></a><span id="l10.663" class="difflineminus">-          action = &quot;copy&quot;;</span>
<a href="#l10.664"></a><span id="l10.664" class="difflineminus">-        }</span>
<a href="#l10.665"></a><span id="l10.665" class="difflineminus">-        transactions.push(</span>
<a href="#l10.666"></a><span id="l10.666" class="difflineminus">-          PlacesUIUtils.makeTransaction(items[i], type, ip.itemId,</span>
<a href="#l10.667"></a><span id="l10.667" class="difflineminus">-                                        insertionIndex, action == &quot;copy&quot;)</span>
<a href="#l10.668"></a><span id="l10.668" class="difflineminus">-        );</span>
<a href="#l10.669"></a><span id="l10.669" class="difflineminus">-      }</span>
<a href="#l10.670"></a><span id="l10.670" class="difflineminus">-</span>
<a href="#l10.671"></a><span id="l10.671" class="difflineminus">-      let aggregatedTxn = new PlacesAggregatedTransaction(&quot;Paste&quot;, transactions);</span>
<a href="#l10.672"></a><span id="l10.672" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(aggregatedTxn);</span>
<a href="#l10.673"></a><span id="l10.673" class="difflineminus">-</span>
<a href="#l10.674"></a><span id="l10.674" class="difflineminus">-      for (let i = 0; i &lt; transactions.length; ++i) {</span>
<a href="#l10.675"></a><span id="l10.675" class="difflineminus">-        itemsToSelect.push(</span>
<a href="#l10.676"></a><span id="l10.676" class="difflineminus">-          PlacesUtils.bookmarks.getIdForItemAt(ip.itemId, ip.index + i)</span>
<a href="#l10.677"></a><span id="l10.677" class="difflineminus">-        );</span>
<a href="#l10.678"></a><span id="l10.678" class="difflineminus">-      }</span>
<a href="#l10.679"></a><span id="l10.679" class="difflineminus">-    }</span>
<a href="#l10.680"></a><span id="l10.680" class="difflineplus">+    let doCopy = action == &quot;copy&quot;;</span>
<a href="#l10.681"></a><span id="l10.681" class="difflineplus">+    let itemsToSelect = await handleTransferItems(items, ip, doCopy, this._view);</span>
<a href="#l10.682"></a><span id="l10.682"> </span>
<a href="#l10.683"></a><span id="l10.683">     // Cut/past operations are not repeatable, so clear the clipboard.</span>
<a href="#l10.684"></a><span id="l10.684">     if (action == &quot;cut&quot;) {</span>
<a href="#l10.685"></a><span id="l10.685">       this._clearClipboard();</span>
<a href="#l10.686"></a><span id="l10.686">     }</span>
<a href="#l10.687"></a><span id="l10.687"> </span>
<a href="#l10.688"></a><span id="l10.688">     if (itemsToSelect.length &gt; 0)</span>
<a href="#l10.689"></a><span id="l10.689">       this._view.selectItems(itemsToSelect, false);</span>
<a href="#l10.690"></a><span id="l10.690" class="difflineat">@@ -1490,166 +1367,143 @@ var PlacesControllerDragHelper = {</span>
<a href="#l10.691"></a><span id="l10.691">       }</span>
<a href="#l10.692"></a><span id="l10.692">     }</span>
<a href="#l10.693"></a><span id="l10.693">     return true;</span>
<a href="#l10.694"></a><span id="l10.694">   },</span>
<a href="#l10.695"></a><span id="l10.695"> </span>
<a href="#l10.696"></a><span id="l10.696">   /**</span>
<a href="#l10.697"></a><span id="l10.697">    * Determines if an unwrapped node can be moved.</span>
<a href="#l10.698"></a><span id="l10.698">    *</span>
<a href="#l10.699"></a><span id="l10.699" class="difflineminus">-   * @param   aUnwrappedNode</span>
<a href="#l10.700"></a><span id="l10.700" class="difflineminus">-   *          A node unwrapped by PlacesUtils.unwrapNodes().</span>
<a href="#l10.701"></a><span id="l10.701" class="difflineplus">+   * @param unwrappedNode</span>
<a href="#l10.702"></a><span id="l10.702" class="difflineplus">+   *        A node unwrapped by PlacesUtils.unwrapNodes().</span>
<a href="#l10.703"></a><span id="l10.703">    * @return True if the node can be moved, false otherwise.</span>
<a href="#l10.704"></a><span id="l10.704">    */</span>
<a href="#l10.705"></a><span id="l10.705" class="difflineminus">-  canMoveUnwrappedNode(aUnwrappedNode) {</span>
<a href="#l10.706"></a><span id="l10.706" class="difflineminus">-    return aUnwrappedNode.id &gt; 0 &amp;&amp;</span>
<a href="#l10.707"></a><span id="l10.707" class="difflineminus">-           !PlacesUtils.isRootItem(aUnwrappedNode.id) &amp;&amp;</span>
<a href="#l10.708"></a><span id="l10.708" class="difflineminus">-           (!aUnwrappedNode.parent || !PlacesUIUtils.isContentsReadOnly(aUnwrappedNode.parent)) &amp;&amp;</span>
<a href="#l10.709"></a><span id="l10.709" class="difflineminus">-           aUnwrappedNode.parent != PlacesUtils.tagsFolderId &amp;&amp;</span>
<a href="#l10.710"></a><span id="l10.710" class="difflineminus">-           aUnwrappedNode.grandParentId != PlacesUtils.tagsFolderId;</span>
<a href="#l10.711"></a><span id="l10.711" class="difflineplus">+  canMoveUnwrappedNode(unwrappedNode) {</span>
<a href="#l10.712"></a><span id="l10.712" class="difflineplus">+    if (unwrappedNode.id &lt;= 0 || PlacesUtils.isRootItem(unwrappedNode.id)) {</span>
<a href="#l10.713"></a><span id="l10.713" class="difflineplus">+      return false;</span>
<a href="#l10.714"></a><span id="l10.714" class="difflineplus">+    }</span>
<a href="#l10.715"></a><span id="l10.715" class="difflineplus">+    let parentId = unwrappedNode.parent;</span>
<a href="#l10.716"></a><span id="l10.716" class="difflineplus">+    if (parentId &lt;= 0 ||</span>
<a href="#l10.717"></a><span id="l10.717" class="difflineplus">+        parentId == PlacesUtils.placesRootId ||</span>
<a href="#l10.718"></a><span id="l10.718" class="difflineplus">+        parentId == PlacesUtils.tagsFolderId ||</span>
<a href="#l10.719"></a><span id="l10.719" class="difflineplus">+        unwrappedNode.grandParentId == PlacesUtils.tagsFolderId) {</span>
<a href="#l10.720"></a><span id="l10.720" class="difflineplus">+      return false;</span>
<a href="#l10.721"></a><span id="l10.721" class="difflineplus">+    }</span>
<a href="#l10.722"></a><span id="l10.722" class="difflineplus">+    // leftPaneFolderId and allBookmarksFolderId are lazy getters running</span>
<a href="#l10.723"></a><span id="l10.723" class="difflineplus">+    // at least a synchronous DB query. Therefore we don't want to invoke</span>
<a href="#l10.724"></a><span id="l10.724" class="difflineplus">+    // them first, especially because isCommandEnabled may be called way</span>
<a href="#l10.725"></a><span id="l10.725" class="difflineplus">+    // before the left pane folder is even necessary.</span>
<a href="#l10.726"></a><span id="l10.726" class="difflineplus">+    if (typeof Object.getOwnPropertyDescriptor(PlacesUIUtils, &quot;leftPaneFolderId&quot;).get != &quot;function&quot; &amp;&amp;</span>
<a href="#l10.727"></a><span id="l10.727" class="difflineplus">+        (parentId == PlacesUIUtils.leftPaneFolderId ||</span>
<a href="#l10.728"></a><span id="l10.728" class="difflineplus">+          parentId == PlacesUIUtils.allBookmarksFolderId)) {</span>
<a href="#l10.729"></a><span id="l10.729" class="difflineplus">+      return false;</span>
<a href="#l10.730"></a><span id="l10.730" class="difflineplus">+    }</span>
<a href="#l10.731"></a><span id="l10.731" class="difflineplus">+    return true;</span>
<a href="#l10.732"></a><span id="l10.732">   },</span>
<a href="#l10.733"></a><span id="l10.733"> </span>
<a href="#l10.734"></a><span id="l10.734">   /**</span>
<a href="#l10.735"></a><span id="l10.735">    * Determines if a node can be moved.</span>
<a href="#l10.736"></a><span id="l10.736">    *</span>
<a href="#l10.737"></a><span id="l10.737">    * @param   aNode</span>
<a href="#l10.738"></a><span id="l10.738">    *          A nsINavHistoryResultNode node.</span>
<a href="#l10.739"></a><span id="l10.739" class="difflineplus">+   * @param   aView</span>
<a href="#l10.740"></a><span id="l10.740" class="difflineplus">+   *          The view originating the request</span>
<a href="#l10.741"></a><span id="l10.741">    * @param   [optional] aDOMNode</span>
<a href="#l10.742"></a><span id="l10.742">    *          A XUL DOM node.</span>
<a href="#l10.743"></a><span id="l10.743">    * @return True if the node can be moved, false otherwise.</span>
<a href="#l10.744"></a><span id="l10.744">    */</span>
<a href="#l10.745"></a><span id="l10.745" class="difflineminus">-  canMoveNode(aNode, aDOMNode) {</span>
<a href="#l10.746"></a><span id="l10.746" class="difflineplus">+  canMoveNode(aNode, aView, aDOMNode) {</span>
<a href="#l10.747"></a><span id="l10.747">     // Only bookmark items are movable.</span>
<a href="#l10.748"></a><span id="l10.748">     if (aNode.itemId == -1)</span>
<a href="#l10.749"></a><span id="l10.749">       return false;</span>
<a href="#l10.750"></a><span id="l10.750"> </span>
<a href="#l10.751"></a><span id="l10.751">     let parentNode = aNode.parent;</span>
<a href="#l10.752"></a><span id="l10.752">     if (!parentNode) {</span>
<a href="#l10.753"></a><span id="l10.753">       // Normally parentless places nodes can not be moved,</span>
<a href="#l10.754"></a><span id="l10.754">       // but simulated bookmarked URI nodes are special.</span>
<a href="#l10.755"></a><span id="l10.755">       return !!aDOMNode &amp;&amp;</span>
<a href="#l10.756"></a><span id="l10.756">              aDOMNode.hasAttribute(&quot;simulated-places-node&quot;) &amp;&amp;</span>
<a href="#l10.757"></a><span id="l10.757">              PlacesUtils.nodeIsBookmark(aNode);</span>
<a href="#l10.758"></a><span id="l10.758">     }</span>
<a href="#l10.759"></a><span id="l10.759"> </span>
<a href="#l10.760"></a><span id="l10.760">     // Once tags and bookmarked are divorced, the tag-query check should be</span>
<a href="#l10.761"></a><span id="l10.761">     // removed.</span>
<a href="#l10.762"></a><span id="l10.762" class="difflineminus">-    return !(PlacesUtils.nodeIsFolder(parentNode) &amp;&amp;</span>
<a href="#l10.763"></a><span id="l10.763" class="difflineminus">-             PlacesUIUtils.isContentsReadOnly(parentNode)) &amp;&amp;</span>
<a href="#l10.764"></a><span id="l10.764" class="difflineplus">+    return PlacesUtils.nodeIsFolder(parentNode) &amp;&amp;</span>
<a href="#l10.765"></a><span id="l10.765" class="difflineplus">+           !PlacesUIUtils.isFolderReadOnly(parentNode, aView) &amp;&amp;</span>
<a href="#l10.766"></a><span id="l10.766">            !PlacesUtils.nodeIsTagQuery(parentNode);</span>
<a href="#l10.767"></a><span id="l10.767">   },</span>
<a href="#l10.768"></a><span id="l10.768"> </span>
<a href="#l10.769"></a><span id="l10.769">   /**</span>
<a href="#l10.770"></a><span id="l10.770">    * Handles the drop of one or more items onto a view.</span>
<a href="#l10.771"></a><span id="l10.771" class="difflineminus">-   * @param   insertionPoint</span>
<a href="#l10.772"></a><span id="l10.772" class="difflineminus">-   *          The insertion point where the items should be dropped</span>
<a href="#l10.773"></a><span id="l10.773" class="difflineplus">+   *</span>
<a href="#l10.774"></a><span id="l10.774" class="difflineplus">+   * @param {Object} insertionPoint The insertion point where the items should</span>
<a href="#l10.775"></a><span id="l10.775" class="difflineplus">+   *                                be dropped.</span>
<a href="#l10.776"></a><span id="l10.776" class="difflineplus">+   * @param {Object} dt             The dataTransfer information for the drop.</span>
<a href="#l10.777"></a><span id="l10.777" class="difflineplus">+   * @param {Object} view           The view or the tree element. This allows</span>
<a href="#l10.778"></a><span id="l10.778" class="difflineplus">+   *                                batching to take place.</span>
<a href="#l10.779"></a><span id="l10.779">    */</span>
<a href="#l10.780"></a><span id="l10.780" class="difflineminus">-  async onDrop(insertionPoint, dt) {</span>
<a href="#l10.781"></a><span id="l10.781" class="difflineplus">+  async onDrop(insertionPoint, dt, view) {</span>
<a href="#l10.782"></a><span id="l10.782">     let doCopy = [&quot;copy&quot;, &quot;link&quot;].includes(dt.dropEffect);</span>
<a href="#l10.783"></a><span id="l10.783"> </span>
<a href="#l10.784"></a><span id="l10.784" class="difflineminus">-    let transactions = [];</span>
<a href="#l10.785"></a><span id="l10.785">     let dropCount = dt.mozItemCount;</span>
<a href="#l10.786"></a><span id="l10.786" class="difflineminus">-    let movedCount = 0;</span>
<a href="#l10.787"></a><span id="l10.787" class="difflineminus">-    let parentGuid = PlacesUIUtils.useAsyncTransactions ?</span>
<a href="#l10.788"></a><span id="l10.788" class="difflineminus">-                       (await insertionPoint.promiseGuid()) : null;</span>
<a href="#l10.789"></a><span id="l10.789" class="difflineminus">-    let tagName = insertionPoint.tagName;</span>
<a href="#l10.790"></a><span id="l10.790"> </span>
<a href="#l10.791"></a><span id="l10.791">     // Following flavors may contain duplicated data.</span>
<a href="#l10.792"></a><span id="l10.792">     let duplicable = new Map();</span>
<a href="#l10.793"></a><span id="l10.793">     duplicable.set(PlacesUtils.TYPE_UNICODE, new Set());</span>
<a href="#l10.794"></a><span id="l10.794">     duplicable.set(PlacesUtils.TYPE_X_MOZ_URL, new Set());</span>
<a href="#l10.795"></a><span id="l10.795"> </span>
<a href="#l10.796"></a><span id="l10.796" class="difflineplus">+    // Collect all data from the DataTransfer before processing it, as the</span>
<a href="#l10.797"></a><span id="l10.797" class="difflineplus">+    // DataTransfer is only valid during the synchronous handling of the `drop`</span>
<a href="#l10.798"></a><span id="l10.798" class="difflineplus">+    // event handler callback.</span>
<a href="#l10.799"></a><span id="l10.799" class="difflineplus">+    let nodes = [];</span>
<a href="#l10.800"></a><span id="l10.800">     for (let i = 0; i &lt; dropCount; ++i) {</span>
<a href="#l10.801"></a><span id="l10.801">       let flavor = this.getFirstValidFlavor(dt.mozTypesAt(i));</span>
<a href="#l10.802"></a><span id="l10.802">       if (!flavor)</span>
<a href="#l10.803"></a><span id="l10.803">         return;</span>
<a href="#l10.804"></a><span id="l10.804"> </span>
<a href="#l10.805"></a><span id="l10.805">       let data = dt.mozGetDataAt(flavor, i);</span>
<a href="#l10.806"></a><span id="l10.806">       if (duplicable.has(flavor)) {</span>
<a href="#l10.807"></a><span id="l10.807">         let handled = duplicable.get(flavor);</span>
<a href="#l10.808"></a><span id="l10.808">         if (handled.has(data))</span>
<a href="#l10.809"></a><span id="l10.809">           continue;</span>
<a href="#l10.810"></a><span id="l10.810">         handled.add(data);</span>
<a href="#l10.811"></a><span id="l10.811">       }</span>
<a href="#l10.812"></a><span id="l10.812"> </span>
<a href="#l10.813"></a><span id="l10.813" class="difflineminus">-      let nodes;</span>
<a href="#l10.814"></a><span id="l10.814">       if (flavor != TAB_DROP_TYPE) {</span>
<a href="#l10.815"></a><span id="l10.815" class="difflineminus">-        nodes = PlacesUtils.unwrapNodes(data, flavor);</span>
<a href="#l10.816"></a><span id="l10.816" class="difflineplus">+        nodes = [...nodes, ...PlacesUtils.unwrapNodes(data, flavor)];</span>
<a href="#l10.817"></a><span id="l10.817">       } else if (data instanceof XULElement &amp;&amp; data.localName == &quot;tab&quot; &amp;&amp;</span>
<a href="#l10.818"></a><span id="l10.818" class="difflineminus">-               data.ownerGlobal instanceof ChromeWindow) {</span>
<a href="#l10.819"></a><span id="l10.819" class="difflineplus">+               data.ownerGlobal.isChromeWindow) {</span>
<a href="#l10.820"></a><span id="l10.820">         let uri = data.linkedBrowser.currentURI;</span>
<a href="#l10.821"></a><span id="l10.821">         let spec = uri ? uri.spec : &quot;about:blank&quot;;</span>
<a href="#l10.822"></a><span id="l10.822" class="difflineminus">-        nodes = [{ uri: spec,</span>
<a href="#l10.823"></a><span id="l10.823" class="difflineminus">-                   title: data.label,</span>
<a href="#l10.824"></a><span id="l10.824" class="difflineminus">-                   type: PlacesUtils.TYPE_X_MOZ_URL}];</span>
<a href="#l10.825"></a><span id="l10.825" class="difflineminus">-      } else</span>
<a href="#l10.826"></a><span id="l10.826" class="difflineplus">+        nodes.push({</span>
<a href="#l10.827"></a><span id="l10.827" class="difflineplus">+          uri: spec,</span>
<a href="#l10.828"></a><span id="l10.828" class="difflineplus">+          title: data.label,</span>
<a href="#l10.829"></a><span id="l10.829" class="difflineplus">+          type: PlacesUtils.TYPE_X_MOZ_URL</span>
<a href="#l10.830"></a><span id="l10.830" class="difflineplus">+        });</span>
<a href="#l10.831"></a><span id="l10.831" class="difflineplus">+      } else {</span>
<a href="#l10.832"></a><span id="l10.832">         throw new Error(&quot;bogus data was passed as a tab&quot;);</span>
<a href="#l10.833"></a><span id="l10.833" class="difflineminus">-</span>
<a href="#l10.834"></a><span id="l10.834" class="difflineminus">-      for (let unwrapped of nodes) {</span>
<a href="#l10.835"></a><span id="l10.835" class="difflineminus">-        let index = insertionPoint.index;</span>
<a href="#l10.836"></a><span id="l10.836" class="difflineminus">-</span>
<a href="#l10.837"></a><span id="l10.837" class="difflineminus">-        // Adjust insertion index to prevent reversal of dragged items. When you</span>
<a href="#l10.838"></a><span id="l10.838" class="difflineminus">-        // drag multiple elts upward: need to increment index or each successive</span>
<a href="#l10.839"></a><span id="l10.839" class="difflineminus">-        // elt will be inserted at the same index, each above the previous.</span>
<a href="#l10.840"></a><span id="l10.840" class="difflineminus">-        let dragginUp = insertionPoint.itemId == unwrapped.parent &amp;&amp;</span>
<a href="#l10.841"></a><span id="l10.841" class="difflineminus">-                        index &lt; PlacesUtils.bookmarks.getItemIndex(unwrapped.id);</span>
<a href="#l10.842"></a><span id="l10.842" class="difflineminus">-        if (index != -1 &amp;&amp; dragginUp)</span>
<a href="#l10.843"></a><span id="l10.843" class="difflineminus">-          index += movedCount++;</span>
<a href="#l10.844"></a><span id="l10.844" class="difflineminus">-</span>
<a href="#l10.845"></a><span id="l10.845" class="difflineminus">-        // If dragging over a tag container we should tag the item.</span>
<a href="#l10.846"></a><span id="l10.846" class="difflineminus">-        if (insertionPoint.isTag) {</span>
<a href="#l10.847"></a><span id="l10.847" class="difflineminus">-          let uri = NetUtil.newURI(unwrapped.uri);</span>
<a href="#l10.848"></a><span id="l10.848" class="difflineminus">-          let tagItemId = insertionPoint.itemId;</span>
<a href="#l10.849"></a><span id="l10.849" class="difflineminus">-          if (PlacesUIUtils.useAsyncTransactions)</span>
<a href="#l10.850"></a><span id="l10.850" class="difflineminus">-            transactions.push(PlacesTransactions.Tag({ uri, tag: tagName }));</span>
<a href="#l10.851"></a><span id="l10.851" class="difflineminus">-          else</span>
<a href="#l10.852"></a><span id="l10.852" class="difflineminus">-            transactions.push(new PlacesTagURITransaction(uri, [tagItemId]));</span>
<a href="#l10.853"></a><span id="l10.853" class="difflineminus">-        } else {</span>
<a href="#l10.854"></a><span id="l10.854" class="difflineminus">-          // If this is not a copy, check for safety that we can move the</span>
<a href="#l10.855"></a><span id="l10.855" class="difflineminus">-          // source, otherwise report an error and fallback to a copy.</span>
<a href="#l10.856"></a><span id="l10.856" class="difflineminus">-          if (!doCopy &amp;&amp; !PlacesControllerDragHelper.canMoveUnwrappedNode(unwrapped)) {</span>
<a href="#l10.857"></a><span id="l10.857" class="difflineminus">-            Cu.reportError(&quot;Tried to move an unmovable Places &quot; +</span>
<a href="#l10.858"></a><span id="l10.858" class="difflineminus">-                                         &quot;node, reverting to a copy operation.&quot;);</span>
<a href="#l10.859"></a><span id="l10.859" class="difflineminus">-            doCopy = true;</span>
<a href="#l10.860"></a><span id="l10.860" class="difflineminus">-          }</span>
<a href="#l10.861"></a><span id="l10.861" class="difflineminus">-          if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l10.862"></a><span id="l10.862" class="difflineminus">-            transactions.push(</span>
<a href="#l10.863"></a><span id="l10.863" class="difflineminus">-              PlacesUIUtils.getTransactionForData(unwrapped,</span>
<a href="#l10.864"></a><span id="l10.864" class="difflineminus">-                                                  flavor,</span>
<a href="#l10.865"></a><span id="l10.865" class="difflineminus">-                                                  parentGuid,</span>
<a href="#l10.866"></a><span id="l10.866" class="difflineminus">-                                                  index,</span>
<a href="#l10.867"></a><span id="l10.867" class="difflineminus">-                                                  doCopy));</span>
<a href="#l10.868"></a><span id="l10.868" class="difflineminus">-          } else {</span>
<a href="#l10.869"></a><span id="l10.869" class="difflineminus">-            transactions.push(PlacesUIUtils.makeTransaction(unwrapped,</span>
<a href="#l10.870"></a><span id="l10.870" class="difflineminus">-                                flavor, insertionPoint.itemId,</span>
<a href="#l10.871"></a><span id="l10.871" class="difflineminus">-                                index, doCopy));</span>
<a href="#l10.872"></a><span id="l10.872" class="difflineminus">-          }</span>
<a href="#l10.873"></a><span id="l10.873" class="difflineminus">-        }</span>
<a href="#l10.874"></a><span id="l10.874">       }</span>
<a href="#l10.875"></a><span id="l10.875">     }</span>
<a href="#l10.876"></a><span id="l10.876"> </span>
<a href="#l10.877"></a><span id="l10.877" class="difflineminus">-    if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l10.878"></a><span id="l10.878" class="difflineminus">-      await PlacesTransactions.batch(transactions);</span>
<a href="#l10.879"></a><span id="l10.879" class="difflineminus">-    } else {</span>
<a href="#l10.880"></a><span id="l10.880" class="difflineminus">-      let txn = new PlacesAggregatedTransaction(&quot;DropItems&quot;, transactions);</span>
<a href="#l10.881"></a><span id="l10.881" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l10.882"></a><span id="l10.882" class="difflineminus">-    }</span>
<a href="#l10.883"></a><span id="l10.883" class="difflineplus">+    await handleTransferItems(nodes, insertionPoint, doCopy, view);</span>
<a href="#l10.884"></a><span id="l10.884">   },</span>
<a href="#l10.885"></a><span id="l10.885"> </span>
<a href="#l10.886"></a><span id="l10.886">   /**</span>
<a href="#l10.887"></a><span id="l10.887">    * Checks if we can insert into a container.</span>
<a href="#l10.888"></a><span id="l10.888">    * @param   aContainer</span>
<a href="#l10.889"></a><span id="l10.889">    *          The container were we are want to drop</span>
<a href="#l10.890"></a><span id="l10.890" class="difflineplus">+   * @param   aView</span>
<a href="#l10.891"></a><span id="l10.891" class="difflineplus">+   *          The view generating the request</span>
<a href="#l10.892"></a><span id="l10.892">    */</span>
<a href="#l10.893"></a><span id="l10.893" class="difflineminus">-  disallowInsertion(aContainer) {</span>
<a href="#l10.894"></a><span id="l10.894" class="difflineplus">+  disallowInsertion(aContainer, aView) {</span>
<a href="#l10.895"></a><span id="l10.895">     NS_ASSERT(aContainer, &quot;empty container&quot;);</span>
<a href="#l10.896"></a><span id="l10.896">     // Allow dropping into Tag containers and editable folders.</span>
<a href="#l10.897"></a><span id="l10.897">     return !PlacesUtils.nodeIsTagQuery(aContainer) &amp;&amp;</span>
<a href="#l10.898"></a><span id="l10.898">            (!PlacesUtils.nodeIsFolder(aContainer) ||</span>
<a href="#l10.899"></a><span id="l10.899" class="difflineminus">-            PlacesUIUtils.isContentsReadOnly(aContainer));</span>
<a href="#l10.900"></a><span id="l10.900" class="difflineplus">+            PlacesUIUtils.isFolderReadOnly(aContainer, aView));</span>
<a href="#l10.901"></a><span id="l10.901">   }</span>
<a href="#l10.902"></a><span id="l10.902"> };</span>
<a href="#l10.903"></a><span id="l10.903"> </span>
<a href="#l10.904"></a><span id="l10.904"> </span>
<a href="#l10.905"></a><span id="l10.905"> XPCOMUtils.defineLazyServiceGetter(PlacesControllerDragHelper, &quot;dragService&quot;,</span>
<a href="#l10.906"></a><span id="l10.906">                                    &quot;@mozilla.org/widget/dragservice;1&quot;,</span>
<a href="#l10.907"></a><span id="l10.907">                                    &quot;nsIDragService&quot;);</span>
<a href="#l10.908"></a><span id="l10.908"> </span>
<a href="#l10.909"></a><span id="l10.909" class="difflineat">@@ -1703,8 +1557,147 @@ function doGetPlacesControllerForCommand</span>
<a href="#l10.910"></a><span id="l10.910">   return null;</span>
<a href="#l10.911"></a><span id="l10.911"> }</span>
<a href="#l10.912"></a><span id="l10.912"> </span>
<a href="#l10.913"></a><span id="l10.913"> function goDoPlacesCommand(aCommand) {</span>
<a href="#l10.914"></a><span id="l10.914">   let controller = doGetPlacesControllerForCommand(aCommand);</span>
<a href="#l10.915"></a><span id="l10.915">   if (controller &amp;&amp; controller.isCommandEnabled(aCommand))</span>
<a href="#l10.916"></a><span id="l10.916">     controller.doCommand(aCommand);</span>
<a href="#l10.917"></a><span id="l10.917"> }</span>
<a href="#l10.918"></a><span id="l10.918" class="difflineplus">+</span>
<a href="#l10.919"></a><span id="l10.919" class="difflineplus">+/**</span>
<a href="#l10.920"></a><span id="l10.920" class="difflineplus">+ * This gets the most appropriate item for using for batching. In the case of multiple</span>
<a href="#l10.921"></a><span id="l10.921" class="difflineplus">+ * views being related, the method returns the most expensive result to batch.</span>
<a href="#l10.922"></a><span id="l10.922" class="difflineplus">+ * For example, if it detects the left-hand library pane, then it will look for</span>
<a href="#l10.923"></a><span id="l10.923" class="difflineplus">+ * and return the reference to the right-hand pane.</span>
<a href="#l10.924"></a><span id="l10.924" class="difflineplus">+ *</span>
<a href="#l10.925"></a><span id="l10.925" class="difflineplus">+ * @param {Object} viewOrElement The item to check.</span>
<a href="#l10.926"></a><span id="l10.926" class="difflineplus">+ * @return {Object} Will return the best result node to batch, or null</span>
<a href="#l10.927"></a><span id="l10.927" class="difflineplus">+ *                  if one could not be found.</span>
<a href="#l10.928"></a><span id="l10.928" class="difflineplus">+ */</span>
<a href="#l10.929"></a><span id="l10.929" class="difflineplus">+function getResultForBatching(viewOrElement) {</span>
<a href="#l10.930"></a><span id="l10.930" class="difflineplus">+  if (viewOrElement &amp;&amp; viewOrElement instanceof Ci.nsIDOMElement &amp;&amp;</span>
<a href="#l10.931"></a><span id="l10.931" class="difflineplus">+      viewOrElement.id === &quot;placesList&quot;) {</span>
<a href="#l10.932"></a><span id="l10.932" class="difflineplus">+    // Note: fall back to the existing item if we can't find the right-hane pane.</span>
<a href="#l10.933"></a><span id="l10.933" class="difflineplus">+    viewOrElement = document.getElementById(&quot;placeContent&quot;) || viewOrElement;</span>
<a href="#l10.934"></a><span id="l10.934" class="difflineplus">+  }</span>
<a href="#l10.935"></a><span id="l10.935" class="difflineplus">+</span>
<a href="#l10.936"></a><span id="l10.936" class="difflineplus">+  if (viewOrElement &amp;&amp; viewOrElement.result) {</span>
<a href="#l10.937"></a><span id="l10.937" class="difflineplus">+    return viewOrElement.result;</span>
<a href="#l10.938"></a><span id="l10.938" class="difflineplus">+  }</span>
<a href="#l10.939"></a><span id="l10.939" class="difflineplus">+</span>
<a href="#l10.940"></a><span id="l10.940" class="difflineplus">+  return null;</span>
<a href="#l10.941"></a><span id="l10.941" class="difflineplus">+}</span>
<a href="#l10.942"></a><span id="l10.942" class="difflineplus">+</span>
<a href="#l10.943"></a><span id="l10.943" class="difflineplus">+/**</span>
<a href="#l10.944"></a><span id="l10.944" class="difflineplus">+ * Processes a set of transfer items that have been dropped or pasted.</span>
<a href="#l10.945"></a><span id="l10.945" class="difflineplus">+ * Batching will be applied where necessary.</span>
<a href="#l10.946"></a><span id="l10.946" class="difflineplus">+ *</span>
<a href="#l10.947"></a><span id="l10.947" class="difflineplus">+ * @param {Array} items A list of unwrapped nodes to process.</span>
<a href="#l10.948"></a><span id="l10.948" class="difflineplus">+ * @param {Object} insertionPoint The requested point for insertion.</span>
<a href="#l10.949"></a><span id="l10.949" class="difflineplus">+ * @param {Boolean} doCopy Set to true to copy the items, false will move them</span>
<a href="#l10.950"></a><span id="l10.950" class="difflineplus">+ *                         if possible.</span>
<a href="#l10.951"></a><span id="l10.951" class="difflineplus">+ * @return {Array} Returns an empty array when the insertion point is a tag, else</span>
<a href="#l10.952"></a><span id="l10.952" class="difflineplus">+ *                 returns an array of copied or moved guids.</span>
<a href="#l10.953"></a><span id="l10.953" class="difflineplus">+ */</span>
<a href="#l10.954"></a><span id="l10.954" class="difflineplus">+async function handleTransferItems(items, insertionPoint, doCopy, view) {</span>
<a href="#l10.955"></a><span id="l10.955" class="difflineplus">+  let transactions;</span>
<a href="#l10.956"></a><span id="l10.956" class="difflineplus">+  let itemsCount;</span>
<a href="#l10.957"></a><span id="l10.957" class="difflineplus">+  if (insertionPoint.isTag) {</span>
<a href="#l10.958"></a><span id="l10.958" class="difflineplus">+    let urls = items.filter(item =&gt; &quot;uri&quot; in item).map(item =&gt; item.uri);</span>
<a href="#l10.959"></a><span id="l10.959" class="difflineplus">+    itemsCount = urls.length;</span>
<a href="#l10.960"></a><span id="l10.960" class="difflineplus">+    transactions = [PlacesTransactions.Tag({ urls, tag: insertionPoint.tagName })];</span>
<a href="#l10.961"></a><span id="l10.961" class="difflineplus">+  } else {</span>
<a href="#l10.962"></a><span id="l10.962" class="difflineplus">+    let insertionIndex = await insertionPoint.getIndex();</span>
<a href="#l10.963"></a><span id="l10.963" class="difflineplus">+    itemsCount = items.length;</span>
<a href="#l10.964"></a><span id="l10.964" class="difflineplus">+    transactions = await getTransactionsForTransferItems(</span>
<a href="#l10.965"></a><span id="l10.965" class="difflineplus">+      items, insertionIndex, insertionPoint.guid, doCopy);</span>
<a href="#l10.966"></a><span id="l10.966" class="difflineplus">+  }</span>
<a href="#l10.967"></a><span id="l10.967" class="difflineplus">+</span>
<a href="#l10.968"></a><span id="l10.968" class="difflineplus">+  // Check if we actually have something to add, if we don't it probably wasn't</span>
<a href="#l10.969"></a><span id="l10.969" class="difflineplus">+  // valid, or it was moving to the same location, so just ignore it.</span>
<a href="#l10.970"></a><span id="l10.970" class="difflineplus">+  if (!transactions.length) {</span>
<a href="#l10.971"></a><span id="l10.971" class="difflineplus">+    return [];</span>
<a href="#l10.972"></a><span id="l10.972" class="difflineplus">+  }</span>
<a href="#l10.973"></a><span id="l10.973" class="difflineplus">+</span>
<a href="#l10.974"></a><span id="l10.974" class="difflineplus">+  let guidsToSelect = [];</span>
<a href="#l10.975"></a><span id="l10.975" class="difflineplus">+  let resultForBatching = getResultForBatching(view);</span>
<a href="#l10.976"></a><span id="l10.976" class="difflineplus">+</span>
<a href="#l10.977"></a><span id="l10.977" class="difflineplus">+  // If we're inserting into a tag, we don't get the guid, so we'll just</span>
<a href="#l10.978"></a><span id="l10.978" class="difflineplus">+  // pass the transactions direct to the batch function.</span>
<a href="#l10.979"></a><span id="l10.979" class="difflineplus">+  let batchingItem = transactions;</span>
<a href="#l10.980"></a><span id="l10.980" class="difflineplus">+  if (!insertionPoint.isTag) {</span>
<a href="#l10.981"></a><span id="l10.981" class="difflineplus">+    // If we're not a tag, then we need to get the ids of the items to select.</span>
<a href="#l10.982"></a><span id="l10.982" class="difflineplus">+    batchingItem = async () =&gt; {</span>
<a href="#l10.983"></a><span id="l10.983" class="difflineplus">+      for (let transaction of transactions) {</span>
<a href="#l10.984"></a><span id="l10.984" class="difflineplus">+        let guid = await transaction.transact();</span>
<a href="#l10.985"></a><span id="l10.985" class="difflineplus">+        if (guid) {</span>
<a href="#l10.986"></a><span id="l10.986" class="difflineplus">+          guidsToSelect.push(guid);</span>
<a href="#l10.987"></a><span id="l10.987" class="difflineplus">+        }</span>
<a href="#l10.988"></a><span id="l10.988" class="difflineplus">+      }</span>
<a href="#l10.989"></a><span id="l10.989" class="difflineplus">+    };</span>
<a href="#l10.990"></a><span id="l10.990" class="difflineplus">+  }</span>
<a href="#l10.991"></a><span id="l10.991" class="difflineplus">+</span>
<a href="#l10.992"></a><span id="l10.992" class="difflineplus">+  await PlacesUIUtils.batchUpdatesForNode(resultForBatching, itemsCount, async () =&gt; {</span>
<a href="#l10.993"></a><span id="l10.993" class="difflineplus">+    await PlacesTransactions.batch(batchingItem);</span>
<a href="#l10.994"></a><span id="l10.994" class="difflineplus">+  });</span>
<a href="#l10.995"></a><span id="l10.995" class="difflineplus">+</span>
<a href="#l10.996"></a><span id="l10.996" class="difflineplus">+  return guidsToSelect;</span>
<a href="#l10.997"></a><span id="l10.997" class="difflineplus">+}</span>
<a href="#l10.998"></a><span id="l10.998" class="difflineplus">+</span>
<a href="#l10.999"></a><span id="l10.999" class="difflineplus">+/**</span>
<a href="#l10.1000"></a><span id="l10.1000" class="difflineplus">+ * Processes a set of transfer items and returns transactions to insert or</span>
<a href="#l10.1001"></a><span id="l10.1001" class="difflineplus">+ * move them.</span>
<a href="#l10.1002"></a><span id="l10.1002" class="difflineplus">+ *</span>
<a href="#l10.1003"></a><span id="l10.1003" class="difflineplus">+ * @param {Array} items A list of unwrapped nodes to get transactions for.</span>
<a href="#l10.1004"></a><span id="l10.1004" class="difflineplus">+ * @param {Integer} insertionIndex The requested index for insertion.</span>
<a href="#l10.1005"></a><span id="l10.1005" class="difflineplus">+ * @param {String} insertionParentGuid The guid of the parent folder to insert</span>
<a href="#l10.1006"></a><span id="l10.1006" class="difflineplus">+ *                                     or move the items to.</span>
<a href="#l10.1007"></a><span id="l10.1007" class="difflineplus">+ * @param {Boolean} doCopy Set to true to copy the items, false will move them</span>
<a href="#l10.1008"></a><span id="l10.1008" class="difflineplus">+ *                         if possible.</span>
<a href="#l10.1009"></a><span id="l10.1009" class="difflineplus">+ * @return {Array} Returns an array of created PlacesTransactions.</span>
<a href="#l10.1010"></a><span id="l10.1010" class="difflineplus">+ */</span>
<a href="#l10.1011"></a><span id="l10.1011" class="difflineplus">+async function getTransactionsForTransferItems(items, insertionIndex,</span>
<a href="#l10.1012"></a><span id="l10.1012" class="difflineplus">+                                               insertionParentGuid, doCopy) {</span>
<a href="#l10.1013"></a><span id="l10.1013" class="difflineplus">+  let transactions = [];</span>
<a href="#l10.1014"></a><span id="l10.1014" class="difflineplus">+  let index = insertionIndex;</span>
<a href="#l10.1015"></a><span id="l10.1015" class="difflineplus">+</span>
<a href="#l10.1016"></a><span id="l10.1016" class="difflineplus">+  for (let item of items) {</span>
<a href="#l10.1017"></a><span id="l10.1017" class="difflineplus">+    if (index != -1 &amp;&amp; item.itemGuid) {</span>
<a href="#l10.1018"></a><span id="l10.1018" class="difflineplus">+      // Note: we use the parent from the existing bookmark as the sidebar</span>
<a href="#l10.1019"></a><span id="l10.1019" class="difflineplus">+      // gives us an unwrapped.parent that is actually a query and not the real</span>
<a href="#l10.1020"></a><span id="l10.1020" class="difflineplus">+      // parent.</span>
<a href="#l10.1021"></a><span id="l10.1021" class="difflineplus">+      let existingBookmark = await PlacesUtils.bookmarks.fetch(item.itemGuid);</span>
<a href="#l10.1022"></a><span id="l10.1022" class="difflineplus">+</span>
<a href="#l10.1023"></a><span id="l10.1023" class="difflineplus">+      // If we're dropping on the same folder, then we may need to adjust</span>
<a href="#l10.1024"></a><span id="l10.1024" class="difflineplus">+      // the index to insert at the correct place.</span>
<a href="#l10.1025"></a><span id="l10.1025" class="difflineplus">+      if (existingBookmark &amp;&amp; insertionParentGuid == existingBookmark.parentGuid) {</span>
<a href="#l10.1026"></a><span id="l10.1026" class="difflineplus">+        if (index &gt; existingBookmark.index) {</span>
<a href="#l10.1027"></a><span id="l10.1027" class="difflineplus">+          // If we're dragging down, we need to go one lower to insert at</span>
<a href="#l10.1028"></a><span id="l10.1028" class="difflineplus">+          // the real point as moving the element changes the index of</span>
<a href="#l10.1029"></a><span id="l10.1029" class="difflineplus">+          // everything below by 1.</span>
<a href="#l10.1030"></a><span id="l10.1030" class="difflineplus">+          index--;</span>
<a href="#l10.1031"></a><span id="l10.1031" class="difflineplus">+        } else if (index == existingBookmark.index) {</span>
<a href="#l10.1032"></a><span id="l10.1032" class="difflineplus">+          // This isn't moving so we skip it.</span>
<a href="#l10.1033"></a><span id="l10.1033" class="difflineplus">+          continue;</span>
<a href="#l10.1034"></a><span id="l10.1034" class="difflineplus">+        }</span>
<a href="#l10.1035"></a><span id="l10.1035" class="difflineplus">+      }</span>
<a href="#l10.1036"></a><span id="l10.1036" class="difflineplus">+    }</span>
<a href="#l10.1037"></a><span id="l10.1037" class="difflineplus">+</span>
<a href="#l10.1038"></a><span id="l10.1038" class="difflineplus">+    // If this is not a copy, check for safety that we can move the</span>
<a href="#l10.1039"></a><span id="l10.1039" class="difflineplus">+    // source, otherwise report an error and fallback to a copy.</span>
<a href="#l10.1040"></a><span id="l10.1040" class="difflineplus">+    if (!doCopy &amp;&amp; !PlacesControllerDragHelper.canMoveUnwrappedNode(item)) {</span>
<a href="#l10.1041"></a><span id="l10.1041" class="difflineplus">+      Cu.reportError(&quot;Tried to move an unmovable Places &quot; +</span>
<a href="#l10.1042"></a><span id="l10.1042" class="difflineplus">+                                   &quot;node, reverting to a copy operation.&quot;);</span>
<a href="#l10.1043"></a><span id="l10.1043" class="difflineplus">+      doCopy = true;</span>
<a href="#l10.1044"></a><span id="l10.1044" class="difflineplus">+    }</span>
<a href="#l10.1045"></a><span id="l10.1045" class="difflineplus">+    transactions.push(</span>
<a href="#l10.1046"></a><span id="l10.1046" class="difflineplus">+      PlacesUIUtils.getTransactionForData(item,</span>
<a href="#l10.1047"></a><span id="l10.1047" class="difflineplus">+                                          insertionParentGuid,</span>
<a href="#l10.1048"></a><span id="l10.1048" class="difflineplus">+                                          index,</span>
<a href="#l10.1049"></a><span id="l10.1049" class="difflineplus">+                                          doCopy));</span>
<a href="#l10.1050"></a><span id="l10.1050" class="difflineplus">+</span>
<a href="#l10.1051"></a><span id="l10.1051" class="difflineplus">+    if (index != -1 &amp;&amp; item.itemGuid) {</span>
<a href="#l10.1052"></a><span id="l10.1052" class="difflineplus">+      index++;</span>
<a href="#l10.1053"></a><span id="l10.1053" class="difflineplus">+    }</span>
<a href="#l10.1054"></a><span id="l10.1054" class="difflineplus">+  }</span>
<a href="#l10.1055"></a><span id="l10.1055" class="difflineplus">+  return transactions;</span>
<a href="#l10.1056"></a><span id="l10.1056" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/suite/common/places/content/editBookmarkOverlay.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/suite/common/places/content/editBookmarkOverlay.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -16,18 +16,17 @@ var gEditItemOverlay = {</span>
<a href="#l11.4"></a><span id="l11.4">     if (!aInitInfo)</span>
<a href="#l11.5"></a><span id="l11.5">       return this._paneInfo = null;</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7">     if (&quot;uris&quot; in aInitInfo &amp;&amp; &quot;node&quot; in aInitInfo)</span>
<a href="#l11.8"></a><span id="l11.8">       throw new Error(&quot;ambiguous pane info&quot;);</span>
<a href="#l11.9"></a><span id="l11.9">     if (!(&quot;uris&quot; in aInitInfo) &amp;&amp; !(&quot;node&quot; in aInitInfo))</span>
<a href="#l11.10"></a><span id="l11.10">       throw new Error(&quot;Neither node nor uris set for pane info&quot;);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    // Once we stop supporting legacy add-ons the code should throw if a node is</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-    // not passed.</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+    // We either pass a node or uris.</span>
<a href="#l11.15"></a><span id="l11.15">     let node = &quot;node&quot; in aInitInfo ? aInitInfo.node : null;</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17">     // Since there's no true UI for folder shortcuts (they show up just as their target</span>
<a href="#l11.18"></a><span id="l11.18">     // folders), when the pane shows for them it's opened in read-only mode, showing the</span>
<a href="#l11.19"></a><span id="l11.19">     // properties of the target folder.</span>
<a href="#l11.20"></a><span id="l11.20">     let itemId = node ? node.itemId : -1;</span>
<a href="#l11.21"></a><span id="l11.21">     let itemGuid = node ? PlacesUtils.getConcreteItemGuid(node) : null;</span>
<a href="#l11.22"></a><span id="l11.22">     let isItem = itemId != -1;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineat">@@ -51,18 +50,24 @@ var gEditItemOverlay = {</span>
<a href="#l11.24"></a><span id="l11.24">     let parentId = -1;</span>
<a href="#l11.25"></a><span id="l11.25">     let parentGuid = null;</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27">     if (node &amp;&amp; isItem) {</span>
<a href="#l11.28"></a><span id="l11.28">       if (!node.parent || (node.parent.itemId &gt; 0 &amp;&amp; !node.parent.bookmarkGuid)) {</span>
<a href="#l11.29"></a><span id="l11.29">         throw new Error(&quot;Cannot use an incomplete node to initialize the edit bookmark panel&quot;);</span>
<a href="#l11.30"></a><span id="l11.30">       }</span>
<a href="#l11.31"></a><span id="l11.31">       let parent = node.parent;</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-      isParentReadOnly = !PlacesUtils.nodeIsFolder(parent) ||</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-                          PlacesUIUtils.isContentsReadOnly(parent);</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+      isParentReadOnly = !PlacesUtils.nodeIsFolder(parent);</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+      if (!isParentReadOnly) {</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+        let folderId = PlacesUtils.getConcreteItemId(parent);</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+        isParentReadOnly = folderId == PlacesUtils.placesRootId ||</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+                           (!(&quot;get&quot; in Object.getOwnPropertyDescriptor(PlacesUIUtils, &quot;leftPaneFolderId&quot;)) &amp;&amp;</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+                            (folderId == PlacesUIUtils.leftPaneFolderId ||</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+                             folderId == PlacesUIUtils.allBookmarksFolderId));</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+      }</span>
<a href="#l11.42"></a><span id="l11.42">       parentId = parent.itemId;</span>
<a href="#l11.43"></a><span id="l11.43">       parentGuid = parent.bookmarkGuid;</span>
<a href="#l11.44"></a><span id="l11.44">     }</span>
<a href="#l11.45"></a><span id="l11.45"> </span>
<a href="#l11.46"></a><span id="l11.46">     let focusedElement = aInitInfo.focusedElement;</span>
<a href="#l11.47"></a><span id="l11.47">     let onPanelReady = aInitInfo.onPanelReady;</span>
<a href="#l11.48"></a><span id="l11.48"> </span>
<a href="#l11.49"></a><span id="l11.49">     return this._paneInfo = { itemId, itemGuid, parentId, parentGuid, isItem,</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineat">@@ -224,17 +229,17 @@ var gEditItemOverlay = {</span>
<a href="#l11.51"></a><span id="l11.51">           isBookmark, bulkTagging, uris,</span>
<a href="#l11.52"></a><span id="l11.52">           visibleRows, focusedElement,</span>
<a href="#l11.53"></a><span id="l11.53">           onPanelReady } = this._setPaneInfo(aInfo);</span>
<a href="#l11.54"></a><span id="l11.54"> </span>
<a href="#l11.55"></a><span id="l11.55">     let showOrCollapse =</span>
<a href="#l11.56"></a><span id="l11.56">       (rowId, isAppropriateForInput, nameInHiddenRows = null) =&gt; {</span>
<a href="#l11.57"></a><span id="l11.57">         let visible = isAppropriateForInput;</span>
<a href="#l11.58"></a><span id="l11.58">         if (visible &amp;&amp; &quot;hiddenRows&quot; in aInfo &amp;&amp; nameInHiddenRows)</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-          visible &amp;= aInfo.hiddenRows.indexOf(nameInHiddenRows) == -1;</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+          visible &amp;= !aInfo.hiddenRows.includes(nameInHiddenRows);</span>
<a href="#l11.61"></a><span id="l11.61">         if (visible)</span>
<a href="#l11.62"></a><span id="l11.62">           visibleRows.add(rowId);</span>
<a href="#l11.63"></a><span id="l11.63">         return !(this._element(rowId).collapsed = !visible);</span>
<a href="#l11.64"></a><span id="l11.64">       };</span>
<a href="#l11.65"></a><span id="l11.65"> </span>
<a href="#l11.66"></a><span id="l11.66">     if (showOrCollapse(&quot;nameRow&quot;, !bulkTagging, &quot;name&quot;)) {</span>
<a href="#l11.67"></a><span id="l11.67">       this._initNamePicker();</span>
<a href="#l11.68"></a><span id="l11.68">       this._namePicker.readOnly = this.readOnly;</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineat">@@ -335,17 +340,17 @@ var gEditItemOverlay = {</span>
<a href="#l11.70"></a><span id="l11.70">     let commonTags = new Set(PlacesUtils.tagging.getTagsForURI(firstURI));</span>
<a href="#l11.71"></a><span id="l11.71">     if (commonTags.size == 0)</span>
<a href="#l11.72"></a><span id="l11.72">       return this._cachedCommonTags = [];</span>
<a href="#l11.73"></a><span id="l11.73"> </span>
<a href="#l11.74"></a><span id="l11.74">     for (let uri of uris) {</span>
<a href="#l11.75"></a><span id="l11.75">       let curentURITags = PlacesUtils.tagging.getTagsForURI(uri);</span>
<a href="#l11.76"></a><span id="l11.76">       for (let tag of commonTags) {</span>
<a href="#l11.77"></a><span id="l11.77">         if (!curentURITags.includes(tag)) {</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-          commonTags.delete(tag)</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+          commonTags.delete(tag);</span>
<a href="#l11.80"></a><span id="l11.80">           if (commonTags.size == 0)</span>
<a href="#l11.81"></a><span id="l11.81">             return this._paneInfo.cachedCommonTags = [];</span>
<a href="#l11.82"></a><span id="l11.82">         }</span>
<a href="#l11.83"></a><span id="l11.83">       }</span>
<a href="#l11.84"></a><span id="l11.84">     }</span>
<a href="#l11.85"></a><span id="l11.85">     return this._paneInfo._cachedCommonTags = [...commonTags];</span>
<a href="#l11.86"></a><span id="l11.86">   },</span>
<a href="#l11.87"></a><span id="l11.87"> </span>
<a href="#l11.88"></a><span id="l11.88" class="difflineat">@@ -498,17 +503,18 @@ var gEditItemOverlay = {</span>
<a href="#l11.89"></a><span id="l11.89"> </span>
<a href="#l11.90"></a><span id="l11.90">   onTagsFieldChange() {</span>
<a href="#l11.91"></a><span id="l11.91">     // Check for _paneInfo existing as the dialog may be closing but receiving</span>
<a href="#l11.92"></a><span id="l11.92">     // async updates from unresolved promises.</span>
<a href="#l11.93"></a><span id="l11.93">     if (this._paneInfo &amp;&amp;</span>
<a href="#l11.94"></a><span id="l11.94">         (this._paneInfo.isURI || this._paneInfo.bulkTagging)) {</span>
<a href="#l11.95"></a><span id="l11.95">       this._updateTags().then(</span>
<a href="#l11.96"></a><span id="l11.96">         anyChanges =&gt; {</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-          if (anyChanges)</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+          // Check _paneInfo here as we might be closing the dialog.</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+          if (anyChanges &amp;&amp; this._paneInfo)</span>
<a href="#l11.100"></a><span id="l11.100">             this._mayUpdateFirstEditField(&quot;tagsField&quot;);</span>
<a href="#l11.101"></a><span id="l11.101">         }, Cu.reportError);</span>
<a href="#l11.102"></a><span id="l11.102">     }</span>
<a href="#l11.103"></a><span id="l11.103">   },</span>
<a href="#l11.104"></a><span id="l11.104"> </span>
<a href="#l11.105"></a><span id="l11.105">   /**</span>
<a href="#l11.106"></a><span id="l11.106">    * For a given array of currently-set tags and the tags-input-field</span>
<a href="#l11.107"></a><span id="l11.107">    * value, returns which tags should be removed and which should be added in</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineat">@@ -534,30 +540,16 @@ var gEditItemOverlay = {</span>
<a href="#l11.109"></a><span id="l11.109">   },</span>
<a href="#l11.110"></a><span id="l11.110"> </span>
<a href="#l11.111"></a><span id="l11.111">   // Adds and removes tags for one or more uris.</span>
<a href="#l11.112"></a><span id="l11.112">   _setTagsFromTagsInputField(aCurrentTags, aURIs) {</span>
<a href="#l11.113"></a><span id="l11.113">     let { removedTags, newTags } = this._getTagsChanges(aCurrentTags);</span>
<a href="#l11.114"></a><span id="l11.114">     if (removedTags.length + newTags.length == 0)</span>
<a href="#l11.115"></a><span id="l11.115">       return false;</span>
<a href="#l11.116"></a><span id="l11.116"> </span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-    if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-      let txns = [];</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-      for (let uri of aURIs) {</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-        if (removedTags.length &gt; 0)</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-          txns.push(new PlacesUntagURITransaction(uri, removedTags));</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-        if (newTags.length &gt; 0)</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-          txns.push(new PlacesTagURITransaction(uri, newTags));</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-      }</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-        new PlacesAggregatedTransaction(&quot;Update tags&quot;, txns));</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-      return true;</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-    }</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-</span>
<a href="#l11.131"></a><span id="l11.131">     let setTags = async function() {</span>
<a href="#l11.132"></a><span id="l11.132">       if (removedTags.length &gt; 0) {</span>
<a href="#l11.133"></a><span id="l11.133">         await PlacesTransactions.Untag({ urls: aURIs, tags: removedTags })</span>
<a href="#l11.134"></a><span id="l11.134">                                 .transact();</span>
<a href="#l11.135"></a><span id="l11.135">       }</span>
<a href="#l11.136"></a><span id="l11.136">       if (newTags.length &gt; 0) {</span>
<a href="#l11.137"></a><span id="l11.137">         await PlacesTransactions.Tag({ urls: aURIs, tags: newTags })</span>
<a href="#l11.138"></a><span id="l11.138">                                 .transact();</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineat">@@ -608,61 +600,46 @@ var gEditItemOverlay = {</span>
<a href="#l11.140"></a><span id="l11.140">     // * if this._firstEditedField is already set, this is not the first field,</span>
<a href="#l11.141"></a><span id="l11.141">     //   so there's nothing to do</span>
<a href="#l11.142"></a><span id="l11.142">     if (this._paneInfo.bulkTagging || this._firstEditedField)</span>
<a href="#l11.143"></a><span id="l11.143">       return;</span>
<a href="#l11.144"></a><span id="l11.144"> </span>
<a href="#l11.145"></a><span id="l11.145">     this._firstEditedField = aNewField;</span>
<a href="#l11.146"></a><span id="l11.146"> </span>
<a href="#l11.147"></a><span id="l11.147">     // set the pref</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineminus">-    var prefs = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineminus">-                  .getService(Ci.nsIPrefBranch);</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-    prefs.setCharPref(&quot;browser.bookmarks.editDialog.firstEditField&quot;, aNewField);</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+    Services.prefs.setCharPref(&quot;browser.bookmarks.editDialog.firstEditField&quot;, aNewField);</span>
<a href="#l11.152"></a><span id="l11.152">   },</span>
<a href="#l11.153"></a><span id="l11.153"> </span>
<a href="#l11.154"></a><span id="l11.154">   async onNamePickerChange() {</span>
<a href="#l11.155"></a><span id="l11.155">     if (this.readOnly || !(this._paneInfo.isItem || this._paneInfo.isTag))</span>
<a href="#l11.156"></a><span id="l11.156">       return;</span>
<a href="#l11.157"></a><span id="l11.157"> </span>
<a href="#l11.158"></a><span id="l11.158">     // Here we update either the item title or its cached static title</span>
<a href="#l11.159"></a><span id="l11.159">     let newTitle = this._namePicker.value;</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-    if (!newTitle &amp;&amp; this._paneInfo.parentGuid == PlacesUtils.bookmarks.tagsGuid) {</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+    if (!newTitle &amp;&amp; this._paneInfo.isTag) {</span>
<a href="#l11.162"></a><span id="l11.162">       // We don't allow setting an empty title for a tag, restore the old one.</span>
<a href="#l11.163"></a><span id="l11.163">       this._initNamePicker();</span>
<a href="#l11.164"></a><span id="l11.164">     } else {</span>
<a href="#l11.165"></a><span id="l11.165">       this._mayUpdateFirstEditField(&quot;namePicker&quot;);</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineminus">-      if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineminus">-        let txn = new PlacesEditItemTitleTransaction(this._paneInfo.itemId,</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineminus">-                                                     newTitle);</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-        PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-        return;</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineminus">-      }</span>
<a href="#l11.172"></a><span id="l11.172"> </span>
<a href="#l11.173"></a><span id="l11.173">       let guid = this._paneInfo.isTag</span>
<a href="#l11.174"></a><span id="l11.174">                   ? (await PlacesUtils.promiseItemGuid(this._paneInfo.itemId))</span>
<a href="#l11.175"></a><span id="l11.175">                   : this._paneInfo.itemGuid;</span>
<a href="#l11.176"></a><span id="l11.176">       await PlacesTransactions.EditTitle({ guid, title: newTitle }).transact();</span>
<a href="#l11.177"></a><span id="l11.177">     }</span>
<a href="#l11.178"></a><span id="l11.178">   },</span>
<a href="#l11.179"></a><span id="l11.179"> </span>
<a href="#l11.180"></a><span id="l11.180">   onDescriptionFieldChange() {</span>
<a href="#l11.181"></a><span id="l11.181">     if (this.readOnly || !this._paneInfo.isItem)</span>
<a href="#l11.182"></a><span id="l11.182">       return;</span>
<a href="#l11.183"></a><span id="l11.183"> </span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-    let itemId = this._paneInfo.itemId;</span>
<a href="#l11.185"></a><span id="l11.185">     let description = this._element(&quot;descriptionField&quot;).value;</span>
<a href="#l11.186"></a><span id="l11.186">     if (description != PlacesUIUtils.getItemDescription(this._paneInfo.itemId)) {</span>
<a href="#l11.187"></a><span id="l11.187">       let annotation =</span>
<a href="#l11.188"></a><span id="l11.188">         { name: PlacesUIUtils.DESCRIPTION_ANNO, value: description };</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">-      if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-        let txn = new PlacesSetItemAnnotationTransaction(itemId,</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-                                                         annotation);</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-        PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-        return;</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineminus">-      }</span>
<a href="#l11.195"></a><span id="l11.195">       let guid = this._paneInfo.itemGuid;</span>
<a href="#l11.196"></a><span id="l11.196">       PlacesTransactions.Annotate({ guid, annotation })</span>
<a href="#l11.197"></a><span id="l11.197">                         .transact().catch(Cu.reportError);</span>
<a href="#l11.198"></a><span id="l11.198">     }</span>
<a href="#l11.199"></a><span id="l11.199">   },</span>
<a href="#l11.200"></a><span id="l11.200"> </span>
<a href="#l11.201"></a><span id="l11.201">   onLocationFieldChange() {</span>
<a href="#l11.202"></a><span id="l11.202">     if (this.readOnly || !this._paneInfo.isBookmark)</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineat">@@ -674,79 +651,58 @@ var gEditItemOverlay = {</span>
<a href="#l11.204"></a><span id="l11.204">     } catch (ex) {</span>
<a href="#l11.205"></a><span id="l11.205">       // TODO: Bug 1089141 - Provide some feedback about the invalid url.</span>
<a href="#l11.206"></a><span id="l11.206">       return;</span>
<a href="#l11.207"></a><span id="l11.207">     }</span>
<a href="#l11.208"></a><span id="l11.208"> </span>
<a href="#l11.209"></a><span id="l11.209">     if (this._paneInfo.uri.equals(newURI))</span>
<a href="#l11.210"></a><span id="l11.210">       return;</span>
<a href="#l11.211"></a><span id="l11.211"> </span>
<a href="#l11.212"></a><span id="l11.212" class="difflineminus">-    if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineminus">-      let txn = new PlacesEditBookmarkURITransaction(this._paneInfo.itemId, newURI);</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineminus">-      return;</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineminus">-    }</span>
<a href="#l11.217"></a><span id="l11.217">     let guid = this._paneInfo.itemGuid;</span>
<a href="#l11.218"></a><span id="l11.218">     PlacesTransactions.EditUrl({ guid, url: newURI })</span>
<a href="#l11.219"></a><span id="l11.219">                       .transact().catch(Cu.reportError);</span>
<a href="#l11.220"></a><span id="l11.220">   },</span>
<a href="#l11.221"></a><span id="l11.221"> </span>
<a href="#l11.222"></a><span id="l11.222">   onKeywordFieldChange() {</span>
<a href="#l11.223"></a><span id="l11.223">     if (this.readOnly || !this._paneInfo.isBookmark)</span>
<a href="#l11.224"></a><span id="l11.224">       return;</span>
<a href="#l11.225"></a><span id="l11.225"> </span>
<a href="#l11.226"></a><span id="l11.226" class="difflineminus">-    let itemId = this._paneInfo.itemId;</span>
<a href="#l11.227"></a><span id="l11.227">     let oldKeyword = this._keyword;</span>
<a href="#l11.228"></a><span id="l11.228">     let keyword = this._keyword = this._keywordField.value;</span>
<a href="#l11.229"></a><span id="l11.229">     let postData = this._paneInfo.postData;</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-    if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineminus">-      let txn = new PlacesEditBookmarkKeywordTransaction(itemId,</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineminus">-                                                         keyword,</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineminus">-                                                         postData,</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineminus">-                                                         oldKeyword);</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineminus">-      return;</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineminus">-    }</span>
<a href="#l11.238"></a><span id="l11.238">     let guid = this._paneInfo.itemGuid;</span>
<a href="#l11.239"></a><span id="l11.239">     PlacesTransactions.EditKeyword({ guid, keyword, postData, oldKeyword })</span>
<a href="#l11.240"></a><span id="l11.240">                       .transact().catch(Cu.reportError);</span>
<a href="#l11.241"></a><span id="l11.241">   },</span>
<a href="#l11.242"></a><span id="l11.242"> </span>
<a href="#l11.243"></a><span id="l11.243">   onLoadInSidebarCheckboxCommand() {</span>
<a href="#l11.244"></a><span id="l11.244">     if (!this.initialized || !this._paneInfo.isBookmark)</span>
<a href="#l11.245"></a><span id="l11.245">       return;</span>
<a href="#l11.246"></a><span id="l11.246"> </span>
<a href="#l11.247"></a><span id="l11.247">     let annotation = { name: PlacesUIUtils.LOAD_IN_SIDEBAR_ANNO };</span>
<a href="#l11.248"></a><span id="l11.248">     if (this._loadInSidebarCheckbox.checked)</span>
<a href="#l11.249"></a><span id="l11.249">       annotation.value = true;</span>
<a href="#l11.250"></a><span id="l11.250"> </span>
<a href="#l11.251"></a><span id="l11.251" class="difflineminus">-    if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineminus">-      let itemId = this._paneInfo.itemId;</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineminus">-      let txn = new PlacesSetItemAnnotationTransaction(itemId,</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineminus">-                                                       annotation);</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineminus">-      return;</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineminus">-    }</span>
<a href="#l11.258"></a><span id="l11.258">     let guid = this._paneInfo.itemGuid;</span>
<a href="#l11.259"></a><span id="l11.259">     PlacesTransactions.Annotate({ guid, annotation })</span>
<a href="#l11.260"></a><span id="l11.260">                       .transact().catch(Cu.reportError);</span>
<a href="#l11.261"></a><span id="l11.261">   },</span>
<a href="#l11.262"></a><span id="l11.262"> </span>
<a href="#l11.263"></a><span id="l11.263">   toggleFolderTreeVisibility() {</span>
<a href="#l11.264"></a><span id="l11.264">     var expander = this._element(&quot;foldersExpander&quot;);</span>
<a href="#l11.265"></a><span id="l11.265">     var folderTreeRow = this._element(&quot;folderTreeRow&quot;);</span>
<a href="#l11.266"></a><span id="l11.266">     if (!folderTreeRow.collapsed) {</span>
<a href="#l11.267"></a><span id="l11.267">       expander.className = &quot;expander-down&quot;;</span>
<a href="#l11.268"></a><span id="l11.268">       expander.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l11.269"></a><span id="l11.269">                             expander.getAttribute(&quot;tooltiptextdown&quot;));</span>
<a href="#l11.270"></a><span id="l11.270">       folderTreeRow.collapsed = true;</span>
<a href="#l11.271"></a><span id="l11.271">       this._element(&quot;chooseFolderSeparator&quot;).hidden =</span>
<a href="#l11.272"></a><span id="l11.272">         this._element(&quot;chooseFolderMenuItem&quot;).hidden = false;</span>
<a href="#l11.273"></a><span id="l11.273">     } else {</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineminus">-      expander.className = &quot;expander-up&quot;</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineplus">+      expander.className = &quot;expander-up&quot;;</span>
<a href="#l11.276"></a><span id="l11.276">       expander.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l11.277"></a><span id="l11.277">                             expander.getAttribute(&quot;tooltiptextup&quot;));</span>
<a href="#l11.278"></a><span id="l11.278">       folderTreeRow.collapsed = false;</span>
<a href="#l11.279"></a><span id="l11.279"> </span>
<a href="#l11.280"></a><span id="l11.280">       // XXXmano: Ideally we would only do this once, but for some odd reason,</span>
<a href="#l11.281"></a><span id="l11.281">       // the editable mode set on this tree, together with its collapsed state</span>
<a href="#l11.282"></a><span id="l11.282">       // breaks the view.</span>
<a href="#l11.283"></a><span id="l11.283">       const FOLDER_TREE_PLACE_URI =</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineat">@@ -807,26 +763,19 @@ var gEditItemOverlay = {</span>
<a href="#l11.285"></a><span id="l11.285">       setTimeout(() =&gt; this.toggleFolderTreeVisibility(), 100);</span>
<a href="#l11.286"></a><span id="l11.286">       return;</span>
<a href="#l11.287"></a><span id="l11.287">     }</span>
<a href="#l11.288"></a><span id="l11.288"> </span>
<a href="#l11.289"></a><span id="l11.289">     // Move the item</span>
<a href="#l11.290"></a><span id="l11.290">     let containerId = this._folderMenuList.selectedItem.folderId;</span>
<a href="#l11.291"></a><span id="l11.291">     if (this._paneInfo.parentId != containerId &amp;&amp;</span>
<a href="#l11.292"></a><span id="l11.292">         this._paneInfo.itemId != containerId) {</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineminus">-      if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineminus">-        let newParentGuid = await PlacesUtils.promiseItemGuid(containerId);</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineminus">-        let guid = this._paneInfo.itemGuid;</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineminus">-        await PlacesTransactions.Move({ guid, newParentGuid }).transact();</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineminus">-      } else {</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineminus">-        let txn = new PlacesMoveItemTransaction(this._paneInfo.itemId,</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineminus">-                                                containerId,</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineminus">-                                                PlacesUtils.bookmarks.DEFAULT_INDEX);</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineminus">-        PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineminus">-      }</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineplus">+      let newParentGuid = await PlacesUtils.promiseItemGuid(containerId);</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineplus">+      let guid = this._paneInfo.itemGuid;</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineplus">+      await PlacesTransactions.Move({ guid, newParentGuid }).transact();</span>
<a href="#l11.306"></a><span id="l11.306"> </span>
<a href="#l11.307"></a><span id="l11.307">       // Mark the containing folder as recently-used if it isn't in the</span>
<a href="#l11.308"></a><span id="l11.308">       // static list</span>
<a href="#l11.309"></a><span id="l11.309">       if (containerId != PlacesUtils.unfiledBookmarksFolderId &amp;&amp;</span>
<a href="#l11.310"></a><span id="l11.310">           containerId != PlacesUtils.toolbarFolderId &amp;&amp;</span>
<a href="#l11.311"></a><span id="l11.311">           containerId != PlacesUtils.bookmarksMenuFolderId) {</span>
<a href="#l11.312"></a><span id="l11.312">         this._markFolderAsRecentlyUsed(containerId)</span>
<a href="#l11.313"></a><span id="l11.313">             .catch(Cu.reportError);</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineat">@@ -863,40 +812,16 @@ var gEditItemOverlay = {</span>
<a href="#l11.315"></a><span id="l11.315">       return;</span>
<a href="#l11.316"></a><span id="l11.316"> </span>
<a href="#l11.317"></a><span id="l11.317">     var folderItem = this._getFolderMenuItem(folderId, selectedNode.title);</span>
<a href="#l11.318"></a><span id="l11.318">     this._folderMenuList.selectedItem = folderItem;</span>
<a href="#l11.319"></a><span id="l11.319">     folderItem.doCommand();</span>
<a href="#l11.320"></a><span id="l11.320">   },</span>
<a href="#l11.321"></a><span id="l11.321"> </span>
<a href="#l11.322"></a><span id="l11.322">   async _markFolderAsRecentlyUsed(aFolderId) {</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineminus">-    if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineminus">-      let txns = [];</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineminus">-</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineminus">-      // Expire old unused recent folders.</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineminus">-      let annotation = this._getLastUsedAnnotationObject(false);</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineminus">-      while (this._recentFolders.length &gt; MAX_FOLDER_ITEM_IN_MENU_LIST) {</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineminus">-        let folderId = this._recentFolders.pop().folderId;</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineminus">-        let annoTxn = new PlacesSetItemAnnotationTransaction(folderId,</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineminus">-                                                             annotation);</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineminus">-        txns.push(annoTxn);</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineminus">-      }</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineminus">-</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineminus">-      // Mark folder as recently used</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineminus">-      annotation = this._getLastUsedAnnotationObject(true);</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineminus">-      let annoTxn = new PlacesSetItemAnnotationTransaction(aFolderId,</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineminus">-                                                           annotation);</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineminus">-      txns.push(annoTxn);</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineminus">-</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineminus">-      let aggregate =</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineminus">-        new PlacesAggregatedTransaction(&quot;Update last used folders&quot;, txns);</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(aggregate);</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineminus">-      return;</span>
<a href="#l11.345"></a><span id="l11.345" class="difflineminus">-    }</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineminus">-</span>
<a href="#l11.347"></a><span id="l11.347">     // Expire old unused recent folders.</span>
<a href="#l11.348"></a><span id="l11.348">     let guids = [];</span>
<a href="#l11.349"></a><span id="l11.349">     while (this._recentFolders.length &gt; MAX_FOLDER_ITEM_IN_MENU_LIST) {</span>
<a href="#l11.350"></a><span id="l11.350">       let folderId = this._recentFolders.pop().folderId;</span>
<a href="#l11.351"></a><span id="l11.351">       let guid = await PlacesUtils.promiseItemGuid(folderId);</span>
<a href="#l11.352"></a><span id="l11.352">       guids.push(guid);</span>
<a href="#l11.353"></a><span id="l11.353">     }</span>
<a href="#l11.354"></a><span id="l11.354">     if (guids.length &gt; 0) {</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineat">@@ -1002,31 +927,27 @@ var gEditItemOverlay = {</span>
<a href="#l11.356"></a><span id="l11.356">                .filter(tag =&gt; tag.length &gt; 0); // Kill empty tags.</span>
<a href="#l11.357"></a><span id="l11.357">   },</span>
<a href="#l11.358"></a><span id="l11.358"> </span>
<a href="#l11.359"></a><span id="l11.359">   async newFolder() {</span>
<a href="#l11.360"></a><span id="l11.360">     let ip = this._folderTree.insertionPoint;</span>
<a href="#l11.361"></a><span id="l11.361"> </span>
<a href="#l11.362"></a><span id="l11.362">     // default to the bookmarks menu folder</span>
<a href="#l11.363"></a><span id="l11.363">     if (!ip || ip.itemId == PlacesUIUtils.allBookmarksFolderId) {</span>
<a href="#l11.364"></a><span id="l11.364" class="difflineminus">-      ip = new InsertionPoint(PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineminus">-                              PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineminus">-                              Ci.nsITreeView.DROP_ON);</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineplus">+      ip = new InsertionPoint({</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineplus">+        parentId: PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineplus">+        parentGuid: PlacesUtils.bookmarks.menuGuid</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineplus">+      });</span>
<a href="#l11.371"></a><span id="l11.371">     }</span>
<a href="#l11.372"></a><span id="l11.372"> </span>
<a href="#l11.373"></a><span id="l11.373">     // XXXmano: add a separate &quot;New Folder&quot; string at some point...</span>
<a href="#l11.374"></a><span id="l11.374">     let title = this._element(&quot;newFolderButton&quot;).label;</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineminus">-    if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineminus">-      let parentGuid = await ip.promiseGuid();</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineminus">-      await PlacesTransactions.NewFolder({ parentGuid, title, index: ip.index })</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineminus">-                              .transact().catch(Cu.reportError);</span>
<a href="#l11.379"></a><span id="l11.379" class="difflineminus">-    } else {</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineminus">-      let txn = new PlacesCreateFolderTransaction(title, ip.itemId, ip.index);</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineminus">-    }</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineplus">+    await PlacesTransactions.NewFolder({ parentGuid: ip.guid, title,</span>
<a href="#l11.384"></a><span id="l11.384" class="difflineplus">+                                         index: await ip.getIndex() })</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineplus">+                            .transact().catch(Cu.reportError);</span>
<a href="#l11.386"></a><span id="l11.386"> </span>
<a href="#l11.387"></a><span id="l11.387">     this._folderTree.focus();</span>
<a href="#l11.388"></a><span id="l11.388">     this._folderTree.selectItems([ip.itemId]);</span>
<a href="#l11.389"></a><span id="l11.389">     PlacesUtils.asContainer(this._folderTree.selectedNode).containerOpen = true;</span>
<a href="#l11.390"></a><span id="l11.390">     this._folderTree.selectItems([this._lastNewItem]);</span>
<a href="#l11.391"></a><span id="l11.391">     this._folderTree.startEditing(this._folderTree.view.selection.currentIndex,</span>
<a href="#l11.392"></a><span id="l11.392">                                   this._folderTree.columns.getFirstColumn());</span>
<a href="#l11.393"></a><span id="l11.393">   },</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineat">@@ -1101,50 +1022,50 @@ var gEditItemOverlay = {</span>
<a href="#l11.395"></a><span id="l11.395">       // Any tags change should be reflected in the tags selector.</span>
<a href="#l11.396"></a><span id="l11.396">       if (this._element(&quot;tagsSelector&quot;)) {</span>
<a href="#l11.397"></a><span id="l11.397">         this._rebuildTagsSelectorList();</span>
<a href="#l11.398"></a><span id="l11.398">       }</span>
<a href="#l11.399"></a><span id="l11.399">     }</span>
<a href="#l11.400"></a><span id="l11.400">   },</span>
<a href="#l11.401"></a><span id="l11.401"> </span>
<a href="#l11.402"></a><span id="l11.402">   _onItemTitleChange(aItemId, aNewTitle) {</span>
<a href="#l11.403"></a><span id="l11.403" class="difflineminus">-    if (!this._paneInfo.isBookmark)</span>
<a href="#l11.404"></a><span id="l11.404" class="difflineminus">-      return;</span>
<a href="#l11.405"></a><span id="l11.405">     if (aItemId == this._paneInfo.itemId) {</span>
<a href="#l11.406"></a><span id="l11.406">       this._paneInfo.title = aNewTitle;</span>
<a href="#l11.407"></a><span id="l11.407">       this._initTextField(this._namePicker, aNewTitle);</span>
<a href="#l11.408"></a><span id="l11.408">     } else if (this._paneInfo.visibleRows.has(&quot;folderRow&quot;)) {</span>
<a href="#l11.409"></a><span id="l11.409">       // If the title of a folder which is listed within the folders</span>
<a href="#l11.410"></a><span id="l11.410">       // menulist has been changed, we need to update the label of its</span>
<a href="#l11.411"></a><span id="l11.411">       // representing element.</span>
<a href="#l11.412"></a><span id="l11.412">       let menupopup = this._folderMenuList.menupopup;</span>
<a href="#l11.413"></a><span id="l11.413">       for (let menuitem of menupopup.childNodes) {</span>
<a href="#l11.414"></a><span id="l11.414">         if (&quot;folderId&quot; in menuitem &amp;&amp; menuitem.folderId == aItemId) {</span>
<a href="#l11.415"></a><span id="l11.415">           menuitem.label = aNewTitle;</span>
<a href="#l11.416"></a><span id="l11.416">           break;</span>
<a href="#l11.417"></a><span id="l11.417">         }</span>
<a href="#l11.418"></a><span id="l11.418">       }</span>
<a href="#l11.419"></a><span id="l11.419">     }</span>
<a href="#l11.420"></a><span id="l11.420">     // We need to also update title of recent folders.</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineminus">-    for (let folder of this._recentFolders) {</span>
<a href="#l11.422"></a><span id="l11.422" class="difflineminus">-      if (folder.folderId == aItemId) {</span>
<a href="#l11.423"></a><span id="l11.423" class="difflineminus">-        folder.title = aNewTitle;</span>
<a href="#l11.424"></a><span id="l11.424" class="difflineminus">-        break;</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineplus">+    if (this._recentFolders) {</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineplus">+      for (let folder of this._recentFolders) {</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineplus">+        if (folder.folderId == aItemId) {</span>
<a href="#l11.428"></a><span id="l11.428" class="difflineplus">+          folder.title = aNewTitle;</span>
<a href="#l11.429"></a><span id="l11.429" class="difflineplus">+          break;</span>
<a href="#l11.430"></a><span id="l11.430" class="difflineplus">+        }</span>
<a href="#l11.431"></a><span id="l11.431">       }</span>
<a href="#l11.432"></a><span id="l11.432">     }</span>
<a href="#l11.433"></a><span id="l11.433">   },</span>
<a href="#l11.434"></a><span id="l11.434"> </span>
<a href="#l11.435"></a><span id="l11.435">   // nsINavBookmarkObserver</span>
<a href="#l11.436"></a><span id="l11.436">   onItemChanged(aItemId, aProperty, aIsAnnotationProperty, aValue,</span>
<a href="#l11.437"></a><span id="l11.437">                 aLastModified, aItemType, aParentId, aGuid) {</span>
<a href="#l11.438"></a><span id="l11.438">     if (aProperty == &quot;tags&quot; &amp;&amp; this._paneInfo.visibleRows.has(&quot;tagsRow&quot;)) {</span>
<a href="#l11.439"></a><span id="l11.439">       this._onTagsChange(aGuid).catch(Cu.reportError);</span>
<a href="#l11.440"></a><span id="l11.440">       return;</span>
<a href="#l11.441"></a><span id="l11.441">     }</span>
<a href="#l11.442"></a><span id="l11.442" class="difflineminus">-    if (aProperty == &quot;title&quot; &amp;&amp; this._paneInfo.isItem) {</span>
<a href="#l11.443"></a><span id="l11.443" class="difflineplus">+    if (aProperty == &quot;title&quot; &amp;&amp; (this._paneInfo.isItem || this._paneInfo.isTag)) {</span>
<a href="#l11.444"></a><span id="l11.444">       // This also updates titles of folders in the folder menu list.</span>
<a href="#l11.445"></a><span id="l11.445">       this._onItemTitleChange(aItemId, aValue);</span>
<a href="#l11.446"></a><span id="l11.446">       return;</span>
<a href="#l11.447"></a><span id="l11.447">     }</span>
<a href="#l11.448"></a><span id="l11.448"> </span>
<a href="#l11.449"></a><span id="l11.449">     if (!this._paneInfo.isItem || this._paneInfo.itemId != aItemId) {</span>
<a href="#l11.450"></a><span id="l11.450">       return;</span>
<a href="#l11.451"></a><span id="l11.451">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/suite/common/places/content/editBookmarkOverlay.xul</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/suite/common/places/content/editBookmarkOverlay.xul</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -117,22 +117,21 @@</span>
<a href="#l12.4"></a><span id="l12.4">              collapsed=&quot;true&quot;&gt;</span>
<a href="#l12.5"></a><span id="l12.5">           &lt;label value=&quot;&amp;editBookmarkOverlay.tags.label;&quot;</span>
<a href="#l12.6"></a><span id="l12.6">                  class=&quot;editBMPanel_rowLabel&quot;</span>
<a href="#l12.7"></a><span id="l12.7">                  accesskey=&quot;&amp;editBookmarkOverlay.tags.accesskey;&quot;</span>
<a href="#l12.8"></a><span id="l12.8">                  control=&quot;editBMPanel_tagsField&quot;/&gt;</span>
<a href="#l12.9"></a><span id="l12.9">           &lt;hbox flex=&quot;1&quot; align=&quot;center&quot;&gt;</span>
<a href="#l12.10"></a><span id="l12.10">             &lt;textbox id=&quot;editBMPanel_tagsField&quot;</span>
<a href="#l12.11"></a><span id="l12.11">                      type=&quot;autocomplete&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-                     class=&quot;padded&quot;</span>
<a href="#l12.13"></a><span id="l12.13">                      flex=&quot;1&quot;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-                     autocompletesearch=&quot;places-tag-autocomplete&quot; </span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+                     autocompletesearch=&quot;places-tag-autocomplete&quot;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+                     autocompletepopup=&quot;PopupAutoComplete&quot;</span>
<a href="#l12.17"></a><span id="l12.17">                      completedefaultindex=&quot;true&quot;</span>
<a href="#l12.18"></a><span id="l12.18">                      tabscrolling=&quot;true&quot;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-                     showcommentcolumn=&quot;true&quot;</span>
<a href="#l12.20"></a><span id="l12.20">                      placeholder=&quot;&amp;editBookmarkOverlay.tagsEmptyDesc.label;&quot;</span>
<a href="#l12.21"></a><span id="l12.21">                      onchange=&quot;gEditItemOverlay.onTagsFieldChange();&quot;/&gt;</span>
<a href="#l12.22"></a><span id="l12.22">             &lt;button id=&quot;editBMPanel_tagsSelectorExpander&quot;</span>
<a href="#l12.23"></a><span id="l12.23">                     class=&quot;expander-down&quot;</span>
<a href="#l12.24"></a><span id="l12.24">                     tooltiptext=&quot;&amp;editBookmarkOverlay.tagsExpanderDown.tooltip;&quot;</span>
<a href="#l12.25"></a><span id="l12.25">                     tooltiptextdown=&quot;&amp;editBookmarkOverlay.tagsExpanderDown.tooltip;&quot;</span>
<a href="#l12.26"></a><span id="l12.26">                     tooltiptextup=&quot;&amp;editBookmarkOverlay.expanderUp.tooltip;&quot;</span>
<a href="#l12.27"></a><span id="l12.27">                     oncommand=&quot;gEditItemOverlay.toggleTagsSelector();&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/suite/common/places/content/history-panel.xul</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/suite/common/places/content/history-panel.xul</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -40,19 +40,19 @@</span>
<a href="#l13.4"></a><span id="l13.4">   &lt;/keyset&gt;</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6">   &lt;!-- required to overlay the context menu --&gt;</span>
<a href="#l13.7"></a><span id="l13.7">   &lt;menupopup id=&quot;placesContext&quot;/&gt;</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9">   &lt;!-- Bookmarks and history tooltip --&gt;</span>
<a href="#l13.10"></a><span id="l13.10">   &lt;tooltip id=&quot;bhTooltip&quot;/&gt;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  &lt;hbox id=&quot;sidebar-search-container&quot; align=&quot;center&quot;&gt;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  &lt;hbox id=&quot;sidebar-search-container&quot;&gt;</span>
<a href="#l13.14"></a><span id="l13.14">     &lt;textbox id=&quot;search-box&quot; flex=&quot;1&quot; type=&quot;search&quot;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-             placeholder=&quot;&amp;search.placeholder;&quot;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+             placeholder=&quot;&amp;historySearch.placeholder;&quot;</span>
<a href="#l13.17"></a><span id="l13.17">              aria-controls=&quot;historyTree&quot;</span>
<a href="#l13.18"></a><span id="l13.18">              oncommand=&quot;searchHistory(this.value);&quot;/&gt;</span>
<a href="#l13.19"></a><span id="l13.19">     &lt;button id=&quot;viewButton&quot; style=&quot;min-width:0px !important;&quot; type=&quot;menu&quot;</span>
<a href="#l13.20"></a><span id="l13.20">             label=&quot;&amp;view.label;&quot; accesskey=&quot;&amp;view.accesskey;&quot; selectedsort=&quot;day&quot;</span>
<a href="#l13.21"></a><span id="l13.21">             persist=&quot;selectedsort&quot;&gt;</span>
<a href="#l13.22"></a><span id="l13.22">       &lt;menupopup&gt;</span>
<a href="#l13.23"></a><span id="l13.23">         &lt;menuitem id=&quot;bydayandsite&quot; label=&quot;&amp;byDayAndSite.label;&quot;</span>
<a href="#l13.24"></a><span id="l13.24">                   accesskey=&quot;&amp;byDayAndSite.accesskey;&quot; type=&quot;radio&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/suite/common/places/content/menu.xml</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/suite/common/places/content/menu.xml</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -64,17 +64,17 @@</span>
<a href="#l14.4"></a><span id="l14.4">            dragging over this popup insertion point --&gt;</span>
<a href="#l14.5"></a><span id="l14.5">       &lt;method name=&quot;_getDropPoint&quot;&gt;</span>
<a href="#l14.6"></a><span id="l14.6">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l14.7"></a><span id="l14.7">           &lt;body&gt;&lt;![CDATA[</span>
<a href="#l14.8"></a><span id="l14.8">             // Can't drop if the menu isn't a folder</span>
<a href="#l14.9"></a><span id="l14.9">             let resultNode = this._placesNode;</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11">             if (!PlacesUtils.nodeIsFolder(resultNode) ||</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-                PlacesControllerDragHelper.disallowInsertion(resultNode)) {</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+                PlacesControllerDragHelper.disallowInsertion(resultNode, this._rootView)) {</span>
<a href="#l14.14"></a><span id="l14.14">               return null;</span>
<a href="#l14.15"></a><span id="l14.15">             }</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17">             var dropPoint = { ip: null, folderElt: null };</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19">             // The element we are dragging over</span>
<a href="#l14.20"></a><span id="l14.20">             let elt = aEvent.target;</span>
<a href="#l14.21"></a><span id="l14.21">             if (elt.localName == &quot;menupopup&quot;)</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -85,75 +85,78 @@</span>
<a href="#l14.23"></a><span id="l14.23">             let eventY = aEvent.layerY + (scrollbox.boxObject.y - this.boxObject.y);</span>
<a href="#l14.24"></a><span id="l14.24">             let scrollboxOffset = scrollbox.scrollBoxObject.y -</span>
<a href="#l14.25"></a><span id="l14.25">                                   (scrollbox.boxObject.y - this.boxObject.y);</span>
<a href="#l14.26"></a><span id="l14.26">             let eltY = elt.boxObject.y - scrollboxOffset;</span>
<a href="#l14.27"></a><span id="l14.27">             let eltHeight = elt.boxObject.height;</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29">             if (!elt._placesNode) {</span>
<a href="#l14.30"></a><span id="l14.30">               // If we are dragging over a non places node drop at the end.</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-              dropPoint.ip = new InsertionPoint(</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-                                  PlacesUtils.getConcreteItemId(resultNode),</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-                                  -1,</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-                                  Ci.nsITreeView.DROP_ON);</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+              dropPoint.ip = new InsertionPoint({</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+                parentId: PlacesUtils.getConcreteItemId(resultNode),</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+                parentGuid: PlacesUtils.getConcreteItemGuid(resultNode)</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+              });</span>
<a href="#l14.39"></a><span id="l14.39">               // We can set folderElt if we are dropping over a static menu that</span>
<a href="#l14.40"></a><span id="l14.40">               // has an internal placespopup.</span>
<a href="#l14.41"></a><span id="l14.41">               let isMenu = elt.localName == &quot;menu&quot; ||</span>
<a href="#l14.42"></a><span id="l14.42">                  (elt.localName == &quot;toolbarbutton&quot; &amp;&amp;</span>
<a href="#l14.43"></a><span id="l14.43">                   elt.getAttribute(&quot;type&quot;) == &quot;menu&quot;);</span>
<a href="#l14.44"></a><span id="l14.44">               if (isMenu &amp;&amp; elt.lastChild &amp;&amp;</span>
<a href="#l14.45"></a><span id="l14.45">                   elt.lastChild.hasAttribute(&quot;placespopup&quot;))</span>
<a href="#l14.46"></a><span id="l14.46">                 dropPoint.folderElt = elt;</span>
<a href="#l14.47"></a><span id="l14.47">               return dropPoint;</span>
<a href="#l14.48"></a><span id="l14.48">             }</span>
<a href="#l14.49"></a><span id="l14.49"> </span>
<a href="#l14.50"></a><span id="l14.50">             let tagName = PlacesUtils.nodeIsTagQuery(elt._placesNode) ?</span>
<a href="#l14.51"></a><span id="l14.51">                             elt._placesNode.title : null;</span>
<a href="#l14.52"></a><span id="l14.52">             if ((PlacesUtils.nodeIsFolder(elt._placesNode) &amp;&amp;</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-                 !PlacesUIUtils.isContentsReadOnly(elt._placesNode)) ||</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+                 !PlacesUIUtils.isFolderReadOnly(elt._placesNode, this._rootView)) ||</span>
<a href="#l14.55"></a><span id="l14.55">                 PlacesUtils.nodeIsTagQuery(elt._placesNode)) {</span>
<a href="#l14.56"></a><span id="l14.56">               // This is a folder or a tag container.</span>
<a href="#l14.57"></a><span id="l14.57">               if (eventY - eltY &lt; eltHeight * 0.20) {</span>
<a href="#l14.58"></a><span id="l14.58">                 // If mouse is in the top part of the element, drop above folder.</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-                dropPoint.ip = new InsertionPoint(</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-                                    PlacesUtils.getConcreteItemId(resultNode),</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-                                    -1,</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-                                    Ci.nsITreeView.DROP_BEFORE,</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-                                    tagName,</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-                                    elt._placesNode.itemId);</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+                dropPoint.ip = new InsertionPoint({</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+                  parentId: PlacesUtils.getConcreteItemId(resultNode),</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+                  parentGuid: PlacesUtils.getConcreteItemGuid(resultNode),</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+                  orientation: Ci.nsITreeView.DROP_BEFORE,</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+                  tagName,</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+                  dropNearNode: elt._placesNode</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+                });</span>
<a href="#l14.72"></a><span id="l14.72">                 return dropPoint;</span>
<a href="#l14.73"></a><span id="l14.73">               } else if (eventY - eltY &lt; eltHeight * 0.80) {</span>
<a href="#l14.74"></a><span id="l14.74">                 // If mouse is in the middle of the element, drop inside folder.</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-                dropPoint.ip = new InsertionPoint(</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-                                    PlacesUtils.getConcreteItemId(elt._placesNode),</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-                                    -1,</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-                                    Ci.nsITreeView.DROP_ON,</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-                                    tagName);</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+                dropPoint.ip = new InsertionPoint({</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+                  parentId: PlacesUtils.getConcreteItemId(elt._placesNode),</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+                  parentGuid: PlacesUtils.getConcreteItemGuid(elt._placesNode),</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+                  tagName</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+                });</span>
<a href="#l14.85"></a><span id="l14.85">                 dropPoint.folderElt = elt;</span>
<a href="#l14.86"></a><span id="l14.86">                 return dropPoint;</span>
<a href="#l14.87"></a><span id="l14.87">               }</span>
<a href="#l14.88"></a><span id="l14.88">             } else if (eventY - eltY &lt;= eltHeight / 2) {</span>
<a href="#l14.89"></a><span id="l14.89">               // This is a non-folder node or a readonly folder.</span>
<a href="#l14.90"></a><span id="l14.90">               // If the mouse is above the middle, drop above this item.</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-              dropPoint.ip = new InsertionPoint(</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-                                  PlacesUtils.getConcreteItemId(resultNode),</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-                                  -1,</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-                                  Ci.nsITreeView.DROP_BEFORE,</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-                                  tagName,</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-                                  elt._placesNode.itemId);</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+              dropPoint.ip = new InsertionPoint({</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+                parentId: PlacesUtils.getConcreteItemId(resultNode),</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+                parentGuid: PlacesUtils.getConcreteItemGuid(resultNode),</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+                orientation: Ci.nsITreeView.DROP_BEFORE,</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+                tagName,</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+                dropNearNode: elt._placesNode</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+              });</span>
<a href="#l14.104"></a><span id="l14.104">               return dropPoint;</span>
<a href="#l14.105"></a><span id="l14.105">             }</span>
<a href="#l14.106"></a><span id="l14.106"> </span>
<a href="#l14.107"></a><span id="l14.107">             // Drop below the item.</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineminus">-            dropPoint.ip = new InsertionPoint(</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineminus">-                                PlacesUtils.getConcreteItemId(resultNode),</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineminus">-                                -1,</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineminus">-                                Ci.nsITreeView.DROP_AFTER,</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineminus">-                                tagName,</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineminus">-                                elt._placesNode.itemId);</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+            dropPoint.ip = new InsertionPoint({</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+              parentId: PlacesUtils.getConcreteItemId(resultNode),</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+              parentGuid: PlacesUtils.getConcreteItemGuid(resultNode),</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+              orientation: Ci.nsITreeView.DROP_AFTER,</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+              tagName,</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+              dropNearNode: elt._placesNode,</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+            });</span>
<a href="#l14.121"></a><span id="l14.121">             return dropPoint;</span>
<a href="#l14.122"></a><span id="l14.122">         ]]&gt;&lt;/body&gt;</span>
<a href="#l14.123"></a><span id="l14.123">       &lt;/method&gt;</span>
<a href="#l14.124"></a><span id="l14.124"> </span>
<a href="#l14.125"></a><span id="l14.125">       &lt;!-- Sub-menus should be opened when the mouse drags over them, and closed</span>
<a href="#l14.126"></a><span id="l14.126">            when the mouse drags off.  The overFolder object manages opening and</span>
<a href="#l14.127"></a><span id="l14.127">            closing of folders when the mouse hovers. --&gt;</span>
<a href="#l14.128"></a><span id="l14.128">       &lt;field name=&quot;_overFolder&quot;&gt;&lt;![CDATA[({</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineat">@@ -342,17 +345,17 @@</span>
<a href="#l14.130"></a><span id="l14.130">         let elt = event.target;</span>
<a href="#l14.131"></a><span id="l14.131">         if (!elt._placesNode)</span>
<a href="#l14.132"></a><span id="l14.132">           return;</span>
<a href="#l14.133"></a><span id="l14.133"> </span>
<a href="#l14.134"></a><span id="l14.134">         let draggedElt = elt._placesNode;</span>
<a href="#l14.135"></a><span id="l14.135"> </span>
<a href="#l14.136"></a><span id="l14.136">         // Force a copy action if parent node is a query or we are dragging a</span>
<a href="#l14.137"></a><span id="l14.137">         // not-removable node.</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineminus">-        if (!PlacesControllerDragHelper.canMoveNode(draggedElt, elt))</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+        if (!PlacesControllerDragHelper.canMoveNode(draggedElt, this._rootView, elt))</span>
<a href="#l14.140"></a><span id="l14.140">           event.dataTransfer.effectAllowed = &quot;copyLink&quot;;</span>
<a href="#l14.141"></a><span id="l14.141"> </span>
<a href="#l14.142"></a><span id="l14.142">         // Activate the view and cache the dragged element.</span>
<a href="#l14.143"></a><span id="l14.143">         this._rootView._draggedElt = draggedElt;</span>
<a href="#l14.144"></a><span id="l14.144">         this._rootView.controller.setDataTransfer(event);</span>
<a href="#l14.145"></a><span id="l14.145">         this.setAttribute(&quot;dragstart&quot;, &quot;true&quot;);</span>
<a href="#l14.146"></a><span id="l14.146">         event.stopPropagation();</span>
<a href="#l14.147"></a><span id="l14.147">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineat">@@ -412,17 +415,17 @@</span>
<a href="#l14.149"></a><span id="l14.149">         let anonid = event.originalTarget.getAttribute(&quot;anonid&quot;);</span>
<a href="#l14.150"></a><span id="l14.150">         let scrollDir = 0;</span>
<a href="#l14.151"></a><span id="l14.151">         if (anonid == &quot;scrollbutton-up&quot;) {</span>
<a href="#l14.152"></a><span id="l14.152">           scrollDir = -1;</span>
<a href="#l14.153"></a><span id="l14.153">         } else if (anonid == &quot;scrollbutton-down&quot;) {</span>
<a href="#l14.154"></a><span id="l14.154">           scrollDir = 1;</span>
<a href="#l14.155"></a><span id="l14.155">         }</span>
<a href="#l14.156"></a><span id="l14.156">         if (scrollDir != 0) {</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineminus">-          this._scrollBox.scrollByIndex(scrollDir, false);</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+          this._scrollBox.scrollByIndex(scrollDir, true);</span>
<a href="#l14.159"></a><span id="l14.159">         }</span>
<a href="#l14.160"></a><span id="l14.160"> </span>
<a href="#l14.161"></a><span id="l14.161">         // Check if we should hide the drop indicator for this target.</span>
<a href="#l14.162"></a><span id="l14.162">         if (dropPoint.folderElt || this._hideDropIndicator(event)) {</span>
<a href="#l14.163"></a><span id="l14.163">           this._indicatorBar.hidden = true;</span>
<a href="#l14.164"></a><span id="l14.164">           event.preventDefault();</span>
<a href="#l14.165"></a><span id="l14.165">           event.stopPropagation();</span>
<a href="#l14.166"></a><span id="l14.166">           return;</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineat">@@ -597,17 +600,17 @@</span>
<a href="#l14.168"></a><span id="l14.168">           disablePointerEvents = this.getAttribute(&quot;disablepointereventsfortransition&quot;) == &quot;true&quot;;</span>
<a href="#l14.169"></a><span id="l14.169">         }</span>
<a href="#l14.170"></a><span id="l14.170">         if (!disablePointerEvents) {</span>
<a href="#l14.171"></a><span id="l14.171">           this.style.removeProperty(&quot;pointer-events&quot;);</span>
<a href="#l14.172"></a><span id="l14.172">         }</span>
<a href="#l14.173"></a><span id="l14.173">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l14.174"></a><span id="l14.174">       &lt;handler event=&quot;transitionend&quot;&gt;&lt;![CDATA[</span>
<a href="#l14.175"></a><span id="l14.175">         if (event.originalTarget.getAttribute(&quot;anonid&quot;) == &quot;container&quot; &amp;&amp;</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineminus">-            event.propertyName == &quot;transform&quot;) {</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+            (event.propertyName == &quot;transform&quot; || event.propertyName == &quot;-moz-window-transform&quot;)) {</span>
<a href="#l14.178"></a><span id="l14.178">           this.style.removeProperty(&quot;pointer-events&quot;);</span>
<a href="#l14.179"></a><span id="l14.179">         }</span>
<a href="#l14.180"></a><span id="l14.180">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l14.181"></a><span id="l14.181">       &lt;handler event=&quot;popuphiding&quot; phase=&quot;target&quot;&gt;&lt;![CDATA[</span>
<a href="#l14.182"></a><span id="l14.182">         this.setAttribute(&quot;animate&quot;, &quot;cancel&quot;);</span>
<a href="#l14.183"></a><span id="l14.183">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l14.184"></a><span id="l14.184">       &lt;handler event=&quot;popuphidden&quot; phase=&quot;target&quot;&gt;&lt;![CDATA[</span>
<a href="#l14.185"></a><span id="l14.185">         this.removeAttribute(&quot;panelopen&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/suite/common/places/content/places.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/suite/common/places/content/places.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -37,17 +37,17 @@ var PlacesOrganizer = {</span>
<a href="#l15.4"></a><span id="l15.4">     &quot;editBMPanel_keywordRow&quot;,</span>
<a href="#l15.5"></a><span id="l15.5">   ],</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7">   _initFolderTree() {</span>
<a href="#l15.8"></a><span id="l15.8">     var leftPaneRoot = PlacesUIUtils.leftPaneFolderId;</span>
<a href="#l15.9"></a><span id="l15.9">     this._places.place = &quot;place:excludeItems=1&amp;expandQueries=0&amp;folder=&quot; + leftPaneRoot;</span>
<a href="#l15.10"></a><span id="l15.10">   },</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  selectLeftPaneQuery: function PO_selectLeftPaneQuery(aQueryName) {</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  selectLeftPaneBuiltIn(aQueryName) {</span>
<a href="#l15.14"></a><span id="l15.14">     var itemId = PlacesUIUtils.leftPaneQueries[aQueryName];</span>
<a href="#l15.15"></a><span id="l15.15">     this._places.selectItems([itemId]);</span>
<a href="#l15.16"></a><span id="l15.16">     // Forcefully expand all-bookmarks</span>
<a href="#l15.17"></a><span id="l15.17">     if (aQueryName == &quot;AllBookmarks&quot; || aQueryName == &quot;History&quot;)</span>
<a href="#l15.18"></a><span id="l15.18">       PlacesUtils.asContainer(this._places.selectedNode).containerOpen = true;</span>
<a href="#l15.19"></a><span id="l15.19">   },</span>
<a href="#l15.20"></a><span id="l15.20"> </span>
<a href="#l15.21"></a><span id="l15.21">   /**</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -73,17 +73,17 @@ var PlacesOrganizer = {</span>
<a href="#l15.23"></a><span id="l15.23">         switch (typeof container) {</span>
<a href="#l15.24"></a><span id="l15.24">           case &quot;number&quot;:</span>
<a href="#l15.25"></a><span id="l15.25">             this._places.selectItems([container], false);</span>
<a href="#l15.26"></a><span id="l15.26">             break;</span>
<a href="#l15.27"></a><span id="l15.27">           case &quot;string&quot;:</span>
<a href="#l15.28"></a><span id="l15.28">             if (container.substr(0, 6) == &quot;place:&quot;)</span>
<a href="#l15.29"></a><span id="l15.29">               this._places.selectPlaceURI(container);</span>
<a href="#l15.30"></a><span id="l15.30">             else if (container in PlacesUIUtils.leftPaneQueries)</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-              this.selectLeftPaneQuery(container);</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+              this.selectLeftPaneBuiltIn(container);</span>
<a href="#l15.33"></a><span id="l15.33">             else</span>
<a href="#l15.34"></a><span id="l15.34">               throw new Error(&quot;Invalid container found: &quot; + container);</span>
<a href="#l15.35"></a><span id="l15.35">             break;</span>
<a href="#l15.36"></a><span id="l15.36">           default:</span>
<a href="#l15.37"></a><span id="l15.37">             throw new Error(&quot;Invalid container type found: &quot; + container);</span>
<a href="#l15.38"></a><span id="l15.38">         }</span>
<a href="#l15.39"></a><span id="l15.39">         PlacesUtils.asContainer(this._places.selectedNode).containerOpen = true;</span>
<a href="#l15.40"></a><span id="l15.40">       }</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineat">@@ -119,16 +119,18 @@ var PlacesOrganizer = {</span>
<a href="#l15.42"></a><span id="l15.42"> </span>
<a href="#l15.43"></a><span id="l15.43">     window.addEventListener(&quot;AppCommand&quot;, this, true);</span>
<a href="#l15.44"></a><span id="l15.44"> </span>
<a href="#l15.45"></a><span id="l15.45">     // remove the &quot;Properties&quot; context-menu item, we've our own details pane</span>
<a href="#l15.46"></a><span id="l15.46">     document.getElementById(&quot;placesContext&quot;)</span>
<a href="#l15.47"></a><span id="l15.47">             .removeChild(document.getElementById(&quot;placesContext_show:info&quot;));</span>
<a href="#l15.48"></a><span id="l15.48"> </span>
<a href="#l15.49"></a><span id="l15.49">     ContentArea.focus();</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+    // sync is currently disabled</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+    // gSync.init();</span>
<a href="#l15.52"></a><span id="l15.52">   },</span>
<a href="#l15.53"></a><span id="l15.53"> </span>
<a href="#l15.54"></a><span id="l15.54">   QueryInterface: function PO_QueryInterface(aIID) {</span>
<a href="#l15.55"></a><span id="l15.55">     if (aIID.equals(Ci.nsIDOMEventListener) ||</span>
<a href="#l15.56"></a><span id="l15.56">         aIID.equals(Ci.nsISupports))</span>
<a href="#l15.57"></a><span id="l15.57">       return this;</span>
<a href="#l15.58"></a><span id="l15.58"> </span>
<a href="#l15.59"></a><span id="l15.59">     throw Cr.NS_NOINTERFACE;</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineat">@@ -220,43 +222,36 @@ var PlacesOrganizer = {</span>
<a href="#l15.61"></a><span id="l15.61">    *          deleting its text, this will be false.</span>
<a href="#l15.62"></a><span id="l15.62">    */</span>
<a href="#l15.63"></a><span id="l15.63">   _cachedLeftPaneSelectedURI: null,</span>
<a href="#l15.64"></a><span id="l15.64">   onPlaceSelected: function PO_onPlaceSelected(resetSearchBox) {</span>
<a href="#l15.65"></a><span id="l15.65">     // Don't change the right-hand pane contents when there's no selection.</span>
<a href="#l15.66"></a><span id="l15.66">     if (!this._places.hasSelection)</span>
<a href="#l15.67"></a><span id="l15.67">       return;</span>
<a href="#l15.68"></a><span id="l15.68"> </span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-    var node = this._places.selectedNode;</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-    var queries = PlacesUtils.asQuery(node).getQueries();</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-    // Items are only excluded on the left pane.</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-    var options = node.queryOptions.clone();</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-    options.excludeItems = false;</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-    var placeURI = PlacesUtils.history.queriesToQueryString(queries,</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-                                                            queries.length,</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-                                                            options);</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+    let node = this._places.selectedNode;</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+    let placeURI = node.uri;</span>
<a href="#l15.80"></a><span id="l15.80"> </span>
<a href="#l15.81"></a><span id="l15.81">     // If either the place of the content tree in the right pane has changed or</span>
<a href="#l15.82"></a><span id="l15.82">     // the user cleared the search box, update the place, hide the search UI,</span>
<a href="#l15.83"></a><span id="l15.83">     // and update the back/forward buttons by setting location.</span>
<a href="#l15.84"></a><span id="l15.84">     if (ContentArea.currentPlace != placeURI || !resetSearchBox) {</span>
<a href="#l15.85"></a><span id="l15.85">       ContentArea.currentPlace = placeURI;</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineminus">-      this.location = node.uri;</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+      this.location = placeURI;</span>
<a href="#l15.88"></a><span id="l15.88">     }</span>
<a href="#l15.89"></a><span id="l15.89"> </span>
<a href="#l15.90"></a><span id="l15.90">     // When we invalidate a container we use suppressSelectionEvent, when it is</span>
<a href="#l15.91"></a><span id="l15.91">     // unset a select event is fired, in many cases the selection did not really</span>
<a href="#l15.92"></a><span id="l15.92">     // change, so we should check for it, and return early in such a case. Note</span>
<a href="#l15.93"></a><span id="l15.93">     // that we cannot return any earlier than this point, because when</span>
<a href="#l15.94"></a><span id="l15.94">     // !resetSearchBox, we need to update location and hide the UI as above,</span>
<a href="#l15.95"></a><span id="l15.95">     // even though the selection has not changed.</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-    if (node.uri == this._cachedLeftPaneSelectedURI)</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+    if (placeURI == this._cachedLeftPaneSelectedURI)</span>
<a href="#l15.98"></a><span id="l15.98">       return;</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineminus">-    this._cachedLeftPaneSelectedURI = node.uri;</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+    this._cachedLeftPaneSelectedURI = placeURI;</span>
<a href="#l15.101"></a><span id="l15.101"> </span>
<a href="#l15.102"></a><span id="l15.102">     // At this point, resetSearchBox is true, because the left pane selection</span>
<a href="#l15.103"></a><span id="l15.103">     // has changed; otherwise we would have returned earlier.</span>
<a href="#l15.104"></a><span id="l15.104"> </span>
<a href="#l15.105"></a><span id="l15.105">     PlacesSearchBox.searchFilter.reset();</span>
<a href="#l15.106"></a><span id="l15.106">     this._setSearchScopeForNode(node);</span>
<a href="#l15.107"></a><span id="l15.107">     this.updateDetailsPane();</span>
<a href="#l15.108"></a><span id="l15.108">   },</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineat">@@ -265,17 +260,17 @@ var PlacesOrganizer = {</span>
<a href="#l15.110"></a><span id="l15.110">    * Sets the search scope based on aNode's properties.</span>
<a href="#l15.111"></a><span id="l15.111">    * @param   aNode</span>
<a href="#l15.112"></a><span id="l15.112">    *          the node to set up scope from</span>
<a href="#l15.113"></a><span id="l15.113">    */</span>
<a href="#l15.114"></a><span id="l15.114">   _setSearchScopeForNode: function PO__setScopeForNode(aNode) {</span>
<a href="#l15.115"></a><span id="l15.115">     let itemId = aNode.itemId;</span>
<a href="#l15.116"></a><span id="l15.116"> </span>
<a href="#l15.117"></a><span id="l15.117">     if (PlacesUtils.nodeIsHistoryContainer(aNode) ||</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-        itemId == PlacesUIUtils.leftPaneQueries[&quot;History&quot;]) {</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+        itemId == PlacesUIUtils.leftPaneQueries.History) {</span>
<a href="#l15.120"></a><span id="l15.120">       PlacesQueryBuilder.setScope(&quot;history&quot;);</span>
<a href="#l15.121"></a><span id="l15.121">     } else {</span>
<a href="#l15.122"></a><span id="l15.122">       // Default to All Bookmarks for all other nodes, per bug 469437.</span>
<a href="#l15.123"></a><span id="l15.123">       PlacesQueryBuilder.setScope(&quot;bookmarks&quot;);</span>
<a href="#l15.124"></a><span id="l15.124">     }</span>
<a href="#l15.125"></a><span id="l15.125">   },</span>
<a href="#l15.126"></a><span id="l15.126"> </span>
<a href="#l15.127"></a><span id="l15.127">   /**</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineat">@@ -393,17 +388,17 @@ var PlacesOrganizer = {</span>
<a href="#l15.129"></a><span id="l15.129">    * Populates the restore menu with the dates of the backups available.</span>
<a href="#l15.130"></a><span id="l15.130">    */</span>
<a href="#l15.131"></a><span id="l15.131">   populateRestoreMenu: function PO_populateRestoreMenu() {</span>
<a href="#l15.132"></a><span id="l15.132">     let restorePopup = document.getElementById(&quot;fileRestorePopup&quot;);</span>
<a href="#l15.133"></a><span id="l15.133"> </span>
<a href="#l15.134"></a><span id="l15.134">     const dtOptions = {</span>
<a href="#l15.135"></a><span id="l15.135">       dateStyle: &quot;long&quot;</span>
<a href="#l15.136"></a><span id="l15.136">     };</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-    let dateFormatter = Services.intl.createDateTimeFormat(undefined, dtOptions);</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+    let dateFormatter = new Services.intl.DateTimeFormat(undefined, dtOptions);</span>
<a href="#l15.139"></a><span id="l15.139"> </span>
<a href="#l15.140"></a><span id="l15.140">     // Remove existing menu items.  Last item is the restoreFromFile item.</span>
<a href="#l15.141"></a><span id="l15.141">     while (restorePopup.childNodes.length &gt; 1)</span>
<a href="#l15.142"></a><span id="l15.142">       restorePopup.firstChild.remove();</span>
<a href="#l15.143"></a><span id="l15.143"> </span>
<a href="#l15.144"></a><span id="l15.144">     (async function() {</span>
<a href="#l15.145"></a><span id="l15.145">       let backupFiles = await PlacesBackups.getBackupFiles();</span>
<a href="#l15.146"></a><span id="l15.146">       if (backupFiles.length == 0)</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineat">@@ -456,19 +451,17 @@ var PlacesOrganizer = {</span>
<a href="#l15.148"></a><span id="l15.148">     }</span>
<a href="#l15.149"></a><span id="l15.149">   },</span>
<a href="#l15.150"></a><span id="l15.150"> </span>
<a href="#l15.151"></a><span id="l15.151">   /**</span>
<a href="#l15.152"></a><span id="l15.152">    * Called when 'Choose File...' is selected from the restore menu.</span>
<a href="#l15.153"></a><span id="l15.153">    * Prompts for a file and restores bookmarks to those in the file.</span>
<a href="#l15.154"></a><span id="l15.154">    */</span>
<a href="#l15.155"></a><span id="l15.155">   onRestoreBookmarksFromFile: function PO_onRestoreBookmarksFromFile() {</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineminus">-    let dirSvc = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineminus">-                   .getService(Ci.nsIProperties);</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineminus">-    let backupsDir = dirSvc.get(&quot;Desk&quot;, Ci.nsIFile);</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineplus">+    let backupsDir = Services.dirsvc.get(&quot;Desk&quot;, Ci.nsIFile);</span>
<a href="#l15.160"></a><span id="l15.160">     let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(Ci.nsIFilePicker);</span>
<a href="#l15.161"></a><span id="l15.161">     let fpCallback = aResult =&gt; {</span>
<a href="#l15.162"></a><span id="l15.162">       if (aResult != Ci.nsIFilePicker.returnCancel) {</span>
<a href="#l15.163"></a><span id="l15.163">         this.restoreBookmarksFromFile(fp.file.path);</span>
<a href="#l15.164"></a><span id="l15.164">       }</span>
<a href="#l15.165"></a><span id="l15.165">     };</span>
<a href="#l15.166"></a><span id="l15.166"> </span>
<a href="#l15.167"></a><span id="l15.167">     fp.init(window, PlacesUIUtils.getString(&quot;bookmarksRestoreTitle&quot;),</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineat">@@ -487,55 +480,50 @@ var PlacesOrganizer = {</span>
<a href="#l15.169"></a><span id="l15.169">     // check file extension</span>
<a href="#l15.170"></a><span id="l15.170">     if (!aFilePath.toLowerCase().endsWith(&quot;json&quot;) &amp;&amp;</span>
<a href="#l15.171"></a><span id="l15.171">         !aFilePath.toLowerCase().endsWith(&quot;jsonlz4&quot;)) {</span>
<a href="#l15.172"></a><span id="l15.172">       this._showErrorAlert(PlacesUIUtils.getString(&quot;bookmarksRestoreFormatError&quot;));</span>
<a href="#l15.173"></a><span id="l15.173">       return;</span>
<a href="#l15.174"></a><span id="l15.174">     }</span>
<a href="#l15.175"></a><span id="l15.175"> </span>
<a href="#l15.176"></a><span id="l15.176">     // confirm ok to delete existing bookmarks</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineminus">-    var prompts = Cc[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineminus">-                    .getService(Ci.nsIPromptService);</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineminus">-    if (!prompts.confirm(null,</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineminus">-                         PlacesUIUtils.getString(&quot;bookmarksRestoreAlertTitle&quot;),</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineminus">-                         PlacesUIUtils.getString(&quot;bookmarksRestoreAlert&quot;)))</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineplus">+    if (!Services.prompt.confirm(null,</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineplus">+           PlacesUIUtils.getString(&quot;bookmarksRestoreAlertTitle&quot;),</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineplus">+           PlacesUIUtils.getString(&quot;bookmarksRestoreAlert&quot;)))</span>
<a href="#l15.185"></a><span id="l15.185">       return;</span>
<a href="#l15.186"></a><span id="l15.186"> </span>
<a href="#l15.187"></a><span id="l15.187">     (async function() {</span>
<a href="#l15.188"></a><span id="l15.188">       try {</span>
<a href="#l15.189"></a><span id="l15.189">         await BookmarkJSONUtils.importFromFile(aFilePath, true);</span>
<a href="#l15.190"></a><span id="l15.190">       } catch (ex) {</span>
<a href="#l15.191"></a><span id="l15.191">         PlacesOrganizer._showErrorAlert(PlacesUIUtils.getString(&quot;bookmarksRestoreParseError&quot;));</span>
<a href="#l15.192"></a><span id="l15.192">       }</span>
<a href="#l15.193"></a><span id="l15.193">     })();</span>
<a href="#l15.194"></a><span id="l15.194">   },</span>
<a href="#l15.195"></a><span id="l15.195"> </span>
<a href="#l15.196"></a><span id="l15.196">   _showErrorAlert: function PO__showErrorAlert(aMsg) {</span>
<a href="#l15.197"></a><span id="l15.197">     var brandShortName = document.getElementById(&quot;brandStrings&quot;).</span>
<a href="#l15.198"></a><span id="l15.198">                                   getString(&quot;brandShortName&quot;);</span>
<a href="#l15.199"></a><span id="l15.199"> </span>
<a href="#l15.200"></a><span id="l15.200" class="difflineminus">-    Cc[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineminus">-      .getService(Ci.nsIPromptService)</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineminus">-      .alert(window, brandShortName, aMsg);</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineplus">+    Services.prompt.alert(window, brandShortName, aMsg);</span>
<a href="#l15.204"></a><span id="l15.204">   },</span>
<a href="#l15.205"></a><span id="l15.205"> </span>
<a href="#l15.206"></a><span id="l15.206">   /**</span>
<a href="#l15.207"></a><span id="l15.207">    * Backup bookmarks to desktop, auto-generate a filename with a date.</span>
<a href="#l15.208"></a><span id="l15.208">    * The file is a JSON serialization of bookmarks, tags and any annotations</span>
<a href="#l15.209"></a><span id="l15.209">    * of those items.</span>
<a href="#l15.210"></a><span id="l15.210">    */</span>
<a href="#l15.211"></a><span id="l15.211">   backupBookmarks: function PO_backupBookmarks() {</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineminus">-    let dirSvc = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineminus">-                   .getService(Ci.nsIProperties);</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineminus">-    let backupsDir = dirSvc.get(&quot;Desk&quot;, Ci.nsILocalFile);</span>
<a href="#l15.215"></a><span id="l15.215" class="difflineplus">+    let backupsDir = Services.dirsvc.get(&quot;Desk&quot;, Ci.nsIFile);</span>
<a href="#l15.216"></a><span id="l15.216">     let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(Ci.nsIFilePicker);</span>
<a href="#l15.217"></a><span id="l15.217">     let fpCallback = function fpCallback_done(aResult) {</span>
<a href="#l15.218"></a><span id="l15.218">       if (aResult != Ci.nsIFilePicker.returnCancel) {</span>
<a href="#l15.219"></a><span id="l15.219">         // There is no OS.File version of the filepicker yet (Bug 937812).</span>
<a href="#l15.220"></a><span id="l15.220" class="difflineminus">-        PlacesBackups.saveBookmarksToJSONFile(fp.file.path);</span>
<a href="#l15.221"></a><span id="l15.221" class="difflineplus">+        PlacesBackups.saveBookmarksToJSONFile(fp.file.path)</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineplus">+                     .catch(Cu.reportError);</span>
<a href="#l15.223"></a><span id="l15.223">       }</span>
<a href="#l15.224"></a><span id="l15.224">     };</span>
<a href="#l15.225"></a><span id="l15.225"> </span>
<a href="#l15.226"></a><span id="l15.226">     fp.init(window, PlacesUIUtils.getString(&quot;bookmarksBackupTitle&quot;),</span>
<a href="#l15.227"></a><span id="l15.227">             Ci.nsIFilePicker.modeSave);</span>
<a href="#l15.228"></a><span id="l15.228">     fp.appendFilter(PlacesUIUtils.getString(&quot;bookmarksRestoreFilterName&quot;),</span>
<a href="#l15.229"></a><span id="l15.229">                     RESTORE_FILEPICKER_FILTER_EXT);</span>
<a href="#l15.230"></a><span id="l15.230">     fp.defaultString = PlacesBackups.getFilenameForDate();</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineat">@@ -628,17 +616,17 @@ var PlacesOrganizer = {</span>
<a href="#l15.232"></a><span id="l15.232">       detailsDeck.selectedIndex = 1;</span>
<a href="#l15.233"></a><span id="l15.233"> </span>
<a href="#l15.234"></a><span id="l15.234">       gEditItemOverlay.initPanel({ node: selectedNode,</span>
<a href="#l15.235"></a><span id="l15.235">                                    hiddenRows: [&quot;folderPicker&quot;] });</span>
<a href="#l15.236"></a><span id="l15.236"> </span>
<a href="#l15.237"></a><span id="l15.237">       this._detectAndSetDetailsPaneMinimalState(selectedNode);</span>
<a href="#l15.238"></a><span id="l15.238">     } else if (!selectedNode &amp;&amp; aNodeList[0]) {</span>
<a href="#l15.239"></a><span id="l15.239">       if (aNodeList.every(PlacesUtils.nodeIsURI)) {</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineminus">-        let uris = aNodeList.map(node =&gt; PlacesUtils._uri(node.uri));</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineplus">+        let uris = aNodeList.map(node =&gt; Services.io.newURI(node.uri));</span>
<a href="#l15.242"></a><span id="l15.242">         detailsDeck.selectedIndex = 1;</span>
<a href="#l15.243"></a><span id="l15.243">         gEditItemOverlay.initPanel({ uris,</span>
<a href="#l15.244"></a><span id="l15.244">                                      hiddenRows: [&quot;folderPicker&quot;,</span>
<a href="#l15.245"></a><span id="l15.245">                                                   &quot;loadInSidebar&quot;,</span>
<a href="#l15.246"></a><span id="l15.246">                                                   &quot;location&quot;,</span>
<a href="#l15.247"></a><span id="l15.247">                                                   &quot;keyword&quot;,</span>
<a href="#l15.248"></a><span id="l15.248">                                                   &quot;description&quot;,</span>
<a href="#l15.249"></a><span id="l15.249">                                                   &quot;name&quot;]});</span>
<a href="#l15.250"></a><span id="l15.250" class="difflineat">@@ -764,25 +752,25 @@ var PlacesSearchBox = {</span>
<a href="#l15.251"></a><span id="l15.251">     // XXX this might be to jumpy, maybe should search for &quot;&quot;, so results</span>
<a href="#l15.252"></a><span id="l15.252">     // are ungrouped, and search box not reset</span>
<a href="#l15.253"></a><span id="l15.253">     if (filterString == &quot;&quot;) {</span>
<a href="#l15.254"></a><span id="l15.254">       PO.onPlaceSelected(false);</span>
<a href="#l15.255"></a><span id="l15.255">       return;</span>
<a href="#l15.256"></a><span id="l15.256">     }</span>
<a href="#l15.257"></a><span id="l15.257"> </span>
<a href="#l15.258"></a><span id="l15.258">     let currentView = ContentArea.currentView;</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineminus">-    let currentOptions = PO.getCurrentOptions();</span>
<a href="#l15.260"></a><span id="l15.260"> </span>
<a href="#l15.261"></a><span id="l15.261">     // Search according to the current scope, which was set by</span>
<a href="#l15.262"></a><span id="l15.262">     // PQB_setScope()</span>
<a href="#l15.263"></a><span id="l15.263">     switch (PlacesSearchBox.filterCollection) {</span>
<a href="#l15.264"></a><span id="l15.264">       case &quot;bookmarks&quot;:</span>
<a href="#l15.265"></a><span id="l15.265">         currentView.applyFilter(filterString, this.folders);</span>
<a href="#l15.266"></a><span id="l15.266">         break;</span>
<a href="#l15.267"></a><span id="l15.267">       case &quot;history&quot;: {</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineplus">+        let currentOptions = PO.getCurrentOptions();</span>
<a href="#l15.269"></a><span id="l15.269">         if (currentOptions.queryType != Ci.nsINavHistoryQueryOptions.QUERY_TYPE_HISTORY) {</span>
<a href="#l15.270"></a><span id="l15.270">           let query = PlacesUtils.history.getNewQuery();</span>
<a href="#l15.271"></a><span id="l15.271">           query.searchTerms = filterString;</span>
<a href="#l15.272"></a><span id="l15.272">           let options = currentOptions.clone();</span>
<a href="#l15.273"></a><span id="l15.273">           // Make sure we're getting uri results.</span>
<a href="#l15.274"></a><span id="l15.274">           options.resultType = currentOptions.RESULTS_AS_URI;</span>
<a href="#l15.275"></a><span id="l15.275">           options.queryType = Ci.nsINavHistoryQueryOptions.QUERY_TYPE_HISTORY;</span>
<a href="#l15.276"></a><span id="l15.276">           options.includeHidden = true;</span>
<a href="#l15.277"></a><span id="l15.277" class="difflineat">@@ -856,16 +844,19 @@ var PlacesSearchBox = {</span>
<a href="#l15.278"></a><span id="l15.278">   focus: function PSB_focus() {</span>
<a href="#l15.279"></a><span id="l15.279">     this.searchFilter.focus();</span>
<a href="#l15.280"></a><span id="l15.280">   },</span>
<a href="#l15.281"></a><span id="l15.281"> </span>
<a href="#l15.282"></a><span id="l15.282">   /**</span>
<a href="#l15.283"></a><span id="l15.283">    * Set up the gray text in the search bar as the Places View loads.</span>
<a href="#l15.284"></a><span id="l15.284">    */</span>
<a href="#l15.285"></a><span id="l15.285">   init: function PSB_init() {</span>
<a href="#l15.286"></a><span id="l15.286" class="difflineplus">+    if (Services.prefs.getBoolPref(&quot;browser.urlbar.clickSelectsAll&quot;, false)) {</span>
<a href="#l15.287"></a><span id="l15.287" class="difflineplus">+      this.searchFilter.setAttribute(&quot;clickSelectsAll&quot;, true);</span>
<a href="#l15.288"></a><span id="l15.288" class="difflineplus">+    }</span>
<a href="#l15.289"></a><span id="l15.289">     this.updateCollectionTitle();</span>
<a href="#l15.290"></a><span id="l15.290">   },</span>
<a href="#l15.291"></a><span id="l15.291"> </span>
<a href="#l15.292"></a><span id="l15.292">   /**</span>
<a href="#l15.293"></a><span id="l15.293">    * Gets or sets the text shown in the Places Search Box</span>
<a href="#l15.294"></a><span id="l15.294">    */</span>
<a href="#l15.295"></a><span id="l15.295">   get value() {</span>
<a href="#l15.296"></a><span id="l15.296">     return this.searchFilter.value;</span>
<a href="#l15.297"></a><span id="l15.297" class="difflineat">@@ -1163,17 +1154,17 @@ var ViewMenu = {</span>
<a href="#l15.298"></a><span id="l15.298">     // is invalid, result.sortingMode will be undefined, which has the effect</span>
<a href="#l15.299"></a><span id="l15.299">     // of unsorting the tree.</span>
<a href="#l15.300"></a><span id="l15.300">     aDirection = (aDirection || colLookupTable[columnId].dir).toUpperCase();</span>
<a href="#l15.301"></a><span id="l15.301"> </span>
<a href="#l15.302"></a><span id="l15.302">     var sortConst = &quot;SORT_BY_&quot; + colLookupTable[columnId].key + &quot;_&quot; + aDirection;</span>
<a href="#l15.303"></a><span id="l15.303">     result.sortingAnnotation = colLookupTable[columnId].anno || &quot;&quot;;</span>
<a href="#l15.304"></a><span id="l15.304">     result.sortingMode = Ci.nsINavHistoryQueryOptions[sortConst];</span>
<a href="#l15.305"></a><span id="l15.305">   }</span>
<a href="#l15.306"></a><span id="l15.306" class="difflineminus">-}</span>
<a href="#l15.307"></a><span id="l15.307" class="difflineplus">+};</span>
<a href="#l15.308"></a><span id="l15.308"> </span>
<a href="#l15.309"></a><span id="l15.309"> var ContentArea = {</span>
<a href="#l15.310"></a><span id="l15.310">   _specialViews: new Map(),</span>
<a href="#l15.311"></a><span id="l15.311"> </span>
<a href="#l15.312"></a><span id="l15.312">   init: function CA_init() {</span>
<a href="#l15.313"></a><span id="l15.313">     this._deck = document.getElementById(&quot;placesViewsDeck&quot;);</span>
<a href="#l15.314"></a><span id="l15.314">     this._toolbar = document.getElementById(&quot;placesToolbar&quot;);</span>
<a href="#l15.315"></a><span id="l15.315">     ContentTree.init();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/suite/common/places/content/places.xul</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/suite/common/places/content/places.xul</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -224,17 +224,16 @@</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5">         &lt;!-- help menu filled from globalOverlay --&gt;</span>
<a href="#l16.6"></a><span id="l16.6">         &lt;menu id=&quot;menu_Help&quot;/&gt;</span>
<a href="#l16.7"></a><span id="l16.7">       &lt;/menubar&gt;</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9">       &lt;toolbarspring id=&quot;toolbar-spacer&quot;/&gt;</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11">       &lt;textbox id=&quot;searchFilter&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-               clickSelectsAll=&quot;true&quot;</span>
<a href="#l16.13"></a><span id="l16.13">                type=&quot;search&quot;</span>
<a href="#l16.14"></a><span id="l16.14">                aria-controls=&quot;placeContent&quot;</span>
<a href="#l16.15"></a><span id="l16.15">                oncommand=&quot;PlacesSearchBox.search(this.value);&quot;</span>
<a href="#l16.16"></a><span id="l16.16">                collection=&quot;bookmarks&quot;&gt;</span>
<a href="#l16.17"></a><span id="l16.17">       &lt;/textbox&gt;</span>
<a href="#l16.18"></a><span id="l16.18">     &lt;/toolbar&gt;</span>
<a href="#l16.19"></a><span id="l16.19">   &lt;/toolbox&gt;</span>
<a href="#l16.20"></a><span id="l16.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/suite/common/places/content/placesOverlay.xul</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/suite/common/places/content/placesOverlay.xul</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -11,25 +11,19 @@</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5"> &lt;overlay id=&quot;placesOverlay&quot;</span>
<a href="#l17.6"></a><span id="l17.6">          xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;</span>
<a href="#l17.7"></a><span id="l17.7">          xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l17.10"></a><span id="l17.10">           src=&quot;chrome://global/content/globalOverlay.js&quot;/&gt;</span>
<a href="#l17.11"></a><span id="l17.11">   &lt;script type=&quot;application/javascript&quot;&gt;&lt;![CDATA[</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-    // TODO: Bug 406371.</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-    // A bunch of browser code depends on us defining these, sad but true :(</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-    var Cc = Cc;</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-    var Ci = Ci;</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-    var Cr = Cr;</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-    var Cu = Cu;</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-</span>
<a href="#l17.19"></a><span id="l17.19">     ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-    ChromeUtils.import(&quot;resource://gre/modules/PlacesUtils.jsm&quot;);</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+    ChromeUtils.defineModuleGetter(window,</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+      &quot;PlacesUtils&quot;, &quot;resource://gre/modules/PlacesUtils.jsm&quot;);</span>
<a href="#l17.23"></a><span id="l17.23">     ChromeUtils.defineModuleGetter(window,</span>
<a href="#l17.24"></a><span id="l17.24">       &quot;PlacesUIUtils&quot;, &quot;resource:///modules/PlacesUIUtils.jsm&quot;);</span>
<a href="#l17.25"></a><span id="l17.25">     ChromeUtils.defineModuleGetter(window,</span>
<a href="#l17.26"></a><span id="l17.26">       &quot;PlacesTransactions&quot;, &quot;resource://gre/modules/PlacesTransactions.jsm&quot;);</span>
<a href="#l17.27"></a><span id="l17.27">   ]]&gt;&lt;/script&gt;</span>
<a href="#l17.28"></a><span id="l17.28">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l17.29"></a><span id="l17.29">           src=&quot;chrome://communicator/content/places/controller.js&quot;/&gt;</span>
<a href="#l17.30"></a><span id="l17.30">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineat">@@ -85,16 +79,20 @@</span>
<a href="#l17.32"></a><span id="l17.32">     &lt;command id=&quot;placesCmd_paste&quot;</span>
<a href="#l17.33"></a><span id="l17.33">              oncommand=&quot;goDoPlacesCommand('placesCmd_paste');&quot;/&gt;</span>
<a href="#l17.34"></a><span id="l17.34">     &lt;command id=&quot;placesCmd_delete&quot;</span>
<a href="#l17.35"></a><span id="l17.35">              oncommand=&quot;goDoPlacesCommand('placesCmd_delete');&quot;/&gt;</span>
<a href="#l17.36"></a><span id="l17.36">   &lt;/commandset&gt;</span>
<a href="#l17.37"></a><span id="l17.37"> </span>
<a href="#l17.38"></a><span id="l17.38">   &lt;menupopup id=&quot;placesContext&quot;</span>
<a href="#l17.39"></a><span id="l17.39">              onpopupshowing=&quot;this._view = PlacesUIUtils.getViewForNode(document.popupNode);</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+                             if (!PlacesUIUtils.openInTabClosesMenu) {</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+                               document.getElementById ('placesContext_open:newtab')</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+                               .setAttribute('closemenu', 'single');</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+                             }</span>
<a href="#l17.44"></a><span id="l17.44">                              return this._view.buildContextMenu(this);&quot;</span>
<a href="#l17.45"></a><span id="l17.45">              onpopuphiding=&quot;this._view.destroyContextMenu();&quot;&gt;</span>
<a href="#l17.46"></a><span id="l17.46">     &lt;menuitem id=&quot;placesContext_open&quot;</span>
<a href="#l17.47"></a><span id="l17.47">               command=&quot;placesCmd_open&quot;</span>
<a href="#l17.48"></a><span id="l17.48">               label=&quot;&amp;cmd.open.label;&quot;</span>
<a href="#l17.49"></a><span id="l17.49">               accesskey=&quot;&amp;cmd.open.accesskey;&quot;</span>
<a href="#l17.50"></a><span id="l17.50">               default=&quot;true&quot;</span>
<a href="#l17.51"></a><span id="l17.51">               selectiontype=&quot;single&quot;</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineat">@@ -193,17 +191,16 @@</span>
<a href="#l17.53"></a><span id="l17.53">               forcehideselection=&quot;bookmark&quot;/&gt;</span>
<a href="#l17.54"></a><span id="l17.54">     &lt;menuitem id=&quot;placesContext_deleteHost&quot;</span>
<a href="#l17.55"></a><span id="l17.55">               command=&quot;placesCmd_deleteDataHost&quot;</span>
<a href="#l17.56"></a><span id="l17.56">               label=&quot;&amp;cmd.deleteDomainData.label;&quot;</span>
<a href="#l17.57"></a><span id="l17.57">               accesskey=&quot;&amp;cmd.deleteDomainData.accesskey;&quot;</span>
<a href="#l17.58"></a><span id="l17.58">               closemenu=&quot;single&quot;</span>
<a href="#l17.59"></a><span id="l17.59">               selection=&quot;link|host&quot;</span>
<a href="#l17.60"></a><span id="l17.60">               selectiontype=&quot;single&quot;</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-              hideifprivatebrowsing=&quot;true&quot;</span>
<a href="#l17.62"></a><span id="l17.62">               forcehideselection=&quot;bookmark&quot;/&gt;</span>
<a href="#l17.63"></a><span id="l17.63">     &lt;menuseparator id=&quot;placesContext_deleteSeparator&quot;/&gt;</span>
<a href="#l17.64"></a><span id="l17.64">     &lt;menuitem id=&quot;placesContext_sortBy:name&quot;</span>
<a href="#l17.65"></a><span id="l17.65">               command=&quot;placesCmd_sortBy:name&quot;</span>
<a href="#l17.66"></a><span id="l17.66">               label=&quot;&amp;cmd.sortby_name.label;&quot;</span>
<a href="#l17.67"></a><span id="l17.67">               accesskey=&quot;&amp;cmd.context_sortby_name.accesskey;&quot;</span>
<a href="#l17.68"></a><span id="l17.68">               closemenu=&quot;single&quot;</span>
<a href="#l17.69"></a><span id="l17.69">               selection=&quot;folder&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/suite/common/places/content/sidebarUtils.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/suite/common/places/content/sidebarUtils.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.5"></a><span id="l18.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.6"></a><span id="l18.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8"> ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+window.top.gUIDensity.update();</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11"> var SidebarUtils = {</span>
<a href="#l18.12"></a><span id="l18.12">   handleTreeClick: function SU_handleTreeClick(aTree, aEvent, aGutterSelect) {</span>
<a href="#l18.13"></a><span id="l18.13">     // right-clicks are not handled here</span>
<a href="#l18.14"></a><span id="l18.14">     if (aEvent.button == 2)</span>
<a href="#l18.15"></a><span id="l18.15">       return;</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17">     var tbo = aTree.treeBoxObject;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/suite/common/places/content/tree.xml</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/suite/common/places/content/tree.xml</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -237,25 +237,25 @@</span>
<a href="#l19.4"></a><span id="l19.4">               parents.push(parent);</span>
<a href="#l19.5"></a><span id="l19.5">               parent = parent.parent;</span>
<a href="#l19.6"></a><span id="l19.6">             }</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8">             // Walk the list backwards (opening from the root of the hierarchy)</span>
<a href="#l19.9"></a><span id="l19.9">             // opening each folder as we go.</span>
<a href="#l19.10"></a><span id="l19.10">             for (var i = parents.length - 1; i &gt;= 0; --i) {</span>
<a href="#l19.11"></a><span id="l19.11">               let index = view.treeIndexForNode(parents[i]);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-              if (index != Ci.nsINavHistoryResultTreeViewer.INDEX_INVISIBLE &amp;&amp;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+              if (index != -1 &amp;&amp;</span>
<a href="#l19.14"></a><span id="l19.14">                   view.isContainer(index) &amp;&amp; !view.isContainerOpen(index))</span>
<a href="#l19.15"></a><span id="l19.15">                 view.toggleOpenState(index);</span>
<a href="#l19.16"></a><span id="l19.16">             }</span>
<a href="#l19.17"></a><span id="l19.17">             // Select the specified node...</span>
<a href="#l19.18"></a><span id="l19.18">           }</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20">           let index = view.treeIndexForNode(node);</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-          if (index == Ci.nsINavHistoryResultTreeViewer.INDEX_INVISIBLE)</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+          if (index == -1)</span>
<a href="#l19.23"></a><span id="l19.23">             return;</span>
<a href="#l19.24"></a><span id="l19.24"> </span>
<a href="#l19.25"></a><span id="l19.25">           view.selection.select(index);</span>
<a href="#l19.26"></a><span id="l19.26">           // ... and ensure it's visible, not scrolled off somewhere.</span>
<a href="#l19.27"></a><span id="l19.27">           this.treeBoxObject.ensureRowIsVisible(index);</span>
<a href="#l19.28"></a><span id="l19.28">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.29"></a><span id="l19.29">       &lt;/method&gt;</span>
<a href="#l19.30"></a><span id="l19.30"> </span>
<a href="#l19.31"></a><span id="l19.31" class="difflineat">@@ -466,17 +466,17 @@</span>
<a href="#l19.32"></a><span id="l19.32"> </span>
<a href="#l19.33"></a><span id="l19.33">       &lt;method name=&quot;_getInsertionPoint&quot;&gt;</span>
<a href="#l19.34"></a><span id="l19.34">         &lt;parameter name=&quot;index&quot;/&gt;</span>
<a href="#l19.35"></a><span id="l19.35">         &lt;parameter name=&quot;orientation&quot;/&gt;</span>
<a href="#l19.36"></a><span id="l19.36">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.37"></a><span id="l19.37">           var result = this.result;</span>
<a href="#l19.38"></a><span id="l19.38">           var resultview = this.view;</span>
<a href="#l19.39"></a><span id="l19.39">           var container = result.root;</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-          var dropNearItemId = -1;</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+          var dropNearNode = null;</span>
<a href="#l19.42"></a><span id="l19.42">           NS_ASSERT(container, &quot;null container&quot;);</span>
<a href="#l19.43"></a><span id="l19.43">           // When there's no selection, assume the container is the container</span>
<a href="#l19.44"></a><span id="l19.44">           // the view is populated from (i.e. the result's itemId).</span>
<a href="#l19.45"></a><span id="l19.45">           if (index != -1) {</span>
<a href="#l19.46"></a><span id="l19.46">             var lastSelected = resultview.nodeForTreeIndex(index);</span>
<a href="#l19.47"></a><span id="l19.47">             if (resultview.isContainer(index) &amp;&amp; orientation == Ci.nsITreeView.DROP_ON) {</span>
<a href="#l19.48"></a><span id="l19.48">               // If the last selected item is an open container, append _into_</span>
<a href="#l19.49"></a><span id="l19.49">               // it, rather than insert adjacent to it.</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineat">@@ -495,67 +495,70 @@</span>
<a href="#l19.51"></a><span id="l19.51">               container = lastSelected.parent;</span>
<a href="#l19.52"></a><span id="l19.52"> </span>
<a href="#l19.53"></a><span id="l19.53">               // See comment in the treeView.js's copy of this method</span>
<a href="#l19.54"></a><span id="l19.54">               if (!container || !container.containerOpen)</span>
<a href="#l19.55"></a><span id="l19.55">                 return null;</span>
<a href="#l19.56"></a><span id="l19.56"> </span>
<a href="#l19.57"></a><span id="l19.57">               // Avoid the potentially expensive call to getChildIndex</span>
<a href="#l19.58"></a><span id="l19.58">               // if we know this container doesn't allow insertion</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-              if (PlacesControllerDragHelper.disallowInsertion(container))</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+              if (PlacesControllerDragHelper.disallowInsertion(container, this))</span>
<a href="#l19.61"></a><span id="l19.61">                 return null;</span>
<a href="#l19.62"></a><span id="l19.62"> </span>
<a href="#l19.63"></a><span id="l19.63">               var queryOptions = PlacesUtils.asQuery(result.root).queryOptions;</span>
<a href="#l19.64"></a><span id="l19.64">               if (queryOptions.sortingMode !=</span>
<a href="#l19.65"></a><span id="l19.65">                     Ci.nsINavHistoryQueryOptions.SORT_BY_NONE) {</span>
<a href="#l19.66"></a><span id="l19.66">                 // If we are within a sorted view, insert at the end</span>
<a href="#l19.67"></a><span id="l19.67">                 index = -1;</span>
<a href="#l19.68"></a><span id="l19.68">               } else if (queryOptions.excludeItems ||</span>
<a href="#l19.69"></a><span id="l19.69">                          queryOptions.excludeQueries ||</span>
<a href="#l19.70"></a><span id="l19.70">                          queryOptions.excludeReadOnlyFolders) {</span>
<a href="#l19.71"></a><span id="l19.71">                 // Some item may be invisible, insert near last selected one.</span>
<a href="#l19.72"></a><span id="l19.72">                 // We don't replace index here to avoid requests to the db,</span>
<a href="#l19.73"></a><span id="l19.73">                 // instead it will be calculated later by the controller.</span>
<a href="#l19.74"></a><span id="l19.74">                 index = -1;</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineminus">-                dropNearItemId = lastSelected.itemId;</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+                dropNearNode = lastSelected;</span>
<a href="#l19.77"></a><span id="l19.77">               } else {</span>
<a href="#l19.78"></a><span id="l19.78">                 var lsi = container.getChildIndex(lastSelected);</span>
<a href="#l19.79"></a><span id="l19.79">                 index = orientation == Ci.nsITreeView.DROP_BEFORE ? lsi : lsi + 1;</span>
<a href="#l19.80"></a><span id="l19.80">               }</span>
<a href="#l19.81"></a><span id="l19.81">             }</span>
<a href="#l19.82"></a><span id="l19.82">           }</span>
<a href="#l19.83"></a><span id="l19.83"> </span>
<a href="#l19.84"></a><span id="l19.84" class="difflineminus">-          if (PlacesControllerDragHelper.disallowInsertion(container))</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+          if (PlacesControllerDragHelper.disallowInsertion(container, this))</span>
<a href="#l19.86"></a><span id="l19.86">             return null;</span>
<a href="#l19.87"></a><span id="l19.87"> </span>
<a href="#l19.88"></a><span id="l19.88">           // TODO (Bug 1160193): properly support dropping on a tag root.</span>
<a href="#l19.89"></a><span id="l19.89">           let tagName = null;</span>
<a href="#l19.90"></a><span id="l19.90">           if (PlacesUtils.nodeIsTagQuery(container)) {</span>
<a href="#l19.91"></a><span id="l19.91">             tagName = container.title;</span>
<a href="#l19.92"></a><span id="l19.92">             if (!tagName)</span>
<a href="#l19.93"></a><span id="l19.93">               return null;</span>
<a href="#l19.94"></a><span id="l19.94">           }</span>
<a href="#l19.95"></a><span id="l19.95"> </span>
<a href="#l19.96"></a><span id="l19.96" class="difflineminus">-          return new InsertionPoint(PlacesUtils.getConcreteItemId(container),</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineminus">-                                    index, orientation,</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineminus">-                                    tagName,</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-                                    dropNearItemId);</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+          return new InsertionPoint({</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+            parentId: PlacesUtils.getConcreteItemId(container),</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+            parentGuid: PlacesUtils.getConcreteItemGuid(container),</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+            index, orientation, tagName, dropNearNode</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineplus">+          });</span>
<a href="#l19.105"></a><span id="l19.105">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.106"></a><span id="l19.106">       &lt;/method&gt;</span>
<a href="#l19.107"></a><span id="l19.107"> </span>
<a href="#l19.108"></a><span id="l19.108">       &lt;!-- nsIPlacesView --&gt;</span>
<a href="#l19.109"></a><span id="l19.109">       &lt;method name=&quot;selectAll&quot;&gt;</span>
<a href="#l19.110"></a><span id="l19.110">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.111"></a><span id="l19.111">           this.view.selection.selectAll();</span>
<a href="#l19.112"></a><span id="l19.112">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.113"></a><span id="l19.113">       &lt;/method&gt;</span>
<a href="#l19.114"></a><span id="l19.114"> </span>
<a href="#l19.115"></a><span id="l19.115">       &lt;!-- This method will select the first node in the tree that matches</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineminus">-           each given item id. It will open any folder nodes that it needs</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineplus">+           each given item guid. It will open any folder nodes that it needs</span>
<a href="#l19.118"></a><span id="l19.118">            to in order to show the selected items.</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineplus">+           Note: An array of ids or guids (or a mixture) may be passed as aIDs.</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineplus">+           Passing IDs should be considered deprecated.</span>
<a href="#l19.121"></a><span id="l19.121">       --&gt;</span>
<a href="#l19.122"></a><span id="l19.122">       &lt;method name=&quot;selectItems&quot;&gt;</span>
<a href="#l19.123"></a><span id="l19.123">         &lt;parameter name=&quot;aIDs&quot;/&gt;</span>
<a href="#l19.124"></a><span id="l19.124">         &lt;parameter name=&quot;aOpenContainers&quot;/&gt;</span>
<a href="#l19.125"></a><span id="l19.125">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.126"></a><span id="l19.126">           // Never open containers in flat lists.</span>
<a href="#l19.127"></a><span id="l19.127">           if (this.flatList)</span>
<a href="#l19.128"></a><span id="l19.128">             aOpenContainers = false;</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineat">@@ -592,16 +595,26 @@</span>
<a href="#l19.130"></a><span id="l19.130">             // See if node matches an ID we wanted; add to results.</span>
<a href="#l19.131"></a><span id="l19.131">             // For simple folder queries, check both itemId and the concrete</span>
<a href="#l19.132"></a><span id="l19.132">             // item id.</span>
<a href="#l19.133"></a><span id="l19.133">             var index = ids.indexOf(node.itemId);</span>
<a href="#l19.134"></a><span id="l19.134">             if (index == -1 &amp;&amp;</span>
<a href="#l19.135"></a><span id="l19.135">                 node.type == Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER_SHORTCUT)</span>
<a href="#l19.136"></a><span id="l19.136">               index = ids.indexOf(PlacesUtils.asQuery(node).folderItemId);</span>
<a href="#l19.137"></a><span id="l19.137"> </span>
<a href="#l19.138"></a><span id="l19.138" class="difflineplus">+            if (index == -1) {</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineplus">+              index = ids.indexOf(node.bookmarkGuid);</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineplus">+              if (index == -1) {</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineplus">+                let concreteGuid = PlacesUtils.getConcreteItemGuid(node);</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineplus">+                if (concreteGuid != node.bookmarkGuid) {</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineplus">+                  index = ids.indexOf(concreteGuid);</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineplus">+                }</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineplus">+              }</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineplus">+            }</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineplus">+</span>
<a href="#l19.148"></a><span id="l19.148">             if (index != -1) {</span>
<a href="#l19.149"></a><span id="l19.149">               nodes.push(node);</span>
<a href="#l19.150"></a><span id="l19.150">               foundOne = true;</span>
<a href="#l19.151"></a><span id="l19.151">               ids.splice(index, 1);</span>
<a href="#l19.152"></a><span id="l19.152">             }</span>
<a href="#l19.153"></a><span id="l19.153"> </span>
<a href="#l19.154"></a><span id="l19.154">             var concreteGuid = PlacesUtils.getConcreteItemGuid(node);</span>
<a href="#l19.155"></a><span id="l19.155">             if (ids.length == 0 || !PlacesUtils.nodeIsContainer(node) ||</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineat">@@ -634,17 +647,17 @@</span>
<a href="#l19.157"></a><span id="l19.157">             node.containerOpen = previousOpenness;</span>
<a href="#l19.158"></a><span id="l19.158">             return foundOne;</span>
<a href="#l19.159"></a><span id="l19.159">           }</span>
<a href="#l19.160"></a><span id="l19.160"> </span>
<a href="#l19.161"></a><span id="l19.161">           // Disable notifications while looking for nodes.</span>
<a href="#l19.162"></a><span id="l19.162">           let result = this.result;</span>
<a href="#l19.163"></a><span id="l19.163">           let didSuppressNotifications = result.suppressNotifications;</span>
<a href="#l19.164"></a><span id="l19.164">           if (!didSuppressNotifications)</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineminus">-            result.suppressNotifications = true</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineplus">+            result.suppressNotifications = true;</span>
<a href="#l19.167"></a><span id="l19.167">           try {</span>
<a href="#l19.168"></a><span id="l19.168">             findNodes(this.result.root);</span>
<a href="#l19.169"></a><span id="l19.169">           } finally {</span>
<a href="#l19.170"></a><span id="l19.170">             if (!didSuppressNotifications)</span>
<a href="#l19.171"></a><span id="l19.171">               result.suppressNotifications = false;</span>
<a href="#l19.172"></a><span id="l19.172">           }</span>
<a href="#l19.173"></a><span id="l19.173"> </span>
<a href="#l19.174"></a><span id="l19.174">           // For all the nodes we've found, highlight the corresponding</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineat">@@ -654,17 +667,17 @@</span>
<a href="#l19.176"></a><span id="l19.176">           selection.selectEventsSuppressed = true;</span>
<a href="#l19.177"></a><span id="l19.177">           selection.clearSelection();</span>
<a href="#l19.178"></a><span id="l19.178">           // Open nodes containing found items</span>
<a href="#l19.179"></a><span id="l19.179">           for (let i = 0; i &lt; nodesToOpen.length; i++) {</span>
<a href="#l19.180"></a><span id="l19.180">             nodesToOpen[i].containerOpen = true;</span>
<a href="#l19.181"></a><span id="l19.181">           }</span>
<a href="#l19.182"></a><span id="l19.182">           for (let i = 0; i &lt; nodes.length; i++) {</span>
<a href="#l19.183"></a><span id="l19.183">             var index = resultview.treeIndexForNode(nodes[i]);</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineminus">-            if (index == Ci.nsINavHistoryResultTreeViewer.INDEX_INVISIBLE)</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineplus">+            if (index == -1)</span>
<a href="#l19.186"></a><span id="l19.186">               continue;</span>
<a href="#l19.187"></a><span id="l19.187">             selection.rangedSelect(index, index, true);</span>
<a href="#l19.188"></a><span id="l19.188">           }</span>
<a href="#l19.189"></a><span id="l19.189">           selection.selectEventsSuppressed = false;</span>
<a href="#l19.190"></a><span id="l19.190">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.191"></a><span id="l19.191">       &lt;/method&gt;</span>
<a href="#l19.192"></a><span id="l19.192"> </span>
<a href="#l19.193"></a><span id="l19.193">       &lt;field name=&quot;_contextMenuShown&quot;&gt;false&lt;/field&gt;</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineat">@@ -727,17 +740,17 @@</span>
<a href="#l19.195"></a><span id="l19.195">           if (!node.parent) {</span>
<a href="#l19.196"></a><span id="l19.196">             event.preventDefault();</span>
<a href="#l19.197"></a><span id="l19.197">             event.stopPropagation();</span>
<a href="#l19.198"></a><span id="l19.198">             return;</span>
<a href="#l19.199"></a><span id="l19.199">           }</span>
<a href="#l19.200"></a><span id="l19.200"> </span>
<a href="#l19.201"></a><span id="l19.201">           // If this node is child of a readonly container (e.g. a livemark)</span>
<a href="#l19.202"></a><span id="l19.202">           // or cannot be moved, we must force a copy.</span>
<a href="#l19.203"></a><span id="l19.203" class="difflineminus">-          if (!PlacesControllerDragHelper.canMoveNode(node)) {</span>
<a href="#l19.204"></a><span id="l19.204" class="difflineplus">+          if (!PlacesControllerDragHelper.canMoveNode(node, this)) {</span>
<a href="#l19.205"></a><span id="l19.205">             event.dataTransfer.effectAllowed = &quot;copyLink&quot;;</span>
<a href="#l19.206"></a><span id="l19.206">             break;</span>
<a href="#l19.207"></a><span id="l19.207">           }</span>
<a href="#l19.208"></a><span id="l19.208">         }</span>
<a href="#l19.209"></a><span id="l19.209"> </span>
<a href="#l19.210"></a><span id="l19.210">         this._controller.setDataTransfer(event);</span>
<a href="#l19.211"></a><span id="l19.211">         event.stopPropagation();</span>
<a href="#l19.212"></a><span id="l19.212">       ]]&gt;&lt;/handler&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/suite/common/places/content/treeView.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/suite/common/places/content/treeView.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -2,17 +2,16 @@</span>
<a href="#l20.4"></a><span id="l20.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l20.5"></a><span id="l20.5">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.6"></a><span id="l20.6"> </span>
<a href="#l20.7"></a><span id="l20.7"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l20.8"></a><span id="l20.8"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10"> const PTV_interfaces = [Ci.nsITreeView,</span>
<a href="#l20.11"></a><span id="l20.11">                         Ci.nsINavHistoryResultObserver,</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-                        Ci.nsINavHistoryResultTreeViewer,</span>
<a href="#l20.13"></a><span id="l20.13">                         Ci.nsISupportsWeakReference];</span>
<a href="#l20.14"></a><span id="l20.14"> </span>
<a href="#l20.15"></a><span id="l20.15"> /**</span>
<a href="#l20.16"></a><span id="l20.16">  * This returns the key for any node/details object.</span>
<a href="#l20.17"></a><span id="l20.17">  *</span>
<a href="#l20.18"></a><span id="l20.18">  * @param nodeOrDetails</span>
<a href="#l20.19"></a><span id="l20.19">  *        A node, or an object containing the following properties:</span>
<a href="#l20.20"></a><span id="l20.20">  *        - uri</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineat">@@ -551,29 +550,29 @@ PlacesTreeView.prototype = {</span>
<a href="#l20.22"></a><span id="l20.22">   },</span>
<a href="#l20.23"></a><span id="l20.23"> </span>
<a href="#l20.24"></a><span id="l20.24">   // We use a different formatter for times within the current day,</span>
<a href="#l20.25"></a><span id="l20.25">   // so we cache both a &quot;today&quot; formatter and a general date formatter.</span>
<a href="#l20.26"></a><span id="l20.26">   __todayFormatter: null,</span>
<a href="#l20.27"></a><span id="l20.27">   get _todayFormatter() {</span>
<a href="#l20.28"></a><span id="l20.28">     if (!this.__todayFormatter) {</span>
<a href="#l20.29"></a><span id="l20.29">       const dtOptions = { timeStyle: &quot;short&quot; };</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-      this.__todayFormatter = Services.intl.createDateTimeFormat(undefined, dtOptions);</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+      this.__todayFormatter = new Services.intl.DateTimeFormat(undefined, dtOptions);</span>
<a href="#l20.32"></a><span id="l20.32">     }</span>
<a href="#l20.33"></a><span id="l20.33">     return this.__todayFormatter;</span>
<a href="#l20.34"></a><span id="l20.34">   },</span>
<a href="#l20.35"></a><span id="l20.35"> </span>
<a href="#l20.36"></a><span id="l20.36">   __dateFormatter: null,</span>
<a href="#l20.37"></a><span id="l20.37">   get _dateFormatter() {</span>
<a href="#l20.38"></a><span id="l20.38">     if (!this.__dateFormatter) {</span>
<a href="#l20.39"></a><span id="l20.39">       const dtOptions = {</span>
<a href="#l20.40"></a><span id="l20.40">         dateStyle: &quot;short&quot;,</span>
<a href="#l20.41"></a><span id="l20.41">         timeStyle: &quot;short&quot;</span>
<a href="#l20.42"></a><span id="l20.42">       };</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-      this.__dateFormatter = Services.intl.createDateTimeFormat(undefined, dtOptions);</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+      this.__dateFormatter = new Services.intl.DateTimeFormat(undefined, dtOptions);</span>
<a href="#l20.45"></a><span id="l20.45">     }</span>
<a href="#l20.46"></a><span id="l20.46">     return this.__dateFormatter;</span>
<a href="#l20.47"></a><span id="l20.47">   },</span>
<a href="#l20.48"></a><span id="l20.48"> </span>
<a href="#l20.49"></a><span id="l20.49">   COLUMN_TYPE_UNKNOWN: 0,</span>
<a href="#l20.50"></a><span id="l20.50">   COLUMN_TYPE_TITLE: 1,</span>
<a href="#l20.51"></a><span id="l20.51">   COLUMN_TYPE_URI: 2,</span>
<a href="#l20.52"></a><span id="l20.52">   COLUMN_TYPE_DATE: 3,</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineat">@@ -1188,30 +1187,46 @@ PlacesTreeView.prototype = {</span>
<a href="#l20.54"></a><span id="l20.54"> </span>
<a href="#l20.55"></a><span id="l20.55">     // If the tree is not set yet, setTree will call finishInit.</span>
<a href="#l20.56"></a><span id="l20.56">     if (this._tree &amp;&amp; val)</span>
<a href="#l20.57"></a><span id="l20.57">       this._finishInit();</span>
<a href="#l20.58"></a><span id="l20.58"> </span>
<a href="#l20.59"></a><span id="l20.59">     return val;</span>
<a href="#l20.60"></a><span id="l20.60">   },</span>
<a href="#l20.61"></a><span id="l20.61"> </span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-  nodeForTreeIndex: function PTV_nodeForTreeIndex(aIndex) {</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+  /**</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+   * This allows you to get at the real node for a given row index. This is</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+   * only valid when a tree is attached.</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+   *</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+   * @param {Integer} aIndex The index for the node to get.</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+   * @return {Ci.nsINavHistoryResultNode} The node.</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+   * @throws Cr.NS_ERROR_INVALID_ARG if the index is greater than the number of</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+   *                                 rows.</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+   */</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+  nodeForTreeIndex(aIndex) {</span>
<a href="#l20.73"></a><span id="l20.73">     if (aIndex &gt; this._rows.length)</span>
<a href="#l20.74"></a><span id="l20.74">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l20.75"></a><span id="l20.75"> </span>
<a href="#l20.76"></a><span id="l20.76">     return this._getNodeForRow(aIndex);</span>
<a href="#l20.77"></a><span id="l20.77">   },</span>
<a href="#l20.78"></a><span id="l20.78"> </span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-  treeIndexForNode: function PTV_treeNodeForIndex(aNode) {</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+  /**</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+   * Reverse of nodeForTreeIndex, returns the row index for a given result node.</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+   * The node should be part of the tree.</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+   *</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+   * @param {Ci.nsINavHistoryResultNode} aNode The node to look for in the tree.</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+   * @returns {Integer} The found index, or -1 if the item is not visible or not found.</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+   */</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+  treeIndexForNode(aNode) {</span>
<a href="#l20.88"></a><span id="l20.88">     // The API allows passing invisible nodes.</span>
<a href="#l20.89"></a><span id="l20.89">     try {</span>
<a href="#l20.90"></a><span id="l20.90">       return this._getRowForNode(aNode, true);</span>
<a href="#l20.91"></a><span id="l20.91">     } catch (ex) { }</span>
<a href="#l20.92"></a><span id="l20.92"> </span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-    return Ci.nsINavHistoryResultTreeViewer.INDEX_INVISIBLE;</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+    return -1;</span>
<a href="#l20.95"></a><span id="l20.95">   },</span>
<a href="#l20.96"></a><span id="l20.96"> </span>
<a href="#l20.97"></a><span id="l20.97">   // nsITreeView</span>
<a href="#l20.98"></a><span id="l20.98">   get rowCount() {</span>
<a href="#l20.99"></a><span id="l20.99">     return this._rows.length;</span>
<a href="#l20.100"></a><span id="l20.100">   },</span>
<a href="#l20.101"></a><span id="l20.101">   get selection() {</span>
<a href="#l20.102"></a><span id="l20.102">     return this._selection;</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineat">@@ -1299,36 +1314,31 @@ PlacesTreeView.prototype = {</span>
<a href="#l20.104"></a><span id="l20.104">     return props + &quot; &quot; + properties;</span>
<a href="#l20.105"></a><span id="l20.105">   },</span>
<a href="#l20.106"></a><span id="l20.106"> </span>
<a href="#l20.107"></a><span id="l20.107">   getColumnProperties(aColumn) { return &quot;&quot;; },</span>
<a href="#l20.108"></a><span id="l20.108"> </span>
<a href="#l20.109"></a><span id="l20.109">   isContainer: function PTV_isContainer(aRow) {</span>
<a href="#l20.110"></a><span id="l20.110">     // Only leaf nodes aren't listed in the rows array.</span>
<a href="#l20.111"></a><span id="l20.111">     let node = this._rows[aRow];</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineminus">-    if (node === undefined)</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineplus">+    if (node === undefined || !PlacesUtils.nodeIsContainer(node))</span>
<a href="#l20.114"></a><span id="l20.114">       return false;</span>
<a href="#l20.115"></a><span id="l20.115"> </span>
<a href="#l20.116"></a><span id="l20.116" class="difflineminus">-    if (PlacesUtils.nodeIsContainer(node)) {</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineminus">-      // Flat-lists may ignore expandQueries and other query options when</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineminus">-      // they are asked to open a container.</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineminus">-      if (this._flatList)</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineminus">-        return true;</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineplus">+    // Flat-lists may ignore expandQueries and other query options when</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineplus">+    // they are asked to open a container.</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+    if (this._flatList)</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+      return true;</span>
<a href="#l20.125"></a><span id="l20.125"> </span>
<a href="#l20.126"></a><span id="l20.126" class="difflineminus">-      // treat non-expandable childless queries as non-containers</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineminus">-      if (PlacesUtils.nodeIsQuery(node)) {</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineminus">-        let parent = node.parent;</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineminus">-        if ((PlacesUtils.nodeIsQuery(parent) ||</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineminus">-             PlacesUtils.nodeIsFolder(parent)) &amp;&amp;</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineminus">-            !PlacesUtils.asQuery(node).hasChildren)</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineminus">-          return PlacesUtils.asQuery(parent).queryOptions.expandQueries;</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineminus">-      }</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineminus">-      return true;</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineplus">+    // Treat non-expandable childless queries as non-containers, unless they</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineplus">+    // are tags.</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineplus">+    if (PlacesUtils.nodeIsQuery(node) &amp;&amp; !PlacesUtils.nodeIsTagQuery(node)) {</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineplus">+      PlacesUtils.asQuery(node);</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineplus">+      return node.queryOptions.expandQueries || node.hasChildren;</span>
<a href="#l20.140"></a><span id="l20.140">     }</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-    return false;</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineplus">+    return true;</span>
<a href="#l20.143"></a><span id="l20.143">   },</span>
<a href="#l20.144"></a><span id="l20.144"> </span>
<a href="#l20.145"></a><span id="l20.145">   isContainerOpen: function PTV_isContainerOpen(aRow) {</span>
<a href="#l20.146"></a><span id="l20.146">     if (this._flatList)</span>
<a href="#l20.147"></a><span id="l20.147">       return false;</span>
<a href="#l20.148"></a><span id="l20.148"> </span>
<a href="#l20.149"></a><span id="l20.149">     // All containers are listed in the rows array.</span>
<a href="#l20.150"></a><span id="l20.150">     return this._rows[aRow].containerOpen;</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineat">@@ -1368,17 +1378,17 @@ PlacesTreeView.prototype = {</span>
<a href="#l20.152"></a><span id="l20.152">       return false;</span>
<a href="#l20.153"></a><span id="l20.153"> </span>
<a href="#l20.154"></a><span id="l20.154">     let ip = this._getInsertionPoint(aRow, aOrientation);</span>
<a href="#l20.155"></a><span id="l20.155">     return ip &amp;&amp; PlacesControllerDragHelper.canDrop(ip, aDataTransfer);</span>
<a href="#l20.156"></a><span id="l20.156">   },</span>
<a href="#l20.157"></a><span id="l20.157"> </span>
<a href="#l20.158"></a><span id="l20.158">   _getInsertionPoint: function PTV__getInsertionPoint(index, orientation) {</span>
<a href="#l20.159"></a><span id="l20.159">     let container = this._result.root;</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineminus">-    let dropNearItemId = -1;</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineplus">+    let dropNearNode = null;</span>
<a href="#l20.162"></a><span id="l20.162">     // When there's no selection, assume the container is the container</span>
<a href="#l20.163"></a><span id="l20.163">     // the view is populated from (i.e. the result's itemId).</span>
<a href="#l20.164"></a><span id="l20.164">     if (index != -1) {</span>
<a href="#l20.165"></a><span id="l20.165">       let lastSelected = this.nodeForTreeIndex(index);</span>
<a href="#l20.166"></a><span id="l20.166">       if (this.isContainer(index) &amp;&amp; orientation == Ci.nsITreeView.DROP_ON) {</span>
<a href="#l20.167"></a><span id="l20.167">         // If the last selected item is an open container, append _into_</span>
<a href="#l20.168"></a><span id="l20.168">         // it, rather than insert adjacent to it.</span>
<a href="#l20.169"></a><span id="l20.169">         container = lastSelected;</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineat">@@ -1401,67 +1411,71 @@ PlacesTreeView.prototype = {</span>
<a href="#l20.171"></a><span id="l20.171">         // container here.  However, we can simply bail out when this happens,</span>
<a href="#l20.172"></a><span id="l20.172">         // because we would then be back here in less than a millisecond, when</span>
<a href="#l20.173"></a><span id="l20.173">         // the container had been reopened.</span>
<a href="#l20.174"></a><span id="l20.174">         if (!container || !container.containerOpen)</span>
<a href="#l20.175"></a><span id="l20.175">           return null;</span>
<a href="#l20.176"></a><span id="l20.176"> </span>
<a href="#l20.177"></a><span id="l20.177">         // Avoid the potentially expensive call to getChildIndex</span>
<a href="#l20.178"></a><span id="l20.178">         // if we know this container doesn't allow insertion.</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineminus">-        if (PlacesControllerDragHelper.disallowInsertion(container))</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineplus">+        if (PlacesControllerDragHelper.disallowInsertion(container, this._tree.element))</span>
<a href="#l20.181"></a><span id="l20.181">           return null;</span>
<a href="#l20.182"></a><span id="l20.182"> </span>
<a href="#l20.183"></a><span id="l20.183">         let queryOptions = PlacesUtils.asQuery(this._result.root).queryOptions;</span>
<a href="#l20.184"></a><span id="l20.184">         if (queryOptions.sortingMode !=</span>
<a href="#l20.185"></a><span id="l20.185">               Ci.nsINavHistoryQueryOptions.SORT_BY_NONE) {</span>
<a href="#l20.186"></a><span id="l20.186">           // If we are within a sorted view, insert at the end.</span>
<a href="#l20.187"></a><span id="l20.187">           index = -1;</span>
<a href="#l20.188"></a><span id="l20.188">         } else if (queryOptions.excludeItems ||</span>
<a href="#l20.189"></a><span id="l20.189">                  queryOptions.excludeQueries ||</span>
<a href="#l20.190"></a><span id="l20.190">                  queryOptions.excludeReadOnlyFolders) {</span>
<a href="#l20.191"></a><span id="l20.191">           // Some item may be invisible, insert near last selected one.</span>
<a href="#l20.192"></a><span id="l20.192">           // We don't replace index here to avoid requests to the db,</span>
<a href="#l20.193"></a><span id="l20.193">           // instead it will be calculated later by the controller.</span>
<a href="#l20.194"></a><span id="l20.194">           index = -1;</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineminus">-          dropNearItemId = lastSelected.itemId;</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineplus">+          dropNearNode = lastSelected;</span>
<a href="#l20.197"></a><span id="l20.197">         } else {</span>
<a href="#l20.198"></a><span id="l20.198">           let lsi = container.getChildIndex(lastSelected);</span>
<a href="#l20.199"></a><span id="l20.199">           index = orientation == Ci.nsITreeView.DROP_BEFORE ? lsi : lsi + 1;</span>
<a href="#l20.200"></a><span id="l20.200">         }</span>
<a href="#l20.201"></a><span id="l20.201">       }</span>
<a href="#l20.202"></a><span id="l20.202">     }</span>
<a href="#l20.203"></a><span id="l20.203"> </span>
<a href="#l20.204"></a><span id="l20.204" class="difflineminus">-    if (PlacesControllerDragHelper.disallowInsertion(container))</span>
<a href="#l20.205"></a><span id="l20.205" class="difflineplus">+    if (PlacesControllerDragHelper.disallowInsertion(container, this._tree.element))</span>
<a href="#l20.206"></a><span id="l20.206">       return null;</span>
<a href="#l20.207"></a><span id="l20.207"> </span>
<a href="#l20.208"></a><span id="l20.208">     // TODO (Bug 1160193): properly support dropping on a tag root.</span>
<a href="#l20.209"></a><span id="l20.209">     let tagName = null;</span>
<a href="#l20.210"></a><span id="l20.210">     if (PlacesUtils.nodeIsTagQuery(container)) {</span>
<a href="#l20.211"></a><span id="l20.211">       tagName = container.title;</span>
<a href="#l20.212"></a><span id="l20.212">       if (!tagName)</span>
<a href="#l20.213"></a><span id="l20.213">         return null;</span>
<a href="#l20.214"></a><span id="l20.214">     }</span>
<a href="#l20.215"></a><span id="l20.215"> </span>
<a href="#l20.216"></a><span id="l20.216" class="difflineminus">-    return new InsertionPoint(PlacesUtils.getConcreteItemId(container),</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineminus">-                              index, orientation,</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineminus">-                              tagName,</span>
<a href="#l20.219"></a><span id="l20.219" class="difflineminus">-                              dropNearItemId);</span>
<a href="#l20.220"></a><span id="l20.220" class="difflineplus">+    return new InsertionPoint({</span>
<a href="#l20.221"></a><span id="l20.221" class="difflineplus">+      parentId: PlacesUtils.getConcreteItemId(container),</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineplus">+      parentGuid: PlacesUtils.getConcreteItemGuid(container),</span>
<a href="#l20.223"></a><span id="l20.223" class="difflineplus">+      index, orientation, tagName, dropNearNode</span>
<a href="#l20.224"></a><span id="l20.224" class="difflineplus">+    });</span>
<a href="#l20.225"></a><span id="l20.225">   },</span>
<a href="#l20.226"></a><span id="l20.226"> </span>
<a href="#l20.227"></a><span id="l20.227">   drop: function PTV_drop(aRow, aOrientation, aDataTransfer) {</span>
<a href="#l20.228"></a><span id="l20.228">     // We are responsible for translating the |index| and |orientation|</span>
<a href="#l20.229"></a><span id="l20.229">     // parameters into a container id and index within the container,</span>
<a href="#l20.230"></a><span id="l20.230">     // since this information is specific to the tree view.</span>
<a href="#l20.231"></a><span id="l20.231">     let ip = this._getInsertionPoint(aRow, aOrientation);</span>
<a href="#l20.232"></a><span id="l20.232">     if (ip) {</span>
<a href="#l20.233"></a><span id="l20.233" class="difflineminus">-      PlacesControllerDragHelper.onDrop(ip, aDataTransfer)</span>
<a href="#l20.234"></a><span id="l20.234" class="difflineminus">-                                .catch(Cu.reportError);</span>
<a href="#l20.235"></a><span id="l20.235" class="difflineplus">+      PlacesControllerDragHelper.onDrop(ip, aDataTransfer, this._tree.element)</span>
<a href="#l20.236"></a><span id="l20.236" class="difflineplus">+                                .catch(Cu.reportError)</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineplus">+                                .then(() =&gt; {</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineplus">+                                  // We should only clear the drop target once</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineplus">+                                  // the onDrop is complete, as it is an async function.</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineplus">+                                  PlacesControllerDragHelper.currentDropTarget = null;</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineplus">+                                });</span>
<a href="#l20.242"></a><span id="l20.242">     }</span>
<a href="#l20.243"></a><span id="l20.243" class="difflineminus">-</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineminus">-    PlacesControllerDragHelper.currentDropTarget = null;</span>
<a href="#l20.245"></a><span id="l20.245">   },</span>
<a href="#l20.246"></a><span id="l20.246"> </span>
<a href="#l20.247"></a><span id="l20.247">   getParentIndex: function PTV_getParentIndex(aRow) {</span>
<a href="#l20.248"></a><span id="l20.248">     let [, parentRow] = this._getParentByChildRow(aRow);</span>
<a href="#l20.249"></a><span id="l20.249">     return parentRow;</span>
<a href="#l20.250"></a><span id="l20.250">   },</span>
<a href="#l20.251"></a><span id="l20.251"> </span>
<a href="#l20.252"></a><span id="l20.252">   hasNextSibling: function PTV_hasNextSibling(aRow, aAfterIndex) {</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineat">@@ -1500,17 +1514,16 @@ PlacesTreeView.prototype = {</span>
<a href="#l20.254"></a><span id="l20.254">     // Only the title column has an image.</span>
<a href="#l20.255"></a><span id="l20.255">     if (this._getColumnType(aColumn) != this.COLUMN_TYPE_TITLE)</span>
<a href="#l20.256"></a><span id="l20.256">       return &quot;&quot;;</span>
<a href="#l20.257"></a><span id="l20.257"> </span>
<a href="#l20.258"></a><span id="l20.258">     let node = this._getNodeForRow(aRow);</span>
<a href="#l20.259"></a><span id="l20.259">     return node.icon;</span>
<a href="#l20.260"></a><span id="l20.260">   },</span>
<a href="#l20.261"></a><span id="l20.261"> </span>
<a href="#l20.262"></a><span id="l20.262" class="difflineminus">-  getProgressMode(aRow, aColumn) { },</span>
<a href="#l20.263"></a><span id="l20.263">   getCellValue(aRow, aColumn) { },</span>
<a href="#l20.264"></a><span id="l20.264"> </span>
<a href="#l20.265"></a><span id="l20.265">   getCellText: function PTV_getCellText(aRow, aColumn) {</span>
<a href="#l20.266"></a><span id="l20.266">     let node = this._getNodeForRow(aRow);</span>
<a href="#l20.267"></a><span id="l20.267">     switch (this._getColumnType(aColumn)) {</span>
<a href="#l20.268"></a><span id="l20.268">       case this.COLUMN_TYPE_TITLE:</span>
<a href="#l20.269"></a><span id="l20.269">         // normally, this is just the title, but we don't want empty items in</span>
<a href="#l20.270"></a><span id="l20.270">         // the tree view so return a special string if the title is empty.</span>
<a href="#l20.271"></a><span id="l20.271" class="difflineat">@@ -1729,34 +1742,34 @@ PlacesTreeView.prototype = {</span>
<a href="#l20.272"></a><span id="l20.272">     if (aColumn.index != 0)</span>
<a href="#l20.273"></a><span id="l20.273">       return false;</span>
<a href="#l20.274"></a><span id="l20.274"> </span>
<a href="#l20.275"></a><span id="l20.275">     let node = this._rows[aRow];</span>
<a href="#l20.276"></a><span id="l20.276">     if (!node) {</span>
<a href="#l20.277"></a><span id="l20.277">       Cu.reportError(&quot;isEditable called for an unbuilt row.&quot;);</span>
<a href="#l20.278"></a><span id="l20.278">       return false;</span>
<a href="#l20.279"></a><span id="l20.279">     }</span>
<a href="#l20.280"></a><span id="l20.280" class="difflineminus">-    let itemId = node.itemId;</span>
<a href="#l20.281"></a><span id="l20.281" class="difflineplus">+    let itemGuid = node.bookmarkGuid;</span>
<a href="#l20.282"></a><span id="l20.282"> </span>
<a href="#l20.283"></a><span id="l20.283">     // Only bookmark-nodes are editable.  Fortunately, this checks also takes</span>
<a href="#l20.284"></a><span id="l20.284">     // care of livemark children.</span>
<a href="#l20.285"></a><span id="l20.285" class="difflineminus">-    if (itemId == -1)</span>
<a href="#l20.286"></a><span id="l20.286" class="difflineplus">+    if (itemGuid == &quot;&quot;)</span>
<a href="#l20.287"></a><span id="l20.287">       return false;</span>
<a href="#l20.288"></a><span id="l20.288"> </span>
<a href="#l20.289"></a><span id="l20.289">     // The following items are also not editable, even though they are bookmark</span>
<a href="#l20.290"></a><span id="l20.290">     // items.</span>
<a href="#l20.291"></a><span id="l20.291">     // * places-roots</span>
<a href="#l20.292"></a><span id="l20.292">     // * the left pane special folders and queries (those are place: uri</span>
<a href="#l20.293"></a><span id="l20.293">     //   bookmarks)</span>
<a href="#l20.294"></a><span id="l20.294">     // * separators</span>
<a href="#l20.295"></a><span id="l20.295">     //</span>
<a href="#l20.296"></a><span id="l20.296">     // Note that concrete itemIds aren't used intentionally.  For example, we</span>
<a href="#l20.297"></a><span id="l20.297">     // have no reason to disallow renaming a shortcut to the Bookmarks Toolbar,</span>
<a href="#l20.298"></a><span id="l20.298">     // except for the one under All Bookmarks.</span>
<a href="#l20.299"></a><span id="l20.299" class="difflineminus">-    if (PlacesUtils.nodeIsSeparator(node) || PlacesUtils.isRootItem(itemId))</span>
<a href="#l20.300"></a><span id="l20.300" class="difflineplus">+    if (PlacesUtils.nodeIsSeparator(node) || PlacesUtils.isRootItem(itemGuid))</span>
<a href="#l20.301"></a><span id="l20.301">       return false;</span>
<a href="#l20.302"></a><span id="l20.302"> </span>
<a href="#l20.303"></a><span id="l20.303">     let parentId = PlacesUtils.getConcreteItemId(node.parent);</span>
<a href="#l20.304"></a><span id="l20.304">     if (parentId == PlacesUIUtils.leftPaneFolderId ||</span>
<a href="#l20.305"></a><span id="l20.305">         parentId == PlacesUIUtils.allBookmarksFolderId) {</span>
<a href="#l20.306"></a><span id="l20.306">       // Note that the for the time being this is the check that actually</span>
<a href="#l20.307"></a><span id="l20.307">       // blocks renaming places &quot;roots&quot;, and not the isRootItem check above.</span>
<a href="#l20.308"></a><span id="l20.308">       // That's because places root are only exposed through folder shortcuts</span>
<a href="#l20.309"></a><span id="l20.309" class="difflineat">@@ -1766,21 +1779,16 @@ PlacesTreeView.prototype = {</span>
<a href="#l20.310"></a><span id="l20.310"> </span>
<a href="#l20.311"></a><span id="l20.311">     return true;</span>
<a href="#l20.312"></a><span id="l20.312">   },</span>
<a href="#l20.313"></a><span id="l20.313"> </span>
<a href="#l20.314"></a><span id="l20.314">   setCellText: function PTV_setCellText(aRow, aColumn, aText) {</span>
<a href="#l20.315"></a><span id="l20.315">     // We may only get here if the cell is editable.</span>
<a href="#l20.316"></a><span id="l20.316">     let node = this._rows[aRow];</span>
<a href="#l20.317"></a><span id="l20.317">     if (node.title != aText) {</span>
<a href="#l20.318"></a><span id="l20.318" class="difflineminus">-      if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l20.319"></a><span id="l20.319" class="difflineminus">-        let txn = new PlacesEditItemTitleTransaction(node.itemId, aText);</span>
<a href="#l20.320"></a><span id="l20.320" class="difflineminus">-        PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l20.321"></a><span id="l20.321" class="difflineminus">-        return;</span>
<a href="#l20.322"></a><span id="l20.322" class="difflineminus">-      }</span>
<a href="#l20.323"></a><span id="l20.323">       PlacesTransactions.EditTitle({ guid: node.bookmarkGuid, title: aText })</span>
<a href="#l20.324"></a><span id="l20.324">                         .transact().catch(Cu.reportError);</span>
<a href="#l20.325"></a><span id="l20.325">     }</span>
<a href="#l20.326"></a><span id="l20.326">   },</span>
<a href="#l20.327"></a><span id="l20.327"> </span>
<a href="#l20.328"></a><span id="l20.328">   toggleCutNode: function PTV_toggleCutNode(aNode, aValue) {</span>
<a href="#l20.329"></a><span id="l20.329">     let currentVal = this._cuttingNodes.has(aNode);</span>
<a href="#l20.330"></a><span id="l20.330">     if (currentVal != aValue) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/suite/locales/en-US/chrome/browser/navigator.properties</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/browser/navigator.properties</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -61,16 +61,20 @@ editBookmarkPanel.editBookmarkTitle=Edit</span>
<a href="#l21.4"></a><span id="l21.4"> </span>
<a href="#l21.5"></a><span id="l21.5"> # LOCALIZATION NOTE (editBookmark.removeBookmarks.label)</span>
<a href="#l21.6"></a><span id="l21.6"> # Semi-colon list of plural forms. Replacement for #1 is</span>
<a href="#l21.7"></a><span id="l21.7"> # the number of bookmarks to be removed.</span>
<a href="#l21.8"></a><span id="l21.8"> # If this causes problems with localization you can also do &quot;Remove Bookmarks (#1)&quot;</span>
<a href="#l21.9"></a><span id="l21.9"> # instead of &quot;Remove #1 Bookmarks&quot;.</span>
<a href="#l21.10"></a><span id="l21.10"> editBookmark.removeBookmarks.label=Remove Bookmark;Remove #1 Bookmarks</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+# bookmark dialog strings</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+bookmarkAllTabsDefault=[Folder Name]</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+</span>
<a href="#l21.16"></a><span id="l21.16"> # LOCALIZATION NOTE (addKeywordTitleAutoFill): %S will be replaced by the page's title</span>
<a href="#l21.17"></a><span id="l21.17"> # Used as the bookmark name when saving a keyword for a search field.</span>
<a href="#l21.18"></a><span id="l21.18"> addKeywordTitleAutoFill=Search %S</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20"> extensions.{972ce4c6-7e08-4474-a285-3208198ce6fd}.name=SeaMonkey Default Theme</span>
<a href="#l21.21"></a><span id="l21.21"> extensions.{972ce4c6-7e08-4474-a285-3208198ce6fd}.description=This theme uses styles and colors from the system to fit in with other applications.</span>
<a href="#l21.22"></a><span id="l21.22"> </span>
<a href="#l21.23"></a><span id="l21.23"> extensions.modern@themes.mozilla.org.name=SeaMonkey Modern</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

