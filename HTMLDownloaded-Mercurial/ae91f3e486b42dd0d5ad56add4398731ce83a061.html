<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 20404:ae91f3e486b42dd0d5ad56add4398731ce83a061</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ae91f3e486b42dd0d5ad56add4398731ce83a061" />
<meta property="og:url" content="/comm-central/rev/ae91f3e486b42dd0d5ad56add4398731ce83a061" />
<meta property="og:description" content="Bug 530209 - Fix nsPlacesAutoComplete after adding urlbar suggest prefs. r=mak" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ae91f3e486b42dd0d5ad56add4398731ce83a061 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ae91f3e486b42dd0d5ad56add4398731ce83a061">shortlog</a> |
<a href="/comm-central/log/ae91f3e486b42dd0d5ad56add4398731ce83a061">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ae91f3e486b42dd0d5ad56add4398731ce83a061">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ae91f3e486b42dd0d5ad56add4398731ce83a061">files</a> |
changeset |
<a href="/comm-central/raw-rev/ae91f3e486b42dd0d5ad56add4398731ce83a061">raw</a>  | <a href="/comm-central/archive/ae91f3e486b42dd0d5ad56add4398731ce83a061.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=530209">Bug 530209</a> - Fix nsPlacesAutoComplete after adding urlbar suggest prefs. r=mak
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#108;&#101;&#120;&#32;&#66;&#97;&#114;&#100;&#97;&#115;&#32;&#60;&#97;&#108;&#101;&#120;&#46;&#98;&#97;&#114;&#100;&#97;&#115;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 06 Nov 2014 13:41:00 -0500</td></tr>

<tr>
 <td>changeset 20404</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ae91f3e486b42dd0d5ad56add4398731ce83a061">ae91f3e486b42dd0d5ad56add4398731ce83a061</a></td>
</tr>



<tr>
<td>parent 20403</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/552d04abdfd4255d0da7c35defb56ae6f30caad8">552d04abdfd4255d0da7c35defb56ae6f30caad8</a>
</td>
</tr>

<tr>
<td>child 20405</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/729a567d1708762f3c12239d10b815bee8df9cdb">729a567d1708762f3c12239d10b815bee8df9cdb</a>
</td>
</tr>
<tr>
<td>child 20406</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7bab928ba659ba04ae3e8fed0ee8cfa82be87186">7bab928ba659ba04ae3e8fed0ee8cfa82be87186</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ae91f3e486b42dd0d5ad56add4398731ce83a061">12352</a></td></tr>
<tr><td>push user</td><td>philip.chee@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 27 Sep 2016 08:56:11 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9bd937fc0c12 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de&newProject=comm-central&newRevision=66094254572ec015e4e170847fdebd67a6cf6198&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de&newProject=comm-central&newRevision=66094254572ec015e4e170847fdebd67a6cf6198&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9bd937fc0c12bc6b04247f0da5e1f140bd1441de&newProject=comm-central&newRevision=66094254572ec015e4e170847fdebd67a6cf6198&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mak%29&revcount=50">mak</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=530209">530209</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=530209">Bug 530209</a> - Fix nsPlacesAutoComplete after adding urlbar suggest prefs. r=mak</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/nsPlacesAutoComplete.js">suite/common/places/nsPlacesAutoComplete.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/nsPlacesAutoComplete.js">file</a> |
<a href="/comm-central/annotate/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/nsPlacesAutoComplete.js">annotate</a> |
<a href="/comm-central/diff/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/nsPlacesAutoComplete.js">diff</a> |
<a href="/comm-central/comparison/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/nsPlacesAutoComplete.js">comparison</a> |
<a href="/comm-central/log/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/nsPlacesAutoComplete.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/head_autocomplete.js">suite/common/places/tests/autocomplete/head_autocomplete.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/head_autocomplete.js">file</a> |
<a href="/comm-central/annotate/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/head_autocomplete.js">annotate</a> |
<a href="/comm-central/diff/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/head_autocomplete.js">diff</a> |
<a href="/comm-central/comparison/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/head_autocomplete.js">comparison</a> |
<a href="/comm-central/log/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/head_autocomplete.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/test_empty_search.js">suite/common/places/tests/autocomplete/test_empty_search.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/test_empty_search.js">file</a> |
<a href="/comm-central/annotate/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/test_empty_search.js">annotate</a> |
<a href="/comm-central/diff/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/test_empty_search.js">diff</a> |
<a href="/comm-central/comparison/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/test_empty_search.js">comparison</a> |
<a href="/comm-central/log/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/test_empty_search.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/test_special_search.js">suite/common/places/tests/autocomplete/test_special_search.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/test_special_search.js">file</a> |
<a href="/comm-central/annotate/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/test_special_search.js">annotate</a> |
<a href="/comm-central/diff/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/test_special_search.js">diff</a> |
<a href="/comm-central/comparison/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/test_special_search.js">comparison</a> |
<a href="/comm-central/log/ae91f3e486b42dd0d5ad56add4398731ce83a061/suite/common/places/tests/autocomplete/test_special_search.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/common/places/nsPlacesAutoComplete.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/common/places/nsPlacesAutoComplete.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -340,16 +340,20 @@ function nsPlacesAutoComplete()</span>
<a href="#l1.4"></a><span id="l1.4">       stmt.executeAsync();</span>
<a href="#l1.5"></a><span id="l1.5">       stmt.finalize();</span>
<a href="#l1.6"></a><span id="l1.6">       delete this._openPagesCache;</span>
<a href="#l1.7"></a><span id="l1.7">     }</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9">     return db;</span>
<a href="#l1.10"></a><span id="l1.10">   });</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+  this._customQuery = (conditions = &quot;&quot;) =&gt; {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    return this._db.createAsyncStatement(baseQuery(conditions));</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  };</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+</span>
<a href="#l1.16"></a><span id="l1.16">   XPCOMUtils.defineLazyGetter(this, &quot;_defaultQuery&quot;, function() {</span>
<a href="#l1.17"></a><span id="l1.17">     return this._db.createAsyncStatement(baseQuery());</span>
<a href="#l1.18"></a><span id="l1.18">   });</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20">   XPCOMUtils.defineLazyGetter(this, &quot;_historyQuery&quot;, function() {</span>
<a href="#l1.21"></a><span id="l1.21">     // Enforce ignoring the visit_count index, since the frecency one is much</span>
<a href="#l1.22"></a><span id="l1.22">     // faster in this case.  ANALYZE helps the query planner to figure out the</span>
<a href="#l1.23"></a><span id="l1.23">     // faster path, but it may not have run yet.</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineat">@@ -458,16 +462,17 @@ function nsPlacesAutoComplete()</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.27"></a><span id="l1.27">   //// Initialization</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29">   // load preferences</span>
<a href="#l1.30"></a><span id="l1.30">   this._prefs = Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l1.31"></a><span id="l1.31">                 getService(Ci.nsIPrefService).</span>
<a href="#l1.32"></a><span id="l1.32">                 getBranch(kBrowserUrlbarBranch);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+  this._syncEnabledPref(true);</span>
<a href="#l1.34"></a><span id="l1.34">   this._loadPrefs(true);</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36">   // register observers</span>
<a href="#l1.37"></a><span id="l1.37">   this._os = Cc[&quot;@mozilla.org/observer-service;1&quot;].</span>
<a href="#l1.38"></a><span id="l1.38">               getService(Ci.nsIObserverService);</span>
<a href="#l1.39"></a><span id="l1.39">   this._os.addObserver(this, kTopicShutdown, false);</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41"> }</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineat">@@ -521,18 +526,23 @@ nsPlacesAutoComplete.prototype = {</span>
<a href="#l1.43"></a><span id="l1.43">     // 3) open pages not supported by history (this._openPagesQuery)</span>
<a href="#l1.44"></a><span id="l1.44">     // 4) query from this._getSearch</span>
<a href="#l1.45"></a><span id="l1.45">     // (1) only gets ran if we get any filtered tokens from this._getSearch,</span>
<a href="#l1.46"></a><span id="l1.46">     // since if there are no tokens, there is nothing to match, so there is no</span>
<a href="#l1.47"></a><span id="l1.47">     // reason to run the query).</span>
<a href="#l1.48"></a><span id="l1.48">     let {query, tokens} =</span>
<a href="#l1.49"></a><span id="l1.49">       this._getSearch(this._getUnfilteredSearchTokens(this._currentSearchString));</span>
<a href="#l1.50"></a><span id="l1.50">     let queries = tokens.length ?</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-      [this._getBoundKeywordQuery(tokens), this._getBoundAdaptiveQuery(), this._getBoundOpenPagesQuery(tokens), query] :</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-      [this._getBoundAdaptiveQuery(), this._getBoundOpenPagesQuery(tokens), query];</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+      [this._getBoundKeywordQuery(tokens), this._getBoundAdaptiveQuery()] :</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+      [this._getBoundAdaptiveQuery()];</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+    if (this._hasBehavior(&quot;openpage&quot;)) {</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+      queries.push(this._getBoundOpenPagesQuery(tokens));</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+    }</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+    queries.push(query);</span>
<a href="#l1.60"></a><span id="l1.60"> </span>
<a href="#l1.61"></a><span id="l1.61">     // Start executing our queries.</span>
<a href="#l1.62"></a><span id="l1.62">     this._telemetryStartTime = Date.now();</span>
<a href="#l1.63"></a><span id="l1.63">     this._executeQueries(queries);</span>
<a href="#l1.64"></a><span id="l1.64"> </span>
<a href="#l1.65"></a><span id="l1.65">     // Set up our persistent state for the duration of the search.</span>
<a href="#l1.66"></a><span id="l1.66">     this._searchTokens = tokens;</span>
<a href="#l1.67"></a><span id="l1.67">     this._usedPlaces = {};</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineat">@@ -683,17 +693,17 @@ nsPlacesAutoComplete.prototype = {</span>
<a href="#l1.69"></a><span id="l1.69">         }</span>
<a href="#l1.70"></a><span id="l1.70">       }</span>
<a href="#l1.71"></a><span id="l1.71"> </span>
<a href="#l1.72"></a><span id="l1.72">       if (this._databaseInitialized) {</span>
<a href="#l1.73"></a><span id="l1.73">         this._db.asyncClose();</span>
<a href="#l1.74"></a><span id="l1.74">       }</span>
<a href="#l1.75"></a><span id="l1.75">     }</span>
<a href="#l1.76"></a><span id="l1.76">     else if (aTopic == kPrefChanged) {</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-      this._loadPrefs();</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+      this._loadPrefs(aSubject, aTopic, aData);</span>
<a href="#l1.79"></a><span id="l1.79">     }</span>
<a href="#l1.80"></a><span id="l1.80">   },</span>
<a href="#l1.81"></a><span id="l1.81"> </span>
<a href="#l1.82"></a><span id="l1.82">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.83"></a><span id="l1.83">   //// nsPlacesAutoComplete</span>
<a href="#l1.84"></a><span id="l1.84"> </span>
<a href="#l1.85"></a><span id="l1.85">   get _databaseInitialized()</span>
<a href="#l1.86"></a><span id="l1.86">     Object.getOwnPropertyDescriptor(this, &quot;_db&quot;).value !== undefined,</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineat">@@ -792,23 +802,61 @@ nsPlacesAutoComplete.prototype = {</span>
<a href="#l1.88"></a><span id="l1.88">           Components.utils.reportError(&quot;Unable to report telemetry.&quot;);</span>
<a href="#l1.89"></a><span id="l1.89">         }</span>
<a href="#l1.90"></a><span id="l1.90">       }</span>
<a href="#l1.91"></a><span id="l1.91">       this._telemetryStartTime = null;</span>
<a href="#l1.92"></a><span id="l1.92">     }</span>
<a href="#l1.93"></a><span id="l1.93">   },</span>
<a href="#l1.94"></a><span id="l1.94"> </span>
<a href="#l1.95"></a><span id="l1.95">   /**</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+   * Synchronize suggest.* prefs with autocomplete.enabled.</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+   */</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+  _syncEnabledPref: function PAC_syncEnabledPref(init = false)</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+  {</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+    let suggestPrefs = [&quot;suggest.history&quot;, &quot;suggest.bookmark&quot;, &quot;suggest.openpage&quot;];</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+    let types = [&quot;History&quot;, &quot;Bookmark&quot;, &quot;Openpage&quot;, &quot;Typed&quot;];</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+    if (init) {</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+      // Make sure to initialize the properties when first called with init = true.</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+      this._enabled = safePrefGetter(this._prefs, kBrowserUrlbarAutocompleteEnabledPref,</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+                                     true);</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+      this._suggestHistory = safePrefGetter(this._prefs, &quot;suggest.history&quot;, true);</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+      this._suggestBookmark = safePrefGetter(this._prefs, &quot;suggest.bookmark&quot;, true);</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+      this._suggestOpenpage = safePrefGetter(this._prefs, &quot;suggest.openpage&quot;, true);</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+      this._suggestTyped = safePrefGetter(this._prefs, &quot;suggest.history.onlyTyped&quot;, false);</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+    }</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+    if (this._enabled) {</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+      // If the autocomplete preference is active, activate all suggest</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+      // preferences only if all of them are false.</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+      if (types.every(type =&gt; this[&quot;_suggest&quot; + type] == false)) {</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+        for (let type of suggestPrefs) {</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+          this._prefs.setBoolPref(type, true);</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+        }</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+      }</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+    } else {</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+      // If the preference was deactivated, deactivate all suggest preferences.</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+      for (let type of suggestPrefs) {</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+        this._prefs.setBoolPref(type, false);</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+      }</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+    }</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+  },</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+  /**</span>
<a href="#l1.130"></a><span id="l1.130">    * Loads the preferences that we care about.</span>
<a href="#l1.131"></a><span id="l1.131">    *</span>
<a href="#l1.132"></a><span id="l1.132">    * @param [optional] aRegisterObserver</span>
<a href="#l1.133"></a><span id="l1.133">    *        Indicates if the preference observer should be added or not.  The</span>
<a href="#l1.134"></a><span id="l1.134">    *        default value is false.</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+   * @param [optional] aTopic</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+   *        Observer's topic, if any.</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+   * @param [optional] aSubject</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+   *        Observer's subject, if any.</span>
<a href="#l1.139"></a><span id="l1.139">    */</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-  _loadPrefs: function PAC_loadPrefs(aRegisterObserver)</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+  _loadPrefs: function PAC_loadPrefs(aRegisterObserver, aTopic, aData)</span>
<a href="#l1.142"></a><span id="l1.142">   {</span>
<a href="#l1.143"></a><span id="l1.143">     this._enabled = safePrefGetter(this._prefs,</span>
<a href="#l1.144"></a><span id="l1.144">                                    kBrowserUrlbarAutocompleteEnabledPref,</span>
<a href="#l1.145"></a><span id="l1.145">                                    true);</span>
<a href="#l1.146"></a><span id="l1.146">     this._matchBehavior = safePrefGetter(this._prefs,</span>
<a href="#l1.147"></a><span id="l1.147">                                          &quot;matchBehavior&quot;,</span>
<a href="#l1.148"></a><span id="l1.148">                                          MATCH_BOUNDARY_ANYWHERE);</span>
<a href="#l1.149"></a><span id="l1.149">     this._filterJavaScript = safePrefGetter(this._prefs, &quot;filter.javascript&quot;, true);</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineat">@@ -818,76 +866,115 @@ nsPlacesAutoComplete.prototype = {</span>
<a href="#l1.151"></a><span id="l1.151">     this._restrictBookmarkToken = safePrefGetter(this._prefs,</span>
<a href="#l1.152"></a><span id="l1.152">                                                  &quot;restrict.bookmark&quot;, &quot;*&quot;);</span>
<a href="#l1.153"></a><span id="l1.153">     this._restrictTypedToken = safePrefGetter(this._prefs, &quot;restrict.typed&quot;, &quot;~&quot;);</span>
<a href="#l1.154"></a><span id="l1.154">     this._restrictTagToken = safePrefGetter(this._prefs, &quot;restrict.tag&quot;, &quot;+&quot;);</span>
<a href="#l1.155"></a><span id="l1.155">     this._restrictOpenPageToken = safePrefGetter(this._prefs,</span>
<a href="#l1.156"></a><span id="l1.156">                                                  &quot;restrict.openpage&quot;, &quot;%&quot;);</span>
<a href="#l1.157"></a><span id="l1.157">     this._matchTitleToken = safePrefGetter(this._prefs, &quot;match.title&quot;, &quot;#&quot;);</span>
<a href="#l1.158"></a><span id="l1.158">     this._matchURLToken = safePrefGetter(this._prefs, &quot;match.url&quot;, &quot;@&quot;);</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-    this._defaultBehavior = safePrefGetter(this._prefs, &quot;default.behavior&quot;, 0);</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+    this._suggestHistory = safePrefGetter(this._prefs, &quot;suggest.history&quot;, true);</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+    this._suggestBookmark = safePrefGetter(this._prefs, &quot;suggest.bookmark&quot;, true);</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+    this._suggestOpenpage = safePrefGetter(this._prefs, &quot;suggest.openpage&quot;, true);</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+    this._suggestTyped = safePrefGetter(this._prefs, &quot;suggest.history.onlyTyped&quot;, false);</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+    // If history is not set, onlyTyped value should be ignored.</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+    if (!this._suggestHistory) {</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+      this._suggestTyped = false;</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+    }</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+    let types = [&quot;History&quot;, &quot;Bookmark&quot;, &quot;Openpage&quot;, &quot;Typed&quot;];</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+    this._defaultBehavior = types.reduce((memo, type) =&gt; {</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+      let prefValue = this[&quot;_suggest&quot; + type];</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+      return memo | (prefValue &amp;&amp;</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+                     Ci.mozIPlacesAutoComplete[&quot;BEHAVIOR_&quot; + type.toUpperCase()]);</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+    }, 0);</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+</span>
<a href="#l1.177"></a><span id="l1.177">     // Further restrictions to apply for &quot;empty searches&quot; (i.e. searches for &quot;&quot;).</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-    this._emptySearchDefaultBehavior =</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-      this._defaultBehavior |</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-      safePrefGetter(this._prefs, &quot;default.behavior.emptyRestriction&quot;,</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-                     Ci.mozIPlacesAutoComplete.BEHAVIOR_HISTORY |</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-                     Ci.mozIPlacesAutoComplete.BEHAVIOR_TYPED);</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+    // The empty behavior is typed history, if history is enabled. Otherwise,</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineplus">+    // it is bookmarks, if they are enabled. If both history and bookmarks are disabled,</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineplus">+    // it defaults to open pages.</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+    this._emptySearchDefaultBehavior = Ci.mozIPlacesAutoComplete.BEHAVIOR_RESTRICT;</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineplus">+    if (this._suggestHistory) {</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineplus">+      this._emptySearchDefaultBehavior |= Ci.mozIPlacesAutoComplete.BEHAVIOR_HISTORY |</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+                                          Ci.mozIPlacesAutoComplete.BEHAVIOR_TYPED;</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+    } else if (this._suggestBookmark) {</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+      this._emptySearchDefaultBehavior |= Ci.mozIPlacesAutoComplete.BEHAVIOR_BOOKMARK;</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+    } else {</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+      this._emptySearchDefaultBehavior |= Ci.mozIPlacesAutoComplete.BEHAVIOR_OPENPAGE;</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+    }</span>
<a href="#l1.195"></a><span id="l1.195"> </span>
<a href="#l1.196"></a><span id="l1.196">     // Validate matchBehavior; default to MATCH_BOUNDARY_ANYWHERE.</span>
<a href="#l1.197"></a><span id="l1.197">     if (this._matchBehavior != MATCH_ANYWHERE &amp;&amp;</span>
<a href="#l1.198"></a><span id="l1.198">         this._matchBehavior != MATCH_BOUNDARY &amp;&amp;</span>
<a href="#l1.199"></a><span id="l1.199">         this._matchBehavior != MATCH_BEGINNING) {</span>
<a href="#l1.200"></a><span id="l1.200">       this._matchBehavior = MATCH_BOUNDARY_ANYWHERE;</span>
<a href="#l1.201"></a><span id="l1.201">     }</span>
<a href="#l1.202"></a><span id="l1.202">     // register observer</span>
<a href="#l1.203"></a><span id="l1.203">     if (aRegisterObserver) {</span>
<a href="#l1.204"></a><span id="l1.204">       this._prefs.addObserver(&quot;&quot;, this, false);</span>
<a href="#l1.205"></a><span id="l1.205">     }</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+    // Synchronize suggest.* prefs with autocomplete.enabled every time</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+    // autocomplete.enabled is changed.</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+    if (aData == kBrowserUrlbarAutocompleteEnabledPref) {</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+      this._syncEnabledPref();</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+    }</span>
<a href="#l1.212"></a><span id="l1.212">   },</span>
<a href="#l1.213"></a><span id="l1.213"> </span>
<a href="#l1.214"></a><span id="l1.214">   /**</span>
<a href="#l1.215"></a><span id="l1.215">    * Given an array of tokens, this function determines which query should be</span>
<a href="#l1.216"></a><span id="l1.216">    * ran.  It also removes any special search tokens.</span>
<a href="#l1.217"></a><span id="l1.217">    *</span>
<a href="#l1.218"></a><span id="l1.218">    * @param aTokens</span>
<a href="#l1.219"></a><span id="l1.219">    *        An array of search tokens.</span>
<a href="#l1.220"></a><span id="l1.220">    * @return an object with two properties:</span>
<a href="#l1.221"></a><span id="l1.221">    *         query: the correctly optimized, bound query to search the database</span>
<a href="#l1.222"></a><span id="l1.222">    *                with.</span>
<a href="#l1.223"></a><span id="l1.223">    *         tokens: the filtered list of tokens to search with.</span>
<a href="#l1.224"></a><span id="l1.224">    */</span>
<a href="#l1.225"></a><span id="l1.225">   _getSearch: function PAC_getSearch(aTokens)</span>
<a href="#l1.226"></a><span id="l1.226">   {</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+    let foundToken = false;</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+    let restrict = (behavior) =&gt; {</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+      if (!foundToken) {</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+        this._behavior = 0;</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+        this._setBehavior(&quot;restrict&quot;);</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+        foundToken = true;</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+      }</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+      this._setBehavior(behavior);</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+    };</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+</span>
<a href="#l1.237"></a><span id="l1.237">     // Set the proper behavior so our call to _getBoundSearchQuery gives us the</span>
<a href="#l1.238"></a><span id="l1.238">     // correct query.</span>
<a href="#l1.239"></a><span id="l1.239">     for (let i = aTokens.length - 1; i &gt;= 0; i--) {</span>
<a href="#l1.240"></a><span id="l1.240">       switch (aTokens[i]) {</span>
<a href="#l1.241"></a><span id="l1.241">         case this._restrictHistoryToken:</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineminus">-          this._setBehavior(&quot;history&quot;);</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+          restrict(&quot;history&quot;);</span>
<a href="#l1.244"></a><span id="l1.244">           break;</span>
<a href="#l1.245"></a><span id="l1.245">         case this._restrictBookmarkToken:</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-          this._setBehavior(&quot;bookmark&quot;);</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineplus">+          restrict(&quot;bookmark&quot;);</span>
<a href="#l1.248"></a><span id="l1.248">           break;</span>
<a href="#l1.249"></a><span id="l1.249">         case this._restrictTagToken:</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-          this._setBehavior(&quot;tag&quot;);</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+          restrict(&quot;tag&quot;);</span>
<a href="#l1.252"></a><span id="l1.252">           break;</span>
<a href="#l1.253"></a><span id="l1.253">         case this._restrictOpenPageToken:</span>
<a href="#l1.254"></a><span id="l1.254">           if (!this._enableActions) {</span>
<a href="#l1.255"></a><span id="l1.255">             continue;</span>
<a href="#l1.256"></a><span id="l1.256">           }</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineminus">-          this._setBehavior(&quot;openpage&quot;);</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+          restrict(&quot;openpage&quot;);</span>
<a href="#l1.259"></a><span id="l1.259">           break;</span>
<a href="#l1.260"></a><span id="l1.260">         case this._matchTitleToken:</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">-          this._setBehavior(&quot;title&quot;);</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineplus">+          restrict(&quot;title&quot;);</span>
<a href="#l1.263"></a><span id="l1.263">           break;</span>
<a href="#l1.264"></a><span id="l1.264">         case this._matchURLToken:</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineminus">-          this._setBehavior(&quot;url&quot;);</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+          restrict(&quot;url&quot;);</span>
<a href="#l1.267"></a><span id="l1.267">           break;</span>
<a href="#l1.268"></a><span id="l1.268">         case this._restrictTypedToken:</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-          this._setBehavior(&quot;typed&quot;);</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+          restrict(&quot;typed&quot;);</span>
<a href="#l1.271"></a><span id="l1.271">           break;</span>
<a href="#l1.272"></a><span id="l1.272">         default:</span>
<a href="#l1.273"></a><span id="l1.273">           // We do not want to remove the token if we did not match.</span>
<a href="#l1.274"></a><span id="l1.274">           continue;</span>
<a href="#l1.275"></a><span id="l1.275">       };</span>
<a href="#l1.276"></a><span id="l1.276"> </span>
<a href="#l1.277"></a><span id="l1.277">       aTokens.splice(i, 1);</span>
<a href="#l1.278"></a><span id="l1.278">     }</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineat">@@ -901,43 +988,65 @@ nsPlacesAutoComplete.prototype = {</span>
<a href="#l1.280"></a><span id="l1.280"> </span>
<a href="#l1.281"></a><span id="l1.281">     return {</span>
<a href="#l1.282"></a><span id="l1.282">       query: this._getBoundSearchQuery(this._matchBehavior, aTokens),</span>
<a href="#l1.283"></a><span id="l1.283">       tokens: aTokens</span>
<a href="#l1.284"></a><span id="l1.284">     };</span>
<a href="#l1.285"></a><span id="l1.285">   },</span>
<a href="#l1.286"></a><span id="l1.286"> </span>
<a href="#l1.287"></a><span id="l1.287">   /**</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineplus">+   * @return a string consisting of the search query to be used based on the</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineplus">+   * previously set urlbar suggestion preferences.</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineplus">+   */</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineplus">+  _getSuggestionPrefQuery: function PAC_getSuggestionPrefQuery()</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineplus">+  {</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineplus">+    if (!this._hasBehavior(&quot;restrict&quot;) &amp;&amp; this._hasBehavior(&quot;history&quot;) &amp;&amp;</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+        this._hasBehavior(&quot;bookmark&quot;)) {</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+      return this._hasBehavior(&quot;typed&quot;) ? this._customQuery(&quot;AND h.typed = 1&quot;)</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+                                        : this._defaultQuery;</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+    }</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+    let conditions = [];</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+    if (this._hasBehavior(&quot;history&quot;)) {</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineplus">+      // Enforce ignoring the visit_count index, since the frecency one is much</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineplus">+      // faster in this case.  ANALYZE helps the query planner to figure out the</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineplus">+      // faster path, but it may not have up-to-date information yet.</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineplus">+      conditions.push(&quot;+h.visit_count &gt; 0&quot;);</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineplus">+    }</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineplus">+    if (this._hasBehavior(&quot;typed&quot;)) {</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineplus">+      conditions.push(&quot;h.typed = 1&quot;);</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineplus">+    }</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineplus">+    if (this._hasBehavior(&quot;bookmark&quot;)) {</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineplus">+      conditions.push(&quot;bookmarked&quot;);</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineplus">+    }</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineplus">+    if (this._hasBehavior(&quot;tag&quot;)) {</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineplus">+      conditions.push(&quot;tags NOTNULL&quot;);</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineplus">+    }</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineplus">+</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineplus">+    return conditions.length ? this._customQuery(&quot;AND &quot; + conditions.join(&quot; AND &quot;))</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineplus">+                             : this._defaultQuery;</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineplus">+  },</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineplus">+</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineplus">+  /**</span>
<a href="#l1.320"></a><span id="l1.320">    * Obtains the search query to be used based on the previously set search</span>
<a href="#l1.321"></a><span id="l1.321">    * behaviors (accessed by this._hasBehavior).  The query is bound and ready to</span>
<a href="#l1.322"></a><span id="l1.322">    * execute.</span>
<a href="#l1.323"></a><span id="l1.323">    *</span>
<a href="#l1.324"></a><span id="l1.324">    * @param aMatchBehavior</span>
<a href="#l1.325"></a><span id="l1.325">    *        How this query should match its tokens to the search string.</span>
<a href="#l1.326"></a><span id="l1.326">    * @param aTokens</span>
<a href="#l1.327"></a><span id="l1.327">    *        An array of search tokens.</span>
<a href="#l1.328"></a><span id="l1.328">    * @return the correctly optimized query to search the database with and the</span>
<a href="#l1.329"></a><span id="l1.329">    *         new list of tokens to search with.  The query has all the needed</span>
<a href="#l1.330"></a><span id="l1.330">    *         parameters bound, so consumers can execute it without doing any</span>
<a href="#l1.331"></a><span id="l1.331">    *         additional work.</span>
<a href="#l1.332"></a><span id="l1.332">    */</span>
<a href="#l1.333"></a><span id="l1.333">   _getBoundSearchQuery: function PAC_getBoundSearchQuery(aMatchBehavior,</span>
<a href="#l1.334"></a><span id="l1.334">                                                          aTokens)</span>
<a href="#l1.335"></a><span id="l1.335">   {</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineminus">-    // We use more optimized queries for restricted searches, so we will always</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineminus">-    // return the most restrictive one to the least restrictive one if more than</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineminus">-    // one token is found.</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineminus">-    // Note: &quot;openpages&quot; behavior is supported by the default query.</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineminus">-    //       _openPagesQuery instead returns only pages not supported by</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineminus">-    //       history and it is always executed.</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineminus">-    let query = this._hasBehavior(&quot;tag&quot;) ? this._tagsQuery :</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineminus">-                this._hasBehavior(&quot;bookmark&quot;) ? this._bookmarkQuery :</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineminus">-                this._hasBehavior(&quot;typed&quot;) ? this._typedQuery :</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineminus">-                this._hasBehavior(&quot;history&quot;) ? this._historyQuery :</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineminus">-                this._defaultQuery;</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineplus">+    let query = this._getSuggestionPrefQuery();</span>
<a href="#l1.348"></a><span id="l1.348"> </span>
<a href="#l1.349"></a><span id="l1.349">     // Bind the needed parameters to the query so consumers can use it.</span>
<a href="#l1.350"></a><span id="l1.350">     let (params = query.params) {</span>
<a href="#l1.351"></a><span id="l1.351">       params.parent = PlacesUtils.tagsFolderId;</span>
<a href="#l1.352"></a><span id="l1.352">       params.query_type = kQueryTypeFiltered;</span>
<a href="#l1.353"></a><span id="l1.353">       params.matchBehavior = aMatchBehavior;</span>
<a href="#l1.354"></a><span id="l1.354">       params.searchBehavior = this._behavior;</span>
<a href="#l1.355"></a><span id="l1.355"> </span>
<a href="#l1.356"></a><span id="l1.356" class="difflineat">@@ -1041,17 +1150,17 @@ nsPlacesAutoComplete.prototype = {</span>
<a href="#l1.357"></a><span id="l1.357">   {</span>
<a href="#l1.358"></a><span id="l1.358">     // Before we do any work, make sure this entry isn't already in our results.</span>
<a href="#l1.359"></a><span id="l1.359">     let entryId = aRow.getResultByIndex(kQueryIndexPlaceId);</span>
<a href="#l1.360"></a><span id="l1.360">     let escapedEntryURL = aRow.getResultByIndex(kQueryIndexURL);</span>
<a href="#l1.361"></a><span id="l1.361">     let openPageCount = aRow.getResultByIndex(kQueryIndexOpenPageCount) || 0;</span>
<a href="#l1.362"></a><span id="l1.362"> </span>
<a href="#l1.363"></a><span id="l1.363">     // If actions are enabled and the page is open, add only the switch-to-tab</span>
<a href="#l1.364"></a><span id="l1.364">     // result.  Otherwise, add the normal result.</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineminus">-    let [url, action] = this._enableActions &amp;&amp; openPageCount &gt; 0 ?</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineplus">+    let [url, action] = this._enableActions &amp;&amp; openPageCount &gt; 0 &amp;&amp; this._hasBehavior(&quot;openpage&quot;) ?</span>
<a href="#l1.367"></a><span id="l1.367">                         [&quot;moz-action:switchtab,&quot; + escapedEntryURL, &quot;action &quot;] :</span>
<a href="#l1.368"></a><span id="l1.368">                         [escapedEntryURL, &quot;&quot;];</span>
<a href="#l1.369"></a><span id="l1.369"> </span>
<a href="#l1.370"></a><span id="l1.370">     if (this._inResults(entryId, url)) {</span>
<a href="#l1.371"></a><span id="l1.371">       return false;</span>
<a href="#l1.372"></a><span id="l1.372">     }</span>
<a href="#l1.373"></a><span id="l1.373"> </span>
<a href="#l1.374"></a><span id="l1.374">     let entryTitle = aRow.getResultByIndex(kQueryIndexTitle) || &quot;&quot;;</span>
<a href="#l1.375"></a><span id="l1.375" class="difflineat">@@ -1076,20 +1185,20 @@ nsPlacesAutoComplete.prototype = {</span>
<a href="#l1.376"></a><span id="l1.376">       else {</span>
<a href="#l1.377"></a><span id="l1.377">         title = entryTitle;</span>
<a href="#l1.378"></a><span id="l1.378">       }</span>
<a href="#l1.379"></a><span id="l1.379">     }</span>
<a href="#l1.380"></a><span id="l1.380"> </span>
<a href="#l1.381"></a><span id="l1.381">     // We will always prefer to show tags if we have them.</span>
<a href="#l1.382"></a><span id="l1.382">     let showTags = !!entryTags;</span>
<a href="#l1.383"></a><span id="l1.383"> </span>
<a href="#l1.384"></a><span id="l1.384" class="difflineminus">-    // However, we'll act as if a page is not bookmarked or tagged if the user</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineminus">-    // only wants only history and not bookmarks or tags.</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineminus">-    if (this._hasBehavior(&quot;history&quot;) &amp;&amp;</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineminus">-        !(this._hasBehavior(&quot;bookmark&quot;) || this._hasBehavior(&quot;tag&quot;))) {</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineplus">+    // However, we'll act as if a page is not bookmarked if the user wants</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineplus">+    // only history and not bookmarks and there are no tags.</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineplus">+    if (this._hasBehavior(&quot;history&quot;) &amp;&amp; !this._hasBehavior(&quot;bookmark&quot;) &amp;&amp;</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineplus">+        !showTags) {</span>
<a href="#l1.392"></a><span id="l1.392">       showTags = false;</span>
<a href="#l1.393"></a><span id="l1.393">       style = &quot;favicon&quot;;</span>
<a href="#l1.394"></a><span id="l1.394">     }</span>
<a href="#l1.395"></a><span id="l1.395"> </span>
<a href="#l1.396"></a><span id="l1.396">     // If we have tags and should show them, we need to add them to the title.</span>
<a href="#l1.397"></a><span id="l1.397">     if (showTags) {</span>
<a href="#l1.398"></a><span id="l1.398">       title += kTitleTagsSeparator + entryTags;</span>
<a href="#l1.399"></a><span id="l1.399">     }</span>
<a href="#l1.400"></a><span id="l1.400" class="difflineat">@@ -1427,17 +1536,19 @@ urlInlineComplete.prototype = {</span>
<a href="#l1.401"></a><span id="l1.401">       this._originalSearchString.slice(pathIndex)</span>
<a href="#l1.402"></a><span id="l1.402">     );</span>
<a href="#l1.403"></a><span id="l1.403"> </span>
<a href="#l1.404"></a><span id="l1.404">     // Within the standard autocomplete query, we only search the beginning</span>
<a href="#l1.405"></a><span id="l1.405">     // of URLs for 1 result.</span>
<a href="#l1.406"></a><span id="l1.406">     let query = this._urlQuery;</span>
<a href="#l1.407"></a><span id="l1.407">     let (params = query.params) {</span>
<a href="#l1.408"></a><span id="l1.408">       params.matchBehavior = MATCH_BEGINNING_CASE_SENSITIVE;</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineminus">-      params.searchBehavior = Ci.mozIPlacesAutoComplete[&quot;BEHAVIOR_URL&quot;];</span>
<a href="#l1.410"></a><span id="l1.410" class="difflineplus">+      params.searchBehavior |= Ci.mozIPlacesAutoComplete.BEHAVIOR_HISTORY |</span>
<a href="#l1.411"></a><span id="l1.411" class="difflineplus">+                               Ci.mozIPlacesAutoComplete.BEHAVIOR_TYPED |</span>
<a href="#l1.412"></a><span id="l1.412" class="difflineplus">+                               Ci.mozIPlacesAutoComplete.BEHAVIOR_URL;</span>
<a href="#l1.413"></a><span id="l1.413">       params.searchString = this._currentSearchString;</span>
<a href="#l1.414"></a><span id="l1.414">     }</span>
<a href="#l1.415"></a><span id="l1.415"> </span>
<a href="#l1.416"></a><span id="l1.416">     // Execute the query.</span>
<a href="#l1.417"></a><span id="l1.417">     let ac = this;</span>
<a href="#l1.418"></a><span id="l1.418">     let wrapper = new AutoCompleteStatementCallbackWrapper(this, {</span>
<a href="#l1.419"></a><span id="l1.419">       handleResult: function(aResultSet) {</span>
<a href="#l1.420"></a><span id="l1.420">         let row = aResultSet.getNextRow();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/suite/common/places/tests/autocomplete/head_autocomplete.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/suite/common/places/tests/autocomplete/head_autocomplete.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -241,18 +241,20 @@ function task_addPageBook(aURI, aTitle, </span>
<a href="#l2.4"></a><span id="l2.4">   }</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">   print(&quot;\nAdding page/book/tag: &quot; + out.join(&quot;, &quot;));</span>
<a href="#l2.7"></a><span id="l2.7"> }</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> function run_test() {</span>
<a href="#l2.10"></a><span id="l2.10">   print(&quot;\n&quot;);</span>
<a href="#l2.11"></a><span id="l2.11">   // always search in history + bookmarks, no matter what the default is</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  prefs.setIntPref(&quot;browser.urlbar.search.sources&quot;, 3);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-  prefs.setIntPref(&quot;browser.urlbar.default.behavior&quot;, 0);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+  prefs.setBoolPref(&quot;browser.urlbar.suggest.history&quot;, true);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+  prefs.setBoolPref(&quot;browser.urlbar.suggest.bookmark&quot;, true);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+  prefs.setBoolPref(&quot;browser.urlbar.suggest.openpage&quot;, true);</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+  prefs.setBoolPref(&quot;browser.urlbar.suggest.history.onlyTyped&quot;, false);</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">   // Search is asynchronous, so don't let the test finish immediately</span>
<a href="#l2.20"></a><span id="l2.20">   do_test_pending();</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22">   // Load the test and print a description then run the test</span>
<a href="#l2.23"></a><span id="l2.23">   let [description, search, expected, func] = gTests[current_test];</span>
<a href="#l2.24"></a><span id="l2.24">   print(description);</span>
<a href="#l2.25"></a><span id="l2.25"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/suite/common/places/tests/autocomplete/test_empty_search.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/suite/common/places/tests/autocomplete/test_empty_search.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -39,25 +39,31 @@ removePages([4,5]);</span>
<a href="#l3.4"></a><span id="l3.4"> // pages that should match; optional function to be run before the test</span>
<a href="#l3.5"></a><span id="l3.5"> let gTests = [</span>
<a href="#l3.6"></a><span id="l3.6">   [&quot;0: Match everything&quot;,</span>
<a href="#l3.7"></a><span id="l3.7">    &quot;foo&quot;, [0,1,2,3,4,5]],</span>
<a href="#l3.8"></a><span id="l3.8">   [&quot;1: Match only typed history&quot;,</span>
<a href="#l3.9"></a><span id="l3.9">    &quot;foo ^ ~&quot;, [2,3]],</span>
<a href="#l3.10"></a><span id="l3.10">   [&quot;2: Drop-down empty search matches only typed history&quot;,</span>
<a href="#l3.11"></a><span id="l3.11">    &quot;&quot;, [2,3]],</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  [&quot;3: Drop-down empty search matches everything&quot;,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-   &quot;&quot;, [0,1,2,3,4,5], function () setEmptyPref(0)],</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  [&quot;3: Drop-down empty search matches only bookmarks&quot;,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+   &quot;&quot;, [2,3], matchBookmarks],</span>
<a href="#l3.16"></a><span id="l3.16">   [&quot;4: Drop-down empty search matches only typed&quot;,</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-   &quot;&quot;, [2,3,5], function () setEmptyPref(32)],</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-  [&quot;5: Drop-down empty search matches only typed history&quot;,</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-   &quot;&quot;, [2,3], clearEmptyPref],</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+   &quot;&quot;, [2,3], matchTyped],</span>
<a href="#l3.21"></a><span id="l3.21"> ];</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-function setEmptyPref(aValue)</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-  prefs.setIntPref(&quot;browser.urlbar.default.behavior.emptyRestriction&quot;, aValue);</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-function clearEmptyPref()</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-{</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-  if (prefs.prefHasUserValue(&quot;browser.urlbar.default.behavior.emptyRestriction&quot;))</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-    prefs.clearUserPref(&quot;browser.urlbar.default.behavior.emptyRestriction&quot;);</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+function matchBookmarks() {</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  prefs.setBoolPref(&quot;browser.urlbar.suggest.history&quot;, false);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  prefs.setBoolPref(&quot;browser.urlbar.suggest.bookmark&quot;, true);</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  clearPrefs();</span>
<a href="#l3.34"></a><span id="l3.34"> }</span>
<a href="#l3.35"></a><span id="l3.35"> </span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+function matchTyped() {</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  prefs.setBoolPref(&quot;browser.urlbar.suggest.history&quot;, true);</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  prefs.setBoolPref(&quot;browser.urlbar.suggest.history.onlyTyped&quot;, true);</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  clearPrefs();</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+}</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+function clearPrefs() {</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+  prefs.clearUserPref(&quot;browser.urlbar.suggest.history&quot;);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  prefs.clearUserPref(&quot;browser.urlbar.suggest.bookmark&quot;);</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+  prefs.clearUserPref(&quot;browser.urlbar.suggest.history.onlyTyped&quot;);</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/suite/common/places/tests/autocomplete/test_special_search.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/suite/common/places/tests/autocomplete/test_special_search.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -55,35 +55,35 @@ removePages([4,6,7,8,9,11]);</span>
<a href="#l4.4"></a><span id="l4.4"> markTyped([0,10], 0);</span>
<a href="#l4.5"></a><span id="l4.5"> markTyped([3], 1);</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> // Provide for each test: description; search terms; array of gPages indices of</span>
<a href="#l4.8"></a><span id="l4.8"> // pages that should match; optional function to be run before the test</span>
<a href="#l4.9"></a><span id="l4.9"> let gTests = [</span>
<a href="#l4.10"></a><span id="l4.10">   // Test restricting searches</span>
<a href="#l4.11"></a><span id="l4.11">   [&quot;0: History restrict&quot;,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-   &quot;^&quot;, [0,1,2,3,5,10], ignoreTags],</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+   &quot;^&quot;, [0,1,2,3,5,10]],</span>
<a href="#l4.14"></a><span id="l4.14">   [&quot;1: Star restrict&quot;,</span>
<a href="#l4.15"></a><span id="l4.15">    &quot;*&quot;, [4,5,6,7,8,9,10,11]],</span>
<a href="#l4.16"></a><span id="l4.16">   [&quot;2: Tag restrict&quot;,</span>
<a href="#l4.17"></a><span id="l4.17">    &quot;+&quot;, [8,9,10,11]],</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19">   // Test specials as any word position</span>
<a href="#l4.20"></a><span id="l4.20">   [&quot;3: Special as first word&quot;,</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-   &quot;^ foo bar&quot;, [1,2,3,5,10], ignoreTags],</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+   &quot;^ foo bar&quot;, [1,2,3,5,10]],</span>
<a href="#l4.23"></a><span id="l4.23">   [&quot;4: Special as middle word&quot;,</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-   &quot;foo ^ bar&quot;, [1,2,3,5,10], ignoreTags],</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+   &quot;foo ^ bar&quot;, [1,2,3,5,10]],</span>
<a href="#l4.26"></a><span id="l4.26">   [&quot;5: Special as last word&quot;,</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-   &quot;foo bar ^&quot;, [1,2,3,5,10], ignoreTags],</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+   &quot;foo bar ^&quot;, [1,2,3,5,10]],</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30">   // Test restricting and matching searches with a term</span>
<a href="#l4.31"></a><span id="l4.31">   [&quot;6.1: foo ^ -&gt; history&quot;,</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-   &quot;foo ^&quot;, [1,2,3,5,10], ignoreTags],</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+   &quot;foo ^&quot;, [1,2,3,5,10]],</span>
<a href="#l4.34"></a><span id="l4.34">   [&quot;6.2: foo | -&gt; history (change pref)&quot;,</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-   &quot;foo |&quot;, [1,2,3,5,10], function() {ignoreTags(); changeRestrict(&quot;history&quot;, &quot;|&quot;); }],</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+   &quot;foo |&quot;, [1,2,3,5,10], function() { changeRestrict(&quot;history&quot;, &quot;|&quot;); }],</span>
<a href="#l4.37"></a><span id="l4.37">   [&quot;7.1: foo * -&gt; is star&quot;,</span>
<a href="#l4.38"></a><span id="l4.38">    &quot;foo *&quot;, [5,6,7,8,9,10,11], function() resetRestrict(&quot;history&quot;)],</span>
<a href="#l4.39"></a><span id="l4.39">   [&quot;7.2: foo | -&gt; is star (change pref)&quot;,</span>
<a href="#l4.40"></a><span id="l4.40">    &quot;foo |&quot;, [5,6,7,8,9,10,11], function() changeRestrict(&quot;bookmark&quot;, &quot;|&quot;)],</span>
<a href="#l4.41"></a><span id="l4.41">   [&quot;8.1: foo # -&gt; in title&quot;,</span>
<a href="#l4.42"></a><span id="l4.42">    &quot;foo #&quot;, [1,3,5,7,8,9,10,11], function() resetRestrict(&quot;bookmark&quot;)],</span>
<a href="#l4.43"></a><span id="l4.43">   [&quot;8.2: foo | -&gt; in title (change pref)&quot;,</span>
<a href="#l4.44"></a><span id="l4.44">    &quot;foo |&quot;, [1,3,5,7,8,9,10,11], function() changeRestrict(&quot;title&quot;, &quot;|&quot;)],</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineat">@@ -99,23 +99,23 @@ let gTests = [</span>
<a href="#l4.46"></a><span id="l4.46">    &quot;foo ~&quot;, [3,10], function() resetRestrict(&quot;tag&quot;)],</span>
<a href="#l4.47"></a><span id="l4.47">   [&quot;10.4: foo | -&gt; is typed (change pref)&quot;,</span>
<a href="#l4.48"></a><span id="l4.48">    &quot;foo |&quot;, [3,10], function() changeRestrict(&quot;typed&quot;, &quot;|&quot;)],</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50">   // Test various pairs of special searches</span>
<a href="#l4.51"></a><span id="l4.51">   [&quot;11: foo ^ * -&gt; history, is star&quot;,</span>
<a href="#l4.52"></a><span id="l4.52">    &quot;foo ^ *&quot;, [5,10], function() resetRestrict(&quot;typed&quot;)],</span>
<a href="#l4.53"></a><span id="l4.53">   [&quot;12: foo ^ # -&gt; history, in title&quot;,</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-   &quot;foo ^ #&quot;, [1,3,5,10], ignoreTags],</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+   &quot;foo ^ #&quot;, [1,3,5,10]],</span>
<a href="#l4.56"></a><span id="l4.56">   [&quot;13: foo ^ @ -&gt; history, in url&quot;,</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-   &quot;foo ^ @&quot;, [2,3,10], ignoreTags],</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+   &quot;foo ^ @&quot;, [2,3,10]],</span>
<a href="#l4.59"></a><span id="l4.59">   [&quot;14: foo ^ + -&gt; history, is tag&quot;,</span>
<a href="#l4.60"></a><span id="l4.60">    &quot;foo ^ +&quot;, [10]],</span>
<a href="#l4.61"></a><span id="l4.61">   [&quot;14.1: foo ^ ~ -&gt; history, is typed&quot;,</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-   &quot;foo ^ ~&quot;, [3,10], ignoreTags],</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+   &quot;foo ^ ~&quot;, [3,10]],</span>
<a href="#l4.64"></a><span id="l4.64">   [&quot;15: foo * # -&gt; is star, in title&quot;,</span>
<a href="#l4.65"></a><span id="l4.65">    &quot;foo * #&quot;, [5,7,8,9,10,11]],</span>
<a href="#l4.66"></a><span id="l4.66">   [&quot;16: foo * @ -&gt; is star, in url&quot;,</span>
<a href="#l4.67"></a><span id="l4.67">    &quot;foo * @&quot;, [6,7,10,11]],</span>
<a href="#l4.68"></a><span id="l4.68">   [&quot;17: foo * + -&gt; same as +&quot;,</span>
<a href="#l4.69"></a><span id="l4.69">    &quot;foo * +&quot;, [8,9,10,11]],</span>
<a href="#l4.70"></a><span id="l4.70">   [&quot;17.1: foo * ~ -&gt; is star, is typed&quot;,</span>
<a href="#l4.71"></a><span id="l4.71">    &quot;foo * ~&quot;, [10]],</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineat">@@ -129,37 +129,36 @@ let gTests = [</span>
<a href="#l4.73"></a><span id="l4.73">    &quot;foo @ +&quot;, [10,11]],</span>
<a href="#l4.74"></a><span id="l4.74">   [&quot;20.1: foo @ ~ -&gt; in url, is typed&quot;,</span>
<a href="#l4.75"></a><span id="l4.75">    &quot;foo @ ~&quot;, [3,10]],</span>
<a href="#l4.76"></a><span id="l4.76">   [&quot;20.2: foo + ~ -&gt; is tag, is typed&quot;,</span>
<a href="#l4.77"></a><span id="l4.77">    &quot;foo + ~&quot;, [10]],</span>
<a href="#l4.78"></a><span id="l4.78"> </span>
<a href="#l4.79"></a><span id="l4.79">   // Test default usage by setting certain bits of default.behavior to 1</span>
<a href="#l4.80"></a><span id="l4.80">   [&quot;21: foo -&gt; default history&quot;,</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-   &quot;foo&quot;, [1,2,3,5,10], function() makeDefault(1)],</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-  [&quot;22: foo -&gt; default history, is star&quot;,</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-   &quot;foo&quot;, [5,10], function() makeDefault(3)],</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-  [&quot;22.1: foo -&gt; default history, is star, is typed&quot;,</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-   &quot;foo&quot;, [10], function() makeDefault(35)],</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-  [&quot;23: foo -&gt; default history, is star, in url&quot;,</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-   &quot;foo&quot;, [10], function() makeDefault(19)],</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+   &quot;foo&quot;, [1,2,3,5,10], function () { setPref({ history: true }); }],</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+  [&quot;22: foo -&gt; default history or is star&quot;,</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+   &quot;foo&quot;, [1,2,3,5,6,7,8,9,10,11], function() setPref({ history: true, bookmark: true })],</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+  [&quot;22.1: foo -&gt; default history or is star, is typed&quot;,</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+   &quot;foo&quot;, [3,10], function() setPref({ history: true, bookmark: true, &quot;history.onlyTyped&quot;: true })],</span>
<a href="#l4.93"></a><span id="l4.93"> </span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-  // Change the default to be less restrictive to make sure we find more</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-  [&quot;24: foo -&gt; default is star, in url&quot;,</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-   &quot;foo&quot;, [6,7,10,11], function() makeDefault(18)],</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-  [&quot;25: foo -&gt; default in url&quot;,</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-   &quot;foo&quot;, [2,3,6,7,10,11], function() makeDefault(16)],</span>
<a href="#l4.99"></a><span id="l4.99"> ];</span>
<a href="#l4.100"></a><span id="l4.100"> </span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-function makeDefault(aDefault) {</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-  // We want to ignore tags if we're restricting to history unless we're showing</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-  if ((aDefault &amp; 1) &amp;&amp; !((aDefault &amp; 2) || (aDefault &amp; 4)))</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-    ignoreTags();</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+function setPref(aTypes) {</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+  clearSuggestPrefs();</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+  for (let type in aTypes) {</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+    prefs.setBoolPref(&quot;browser.urlbar.suggest.&quot; + type, aTypes[type]);</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+  }</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+}</span>
<a href="#l4.111"></a><span id="l4.111"> </span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-  prefs.setIntPref(&quot;browser.urlbar.default.behavior&quot;, aDefault);</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+function clearSuggestPrefs() {</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+  prefs.setBoolPref(&quot;browser.urlbar.suggest.history&quot;, false);</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+  prefs.setBoolPref(&quot;browser.urlbar.suggest.bookmark&quot;, false);</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+  prefs.setBoolPref(&quot;browser.urlbar.suggest.history.onlyTyped&quot;, false);</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+  prefs.setBoolPref(&quot;browser.urlbar.suggest.openpage&quot;, false);</span>
<a href="#l4.118"></a><span id="l4.118"> }</span>
<a href="#l4.119"></a><span id="l4.119"> </span>
<a href="#l4.120"></a><span id="l4.120"> function changeRestrict(aType, aChar)</span>
<a href="#l4.121"></a><span id="l4.121"> {</span>
<a href="#l4.122"></a><span id="l4.122">   let branch = &quot;browser.urlbar.&quot;;</span>
<a href="#l4.123"></a><span id="l4.123">   // &quot;title&quot; and &quot;url&quot; are different from everything else, so special case them.</span>
<a href="#l4.124"></a><span id="l4.124">   if (aType == &quot;title&quot; || aType == &quot;url&quot;)</span>
<a href="#l4.125"></a><span id="l4.125">     branch += &quot;match.&quot;;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

