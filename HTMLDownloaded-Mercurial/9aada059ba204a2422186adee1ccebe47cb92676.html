<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3222:9aada059ba204a2422186adee1ccebe47cb92676</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9aada059ba204a2422186adee1ccebe47cb92676" />
<meta property="og:url" content="/comm-central/rev/9aada059ba204a2422186adee1ccebe47cb92676" />
<meta property="og:description" content="work on date constraints for auto-synced offline stores, r/sr=standard8, 482476" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9aada059ba204a2422186adee1ccebe47cb92676 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9aada059ba204a2422186adee1ccebe47cb92676">shortlog</a> |
<a href="/comm-central/log/9aada059ba204a2422186adee1ccebe47cb92676">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9aada059ba204a2422186adee1ccebe47cb92676">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9aada059ba204a2422186adee1ccebe47cb92676">files</a> |
changeset |
<a href="/comm-central/raw-rev/9aada059ba204a2422186adee1ccebe47cb92676">raw</a>  | <a href="/comm-central/archive/9aada059ba204a2422186adee1ccebe47cb92676.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
work on date constraints for auto-synced offline stores, r/sr=standard8, 482476
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 03 Aug 2009 11:12:49 -0700</td></tr>

<tr>
 <td>changeset 3222</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9aada059ba204a2422186adee1ccebe47cb92676">9aada059ba204a2422186adee1ccebe47cb92676</a></td>
</tr>



<tr>
<td>parent 3221</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6bd79b0f2f1778205fc593c300febb937215561b">6bd79b0f2f1778205fc593c300febb937215561b</a>
</td>
</tr>

<tr>
<td>child 3223</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/79eaac144a0b67b43b7862767aba6d822d628e3e">79eaac144a0b67b43b7862767aba6d822d628e3e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9aada059ba204a2422186adee1ccebe47cb92676">2627</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 03 Aug 2009 18:12:43 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9aada059ba20 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9aada059ba204a2422186adee1ccebe47cb92676">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9aada059ba204a2422186adee1ccebe47cb92676&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9aada059ba204a2422186adee1ccebe47cb92676&newProject=comm-central&newRevision=9aada059ba204a2422186adee1ccebe47cb92676&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9aada059ba204a2422186adee1ccebe47cb92676&newProject=comm-central&newRevision=9aada059ba204a2422186adee1ccebe47cb92676&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9aada059ba204a2422186adee1ccebe47cb92676&newProject=comm-central&newRevision=9aada059ba204a2422186adee1ccebe47cb92676&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=482476">482476</a></td></tr>




</table></div>

<div class="page_body description">work on date constraints for auto-synced offline stores, r/sr=standard8, 482476</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/public/nsIMsgFolder.idl">mailnews/base/public/nsIMsgFolder.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/public/nsIMsgFolder.idl">file</a> |
<a href="/comm-central/annotate/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/public/nsIMsgFolder.idl">annotate</a> |
<a href="/comm-central/diff/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/public/nsIMsgFolder.idl">diff</a> |
<a href="/comm-central/comparison/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/public/nsIMsgFolder.idl">comparison</a> |
<a href="/comm-central/log/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/public/nsIMsgFolder.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/src/nsMsgFolderCompactor.cpp">mailnews/base/src/nsMsgFolderCompactor.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/src/nsMsgFolderCompactor.cpp">file</a> |
<a href="/comm-central/annotate/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/src/nsMsgFolderCompactor.cpp">annotate</a> |
<a href="/comm-central/diff/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/src/nsMsgFolderCompactor.cpp">diff</a> |
<a href="/comm-central/comparison/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/src/nsMsgFolderCompactor.cpp">comparison</a> |
<a href="/comm-central/log/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/src/nsMsgFolderCompactor.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/src/nsMsgFolderCompactor.h">mailnews/base/src/nsMsgFolderCompactor.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/src/nsMsgFolderCompactor.h">file</a> |
<a href="/comm-central/annotate/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/src/nsMsgFolderCompactor.h">annotate</a> |
<a href="/comm-central/diff/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/src/nsMsgFolderCompactor.h">diff</a> |
<a href="/comm-central/comparison/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/src/nsMsgFolderCompactor.h">comparison</a> |
<a href="/comm-central/log/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/base/src/nsMsgFolderCompactor.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/public/nsIImapService.idl">mailnews/imap/public/nsIImapService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/public/nsIImapService.idl">file</a> |
<a href="/comm-central/annotate/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/public/nsIImapService.idl">annotate</a> |
<a href="/comm-central/diff/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/public/nsIImapService.idl">diff</a> |
<a href="/comm-central/comparison/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/public/nsIImapService.idl">comparison</a> |
<a href="/comm-central/log/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/public/nsIImapService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/public/nsIMsgImapMailFolder.idl">mailnews/imap/public/nsIMsgImapMailFolder.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/public/nsIMsgImapMailFolder.idl">file</a> |
<a href="/comm-central/annotate/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/public/nsIMsgImapMailFolder.idl">annotate</a> |
<a href="/comm-central/diff/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/public/nsIMsgImapMailFolder.idl">diff</a> |
<a href="/comm-central/comparison/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/public/nsIMsgImapMailFolder.idl">comparison</a> |
<a href="/comm-central/log/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/public/nsIMsgImapMailFolder.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/src/nsImapService.cpp">mailnews/imap/src/nsImapService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/src/nsImapService.cpp">file</a> |
<a href="/comm-central/annotate/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/src/nsImapService.cpp">annotate</a> |
<a href="/comm-central/diff/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/src/nsImapService.cpp">diff</a> |
<a href="/comm-central/comparison/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/src/nsImapService.cpp">comparison</a> |
<a href="/comm-central/log/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/src/nsImapService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/test/unit/test_compactOfflineStore.js">mailnews/imap/test/unit/test_compactOfflineStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/test/unit/test_compactOfflineStore.js">file</a> |
<a href="/comm-central/annotate/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/test/unit/test_compactOfflineStore.js">annotate</a> |
<a href="/comm-central/diff/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/test/unit/test_compactOfflineStore.js">diff</a> |
<a href="/comm-central/comparison/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/test/unit/test_compactOfflineStore.js">comparison</a> |
<a href="/comm-central/log/9aada059ba204a2422186adee1ccebe47cb92676/mailnews/imap/test/unit/test_compactOfflineStore.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -39,18 +39,16 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;nsIFolderListener.idl&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsIMsgThread.idl&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;nsIMsgIncomingServer.idl&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;nsIMsgCopyServiceListener.idl&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;nsIUrlListener.idl&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> #include &quot;nsISimpleEnumerator.idl&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-[ptr] native octet_ptr(PRUint8);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-</span>
<a href="#l1.14"></a><span id="l1.14"> interface nsIMsgDBHdr;</span>
<a href="#l1.15"></a><span id="l1.15"> interface nsIMsgWindow;</span>
<a href="#l1.16"></a><span id="l1.16"> interface nsIMsgDatabase;</span>
<a href="#l1.17"></a><span id="l1.17"> interface nsIDBFolderInfo;</span>
<a href="#l1.18"></a><span id="l1.18"> interface nsIMsgFilterList;</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> interface nsIMsgFolderCacheElement;</span>
<a href="#l1.21"></a><span id="l1.21"> interface nsITransport;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -198,16 +196,24 @@ interface nsIMsgFolder : nsISupports {</span>
<a href="#l1.23"></a><span id="l1.23">   nsIMsgFolder addSubfolder(in AString folderName);</span>
<a href="#l1.24"></a><span id="l1.24">   /* this method ensures the storage for the folder exists.</span>
<a href="#l1.25"></a><span id="l1.25">     For local folders, it creates the berkeley mailbox if missing.</span>
<a href="#l1.26"></a><span id="l1.26">     For imap folders, it subscribes to the folder if it exists,</span>
<a href="#l1.27"></a><span id="l1.27">     or creates it if it doesn't exist</span>
<a href="#l1.28"></a><span id="l1.28">   */</span>
<a href="#l1.29"></a><span id="l1.29">   void createStorageIfMissing(in nsIUrlListener urlListener);</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  /**</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+   * Compact this folder. For IMAP folders configured for offline use,</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+   * it will also compact the offline store, and the completed notification</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+   * will occur when the Expunge is finished, not the offline store compaction.</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+   *</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+   * @param aListener   Notified of completion, can be null.</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+   * @param aMsgWindow  For progress/status, can be null.</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+   */</span>
<a href="#l1.39"></a><span id="l1.39">   void compact(in nsIUrlListener aListener, in nsIMsgWindow aMsgWindow);</span>
<a href="#l1.40"></a><span id="l1.40">   /**</span>
<a href="#l1.41"></a><span id="l1.41">    * Compact all folders in the account corresponding to this folder/</span>
<a href="#l1.42"></a><span id="l1.42">    * Optionally compact their offline stores as well (imap/news)</span>
<a href="#l1.43"></a><span id="l1.43">    * </span>
<a href="#l1.44"></a><span id="l1.44">    * @param aListener   Notified of completion, can be null.</span>
<a href="#l1.45"></a><span id="l1.45">    * @param aMsgWindow  For progress/status, can be null.</span>
<a href="#l1.46"></a><span id="l1.46">    * @param aCompactOfflineAlso  This controls whether we compact all </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -191,17 +191,17 @@ nsFolderCompactState::Compact(nsIMsgFold</span>
<a href="#l2.4"></a><span id="l2.4">                               nsIUrlListener *aListener, nsIMsgWindow *aMsgWindow)</span>
<a href="#l2.5"></a><span id="l2.5"> {</span>
<a href="#l2.6"></a><span id="l2.6">   NS_ENSURE_ARG_POINTER(folder);</span>
<a href="#l2.7"></a><span id="l2.7">   m_listener = aListener;</span>
<a href="#l2.8"></a><span id="l2.8">   if (!m_compactingOfflineFolders &amp;&amp; !aOfflineStore)</span>
<a href="#l2.9"></a><span id="l2.9">   {</span>
<a href="#l2.10"></a><span id="l2.10">     nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(folder);</span>
<a href="#l2.11"></a><span id="l2.11">     if (imapFolder)</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-      return folder-&gt;Compact(this, aMsgWindow);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      return imapFolder-&gt;Expunge(this, aMsgWindow);</span>
<a href="#l2.14"></a><span id="l2.14">   }</span>
<a href="#l2.15"></a><span id="l2.15">    m_window = aMsgWindow;</span>
<a href="#l2.16"></a><span id="l2.16">    nsresult rv;</span>
<a href="#l2.17"></a><span id="l2.17">    nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l2.18"></a><span id="l2.18">    nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l2.19"></a><span id="l2.19">    nsCOMPtr&lt;nsIMsgDatabase&gt; mailDBFactory;</span>
<a href="#l2.20"></a><span id="l2.20">    nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l2.21"></a><span id="l2.21">    nsCString baseMessageURI;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -860,21 +860,65 @@ nsOfflineStoreCompactState::nsOfflineSto</span>
<a href="#l2.23"></a><span id="l2.23"> nsOfflineStoreCompactState::~nsOfflineStoreCompactState()</span>
<a href="#l2.24"></a><span id="l2.24"> {</span>
<a href="#l2.25"></a><span id="l2.25"> }</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28"> nsresult</span>
<a href="#l2.29"></a><span id="l2.29"> nsOfflineStoreCompactState::InitDB(nsIMsgDatabase *db)</span>
<a href="#l2.30"></a><span id="l2.30"> {</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  // Start with the list of messages we have offline as the possible</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  // message to keep when compacting the offline store.</span>
<a href="#l2.33"></a><span id="l2.33">   db-&gt;ListAllOfflineMsgs(&amp;m_keyArray);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+  // Filter out msgs that have the &quot;pendingRemoval&quot; attribute set.</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+  nsString pendingRemoval;</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  for (PRInt32 i = m_keyArray.Length() - 1; i &gt;= 0; i--)</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+  {</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+    nsresult rv = db-&gt;GetMsgHdrForKey(m_keyArray[i], getter_AddRefs(hdr));</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+    hdr-&gt;GetProperty(&quot;pendingRemoval&quot;, pendingRemoval);</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+    if (!pendingRemoval.IsEmpty())</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+    {</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+      m_keyArray.RemoveElementAt(i);</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+      // Turn off offline flag for message, since after the compact is completed;</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+      // we won't have the message in the offline store.</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+      PRUint32 resultFlags;</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+      hdr-&gt;AndFlags(~nsMsgMessageFlags::Offline, &amp;resultFlags);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+    }</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+  }</span>
<a href="#l2.51"></a><span id="l2.51">   m_db = db;</span>
<a href="#l2.52"></a><span id="l2.52">   return NS_OK;</span>
<a href="#l2.53"></a><span id="l2.53"> }</span>
<a href="#l2.54"></a><span id="l2.54"> </span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+nsresult nsOfflineStoreCompactState::CopyNextMessage()</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+{</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  m_messageUri.SetLength(0); // clear the previous message uri</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+  nsresult rv = BuildMessageURI(m_baseMessageUri.get(), m_keyArray[m_curIndex],</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+                                m_messageUri);</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+  m_startOfMsg = PR_TRUE;</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; thisSupports;</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+  QueryInterface(NS_GET_IID(nsISupports), getter_AddRefs(thisSupports));</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+  rv = m_messageService-&gt;StreamMessage(m_messageUri.get(), thisSupports, m_window, nsnull,</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+                                  PR_FALSE, EmptyCString(), PR_TRUE, nsnull);</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  // if copy fails, we clear the offline flag on the source message.</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  {</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+    GetMessage(getter_AddRefs(hdr));</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+    if (hdr)</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+    {</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+      PRUint32 resultFlags;</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+      hdr-&gt;AndFlags(~nsMsgMessageFlags::Offline, &amp;resultFlags);</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+    }</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+  }</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+  return rv;</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+}</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+</span>
<a href="#l2.80"></a><span id="l2.80"> NS_IMETHODIMP</span>
<a href="#l2.81"></a><span id="l2.81"> nsOfflineStoreCompactState::OnStopRequest(nsIRequest *request, nsISupports *ctxt,</span>
<a href="#l2.82"></a><span id="l2.82">                                           nsresult status)</span>
<a href="#l2.83"></a><span id="l2.83"> {</span>
<a href="#l2.84"></a><span id="l2.84">   nsresult rv = status;</span>
<a href="#l2.85"></a><span id="l2.85">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l2.86"></a><span id="l2.86">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l2.87"></a><span id="l2.87">   nsCOMPtr&lt;nsIMsgDBHdr&gt; newMsgHdr;</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineat">@@ -907,29 +951,17 @@ nsOfflineStoreCompactState::OnStopReques</span>
<a href="#l2.89"></a><span id="l2.89">     msgHdr = nsnull;</span>
<a href="#l2.90"></a><span id="l2.90">     newMsgHdr = nsnull;</span>
<a href="#l2.91"></a><span id="l2.91">     // no more to copy finish it up</span>
<a href="#l2.92"></a><span id="l2.92">     FinishCompact();</span>
<a href="#l2.93"></a><span id="l2.93">     Release(); // kill self</span>
<a href="#l2.94"></a><span id="l2.94">   }</span>
<a href="#l2.95"></a><span id="l2.95">   else</span>
<a href="#l2.96"></a><span id="l2.96">   {</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-    m_messageUri.SetLength(0); // clear the previous message uri</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-    rv = BuildMessageURI(m_baseMessageUri.get(), m_keyArray[m_curIndex],</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-                         m_messageUri);</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-    if (NS_FAILED(rv)) goto done;</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-    m_startOfMsg = PR_TRUE;</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-    rv = m_messageService-&gt;CopyMessage(m_messageUri.get(), this, PR_FALSE, nsnull,</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-                                       /* ### should get msg window! */ nsnull, nsnull);</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-   if (NS_FAILED(rv))</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-   {</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-     PRUint32 resultFlags;</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-     msgHdr-&gt;AndFlags(~nsMsgMessageFlags::Offline, &amp;resultFlags);</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-   }</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-  // if this fails, we should clear the offline flag on the source message.</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+    rv = CopyNextMessage();</span>
<a href="#l2.111"></a><span id="l2.111">   }</span>
<a href="#l2.112"></a><span id="l2.112"> </span>
<a href="#l2.113"></a><span id="l2.113"> done:</span>
<a href="#l2.114"></a><span id="l2.114">   if (NS_FAILED(rv)) {</span>
<a href="#l2.115"></a><span id="l2.115">     m_status = rv; // set the status to rv so the destructor can remove the</span>
<a href="#l2.116"></a><span id="l2.116">                    // temp folder and database</span>
<a href="#l2.117"></a><span id="l2.117">     Release(); // kill self</span>
<a href="#l2.118"></a><span id="l2.118">     return rv;</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineat">@@ -1064,21 +1096,17 @@ nsFolderCompactState::EndCopy(nsISupport</span>
<a href="#l2.120"></a><span id="l2.120"> </span>
<a href="#l2.121"></a><span id="l2.121"> nsresult nsOfflineStoreCompactState::StartCompacting()</span>
<a href="#l2.122"></a><span id="l2.122"> {</span>
<a href="#l2.123"></a><span id="l2.123">   nsresult rv = NS_OK;</span>
<a href="#l2.124"></a><span id="l2.124">   if (m_size &gt; 0 &amp;&amp; m_curIndex == 0)</span>
<a href="#l2.125"></a><span id="l2.125">   {</span>
<a href="#l2.126"></a><span id="l2.126">     AddRef(); // we own ourselves, until we're done, anyway.</span>
<a href="#l2.127"></a><span id="l2.127">     ShowCompactingStatusMsg();</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-    m_messageUri.SetLength(0); // clear the previous message uri</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-    rv = BuildMessageURI(m_baseMessageUri.get(), m_keyArray[0], m_messageUri);</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-      rv = m_messageService-&gt;CopyMessage(m_messageUri.get(), this, PR_FALSE,</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-                                         nsnull, m_window, nsnull);</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+    rv = CopyNextMessage();</span>
<a href="#l2.134"></a><span id="l2.134">   }</span>
<a href="#l2.135"></a><span id="l2.135">   else</span>
<a href="#l2.136"></a><span id="l2.136">   { // no messages to copy with</span>
<a href="#l2.137"></a><span id="l2.137">     ReleaseFolderLock();</span>
<a href="#l2.138"></a><span id="l2.138">     FinishCompact();</span>
<a href="#l2.139"></a><span id="l2.139"> //    Release(); // we don't &quot;own&quot; ourselves yet.</span>
<a href="#l2.140"></a><span id="l2.140">   }</span>
<a href="#l2.141"></a><span id="l2.141">   return rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCompactor.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCompactor.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -69,36 +69,36 @@ protected:</span>
<a href="#l3.4"></a><span id="l3.4">   virtual nsresult StartCompacting();</span>
<a href="#l3.5"></a><span id="l3.5">   virtual nsresult FinishCompact();</span>
<a href="#l3.6"></a><span id="l3.6">   void CloseOutputStream();</span>
<a href="#l3.7"></a><span id="l3.7">   void  CleanupTempFilesAfterError();</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9">   nsresult Init(nsIMsgFolder *aFolder, const char* aBaseMsgUri, nsIMsgDatabase *aDb,</span>
<a href="#l3.10"></a><span id="l3.10">                             nsILocalFile *aPath, nsIMsgWindow *aMsgWindow);</span>
<a href="#l3.11"></a><span id="l3.11">   nsresult GetMessage(nsIMsgDBHdr **message);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  nsresult BuildMessageURI(const char *baseURI, PRUint32 key, nsCString&amp; uri);  </span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  nsresult BuildMessageURI(const char *baseURI, PRUint32 key, nsCString&amp; uri);</span>
<a href="#l3.14"></a><span id="l3.14">   nsresult ShowStatusMsg(const nsString&amp; aMsg);</span>
<a href="#l3.15"></a><span id="l3.15">   nsresult ReleaseFolderLock();</span>
<a href="#l3.16"></a><span id="l3.16">   void     ShowCompactingStatusMsg();</span>
<a href="#l3.17"></a><span id="l3.17">   void     CompactCompleted(nsresult exitCode);</span>
<a href="#l3.18"></a><span id="l3.18">   void     ShowDoneStatus();</span>
<a href="#l3.19"></a><span id="l3.19">   nsresult CompactNextFolder();</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21">   nsCString m_baseMessageUri; // base message uri</span>
<a href="#l3.22"></a><span id="l3.22">   nsCString m_messageUri; // current message uri being copy</span>
<a href="#l3.23"></a><span id="l3.23">   nsCOMPtr&lt;nsIMsgFolder&gt; m_folder; // current folder being compact</span>
<a href="#l3.24"></a><span id="l3.24">   nsCOMPtr&lt;nsIMsgDatabase&gt; m_db; // new database for the compact folder</span>
<a href="#l3.25"></a><span id="l3.25">   nsCOMPtr &lt;nsILocalFile&gt; m_file; // new mailbox for the compact folder</span>
<a href="#l3.26"></a><span id="l3.26">   nsCOMPtr &lt;nsIOutputStream&gt; m_fileStream; // output file stream for writing</span>
<a href="#l3.27"></a><span id="l3.27">   nsTArray&lt;nsMsgKey&gt; m_keyArray; // all message keys need to be copied over</span>
<a href="#l3.28"></a><span id="l3.28">   PRInt32 m_size; // size of the message key array</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-  </span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+</span>
<a href="#l3.31"></a><span id="l3.31">    // sum of the sizes of the messages, accumulated as we visit each msg.</span>
<a href="#l3.32"></a><span id="l3.32">   PRUint32 m_totalMsgSize;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-  </span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+</span>
<a href="#l3.35"></a><span id="l3.35">   PRInt32 m_curIndex; // index of the current copied message key in key array</span>
<a href="#l3.36"></a><span id="l3.36">   nsMsgKey m_startOfNewMsg; // offset in mailbox of new message</span>
<a href="#l3.37"></a><span id="l3.37">   char m_dataBuffer[COMPACTOR_READ_BUFF_SIZE + 1]; // temp data buffer for copying message</span>
<a href="#l3.38"></a><span id="l3.38">   nsresult m_status; // the status of the copying operation</span>
<a href="#l3.39"></a><span id="l3.39">   nsCOMPtr &lt;nsIMsgMessageService&gt; m_messageService; // message service for copying </span>
<a href="#l3.40"></a><span id="l3.40">   nsCOMPtr&lt;nsIArray&gt; m_folderArray; // folders we are compacting, if compacting multiple.</span>
<a href="#l3.41"></a><span id="l3.41">   nsCOMPtr &lt;nsIMsgWindow&gt; m_window;</span>
<a href="#l3.42"></a><span id="l3.42">   nsCOMPtr &lt;nsIMsgDBHdr&gt; m_curSrcHdr;</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineat">@@ -124,19 +124,17 @@ public:</span>
<a href="#l3.44"></a><span id="l3.44">   virtual ~nsOfflineStoreCompactState(void);</span>
<a href="#l3.45"></a><span id="l3.45">   NS_IMETHOD OnStopRequest(nsIRequest *request, nsISupports *ctxt,</span>
<a href="#l3.46"></a><span id="l3.46">                                     nsresult status);</span>
<a href="#l3.47"></a><span id="l3.47">   NS_IMETHODIMP OnDataAvailable(nsIRequest *request, nsISupports *ctxt,</span>
<a href="#l3.48"></a><span id="l3.48">                                 nsIInputStream *inStr,</span>
<a href="#l3.49"></a><span id="l3.49">                                 PRUint32 sourceOffset, PRUint32 count);</span>
<a href="#l3.50"></a><span id="l3.50"> </span>
<a href="#l3.51"></a><span id="l3.51"> protected:</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+    nsresult         CopyNextMessage();</span>
<a href="#l3.53"></a><span id="l3.53">     virtual nsresult InitDB(nsIMsgDatabase *db);</span>
<a href="#l3.54"></a><span id="l3.54">     virtual nsresult StartCompacting();</span>
<a href="#l3.55"></a><span id="l3.55">     virtual nsresult FinishCompact();</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57">     PRUint32 m_offlineMsgSize;</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-</span>
<a href="#l3.59"></a><span id="l3.59"> };</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-</span>
<a href="#l3.63"></a><span id="l3.63"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapService.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapService.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -53,22 +53,22 @@ interface nsIUrlListener;</span>
<a href="#l4.4"></a><span id="l4.4"> interface nsIURI;</span>
<a href="#l4.5"></a><span id="l4.5"> interface nsIEventTarget;</span>
<a href="#l4.6"></a><span id="l4.6"> interface nsIFile;</span>
<a href="#l4.7"></a><span id="l4.7"> interface nsIMsgFolder;</span>
<a href="#l4.8"></a><span id="l4.8"> interface nsIMsgWindow;</span>
<a href="#l4.9"></a><span id="l4.9"> interface nsIImapIncomingServer;</span>
<a href="#l4.10"></a><span id="l4.10"> interface nsICacheSession;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-[scriptable, uuid(6a881768-ffc0-4967-b291-2ea83f7027ba)]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+[scriptable, uuid(7ff02a19-f402-436a-a6cc-c4c454f0b86f)]</span>
<a href="#l4.14"></a><span id="l4.14"> interface nsIImapService : nsISupports</span>
<a href="#l4.15"></a><span id="l4.15"> {</span>
<a href="#l4.16"></a><span id="l4.16">   // You can pass in null for the url listener and the url if you don't require either.....</span>
<a href="#l4.17"></a><span id="l4.17">   // aClientEventTarget is the event queue of the event sinks. We post events into this queue.</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-  void selectFolder(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+  void selectFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.20"></a><span id="l4.20">                     in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.21"></a><span id="l4.21">                     in nsIUrlListener aUrlListener,</span>
<a href="#l4.22"></a><span id="l4.22">                     in nsIMsgWindow   aMsgWindow,</span>
<a href="#l4.23"></a><span id="l4.23">                     out nsIURI aURL);</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">   /**</span>
<a href="#l4.26"></a><span id="l4.26">    * Select the folder on the imap server without doing a sync of flags or</span>
<a href="#l4.27"></a><span id="l4.27">    * headers. This is used for offline playback, where we don't want to</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineat">@@ -76,17 +76,17 @@ interface nsIImapService : nsISupports</span>
<a href="#l4.29"></a><span id="l4.29">    *</span>
<a href="#l4.30"></a><span id="l4.30">    * @param aClientEventTarget  the event target of the ui thread</span>
<a href="#l4.31"></a><span id="l4.31">    * @param aImapMailFolder     the folder to select</span>
<a href="#l4.32"></a><span id="l4.32">    * @param aUrlListener        url listener, can be null</span>
<a href="#l4.33"></a><span id="l4.33">    * @param aMsgWindow          msg window url is running in, can be null</span>
<a href="#l4.34"></a><span id="l4.34">    *</span>
<a href="#l4.35"></a><span id="l4.35">    * @returns the url created to run the lite select in.</span>
<a href="#l4.36"></a><span id="l4.36">    */</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-  nsIURI liteSelectFolder(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+  nsIURI liteSelectFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.39"></a><span id="l4.39">                         in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.40"></a><span id="l4.40">                         in nsIUrlListener aUrlListener,</span>
<a href="#l4.41"></a><span id="l4.41">                         in nsIMsgWindow aMsgWindow);</span>
<a href="#l4.42"></a><span id="l4.42">   </span>
<a href="#l4.43"></a><span id="l4.43">   void addImapFetchToUrl(in nsIURI aURL,</span>
<a href="#l4.44"></a><span id="l4.44">                          in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.45"></a><span id="l4.45">                          in ACString aMessageIdentifierList,</span>
<a href="#l4.46"></a><span id="l4.46">                          in ACString aAdditionalHeader);</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineat">@@ -97,42 +97,62 @@ interface nsIImapService : nsISupports</span>
<a href="#l4.48"></a><span id="l4.48">                     in nsIImapMessageSink aImapMessageSink,</span>
<a href="#l4.49"></a><span id="l4.49">                     in nsIMsgWindow aMsgWindow, </span>
<a href="#l4.50"></a><span id="l4.50">                     in nsISupports aConsumer,</span>
<a href="#l4.51"></a><span id="l4.51">                     in ACString aMessageIdentifierList,</span>
<a href="#l4.52"></a><span id="l4.52">                     in boolean convertDataToText,</span>
<a href="#l4.53"></a><span id="l4.53">                     in ACString additionalHeader,</span>
<a href="#l4.54"></a><span id="l4.54">                     out nsIURI aOutURL);</span>
<a href="#l4.55"></a><span id="l4.55"> </span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-  void noop(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  void noop(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.58"></a><span id="l4.58">             in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.59"></a><span id="l4.59">             in nsIUrlListener aUrlListener,</span>
<a href="#l4.60"></a><span id="l4.60">             out nsIURI aURL);</span>
<a href="#l4.61"></a><span id="l4.61"> </span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-  void getHeaders(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  void getHeaders(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.64"></a><span id="l4.64">                   in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.65"></a><span id="l4.65">                   in nsIUrlListener aUrlListener,</span>
<a href="#l4.66"></a><span id="l4.66">                   out nsIURI aURL,</span>
<a href="#l4.67"></a><span id="l4.67">                   in ACString aMessageIdentifierList,</span>
<a href="#l4.68"></a><span id="l4.68">                   in boolean aMessageIdsAreUID);</span>
<a href="#l4.69"></a><span id="l4.69"> </span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-  nsIURI getBodyStart(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+  nsIURI getBodyStart(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.72"></a><span id="l4.72">                   in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.73"></a><span id="l4.73">                   in nsIUrlListener aUrlListener,</span>
<a href="#l4.74"></a><span id="l4.74">                   in ACString aMessageIdentifierList,</span>
<a href="#l4.75"></a><span id="l4.75">                   in long numBytes);</span>
<a href="#l4.76"></a><span id="l4.76"> </span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-  void expunge(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  /**</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+   * Issue an EXPUNGE on the target folder.</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+   *</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+   * @param aClientEventTarget  the event target of the ui thread</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+   * @param aImapMailFolder     the folder to expunge</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+   * @param aUrlListener        url listener, can be null</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+   * @param aMsgWindow          msg window url is running in, can be null</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+   *</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+   * @returns the url created to run the expunge.</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+   */</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+  void expunge(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.89"></a><span id="l4.89">                in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.90"></a><span id="l4.90">                in nsIUrlListener aUrlListener,</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+               in nsIMsgWindow aMsgWindow,</span>
<a href="#l4.92"></a><span id="l4.92">                out nsIURI aURL);</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-  </span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-  nsIURI updateFolderStatus(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-               in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-               in nsIUrlListener aUrlListener);</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+  /**</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+   * Issue a STATUS on the target folder.</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+   *</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+   * @param aClientEventTarget  the event target of the ui thread</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+   * @param aImapMailFolder     the folder to expunge</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+   * @param aUrlListener        url listener, can be null</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+   *</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+   * @returns the url created to run the status.</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+   */</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+  nsIURI updateFolderStatus(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+                            in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+                            in nsIUrlListener aUrlListener);</span>
<a href="#l4.110"></a><span id="l4.110"> </span>
<a href="#l4.111"></a><span id="l4.111">   /**</span>
<a href="#l4.112"></a><span id="l4.112">    * Verify that we can login.</span>
<a href="#l4.113"></a><span id="l4.113">    *</span>
<a href="#l4.114"></a><span id="l4.114">    * @param aImapMailFolder - any old imap folder - we just need it to</span>
<a href="#l4.115"></a><span id="l4.115">    *                          set url sinks.</span>
<a href="#l4.116"></a><span id="l4.116">    * @param aMsgWindow    - nsIMsgWindow to use for notification callbacks.</span>
<a href="#l4.117"></a><span id="l4.117">    * @return - the url that we run.</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineat">@@ -142,117 +162,117 @@ interface nsIImapService : nsISupports</span>
<a href="#l4.119"></a><span id="l4.119">                      in nsIMsgWindow aMsgWindow);</span>
<a href="#l4.120"></a><span id="l4.120"> </span>
<a href="#l4.121"></a><span id="l4.121">   void biff(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.122"></a><span id="l4.122">             in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.123"></a><span id="l4.123">             in nsIUrlListener aUrlListener,</span>
<a href="#l4.124"></a><span id="l4.124">             out nsIURI aURL,</span>
<a href="#l4.125"></a><span id="l4.125">             in unsigned long aUidHighWater);</span>
<a href="#l4.126"></a><span id="l4.126"> </span>
<a href="#l4.127"></a><span id="l4.127" class="difflineminus">-  void deleteMessages(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+  void deleteMessages(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.129"></a><span id="l4.129">                       in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.130"></a><span id="l4.130">                       in nsIUrlListener aUrlListener,</span>
<a href="#l4.131"></a><span id="l4.131">                       out nsIURI aURL,</span>
<a href="#l4.132"></a><span id="l4.132">                       in ACString aMessageIdentifierList,</span>
<a href="#l4.133"></a><span id="l4.133">                       in boolean aMessageIdsAreUID);</span>
<a href="#l4.134"></a><span id="l4.134"> </span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-  void deleteAllMessages(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+  void deleteAllMessages(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.137"></a><span id="l4.137">                          in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.138"></a><span id="l4.138">                          in nsIUrlListener aUrlListener,</span>
<a href="#l4.139"></a><span id="l4.139">                          out nsIURI aURL);</span>
<a href="#l4.140"></a><span id="l4.140">   </span>
<a href="#l4.141"></a><span id="l4.141" class="difflineminus">-  void addMessageFlags(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+  void addMessageFlags(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.143"></a><span id="l4.143">                          in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.144"></a><span id="l4.144">                          in nsIUrlListener aUrlListener,</span>
<a href="#l4.145"></a><span id="l4.145">                          out nsIURI aURL,</span>
<a href="#l4.146"></a><span id="l4.146">                          in ACString aMessageIdentifierList,</span>
<a href="#l4.147"></a><span id="l4.147">                          in imapMessageFlagsType aFlags,</span>
<a href="#l4.148"></a><span id="l4.148">                          in boolean aMessageIdsAreUID);</span>
<a href="#l4.149"></a><span id="l4.149">   </span>
<a href="#l4.150"></a><span id="l4.150" class="difflineminus">-  void subtractMessageFlags(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+  void subtractMessageFlags(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.152"></a><span id="l4.152">                             in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.153"></a><span id="l4.153">                             in nsIUrlListener aUrlListener,</span>
<a href="#l4.154"></a><span id="l4.154">                             out nsIURI aURL,</span>
<a href="#l4.155"></a><span id="l4.155">                             in ACString aMessageIdentifierList,</span>
<a href="#l4.156"></a><span id="l4.156">                             in imapMessageFlagsType aFlags,</span>
<a href="#l4.157"></a><span id="l4.157">                             in boolean aMessageIdsAreUID);</span>
<a href="#l4.158"></a><span id="l4.158"> </span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-  void setMessageFlags(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+  void setMessageFlags(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.161"></a><span id="l4.161">                        in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.162"></a><span id="l4.162">                        in nsIUrlListener aUrlListener,</span>
<a href="#l4.163"></a><span id="l4.163">                        out nsIURI aURL,</span>
<a href="#l4.164"></a><span id="l4.164">                        in ACString aMessageIdentifierList,</span>
<a href="#l4.165"></a><span id="l4.165">                        in imapMessageFlagsType aFlags,</span>
<a href="#l4.166"></a><span id="l4.166">                        in boolean aMessageIdsAreUID);</span>
<a href="#l4.167"></a><span id="l4.167">   </span>
<a href="#l4.168"></a><span id="l4.168" class="difflineminus">-  void discoverAllFolders(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+  void discoverAllFolders(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.170"></a><span id="l4.170">                           in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.171"></a><span id="l4.171">                           in nsIUrlListener aUrlListener,</span>
<a href="#l4.172"></a><span id="l4.172">                           in nsIMsgWindow aMsgWindow,</span>
<a href="#l4.173"></a><span id="l4.173">                           out nsIURI aURL);</span>
<a href="#l4.174"></a><span id="l4.174"> </span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-  void discoverAllAndSubscribedFolders(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+  void discoverAllAndSubscribedFolders(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.177"></a><span id="l4.177">                                        in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.178"></a><span id="l4.178">                                        in nsIUrlListener aUrlListener,</span>
<a href="#l4.179"></a><span id="l4.179">                                        out nsIURI aURL);</span>
<a href="#l4.180"></a><span id="l4.180">   void discoverChildren(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.181"></a><span id="l4.181">                         in nsIMsgFolder aImapMailFolder,</span>
<a href="#l4.182"></a><span id="l4.182">                         in nsIUrlListener aUrlListener,</span>
<a href="#l4.183"></a><span id="l4.183">                         in ACString folderPath,</span>
<a href="#l4.184"></a><span id="l4.184">                         out nsIURI aURL);</span>
<a href="#l4.185"></a><span id="l4.185"> </span>
<a href="#l4.186"></a><span id="l4.186" class="difflineminus">-  void onlineMessageCopy(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+  void onlineMessageCopy(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.188"></a><span id="l4.188">                          in nsIMsgFolder aSrcFolder,</span>
<a href="#l4.189"></a><span id="l4.189">                          in ACString aMessageIds,</span>
<a href="#l4.190"></a><span id="l4.190">                          in nsIMsgFolder aDstFolder,</span>
<a href="#l4.191"></a><span id="l4.191">                          in boolean aIdsAreUids,</span>
<a href="#l4.192"></a><span id="l4.192">                          in boolean aIsMove,</span>
<a href="#l4.193"></a><span id="l4.193">                          in nsIUrlListener aUrlListener,</span>
<a href="#l4.194"></a><span id="l4.194">                          out nsIURI aURL,</span>
<a href="#l4.195"></a><span id="l4.195">                          in nsISupports aCopyState,</span>
<a href="#l4.196"></a><span id="l4.196">                          in nsIMsgWindow aWindow);</span>
<a href="#l4.197"></a><span id="l4.197"> </span>
<a href="#l4.198"></a><span id="l4.198"> </span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-  void appendMessageFromFile(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+  void appendMessageFromFile(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.201"></a><span id="l4.201">                              in nsIFile aFile,</span>
<a href="#l4.202"></a><span id="l4.202">                              in nsIMsgFolder aDstFolder,</span>
<a href="#l4.203"></a><span id="l4.203">                              in ACString aMessageId,</span>
<a href="#l4.204"></a><span id="l4.204">                              in boolean idsAreUids,</span>
<a href="#l4.205"></a><span id="l4.205">                              in boolean aInSelectedState,</span>
<a href="#l4.206"></a><span id="l4.206">                              in nsIUrlListener aUrlListener,</span>
<a href="#l4.207"></a><span id="l4.207">                              out nsIURI aURL,</span>
<a href="#l4.208"></a><span id="l4.208">                              in nsISupports aCopyState,</span>
<a href="#l4.209"></a><span id="l4.209">                              in nsIMsgWindow aMsgWindow);</span>
<a href="#l4.210"></a><span id="l4.210">   </span>
<a href="#l4.211"></a><span id="l4.211">   void downloadMessagesForOffline(in ACString aMessageIds, in nsIMsgFolder aSrcFolder,</span>
<a href="#l4.212"></a><span id="l4.212">                       in nsIUrlListener aListener, in nsIMsgWindow   aMsgWindow);</span>
<a href="#l4.213"></a><span id="l4.213"> </span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-  nsIURI moveFolder(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+  nsIURI moveFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.216"></a><span id="l4.216">                     in nsIMsgFolder aSrcFolder,</span>
<a href="#l4.217"></a><span id="l4.217">                     in nsIMsgFolder aDstFolder,</span>
<a href="#l4.218"></a><span id="l4.218">                     in nsIUrlListener aUrlListener,</span>
<a href="#l4.219"></a><span id="l4.219">                     in nsIMsgWindow msgWindow);</span>
<a href="#l4.220"></a><span id="l4.220"> </span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-  nsIURI renameLeaf(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+  nsIURI renameLeaf(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.223"></a><span id="l4.223">                     in nsIMsgFolder aSrcFolder,</span>
<a href="#l4.224"></a><span id="l4.224">                     in AString aLeafName,</span>
<a href="#l4.225"></a><span id="l4.225">                     in nsIUrlListener aUrlListener,</span>
<a href="#l4.226"></a><span id="l4.226">                     in nsIMsgWindow msgWindow);</span>
<a href="#l4.227"></a><span id="l4.227"> </span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-  nsIURI deleteFolder(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+  nsIURI deleteFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.230"></a><span id="l4.230">                       in nsIMsgFolder aFolder,</span>
<a href="#l4.231"></a><span id="l4.231">                       in nsIUrlListener aUrlListener,</span>
<a href="#l4.232"></a><span id="l4.232">                       in nsIMsgWindow aMsgWindow);</span>
<a href="#l4.233"></a><span id="l4.233"> </span>
<a href="#l4.234"></a><span id="l4.234" class="difflineminus">-  nsIURI createFolder(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+  nsIURI createFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.236"></a><span id="l4.236">                       in nsIMsgFolder aParentFolder,</span>
<a href="#l4.237"></a><span id="l4.237">                       in AString aLeafName,</span>
<a href="#l4.238"></a><span id="l4.238">                       in nsIUrlListener aUrlListener);</span>
<a href="#l4.239"></a><span id="l4.239">   </span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-  nsIURI listFolder(in nsIEventTarget aClientEventTarget, </span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+  nsIURI listFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.242"></a><span id="l4.242">                     in nsIMsgFolder aMailFolder,</span>
<a href="#l4.243"></a><span id="l4.243">                     in nsIUrlListener aUrlListener);</span>
<a href="#l4.244"></a><span id="l4.244"> </span>
<a href="#l4.245"></a><span id="l4.245">   nsIURI subscribeFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l4.246"></a><span id="l4.246">                          in nsIMsgFolder aMailFolder,</span>
<a href="#l4.247"></a><span id="l4.247">                          in AString mailboxName,</span>
<a href="#l4.248"></a><span id="l4.248">                          in nsIUrlListener aUrlListener);</span>
<a href="#l4.249"></a><span id="l4.249"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/public/nsIMsgImapMailFolder.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/public/nsIMsgImapMailFolder.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -73,17 +73,17 @@ interface nsIMsgImapFolderProps : nsISup</span>
<a href="#l5.4"></a><span id="l5.4">     void setQuotaStatus(in AString folderQuotaStatus);</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6">     /**</span>
<a href="#l5.7"></a><span id="l5.7">      * Updates the quota data displayed in the Quota tab.</span>
<a href="#l5.8"></a><span id="l5.8">      */</span>
<a href="#l5.9"></a><span id="l5.9">     void setQuotaData(in ACString quotaroot, in unsigned long usedKB, in unsigned long maxKB);</span>
<a href="#l5.10"></a><span id="l5.10"> };</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-[scriptable, uuid(22b0aac7-937e-46b2-bb6f-ea1190697596)]</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+[scriptable, uuid(1a06d2c2-c6fd-4212-af70-6774e5d0c066)]</span>
<a href="#l5.14"></a><span id="l5.14"> interface nsIMsgImapMailFolder : nsISupports {</span>
<a href="#l5.15"></a><span id="l5.15">   void removeSubFolder(in nsIMsgFolder folder);</span>
<a href="#l5.16"></a><span id="l5.16">   void createClientSubfolderInfo(in ACString folderName, in char hierarchyDelimiter,</span>
<a href="#l5.17"></a><span id="l5.17">                                  in long flags, in boolean suppressNotification);</span>
<a href="#l5.18"></a><span id="l5.18">   void list();</span>
<a href="#l5.19"></a><span id="l5.19">   void renameLocal(in ACString newname, in nsIMsgFolder parent);</span>
<a href="#l5.20"></a><span id="l5.20">   void prepareToRename();</span>
<a href="#l5.21"></a><span id="l5.21">   void performExpand(in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -110,16 +110,36 @@ interface nsIMsgImapMailFolder : nsISupp</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24">   void fillInFolderProps(in nsIMsgImapFolderProps aFolderProps);</span>
<a href="#l5.25"></a><span id="l5.25">   void resetNamespaceReferences();</span>
<a href="#l5.26"></a><span id="l5.26">   void folderPrivileges(in nsIMsgWindow aWindow);</span>
<a href="#l5.27"></a><span id="l5.27">   nsIMsgImapMailFolder findOnlineSubFolder(in ACString onlineName);</span>
<a href="#l5.28"></a><span id="l5.28">   void addFolderRights(in ACString userName, in ACString rights);</span>
<a href="#l5.29"></a><span id="l5.29">   void refreshFolderRights();</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+  /**</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+   * Mark the header as pending removal from the offline store. This also</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+   * increases the expungedBytes count on the folder so we know there's </span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+   * more local disk space to be reclaimed.</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+   *</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+   * @param aHdr     msg hdr to mark pending removal from offline store.</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+   *</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+   */</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  void markPendingRemoval(in nsIMsgDBHdr aHdr);</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+  /**</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+   * Issue an expunge of this folder to the imap server.</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+   *</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+   * @param aUrlListener     url listener, can be null</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+   * @param aWindow          msg window url is running in, can be null</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+   *</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+   * @returns                status of attempt to run url.</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+   */</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+  void expunge(in nsIUrlListener aListener, in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+</span>
<a href="#l5.51"></a><span id="l5.51">   void updateStatus(in nsIUrlListener aListener, in nsIMsgWindow aMsgWindow);</span>
<a href="#l5.52"></a><span id="l5.52">   void updateFolderWithListener(in nsIMsgWindow aMsgWindow, in nsIUrlListener aListener);</span>
<a href="#l5.53"></a><span id="l5.53">   // this is used to issue an arbitrary imap command on the passed in msgs.</span>
<a href="#l5.54"></a><span id="l5.54">   // It assumes the command needs to be run in the selected state.</span>
<a href="#l5.55"></a><span id="l5.55">   nsIURI issueCommandOnMsgs(in ACString command, in string uids, in nsIMsgWindow aWindow);</span>
<a href="#l5.56"></a><span id="l5.56">   nsIURI fetchCustomMsgAttribute(in ACString msgAttribute, in string uids, in nsIMsgWindow aWindow);</span>
<a href="#l5.57"></a><span id="l5.57">   nsIURI storeCustomKeywords(in nsIMsgWindow aMsgWindow,</span>
<a href="#l5.58"></a><span id="l5.58">                       in ACString aFlagsToAdd,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1203,23 +1203,46 @@ NS_IMETHODIMP nsImapMailFolder::Compact(</span>
<a href="#l6.4"></a><span id="l6.4">   nsresult rv = GetDatabase();</span>
<a href="#l6.5"></a><span id="l6.5">   // now's a good time to apply the retention settings. If we do delete any</span>
<a href="#l6.6"></a><span id="l6.6">   // messages, the expunge is going to have to wait until the delete to</span>
<a href="#l6.7"></a><span id="l6.7">   // finish before it can run, but the multiple-connection protection code</span>
<a href="#l6.8"></a><span id="l6.8">   // should handle that.</span>
<a href="#l6.9"></a><span id="l6.9">   if (mDatabase)</span>
<a href="#l6.10"></a><span id="l6.10">     ApplyRetentionSettings();</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  // We're not compacting the offline store here since that can interfere</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  // with the online compact. Offline stores should get compacted in the</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  // background.</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  // We should be able to compact the offline store now that this should</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+  // just be called by the UI.</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+  if (aMsgWindow &amp;&amp; (mFlags &amp; nsMsgFolderFlags::Offline))</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+    CompactOfflineStore(aMsgWindow, nsnull);</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+  return Expunge(aListener, aMsgWindow);</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+}</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+NS_IMETHODIMP nsImapMailFolder::MarkPendingRemoval(nsIMsgDBHdr *aHdr)</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+{</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+  PRUint32 offlineMessageSize;</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+  aHdr-&gt;GetOfflineMessageSize(&amp;offlineMessageSize);</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+  aHdr-&gt;SetStringProperty(&quot;pendingRemoval&quot;, &quot;1&quot;);</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+  nsresult rv = GetDatabase();</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  rv = mDatabase-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+  return dbFolderInfo-&gt;ChangeExpungedBytes(offlineMessageSize);</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+}</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+NS_IMETHODIMP nsImapMailFolder::Expunge(nsIUrlListener *aListener,</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+                                        nsIMsgWindow *aMsgWindow)</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+{</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+  nsresult rv;</span>
<a href="#l6.41"></a><span id="l6.41">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-  return  imapService-&gt;Expunge(m_thread, this, aListener, nsnull);</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+  return imapService-&gt;Expunge(m_thread, this, aListener, aMsgWindow, nsnull);</span>
<a href="#l6.48"></a><span id="l6.48"> }</span>
<a href="#l6.49"></a><span id="l6.49"> </span>
<a href="#l6.50"></a><span id="l6.50"> NS_IMETHODIMP nsImapMailFolder::CompactAll(nsIUrlListener *aListener,</span>
<a href="#l6.51"></a><span id="l6.51">                                                nsIMsgWindow *aMsgWindow,</span>
<a href="#l6.52"></a><span id="l6.52">                                                PRBool aCompactOfflineAlso)</span>
<a href="#l6.53"></a><span id="l6.53"> {</span>
<a href="#l6.54"></a><span id="l6.54">   nsresult rv;</span>
<a href="#l6.55"></a><span id="l6.55">   nsCOMPtr&lt;nsIMutableArray&gt; folderArray, offlineFolderArray;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1542,23 +1542,24 @@ NS_IMETHODIMP nsImapService::UpdateFolde</span>
<a href="#l7.4"></a><span id="l7.4">                                                 nsIUrlListener *aUrlListener, </span>
<a href="#l7.5"></a><span id="l7.5">                                                 nsIURI **aURL)</span>
<a href="#l7.6"></a><span id="l7.6"> {</span>
<a href="#l7.7"></a><span id="l7.7">   return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l7.8"></a><span id="l7.8">                        &quot;/folderstatus&gt;&quot;, nsIImapUrl::nsImapFolderStatus, nsnull, aURL);</span>
<a href="#l7.9"></a><span id="l7.9"> }</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> // Expunge, used to &quot;compress&quot; an imap folder,removes deleted messages.</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-NS_IMETHODIMP nsImapService::Expunge(nsIEventTarget *aClientEventTarget, </span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+NS_IMETHODIMP nsImapService::Expunge(nsIEventTarget *aClientEventTarget,</span>
<a href="#l7.14"></a><span id="l7.14">                                      nsIMsgFolder *aImapMailFolder,</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-                                     nsIUrlListener *aUrlListener, </span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+                                     nsIUrlListener *aUrlListener,</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+                                     nsIMsgWindow *aMsgWindow,</span>
<a href="#l7.18"></a><span id="l7.18">                                      nsIURI **aURL)</span>
<a href="#l7.19"></a><span id="l7.19"> {</span>
<a href="#l7.20"></a><span id="l7.20">   return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-                       &quot;/Expunge&gt;&quot;, nsIImapUrl::nsImapExpungeFolder, nsnull, aURL);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+                       &quot;/Expunge&gt;&quot;, nsIImapUrl::nsImapExpungeFolder, aMsgWindow, aURL);</span>
<a href="#l7.23"></a><span id="l7.23"> }</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25"> /* old-stle biff that doesn't download headers */</span>
<a href="#l7.26"></a><span id="l7.26"> NS_IMETHODIMP nsImapService::Biff(nsIEventTarget *aClientEventTarget, </span>
<a href="#l7.27"></a><span id="l7.27">                                   nsIMsgFolder *aImapMailFolder,</span>
<a href="#l7.28"></a><span id="l7.28">                                   nsIUrlListener *aUrlListener, </span>
<a href="#l7.29"></a><span id="l7.29">                                   nsIURI **aURL,</span>
<a href="#l7.30"></a><span id="l7.30">                                   PRUint32 uidHighWater)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_compactOfflineStore.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_compactOfflineStore.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -6,17 +6,17 @@</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> const gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l8.8"></a><span id="l8.8">                        .getService(Ci.nsIMsgMessageService);</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> // Globals</span>
<a href="#l8.11"></a><span id="l8.11"> var gRootFolder;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-var gIMAPInbox, gIMAPTrashFolder;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+var gIMAPInbox, gIMAPTrashFolder, gMsgImapInboxFolder;</span>
<a href="#l8.14"></a><span id="l8.14"> var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l8.15"></a><span id="l8.15"> var gImapInboxOfflineStoreSize;</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17"> const gMsgFile1 = do_get_file(&quot;../../mailnews/data/bugmail10&quot;);</span>
<a href="#l8.18"></a><span id="l8.18"> const gMsgFile2 = do_get_file(&quot;../../mailnews/data/bugmail11&quot;);</span>
<a href="#l8.19"></a><span id="l8.19"> const gMsgFile3 = do_get_file(&quot;../../mailnews/data/draft1&quot;);</span>
<a href="#l8.20"></a><span id="l8.20"> const gMsgFile4 = do_get_file(&quot;../../mailnews/data/bugmail7&quot;);</span>
<a href="#l8.21"></a><span id="l8.21"> const gMsgFile5 = do_get_file(&quot;../../mailnews/data/bugmail6&quot;);</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -41,17 +41,38 @@ function addMessagesToServer(messages, m</span>
<a href="#l8.23"></a><span id="l8.23">     message.spec = URI.spec;</span>
<a href="#l8.24"></a><span id="l8.24">   });</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26">   // Create the imapMessages and store them on the mailbox</span>
<a href="#l8.27"></a><span id="l8.27">   messages.forEach(function (message)</span>
<a href="#l8.28"></a><span id="l8.28">   {</span>
<a href="#l8.29"></a><span id="l8.29">     mailbox.addMessage(new imapMessage(message.spec, mailbox.uidnext++, []));</span>
<a href="#l8.30"></a><span id="l8.30">   });</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+}</span>
<a href="#l8.32"></a><span id="l8.32"> </span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+function checkOfflineStore(prevOfflineStoreSize) {</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+  dump(&quot;checking offline store\n&quot;);</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+  let offset = new Object;</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+  let size = new Object;</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+  let enumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+  if (enumerator)</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+  {</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+    while (enumerator.hasMoreElements())</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+    {</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+      let header = enumerator.getNext();</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+      // this will verify that the message in the offline store</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+      // starts with &quot;From &quot; - otherwise, it returns an error.</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+      if (header instanceof Components.interfaces.nsIMsgDBHdr &amp;&amp;</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+         (header.flags &amp; Ci.nsMsgMessageFlags.Offline)</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+        gIMAPInbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+    }</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  }</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+  // check that the offline store shrunk by at least 100 bytes.</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  // (exact calculation might be fragile).</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+  do_check_true(prevOfflineStoreSize &gt; gIMAPInbox.filePath.fileSize + 100);</span>
<a href="#l8.53"></a><span id="l8.53"> }</span>
<a href="#l8.54"></a><span id="l8.54"> </span>
<a href="#l8.55"></a><span id="l8.55"> const gTestArray =</span>
<a href="#l8.56"></a><span id="l8.56"> [</span>
<a href="#l8.57"></a><span id="l8.57">   function downloadForOffline() {</span>
<a href="#l8.58"></a><span id="l8.58">     // ...and download for offline use.</span>
<a href="#l8.59"></a><span id="l8.59">     dump(&quot;Downloading for offline use\n&quot;);</span>
<a href="#l8.60"></a><span id="l8.60">     gIMAPInbox.downloadAllForOffline(UrlListener, null);</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineat">@@ -66,37 +87,32 @@ const gTestArray =</span>
<a href="#l8.62"></a><span id="l8.62">     // hack to force uid validity to get initialized for trash.</span>
<a href="#l8.63"></a><span id="l8.63">     gIMAPTrash.updateFolder(null);</span>
<a href="#l8.64"></a><span id="l8.64">   },</span>
<a href="#l8.65"></a><span id="l8.65">   function compactOfflineStore() {</span>
<a href="#l8.66"></a><span id="l8.66">     dump(&quot;compacting offline store\n&quot;);</span>
<a href="#l8.67"></a><span id="l8.67">     gImapInboxOfflineStoreSize = gIMAPInbox.filePath.fileSize;</span>
<a href="#l8.68"></a><span id="l8.68">     gRootFolder.compactAll(UrlListener, null, true);</span>
<a href="#l8.69"></a><span id="l8.69">   },</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-  function checkOfflineStore() {</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-    dump(&quot;checking offline store\n&quot;);</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-    let offset = new Object;</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-    let size = new Object;</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-    let enumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-    if (enumerator)</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-    {</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-      while (enumerator.hasMoreElements())</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-      {</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-        var header = enumerator.getNext();</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-        // this will verify that the message in the offline store</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-        // starts with &quot;From &quot; - otherwise, it returns an error.</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-        if (header instanceof Components.interfaces.nsIMsgDBHdr)</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-          gIMAPInbox.getOfflineFileStream(header.messageKey, offset, size);</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-      }</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-    }</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-    // check that the offline store shrunk by at least 100 bytes.</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-    // (exact calculation might be fragile).</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-    do_check_true(gImapInboxOfflineStoreSize &gt; gIMAPInbox.filePath.fileSize + 100);</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+  function checkCompactionResult() {</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+    checkOfflineStore(gImapInboxOfflineStoreSize);</span>
<a href="#l8.91"></a><span id="l8.91">     UrlListener.OnStopRunningUrl(null, 0);</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-  }</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+  },</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+  function testPendingRemoval() {</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+    let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+    gMsgImapInboxFolder.markPendingRemoval(msgHdr);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+    gImapInboxOfflineStoreSize = gIMAPInbox.filePath.fileSize;</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+    gRootFolder.compactAll(UrlListener, null, true);</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+  },</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+  function checkCompactionResult() {</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+    checkOfflineStore(gImapInboxOfflineStoreSize);</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+    UrlListener.OnStopRunningUrl(null, 0);</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+    let msgHdr = gIMAPInbox.msgDatabase.getMsgHdrForMessageID(gMsgId2);</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+    do_check_eq(msgHdr.flags &amp; Ci.nsMsgMessageFlags.Offline, 0);</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+  },</span>
<a href="#l8.106"></a><span id="l8.106"> ];</span>
<a href="#l8.107"></a><span id="l8.107"> </span>
<a href="#l8.108"></a><span id="l8.108"> function run_test()</span>
<a href="#l8.109"></a><span id="l8.109"> {</span>
<a href="#l8.110"></a><span id="l8.110">   // This is before any of the actual tests, so...</span>
<a href="#l8.111"></a><span id="l8.111">   gTest = 0;</span>
<a href="#l8.112"></a><span id="l8.112"> </span>
<a href="#l8.113"></a><span id="l8.113">   // Add a listener.</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineat">@@ -135,23 +151,23 @@ function run_test()</span>
<a href="#l8.115"></a><span id="l8.115">   // We aren't interested in downloading messages automatically</span>
<a href="#l8.116"></a><span id="l8.116">   prefBranch.setBoolPref(&quot;mail.server.server1.download_on_biff&quot;, false);</span>
<a href="#l8.117"></a><span id="l8.117"> </span>
<a href="#l8.118"></a><span id="l8.118">   // Get the server list...</span>
<a href="#l8.119"></a><span id="l8.119">   gIMAPIncomingServer.performExpand(null);</span>
<a href="#l8.120"></a><span id="l8.120"> </span>
<a href="#l8.121"></a><span id="l8.121">   gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l8.122"></a><span id="l8.122">   gIMAPInbox = gRootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-  msgImapFolder = gIMAPInbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+  gMsgImapInboxFolder = gIMAPInbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l8.125"></a><span id="l8.125">   // these hacks are required because we've created the inbox before</span>
<a href="#l8.126"></a><span id="l8.126">   // running initial folder discovery, and adding the folder bails</span>
<a href="#l8.127"></a><span id="l8.127">   // out before we set it as verified online, so we bail out, and</span>
<a href="#l8.128"></a><span id="l8.128">   // then remove the INBOX folder since it's not verified.</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-  msgImapFolder.hierarchyDelimiter = '/';</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-  msgImapFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+  gMsgImapInboxFolder.hierarchyDelimiter = '/';</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+  gMsgImapInboxFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l8.133"></a><span id="l8.133"> </span>
<a href="#l8.134"></a><span id="l8.134"> </span>
<a href="#l8.135"></a><span id="l8.135">   // Add a couple of messages to the INBOX</span>
<a href="#l8.136"></a><span id="l8.136">   // this is synchronous, afaik</span>
<a href="#l8.137"></a><span id="l8.137">   addMessagesToServer([{file: gMsgFile1, messageId: gMsgId1},</span>
<a href="#l8.138"></a><span id="l8.138">                         {file: gMsgFile4, messageId: gMsgId4},</span>
<a href="#l8.139"></a><span id="l8.139">                          {file: gMsgFile5, messageId: gMsgId5},</span>
<a href="#l8.140"></a><span id="l8.140">                         {file: gMsgFile2, messageId: gMsgId2}],</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineat">@@ -179,27 +195,33 @@ function doTest(test)</span>
<a href="#l8.142"></a><span id="l8.142">     } catch(ex) {dump(ex);}</span>
<a href="#l8.143"></a><span id="l8.143">   }</span>
<a href="#l8.144"></a><span id="l8.144">   else</span>
<a href="#l8.145"></a><span id="l8.145">   {</span>
<a href="#l8.146"></a><span id="l8.146">     // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l8.147"></a><span id="l8.147">     // server</span>
<a href="#l8.148"></a><span id="l8.148">     gRootFolder = null;</span>
<a href="#l8.149"></a><span id="l8.149">     gIMAPInbox = null;</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+    gMsgImapFolder = null;</span>
<a href="#l8.151"></a><span id="l8.151">     gIMAPTrashFolder = null;</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-    gServer.resetTest();</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-    gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-    gServer.performTest();</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-    gServer.stop();</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-    let thread = gThreadManager.currentThread;</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-    while (thread.hasPendingEvents())</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-      thread.processNextEvent(true);</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+    do_timeout_function(1000, endTest);</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+  }</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+}</span>
<a href="#l8.162"></a><span id="l8.162"> </span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-    do_test_finished(); // for the one in run_test()</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-  }</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+function endTest()</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+{</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+  gServer.resetTest();</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+  gServer.performTest();</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+  gServer.stop();</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+  let thread = gThreadManager.currentThread;</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+  while (thread.hasPendingEvents())</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+    thread.processNextEvent(true);</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+  do_test_finished(); // for the one in run_test()</span>
<a href="#l8.176"></a><span id="l8.176"> }</span>
<a href="#l8.177"></a><span id="l8.177"> </span>
<a href="#l8.178"></a><span id="l8.178"> // nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l8.179"></a><span id="l8.179"> // is completed.</span>
<a href="#l8.180"></a><span id="l8.180"> var CopyListener = </span>
<a href="#l8.181"></a><span id="l8.181"> {</span>
<a href="#l8.182"></a><span id="l8.182">   OnStartCopy: function() {},</span>
<a href="#l8.183"></a><span id="l8.183">   OnProgress: function(aProgress, aProgressMax) {},</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

