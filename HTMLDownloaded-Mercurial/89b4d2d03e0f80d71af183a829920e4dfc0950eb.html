<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 14420:89b4d2d03e0f80d71af183a829920e4dfc0950eb</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 89b4d2d03e0f80d71af183a829920e4dfc0950eb" />
<meta property="og:url" content="/comm-central/rev/89b4d2d03e0f80d71af183a829920e4dfc0950eb" />
<meta property="og:description" content="Start using Services.jsm." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 89b4d2d03e0f80d71af183a829920e4dfc0950eb 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/89b4d2d03e0f80d71af183a829920e4dfc0950eb">shortlog</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/89b4d2d03e0f80d71af183a829920e4dfc0950eb">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb">files</a> |
changeset |
<a href="/comm-central/raw-rev/89b4d2d03e0f80d71af183a829920e4dfc0950eb">raw</a>  | <a href="/comm-central/archive/89b4d2d03e0f80d71af183a829920e4dfc0950eb.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Start using Services.jsm.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#108;&#111;&#114;&#105;&#97;&#110;&#32;&#81;&#117;&#232;&#122;&#101;&#32;&#60;&#102;&#108;&#111;&#114;&#105;&#97;&#110;&#64;&#105;&#110;&#115;&#116;&#97;&#110;&#116;&#98;&#105;&#114;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 05 Nov 2010 15:03:08 +0100</td></tr>

<tr>
 <td>changeset 14420</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/89b4d2d03e0f80d71af183a829920e4dfc0950eb">89b4d2d03e0f80d71af183a829920e4dfc0950eb</a></td>
</tr>



<tr>
<td>parent 14419</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bd5f22180a4756e8fa5e23de0a2d89864be26a89">bd5f22180a4756e8fa5e23de0a2d89864be26a89</a>
</td>
</tr>

<tr>
<td>child 14421</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9ccd3e4d24dc1f3cbfef703361e3bd27fb2c221c">9ccd3e4d24dc1f3cbfef703361e3bd27fb2c221c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=89b4d2d03e0f80d71af183a829920e4dfc0950eb">9778</a></td></tr>
<tr><td>push user</td><td>florian@queze.net</td></tr>
<tr><td>push date</td><td class="date age">Sun, 12 Jan 2014 18:25:45 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f81a23bfefcd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">Start using Services.jsm.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/account.js">im/content/account.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/account.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/account.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/account.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/account.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/account.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/accountWizard.js">im/content/accountWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/accountWizard.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/accountWizard.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/accountWizard.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/accountWizard.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/accountWizard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/accounts.js">im/content/accounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/accounts.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/accounts.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/accounts.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/accounts.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/accounts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/addbuddy.js">im/content/addbuddy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/addbuddy.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/addbuddy.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/addbuddy.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/addbuddy.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/addbuddy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/blist.js">im/content/blist.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/blist.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/blist.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/blist.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/blist.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/blist.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/buddy.xml">im/content/buddy.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/buddy.xml">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/buddy.xml">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/buddy.xml">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/buddy.xml">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/buddy.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/buddytooltip.xml">im/content/buddytooltip.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/buddytooltip.xml">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/buddytooltip.xml">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/buddytooltip.xml">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/buddytooltip.xml">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/buddytooltip.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/convZoom.js">im/content/convZoom.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/convZoom.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/convZoom.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/convZoom.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/convZoom.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/convZoom.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/convbrowser.xml">im/content/convbrowser.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/convbrowser.xml">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/convbrowser.xml">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/convbrowser.xml">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/convbrowser.xml">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/convbrowser.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/conversation.xml">im/content/conversation.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/conversation.xml">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/conversation.xml">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/conversation.xml">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/conversation.xml">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/conversation.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/core.js">im/content/core.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/core.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/core.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/core.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/core.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/core.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/debug/debug.js">im/content/debug/debug.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/debug/debug.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/debug/debug.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/debug/debug.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/debug/debug.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/debug/debug.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/joinchat.js">im/content/joinchat.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/joinchat.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/joinchat.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/joinchat.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/joinchat.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/joinchat.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/menus.js">im/content/menus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/menus.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/menus.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/menus.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/menus.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/menus.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/nsContextMenu.js">im/content/nsContextMenu.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/nsContextMenu.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/nsContextMenu.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/nsContextMenu.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/nsContextMenu.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/nsContextMenu.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/advanced.js">im/content/preferences/advanced.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/advanced.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/advanced.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/advanced.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/advanced.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/advanced.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/applications.js">im/content/preferences/applications.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/applications.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/applications.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/applications.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/applications.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/applications.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/connection.js">im/content/preferences/connection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/connection.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/connection.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/connection.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/connection.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/connection.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/main.js">im/content/preferences/main.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/main.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/main.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/main.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/main.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/main.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/messagestyle.js">im/content/preferences/messagestyle.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/messagestyle.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/messagestyle.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/messagestyle.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/messagestyle.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/messagestyle.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/privacy.js">im/content/preferences/privacy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/privacy.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/privacy.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/privacy.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/privacy.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/privacy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/themes.js">im/content/preferences/themes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/themes.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/themes.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/themes.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/themes.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/preferences/themes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/proxies.js">im/content/proxies.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/proxies.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/proxies.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/proxies.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/proxies.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/proxies.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/sound.js">im/content/sound.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/sound.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/sound.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/sound.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/sound.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/sound.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/tabbrowser.xml">im/content/tabbrowser.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/tabbrowser.xml">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/tabbrowser.xml">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/tabbrowser.xml">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/tabbrowser.xml">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/tabbrowser.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/utilities.js">im/content/utilities.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/utilities.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/utilities.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/utilities.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/utilities.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/utilities.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/viewlog.js">im/content/viewlog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/viewlog.js">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/viewlog.js">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/viewlog.js">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/viewlog.js">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/content/viewlog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/Makefile.in">im/modules/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/Makefile.in">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/Makefile.in">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/Makefile.in">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/Makefile.in">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imContentSink.jsm">im/modules/imContentSink.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imContentSink.jsm">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imContentSink.jsm">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imContentSink.jsm">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imContentSink.jsm">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imContentSink.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imServices.jsm">im/modules/imServices.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imServices.jsm">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imServices.jsm">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imServices.jsm">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imServices.jsm">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imServices.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imSmileys.jsm">im/modules/imSmileys.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imSmileys.jsm">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imSmileys.jsm">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imSmileys.jsm">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imSmileys.jsm">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imSmileys.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imTextboxUtils.jsm">im/modules/imTextboxUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imTextboxUtils.jsm">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imTextboxUtils.jsm">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imTextboxUtils.jsm">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imTextboxUtils.jsm">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imTextboxUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imThemes.jsm">im/modules/imThemes.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imThemes.jsm">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imThemes.jsm">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imThemes.jsm">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imThemes.jsm">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imThemes.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imWindows.jsm">im/modules/imWindows.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imWindows.jsm">file</a> |
<a href="/comm-central/annotate/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imWindows.jsm">annotate</a> |
<a href="/comm-central/diff/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imWindows.jsm">diff</a> |
<a href="/comm-central/comparison/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imWindows.jsm">comparison</a> |
<a href="/comm-central/log/89b4d2d03e0f80d71af183a829920e4dfc0950eb/im/modules/imWindows.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/im/content/account.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/im/content/account.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -52,38 +52,36 @@ var account = {</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">     if (this.proto.noPassword)</span>
<a href="#l1.6"></a><span id="l1.6">       document.getElementById(&quot;passwordBox&quot;).hidden = true;</span>
<a href="#l1.7"></a><span id="l1.7">     else</span>
<a href="#l1.8"></a><span id="l1.8">       document.getElementById(&quot;password&quot;).value = this.account.password;</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10">     document.getElementById(&quot;alias&quot;).value = this.account.alias;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    this.prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                                 .getService(Ci.nsIPrefService);</span>
<a href="#l1.14"></a><span id="l1.14">     let protoId = this.proto.id;</span>
<a href="#l1.15"></a><span id="l1.15">     if (protoId == &quot;prpl-irc&quot; || protoId == &quot;prpl-jabber&quot; ||</span>
<a href="#l1.16"></a><span id="l1.16">         protoId == &quot;prpl-gtalk&quot;) {</span>
<a href="#l1.17"></a><span id="l1.17">       document.getElementById(&quot;optionalSeparator&quot;).hidden = false;</span>
<a href="#l1.18"></a><span id="l1.18">       document.getElementById(&quot;autojoinBox&quot;).hidden = false;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-      var branch = this.prefService.getBranch(&quot;messenger.account.&quot; +</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-                                              this.account.id + &quot;.&quot;);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+      var branch = Services.prefs.getBranch(&quot;messenger.account.&quot; +</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+                                            this.account.id + &quot;.&quot;);</span>
<a href="#l1.23"></a><span id="l1.23">       if (branch.prefHasUserValue(autoJoinPref)) {</span>
<a href="#l1.24"></a><span id="l1.24">         document.getElementById(&quot;autojoin&quot;).value =</span>
<a href="#l1.25"></a><span id="l1.25">           branch.getCharPref(autoJoinPref);</span>
<a href="#l1.26"></a><span id="l1.26">       }</span>
<a href="#l1.27"></a><span id="l1.27">     }</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29"> /* FIXME</span>
<a href="#l1.30"></a><span id="l1.30">     document.getElementById(&quot;newMailNotification&quot;).hidden =</span>
<a href="#l1.31"></a><span id="l1.31">       !this.proto.newMailNotification;</span>
<a href="#l1.32"></a><span id="l1.32"> */</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-    this.prefs = this.prefService.getBranch(&quot;messenger.account.&quot; +</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-                                            this.account.id + &quot;.options.&quot;);</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+    this.prefs = Services.prefs.getBranch(&quot;messenger.account.&quot; +</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+                                          this.account.id + &quot;.options.&quot;);</span>
<a href="#l1.38"></a><span id="l1.38">     this.populateProtoSpecificBox();</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40">     this.proxy = this.account.proxyInfo;</span>
<a href="#l1.41"></a><span id="l1.41">     this.displayProxyDescription();</span>
<a href="#l1.42"></a><span id="l1.42"> </span>
<a href="#l1.43"></a><span id="l1.43">     addObservers(this, events);</span>
<a href="#l1.44"></a><span id="l1.44">     window.addEventListener(&quot;unload&quot;, this.unload, false);</span>
<a href="#l1.45"></a><span id="l1.45">   },</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineat">@@ -98,19 +96,17 @@ var account = {</span>
<a href="#l1.47"></a><span id="l1.47">   },</span>
<a href="#l1.48"></a><span id="l1.48"> </span>
<a href="#l1.49"></a><span id="l1.49">   displayProxyDescription: function aw_displayProxyDescription() {</span>
<a href="#l1.50"></a><span id="l1.50">     var type = this.proxy.type;</span>
<a href="#l1.51"></a><span id="l1.51">     var bundle = document.getElementById(&quot;proxiesBundle&quot;);</span>
<a href="#l1.52"></a><span id="l1.52">     var proxy;</span>
<a href="#l1.53"></a><span id="l1.53">     var result;</span>
<a href="#l1.54"></a><span id="l1.54">     if (type == Ci.purpleIProxyInfo.useGlobal) {</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-      proxy = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-                        .getService(Ci.purpleICoreService)</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-                        .globalProxy;</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+      proxy = Services.core.globalProxy;</span>
<a href="#l1.59"></a><span id="l1.59">       type = proxy.type;</span>
<a href="#l1.60"></a><span id="l1.60">     }</span>
<a href="#l1.61"></a><span id="l1.61">     else</span>
<a href="#l1.62"></a><span id="l1.62">       proxy = this.proxy;</span>
<a href="#l1.63"></a><span id="l1.63"> </span>
<a href="#l1.64"></a><span id="l1.64">     if (type == Ci.purpleIProxyInfo.noProxy)</span>
<a href="#l1.65"></a><span id="l1.65">       result = bundle.getString(&quot;proxies.directConnection&quot;);</span>
<a href="#l1.66"></a><span id="l1.66"> </span>
<a href="#l1.67"></a><span id="l1.67" class="difflineat">@@ -266,18 +262,18 @@ var account = {</span>
<a href="#l1.68"></a><span id="l1.68"> </span>
<a href="#l1.69"></a><span id="l1.69">     var alias = this.getValue(&quot;alias&quot;);</span>
<a href="#l1.70"></a><span id="l1.70">     if (alias != this.account.alias)</span>
<a href="#l1.71"></a><span id="l1.71">       this.account.alias = alias;</span>
<a href="#l1.72"></a><span id="l1.72"> </span>
<a href="#l1.73"></a><span id="l1.73">     let protoId = this.proto.id;</span>
<a href="#l1.74"></a><span id="l1.74">     if (protoId == &quot;prpl-irc&quot; || protoId == &quot;prpl-jabber&quot; ||</span>
<a href="#l1.75"></a><span id="l1.75">         protoId == &quot;prpl-gtalk&quot;) {</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-      var branch = this.prefService.getBranch(&quot;messenger.account.&quot; +</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-                                              this.account.id + &quot;.&quot;);</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+      var branch = Services.prefs.getBranch(&quot;messenger.account.&quot; +</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+                                            this.account.id + &quot;.&quot;);</span>
<a href="#l1.80"></a><span id="l1.80">       var autojoin = this.getValue(&quot;autojoin&quot;);</span>
<a href="#l1.81"></a><span id="l1.81">       if (autojoin || branch.prefHasUserValue(autoJoinPref))</span>
<a href="#l1.82"></a><span id="l1.82">         branch.setCharPref(autoJoinPref, autojoin);</span>
<a href="#l1.83"></a><span id="l1.83">     }</span>
<a href="#l1.84"></a><span id="l1.84"> </span>
<a href="#l1.85"></a><span id="l1.85">     if (this.account.proxyInfo.key != this.proxy.key) {</span>
<a href="#l1.86"></a><span id="l1.86">       this.account.proxyInfo = this.proxy;</span>
<a href="#l1.87"></a><span id="l1.87">       connectionInfoHasChanged = true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/im/content/accountWizard.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/im/content/accountWizard.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -42,18 +42,16 @@ const events = [</span>
<a href="#l2.4"></a><span id="l2.4">   &quot;purple-quit&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> ];</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> var accountWizard = {</span>
<a href="#l2.8"></a><span id="l2.8">   onload: function aw_onload() {</span>
<a href="#l2.9"></a><span id="l2.9">     accountWizard.setGetMoreProtocols();</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">     var protoList = document.getElementById(&quot;protolist&quot;);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    this.pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-                         .getService(Ci.purpleICoreService);</span>
<a href="#l2.14"></a><span id="l2.14">     var protos = [];</span>
<a href="#l2.15"></a><span id="l2.15">     for (let proto in this.getProtocols())</span>
<a href="#l2.16"></a><span id="l2.16">       protos.push(proto);</span>
<a href="#l2.17"></a><span id="l2.17">     protos.sort(function(a, b) a.name &lt; b.name ? -1 : a.name &gt; b.name ? 1 : 0);</span>
<a href="#l2.18"></a><span id="l2.18">     protos.forEach(function(proto) {</span>
<a href="#l2.19"></a><span id="l2.19">       var id = proto.id;</span>
<a href="#l2.20"></a><span id="l2.20">       var item = protoList.appendItem(proto.name, id, id);</span>
<a href="#l2.21"></a><span id="l2.21">       item.setAttribute(&quot;image&quot;, proto.iconBaseURI + &quot;icon.png&quot;);</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -101,17 +99,17 @@ var accountWizard = {</span>
<a href="#l2.23"></a><span id="l2.23">     var exists = accountWizard.proto.accountExists(name);</span>
<a href="#l2.24"></a><span id="l2.24">     wizard.canAdvance = !exists;</span>
<a href="#l2.25"></a><span id="l2.25">     duplicateWarning.hidden = !exists;</span>
<a href="#l2.26"></a><span id="l2.26">   },</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28">   selectProtocol: function aw_selectProtocol() {</span>
<a href="#l2.29"></a><span id="l2.29">     var protoList = document.getElementById(&quot;protolist&quot;);</span>
<a href="#l2.30"></a><span id="l2.30">     var id = protoList.selectedItem.value;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-    this.proto = this.pcs.getProtocolById(id);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+    this.proto = Services.core.getProtocolById(id);</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34">     return true;</span>
<a href="#l2.35"></a><span id="l2.35">   },</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38">   insertUsernameField: function aw_insertUsernameField(aName, aLabel, aParent,</span>
<a href="#l2.39"></a><span id="l2.39">                                                        aDefaultValue) {</span>
<a href="#l2.40"></a><span id="l2.40">     var hbox = document.createElement(&quot;hbox&quot;);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineat">@@ -215,17 +213,17 @@ var accountWizard = {</span>
<a href="#l2.42"></a><span id="l2.42">   },</span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44">   displayProxyDescription: function aw_displayProxyDescription() {</span>
<a href="#l2.45"></a><span id="l2.45">     var type = this.proxy.type;</span>
<a href="#l2.46"></a><span id="l2.46">     var bundle = document.getElementById(&quot;proxiesBundle&quot;);</span>
<a href="#l2.47"></a><span id="l2.47">     var proxy;</span>
<a href="#l2.48"></a><span id="l2.48">     var result;</span>
<a href="#l2.49"></a><span id="l2.49">     if (type == Ci.purpleIProxyInfo.useGlobal) {</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-      proxy = this.pcs.globalProxy;</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+      proxy = Services.core.globalProxy;</span>
<a href="#l2.52"></a><span id="l2.52">       type = proxy.type;</span>
<a href="#l2.53"></a><span id="l2.53">     }</span>
<a href="#l2.54"></a><span id="l2.54">     else</span>
<a href="#l2.55"></a><span id="l2.55">       proxy = this.proxy;</span>
<a href="#l2.56"></a><span id="l2.56"> </span>
<a href="#l2.57"></a><span id="l2.57">     if (type == Ci.purpleIProxyInfo.noProxy)</span>
<a href="#l2.58"></a><span id="l2.58">       result = bundle.getString(&quot;proxies.directConnection&quot;);</span>
<a href="#l2.59"></a><span id="l2.59"> </span>
<a href="#l2.60"></a><span id="l2.60" class="difflineat">@@ -436,17 +434,17 @@ var accountWizard = {</span>
<a href="#l2.61"></a><span id="l2.61">     for (let i = 0; i &lt; this.prefs.length; ++i) {</span>
<a href="#l2.62"></a><span id="l2.62">       let opt = this.prefs[i];</span>
<a href="#l2.63"></a><span id="l2.63">       let label = bundle.getFormattedString(&quot;accountColon&quot;, [opt.opt.label]);</span>
<a href="#l2.64"></a><span id="l2.64">       rows.appendChild(this.createSummaryRow(label, opt.value));</span>
<a href="#l2.65"></a><span id="l2.65">     }</span>
<a href="#l2.66"></a><span id="l2.66">   },</span>
<a href="#l2.67"></a><span id="l2.67"> </span>
<a href="#l2.68"></a><span id="l2.68">   createAccount: function aw_createAccount() {</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-    var acc = this.pcs.createAccount(this.username, this.proto.id);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+    var acc = Services.core.createAccount(this.username, this.proto.id);</span>
<a href="#l2.71"></a><span id="l2.71">     if (!this.proto.noPassword) {</span>
<a href="#l2.72"></a><span id="l2.72">       acc.password = this.password;</span>
<a href="#l2.73"></a><span id="l2.73">       acc.rememberPassword = true;</span>
<a href="#l2.74"></a><span id="l2.74">     }</span>
<a href="#l2.75"></a><span id="l2.75">     if (this.alias)</span>
<a href="#l2.76"></a><span id="l2.76">       acc.alias = this.alias;</span>
<a href="#l2.77"></a><span id="l2.77">     //FIXME: newMailNotification</span>
<a href="#l2.78"></a><span id="l2.78"> </span>
<a href="#l2.79"></a><span id="l2.79" class="difflineat">@@ -494,17 +492,17 @@ var accountWizard = {</span>
<a href="#l2.80"></a><span id="l2.80">   getValue: function aw_getValue(aId) {</span>
<a href="#l2.81"></a><span id="l2.81">     var elt = document.getElementById(aId);</span>
<a href="#l2.82"></a><span id="l2.82">     if (&quot;checked&quot; in elt)</span>
<a href="#l2.83"></a><span id="l2.83">       return elt.checked;</span>
<a href="#l2.84"></a><span id="l2.84">     return elt.value;</span>
<a href="#l2.85"></a><span id="l2.85">   },</span>
<a href="#l2.86"></a><span id="l2.86"> </span>
<a href="#l2.87"></a><span id="l2.87">   getProtocols: function aw_getProtocols() {</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-    return getIter(this.pcs.getProtocols());</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+    return getIter(Services.core.getProtocols());</span>
<a href="#l2.90"></a><span id="l2.90">   },</span>
<a href="#l2.91"></a><span id="l2.91">   getProtoOptions: function aw_getProtoOptions() {</span>
<a href="#l2.92"></a><span id="l2.92">     return getIter(this.proto.getOptions());</span>
<a href="#l2.93"></a><span id="l2.93">   },</span>
<a href="#l2.94"></a><span id="l2.94">   getProtoUserSplits: function aw_getProtoUserSplits() {</span>
<a href="#l2.95"></a><span id="l2.95">     return getIter(this.proto.getUsernameSplit());</span>
<a href="#l2.96"></a><span id="l2.96">   },</span>
<a href="#l2.97"></a><span id="l2.97"> </span>
<a href="#l2.98"></a><span id="l2.98" class="difflineat">@@ -544,19 +542,17 @@ var accountWizard = {</span>
<a href="#l2.99"></a><span id="l2.99">    *  Stripped down code from preferences/themes.js</span>
<a href="#l2.100"></a><span id="l2.100">    */</span>
<a href="#l2.101"></a><span id="l2.101">   setGetMoreProtocols: function (){</span>
<a href="#l2.102"></a><span id="l2.102">     let prefURL = PREF_EXTENSIONS_GETMOREPROTOCOLSURL;</span>
<a href="#l2.103"></a><span id="l2.103">     var getMore = document.getElementById(&quot;getMoreProtocols&quot;);</span>
<a href="#l2.104"></a><span id="l2.104">     var showGetMore = false;</span>
<a href="#l2.105"></a><span id="l2.105">     const nsIPrefBranch2 = Components.interfaces.nsIPrefBranch2;</span>
<a href="#l2.106"></a><span id="l2.106"> </span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-    if (Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-                  .getService(nsIPrefBranch2)</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-                  .getPrefType(prefURL) != nsIPrefBranch2.PREF_INVALID) {</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+    if (Services.prefs.getPrefType(prefURL) != nsIPrefBranch2.PREF_INVALID) {</span>
<a href="#l2.111"></a><span id="l2.111">       try {</span>
<a href="#l2.112"></a><span id="l2.112">         var getMoreURL = Components.classes[&quot;@mozilla.org/toolkit/URLFormatterService;1&quot;]</span>
<a href="#l2.113"></a><span id="l2.113">                                    .getService(Components.interfaces.nsIURLFormatter)</span>
<a href="#l2.114"></a><span id="l2.114">                                    .formatURLPref(prefURL);</span>
<a href="#l2.115"></a><span id="l2.115">         getMore.setAttribute(&quot;getMoreURL&quot;, getMoreURL);</span>
<a href="#l2.116"></a><span id="l2.116">         showGetMore = getMoreURL != &quot;about:blank&quot;;</span>
<a href="#l2.117"></a><span id="l2.117">       }</span>
<a href="#l2.118"></a><span id="l2.118">       catch (e) { }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/im/content/accounts.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/im/content/accounts.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -256,45 +256,39 @@ var gAccountManager = {</span>
<a href="#l3.4"></a><span id="l3.4">     }, this._disabledDelay, this.accountList.selectedItem);</span>
<a href="#l3.5"></a><span id="l3.5">   },</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7">   delete: function am_delete() {</span>
<a href="#l3.8"></a><span id="l3.8">     var selectedItem = this.accountList.selectedItem;</span>
<a href="#l3.9"></a><span id="l3.9">     if (!selectedItem)</span>
<a href="#l3.10"></a><span id="l3.10">       return;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-                          .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-    var showPrompt = prefs.getBoolPref(&quot;messenger.accounts.promptOnDelete&quot;);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    var showPrompt =</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+      Services.prefs.getBoolPref(&quot;messenger.accounts.promptOnDelete&quot;);</span>
<a href="#l3.18"></a><span id="l3.18">     if (showPrompt) {</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-      var prompts = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-                              .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+      var prompts = Services.prompt;</span>
<a href="#l3.23"></a><span id="l3.23">       var bundle = document.getElementById(&quot;accountsBundle&quot;);</span>
<a href="#l3.24"></a><span id="l3.24">       var promptTitle    = bundle.getString(&quot;account.deletePrompt.title&quot;);</span>
<a href="#l3.25"></a><span id="l3.25">       var promptMessage  = bundle.getString(&quot;account.deletePrompt.message&quot;);</span>
<a href="#l3.26"></a><span id="l3.26">       var promptCheckbox = bundle.getString(&quot;account.deletePrompt.checkbox&quot;);</span>
<a href="#l3.27"></a><span id="l3.27">       var deleteButton   = bundle.getString(&quot;account.deletePrompt.button&quot;);</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">       var checkbox = {};</span>
<a href="#l3.30"></a><span id="l3.30">       var flags = prompts.BUTTON_TITLE_IS_STRING * prompts.BUTTON_POS_0 +</span>
<a href="#l3.31"></a><span id="l3.31">                   prompts.BUTTON_TITLE_CANCEL * prompts.BUTTON_POS_1 +</span>
<a href="#l3.32"></a><span id="l3.32">                   prompts.BUTTON_POS_1_DEFAULT;</span>
<a href="#l3.33"></a><span id="l3.33">       if (prompts.confirmEx(window, promptTitle, promptMessage, flags,</span>
<a href="#l3.34"></a><span id="l3.34">                             deleteButton, null, null, promptCheckbox, checkbox))</span>
<a href="#l3.35"></a><span id="l3.35">         return;</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37">       if (checkbox.value)</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-        prefs.setBoolPref(&quot;messenger.accounts.promptOnDelete&quot;, false);</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+        Services.prefs.setBoolPref(&quot;messenger.accounts.promptOnDelete&quot;, false);</span>
<a href="#l3.40"></a><span id="l3.40">     }</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-    var pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-                        .getService(Ci.purpleICoreService);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-    pcs.deleteAccount(selectedItem.id);</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+    Services.core.deleteAccount(selectedItem.id);</span>
<a href="#l3.46"></a><span id="l3.46">   },</span>
<a href="#l3.47"></a><span id="l3.47">   new: function am_new() {</span>
<a href="#l3.48"></a><span id="l3.48">     this.openDialog(&quot;chrome://instantbird/content/accountWizard.xul&quot;);</span>
<a href="#l3.49"></a><span id="l3.49">   },</span>
<a href="#l3.50"></a><span id="l3.50">   edit: function am_edit() {</span>
<a href="#l3.51"></a><span id="l3.51">     this.openDialog(&quot;chrome://instantbird/content/account.xul&quot;,</span>
<a href="#l3.52"></a><span id="l3.52">                     this.accountList.selectedItem.account);</span>
<a href="#l3.53"></a><span id="l3.53">   },</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineat">@@ -444,35 +438,28 @@ var gAccountManager = {</span>
<a href="#l3.55"></a><span id="l3.55"> </span>
<a href="#l3.56"></a><span id="l3.56">     let newIndex = accountList.selectedIndex + aOffset;</span>
<a href="#l3.57"></a><span id="l3.57">     if (newIndex &lt; 0)</span>
<a href="#l3.58"></a><span id="l3.58">       newIndex = 0;</span>
<a href="#l3.59"></a><span id="l3.59">     else if (newIndex &gt;= accountList.itemCount)</span>
<a href="#l3.60"></a><span id="l3.60">       newIndex = accountList.itemCount - 1;</span>
<a href="#l3.61"></a><span id="l3.61">     array.splice(newIndex, 0, selectedID);</span>
<a href="#l3.62"></a><span id="l3.62"> </span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-    Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-              .getService(Components.interfaces.nsIPrefBranch)</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-              .setCharPref(&quot;messenger.accounts&quot;, array.join(&quot;,&quot;));</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+    Services.prefs.setCharPref(&quot;messenger.accounts&quot;, array.join(&quot;,&quot;));</span>
<a href="#l3.67"></a><span id="l3.67">   },</span>
<a href="#l3.68"></a><span id="l3.68"> </span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-  getAccounts: function am_getAccounts() {</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-    var pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-                        .getService(Ci.purpleICoreService);</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-    return getIter(pcs.getAccounts());</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-  },</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  getAccounts: function am_getAccounts() getIter(Services.core.getAccounts()),</span>
<a href="#l3.75"></a><span id="l3.75"> </span>
<a href="#l3.76"></a><span id="l3.76">   openDialog: function am_openDialog(aUrl, aArgs) {</span>
<a href="#l3.77"></a><span id="l3.77">     this.modalDialog = true;</span>
<a href="#l3.78"></a><span id="l3.78">     window.openDialog(aUrl, &quot;&quot;, &quot;chrome,modal,titlebar,centerscreen&quot;, aArgs);</span>
<a href="#l3.79"></a><span id="l3.79">     this.modalDialog = false;</span>
<a href="#l3.80"></a><span id="l3.80">   },</span>
<a href="#l3.81"></a><span id="l3.81">   setAutoLoginNotification: function am_setAutoLoginNotification() {</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-    var pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-                        .getService(Ci.purpleICoreService);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+    var pcs = Services.core;</span>
<a href="#l3.85"></a><span id="l3.85">     var autoLoginStatus = pcs.autoLoginStatus;</span>
<a href="#l3.86"></a><span id="l3.86">     let isOffline = false;</span>
<a href="#l3.87"></a><span id="l3.87">     let crashCount = 0;</span>
<a href="#l3.88"></a><span id="l3.88">     for (let acc in this.getAccounts())</span>
<a href="#l3.89"></a><span id="l3.89">       if (acc.autoLogin &amp;&amp; acc.firstConnectionState == acc.FIRST_CONNECTION_CRASHED)</span>
<a href="#l3.90"></a><span id="l3.90">         ++crashCount;</span>
<a href="#l3.91"></a><span id="l3.91"> </span>
<a href="#l3.92"></a><span id="l3.92">     if (autoLoginStatus == pcs.AUTOLOGIN_ENABLED &amp;&amp; crashCount == 0) {</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineat">@@ -523,26 +510,23 @@ var gAccountManager = {</span>
<a href="#l3.94"></a><span id="l3.94">       default:</span>
<a href="#l3.95"></a><span id="l3.95">         label = bundle.getString(&quot;accountsManager.notification.other.label&quot;);</span>
<a href="#l3.96"></a><span id="l3.96">     }</span>
<a href="#l3.97"></a><span id="l3.97">     this.setOffline(isOffline || pcs.currentStatusType == pcs.STATUS_OFFLINE);</span>
<a href="#l3.98"></a><span id="l3.98"> </span>
<a href="#l3.99"></a><span id="l3.99">     box.appendNotification(label, &quot;autologinStatus&quot;, null, priority, [connectNowButton]);</span>
<a href="#l3.100"></a><span id="l3.100">   },</span>
<a href="#l3.101"></a><span id="l3.101">   processAutoLogin: function am_processAutoLogin() {</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-    var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-                              .getService(Components.interfaces.nsIIOService2);</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+    var ioService = Services.io;</span>
<a href="#l3.105"></a><span id="l3.105">     if (ioService.offline) {</span>
<a href="#l3.106"></a><span id="l3.106">       ioService.manageOfflineStatus = false;</span>
<a href="#l3.107"></a><span id="l3.107">       ioService.offline = false;</span>
<a href="#l3.108"></a><span id="l3.108">     }</span>
<a href="#l3.109"></a><span id="l3.109"> </span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-    Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-              .getService(Ci.purpleICoreService)</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-              .processAutoLogin();</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+    Services.core.processAutoLogin();</span>
<a href="#l3.114"></a><span id="l3.114"> </span>
<a href="#l3.115"></a><span id="l3.115">     gAccountManager.accountList.selectedItem.buttons.setFocus();</span>
<a href="#l3.116"></a><span id="l3.116">   },</span>
<a href="#l3.117"></a><span id="l3.117">   processCrashedAccountsLogin: function am_processCrashedAccountsLogin() {</span>
<a href="#l3.118"></a><span id="l3.118">     for (let acc in gAccountManager.getAccounts())</span>
<a href="#l3.119"></a><span id="l3.119">       if (acc.disconnected &amp;&amp; acc.autoLogin &amp;&amp;</span>
<a href="#l3.120"></a><span id="l3.120">           acc.firstConnectionState == acc.FIRST_CONNECTION_CRASHED)</span>
<a href="#l3.121"></a><span id="l3.121">         acc.connect();</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineat">@@ -569,19 +553,18 @@ let gAMDragAndDrop = {</span>
<a href="#l3.123"></a><span id="l3.123">   ACCOUNT_MIME_TYPE: &quot;application/x-moz-richlistitem&quot;,</span>
<a href="#l3.124"></a><span id="l3.124">   // Size of the scroll zone on the top and on the bottom of the account list</span>
<a href="#l3.125"></a><span id="l3.125">   MAGIC_SCROLL_HEIGHT: 20,</span>
<a href="#l3.126"></a><span id="l3.126"> </span>
<a href="#l3.127"></a><span id="l3.127">   // A preference already exists to define scroll speed, let's use it.</span>
<a href="#l3.128"></a><span id="l3.128">   get SCROLL_SPEED() {</span>
<a href="#l3.129"></a><span id="l3.129">     delete this.SCROLL_SPEED;</span>
<a href="#l3.130"></a><span id="l3.130">     try {</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-      this.SCROLL_SPEED = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-                            .getService(Ci.nsIPrefBranch2)</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-                            .getIntPref(&quot;toolkit.scrollbox.scrollIncrement&quot;);</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+      this.SCROLL_SPEED =</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+        Services.prefs.getIntPref(&quot;toolkit.scrollbox.scrollIncrement&quot;);</span>
<a href="#l3.136"></a><span id="l3.136">     }</span>
<a href="#l3.137"></a><span id="l3.137">     catch (e) {</span>
<a href="#l3.138"></a><span id="l3.138">       this.SCROLL_SPEED = 20;</span>
<a href="#l3.139"></a><span id="l3.139">     }</span>
<a href="#l3.140"></a><span id="l3.140">     return this.SCROLL_SPEED;</span>
<a href="#l3.141"></a><span id="l3.141">   },</span>
<a href="#l3.142"></a><span id="l3.142"> </span>
<a href="#l3.143"></a><span id="l3.143">   onDragStart: function amdnd_onDragStart(aEvent, aTransferData, aAction) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/im/content/addbuddy.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/im/content/addbuddy.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -33,68 +33,60 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.5"></a><span id="l4.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.6"></a><span id="l4.6">  *</span>
<a href="#l4.7"></a><span id="l4.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> var addBuddy = {</span>
<a href="#l4.11"></a><span id="l4.11">   onload: function ab_onload() {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    this.pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                         .getService(Ci.purpleICoreService);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-    this.pts = Components.classes[&quot;@instantbird.org/purple/tags-service;1&quot;]</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-                         .getService(Ci.imITagsService);</span>
<a href="#l4.16"></a><span id="l4.16">     this.buildAccountList();</span>
<a href="#l4.17"></a><span id="l4.17">     this.buildTagList();</span>
<a href="#l4.18"></a><span id="l4.18">   },</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20">   buildAccountList: function ab_buildAccountList() {</span>
<a href="#l4.21"></a><span id="l4.21">     var accountList = document.getElementById(&quot;accountlist&quot;);</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-    for (let acc in this.getAccounts()) {</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+    for (let acc in getIter(Services.core.getAccounts())) {</span>
<a href="#l4.24"></a><span id="l4.24">       if (!acc.connected)</span>
<a href="#l4.25"></a><span id="l4.25">         continue;</span>
<a href="#l4.26"></a><span id="l4.26">       var proto = acc.protocol;</span>
<a href="#l4.27"></a><span id="l4.27">       var item = accountList.appendItem(acc.name, acc.id, proto.name);</span>
<a href="#l4.28"></a><span id="l4.28">       item.setAttribute(&quot;image&quot;, proto.iconBaseURI + &quot;icon.png&quot;);</span>
<a href="#l4.29"></a><span id="l4.29">       item.setAttribute(&quot;class&quot;, &quot;menuitem-iconic&quot;);</span>
<a href="#l4.30"></a><span id="l4.30">     }</span>
<a href="#l4.31"></a><span id="l4.31">     if (!accountList.itemCount) {</span>
<a href="#l4.32"></a><span id="l4.32">       document.getElementById(&quot;addBuddyDialog&quot;).cancelDialog();</span>
<a href="#l4.33"></a><span id="l4.33">       throw &quot;No connected account!&quot;;</span>
<a href="#l4.34"></a><span id="l4.34">     }</span>
<a href="#l4.35"></a><span id="l4.35">     accountList.selectedIndex = 0;</span>
<a href="#l4.36"></a><span id="l4.36">   },</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38">   buildTagList: function ab_buildTagList() {</span>
<a href="#l4.39"></a><span id="l4.39">     var tagList = document.getElementById(&quot;taglist&quot;);</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-    let tags = this.pts.getTags();</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+    let tags = Services.tags.getTags();</span>
<a href="#l4.42"></a><span id="l4.42">     if (!tags.length) {</span>
<a href="#l4.43"></a><span id="l4.43">       let bundle = document.getElementById(&quot;instantbirdBundle&quot;);</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-      tags.push(this.pts.createTag(bundle.getString(&quot;defaultGroup&quot;)));</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+      tags.push(Services.tags.createTag(bundle.getString(&quot;defaultGroup&quot;)));</span>
<a href="#l4.46"></a><span id="l4.46">     }</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48">     tags.forEach(function (tag) {</span>
<a href="#l4.49"></a><span id="l4.49">       tagList.appendItem(tag.name, tag.id);</span>
<a href="#l4.50"></a><span id="l4.50">     });</span>
<a href="#l4.51"></a><span id="l4.51">     tagList.selectedIndex = 0;</span>
<a href="#l4.52"></a><span id="l4.52">   },</span>
<a href="#l4.53"></a><span id="l4.53"> </span>
<a href="#l4.54"></a><span id="l4.54">   getValue: function ab_getValue(aId) document.getElementById(aId).value,</span>
<a href="#l4.55"></a><span id="l4.55"> </span>
<a href="#l4.56"></a><span id="l4.56">   create: function ab_create() {</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-    var account = this.pcs.getAccountById(this.getValue(&quot;accountlist&quot;));</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+    var account = Services.core.getAccountById(this.getValue(&quot;accountlist&quot;));</span>
<a href="#l4.59"></a><span id="l4.59">     var name = this.getValue(&quot;name&quot;);</span>
<a href="#l4.60"></a><span id="l4.60"> </span>
<a href="#l4.61"></a><span id="l4.61">     var tag;</span>
<a href="#l4.62"></a><span id="l4.62">     var taglist = document.getElementById(&quot;taglist&quot;);</span>
<a href="#l4.63"></a><span id="l4.63">     var items = taglist.getElementsByAttribute(&quot;label&quot;, taglist.label);</span>
<a href="#l4.64"></a><span id="l4.64">     if (items.length)</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-      tag = this.pts.getTagById(items[0].value);</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+      tag = Services.tags.getTagById(items[0].value);</span>
<a href="#l4.67"></a><span id="l4.67">     else</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-      tag = this.pts.createTag(taglist.label);</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+      tag = Services.tags.createTag(taglist.label);</span>
<a href="#l4.70"></a><span id="l4.70"> </span>
<a href="#l4.71"></a><span id="l4.71">     account.addBuddy(tag, name);</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-  },</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-  getAccounts: function ab_getAccounts() {</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-    return getIter(this.pcs.getAccounts());</span>
<a href="#l4.76"></a><span id="l4.76">   }</span>
<a href="#l4.77"></a><span id="l4.77"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/im/content/blist.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/im/content/blist.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -78,33 +78,30 @@ buddyListContextMenu.prototype = {</span>
<a href="#l5.4"></a><span id="l5.4">     if (this.onBuddy)</span>
<a href="#l5.5"></a><span id="l5.5">       this.target.openConversation();</span>
<a href="#l5.6"></a><span id="l5.6">   },</span>
<a href="#l5.7"></a><span id="l5.7">   alias: function blcm_alias() {</span>
<a href="#l5.8"></a><span id="l5.8">     if (this.onBuddy)</span>
<a href="#l5.9"></a><span id="l5.9">       this.target.startAliasing();</span>
<a href="#l5.10"></a><span id="l5.10">   },</span>
<a href="#l5.11"></a><span id="l5.11">   delete: function blcm_delete() {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    var prompts = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-                            .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l5.14"></a><span id="l5.14">     let bundle =</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-      Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-                .getService(Components.interfaces.nsIStringBundleService)</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-                .createBundle(&quot;chrome://instantbird/locale/instantbird.properties&quot;);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+      Services.strings.createBundle(&quot;chrome://instantbird/locale/instantbird.properties&quot;);</span>
<a href="#l5.19"></a><span id="l5.19">     let contact = this.target.contact;</span>
<a href="#l5.20"></a><span id="l5.20">     let displayName = contact.displayName;</span>
<a href="#l5.21"></a><span id="l5.21">     let promptTitle = bundle.formatStringFromName(&quot;buddy.deletePrompt.title&quot;,</span>
<a href="#l5.22"></a><span id="l5.22">                                                   [displayName], 1);</span>
<a href="#l5.23"></a><span id="l5.23">     let userName = contact.preferredBuddy.userName;</span>
<a href="#l5.24"></a><span id="l5.24">     if (displayName != userName)</span>
<a href="#l5.25"></a><span id="l5.25">       displayName += &quot; (&quot; + userName + &quot;)&quot;;</span>
<a href="#l5.26"></a><span id="l5.26">     let proto = contact.preferredBuddy.protocol.name; // FIXME build a list</span>
<a href="#l5.27"></a><span id="l5.27">     let promptMessage = bundle.formatStringFromName(&quot;buddy.deletePrompt.message&quot;,</span>
<a href="#l5.28"></a><span id="l5.28">                                                     [displayName, proto], 2);</span>
<a href="#l5.29"></a><span id="l5.29">     let deleteButton = bundle.GetStringFromName(&quot;buddy.deletePrompt.button&quot;);</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+    let prompts = Services.prompt;</span>
<a href="#l5.31"></a><span id="l5.31">     let flags = prompts.BUTTON_TITLE_IS_STRING * prompts.BUTTON_POS_0 +</span>
<a href="#l5.32"></a><span id="l5.32">                 prompts.BUTTON_TITLE_CANCEL * prompts.BUTTON_POS_1 +</span>
<a href="#l5.33"></a><span id="l5.33">                 prompts.BUTTON_POS_1_DEFAULT;</span>
<a href="#l5.34"></a><span id="l5.34">     if (prompts.confirmEx(window, promptTitle, promptMessage, flags,</span>
<a href="#l5.35"></a><span id="l5.35">                           deleteButton, null, null, null, {}))</span>
<a href="#l5.36"></a><span id="l5.36">       return;</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38">     this.target.remove();</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineat">@@ -114,107 +111,89 @@ buddyListContextMenu.prototype = {</span>
<a href="#l5.40"></a><span id="l5.40">       return;</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42">     let popup = document.getElementById(&quot;context-moveto-popup&quot;);</span>
<a href="#l5.43"></a><span id="l5.43">     let item;</span>
<a href="#l5.44"></a><span id="l5.44">     while ((item = popup.firstChild) &amp;&amp; item.localName != &quot;menuseparator&quot;)</span>
<a href="#l5.45"></a><span id="l5.45">       popup.removeChild(item);</span>
<a href="#l5.46"></a><span id="l5.46"> </span>
<a href="#l5.47"></a><span id="l5.47">     let groupId = this.target.group.groupId;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-    let pts = Components.classes[&quot;@instantbird.org/purple/tags-service;1&quot;]</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-                        .getService(Ci.imITagsService);</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-</span>
<a href="#l5.51"></a><span id="l5.51">     let sortFunction = function (a, b) {</span>
<a href="#l5.52"></a><span id="l5.52">       let [a, b] = [a.name.toLowerCase(), b.name.toLowerCase()];</span>
<a href="#l5.53"></a><span id="l5.53">       return a &lt; b ? 1 : a &gt; b ? -1 : 0;</span>
<a href="#l5.54"></a><span id="l5.54">     };</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-    pts.getTags()</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-       .sort(sortFunction)</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-       .forEach(function (aTag) {</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+    Services.tags.getTags()</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+            .sort(sortFunction)</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+            .forEach(function (aTag) {</span>
<a href="#l5.61"></a><span id="l5.61">       item = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l5.62"></a><span id="l5.62">       item.setAttribute(&quot;label&quot;, aTag.name);</span>
<a href="#l5.63"></a><span id="l5.63">       item.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l5.64"></a><span id="l5.64">       let id = aTag.id;</span>
<a href="#l5.65"></a><span id="l5.65">       item.groupId = id;</span>
<a href="#l5.66"></a><span id="l5.66">       if (groupId == id)</span>
<a href="#l5.67"></a><span id="l5.67">         item.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l5.68"></a><span id="l5.68">       popup.insertBefore(item, popup.firstChild);</span>
<a href="#l5.69"></a><span id="l5.69">     });</span>
<a href="#l5.70"></a><span id="l5.70">   },</span>
<a href="#l5.71"></a><span id="l5.71">   moveTo: function blcm_moveTo(aEvent) {</span>
<a href="#l5.72"></a><span id="l5.72">     let item = aEvent.originalTarget;</span>
<a href="#l5.73"></a><span id="l5.73">     if (item.groupId)</span>
<a href="#l5.74"></a><span id="l5.74">       this.target.moveTo(item.groupId);</span>
<a href="#l5.75"></a><span id="l5.75">   },</span>
<a href="#l5.76"></a><span id="l5.76">   moveToNewTag: function blcm_moveToNewTag() {</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-    let prompts =</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-      Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-                .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l5.80"></a><span id="l5.80">     let bundle =</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-      Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-                .getService(Components.interfaces.nsIStringBundleService)</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-                .createBundle(&quot;chrome://instantbird/locale/instantbird.properties&quot;);</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+      Services.strings.createBundle(&quot;chrome://instantbird/locale/instantbird.properties&quot;);</span>
<a href="#l5.85"></a><span id="l5.85">     let title = bundle.GetStringFromName(&quot;newGroupPromptTitle&quot;);</span>
<a href="#l5.86"></a><span id="l5.86">     let message = bundle.GetStringFromName(&quot;newGroupPromptMessage&quot;);</span>
<a href="#l5.87"></a><span id="l5.87">     let name = {};</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-    if (!prompts.prompt(window, title, message, name, null,</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-                        {value: false}) || !name.value)</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+    if (!Services.prompt.prompt(window, title, message, name, null,</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+                                {value: false}) || !name.value)</span>
<a href="#l5.92"></a><span id="l5.92">       return; // the user canceled</span>
<a href="#l5.93"></a><span id="l5.93"> </span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-    let pts = Components.classes[&quot;@instantbird.org/purple/tags-service;1&quot;]</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-                        .getService(Ci.imITagsService);</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-    let tag = pts.getTagByName(name.value) || pts.createTag(name.value);</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-    this.target.moveTo(tag.id);</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+    // If the tag already exists, createTag will return it.</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+    this.target.moveTo(Services.tags.createTag(name.value).id);</span>
<a href="#l5.100"></a><span id="l5.100">   },</span>
<a href="#l5.101"></a><span id="l5.101">   showLogs: function blcm_showLogs() {</span>
<a href="#l5.102"></a><span id="l5.102">     if (!this.onBuddy)</span>
<a href="#l5.103"></a><span id="l5.103">       return;</span>
<a href="#l5.104"></a><span id="l5.104"> </span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-    var logger = Components.classes[&quot;@instantbird.org/logger;1&quot;]</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-                           .getService(Ci.ibILogger);</span>
<a href="#l5.107"></a><span id="l5.107">     var logs = [];</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-    for (let log in getIter(logger.getLogsForContact(this.target.contact)))</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+    let contact = this.target.contact;</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+    for (let log in getIter(Services.logs.getLogsForContact(contact)))</span>
<a href="#l5.111"></a><span id="l5.111">       logs.push(log);</span>
<a href="#l5.112"></a><span id="l5.112">     window.openDialog(&quot;chrome://instantbird/content/viewlog.xul&quot;,</span>
<a href="#l5.113"></a><span id="l5.113">                       &quot;Logs&quot;, &quot;chrome,resizable&quot;, {logs: logs},</span>
<a href="#l5.114"></a><span id="l5.114">                       this.target.getAttribute(&quot;displayname&quot;));</span>
<a href="#l5.115"></a><span id="l5.115">   },</span>
<a href="#l5.116"></a><span id="l5.116">   toggleShowOfflineBuddies: function blcm_toggleShowOfflineBuddies() {</span>
<a href="#l5.117"></a><span id="l5.117">     let newValue =</span>
<a href="#l5.118"></a><span id="l5.118">       !!document.getElementById(&quot;context-show-offline-buddies&quot;)</span>
<a href="#l5.119"></a><span id="l5.119">                 .getAttribute(&quot;checked&quot;);</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-    Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-              .getService(Components.interfaces.nsIPrefBranch2)</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-              .setBoolPref(showOfflineBuddiesPref, newValue);</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+    Services.prefs.setBoolPref(showOfflineBuddiesPref, newValue);</span>
<a href="#l5.124"></a><span id="l5.124">   }</span>
<a href="#l5.125"></a><span id="l5.125"> };</span>
<a href="#l5.126"></a><span id="l5.126"> </span>
<a href="#l5.127"></a><span id="l5.127"> var buddyList = {</span>
<a href="#l5.128"></a><span id="l5.128">   observe: function bl_observe(aSubject, aTopic, aMsg) {</span>
<a href="#l5.129"></a><span id="l5.129">     if (aTopic == &quot;purple-quit&quot;) {</span>
<a href="#l5.130"></a><span id="l5.130">       window.close();</span>
<a href="#l5.131"></a><span id="l5.131">       return;</span>
<a href="#l5.132"></a><span id="l5.132">     }</span>
<a href="#l5.133"></a><span id="l5.133"> </span>
<a href="#l5.134"></a><span id="l5.134">     if (aTopic == &quot;nsPref:changed&quot; &amp;&amp; aMsg == showOfflineBuddiesPref) {</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-      let prefBranch =</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-        Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-                  .getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-      let showOffline = prefBranch.getBoolPref(showOfflineBuddiesPref);</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+      let showOffline = Services.prefs.getBoolPref(showOfflineBuddiesPref);</span>
<a href="#l5.140"></a><span id="l5.140">       this._showOffline = showOffline;</span>
<a href="#l5.141"></a><span id="l5.141">       let item = document.getElementById(&quot;context-show-offline-buddies&quot;);</span>
<a href="#l5.142"></a><span id="l5.142">       if (showOffline)</span>
<a href="#l5.143"></a><span id="l5.143">         item.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l5.144"></a><span id="l5.144">       else</span>
<a href="#l5.145"></a><span id="l5.145">         item.removeAttribute(&quot;checked&quot;);</span>
<a href="#l5.146"></a><span id="l5.146"> </span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-      let pts = Components.classes[&quot;@instantbird.org/purple/tags-service;1&quot;]</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-                          .getService(Ci.imITagsService);</span>
<a href="#l5.149"></a><span id="l5.149">       let blistBox = document.getElementById(&quot;buddylistbox&quot;);</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-      pts.getTags().forEach(function (aTag) {</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+      Services.tags.getTags().forEach(function (aTag) {</span>
<a href="#l5.152"></a><span id="l5.152">         let elt = document.getElementById(&quot;group&quot; + aTag.id);</span>
<a href="#l5.153"></a><span id="l5.153">         if (elt)</span>
<a href="#l5.154"></a><span id="l5.154">           elt.showOffline = showOffline;</span>
<a href="#l5.155"></a><span id="l5.155">         else if (showOffline) {</span>
<a href="#l5.156"></a><span id="l5.156">           elt = document.createElement(&quot;group&quot;);</span>
<a href="#l5.157"></a><span id="l5.157">           blistBox.appendChild(elt);</span>
<a href="#l5.158"></a><span id="l5.158">           elt._showOffline = true;</span>
<a href="#l5.159"></a><span id="l5.159">           if (!elt.build(aTag))</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineat">@@ -258,34 +237,31 @@ var buddyList = {</span>
<a href="#l5.161"></a><span id="l5.161">     }</span>
<a href="#l5.162"></a><span id="l5.162">   },</span>
<a href="#l5.163"></a><span id="l5.163"> </span>
<a href="#l5.164"></a><span id="l5.164">   displayStatusType: function bl_displayStatusType(aStatusType) {</span>
<a href="#l5.165"></a><span id="l5.165">     document.getElementById(&quot;statusMessage&quot;)</span>
<a href="#l5.166"></a><span id="l5.166">             .setAttribute(&quot;statusType&quot;, aStatusType);</span>
<a href="#l5.167"></a><span id="l5.167"> </span>
<a href="#l5.168"></a><span id="l5.168">     let bundle =</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-      Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-                .getService(Components.interfaces.nsIStringBundleService)</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-                .createBundle(&quot;chrome://instantbird/locale/instantbird.properties&quot;);</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+      Services.strings.createBundle(&quot;chrome://instantbird/locale/instantbird.properties&quot;);</span>
<a href="#l5.173"></a><span id="l5.173">     let statusString;</span>
<a href="#l5.174"></a><span id="l5.174">     try {</span>
<a href="#l5.175"></a><span id="l5.175">       // In some odd cases, this function could be called for an</span>
<a href="#l5.176"></a><span id="l5.176">       // unknown status type.</span>
<a href="#l5.177"></a><span id="l5.177">       statusString = bundle.GetStringFromName(aStatusType + &quot;StatusType&quot;);</span>
<a href="#l5.178"></a><span id="l5.178">     } catch (e) { }</span>
<a href="#l5.179"></a><span id="l5.179">     let statusTypeIcon = document.getElementById(&quot;statusTypeIcon&quot;);</span>
<a href="#l5.180"></a><span id="l5.180">     statusTypeIcon.setAttribute(&quot;status&quot;, aStatusType);</span>
<a href="#l5.181"></a><span id="l5.181">     statusTypeIcon.setAttribute(&quot;tooltiptext&quot;, statusString);</span>
<a href="#l5.182"></a><span id="l5.182">     return statusString;</span>
<a href="#l5.183"></a><span id="l5.183">   },</span>
<a href="#l5.184"></a><span id="l5.184"> </span>
<a href="#l5.185"></a><span id="l5.185">   displayCurrentStatus: function bl_displayCurrentStatus() {</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-    var pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-                        .getService(Ci.purpleICoreService);</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+    let pcs = Services.core;</span>
<a href="#l5.189"></a><span id="l5.189">     let message = pcs.currentStatusMessage;</span>
<a href="#l5.190"></a><span id="l5.190">     let status = &quot;unknown&quot;;</span>
<a href="#l5.191"></a><span id="l5.191">     let statusType = pcs.currentStatusType;</span>
<a href="#l5.192"></a><span id="l5.192">     if (statusType == Ci.purpleICoreService.STATUS_AVAILABLE)</span>
<a href="#l5.193"></a><span id="l5.193">       status = &quot;available&quot;;</span>
<a href="#l5.194"></a><span id="l5.194">     else if (statusType == Ci.purpleICoreService.STATUS_UNAVAILABLE)</span>
<a href="#l5.195"></a><span id="l5.195">       status = &quot;unavailable&quot;;</span>
<a href="#l5.196"></a><span id="l5.196">     else if (statusType == Ci.purpleICoreService.STATUS_IDLE)</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineat">@@ -307,21 +283,18 @@ var buddyList = {</span>
<a href="#l5.198"></a><span id="l5.198">       message = statusString;</span>
<a href="#l5.199"></a><span id="l5.199">     }</span>
<a href="#l5.200"></a><span id="l5.200">     statusMessage.setAttribute(&quot;value&quot;, message);</span>
<a href="#l5.201"></a><span id="l5.201">     statusMessage.setAttribute(&quot;tooltiptext&quot;, message);</span>
<a href="#l5.202"></a><span id="l5.202">   },</span>
<a href="#l5.203"></a><span id="l5.203"> </span>
<a href="#l5.204"></a><span id="l5.204">   editStatus: function bl_editStatus(aEvent) {</span>
<a href="#l5.205"></a><span id="l5.205">     let status = aEvent.originalTarget.getAttribute(&quot;status&quot;);</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-    if (status == &quot;offline&quot;) {</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-      Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-                .getService(Ci.purpleICoreService)</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-                .setStatus(Ci.purpleICoreService.STATUS_OFFLINE, &quot;&quot;);</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineminus">-    }</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+    if (status == &quot;offline&quot;)</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+      Services.core.setStatus(Ci.purpleICoreService.STATUS_OFFLINE, &quot;&quot;);</span>
<a href="#l5.213"></a><span id="l5.213">     else if (status)</span>
<a href="#l5.214"></a><span id="l5.214">       this.startEditStatus(status);</span>
<a href="#l5.215"></a><span id="l5.215">   },</span>
<a href="#l5.216"></a><span id="l5.216"> </span>
<a href="#l5.217"></a><span id="l5.217">   startEditStatus: function bl_startEditStatus(aStatusType) {</span>
<a href="#l5.218"></a><span id="l5.218">     let currentStatusType =</span>
<a href="#l5.219"></a><span id="l5.219">       document.getElementById(&quot;statusTypeIcon&quot;).getAttribute(&quot;status&quot;);</span>
<a href="#l5.220"></a><span id="l5.220">     if (aStatusType != currentStatusType) {</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineat">@@ -340,21 +313,18 @@ var buddyList = {</span>
<a href="#l5.222"></a><span id="l5.222"> </span>
<a href="#l5.223"></a><span id="l5.223">     let elt = document.getElementById(&quot;statusMessage&quot;);</span>
<a href="#l5.224"></a><span id="l5.224">     if (!elt.hasAttribute(&quot;editing&quot;)) {</span>
<a href="#l5.225"></a><span id="l5.225">       elt.setAttribute(&quot;editing&quot;, &quot;true&quot;);</span>
<a href="#l5.226"></a><span id="l5.226">       elt.addEventListener(&quot;keypress&quot;, this.statusMessageKeyPress, false);</span>
<a href="#l5.227"></a><span id="l5.227">       elt.addEventListener(&quot;blur&quot;, this.statusMessageBlur, false);</span>
<a href="#l5.228"></a><span id="l5.228">       if (elt.hasAttribute(&quot;usingDefault&quot;)) {</span>
<a href="#l5.229"></a><span id="l5.229">         if (&quot;_statusTypeBeforeEditing&quot; in this &amp;&amp;</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineminus">-            this._statusTypeBeforeEditing == &quot;offline&quot;) {</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineminus">-          let pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineminus">-                        .getService(Ci.purpleICoreService);</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-          elt.setAttribute(&quot;value&quot;, pcs.currentStatusMessage);</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-        }</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+            this._statusTypeBeforeEditing == &quot;offline&quot;)</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+          elt.setAttribute(&quot;value&quot;, Services.core.currentStatusMessage);</span>
<a href="#l5.237"></a><span id="l5.237">         else</span>
<a href="#l5.238"></a><span id="l5.238">           elt.removeAttribute(&quot;value&quot;);</span>
<a href="#l5.239"></a><span id="l5.239">       }</span>
<a href="#l5.240"></a><span id="l5.240">       if (!(&quot;TextboxSpellChecker&quot; in window))</span>
<a href="#l5.241"></a><span id="l5.241">         Components.utils.import(&quot;resource:///modules/imTextboxUtils.jsm&quot;);</span>
<a href="#l5.242"></a><span id="l5.242">       TextboxSpellChecker.registerTextbox(elt);</span>
<a href="#l5.243"></a><span id="l5.243">       // force binding attachmant by forcing layout</span>
<a href="#l5.244"></a><span id="l5.244">       elt.getBoundingClientRect();</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineat">@@ -391,65 +361,58 @@ var buddyList = {</span>
<a href="#l5.246"></a><span id="l5.246">         buddyList.statusMessageRefreshTimer();</span>
<a href="#l5.247"></a><span id="l5.247">     }</span>
<a href="#l5.248"></a><span id="l5.248">   },</span>
<a href="#l5.249"></a><span id="l5.249"> </span>
<a href="#l5.250"></a><span id="l5.250">   finishEditStatusMessage: function bl_finishEditStatusMessage(aSave) {</span>
<a href="#l5.251"></a><span id="l5.251">     clearTimeout(this._stopEditStatusTimeout);</span>
<a href="#l5.252"></a><span id="l5.252">     let elt = document.getElementById(&quot;statusMessage&quot;);</span>
<a href="#l5.253"></a><span id="l5.253">     if (aSave) {</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineminus">-      var pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineminus">-                          .getService(Ci.purpleICoreService);</span>
<a href="#l5.256"></a><span id="l5.256">       let newStatus = Ci.purpleICoreService.STATUS_UNSET;</span>
<a href="#l5.257"></a><span id="l5.257">       if (&quot;_statusTypeEditing&quot; in this) {</span>
<a href="#l5.258"></a><span id="l5.258">         let statusType = this._statusTypeEditing;</span>
<a href="#l5.259"></a><span id="l5.259">         if (statusType == &quot;available&quot;)</span>
<a href="#l5.260"></a><span id="l5.260">           newStatus = Ci.purpleICoreService.STATUS_AVAILABLE;</span>
<a href="#l5.261"></a><span id="l5.261">         else if (statusType == &quot;unavailable&quot;)</span>
<a href="#l5.262"></a><span id="l5.262">           newStatus = Ci.purpleICoreService.STATUS_UNAVAILABLE;</span>
<a href="#l5.263"></a><span id="l5.263">         else if (statusType == &quot;offline&quot;)</span>
<a href="#l5.264"></a><span id="l5.264">           newStatus = Ci.purpleICoreService.STATUS_OFFLINE;</span>
<a href="#l5.265"></a><span id="l5.265">         delete this._statusTypeBeforeEditing;</span>
<a href="#l5.266"></a><span id="l5.266">         delete this._statusTypeEditing;</span>
<a href="#l5.267"></a><span id="l5.267">       }</span>
<a href="#l5.268"></a><span id="l5.268">       // apply the new status only if it is different from the current one</span>
<a href="#l5.269"></a><span id="l5.269">       if (newStatus != Ci.purpleICoreService.STATUS_UNSET ||</span>
<a href="#l5.270"></a><span id="l5.270">           elt.value != elt.getAttribute(&quot;value&quot;))</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineminus">-        pcs.setStatus(newStatus, elt.value);</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+        Services.core.setStatus(newStatus, elt.value);</span>
<a href="#l5.273"></a><span id="l5.273">     }</span>
<a href="#l5.274"></a><span id="l5.274">     else if (&quot;_statusTypeBeforeEditing&quot; in this) {</span>
<a href="#l5.275"></a><span id="l5.275">       this.displayStatusType(this._statusTypeBeforeEditing);</span>
<a href="#l5.276"></a><span id="l5.276">       delete this._statusTypeBeforeEditing;</span>
<a href="#l5.277"></a><span id="l5.277">       delete this._statusTypeEditing;</span>
<a href="#l5.278"></a><span id="l5.278">     }</span>
<a href="#l5.279"></a><span id="l5.279"> </span>
<a href="#l5.280"></a><span id="l5.280">     if (elt.hasAttribute(&quot;usingDefault&quot;))</span>
<a href="#l5.281"></a><span id="l5.281">       elt.setAttribute(&quot;value&quot;, elt.getAttribute(&quot;usingDefault&quot;));</span>
<a href="#l5.282"></a><span id="l5.282">     TextboxSpellChecker.unregisterTextbox(elt);</span>
<a href="#l5.283"></a><span id="l5.283">     elt.removeAttribute(&quot;editing&quot;);</span>
<a href="#l5.284"></a><span id="l5.284">     elt.removeEventListener(&quot;keypress&quot;, this.statusMessageKeyPress, false);</span>
<a href="#l5.285"></a><span id="l5.285">     elt.removeEventListener(&quot;blur&quot;, this.statusMessageBlur, false);</span>
<a href="#l5.286"></a><span id="l5.286">   },</span>
<a href="#l5.287"></a><span id="l5.287"> </span>
<a href="#l5.288"></a><span id="l5.288" class="difflineminus">-  getAccounts: function bl_getAccounts() {</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineminus">-    var pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineminus">-                        .getService(Ci.purpleICoreService);</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineminus">-    return getIter(pcs.getAccounts());</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineminus">-  },</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineplus">+  getAccounts: function bl_getAccounts() getIter(Services.core.getAccounts()),</span>
<a href="#l5.294"></a><span id="l5.294"> </span>
<a href="#l5.295"></a><span id="l5.295">   /* This function pops up the account manager is no account is</span>
<a href="#l5.296"></a><span id="l5.296">    * connected or connecting.</span>
<a href="#l5.297"></a><span id="l5.297">    * When called during startup (aIsStarting == true), it will also</span>
<a href="#l5.298"></a><span id="l5.298">    * look for crashed accounts.</span>
<a href="#l5.299"></a><span id="l5.299">    */</span>
<a href="#l5.300"></a><span id="l5.300">   showAccountManagerIfNeeded: function bl_showAccountManagerIfNeeded(aIsStarting) {</span>
<a href="#l5.301"></a><span id="l5.301">     // If the current status is offline, we don't need the account manager</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineminus">-    let pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineminus">-                        .getService(Ci.purpleICoreService);</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineminus">-    let isOffline = pcs.currentStatusType == pcs.STATUS_OFFLINE;</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+    let isOffline =</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+      Services.core.currentStatusType == Ci.purpleICoreService.STATUS_OFFLINE;</span>
<a href="#l5.307"></a><span id="l5.307">     if (isOffline &amp;&amp; !aIsStarting)</span>
<a href="#l5.308"></a><span id="l5.308">       return;</span>
<a href="#l5.309"></a><span id="l5.309"> </span>
<a href="#l5.310"></a><span id="l5.310">     let hasActiveAccount = false;</span>
<a href="#l5.311"></a><span id="l5.311">     let hasCrashedAccount = false;</span>
<a href="#l5.312"></a><span id="l5.312">     for (let acc in this.getAccounts()) {</span>
<a href="#l5.313"></a><span id="l5.313">       if (acc.connected || acc.connecting)</span>
<a href="#l5.314"></a><span id="l5.314">         hasActiveAccount = true;</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineat">@@ -464,33 +427,31 @@ var buddyList = {</span>
<a href="#l5.316"></a><span id="l5.316">        or if all accounts are disconnected</span>
<a href="#l5.317"></a><span id="l5.317">        In case of connection failure after an automatic reconnection attempt,</span>
<a href="#l5.318"></a><span id="l5.318">        we don't want to popup the account manager */</span>
<a href="#l5.319"></a><span id="l5.319">     if ((!hasActiveAccount &amp;&amp; !isOffline) || (aIsStarting &amp;&amp; hasCrashedAccount))</span>
<a href="#l5.320"></a><span id="l5.320">       menus.accounts();</span>
<a href="#l5.321"></a><span id="l5.321">   },</span>
<a href="#l5.322"></a><span id="l5.322"> </span>
<a href="#l5.323"></a><span id="l5.323">   load: function bl_load() {</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineminus">-    var wm = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineminus">-                       .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineminus">-    var blistWindows = wm.getEnumerator(&quot;Messenger:blist&quot;);</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+    var blistWindows = Services.wm.getEnumerator(&quot;Messenger:blist&quot;);</span>
<a href="#l5.328"></a><span id="l5.328">     while (blistWindows.hasMoreElements()) {</span>
<a href="#l5.329"></a><span id="l5.329">       var win = blistWindows.getNext();</span>
<a href="#l5.330"></a><span id="l5.330">       if (win != window) {</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineminus">-        win.QueryInterface(Components.interfaces.nsIDOMWindowInternal).focus();</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineplus">+        win.QueryInterface(Ci.nsIDOMWindowInternal).focus();</span>
<a href="#l5.333"></a><span id="l5.333">         window.close();</span>
<a href="#l5.334"></a><span id="l5.334">         return;</span>
<a href="#l5.335"></a><span id="l5.335">       }</span>
<a href="#l5.336"></a><span id="l5.336">     }</span>
<a href="#l5.337"></a><span id="l5.337"> </span>
<a href="#l5.338"></a><span id="l5.338">     try {</span>
<a href="#l5.339"></a><span id="l5.339">       // Set the Vendor for breakpad only</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineminus">-      if (&quot;nsICrashReporter&quot; in Components.interfaces) {</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineplus">+      if (&quot;nsICrashReporter&quot; in Ci) {</span>
<a href="#l5.342"></a><span id="l5.342">         Components.classes[&quot;@mozilla.org/xre/app-info;1&quot;]</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineminus">-                  .getService(Components.interfaces.nsICrashReporter)</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineplus">+                  .getService(Ci.nsICrashReporter)</span>
<a href="#l5.345"></a><span id="l5.345">                   .annotateCrashReport(&quot;Vendor&quot;, &quot;Instantbird&quot;);</span>
<a href="#l5.346"></a><span id="l5.346">       }</span>
<a href="#l5.347"></a><span id="l5.347">     } catch(e) {</span>
<a href="#l5.348"></a><span id="l5.348">       // This can fail if breakpad isn't enabled,</span>
<a href="#l5.349"></a><span id="l5.349">       // don't worry too much about this exception.</span>
<a href="#l5.350"></a><span id="l5.350">     }</span>
<a href="#l5.351"></a><span id="l5.351"> </span>
<a href="#l5.352"></a><span id="l5.352">     if (!initPurpleCore()) {</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineat">@@ -500,29 +461,25 @@ var buddyList = {</span>
<a href="#l5.354"></a><span id="l5.354"> </span>
<a href="#l5.355"></a><span id="l5.355">     // TODO remove this once we cleanup the way the menus are inserted</span>
<a href="#l5.356"></a><span id="l5.356">     let menubar = document.getElementById(&quot;blistMenubar&quot;);</span>
<a href="#l5.357"></a><span id="l5.357">     let statusArea = document.getElementById(&quot;statusArea&quot;);</span>
<a href="#l5.358"></a><span id="l5.358">     statusArea.parentNode.insertBefore(menubar, statusArea);</span>
<a href="#l5.359"></a><span id="l5.359"> </span>
<a href="#l5.360"></a><span id="l5.360">     buddyList.displayCurrentStatus();</span>
<a href="#l5.361"></a><span id="l5.361"> </span>
<a href="#l5.362"></a><span id="l5.362" class="difflineminus">-    let prefBranch =</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineminus">-      Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineminus">-                .getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+    let prefBranch = Services.prefs;</span>
<a href="#l5.366"></a><span id="l5.366">     buddyList._showOffline = prefBranch.getBoolPref(showOfflineBuddiesPref);</span>
<a href="#l5.367"></a><span id="l5.367">     if (buddyList._showOffline) {</span>
<a href="#l5.368"></a><span id="l5.368">       document.getElementById(&quot;context-show-offline-buddies&quot;)</span>
<a href="#l5.369"></a><span id="l5.369">               .setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l5.370"></a><span id="l5.370">     }</span>
<a href="#l5.371"></a><span id="l5.371"> </span>
<a href="#l5.372"></a><span id="l5.372" class="difflineminus">-    let pts = Components.classes[&quot;@instantbird.org/purple/tags-service;1&quot;]</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineminus">-                        .getService(Ci.imITagsService);</span>
<a href="#l5.374"></a><span id="l5.374">     let blistBox = document.getElementById(&quot;buddylistbox&quot;);</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineminus">-    pts.getTags().forEach(function (aTag) {</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineplus">+    Services.tags.getTags().forEach(function (aTag) {</span>
<a href="#l5.377"></a><span id="l5.377">       let groupElt = document.createElement(&quot;group&quot;);</span>
<a href="#l5.378"></a><span id="l5.378">       blistBox.appendChild(groupElt);</span>
<a href="#l5.379"></a><span id="l5.379">       if (buddyList._showOffline)</span>
<a href="#l5.380"></a><span id="l5.380">         groupElt._showOffline = true;</span>
<a href="#l5.381"></a><span id="l5.381">       if (!groupElt.build(aTag))</span>
<a href="#l5.382"></a><span id="l5.382">         blistBox.removeChild(groupElt);</span>
<a href="#l5.383"></a><span id="l5.383">     });</span>
<a href="#l5.384"></a><span id="l5.384"> </span>
<a href="#l5.385"></a><span id="l5.385" class="difflineat">@@ -533,19 +490,17 @@ var buddyList = {</span>
<a href="#l5.386"></a><span id="l5.386">     Conversations.init();</span>
<a href="#l5.387"></a><span id="l5.387"> </span>
<a href="#l5.388"></a><span id="l5.388">     buddyList.showAccountManagerIfNeeded(true);</span>
<a href="#l5.389"></a><span id="l5.389">     this.addEventListener(&quot;unload&quot;, buddyList.unload, false);</span>
<a href="#l5.390"></a><span id="l5.390">     this.addEventListener(&quot;close&quot;, buddyList.close, false);</span>
<a href="#l5.391"></a><span id="l5.391">   },</span>
<a href="#l5.392"></a><span id="l5.392">   unload: function bl_unload() {</span>
<a href="#l5.393"></a><span id="l5.393">     removeObservers(buddyList, events);</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineminus">-    Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineminus">-              .getService(Components.interfaces.nsIPrefBranch2)</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineminus">-              .removeObserver(showOfflineBuddiesPref, buddyList);</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+    Services.prefs.removeObserver(showOfflineBuddiesPref, buddyList);</span>
<a href="#l5.398"></a><span id="l5.398">     uninitPurpleCore();</span>
<a href="#l5.399"></a><span id="l5.399">    },</span>
<a href="#l5.400"></a><span id="l5.400"> </span>
<a href="#l5.401"></a><span id="l5.401">   close: function bl_close(event) {</span>
<a href="#l5.402"></a><span id="l5.402">     event.preventDefault();</span>
<a href="#l5.403"></a><span id="l5.403">     goQuitApplication();</span>
<a href="#l5.404"></a><span id="l5.404">   },</span>
<a href="#l5.405"></a><span id="l5.405"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/im/content/buddy.xml</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/im/content/buddy.xml</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -237,19 +237,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">      &lt;method name=&quot;moveTo&quot;&gt;</span>
<a href="#l6.5"></a><span id="l6.5">       &lt;parameter name=&quot;aGroupId&quot;/&gt;</span>
<a href="#l6.6"></a><span id="l6.6">       &lt;body&gt;</span>
<a href="#l6.7"></a><span id="l6.7">       &lt;![CDATA[</span>
<a href="#l6.8"></a><span id="l6.8">         let currentGroupId = this.group.groupId;</span>
<a href="#l6.9"></a><span id="l6.9">         if (currentGroupId == aGroupId)</span>
<a href="#l6.10"></a><span id="l6.10">           return;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-        let pts = Components.classes[&quot;@instantbird.org/purple/tags-service;1&quot;]</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-                            .getService(Ci.imITagsService);</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-        this.contact.move(this.group.tag, pts.getTagById(aGroupId));</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+        this.contact.move(this.group.tag, Services.tags.getTagById(aGroupId));</span>
<a href="#l6.16"></a><span id="l6.16">       ]]&gt;</span>
<a href="#l6.17"></a><span id="l6.17">       &lt;/body&gt;</span>
<a href="#l6.18"></a><span id="l6.18">      &lt;/method&gt;</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">      &lt;method name=&quot;remove&quot;&gt;</span>
<a href="#l6.21"></a><span id="l6.21">       &lt;body&gt;</span>
<a href="#l6.22"></a><span id="l6.22">       &lt;![CDATA[</span>
<a href="#l6.23"></a><span id="l6.23">         this.contact.remove();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/im/content/buddytooltip.xml</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/im/content/buddytooltip.xml</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -72,19 +72,17 @@</span>
<a href="#l7.4"></a><span id="l7.4">       &lt;/xul:vbox&gt;</span>
<a href="#l7.5"></a><span id="l7.5">     &lt;/content&gt;</span>
<a href="#l7.6"></a><span id="l7.6">     &lt;implementation implements=&quot;nsIObserver, nsIDOMEventListener&quot;&gt;</span>
<a href="#l7.7"></a><span id="l7.7">      &lt;property name=&quot;bundle&quot;&gt;</span>
<a href="#l7.8"></a><span id="l7.8">        &lt;getter&gt;</span>
<a href="#l7.9"></a><span id="l7.9">          &lt;![CDATA[</span>
<a href="#l7.10"></a><span id="l7.10">           if (!this._bundle) {</span>
<a href="#l7.11"></a><span id="l7.11">             this._bundle =</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-              Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-                        .getService(Components.interfaces.nsIStringBundleService)</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-                        .createBundle(&quot;chrome://instantbird/locale/buddytooltip.properties&quot;);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+              Services.strings.createBundle(&quot;chrome://instantbird/locale/buddytooltip.properties&quot;);</span>
<a href="#l7.16"></a><span id="l7.16">           }</span>
<a href="#l7.17"></a><span id="l7.17">           return this._bundle;</span>
<a href="#l7.18"></a><span id="l7.18">          ]]&gt;</span>
<a href="#l7.19"></a><span id="l7.19">        &lt;/getter&gt;</span>
<a href="#l7.20"></a><span id="l7.20">      &lt;/property&gt;</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22">      &lt;property name=&quot;buddy&quot;&gt;</span>
<a href="#l7.23"></a><span id="l7.23">        &lt;getter&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/im/content/convZoom.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/im/content/convZoom.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -37,38 +37,32 @@</span>
<a href="#l8.4"></a><span id="l8.4">  *</span>
<a href="#l8.5"></a><span id="l8.5">  * ***** END LICENSE BLOCK *****/</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> // This code was mostly copied from mozilla:</span>
<a href="#l8.8"></a><span id="l8.8"> // mozilla-central/source/browser/base/content/browser-textZoom.js</span>
<a href="#l8.9"></a><span id="l8.9"> var FullZoom = {</span>
<a href="#l8.10"></a><span id="l8.10">   prefName: &quot;conversation.zoomLevel&quot;,</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  get _prefBranch() {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-    delete this._prefBranch;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-    return this._prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-                              .getService(Ci.nsIPrefBranch2);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-  },</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-</span>
<a href="#l8.18"></a><span id="l8.18">   init: function FullZoom_init() {</span>
<a href="#l8.19"></a><span id="l8.19">     window.addEventListener(&quot;DOMMouseScroll&quot;, FullZoom.handleMouseScrolled, false);</span>
<a href="#l8.20"></a><span id="l8.20">     window.addEventListener(&quot;unload&quot;, FullZoom.destroy, false);</span>
<a href="#l8.21"></a><span id="l8.21">     let conversations = document.getElementById(&quot;conversations&quot;);</span>
<a href="#l8.22"></a><span id="l8.22">     if (conversations) {</span>
<a href="#l8.23"></a><span id="l8.23">       conversations.tabContainer</span>
<a href="#l8.24"></a><span id="l8.24">                    .addEventListener(&quot;select&quot;, FullZoom.setSettingValue, false);</span>
<a href="#l8.25"></a><span id="l8.25">     }</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-    FullZoom._prefBranch.addObserver(FullZoom.prefName, FullZoom, false);</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+    Services.prefs.addObserver(FullZoom.prefName, FullZoom, false);</span>
<a href="#l8.29"></a><span id="l8.29">     FullZoom.getPrefValue();</span>
<a href="#l8.30"></a><span id="l8.30">     FullZoom.setSettingValue();</span>
<a href="#l8.31"></a><span id="l8.31">   },</span>
<a href="#l8.32"></a><span id="l8.32"> </span>
<a href="#l8.33"></a><span id="l8.33">   destroy: function FullZoom_destroy() {</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-    FullZoom._prefBranch.removeObserver(FullZoom.prefName, FullZoom);</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+    Services.prefs.removeObserver(FullZoom.prefName, FullZoom);</span>
<a href="#l8.36"></a><span id="l8.36">     window.removeEventListener(&quot;DOMMouseScroll&quot;, FullZoom.handleMouseScrolled, false);</span>
<a href="#l8.37"></a><span id="l8.37">   },</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39">   // Events Handlers / Observe</span>
<a href="#l8.40"></a><span id="l8.40">   handleMouseScrolled: function FullZoom_handleMouseScrolled(event) {</span>
<a href="#l8.41"></a><span id="l8.41">     if (!event.ctrlKey || event.altKey || event.shiftKey || !event.detail)</span>
<a href="#l8.42"></a><span id="l8.42">       return;</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44" class="difflineat">@@ -101,27 +95,27 @@ var FullZoom = {</span>
<a href="#l8.45"></a><span id="l8.45">     ZoomManager.reduce();</span>
<a href="#l8.46"></a><span id="l8.46">     this.applySettingToPref();</span>
<a href="#l8.47"></a><span id="l8.47">   },</span>
<a href="#l8.48"></a><span id="l8.48">   reset: function FullZoom_ZoomReset() {</span>
<a href="#l8.49"></a><span id="l8.49">     ZoomManager.reset();</span>
<a href="#l8.50"></a><span id="l8.50">     try {</span>
<a href="#l8.51"></a><span id="l8.51">       // Can throw an exception when the preference does not exist or is</span>
<a href="#l8.52"></a><span id="l8.52">       // already at its default value.</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-      this._prefBranch.clearUserPref(this.prefName);</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+      Services.prefs.clearUserPref(this.prefName);</span>
<a href="#l8.55"></a><span id="l8.55">     }</span>
<a href="#l8.56"></a><span id="l8.56">     catch (ex) {}</span>
<a href="#l8.57"></a><span id="l8.57">   },</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59">   // Settings and Prefs</span>
<a href="#l8.60"></a><span id="l8.60">   applySettingToPref: function FullZoom_applySettingToPref() {</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-    this._prefBranch.setCharPref(this.prefName, ZoomManager.zoom);</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+    Services.prefs.setCharPref(this.prefName, ZoomManager.zoom);</span>
<a href="#l8.63"></a><span id="l8.63">   },</span>
<a href="#l8.64"></a><span id="l8.64">   getPrefValue: function FullZoom_getPrefValue() {</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-    this._value = parseFloat(this._prefBranch.getCharPref(this.prefName));</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+    this._value = parseFloat(Services.prefs.getCharPref(this.prefName));</span>
<a href="#l8.67"></a><span id="l8.67">   },</span>
<a href="#l8.68"></a><span id="l8.68">   setSettingValue: function FullZoom_setSettingValue() {</span>
<a href="#l8.69"></a><span id="l8.69">     FullZoom._applyPrefToSetting(FullZoom._value);</span>
<a href="#l8.70"></a><span id="l8.70">   },</span>
<a href="#l8.71"></a><span id="l8.71">   /**</span>
<a href="#l8.72"></a><span id="l8.72">    * Set the zoom level for the current tab.</span>
<a href="#l8.73"></a><span id="l8.73">    *</span>
<a href="#l8.74"></a><span id="l8.74">    * Per nsPresContext::setFullZoom, we can set the zoom to its current value</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/im/content/convbrowser.xml</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/im/content/convbrowser.xml</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -61,17 +61,17 @@</span>
<a href="#l9.4"></a><span id="l9.4">       &lt;property name=&quot;autoscrollEnabled&quot;&gt;</span>
<a href="#l9.5"></a><span id="l9.5">         &lt;getter&gt;</span>
<a href="#l9.6"></a><span id="l9.6">           &lt;![CDATA[</span>
<a href="#l9.7"></a><span id="l9.7">             if (this.getAttribute(&quot;autoscroll&quot;) == &quot;false&quot;)</span>
<a href="#l9.8"></a><span id="l9.8">               return false;</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10">             var enabled = true;</span>
<a href="#l9.11"></a><span id="l9.11">             try {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-              enabled = this.mPrefs.getBoolPref(&quot;general.autoScroll&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+              enabled = Services.prefs.getBoolPref(&quot;general.autoScroll&quot;);</span>
<a href="#l9.14"></a><span id="l9.14">             }</span>
<a href="#l9.15"></a><span id="l9.15">             catch(ex) {</span>
<a href="#l9.16"></a><span id="l9.16">             }</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18">             return enabled;</span>
<a href="#l9.19"></a><span id="l9.19">           ]]&gt;</span>
<a href="#l9.20"></a><span id="l9.20">         &lt;/getter&gt;</span>
<a href="#l9.21"></a><span id="l9.21">       &lt;/property&gt;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -165,24 +165,19 @@</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24">       &lt;property name=&quot;markupDocumentViewer&quot;</span>
<a href="#l9.25"></a><span id="l9.25">                 onget=&quot;return this.docShell.contentViewer.QueryInterface(Components.interfaces.nsIMarkupDocumentViewer);&quot;</span>
<a href="#l9.26"></a><span id="l9.26">                 readonly=&quot;true&quot;/&gt;</span>
<a href="#l9.27"></a><span id="l9.27"> </span>
<a href="#l9.28"></a><span id="l9.28">       &lt;field name=&quot;magicCopyPref&quot; readonly=&quot;true&quot;&gt;&quot;messenger.conversations.selections.magicCopyEnabled&quot;&lt;/field&gt;</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30">       &lt;property name=&quot;magicCopyEnabled&quot;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-                onget=&quot;return this.mPrefs.getBoolPref(this.magicCopyPref);&quot;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+                onget=&quot;return Services.prefs.getBoolPref(this.magicCopyPref);&quot;</span>
<a href="#l9.33"></a><span id="l9.33">                 readonly=&quot;true&quot;/&gt;</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-      &lt;field name=&quot;mPrefs&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-        Components.classes['@mozilla.org/preferences-service;1']</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-                  .getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-</span>
<a href="#l9.40"></a><span id="l9.40">       &lt;method name=&quot;addProgressListener&quot;&gt;</span>
<a href="#l9.41"></a><span id="l9.41">         &lt;parameter name=&quot;aListener&quot;/&gt;</span>
<a href="#l9.42"></a><span id="l9.42">         &lt;body&gt;</span>
<a href="#l9.43"></a><span id="l9.43">           &lt;![CDATA[</span>
<a href="#l9.44"></a><span id="l9.44">             this.webProgress.addProgressListener(aListener, Components.interfaces.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l9.45"></a><span id="l9.45">           ]]&gt;</span>
<a href="#l9.46"></a><span id="l9.46">         &lt;/body&gt;</span>
<a href="#l9.47"></a><span id="l9.47">       &lt;/method&gt;</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineat">@@ -197,17 +192,17 @@</span>
<a href="#l9.49"></a><span id="l9.49">       &lt;/method&gt;</span>
<a href="#l9.50"></a><span id="l9.50"> </span>
<a href="#l9.51"></a><span id="l9.51">       &lt;field name=&quot;mDestroyed&quot;&gt;false&lt;/field&gt;</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53">       &lt;constructor&gt;</span>
<a href="#l9.54"></a><span id="l9.54">         &lt;![CDATA[</span>
<a href="#l9.55"></a><span id="l9.55">           this.addEventListener(&quot;scroll&quot;, this.browserScroll, false);</span>
<a href="#l9.56"></a><span id="l9.56">           this.addEventListener(&quot;resize&quot;, this.browserResize, false);</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-          this.mPrefs.addObserver(this.magicCopyPref, this, false);</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+          Services.prefs.addObserver(this.magicCopyPref, this, false);</span>
<a href="#l9.59"></a><span id="l9.59"> </span>
<a href="#l9.60"></a><span id="l9.60">           if (!(&quot;cleanupImMarkup&quot; in window))</span>
<a href="#l9.61"></a><span id="l9.61">             Components.utils.import(&quot;resource:///modules/imContentSink.jsm&quot;);</span>
<a href="#l9.62"></a><span id="l9.62">           if (!(&quot;smileImMarkup&quot; in window))</span>
<a href="#l9.63"></a><span id="l9.63">             Components.utils.import(&quot;resource:///modules/imSmileys.jsm&quot;);</span>
<a href="#l9.64"></a><span id="l9.64">           if (!(&quot;getCurrentTheme&quot; in window))</span>
<a href="#l9.65"></a><span id="l9.65">             Components.utils.import(&quot;resource:///modules/imThemes.jsm&quot;);</span>
<a href="#l9.66"></a><span id="l9.66">         ]]&gt;</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineat">@@ -234,17 +229,17 @@</span>
<a href="#l9.68"></a><span id="l9.68"> </span>
<a href="#l9.69"></a><span id="l9.69">             this._fastFind = null;</span>
<a href="#l9.70"></a><span id="l9.70"> </span>
<a href="#l9.71"></a><span id="l9.71">             if (this._autoScrollNeedsCleanup) {</span>
<a href="#l9.72"></a><span id="l9.72">               // we polluted the global scope, so clean it up</span>
<a href="#l9.73"></a><span id="l9.73">               this._autoScrollPopup.parentNode.removeChild(this._autoScrollPopup);</span>
<a href="#l9.74"></a><span id="l9.74">             }</span>
<a href="#l9.75"></a><span id="l9.75"> </span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-            this.mPrefs.removeObserver(this.magicCopyPref, this);</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+            Services.prefs.removeObserver(this.magicCopyPref, this);</span>
<a href="#l9.78"></a><span id="l9.78">             if (this.magicCopyEnabled)</span>
<a href="#l9.79"></a><span id="l9.79">               this.contentWindow.controllers.removeController(this);</span>
<a href="#l9.80"></a><span id="l9.80">           ]]&gt;</span>
<a href="#l9.81"></a><span id="l9.81">         &lt;/body&gt;</span>
<a href="#l9.82"></a><span id="l9.82">       &lt;/method&gt;</span>
<a href="#l9.83"></a><span id="l9.83"> </span>
<a href="#l9.84"></a><span id="l9.84">       &lt;field name=&quot;_autoScrollEnabled&quot;&gt;true&lt;/field&gt;</span>
<a href="#l9.85"></a><span id="l9.85"> </span>
<a href="#l9.86"></a><span id="l9.86" class="difflineat">@@ -480,19 +475,17 @@</span>
<a href="#l9.87"></a><span id="l9.87">                             .getService(Components.interfaces.nsIClipboard);</span>
<a href="#l9.88"></a><span id="l9.88">                 if (clipboard.supportsSelectionClipboard()) {</span>
<a href="#l9.89"></a><span id="l9.89">                   this.contentWindow.getSelection()</span>
<a href="#l9.90"></a><span id="l9.90">                       .QueryInterface(Components.interfaces.nsISelectionPrivate)</span>
<a href="#l9.91"></a><span id="l9.91">                       .addSelectionListener(this);</span>
<a href="#l9.92"></a><span id="l9.92">                 }</span>
<a href="#l9.93"></a><span id="l9.93">               }</span>
<a href="#l9.94"></a><span id="l9.94"> </span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-              Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-                        .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-                        .notifyObservers(this, &quot;conversation-loaded&quot;, null);</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+              Services.obs.notifyObservers(this, &quot;conversation-loaded&quot;, null);</span>
<a href="#l9.99"></a><span id="l9.99">             }</span>
<a href="#l9.100"></a><span id="l9.100">           ]]&gt;</span>
<a href="#l9.101"></a><span id="l9.101">         &lt;/body&gt;</span>
<a href="#l9.102"></a><span id="l9.102">       &lt;/method&gt;</span>
<a href="#l9.103"></a><span id="l9.103"> </span>
<a href="#l9.104"></a><span id="l9.104">       &lt;method name=&quot;onProgressChange&quot;&gt;</span>
<a href="#l9.105"></a><span id="l9.105">         &lt;parameter name=&quot;aProgress&quot;/&gt;</span>
<a href="#l9.106"></a><span id="l9.106">         &lt;parameter name=&quot;aRequest&quot;/&gt;</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineat">@@ -673,23 +666,23 @@</span>
<a href="#l9.108"></a><span id="l9.108">       &lt;method name=&quot;isAutoscrollBlocker&quot;&gt;</span>
<a href="#l9.109"></a><span id="l9.109">         &lt;parameter name=&quot;node&quot;/&gt;</span>
<a href="#l9.110"></a><span id="l9.110">         &lt;body&gt;</span>
<a href="#l9.111"></a><span id="l9.111">           &lt;![CDATA[</span>
<a href="#l9.112"></a><span id="l9.112">             var mmPaste = false;</span>
<a href="#l9.113"></a><span id="l9.113">             var mmScrollbarPosition = false;</span>
<a href="#l9.114"></a><span id="l9.114"> </span>
<a href="#l9.115"></a><span id="l9.115">             try {</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-              mmPaste = this.mPrefs.getBoolPref(&quot;middlemouse.paste&quot;);</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+              mmPaste = Services.prefs.getBoolPref(&quot;middlemouse.paste&quot;);</span>
<a href="#l9.118"></a><span id="l9.118">             }</span>
<a href="#l9.119"></a><span id="l9.119">             catch (ex) {</span>
<a href="#l9.120"></a><span id="l9.120">             }</span>
<a href="#l9.121"></a><span id="l9.121"> </span>
<a href="#l9.122"></a><span id="l9.122">             try {</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-              mmScrollbarPosition = this.mPrefs.getBoolPref(&quot;middlemouse.scrollbarPosition&quot;);</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+              mmScrollbarPosition = Services.prefs.getBoolPref(&quot;middlemouse.scrollbarPosition&quot;);</span>
<a href="#l9.125"></a><span id="l9.125">             }</span>
<a href="#l9.126"></a><span id="l9.126">             catch (ex) {</span>
<a href="#l9.127"></a><span id="l9.127">             }</span>
<a href="#l9.128"></a><span id="l9.128"> </span>
<a href="#l9.129"></a><span id="l9.129">             while (node) {</span>
<a href="#l9.130"></a><span id="l9.130">               if ((node instanceof HTMLAnchorElement || node instanceof HTMLAreaElement) &amp;&amp; node.hasAttribute(&quot;href&quot;))</span>
<a href="#l9.131"></a><span id="l9.131">                 return true;</span>
<a href="#l9.132"></a><span id="l9.132"> </span>
<a href="#l9.133"></a><span id="l9.133" class="difflineat">@@ -808,24 +801,24 @@</span>
<a href="#l9.134"></a><span id="l9.134">     &lt;/implementation&gt;</span>
<a href="#l9.135"></a><span id="l9.135"> </span>
<a href="#l9.136"></a><span id="l9.136">     &lt;handlers&gt;</span>
<a href="#l9.137"></a><span id="l9.137">       &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_F7&quot; group=&quot;system&quot;&gt;</span>
<a href="#l9.138"></a><span id="l9.138">         &lt;![CDATA[</span>
<a href="#l9.139"></a><span id="l9.139">           if (event.getPreventDefault() || !event.isTrusted)</span>
<a href="#l9.140"></a><span id="l9.140">             return;</span>
<a href="#l9.141"></a><span id="l9.141"> </span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-          var isEnabled = this.mPrefs.getBoolPref(&quot;accessibility.browsewithcaret_shortcut.enabled&quot;);</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+          var isEnabled = Services.prefs.getBoolPref(&quot;accessibility.browsewithcaret_shortcut.enabled&quot;);</span>
<a href="#l9.144"></a><span id="l9.144">           if (!isEnabled)</span>
<a href="#l9.145"></a><span id="l9.145">             return;</span>
<a href="#l9.146"></a><span id="l9.146"> </span>
<a href="#l9.147"></a><span id="l9.147">           // Toggle browse with caret mode</span>
<a href="#l9.148"></a><span id="l9.148">           try {</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-            var browseWithCaretOn = this.mPrefs.getBoolPref(&quot;accessibility.browsewithcaret&quot;);</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-            this.mPrefs.setBoolPref(&quot;accessibility.browsewithcaret&quot;,!browseWithCaretOn);</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+            var browseWithCaretOn = Services.prefs.getBoolPref(&quot;accessibility.browsewithcaret&quot;);</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+            Services.prefs.setBoolPref(&quot;accessibility.browsewithcaret&quot;, !browseWithCaretOn);</span>
<a href="#l9.153"></a><span id="l9.153">           } catch (ex) {</span>
<a href="#l9.154"></a><span id="l9.154">           }</span>
<a href="#l9.155"></a><span id="l9.155">         ]]&gt;</span>
<a href="#l9.156"></a><span id="l9.156">       &lt;/handler&gt;</span>
<a href="#l9.157"></a><span id="l9.157">       &lt;handler event=&quot;mousedown&quot; phase=&quot;capturing&quot;&gt;</span>
<a href="#l9.158"></a><span id="l9.158">         &lt;![CDATA[</span>
<a href="#l9.159"></a><span id="l9.159">           if (!this._scrollingView &amp;&amp; event.button == 1) {</span>
<a href="#l9.160"></a><span id="l9.160">             if (!this.autoscrollEnabled  ||</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/im/content/conversation.xml</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/im/content/conversation.xml</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -107,19 +107,17 @@</span>
<a href="#l10.4"></a><span id="l10.4">        var editor = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;editor&quot;);</span>
<a href="#l10.5"></a><span id="l10.5">        editor.addEventListener(&quot;keypress&quot;, this.editorKeyPress, false);</span>
<a href="#l10.6"></a><span id="l10.6">        //this doesn't work at the moment</span>
<a href="#l10.7"></a><span id="l10.7">        //editor.contentDocument.designMode = &quot;on&quot;;</span>
<a href="#l10.8"></a><span id="l10.8">        //setTimeout(function() { editor.contentWindow.focus(); }, 100);</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10">        var browser = this.browser;</span>
<a href="#l10.11"></a><span id="l10.11">        browser.addEventListener(&quot;keypress&quot;, this.browserKeyPress, false);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-       Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-                 .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-                 .addObserver(this, &quot;conversation-loaded&quot;, false);</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+       Services.obs.addObserver(this, &quot;conversation-loaded&quot;, false);</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17">        try {</span>
<a href="#l10.18"></a><span id="l10.18">          this.findbar.browser = browser;</span>
<a href="#l10.19"></a><span id="l10.19">        } catch(e) {</span>
<a href="#l10.20"></a><span id="l10.20">          // Do nothing. The exception is expected and harmless.</span>
<a href="#l10.21"></a><span id="l10.21">          // We call the setter of the browser property of the findbar before</span>
<a href="#l10.22"></a><span id="l10.22">          // the constructor of the findbar is executed.</span>
<a href="#l10.23"></a><span id="l10.23">          // Don't worry, the constructor of the findbar will set again the</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineat">@@ -274,19 +272,17 @@</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26">         var account = this._conv.account;</span>
<a href="#l10.27"></a><span id="l10.27">         if (account.noNewlines)</span>
<a href="#l10.28"></a><span id="l10.28">           // 'Illegal operation on WrappedNative prototype object' if the this</span>
<a href="#l10.29"></a><span id="l10.29">           // object is not specified (since nsIClassInfo was added to this._conv)</span>
<a href="#l10.30"></a><span id="l10.30">           msg.split(&quot;\n&quot;).forEach(this._conv.sendMsg, this._conv);</span>
<a href="#l10.31"></a><span id="l10.31">         else if (account.HTMLEnabled) {</span>
<a href="#l10.32"></a><span id="l10.32">           msg = msg.replace(/\n/g, &quot;&lt;br/&gt;&quot;);</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-          let prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-                                .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-          if (prefs.getBoolPref(&quot;messenger.conversations.sendFormat&quot;)) {</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+          if (Services.prefs.getBoolPref(&quot;messenger.conversations.sendFormat&quot;)) {</span>
<a href="#l10.37"></a><span id="l10.37">             let style = MessageFormat.getMessageStyle();</span>
<a href="#l10.38"></a><span id="l10.38">             let proto = this._conv.account.protocol.id;</span>
<a href="#l10.39"></a><span id="l10.39">             if (proto == &quot;prpl-msn&quot;) {</span>
<a href="#l10.40"></a><span id="l10.40">               if (&quot;color&quot; in style)</span>
<a href="#l10.41"></a><span id="l10.41">                 msg = &quot;&lt;font color=\&quot;&quot; + style.color + &quot;\&quot;&gt;&quot; + msg + &quot;&lt;/font&gt;&quot;;</span>
<a href="#l10.42"></a><span id="l10.42">               if (&quot;fontFamily&quot; in style)</span>
<a href="#l10.43"></a><span id="l10.43">                 msg = &quot;&lt;font face=\&quot;&quot; + style.fontFamily + &quot;\&quot;&gt;&quot; + msg + &quot;&lt;/font&gt;&quot;;</span>
<a href="#l10.44"></a><span id="l10.44">               // MSN doesn't support font size info in messages...</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineat">@@ -389,19 +385,17 @@</span>
<a href="#l10.46"></a><span id="l10.46">         // Calculate the number of lines to display.</span>
<a href="#l10.47"></a><span id="l10.47">         let numberOfLines =</span>
<a href="#l10.48"></a><span id="l10.48">           Math.round(totalSpace * this._TEXTBOX_RATIO / lineHeight);</span>
<a href="#l10.49"></a><span id="l10.49">         if (numberOfLines &lt;= 0)</span>
<a href="#l10.50"></a><span id="l10.50">           numberOfLines = 1;</span>
<a href="#l10.51"></a><span id="l10.51"> </span>
<a href="#l10.52"></a><span id="l10.52">         if (!this._maxEmptyLines) {</span>
<a href="#l10.53"></a><span id="l10.53">           this._maxEmptyLines =</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-            Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-                      .getService(Components.interfaces.nsIPrefBranch)</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-                      .getIntPref(&quot;messenger.conversations.textbox.defaultMaxLines&quot;);</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+            Services.prefs.getIntPref(&quot;messenger.conversations.textbox.defaultMaxLines&quot;);</span>
<a href="#l10.58"></a><span id="l10.58">         }</span>
<a href="#l10.59"></a><span id="l10.59"> </span>
<a href="#l10.60"></a><span id="l10.60">         if (numberOfLines &gt; this._maxEmptyLines)</span>
<a href="#l10.61"></a><span id="l10.61">           numberOfLines = this._maxEmptyLines;</span>
<a href="#l10.62"></a><span id="l10.62">         textbox.defaultHeight = numberOfLines * lineHeight;</span>
<a href="#l10.63"></a><span id="l10.63"> </span>
<a href="#l10.64"></a><span id="l10.64">         // set minimum height (in case the user moves the splitter)</span>
<a href="#l10.65"></a><span id="l10.65">         textbox.minHeight = lineHeight + this._TEXTBOX_VERTICAL_OVERHEAD;</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineat">@@ -666,19 +660,18 @@</span>
<a href="#l10.67"></a><span id="l10.67">         var editor = conv.editor;</span>
<a href="#l10.68"></a><span id="l10.68"> </span>
<a href="#l10.69"></a><span id="l10.69">         if (event.charCode == 0 &amp;&amp;  // it's not a character, it's a command key</span>
<a href="#l10.70"></a><span id="l10.70">             (event.keyCode != 13 &amp;&amp; // Return</span>
<a href="#l10.71"></a><span id="l10.71">              event.keyCode != 8 &amp;&amp;  // Backspace</span>
<a href="#l10.72"></a><span id="l10.72">              event.keyCode != 46))  // Delete</span>
<a href="#l10.73"></a><span id="l10.73">           return;</span>
<a href="#l10.74"></a><span id="l10.74"> </span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-        let prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-                              .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-        if (accelKeyPressed || !prefs.getBoolPref(&quot;accessibility.typeaheadfind&quot;))</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+        if (accelKeyPressed ||</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+            !Services.prefs.getBoolPref(&quot;accessibility.typeaheadfind&quot;))</span>
<a href="#l10.80"></a><span id="l10.80">           editor.focus();</span>
<a href="#l10.81"></a><span id="l10.81"> </span>
<a href="#l10.82"></a><span id="l10.82">         // Returns for Ctrl+V</span>
<a href="#l10.83"></a><span id="l10.83">         if (accelKeyPressed)</span>
<a href="#l10.84"></a><span id="l10.84">           return;</span>
<a href="#l10.85"></a><span id="l10.85"> </span>
<a href="#l10.86"></a><span id="l10.86">         const masks = Components.interfaces.nsIDOMNSEvent;</span>
<a href="#l10.87"></a><span id="l10.87">         var modifiers = 0;</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineat">@@ -897,20 +890,18 @@</span>
<a href="#l10.89"></a><span id="l10.89">          this.displayStatusText();</span>
<a href="#l10.90"></a><span id="l10.90">        ]]&gt;</span>
<a href="#l10.91"></a><span id="l10.91">        &lt;/body&gt;</span>
<a href="#l10.92"></a><span id="l10.92">      &lt;/method&gt;</span>
<a href="#l10.93"></a><span id="l10.93"> </span>
<a href="#l10.94"></a><span id="l10.94">      &lt;method name=&quot;showLogs&quot;&gt;</span>
<a href="#l10.95"></a><span id="l10.95">        &lt;body&gt;</span>
<a href="#l10.96"></a><span id="l10.96">        &lt;![CDATA[</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-         var logger = Components.classes[&quot;@instantbird.org/logger;1&quot;]</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-                                .getService(Ci.ibILogger);</span>
<a href="#l10.99"></a><span id="l10.99">          var logs = [];</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-         for (let log in getIter(logger.getLogsForConversation(this.conv)))</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+         for (let log in getIter(Services.logs.getLogsForConversation(this.conv)))</span>
<a href="#l10.102"></a><span id="l10.102">            logs.push(log);</span>
<a href="#l10.103"></a><span id="l10.103">          window.openDialog(&quot;chrome://instantbird/content/viewlog.xul&quot;,</span>
<a href="#l10.104"></a><span id="l10.104">                            &quot;Logs&quot;, &quot;chrome,resizable&quot;, {logs: logs},</span>
<a href="#l10.105"></a><span id="l10.105">                            this.conv.name);</span>
<a href="#l10.106"></a><span id="l10.106">        ]]&gt;</span>
<a href="#l10.107"></a><span id="l10.107">        &lt;/body&gt;</span>
<a href="#l10.108"></a><span id="l10.108">      &lt;/method&gt;</span>
<a href="#l10.109"></a><span id="l10.109"> </span>
<a href="#l10.110"></a><span id="l10.110" class="difflineat">@@ -1023,19 +1014,17 @@</span>
<a href="#l10.111"></a><span id="l10.111">          if (aTopic == &quot;conversation-loaded&quot;) {</span>
<a href="#l10.112"></a><span id="l10.112">            if (aSubject != this.browser)</span>
<a href="#l10.113"></a><span id="l10.113">              return;</span>
<a href="#l10.114"></a><span id="l10.114"> </span>
<a href="#l10.115"></a><span id="l10.115">            // Display all queued messages. Use a timeout so that message text</span>
<a href="#l10.116"></a><span id="l10.116">            // modifiers can be added with observers for this notification.</span>
<a href="#l10.117"></a><span id="l10.117">            setTimeout(function(aSelf) { aSelf._emptyMessageQueue(); }, 0, this);</span>
<a href="#l10.118"></a><span id="l10.118"> </span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-           Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-                     .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-                     .removeObserver(this, &quot;conversation-loaded&quot;);</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+           Services.obs.removeObserver(this, &quot;conversation-loaded&quot;);</span>
<a href="#l10.123"></a><span id="l10.123">            return;</span>
<a href="#l10.124"></a><span id="l10.124">          }</span>
<a href="#l10.125"></a><span id="l10.125"> </span>
<a href="#l10.126"></a><span id="l10.126">          switch(aTopic) {</span>
<a href="#l10.127"></a><span id="l10.127">          case &quot;new-text&quot;:</span>
<a href="#l10.128"></a><span id="l10.128">            if (this.loaded)</span>
<a href="#l10.129"></a><span id="l10.129">              this._addMsg(aSubject);</span>
<a href="#l10.130"></a><span id="l10.130">            break;</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineat">@@ -1198,19 +1187,17 @@</span>
<a href="#l10.132"></a><span id="l10.132">        &lt;/getter&gt;</span>
<a href="#l10.133"></a><span id="l10.133">      &lt;/property&gt;</span>
<a href="#l10.134"></a><span id="l10.134"> </span>
<a href="#l10.135"></a><span id="l10.135">      &lt;property name=&quot;bundle&quot;&gt;</span>
<a href="#l10.136"></a><span id="l10.136">        &lt;getter&gt;</span>
<a href="#l10.137"></a><span id="l10.137">          &lt;![CDATA[</span>
<a href="#l10.138"></a><span id="l10.138">           if (!this._bundle) {</span>
<a href="#l10.139"></a><span id="l10.139">             this._bundle =</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineminus">-              Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineminus">-                        .getService(Components.interfaces.nsIStringBundleService)</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineminus">-                        .createBundle(&quot;chrome://instantbird/locale/instantbird.properties&quot;);</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+              Services.strings.createBundle(&quot;chrome://instantbird/locale/instantbird.properties&quot;);</span>
<a href="#l10.144"></a><span id="l10.144">           }</span>
<a href="#l10.145"></a><span id="l10.145">           return this._bundle;</span>
<a href="#l10.146"></a><span id="l10.146">          ]]&gt;</span>
<a href="#l10.147"></a><span id="l10.147">        &lt;/getter&gt;</span>
<a href="#l10.148"></a><span id="l10.148">      &lt;/property&gt;</span>
<a href="#l10.149"></a><span id="l10.149">     &lt;/implementation&gt;</span>
<a href="#l10.150"></a><span id="l10.150">   &lt;/binding&gt;</span>
<a href="#l10.151"></a><span id="l10.151"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/im/content/core.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/im/content/core.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -44,18 +44,17 @@ function initPurpleCore()</span>
<a href="#l11.4"></a><span id="l11.4">   }</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6">   if (!Components.classes[&quot;@instantbird.org/purple/core;1&quot;]) {</span>
<a href="#l11.7"></a><span id="l11.7">     promptError(&quot;startupFailure.xpcomRegistrationError&quot;);</span>
<a href="#l11.8"></a><span id="l11.8">     return false;</span>
<a href="#l11.9"></a><span id="l11.9">   }</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11">   try {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    var pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-                        .getService(Ci.purpleICoreService);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+    var pcs = Services.core;</span>
<a href="#l11.15"></a><span id="l11.15">     pcs.init();</span>
<a href="#l11.16"></a><span id="l11.16">   }</span>
<a href="#l11.17"></a><span id="l11.17">   catch (e) {</span>
<a href="#l11.18"></a><span id="l11.18">     promptError(&quot;startupFailure.purplexpcomInitError&quot;, e);</span>
<a href="#l11.19"></a><span id="l11.19">     return false;</span>
<a href="#l11.20"></a><span id="l11.20">   }</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22">   if (!pcs.version) {</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineat">@@ -70,47 +69,40 @@ function initPurpleCore()</span>
<a href="#l11.24"></a><span id="l11.24">   }</span>
<a href="#l11.25"></a><span id="l11.25"> </span>
<a href="#l11.26"></a><span id="l11.26">   return true;</span>
<a href="#l11.27"></a><span id="l11.27"> }</span>
<a href="#l11.28"></a><span id="l11.28"> </span>
<a href="#l11.29"></a><span id="l11.29"> function uninitPurpleCore()</span>
<a href="#l11.30"></a><span id="l11.30"> {</span>
<a href="#l11.31"></a><span id="l11.31">   try {</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-    var pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-                        .getService(Ci.purpleICoreService);</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-    pcs.quit();</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+    Services.core.quit();</span>
<a href="#l11.36"></a><span id="l11.36">   }</span>
<a href="#l11.37"></a><span id="l11.37">   catch (e) {</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-    var prompts = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-                            .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-    prompts.alert(null, &quot;Shutdown Error&quot;, &quot;An error occurred while shutting down purplexpcom: &quot; + e);</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+    Services.prompt.alert(null, &quot;Shutdown Error&quot;,</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+                          &quot;An error occurred while shutting down purplexpcom: &quot; + e);</span>
<a href="#l11.44"></a><span id="l11.44">   }</span>
<a href="#l11.45"></a><span id="l11.45"> }</span>
<a href="#l11.46"></a><span id="l11.46"> </span>
<a href="#l11.47"></a><span id="l11.47"> function promptError(aKeyString, aMessage) {</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-  const nsIPromptService = Components.interfaces.nsIPromptService;</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-  var prompts = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-                          .getService(nsIPromptService);</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-  var bundle = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-                         .getService(Components.interfaces.nsIStringBundleService)</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-                         .createBundle(&quot;chrome://instantbird/locale/core.properties&quot;);</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+  var bundle =</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+    Services.strings.createBundle(&quot;chrome://instantbird/locale/core.properties&quot;);</span>
<a href="#l11.57"></a><span id="l11.57"> </span>
<a href="#l11.58"></a><span id="l11.58">   var title = bundle.GetStringFromName(&quot;startupFailure.title&quot;);</span>
<a href="#l11.59"></a><span id="l11.59">   var message =</span>
<a href="#l11.60"></a><span id="l11.60">     bundle.GetStringFromName(&quot;startupFailure.apologize&quot;) + &quot;\n\n&quot; +</span>
<a href="#l11.61"></a><span id="l11.61">     (aMessage ? bundle.formatStringFromName(aKeyString, [aMessage], 1)</span>
<a href="#l11.62"></a><span id="l11.62">               : bundle.GetStringFromName(aKeyString)) + &quot;\n\n&quot; +</span>
<a href="#l11.63"></a><span id="l11.63">     bundle.GetStringFromName(&quot;startupFailure.update&quot;);</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+  const nsIPromptService = Components.interfaces.nsIPromptService;</span>
<a href="#l11.65"></a><span id="l11.65">   const flags =</span>
<a href="#l11.66"></a><span id="l11.66">     nsIPromptService.BUTTON_POS_1 * nsIPromptService.BUTTON_TITLE_IS_STRING +</span>
<a href="#l11.67"></a><span id="l11.67">     nsIPromptService.BUTTON_POS_0 * nsIPromptService.BUTTON_TITLE_IS_STRING;</span>
<a href="#l11.68"></a><span id="l11.68"> </span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+  var prompts = Services.prompt;</span>
<a href="#l11.70"></a><span id="l11.70">   if (!prompts.confirmEx(null, title, message, flags,</span>
<a href="#l11.71"></a><span id="l11.71">                          bundle.GetStringFromName(&quot;startupFailure.buttonUpdate&quot;),</span>
<a href="#l11.72"></a><span id="l11.72">                          bundle.GetStringFromName(&quot;startupFailure.buttonClose&quot;),</span>
<a href="#l11.73"></a><span id="l11.73">                          null, null, {})) {</span>
<a href="#l11.74"></a><span id="l11.74">     // copied from checkForUpdates in mozilla/browser/base/content/utilityOverlay.js</span>
<a href="#l11.75"></a><span id="l11.75">     var um =</span>
<a href="#l11.76"></a><span id="l11.76">       Components.classes[&quot;@mozilla.org/updates/update-manager;1&quot;]</span>
<a href="#l11.77"></a><span id="l11.77">                 .getService(Components.interfaces.nsIUpdateManager);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/im/content/debug/debug.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/im/content/debug/debug.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -26,18 +26,17 @@ var debug = {</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5">   garbageCollect: function debug_garbageCollect() {</span>
<a href="#l12.6"></a><span id="l12.6">     window.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l12.7"></a><span id="l12.7">           .getInterface(Ci.nsIDOMWindowUtils)</span>
<a href="#l12.8"></a><span id="l12.8">           .garbageCollect();</span>
<a href="#l12.9"></a><span id="l12.9">   },</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11">   forceOnline: function debug_forceOnline() {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    var ios = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-                        .getService(Components.interfaces.nsIIOService2);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+    var ios = Services.io;</span>
<a href="#l12.15"></a><span id="l12.15">     ios.manageOfflineStatus = false;</span>
<a href="#l12.16"></a><span id="l12.16">     ios.offline = false;</span>
<a href="#l12.17"></a><span id="l12.17">   },</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19">   load: function debug_load() {</span>
<a href="#l12.20"></a><span id="l12.20">     setTimeout(function() {</span>
<a href="#l12.21"></a><span id="l12.21">       // Load the Window DataSource so that browser windows opened subsequent to DOM</span>
<a href="#l12.22"></a><span id="l12.22">       // Inspector show up in the DOM Inspector's window list.</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineat">@@ -47,48 +46,42 @@ var debug = {</span>
<a href="#l12.24"></a><span id="l12.24">   }</span>
<a href="#l12.25"></a><span id="l12.25"> };</span>
<a href="#l12.26"></a><span id="l12.26"> </span>
<a href="#l12.27"></a><span id="l12.27"> window.addEventListener(&quot;load&quot;, debug.load, false);</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29"> function debug_enumerateProtocols()</span>
<a href="#l12.30"></a><span id="l12.30"> {</span>
<a href="#l12.31"></a><span id="l12.31">   dump(&quot;trying to enumerate protocols:\n&quot;);</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-  var pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-                      .getService(Ci.purpleICoreService);</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-  for (let proto in getIter(pcs.getProtocols())) {</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+  for (let proto in getIter(Services.core.getProtocols())) {</span>
<a href="#l12.36"></a><span id="l12.36">     dump(&quot; &quot; + proto.name + &quot; &quot; + proto.id + &quot;\n&quot;);</span>
<a href="#l12.37"></a><span id="l12.37">     for (let opt in getIter(proto.getOptions())) {</span>
<a href="#l12.38"></a><span id="l12.38">       var type = { };</span>
<a href="#l12.39"></a><span id="l12.39">       type[opt.typeBool] = [&quot;bool&quot;, opt.getBool];</span>
<a href="#l12.40"></a><span id="l12.40">       type[opt.typeInt] = [&quot;int&quot;, opt.getInt];</span>
<a href="#l12.41"></a><span id="l12.41">       type[opt.typeString] = [&quot;string&quot;, opt.getString];</span>
<a href="#l12.42"></a><span id="l12.42">       dump(&quot;  (&quot;+ type[opt.type][0] + &quot;) &quot;  +</span>
<a href="#l12.43"></a><span id="l12.43">            opt.name + (opt.masked ? &quot;(masked)&quot; : &quot;&quot;) + &quot;\t&quot; +</span>
<a href="#l12.44"></a><span id="l12.44">            type[opt.type][1]() + &quot;\n&quot;);</span>
<a href="#l12.45"></a><span id="l12.45">     }</span>
<a href="#l12.46"></a><span id="l12.46">   }</span>
<a href="#l12.47"></a><span id="l12.47"> }</span>
<a href="#l12.48"></a><span id="l12.48"> </span>
<a href="#l12.49"></a><span id="l12.49"> function debug_connectAccount(aProto, aName, aPassword)</span>
<a href="#l12.50"></a><span id="l12.50"> {</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-  var pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-                      .getService(Ci.purpleICoreService);</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+  var pcs = Services.core;</span>
<a href="#l12.55"></a><span id="l12.55">   var proto = pcs.getProtocolById(aProto);</span>
<a href="#l12.56"></a><span id="l12.56">   if (!proto)</span>
<a href="#l12.57"></a><span id="l12.57">     throw &quot;Couldn't get protocol &quot; + aProto;</span>
<a href="#l12.58"></a><span id="l12.58"> </span>
<a href="#l12.59"></a><span id="l12.59">   var acc = pcs.createAccount(aName, proto);</span>
<a href="#l12.60"></a><span id="l12.60">   acc.password = aPassword;</span>
<a href="#l12.61"></a><span id="l12.61">   dump(&quot;trying to connect to &quot; + proto.name +</span>
<a href="#l12.62"></a><span id="l12.62">        &quot; (&quot; + proto.id + &quot;) with &quot; + aName + &quot;\n&quot;);</span>
<a href="#l12.63"></a><span id="l12.63">   acc.connect();</span>
<a href="#l12.64"></a><span id="l12.64"> }</span>
<a href="#l12.65"></a><span id="l12.65"> </span>
<a href="#l12.66"></a><span id="l12.66"> function debug_dumpBuddyList()</span>
<a href="#l12.67"></a><span id="l12.67"> {</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-  var pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-                      .getService(Ci.purpleICoreService);</span>
<a href="#l12.70"></a><span id="l12.70">   let formatBuddy = (function(buddy) &quot;  &quot; + buddy.name + &quot;\n   &quot; + buddy.getAccounts().map(function(a) a.name).join(&quot; &quot;));</span>
<a href="#l12.71"></a><span id="l12.71">   let formatGroup = (function(aGroup) &quot; Group &quot; + aGroup.id + &quot;: &quot; + aGroup.name + &quot;\n&quot; + aGroup.getBuddies().map(formatBuddy).join(&quot;\n&quot;));</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-  dump(&quot;Buddy list:\n\n&quot; + pcs.getTags().map(formatGroup).join(&quot;\n\n&quot;) + &quot;\n\n&quot;);</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+  dump(&quot;Buddy list:\n\n&quot; + Services.core.getTags().map(formatGroup).join(&quot;\n\n&quot;) + &quot;\n\n&quot;);</span>
<a href="#l12.74"></a><span id="l12.74"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/im/content/joinchat.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/im/content/joinchat.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -34,22 +34,16 @@</span>
<a href="#l13.4"></a><span id="l13.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l13.5"></a><span id="l13.5">  *</span>
<a href="#l13.6"></a><span id="l13.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> const autoJoinPref = &quot;autoJoin&quot;;</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> var joinChat = {</span>
<a href="#l13.11"></a><span id="l13.11">   onload: function jc_onload() {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-    this.pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-                         .getService(Ci.purpleICoreService);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-    this.buildAccountList();</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-  },</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-  buildAccountList: function jc_buildAccountList() {</span>
<a href="#l13.18"></a><span id="l13.18">     var accountList = document.getElementById(&quot;accountlist&quot;);</span>
<a href="#l13.19"></a><span id="l13.19">     for (let acc in this.getAccounts()) {</span>
<a href="#l13.20"></a><span id="l13.20">       if (!acc.connected || !acc.canJoinChat)</span>
<a href="#l13.21"></a><span id="l13.21">         continue;</span>
<a href="#l13.22"></a><span id="l13.22">       var proto = acc.protocol;</span>
<a href="#l13.23"></a><span id="l13.23">       var item = accountList.appendItem(acc.name, acc.id, proto.name);</span>
<a href="#l13.24"></a><span id="l13.24">       item.setAttribute(&quot;image&quot;, proto.iconBaseURI + &quot;icon.png&quot;);</span>
<a href="#l13.25"></a><span id="l13.25">       item.setAttribute(&quot;class&quot;, &quot;menuitem-iconic&quot;);</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineat">@@ -145,31 +139,28 @@ var joinChat = {</span>
<a href="#l13.27"></a><span id="l13.27">         document.getElementById(&quot;autojoin&quot;).checked) {</span>
<a href="#l13.28"></a><span id="l13.28">       let name;</span>
<a href="#l13.29"></a><span id="l13.29">       if (protoId == &quot;prpl-irc&quot;)</span>
<a href="#l13.30"></a><span id="l13.30">         name = values.getValue(&quot;channel&quot;);</span>
<a href="#l13.31"></a><span id="l13.31">       else</span>
<a href="#l13.32"></a><span id="l13.32">         name = values.getValue(&quot;room&quot;) + &quot;@&quot; +</span>
<a href="#l13.33"></a><span id="l13.33">                values.getValue(&quot;server&quot;) + &quot;/&quot; + values.getValue(&quot;handle&quot;);</span>
<a href="#l13.34"></a><span id="l13.34"> </span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-      let prefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-                                 .getService(Ci.nsIPrefService)</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-                                 .getBranch(&quot;messenger.account.&quot; + account.id + &quot;.&quot;);</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+      let prefBranch =</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+        Services.prefs.getBranch(&quot;messenger.account.&quot; + account.id + &quot;.&quot;);</span>
<a href="#l13.40"></a><span id="l13.40">       let autojoin = [ ];</span>
<a href="#l13.41"></a><span id="l13.41">       if (prefBranch.prefHasUserValue(autoJoinPref)) {</span>
<a href="#l13.42"></a><span id="l13.42">         let prefValue = prefBranch.getCharPref(autoJoinPref);</span>
<a href="#l13.43"></a><span id="l13.43">         if (prefValue)</span>
<a href="#l13.44"></a><span id="l13.44">           autojoin = prefValue.split(&quot;,&quot;);</span>
<a href="#l13.45"></a><span id="l13.45">       }</span>
<a href="#l13.46"></a><span id="l13.46"> </span>
<a href="#l13.47"></a><span id="l13.47">       if (autojoin.indexOf(name) == -1) {</span>
<a href="#l13.48"></a><span id="l13.48">         autojoin.push(name);</span>
<a href="#l13.49"></a><span id="l13.49">         prefBranch.setCharPref(autoJoinPref, autojoin.join(&quot;,&quot;));</span>
<a href="#l13.50"></a><span id="l13.50">       }</span>
<a href="#l13.51"></a><span id="l13.51">     }</span>
<a href="#l13.52"></a><span id="l13.52"> </span>
<a href="#l13.53"></a><span id="l13.53">     return true;</span>
<a href="#l13.54"></a><span id="l13.54">   },</span>
<a href="#l13.55"></a><span id="l13.55"> </span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-  getAccounts: function jc_getAccounts() {</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-    return getIter(this.pcs.getAccounts());</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-  }</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+  getAccounts: function jc_getAccounts() getIter(Services.core.getAccounts()</span>
<a href="#l13.60"></a><span id="l13.60"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/im/content/menus.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/im/content/menus.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -39,21 +39,22 @@ const addonManagerWindow = &quot;chrome://moz</span>
<a href="#l14.4"></a><span id="l14.4"> const accountManagerWindow = &quot;chrome://instantbird/content/accounts.xul&quot;;</span>
<a href="#l14.5"></a><span id="l14.5"> const blistWindow = &quot;chrome://instantbird/content/blist.xul&quot;;</span>
<a href="#l14.6"></a><span id="l14.6"> const addBuddyWindow = &quot;chrome://instantbird/content/addbuddy.xul&quot;;</span>
<a href="#l14.7"></a><span id="l14.7"> const joinChatWindow = &quot;chrome://instantbird/content/joinchat.xul&quot;;</span>
<a href="#l14.8"></a><span id="l14.8"> const aboutWindow = &quot;chrome://instantbird/content/aboutDialog.xul&quot;;</span>
<a href="#l14.9"></a><span id="l14.9"> const errorConsoleWindow = &quot;chrome://global/content/console.xul&quot;;</span>
<a href="#l14.10"></a><span id="l14.10"> const preferencesWindow = &quot;chrome://instantbird/content/preferences/preferences.xul&quot;;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+if (!(&quot;Services&quot; in window))</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  Components.utils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+</span>
<a href="#l14.15"></a><span id="l14.15"> var menus = {</span>
<a href="#l14.16"></a><span id="l14.16">   focus: function menu_focus(aWindowType) {</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-    var wm = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-                       .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-    var win = wm.getMostRecentWindow(aWindowType);</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+    var win = Services.wm.getMostRecentWindow(aWindowType);</span>
<a href="#l14.21"></a><span id="l14.21">     if (win)</span>
<a href="#l14.22"></a><span id="l14.22">       win.focus();</span>
<a href="#l14.23"></a><span id="l14.23">     return win;</span>
<a href="#l14.24"></a><span id="l14.24">   },</span>
<a href="#l14.25"></a><span id="l14.25"> </span>
<a href="#l14.26"></a><span id="l14.26">   about: function menu_about() {</span>
<a href="#l14.27"></a><span id="l14.27">     if (!this.focus(&quot;Messenger:About&quot;))</span>
<a href="#l14.28"></a><span id="l14.28">       window.open(aboutWindow, &quot;About&quot;,</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineat">@@ -151,19 +152,17 @@ var menus = {</span>
<a href="#l14.30"></a><span id="l14.30">     checkForUpdates.accessKey = strings.getString(&quot;updatesItem_&quot; + key + &quot;.accesskey&quot;);</span>
<a href="#l14.31"></a><span id="l14.31">     if (um.activeUpdate &amp;&amp; updates.isDownloading)</span>
<a href="#l14.32"></a><span id="l14.32">       checkForUpdates.setAttribute(&quot;loading&quot;, &quot;true&quot;);</span>
<a href="#l14.33"></a><span id="l14.33">     else</span>
<a href="#l14.34"></a><span id="l14.34">       checkForUpdates.removeAttribute(&quot;loading&quot;);</span>
<a href="#l14.35"></a><span id="l14.35">   },</span>
<a href="#l14.36"></a><span id="l14.36"> </span>
<a href="#l14.37"></a><span id="l14.37">   getAccounts: function bl_getAccounts() {</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-    var pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-                        .getService(Ci.purpleICoreService);</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-    return getIter(pcs.getAccounts());</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+    return getIter(Services.core.getAccounts());</span>
<a href="#l14.42"></a><span id="l14.42">   },</span>
<a href="#l14.43"></a><span id="l14.43">   updateFileMenuitems: function menu_updateFileMenuitems() {</span>
<a href="#l14.44"></a><span id="l14.44">     let hasConnectedAccount = false;</span>
<a href="#l14.45"></a><span id="l14.45">     let canJoinChat = false;</span>
<a href="#l14.46"></a><span id="l14.46">     for (let acc in this.getAccounts()) {</span>
<a href="#l14.47"></a><span id="l14.47">       if (acc.connected) {</span>
<a href="#l14.48"></a><span id="l14.48">         hasConnectedAccount = true;</span>
<a href="#l14.49"></a><span id="l14.49">         if (acc.canJoinChat)</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineat">@@ -181,20 +180,18 @@ var menus = {</span>
<a href="#l14.51"></a><span id="l14.51">   },</span>
<a href="#l14.52"></a><span id="l14.52"> </span>
<a href="#l14.53"></a><span id="l14.53">   joinChat: function menu_joinChat() {</span>
<a href="#l14.54"></a><span id="l14.54">     window.openDialog(joinChatWindow, &quot;&quot;,</span>
<a href="#l14.55"></a><span id="l14.55">                       &quot;chrome,modal,titlebar,centerscreen&quot;);</span>
<a href="#l14.56"></a><span id="l14.56">   },</span>
<a href="#l14.57"></a><span id="l14.57"> </span>
<a href="#l14.58"></a><span id="l14.58">   checkCurrentStatusType: function menu_checkCurrentStatusType(aItems) {</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-    var pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-                        .getService(Ci.purpleICoreService);</span>
<a href="#l14.61"></a><span id="l14.61">     let status = &quot;unknown&quot;;</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-    let statusType = pcs.currentStatusType;</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+    let statusType = Services.core.currentStatusType;</span>
<a href="#l14.64"></a><span id="l14.64">     if (statusType == Ci.purpleICoreService.STATUS_AVAILABLE)</span>
<a href="#l14.65"></a><span id="l14.65">       status = &quot;available&quot;;</span>
<a href="#l14.66"></a><span id="l14.66">     else if (statusType == Ci.purpleICoreService.STATUS_UNAVAILABLE ||</span>
<a href="#l14.67"></a><span id="l14.67">              statusType == Ci.purpleICoreService.STATUS_AWAY)</span>
<a href="#l14.68"></a><span id="l14.68">       status = &quot;unavailable&quot;;</span>
<a href="#l14.69"></a><span id="l14.69">     else if (statusType == Ci.purpleICoreService.STATUS_OFFLINE)</span>
<a href="#l14.70"></a><span id="l14.70">       status = &quot;offline&quot;;</span>
<a href="#l14.71"></a><span id="l14.71"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/im/content/nsContextMenu.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/im/content/nsContextMenu.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -73,18 +73,19 @@ function nsContextMenu(aXulMenu, aBrowse</span>
<a href="#l15.4"></a><span id="l15.4">   this.linkURI           = null;</span>
<a href="#l15.5"></a><span id="l15.5">   this.linkProtocol      = null;</span>
<a href="#l15.6"></a><span id="l15.6">   this.isTextSelected    = false;</span>
<a href="#l15.7"></a><span id="l15.7">   this.isContentSelected = false;</span>
<a href="#l15.8"></a><span id="l15.8">   this.shouldDisplay     = true;</span>
<a href="#l15.9"></a><span id="l15.9">   this.ellipsis = &quot;\u2026&quot;;</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11">   try {</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    this.ellipsis = gPrefService.getComplexValue(&quot;intl.ellipsis&quot;,</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-                                                 Ci.nsIPrefLocalizedString).data;</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+    this.ellipsis =</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+      Services.prefs.getComplexValue(&quot;intl.ellipsis&quot;,</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+                                     Ci.nsIPrefLocalizedString).data;</span>
<a href="#l15.17"></a><span id="l15.17">   } catch (e) { }</span>
<a href="#l15.18"></a><span id="l15.18"> </span>
<a href="#l15.19"></a><span id="l15.19">   // Initialize new menu.</span>
<a href="#l15.20"></a><span id="l15.20">   this.initMenu(aXulMenu, aBrowser);</span>
<a href="#l15.21"></a><span id="l15.21"> }</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23"> // Prototype for nsContextMenu &quot;class.&quot;</span>
<a href="#l15.24"></a><span id="l15.24"> nsContextMenu.prototype = {</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineat">@@ -190,36 +191,32 @@ nsContextMenu.prototype = {</span>
<a href="#l15.26"></a><span id="l15.26">     return this.linkProtocol &amp;&amp; !(</span>
<a href="#l15.27"></a><span id="l15.27">              this.linkProtocol == &quot;mailto&quot;     ||</span>
<a href="#l15.28"></a><span id="l15.28">              this.linkProtocol == &quot;javascript&quot; ||</span>
<a href="#l15.29"></a><span id="l15.29">              this.linkProtocol == &quot;news&quot;       ||</span>
<a href="#l15.30"></a><span id="l15.30">              this.linkProtocol == &quot;snews&quot;      );</span>
<a href="#l15.31"></a><span id="l15.31">   },</span>
<a href="#l15.32"></a><span id="l15.32"> </span>
<a href="#l15.33"></a><span id="l15.33">   openEngineManager: function() {</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-    var wm = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-                       .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-    var window = wm.getMostRecentWindow(&quot;Browser:SearchManager&quot;);</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+    var window = Services.wm.getMostRecentWindow(&quot;Browser:SearchManager&quot;);</span>
<a href="#l15.38"></a><span id="l15.38">     if (window)</span>
<a href="#l15.39"></a><span id="l15.39">       window.focus();</span>
<a href="#l15.40"></a><span id="l15.40">     else {</span>
<a href="#l15.41"></a><span id="l15.41">       openDialog(&quot;chrome://instantbird/content/engineManager.xul&quot;,</span>
<a href="#l15.42"></a><span id="l15.42">                  &quot;_blank&quot;, &quot;chrome,dialog,modal,centerscreen&quot;);</span>
<a href="#l15.43"></a><span id="l15.43">     }</span>
<a href="#l15.44"></a><span id="l15.44">   },</span>
<a href="#l15.45"></a><span id="l15.45"> </span>
<a href="#l15.46"></a><span id="l15.46">   buildSearchEngineList: function() {</span>
<a href="#l15.47"></a><span id="l15.47">     let popup = document.getElementById(&quot;context-popup-searchselect-with&quot;);</span>
<a href="#l15.48"></a><span id="l15.48">     // remove the menuitems added last time we opened the popup</span>
<a href="#l15.49"></a><span id="l15.49">     while (popup.firstChild &amp;&amp; popup.firstChild.localName != &quot;menuseparator&quot;)</span>
<a href="#l15.50"></a><span id="l15.50">       popup.removeChild(popup.firstChild);</span>
<a href="#l15.51"></a><span id="l15.51"> </span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-    let engines = Components.classes[&quot;@mozilla.org/browser/search-service;1&quot;]</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-                            .getService(Ci.nsIBrowserSearchService)</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-                            .getVisibleEngines({});</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+    let engines = Services.search.getVisibleEngines({});</span>
<a href="#l15.56"></a><span id="l15.56"> </span>
<a href="#l15.57"></a><span id="l15.57">     for (let i = engines.length - 1; i &gt;= 0; --i) {</span>
<a href="#l15.58"></a><span id="l15.58">       let menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l15.59"></a><span id="l15.59">       let name = engines[i].name;</span>
<a href="#l15.60"></a><span id="l15.60">       menuitem.setAttribute(&quot;label&quot;, name);</span>
<a href="#l15.61"></a><span id="l15.61">       menuitem.setAttribute(&quot;class&quot;, &quot;menuitem-iconic&quot;);</span>
<a href="#l15.62"></a><span id="l15.62">       if (engines[i].iconURI)</span>
<a href="#l15.63"></a><span id="l15.63">         menuitem.setAttribute(&quot;src&quot;, engines[i].iconURI.spec);</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineat">@@ -231,35 +228,35 @@ nsContextMenu.prototype = {</span>
<a href="#l15.65"></a><span id="l15.65">   searchSelectionWith: function(aEvent) {</span>
<a href="#l15.66"></a><span id="l15.66">     var engine = aEvent.originalTarget.engine;</span>
<a href="#l15.67"></a><span id="l15.67">     if (engine)</span>
<a href="#l15.68"></a><span id="l15.68">       this.searchSelection(engine);</span>
<a href="#l15.69"></a><span id="l15.69">   },</span>
<a href="#l15.70"></a><span id="l15.70"> </span>
<a href="#l15.71"></a><span id="l15.71">   searchSelection: function(aEngine) {</span>
<a href="#l15.72"></a><span id="l15.72">     if (!aEngine) {</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-      aEngine = Cc[&quot;@mozilla.org/browser/search-service;1&quot;].</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-                getService(Ci.nsIBrowserSearchService).</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-                defaultEngine;</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+      aEngine = Services.search.defaultEngine;</span>
<a href="#l15.77"></a><span id="l15.77">     }</span>
<a href="#l15.78"></a><span id="l15.78"> </span>
<a href="#l15.79"></a><span id="l15.79">     var submission = aEngine.getSubmission(getBrowserSelection(), null);</span>
<a href="#l15.80"></a><span id="l15.80">     // getSubmission can return null if the engine doesn't have a URL</span>
<a href="#l15.81"></a><span id="l15.81">     // with a text/html response type.  This is unlikely (since</span>
<a href="#l15.82"></a><span id="l15.82">     // SearchService._addEngineToStore() should fail for such an engine),</span>
<a href="#l15.83"></a><span id="l15.83">     // but let's be on the safe side.</span>
<a href="#l15.84"></a><span id="l15.84">     if (!submission)</span>
<a href="#l15.85"></a><span id="l15.85">       return;</span>
<a href="#l15.86"></a><span id="l15.86"> </span>
<a href="#l15.87"></a><span id="l15.87" class="difflineminus">-    gExtProtoService.loadURI(submission.uri, window);</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+    this.openLink(submission.uri);</span>
<a href="#l15.89"></a><span id="l15.89">   },</span>
<a href="#l15.90"></a><span id="l15.90"> </span>
<a href="#l15.91"></a><span id="l15.91">   // Open linked-to URL in a new window.</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-  openLink: function () {</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">-    gExtProtoService.loadURI(this.linkURI, window);</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+  openLink: function (aURI) {</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+    Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;].</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+    getService(Ci.nsIExternalProtocolService).</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+    loadURI(aURI || this.linkURI, window);</span>
<a href="#l15.98"></a><span id="l15.98">   },</span>
<a href="#l15.99"></a><span id="l15.99"> </span>
<a href="#l15.100"></a><span id="l15.100">   // Generate email address and put it on clipboard.</span>
<a href="#l15.101"></a><span id="l15.101">   copyEmail: function() {</span>
<a href="#l15.102"></a><span id="l15.102">     // Copy the comma-separated list of email addresses only.</span>
<a href="#l15.103"></a><span id="l15.103">     // There are other ways of embedding email addresses in a mailto:</span>
<a href="#l15.104"></a><span id="l15.104">     // link, but such complex parsing is beyond us.</span>
<a href="#l15.105"></a><span id="l15.105">     var url = this.linkURL;</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineat">@@ -328,20 +325,18 @@ nsContextMenu.prototype = {</span>
<a href="#l15.107"></a><span id="l15.107">       // for example, HTML case also throws if empty</span>
<a href="#l15.108"></a><span id="l15.108">       throw &quot;Empty href&quot;;</span>
<a href="#l15.109"></a><span id="l15.109">     }</span>
<a href="#l15.110"></a><span id="l15.110"> </span>
<a href="#l15.111"></a><span id="l15.111">     return makeURLAbsolute(this.link.baseURI, href);</span>
<a href="#l15.112"></a><span id="l15.112">   },</span>
<a href="#l15.113"></a><span id="l15.113"> </span>
<a href="#l15.114"></a><span id="l15.114">   getLinkURI: function() {</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineminus">-    var ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;].</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineminus">-                    getService(Ci.nsIIOService);</span>
<a href="#l15.117"></a><span id="l15.117">     try {</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-      return ioService.newURI(this.linkURL, null, null);</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+      return Services.io.newURI(this.linkURL, null, null);</span>
<a href="#l15.120"></a><span id="l15.120">     }</span>
<a href="#l15.121"></a><span id="l15.121">     catch (ex) {</span>
<a href="#l15.122"></a><span id="l15.122">      // e.g. empty URL string</span>
<a href="#l15.123"></a><span id="l15.123">     }</span>
<a href="#l15.124"></a><span id="l15.124"> </span>
<a href="#l15.125"></a><span id="l15.125">     return null;</span>
<a href="#l15.126"></a><span id="l15.126">   },</span>
<a href="#l15.127"></a><span id="l15.127"> </span>
<a href="#l15.128"></a><span id="l15.128" class="difflineat">@@ -374,19 +369,17 @@ nsContextMenu.prototype = {</span>
<a href="#l15.129"></a><span id="l15.129">     var selectedText = getBrowserSelection(16);</span>
<a href="#l15.130"></a><span id="l15.130"> </span>
<a href="#l15.131"></a><span id="l15.131">     if (!selectedText)</span>
<a href="#l15.132"></a><span id="l15.132">       return false;</span>
<a href="#l15.133"></a><span id="l15.133"> </span>
<a href="#l15.134"></a><span id="l15.134">     if (selectedText.length &gt; 15)</span>
<a href="#l15.135"></a><span id="l15.135">       selectedText = selectedText.substr(0,15) + this.ellipsis;</span>
<a href="#l15.136"></a><span id="l15.136"> </span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-    var engine = Cc[&quot;@mozilla.org/browser/search-service;1&quot;].</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineminus">-                 getService(Ci.nsIBrowserSearchService).</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineminus">-                 defaultEngine;</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+    var engine = Services.search.defaultEngine;</span>
<a href="#l15.141"></a><span id="l15.141">     if (!engine)</span>
<a href="#l15.142"></a><span id="l15.142">       return false;</span>
<a href="#l15.143"></a><span id="l15.143"> </span>
<a href="#l15.144"></a><span id="l15.144">     // format &quot;Search &lt;engine&gt; for &lt;selection&gt;&quot; string to show in menu</span>
<a href="#l15.145"></a><span id="l15.145">     var bundle = document.getElementById(&quot;bundle_instantbird&quot;);</span>
<a href="#l15.146"></a><span id="l15.146">     var menuLabel = bundle.getFormattedString(&quot;contextMenuSearchText&quot;,</span>
<a href="#l15.147"></a><span id="l15.147">                                               [engine.name,</span>
<a href="#l15.148"></a><span id="l15.148">                                                selectedText]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/im/content/preferences/advanced.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/im/content/preferences/advanced.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -135,19 +135,17 @@ var gAdvancedPane = {</span>
<a href="#l16.4"></a><span id="l16.4">   writeCheckSpelling: function ()</span>
<a href="#l16.5"></a><span id="l16.5">   {</span>
<a href="#l16.6"></a><span id="l16.6">     var checkbox = document.getElementById(&quot;checkSpelling&quot;);</span>
<a href="#l16.7"></a><span id="l16.7">     return checkbox.checked ? (this._storedSpellCheck == 2 ? 2 : 1) : 0;</span>
<a href="#l16.8"></a><span id="l16.8">   },</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10">   showSearchEngineManager: function()</span>
<a href="#l16.11"></a><span id="l16.11">   {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    var wm = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-                       .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-    var window = wm.getMostRecentWindow(&quot;Browser:SearchManager&quot;);</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+    var window = Services.wm.getMostRecentWindow(&quot;Browser:SearchManager&quot;);</span>
<a href="#l16.16"></a><span id="l16.16">     if (window)</span>
<a href="#l16.17"></a><span id="l16.17">       window.focus();</span>
<a href="#l16.18"></a><span id="l16.18">     else {</span>
<a href="#l16.19"></a><span id="l16.19">       openDialog(&quot;chrome://instantbird/content/engineManager.xul&quot;,</span>
<a href="#l16.20"></a><span id="l16.20">                  &quot;_blank&quot;, &quot;chrome,dialog,modal,centerscreen&quot;);</span>
<a href="#l16.21"></a><span id="l16.21">     }</span>
<a href="#l16.22"></a><span id="l16.22">   },</span>
<a href="#l16.23"></a><span id="l16.23">   </span>
<a href="#l16.24"></a><span id="l16.24" class="difflineat">@@ -430,24 +428,22 @@ var gAdvancedPane = {</span>
<a href="#l16.25"></a><span id="l16.25">   {</span>
<a href="#l16.26"></a><span id="l16.26">     var shellSvc = Components.classes[&quot;@mozilla.org/browser/shell-service;1&quot;]</span>
<a href="#l16.27"></a><span id="l16.27">                              .getService(Components.interfaces.nsIShellService);</span>
<a href="#l16.28"></a><span id="l16.28">     var brandBundle = document.getElementById(&quot;bundleBrand&quot;);</span>
<a href="#l16.29"></a><span id="l16.29">     var shellBundle = document.getElementById(&quot;bundleShell&quot;);</span>
<a href="#l16.30"></a><span id="l16.30">     var brandShortName = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l16.31"></a><span id="l16.31">     var promptTitle = shellBundle.getString(&quot;setDefaultBrowserTitle&quot;);</span>
<a href="#l16.32"></a><span id="l16.32">     var promptMessage;</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-    const IPS = Components.interfaces.nsIPromptService;</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-    var psvc = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-                         .getService(IPS);</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+    var psvc = Services.prompt;</span>
<a href="#l16.37"></a><span id="l16.37">     if (!shellSvc.isDefaultBrowser(false)) {</span>
<a href="#l16.38"></a><span id="l16.38">       promptMessage = shellBundle.getFormattedString(&quot;setDefaultBrowserMessage&quot;, </span>
<a href="#l16.39"></a><span id="l16.39">                                                      [brandShortName]);</span>
<a href="#l16.40"></a><span id="l16.40">       var rv = psvc.confirmEx(window, promptTitle, promptMessage, </span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-                              IPS.STD_YES_NO_BUTTONS,</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+                              psvc.STD_YES_NO_BUTTONS,</span>
<a href="#l16.43"></a><span id="l16.43">                               null, null, null, null, { });</span>
<a href="#l16.44"></a><span id="l16.44">       if (rv == 0)</span>
<a href="#l16.45"></a><span id="l16.45">         shellSvc.setDefaultBrowser(true, false);</span>
<a href="#l16.46"></a><span id="l16.46">     }</span>
<a href="#l16.47"></a><span id="l16.47">     else {</span>
<a href="#l16.48"></a><span id="l16.48">       promptMessage = shellBundle.getFormattedString(&quot;alreadyDefaultBrowser&quot;,</span>
<a href="#l16.49"></a><span id="l16.49">                                                      [brandShortName]);</span>
<a href="#l16.50"></a><span id="l16.50">       psvc.alert(window, promptTitle, promptMessage);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/im/content/preferences/applications.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/im/content/preferences/applications.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -88,21 +88,17 @@ function getDisplayNameForFile(aFile) {</span>
<a href="#l17.4"></a><span id="l17.4">     catch(ex) {</span>
<a href="#l17.5"></a><span id="l17.5">       // fall through to the file name</span>
<a href="#l17.6"></a><span id="l17.6">     }</span>
<a href="#l17.7"></a><span id="l17.7">   }</span>
<a href="#l17.8"></a><span id="l17.8"> /*</span>
<a href="#l17.9"></a><span id="l17.9"> #endif</span>
<a href="#l17.10"></a><span id="l17.10"> */</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  return Cc[&quot;@mozilla.org/network/io-service;1&quot;].</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-         getService(Ci.nsIIOService).</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-         newFileURI(aFile).</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-         QueryInterface(Ci.nsIURL).</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-         fileName;</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+  return Services.io.newFileURI(aFile).QueryInterface(Ci.nsIURL).fileName;</span>
<a href="#l17.18"></a><span id="l17.18"> }</span>
<a href="#l17.19"></a><span id="l17.19"> </span>
<a href="#l17.20"></a><span id="l17.20"> function getLocalHandlerApp(aFile) {</span>
<a href="#l17.21"></a><span id="l17.21">   var localHandlerApp = Cc[&quot;@mozilla.org/uriloader/local-handler-app;1&quot;].</span>
<a href="#l17.22"></a><span id="l17.22">                         createInstance(Ci.nsILocalHandlerApp);</span>
<a href="#l17.23"></a><span id="l17.23">   localHandlerApp.name = getDisplayNameForFile(aFile);</span>
<a href="#l17.24"></a><span id="l17.24">   localHandlerApp.executable = aFile;</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26" class="difflineat">@@ -163,22 +159,16 @@ HandlerInfoWrapper.prototype = {</span>
<a href="#l17.27"></a><span id="l17.27"> </span>
<a href="#l17.28"></a><span id="l17.28"> </span>
<a href="#l17.29"></a><span id="l17.29">   //**************************************************************************//</span>
<a href="#l17.30"></a><span id="l17.30">   // Convenience Utils</span>
<a href="#l17.31"></a><span id="l17.31"> </span>
<a href="#l17.32"></a><span id="l17.32">   _handlerSvc: Cc[&quot;@mozilla.org/uriloader/handler-service;1&quot;].</span>
<a href="#l17.33"></a><span id="l17.33">                getService(Ci.nsIHandlerService),</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-  // Retrieve this as nsIPrefBranch and then immediately QI to nsIPrefBranch2</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-  // so both interfaces are available to callers.</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-  _prefSvc: Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-            getService(Ci.nsIPrefBranch).</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-            QueryInterface(Ci.nsIPrefBranch2),</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-</span>
<a href="#l17.41"></a><span id="l17.41">   _categoryMgr: Cc[&quot;@mozilla.org/categorymanager;1&quot;].</span>
<a href="#l17.42"></a><span id="l17.42">                 getService(Ci.nsICategoryManager),</span>
<a href="#l17.43"></a><span id="l17.43"> </span>
<a href="#l17.44"></a><span id="l17.44">   element: function(aID) {</span>
<a href="#l17.45"></a><span id="l17.45">     return document.getElementById(aID);</span>
<a href="#l17.46"></a><span id="l17.46">   },</span>
<a href="#l17.47"></a><span id="l17.47"> </span>
<a href="#l17.48"></a><span id="l17.48"> </span>
<a href="#l17.49"></a><span id="l17.49" class="difflineat">@@ -373,34 +363,25 @@ var gApplicationsPane = {</span>
<a href="#l17.50"></a><span id="l17.50">   // Convenience &amp; Performance Shortcuts</span>
<a href="#l17.51"></a><span id="l17.51"> </span>
<a href="#l17.52"></a><span id="l17.52">   // These get defined by init().</span>
<a href="#l17.53"></a><span id="l17.53">   _brandShortName : null,</span>
<a href="#l17.54"></a><span id="l17.54">   _prefsBundle    : null,</span>
<a href="#l17.55"></a><span id="l17.55">   _list           : null,</span>
<a href="#l17.56"></a><span id="l17.56">   _filter         : null,</span>
<a href="#l17.57"></a><span id="l17.57"> </span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-  // Retrieve this as nsIPrefBranch and then immediately QI to nsIPrefBranch2</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-  // so both interfaces are available to callers.</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-  _prefSvc      : Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-                  getService(Ci.nsIPrefBranch).</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-                  QueryInterface(Ci.nsIPrefBranch2),</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-</span>
<a href="#l17.64"></a><span id="l17.64">   _mimeSvc      : Cc[&quot;@mozilla.org/mime;1&quot;].</span>
<a href="#l17.65"></a><span id="l17.65">                   getService(Ci.nsIMIMEService),</span>
<a href="#l17.66"></a><span id="l17.66"> </span>
<a href="#l17.67"></a><span id="l17.67">   _helperAppSvc : Cc[&quot;@mozilla.org/uriloader/external-helper-app-service;1&quot;].</span>
<a href="#l17.68"></a><span id="l17.68">                   getService(Ci.nsIExternalHelperAppService),</span>
<a href="#l17.69"></a><span id="l17.69"> </span>
<a href="#l17.70"></a><span id="l17.70">   _handlerSvc   : Cc[&quot;@mozilla.org/uriloader/handler-service;1&quot;].</span>
<a href="#l17.71"></a><span id="l17.71">                   getService(Ci.nsIHandlerService),</span>
<a href="#l17.72"></a><span id="l17.72"> </span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-  _ioSvc        : Cc[&quot;@mozilla.org/network/io-service;1&quot;].</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineminus">-                  getService(Ci.nsIIOService),</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineminus">-</span>
<a href="#l17.76"></a><span id="l17.76"> </span>
<a href="#l17.77"></a><span id="l17.77">   //**************************************************************************//</span>
<a href="#l17.78"></a><span id="l17.78">   // Initialization &amp; Destruction</span>
<a href="#l17.79"></a><span id="l17.79"> </span>
<a href="#l17.80"></a><span id="l17.80">   init: function() {</span>
<a href="#l17.81"></a><span id="l17.81">     // Initialize shortcuts to some commonly accessed elements &amp; values.</span>
<a href="#l17.82"></a><span id="l17.82">     this._brandShortName =</span>
<a href="#l17.83"></a><span id="l17.83">       document.getElementById(&quot;bundleBrand&quot;).getString(&quot;brandShortName&quot;);</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineat">@@ -434,18 +415,17 @@ var gApplicationsPane = {</span>
<a href="#l17.85"></a><span id="l17.85">     // XXX Shouldn't we perhaps just set a max-height on the richlistbox?</span>
<a href="#l17.86"></a><span id="l17.86">     var _delayedPaneLoad = function(self) {</span>
<a href="#l17.87"></a><span id="l17.87">       self._loadData();</span>
<a href="#l17.88"></a><span id="l17.88">       self._rebuildVisibleTypes();</span>
<a href="#l17.89"></a><span id="l17.89">       self._sortVisibleTypes();</span>
<a href="#l17.90"></a><span id="l17.90">       self._rebuildView();</span>
<a href="#l17.91"></a><span id="l17.91"> </span>
<a href="#l17.92"></a><span id="l17.92">       // Notify observers that the UI is now ready</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-      Cc[&quot;@mozilla.org/observer-service;1&quot;].getService(Ci.nsIObserverService).</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-      notifyObservers(window, &quot;app-handler-pane-loaded&quot;, null);</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+      Services.obs.notifyObservers(window, &quot;app-handler-pane-loaded&quot;, null);</span>
<a href="#l17.96"></a><span id="l17.96">     };</span>
<a href="#l17.97"></a><span id="l17.97">     setTimeout(_delayedPaneLoad, 0, this);</span>
<a href="#l17.98"></a><span id="l17.98">   },</span>
<a href="#l17.99"></a><span id="l17.99"> </span>
<a href="#l17.100"></a><span id="l17.100">   destroy: function() {</span>
<a href="#l17.101"></a><span id="l17.101">     window.removeEventListener(&quot;unload&quot;, this, false);</span>
<a href="#l17.102"></a><span id="l17.102">   },</span>
<a href="#l17.103"></a><span id="l17.103"> </span>
<a href="#l17.104"></a><span id="l17.104" class="difflineat">@@ -1123,34 +1103,34 @@ var gApplicationsPane = {</span>
<a href="#l17.105"></a><span id="l17.105">     if (aHandlerApp instanceof Ci.nsIWebContentHandlerInfo)</span>
<a href="#l17.106"></a><span id="l17.106">       return this._getIconURLForWebApp(aHandlerApp.uri);</span>
<a href="#l17.107"></a><span id="l17.107"> </span>
<a href="#l17.108"></a><span id="l17.108">     // We know nothing about other kinds of handler apps.</span>
<a href="#l17.109"></a><span id="l17.109">     return &quot;&quot;;</span>
<a href="#l17.110"></a><span id="l17.110">   },</span>
<a href="#l17.111"></a><span id="l17.111"> </span>
<a href="#l17.112"></a><span id="l17.112">   _getIconURLForFile: function(aFile) {</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineminus">-    var fph = this._ioSvc.getProtocolHandler(&quot;file&quot;).</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineplus">+    var fph = Services.io.getProtocolHandler(&quot;file&quot;).</span>
<a href="#l17.115"></a><span id="l17.115">               QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l17.116"></a><span id="l17.116">     var urlSpec = fph.getURLSpecFromFile(aFile);</span>
<a href="#l17.117"></a><span id="l17.117"> </span>
<a href="#l17.118"></a><span id="l17.118">     return &quot;moz-icon://&quot; + urlSpec + &quot;?size=16&quot;;</span>
<a href="#l17.119"></a><span id="l17.119">   },</span>
<a href="#l17.120"></a><span id="l17.120"> </span>
<a href="#l17.121"></a><span id="l17.121">   _getIconURLForWebApp: function(aWebAppURITemplate) {</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineminus">-    var uri = this._ioSvc.newURI(aWebAppURITemplate, null, null);</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineplus">+    var uri = Services.io.newURI(aWebAppURITemplate, null, null);</span>
<a href="#l17.124"></a><span id="l17.124"> </span>
<a href="#l17.125"></a><span id="l17.125">     // Unfortunately we can't use the favicon service to get the favicon,</span>
<a href="#l17.126"></a><span id="l17.126">     // because the service looks in the annotations table for a record with</span>
<a href="#l17.127"></a><span id="l17.127">     // the exact URL we give it, and users won't have such records for URLs</span>
<a href="#l17.128"></a><span id="l17.128">     // they don't visit, and users won't visit the web app's URL template,</span>
<a href="#l17.129"></a><span id="l17.129">     // they'll only visit URLs derived from that template (i.e. with %s</span>
<a href="#l17.130"></a><span id="l17.130">     // in the template replaced by the URL of the content being handled).</span>
<a href="#l17.131"></a><span id="l17.131"> </span>
<a href="#l17.132"></a><span id="l17.132" class="difflineminus">-    if (/^https?/.test(uri.scheme) &amp;&amp; this._prefSvc.getBoolPref(&quot;browser.chrome.favicons&quot;))</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+    if (/^https?/.test(uri.scheme) &amp;&amp; Services.prefs.getBoolPref(&quot;browser.chrome.favicons&quot;))</span>
<a href="#l17.134"></a><span id="l17.134">       return uri.prePath + &quot;/favicon.ico&quot;;</span>
<a href="#l17.135"></a><span id="l17.135"> </span>
<a href="#l17.136"></a><span id="l17.136">     return &quot;&quot;;</span>
<a href="#l17.137"></a><span id="l17.137">   },</span>
<a href="#l17.138"></a><span id="l17.138"> </span>
<a href="#l17.139"></a><span id="l17.139">   _getIconURLForSystemDefault: function(aHandlerInfo) {</span>
<a href="#l17.140"></a><span id="l17.140">     // Handler info objects for MIME types on some OSes implement a property bag</span>
<a href="#l17.141"></a><span id="l17.141">     // interface from which we can get an icon for the default app, so if we're</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/im/content/preferences/connection.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/im/content/preferences/connection.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -107,19 +107,17 @@ var gConnectionsDialog = {</span>
<a href="#l18.4"></a><span id="l18.4">     // Disable the &quot;Reload PAC&quot; button if the selected proxy type is not PAC or</span>
<a href="#l18.5"></a><span id="l18.5">     // if the current value of the PAC textbox does not match the value stored</span>
<a href="#l18.6"></a><span id="l18.6">     // in prefs.  Likewise, disable the reload button if PAC is not configured</span>
<a href="#l18.7"></a><span id="l18.7">     // in prefs.</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9">     var typedURL = document.getElementById(&quot;networkProxyAutoconfigURL&quot;).value;</span>
<a href="#l18.10"></a><span id="l18.10">     var proxyTypeCur = document.getElementById(&quot;network.proxy.type&quot;).value;</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-    var prefs =</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-        Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-        getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+    var prefs = Services.prefs;</span>
<a href="#l18.16"></a><span id="l18.16">     var pacURL = prefs.getCharPref(&quot;network.proxy.autoconfig_url&quot;);</span>
<a href="#l18.17"></a><span id="l18.17">     var proxyType = prefs.getIntPref(&quot;network.proxy.type&quot;);</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19">     var disableReloadPref =</span>
<a href="#l18.20"></a><span id="l18.20">         document.getElementById(&quot;pref.advanced.proxies.disable_button.reload&quot;);</span>
<a href="#l18.21"></a><span id="l18.21">     disableReloadPref.disabled =</span>
<a href="#l18.22"></a><span id="l18.22">         (proxyTypeCur != 2 || proxyType != 2 || typedURL != pacURL);</span>
<a href="#l18.23"></a><span id="l18.23">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/im/content/preferences/main.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/im/content/preferences/main.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -48,19 +48,17 @@ var gMainPane = {</span>
<a href="#l19.4"></a><span id="l19.4">   {</span>
<a href="#l19.5"></a><span id="l19.5">     this._pane = document.getElementById(&quot;paneMain&quot;);</span>
<a href="#l19.6"></a><span id="l19.6">   },</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8">   /**</span>
<a href="#l19.9"></a><span id="l19.9">    * Helper to focus an already existing window before opening a new one.</span>
<a href="#l19.10"></a><span id="l19.10">    */</span>
<a href="#l19.11"></a><span id="l19.11">   focus: function (aWindowType) {</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-    var wm = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-                       .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-    var win = wm.getMostRecentWindow(aWindowType);</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+    var win = Services.wm.getMostRecentWindow(aWindowType);</span>
<a href="#l19.16"></a><span id="l19.16">     if (win)</span>
<a href="#l19.17"></a><span id="l19.17">       win.focus();</span>
<a href="#l19.18"></a><span id="l19.18">     return win;</span>
<a href="#l19.19"></a><span id="l19.19">   },</span>
<a href="#l19.20"></a><span id="l19.20"> </span>
<a href="#l19.21"></a><span id="l19.21">   /**</span>
<a href="#l19.22"></a><span id="l19.22">    * Displays the Add-ons Manager.</span>
<a href="#l19.23"></a><span id="l19.23">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/im/content/preferences/messagestyle.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/im/content/preferences/messagestyle.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -257,28 +257,24 @@ var previewObserver = {</span>
<a href="#l20.4"></a><span id="l20.4">     this.reloadPreview();</span>
<a href="#l20.5"></a><span id="l20.5">     document.getElementById(&quot;previewDeck&quot;).selectedIndex = 1;</span>
<a href="#l20.6"></a><span id="l20.6">   },</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8">   reloadPreview: function() {</span>
<a href="#l20.9"></a><span id="l20.9">     this.conv.messages.forEach(function (m) { m.reset(); });</span>
<a href="#l20.10"></a><span id="l20.10">     this.browser.init(this.conv);</span>
<a href="#l20.11"></a><span id="l20.11">     this.browser._theme = this.theme;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-              .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-              .addObserver(this, &quot;conversation-loaded&quot;, false);</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+    Services.obs.addObserver(this, &quot;conversation-loaded&quot;, false);</span>
<a href="#l20.16"></a><span id="l20.16">   },</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18">   observe: function(aSubject, aTopic, aData) {</span>
<a href="#l20.19"></a><span id="l20.19">     if (aTopic != &quot;conversation-loaded&quot; || aSubject != this.browser)</span>
<a href="#l20.20"></a><span id="l20.20">       return;</span>
<a href="#l20.21"></a><span id="l20.21"> </span>
<a href="#l20.22"></a><span id="l20.22">     // Display all queued messages. Use a timeout so that message text</span>
<a href="#l20.23"></a><span id="l20.23">     // modifiers can be added with observers for this notification.</span>
<a href="#l20.24"></a><span id="l20.24">     setTimeout(function(aSelf) {</span>
<a href="#l20.25"></a><span id="l20.25">       aSelf.conv.messages.forEach(aSelf.browser.appendMessage, aSelf.browser);</span>
<a href="#l20.26"></a><span id="l20.26">     }, 0, this);</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-    Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-              .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-              .removeObserver(this, &quot;conversation-loaded&quot;);</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+    Services.obs.removeObserver(this, &quot;conversation-loaded&quot;);</span>
<a href="#l20.32"></a><span id="l20.32">   }</span>
<a href="#l20.33"></a><span id="l20.33"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/im/content/preferences/privacy.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/im/content/preferences/privacy.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -62,36 +62,33 @@ var gPrivacyPane = {</span>
<a href="#l21.4"></a><span id="l21.4">   },</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6">   openLogFolder: function ()</span>
<a href="#l21.7"></a><span id="l21.7">   {</span>
<a href="#l21.8"></a><span id="l21.8">     let Cc = Components.classes;</span>
<a href="#l21.9"></a><span id="l21.9">     let Ci = Components.interfaces;</span>
<a href="#l21.10"></a><span id="l21.10">     </span>
<a href="#l21.11"></a><span id="l21.11">     // Log folder is &quot;'profile directory'/logs&quot;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-    var logFolder = Cc[&quot;@mozilla.org/file/directory_service;1&quot;].</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-                    getService(Ci.nsIProperties).</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-                    get(&quot;ProfD&quot;, Ci.nsILocalFile);</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+    var logFolder = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsILocalFile);</span>
<a href="#l21.16"></a><span id="l21.16">     logFolder.append(&quot;logs&quot;);</span>
<a href="#l21.17"></a><span id="l21.17"> </span>
<a href="#l21.18"></a><span id="l21.18">     try {</span>
<a href="#l21.19"></a><span id="l21.19">       logFolder.reveal();</span>
<a href="#l21.20"></a><span id="l21.20">     } catch (e) {</span>
<a href="#l21.21"></a><span id="l21.21">       // Adapted the workaround of Firefox' Download Manager for some *ix systems</span>
<a href="#l21.22"></a><span id="l21.22">       let parent = logFolder.parent.QueryInterface(Ci.nsILocalFile);</span>
<a href="#l21.23"></a><span id="l21.23">       if (!parent)</span>
<a href="#l21.24"></a><span id="l21.24">        return;</span>
<a href="#l21.25"></a><span id="l21.25"> </span>
<a href="#l21.26"></a><span id="l21.26">       try {</span>
<a href="#l21.27"></a><span id="l21.27">        // &quot;Double click&quot; the parent directory to show where the file should be</span>
<a href="#l21.28"></a><span id="l21.28">        parent.launch();</span>
<a href="#l21.29"></a><span id="l21.29">       } catch (e) {</span>
<a href="#l21.30"></a><span id="l21.30">        // If launch also fails (probably because it's not implemented), let the</span>
<a href="#l21.31"></a><span id="l21.31">        // OS handler try to open the parent</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-       let uri = Cc[&quot;@mozilla.org/network/io-service;1&quot;].</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-                 getService(Ci.nsIIOService).newFileURI(parent);</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+       let uri = Services.io.newFileURI(parent);</span>
<a href="#l21.35"></a><span id="l21.35">        let protocolSvc = Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;].</span>
<a href="#l21.36"></a><span id="l21.36">                          getService(Ci.nsIExternalProtocolService);</span>
<a href="#l21.37"></a><span id="l21.37">        protocolSvc.loadUrl(uri);</span>
<a href="#l21.38"></a><span id="l21.38">       }</span>
<a href="#l21.39"></a><span id="l21.39">     }</span>
<a href="#l21.40"></a><span id="l21.40">   }</span>
<a href="#l21.41"></a><span id="l21.41"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/im/content/preferences/themes.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/im/content/preferences/themes.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -63,20 +63,17 @@ var gThemePane = {</span>
<a href="#l22.4"></a><span id="l22.4">         break;</span>
<a href="#l22.5"></a><span id="l22.5">       default:</span>
<a href="#l22.6"></a><span id="l22.6">         return;</span>
<a href="#l22.7"></a><span id="l22.7">     }</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9">     var getMore = document.getElementById(&quot;getMore&quot; + aType);</span>
<a href="#l22.10"></a><span id="l22.10">     var showGetMore = false;</span>
<a href="#l22.11"></a><span id="l22.11">     const nsIPrefBranch2 = Components.interfaces.nsIPrefBranch2;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-    if (Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-                  .getService(nsIPrefBranch2)</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-                  .getPrefType(prefURL) != nsIPrefBranch2.PREF_INVALID) {</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+    if (Services.prefs.getPrefType(prefURL) != nsIPrefBranch2.PREF_INVALID) {</span>
<a href="#l22.17"></a><span id="l22.17">       try {</span>
<a href="#l22.18"></a><span id="l22.18">         var getMoreURL = Components.classes[&quot;@mozilla.org/toolkit/URLFormatterService;1&quot;]</span>
<a href="#l22.19"></a><span id="l22.19">                                    .getService(Components.interfaces.nsIURLFormatter)</span>
<a href="#l22.20"></a><span id="l22.20">                                    .formatURLPref(prefURL);</span>
<a href="#l22.21"></a><span id="l22.21">         getMore.setAttribute(&quot;getMoreURL&quot;, getMoreURL);</span>
<a href="#l22.22"></a><span id="l22.22">         showGetMore = getMoreURL != &quot;about:blank&quot;;</span>
<a href="#l22.23"></a><span id="l22.23">       }</span>
<a href="#l22.24"></a><span id="l22.24">       catch (e) { }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/im/content/proxies.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/im/content/proxies.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -37,18 +37,17 @@</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5"> var gProxies = {</span>
<a href="#l23.6"></a><span id="l23.6">   load: function proxy_load() {</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8">   // check the environment</span>
<a href="#l23.9"></a><span id="l23.9">   // see what the global settings are</span>
<a href="#l23.10"></a><span id="l23.10">   // build a list of existing proxies</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-    var pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-                        .getService(Ci.purpleICoreService);</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+    var pcs = Services.core;</span>
<a href="#l23.15"></a><span id="l23.15"> </span>
<a href="#l23.16"></a><span id="l23.16">     var proxyInfoCtr = Components.Constructor(&quot;@instantbird.org/purple/proxyinfo;1&quot;,</span>
<a href="#l23.17"></a><span id="l23.17">                                               &quot;purpleIProxyInfo&quot;);</span>
<a href="#l23.18"></a><span id="l23.18">     var proxyInfo;</span>
<a href="#l23.19"></a><span id="l23.19">     var account = window.arguments[0];</span>
<a href="#l23.20"></a><span id="l23.20">     if (account) {</span>
<a href="#l23.21"></a><span id="l23.21">       proxyInfo = new proxyInfoCtr();</span>
<a href="#l23.22"></a><span id="l23.22">       proxyInfo.type = Ci.purpleIProxyInfo.useGlobal;</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineat">@@ -148,20 +147,18 @@ var gProxies = {</span>
<a href="#l23.24"></a><span id="l23.24">     }</span>
<a href="#l23.25"></a><span id="l23.25">   },</span>
<a href="#l23.26"></a><span id="l23.26"> </span>
<a href="#l23.27"></a><span id="l23.27">   getValue: function proxy_getValue(aId) {</span>
<a href="#l23.28"></a><span id="l23.28">     return document.getElementById(aId).value;</span>
<a href="#l23.29"></a><span id="l23.29">   },</span>
<a href="#l23.30"></a><span id="l23.30"> </span>
<a href="#l23.31"></a><span id="l23.31">   accept: function proxy_accept() {</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-    var pcs = Components.classes[&quot;@instantbird.org/purple/core;1&quot;]</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-                        .getService(Ci.purpleICoreService);</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-    var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-                                  .getService(Ci.nsIPromptService);</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+    var pcs = Services.core;</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineplus">+    var promptService = Services.prompt;</span>
<a href="#l23.38"></a><span id="l23.38">     var item = document.getElementById(&quot;proxylist&quot;).selectedItem;</span>
<a href="#l23.39"></a><span id="l23.39">     if (item.id == &quot;newProxy&quot;) {</span>
<a href="#l23.40"></a><span id="l23.40">       var type = this.getValue(&quot;proxyType&quot;);</span>
<a href="#l23.41"></a><span id="l23.41">       var host = this.getValue(&quot;hostname&quot;);</span>
<a href="#l23.42"></a><span id="l23.42">       var port = this.getValue(&quot;port&quot;);</span>
<a href="#l23.43"></a><span id="l23.43">       if (!host || !port) {</span>
<a href="#l23.44"></a><span id="l23.44">         promptService.alert(window, bundle.getString(&quot;proxies.alert.invalidInput.title&quot;),</span>
<a href="#l23.45"></a><span id="l23.45">                             bundle.getString(&quot;proxies.alert.invalidInput.message&quot;));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/im/content/sound.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/im/content/sound.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -81,17 +81,18 @@ var soundHelper = {</span>
<a href="#l24.4"></a><span id="l24.4"> </span>
<a href="#l24.5"></a><span id="l24.5">   play: function sh_play(aEvent) {</span>
<a href="#l24.6"></a><span id="l24.6">     if (this._muted)</span>
<a href="#l24.7"></a><span id="l24.7">       return;</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9">     if (!(aEvent in this._soundUri)) {</span>
<a href="#l24.10"></a><span id="l24.10">       if (!(aEvent in this.soundFiles))</span>
<a href="#l24.11"></a><span id="l24.11">         throw &quot;bad sound event&quot;;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-      this._soundUri[aEvent] = makeURI(this.soundFiles[aEvent]);</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+      this._soundUri[aEvent] =</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+        Services.io.newURI(this.soundFiles[aEvent], null, null);</span>
<a href="#l24.15"></a><span id="l24.15">     }</span>
<a href="#l24.16"></a><span id="l24.16"> </span>
<a href="#l24.17"></a><span id="l24.17">     if (this._playingEvents.indexOf(aEvent) == -1)</span>
<a href="#l24.18"></a><span id="l24.18">       if (this._playingEvents.push(aEvent) == 1)</span>
<a href="#l24.19"></a><span id="l24.19">         setTimeout(this._play, 0);</span>
<a href="#l24.20"></a><span id="l24.20">   }</span>
<a href="#l24.21"></a><span id="l24.21"> };</span>
<a href="#l24.22"></a><span id="l24.22"> </span>
<a href="#l24.23"></a><span id="l24.23" class="difflineat">@@ -126,20 +127,17 @@ var soundObserver = {</span>
<a href="#l24.24"></a><span id="l24.24">       break;</span>
<a href="#l24.25"></a><span id="l24.25"> </span>
<a href="#l24.26"></a><span id="l24.26">     default:</span>
<a href="#l24.27"></a><span id="l24.27">       throw &quot;bad notification&quot;;</span>
<a href="#l24.28"></a><span id="l24.28">     }</span>
<a href="#l24.29"></a><span id="l24.29">   },</span>
<a href="#l24.30"></a><span id="l24.30">   load: function so_load() {</span>
<a href="#l24.31"></a><span id="l24.31">     addObservers(soundObserver, soundEvents);</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-    soundObserver._prefBranch =</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-      Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-                .getService(Ci.nsIPrefService)</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-                .getBranch(optPrefBranch);</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+    soundObserver._prefBranch = Services.prefs.getBranch(optPrefBranch);</span>
<a href="#l24.37"></a><span id="l24.37">     soundObserver._prefBranch.QueryInterface(Ci.nsIPrefBranch2);</span>
<a href="#l24.38"></a><span id="l24.38">     soundObserver._prefBranch.addObserver(soundsPref, soundObserver, false);</span>
<a href="#l24.39"></a><span id="l24.39">     soundHelper.muted = !soundObserver._prefBranch.getBoolPref(soundsPref);</span>
<a href="#l24.40"></a><span id="l24.40"> </span>
<a href="#l24.41"></a><span id="l24.41">     this.addEventListener(&quot;unload&quot;, soundObserver.unload, false);</span>
<a href="#l24.42"></a><span id="l24.42">   },</span>
<a href="#l24.43"></a><span id="l24.43">   unload: function so_unload() {</span>
<a href="#l24.44"></a><span id="l24.44">     removeObservers(soundObserver, soundEvents);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/im/content/tabbrowser.xml</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/im/content/tabbrowser.xml</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -126,20 +126,16 @@</span>
<a href="#l25.4"></a><span id="l25.4">         &lt;/xul:hbox&gt;</span>
<a href="#l25.5"></a><span id="l25.5">         &lt;xul:tabpanels flex=&quot;1&quot; class=&quot;plain&quot; selectedIndex=&quot;0&quot; anonid=&quot;panelcontainer&quot;&gt;</span>
<a href="#l25.6"></a><span id="l25.6">           &lt;xul:conversation selected=&quot;true&quot;/&gt;</span>
<a href="#l25.7"></a><span id="l25.7">         &lt;/xul:tabpanels&gt;</span>
<a href="#l25.8"></a><span id="l25.8">       &lt;/xul:tabbox&gt;</span>
<a href="#l25.9"></a><span id="l25.9">       &lt;children/&gt;</span>
<a href="#l25.10"></a><span id="l25.10">     &lt;/content&gt;</span>
<a href="#l25.11"></a><span id="l25.11">     &lt;implementation&gt;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-      &lt;field name=&quot;mPrefs&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-        Components.classes['@mozilla.org/preferences-service;1']</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-                  .getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l25.16"></a><span id="l25.16">       &lt;field name=&quot;mTabBox&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l25.17"></a><span id="l25.17">         document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;tabbox&quot;);</span>
<a href="#l25.18"></a><span id="l25.18">       &lt;/field&gt;</span>
<a href="#l25.19"></a><span id="l25.19">       &lt;field name=&quot;mTabDropIndicatorBar&quot;&gt;</span>
<a href="#l25.20"></a><span id="l25.20">         this.mTabBox.childNodes[0]</span>
<a href="#l25.21"></a><span id="l25.21">       &lt;/field&gt;</span>
<a href="#l25.22"></a><span id="l25.22">       &lt;field name=&quot;mStrip&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l25.23"></a><span id="l25.23">         document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;strip&quot;);</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineat">@@ -300,24 +296,24 @@</span>
<a href="#l25.25"></a><span id="l25.25">         observe: function(subject, topic, data)</span>
<a href="#l25.26"></a><span id="l25.26">         {</span>
<a href="#l25.27"></a><span id="l25.27">           if (topic == &quot;nsPref:changed&quot;) {</span>
<a href="#l25.28"></a><span id="l25.28">             switch (data) {</span>
<a href="#l25.29"></a><span id="l25.29">             case &quot;browser.tabs.autoHide&quot;:</span>
<a href="#l25.30"></a><span id="l25.30">               if (this.tabbrowser.tabContainer.childNodes.length == 1 &amp;amp;&amp;amp;</span>
<a href="#l25.31"></a><span id="l25.31">                   window.toolbar.visible) {</span>
<a href="#l25.32"></a><span id="l25.32">                 let visible =</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-                  !this.tabbrowser.mPrefs.getBoolPref(&quot;browser.tabs.autoHide&quot;);</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+                  !Services.prefs.getBoolPref(&quot;browser.tabs.autoHide&quot;);</span>
<a href="#l25.35"></a><span id="l25.35">                 this.tabbrowser.setStripVisibilityTo(visible);</span>
<a href="#l25.36"></a><span id="l25.36">               }</span>
<a href="#l25.37"></a><span id="l25.37">               break;</span>
<a href="#l25.38"></a><span id="l25.38"> </span>
<a href="#l25.39"></a><span id="l25.39">             case &quot;messenger.conversations.useSeparateWindowsForMUCs&quot;:</span>
<a href="#l25.40"></a><span id="l25.40">               if (this.tabbrowser.tabContainer.childNodes.length &gt; 1 &amp;amp;&amp;amp;</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-                  this.tabbrowser.mPrefs.getBoolPref(&quot;messenger.conversations.useSeparateWindowsForMUCs&quot;)) {</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineplus">+                  Services.prefs.getBoolPref(&quot;messenger.conversations.useSeparateWindowsForMUCs&quot;)) {</span>
<a href="#l25.43"></a><span id="l25.43">                 let convs = this.tabbrowser.conversations;</span>
<a href="#l25.44"></a><span id="l25.44">                 let firstIsChat = convs[0].hasAttribute(&quot;chat&quot;);</span>
<a href="#l25.45"></a><span id="l25.45">                 let movedTabs = [];</span>
<a href="#l25.46"></a><span id="l25.46">                 for (let i = 1; i &amp;lt; convs.length; ++i)</span>
<a href="#l25.47"></a><span id="l25.47">                   if (convs[i].hasAttribute(&quot;chat&quot;) != firstIsChat)</span>
<a href="#l25.48"></a><span id="l25.48">                     movedTabs.push(convs[i].tab);</span>
<a href="#l25.49"></a><span id="l25.49">                 if (movedTabs.length)</span>
<a href="#l25.50"></a><span id="l25.50">                   this.tabbrowser.replaceTabsWithWindow(movedTabs);</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineat">@@ -365,20 +361,20 @@</span>
<a href="#l25.52"></a><span id="l25.52">         &lt;/body&gt;</span>
<a href="#l25.53"></a><span id="l25.53">       &lt;/method&gt;</span>
<a href="#l25.54"></a><span id="l25.54"> </span>
<a href="#l25.55"></a><span id="l25.55">       &lt;method name=&quot;addConversation&quot;&gt;</span>
<a href="#l25.56"></a><span id="l25.56">         &lt;parameter name=&quot;aConv&quot;/&gt;</span>
<a href="#l25.57"></a><span id="l25.57">         &lt;body&gt;</span>
<a href="#l25.58"></a><span id="l25.58">           &lt;![CDATA[</span>
<a href="#l25.59"></a><span id="l25.59">             if (!this.mFirstTabIsDummy) {</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineminus">-              if (!this.mPrefs.getBoolPref(&quot;messenger.conversations.openInTabs&quot;))</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineplus">+              if (!Services.prefs.getBoolPref(&quot;messenger.conversations.openInTabs&quot;))</span>
<a href="#l25.62"></a><span id="l25.62">                 return null;</span>
<a href="#l25.63"></a><span id="l25.63"> </span>
<a href="#l25.64"></a><span id="l25.64" class="difflineminus">-              if (this.mPrefs.getBoolPref(&quot;messenger.conversations.useSeparateWindowsForMUCs&quot;) &amp;&amp;</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineplus">+              if (Services.prefs.getBoolPref(&quot;messenger.conversations.useSeparateWindowsForMUCs&quot;) &amp;&amp;</span>
<a href="#l25.66"></a><span id="l25.66">                   aConv.isChat != this.conversations[0].hasAttribute(&quot;chat&quot;))</span>
<a href="#l25.67"></a><span id="l25.67">                 return null;</span>
<a href="#l25.68"></a><span id="l25.68">             }</span>
<a href="#l25.69"></a><span id="l25.69"> </span>
<a href="#l25.70"></a><span id="l25.70">             return this._addConversation(aConv);</span>
<a href="#l25.71"></a><span id="l25.71">         ]]&gt;</span>
<a href="#l25.72"></a><span id="l25.72">         &lt;/body&gt;</span>
<a href="#l25.73"></a><span id="l25.73">       &lt;/method&gt;</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineat">@@ -411,17 +407,17 @@</span>
<a href="#l25.75"></a><span id="l25.75">               t = this.mTabContainer.firstChild;</span>
<a href="#l25.76"></a><span id="l25.76">             else</span>
<a href="#l25.77"></a><span id="l25.77">               t = this.mTabContainer.addTab();</span>
<a href="#l25.78"></a><span id="l25.78">             t.setAttribute(&quot;label&quot;, aConv.title);</span>
<a href="#l25.79"></a><span id="l25.79">             conv.tab = t;</span>
<a href="#l25.80"></a><span id="l25.80">             conv.conv = aConv;</span>
<a href="#l25.81"></a><span id="l25.81"> </span>
<a href="#l25.82"></a><span id="l25.82">             if (this.mStrip.collapsed &amp;&amp;</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineminus">-                !this.mPrefs.getBoolPref(&quot;browser.tabs.autoHide&quot;))</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineplus">+                !Services.prefs.getBoolPref(&quot;browser.tabs.autoHide&quot;))</span>
<a href="#l25.85"></a><span id="l25.85">               this.setStripVisibilityTo(true);</span>
<a href="#l25.86"></a><span id="l25.86">             this.mFirstTabIsDummy = false;</span>
<a href="#l25.87"></a><span id="l25.87"> </span>
<a href="#l25.88"></a><span id="l25.88">             var uniqueId = &quot;panel&quot; + Date.now() + t._tPos;</span>
<a href="#l25.89"></a><span id="l25.89">             this.mPanelContainer.lastChild.id = uniqueId;</span>
<a href="#l25.90"></a><span id="l25.90">             t.linkedPanel = uniqueId;</span>
<a href="#l25.91"></a><span id="l25.91">             t.linkedConversation = conv;</span>
<a href="#l25.92"></a><span id="l25.92">             t.linkedBrowser = conv.browser;</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineat">@@ -445,49 +441,47 @@</span>
<a href="#l25.94"></a><span id="l25.94">             let tab = conv.tab;</span>
<a href="#l25.95"></a><span id="l25.95">             return tab.hasAttribute(&quot;unread&quot;) &amp;&amp;</span>
<a href="#l25.96"></a><span id="l25.96">                    (!tab.hasAttribute(&quot;chat&quot;) || tab.hasAttribute(&quot;attention&quot;));</span>
<a href="#l25.97"></a><span id="l25.97">           }).length;</span>
<a href="#l25.98"></a><span id="l25.98">           if (!unreadConvsCount)</span>
<a href="#l25.99"></a><span id="l25.99">             return reallyClose;</span>
<a href="#l25.100"></a><span id="l25.100"> </span>
<a href="#l25.101"></a><span id="l25.101">           const pref = &quot;browser.tabs.warnOnClose&quot;;</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineminus">-          var shouldPrompt = this.mPrefs.getBoolPref(pref);</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineplus">+          var shouldPrompt = Services.prefs.getBoolPref(pref);</span>
<a href="#l25.104"></a><span id="l25.104"> </span>
<a href="#l25.105"></a><span id="l25.105">           if (shouldPrompt) {</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineminus">-            var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineminus">-                                          .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineminus">-</span>
<a href="#l25.109"></a><span id="l25.109">             //default to true: if it were false, we wouldn't get this far</span>
<a href="#l25.110"></a><span id="l25.110">             var warnOnClose = { value:true };</span>
<a href="#l25.111"></a><span id="l25.111">             var bundle = this.mStringBundle;</span>
<a href="#l25.112"></a><span id="l25.112">             if (!(&quot;PluralForm&quot; in window))</span>
<a href="#l25.113"></a><span id="l25.113">               Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l25.114"></a><span id="l25.114">             var promptMessage = PluralForm.get(unreadConvsCount, bundle.getString(&quot;tabs.closeWarningMessage&quot;))</span>
<a href="#l25.115"></a><span id="l25.115">                                           .replace(&quot;#1&quot;, unreadConvsCount);</span>
<a href="#l25.116"></a><span id="l25.116">             var closeButton = PluralForm.get(unreadConvsCount, bundle.getString(&quot;tabs.closeButton&quot;));</span>
<a href="#l25.117"></a><span id="l25.117">             // focus the window before prompting.</span>
<a href="#l25.118"></a><span id="l25.118">             // this will raise any minimized window, which will</span>
<a href="#l25.119"></a><span id="l25.119">             // make it obvious which window the prompt is for and will</span>
<a href="#l25.120"></a><span id="l25.120">             // solve the problem of windows &quot;obscuring&quot; the prompt.</span>
<a href="#l25.121"></a><span id="l25.121">             // see bug #350299 for more details</span>
<a href="#l25.122"></a><span id="l25.122">             window.focus();</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineplus">+            var promptService = Services.prompt;</span>
<a href="#l25.124"></a><span id="l25.124">             var buttonPressed = promptService.confirmEx(window,</span>
<a href="#l25.125"></a><span id="l25.125">                                                         bundle.getString('tabs.closeWarningTitle'),</span>
<a href="#l25.126"></a><span id="l25.126">                                                         promptMessage,</span>
<a href="#l25.127"></a><span id="l25.127">                                                         (promptService.BUTTON_TITLE_IS_STRING * promptService.BUTTON_POS_0)</span>
<a href="#l25.128"></a><span id="l25.128">                                                         + (promptService.BUTTON_TITLE_CANCEL * promptService.BUTTON_POS_1),</span>
<a href="#l25.129"></a><span id="l25.129">                                                         closeButton,</span>
<a href="#l25.130"></a><span id="l25.130">                                                         null, null,</span>
<a href="#l25.131"></a><span id="l25.131">                                                         bundle.getString('tabs.closeWarningPromptMe'),</span>
<a href="#l25.132"></a><span id="l25.132">                                                         warnOnClose);</span>
<a href="#l25.133"></a><span id="l25.133">             reallyClose = (buttonPressed == 0);</span>
<a href="#l25.134"></a><span id="l25.134">             // don't set the pref unless they press OK and it's false</span>
<a href="#l25.135"></a><span id="l25.135">             if (reallyClose &amp;&amp; !warnOnClose.value)</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineminus">-              this.mPrefs.setBoolPref(pref, false);</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineplus">+              Services.prefs.setBoolPref(pref, false);</span>
<a href="#l25.138"></a><span id="l25.138">           }</span>
<a href="#l25.139"></a><span id="l25.139">           return reallyClose;</span>
<a href="#l25.140"></a><span id="l25.140">         ]]&gt;</span>
<a href="#l25.141"></a><span id="l25.141">       &lt;/body&gt;</span>
<a href="#l25.142"></a><span id="l25.142">       &lt;/method&gt;</span>
<a href="#l25.143"></a><span id="l25.143"> </span>
<a href="#l25.144"></a><span id="l25.144">       &lt;method name=&quot;removeAllTabsBut&quot;&gt;</span>
<a href="#l25.145"></a><span id="l25.145">         &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l25.146"></a><span id="l25.146" class="difflineat">@@ -555,17 +549,17 @@</span>
<a href="#l25.147"></a><span id="l25.147">             if (l == 1) {</span>
<a href="#l25.148"></a><span id="l25.148">               closeWindow = true;</span>
<a href="#l25.149"></a><span id="l25.149">               if (aCloseWindowFastpath &amp;&amp;</span>
<a href="#l25.150"></a><span id="l25.150">                   this._removingTabs.length == 0 &amp;&amp;</span>
<a href="#l25.151"></a><span id="l25.151">                   (this._windowIsClosing = window.closeWindow(true)))</span>
<a href="#l25.152"></a><span id="l25.152">                 return null;</span>
<a href="#l25.153"></a><span id="l25.153">             }</span>
<a href="#l25.154"></a><span id="l25.154">             if (l == 2) {</span>
<a href="#l25.155"></a><span id="l25.155" class="difflineminus">-              let autohide = this.mPrefs.getBoolPref(&quot;browser.tabs.autoHide&quot;);</span>
<a href="#l25.156"></a><span id="l25.156" class="difflineplus">+              let autohide = Services.prefs.getBoolPref(&quot;browser.tabs.autoHide&quot;);</span>
<a href="#l25.157"></a><span id="l25.157">               let tabStripHide = !window.toolbar.visible;</span>
<a href="#l25.158"></a><span id="l25.158">               if (autohide || tabStripHide)</span>
<a href="#l25.159"></a><span id="l25.159">                 this.setStripVisibilityTo(false);</span>
<a href="#l25.160"></a><span id="l25.160">             }</span>
<a href="#l25.161"></a><span id="l25.161"> </span>
<a href="#l25.162"></a><span id="l25.162">             this._removingTabs.push(aTab);</span>
<a href="#l25.163"></a><span id="l25.163"> </span>
<a href="#l25.164"></a><span id="l25.164">             // We're committed to closing the tab now.</span>
<a href="#l25.165"></a><span id="l25.165" class="difflineat">@@ -1066,23 +1060,21 @@</span>
<a href="#l25.166"></a><span id="l25.166">             if (this.mTabs.length == 1)</span>
<a href="#l25.167"></a><span id="l25.167">               return;</span>
<a href="#l25.168"></a><span id="l25.168"> </span>
<a href="#l25.169"></a><span id="l25.169">             var sa = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l25.170"></a><span id="l25.170">                                .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l25.171"></a><span id="l25.171">             aTabs.forEach(function(aTab) { sa.AppendElement(aTab); });</span>
<a href="#l25.172"></a><span id="l25.172"> </span>
<a href="#l25.173"></a><span id="l25.173">             // tell a new window to take the &quot;dropped&quot; tab</span>
<a href="#l25.174"></a><span id="l25.174" class="difflineminus">-            var ww = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;].</span>
<a href="#l25.175"></a><span id="l25.175" class="difflineminus">-                      getService(Ci.nsIWindowWatcher);</span>
<a href="#l25.176"></a><span id="l25.176" class="difflineminus">-            return ww.openWindow(window,</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineminus">-                                 getConvWindowURL(),</span>
<a href="#l25.178"></a><span id="l25.178" class="difflineminus">-                                 null,</span>
<a href="#l25.179"></a><span id="l25.179" class="difflineminus">-                                 &quot;chrome,dialog=no,all&quot;,</span>
<a href="#l25.180"></a><span id="l25.180" class="difflineminus">-                                 sa);</span>
<a href="#l25.181"></a><span id="l25.181" class="difflineplus">+            return Services.ww.openWindow(window,</span>
<a href="#l25.182"></a><span id="l25.182" class="difflineplus">+                                          getConvWindowURL(),</span>
<a href="#l25.183"></a><span id="l25.183" class="difflineplus">+                                          null,</span>
<a href="#l25.184"></a><span id="l25.184" class="difflineplus">+                                          &quot;chrome,dialog=no,all&quot;,</span>
<a href="#l25.185"></a><span id="l25.185" class="difflineplus">+                                          sa);</span>
<a href="#l25.186"></a><span id="l25.186">           ]]&gt;</span>
<a href="#l25.187"></a><span id="l25.187">         &lt;/body&gt;</span>
<a href="#l25.188"></a><span id="l25.188">       &lt;/method&gt;</span>
<a href="#l25.189"></a><span id="l25.189"> </span>
<a href="#l25.190"></a><span id="l25.190">       &lt;method name=&quot;_onDragLeave&quot;&gt;</span>
<a href="#l25.191"></a><span id="l25.191">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l25.192"></a><span id="l25.192">         &lt;body&gt;</span>
<a href="#l25.193"></a><span id="l25.193">           &lt;![CDATA[</span>
<a href="#l25.194"></a><span id="l25.194" class="difflineat">@@ -1342,26 +1334,26 @@</span>
<a href="#l25.195"></a><span id="l25.195">           this.mTabContainer.childNodes[0].linkedConversation = this.mPanelContainer.childNodes[0];</span>
<a href="#l25.196"></a><span id="l25.196">           this.mTabContainer.childNodes[0].linkedBrowser = this.mPanelContainer.childNodes[0].browser;</span>
<a href="#l25.197"></a><span id="l25.197"> </span>
<a href="#l25.198"></a><span id="l25.198">           // set up the shared autoscroll popup</span>
<a href="#l25.199"></a><span id="l25.199">           this._autoScrollPopup = this.mCurrentBrowser._createAutoScrollPopup();</span>
<a href="#l25.200"></a><span id="l25.200">           this._autoScrollPopup.id = &quot;autoscroller&quot;;</span>
<a href="#l25.201"></a><span id="l25.201">           this.appendChild(this._autoScrollPopup);</span>
<a href="#l25.202"></a><span id="l25.202">           this.mCurrentBrowser.setAttribute(&quot;autoscrollpopup&quot;, this._autoScrollPopup.id);</span>
<a href="#l25.203"></a><span id="l25.203" class="difflineminus">-          this.mPrefs.addObserver(&quot;browser.tabs.autoHide&quot;, this._prefObserver, false);</span>
<a href="#l25.204"></a><span id="l25.204" class="difflineminus">-          this.mPrefs.addObserver(&quot;messenger.conversations.useSeparateWindowsForMUCs&quot;, this._prefObserver, false);</span>
<a href="#l25.205"></a><span id="l25.205" class="difflineplus">+          Services.prefs.addObserver(&quot;browser.tabs.autoHide&quot;, this._prefObserver, false);</span>
<a href="#l25.206"></a><span id="l25.206" class="difflineplus">+          Services.prefs.addObserver(&quot;messenger.conversations.useSeparateWindowsForMUCs&quot;, this._prefObserver, false);</span>
<a href="#l25.207"></a><span id="l25.207">         ]]&gt;</span>
<a href="#l25.208"></a><span id="l25.208">       &lt;/constructor&gt;</span>
<a href="#l25.209"></a><span id="l25.209"> </span>
<a href="#l25.210"></a><span id="l25.210">       &lt;destructor&gt;</span>
<a href="#l25.211"></a><span id="l25.211">         &lt;![CDATA[</span>
<a href="#l25.212"></a><span id="l25.212">           document.removeEventListener(&quot;keypress&quot;, this._keyEventHandler, false);</span>
<a href="#l25.213"></a><span id="l25.213" class="difflineminus">-          this.mPrefs.removeObserver(&quot;browser.tabs.autoHide&quot;, this._prefObserver);</span>
<a href="#l25.214"></a><span id="l25.214" class="difflineminus">-          this.mPrefs.removeObserver(&quot;messenger.conversations.useSeparateWindowsForMUCs&quot;, this._prefObserver);</span>
<a href="#l25.215"></a><span id="l25.215" class="difflineplus">+          Services.prefs.removeObserver(&quot;browser.tabs.autoHide&quot;, this._prefObserver);</span>
<a href="#l25.216"></a><span id="l25.216" class="difflineplus">+          Services.prefs.removeObserver(&quot;messenger.conversations.useSeparateWindowsForMUCs&quot;, this._prefObserver);</span>
<a href="#l25.217"></a><span id="l25.217">         ]]&gt;</span>
<a href="#l25.218"></a><span id="l25.218">       &lt;/destructor&gt;</span>
<a href="#l25.219"></a><span id="l25.219">     &lt;/implementation&gt;</span>
<a href="#l25.220"></a><span id="l25.220">   &lt;/binding&gt;</span>
<a href="#l25.221"></a><span id="l25.221"> </span>
<a href="#l25.222"></a><span id="l25.222">   &lt;binding id=&quot;tabbrowser-arrowscrollbox&quot; extends=&quot;chrome://global/content/bindings/scrollbox.xml#arrowscrollbox-clicktoscroll&quot;&gt;</span>
<a href="#l25.223"></a><span id="l25.223">     &lt;implementation&gt;</span>
<a href="#l25.224"></a><span id="l25.224">       &lt;!-- Override scrollbox.xml method, since our scrollbox's children are</span>
<a href="#l25.225"></a><span id="l25.225" class="difflineat">@@ -1504,20 +1496,17 @@</span>
<a href="#l25.226"></a><span id="l25.226">           &lt;/xul:hbox&gt;</span>
<a href="#l25.227"></a><span id="l25.227"> #endif</span>
<a href="#l25.228"></a><span id="l25.228">         &lt;/xul:hbox&gt;</span>
<a href="#l25.229"></a><span id="l25.229">       &lt;/xul:stack&gt;</span>
<a href="#l25.230"></a><span id="l25.230">     &lt;/content&gt;</span>
<a href="#l25.231"></a><span id="l25.231">     &lt;implementation implements=&quot;nsITimerCallback, nsIDOMEventListener&quot;&gt;</span>
<a href="#l25.232"></a><span id="l25.232">       &lt;constructor&gt;</span>
<a href="#l25.233"></a><span id="l25.233">         &lt;![CDATA[</span>
<a href="#l25.234"></a><span id="l25.234" class="difflineminus">-          var pb2 =</span>
<a href="#l25.235"></a><span id="l25.235" class="difflineminus">-              Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l25.236"></a><span id="l25.236" class="difflineminus">-              getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l25.237"></a><span id="l25.237" class="difflineminus">-</span>
<a href="#l25.238"></a><span id="l25.238" class="difflineplus">+          var pb2 = Services.prefs;</span>
<a href="#l25.239"></a><span id="l25.239">           let tab = this.firstChild;</span>
<a href="#l25.240"></a><span id="l25.240">           try {</span>
<a href="#l25.241"></a><span id="l25.241">             this.mTabMinWidth = pb2.getIntPref(&quot;browser.tabs.tabMinWidth&quot;);</span>
<a href="#l25.242"></a><span id="l25.242">             tab.minWidth = this.mTabMinWidth;</span>
<a href="#l25.243"></a><span id="l25.243">           } catch (e) {</span>
<a href="#l25.244"></a><span id="l25.244">           }</span>
<a href="#l25.245"></a><span id="l25.245">           try {</span>
<a href="#l25.246"></a><span id="l25.246">             this.mTabMaxWidth = pb2.getIntPref(&quot;browser.tabs.tabMaxWidth&quot;);</span>
<a href="#l25.247"></a><span id="l25.247" class="difflineat">@@ -1537,20 +1526,18 @@</span>
<a href="#l25.248"></a><span id="l25.248">                           this._prefObserver, false);</span>
<a href="#l25.249"></a><span id="l25.249"> </span>
<a href="#l25.250"></a><span id="l25.250">           window.addEventListener(&quot;resize&quot;, this, false);</span>
<a href="#l25.251"></a><span id="l25.251">         ]]&gt;</span>
<a href="#l25.252"></a><span id="l25.252">       &lt;/constructor&gt;</span>
<a href="#l25.253"></a><span id="l25.253"> </span>
<a href="#l25.254"></a><span id="l25.254">       &lt;destructor&gt;</span>
<a href="#l25.255"></a><span id="l25.255">         &lt;![CDATA[</span>
<a href="#l25.256"></a><span id="l25.256" class="difflineminus">-          var pb2 =</span>
<a href="#l25.257"></a><span id="l25.257" class="difflineminus">-              Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l25.258"></a><span id="l25.258" class="difflineminus">-              getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l25.259"></a><span id="l25.259" class="difflineminus">-          pb2.removeObserver(&quot;browser.tabs.closeButtons&quot;, this._prefObserver);</span>
<a href="#l25.260"></a><span id="l25.260" class="difflineplus">+          Services.prefs.removeObserver(&quot;browser.tabs.closeButtons&quot;,</span>
<a href="#l25.261"></a><span id="l25.261" class="difflineplus">+                                        this._prefObserver);</span>
<a href="#l25.262"></a><span id="l25.262"> </span>
<a href="#l25.263"></a><span id="l25.263">           // Release timer to avoid reference cycles.</span>
<a href="#l25.264"></a><span id="l25.264">           if (this._animateTimer) {</span>
<a href="#l25.265"></a><span id="l25.265">             this._animateTimer.cancel();</span>
<a href="#l25.266"></a><span id="l25.266">             this._animateTimer = null;</span>
<a href="#l25.267"></a><span id="l25.267">           }</span>
<a href="#l25.268"></a><span id="l25.268">         ]]&gt;</span>
<a href="#l25.269"></a><span id="l25.269">       &lt;/destructor&gt;</span>
<a href="#l25.270"></a><span id="l25.270" class="difflineat">@@ -1681,30 +1668,16 @@</span>
<a href="#l25.271"></a><span id="l25.271">           case 3:</span>
<a href="#l25.272"></a><span id="l25.272">             this.setAttribute(&quot;closebuttons&quot;, &quot;noclose&quot;);</span>
<a href="#l25.273"></a><span id="l25.273">             break;</span>
<a href="#l25.274"></a><span id="l25.274">           }</span>
<a href="#l25.275"></a><span id="l25.275">           this.mTabstripClosebutton.collapsed = this.mCloseButtons != 3;</span>
<a href="#l25.276"></a><span id="l25.276">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.277"></a><span id="l25.277">       &lt;/method&gt;</span>
<a href="#l25.278"></a><span id="l25.278"> </span>
<a href="#l25.279"></a><span id="l25.279" class="difflineminus">-      &lt;field name=&quot;_mPrefs&quot;&gt;null&lt;/field&gt;</span>
<a href="#l25.280"></a><span id="l25.280" class="difflineminus">-      &lt;property name=&quot;mPrefs&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l25.281"></a><span id="l25.281" class="difflineminus">-        &lt;getter&gt;</span>
<a href="#l25.282"></a><span id="l25.282" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l25.283"></a><span id="l25.283" class="difflineminus">-          if (!this._mPrefs) {</span>
<a href="#l25.284"></a><span id="l25.284" class="difflineminus">-            this._mPrefs =</span>
<a href="#l25.285"></a><span id="l25.285" class="difflineminus">-              Components.classes['@mozilla.org/preferences-service;1'].</span>
<a href="#l25.286"></a><span id="l25.286" class="difflineminus">-              getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l25.287"></a><span id="l25.287" class="difflineminus">-          }</span>
<a href="#l25.288"></a><span id="l25.288" class="difflineminus">-          return this._mPrefs;</span>
<a href="#l25.289"></a><span id="l25.289" class="difflineminus">-        ]]&gt;</span>
<a href="#l25.290"></a><span id="l25.290" class="difflineminus">-        &lt;/getter&gt;</span>
<a href="#l25.291"></a><span id="l25.291" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l25.292"></a><span id="l25.292" class="difflineminus">-</span>
<a href="#l25.293"></a><span id="l25.293">       &lt;method name=&quot;_handleTabSelect&quot;&gt;</span>
<a href="#l25.294"></a><span id="l25.294">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.295"></a><span id="l25.295">           this.mTabstrip.ensureElementIsVisible(this.selectedItem);</span>
<a href="#l25.296"></a><span id="l25.296">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.297"></a><span id="l25.297">       &lt;/method&gt;</span>
<a href="#l25.298"></a><span id="l25.298"> </span>
<a href="#l25.299"></a><span id="l25.299">       &lt;method name=&quot;_fillTrailingGap&quot;&gt;</span>
<a href="#l25.300"></a><span id="l25.300">         &lt;body&gt;&lt;![CDATA[</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/im/content/utilities.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/im/content/utilities.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -32,60 +32,29 @@</span>
<a href="#l26.4"></a><span id="l26.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l26.5"></a><span id="l26.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l26.6"></a><span id="l26.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l26.7"></a><span id="l26.7">  *</span>
<a href="#l26.8"></a><span id="l26.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l26.9"></a><span id="l26.9"> </span>
<a href="#l26.10"></a><span id="l26.10"> const Cc = Components.classes;</span>
<a href="#l26.11"></a><span id="l26.11"> const Ci = Components.interfaces;</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l26.13"></a><span id="l26.13"> </span>
<a href="#l26.14"></a><span id="l26.14"> function getIter(aEnumerator)</span>
<a href="#l26.15"></a><span id="l26.15"> {</span>
<a href="#l26.16"></a><span id="l26.16">   while (aEnumerator.hasMoreElements())</span>
<a href="#l26.17"></a><span id="l26.17">     yield aEnumerator.getNext();</span>
<a href="#l26.18"></a><span id="l26.18"> }</span>
<a href="#l26.19"></a><span id="l26.19"> </span>
<a href="#l26.20"></a><span id="l26.20" class="difflineminus">-__defineGetter__(&quot;gPrefService&quot;, function() {</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-  delete this.gPrefService;</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-  return this.gPrefService = Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-                             getService(Ci.nsIPrefBranch2);</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-});</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineminus">-</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineminus">-__defineGetter__(&quot;gExtProtoService&quot;, function() {</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineminus">-  delete this.gExtProtoService;</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineminus">-  return this.gExtProtoService =</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineminus">-    Cc[&quot;@mozilla.org/uriloader/external-protocol-service;1&quot;].</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineminus">-    getService(Ci.nsIExternalProtocolService);</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-});</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-function getObserverService()</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-{</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-  return Cc[&quot;@mozilla.org/observer-service;1&quot;].getService(Ci.nsIObserverService);</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-}</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-</span>
<a href="#l26.38"></a><span id="l26.38"> function addObservers(aObserver, aTopics)</span>
<a href="#l26.39"></a><span id="l26.39"> {</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineminus">-  var observerService = getObserverService();</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineplus">+  let observerService = Services.obs;</span>
<a href="#l26.42"></a><span id="l26.42">   for (let i = 0; i &lt; aTopics.length; ++i)</span>
<a href="#l26.43"></a><span id="l26.43">     observerService.addObserver(aObserver, aTopics[i], false);</span>
<a href="#l26.44"></a><span id="l26.44"> }</span>
<a href="#l26.45"></a><span id="l26.45"> </span>
<a href="#l26.46"></a><span id="l26.46"> function removeObservers(aObserver, aTopics)</span>
<a href="#l26.47"></a><span id="l26.47"> {</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineminus">-  var observerService = getObserverService();</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineplus">+  let observerService = Services.obs;</span>
<a href="#l26.50"></a><span id="l26.50">   for (let i = 0; i &lt; aTopics.length; ++i)</span>
<a href="#l26.51"></a><span id="l26.51">     observerService.removeObserver(aObserver, aTopics[i]);</span>
<a href="#l26.52"></a><span id="l26.52"> }</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineminus">-</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-function makeURI(aURL, aOriginCharset, aBaseURI)</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-{</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineminus">-  var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineminus">-                            .getService(Ci.nsIIOService);</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineminus">-  return ioService.newURI(aURL, aOriginCharset, aBaseURI);</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineminus">-}</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineminus">-</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineminus">-function logMsg(aString)</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineminus">-{</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineminus">-  Components.classes[&quot;@mozilla.org/consoleservice;1&quot;]</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineminus">-                     .getService(Ci.nsIConsoleService)</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineminus">-                     .logStringMessage(aString);</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/im/content/viewlog.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/im/content/viewlog.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -75,20 +75,17 @@ var logWindow = {</span>
<a href="#l27.4"></a><span id="l27.4">   onselect: function lw_onselect() {</span>
<a href="#l27.5"></a><span id="l27.5">     let browser = getBrowser();</span>
<a href="#l27.6"></a><span id="l27.6">     browser.documentCharsetInfo.forcedCharset =</span>
<a href="#l27.7"></a><span id="l27.7">       browser.mAtomService.getAtom(&quot;UTF-8&quot;);</span>
<a href="#l27.8"></a><span id="l27.8">     let path = document.getElementById(&quot;logList&quot;).selectedItem.log.path;</span>
<a href="#l27.9"></a><span id="l27.9">     let file = Components.classes[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l27.10"></a><span id="l27.10">                          .createInstance(Components.interfaces.nsILocalFile);</span>
<a href="#l27.11"></a><span id="l27.11">     file.initWithPath(path);</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-    let url = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-                        .getService(Components.interfaces.nsIIOService)</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-                        .newFileURI(file).spec;</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">-    browser.loadURI(url);</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineplus">+    browser.loadURI(Services.io.newFileURI(file).spec);</span>
<a href="#l27.17"></a><span id="l27.17">   },</span>
<a href="#l27.18"></a><span id="l27.18"> </span>
<a href="#l27.19"></a><span id="l27.19">   contentLoaded: function lw_contentLoaded() {</span>
<a href="#l27.20"></a><span id="l27.20">     let doc = getBrowser().contentDocument;</span>
<a href="#l27.21"></a><span id="l27.21"> </span>
<a href="#l27.22"></a><span id="l27.22">     let link = doc.createElement(&quot;link&quot;);</span>
<a href="#l27.23"></a><span id="l27.23">     link.type = &quot;text/css&quot;;</span>
<a href="#l27.24"></a><span id="l27.24">     link.rel = &quot;stylesheet&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/im/modules/Makefile.in</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/im/modules/Makefile.in</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -38,16 +38,17 @@ DEPTH		= ../..</span>
<a href="#l28.4"></a><span id="l28.4"> topsrcdir	= @top_srcdir@</span>
<a href="#l28.5"></a><span id="l28.5"> srcdir		= @srcdir@</span>
<a href="#l28.6"></a><span id="l28.6"> VPATH		= @srcdir@</span>
<a href="#l28.7"></a><span id="l28.7"> </span>
<a href="#l28.8"></a><span id="l28.8"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l28.9"></a><span id="l28.9"> </span>
<a href="#l28.10"></a><span id="l28.10"> EXTRA_JS_MODULES = \</span>
<a href="#l28.11"></a><span id="l28.11"> 	imContentSink.jsm \</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+	imServices.jsm \</span>
<a href="#l28.13"></a><span id="l28.13"> 	imSmileys.jsm \</span>
<a href="#l28.14"></a><span id="l28.14"> 	$(NULL)</span>
<a href="#l28.15"></a><span id="l28.15"> </span>
<a href="#l28.16"></a><span id="l28.16"> EXTRA_PP_JS_MODULES = \</span>
<a href="#l28.17"></a><span id="l28.17"> 	imThemes.jsm \</span>
<a href="#l28.18"></a><span id="l28.18"> 	imTextboxUtils.jsm \</span>
<a href="#l28.19"></a><span id="l28.19"> 	imWindows.jsm \</span>
<a href="#l28.20"></a><span id="l28.20"> 	$(NULL)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/im/modules/imContentSink.jsm</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/im/modules/imContentSink.jsm</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -30,16 +30,18 @@</span>
<a href="#l29.4"></a><span id="l29.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l29.5"></a><span id="l29.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l29.6"></a><span id="l29.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l29.7"></a><span id="l29.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l29.8"></a><span id="l29.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l29.9"></a><span id="l29.9">  *</span>
<a href="#l29.10"></a><span id="l29.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+</span>
<a href="#l29.14"></a><span id="l29.14"> var EXPORTED_SYMBOLS = [</span>
<a href="#l29.15"></a><span id="l29.15">   &quot;cleanupImMarkup&quot;, // used to clean up incoming IMs.</span>
<a href="#l29.16"></a><span id="l29.16">                      // This will use the global ruleset of acceptable stuff</span>
<a href="#l29.17"></a><span id="l29.17">                      // except if another (custom one) is provided</span>
<a href="#l29.18"></a><span id="l29.18">   &quot;createDerivedRuleset&quot;, // used to create a ruleset that inherits from the</span>
<a href="#l29.19"></a><span id="l29.19">                           // default one</span>
<a href="#l29.20"></a><span id="l29.20">                           // useful if you want to allow or forbid</span>
<a href="#l29.21"></a><span id="l29.21">                           // an additionnal thing in a specific</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineat">@@ -183,39 +185,34 @@ const modePref = &quot;messenger.options.filt</span>
<a href="#l29.23"></a><span id="l29.23"> const kModes = [kStrictMode, kStandardMode, kPermissiveMode];</span>
<a href="#l29.24"></a><span id="l29.24"> </span>
<a href="#l29.25"></a><span id="l29.25"> var gGlobalRuleset = null;</span>
<a href="#l29.26"></a><span id="l29.26"> </span>
<a href="#l29.27"></a><span id="l29.27"> function initGlobalRuleset()</span>
<a href="#l29.28"></a><span id="l29.28"> {</span>
<a href="#l29.29"></a><span id="l29.29">   gGlobalRuleset = newRuleset();</span>
<a href="#l29.30"></a><span id="l29.30"> </span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-  Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineminus">-            .getService(Components.interfaces.nsIPrefBranch2)</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineminus">-            .addObserver(modePref, styleObserver, false);</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineplus">+  Services.prefs.addObserver(modePref, styleObserver, false);</span>
<a href="#l29.35"></a><span id="l29.35"> }</span>
<a href="#l29.36"></a><span id="l29.36"> </span>
<a href="#l29.37"></a><span id="l29.37"> var styleObserver = {</span>
<a href="#l29.38"></a><span id="l29.38">   observe: function so_observe(aObject, aTopic, aMsg) {</span>
<a href="#l29.39"></a><span id="l29.39">     if (aTopic != &quot;nsPref:changed&quot; || aMsg != modePref)</span>
<a href="#l29.40"></a><span id="l29.40">       throw &quot;bad notification&quot;;</span>
<a href="#l29.41"></a><span id="l29.41"> </span>
<a href="#l29.42"></a><span id="l29.42">     if (!gGlobalRuleset)</span>
<a href="#l29.43"></a><span id="l29.43">       throw &quot;gGlobalRuleset not initialized&quot;;</span>
<a href="#l29.44"></a><span id="l29.44"> </span>
<a href="#l29.45"></a><span id="l29.45">     setBaseRuleset(getModePref(), gGlobalRuleset);</span>
<a href="#l29.46"></a><span id="l29.46">   }</span>
<a href="#l29.47"></a><span id="l29.47"> };</span>
<a href="#l29.48"></a><span id="l29.48"> </span>
<a href="#l29.49"></a><span id="l29.49"> function getModePref()</span>
<a href="#l29.50"></a><span id="l29.50"> {</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineminus">-  let baseNum =</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineminus">-    Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineminus">-              .getService(Components.interfaces.nsIPrefBranch)</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineminus">-              .getIntPref(modePref);</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineplus">+  let baseNum = Services.prefs.getIntPref(modePref);</span>
<a href="#l29.56"></a><span id="l29.56">   if (baseNum &lt; 0 || baseNum &gt; 2)</span>
<a href="#l29.57"></a><span id="l29.57">     baseNum = 1;</span>
<a href="#l29.58"></a><span id="l29.58"> </span>
<a href="#l29.59"></a><span id="l29.59">   return kModes[baseNum];</span>
<a href="#l29.60"></a><span id="l29.60"> }</span>
<a href="#l29.61"></a><span id="l29.61"> </span>
<a href="#l29.62"></a><span id="l29.62"> function setBaseRuleset(aBase, aResult)</span>
<a href="#l29.63"></a><span id="l29.63"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">new file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineminus">--- /dev/null</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineplus">+++ b/im/modules/imServices.jsm</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineat">@@ -0,0 +1,51 @@</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineplus">+ *</span>
<a href="#l30.8"></a><span id="l30.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l30.9"></a><span id="l30.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+ *</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+ * License.</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+ *</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+ * The Original Code is the Instantbird messenging client, released</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+ * 2010.</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+ *</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+ * Florian QUEZE &lt;florian@instantbird.org&gt;.</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineplus">+ *</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineplus">+ *</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineplus">+ *</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineplus">+</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineplus">+let EXPORTED_SYMBOLS = [&quot;Services&quot;];</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineplus">+</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineplus">+</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(Services, &quot;core&quot;,</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineplus">+                                   &quot;@instantbird.org/purple/core;1&quot;,</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineplus">+                                   &quot;purpleICoreService&quot;);</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(Services, &quot;tags&quot;,</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+                                   &quot;@instantbird.org/purple/tags-service;1&quot;,</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineplus">+                                   &quot;imITagsService&quot;);</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(Services, &quot;logs&quot;,</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineplus">+                                   &quot;@instantbird.org/logger;1&quot;,</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+                                   &quot;ibILogger&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/im/modules/imSmileys.jsm</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/im/modules/imSmileys.jsm</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -30,16 +30,18 @@</span>
<a href="#l31.4"></a><span id="l31.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l31.5"></a><span id="l31.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l31.6"></a><span id="l31.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l31.7"></a><span id="l31.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l31.8"></a><span id="l31.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l31.9"></a><span id="l31.9">  *</span>
<a href="#l31.10"></a><span id="l31.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+</span>
<a href="#l31.14"></a><span id="l31.14"> var EXPORTED_SYMBOLS = [</span>
<a href="#l31.15"></a><span id="l31.15">   &quot;smileImMarkup&quot;, // used to add smile:// img tags into IM markup.</span>
<a href="#l31.16"></a><span id="l31.16">   &quot;smileTextNode&quot;, // used to add smile:// img tags to the content of a textnode</span>
<a href="#l31.17"></a><span id="l31.17">   &quot;smileString&quot;, // used to add smile:// img tags into a string without parsing it as HTML. Be sure the string doesn't contain HTML tags.</span>
<a href="#l31.18"></a><span id="l31.18">   &quot;getSmileRealURI&quot;, // used to retrive the chrome URI for a smile:// URI</span>
<a href="#l31.19"></a><span id="l31.19">   &quot;getSmileyList&quot; // used to display a list of smileys in the UI</span>
<a href="#l31.20"></a><span id="l31.20"> ];</span>
<a href="#l31.21"></a><span id="l31.21"> </span>
<a href="#l31.22"></a><span id="l31.22" class="difflineat">@@ -49,19 +51,17 @@ const themeFile = &quot;theme.js&quot;;</span>
<a href="#l31.23"></a><span id="l31.23"> __defineGetter__(&quot;gTheme&quot;, function() {</span>
<a href="#l31.24"></a><span id="l31.24">   delete this.gTheme;</span>
<a href="#l31.25"></a><span id="l31.25">   gPrefObserver.init();</span>
<a href="#l31.26"></a><span id="l31.26">   return this.gTheme = getTheme();</span>
<a href="#l31.27"></a><span id="l31.27"> });</span>
<a href="#l31.28"></a><span id="l31.28"> </span>
<a href="#l31.29"></a><span id="l31.29"> var gPrefObserver = {</span>
<a href="#l31.30"></a><span id="l31.30">   init: function po_init() {</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineminus">-    Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineminus">-              .getService(Components.interfaces.nsIPrefBranch2)</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-              .addObserver(emoticonsThemePref, gPrefObserver, false);</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineplus">+    Services.prefs.addObserver(emoticonsThemePref, gPrefObserver, false);</span>
<a href="#l31.35"></a><span id="l31.35">   },</span>
<a href="#l31.36"></a><span id="l31.36"> </span>
<a href="#l31.37"></a><span id="l31.37">   observe: function so_observe(aObject, aTopic, aMsg) {</span>
<a href="#l31.38"></a><span id="l31.38">     if (aTopic != &quot;nsPref:changed&quot; || aMsg != emoticonsThemePref)</span>
<a href="#l31.39"></a><span id="l31.39">       throw &quot;bad notification&quot;;</span>
<a href="#l31.40"></a><span id="l31.40"> </span>
<a href="#l31.41"></a><span id="l31.41">     gTheme = getTheme();</span>
<a href="#l31.42"></a><span id="l31.42">   }</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineat">@@ -89,39 +89,34 @@ function getSmileyList(aThemeName)</span>
<a href="#l31.44"></a><span id="l31.44">             src: theme.baseUri + aSmiley.filename,</span>
<a href="#l31.45"></a><span id="l31.45">             textCodes: aSmiley.textCodes};</span>
<a href="#l31.46"></a><span id="l31.46">   };</span>
<a href="#l31.47"></a><span id="l31.47">   return theme.json.smileys.map(addAbsoluteUrls);</span>
<a href="#l31.48"></a><span id="l31.48"> }</span>
<a href="#l31.49"></a><span id="l31.49"> </span>
<a href="#l31.50"></a><span id="l31.50"> function getTheme(aName)</span>
<a href="#l31.51"></a><span id="l31.51"> {</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineminus">-  let name = aName ||</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineminus">-    Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineminus">-              .getService(Components.interfaces.nsIPrefBranch)</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineminus">-              .getCharPref(emoticonsThemePref);</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineplus">+  let name = aName || Services.prefs.getCharPref(emoticonsThemePref);</span>
<a href="#l31.57"></a><span id="l31.57"> </span>
<a href="#l31.58"></a><span id="l31.58">   let theme = {</span>
<a href="#l31.59"></a><span id="l31.59">     name: name,</span>
<a href="#l31.60"></a><span id="l31.60">     iconsHash: null,</span>
<a href="#l31.61"></a><span id="l31.61">     json: null,</span>
<a href="#l31.62"></a><span id="l31.62">     regExp: null</span>
<a href="#l31.63"></a><span id="l31.63">   };</span>
<a href="#l31.64"></a><span id="l31.64"> </span>
<a href="#l31.65"></a><span id="l31.65">   if (name == &quot;none&quot;)</span>
<a href="#l31.66"></a><span id="l31.66">     return theme;</span>
<a href="#l31.67"></a><span id="l31.67"> </span>
<a href="#l31.68"></a><span id="l31.68">   if (name == &quot;default&quot;)</span>
<a href="#l31.69"></a><span id="l31.69">     theme.baseUri = &quot;chrome://instantbird-emoticons/skin/&quot;;</span>
<a href="#l31.70"></a><span id="l31.70">   else</span>
<a href="#l31.71"></a><span id="l31.71">     theme.baseUri = &quot;chrome://&quot; + theme.name + &quot;/skin/&quot;;</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineminus">-  let ios = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineminus">-                      .getService(Components.interfaces.nsIIOService);</span>
<a href="#l31.74"></a><span id="l31.74">   try {</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineminus">-    let channel = ios.newChannel(theme.baseUri + themeFile, null, null);</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineplus">+    let channel = Services.io.newChannel(theme.baseUri + themeFile, null, null);</span>
<a href="#l31.77"></a><span id="l31.77">     let stream = channel.open();</span>
<a href="#l31.78"></a><span id="l31.78">     let json = Components.classes[&quot;@mozilla.org/dom/json;1&quot;]</span>
<a href="#l31.79"></a><span id="l31.79">                          .createInstance(Components.interfaces.nsIJSON);</span>
<a href="#l31.80"></a><span id="l31.80">     theme.json = json.decodeFromStream(stream, stream.available());</span>
<a href="#l31.81"></a><span id="l31.81">     stream.close();</span>
<a href="#l31.82"></a><span id="l31.82">     theme.iconsHash = {};</span>
<a href="#l31.83"></a><span id="l31.83">     for each (smiley in theme.json.smileys) {</span>
<a href="#l31.84"></a><span id="l31.84">       for each (textCode in smiley.textCodes)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/im/modules/imTextboxUtils.jsm</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/im/modules/imTextboxUtils.jsm</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -32,66 +32,61 @@</span>
<a href="#l32.4"></a><span id="l32.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l32.5"></a><span id="l32.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l32.6"></a><span id="l32.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l32.7"></a><span id="l32.7">  *</span>
<a href="#l32.8"></a><span id="l32.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l32.9"></a><span id="l32.9"> </span>
<a href="#l32.10"></a><span id="l32.10"> var EXPORTED_SYMBOLS = [&quot;MessageFormat&quot;, &quot;TextboxSize&quot;, &quot;TextboxSpellChecker&quot;];</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-const Cc = Components.classes;</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+Components.utils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l32.16"></a><span id="l32.16"> const Ci = Components.interfaces;</span>
<a href="#l32.17"></a><span id="l32.17"> </span>
<a href="#l32.18"></a><span id="l32.18" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;prefs&quot;, function() {</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineminus">-  return Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineminus">-           .getService(Ci.nsIPrefService)</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineminus">-           .QueryInterface(Ci.nsIPrefBranch2);</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineminus">-});</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineminus">-</span>
<a href="#l32.24"></a><span id="l32.24"> let MessageFormat = {</span>
<a href="#l32.25"></a><span id="l32.25">   _observedPrefs: [],</span>
<a href="#l32.26"></a><span id="l32.26"> </span>
<a href="#l32.27"></a><span id="l32.27">   getValues: function mf_getValues() {</span>
<a href="#l32.28"></a><span id="l32.28">     this.unregisterObservers();</span>
<a href="#l32.29"></a><span id="l32.29">     let langGroup =</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineminus">-      prefs.getComplexValue(&quot;font.language.group&quot;,</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-                            Components.interfaces.nsIPrefLocalizedString).data;</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineminus">-    let fontGroup = prefs.getCharPref(&quot;font.default.&quot; + langGroup);</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineplus">+      Services.prefs.getComplexValue(&quot;font.language.group&quot;,</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+                                     Ci.nsIPrefLocalizedString).data;</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineplus">+    let fontGroup = Services.prefs.getCharPref(&quot;font.default.&quot; + langGroup);</span>
<a href="#l32.36"></a><span id="l32.36">     let fontPref = &quot;font.name.&quot; + fontGroup + &quot;.&quot; + langGroup;</span>
<a href="#l32.37"></a><span id="l32.37">     let fontSizePref = &quot;font.size.variable.&quot; + langGroup;</span>
<a href="#l32.38"></a><span id="l32.38">     this._values = {</span>
<a href="#l32.39"></a><span id="l32.39">       langGroup: langGroup,</span>
<a href="#l32.40"></a><span id="l32.40">       fontGroup: fontGroup,</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineminus">-      font: prefs.getCharPref(fontPref),</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineminus">-      fontIsDefault: !prefs.prefHasUserValue(fontPref),</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineminus">-      fontSize: prefs.getIntPref(fontSizePref),</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineminus">-      fontSizeIsDefault: !prefs.prefHasUserValue(fontSizePref),</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineminus">-      defaultFontSize: prefs.getDefaultBranch(null).getIntPref(fontSizePref),</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineminus">-      foregroundColor: prefs.getCharPref(&quot;browser.display.foreground_color&quot;),</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineplus">+      font: Services.prefs.getCharPref(fontPref),</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineplus">+      fontIsDefault: !Services.prefs.prefHasUserValue(fontPref),</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineplus">+      fontSize: Services.prefs.getIntPref(fontSizePref),</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+      fontSizeIsDefault: !Services.prefs.prefHasUserValue(fontSizePref),</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+      defaultFontSize:</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineplus">+        Services.prefs.getDefaultBranch(null).getIntPref(fontSizePref),</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineplus">+      foregroundColor:</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineplus">+        Services.prefs.getCharPref(&quot;browser.display.foreground_color&quot;),</span>
<a href="#l32.55"></a><span id="l32.55">       foregroundColorIsDefault:</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineminus">-        !prefs.prefHasUserValue(&quot;browser.display.foreground_color&quot;),</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineminus">-      useSystemColor: prefs.getBoolPref(&quot;browser.display.use_system_colors&quot;)</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineplus">+        !Services.prefs.prefHasUserValue(&quot;browser.display.foreground_color&quot;),</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineplus">+      useSystemColor:</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineplus">+        Services.prefs.getBoolPref(&quot;browser.display.use_system_colors&quot;)</span>
<a href="#l32.61"></a><span id="l32.61">     };</span>
<a href="#l32.62"></a><span id="l32.62"> </span>
<a href="#l32.63"></a><span id="l32.63">     this._observedPrefs = [</span>
<a href="#l32.64"></a><span id="l32.64">       &quot;font.language.group&quot;,</span>
<a href="#l32.65"></a><span id="l32.65">       &quot;font.default.&quot; + langGroup,</span>
<a href="#l32.66"></a><span id="l32.66">       &quot;font.name.&quot; + fontGroup + &quot;.&quot; + langGroup,</span>
<a href="#l32.67"></a><span id="l32.67">       &quot;font.size.variable.&quot; + langGroup,</span>
<a href="#l32.68"></a><span id="l32.68">       &quot;browser.display.foreground_color&quot;,</span>
<a href="#l32.69"></a><span id="l32.69">       &quot;browser.display.use_system_colors&quot;</span>
<a href="#l32.70"></a><span id="l32.70">     ];</span>
<a href="#l32.71"></a><span id="l32.71">     for each (let name in this._observedPrefs)</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineminus">-      prefs.addObserver(name, this, false);</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineplus">+      Services.prefs.addObserver(name, this, false);</span>
<a href="#l32.74"></a><span id="l32.74">   },</span>
<a href="#l32.75"></a><span id="l32.75">   unregisterObservers: function mf_unregisterObservers() {</span>
<a href="#l32.76"></a><span id="l32.76">     for each (let name in this._observedPrefs)</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineminus">-      prefs.removeObserver(name, this);</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineplus">+      Services.prefs.removeObserver(name, this);</span>
<a href="#l32.79"></a><span id="l32.79">     this._observedPrefs = [];</span>
<a href="#l32.80"></a><span id="l32.80">   },</span>
<a href="#l32.81"></a><span id="l32.81">   observe: function(aSubject, aTopic, aMsg) {</span>
<a href="#l32.82"></a><span id="l32.82">     this.getValues();</span>
<a href="#l32.83"></a><span id="l32.83">     for each (let textbox in this._textboxes)</span>
<a href="#l32.84"></a><span id="l32.84">       this.styleTextbox(textbox);</span>
<a href="#l32.85"></a><span id="l32.85">   },</span>
<a href="#l32.86"></a><span id="l32.86">   _getColor: function mf__getColor() {</span>
<a href="#l32.87"></a><span id="l32.87" class="difflineat">@@ -140,57 +135,57 @@ let MessageFormat = {</span>
<a href="#l32.88"></a><span id="l32.88">       this.unregisterObservers();</span>
<a href="#l32.89"></a><span id="l32.89">   }</span>
<a href="#l32.90"></a><span id="l32.90"> };</span>
<a href="#l32.91"></a><span id="l32.91"> </span>
<a href="#l32.92"></a><span id="l32.92"> let TextboxSize = {</span>
<a href="#l32.93"></a><span id="l32.93">   _textboxAutoResizePrefName: &quot;messenger.conversations.textbox.autoResize&quot;,</span>
<a href="#l32.94"></a><span id="l32.94">   get autoResize() {</span>
<a href="#l32.95"></a><span id="l32.95">     delete this.autoResize;</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineminus">-    prefs.addObserver(this._textboxAutoResizePrefName, this, false);</span>
<a href="#l32.97"></a><span id="l32.97" class="difflineplus">+    Services.prefs.addObserver(this._textboxAutoResizePrefName, this, false);</span>
<a href="#l32.98"></a><span id="l32.98">     return this.autoResize =</span>
<a href="#l32.99"></a><span id="l32.99" class="difflineminus">-      prefs.getBoolPref(this._textboxAutoResizePrefName);</span>
<a href="#l32.100"></a><span id="l32.100" class="difflineplus">+      Services.prefs.getBoolPref(this._textboxAutoResizePrefName);</span>
<a href="#l32.101"></a><span id="l32.101">   },</span>
<a href="#l32.102"></a><span id="l32.102">   observe: function(aSubject, aTopic, aMsg) {</span>
<a href="#l32.103"></a><span id="l32.103">     if (aTopic == &quot;nsPref:changed&quot; &amp;&amp; aMsg == this._textboxAutoResizePrefName)</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineminus">-      this.autoResize = prefs.getBoolPref(aMsg);</span>
<a href="#l32.105"></a><span id="l32.105" class="difflineplus">+      this.autoResize = Services.prefs.getBoolPref(aMsg);</span>
<a href="#l32.106"></a><span id="l32.106">   }</span>
<a href="#l32.107"></a><span id="l32.107"> };</span>
<a href="#l32.108"></a><span id="l32.108"> </span>
<a href="#l32.109"></a><span id="l32.109"> let TextboxSpellChecker = {</span>
<a href="#l32.110"></a><span id="l32.110">   _spellCheckPrefName: &quot;layout.spellcheckDefault&quot;,</span>
<a href="#l32.111"></a><span id="l32.111">   _enabled: false,</span>
<a href="#l32.112"></a><span id="l32.112">  getValue: function tsc_getValue() {</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineminus">-    this._enabled = !!prefs.getIntPref(this._spellCheckPrefName);</span>
<a href="#l32.114"></a><span id="l32.114" class="difflineplus">+    this._enabled = !!Services.prefs.getIntPref(this._spellCheckPrefName);</span>
<a href="#l32.115"></a><span id="l32.115">   },</span>
<a href="#l32.116"></a><span id="l32.116">   applyValue: function tsc_applyValue(aTextbox) {</span>
<a href="#l32.117"></a><span id="l32.117">     if (this._enabled)</span>
<a href="#l32.118"></a><span id="l32.118">       aTextbox.setAttribute(&quot;spellcheck&quot;, &quot;true&quot;);</span>
<a href="#l32.119"></a><span id="l32.119">     else</span>
<a href="#l32.120"></a><span id="l32.120">       aTextbox.removeAttribute(&quot;spellcheck&quot;);</span>
<a href="#l32.121"></a><span id="l32.121">   },</span>
<a href="#l32.122"></a><span id="l32.122"> </span>
<a href="#l32.123"></a><span id="l32.123">   _textboxes: [],</span>
<a href="#l32.124"></a><span id="l32.124">   registerTextbox: function tsc_registerTextbox(aTextbox) {</span>
<a href="#l32.125"></a><span id="l32.125">     if (this._textboxes.indexOf(aTextbox) == -1)</span>
<a href="#l32.126"></a><span id="l32.126">       this._textboxes.push(aTextbox);</span>
<a href="#l32.127"></a><span id="l32.127"> </span>
<a href="#l32.128"></a><span id="l32.128">     if (this._textboxes.length == 1) {</span>
<a href="#l32.129"></a><span id="l32.129" class="difflineminus">-      prefs.addObserver(this._spellCheckPrefName, this, false);</span>
<a href="#l32.130"></a><span id="l32.130" class="difflineplus">+      Services.prefs.addObserver(this._spellCheckPrefName, this, false);</span>
<a href="#l32.131"></a><span id="l32.131">       this.getValue();</span>
<a href="#l32.132"></a><span id="l32.132">     }</span>
<a href="#l32.133"></a><span id="l32.133"> </span>
<a href="#l32.134"></a><span id="l32.134">     this.applyValue(aTextbox);</span>
<a href="#l32.135"></a><span id="l32.135">   },</span>
<a href="#l32.136"></a><span id="l32.136">   unregisterTextbox: function tsc_unregisterTextbox(aTextbox) {</span>
<a href="#l32.137"></a><span id="l32.137">     let index = this._textboxes.indexOf(aTextbox);</span>
<a href="#l32.138"></a><span id="l32.138">     if (index != -1)</span>
<a href="#l32.139"></a><span id="l32.139">       this._textboxes.splice(index, 1);</span>
<a href="#l32.140"></a><span id="l32.140"> </span>
<a href="#l32.141"></a><span id="l32.141">     if (!this._textboxes.length)</span>
<a href="#l32.142"></a><span id="l32.142" class="difflineminus">-      prefs.removeObserver(this._spellCheckPrefName, this);</span>
<a href="#l32.143"></a><span id="l32.143" class="difflineplus">+      Services.prefs.removeObserver(this._spellCheckPrefName, this);</span>
<a href="#l32.144"></a><span id="l32.144">   },</span>
<a href="#l32.145"></a><span id="l32.145">   observe: function tsc_observe(aSubject, aTopic, aMsg) {</span>
<a href="#l32.146"></a><span id="l32.146">     this.getValue();</span>
<a href="#l32.147"></a><span id="l32.147">     for each (let textbox in this._textboxes)</span>
<a href="#l32.148"></a><span id="l32.148">       this.applyValue(textbox);</span>
<a href="#l32.149"></a><span id="l32.149">   }</span>
<a href="#l32.150"></a><span id="l32.150"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/im/modules/imThemes.jsm</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/im/modules/imThemes.jsm</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -49,45 +49,43 @@ var EXPORTED_SYMBOLS = [</span>
<a href="#l33.4"></a><span id="l33.4">   &quot;getThemeVariants&quot;,</span>
<a href="#l33.5"></a><span id="l33.5">   &quot;isNextMessage&quot;,</span>
<a href="#l33.6"></a><span id="l33.6">   &quot;insertHTMLForMessage&quot;,</span>
<a href="#l33.7"></a><span id="l33.7">   &quot;initHTMLDocument&quot;,</span>
<a href="#l33.8"></a><span id="l33.8">   &quot;getMessagesForRange&quot;,</span>
<a href="#l33.9"></a><span id="l33.9">   &quot;serializeSelection&quot;</span>
<a href="#l33.10"></a><span id="l33.10"> ];</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+</span>
<a href="#l33.15"></a><span id="l33.15"> const messagesStylePrefBranch = &quot;messenger.options.messagesStyle.&quot;;</span>
<a href="#l33.16"></a><span id="l33.16"> const themePref = &quot;theme&quot;;</span>
<a href="#l33.17"></a><span id="l33.17"> const variantPref = &quot;variant&quot;;</span>
<a href="#l33.18"></a><span id="l33.18"> const showHeaderPref = &quot;showHeader&quot;;</span>
<a href="#l33.19"></a><span id="l33.19"> const combineConsecutivePref = &quot;combineConsecutive&quot;;</span>
<a href="#l33.20"></a><span id="l33.20"> const combineConsecutiveIntervalPref = &quot;combineConsecutiveInterval&quot;;</span>
<a href="#l33.21"></a><span id="l33.21"> </span>
<a href="#l33.22"></a><span id="l33.22"> const DEFAULT_THEME = &quot;bubbles&quot;;</span>
<a href="#l33.23"></a><span id="l33.23"> const DEFAULT_THEMES = [&quot;bubbles&quot;, &quot;dark&quot;, &quot;papersheets&quot;, &quot;simple&quot;];</span>
<a href="#l33.24"></a><span id="l33.24"> </span>
<a href="#l33.25"></a><span id="l33.25"> __defineGetter__(&quot;gPrefBranch&quot;, function() {</span>
<a href="#l33.26"></a><span id="l33.26">   delete this.gPrefBranch;</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineminus">-  return this.gPrefBranch = </span>
<a href="#l33.28"></a><span id="l33.28" class="difflineminus">-    Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineminus">-              .getService(Components.interfaces.nsIPrefService)</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineminus">-              .getBranch(messagesStylePrefBranch);</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+  return this.gPrefBranch = Services.prefs.getBranch(messagesStylePrefBranch);</span>
<a href="#l33.32"></a><span id="l33.32"> });</span>
<a href="#l33.33"></a><span id="l33.33"> </span>
<a href="#l33.34"></a><span id="l33.34"> var gCurrentTheme = null;</span>
<a href="#l33.35"></a><span id="l33.35"> </span>
<a href="#l33.36"></a><span id="l33.36"> function getChromeFile(aURI)</span>
<a href="#l33.37"></a><span id="l33.37"> {</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineminus">-  let ios = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineminus">-                      .getService(Components.interfaces.nsIIOService);</span>
<a href="#l33.40"></a><span id="l33.40">   try {</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineminus">-    let channel = ios.newChannel(aURI, null, null);</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+    let channel = Services.io.newChannel(aURI, null, null);</span>
<a href="#l33.43"></a><span id="l33.43">     let stream = channel.open();</span>
<a href="#l33.44"></a><span id="l33.44">     let sstream = Components.classes[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineminus">-                            .createInstance(Components.interfaces.nsIScriptableInputStream);</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineplus">+                            .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l33.47"></a><span id="l33.47">     sstream.init(stream);</span>
<a href="#l33.48"></a><span id="l33.48">     let text = sstream.read(sstream.available());</span>
<a href="#l33.49"></a><span id="l33.49">     sstream.close();</span>
<a href="#l33.50"></a><span id="l33.50">     return text;</span>
<a href="#l33.51"></a><span id="l33.51">   } catch (e) {</span>
<a href="#l33.52"></a><span id="l33.52">     if (e.result != Components.results.NS_ERROR_FILE_NOT_FOUND)</span>
<a href="#l33.53"></a><span id="l33.53">       dump(&quot;Getting &quot; + aURI + &quot;: &quot; + e + &quot;\n&quot;);</span>
<a href="#l33.54"></a><span id="l33.54">     return null;</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineat">@@ -159,51 +157,49 @@ function plistToJSON(aElt)</span>
<a href="#l33.56"></a><span id="l33.56"> </span>
<a href="#l33.57"></a><span id="l33.57">     case 'dict':</span>
<a href="#l33.58"></a><span id="l33.58">       let res = {};</span>
<a href="#l33.59"></a><span id="l33.59">       let nodes = aElt.childNodes;</span>
<a href="#l33.60"></a><span id="l33.60">       for (let i = 0; i &lt; nodes.length; ++i) {</span>
<a href="#l33.61"></a><span id="l33.61">         if (nodes[i].nodeName == 'key') {</span>
<a href="#l33.62"></a><span id="l33.62">           let key = nodes[i].textContent;</span>
<a href="#l33.63"></a><span id="l33.63">           ++i;</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineminus">-          while (!(nodes[i] instanceof Components.interfaces.nsIDOMElement))</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+          while (!(nodes[i] instanceof Ci.nsIDOMElement))</span>
<a href="#l33.66"></a><span id="l33.66">             ++i;</span>
<a href="#l33.67"></a><span id="l33.67">           res[key] = plistToJSON(nodes[i]);</span>
<a href="#l33.68"></a><span id="l33.68">         }</span>
<a href="#l33.69"></a><span id="l33.69">       }</span>
<a href="#l33.70"></a><span id="l33.70">       return res;</span>
<a href="#l33.71"></a><span id="l33.71"> </span>
<a href="#l33.72"></a><span id="l33.72">     case 'array':</span>
<a href="#l33.73"></a><span id="l33.73">       let array = [];</span>
<a href="#l33.74"></a><span id="l33.74">       nodes = aElt.childNodes;</span>
<a href="#l33.75"></a><span id="l33.75">       for (let i = 0; i &lt; nodes.length; ++i) {</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineminus">-        if (nodes[i] instanceof Components.interfaces.nsIDOMElement)</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineplus">+        if (nodes[i] instanceof Ci.nsIDOMElement)</span>
<a href="#l33.78"></a><span id="l33.78">           array.push(plistToJSON(nodes[i]));</span>
<a href="#l33.79"></a><span id="l33.79">       }</span>
<a href="#l33.80"></a><span id="l33.80">       return array;</span>
<a href="#l33.81"></a><span id="l33.81"> </span>
<a href="#l33.82"></a><span id="l33.82">     default:</span>
<a href="#l33.83"></a><span id="l33.83">       throw &quot;Unknown tag in plist file&quot;;</span>
<a href="#l33.84"></a><span id="l33.84">   }</span>
<a href="#l33.85"></a><span id="l33.85"> }</span>
<a href="#l33.86"></a><span id="l33.86"> </span>
<a href="#l33.87"></a><span id="l33.87"> function getInfoPlistContent(aBaseURI)</span>
<a href="#l33.88"></a><span id="l33.88"> {</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineminus">-  let ios = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineminus">-                      .getService(Components.interfaces.nsIIOService);</span>
<a href="#l33.91"></a><span id="l33.91">   try {</span>
<a href="#l33.92"></a><span id="l33.92" class="difflineminus">-    let channel = ios.newChannel(aBaseURI + &quot;Info.plist&quot;, null, null);</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineplus">+    let channel = Services.io.newChannel(aBaseURI + &quot;Info.plist&quot;, null, null);</span>
<a href="#l33.94"></a><span id="l33.94">     let stream = channel.open();</span>
<a href="#l33.95"></a><span id="l33.95">     let parser = Components.classes[&quot;@mozilla.org/xmlextras/domparser;1&quot;]</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineminus">-                           .createInstance(Components.interfaces.nsIDOMParser);</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineplus">+                           .createInstance(Ci.nsIDOMParser);</span>
<a href="#l33.98"></a><span id="l33.98">     let doc = parser.parseFromStream(stream, null, stream.available(), &quot;text/xml&quot;);</span>
<a href="#l33.99"></a><span id="l33.99">     if (doc.documentElement.localName != &quot;plist&quot;)</span>
<a href="#l33.100"></a><span id="l33.100">       throw &quot;Invalid Info.plist file&quot;;</span>
<a href="#l33.101"></a><span id="l33.101">     let node = doc.documentElement.firstChild;</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineminus">-    while (node &amp;&amp; !(node instanceof Components.interfaces.nsIDOMElement))</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineplus">+    while (node &amp;&amp; !(node instanceof Ci.nsIDOMElement))</span>
<a href="#l33.104"></a><span id="l33.104">       node = node.nextSibling;</span>
<a href="#l33.105"></a><span id="l33.105">     if (!node || node.localName != &quot;dict&quot;)</span>
<a href="#l33.106"></a><span id="l33.106">       throw &quot;Empty or invalid Info.plist file&quot;;</span>
<a href="#l33.107"></a><span id="l33.107">     return plistToJSON(node);</span>
<a href="#l33.108"></a><span id="l33.108">   } catch(e) {</span>
<a href="#l33.109"></a><span id="l33.109">     Components.utils.reportError(e);</span>
<a href="#l33.110"></a><span id="l33.110">     return null;</span>
<a href="#l33.111"></a><span id="l33.111">   }</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineat">@@ -252,72 +248,71 @@ function getCurrentTheme()</span>
<a href="#l33.113"></a><span id="l33.113">     gCurrentTheme.variant = &quot;default&quot;;</span>
<a href="#l33.114"></a><span id="l33.114">   }</span>
<a href="#l33.115"></a><span id="l33.115"> </span>
<a href="#l33.116"></a><span id="l33.116">   return gCurrentTheme;</span>
<a href="#l33.117"></a><span id="l33.117"> }</span>
<a href="#l33.118"></a><span id="l33.118"> </span>
<a href="#l33.119"></a><span id="l33.119"> function getDirectoryEntries(aDir)</span>
<a href="#l33.120"></a><span id="l33.120"> {</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineminus">-  let ios = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l33.122"></a><span id="l33.122" class="difflineminus">-                      .getService(Components.interfaces.nsIIOService);</span>
<a href="#l33.123"></a><span id="l33.123" class="difflineplus">+  let ios = Services.io;</span>
<a href="#l33.124"></a><span id="l33.124">   let uri = ios.newURI(aDir, null, null);</span>
<a href="#l33.125"></a><span id="l33.125">   let cr = Components.classes[&quot;@mozilla.org/chrome/chrome-registry;1&quot;]</span>
<a href="#l33.126"></a><span id="l33.126" class="difflineminus">-                     .getService(Components.interfaces.nsIXULChromeRegistry);</span>
<a href="#l33.127"></a><span id="l33.127" class="difflineplus">+                     .getService(Ci.nsIXULChromeRegistry);</span>
<a href="#l33.128"></a><span id="l33.128">   while (uri.scheme == &quot;chrome&quot;)</span>
<a href="#l33.129"></a><span id="l33.129">     uri = cr.convertChromeURL(uri);</span>
<a href="#l33.130"></a><span id="l33.130"> </span>
<a href="#l33.131"></a><span id="l33.131">   // remove any trailing file name added by convertChromeURL</span>
<a href="#l33.132"></a><span id="l33.132">   let spec = uri.spec.replace(/[^\/]+$/, &quot;&quot;);</span>
<a href="#l33.133"></a><span id="l33.133">   uri = ios.newURI(spec, null, null);</span>
<a href="#l33.134"></a><span id="l33.134"> </span>
<a href="#l33.135"></a><span id="l33.135">   let results = [];</span>
<a href="#l33.136"></a><span id="l33.136">   if (uri.scheme == &quot;jar&quot;) {</span>
<a href="#l33.137"></a><span id="l33.137" class="difflineminus">-    uri.QueryInterface(Components.interfaces.nsIJARURI);</span>
<a href="#l33.138"></a><span id="l33.138" class="difflineplus">+    uri.QueryInterface(Ci.nsIJARURI);</span>
<a href="#l33.139"></a><span id="l33.139">     var strEntry = uri.JAREntry;</span>
<a href="#l33.140"></a><span id="l33.140">     if (!strEntry)</span>
<a href="#l33.141"></a><span id="l33.141">       return [];</span>
<a href="#l33.142"></a><span id="l33.142"> </span>
<a href="#l33.143"></a><span id="l33.143">     let zr = Components.classes[&quot;@mozilla.org/libjar/zip-reader;1&quot;]</span>
<a href="#l33.144"></a><span id="l33.144" class="difflineminus">-                       .createInstance(Components.interfaces.nsIZipReader);</span>
<a href="#l33.145"></a><span id="l33.145" class="difflineplus">+                       .createInstance(Ci.nsIZipReader);</span>
<a href="#l33.146"></a><span id="l33.146">     let jarFile = uri.JARFile;</span>
<a href="#l33.147"></a><span id="l33.147" class="difflineminus">-    if (jarFile instanceof Components.interfaces.nsIJARURI) {</span>
<a href="#l33.148"></a><span id="l33.148" class="difflineplus">+    if (jarFile instanceof Ci.nsIJARURI) {</span>
<a href="#l33.149"></a><span id="l33.149">       let innerZr = Components.classes[&quot;@mozilla.org/libjar/zip-reader;1&quot;]</span>
<a href="#l33.150"></a><span id="l33.150" class="difflineminus">-                              .createInstance(Components.interfaces.nsIZipReader);</span>
<a href="#l33.151"></a><span id="l33.151" class="difflineminus">-      innerZr.open(jarFile.JARFile.QueryInterface(Components.interfaces.nsIFileURL).file);</span>
<a href="#l33.152"></a><span id="l33.152" class="difflineplus">+                              .createInstance(Ci.nsIZipReader);</span>
<a href="#l33.153"></a><span id="l33.153" class="difflineplus">+      innerZr.open(jarFile.JARFile.QueryInterface(Ci.nsIFileURL).file);</span>
<a href="#l33.154"></a><span id="l33.154">       zr.openInner(innerZr, jarFile.JAREntry);</span>
<a href="#l33.155"></a><span id="l33.155">     }</span>
<a href="#l33.156"></a><span id="l33.156">     else</span>
<a href="#l33.157"></a><span id="l33.157" class="difflineminus">-      zr.open(jarFile.QueryInterface(Components.interfaces.nsIFileURL).file);</span>
<a href="#l33.158"></a><span id="l33.158" class="difflineplus">+      zr.open(jarFile.QueryInterface(Ci.nsIFileURL).file);</span>
<a href="#l33.159"></a><span id="l33.159"> </span>
<a href="#l33.160"></a><span id="l33.160">     if (!zr.hasEntry(strEntry) || !zr.getEntry(strEntry).isDirectory) {</span>
<a href="#l33.161"></a><span id="l33.161">       zr.close();</span>
<a href="#l33.162"></a><span id="l33.162">       return [];</span>
<a href="#l33.163"></a><span id="l33.163">     }</span>
<a href="#l33.164"></a><span id="l33.164"> </span>
<a href="#l33.165"></a><span id="l33.165">     var escapedEntry = strEntry.replace(/([*?$[\]^~()\\])/g, &quot;\\$1&quot;);</span>
<a href="#l33.166"></a><span id="l33.166">     var filter = escapedEntry + &quot;?*~&quot; + escapedEntry + &quot;?*/?*&quot;;</span>
<a href="#l33.167"></a><span id="l33.167">     var entries = zr.findEntries(filter);</span>
<a href="#l33.168"></a><span id="l33.168"> </span>
<a href="#l33.169"></a><span id="l33.169">     let parentLength = strEntry.length;</span>
<a href="#l33.170"></a><span id="l33.170">     while (entries.hasMore())</span>
<a href="#l33.171"></a><span id="l33.171">       results.push(entries.getNext().substring(parentLength));</span>
<a href="#l33.172"></a><span id="l33.172">     zr.close();</span>
<a href="#l33.173"></a><span id="l33.173">   }</span>
<a href="#l33.174"></a><span id="l33.174">   else if (uri.scheme == &quot;file&quot;) {</span>
<a href="#l33.175"></a><span id="l33.175" class="difflineminus">-    uri.QueryInterface(Components.interfaces.nsIFileURL);</span>
<a href="#l33.176"></a><span id="l33.176" class="difflineplus">+    uri.QueryInterface(Ci.nsIFileURL);</span>
<a href="#l33.177"></a><span id="l33.177">     var dir = uri.file;</span>
<a href="#l33.178"></a><span id="l33.178"> </span>
<a href="#l33.179"></a><span id="l33.179">     if (!dir.exists() || !dir.isDirectory())</span>
<a href="#l33.180"></a><span id="l33.180">       return [];</span>
<a href="#l33.181"></a><span id="l33.181"> </span>
<a href="#l33.182"></a><span id="l33.182">     let children = dir.directoryEntries;</span>
<a href="#l33.183"></a><span id="l33.183">     while (children.hasMoreElements()) {</span>
<a href="#l33.184"></a><span id="l33.184">       let file = children.getNext()</span>
<a href="#l33.185"></a><span id="l33.185" class="difflineminus">-                         .QueryInterface(Components.interfaces.nsIFile);</span>
<a href="#l33.186"></a><span id="l33.186" class="difflineplus">+                         .QueryInterface(Ci.nsIFile);</span>
<a href="#l33.187"></a><span id="l33.187">       results.push(file.leafName);</span>
<a href="#l33.188"></a><span id="l33.188">     }</span>
<a href="#l33.189"></a><span id="l33.189">   }</span>
<a href="#l33.190"></a><span id="l33.190"> </span>
<a href="#l33.191"></a><span id="l33.191">   return results;</span>
<a href="#l33.192"></a><span id="l33.192"> }</span>
<a href="#l33.193"></a><span id="l33.193"> </span>
<a href="#l33.194"></a><span id="l33.194"> function getThemeVariants(aTheme)</span>
<a href="#l33.195"></a><span id="l33.195" class="difflineat">@@ -373,23 +368,19 @@ const headerFooterReplacements = {</span>
<a href="#l33.196"></a><span id="l33.196">     if (aFormat)</span>
<a href="#l33.197"></a><span id="l33.197">       return (new Date()).toLocaleFormat(aFormat);</span>
<a href="#l33.198"></a><span id="l33.198">     else</span>
<a href="#l33.199"></a><span id="l33.199">       return (new Date()).toLocaleTimeString();</span>
<a href="#l33.200"></a><span id="l33.200">   }</span>
<a href="#l33.201"></a><span id="l33.201"> };</span>
<a href="#l33.202"></a><span id="l33.202"> </span>
<a href="#l33.203"></a><span id="l33.203"> function formatAutoResponce(aTxt)</span>
<a href="#l33.204"></a><span id="l33.204" class="difflineminus">-{</span>
<a href="#l33.205"></a><span id="l33.205" class="difflineminus">-  let bundle =</span>
<a href="#l33.206"></a><span id="l33.206" class="difflineminus">-    Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l33.207"></a><span id="l33.207" class="difflineminus">-              .getService(Components.interfaces.nsIStringBundleService)</span>
<a href="#l33.208"></a><span id="l33.208" class="difflineminus">-              .createBundle(&quot;chrome://instantbird/locale/instantbird.properties&quot;);</span>
<a href="#l33.209"></a><span id="l33.209" class="difflineminus">-  return bundle.formatStringFromName(&quot;autoReply&quot;, [aTxt], 1);</span>
<a href="#l33.210"></a><span id="l33.210" class="difflineminus">-}</span>
<a href="#l33.211"></a><span id="l33.211" class="difflineplus">+  Services.strings</span>
<a href="#l33.212"></a><span id="l33.212" class="difflineplus">+          .createBundle(&quot;chrome://instantbird/locale/instantbird.properties&quot;)</span>
<a href="#l33.213"></a><span id="l33.213" class="difflineplus">+          .formatStringFromName(&quot;autoReply&quot;, [aTxt], 1)</span>
<a href="#l33.214"></a><span id="l33.214"> </span>
<a href="#l33.215"></a><span id="l33.215"> const statusMessageReplacements = {</span>
<a href="#l33.216"></a><span id="l33.216">   message: function(aMsg) &quot;&lt;span class=\&quot;ib-msg-txt\&quot;&gt;&quot; +</span>
<a href="#l33.217"></a><span id="l33.217">                           (aMsg.autoResponse ? formatAutoResponce(aMsg.message) : aMsg.message) +</span>
<a href="#l33.218"></a><span id="l33.218">                           &quot;&lt;/span&gt;&quot;,</span>
<a href="#l33.219"></a><span id="l33.219">   time: function(aMsg, aFormat) {</span>
<a href="#l33.220"></a><span id="l33.220">     let date = new Date(aMsg.time * 1000);</span>
<a href="#l33.221"></a><span id="l33.221">     if (aFormat)</span>
<a href="#l33.222"></a><span id="l33.222" class="difflineat">@@ -554,17 +545,17 @@ function insertHTMLForMessage(aMsg, aHTM</span>
<a href="#l33.223"></a><span id="l33.223">   // store the purpleIMessage object in each of the &quot;root&quot; node that</span>
<a href="#l33.224"></a><span id="l33.224">   // will be inserted into the document, so that selection code can</span>
<a href="#l33.225"></a><span id="l33.225">   // retrieve the message by just looking at the parent node until it</span>
<a href="#l33.226"></a><span id="l33.226">   // finds something.</span>
<a href="#l33.227"></a><span id="l33.227">   for (let root = result; root; root = root.nextSibling)</span>
<a href="#l33.228"></a><span id="l33.228">     root._originalMsg = aMsg;</span>
<a href="#l33.229"></a><span id="l33.229"> </span>
<a href="#l33.230"></a><span id="l33.230">   // make sure the result is an HTMLElement and not some whitespace...</span>
<a href="#l33.231"></a><span id="l33.231" class="difflineminus">-  while (result &amp;&amp; !(result instanceof Components.interfaces.nsIDOMHTMLElement))</span>
<a href="#l33.232"></a><span id="l33.232" class="difflineplus">+  while (result &amp;&amp; !(result instanceof Ci.nsIDOMHTMLElement))</span>
<a href="#l33.233"></a><span id="l33.233">     result = result.nextSibling;</span>
<a href="#l33.234"></a><span id="l33.234">   if (insert)</span>
<a href="#l33.235"></a><span id="l33.235">     parent.replaceChild(documentFragment, insert);</span>
<a href="#l33.236"></a><span id="l33.236">   else</span>
<a href="#l33.237"></a><span id="l33.237">     parent.appendChild(documentFragment);</span>
<a href="#l33.238"></a><span id="l33.238">   return result;</span>
<a href="#l33.239"></a><span id="l33.239"> }</span>
<a href="#l33.240"></a><span id="l33.240"> </span>
<a href="#l33.241"></a><span id="l33.241" class="difflineat">@@ -637,30 +628,29 @@ function initHTMLDocument(aConv, aTheme,</span>
<a href="#l33.242"></a><span id="l33.242"> </span>
<a href="#l33.243"></a><span id="l33.243"> /* Selection stuff */</span>
<a href="#l33.244"></a><span id="l33.244"> function getEllipsis()</span>
<a href="#l33.245"></a><span id="l33.245"> {</span>
<a href="#l33.246"></a><span id="l33.246">   let ellipsis = &quot;[\u2026]&quot;;</span>
<a href="#l33.247"></a><span id="l33.247"> </span>
<a href="#l33.248"></a><span id="l33.248">   try {</span>
<a href="#l33.249"></a><span id="l33.249">     ellipsis =</span>
<a href="#l33.250"></a><span id="l33.250" class="difflineminus">-      Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l33.251"></a><span id="l33.251" class="difflineminus">-                .getService(Components.interfaces.nsIPrefBranch2)</span>
<a href="#l33.252"></a><span id="l33.252" class="difflineminus">-                .getComplexValue(&quot;messenger.conversations.selections.ellipsis&quot;,</span>
<a href="#l33.253"></a><span id="l33.253" class="difflineminus">-                                 Components.interfaces.nsIPrefLocalizedString).data;</span>
<a href="#l33.254"></a><span id="l33.254" class="difflineplus">+      Services.prefs</span>
<a href="#l33.255"></a><span id="l33.255" class="difflineplus">+              .getComplexValue(&quot;messenger.conversations.selections.ellipsis&quot;,</span>
<a href="#l33.256"></a><span id="l33.256" class="difflineplus">+                               Ci.nsIPrefLocalizedString).data;</span>
<a href="#l33.257"></a><span id="l33.257">   } catch (e) { }</span>
<a href="#l33.258"></a><span id="l33.258">   return ellipsis;</span>
<a href="#l33.259"></a><span id="l33.259"> }</span>
<a href="#l33.260"></a><span id="l33.260"> </span>
<a href="#l33.261"></a><span id="l33.261"> function _serializeDOMObject(aDocument, aInitFunction)</span>
<a href="#l33.262"></a><span id="l33.262"> {</span>
<a href="#l33.263"></a><span id="l33.263">   const type = &quot;text/plain&quot;;</span>
<a href="#l33.264"></a><span id="l33.264">   var encoder =</span>
<a href="#l33.265"></a><span id="l33.265">     Components.classes[&quot;@mozilla.org/layout/documentEncoder;1?type=&quot; + type]</span>
<a href="#l33.266"></a><span id="l33.266" class="difflineminus">-              .createInstance(Components.interfaces.nsIDocumentEncoder);</span>
<a href="#l33.267"></a><span id="l33.267" class="difflineplus">+              .createInstance(Ci.nsIDocumentEncoder);</span>
<a href="#l33.268"></a><span id="l33.268">   encoder.init(aDocument, type, 0);</span>
<a href="#l33.269"></a><span id="l33.269">   aInitFunction(encoder);</span>
<a href="#l33.270"></a><span id="l33.270">   let result = encoder.encodeToString();</span>
<a href="#l33.271"></a><span id="l33.271">   return result;</span>
<a href="#l33.272"></a><span id="l33.272"> }</span>
<a href="#l33.273"></a><span id="l33.273"> </span>
<a href="#l33.274"></a><span id="l33.274"> function serializeRange(aRange)</span>
<a href="#l33.275"></a><span id="l33.275"> {</span>
<a href="#l33.276"></a><span id="l33.276" class="difflineat">@@ -774,17 +764,17 @@ SelectedMessage.prototype = {</span>
<a href="#l33.277"></a><span id="l33.277">   // Helper function that returns the first span node of class</span>
<a href="#l33.278"></a><span id="l33.278">   // ib-msg-text under the rootNodes of the selected message.</span>
<a href="#l33.279"></a><span id="l33.279">   _getSpanNode: function() {</span>
<a href="#l33.280"></a><span id="l33.280">     // first use the cached value if any</span>
<a href="#l33.281"></a><span id="l33.281">     if (this._spanNode)</span>
<a href="#l33.282"></a><span id="l33.282">       return this._spanNode;</span>
<a href="#l33.283"></a><span id="l33.283"> </span>
<a href="#l33.284"></a><span id="l33.284">     let spanNode = null;</span>
<a href="#l33.285"></a><span id="l33.285" class="difflineminus">-    const NodeFilter = Components.interfaces.nsIDOMNodeFilter;</span>
<a href="#l33.286"></a><span id="l33.286" class="difflineplus">+    const NodeFilter = Ci.nsIDOMNodeFilter;</span>
<a href="#l33.287"></a><span id="l33.287">     // helper filter function for the tree walker</span>
<a href="#l33.288"></a><span id="l33.288">     let filter = function(node) {</span>
<a href="#l33.289"></a><span id="l33.289">       return node.className == &quot;ib-msg-txt&quot; ? NodeFilter.FILTER_ACCEPT</span>
<a href="#l33.290"></a><span id="l33.290">                                             : NodeFilter.FILTER_SKIP;</span>
<a href="#l33.291"></a><span id="l33.291">     };</span>
<a href="#l33.292"></a><span id="l33.292">     // walk the DOM subtrees of each root, keep the first correct span node</span>
<a href="#l33.293"></a><span id="l33.293">     for (let i = 0; !spanNode &amp;&amp; i &lt; this._rootNodes.length; ++i) {</span>
<a href="#l33.294"></a><span id="l33.294">       let rootNode = this._rootNodes[i];</span>
<a href="#l33.295"></a><span id="l33.295" class="difflineat">@@ -898,22 +888,19 @@ SelectedMessage.prototype = {</span>
<a href="#l33.296"></a><span id="l33.296">       div.innerHTML = msg.autoResponse ? formatAutoResponce(msg.message) : msg.message;</span>
<a href="#l33.297"></a><span id="l33.297">       text = serializeNode(div);</span>
<a href="#l33.298"></a><span id="l33.298">     }</span>
<a href="#l33.299"></a><span id="l33.299"> </span>
<a href="#l33.300"></a><span id="l33.300">     // then get the suitable replacements and templates for this message</span>
<a href="#l33.301"></a><span id="l33.301">     let getLocalizedPrefWithDefault = function (aName, aDefault) {</span>
<a href="#l33.302"></a><span id="l33.302">       try {</span>
<a href="#l33.303"></a><span id="l33.303">         let prefBranch =</span>
<a href="#l33.304"></a><span id="l33.304" class="difflineminus">-          Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l33.305"></a><span id="l33.305" class="difflineminus">-                    .getService(Components.interfaces.nsIPrefService)</span>
<a href="#l33.306"></a><span id="l33.306" class="difflineminus">-                    .getBranch(&quot;messenger.conversations.selections.&quot;);</span>
<a href="#l33.307"></a><span id="l33.307" class="difflineminus">-        const nsIPrefLocalizedString = Components.interfaces.nsIPrefLocalizedString;</span>
<a href="#l33.308"></a><span id="l33.308" class="difflineplus">+          Services.prefs.getBranch(&quot;messenger.conversations.selections.&quot;);</span>
<a href="#l33.309"></a><span id="l33.309">         return prefBranch.getComplexValue(aName,</span>
<a href="#l33.310"></a><span id="l33.310" class="difflineminus">-                                          nsIPrefLocalizedString).data;</span>
<a href="#l33.311"></a><span id="l33.311" class="difflineplus">+                                          Ci.nsIPrefLocalizedString).data;</span>
<a href="#l33.312"></a><span id="l33.312">       } catch(e) {</span>
<a href="#l33.313"></a><span id="l33.313">         return aDefault;</span>
<a href="#l33.314"></a><span id="l33.314">       }</span>
<a href="#l33.315"></a><span id="l33.315">     };</span>
<a href="#l33.316"></a><span id="l33.316">     let html, replacements;</span>
<a href="#l33.317"></a><span id="l33.317">     if (msg.system) {</span>
<a href="#l33.318"></a><span id="l33.318">       replacements = statusReplacements;</span>
<a href="#l33.319"></a><span id="l33.319">       html = getLocalizedPrefWithDefault(&quot;systemMessagesTemplate&quot;,</span>
<a href="#l33.320"></a><span id="l33.320" class="difflineat">@@ -974,27 +961,27 @@ function getMessagesForRange(aRange)</span>
<a href="#l33.321"></a><span id="l33.321">       }</span>
<a href="#l33.322"></a><span id="l33.322">     }</span>
<a href="#l33.323"></a><span id="l33.323"> </span>
<a href="#l33.324"></a><span id="l33.324">     // check if we have reached the end node</span>
<a href="#l33.325"></a><span id="l33.325">     if (aNode == endNode)</span>
<a href="#l33.326"></a><span id="l33.326">       return true;</span>
<a href="#l33.327"></a><span id="l33.327"> </span>
<a href="#l33.328"></a><span id="l33.328">     // recurse through children</span>
<a href="#l33.329"></a><span id="l33.329" class="difflineminus">-    if (aNode instanceof Components.interfaces.nsIDOMHTMLElement) {</span>
<a href="#l33.330"></a><span id="l33.330" class="difflineplus">+    if (aNode instanceof Ci.nsIDOMHTMLElement) {</span>
<a href="#l33.331"></a><span id="l33.331">       for (let i = 0; i &lt; aNode.childNodes.length; ++i)</span>
<a href="#l33.332"></a><span id="l33.332">         if (processSubtree(aNode.childNodes[i]))</span>
<a href="#l33.333"></a><span id="l33.333">           return true;</span>
<a href="#l33.334"></a><span id="l33.334">     }</span>
<a href="#l33.335"></a><span id="l33.335"> </span>
<a href="#l33.336"></a><span id="l33.336">     return false;</span>
<a href="#l33.337"></a><span id="l33.337">   };</span>
<a href="#l33.338"></a><span id="l33.338"> </span>
<a href="#l33.339"></a><span id="l33.339">   let currentNode = aRange.commonAncestorContainer;</span>
<a href="#l33.340"></a><span id="l33.340" class="difflineminus">-  if (currentNode instanceof Components.interfaces.nsIDOMHTMLElement) {</span>
<a href="#l33.341"></a><span id="l33.341" class="difflineplus">+  if (currentNode instanceof Ci.nsIDOMHTMLElement) {</span>
<a href="#l33.342"></a><span id="l33.342">     // Determine the index of the first and last children of currentNode</span>
<a href="#l33.343"></a><span id="l33.343">     // that we should process.</span>
<a href="#l33.344"></a><span id="l33.344">     let found = false;</span>
<a href="#l33.345"></a><span id="l33.345">     let start = 0;</span>
<a href="#l33.346"></a><span id="l33.346">     if (currentNode == startNode) {</span>
<a href="#l33.347"></a><span id="l33.347">       // we want to process all children</span>
<a href="#l33.348"></a><span id="l33.348">       found = true;</span>
<a href="#l33.349"></a><span id="l33.349">       start = aRange.startOffset;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/im/modules/imWindows.jsm</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/im/modules/imWindows.jsm</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -33,37 +33,39 @@</span>
<a href="#l34.4"></a><span id="l34.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l34.5"></a><span id="l34.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l34.6"></a><span id="l34.6">  *</span>
<a href="#l34.7"></a><span id="l34.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l34.8"></a><span id="l34.8"> </span>
<a href="#l34.9"></a><span id="l34.9"> const CONVERSATION_WINDOW_URI = &quot;chrome://instantbird/content/instantbird.xul&quot;;</span>
<a href="#l34.10"></a><span id="l34.10"> var EXPORTED_SYMBOLS = [&quot;Conversations&quot;];</span>
<a href="#l34.11"></a><span id="l34.11"> </span>
<a href="#l34.12"></a><span id="l34.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+</span>
<a href="#l34.14"></a><span id="l34.14"> var Conversations = {</span>
<a href="#l34.15"></a><span id="l34.15"> #ifdef XP_MACOSX</span>
<a href="#l34.16"></a><span id="l34.16">   _badgeTimeout: null,</span>
<a href="#l34.17"></a><span id="l34.17">   _showDockBadgePrefName: &quot;messenger.options.showUnreadCountInDock&quot;,</span>
<a href="#l34.18"></a><span id="l34.18">   get dockBadgeService() {</span>
<a href="#l34.19"></a><span id="l34.19">     let badgeService =</span>
<a href="#l34.20"></a><span id="l34.20">       Components.classes[&quot;@instantbird.org/purple/nsdockbadgeservice;1&quot;]</span>
<a href="#l34.21"></a><span id="l34.21">                 .getService(Components.interfaces.nsIDockBadgeService);</span>
<a href="#l34.22"></a><span id="l34.22">     delete this.dockBadgeService;</span>
<a href="#l34.23"></a><span id="l34.23">     return this.dockBadgeService = badgeService;</span>
<a href="#l34.24"></a><span id="l34.24">   },</span>
<a href="#l34.25"></a><span id="l34.25">   _showUnreadCount: function c_showUnreadCount() {</span>
<a href="#l34.26"></a><span id="l34.26">     let text = Conversations._unreadCount || &quot;&quot;;</span>
<a href="#l34.27"></a><span id="l34.27">     Conversations.dockBadgeService.badgeText = text;</span>
<a href="#l34.28"></a><span id="l34.28">   },</span>
<a href="#l34.29"></a><span id="l34.29">   _displayUnreadCountInDockBadge: function c_displayUnreadCountInDockBadge() {</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineminus">-    if (!this._prefBranch.getBoolPref(this._showDockBadgePrefName))</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+    if (!Services.prefs.getBoolPref(this._showDockBadgePrefName))</span>
<a href="#l34.32"></a><span id="l34.32">       return;</span>
<a href="#l34.33"></a><span id="l34.33"> </span>
<a href="#l34.34"></a><span id="l34.34">     if (this._unreadCount == 1 &amp;&amp;</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineminus">-        this._prefBranch.getBoolPref(this._getAttentionPrefName))</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineplus">+        Services.prefs.getBoolPref(this._getAttentionPrefName))</span>
<a href="#l34.37"></a><span id="l34.37">       // We use a timeout because it looks better to add the dock</span>
<a href="#l34.38"></a><span id="l34.38">       // badge only after the dock item has stopped jumping.</span>
<a href="#l34.39"></a><span id="l34.39">       this._badgeTimeout =</span>
<a href="#l34.40"></a><span id="l34.40">         this._windows[0].setTimeout(function () {</span>
<a href="#l34.41"></a><span id="l34.41">           Conversations._badgeTimeout = null;</span>
<a href="#l34.42"></a><span id="l34.42">           Conversations._showUnreadCount();</span>
<a href="#l34.43"></a><span id="l34.43">         }, 1000);</span>
<a href="#l34.44"></a><span id="l34.44">     else</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineat">@@ -93,22 +95,16 @@ var Conversations = {</span>
<a href="#l34.46"></a><span id="l34.46">     this._unreadCount = 0;</span>
<a href="#l34.47"></a><span id="l34.47"> #ifdef XP_MACOSX</span>
<a href="#l34.48"></a><span id="l34.48">     this._hideUnreadCountDockBadge();</span>
<a href="#l34.49"></a><span id="l34.49"> #endif</span>
<a href="#l34.50"></a><span id="l34.50">   },</span>
<a href="#l34.51"></a><span id="l34.51">   _windows: [],</span>
<a href="#l34.52"></a><span id="l34.52">   _getAttentionPrefName: &quot;messenger.options.getAttentionOnNewMessages&quot;,</span>
<a href="#l34.53"></a><span id="l34.53">   _notificationPrefName: &quot;messenger.options.notifyOfNewMessages&quot;,</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineminus">-  get _prefBranch () {</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineminus">-    delete this._prefBranch;</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineminus">-    return this._prefBranch =</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineminus">-      Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineminus">-                .getService(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineminus">-  },</span>
<a href="#l34.60"></a><span id="l34.60">   registerWindow: function(aWindow) {</span>
<a href="#l34.61"></a><span id="l34.61">     if (this._windows.indexOf(aWindow) == -1)</span>
<a href="#l34.62"></a><span id="l34.62">       this._windows.unshift(aWindow);</span>
<a href="#l34.63"></a><span id="l34.63"> </span>
<a href="#l34.64"></a><span id="l34.64">     if (this._pendingNotifications) {</span>
<a href="#l34.65"></a><span id="l34.65">       // Cache in a variable and delete the existing notification array</span>
<a href="#l34.66"></a><span id="l34.66">       // before redispatching the notifications so that the observe</span>
<a href="#l34.67"></a><span id="l34.67">       // method can recreate it.</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineat">@@ -154,74 +150,71 @@ var Conversations = {</span>
<a href="#l34.69"></a><span id="l34.69">   },</span>
<a href="#l34.70"></a><span id="l34.70"> </span>
<a href="#l34.71"></a><span id="l34.71">   _onQuitRequest: function (aCancelQuit, aQuitType) {</span>
<a href="#l34.72"></a><span id="l34.72">     // The request has already been canceled somewhere else</span>
<a href="#l34.73"></a><span id="l34.73">     if ((aCancelQuit instanceof Components.interfaces.nsISupportsPRBool)</span>
<a href="#l34.74"></a><span id="l34.74">          &amp;&amp; aCancelQuit.data)</span>
<a href="#l34.75"></a><span id="l34.75">       return;</span>
<a href="#l34.76"></a><span id="l34.76"> </span>
<a href="#l34.77"></a><span id="l34.77" class="difflineminus">-    if (!this._prefBranch.getBoolPref(&quot;messenger.warnOnQuit&quot;))</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineplus">+    if (!Services.prefs.getBoolPref(&quot;messenger.warnOnQuit&quot;))</span>
<a href="#l34.79"></a><span id="l34.79">       return;</span>
<a href="#l34.80"></a><span id="l34.80"> </span>
<a href="#l34.81"></a><span id="l34.81">     let unreadConvsCount = this._conversations.filter(function(conv) {</span>
<a href="#l34.82"></a><span id="l34.82">       let tab = conv.tab;</span>
<a href="#l34.83"></a><span id="l34.83">       return tab.hasAttribute(&quot;unread&quot;) &amp;&amp;</span>
<a href="#l34.84"></a><span id="l34.84">              (!tab.hasAttribute(&quot;chat&quot;) || tab.hasAttribute(&quot;attention&quot;));</span>
<a href="#l34.85"></a><span id="l34.85">     }).length;</span>
<a href="#l34.86"></a><span id="l34.86"> </span>
<a href="#l34.87"></a><span id="l34.87">     if (unreadConvsCount == 0)</span>
<a href="#l34.88"></a><span id="l34.88">       return;</span>
<a href="#l34.89"></a><span id="l34.89"> </span>
<a href="#l34.90"></a><span id="l34.90">     let bundle =</span>
<a href="#l34.91"></a><span id="l34.91" class="difflineminus">-      Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l34.92"></a><span id="l34.92" class="difflineminus">-                .getService(Components.interfaces.nsIStringBundleService)</span>
<a href="#l34.93"></a><span id="l34.93" class="difflineminus">-                .createBundle(&quot;chrome://instantbird/locale/quitDialog.properties&quot;);</span>
<a href="#l34.94"></a><span id="l34.94" class="difflineplus">+      Services.strings.createBundle(&quot;chrome://instantbird/locale/quitDialog.properties&quot;);</span>
<a href="#l34.95"></a><span id="l34.95">     let promptTitle    = bundle.GetStringFromName(&quot;dialogTitle&quot;);</span>
<a href="#l34.96"></a><span id="l34.96">     let promptMessage  = bundle.GetStringFromName(&quot;message&quot;);</span>
<a href="#l34.97"></a><span id="l34.97">     let promptCheckbox = bundle.GetStringFromName(&quot;checkbox&quot;);</span>
<a href="#l34.98"></a><span id="l34.98">     let action         = aQuitType == &quot;restart&quot; ? &quot;restart&quot; : &quot;quit&quot;;</span>
<a href="#l34.99"></a><span id="l34.99">     let button         = bundle.GetStringFromName(action + &quot;Button&quot;);</span>
<a href="#l34.100"></a><span id="l34.100"> </span>
<a href="#l34.101"></a><span id="l34.101">     Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l34.102"></a><span id="l34.102">     promptMessage = PluralForm.get(unreadConvsCount, promptMessage)</span>
<a href="#l34.103"></a><span id="l34.103">                               .replace(&quot;#1&quot;, unreadConvsCount);</span>
<a href="#l34.104"></a><span id="l34.104"> </span>
<a href="#l34.105"></a><span id="l34.105" class="difflineminus">-    let prompts = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l34.106"></a><span id="l34.106" class="difflineminus">-                            .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l34.107"></a><span id="l34.107" class="difflineplus">+    let prompts = Services.prompt;</span>
<a href="#l34.108"></a><span id="l34.108">     let flags = prompts.BUTTON_TITLE_IS_STRING * prompts.BUTTON_POS_0 +</span>
<a href="#l34.109"></a><span id="l34.109">                 prompts.BUTTON_TITLE_CANCEL * prompts.BUTTON_POS_1 +</span>
<a href="#l34.110"></a><span id="l34.110">                 prompts.BUTTON_POS_1_DEFAULT;</span>
<a href="#l34.111"></a><span id="l34.111">     let checkbox = {value: false};</span>
<a href="#l34.112"></a><span id="l34.112">     if (prompts.confirmEx(this._windows[0], promptTitle, promptMessage, flags,</span>
<a href="#l34.113"></a><span id="l34.113">                           button, null, null, promptCheckbox, checkbox)) {</span>
<a href="#l34.114"></a><span id="l34.114">       aCancelQuit.data = true;</span>
<a href="#l34.115"></a><span id="l34.115">       return;</span>
<a href="#l34.116"></a><span id="l34.116">     }</span>
<a href="#l34.117"></a><span id="l34.117"> </span>
<a href="#l34.118"></a><span id="l34.118">     if (checkbox.value)</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineminus">-      this._prefBranch.setBoolPref(&quot;messenger.warnOnQuit&quot;, false);</span>
<a href="#l34.120"></a><span id="l34.120" class="difflineplus">+      Services.prefs.setBoolPref(&quot;messenger.warnOnQuit&quot;, false);</span>
<a href="#l34.121"></a><span id="l34.121">   },</span>
<a href="#l34.122"></a><span id="l34.122"> </span>
<a href="#l34.123"></a><span id="l34.123">   onWindowFocus: function (aWindow) {</span>
<a href="#l34.124"></a><span id="l34.124">     let position = this._windows.indexOf(aWindow);</span>
<a href="#l34.125"></a><span id="l34.125">     if (position != -1) {</span>
<a href="#l34.126"></a><span id="l34.126">       this._windows.splice(position, 1);</span>
<a href="#l34.127"></a><span id="l34.127">       this._windows.unshift(aWindow);</span>
<a href="#l34.128"></a><span id="l34.128">     }</span>
<a href="#l34.129"></a><span id="l34.129">     this._clearUnreadCount();</span>
<a href="#l34.130"></a><span id="l34.130">   },</span>
<a href="#l34.131"></a><span id="l34.131"> </span>
<a href="#l34.132"></a><span id="l34.132">   get ellipsis () {</span>
<a href="#l34.133"></a><span id="l34.133">     let ellipsis = &quot;[\u2026]&quot;;</span>
<a href="#l34.134"></a><span id="l34.134"> </span>
<a href="#l34.135"></a><span id="l34.135">     try {</span>
<a href="#l34.136"></a><span id="l34.136">       ellipsis =</span>
<a href="#l34.137"></a><span id="l34.137" class="difflineminus">-        this._prefBranch.getComplexValue(&quot;intl.ellipsis&quot;,</span>
<a href="#l34.138"></a><span id="l34.138" class="difflineminus">-                                         Components.interfaces.nsIPrefLocalizedString).data;</span>
<a href="#l34.139"></a><span id="l34.139" class="difflineplus">+        Services.prefs.getComplexValue(&quot;intl.ellipsis&quot;,</span>
<a href="#l34.140"></a><span id="l34.140" class="difflineplus">+                                       Components.interfaces.nsIPrefLocalizedString).data;</span>
<a href="#l34.141"></a><span id="l34.141">     } catch (e) { }</span>
<a href="#l34.142"></a><span id="l34.142">     return ellipsis;</span>
<a href="#l34.143"></a><span id="l34.143">   },</span>
<a href="#l34.144"></a><span id="l34.144"> </span>
<a href="#l34.145"></a><span id="l34.145">   _showMessageNotification: function (aMessage) {</span>
<a href="#l34.146"></a><span id="l34.146">     // Get the hidden window. We need it to create a DOM node.</span>
<a href="#l34.147"></a><span id="l34.147">     let win = Components.classes[&quot;@mozilla.org/appshell/appShellService;1&quot;]</span>
<a href="#l34.148"></a><span id="l34.148">                         .getService(Components.interfaces.nsIAppShellService)</span>
<a href="#l34.149"></a><span id="l34.149" class="difflineat">@@ -266,65 +259,64 @@ var Conversations = {</span>
<a href="#l34.150"></a><span id="l34.150">     // Finally show the notification!</span>
<a href="#l34.151"></a><span id="l34.151">     Components.classes[&quot;@mozilla.org/alerts-service;1&quot;]</span>
<a href="#l34.152"></a><span id="l34.152">               .getService(Components.interfaces.nsIAlertsService)</span>
<a href="#l34.153"></a><span id="l34.153">               .showAlertNotification(icon, aMessage.alias || aMessage.who,</span>
<a href="#l34.154"></a><span id="l34.154">                                      messageText, true, &quot;&quot;, observer);</span>
<a href="#l34.155"></a><span id="l34.155">   },</span>
<a href="#l34.156"></a><span id="l34.156"> </span>
<a href="#l34.157"></a><span id="l34.157">   init: function() {</span>
<a href="#l34.158"></a><span id="l34.158" class="difflineminus">-    let os = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l34.159"></a><span id="l34.159" class="difflineminus">-                       .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l34.160"></a><span id="l34.160" class="difflineplus">+    let os = Services.obs;</span>
<a href="#l34.161"></a><span id="l34.161">     [&quot;new-text&quot;,</span>
<a href="#l34.162"></a><span id="l34.162">      &quot;new-conversation&quot;,</span>
<a href="#l34.163"></a><span id="l34.163">      &quot;account-connected&quot;,</span>
<a href="#l34.164"></a><span id="l34.164">      &quot;purple-quit&quot;,</span>
<a href="#l34.165"></a><span id="l34.165">      &quot;quit-application-requested&quot;].forEach(function (aTopic) {</span>
<a href="#l34.166"></a><span id="l34.166">       os.addObserver(Conversations, aTopic, false);</span>
<a href="#l34.167"></a><span id="l34.167">     });</span>
<a href="#l34.168"></a><span id="l34.168"> #ifdef XP_MACOSX</span>
<a href="#l34.169"></a><span id="l34.169" class="difflineminus">-    this._prefBranch.addObserver(this._showDockBadgePrefName, this, false);</span>
<a href="#l34.170"></a><span id="l34.170" class="difflineplus">+    Services.prefs.addObserver(this._showDockBadgePrefName, this, false);</span>
<a href="#l34.171"></a><span id="l34.171"> #endif</span>
<a href="#l34.172"></a><span id="l34.172">   },</span>
<a href="#l34.173"></a><span id="l34.173"> </span>
<a href="#l34.174"></a><span id="l34.174">   observe: function(aSubject, aTopic, aMsg) {</span>
<a href="#l34.175"></a><span id="l34.175">     if (aTopic == &quot;quit-application-requested&quot;) {</span>
<a href="#l34.176"></a><span id="l34.176">       this._onQuitRequest(aSubject, aMsg);</span>
<a href="#l34.177"></a><span id="l34.177">       return;</span>
<a href="#l34.178"></a><span id="l34.178">     }</span>
<a href="#l34.179"></a><span id="l34.179"> </span>
<a href="#l34.180"></a><span id="l34.180">     if (aTopic == &quot;purple-quit&quot;) {</span>
<a href="#l34.181"></a><span id="l34.181">       for (let id in this._purpleConv)</span>
<a href="#l34.182"></a><span id="l34.182">         this._purpleConv[id].unInit();</span>
<a href="#l34.183"></a><span id="l34.183"> #ifdef XP_MACOSX</span>
<a href="#l34.184"></a><span id="l34.184" class="difflineminus">-      this._prefBranch.removeObserver(Conversations._showDockBadgePrefName,</span>
<a href="#l34.185"></a><span id="l34.185" class="difflineminus">-                                      Conversations);</span>
<a href="#l34.186"></a><span id="l34.186" class="difflineplus">+      Services.prefs.removeObserver(Conversations._showDockBadgePrefName,</span>
<a href="#l34.187"></a><span id="l34.187" class="difflineplus">+                                    Conversations);</span>
<a href="#l34.188"></a><span id="l34.188"> #endif</span>
<a href="#l34.189"></a><span id="l34.189">     }</span>
<a href="#l34.190"></a><span id="l34.190"> </span>
<a href="#l34.191"></a><span id="l34.191"> #ifdef XP_MACOSX</span>
<a href="#l34.192"></a><span id="l34.192">     if (aTopic == &quot;nsPref:changed&quot;) {</span>
<a href="#l34.193"></a><span id="l34.193">       if (aMsg == this._showDockBadgePrefName) {</span>
<a href="#l34.194"></a><span id="l34.194" class="difflineminus">-        if (this._prefBranch.getBoolPref(aMsg))</span>
<a href="#l34.195"></a><span id="l34.195" class="difflineplus">+        if (Services.prefs.getBoolPref(aMsg))</span>
<a href="#l34.196"></a><span id="l34.196">           this._showUnreadCount();</span>
<a href="#l34.197"></a><span id="l34.197">         else</span>
<a href="#l34.198"></a><span id="l34.198">           this._hideUnreadCountDockBadge();</span>
<a href="#l34.199"></a><span id="l34.199">       }</span>
<a href="#l34.200"></a><span id="l34.200">       return;</span>
<a href="#l34.201"></a><span id="l34.201">     }</span>
<a href="#l34.202"></a><span id="l34.202"> #endif</span>
<a href="#l34.203"></a><span id="l34.203"> </span>
<a href="#l34.204"></a><span id="l34.204">     if (aTopic == &quot;account-connected&quot;) {</span>
<a href="#l34.205"></a><span id="l34.205">       let account = aSubject.QueryInterface(Components.interfaces.purpleIAccount);</span>
<a href="#l34.206"></a><span id="l34.206">       if (!account.canJoinChat)</span>
<a href="#l34.207"></a><span id="l34.207">         return;</span>
<a href="#l34.208"></a><span id="l34.208"> </span>
<a href="#l34.209"></a><span id="l34.209">       let pref = &quot;messenger.account.&quot; + account.id + &quot;.autoJoin&quot;;</span>
<a href="#l34.210"></a><span id="l34.210" class="difflineminus">-      if (this._prefBranch.prefHasUserValue(pref)) {</span>
<a href="#l34.211"></a><span id="l34.211" class="difflineminus">-        let autojoin = this._prefBranch.getCharPref(pref);</span>
<a href="#l34.212"></a><span id="l34.212" class="difflineplus">+      if (Services.prefs.prefHasUserValue(pref)) {</span>
<a href="#l34.213"></a><span id="l34.213" class="difflineplus">+        let autojoin = Services.prefs.getCharPref(pref);</span>
<a href="#l34.214"></a><span id="l34.214">         if (autojoin) {</span>
<a href="#l34.215"></a><span id="l34.215">           autojoin = autojoin.split(&quot;,&quot;);</span>
<a href="#l34.216"></a><span id="l34.216">           for (let i = 0; i &lt; autojoin.length; ++i) {</span>
<a href="#l34.217"></a><span id="l34.217">             let values = account.getChatRoomDefaultFieldValues(autojoin[i]);</span>
<a href="#l34.218"></a><span id="l34.218">             account.joinChat(values);</span>
<a href="#l34.219"></a><span id="l34.219">           }</span>
<a href="#l34.220"></a><span id="l34.220">         }</span>
<a href="#l34.221"></a><span id="l34.221">       }</span>
<a href="#l34.222"></a><span id="l34.222" class="difflineat">@@ -346,33 +338,31 @@ var Conversations = {</span>
<a href="#l34.223"></a><span id="l34.223">       // If we are already creating a window, append the notification.</span>
<a href="#l34.224"></a><span id="l34.224">       if (this._pendingNotifications) {</span>
<a href="#l34.225"></a><span id="l34.225">         this._pendingNotifications.push({object: aSubject, topic: aTopic,</span>
<a href="#l34.226"></a><span id="l34.226">                                          msg: aMsg});</span>
<a href="#l34.227"></a><span id="l34.227">         return;</span>
<a href="#l34.228"></a><span id="l34.228">       }</span>
<a href="#l34.229"></a><span id="l34.229"> </span>
<a href="#l34.230"></a><span id="l34.230">       // We need to create a new window.</span>
<a href="#l34.231"></a><span id="l34.231" class="difflineminus">-      var wwatch = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l34.232"></a><span id="l34.232" class="difflineminus">-                             .getService(Components.interfaces.nsIWindowWatcher);</span>
<a href="#l34.233"></a><span id="l34.233" class="difflineminus">-      wwatch.openWindow(null, CONVERSATION_WINDOW_URI, &quot;_blank&quot;,</span>
<a href="#l34.234"></a><span id="l34.234" class="difflineminus">-                        &quot;chrome,toolbar,resizable&quot;, null);</span>
<a href="#l34.235"></a><span id="l34.235" class="difflineplus">+      Services.ww.openWindow(null, CONVERSATION_WINDOW_URI, &quot;_blank&quot;,</span>
<a href="#l34.236"></a><span id="l34.236" class="difflineplus">+                             &quot;chrome,toolbar,resizable&quot;, null);</span>
<a href="#l34.237"></a><span id="l34.237">       this._pendingNotifications = [{object: aSubject, topic: aTopic, msg: aMsg}];</span>
<a href="#l34.238"></a><span id="l34.238">       return;</span>
<a href="#l34.239"></a><span id="l34.239">     }</span>
<a href="#l34.240"></a><span id="l34.240"> </span>
<a href="#l34.241"></a><span id="l34.241">     if (aTopic == &quot;new-text&quot;) {</span>
<a href="#l34.242"></a><span id="l34.242">       let conv = this._purpleConv[aSubject.conversation.id];</span>
<a href="#l34.243"></a><span id="l34.243">       if (!conv.loaded)</span>
<a href="#l34.244"></a><span id="l34.244">         conv.addMsg(aSubject);</span>
<a href="#l34.245"></a><span id="l34.245">       if (aSubject.incoming &amp;&amp; !aSubject.system &amp;&amp;</span>
<a href="#l34.246"></a><span id="l34.246">           (!aSubject.conversation.isChat || aSubject.containsNick)) {</span>
<a href="#l34.247"></a><span id="l34.247" class="difflineminus">-        if (this._prefBranch.getBoolPref(this._getAttentionPrefName))</span>
<a href="#l34.248"></a><span id="l34.248" class="difflineplus">+        if (Services.prefs.getBoolPref(this._getAttentionPrefName))</span>
<a href="#l34.249"></a><span id="l34.249">           conv.ownerDocument.defaultView.getAttention();</span>
<a href="#l34.250"></a><span id="l34.250">         if (!this._windows[0].document.hasFocus()) {</span>
<a href="#l34.251"></a><span id="l34.251">           this._incrementUnreadCount();</span>
<a href="#l34.252"></a><span id="l34.252" class="difflineminus">-          if (this._prefBranch.getBoolPref(this._notificationPrefName))</span>
<a href="#l34.253"></a><span id="l34.253" class="difflineplus">+          if (Services.prefs.getBoolPref(this._notificationPrefName))</span>
<a href="#l34.254"></a><span id="l34.254">             this._showMessageNotification(aSubject);</span>
<a href="#l34.255"></a><span id="l34.255">         }</span>
<a href="#l34.256"></a><span id="l34.256">       }</span>
<a href="#l34.257"></a><span id="l34.257">     }</span>
<a href="#l34.258"></a><span id="l34.258">   }</span>
<a href="#l34.259"></a><span id="l34.259"> };</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

