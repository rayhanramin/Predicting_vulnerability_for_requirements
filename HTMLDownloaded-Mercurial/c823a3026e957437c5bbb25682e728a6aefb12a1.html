<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 904:c823a3026e957437c5bbb25682e728a6aefb12a1</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c823a3026e957437c5bbb25682e728a6aefb12a1" />
<meta property="og:url" content="/comm-central/rev/c823a3026e957437c5bbb25682e728a6aefb12a1" />
<meta property="og:description" content="indexing unit test allegedly works!" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c823a3026e957437c5bbb25682e728a6aefb12a1 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c823a3026e957437c5bbb25682e728a6aefb12a1">shortlog</a> |
<a href="/comm-central/log/c823a3026e957437c5bbb25682e728a6aefb12a1">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c823a3026e957437c5bbb25682e728a6aefb12a1">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c823a3026e957437c5bbb25682e728a6aefb12a1">files</a> |
changeset |
<a href="/comm-central/raw-rev/c823a3026e957437c5bbb25682e728a6aefb12a1">raw</a>  | <a href="/comm-central/archive/c823a3026e957437c5bbb25682e728a6aefb12a1.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
indexing unit test allegedly works!
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 03 Sep 2008 01:55:23 -0700</td></tr>

<tr>
 <td>changeset 904</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c823a3026e957437c5bbb25682e728a6aefb12a1">c823a3026e957437c5bbb25682e728a6aefb12a1</a></td>
</tr>



<tr>
<td>parent 903</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9428198987203b368b40bdd0d1df35942712fde0">9428198987203b368b40bdd0d1df35942712fde0</a>
</td>
</tr>

<tr>
<td>child 905</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5f1106c3cae4ccad36f401272e3ec13f25d5d54d">5f1106c3cae4ccad36f401272e3ec13f25d5d54d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c823a3026e957437c5bbb25682e728a6aefb12a1">743</a></td></tr>
<tr><td>push user</td><td>dmosedale@mozilla.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 04 Nov 2008 20:01:44 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a79b923a9cba [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a79b923a9cba395cb3911b27c9599ffb8c997caf&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a79b923a9cba395cb3911b27c9599ffb8c997caf&newProject=comm-central&newRevision=d32b4cc6f46d1195ae66fd0cf8395c60b9259ca6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">indexing unit test allegedly works!</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c823a3026e957437c5bbb25682e728a6aefb12a1/content/overlay.js">content/overlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c823a3026e957437c5bbb25682e728a6aefb12a1/content/overlay.js">file</a> |
<a href="/comm-central/annotate/c823a3026e957437c5bbb25682e728a6aefb12a1/content/overlay.js">annotate</a> |
<a href="/comm-central/diff/c823a3026e957437c5bbb25682e728a6aefb12a1/content/overlay.js">diff</a> |
<a href="/comm-central/comparison/c823a3026e957437c5bbb25682e728a6aefb12a1/content/overlay.js">comparison</a> |
<a href="/comm-central/log/c823a3026e957437c5bbb25682e728a6aefb12a1/content/overlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c823a3026e957437c5bbb25682e728a6aefb12a1/modules/indexer.js">modules/indexer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c823a3026e957437c5bbb25682e728a6aefb12a1/modules/indexer.js">file</a> |
<a href="/comm-central/annotate/c823a3026e957437c5bbb25682e728a6aefb12a1/modules/indexer.js">annotate</a> |
<a href="/comm-central/diff/c823a3026e957437c5bbb25682e728a6aefb12a1/modules/indexer.js">diff</a> |
<a href="/comm-central/comparison/c823a3026e957437c5bbb25682e728a6aefb12a1/modules/indexer.js">comparison</a> |
<a href="/comm-central/log/c823a3026e957437c5bbb25682e728a6aefb12a1/modules/indexer.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c823a3026e957437c5bbb25682e728a6aefb12a1/modules/mimemsg.js">modules/mimemsg.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c823a3026e957437c5bbb25682e728a6aefb12a1/modules/mimemsg.js">file</a> |
<a href="/comm-central/annotate/c823a3026e957437c5bbb25682e728a6aefb12a1/modules/mimemsg.js">annotate</a> |
<a href="/comm-central/diff/c823a3026e957437c5bbb25682e728a6aefb12a1/modules/mimemsg.js">diff</a> |
<a href="/comm-central/comparison/c823a3026e957437c5bbb25682e728a6aefb12a1/modules/mimemsg.js">comparison</a> |
<a href="/comm-central/log/c823a3026e957437c5bbb25682e728a6aefb12a1/modules/mimemsg.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c823a3026e957437c5bbb25682e728a6aefb12a1/test/resources/glodaTestHelper.js">test/resources/glodaTestHelper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c823a3026e957437c5bbb25682e728a6aefb12a1/test/resources/glodaTestHelper.js">file</a> |
<a href="/comm-central/annotate/c823a3026e957437c5bbb25682e728a6aefb12a1/test/resources/glodaTestHelper.js">annotate</a> |
<a href="/comm-central/diff/c823a3026e957437c5bbb25682e728a6aefb12a1/test/resources/glodaTestHelper.js">diff</a> |
<a href="/comm-central/comparison/c823a3026e957437c5bbb25682e728a6aefb12a1/test/resources/glodaTestHelper.js">comparison</a> |
<a href="/comm-central/log/c823a3026e957437c5bbb25682e728a6aefb12a1/test/resources/glodaTestHelper.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c823a3026e957437c5bbb25682e728a6aefb12a1/test/unit/test_index_messages.js">test/unit/test_index_messages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c823a3026e957437c5bbb25682e728a6aefb12a1/test/unit/test_index_messages.js">file</a> |
<a href="/comm-central/annotate/c823a3026e957437c5bbb25682e728a6aefb12a1/test/unit/test_index_messages.js">annotate</a> |
<a href="/comm-central/diff/c823a3026e957437c5bbb25682e728a6aefb12a1/test/unit/test_index_messages.js">diff</a> |
<a href="/comm-central/comparison/c823a3026e957437c5bbb25682e728a6aefb12a1/test/unit/test_index_messages.js">comparison</a> |
<a href="/comm-central/log/c823a3026e957437c5bbb25682e728a6aefb12a1/test/unit/test_index_messages.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/content/overlay.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/content/overlay.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -40,21 +40,16 @@ Components.utils.import(&quot;resource://glod</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> var gloda = {</span>
<a href="#l1.6"></a><span id="l1.6">   _mimeMsg: {},</span>
<a href="#l1.7"></a><span id="l1.7">   </span>
<a href="#l1.8"></a><span id="l1.8">   onLoad: function() {</span>
<a href="#l1.9"></a><span id="l1.9">     // initialization code</span>
<a href="#l1.10"></a><span id="l1.10">     this.initialized = true;</span>
<a href="#l1.11"></a><span id="l1.11">     this.strings = document.getElementById(&quot;gloda-strings&quot;);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    </span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    // initialize the globals required for the JS Mime representation</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-    Components.utils.import(&quot;resource://gloda/modules/mimemsg.js&quot;,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-                            this._mimeMsg);</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-    this._mimeMsg.MsgHdrToMimeMessage.initGlobals(messenger, msgWindow);</span>
<a href="#l1.17"></a><span id="l1.17">   },</span>
<a href="#l1.18"></a><span id="l1.18">   onIndexEverythingCommand: function(e) {</span>
<a href="#l1.19"></a><span id="l1.19">     GlodaIndexer.indexEverything();</span>
<a href="#l1.20"></a><span id="l1.20">   },</span>
<a href="#l1.21"></a><span id="l1.21">   onIndexAddressBookCommand: function(e) {</span>
<a href="#l1.22"></a><span id="l1.22">     // TODO support address-book indexing or something.</span>
<a href="#l1.23"></a><span id="l1.23">   },  </span>
<a href="#l1.24"></a><span id="l1.24">   indexSelectedMessages: function () {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/modules/indexer.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/modules/indexer.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -236,26 +236,40 @@ let GlodaIndexer = {</span>
<a href="#l2.4"></a><span id="l2.4">     let mailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;].</span>
<a href="#l2.5"></a><span id="l2.5">                         getService(Ci.nsIMsgMailSession);</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">     this._folderListener._init(this);</span>
<a href="#l2.8"></a><span id="l2.8">     // register for folder loaded events...</span>
<a href="#l2.9"></a><span id="l2.9">     mailSession.AddFolderListener(this._folderListener,</span>
<a href="#l2.10"></a><span id="l2.10">                                   Ci.nsIFolderListener.event);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    let observerService = Cc[&quot;@mozilla.org/observer-service;1&quot;].</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+                            getService(Ci.nsIObserverService);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    observerService.addObserver(this, &quot;xpcom-shutdown&quot;, false);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+</span>
<a href="#l2.16"></a><span id="l2.16">     // figure out if event-driven indexing should be enabled...</span>
<a href="#l2.17"></a><span id="l2.17">     let prefService = Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l2.18"></a><span id="l2.18">                         getService(Ci.nsIPrefService);</span>
<a href="#l2.19"></a><span id="l2.19">     let branch = prefService.getBranch(&quot;mailnews.database.global.indexer&quot;);</span>
<a href="#l2.20"></a><span id="l2.20">     let eventDrivenEnabled = true; // default</span>
<a href="#l2.21"></a><span id="l2.21">     if (branch.prefHasUserValue(&quot;enabled&quot;))</span>
<a href="#l2.22"></a><span id="l2.22">       eventDrivenEnabled = branch.getBoolPref(&quot;enabled&quot;);</span>
<a href="#l2.23"></a><span id="l2.23">     this.enabled = eventDrivenEnabled;</span>
<a href="#l2.24"></a><span id="l2.24">   },</span>
<a href="#l2.25"></a><span id="l2.25">   </span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+  _shutdown: function gloda_index_shutdown() {</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+    this._log.info(&quot;Shutting Down&quot;);</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+    this.enabled = false;</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+    </span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+    let mailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;].</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+                        getService(Ci.nsIMsgMailSession);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+    mailSession.RemoveFolderListener(this._folderListener);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+  },</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+  </span>
<a href="#l2.36"></a><span id="l2.36">   /**</span>
<a href="#l2.37"></a><span id="l2.37">    * Are we enabled, read: are we processing change events?</span>
<a href="#l2.38"></a><span id="l2.38">    */</span>
<a href="#l2.39"></a><span id="l2.39">   _enabled: false,</span>
<a href="#l2.40"></a><span id="l2.40">   get enabled() { return this._enabled; },</span>
<a href="#l2.41"></a><span id="l2.41">   set enabled(aEnable) {</span>
<a href="#l2.42"></a><span id="l2.42">     if (!this._enabled &amp;&amp; aEnable) {</span>
<a href="#l2.43"></a><span id="l2.43">       this._msgFolderListener.indexer = this;</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineat">@@ -900,16 +914,21 @@ let GlodaIndexer = {</span>
<a href="#l2.45"></a><span id="l2.45">     job.items = [[GlodaDatastore._mapFolderURI(fm[0].URI), fm[1]] for each</span>
<a href="#l2.46"></a><span id="l2.46">                  (fm in aFoldersAndMessages)];</span>
<a href="#l2.47"></a><span id="l2.47">     this._indexQueue.push(job);</span>
<a href="#l2.48"></a><span id="l2.48">     this._indexingJobGoal++;</span>
<a href="#l2.49"></a><span id="l2.49">     this.indexing = true;</span>
<a href="#l2.50"></a><span id="l2.50">   },</span>
<a href="#l2.51"></a><span id="l2.51">   </span>
<a href="#l2.52"></a><span id="l2.52">   /* *********** Event Processing *********** */</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+  observe: function gloda_indexer_observe(aSubject, aTopic, aData) {</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+    if (aTopic == &quot;xpcom-shutdown&quot;) {</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+      GlodaIndexer._shutdown();</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+    }</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  },</span>
<a href="#l2.58"></a><span id="l2.58"> </span>
<a href="#l2.59"></a><span id="l2.59">   /* ***** Folder Changes ***** */  </span>
<a href="#l2.60"></a><span id="l2.60">   /**</span>
<a href="#l2.61"></a><span id="l2.61">    * All additions and removals are queued for processing.  Indexing messages</span>
<a href="#l2.62"></a><span id="l2.62">    *  is potentially phenomenally expensive, and deletion can still be</span>
<a href="#l2.63"></a><span id="l2.63">    *  relatively expensive due to our need to delete the message, its</span>
<a href="#l2.64"></a><span id="l2.64">    *  attributes, and all attributes that reference it.  Additionally,</span>
<a href="#l2.65"></a><span id="l2.65">    *  attribute deletion costs are higher than attribute look-up because</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/modules/mimemsg.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/modules/mimemsg.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -105,18 +105,18 @@ CallbackStreamListener.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">                     createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l3.5"></a><span id="l3.5">       this._stream.init(aInputStream);</span>
<a href="#l3.6"></a><span id="l3.6">     }</span>
<a href="#l3.7"></a><span id="l3.7">     this._stream.read(aCount);</span>
<a href="#l3.8"></a><span id="l3.8">     </span>
<a href="#l3.9"></a><span id="l3.9">   },</span>
<a href="#l3.10"></a><span id="l3.10"> };</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-let gMessenger = null;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-let gMsgWindow = null;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+let gMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;].</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+                   createInstance(Ci.nsIMessenger);</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> /**</span>
<a href="#l3.18"></a><span id="l3.18">  * Starts retrieval of a MimeMessage instance for the given message header.</span>
<a href="#l3.19"></a><span id="l3.19">  *  Your callback will be called with the message header you provide and the</span>
<a href="#l3.20"></a><span id="l3.20">  *  </span>
<a href="#l3.21"></a><span id="l3.21">  * @param aMsgHdr The message header to retrieve the body for and build a MIME</span>
<a href="#l3.22"></a><span id="l3.22">  *     representation of the message.</span>
<a href="#l3.23"></a><span id="l3.23">  * @param aCallbackThis The (optional) 'this' to use for your callback function.</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineat">@@ -129,17 +129,17 @@ function MsgHdrToMimeMessage(aMsgHdr, aC</span>
<a href="#l3.25"></a><span id="l3.25">   let msgURI = aMsgHdr.folder.getUriForMsg(aMsgHdr);</span>
<a href="#l3.26"></a><span id="l3.26">   let msgService = gMessenger.messageServiceFromURI(msgURI);</span>
<a href="#l3.27"></a><span id="l3.27">   </span>
<a href="#l3.28"></a><span id="l3.28">   let streamListener = new CallbackStreamListener(aMsgHdr,</span>
<a href="#l3.29"></a><span id="l3.29">                                                   aCallbackThis, aCallback);</span>
<a href="#l3.30"></a><span id="l3.30">   </span>
<a href="#l3.31"></a><span id="l3.31">   let streamURI = msgService.streamMessage(msgURI,</span>
<a href="#l3.32"></a><span id="l3.32">                                            streamListener, // consumer</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-                                           gMsgWindow, // nsIMsgWindow</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+                                           null, // nsIMsgWindow</span>
<a href="#l3.35"></a><span id="l3.35">                                            dumbUrlListener, // nsIUrlListener</span>
<a href="#l3.36"></a><span id="l3.36">                                            true, // have them create the converter</span>
<a href="#l3.37"></a><span id="l3.37">       // additional uri payload, note that &quot;header=&quot; is prepended automatically </span>
<a href="#l3.38"></a><span id="l3.38">                                            &quot;filter&amp;emitter=js&quot;); </span>
<a href="#l3.39"></a><span id="l3.39"> }</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41"> /**</span>
<a href="#l3.42"></a><span id="l3.42">  * Let the jsmimeemitter provide us with results.  The poor emitter (if I am</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineat">@@ -151,23 +151,16 @@ function MsgHdrToMimeMessage(aMsgHdr, aC</span>
<a href="#l3.44"></a><span id="l3.44">  *  on things like the nsIUri instances either.  So we have the jsmimeemitter</span>
<a href="#l3.45"></a><span id="l3.45">  *  import us and poke things into RESULT_RENDEVOUZ.  We put it here on this</span>
<a href="#l3.46"></a><span id="l3.46">  *  function to try and be stealthy and avoid polluting the namespaces (or</span>
<a href="#l3.47"></a><span id="l3.47">  *  encouraging bad behaviour) of our importers.</span>
<a href="#l3.48"></a><span id="l3.48">  *</span>
<a href="#l3.49"></a><span id="l3.49">  * If you can come up with a prettier way to shuttle this data, please do.</span>
<a href="#l3.50"></a><span id="l3.50">  */</span>
<a href="#l3.51"></a><span id="l3.51"> MsgHdrToMimeMessage.RESULT_RENDEVOUZ = {};</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-/**</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">- * Someone with access to these globals needs to push them into us.</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">- */</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-MsgHdrToMimeMessage.initGlobals = function(aMessenger, aMsgWindow) {</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-  gMessenger = aMessenger;</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-  gMsgWindow = aMsgWindow;</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-}</span>
<a href="#l3.59"></a><span id="l3.59"> </span>
<a href="#l3.60"></a><span id="l3.60"> /**</span>
<a href="#l3.61"></a><span id="l3.61">  * @ivar partName The MIME part, ex &quot;1.2.2.1&quot;.  The partName of a (top-level)</span>
<a href="#l3.62"></a><span id="l3.62">  *     message is &quot;1&quot;, its first child is &quot;1.1&quot;, its second child is &quot;1.2&quot;,</span>
<a href="#l3.63"></a><span id="l3.63">  *     its first child's first child is &quot;1.1.1&quot;, etc.</span>
<a href="#l3.64"></a><span id="l3.64">  * @ivar headers Maps lower-cased header field names to a list of the values</span>
<a href="#l3.65"></a><span id="l3.65">  *     seen for the given header.  Use get or getAll as convenience helpers.</span>
<a href="#l3.66"></a><span id="l3.66">  * @ivar body The body of the message.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/test/resources/glodaTestHelper.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/test/resources/glodaTestHelper.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -50,54 +50,168 @@ function indexMessages(aSynthMessages, a</span>
<a href="#l4.4"></a><span id="l4.4">   </span>
<a href="#l4.5"></a><span id="l4.5">   ims.inputMessages = aSynthMessages;</span>
<a href="#l4.6"></a><span id="l4.6">   ims.glodaMessages = [];</span>
<a href="#l4.7"></a><span id="l4.7">   ims.verifier = aVerifier;</span>
<a href="#l4.8"></a><span id="l4.8">   ims.previousValue = undefined;</span>
<a href="#l4.9"></a><span id="l4.9">   ims.onDone = aOnDone;</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">   if (!ims.inited) {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+    // Disable new mail notifications</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    var prefSvc = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+      .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  </span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+    prefSvc.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+    prefSvc.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+    prefSvc.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+    prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+  </span>
<a href="#l4.21"></a><span id="l4.21">     GlodaIndexer.addListener(messageIndexerListener.onIndexNotification);</span>
<a href="#l4.22"></a><span id="l4.22">     ims.catchAllCollection = Gloda._wildcardCollection(Gloda.NOUN_MESSAGE);</span>
<a href="#l4.23"></a><span id="l4.23">     ims.catchAllCollection.listener = messageCollectionListener;</span>
<a href="#l4.24"></a><span id="l4.24">     </span>
<a href="#l4.25"></a><span id="l4.25">     // set up POP3 fakeserver to feed things in...</span>
<a href="#l4.26"></a><span id="l4.26">     [ims.daemon, ims.server] = setupServerDaemon();</span>
<a href="#l4.27"></a><span id="l4.27">     ims.incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+    ims.pop3Service = Cc[&quot;@mozilla.org/messenger/popservice;1&quot;]</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+                        .getService(Ci.nsIPop3Service);</span>
<a href="#l4.31"></a><span id="l4.31">     </span>
<a href="#l4.32"></a><span id="l4.32">     ims.inited = true;</span>
<a href="#l4.33"></a><span id="l4.33">   }</span>
<a href="#l4.34"></a><span id="l4.34">   </span>
<a href="#l4.35"></a><span id="l4.35">   ims.daemon.setMessages(_synthMessagesToFakeRep(aSynthMessages));</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+  ims.active = true;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  do_timeout(0, &quot;driveFakeServer();&quot;);</span>
<a href="#l4.38"></a><span id="l4.38"> }</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40"> var indexMessageState = {</span>
<a href="#l4.41"></a><span id="l4.41">   /** have we been initialized (hooked listeners, etc.) */</span>
<a href="#l4.42"></a><span id="l4.42">   inited: false,</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  active: false,</span>
<a href="#l4.44"></a><span id="l4.44">   /** our catch-all message collection that nets us all messages passing by */</span>
<a href="#l4.45"></a><span id="l4.45">   catchAllCollection: null,</span>
<a href="#l4.46"></a><span id="l4.46">   /** the set of synthetic messages passed in to indexMessages */</span>
<a href="#l4.47"></a><span id="l4.47">   inputMessages: null,</span>
<a href="#l4.48"></a><span id="l4.48">   /** the gloda messages resulting from indexing corresponding to input ones */</span>
<a href="#l4.49"></a><span id="l4.49">   glodaMessages: null,</span>
<a href="#l4.50"></a><span id="l4.50">   /** the user-specified accumulate-style verification func */</span>
<a href="#l4.51"></a><span id="l4.51">   verifier: null,</span>
<a href="#l4.52"></a><span id="l4.52">   /** the result of the last call to the verification function */</span>
<a href="#l4.53"></a><span id="l4.53">   previousValue: undefined,</span>
<a href="#l4.54"></a><span id="l4.54">   /** the function to call once we have indexed all the messages */</span>
<a href="#l4.55"></a><span id="l4.55">   onDone: null,</span>
<a href="#l4.56"></a><span id="l4.56">   </span>
<a href="#l4.57"></a><span id="l4.57">   /** nsMailServer instance with POP3_RFC1939 handler */</span>
<a href="#l4.58"></a><span id="l4.58">   server: null,</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+  serverStarted: false,</span>
<a href="#l4.60"></a><span id="l4.60">   /** pop3Daemon instance */</span>
<a href="#l4.61"></a><span id="l4.61">   daemon: null,</span>
<a href="#l4.62"></a><span id="l4.62">   /** incoming pop3 server */</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-  incomingServer: null</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+  incomingServer: null,</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+  /** pop3 service */</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+  pop3Service: null,</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+  urlListener: {</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+    OnStartRunningUrl: function (url) {</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+    },</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+    OnStopRunningUrl: function (url, result) {</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+dump(&quot;~~onStopRuningUrl\n&quot;);</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+      let ims = indexMessageState;</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+      try {</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+        var transaction = ims.server.playTransaction();</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+        // we don't realy care about the transaction </span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+  </span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+        do_check_eq(result, 0);</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+      }</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+      catch (e) {</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+        // If we have an error, clean up nicely before we throw it.</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+        ims.server.stop();</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  </span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+        var thread = gThreadManager.currentThread;</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+        while (thread.hasPendingEvents())</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+          thread.processNextEvent(true);</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+  </span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+        do_throw(e);</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+      }</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+  </span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+      // Let OnStopRunningUrl return cleanly before doing anything else.</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+      //do_timeout(0, &quot;indexMessageState.checkBusy();&quot;);</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+    }</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+  },</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+  </span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+  checkBusy: function() {</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+dump(&quot;~~~~checkBusy\n&quot;);</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+    let ims = indexMessageState;</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+    if (tests.length == 0) {</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+    }</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+  </span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+    // If the server hasn't quite finished, just delay a little longer.</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+    if (ims.incomingServer.serverBusy ||</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+        (ims.incomingServer instanceof Ci.nsIPop3IncomingServer &amp;&amp;</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+         ims.incomingServer.runningProtocol)) {</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+      do_timeout(20, ims.checkBusy);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+      return;</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+    }</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+    </span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+    // if there is more to do, do it</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+    //if (ims.active)</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+    //  driveFakeServer();</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+  }</span>
<a href="#l4.114"></a><span id="l4.114"> };</span>
<a href="#l4.115"></a><span id="l4.115"> </span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+function driveFakeServer() {</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+  let ims = indexMessageState;</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+dump(&quot;&gt;&gt;&gt; enter driveFakeServer\n&quot;);</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+  // Handle the server in a try/catch/finally loop so that we always will stop</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+  // the server if something fails.</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+  try {</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+    if (!(ims.serverStarted)) {</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+      dump(&quot;  starting fake server\n&quot;);</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+      ims.server.start(POP3_PORT);</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+      ims.serverStarted = true;</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+    }</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+    else {</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+      dump(&quot;  resetting fake server\n&quot;);</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+      ims.server.resetTest();</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+    }</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+    </span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+    // Now get the mail</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+    dump(&quot;  issuing GetNewMail\n&quot;);</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+    ims.pop3Service.GetNewMail(null, ims.urlListener, gLocalInboxFolder,</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+                               ims.incomingServer);</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+    dump(&quot;  issuing performTest\n&quot;)</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+    ims.server.performTest();</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+  }</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+  catch (e) {</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+    ims.server.stop();</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+    do_throw(e);</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+  }</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+  finally {</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+    dump(&quot;  draining events\n&quot;);</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+    var thread = gThreadManager.currentThread;</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+    while (thread.hasPendingEvents())</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+      thread.processNextEvent(true);</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+  }</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+dump(&quot;&lt;&lt;&lt; exit driveFakeServer\n&quot;);</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+}</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+function killFakeServer() {</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+  let ims = indexMessageState;</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+  ims.incomingServer.closeCachedConnections();</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+  </span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+  // No more tests, let everything finish</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+  ims.server.stop();</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+  </span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+  var thread = gThreadManager.currentThread;</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+  while (thread.hasPendingEvents())</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+    thread.processNextEvent(true);</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+}</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+</span>
<a href="#l4.165"></a><span id="l4.165"> var messageCollectionListener = {</span>
<a href="#l4.166"></a><span id="l4.166">   onItemsAdded: function(aItems) {</span>
<a href="#l4.167"></a><span id="l4.167">     dump(&quot;onItemsAdded\n&quot;);</span>
<a href="#l4.168"></a><span id="l4.168">     let ims = indexMessageState;</span>
<a href="#l4.169"></a><span id="l4.169">     ims.glodaMessages = ims.glodaMessages.concat(aItems);</span>
<a href="#l4.170"></a><span id="l4.170">   },</span>
<a href="#l4.171"></a><span id="l4.171">   </span>
<a href="#l4.172"></a><span id="l4.172">   onItemsModified: function(aItems) {</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineat">@@ -108,73 +222,105 @@ var messageCollectionListener = {</span>
<a href="#l4.174"></a><span id="l4.174"> };</span>
<a href="#l4.175"></a><span id="l4.175"> </span>
<a href="#l4.176"></a><span id="l4.176"> var messageIndexerListener = {</span>
<a href="#l4.177"></a><span id="l4.177">   onIndexNotification: function(aStatus, aPrettyName, aJobIndex, aJobTotal,</span>
<a href="#l4.178"></a><span id="l4.178">                                 aJobItemIndex, aJobItemGoal) {</span>
<a href="#l4.179"></a><span id="l4.179">     dump(&quot;onIndexNotification\n&quot;);</span>
<a href="#l4.180"></a><span id="l4.180">     // we only care if indexing has just completed...</span>
<a href="#l4.181"></a><span id="l4.181">     if (!GlodaIndexer.indexing) {</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+dump(&quot;  gloda is no longer indexing.\n&quot;);</span>
<a href="#l4.183"></a><span id="l4.183">       let ims = indexMessageState;</span>
<a href="#l4.184"></a><span id="l4.184">       </span>
<a href="#l4.185"></a><span id="l4.185">       // if we haven't seen all the messages we should see, assume that the</span>
<a href="#l4.186"></a><span id="l4.186">       //  rest are on their way, and are just coming in a subsequent job...</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-      if (ims.glodaMessages.length &lt; ims.inputMessages.length)</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+      if (ims.glodaMessages.length &lt; ims.inputMessages.length) {</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+dump(&quot;we wanted &quot; + ims.inputMessages.length + &quot; but have seen &quot; + </span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+     ims.glodaMessages.length + &quot;\n&quot;);</span>
<a href="#l4.191"></a><span id="l4.191">         return;</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+      }</span>
<a href="#l4.193"></a><span id="l4.193">     </span>
<a href="#l4.194"></a><span id="l4.194">       // call the verifier.  (we expect them to generate an exception if the</span>
<a href="#l4.195"></a><span id="l4.195">       //  verification fails, using do_check_*/do_throw; we don't care about</span>
<a href="#l4.196"></a><span id="l4.196">       //  the return value except to propagate forward to subsequent calls.)</span>
<a href="#l4.197"></a><span id="l4.197">       for (let iMessage=0; iMessage &lt; ims.inputMessages; iMessage++) {</span>
<a href="#l4.198"></a><span id="l4.198">         ims.previousValue = ims.verifier(ims.inputMessages[iMessage],</span>
<a href="#l4.199"></a><span id="l4.199">                                          ims.glodaMessages[iMessage],</span>
<a href="#l4.200"></a><span id="l4.200">                                          ims.previousValue);</span>
<a href="#l4.201"></a><span id="l4.201">       }</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineminus">-      </span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+dump(&quot;  calling onDone\n&quot;);</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+      ims.active = false;</span>
<a href="#l4.206"></a><span id="l4.206">       ims.onDone();</span>
<a href="#l4.207"></a><span id="l4.207">     }</span>
<a href="#l4.208"></a><span id="l4.208">   }</span>
<a href="#l4.209"></a><span id="l4.209"> };</span>
<a href="#l4.210"></a><span id="l4.210"> </span>
<a href="#l4.211"></a><span id="l4.211"> /**</span>
<a href="#l4.212"></a><span id="l4.212">  * Given a function that generates a set of synthetic messages, feed those</span>
<a href="#l4.213"></a><span id="l4.213">  *  messages to gloda to be indexed, verifying the resulting indexed messages</span>
<a href="#l4.214"></a><span id="l4.214">  *  have the desired properties by calling the provided verification function.</span>
<a href="#l4.215"></a><span id="l4.215">  * This process is executed once for each possible permutation of observation</span>
<a href="#l4.216"></a><span id="l4.216">  *  of the synthetic messages.  (Well, we cap it; brute-force test your logic</span>
<a href="#l4.217"></a><span id="l4.217">  *  on your own time; you should really only be feeding us minimal scenarios.)</span>
<a href="#l4.218"></a><span id="l4.218">  */</span>
<a href="#l4.219"></a><span id="l4.219"> function indexAndPermuteMessages(aScenarioMaker, aVerifier, aOnDone) {</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-  let firstSet = aScenarioMaker();</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+  let mis = multiIndexState;</span>
<a href="#l4.222"></a><span id="l4.222">   </span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+  mis.queue.push([aScenarioMaker, aVerifier, aOnDone]);</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+  // start processing it immediately if we're not doing anything...</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+  if (!mis.active)</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+    _multiIndexNext();</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+}</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+function _multiIndexNext() {</span>
<a href="#l4.231"></a><span id="l4.231">   let mis = multiIndexState;</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-  mis.scenarioMaker = aScenarioMaker;</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineminus">-  mis.verifier = aVerifier;</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineminus">-  // so, 32 permutations is probably too generous, not to mention an odd choice.</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineminus">-  mis.numPermutations = Math.min(factorial(firstSet.length), 32);</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineminus">-  mis.nextPermutationId = 1;</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+  </span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+  if (mis.queue.length) {</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+    mis.active = true;</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+    </span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+    let [aScenarioMaker, aVerifier, aOnDone] = mis.queue.shift();</span>
<a href="#l4.242"></a><span id="l4.242">   </span>
<a href="#l4.243"></a><span id="l4.243" class="difflineminus">-  indexMessages(firstSet, mis.verifier, _permutationIndexed);</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+    let firstSet = aScenarioMaker();</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+    </span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+    mis.scenarioMaker = aScenarioMaker;</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+    mis.verifier = aVerifier;</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+    // so, 32 permutations is probably too generous, not to mention an odd choice.</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+    mis.numPermutations = Math.min(factorial(firstSet.length), 32);</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+    mis.nextPermutationId = 1;</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+    </span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+    mis.onDone = aOnDone;</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+    </span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+    indexMessages(firstSet, mis.verifier, _permutationIndexed);</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+  }</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+  else {</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+    mis.active = false;</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+    if (mis.onDone)</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+      mis.onDone();</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+  }</span>
<a href="#l4.261"></a><span id="l4.261"> }</span>
<a href="#l4.262"></a><span id="l4.262"> </span>
<a href="#l4.263"></a><span id="l4.263"> function _permutationIndexed() {</span>
<a href="#l4.264"></a><span id="l4.264">   let mis = multiIndexState;</span>
<a href="#l4.265"></a><span id="l4.265">   if (mis.nextPermutationId &lt; mis.numPermutations)</span>
<a href="#l4.266"></a><span id="l4.266">     indexMessages(permute(mis.scenarioMaker(), mis.nextPermutationId++),</span>
<a href="#l4.267"></a><span id="l4.267">                   mis.verifier, _permutationIndexed);</span>
<a href="#l4.268"></a><span id="l4.268">   else</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineminus">-    mis.onDone();</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+    _multiIndexNext();</span>
<a href="#l4.271"></a><span id="l4.271"> }</span>
<a href="#l4.272"></a><span id="l4.272"> </span>
<a href="#l4.273"></a><span id="l4.273"> var multiIndexState = {</span>
<a href="#l4.274"></a><span id="l4.274">   scenarioMaker: null,</span>
<a href="#l4.275"></a><span id="l4.275">   verifier: null,</span>
<a href="#l4.276"></a><span id="l4.276">   onDone: null,</span>
<a href="#l4.277"></a><span id="l4.277">   numPermutations: undefined,</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-  nextPermutationId: undefined</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+  nextPermutationId: undefined,</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+  active: false,</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+  queue: []</span>
<a href="#l4.282"></a><span id="l4.282"> };</span>
<a href="#l4.283"></a><span id="l4.283"> </span>
<a href="#l4.284"></a><span id="l4.284"> function factorial(i, rv) {</span>
<a href="#l4.285"></a><span id="l4.285">   if (i &lt;= 1)</span>
<a href="#l4.286"></a><span id="l4.286">     return rv || 1;</span>
<a href="#l4.287"></a><span id="l4.287">   return factorial(i-1, (rv || 1) * i); // tail-call capable</span>
<a href="#l4.288"></a><span id="l4.288"> }</span>
<a href="#l4.289"></a><span id="l4.289"> </span>
<a href="#l4.290"></a><span id="l4.290" class="difflineat">@@ -184,16 +330,17 @@ function factorial(i, rv) {</span>
<a href="#l4.291"></a><span id="l4.291">  *  at each step.</span>
<a href="#l4.292"></a><span id="l4.292">  *</span>
<a href="#l4.293"></a><span id="l4.293">  * @param aArray Source array that is destructively processed.</span>
<a href="#l4.294"></a><span id="l4.294">  * @param aPermutationId The permutation id.  A permutation id of 0 results in</span>
<a href="#l4.295"></a><span id="l4.295">  *     the original array's sequence being maintained.</span>
<a href="#l4.296"></a><span id="l4.296">  */</span>
<a href="#l4.297"></a><span id="l4.297"> function permute(aArray, aPermutationId) {</span>
<a href="#l4.298"></a><span id="l4.298">   let out = [];</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineminus">-  for (let l=aArray.length; l &gt;= 0; l--) {</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+  for (let l=aArray.length; l &gt; 0; l--) {</span>
<a href="#l4.301"></a><span id="l4.301">     let offset = aPermutationId % l;  </span>
<a href="#l4.302"></a><span id="l4.302">     out.push(aArray[offset]);</span>
<a href="#l4.303"></a><span id="l4.303">     aArray.splice(offset, 1);</span>
<a href="#l4.304"></a><span id="l4.304">     aPermutationId = Math.floor(aPermutationId / l);</span>
<a href="#l4.305"></a><span id="l4.305">   }</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineplus">+dump (&quot;permute returning: &quot; + out + &quot;\n&quot;);</span>
<a href="#l4.307"></a><span id="l4.307">   return out;</span>
<a href="#l4.308"></a><span id="l4.308"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/test/unit/test_index_messages.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/test/unit/test_index_messages.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -18,27 +18,31 @@ function allMessageInSameConversation(aS</span>
<a href="#l5.4"></a><span id="l5.4"> }</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> /**</span>
<a href="#l5.7"></a><span id="l5.7">  * Test our conversation/threading logic.</span>
<a href="#l5.8"></a><span id="l5.8">  */</span>
<a href="#l5.9"></a><span id="l5.9"> function test_threading() {</span>
<a href="#l5.10"></a><span id="l5.10">   indexAndPermuteMessages(scenarios.directReply,</span>
<a href="#l5.11"></a><span id="l5.11">                           allMessageInSameConversation);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+dump(&quot;11111111111111\n&quot;);</span>
<a href="#l5.13"></a><span id="l5.13">   indexAndPermuteMessages(scenarios.missingIntermediary,</span>
<a href="#l5.14"></a><span id="l5.14">                           allMessageInSameConversation);</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+dump(&quot;22222222222222\n&quot;);</span>
<a href="#l5.16"></a><span id="l5.16">   indexAndPermuteMessages(scenarios.siblingsMissingParent,</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-                          allMessageInSameConversation);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+                          allMessageInSameConversation,</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+                          next_test);</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+dump(&quot;33333333333333\n&quot;);</span>
<a href="#l5.21"></a><span id="l5.21"> }</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23"> function test_attributes_fundamental() {</span>
<a href="#l5.24"></a><span id="l5.24">   // create a synthetic message</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-  let smsg = msgGen.newMessage();</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+  let smsg = msgGen.makeMessage();</span>
<a href="#l5.27"></a><span id="l5.27">   </span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-  indexMessages([smsg], verify_attributes_fundamental);</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+  indexMessages([smsg], verify_attributes_fundamental, next_test);</span>
<a href="#l5.30"></a><span id="l5.30"> }</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32"> function verify_attributes_fundamental(smsg, gmsg) {  </span>
<a href="#l5.33"></a><span id="l5.33">   // -- subject</span>
<a href="#l5.34"></a><span id="l5.34">   do_check_eq(smsg.subject, gmsg.conversation.subject);</span>
<a href="#l5.35"></a><span id="l5.35">   </span>
<a href="#l5.36"></a><span id="l5.36">   // -- contact/identity information</span>
<a href="#l5.37"></a><span id="l5.37">   // - from</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineat">@@ -66,30 +70,36 @@ function test_attributes_explicit() {</span>
<a href="#l5.39"></a><span id="l5.39">  */</span>
<a href="#l5.40"></a><span id="l5.40"> function test_message_fulltext() {</span>
<a href="#l5.41"></a><span id="l5.41">   </span>
<a href="#l5.42"></a><span id="l5.42"> }</span>
<a href="#l5.43"></a><span id="l5.43"> </span>
<a href="#l5.44"></a><span id="l5.44"> function test_iterator() {</span>
<a href="#l5.45"></a><span id="l5.45">   do_test_pending();</span>
<a href="#l5.46"></a><span id="l5.46"> </span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+dump(&quot;calling test_threading\n&quot;);</span>
<a href="#l5.48"></a><span id="l5.48">   yield test_threading();</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+dump(&quot;back from test_threading yield\n&quot;);</span>
<a href="#l5.50"></a><span id="l5.50">   yield test_attributes_fundamental();</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+dump (&quot;back from test_attributes_fundamental\n&quot;);</span>
<a href="#l5.52"></a><span id="l5.52">   </span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+  killFakeServer();</span>
<a href="#l5.54"></a><span id="l5.54">   do_test_finished();</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+dump(&quot;!!!!!! TEST FINISHED!\n&quot;);</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+  </span>
<a href="#l5.57"></a><span id="l5.57">   // once the control flow hits the root after do_test_finished, we're done,</span>
<a href="#l5.58"></a><span id="l5.58">   //  so let's just yield something to avoid callers having to deal with an</span>
<a href="#l5.59"></a><span id="l5.59">   //  exception indicating completion.</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+  gTestIterator = null;</span>
<a href="#l5.61"></a><span id="l5.61">   yield null;</span>
<a href="#l5.62"></a><span id="l5.62"> }</span>
<a href="#l5.63"></a><span id="l5.63"> </span>
<a href="#l5.64"></a><span id="l5.64"> var gTestIterator = null;</span>
<a href="#l5.65"></a><span id="l5.65"> </span>
<a href="#l5.66"></a><span id="l5.66"> function next_test() {</span>
<a href="#l5.67"></a><span id="l5.67">   gTestIterator.next();</span>
<a href="#l5.68"></a><span id="l5.68"> }</span>
<a href="#l5.69"></a><span id="l5.69"> </span>
<a href="#l5.70"></a><span id="l5.70"> function run_test() {</span>
<a href="#l5.71"></a><span id="l5.71">   gTestIterator = test_iterator();</span>
<a href="#l5.72"></a><span id="l5.72">   </span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-  do_test_pending();</span>
<a href="#l5.74"></a><span id="l5.74">   next_test();</span>
<a href="#l5.75"></a><span id="l5.75"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

