<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 7359:f07a0f76ac47814bb647af1e73e51425e2d23748</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f07a0f76ac47814bb647af1e73e51425e2d23748" />
<meta property="og:url" content="/comm-central/rev/f07a0f76ac47814bb647af1e73e51425e2d23748" />
<meta property="og:description" content="Bug 641193 - improve fancy mozmill logging, round 2. changes to fancy mozmill logging for better orangestanding v2. r=Standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f07a0f76ac47814bb647af1e73e51425e2d23748 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f07a0f76ac47814bb647af1e73e51425e2d23748">shortlog</a> |
<a href="/comm-central/log/f07a0f76ac47814bb647af1e73e51425e2d23748">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f07a0f76ac47814bb647af1e73e51425e2d23748">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f07a0f76ac47814bb647af1e73e51425e2d23748">files</a> |
changeset |
<a href="/comm-central/raw-rev/f07a0f76ac47814bb647af1e73e51425e2d23748">raw</a>  | <a href="/comm-central/archive/f07a0f76ac47814bb647af1e73e51425e2d23748.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=641193">Bug 641193</a> - improve fancy mozmill logging, round 2. changes to fancy mozmill logging for better orangestanding v2. r=Standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 16 Mar 2011 02:42:18 -0700</td></tr>

<tr>
 <td>changeset 7359</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f07a0f76ac47814bb647af1e73e51425e2d23748">f07a0f76ac47814bb647af1e73e51425e2d23748</a></td>
</tr>



<tr>
<td>parent 7358</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a70e18e2ce570f12923fa95872ef703944bfd575">a70e18e2ce570f12923fa95872ef703944bfd575</a>
</td>
</tr>

<tr>
<td>child 7360</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f21b1a0b5526354135b91983121b0eacba69e715">f21b1a0b5526354135b91983121b0eacba69e715</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f07a0f76ac47814bb647af1e73e51425e2d23748">5639</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Wed, 16 Mar 2011 09:42:37 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f07a0f76ac47 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f07a0f76ac47814bb647af1e73e51425e2d23748">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f07a0f76ac47814bb647af1e73e51425e2d23748&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f07a0f76ac47814bb647af1e73e51425e2d23748&newProject=comm-central&newRevision=f07a0f76ac47814bb647af1e73e51425e2d23748&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f07a0f76ac47814bb647af1e73e51425e2d23748&newProject=comm-central&newRevision=f07a0f76ac47814bb647af1e73e51425e2d23748&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f07a0f76ac47814bb647af1e73e51425e2d23748&newProject=comm-central&newRevision=f07a0f76ac47814bb647af1e73e51425e2d23748&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=641193">641193</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=641193">Bug 641193</a> - improve fancy mozmill logging, round 2. changes to fancy mozmill logging for better orangestanding v2. r=Standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f07a0f76ac47814bb647af1e73e51425e2d23748/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f07a0f76ac47814bb647af1e73e51425e2d23748/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/f07a0f76ac47814bb647af1e73e51425e2d23748/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/f07a0f76ac47814bb647af1e73e51425e2d23748/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/f07a0f76ac47814bb647af1e73e51425e2d23748/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/f07a0f76ac47814bb647af1e73e51425e2d23748/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f07a0f76ac47814bb647af1e73e51425e2d23748/mail/test/mozmill/shared-modules/test-window-helpers.js">mail/test/mozmill/shared-modules/test-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f07a0f76ac47814bb647af1e73e51425e2d23748/mail/test/mozmill/shared-modules/test-window-helpers.js">file</a> |
<a href="/comm-central/annotate/f07a0f76ac47814bb647af1e73e51425e2d23748/mail/test/mozmill/shared-modules/test-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/f07a0f76ac47814bb647af1e73e51425e2d23748/mail/test/mozmill/shared-modules/test-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/f07a0f76ac47814bb647af1e73e51425e2d23748/mail/test/mozmill/shared-modules/test-window-helpers.js">comparison</a> |
<a href="/comm-central/log/f07a0f76ac47814bb647af1e73e51425e2d23748/mail/test/mozmill/shared-modules/test-window-helpers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -174,17 +174,17 @@ function setupModule() {</span>
<a href="#l1.4"></a><span id="l1.4">   // Listen for setTest so we can change buckets and generate logHelper test</span>
<a href="#l1.5"></a><span id="l1.5">   //  begin/end notifications.</span>
<a href="#l1.6"></a><span id="l1.6">   frame.events.addListener(&quot;setTest&quot;, function(obj) {</span>
<a href="#l1.7"></a><span id="l1.7">       // ignore setupModule and teardownModule</span>
<a href="#l1.8"></a><span id="l1.8">       if (obj.name == &quot;setupModule&quot; ||</span>
<a href="#l1.9"></a><span id="l1.9">           obj.name == &quot;teardownModule&quot;)</span>
<a href="#l1.10"></a><span id="l1.10">         return;</span>
<a href="#l1.11"></a><span id="l1.11">       if (obj.filename != curTestFile) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-        testHelperModule.mark_test_end();  </span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+        testHelperModule.mark_test_end();</span>
<a href="#l1.14"></a><span id="l1.14">         bucketAppender.newBucket();</span>
<a href="#l1.15"></a><span id="l1.15">         testHelperModule.mark_test_start(obj.filename);</span>
<a href="#l1.16"></a><span id="l1.16">         curTestFile = obj.filename;</span>
<a href="#l1.17"></a><span id="l1.17">       }</span>
<a href="#l1.18"></a><span id="l1.18">       else {</span>
<a href="#l1.19"></a><span id="l1.19">         testHelperModule.mark_test_end(1);</span>
<a href="#l1.20"></a><span id="l1.20">         bucketAppender.newBucket();</span>
<a href="#l1.21"></a><span id="l1.21">       }</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -1447,17 +1447,17 @@ function plan_for_message_display(aContr</span>
<a href="#l1.23"></a><span id="l1.23">  *     be loaded?  You should use this in conjunction with</span>
<a href="#l1.24"></a><span id="l1.24">  *     |plan_for_message_display| as per the documentation above.  If you do</span>
<a href="#l1.25"></a><span id="l1.25">  *     not pass true and there is no message load in process, this method will</span>
<a href="#l1.26"></a><span id="l1.26">  *     return immediately.</span>
<a href="#l1.27"></a><span id="l1.27">  */</span>
<a href="#l1.28"></a><span id="l1.28"> function wait_for_message_display_completion(aController, aLoadDemanded) {</span>
<a href="#l1.29"></a><span id="l1.29">   if (aController == null)</span>
<a href="#l1.30"></a><span id="l1.30">     aController = mc;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-  mark_action(&quot;fdh&quot;, &quot;wait_for_message_display_completion&quot;, []);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+  mark_action(&quot;fdhb&quot;, &quot;wait_for_message_display_completion&quot;, []);</span>
<a href="#l1.33"></a><span id="l1.33">   let contentPane = aController.contentPane;</span>
<a href="#l1.34"></a><span id="l1.34">   let oldHref = null;</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36">   // There are a couple possible states the universe can be in:</span>
<a href="#l1.37"></a><span id="l1.37">   // 1) No message load happened or is going to happen.</span>
<a href="#l1.38"></a><span id="l1.38">   // 2) The only message load that is going to happened has happened.</span>
<a href="#l1.39"></a><span id="l1.39">   // 3) A message load is happening right now.</span>
<a href="#l1.40"></a><span id="l1.40">   // 4) A message load should happen in the near future.</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineat">@@ -1490,17 +1490,17 @@ function wait_for_message_display_comple</span>
<a href="#l1.42"></a><span id="l1.42">     return !docShell.busyFlags;</span>
<a href="#l1.43"></a><span id="l1.43">   };</span>
<a href="#l1.44"></a><span id="l1.44">   if (!controller.waitForEval('subject()', NORMAL_TIMEOUT, FAST_INTERVAL,</span>
<a href="#l1.45"></a><span id="l1.45">                               isLoadedChecker))</span>
<a href="#l1.46"></a><span id="l1.46">     mark_failure([&quot;Timed out waiting for message display completion.&quot;]);</span>
<a href="#l1.47"></a><span id="l1.47">   // the above may return immediately, meaning the event queue might not get a</span>
<a href="#l1.48"></a><span id="l1.48">   //  chance.  give it a chance now.</span>
<a href="#l1.49"></a><span id="l1.49">   aController.sleep(0);</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-  mark_action(&quot;fdh&quot;, &quot;/wait_for_message_display_completion&quot;, []);</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  mark_action(&quot;fdhb&quot;, &quot;/wait_for_message_display_completion&quot;, []);</span>
<a href="#l1.52"></a><span id="l1.52"> }</span>
<a href="#l1.53"></a><span id="l1.53"> </span>
<a href="#l1.54"></a><span id="l1.54"> /**</span>
<a href="#l1.55"></a><span id="l1.55">  * Wait for the content pane to be blank because no message is to be displayed.</span>
<a href="#l1.56"></a><span id="l1.56">  * You would not want to call this once folder summaries land and if they are</span>
<a href="#l1.57"></a><span id="l1.57">  *  enabled.</span>
<a href="#l1.58"></a><span id="l1.58">  *</span>
<a href="#l1.59"></a><span id="l1.59">  * @param aController optional controller, defaulting to |mc|.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -127,32 +127,32 @@ function installInto(module) {</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">   module.augment_controller = augment_controller;</span>
<a href="#l2.6"></a><span id="l2.6"> }</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> /**</span>
<a href="#l2.9"></a><span id="l2.9">  * Return the &quot;windowtype&quot; or &quot;id&quot; for the given xul window if it is available.</span>
<a href="#l2.10"></a><span id="l2.10">  * If not, return null.</span>
<a href="#l2.11"></a><span id="l2.11">  */</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-function getWindowTypeForXulWindow(aXULWindow) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+function getWindowTypeForXulWindow(aXULWindow, aBusyOk) {</span>
<a href="#l2.14"></a><span id="l2.14">   // Sometimes we are given HTML windows, for which the logic below will</span>
<a href="#l2.15"></a><span id="l2.15">   //  bail.  So we use a fast-path here that should work for HTML and should</span>
<a href="#l2.16"></a><span id="l2.16">   //  maybe also work with XUL.  I'm not going to go into it...</span>
<a href="#l2.17"></a><span id="l2.17">   if (aXULWindow.document &amp;&amp;</span>
<a href="#l2.18"></a><span id="l2.18">       aXULWindow.document.documentElement &amp;&amp;</span>
<a href="#l2.19"></a><span id="l2.19">       aXULWindow.document.documentElement.hasAttribute(&quot;windowtype&quot;))</span>
<a href="#l2.20"></a><span id="l2.20">     return aXULWindow.document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22">   let docshell = aXULWindow.docShell;</span>
<a href="#l2.23"></a><span id="l2.23">   // we need the docshell to exist...</span>
<a href="#l2.24"></a><span id="l2.24">   if (!docshell)</span>
<a href="#l2.25"></a><span id="l2.25">     return null;</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27">   // we can't know if it's the right document until it's not busy</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-  if (docshell.busyFlags)</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+  if (!aBusyOk &amp;&amp; docshell.busyFlags)</span>
<a href="#l2.30"></a><span id="l2.30">     return null;</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32">   // it also needs to have content loaded (it starts out not busy with no</span>
<a href="#l2.33"></a><span id="l2.33">   //  content viewer.)</span>
<a href="#l2.34"></a><span id="l2.34">   if (docshell.contentViewer == null)</span>
<a href="#l2.35"></a><span id="l2.35">     return null;</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37">   // now we're cooking! let's get the document...</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineat">@@ -162,16 +162,53 @@ function getWindowTypeForXulWindow(aXULW</span>
<a href="#l2.39"></a><span id="l2.39">     return null;</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41">   // finally, we can now have a windowtype!</span>
<a href="#l2.42"></a><span id="l2.42">   let windowType = outerDoc.documentElement.getAttribute(&quot;windowtype&quot;) ||</span>
<a href="#l2.43"></a><span id="l2.43">                    outerDoc.documentElement.getAttribute(&quot;id&quot;);</span>
<a href="#l2.44"></a><span id="l2.44">   return windowType;</span>
<a href="#l2.45"></a><span id="l2.45"> }</span>
<a href="#l2.46"></a><span id="l2.46"> </span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+/**</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+ * Return the unique id we annotated onto this XUL window during</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+ *  augment_controller.</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+ */</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+function getUniqueIdForXulWindow(aXULWindow) {</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  // html case</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+  if (aXULWindow.document &amp;&amp;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+      aXULWindow.document.documentElement) {</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+    if (!(UNIQUE_WINDOW_ID_ATTR in aXULWindow.document.defaultView))</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+      return &quot;no attr html&quot;;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+    return aXULWindow.document.defaultView[UNIQUE_WINDOW_ID_ATTR];</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+  }</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+  // XUL case</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+  let docshell = aXULWindow.docShell;</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+  // we need the docshell to exist...</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+  if (!docshell)</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+    return &quot;no docshell&quot;;</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  // it also needs to have content loaded (it starts out not busy with no</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+  //  content viewer.)</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  if (docshell.contentViewer == null)</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+    return &quot;no contentViewer&quot;;</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+  // now we're cooking! let's get the document...</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+  let outerDoc = docshell.contentViewer.DOMDocument;</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+  // and make sure it's not blank.  that's also an intermediate state.</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+  if (outerDoc.location.href == &quot;about:blank&quot;)</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+    return &quot;about:blank&quot;;</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+  // finally, we can now have a windowtype!</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+  let win = outerDoc.defaultView;</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+  if (UNIQUE_WINDOW_ID_ATTR in win)</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+    return win[UNIQUE_WINDOW_ID_ATTR];</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+  return &quot;no attr xul&quot;;</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+}</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+</span>
<a href="#l2.84"></a><span id="l2.84"> var WindowWatcher = {</span>
<a href="#l2.85"></a><span id="l2.85">   _inited: false,</span>
<a href="#l2.86"></a><span id="l2.86">   _firstWindowOpened: false,</span>
<a href="#l2.87"></a><span id="l2.87">   ensureInited: function WindowWatcher_ensureInited() {</span>
<a href="#l2.88"></a><span id="l2.88">     if (this._inited)</span>
<a href="#l2.89"></a><span id="l2.89">       return;</span>
<a href="#l2.90"></a><span id="l2.90"> </span>
<a href="#l2.91"></a><span id="l2.91">     // Add ourselves as an nsIWindowMediatorListener so we can here about when</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineat">@@ -373,17 +410,18 @@ var WindowWatcher = {</span>
<a href="#l2.93"></a><span id="l2.93">   /**</span>
<a href="#l2.94"></a><span id="l2.94">    * This notification gets called when windows tell the widnow mediator when</span>
<a href="#l2.95"></a><span id="l2.95">    *  the window title gets changed.  In theory, we could use this to be</span>
<a href="#l2.96"></a><span id="l2.96">    *  event driven with less polling (effort), but it is not to be.</span>
<a href="#l2.97"></a><span id="l2.97">    */</span>
<a href="#l2.98"></a><span id="l2.98">   onWindowTitleChange: function WindowWatcher_onWindowTitleChange(</span>
<a href="#l2.99"></a><span id="l2.99">       aXULWindow, aNewTitle) {</span>
<a href="#l2.100"></a><span id="l2.100">     mark_action(&quot;winhelp&quot;, &quot;onWindowTitleChange&quot;,</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-                [aXULWindow.toString(), getWindowTypeForXulWindow(aXULWindow),</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+                [getWindowTypeForXulWindow(aXULWindow, true) +</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+                   &quot; (&quot; + getUniqueIdForXulWindow(aXULWindow) + &quot;)&quot;,</span>
<a href="#l2.104"></a><span id="l2.104">                  &quot;changed title to&quot;, aNewTitle]);</span>
<a href="#l2.105"></a><span id="l2.105">   },</span>
<a href="#l2.106"></a><span id="l2.106"> </span>
<a href="#l2.107"></a><span id="l2.107">   /**</span>
<a href="#l2.108"></a><span id="l2.108">    * Used by waitForWindowOpen to check all of the windows we are monitoring and</span>
<a href="#l2.109"></a><span id="l2.109">    *  then check if we have any results.</span>
<a href="#l2.110"></a><span id="l2.110">    *</span>
<a href="#l2.111"></a><span id="l2.111">    * @return true if we found what we were |waitingForOpen|, false otherwise.</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineat">@@ -422,21 +460,29 @@ var WindowWatcher = {</span>
<a href="#l2.113"></a><span id="l2.113">   },</span>
<a href="#l2.114"></a><span id="l2.114"> </span>
<a href="#l2.115"></a><span id="l2.115">   /**</span>
<a href="#l2.116"></a><span id="l2.116">    * nsIWindowMediatorListener notification that a XUL window was opened.  We</span>
<a href="#l2.117"></a><span id="l2.117">    *  check out the window, and if we were not able to fully consider it, we</span>
<a href="#l2.118"></a><span id="l2.118">    *  add it to our monitoring list.</span>
<a href="#l2.119"></a><span id="l2.119">    */</span>
<a href="#l2.120"></a><span id="l2.120">   onOpenWindow: function WindowWatcher_onOpenWindow(aXULWindow) {</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+    // note: we would love to add our window activation/deactivation listeners</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+    //  and poke our unique id, but there is no contentViewer at this point</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+    //  and so there's no place to poke our unique id.  (aXULWindow does not</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+    //  let us put expandos on; it's an XPCWrappedNative and explodes.)</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+    // There may be nuances about outer window/inner window that make it</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+    //  feasible, but I have forgotten any such nuances I once knew.</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+</span>
<a href="#l2.128"></a><span id="l2.128">     // It would be great to be able to indicate if the window is modal or not,</span>
<a href="#l2.129"></a><span id="l2.129">     //  but nothing is really jumping out at me to enable that...</span>
<a href="#l2.130"></a><span id="l2.130">     mark_action(&quot;winhelp&quot;, &quot;onOpenWindow&quot;,</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-                [aXULWindow.toString(),</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-                 &quot;window type&quot;, getWindowTypeForXulWindow(aXULWindow)]);</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+                [getWindowTypeForXulWindow(aXULWindow, true) +</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+                   &quot; (&quot; + getUniqueIdForXulWindow(aXULWindow) + &quot;)&quot;,</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+                   &quot;active?&quot;, focusManager.focusedWindow == aXULWindow]);</span>
<a href="#l2.136"></a><span id="l2.136">     if (!this.consider(aXULWindow))</span>
<a href="#l2.137"></a><span id="l2.137">       this.monitorWindowLoad(aXULWindow);</span>
<a href="#l2.138"></a><span id="l2.138">   },</span>
<a href="#l2.139"></a><span id="l2.139"> </span>
<a href="#l2.140"></a><span id="l2.140">   /**</span>
<a href="#l2.141"></a><span id="l2.141">    * Consider if the given window is something in our |waitingList|.</span>
<a href="#l2.142"></a><span id="l2.142">    *</span>
<a href="#l2.143"></a><span id="l2.143">    * @return true if we were able to fully consider the object, false if we were</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineat">@@ -463,17 +509,18 @@ var WindowWatcher = {</span>
<a href="#l2.145"></a><span id="l2.145">    */</span>
<a href="#l2.146"></a><span id="l2.146">   onCloseWindow: function WindowWatcher_onCloseWindow(aXULWindow) {</span>
<a href="#l2.147"></a><span id="l2.147">     let domWindow = aXULWindow.docShell.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l2.148"></a><span id="l2.148">                                        .getInterface(Ci.nsIDOMWindowInternal);</span>
<a href="#l2.149"></a><span id="l2.149">     let windowType =</span>
<a href="#l2.150"></a><span id="l2.150">       domWindow.document.documentElement.getAttribute(&quot;windowtype&quot;) ||</span>
<a href="#l2.151"></a><span id="l2.151">       domWindow.document.documentElement.getAttribute(&quot;id&quot;);</span>
<a href="#l2.152"></a><span id="l2.152">     mark_action(&quot;winhelp&quot;, &quot;onCloseWindow&quot;,</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-                [aXULWindow.toString(), &quot;window type&quot;, windowType]);</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+                [getWindowTypeForXulWindow(aXULWindow, true) +</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+                   &quot; (&quot; + getUniqueIdForXulWindow(aXULWindow) + &quot;)&quot;]);</span>
<a href="#l2.156"></a><span id="l2.156">     // XXX because of how we dance with things, equivalence is not gonna</span>
<a href="#l2.157"></a><span id="l2.157">     //  happen for us.  This is most pragmatic.</span>
<a href="#l2.158"></a><span id="l2.158">     if (this.waitingList[windowType] !== null)</span>
<a href="#l2.159"></a><span id="l2.159">       this.waitingList[windowType] = null;</span>
<a href="#l2.160"></a><span id="l2.160">   },</span>
<a href="#l2.161"></a><span id="l2.161"> };</span>
<a href="#l2.162"></a><span id="l2.162"> </span>
<a href="#l2.163"></a><span id="l2.163"> /**</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineat">@@ -528,17 +575,17 @@ function plan_for_new_window(aWindowType</span>
<a href="#l2.165"></a><span id="l2.165"> function wait_for_new_window(aWindowType) {</span>
<a href="#l2.166"></a><span id="l2.166">   mark_action(&quot;fdh&quot;, &quot;wait_for_new_window&quot;, [aWindowType]);</span>
<a href="#l2.167"></a><span id="l2.167">   let c = augment_controller(WindowWatcher.waitForWindowOpen(aWindowType),</span>
<a href="#l2.168"></a><span id="l2.168">                              aWindowType);</span>
<a href="#l2.169"></a><span id="l2.169">   // A nested event loop can get spun inside the Controller's constructor</span>
<a href="#l2.170"></a><span id="l2.170">   //  (which is arguably not a great idea), so it's important that we denote</span>
<a href="#l2.171"></a><span id="l2.171">   //  when we're actually leaving this function in case something crazy</span>
<a href="#l2.172"></a><span id="l2.172">   //  happens.</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-  mark_action(&quot;fdh&quot;, &quot;/wait_for_new_window&quot;, [aWindowType]);</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+  mark_action(&quot;fdhb&quot;, &quot;/wait_for_new_window&quot;, [aWindowType]);</span>
<a href="#l2.175"></a><span id="l2.175">   return c;</span>
<a href="#l2.176"></a><span id="l2.176"> }</span>
<a href="#l2.177"></a><span id="l2.177"> </span>
<a href="#l2.178"></a><span id="l2.178"> /**</span>
<a href="#l2.179"></a><span id="l2.179">  * Plan for the imminent display of a modal dialog.  Modal dialogs spin their</span>
<a href="#l2.180"></a><span id="l2.180">  *  own event loop which means that either that control flow will not return</span>
<a href="#l2.181"></a><span id="l2.181">  *  to the caller until the modal dialog finishes running.  This means that</span>
<a href="#l2.182"></a><span id="l2.182">  *  you need to provide a sub-test function to be run inside the modal dialog</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineat">@@ -560,30 +607,30 @@ function plan_for_modal_dialog(aWindowTy</span>
<a href="#l2.184"></a><span id="l2.184">  * In case the dialog might be stuck for a long time, you can pass an optional</span>
<a href="#l2.185"></a><span id="l2.185">  *  timeout.</span>
<a href="#l2.186"></a><span id="l2.186">  *</span>
<a href="#l2.187"></a><span id="l2.187">  * @param aTimeout Your custom timeout (default is WINDOW_OPEN_TIMEOUT_MS)</span>
<a href="#l2.188"></a><span id="l2.188">  */</span>
<a href="#l2.189"></a><span id="l2.189"> function wait_for_modal_dialog(aWindowType, aTimeout) {</span>
<a href="#l2.190"></a><span id="l2.190">   mark_action(&quot;fdh&quot;, &quot;wait_for_modal_dialog&quot;, [aWindowType, aTimeout]);</span>
<a href="#l2.191"></a><span id="l2.191">   WindowWatcher.waitForModalDialog(aWindowType, aTimeout);</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineminus">-  mark_action(&quot;fdh&quot;, &quot;/wait_for_modal_dialog&quot;, [aWindowType, aTimeout]);</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+  mark_action(&quot;fdhb&quot;, &quot;/wait_for_modal_dialog&quot;, [aWindowType, aTimeout]);</span>
<a href="#l2.194"></a><span id="l2.194"> }</span>
<a href="#l2.195"></a><span id="l2.195"> </span>
<a href="#l2.196"></a><span id="l2.196"> /**</span>
<a href="#l2.197"></a><span id="l2.197">  * Call this just before you trigger the event that will cause the provided</span>
<a href="#l2.198"></a><span id="l2.198">  *  controller's window to disappear.  You then follow this with a call to</span>
<a href="#l2.199"></a><span id="l2.199">  *  |wait_for_window_close| when you want to block on verifying the close.</span>
<a href="#l2.200"></a><span id="l2.200">  *</span>
<a href="#l2.201"></a><span id="l2.201">  * @param aController The MozmillController, potentially returned from a call to</span>
<a href="#l2.202"></a><span id="l2.202">  *     wait_for_new_window, whose window should be disappearing.</span>
<a href="#l2.203"></a><span id="l2.203">  */</span>
<a href="#l2.204"></a><span id="l2.204"> function plan_for_window_close(aController) {</span>
<a href="#l2.205"></a><span id="l2.205">   mark_action(&quot;fdh&quot;, &quot;plan_for_window_close&quot;,</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-              [getWindowTypeForXulWindow(aController.window)]);</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+              [getWindowTypeForXulWindow(aController.window, true)]);</span>
<a href="#l2.208"></a><span id="l2.208">   WindowWatcher.ensureInited();</span>
<a href="#l2.209"></a><span id="l2.209">   WindowWatcher.planForWindowClose(aController.window);</span>
<a href="#l2.210"></a><span id="l2.210"> }</span>
<a href="#l2.211"></a><span id="l2.211"> </span>
<a href="#l2.212"></a><span id="l2.212"> /**</span>
<a href="#l2.213"></a><span id="l2.213">  * Wait for the closure of the window you noted you would listen for its close</span>
<a href="#l2.214"></a><span id="l2.214">  *  in plan_for_window_close.</span>
<a href="#l2.215"></a><span id="l2.215">  */</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineat">@@ -1131,51 +1178,120 @@ function _augment_helper(aController, aA</span>
<a href="#l2.217"></a><span id="l2.217"> </span>
<a href="#l2.218"></a><span id="l2.218">   if (aAugmentDef.onAugment) {</span>
<a href="#l2.219"></a><span id="l2.219">     aAugmentDef.onAugment(aController);</span>
<a href="#l2.220"></a><span id="l2.220">   }</span>
<a href="#l2.221"></a><span id="l2.221"> }</span>
<a href="#l2.222"></a><span id="l2.222"> </span>
<a href="#l2.223"></a><span id="l2.223"> var INPUT_PEEK_EVENTS = [&quot;click&quot;, &quot;keypress&quot;];</span>
<a href="#l2.224"></a><span id="l2.224"> </span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+var UNIQUE_WINDOW_ID_ATTR = &quot;__winHelper_uniqueId&quot;;</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+var DOM_KEYCODE_TO_NAME = {};</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+function populateDomKeycodeMap() {</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+  let nsIDOMKeyEvent = Ci.nsIDOMKeyEvent;</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+  let re_dom_vk = /^DOM_VK_/;</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineplus">+  for (let key in nsIDOMKeyEvent) {</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineplus">+    </span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+    if (re_dom_vk.test(key)) {</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+      let val = nsIDOMKeyEvent[key];</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+      DOM_KEYCODE_TO_NAME[val] = key;</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+    }</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+  }</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+}</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+populateDomKeycodeMap();</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+/**</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+ * Given an event, provide a uniquely identifying string that usefully</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+ *  identifies the window.  We do this by getting the windowtype (an ad hoc</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+ *  attribute on the document element) if available, or the id on the document</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+ *  element if there was no windowtype.  (Experience has shown these to be</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+ *  always present).  Additionally, we annotated a unique counter value onto</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+ *  the window at augmentation time, and so we tack that on to be able to</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+ *  tell the difference between otherwise similar windows.</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+ */</span>
<a href="#l2.251"></a><span id="l2.251"> function getWindowDescribeyFromEvent(event) {</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-  var win = event.target.ownerDocument.defaultView;</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+  var target = event.target;</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+  // assume it's a window if there's no ownerDocument attribute</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+  var win = (&quot;ownerDocument&quot; in target) ? target.ownerDocument.defaultView</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+                                        : target;</span>
<a href="#l2.257"></a><span id="l2.257">   var owningWin =</span>
<a href="#l2.258"></a><span id="l2.258">     win.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l2.259"></a><span id="l2.259">        .getInterface(Ci.nsIWebNavigation)</span>
<a href="#l2.260"></a><span id="l2.260">        .QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l2.261"></a><span id="l2.261">        .rootTreeItem</span>
<a href="#l2.262"></a><span id="l2.262">        .QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l2.263"></a><span id="l2.263">        .getInterface(Ci.nsIDOMWindow);</span>
<a href="#l2.264"></a><span id="l2.264">   var docElem = owningWin.document.documentElement;</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-  return docElem.getAttribute(&quot;windowtype&quot;) ||</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-         docElem.getAttribute(&quot;id&quot;);</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineplus">+  return (docElem.getAttribute(&quot;windowtype&quot;) ||</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineplus">+          docElem.getAttribute(&quot;id&quot;) || &quot;mysterious&quot;) +</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineplus">+         &quot; (&quot; + (UNIQUE_WINDOW_ID_ATTR in win ? win[UNIQUE_WINDOW_ID_ATTR] :</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+                 &quot;n/a&quot;) + &quot;)&quot;;</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+}</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineplus">+function __peek_activate_handler(event) {</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+  mark_action(&quot;winhelp&quot;, event.type,</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+              [getWindowDescribeyFromEvent(event)]);</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineplus">+  return true;</span>
<a href="#l2.277"></a><span id="l2.277"> }</span>
<a href="#l2.278"></a><span id="l2.278"> </span>
<a href="#l2.279"></a><span id="l2.279"> function __peek_click_handler(event) {</span>
<a href="#l2.280"></a><span id="l2.280">   mark_action(&quot;winhelp&quot;, event.type,</span>
<a href="#l2.281"></a><span id="l2.281">               [&quot;mouse button&quot;, event.button,</span>
<a href="#l2.282"></a><span id="l2.282">                &quot;target:&quot;, normalize_for_json(event.target),</span>
<a href="#l2.283"></a><span id="l2.283">                &quot;in&quot;, getWindowDescribeyFromEvent(event),</span>
<a href="#l2.284"></a><span id="l2.284">                &quot;original target:&quot;, normalize_for_json(event.originalTarget)]);</span>
<a href="#l2.285"></a><span id="l2.285">   return true;</span>
<a href="#l2.286"></a><span id="l2.286"> }</span>
<a href="#l2.287"></a><span id="l2.287"> </span>
<a href="#l2.288"></a><span id="l2.288"> function __bubbled_click_handler(event) {</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-  mark_action(&quot;winhelp&quot;, &quot;bubbled &quot; + event.type,</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+  mark_action(&quot;winhelpb&quot;, &quot;bubbled &quot; + event.type,</span>
<a href="#l2.291"></a><span id="l2.291">               [&quot;mouse button&quot;, event.button,</span>
<a href="#l2.292"></a><span id="l2.292">                &quot;target:&quot;, normalize_for_json(event.target),</span>
<a href="#l2.293"></a><span id="l2.293">                &quot;in&quot;, getWindowDescribeyFromEvent(event),</span>
<a href="#l2.294"></a><span id="l2.294">                &quot;original target:&quot;, normalize_for_json(event.originalTarget)]);</span>
<a href="#l2.295"></a><span id="l2.295">   return true;</span>
<a href="#l2.296"></a><span id="l2.296"> }</span>
<a href="#l2.297"></a><span id="l2.297"> </span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+function describeKeyEvent(event) {</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+  let s;</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+  if (event.keyCode) {</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+    s = DOM_KEYCODE_TO_NAME[event.keyCode];</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+  }</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+  else if (event.charCode) {</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineplus">+    s = &quot;'&quot; + String.fromCharCode(event.charCode) + &quot;'&quot;;</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineplus">+  }</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineplus">+  else {</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineplus">+    s = &quot;no keyCode/charCode?&quot;;</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+  }</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+  if (event.shiftKey)</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+    s = &quot;shift-&quot; + s;</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+  if (event.ctrlKey)</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+    s = &quot;ctrl-&quot;; + s</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+  if (event.altKey)</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+    s = &quot;alt-&quot; + s;</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineplus">+  if (event.metaKey)</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+    s = &quot;meta-&quot; + s;</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineplus">+  return s;</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineplus">+}</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineplus">+</span>
<a href="#l2.322"></a><span id="l2.322"> function __peek_keypress_handler(event) {</span>
<a href="#l2.323"></a><span id="l2.323">   mark_action(&quot;winhelp&quot;, event.type,</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineminus">-              [&quot;keycode&quot;, event.keyCode, &quot;char&quot;, event.charCode,</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+              [describeKeyEvent(event),</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+               &quot;target:&quot;, normalize_for_json(event.target),</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineplus">+               &quot;in&quot;, getWindowDescribeyFromEvent(event)]);</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineplus">+  return true;</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineplus">+}</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineplus">+</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+function __bubbled_keypress_handler(event) {</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+  mark_action(&quot;winhelpb&quot;, &quot;bubbled &quot; + event.type,</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+              [describeKeyEvent(event),</span>
<a href="#l2.334"></a><span id="l2.334">                &quot;target:&quot;, normalize_for_json(event.target),</span>
<a href="#l2.335"></a><span id="l2.335">                &quot;in&quot;, getWindowDescribeyFromEvent(event)]);</span>
<a href="#l2.336"></a><span id="l2.336">   return true;</span>
<a href="#l2.337"></a><span id="l2.337"> }</span>
<a href="#l2.338"></a><span id="l2.338"> </span>
<a href="#l2.339"></a><span id="l2.339"> </span>
<a href="#l2.340"></a><span id="l2.340"> function __popup_showing(event) {</span>
<a href="#l2.341"></a><span id="l2.341">   mark_action(&quot;winhelp&quot;, &quot;popupShowing&quot;,</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineat">@@ -1204,48 +1320,63 @@ function __popup_hiding(event) {</span>
<a href="#l2.343"></a><span id="l2.343"> function __popup_hidden(event) {</span>
<a href="#l2.344"></a><span id="l2.344">   mark_action(&quot;winhelp&quot;, &quot;popupHidden&quot;,</span>
<a href="#l2.345"></a><span id="l2.345">               [this,</span>
<a href="#l2.346"></a><span id="l2.346">                &quot;target:&quot;, normalize_for_json(event.target),</span>
<a href="#l2.347"></a><span id="l2.347">                &quot;current target:&quot;, normalize_for_json(event.target)]);</span>
<a href="#l2.348"></a><span id="l2.348">   return true;</span>
<a href="#l2.349"></a><span id="l2.349"> }</span>
<a href="#l2.350"></a><span id="l2.350"> </span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+var gNextOneUpUniqueID = 0;</span>
<a href="#l2.352"></a><span id="l2.352"> </span>
<a href="#l2.353"></a><span id="l2.353"> /**</span>
<a href="#l2.354"></a><span id="l2.354">  * controller.js in mozmill actually has its own extension mechanism,</span>
<a href="#l2.355"></a><span id="l2.355">  *  controllerAdditions.  Unfortunately, it does not make its stuff public at</span>
<a href="#l2.356"></a><span id="l2.356">  *  this time.  In the future we can change ourselves to just use that</span>
<a href="#l2.357"></a><span id="l2.357">  *  mechanism.</span>
<a href="#l2.358"></a><span id="l2.358">  */</span>
<a href="#l2.359"></a><span id="l2.359"> function augment_controller(aController, aWindowType) {</span>
<a href="#l2.360"></a><span id="l2.360">   if (aWindowType === undefined)</span>
<a href="#l2.361"></a><span id="l2.361">     aWindowType =</span>
<a href="#l2.362"></a><span id="l2.362">       aController.window.document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l2.363"></a><span id="l2.363"> </span>
<a href="#l2.364"></a><span id="l2.364">   _augment_helper(aController, AugmentEverybodyWith);</span>
<a href="#l2.365"></a><span id="l2.365">   if (PerWindowTypeAugmentations[aWindowType])</span>
<a href="#l2.366"></a><span id="l2.366">     _augment_helper(aController, PerWindowTypeAugmentations[aWindowType]);</span>
<a href="#l2.367"></a><span id="l2.367"> </span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-  // for debugging purposes, add our listener that sneaks a peek at clicks and</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-  //  key events</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineplus">+  // Add a bunch of listeners to generate mark_action events to provide</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineplus">+  //  context for what is actually going on.</span>
<a href="#l2.372"></a><span id="l2.372">   try {</span>
<a href="#l2.373"></a><span id="l2.373">     let doc = aController.window.document;</span>
<a href="#l2.374"></a><span id="l2.374"> </span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+    aController.window[UNIQUE_WINDOW_ID_ATTR] = gNextOneUpUniqueID++;</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineplus">+    // - window activation / deactivation</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+    aController.window.addEventListener(&quot;activate&quot;, __peek_activate_handler,</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+                                        true);</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+    aController.window.addEventListener(&quot;deactivate&quot;, __peek_activate_handler,</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineplus">+                                        true);</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineplus">+</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineplus">+    // - capturing listeners</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+    // (so we can see the start of the event)</span>
<a href="#l2.385"></a><span id="l2.385">     doc.addEventListener(&quot;mousedown&quot;, __peek_click_handler, true);</span>
<a href="#l2.386"></a><span id="l2.386">     doc.addEventListener(&quot;click&quot;, __peek_click_handler, true);</span>
<a href="#l2.387"></a><span id="l2.387">     doc.addEventListener(&quot;contextmenu&quot;, __peek_click_handler, true);</span>
<a href="#l2.388"></a><span id="l2.388">     doc.addEventListener(&quot;mouseup&quot;, __peek_click_handler, true);</span>
<a href="#l2.389"></a><span id="l2.389"> </span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+    doc.addEventListener(&quot;keypress&quot;, __peek_keypress_handler, true);</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineplus">+</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineplus">+    // - bubbling listeners</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+    // (so we can see if the event got killed / eaten)</span>
<a href="#l2.394"></a><span id="l2.394">     doc.addEventListener(&quot;mousedown&quot;, __bubbled_click_handler, false);</span>
<a href="#l2.395"></a><span id="l2.395">     doc.addEventListener(&quot;click&quot;, __bubbled_click_handler, false);</span>
<a href="#l2.396"></a><span id="l2.396">     doc.addEventListener(&quot;contextmenu&quot;, __bubbled_click_handler, false);</span>
<a href="#l2.397"></a><span id="l2.397">     doc.addEventListener(&quot;mouseup&quot;, __bubbled_click_handler, false);</span>
<a href="#l2.398"></a><span id="l2.398"> </span>
<a href="#l2.399"></a><span id="l2.399" class="difflineminus">-    doc.addEventListener(&quot;keypress&quot;, __peek_keypress_handler, true);</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineplus">+    doc.addEventListener(&quot;keypress&quot;, __bubbled_keypress_handler, false);</span>
<a href="#l2.401"></a><span id="l2.401"> </span>
<a href="#l2.402"></a><span id="l2.402">     // - also, add pop-up shown/hidden events....</span>
<a href="#l2.403"></a><span id="l2.403">     // We need to add these directly to the popups themselves in order to</span>
<a href="#l2.404"></a><span id="l2.404">     //  see anything.</span>
<a href="#l2.405"></a><span id="l2.405">     let popups = doc.documentElement.getElementsByTagName(&quot;menupopup&quot;);</span>
<a href="#l2.406"></a><span id="l2.406">     for (let i = 0; i &lt; popups.length; i++) {</span>
<a href="#l2.407"></a><span id="l2.407">       let popup = popups[i];</span>
<a href="#l2.408"></a><span id="l2.408">       popup.addEventListener(&quot;popupshowing&quot;, __popup_showing, true);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

