<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 19122:158bced7b1295d82b8dcde3db82bdd691066a7be</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 158bced7b1295d82b8dcde3db82bdd691066a7be" />
<meta property="og:url" content="/comm-central/rev/158bced7b1295d82b8dcde3db82bdd691066a7be" />
<meta property="og:description" content="Bug 777732 - Remove compose windows recycling (part 1). r=mkmelin a=jorgk SM CLOSED TREE" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 158bced7b1295d82b8dcde3db82bdd691066a7be 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/158bced7b1295d82b8dcde3db82bdd691066a7be">shortlog</a> |
<a href="/comm-central/log/158bced7b1295d82b8dcde3db82bdd691066a7be">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/158bced7b1295d82b8dcde3db82bdd691066a7be">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/158bced7b1295d82b8dcde3db82bdd691066a7be">files</a> |
changeset |
<a href="/comm-central/raw-rev/158bced7b1295d82b8dcde3db82bdd691066a7be">raw</a>  | <a href="/comm-central/archive/158bced7b1295d82b8dcde3db82bdd691066a7be.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=777732">Bug 777732</a> - Remove compose windows recycling (part 1). r=mkmelin a=jorgk SM CLOSED TREE
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;</td></tr>
<tr><td></td><td class="date age">Mon, 28 Mar 2016 18:40:21 +0200</td></tr>

<tr>
 <td>changeset 19122</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/158bced7b1295d82b8dcde3db82bdd691066a7be">158bced7b1295d82b8dcde3db82bdd691066a7be</a></td>
</tr>



<tr>
<td>parent 19121</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4d8a8c737743d20de2ac9e48943a3f03e2571908">4d8a8c737743d20de2ac9e48943a3f03e2571908</a>
</td>
</tr>

<tr>
<td>child 19123</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2738399062904a73b1de05fd351584286f849c76">2738399062904a73b1de05fd351584286f849c76</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=158bced7b1295d82b8dcde3db82bdd691066a7be">11741</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 28 Mar 2016 18:03:41 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@158bced7b129 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=158bced7b1295d82b8dcde3db82bdd691066a7be">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=158bced7b1295d82b8dcde3db82bdd691066a7be&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=158bced7b1295d82b8dcde3db82bdd691066a7be&newProject=comm-central&newRevision=158bced7b1295d82b8dcde3db82bdd691066a7be&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=158bced7b1295d82b8dcde3db82bdd691066a7be&newProject=comm-central&newRevision=158bced7b1295d82b8dcde3db82bdd691066a7be&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=158bced7b1295d82b8dcde3db82bdd691066a7be&newProject=comm-central&newRevision=158bced7b1295d82b8dcde3db82bdd691066a7be&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a>, <a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=777732">777732</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=777732">Bug 777732</a> - Remove compose windows recycling (part 1). r=mkmelin a=jorgk SM CLOSED TREE</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/extensions/smime/content/msgCompSMIMEOverlay.js">mail/extensions/smime/content/msgCompSMIMEOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/extensions/smime/content/msgCompSMIMEOverlay.js">file</a> |
<a href="/comm-central/annotate/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/extensions/smime/content/msgCompSMIMEOverlay.js">annotate</a> |
<a href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/extensions/smime/content/msgCompSMIMEOverlay.js">diff</a> |
<a href="/comm-central/comparison/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/extensions/smime/content/msgCompSMIMEOverlay.js">comparison</a> |
<a href="/comm-central/log/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/extensions/smime/content/msgCompSMIMEOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-attachment-reminder.js">mail/test/mozmill/composition/test-attachment-reminder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-attachment-reminder.js">file</a> |
<a href="/comm-central/annotate/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-attachment-reminder.js">annotate</a> |
<a href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-attachment-reminder.js">diff</a> |
<a href="/comm-central/comparison/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-attachment-reminder.js">comparison</a> |
<a href="/comm-central/log/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-attachment-reminder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-charset-upgrade.js">mail/test/mozmill/composition/test-charset-upgrade.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-charset-upgrade.js">file</a> |
<a href="/comm-central/annotate/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-charset-upgrade.js">annotate</a> |
<a href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-charset-upgrade.js">diff</a> |
<a href="/comm-central/comparison/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-charset-upgrade.js">comparison</a> |
<a href="/comm-central/log/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-charset-upgrade.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-drafts.js">mail/test/mozmill/composition/test-drafts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-drafts.js">file</a> |
<a href="/comm-central/annotate/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-drafts.js">annotate</a> |
<a href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-drafts.js">diff</a> |
<a href="/comm-central/comparison/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-drafts.js">comparison</a> |
<a href="/comm-central/log/158bced7b1295d82b8dcde3db82bdd691066a7be/mail/test/mozmill/composition/test-drafts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/public/nsIMsgCompose.idl">mailnews/compose/public/nsIMsgCompose.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/public/nsIMsgCompose.idl">file</a> |
<a href="/comm-central/annotate/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/public/nsIMsgCompose.idl">annotate</a> |
<a href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/public/nsIMsgCompose.idl">diff</a> |
<a href="/comm-central/comparison/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/public/nsIMsgCompose.idl">comparison</a> |
<a href="/comm-central/log/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/public/nsIMsgCompose.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/public/nsIMsgComposeService.idl">mailnews/compose/public/nsIMsgComposeService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/public/nsIMsgComposeService.idl">file</a> |
<a href="/comm-central/annotate/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/public/nsIMsgComposeService.idl">annotate</a> |
<a href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/public/nsIMsgComposeService.idl">diff</a> |
<a href="/comm-central/comparison/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/public/nsIMsgComposeService.idl">comparison</a> |
<a href="/comm-central/log/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/public/nsIMsgComposeService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgCompose.h">mailnews/compose/src/nsMsgCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgCompose.h">file</a> |
<a href="/comm-central/annotate/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgCompose.h">annotate</a> |
<a href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgCompose.h">diff</a> |
<a href="/comm-central/comparison/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgCompose.h">comparison</a> |
<a href="/comm-central/log/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgCompose.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgComposeService.cpp">mailnews/compose/src/nsMsgComposeService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgComposeService.cpp">file</a> |
<a href="/comm-central/annotate/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgComposeService.cpp">annotate</a> |
<a href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgComposeService.cpp">diff</a> |
<a href="/comm-central/comparison/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgComposeService.cpp">comparison</a> |
<a href="/comm-central/log/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgComposeService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgComposeService.h">mailnews/compose/src/nsMsgComposeService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgComposeService.h">file</a> |
<a href="/comm-central/annotate/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgComposeService.h">annotate</a> |
<a href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgComposeService.h">diff</a> |
<a href="/comm-central/comparison/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgComposeService.h">comparison</a> |
<a href="/comm-central/log/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/compose/src/nsMsgComposeService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/extensions/smime/content/msgCompSMIMEOverlay.js">mailnews/extensions/smime/content/msgCompSMIMEOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/extensions/smime/content/msgCompSMIMEOverlay.js">file</a> |
<a href="/comm-central/annotate/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/extensions/smime/content/msgCompSMIMEOverlay.js">annotate</a> |
<a href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/extensions/smime/content/msgCompSMIMEOverlay.js">diff</a> |
<a href="/comm-central/comparison/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/extensions/smime/content/msgCompSMIMEOverlay.js">comparison</a> |
<a href="/comm-central/log/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/extensions/smime/content/msgCompSMIMEOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/mailnews.js">mailnews/mailnews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/mailnews.js">file</a> |
<a href="/comm-central/annotate/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/mailnews.js">annotate</a> |
<a href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/mailnews.js">diff</a> |
<a href="/comm-central/comparison/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/mailnews.js">comparison</a> |
<a href="/comm-central/log/158bced7b1295d82b8dcde3db82bdd691066a7be/mailnews/mailnews.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/suite/mailnews/compose/MsgComposeCommands.js">suite/mailnews/compose/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/158bced7b1295d82b8dcde3db82bdd691066a7be/suite/mailnews/compose/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/158bced7b1295d82b8dcde3db82bdd691066a7be/suite/mailnews/compose/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/suite/mailnews/compose/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/158bced7b1295d82b8dcde3db82bdd691066a7be/suite/mailnews/compose/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/158bced7b1295d82b8dcde3db82bdd691066a7be/suite/mailnews/compose/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/suite/profile/migration/src/nsThunderbirdProfileMigrator.cpp">suite/profile/migration/src/nsThunderbirdProfileMigrator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/158bced7b1295d82b8dcde3db82bdd691066a7be/suite/profile/migration/src/nsThunderbirdProfileMigrator.cpp">file</a> |
<a href="/comm-central/annotate/158bced7b1295d82b8dcde3db82bdd691066a7be/suite/profile/migration/src/nsThunderbirdProfileMigrator.cpp">annotate</a> |
<a href="/comm-central/diff/158bced7b1295d82b8dcde3db82bdd691066a7be/suite/profile/migration/src/nsThunderbirdProfileMigrator.cpp">diff</a> |
<a href="/comm-central/comparison/158bced7b1295d82b8dcde3db82bdd691066a7be/suite/profile/migration/src/nsThunderbirdProfileMigrator.cpp">comparison</a> |
<a href="/comm-central/log/158bced7b1295d82b8dcde3db82bdd691066a7be/suite/profile/migration/src/nsThunderbirdProfileMigrator.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -166,100 +166,16 @@ function updateEditableFields(aDisable)</span>
<a href="#l1.4"></a><span id="l1.4">   else</span>
<a href="#l1.5"></a><span id="l1.5">     gMsgCompose.editor.flags &amp;= ~nsIPlaintextEditorMail.eEditorReadonlyMask;</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">   let elements = document.querySelectorAll('[disableonsend=&quot;true&quot;]');</span>
<a href="#l1.8"></a><span id="l1.8">   for (let i = 0; i &lt; elements.length; i++)</span>
<a href="#l1.9"></a><span id="l1.9">     elements[i].disabled = aDisable;</span>
<a href="#l1.10"></a><span id="l1.10"> }</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-var gComposeRecyclingListener = {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-  onClose: function() {</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-    //Clear the subject</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-    GetMsgSubjectElement().value = &quot;&quot;;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-    // be sure to clear the transaction manager for the subject</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-    GetMsgSubjectElement().editor.transactionManager.clear();</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-    SetComposeWindowTitle();</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-    //Reset recipients and attachments</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-    awResetAllRows();</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-    RemoveAllAttachments();</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-    // We need to clear the identity popup menu in case the user will change them.</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-    // It will be rebuilt later in ComposeStartup</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-    ClearIdentityListPopup(document.getElementById(&quot;msgIdentityPopup&quot;));</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-    var identityElement = document.getElementById(&quot;msgIdentity&quot;);</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-    identityElement.editable = false;</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-    identityElement.setAttribute(&quot;type&quot;, &quot;description&quot;);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-    var customizeMenuitem = document.getElementById(&quot;cmd_customizeFromAddress&quot;);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    customizeMenuitem.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-    customizeMenuitem.setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-    // Do not listen to changes to spell check dictionary.</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-    document.removeEventListener(&quot;spellcheck-changed&quot;, updateDocumentLanguage);</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-    // Disconnect the observer, we'll attach a new one when recycling the</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-    // window.</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-    gLanguageObserver.disconnect();</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-    // Stop observing dictionary removals.</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-    dictionaryRemovalObserver.removeObserver();</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-    // Stop gSpellChecker so personal dictionary is saved.</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-    // We need to do this before disabling the editor.</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-    enableInlineSpellCheck(false);</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-    // clear any suggestions in the context menu</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-    gSpellChecker.clearSuggestionsFromMenu();</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-    gSpellChecker.clearDictionaryListFromMenu();</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-    SetContentAndBodyAsUnmodified();</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-    updateEditableFields(true);</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-    // Clear the focus</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-    awGetInputElement(1).removeAttribute('focused');</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-    //Reset Boxes size</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-    document.getElementById(&quot;headers-box&quot;).removeAttribute(&quot;height&quot;);</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-    document.getElementById(&quot;appcontent&quot;).removeAttribute(&quot;height&quot;);</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-    document.getElementById(&quot;addresses-box&quot;).removeAttribute(&quot;width&quot;);</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-    //Reset menu options</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-    document.getElementById(&quot;format_auto&quot;).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-    document.getElementById(&quot;priority_normal&quot;).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-    // Reset the Customize Toolbars panel/sheet if open.</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-    if (getMailToolbox().customizing &amp;&amp; gCustomizeSheet)</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-      document.getElementById(&quot;customizeToolbarSheetIFrame&quot;)</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-              .contentWindow.finishToolbarCustomization();</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-    //Reset editor</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-    EditorResetFontAndColorAttributes();</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-    EditorCleanup();</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-    gAttachmentNotifier.redetectKeywords();</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-    //Release the nsIMsgComposeParams object</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-    if (window.arguments &amp;&amp; window.arguments[0])</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-      window.arguments[0] = null;</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-    document.getElementById(&quot;msgcomposeWindow&quot;).dispatchEvent(</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-      new Event(&quot;compose-window-close&quot;, { bubbles: false , cancelable: true }));</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-    if (gAutoSaveTimeout)</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-      clearTimeout(gAutoSaveTimeout);</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-    ReleaseGlobalVariables(); 	// This line must be the last in onClose();</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-  },</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-  onReopen: function(params) {</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-    InitializeGlobalVariables();</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-    ComposeStartup(true, params);</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-    var event = document.createEvent('Events');</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-    event.initEvent('compose-window-reopen', false, true);</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-    document.getElementById(&quot;msgcomposeWindow&quot;).dispatchEvent(event);</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-  }</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-};</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-</span>
<a href="#l1.96"></a><span id="l1.96"> var PrintPreviewListener = {</span>
<a href="#l1.97"></a><span id="l1.97">   getPrintPreviewBrowser: function() {</span>
<a href="#l1.98"></a><span id="l1.98">     var browser = document.getElementById(&quot;cppBrowser&quot;);</span>
<a href="#l1.99"></a><span id="l1.99">     if (!browser) {</span>
<a href="#l1.100"></a><span id="l1.100">       browser = document.createElement(&quot;browser&quot;);</span>
<a href="#l1.101"></a><span id="l1.101">       browser.setAttribute(&quot;id&quot;, &quot;cppBrowser&quot;);</span>
<a href="#l1.102"></a><span id="l1.102">       browser.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l1.103"></a><span id="l1.103">       browser.setAttribute(&quot;disablehistory&quot;, &quot;true&quot;);</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineat">@@ -374,17 +290,17 @@ var stateListener = {</span>
<a href="#l1.105"></a><span id="l1.105">         SetContentAndBodyAsUnmodified();</span>
<a href="#l1.106"></a><span id="l1.106"> </span>
<a href="#l1.107"></a><span id="l1.107">       if (gCloseWindowAfterSave)</span>
<a href="#l1.108"></a><span id="l1.108">       {</span>
<a href="#l1.109"></a><span id="l1.109">         // Notify the SendListener that Send has been aborted and Stopped</span>
<a href="#l1.110"></a><span id="l1.110">         if (gMsgCompose)</span>
<a href="#l1.111"></a><span id="l1.111">           gMsgCompose.onSendNotPerformed(null, Components.results.NS_ERROR_ABORT);</span>
<a href="#l1.112"></a><span id="l1.112"> </span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-        MsgComposeCloseWindow(true);</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+        MsgComposeCloseWindow();</span>
<a href="#l1.115"></a><span id="l1.115">       }</span>
<a href="#l1.116"></a><span id="l1.116">     }</span>
<a href="#l1.117"></a><span id="l1.117">     // else if we failed to save, and we're autosaving, need to re-mark the editor</span>
<a href="#l1.118"></a><span id="l1.118">     // as changed, so that we won't lose the changes.</span>
<a href="#l1.119"></a><span id="l1.119">     else if (gAutoSaving)</span>
<a href="#l1.120"></a><span id="l1.120">     {</span>
<a href="#l1.121"></a><span id="l1.121">       gMsgCompose.bodyModified = true;</span>
<a href="#l1.122"></a><span id="l1.122">       gContentChanged = true;</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineat">@@ -1666,18 +1582,18 @@ function MessageComposeOfflineStateChang</span>
<a href="#l1.124"></a><span id="l1.124"> function DoCommandClose()</span>
<a href="#l1.125"></a><span id="l1.125"> {</span>
<a href="#l1.126"></a><span id="l1.126">   if (ComposeCanClose()) {</span>
<a href="#l1.127"></a><span id="l1.127"> </span>
<a href="#l1.128"></a><span id="l1.128">     // Notify the SendListener that Send has been aborted and Stopped</span>
<a href="#l1.129"></a><span id="l1.129">     if (gMsgCompose)</span>
<a href="#l1.130"></a><span id="l1.130">       gMsgCompose.onSendNotPerformed(null, Components.results.NS_ERROR_ABORT);</span>
<a href="#l1.131"></a><span id="l1.131"> </span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-    // note: if we're not caching this window, this destroys it for us</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-    MsgComposeCloseWindow(true);</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+    // This destroys the window for us.</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+    MsgComposeCloseWindow();</span>
<a href="#l1.136"></a><span id="l1.136">   }</span>
<a href="#l1.137"></a><span id="l1.137"> </span>
<a href="#l1.138"></a><span id="l1.138">   return false;</span>
<a href="#l1.139"></a><span id="l1.139"> }</span>
<a href="#l1.140"></a><span id="l1.140"> </span>
<a href="#l1.141"></a><span id="l1.141"> function DoCommandPrint()</span>
<a href="#l1.142"></a><span id="l1.142"> {</span>
<a href="#l1.143"></a><span id="l1.143">   try {</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineat">@@ -2097,28 +2013,24 @@ var dictionaryRemovalObserver =</span>
<a href="#l1.145"></a><span id="l1.145">   isAdded: false,</span>
<a href="#l1.146"></a><span id="l1.146"> </span>
<a href="#l1.147"></a><span id="l1.147">   addObserver: function() {</span>
<a href="#l1.148"></a><span id="l1.148">     Services.obs.addObserver(this, &quot;spellcheck-dictionary-remove&quot;, false);</span>
<a href="#l1.149"></a><span id="l1.149">     this.isAdded = true;</span>
<a href="#l1.150"></a><span id="l1.150">   },</span>
<a href="#l1.151"></a><span id="l1.151"> </span>
<a href="#l1.152"></a><span id="l1.152">   removeObserver: function() {</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-    // We need to protect against double removal:</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-    // The window can be recycled and later destroyed (at shutdown or when the</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-    // composition style changes from HTML to plain text or vice versa) or</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-    // only destroyed if it was never recycled before.</span>
<a href="#l1.157"></a><span id="l1.157">     if (this.isAdded) {</span>
<a href="#l1.158"></a><span id="l1.158">       Services.obs.removeObserver(this, &quot;spellcheck-dictionary-remove&quot;);</span>
<a href="#l1.159"></a><span id="l1.159">       this.isAdded = false;</span>
<a href="#l1.160"></a><span id="l1.160">     }</span>
<a href="#l1.161"></a><span id="l1.161">   }</span>
<a href="#l1.162"></a><span id="l1.162"> }</span>
<a href="#l1.163"></a><span id="l1.163"> </span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-function ComposeStartup(recycled, aParams)</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+function ComposeStartup(aParams)</span>
<a href="#l1.166"></a><span id="l1.166"> {</span>
<a href="#l1.167"></a><span id="l1.167">   // Findbar overlay</span>
<a href="#l1.168"></a><span id="l1.168">   if (!document.getElementById(&quot;findbar-replaceButton&quot;)) {</span>
<a href="#l1.169"></a><span id="l1.169">     let replaceButton = document.createElement(&quot;toolbarbutton&quot;);</span>
<a href="#l1.170"></a><span id="l1.170">     replaceButton.setAttribute(&quot;id&quot;, &quot;findbar-replaceButton&quot;);</span>
<a href="#l1.171"></a><span id="l1.171">     replaceButton.setAttribute(&quot;class&quot;, &quot;findbar-button tabbable&quot;);</span>
<a href="#l1.172"></a><span id="l1.172">     replaceButton.setAttribute(&quot;label&quot;, getComposeBundle().getString(&quot;replaceButton.label&quot;));</span>
<a href="#l1.173"></a><span id="l1.173">     replaceButton.setAttribute(&quot;accesskey&quot;, getComposeBundle().getString(&quot;replaceButton.accesskey&quot;));</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineat">@@ -2292,60 +2204,49 @@ function ComposeStartup(recycled, aParam</span>
<a href="#l1.175"></a><span id="l1.175">     }</span>
<a href="#l1.176"></a><span id="l1.176">   }</span>
<a href="#l1.177"></a><span id="l1.177">   LoadIdentity(true);</span>
<a href="#l1.178"></a><span id="l1.178"> </span>
<a href="#l1.179"></a><span id="l1.179">   // Get the &lt;editor&gt; element to startup an editor</span>
<a href="#l1.180"></a><span id="l1.180">   var editorElement = GetCurrentEditorElement();</span>
<a href="#l1.181"></a><span id="l1.181">   gMsgCompose = MailServices.compose.initCompose(params, window, editorElement.docShell);</span>
<a href="#l1.182"></a><span id="l1.182"> </span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-  // Set the close listener.</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-  gMsgCompose.recyclingListener = gComposeRecyclingListener;</span>
<a href="#l1.185"></a><span id="l1.185">   gMsgCompose.addMsgSendListener(gSendListener);</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-  // Lets the compose object know that we are dealing with a recycled window.</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-  gMsgCompose.recycledWindow = recycled;</span>
<a href="#l1.188"></a><span id="l1.188"> </span>
<a href="#l1.189"></a><span id="l1.189">   document.getElementById(&quot;returnReceiptMenu&quot;)</span>
<a href="#l1.190"></a><span id="l1.190">           .setAttribute('checked', gMsgCompose.compFields.returnReceipt);</span>
<a href="#l1.191"></a><span id="l1.191">   document.getElementById(&quot;dsnMenu&quot;)</span>
<a href="#l1.192"></a><span id="l1.192">           .setAttribute(&quot;checked&quot;, gMsgCompose.compFields.DSN);</span>
<a href="#l1.193"></a><span id="l1.193">   document.getElementById(&quot;cmd_attachVCard&quot;)</span>
<a href="#l1.194"></a><span id="l1.194">           .setAttribute(&quot;checked&quot;, gMsgCompose.compFields.attachVCard);</span>
<a href="#l1.195"></a><span id="l1.195">   toggleAttachmentReminder(gMsgCompose.compFields.attachmentReminder);</span>
<a href="#l1.196"></a><span id="l1.196">   gSendFormat = gMsgCompose.compFields.deliveryFormat;</span>
<a href="#l1.197"></a><span id="l1.197">   SetCompositionAsPerDeliveryFormat(gSendFormat);</span>
<a href="#l1.198"></a><span id="l1.198">   SelectDeliveryFormatMenuOption(gSendFormat);</span>
<a href="#l1.199"></a><span id="l1.199"> </span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-  // If recycle, editor is already created.</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineminus">-  if (!recycled)</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+  let editortype = gMsgCompose.composeHTML ? &quot;htmlmail&quot; : &quot;textmail&quot;;</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+  editorElement.makeEditable(editortype, true);</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+  // setEditorType MUST be called before setContentWindow</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+  if (gMsgCompose.composeHTML)</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+  {</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+    initLocalFontFaceMenu(document.getElementById(&quot;FontFacePopup&quot;));</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+  }</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+  else</span>
<a href="#l1.211"></a><span id="l1.211">   {</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-    let editortype = gMsgCompose.composeHTML ? &quot;htmlmail&quot; : &quot;textmail&quot;;</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-    editorElement.makeEditable(editortype, true);</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-    // setEditorType MUST be called before setContentWindow</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-    if (gMsgCompose.composeHTML)</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-    {</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-      initLocalFontFaceMenu(document.getElementById(&quot;FontFacePopup&quot;));</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-    }</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineminus">-    else</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-    {</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-      // We are editing in plain text mode.</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineminus">-      // The SetCompositionAsPerDeliveryFormat call above already hid</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-      // the HTML toolbar, format and insert menus.</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-      // Also remove the delivery format from the options menu.</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-      // We only do that when the window is first created (&quot;!recycled&quot;)</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-      // as we will never need to restore it since a plain text window will</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-      // never be used for a HTML composition.</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-      document.getElementById(&quot;outputFormatMenu&quot;).setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineminus">-    }</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineminus">-</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-    // Do setup common to Message Composer and Web Composer.</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-    EditorSharedStartup();</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+    // We are editing in plain text mode.</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+    // The SetCompositionAsPerDeliveryFormat call above already hid</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+    // the HTML toolbar, format and insert menus.</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineplus">+    // Also remove the delivery format from the options menu.</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+    document.getElementById(&quot;outputFormatMenu&quot;).setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l1.239"></a><span id="l1.239">   }</span>
<a href="#l1.240"></a><span id="l1.240"> </span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+  // Do setup common to Message Composer and Web Composer.</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+  EditorSharedStartup();</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+</span>
<a href="#l1.244"></a><span id="l1.244">   if (params.bodyIsLink)</span>
<a href="#l1.245"></a><span id="l1.245">   {</span>
<a href="#l1.246"></a><span id="l1.246">     let body = gMsgCompose.compFields.body;</span>
<a href="#l1.247"></a><span id="l1.247">     if (gMsgCompose.composeHTML)</span>
<a href="#l1.248"></a><span id="l1.248">     {</span>
<a href="#l1.249"></a><span id="l1.249">       let cleanBody;</span>
<a href="#l1.250"></a><span id="l1.250">       try {</span>
<a href="#l1.251"></a><span id="l1.251">         cleanBody = decodeURI(body);</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineat">@@ -2365,43 +2266,26 @@ function ComposeStartup(recycled, aParam</span>
<a href="#l1.253"></a><span id="l1.253"> </span>
<a href="#l1.254"></a><span id="l1.254">   AddAttachments(gMsgCompose.compFields.attachments);</span>
<a href="#l1.255"></a><span id="l1.255"> </span>
<a href="#l1.256"></a><span id="l1.256">   document.getElementById(&quot;msgcomposeWindow&quot;).dispatchEvent(</span>
<a href="#l1.257"></a><span id="l1.257">     new Event(&quot;compose-window-init&quot;, { bubbles: false , cancelable: true }));</span>
<a href="#l1.258"></a><span id="l1.258"> </span>
<a href="#l1.259"></a><span id="l1.259">   gMsgCompose.RegisterStateListener(stateListener);</span>
<a href="#l1.260"></a><span id="l1.260"> </span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">-  if (recycled)</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineminus">-  {</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineminus">-    InitEditor();</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineminus">-</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineminus">-    if (gMsgCompose.composeHTML)</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineminus">-    {</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineminus">-      // Force color picker on toolbar to show document colors.</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-      onFontColorChange();</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-      onBackgroundColorChange();</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-    }</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineminus">-    // Reset the priority field for recycled windows.</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineminus">-    updatePriorityToolbarButton(&quot;Normal&quot;);</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineminus">-  }</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineminus">-  else</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineminus">-  {</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineminus">-    // Add an observer to be called when document is done loading,</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineminus">-    // which creates the editor.</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-    try {</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineminus">-      GetCurrentCommandManager().</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineminus">-              addCommandObserver(gMsgEditorCreationObserver, &quot;obs_documentCreated&quot;);</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineminus">-</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineminus">-      // Load empty page to create the editor.</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineminus">-      editorElement.webNavigation.loadURI(&quot;about:blank&quot;, 0, null, null, null);</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineminus">-    } catch (e) {</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineminus">-      Components.utils.reportError(e);</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineminus">-    }</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineplus">+  // Add an observer to be called when document is done loading,</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineplus">+  // which creates the editor.</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineplus">+  try {</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineplus">+    GetCurrentCommandManager().</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineplus">+            addCommandObserver(gMsgEditorCreationObserver, &quot;obs_documentCreated&quot;);</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineplus">+</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+    // Load empty page to create the editor.</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+    editorElement.webNavigation.loadURI(&quot;about:blank&quot;, 0, null, null, null);</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+  } catch (e) {</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+    Components.utils.reportError(e);</span>
<a href="#l1.298"></a><span id="l1.298">   }</span>
<a href="#l1.299"></a><span id="l1.299"> </span>
<a href="#l1.300"></a><span id="l1.300">   gEditingDraft = gMsgCompose.compFields.draftId;</span>
<a href="#l1.301"></a><span id="l1.301"> </span>
<a href="#l1.302"></a><span id="l1.302">   // finally, see if we need to auto open the address sidebar.</span>
<a href="#l1.303"></a><span id="l1.303">   var sideBarBox = document.getElementById('sidebar-box');</span>
<a href="#l1.304"></a><span id="l1.304">   if (sideBarBox.getAttribute(&quot;sidebarVisible&quot;) == &quot;true&quot;)</span>
<a href="#l1.305"></a><span id="l1.305">   {</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineat">@@ -2451,17 +2335,17 @@ var gMsgEditorCreationObserver =</span>
<a href="#l1.307"></a><span id="l1.307"> function WizCallback(state)</span>
<a href="#l1.308"></a><span id="l1.308"> {</span>
<a href="#l1.309"></a><span id="l1.309">   if (state){</span>
<a href="#l1.310"></a><span id="l1.310">     ComposeStartup(false, null);</span>
<a href="#l1.311"></a><span id="l1.311">   }</span>
<a href="#l1.312"></a><span id="l1.312">   else</span>
<a href="#l1.313"></a><span id="l1.313">   {</span>
<a href="#l1.314"></a><span id="l1.314">     // The account wizard is still closing so we can't close just yet</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineminus">-    setTimeout(MsgComposeCloseWindow, 0, false); // Don't recycle a bogus window</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineplus">+    setTimeout(MsgComposeCloseWindow, 0);</span>
<a href="#l1.317"></a><span id="l1.317">   }</span>
<a href="#l1.318"></a><span id="l1.318"> }</span>
<a href="#l1.319"></a><span id="l1.319"> </span>
<a href="#l1.320"></a><span id="l1.320"> function ComposeLoad()</span>
<a href="#l1.321"></a><span id="l1.321"> {</span>
<a href="#l1.322"></a><span id="l1.322">   try {</span>
<a href="#l1.323"></a><span id="l1.323">     var other_headers = getPref(&quot;mail.compose.other.header&quot;);</span>
<a href="#l1.324"></a><span id="l1.324">   }</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineat">@@ -2490,24 +2374,24 @@ function ComposeLoad()</span>
<a href="#l1.326"></a><span id="l1.326"> </span>
<a href="#l1.327"></a><span id="l1.327">     if (other_headers) {</span>
<a href="#l1.328"></a><span id="l1.328">       var selectNode = document.getElementById('addressCol1#1');</span>
<a href="#l1.329"></a><span id="l1.329">       var other_headers_Array = other_headers.split(&quot;,&quot;);</span>
<a href="#l1.330"></a><span id="l1.330">       for (let i = 0; i &lt; other_headers_Array.length; i++)</span>
<a href="#l1.331"></a><span id="l1.331">         selectNode.appendItem(other_headers_Array[i] + &quot;:&quot;, &quot;addr_other&quot;);</span>
<a href="#l1.332"></a><span id="l1.332">     }</span>
<a href="#l1.333"></a><span id="l1.333">     if (state)</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineminus">-      ComposeStartup(false, null);</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineplus">+      ComposeStartup(null);</span>
<a href="#l1.336"></a><span id="l1.336">   }</span>
<a href="#l1.337"></a><span id="l1.337">   catch (ex) {</span>
<a href="#l1.338"></a><span id="l1.338">     Components.utils.reportError(ex);</span>
<a href="#l1.339"></a><span id="l1.339">     Services.prompt.alert(window, getComposeBundle().getString(&quot;initErrorDlogTitle&quot;),</span>
<a href="#l1.340"></a><span id="l1.340">                           getComposeBundle().getString(&quot;initErrorDlgMessage&quot;));</span>
<a href="#l1.341"></a><span id="l1.341"> </span>
<a href="#l1.342"></a><span id="l1.342" class="difflineminus">-    MsgComposeCloseWindow(false); // Don't try to recycle a bogus window</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineplus">+    MsgComposeCloseWindow();</span>
<a href="#l1.344"></a><span id="l1.344">     return;</span>
<a href="#l1.345"></a><span id="l1.345">   }</span>
<a href="#l1.346"></a><span id="l1.346"> </span>
<a href="#l1.347"></a><span id="l1.347">   ToolbarIconColor.init();</span>
<a href="#l1.348"></a><span id="l1.348"> </span>
<a href="#l1.349"></a><span id="l1.349">   // initialize the customizeDone method on the customizeable toolbar</span>
<a href="#l1.350"></a><span id="l1.350">   var toolbox = document.getElementById(&quot;compose-toolbox&quot;);</span>
<a href="#l1.351"></a><span id="l1.351">   toolbox.customizeDone = function(aEvent) { MailToolboxCustomizeDone(aEvent, &quot;CustomizeComposeToolbar&quot;); };</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineat">@@ -3659,20 +3543,20 @@ function RemoveDraft()</span>
<a href="#l1.353"></a><span id="l1.353"> }</span>
<a href="#l1.354"></a><span id="l1.354"> </span>
<a href="#l1.355"></a><span id="l1.355"> function SetContentAndBodyAsUnmodified()</span>
<a href="#l1.356"></a><span id="l1.356"> {</span>
<a href="#l1.357"></a><span id="l1.357">   gMsgCompose.bodyModified = false;</span>
<a href="#l1.358"></a><span id="l1.358">   gContentChanged = false;</span>
<a href="#l1.359"></a><span id="l1.359"> }</span>
<a href="#l1.360"></a><span id="l1.360"> </span>
<a href="#l1.361"></a><span id="l1.361" class="difflineminus">-function MsgComposeCloseWindow(recycleIt)</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineplus">+function MsgComposeCloseWindow()</span>
<a href="#l1.363"></a><span id="l1.363"> {</span>
<a href="#l1.364"></a><span id="l1.364">   if (gMsgCompose)</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineminus">-    gMsgCompose.CloseWindow(recycleIt);</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineplus">+    gMsgCompose.CloseWindow();</span>
<a href="#l1.367"></a><span id="l1.367">   else</span>
<a href="#l1.368"></a><span id="l1.368">     window.close();</span>
<a href="#l1.369"></a><span id="l1.369"> }</span>
<a href="#l1.370"></a><span id="l1.370"> </span>
<a href="#l1.371"></a><span id="l1.371"> function GetLastAttachDirectory()</span>
<a href="#l1.372"></a><span id="l1.372"> {</span>
<a href="#l1.373"></a><span id="l1.373">   var lastDirectory;</span>
<a href="#l1.374"></a><span id="l1.374"> </span>
<a href="#l1.375"></a><span id="l1.375" class="difflineat">@@ -4988,19 +4872,18 @@ function InitEditor()</span>
<a href="#l1.376"></a><span id="l1.376">   // We use addOverrideStyleSheet rather than addStyleSheet so that we get</span>
<a href="#l1.377"></a><span id="l1.377">   // a synchronous load, rather than having a late-finishing async load</span>
<a href="#l1.378"></a><span id="l1.378">   // mark our editor as modified when the user hasn't typed anything yet,</span>
<a href="#l1.379"></a><span id="l1.379">   // but that means the sheet must not @import slow things, especially</span>
<a href="#l1.380"></a><span id="l1.380">   // not over the network.</span>
<a href="#l1.381"></a><span id="l1.381">   editor.addOverrideStyleSheet(&quot;chrome://messenger/content/composerOverlay.css&quot;);</span>
<a href="#l1.382"></a><span id="l1.382">   gMsgCompose.initEditor(editor, window.content);</span>
<a href="#l1.383"></a><span id="l1.383"> </span>
<a href="#l1.384"></a><span id="l1.384" class="difflineminus">-  // We always go through this function everytime we init an editor, be it a</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineminus">-  // recycled editor, or a fresh one. First step is making sure we can spell</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineminus">-  // check.</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineplus">+  // We always go through this function everytime we init an editor.</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineplus">+  // First step is making sure we can spell check.</span>
<a href="#l1.389"></a><span id="l1.389">   gSpellChecker.init(editor);</span>
<a href="#l1.390"></a><span id="l1.390">   document.getElementById('menu_inlineSpellCheck')</span>
<a href="#l1.391"></a><span id="l1.391">           .setAttribute('disabled', !gSpellChecker.canSpellCheck);</span>
<a href="#l1.392"></a><span id="l1.392">   document.getElementById('spellCheckEnable')</span>
<a href="#l1.393"></a><span id="l1.393">           .setAttribute('disabled', !gSpellChecker.canSpellCheck);</span>
<a href="#l1.394"></a><span id="l1.394">   // If canSpellCheck = false, then hidden = false, i.e. show it so that we can</span>
<a href="#l1.395"></a><span id="l1.395">   // still add dictionaries. Else, hide that.</span>
<a href="#l1.396"></a><span id="l1.396">   document.getElementById('spellCheckAddDictionariesMain')</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/extensions/smime/content/msgCompSMIMEOverlay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/extensions/smime/content/msgCompSMIMEOverlay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -68,18 +68,17 @@ function onComposerReOpen()</span>
<a href="#l2.4"></a><span id="l2.4">   if (gSMFields.signMessage)</span>
<a href="#l2.5"></a><span id="l2.5">     setSignatureUI();</span>
<a href="#l2.6"></a><span id="l2.6">   else</span>
<a href="#l2.7"></a><span id="l2.7">     setNoSignatureUI();</span>
<a href="#l2.8"></a><span id="l2.8"> }</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> addEventListener(&quot;load&quot;, smimeComposeOnLoad, false);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-// this function gets called multiple times,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-// but only on first open, not on composer recycling</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+// this function gets called multiple times.</span>
<a href="#l2.15"></a><span id="l2.15"> function smimeComposeOnLoad()</span>
<a href="#l2.16"></a><span id="l2.16"> {</span>
<a href="#l2.17"></a><span id="l2.17">   removeEventListener(&quot;load&quot;, smimeComposeOnLoad, false);</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">   onComposerReOpen();</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">   top.controllers.appendController(SecurityController);</span>
<a href="#l2.22"></a><span id="l2.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-attachment-reminder.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-attachment-reminder.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -550,52 +550,16 @@ function test_disabled_attachment_remind</span>
<a href="#l3.4"></a><span id="l3.4">   click_send_and_handle_send_error(cwc);</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6">   close_compose_window(cwc);</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">   Services.prefs.setBoolPref(kReminderPref, true);</span>
<a href="#l3.9"></a><span id="l3.9"> }</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> /**</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">- * Bug 1099866</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">- * Check if reminder does not stay open on compose window reopen</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">- * due to window recycling.</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">- */</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-function test_recycling_attachment_reminder() {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-  let recycledWindows = Services.prefs.getIntPref(&quot;mail.compose.max_recycled_windows&quot;);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-  assert_true(recycledWindows &gt; 0);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-  // Open a sample message with no attachment keywords.</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-  let cwc = open_compose_new_mail();</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-  setupComposeWin(cwc, &quot;test@example.invalid&quot;, &quot;Testing recycling a reminder!&quot;,</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-                  &quot;Some body...&quot;);</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-  // There should be no attachment notification.</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-  assert_automatic_reminder_state(cwc, false);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-  // Add some keyword so the automatic notification</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-  // could potentially show up.</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-  setupComposeWin(cwc, &quot;&quot;, &quot;&quot;, &quot; and look for your attachment!&quot;);</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-  // Give the notification time to appear. It should.</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-  wait_for_reminder_state(cwc, true);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-  close_compose_window(cwc, true);</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-  // Another compose window without any keywords.</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-  cwc = open_compose_new_mail();</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-  setupComposeWin(cwc, &quot;test@example.invalid&quot;, &quot;Testing reminder after recycling!&quot;,</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-                  &quot;Some body...&quot;);</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-  // There should be no attachment notification.</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-  assert_automatic_reminder_state(cwc, false);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-  close_compose_window(cwc);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-}</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-/**</span>
<a href="#l3.48"></a><span id="l3.48">  * Click the send button and handle the send error dialog popping up.</span>
<a href="#l3.49"></a><span id="l3.49">  * It will return us back to the compose window.</span>
<a href="#l3.50"></a><span id="l3.50">  *</span>
<a href="#l3.51"></a><span id="l3.51">  * @param aController</span>
<a href="#l3.52"></a><span id="l3.52">  * @param aAlreadySending  Set this to true if sending was already triggered</span>
<a href="#l3.53"></a><span id="l3.53">  *                         by other means.</span>
<a href="#l3.54"></a><span id="l3.54">  */</span>
<a href="#l3.55"></a><span id="l3.55"> function click_send_and_handle_send_error(aController, aAlreadySending) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-charset-upgrade.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-charset-upgrade.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -154,18 +154,20 @@ function test_encoding_upgrade_html_comp</span>
<a href="#l4.4"></a><span id="l4.4">   if (!draftMsg2Content.includes('content=&quot;text/html; charset=UTF-8&quot;'))</span>
<a href="#l4.5"></a><span id="l4.5">     throw new Error(&quot;Expected content type not in msg; draftMsg2Content=&quot; +</span>
<a href="#l4.6"></a><span id="l4.6">                     draftMsg2Content);</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8">   if (!draftMsg2Content.includes(CHINESE))</span>
<a href="#l4.9"></a><span id="l4.9">     throw new Error(&quot;Chinese text not in msg; CHINESE=&quot; + CHINESE +</span>
<a href="#l4.10"></a><span id="l4.10">                     &quot;, draftMsg2Content=&quot; + draftMsg2Content);</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  // Ctrl+Shift+Return = Send Later</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  compWin.keypress(null, &quot;VK_RETURN&quot;, {shiftKey: true, accelKey: true});</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  compWin.window.setTimeout(function() {</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+    // Ctrl+Shift+Return = Send Later</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+    compWin.keypress(null, &quot;VK_RETURN&quot;, {shiftKey: true, accelKey: true});</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+  }, 0);</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19">   be_in_folder(outboxFolder);</span>
<a href="#l4.20"></a><span id="l4.20">   let outMsg = select_click_row(0);</span>
<a href="#l4.21"></a><span id="l4.21">   let outMsgContent = getMsgSource(outMsg);</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23">   // This message should be multipart/alternative.</span>
<a href="#l4.24"></a><span id="l4.24">   if (!outMsgContent.includes(&quot;Content-Type: multipart/alternative&quot;))</span>
<a href="#l4.25"></a><span id="l4.25">     throw new Error(&quot;Expected multipart/alternative; content=&quot; + outMsgContent);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineat">@@ -227,18 +229,20 @@ function test_encoding_upgrade_plaintext</span>
<a href="#l4.27"></a><span id="l4.27">   if (draftMsg2Content.includes(&quot;&lt;html&gt;&quot;))</span>
<a href="#l4.28"></a><span id="l4.28">     throw new Error(&quot;Plaintext draft contained &lt;html&gt;; &quot;+</span>
<a href="#l4.29"></a><span id="l4.29">                     &quot;draftMsg2Content=&quot; + draftMsg2Content);</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31">   if (!draftMsg2Content.includes(CHINESE))</span>
<a href="#l4.32"></a><span id="l4.32">     throw new Error(&quot;Chinese text not in msg; CHINESE=&quot; + CHINESE +</span>
<a href="#l4.33"></a><span id="l4.33">                     &quot;, draftMsg2Content=&quot; + draftMsg2Content);</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-  // Ctrl+Shift+Return = Send Later.</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-  compWin.keypress(null, &quot;VK_RETURN&quot;, {shiftKey: true, accelKey: true});</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  compWin.window.setTimeout(function() {</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+    // Ctrl+Shift+Return = Send Later.</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+    compWin.keypress(null, &quot;VK_RETURN&quot;, {shiftKey: true, accelKey: true});</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+  }, 0);</span>
<a href="#l4.41"></a><span id="l4.41"> </span>
<a href="#l4.42"></a><span id="l4.42">   be_in_folder(outboxFolder);</span>
<a href="#l4.43"></a><span id="l4.43">   let outMsg = select_click_row(0);</span>
<a href="#l4.44"></a><span id="l4.44">   let outMsgContent = getMsgSource(outMsg);</span>
<a href="#l4.45"></a><span id="l4.45"> </span>
<a href="#l4.46"></a><span id="l4.46">   // This message should be text/plain;</span>
<a href="#l4.47"></a><span id="l4.47">   if (!outMsgContent.includes(&quot;Content-Type: text/plain&quot;))</span>
<a href="#l4.48"></a><span id="l4.48">     throw new Error(&quot;Expected text/plain; content=&quot; + outMsgContent);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-drafts.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-drafts.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -138,17 +138,17 @@ function test_save_delivery_format() {</span>
<a href="#l5.4"></a><span id="l5.4">   cwc.window.SaveAsDraft();</span>
<a href="#l5.5"></a><span id="l5.5">   utils.waitFor(() =&gt; !cwc.window.gSaveOperationInProgress &amp;&amp; !cwc.window.gWindowLock,</span>
<a href="#l5.6"></a><span id="l5.6">                 &quot;Saving of draft did not finish&quot;);</span>
<a href="#l5.7"></a><span id="l5.7">   wait_for_window_focused(cwc.window);</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9">   close_compose_window(cwc);</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">   // Open a new composition see if the menu is again at default value, not the one</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  // chosen above, even in a recycled compose window.</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  // chosen above.</span>
<a href="#l5.14"></a><span id="l5.14">   cwc = open_compose_new_mail();</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16">   assert_format_value(&quot;format_auto&quot;, Ci.nsIMsgCompSendFormat.AskUser);</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18">   close_compose_window(cwc);</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20">   be_in_folder(draftsFolder);</span>
<a href="#l5.21"></a><span id="l5.21">   select_click_row(0);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgCompose.idl</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgCompose.idl</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -86,23 +86,16 @@ interface nsIMsgComposeNotificationType</span>
<a href="#l6.4"></a><span id="l6.4">     const long ComposeProcessDone = 1;</span>
<a href="#l6.5"></a><span id="l6.5">     const long SaveInFolderDone   = 2;</span>
<a href="#l6.6"></a><span id="l6.6">     const long ComposeBodyReady   = 3;</span>
<a href="#l6.7"></a><span id="l6.7"> };</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> native nsString(nsString);</span>
<a href="#l6.10"></a><span id="l6.10"> [ref] native nsStringRef(nsString);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-/* recycling listener interface */</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-[scriptable, uuid(0b28cc56-1dd2-11b2-bbe4-99e6a314f8ba)]</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-interface nsIMsgComposeRecyclingListener : nsISupports {</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-  void onClose();</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-  void onReopen(in nsIMsgComposeParams params);</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-};</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-</span>
<a href="#l6.19"></a><span id="l6.19"> [scriptable, uuid(c6544b6b-06dd-43ac-89b5-949d7c81bb7b)]</span>
<a href="#l6.20"></a><span id="l6.20"> interface nsIMsgCompose : nsIMsgSendListener {</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22">   /**</span>
<a href="#l6.23"></a><span id="l6.23">    * Initializes the msg compose object.</span>
<a href="#l6.24"></a><span id="l6.24">    *</span>
<a href="#l6.25"></a><span id="l6.25">    * @param aParams   An nsIMsgComposeParams object containing the initial</span>
<a href="#l6.26"></a><span id="l6.26">    *                  details for the compose.</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineat">@@ -135,17 +128,17 @@ interface nsIMsgCompose : nsIMsgSendList</span>
<a href="#l6.28"></a><span id="l6.28">    * @param identity The message identity.</span>
<a href="#l6.29"></a><span id="l6.29">    * @param accountKey The message account key.</span>
<a href="#l6.30"></a><span id="l6.30">    */</span>
<a href="#l6.31"></a><span id="l6.31">   void sendMsgToServer(in MSG_DeliverMode deliverMode,</span>
<a href="#l6.32"></a><span id="l6.32">                        in nsIMsgIdentity identity,</span>
<a href="#l6.33"></a><span id="l6.33">                        in string accountKey);</span>
<a href="#l6.34"></a><span id="l6.34"> </span>
<a href="#l6.35"></a><span id="l6.35">   /* ... */</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-  void CloseWindow(in boolean reclycleIt);</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+  void CloseWindow();</span>
<a href="#l6.38"></a><span id="l6.38"> </span>
<a href="#l6.39"></a><span id="l6.39">   /* ... */</span>
<a href="#l6.40"></a><span id="l6.40">   void abort();</span>
<a href="#l6.41"></a><span id="l6.41">     </span>
<a href="#l6.42"></a><span id="l6.42">   /* ... */</span>
<a href="#l6.43"></a><span id="l6.43">   void quoteMessage(in string msgURI);</span>
<a href="#l6.44"></a><span id="l6.44"> </span>
<a href="#l6.45"></a><span id="l6.45">   /*</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineat">@@ -279,22 +272,16 @@ interface nsIMsgCompose : nsIMsgSendList</span>
<a href="#l6.47"></a><span id="l6.47">   [noscript] void buildBodyMessageAndSignature();</span>
<a href="#l6.48"></a><span id="l6.48">   </span>
<a href="#l6.49"></a><span id="l6.49"> 	/* ... */</span>
<a href="#l6.50"></a><span id="l6.50">   [noscript] void buildQuotedMessageAndSignature();</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52">  	/* ... */</span>
<a href="#l6.53"></a><span id="l6.53">   [noscript] void getQuotingToFollow(out boolean quotingToFollow);</span>
<a href="#l6.54"></a><span id="l6.54"> </span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">- 	/* ... */</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-  attribute nsIMsgComposeRecyclingListener recyclingListener;</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-  </span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-  /* ... */</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-  attribute boolean recycledWindow;</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-  </span>
<a href="#l6.61"></a><span id="l6.61">   readonly attribute string originalMsgURI;</span>
<a href="#l6.62"></a><span id="l6.62"> </span>
<a href="#l6.63"></a><span id="l6.63">   attribute boolean deleteDraft;</span>
<a href="#l6.64"></a><span id="l6.64"> </span>
<a href="#l6.65"></a><span id="l6.65">   /* true when the compose window is in the process of inserting quoted content</span>
<a href="#l6.66"></a><span id="l6.66">      (i.e. via reply, forward inline or a quoting operation) into the document </span>
<a href="#l6.67"></a><span id="l6.67">    */</span>
<a href="#l6.68"></a><span id="l6.68">   attribute boolean insertingQuotedContent;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgComposeService.idl</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgComposeService.idl</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -41,18 +41,17 @@ interface nsIMsgComposeService : nsISupp</span>
<a href="#l7.4"></a><span id="l7.4">   void OpenComposeWindowWithURI(in string msgComposeWindowURL,</span>
<a href="#l7.5"></a><span id="l7.5">                                 in nsIURI aURI,</span>
<a href="#l7.6"></a><span id="l7.6">                                 [optional] in nsIMsgIdentity aIdentity);</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8">   /* ... */</span>
<a href="#l7.9"></a><span id="l7.9">   void OpenComposeWindowWithParams(in string msgComposeWindowURL, in nsIMsgComposeParams params);</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">   /**</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-   * Creates an nsIMsgCompose instance, initalizes it, and manages the window</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-   * recycling cache.</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+   * Creates an nsIMsgCompose instance and initalizes it.</span>
<a href="#l7.15"></a><span id="l7.15">    *</span>
<a href="#l7.16"></a><span id="l7.16">    * @param aParams   An nsIMsgComposeParams object containing the initial</span>
<a href="#l7.17"></a><span id="l7.17">    *                  details for the compose.</span>
<a href="#l7.18"></a><span id="l7.18">    * @param aWindow   The optional window associated with this compose object.</span>
<a href="#l7.19"></a><span id="l7.19">    * @param aDocShell The optional docShell of the editor element that is used</span>
<a href="#l7.20"></a><span id="l7.20">    *                  for composing.</span>
<a href="#l7.21"></a><span id="l7.21">    */</span>
<a href="#l7.22"></a><span id="l7.22">   nsIMsgCompose initCompose(in nsIMsgComposeParams aParams,</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineat">@@ -68,18 +67,16 @@ interface nsIMsgComposeService : nsISupp</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25">   /* This function is use for debugging purpose only and may go away at anytime without warning */</span>
<a href="#l7.26"></a><span id="l7.26">   void TimeStamp(in string label, in boolean resetTime);  </span>
<a href="#l7.27"></a><span id="l7.27">   </span>
<a href="#l7.28"></a><span id="l7.28">   /* This attribute is use for debugging purposes for determining whether to PR_LOG or not */</span>
<a href="#l7.29"></a><span id="l7.29">   readonly attribute boolean logComposePerformance;</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31">   [noscript] boolean determineComposeHTML(in nsIMsgIdentity aIdentity, in MSG_ComposeFormat aFormat);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-  [noscript] void cacheWindow(in mozIDOMWindowProxy aWindow, in boolean aComposeHTML, in nsIMsgComposeRecyclingListener listener);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-  boolean isCachedWindow(in mozIDOMWindowProxy aWindow);</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35">   /** </span>
<a href="#l7.36"></a><span id="l7.36">    * given a mailto url, parse the attributes and turn them into a nsIMsgComposeParams object</span>
<a href="#l7.37"></a><span id="l7.37">    * @return nsIMsgComposeParams which corresponds to the passed in mailto url</span>
<a href="#l7.38"></a><span id="l7.38">    */</span>
<a href="#l7.39"></a><span id="l7.39">   nsIMsgComposeParams getParamsForMailto(in nsIURI aURI); </span>
<a href="#l7.40"></a><span id="l7.40"> </span>
<a href="#l7.41"></a><span id="l7.41">   /**</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineat">@@ -125,17 +122,17 @@ interface nsIMsgComposeService : nsISupp</span>
<a href="#l7.43"></a><span id="l7.43">    *</span>
<a href="#l7.44"></a><span id="l7.44">    * @param aDocShell The nsIDocShell of the editor element. </span>
<a href="#l7.45"></a><span id="l7.45">    * @param aMsgCompose The compose object associated with the compose window</span>
<a href="#l7.46"></a><span id="l7.46">    */</span>
<a href="#l7.47"></a><span id="l7.47">   void registerComposeDocShell(in nsIDocShell aDocShell,</span>
<a href="#l7.48"></a><span id="l7.48">                                in nsIMsgCompose aMsgCompose);</span>
<a href="#l7.49"></a><span id="l7.49"> </span>
<a href="#l7.50"></a><span id="l7.50">   /** </span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-   * When an editor docShell is being closed (or recycled), you should</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+   * When an editor docShell is being closed, you should</span>
<a href="#l7.53"></a><span id="l7.53">    * unregister it from this service. nsIMsgCompose normally calls this</span>
<a href="#l7.54"></a><span id="l7.54">    * automatically for items passed to initCompose.</span>
<a href="#l7.55"></a><span id="l7.55">    *</span>
<a href="#l7.56"></a><span id="l7.56">    * @param aDocShell The nsIDocShell of the editor element. </span>
<a href="#l7.57"></a><span id="l7.57">    */</span>
<a href="#l7.58"></a><span id="l7.58">   void unregisterComposeDocShell(in nsIDocShell aDocShell);</span>
<a href="#l7.59"></a><span id="l7.59">   </span>
<a href="#l7.60"></a><span id="l7.60">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -182,17 +182,16 @@ nsMsgCompose::nsMsgCompose()</span>
<a href="#l8.4"></a><span id="l8.4">   // For TagConvertible</span>
<a href="#l8.5"></a><span id="l8.5">   // Read and cache pref</span>
<a href="#l8.6"></a><span id="l8.6">   mConvertStructs = false;</span>
<a href="#l8.7"></a><span id="l8.7">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch (do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l8.8"></a><span id="l8.8">   if (prefBranch)</span>
<a href="#l8.9"></a><span id="l8.9">     prefBranch-&gt;GetBoolPref(&quot;converter.html2txt.structs&quot;, &amp;mConvertStructs);</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11">   m_composeHTML = false;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  mRecycledWindow = true;</span>
<a href="#l8.13"></a><span id="l8.13"> }</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> nsMsgCompose::~nsMsgCompose()</span>
<a href="#l8.17"></a><span id="l8.17"> {</span>
<a href="#l8.18"></a><span id="l8.18">   NS_IF_RELEASE(m_compFields);</span>
<a href="#l8.19"></a><span id="l8.19">   NS_IF_RELEASE(mQuoteStreamListener);</span>
<a href="#l8.20"></a><span id="l8.20"> }</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -605,27 +604,16 @@ nsMsgCompose::ConvertAndLoadComposeWindo</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23">   // First, get the nsIEditor interface for future use</span>
<a href="#l8.24"></a><span id="l8.24">   nsCOMPtr&lt;nsIDOMNode&gt; nodeInserted;</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26">   TranslateLineEnding(aPrefix);</span>
<a href="#l8.27"></a><span id="l8.27">   TranslateLineEnding(aBuf);</span>
<a href="#l8.28"></a><span id="l8.28">   TranslateLineEnding(aSignature);</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  // We're going to be inserting stuff, and MsgComposeCommands</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-  // may have set the editor to readonly in the recycled case.</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-  // So set it back to writable.</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-  // Note!  enableEditableFields in gComposeRecyclingListener::onReopen</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-  // will redundantly set this flag to writable, but it gets there</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-  // too late.</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-  uint32_t flags = 0;</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-  m_editor-&gt;GetFlags(&amp;flags);</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-  flags &amp;= ~nsIPlaintextEditor::eEditorReadonlyMask;</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-  m_editor-&gt;SetFlags(flags);</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-</span>
<a href="#l8.41"></a><span id="l8.41">   m_editor-&gt;EnableUndo(false);</span>
<a href="#l8.42"></a><span id="l8.42"> </span>
<a href="#l8.43"></a><span id="l8.43">   // Ok - now we need to figure out the charset of the aBuf we are going to send</span>
<a href="#l8.44"></a><span id="l8.44">   // into the editor shell. There are I18N calls to sniff the data and then we need</span>
<a href="#l8.45"></a><span id="l8.45">   // to call the new routine in the editor that will allow us to send in the charset</span>
<a href="#l8.46"></a><span id="l8.46">   //</span>
<a href="#l8.47"></a><span id="l8.47"> </span>
<a href="#l8.48"></a><span id="l8.48">   // Now, insert it into the editor...</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineat">@@ -1483,44 +1471,16 @@ NS_IMETHODIMP nsMsgCompose::SendMsg(MSG_</span>
<a href="#l8.50"></a><span id="l8.50"> </span>
<a href="#l8.51"></a><span id="l8.51">     if (progress)</span>
<a href="#l8.52"></a><span id="l8.52">       progress-&gt;CloseProgressDialog(true);</span>
<a href="#l8.53"></a><span id="l8.53">   }</span>
<a href="#l8.54"></a><span id="l8.54"> </span>
<a href="#l8.55"></a><span id="l8.55">   return rv;</span>
<a href="#l8.56"></a><span id="l8.56"> }</span>
<a href="#l8.57"></a><span id="l8.57"> </span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-// XXX when do we break this ref to the listener?</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::SetRecyclingListener(nsIMsgComposeRecyclingListener *aRecyclingListener)</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-{</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-  mRecyclingListener = aRecyclingListener;</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-  return NS_OK;</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-}</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::GetRecyclingListener(nsIMsgComposeRecyclingListener **aRecyclingListener)</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-{</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aRecyclingListener);</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-  *aRecyclingListener = mRecyclingListener;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-  NS_IF_ADDREF(*aRecyclingListener);</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-  return NS_OK;</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-}</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-/* attribute boolean recycledWindow; */</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::GetRecycledWindow(bool *aRecycledWindow)</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-{</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aRecycledWindow);</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-  *aRecycledWindow = mRecycledWindow;</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-  return NS_OK;</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-}</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::SetRecycledWindow(bool aRecycledWindow)</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-{</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-  mRecycledWindow = aRecycledWindow;</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-  return NS_OK;</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-}</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-</span>
<a href="#l8.86"></a><span id="l8.86"> /* attribute boolean deleteDraft */</span>
<a href="#l8.87"></a><span id="l8.87"> NS_IMETHODIMP nsMsgCompose::GetDeleteDraft(bool *aDeleteDraft)</span>
<a href="#l8.88"></a><span id="l8.88"> {</span>
<a href="#l8.89"></a><span id="l8.89">   NS_ENSURE_ARG_POINTER(aDeleteDraft);</span>
<a href="#l8.90"></a><span id="l8.90">   *aDeleteDraft = mDeleteDraft;</span>
<a href="#l8.91"></a><span id="l8.91">   return NS_OK;</span>
<a href="#l8.92"></a><span id="l8.92"> }</span>
<a href="#l8.93"></a><span id="l8.93"> </span>
<a href="#l8.94"></a><span id="l8.94" class="difflineat">@@ -1548,88 +1508,47 @@ bool nsMsgCompose::IsLastWindow()</span>
<a href="#l8.95"></a><span id="l8.95">       if (NS_SUCCEEDED(windowEnumerator-&gt;GetNext(getter_AddRefs(isupports))))</span>
<a href="#l8.96"></a><span id="l8.96">         if (NS_SUCCEEDED(windowEnumerator-&gt;HasMoreElements(&amp;more)))</span>
<a href="#l8.97"></a><span id="l8.97">           return !more;</span>
<a href="#l8.98"></a><span id="l8.98">     }</span>
<a href="#l8.99"></a><span id="l8.99">   }</span>
<a href="#l8.100"></a><span id="l8.100">   return true;</span>
<a href="#l8.101"></a><span id="l8.101"> }</span>
<a href="#l8.102"></a><span id="l8.102"> </span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::CloseWindow(bool recycleIt)</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::CloseWindow(void)</span>
<a href="#l8.105"></a><span id="l8.105"> {</span>
<a href="#l8.106"></a><span id="l8.106">   nsresult rv;</span>
<a href="#l8.107"></a><span id="l8.107"> </span>
<a href="#l8.108"></a><span id="l8.108">   nsCOMPtr&lt;nsIMsgComposeService&gt; composeService = do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.109"></a><span id="l8.109">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.110"></a><span id="l8.110"> </span>
<a href="#l8.111"></a><span id="l8.111">   // unregister the compose object with the compose service</span>
<a href="#l8.112"></a><span id="l8.112">   rv = composeService-&gt;UnregisterComposeDocShell(mDocShell);</span>
<a href="#l8.113"></a><span id="l8.113">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.114"></a><span id="l8.114">   mDocShell = nullptr;</span>
<a href="#l8.115"></a><span id="l8.115"> </span>
<a href="#l8.116"></a><span id="l8.116">   // ensure that the destructor of nsMsgSend is invoked to remove</span>
<a href="#l8.117"></a><span id="l8.117">   // temporary files.</span>
<a href="#l8.118"></a><span id="l8.118">   mMsgSend = nullptr;</span>
<a href="#l8.119"></a><span id="l8.119"> </span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-  recycleIt = recycleIt &amp;&amp; !IsLastWindow();</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-  if (recycleIt)</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-  {</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-    rv = composeService-&gt;CacheWindow(m_window, m_composeHTML, mRecyclingListener);</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-    {</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-      nsCOMPtr&lt;nsIHTMLEditor&gt; htmlEditor (do_QueryInterface(m_editor));</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-      NS_ASSERTION(htmlEditor, &quot;no editor&quot;);</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-      if (htmlEditor)</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-      {</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-        // XXX clear undo txn manager?</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineminus">-</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineminus">-        rv = m_editor-&gt;EnableUndo(false);</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineminus">-</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-        rv = htmlEditor-&gt;RebuildDocumentFromSource(EmptyString());</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-        rv = m_editor-&gt;EnableUndo(true);</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineminus">-        SetBodyModified(false);</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-      }</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">-      if (mRecyclingListener)</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-      {</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-        mRecyclingListener-&gt;OnClose();</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-        /**</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-         * In order to really free the memory, we need to call the JS garbage collector for our window.</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-         * If we don't call GC, the nsIMsgCompose object held by JS will not be released despite we set</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-         * the JS global that held it to null. Each time we reopen a recycled window, we allocate a new</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineminus">-         * nsIMsgCompose that we really need to be released when we recycle the window. In fact despite</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-         * we call GC here, the release won't occur right away. But if we don't call it, the release</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-         * will happen only when we physically close the window which will happen only on quit.</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-         */</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-        nsJSContext::PokeGC(JS::gcreason::NSJSCONTEXT_DESTROY);</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-      }</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-      return NS_OK;</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-    }</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-  }</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-</span>
<a href="#l8.161"></a><span id="l8.161">   //We are going away for real, we need to do some clean up first</span>
<a href="#l8.162"></a><span id="l8.162">   if (m_baseWindow)</span>
<a href="#l8.163"></a><span id="l8.163">   {</span>
<a href="#l8.164"></a><span id="l8.164">     if (m_editor)</span>
<a href="#l8.165"></a><span id="l8.165">     {</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-        /* The editor will be destroyed during yje close window.</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-         * Set it to null to be sure we won't use it anymore</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-         */</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+      // The editor will be destroyed during the close window.</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+      // Set it to null to be sure we won't use it anymore.</span>
<a href="#l8.171"></a><span id="l8.171">       m_editor = nullptr;</span>
<a href="#l8.172"></a><span id="l8.172">     }</span>
<a href="#l8.173"></a><span id="l8.173">     nsIBaseWindow * window = m_baseWindow;</span>
<a href="#l8.174"></a><span id="l8.174">     m_baseWindow = nullptr;</span>
<a href="#l8.175"></a><span id="l8.175">     rv = window-&gt;Destroy();</span>
<a href="#l8.176"></a><span id="l8.176">   }</span>
<a href="#l8.177"></a><span id="l8.177"> </span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+  m_window = nullptr;</span>
<a href="#l8.179"></a><span id="l8.179">   return rv;</span>
<a href="#l8.180"></a><span id="l8.180"> }</span>
<a href="#l8.181"></a><span id="l8.181"> </span>
<a href="#l8.182"></a><span id="l8.182"> nsresult nsMsgCompose::Abort()</span>
<a href="#l8.183"></a><span id="l8.183"> {</span>
<a href="#l8.184"></a><span id="l8.184">   if (mMsgSend)</span>
<a href="#l8.185"></a><span id="l8.185">     mMsgSend-&gt;Abort();</span>
<a href="#l8.186"></a><span id="l8.186"> </span>
<a href="#l8.187"></a><span id="l8.187" class="difflineat">@@ -3754,31 +3673,31 @@ nsresult nsMsgComposeSendListener::OnSto</span>
<a href="#l8.188"></a><span id="l8.188">           {</span>
<a href="#l8.189"></a><span id="l8.189">             msgCompose-&gt;NotifyStateListeners(nsIMsgComposeNotificationType::ComposeProcessDone, NS_OK);</span>
<a href="#l8.190"></a><span id="l8.190">             if (progress)</span>
<a href="#l8.191"></a><span id="l8.191">             {</span>
<a href="#l8.192"></a><span id="l8.192">               progress-&gt;UnregisterListener(this);</span>
<a href="#l8.193"></a><span id="l8.193">               progress-&gt;CloseProgressDialog(false);</span>
<a href="#l8.194"></a><span id="l8.194">             }</span>
<a href="#l8.195"></a><span id="l8.195">             if (hasDomWindow)</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineminus">-              msgCompose-&gt;CloseWindow(true);</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+              msgCompose-&gt;CloseWindow();</span>
<a href="#l8.198"></a><span id="l8.198">           }</span>
<a href="#l8.199"></a><span id="l8.199">         }</span>
<a href="#l8.200"></a><span id="l8.200">       }</span>
<a href="#l8.201"></a><span id="l8.201">       else</span>
<a href="#l8.202"></a><span id="l8.202">       {</span>
<a href="#l8.203"></a><span id="l8.203">         msgCompose-&gt;NotifyStateListeners(nsIMsgComposeNotificationType::ComposeProcessDone, NS_OK);</span>
<a href="#l8.204"></a><span id="l8.204">         if (progress)</span>
<a href="#l8.205"></a><span id="l8.205">         {</span>
<a href="#l8.206"></a><span id="l8.206">           progress-&gt;UnregisterListener(this);</span>
<a href="#l8.207"></a><span id="l8.207">           progress-&gt;CloseProgressDialog(false);</span>
<a href="#l8.208"></a><span id="l8.208">         }</span>
<a href="#l8.209"></a><span id="l8.209">         if (hasDomWindow)</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineminus">-          msgCompose-&gt;CloseWindow(true);  // if we fail on the simple GetFcc call, close the window to be safe and avoid</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineminus">-                                              // windows hanging around to prevent the app from exiting.</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+          msgCompose-&gt;CloseWindow();  // if we fail on the simple GetFcc call, close the window to be safe and avoid</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+                                      // windows hanging around to prevent the app from exiting.</span>
<a href="#l8.214"></a><span id="l8.214">       }</span>
<a href="#l8.215"></a><span id="l8.215"> </span>
<a href="#l8.216"></a><span id="l8.216">       // Remove the current draft msg when sending draft is done.</span>
<a href="#l8.217"></a><span id="l8.217">       bool deleteDraft;</span>
<a href="#l8.218"></a><span id="l8.218">       msgCompose-&gt;GetDeleteDraft(&amp;deleteDraft);</span>
<a href="#l8.219"></a><span id="l8.219">       if (deleteDraft)</span>
<a href="#l8.220"></a><span id="l8.220">         RemoveCurrentDraftMessage(msgCompose, false);</span>
<a href="#l8.221"></a><span id="l8.221">     }</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineat">@@ -3870,17 +3789,17 @@ nsMsgComposeSendListener::OnStopCopy(nsr</span>
<a href="#l8.223"></a><span id="l8.223">       {</span>
<a href="#l8.224"></a><span id="l8.224">         // Remove (possible) draft if we're in send later mode</span>
<a href="#l8.225"></a><span id="l8.225">         if (mDeliverMode == nsIMsgSend::nsMsgQueueForLater ||</span>
<a href="#l8.226"></a><span id="l8.226">             mDeliverMode == nsIMsgSend::nsMsgDeliverBackground)</span>
<a href="#l8.227"></a><span id="l8.227">         {</span>
<a href="#l8.228"></a><span id="l8.228">           msgCompose-&gt;SetDeleteDraft(true);</span>
<a href="#l8.229"></a><span id="l8.229">           RemoveCurrentDraftMessage(msgCompose, true);</span>
<a href="#l8.230"></a><span id="l8.230">         }</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineminus">-        msgCompose-&gt;CloseWindow(true);</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+        msgCompose-&gt;CloseWindow();</span>
<a href="#l8.233"></a><span id="l8.233">       }</span>
<a href="#l8.234"></a><span id="l8.234">     }</span>
<a href="#l8.235"></a><span id="l8.235">     msgCompose-&gt;ClearMessageSend();</span>
<a href="#l8.236"></a><span id="l8.236">   }</span>
<a href="#l8.237"></a><span id="l8.237"> </span>
<a href="#l8.238"></a><span id="l8.238">   return rv;</span>
<a href="#l8.239"></a><span id="l8.239"> }</span>
<a href="#l8.240"></a><span id="l8.240"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -108,18 +108,16 @@ protected:</span>
<a href="#l9.4"></a><span id="l9.4">   nsCOMPtr&lt;nsIDocShell&gt;                     mDocShell;</span>
<a href="#l9.5"></a><span id="l9.5">   nsCOMPtr&lt;nsIBaseWindow&gt;                   m_baseWindow;</span>
<a href="#l9.6"></a><span id="l9.6">   nsMsgCompFields                           *m_compFields;</span>
<a href="#l9.7"></a><span id="l9.7">   nsCOMPtr&lt;nsIMsgIdentity&gt;                  m_identity;</span>
<a href="#l9.8"></a><span id="l9.8">   bool                                      m_composeHTML;</span>
<a href="#l9.9"></a><span id="l9.9">   QuotingOutputStreamListener               *mQuoteStreamListener;</span>
<a href="#l9.10"></a><span id="l9.10">   nsCOMPtr&lt;nsIOutputStream&gt;                 mBaseStream;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  nsCOMPtr&lt;nsIMsgComposeRecyclingListener&gt;  mRecyclingListener;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-  bool                                      mRecycledWindow;</span>
<a href="#l9.14"></a><span id="l9.14">   nsCOMPtr&lt;nsIMsgSend&gt;                      mMsgSend;           // for composition back end</span>
<a href="#l9.15"></a><span id="l9.15">   nsCOMPtr&lt;nsIMsgProgress&gt;                  mProgress;          // use by the back end to report progress to the front end</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17">   // Deal with quoting issues...</span>
<a href="#l9.18"></a><span id="l9.18">   nsString                                  mCiteReference;</span>
<a href="#l9.19"></a><span id="l9.19">   nsCOMPtr&lt;nsIMsgQuote&gt;                     mQuote;</span>
<a href="#l9.20"></a><span id="l9.20">   bool                                      mQuotingToFollow;   // Quoting indicator</span>
<a href="#l9.21"></a><span id="l9.21">   MSG_ComposeType                           mType;              // Message type</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -67,18 +67,16 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #ifdef XP_WIN32</span>
<a href="#l10.5"></a><span id="l10.5"> #include &lt;windows.h&gt;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &lt;shellapi.h&gt;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nsIWidget.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #endif</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> #define DEFAULT_CHROME  &quot;chrome://messenger/content/messengercompose/messengercompose.xul&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-#define PREF_MAIL_COMPOSE_MAXRECYCLEDWINDOWS  &quot;mail.compose.max_recycled_windows&quot;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-</span>
<a href="#l10.14"></a><span id="l10.14"> #define PREF_MAILNEWS_REPLY_QUOTING_SELECTION            &quot;mailnews.reply_quoting_selection&quot;</span>
<a href="#l10.15"></a><span id="l10.15"> #define PREF_MAILNEWS_REPLY_QUOTING_SELECTION_MULTI_WORD &quot;mailnews.reply_quoting_selection.multi_word&quot;</span>
<a href="#l10.16"></a><span id="l10.16"> #define PREF_MAILNEWS_REPLY_QUOTING_SELECTION_ONLY_IF    &quot;mailnews.reply_quoting_selection.only_if_chars&quot;</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18"> #define MAIL_ROOT_PREF                             &quot;mail.&quot;</span>
<a href="#l10.19"></a><span id="l10.19"> #define MAILNEWS_ROOT_PREF                         &quot;mailnews.&quot;</span>
<a href="#l10.20"></a><span id="l10.20"> #define HTMLDOMAINUPDATE_VERSION_PREF_NAME         &quot;global_html_domains.version&quot;</span>
<a href="#l10.21"></a><span id="l10.21"> #define HTMLDOMAINUPDATE_DOMAINLIST_PREF_NAME      &quot;global_html_domains&quot;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineat">@@ -113,104 +111,50 @@ nsMsgComposeService::nsMsgComposeService</span>
<a href="#l10.23"></a><span id="l10.23"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span>
<a href="#l10.24"></a><span id="l10.24">   if (!MsgComposeLogModule)</span>
<a href="#l10.25"></a><span id="l10.25">       MsgComposeLogModule = PR_NewLogModule(&quot;msgcompose&quot;);</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27">   mStartTime = PR_IntervalNow();</span>
<a href="#l10.28"></a><span id="l10.28">   mPreviousTime = mStartTime;</span>
<a href="#l10.29"></a><span id="l10.29"> #endif</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  mMaxRecycledWindows = 0;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-  mCachedWindows = nullptr;</span>
<a href="#l10.33"></a><span id="l10.33"> }</span>
<a href="#l10.34"></a><span id="l10.34"> </span>
<a href="#l10.35"></a><span id="l10.35"> NS_IMPL_ISUPPORTS(nsMsgComposeService,</span>
<a href="#l10.36"></a><span id="l10.36">                    nsIMsgComposeService,</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-                   nsIObserver,</span>
<a href="#l10.38"></a><span id="l10.38">                    ICOMMANDLINEHANDLER,</span>
<a href="#l10.39"></a><span id="l10.39">                    nsISupportsWeakReference)</span>
<a href="#l10.40"></a><span id="l10.40"> </span>
<a href="#l10.41"></a><span id="l10.41"> nsMsgComposeService::~nsMsgComposeService()</span>
<a href="#l10.42"></a><span id="l10.42"> {</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-  if (mCachedWindows)</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-  {</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-    DeleteCachedWindows();</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-    delete [] mCachedWindows;</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-  }</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-</span>
<a href="#l10.49"></a><span id="l10.49">   mOpenComposeWindows.Clear();</span>
<a href="#l10.50"></a><span id="l10.50"> }</span>
<a href="#l10.51"></a><span id="l10.51"> </span>
<a href="#l10.52"></a><span id="l10.52"> nsresult nsMsgComposeService::Init()</span>
<a href="#l10.53"></a><span id="l10.53"> {</span>
<a href="#l10.54"></a><span id="l10.54">   nsresult rv = NS_OK;</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-  // Register observers</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-  // Register for quit application and profile change, we will need to clear the cache.</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-  nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-    mozilla::services::GetObserverService();</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-  if (observerService)</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-  {</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-    rv = observerService-&gt;AddObserver(this, &quot;quit-application&quot;, true);</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-    rv = observerService-&gt;AddObserver(this, &quot;profile-do-change&quot;, true);</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-  }</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-  // Register some pref observer</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pbi = do_GetService(NS_PREFSERVICE_CONTRACTID);</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-  if (pbi)</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-    rv = pbi-&gt;AddObserver(PREF_MAIL_COMPOSE_MAXRECYCLEDWINDOWS, this, true);</span>
<a href="#l10.70"></a><span id="l10.70"> </span>
<a href="#l10.71"></a><span id="l10.71">   Reset();</span>
<a href="#l10.72"></a><span id="l10.72"> </span>
<a href="#l10.73"></a><span id="l10.73">   AddGlobalHtmlDomains();</span>
<a href="#l10.74"></a><span id="l10.74">   // Since the compose service should only be initialized once, we can</span>
<a href="#l10.75"></a><span id="l10.75">   // be pretty sure there aren't any existing compose windows open.</span>
<a href="#l10.76"></a><span id="l10.76">   MsgCleanupTempFiles(&quot;nsmail&quot;, &quot;tmp&quot;);</span>
<a href="#l10.77"></a><span id="l10.77">   MsgCleanupTempFiles(&quot;nsemail&quot;, &quot;html&quot;);</span>
<a href="#l10.78"></a><span id="l10.78">   MsgCleanupTempFiles(&quot;nscopy&quot;, &quot;tmp&quot;);</span>
<a href="#l10.79"></a><span id="l10.79">   return rv;</span>
<a href="#l10.80"></a><span id="l10.80"> }</span>
<a href="#l10.81"></a><span id="l10.81"> </span>
<a href="#l10.82"></a><span id="l10.82"> void nsMsgComposeService::Reset()</span>
<a href="#l10.83"></a><span id="l10.83"> {</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-  if (mCachedWindows)</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-  {</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-    DeleteCachedWindows();</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-    delete [] mCachedWindows;</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-    mCachedWindows = nullptr;</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-    mMaxRecycledWindows = 0;</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-  }</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-</span>
<a href="#l10.94"></a><span id="l10.94">   mOpenComposeWindows.Clear();</span>
<a href="#l10.95"></a><span id="l10.95"> </span>
<a href="#l10.96"></a><span id="l10.96">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-  if(prefs)</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-    rv = prefs-&gt;GetIntPref(PREF_MAIL_COMPOSE_MAXRECYCLEDWINDOWS, &amp;mMaxRecycledWindows);</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; mMaxRecycledWindows &gt; 0)</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-  {</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-    mCachedWindows = new nsMsgCachedWindowInfo[mMaxRecycledWindows];</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-    if (!mCachedWindows)</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-      mMaxRecycledWindows = 0;</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-  }</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-  rv = prefs-&gt;GetBoolPref(&quot;mailnews.logComposePerformance&quot;, &amp;mLogComposePerformance);</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-  return;</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineminus">-}</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-void nsMsgComposeService::DeleteCachedWindows()</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-{</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-  int32_t i;</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineminus">-  for (i = 0; i &lt; mMaxRecycledWindows; i ++)</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineminus">-  {</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-    CloseHiddenCachedWindow(mCachedWindows[i].window);</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineminus">-    mCachedWindows[i].Clear();</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineminus">-  }</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+  if (prefs)</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+    prefs-&gt;GetBoolPref(&quot;mailnews.logComposePerformance&quot;, &amp;mLogComposePerformance);</span>
<a href="#l10.121"></a><span id="l10.121"> }</span>
<a href="#l10.122"></a><span id="l10.122"> </span>
<a href="#l10.123"></a><span id="l10.123"> // Function to open a message compose window and pass an nsIMsgComposeParams</span>
<a href="#l10.124"></a><span id="l10.124"> // parameter to it.</span>
<a href="#l10.125"></a><span id="l10.125"> NS_IMETHODIMP</span>
<a href="#l10.126"></a><span id="l10.126"> nsMsgComposeService::OpenComposeWindowWithParams(const char *chrome,</span>
<a href="#l10.127"></a><span id="l10.127">                                                  nsIMsgComposeParams *params)</span>
<a href="#l10.128"></a><span id="l10.128"> {</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineat">@@ -230,48 +174,17 @@ nsMsgComposeService::OpenComposeWindowWi</span>
<a href="#l10.130"></a><span id="l10.130">   nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l10.131"></a><span id="l10.131">   params-&gt;GetIdentity(getter_AddRefs(identity));</span>
<a href="#l10.132"></a><span id="l10.132">   if (!identity)</span>
<a href="#l10.133"></a><span id="l10.133">   {</span>
<a href="#l10.134"></a><span id="l10.134">     GetDefaultIdentity(getter_AddRefs(identity));</span>
<a href="#l10.135"></a><span id="l10.135">     params-&gt;SetIdentity(identity);</span>
<a href="#l10.136"></a><span id="l10.136">   }</span>
<a href="#l10.137"></a><span id="l10.137"> </span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-  //if we have a cached window for the default chrome, try to reuse it...</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-  if (!chrome || PL_strcasecmp(chrome, DEFAULT_CHROME) == 0)</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineminus">-  {</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineminus">-    MSG_ComposeFormat format;</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineminus">-    params-&gt;GetFormat(&amp;format);</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineminus">-</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineminus">-    bool composeHTML = true;</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineminus">-    rv = DetermineComposeHTML(identity, format, &amp;composeHTML);</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineminus">-    {</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-      int32_t i;</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineminus">-      for (i = 0; i &lt; mMaxRecycledWindows; i ++)</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineminus">-      {</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineminus">-        if (mCachedWindows[i].window &amp;&amp; (mCachedWindows[i].htmlCompose == composeHTML) &amp;&amp; mCachedWindows[i].listener)</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineminus">-        {</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineminus">-          /* We need to save the window pointer as OnReopen will call nsMsgComposeService::InitCompose which will</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineminus">-             clear the cache entry if everything goes well</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineminus">-          */</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineminus">-          nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWindow(mCachedWindows[i].window);</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineminus">-          nsCOMPtr&lt;nsIXULWindow&gt; xulWindow(mCachedWindows[i].xulWindow);</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineminus">-          rv = ShowCachedComposeWindow(domWindow, xulWindow, true);</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineminus">-          {</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineminus">-            mCachedWindows[i].listener-&gt;OnReopen(params);</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineminus">-            return NS_OK;</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineminus">-          }</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineminus">-        }</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineminus">-      }</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineminus">-    }</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineminus">-  }</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineminus">-</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineminus">-  //Else, create a new one...</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+  // Create a new window.</span>
<a href="#l10.171"></a><span id="l10.171">   nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l10.172"></a><span id="l10.172">   if (!wwatch)</span>
<a href="#l10.173"></a><span id="l10.173">     return NS_ERROR_FAILURE;</span>
<a href="#l10.174"></a><span id="l10.174"> </span>
<a href="#l10.175"></a><span id="l10.175">   nsCOMPtr&lt;nsISupportsInterfacePointer&gt; msgParamsWrapper =</span>
<a href="#l10.176"></a><span id="l10.176">     do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l10.177"></a><span id="l10.177">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.178"></a><span id="l10.178"> </span>
<a href="#l10.179"></a><span id="l10.179" class="difflineat">@@ -281,73 +194,16 @@ nsMsgComposeService::OpenComposeWindowWi</span>
<a href="#l10.180"></a><span id="l10.180">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; newWindow;</span>
<a href="#l10.181"></a><span id="l10.181">   rv = wwatch-&gt;OpenWindow(0, chrome &amp;&amp; *chrome ? chrome : DEFAULT_CHROME,</span>
<a href="#l10.182"></a><span id="l10.182">                  &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;, msgParamsWrapper,</span>
<a href="#l10.183"></a><span id="l10.183">                  getter_AddRefs(newWindow));</span>
<a href="#l10.184"></a><span id="l10.184"> </span>
<a href="#l10.185"></a><span id="l10.185">   return rv;</span>
<a href="#l10.186"></a><span id="l10.186"> }</span>
<a href="#l10.187"></a><span id="l10.187"> </span>
<a href="#l10.188"></a><span id="l10.188" class="difflineminus">-void nsMsgComposeService::CloseHiddenCachedWindow(mozIDOMWindowProxy *domWindow)</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineminus">-{</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineminus">-  if (domWindow)</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineminus">-  {</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineminus">-    nsCOMPtr&lt;nsIDocShell&gt; docshell;</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineminus">-    if (domWindow)</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineminus">-    {</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineminus">-      nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window = nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineminus">-      nsCOMPtr&lt;nsIDocShellTreeItem&gt; treeItem =</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineminus">-        do_QueryInterface(window-&gt;GetDocShell());</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineminus">-</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineminus">-      if (treeItem)</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineminus">-      {</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineminus">-        nsCOMPtr&lt;nsIDocShellTreeOwner&gt; treeOwner;</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineminus">-        treeItem-&gt;GetTreeOwner(getter_AddRefs(treeOwner));</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineminus">-        if (treeOwner)</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineminus">-        {</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineminus">-          nsCOMPtr&lt;nsIBaseWindow&gt; baseWindow;</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineminus">-          baseWindow = do_QueryInterface(treeOwner);</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineminus">-          if (baseWindow) {</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineminus">-            // HACK ALERT: when we hid this window we fired the &quot;xul-window-destroyed&quot;</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineminus">-            // notification for it. Now that it's being really-destroyed it will fire that</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineminus">-            // notification *again* for itself. The appstartup code maintains an internal</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineminus">-            // reference count of windows that block app shutdown: we want to increment that</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineminus">-            // count without cancelling app shutdown (so don't use &quot;xul-window-registered&quot;).</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineminus">-            nsCOMPtr&lt;nsIAppStartup&gt; appStartup(do_GetService(NS_APPSTARTUP_CONTRACTID));</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineminus">-            if (appStartup)</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineminus">-              appStartup-&gt;EnterLastWindowClosingSurvivalArea();</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineminus">-</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineminus">-            baseWindow-&gt;Destroy();</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineminus">-          }</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineminus">-        }</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineminus">-      }</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineminus">-    }</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineminus">-  }</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineminus">-}</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineminus">-</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineminus">-nsMsgComposeService::Observe(nsISupports *aSubject, const char *aTopic, const char16_t *someData)</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineminus">-{</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineminus">-  if (!strcmp(aTopic, &quot;profile-do-change&quot;) || !strcmp(aTopic, &quot;quit-application&quot;))</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineminus">-  {</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineminus">-    DeleteCachedWindows();</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineminus">-  }</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineminus">-</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineminus">-  if (!strcmp(aTopic, NS_PREFBRANCH_PREFCHANGE_TOPIC_ID))</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineminus">-  {</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineminus">-    nsDependentString prefName(someData);</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineminus">-    if (prefName.EqualsLiteral(PREF_MAIL_COMPOSE_MAXRECYCLEDWINDOWS))</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineminus">-      Reset();</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineminus">-    return NS_OK;</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineminus">-  }</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineminus">-</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineminus">-  return NS_OK;</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineminus">-}</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineminus">-</span>
<a href="#l10.245"></a><span id="l10.245"> NS_IMETHODIMP</span>
<a href="#l10.246"></a><span id="l10.246"> nsMsgComposeService::DetermineComposeHTML(nsIMsgIdentity *aIdentity, MSG_ComposeFormat aFormat, bool *aComposeHTML)</span>
<a href="#l10.247"></a><span id="l10.247"> {</span>
<a href="#l10.248"></a><span id="l10.248">   NS_ENSURE_ARG_POINTER(aComposeHTML);</span>
<a href="#l10.249"></a><span id="l10.249"> </span>
<a href="#l10.250"></a><span id="l10.250">   *aComposeHTML = true;</span>
<a href="#l10.251"></a><span id="l10.251">   switch (aFormat)</span>
<a href="#l10.252"></a><span id="l10.252">   {</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineat">@@ -709,25 +565,16 @@ NS_IMETHODIMP nsMsgComposeService::OpenC</span>
<a href="#l10.254"></a><span id="l10.254">   return rv;</span>
<a href="#l10.255"></a><span id="l10.255"> }</span>
<a href="#l10.256"></a><span id="l10.256"> </span>
<a href="#l10.257"></a><span id="l10.257"> NS_IMETHODIMP nsMsgComposeService::InitCompose(nsIMsgComposeParams *aParams,</span>
<a href="#l10.258"></a><span id="l10.258">                                                mozIDOMWindowProxy *aWindow,</span>
<a href="#l10.259"></a><span id="l10.259">                                                nsIDocShell *aDocShell,</span>
<a href="#l10.260"></a><span id="l10.260">                                                nsIMsgCompose **_retval)</span>
<a href="#l10.261"></a><span id="l10.261"> {</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineminus">-  // We need to remove the window from the cache.</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineminus">-  int32_t i;</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineminus">-  for (i = 0; i &lt; mMaxRecycledWindows; i ++)</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineminus">-    if (mCachedWindows[i].window == aWindow)</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineminus">-    {</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineminus">-      mCachedWindows[i].Clear();</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineminus">-      break;</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineminus">-    }</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineminus">-</span>
<a href="#l10.271"></a><span id="l10.271">   nsresult rv;</span>
<a href="#l10.272"></a><span id="l10.272">   nsCOMPtr&lt;nsIMsgCompose&gt; msgCompose =</span>
<a href="#l10.273"></a><span id="l10.273">     do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv);</span>
<a href="#l10.274"></a><span id="l10.274">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.275"></a><span id="l10.275"> </span>
<a href="#l10.276"></a><span id="l10.276">   rv = msgCompose-&gt;Initialize(aParams, aWindow, aDocShell);</span>
<a href="#l10.277"></a><span id="l10.277">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.278"></a><span id="l10.278"> </span>
<a href="#l10.279"></a><span id="l10.279" class="difflineat">@@ -785,99 +632,16 @@ NS_IMETHODIMP nsMsgComposeService::TimeS</span>
<a href="#l10.280"></a><span id="l10.280">   MOZ_LOG(MsgComposeLogModule, mozilla::LogLevel::Info, (&quot;[%3.2f][%3.2f] - %s\n&quot;,</span>
<a href="#l10.281"></a><span id="l10.281"> ((double)totalTime/1000.0) + 0.005, ((double)deltaTime/1000.0) + 0.005, label));</span>
<a href="#l10.282"></a><span id="l10.282"> </span>
<a href="#l10.283"></a><span id="l10.283">   mPreviousTime = now;</span>
<a href="#l10.284"></a><span id="l10.284"> #endif</span>
<a href="#l10.285"></a><span id="l10.285">   return NS_OK;</span>
<a href="#l10.286"></a><span id="l10.286"> }</span>
<a href="#l10.287"></a><span id="l10.287"> </span>
<a href="#l10.288"></a><span id="l10.288" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineminus">-nsMsgComposeService::IsCachedWindow(mozIDOMWindowProxy *aCachedWindow, bool *aIsCachedWindow)</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineminus">-{</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aCachedWindow);</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aIsCachedWindow);</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineminus">-</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineminus">-  int32_t i;</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineminus">-  for (i = 0; i &lt; mMaxRecycledWindows; i ++)</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineminus">-    if (mCachedWindows[i].window.get() == aCachedWindow)</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineminus">-    {</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineminus">-      *aIsCachedWindow = true;</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineminus">-      return NS_OK;</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineminus">-    }</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineminus">-</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineminus">- *aIsCachedWindow = false;</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineminus">-  return NS_OK;</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineminus">-}</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineminus">-</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineminus">-nsMsgComposeService::CacheWindow(mozIDOMWindowProxy *aWindow, bool aComposeHTML, nsIMsgComposeRecyclingListener * aListener)</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineminus">-{</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineminus">-</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineminus">-  nsresult rv;</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineminus">-  nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window = nsPIDOMWindowOuter::From(aWindow);</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineminus">-</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineminus">-  nsCOMPtr&lt;nsIDocShellTreeItem&gt; treeItem(do_QueryInterface(window-&gt;GetDocShell(), &amp;rv));</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineminus">-</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineminus">-  nsCOMPtr &lt;nsIDocShellTreeOwner&gt; treeOwner;</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineminus">-  rv = treeItem-&gt;GetTreeOwner(getter_AddRefs(treeOwner));</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineminus">-</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineminus">-  nsCOMPtr&lt;nsIXULWindow&gt; xulWindow(do_GetInterface(treeOwner, &amp;rv));</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineminus">-</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineminus">-  int32_t i;</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineminus">-  int32_t sameTypeId = -1;</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineminus">-  int32_t oppositeTypeId = -1;</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineminus">-</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineminus">-  for (i = 0; i &lt; mMaxRecycledWindows; i ++)</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineminus">-  {</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineminus">-    if (!mCachedWindows[i].window)</span>
<a href="#l10.332"></a><span id="l10.332" class="difflineminus">-    {</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineminus">-      rv = ShowCachedComposeWindow(aWindow, xulWindow, false);</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineminus">-        mCachedWindows[i].Initialize(aWindow, xulWindow, aListener, aComposeHTML);</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineminus">-</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineminus">-      return rv;</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineminus">-    }</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineminus">-    else</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineminus">-      if (mCachedWindows[i].htmlCompose == aComposeHTML)</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineminus">-      {</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineminus">-        if (sameTypeId == -1)</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineminus">-          sameTypeId = i;</span>
<a href="#l10.344"></a><span id="l10.344" class="difflineminus">-      }</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineminus">-      else</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineminus">-      {</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineminus">-        if (oppositeTypeId == -1)</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineminus">-          oppositeTypeId = i;</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineminus">-      }</span>
<a href="#l10.350"></a><span id="l10.350" class="difflineminus">-  }</span>
<a href="#l10.351"></a><span id="l10.351" class="difflineminus">-</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineminus">-  /* Looks like the cache is full. In the case we try to cache a type (html or plain text) of compose window which is not</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineminus">-     already cached, we should replace an opposite one with this new one. That would allow users to be able to take advantage</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineminus">-     of the cached compose window when they switch from one type to another one</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineminus">-  */</span>
<a href="#l10.356"></a><span id="l10.356" class="difflineminus">-  if (sameTypeId == -1 &amp;&amp; oppositeTypeId != -1)</span>
<a href="#l10.357"></a><span id="l10.357" class="difflineminus">-  {</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineminus">-    CloseHiddenCachedWindow(mCachedWindows[oppositeTypeId].window);</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineminus">-    mCachedWindows[oppositeTypeId].Clear();</span>
<a href="#l10.360"></a><span id="l10.360" class="difflineminus">-</span>
<a href="#l10.361"></a><span id="l10.361" class="difflineminus">-    rv = ShowCachedComposeWindow(aWindow, xulWindow, false);</span>
<a href="#l10.362"></a><span id="l10.362" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l10.363"></a><span id="l10.363" class="difflineminus">-      mCachedWindows[oppositeTypeId].Initialize(aWindow, xulWindow, aListener, aComposeHTML);</span>
<a href="#l10.364"></a><span id="l10.364" class="difflineminus">-</span>
<a href="#l10.365"></a><span id="l10.365" class="difflineminus">-    return rv;</span>
<a href="#l10.366"></a><span id="l10.366" class="difflineminus">-  }</span>
<a href="#l10.367"></a><span id="l10.367" class="difflineminus">-</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineminus">-  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l10.369"></a><span id="l10.369" class="difflineminus">-}</span>
<a href="#l10.370"></a><span id="l10.370" class="difflineminus">-</span>
<a href="#l10.371"></a><span id="l10.371"> class nsMsgTemplateReplyHelper final: public nsIStreamListener,</span>
<a href="#l10.372"></a><span id="l10.372">                                       public nsIUrlListener</span>
<a href="#l10.373"></a><span id="l10.373"> {</span>
<a href="#l10.374"></a><span id="l10.374"> public:</span>
<a href="#l10.375"></a><span id="l10.375">   NS_DECL_ISUPPORTS</span>
<a href="#l10.376"></a><span id="l10.376">   NS_DECL_NSIURLLISTENER</span>
<a href="#l10.377"></a><span id="l10.377">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l10.378"></a><span id="l10.378">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l10.379"></a><span id="l10.379" class="difflineat">@@ -1290,84 +1054,16 @@ nsMsgComposeService::ForwardMessage(cons</span>
<a href="#l10.380"></a><span id="l10.380">   // nsMsgCompose::ProcessReplyFlags usually takes care of marking messages</span>
<a href="#l10.381"></a><span id="l10.381">   // as forwarded. ProcessReplyFlags is normally called from</span>
<a href="#l10.382"></a><span id="l10.382">   // nsMsgComposeSendListener::OnStopSending but for this case the msgCompose</span>
<a href="#l10.383"></a><span id="l10.383">   // object is not set so ProcessReplyFlags won't get called.</span>
<a href="#l10.384"></a><span id="l10.384">   // Therefore, let's just mark it here instead.</span>
<a href="#l10.385"></a><span id="l10.385">   return folder-&gt;AddMessageDispositionState(aMsgHdr, nsIMsgFolder::nsMsgDispositionState_Forwarded);</span>
<a href="#l10.386"></a><span id="l10.386"> }</span>
<a href="#l10.387"></a><span id="l10.387"> </span>
<a href="#l10.388"></a><span id="l10.388" class="difflineminus">-nsresult nsMsgComposeService::ShowCachedComposeWindow(mozIDOMWindowProxy *aComposeWindow, nsIXULWindow *aXULWindow, bool aShow)</span>
<a href="#l10.389"></a><span id="l10.389" class="difflineminus">-{</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l10.391"></a><span id="l10.391" class="difflineminus">-</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineminus">-  nsCOMPtr&lt;nsIObserverService&gt; obs =</span>
<a href="#l10.393"></a><span id="l10.393" class="difflineminus">-    mozilla::services::GetObserverService();</span>
<a href="#l10.394"></a><span id="l10.394" class="difflineminus">-  NS_ENSURE_TRUE(obs, NS_ERROR_UNEXPECTED);</span>
<a href="#l10.395"></a><span id="l10.395" class="difflineminus">-</span>
<a href="#l10.396"></a><span id="l10.396" class="difflineminus">-  NS_ENSURE_TRUE(aComposeWindow, NS_ERROR_FAILURE);</span>
<a href="#l10.397"></a><span id="l10.397" class="difflineminus">-  nsCOMPtr &lt;nsPIDOMWindowOuter&gt; window = nsPIDOMWindowOuter::From(aComposeWindow);</span>
<a href="#l10.398"></a><span id="l10.398" class="difflineminus">-</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineminus">-  nsIDocShell *docShell = window-&gt;GetDocShell();</span>
<a href="#l10.400"></a><span id="l10.400" class="difflineminus">-</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineminus">-  nsCOMPtr &lt;nsIDocShellTreeItem&gt; treeItem = do_QueryInterface(docShell, &amp;rv);</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.403"></a><span id="l10.403" class="difflineminus">-</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineminus">-  nsCOMPtr &lt;nsIDocShellTreeOwner&gt; treeOwner;</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineminus">-  rv = treeItem-&gt;GetTreeOwner(getter_AddRefs(treeOwner));</span>
<a href="#l10.406"></a><span id="l10.406" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineminus">-</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineminus">-  if (treeOwner) {</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineminus">-    // the window need to be sticky before we hide it.</span>
<a href="#l10.410"></a><span id="l10.410" class="difflineminus">-    nsCOMPtr&lt;nsIContentViewer&gt; contentViewer;</span>
<a href="#l10.411"></a><span id="l10.411" class="difflineminus">-    rv = docShell-&gt;GetContentViewer(getter_AddRefs(contentViewer));</span>
<a href="#l10.412"></a><span id="l10.412" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.413"></a><span id="l10.413" class="difflineminus">-</span>
<a href="#l10.414"></a><span id="l10.414" class="difflineminus">-    rv = contentViewer-&gt;SetSticky(!aShow);</span>
<a href="#l10.415"></a><span id="l10.415" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.416"></a><span id="l10.416" class="difflineminus">-</span>
<a href="#l10.417"></a><span id="l10.417" class="difflineminus">-    // disable (enable) the cached window</span>
<a href="#l10.418"></a><span id="l10.418" class="difflineminus">-    nsCOMPtr&lt;nsIBaseWindow&gt; baseWindow;</span>
<a href="#l10.419"></a><span id="l10.419" class="difflineminus">-    baseWindow = do_QueryInterface(treeOwner, &amp;rv);</span>
<a href="#l10.420"></a><span id="l10.420" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.421"></a><span id="l10.421" class="difflineminus">-</span>
<a href="#l10.422"></a><span id="l10.422" class="difflineminus">-    baseWindow-&gt;SetEnabled(aShow);</span>
<a href="#l10.423"></a><span id="l10.423" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.424"></a><span id="l10.424" class="difflineminus">-</span>
<a href="#l10.425"></a><span id="l10.425" class="difflineminus">-    nsCOMPtr&lt;nsIWindowMediator&gt; windowMediator =</span>
<a href="#l10.426"></a><span id="l10.426" class="difflineminus">-	         do_GetService(NS_WINDOWMEDIATOR_CONTRACTID, &amp;rv);</span>
<a href="#l10.427"></a><span id="l10.427" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.428"></a><span id="l10.428" class="difflineminus">-</span>
<a href="#l10.429"></a><span id="l10.429" class="difflineminus">-    // if showing, reinstate the window with the mediator</span>
<a href="#l10.430"></a><span id="l10.430" class="difflineminus">-    if (aShow) {</span>
<a href="#l10.431"></a><span id="l10.431" class="difflineminus">-      rv = windowMediator-&gt;RegisterWindow(aXULWindow);</span>
<a href="#l10.432"></a><span id="l10.432" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.433"></a><span id="l10.433" class="difflineminus">-</span>
<a href="#l10.434"></a><span id="l10.434" class="difflineminus">-      obs-&gt;NotifyObservers(aXULWindow, &quot;xul-window-registered&quot;, nullptr);</span>
<a href="#l10.435"></a><span id="l10.435" class="difflineminus">-    }</span>
<a href="#l10.436"></a><span id="l10.436" class="difflineminus">-</span>
<a href="#l10.437"></a><span id="l10.437" class="difflineminus">-    // hide (show) the cached window</span>
<a href="#l10.438"></a><span id="l10.438" class="difflineminus">-    rv = baseWindow-&gt;SetVisibility(aShow);</span>
<a href="#l10.439"></a><span id="l10.439" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.440"></a><span id="l10.440" class="difflineminus">-</span>
<a href="#l10.441"></a><span id="l10.441" class="difflineminus">-    // if hiding, remove the window from the mediator,</span>
<a href="#l10.442"></a><span id="l10.442" class="difflineminus">-    // so that it will be removed from the task list</span>
<a href="#l10.443"></a><span id="l10.443" class="difflineminus">-    if (!aShow) {</span>
<a href="#l10.444"></a><span id="l10.444" class="difflineminus">-      rv = windowMediator-&gt;UnregisterWindow(aXULWindow);</span>
<a href="#l10.445"></a><span id="l10.445" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.446"></a><span id="l10.446" class="difflineminus">-</span>
<a href="#l10.447"></a><span id="l10.447" class="difflineminus">-      obs-&gt;NotifyObservers(aXULWindow, &quot;xul-window-destroyed&quot;, nullptr);</span>
<a href="#l10.448"></a><span id="l10.448" class="difflineminus">-    }</span>
<a href="#l10.449"></a><span id="l10.449" class="difflineminus">-  }</span>
<a href="#l10.450"></a><span id="l10.450" class="difflineminus">-  else {</span>
<a href="#l10.451"></a><span id="l10.451" class="difflineminus">-    rv = NS_ERROR_FAILURE;</span>
<a href="#l10.452"></a><span id="l10.452" class="difflineminus">-  }</span>
<a href="#l10.453"></a><span id="l10.453" class="difflineminus">-  return rv;</span>
<a href="#l10.454"></a><span id="l10.454" class="difflineminus">-}</span>
<a href="#l10.455"></a><span id="l10.455" class="difflineminus">-</span>
<a href="#l10.456"></a><span id="l10.456"> nsresult nsMsgComposeService::AddGlobalHtmlDomains()</span>
<a href="#l10.457"></a><span id="l10.457"> {</span>
<a href="#l10.458"></a><span id="l10.458"> </span>
<a href="#l10.459"></a><span id="l10.459">   nsresult rv;</span>
<a href="#l10.460"></a><span id="l10.460">   nsCOMPtr&lt;nsIPrefService&gt; prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.461"></a><span id="l10.461">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.462"></a><span id="l10.462"> </span>
<a href="#l10.463"></a><span id="l10.463">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeService.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeService.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -12,85 +12,53 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsIMimeStreamConverter.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsICommandLineHandler.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #define ICOMMANDLINEHANDLER nsICommandLineHandler</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-class nsMsgCachedWindowInfo</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-{</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-public:</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-  void Initialize(mozIDOMWindowProxy *aWindow, nsIXULWindow *aXULWindow, nsIMsgComposeRecyclingListener *aListener, bool aHtmlCompose)</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-  {</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-    window = aWindow;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-    xulWindow = aXULWindow;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-    listener = aListener;</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-    htmlCompose = aHtmlCompose;</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-  }</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-    </span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-  void Clear()</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-  {</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-    window = nullptr;</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-    listener = nullptr;</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-  }</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-  </span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-  nsCOMPtr&lt;mozIDOMWindowProxy&gt;              window;</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-  nsCOMPtr&lt;nsIXULWindow&gt;                    xulWindow;</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-  nsCOMPtr&lt;nsIMsgComposeRecyclingListener&gt;  listener;</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-  bool                                      htmlCompose;</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-};</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-</span>
<a href="#l11.35"></a><span id="l11.35"> class nsMsgComposeService : </span>
<a href="#l11.36"></a><span id="l11.36">   public nsIMsgComposeService,</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-  public nsIObserver,</span>
<a href="#l11.38"></a><span id="l11.38">   public ICOMMANDLINEHANDLER,</span>
<a href="#l11.39"></a><span id="l11.39">   public nsSupportsWeakReference</span>
<a href="#l11.40"></a><span id="l11.40"> {</span>
<a href="#l11.41"></a><span id="l11.41"> public: </span>
<a href="#l11.42"></a><span id="l11.42"> 	nsMsgComposeService();</span>
<a href="#l11.43"></a><span id="l11.43"> </span>
<a href="#l11.44"></a><span id="l11.44"> 	NS_DECL_ISUPPORTS</span>
<a href="#l11.45"></a><span id="l11.45">   NS_DECL_NSIMSGCOMPOSESERVICE</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-  NS_DECL_NSIOBSERVER</span>
<a href="#l11.47"></a><span id="l11.47">   NS_DECL_NSICOMMANDLINEHANDLER</span>
<a href="#l11.48"></a><span id="l11.48"> </span>
<a href="#l11.49"></a><span id="l11.49">   nsresult Init();</span>
<a href="#l11.50"></a><span id="l11.50">   void Reset();</span>
<a href="#l11.51"></a><span id="l11.51">   void DeleteCachedWindows();</span>
<a href="#l11.52"></a><span id="l11.52">   nsresult AddGlobalHtmlDomains();</span>
<a href="#l11.53"></a><span id="l11.53"> </span>
<a href="#l11.54"></a><span id="l11.54"> private:</span>
<a href="#l11.55"></a><span id="l11.55"> 	virtual ~nsMsgComposeService();</span>
<a href="#l11.56"></a><span id="l11.56">   bool mLogComposePerformance;</span>
<a href="#l11.57"></a><span id="l11.57"> </span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-  int32_t mMaxRecycledWindows;</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-  nsMsgCachedWindowInfo *mCachedWindows;</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-  </span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-  void CloseHiddenCachedWindow(mozIDOMWindowProxy *domWindow);</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-</span>
<a href="#l11.63"></a><span id="l11.63">   nsresult LoadDraftOrTemplate(const nsACString&amp; aMsgURI, nsMimeOutputType aOutType, </span>
<a href="#l11.64"></a><span id="l11.64">                                nsIMsgIdentity * aIdentity, const char * aOriginalMsgURI, </span>
<a href="#l11.65"></a><span id="l11.65">                                nsIMsgDBHdr * aOrigMsgHdr, bool aForwardInline,</span>
<a href="#l11.66"></a><span id="l11.66">                                bool overrideComposeFormat,</span>
<a href="#l11.67"></a><span id="l11.67">                                nsIMsgWindow *aMsgWindow);</span>
<a href="#l11.68"></a><span id="l11.68"> </span>
<a href="#l11.69"></a><span id="l11.69">   nsresult RunMessageThroughMimeDraft(const nsACString&amp; aMsgURI,</span>
<a href="#l11.70"></a><span id="l11.70">                                       nsMimeOutputType aOutType,</span>
<a href="#l11.71"></a><span id="l11.71">                                       nsIMsgIdentity * aIdentity,</span>
<a href="#l11.72"></a><span id="l11.72">                                       const char * aOriginalMsgURI,</span>
<a href="#l11.73"></a><span id="l11.73">                                       nsIMsgDBHdr * aOrigMsgHdr,</span>
<a href="#l11.74"></a><span id="l11.74">                                       bool aForwardInline,</span>
<a href="#l11.75"></a><span id="l11.75">                                       const nsAString &amp;forwardTo,</span>
<a href="#l11.76"></a><span id="l11.76">                                       bool overrideComposeFormat,</span>
<a href="#l11.77"></a><span id="l11.77">                                       nsIMsgWindow *aMsgWindow);</span>
<a href="#l11.78"></a><span id="l11.78"> </span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-  nsresult ShowCachedComposeWindow(mozIDOMWindowProxy *aComposeWindow, nsIXULWindow *aXULWindow, bool aShow);</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-</span>
<a href="#l11.81"></a><span id="l11.81">   // hash table mapping dom windows to nsIMsgCompose objects</span>
<a href="#l11.82"></a><span id="l11.82">   nsInterfaceHashtable&lt;nsISupportsHashKey, nsIWeakReference&gt; mOpenComposeWindows;</span>
<a href="#l11.83"></a><span id="l11.83"> </span>
<a href="#l11.84"></a><span id="l11.84">   // When doing a reply and the settings are enabled, get the HTML of the selected text</span>
<a href="#l11.85"></a><span id="l11.85">   // in the original message window so that it can be quoted instead of the entire message.</span>
<a href="#l11.86"></a><span id="l11.86">   nsresult GetOrigWindowSelection(MSG_ComposeType type, nsIMsgWindow *aMsgWindow, nsACString&amp; aSelHTML);</span>
<a href="#l11.87"></a><span id="l11.87"> </span>
<a href="#l11.88"></a><span id="l11.88"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/extensions/smime/content/msgCompSMIMEOverlay.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/extensions/smime/content/msgCompSMIMEOverlay.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -66,18 +66,17 @@ function onComposerReOpen()</span>
<a href="#l12.4"></a><span id="l12.4">   if (gSMFields.signMessage)</span>
<a href="#l12.5"></a><span id="l12.5">     setSignatureUI();</span>
<a href="#l12.6"></a><span id="l12.6">   else</span>
<a href="#l12.7"></a><span id="l12.7">     setNoSignatureUI();</span>
<a href="#l12.8"></a><span id="l12.8"> }</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10"> addEventListener(&quot;load&quot;, smimeComposeOnLoad, false);</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-// this function gets called multiple times,</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-// but only on first open, not on composer recycling</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+// this function gets called multiple times</span>
<a href="#l12.15"></a><span id="l12.15"> function smimeComposeOnLoad()</span>
<a href="#l12.16"></a><span id="l12.16"> {</span>
<a href="#l12.17"></a><span id="l12.17">   removeEventListener(&quot;load&quot;, smimeComposeOnLoad, false);</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19">   onComposerReOpen();</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21">   top.controllers.appendController(SecurityController);</span>
<a href="#l12.22"></a><span id="l12.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/mailnews.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/mailnews.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -727,18 +727,16 @@ pref(&quot;mailnews.ui.addressbook_panel_resu</span>
<a href="#l13.4"></a><span id="l13.4"> // to hide the non default columns in the select addresses dialog</span>
<a href="#l13.5"></a><span id="l13.5"> // see abCommon.js and abSelectAddressesDialog.js</span>
<a href="#l13.6"></a><span id="l13.6"> pref(&quot;mailnews.ui.select_addresses_results.version&quot;, 1);</span>
<a href="#l13.7"></a><span id="l13.7"> // for manual upgrades of certain UI features.</span>
<a href="#l13.8"></a><span id="l13.8"> // 1 -&gt; 2 is for the ab results pane</span>
<a href="#l13.9"></a><span id="l13.9"> // to hide the non default columns in the advanced directory search dialog</span>
<a href="#l13.10"></a><span id="l13.10"> // see abCommon.js and ABSearchDialog.js</span>
<a href="#l13.11"></a><span id="l13.11"> pref(&quot;mailnews.ui.advanced_directory_search_results.version&quot;, 1);</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-//If set to a number greater than 0, msg compose windows will be recycled in order to open them quickly</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-pref(&quot;mail.compose.max_recycled_windows&quot;, 1);</span>
<a href="#l13.14"></a><span id="l13.14"> </span>
<a href="#l13.15"></a><span id="l13.15"> // from/recipient columns will be replaced with correspondents column</span>
<a href="#l13.16"></a><span id="l13.16"> pref(&quot;mailnews.ui.upgrade.correspondents&quot;, true);</span>
<a href="#l13.17"></a><span id="l13.17"> </span>
<a href="#l13.18"></a><span id="l13.18"> // default description and color prefs for tags</span>
<a href="#l13.19"></a><span id="l13.19"> // (we keep the .labels. names for backwards compatibility)</span>
<a href="#l13.20"></a><span id="l13.20"> pref(&quot;mailnews.labels.description.1&quot;, &quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l13.21"></a><span id="l13.21"> pref(&quot;mailnews.labels.description.2&quot;, &quot;chrome://messenger/locale/messenger.properties&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/suite/mailnews/compose/MsgComposeCommands.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/suite/mailnews/compose/MsgComposeCommands.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -138,97 +138,16 @@ function enableEditableFields()</span>
<a href="#l14.4"></a><span id="l14.4"> {</span>
<a href="#l14.5"></a><span id="l14.5">   gMsgCompose.editor.flags &amp;= ~nsIPlaintextEditorMail.eEditorReadonlyMask;</span>
<a href="#l14.6"></a><span id="l14.6">   var enableElements = document.getElementsByAttribute(&quot;disableonsend&quot;, &quot;true&quot;);</span>
<a href="#l14.7"></a><span id="l14.7">   for (let i = 0; i &lt; enableElements.length; i++)</span>
<a href="#l14.8"></a><span id="l14.8">     enableElements[i].removeAttribute('disabled');</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> }</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-var gComposeRecyclingListener = {</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-  onClose: function() {</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-    //Reset recipients and attachments</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-    awResetAllRows();</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-    RemoveAllAttachments();</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-    // We need to clear the identity popup menu in case the user will change them. It will be rebuilded later in ComposeStartup</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-    ClearIdentityListPopup(document.getElementById(&quot;msgIdentityPopup&quot;));</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-    // Stop listening to changes in the spell check dictionary.</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-    document.removeEventListener(&quot;spellcheck-changed&quot;, updateDocumentLanguage);</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-    // Stop InlineSpellCheckerUI so personal dictionary is saved.</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-    // We need to do this before disabling the editor.</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-    EnableInlineSpellCheck(false);</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-    // clear any suggestions in the context menu</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-    InlineSpellCheckerUI.clearSuggestionsFromMenu();</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-    InlineSpellCheckerUI.clearDictionaryListFromMenu();</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-    //Clear the subject</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-    GetMsgSubjectElement().value = &quot;&quot;;</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-    SetComposeWindowTitle();</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-    SetContentAndBodyAsUnmodified();</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-    disableEditableFields();</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-    ReleaseGlobalVariables();</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-    // Clear the focus</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-    awGetInputElement(1).removeAttribute('focused');</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-    //Reset Boxes size</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-    document.getElementById(&quot;compose-toolbox&quot;).removeAttribute(&quot;height&quot;);</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-    document.getElementById(&quot;appcontent&quot;).removeAttribute(&quot;height&quot;);</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-    document.getElementById(&quot;addresses-box&quot;).removeAttribute(&quot;width&quot;);</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-    document.getElementById(&quot;attachments-box&quot;).removeAttribute(&quot;width&quot;);</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-    //Reset menu options</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-    document.getElementById(&quot;format_auto&quot;).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-    //Reset toolbars that could be hidden</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-    if (gHideMenus) {</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-      document.getElementById(&quot;formatMenu&quot;).hidden = false;</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-      document.getElementById(&quot;insertMenu&quot;).hidden = false;</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-      var showFormat = document.getElementById(&quot;menu_showFormatToolbar&quot;)</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-      showFormat.hidden = false;</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-      if (showFormat.getAttribute(&quot;checked&quot;) == &quot;true&quot;)</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-        document.getElementById(&quot;FormatToolbar&quot;).hidden = false;</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-    }</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-    //Reset the Customize Toolbars panel/sheet if open.</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-    if (getMailToolbox().customizing &amp;&amp; gCustomizeSheet)</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-      document.getElementById(&quot;customizeToolbarSheetIFrame&quot;)</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-              .contentWindow.finishToolbarCustomization();</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-    //Reset editor</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-    EditorResetFontAndColorAttributes();</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-    EditorCleanup();</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-    //Release the nsIMsgComposeParams object</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-    if (window.arguments &amp;&amp; window.arguments[0])</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-      window.arguments[0] = null;</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineminus">-</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-    var event = document.createEvent('Events');</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-    event.initEvent('compose-window-close', false, true);</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-    document.getElementById(&quot;msgcomposeWindow&quot;).dispatchEvent(event);</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-    if (gAutoSaveTimeout)</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-      clearTimeout(gAutoSaveTimeout);</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-  },</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineminus">-</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineminus">-  onReopen: function(params) {</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-    // Reset focus to avoid undesirable visual effect when reopening the window</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineminus">-    InitializeGlobalVariables();</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineminus">-    ComposeStartup(true, params);</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineminus">-</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineminus">-    var event = document.createEvent('Events');</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">-    event.initEvent('compose-window-reopen', false, true);</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-    document.getElementById(&quot;msgcomposeWindow&quot;).dispatchEvent(event);</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-  }</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-};</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-</span>
<a href="#l14.93"></a><span id="l14.93"> var stateListener = {</span>
<a href="#l14.94"></a><span id="l14.94">   NotifyComposeFieldsReady: function() {</span>
<a href="#l14.95"></a><span id="l14.95">     ComposeFieldsReady();</span>
<a href="#l14.96"></a><span id="l14.96">   },</span>
<a href="#l14.97"></a><span id="l14.97"> </span>
<a href="#l14.98"></a><span id="l14.98">   NotifyComposeBodyReady: function() {</span>
<a href="#l14.99"></a><span id="l14.99">     if (gMsgCompose.composeHTML)</span>
<a href="#l14.100"></a><span id="l14.100">       loadHTMLMsgPrefs();</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineat">@@ -246,17 +165,17 @@ var stateListener = {</span>
<a href="#l14.102"></a><span id="l14.102">         SetContentAndBodyAsUnmodified();</span>
<a href="#l14.103"></a><span id="l14.103"> </span>
<a href="#l14.104"></a><span id="l14.104">       if (gCloseWindowAfterSave)</span>
<a href="#l14.105"></a><span id="l14.105">       {</span>
<a href="#l14.106"></a><span id="l14.106">         // Notify the SendListener that Send has been aborted and Stopped</span>
<a href="#l14.107"></a><span id="l14.107">         if (gMsgCompose)</span>
<a href="#l14.108"></a><span id="l14.108">           gMsgCompose.onSendNotPerformed(null, Components.results.NS_ERROR_ABORT);</span>
<a href="#l14.109"></a><span id="l14.109"> </span>
<a href="#l14.110"></a><span id="l14.110" class="difflineminus">-        MsgComposeCloseWindow(true);</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+        MsgComposeCloseWindow();</span>
<a href="#l14.112"></a><span id="l14.112">       }</span>
<a href="#l14.113"></a><span id="l14.113">     }</span>
<a href="#l14.114"></a><span id="l14.114">     // else if we failed to save, and we're autosaving, need to re-mark the editor</span>
<a href="#l14.115"></a><span id="l14.115">     // as changed, so that we won't lose the changes.</span>
<a href="#l14.116"></a><span id="l14.116">     else if (gAutoSaving)</span>
<a href="#l14.117"></a><span id="l14.117">     {</span>
<a href="#l14.118"></a><span id="l14.118">       gMsgCompose.bodyModified = true;</span>
<a href="#l14.119"></a><span id="l14.119">       gContentChanged = true;</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineat">@@ -729,17 +648,17 @@ function MessageComposeOfflineStateChang</span>
<a href="#l14.121"></a><span id="l14.121"> function DoCommandClose()</span>
<a href="#l14.122"></a><span id="l14.122"> {</span>
<a href="#l14.123"></a><span id="l14.123">   if (ComposeCanClose()) {</span>
<a href="#l14.124"></a><span id="l14.124">     // Notify the SendListener that Send has been aborted and Stopped</span>
<a href="#l14.125"></a><span id="l14.125">     if (gMsgCompose)</span>
<a href="#l14.126"></a><span id="l14.126">       gMsgCompose.onSendNotPerformed(null, Components.results.NS_ERROR_ABORT);</span>
<a href="#l14.127"></a><span id="l14.127"> </span>
<a href="#l14.128"></a><span id="l14.128">     // note: if we're not caching this window, this destroys it for us</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineminus">-    MsgComposeCloseWindow(true);</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+    MsgComposeCloseWindow();</span>
<a href="#l14.131"></a><span id="l14.131">   }</span>
<a href="#l14.132"></a><span id="l14.132"> </span>
<a href="#l14.133"></a><span id="l14.133">   return false;</span>
<a href="#l14.134"></a><span id="l14.134"> }</span>
<a href="#l14.135"></a><span id="l14.135"> </span>
<a href="#l14.136"></a><span id="l14.136"> function DoCommandPreferences()</span>
<a href="#l14.137"></a><span id="l14.137"> {</span>
<a href="#l14.138"></a><span id="l14.138">   goPreferences('composing_messages_pane');</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineat">@@ -925,17 +844,17 @@ function handleMailtoArgs(mailtoUrl)</span>
<a href="#l14.140"></a><span id="l14.140"> </span>
<a href="#l14.141"></a><span id="l14.141">     if (uri)</span>
<a href="#l14.142"></a><span id="l14.142">       return sMsgComposeService.getParamsForMailto(uri);</span>
<a href="#l14.143"></a><span id="l14.143">   }</span>
<a href="#l14.144"></a><span id="l14.144"> </span>
<a href="#l14.145"></a><span id="l14.145">   return null;</span>
<a href="#l14.146"></a><span id="l14.146"> }</span>
<a href="#l14.147"></a><span id="l14.147"> </span>
<a href="#l14.148"></a><span id="l14.148" class="difflineminus">-function ComposeStartup(recycled, aParams)</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+function ComposeStartup(aParams)</span>
<a href="#l14.150"></a><span id="l14.150"> {</span>
<a href="#l14.151"></a><span id="l14.151">   var params = null; // New way to pass parameters to the compose window as a nsIMsgComposeParameters object</span>
<a href="#l14.152"></a><span id="l14.152">   var args = null;   // old way, parameters are passed as a string</span>
<a href="#l14.153"></a><span id="l14.153"> </span>
<a href="#l14.154"></a><span id="l14.154">   if (aParams)</span>
<a href="#l14.155"></a><span id="l14.155">     params = aParams;</span>
<a href="#l14.156"></a><span id="l14.156">   else if (window.arguments &amp;&amp; window.arguments[0]) {</span>
<a href="#l14.157"></a><span id="l14.157">     try {</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineat">@@ -1050,63 +969,53 @@ function ComposeStartup(recycled, aParam</span>
<a href="#l14.159"></a><span id="l14.159">   if (sMsgComposeService)</span>
<a href="#l14.160"></a><span id="l14.160">   {</span>
<a href="#l14.161"></a><span id="l14.161">     // Get the &lt;editor&gt; element to startup an editor</span>
<a href="#l14.162"></a><span id="l14.162">     var editorElement = GetCurrentEditorElement();</span>
<a href="#l14.163"></a><span id="l14.163">     gMsgCompose = sMsgComposeService.initCompose(params, window,</span>
<a href="#l14.164"></a><span id="l14.164">                                                  editorElement.docShell);</span>
<a href="#l14.165"></a><span id="l14.165">     if (gMsgCompose)</span>
<a href="#l14.166"></a><span id="l14.166">     {</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineminus">-      // set the close listener</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineminus">-      gMsgCompose.recyclingListener = gComposeRecyclingListener;</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineminus">-</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineminus">-      //Lets the compose object knows that we are dealing with a recycled window</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-      gMsgCompose.recycledWindow = recycled;</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineminus">-</span>
<a href="#l14.173"></a><span id="l14.173">       if (!editorElement)</span>
<a href="#l14.174"></a><span id="l14.174">       {</span>
<a href="#l14.175"></a><span id="l14.175">         dump(&quot;Failed to get editor element!\n&quot;);</span>
<a href="#l14.176"></a><span id="l14.176">         return;</span>
<a href="#l14.177"></a><span id="l14.177">       }</span>
<a href="#l14.178"></a><span id="l14.178"> </span>
<a href="#l14.179"></a><span id="l14.179">       document.getElementById(&quot;returnReceiptMenu&quot;)</span>
<a href="#l14.180"></a><span id="l14.180">               .setAttribute(&quot;checked&quot;, gMsgCompose.compFields.returnReceipt);</span>
<a href="#l14.181"></a><span id="l14.181">       document.getElementById(&quot;dsnMenu&quot;)</span>
<a href="#l14.182"></a><span id="l14.182">               .setAttribute('checked', gMsgCompose.compFields.DSN);</span>
<a href="#l14.183"></a><span id="l14.183">       document.getElementById(&quot;cmd_attachVCard&quot;)</span>
<a href="#l14.184"></a><span id="l14.184">               .setAttribute(&quot;checked&quot;, gMsgCompose.compFields.attachVCard);</span>
<a href="#l14.185"></a><span id="l14.185">       document.getElementById(&quot;menu_inlineSpellCheck&quot;)</span>
<a href="#l14.186"></a><span id="l14.186">               .setAttribute(&quot;checked&quot;, getPref(&quot;mail.spellcheck.inline&quot;));</span>
<a href="#l14.187"></a><span id="l14.187"> </span>
<a href="#l14.188"></a><span id="l14.188" class="difflineminus">-      // If recycle, editor is already created</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineminus">-      if (!recycled)</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+      try {</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+        var editortype = gMsgCompose.composeHTML ? &quot;htmlmail&quot; : &quot;textmail&quot;;</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+        editorElement.makeEditable(editortype, true);</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineplus">+      } catch (e) { dump(&quot; FAILED TO START EDITOR: &quot;+e+&quot;\n&quot;); }</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineplus">+</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineplus">+      // setEditorType MUST be call before setContentWindow</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineplus">+      if (gMsgCompose.composeHTML)</span>
<a href="#l14.197"></a><span id="l14.197">       {</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineminus">-        try {</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineminus">-          var editortype = gMsgCompose.composeHTML ? &quot;htmlmail&quot; : &quot;textmail&quot;;</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineminus">-          editorElement.makeEditable(editortype, true);</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineminus">-        } catch (e) { dump(&quot; FAILED TO START EDITOR: &quot;+e+&quot;\n&quot;); }</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineminus">-</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineminus">-        // setEditorType MUST be call before setContentWindow</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineminus">-        if (gMsgCompose.composeHTML)</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineminus">-        {</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineminus">-          initLocalFontFaceMenu(document.getElementById(&quot;FontFacePopup&quot;));</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineminus">-        }</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineminus">-        else</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineminus">-        {</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineminus">-          //Remove HTML toolbar, format and insert menus as we are editing in plain text mode</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineminus">-          document.getElementById(&quot;outputFormatMenu&quot;).setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineminus">-          document.getElementById(&quot;FormatToolbar&quot;).setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineminus">-          document.getElementById(&quot;formatMenu&quot;).setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineminus">-          document.getElementById(&quot;insertMenu&quot;).setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-          document.getElementById(&quot;menu_showFormatToolbar&quot;).setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineminus">-        }</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineminus">-</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineminus">-        // Do setup common to Message Composer and Web Composer</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineminus">-        EditorSharedStartup();</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineplus">+        initLocalFontFaceMenu(document.getElementById(&quot;FontFacePopup&quot;));</span>
<a href="#l14.221"></a><span id="l14.221">       }</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+      else</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+      {</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineplus">+        //Remove HTML toolbar, format and insert menus as we are editing in plain text mode</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+        document.getElementById(&quot;outputFormatMenu&quot;).setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineplus">+        document.getElementById(&quot;FormatToolbar&quot;).setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+        document.getElementById(&quot;formatMenu&quot;).setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineplus">+        document.getElementById(&quot;insertMenu&quot;).setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineplus">+        document.getElementById(&quot;menu_showFormatToolbar&quot;).setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineplus">+      }</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineplus">+      // Do setup common to Message Composer and Web Composer</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineplus">+      EditorSharedStartup();</span>
<a href="#l14.234"></a><span id="l14.234"> </span>
<a href="#l14.235"></a><span id="l14.235">       var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l14.236"></a><span id="l14.236">       if (msgCompFields)</span>
<a href="#l14.237"></a><span id="l14.237">       {</span>
<a href="#l14.238"></a><span id="l14.238">         if (params.bodyIsLink)</span>
<a href="#l14.239"></a><span id="l14.239">         {</span>
<a href="#l14.240"></a><span id="l14.240">           var body = msgCompFields.body;</span>
<a href="#l14.241"></a><span id="l14.241">           if (gMsgCompose.composeHTML)</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineat">@@ -1133,45 +1042,30 @@ function ComposeStartup(recycled, aParam</span>
<a href="#l14.243"></a><span id="l14.243">       }</span>
<a href="#l14.244"></a><span id="l14.244"> </span>
<a href="#l14.245"></a><span id="l14.245">       var event = document.createEvent('Events');</span>
<a href="#l14.246"></a><span id="l14.246">       event.initEvent('compose-window-init', false, true);</span>
<a href="#l14.247"></a><span id="l14.247">       document.getElementById(&quot;msgcomposeWindow&quot;).dispatchEvent(event);</span>
<a href="#l14.248"></a><span id="l14.248"> </span>
<a href="#l14.249"></a><span id="l14.249">       gMsgCompose.RegisterStateListener(stateListener);</span>
<a href="#l14.250"></a><span id="l14.250"> </span>
<a href="#l14.251"></a><span id="l14.251" class="difflineminus">-      if (recycled)</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineminus">-      {</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineminus">-        InitEditor(GetCurrentEditor());</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineminus">-</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineminus">-        if (gMsgCompose.composeHTML)</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineminus">-        {</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineminus">-          // Force color picker on toolbar to show document colors</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineminus">-          onFontColorChange();</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineminus">-          onBackgroundColorChange();</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineminus">-          // XXX todo: reset paragraph select to &quot;Body Text&quot;</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineminus">-        }</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineminus">-      }</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineminus">-      else</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineminus">-      {</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineminus">-        // Add an observer to be called when document is done loading,</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineminus">-        //   which creates the editor</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineminus">-        try {</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineminus">-          GetCurrentCommandManager().</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineminus">-                addCommandObserver(gMsgEditorCreationObserver, &quot;obs_documentCreated&quot;);</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineminus">-</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineminus">-          // Load empty page to create the editor</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineminus">-          editorElement.webNavigation.loadURI(&quot;about:blank&quot;, // uri string</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineminus">-                               0,                            // load flags</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineminus">-                               null,                         // referrer</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineminus">-                               null,                         // post-data stream</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineminus">-                               null);</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineminus">-        } catch (e) {</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineminus">-          dump(&quot; Failed to startup editor: &quot;+e+&quot;\n&quot;);</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineminus">-        }</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineplus">+      // Add an observer to be called when document is done loading,</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineplus">+      //   which creates the editor</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineplus">+      try {</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineplus">+        GetCurrentCommandManager().</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineplus">+              addCommandObserver(gMsgEditorCreationObserver, &quot;obs_documentCreated&quot;);</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineplus">+</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineplus">+        // Load empty page to create the editor</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineplus">+        editorElement.webNavigation.loadURI(&quot;about:blank&quot;, // uri string</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineplus">+                             0,                            // load flags</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineplus">+                             null,                         // referrer</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineplus">+                             null,                         // post-data stream</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineplus">+                             null);</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineplus">+      } catch (e) {</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineplus">+        dump(&quot; Failed to startup editor: &quot;+e+&quot;\n&quot;);</span>
<a href="#l14.294"></a><span id="l14.294">       }</span>
<a href="#l14.295"></a><span id="l14.295">     }</span>
<a href="#l14.296"></a><span id="l14.296">   }</span>
<a href="#l14.297"></a><span id="l14.297"> </span>
<a href="#l14.298"></a><span id="l14.298">   // create URI of the folder from draftId</span>
<a href="#l14.299"></a><span id="l14.299">   var draftId = msgCompFields.draftId;</span>
<a href="#l14.300"></a><span id="l14.300">   var folderURI = draftId.substring(0, draftId.indexOf(&quot;#&quot;)).replace(&quot;-message&quot;, &quot;&quot;);</span>
<a href="#l14.301"></a><span id="l14.301"> </span>
<a href="#l14.302"></a><span id="l14.302" class="difflineat">@@ -1223,17 +1117,17 @@ var gMsgEditorCreationObserver =</span>
<a href="#l14.303"></a><span id="l14.303"> function WizCallback(state)</span>
<a href="#l14.304"></a><span id="l14.304"> {</span>
<a href="#l14.305"></a><span id="l14.305">   if (state){</span>
<a href="#l14.306"></a><span id="l14.306">     ComposeStartup(false, null);</span>
<a href="#l14.307"></a><span id="l14.307">   }</span>
<a href="#l14.308"></a><span id="l14.308">   else</span>
<a href="#l14.309"></a><span id="l14.309">   {</span>
<a href="#l14.310"></a><span id="l14.310">     // The account wizard is still closing so we can't close just yet</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineminus">-    setTimeout(MsgComposeCloseWindow, 0, false); // Don't recycle a bogus window</span>
<a href="#l14.312"></a><span id="l14.312" class="difflineplus">+    setTimeout(MsgComposeCloseWindow, 0);</span>
<a href="#l14.313"></a><span id="l14.313">   }</span>
<a href="#l14.314"></a><span id="l14.314"> }</span>
<a href="#l14.315"></a><span id="l14.315"> </span>
<a href="#l14.316"></a><span id="l14.316"> function ComposeLoad()</span>
<a href="#l14.317"></a><span id="l14.317"> {</span>
<a href="#l14.318"></a><span id="l14.318">   sComposeMsgsBundle = document.getElementById(&quot;bundle_composeMsgs&quot;);</span>
<a href="#l14.319"></a><span id="l14.319">   sBrandBundle = document.getElementById(&quot;brandBundle&quot;);</span>
<a href="#l14.320"></a><span id="l14.320"> </span>
<a href="#l14.321"></a><span id="l14.321" class="difflineat">@@ -1264,17 +1158,17 @@ function ComposeLoad()</span>
<a href="#l14.322"></a><span id="l14.322">       ComposeStartup(false, null);</span>
<a href="#l14.323"></a><span id="l14.323">   }</span>
<a href="#l14.324"></a><span id="l14.324">   catch (ex) {</span>
<a href="#l14.325"></a><span id="l14.325">     Components.utils.reportError(ex);</span>
<a href="#l14.326"></a><span id="l14.326">     var errorTitle = sComposeMsgsBundle.getString(&quot;initErrorDlogTitle&quot;);</span>
<a href="#l14.327"></a><span id="l14.327">     var errorMsg = sComposeMsgsBundle.getString(&quot;initErrorDlgMessage&quot;);</span>
<a href="#l14.328"></a><span id="l14.328">     Services.prompt.alert(window, errorTitle, errorMsg);</span>
<a href="#l14.329"></a><span id="l14.329"> </span>
<a href="#l14.330"></a><span id="l14.330" class="difflineminus">-    MsgComposeCloseWindow(false); // Don't try to recycle a bogus window</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineplus">+    MsgComposeCloseWindow();</span>
<a href="#l14.332"></a><span id="l14.332">     return;</span>
<a href="#l14.333"></a><span id="l14.333">   }</span>
<a href="#l14.334"></a><span id="l14.334">   if (gLogComposePerformance)</span>
<a href="#l14.335"></a><span id="l14.335">     sMsgComposeService.TimeStamp(&quot;Done with the initialization (ComposeLoad). Waiting on editor to load about:blank&quot;, false);</span>
<a href="#l14.336"></a><span id="l14.336"> </span>
<a href="#l14.337"></a><span id="l14.337">   // Before and after callbacks for the customizeToolbar code</span>
<a href="#l14.338"></a><span id="l14.338">   var mailToolbox = getMailToolbox();</span>
<a href="#l14.339"></a><span id="l14.339">   mailToolbox.customizeInit = MailToolboxCustomizeInit;</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineat">@@ -2157,20 +2051,20 @@ function RemoveDraft()</span>
<a href="#l14.341"></a><span id="l14.341"> }</span>
<a href="#l14.342"></a><span id="l14.342"> </span>
<a href="#l14.343"></a><span id="l14.343"> function SetContentAndBodyAsUnmodified()</span>
<a href="#l14.344"></a><span id="l14.344"> {</span>
<a href="#l14.345"></a><span id="l14.345">   gMsgCompose.bodyModified = false;</span>
<a href="#l14.346"></a><span id="l14.346">   gContentChanged = false;</span>
<a href="#l14.347"></a><span id="l14.347"> }</span>
<a href="#l14.348"></a><span id="l14.348"> </span>
<a href="#l14.349"></a><span id="l14.349" class="difflineminus">-function MsgComposeCloseWindow(recycleIt)</span>
<a href="#l14.350"></a><span id="l14.350" class="difflineplus">+function MsgComposeCloseWindow()</span>
<a href="#l14.351"></a><span id="l14.351"> {</span>
<a href="#l14.352"></a><span id="l14.352">   if (gMsgCompose)</span>
<a href="#l14.353"></a><span id="l14.353" class="difflineminus">-    gMsgCompose.CloseWindow(recycleIt);</span>
<a href="#l14.354"></a><span id="l14.354" class="difflineplus">+    gMsgCompose.CloseWindow();</span>
<a href="#l14.355"></a><span id="l14.355">   else</span>
<a href="#l14.356"></a><span id="l14.356">     window.close();</span>
<a href="#l14.357"></a><span id="l14.357"> }</span>
<a href="#l14.358"></a><span id="l14.358"> </span>
<a href="#l14.359"></a><span id="l14.359"> // attachedLocalFile must be a nsILocalFile</span>
<a href="#l14.360"></a><span id="l14.360"> function SetLastAttachDirectory(attachedLocalFile)</span>
<a href="#l14.361"></a><span id="l14.361"> {</span>
<a href="#l14.362"></a><span id="l14.362">   try {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/suite/profile/migration/src/nsThunderbirdProfileMigrator.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/suite/profile/migration/src/nsThunderbirdProfileMigrator.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -278,17 +278,16 @@ nsThunderbirdProfileMigrator::PrefTransf</span>
<a href="#l15.4"></a><span id="l15.4">   MAKESAMETYPEPREFTRANSFORM(&quot;mail.collect_email_address_incoming&quot;,     Bool),</span>
<a href="#l15.5"></a><span id="l15.5">   MAKESAMETYPEPREFTRANSFORM(&quot;mail.collect_email_address_newsgroup&quot;,    Bool),</span>
<a href="#l15.6"></a><span id="l15.6">   MAKESAMETYPEPREFTRANSFORM(&quot;mail.collect_email_address_outgoing&quot;,     Bool),</span>
<a href="#l15.7"></a><span id="l15.7">   MAKESAMETYPEPREFTRANSFORM(&quot;mail.compose.add_undisclosed_recipients&quot;, Bool),</span>
<a href="#l15.8"></a><span id="l15.8">   MAKESAMETYPEPREFTRANSFORM(&quot;mail.compose.autosave&quot;,                   Bool),</span>
<a href="#l15.9"></a><span id="l15.9">   MAKESAMETYPEPREFTRANSFORM(&quot;mail.compose.autosaveinterval&quot;,           Int),</span>
<a href="#l15.10"></a><span id="l15.10">   MAKESAMETYPEPREFTRANSFORM(&quot;mail.compose.dont_attach_source_of_local_network_links&quot;, Bool),</span>
<a href="#l15.11"></a><span id="l15.11">   MAKESAMETYPEPREFTRANSFORM(&quot;mail.compose.dontWarnMail2Newsgroup&quot;,     Bool),</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  MAKESAMETYPEPREFTRANSFORM(&quot;mail.compose.max_recycled_windows&quot;,       Int),</span>
<a href="#l15.13"></a><span id="l15.13">   MAKESAMETYPEPREFTRANSFORM(&quot;mail.compose.other.header&quot;,               String),</span>
<a href="#l15.14"></a><span id="l15.14">   MAKESAMETYPEPREFTRANSFORM(&quot;mail.compose.wrap_to_window_width&quot;,       Bool),</span>
<a href="#l15.15"></a><span id="l15.15">   MAKESAMETYPEPREFTRANSFORM(&quot;mail.content_disposition_type&quot;,           Int),</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17">   MAKESAMETYPEPREFTRANSFORM(&quot;mail.default_html_action&quot;,                Int),</span>
<a href="#l15.18"></a><span id="l15.18">   MAKESAMETYPEPREFTRANSFORM(&quot;mail.default_sendlater_uri&quot;,              String),</span>
<a href="#l15.19"></a><span id="l15.19">   MAKESAMETYPEPREFTRANSFORM(&quot;mail.delete_matches_sort_order&quot;,          Bool),</span>
<a href="#l15.20"></a><span id="l15.20">   MAKESAMETYPEPREFTRANSFORM(&quot;mail.display_glyph&quot;,                      Bool),</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

