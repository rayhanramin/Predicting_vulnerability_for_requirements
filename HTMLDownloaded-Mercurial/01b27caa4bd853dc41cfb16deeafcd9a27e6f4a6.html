<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 9852:01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6" />
<meta property="og:url" content="/comm-central/rev/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6" />
<meta property="og:description" content="Bug 739041. (Av1a) Port |Bug 482911 - [HTML5] Re-implement bookmarks.html parsing using the HTML5 parser| to SeaMonkey, tests part. r=neil." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6">shortlog</a> |
<a href="/comm-central/log/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6">files</a> |
changeset |
<a href="/comm-central/raw-rev/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6">raw</a>  | <a href="/comm-central/archive/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=739041">Bug 739041</a>. (Av1a) Port |<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=482911">Bug 482911</a> - [HTML5] Re-implement bookmarks.html parsing using the HTML5 parser| to SeaMonkey, tests part. r=neil.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#101;&#114;&#103;&#101;&#32;&#71;&#97;&#117;&#116;&#104;&#101;&#114;&#105;&#101;&#32;&#60;&#115;&#103;&#97;&#117;&#116;&#104;&#101;&#114;&#105;&#101;&#46;&#98;&#122;&#64;&#102;&#114;&#101;&#101;&#46;&#102;&#114;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 07 Apr 2012 02:16:35 +0200</td></tr>

<tr>
 <td>changeset 9852</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6">01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6</a></td>
</tr>



<tr>
<td>parent 9851</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ce3fcd5595263c3fd183a0e62aec5e260ad4ceea">ce3fcd5595263c3fd183a0e62aec5e260ad4ceea</a>
</td>
</tr>

<tr>
<td>child 9853</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b93275536317bcde0d3deff5590aa8d3ea28d0ad">b93275536317bcde0d3deff5590aa8d3ea28d0ad</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6">7504</a></td></tr>
<tr><td>push user</td><td>sgautherie.bz@free.fr</td></tr>
<tr><td>push date</td><td class="date age">Sat, 07 Apr 2012 00:19:07 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@01b27caa4bd8 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6&newProject=comm-central&newRevision=01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6&newProject=comm-central&newRevision=01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6&newProject=comm-central&newRevision=01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28neil%29&revcount=50">neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=739041">739041</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=482911">482911</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=739041">Bug 739041</a>. (Av1a) Port |<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=482911">Bug 482911</a> - [HTML5] Re-implement bookmarks.html parsing using the HTML5 parser| to SeaMonkey, tests part. r=neil.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_384370.js">suite/common/places/tests/unit/test_384370.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_384370.js">file</a> |
<a href="/comm-central/annotate/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_384370.js">annotate</a> |
<a href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_384370.js">diff</a> |
<a href="/comm-central/comparison/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_384370.js">comparison</a> |
<a href="/comm-central/log/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_384370.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_421483.js">suite/common/places/tests/unit/test_421483.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_421483.js">file</a> |
<a href="/comm-central/annotate/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_421483.js">annotate</a> |
<a href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_421483.js">diff</a> |
<a href="/comm-central/comparison/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_421483.js">comparison</a> |
<a href="/comm-central/log/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_421483.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_457441-import-export-corrupt-bookmarks-html.js">suite/common/places/tests/unit/test_457441-import-export-corrupt-bookmarks-html.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_457441-import-export-corrupt-bookmarks-html.js">file</a> |
<a href="/comm-central/annotate/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_457441-import-export-corrupt-bookmarks-html.js">annotate</a> |
<a href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_457441-import-export-corrupt-bookmarks-html.js">diff</a> |
<a href="/comm-central/comparison/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_457441-import-export-corrupt-bookmarks-html.js">comparison</a> |
<a href="/comm-central/log/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_457441-import-export-corrupt-bookmarks-html.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_bookmarksRestoreNotification.js">suite/common/places/tests/unit/test_bookmarksRestoreNotification.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_bookmarksRestoreNotification.js">file</a> |
<a href="/comm-central/annotate/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_bookmarksRestoreNotification.js">annotate</a> |
<a href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_bookmarksRestoreNotification.js">diff</a> |
<a href="/comm-central/comparison/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_bookmarksRestoreNotification.js">comparison</a> |
<a href="/comm-central/log/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_bookmarksRestoreNotification.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_bookmarks_html.js">suite/common/places/tests/unit/test_bookmarks_html.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_bookmarks_html.js">file</a> |
<a href="/comm-central/annotate/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_bookmarks_html.js">annotate</a> |
<a href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_bookmarks_html.js">diff</a> |
<a href="/comm-central/comparison/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_bookmarks_html.js">comparison</a> |
<a href="/comm-central/log/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_bookmarks_html.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_migrate.js">suite/common/places/tests/unit/test_browserGlue_migrate.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_migrate.js">file</a> |
<a href="/comm-central/annotate/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_migrate.js">annotate</a> |
<a href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_migrate.js">diff</a> |
<a href="/comm-central/comparison/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_migrate.js">comparison</a> |
<a href="/comm-central/log/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_migrate.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_prefs.js">suite/common/places/tests/unit/test_browserGlue_prefs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_prefs.js">file</a> |
<a href="/comm-central/annotate/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_prefs.js">annotate</a> |
<a href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_prefs.js">diff</a> |
<a href="/comm-central/comparison/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_prefs.js">comparison</a> |
<a href="/comm-central/log/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_prefs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_smartBookmarks.js">suite/common/places/tests/unit/test_browserGlue_smartBookmarks.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_smartBookmarks.js">file</a> |
<a href="/comm-central/annotate/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_smartBookmarks.js">annotate</a> |
<a href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_smartBookmarks.js">diff</a> |
<a href="/comm-central/comparison/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_smartBookmarks.js">comparison</a> |
<a href="/comm-central/log/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_browserGlue_smartBookmarks.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_clearHistory_shutdown.js">suite/common/places/tests/unit/test_clearHistory_shutdown.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_clearHistory_shutdown.js">file</a> |
<a href="/comm-central/annotate/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_clearHistory_shutdown.js">annotate</a> |
<a href="/comm-central/diff/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_clearHistory_shutdown.js">diff</a> |
<a href="/comm-central/comparison/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_clearHistory_shutdown.js">comparison</a> |
<a href="/comm-central/log/01b27caa4bd853dc41cfb16deeafcd9a27e6f4a6/suite/common/places/tests/unit/test_clearHistory_shutdown.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/common/places/tests/unit/test_384370.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/common/places/tests/unit/test_384370.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -40,30 +40,31 @@ const LOAD_IN_SIDEBAR_ANNO = &quot;bookmarkPr</span>
<a href="#l1.4"></a><span id="l1.4"> const DESCRIPTION_ANNO = &quot;bookmarkProperties/description&quot;;</span>
<a href="#l1.5"></a><span id="l1.5"> const POST_DATA_ANNO = &quot;bookmarkProperties/POSTData&quot;;</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> do_check_eq(typeof PlacesUtils, &quot;object&quot;);</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> // main</span>
<a href="#l1.10"></a><span id="l1.10"> function run_test() {</span>
<a href="#l1.11"></a><span id="l1.11">   do_test_pending();</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+</span>
<a href="#l1.13"></a><span id="l1.13">   /*</span>
<a href="#l1.14"></a><span id="l1.14">     HTML+FEATURES SUMMARY:</span>
<a href="#l1.15"></a><span id="l1.15">     - import legacy bookmarks</span>
<a href="#l1.16"></a><span id="l1.16">     - export as json, import, test (tests integrity of html &gt; json)</span>
<a href="#l1.17"></a><span id="l1.17">     - export as html, import, test (tests integrity of json &gt; html)</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19">     BACKUP/RESTORE SUMMARY:</span>
<a href="#l1.20"></a><span id="l1.20">     - create a bookmark in each root</span>
<a href="#l1.21"></a><span id="l1.21">     - tag multiple URIs with multiple tags</span>
<a href="#l1.22"></a><span id="l1.22">     - export as json, import, test</span>
<a href="#l1.23"></a><span id="l1.23">   */</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-  // get places import/export service</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-  var importer = Cc[&quot;@mozilla.org/browser/places/import-export-service;1&quot;].getService(Ci.nsIPlacesImportExportService);</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+  // import the importer</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+  Cu.import(&quot;resource://gre/modules/BookmarkHTMLUtils.jsm&quot;);</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30">   // avoid creating the places smart folder during tests</span>
<a href="#l1.31"></a><span id="l1.31">   Services.prefs.setIntPref(&quot;browser.places.smartBookmarksVersion&quot;, -1);</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33">   // file pointer to legacy bookmarks file</span>
<a href="#l1.34"></a><span id="l1.34">   //var bookmarksFileOld = do_get_file(&quot;bookmarks.large.html&quot;);</span>
<a href="#l1.35"></a><span id="l1.35">   var bookmarksFileOld = do_get_file(&quot;bookmarks.preplaces.html&quot;);</span>
<a href="#l1.36"></a><span id="l1.36">   // file pointer to a new places-exported json file</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineat">@@ -74,43 +75,53 @@ function run_test() {</span>
<a href="#l1.38"></a><span id="l1.38">   if (jsonFile.exists())</span>
<a href="#l1.39"></a><span id="l1.39">     jsonFile.remove(false);</span>
<a href="#l1.40"></a><span id="l1.40">   jsonFile.create(Ci.nsILocalFile.NORMAL_FILE_TYPE, 0600);</span>
<a href="#l1.41"></a><span id="l1.41">   if (!jsonFile.exists())</span>
<a href="#l1.42"></a><span id="l1.42">     do_throw(&quot;couldn't create file: bookmarks.exported.json&quot;);</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44">   // Test importing a pre-Places canonical bookmarks file.</span>
<a href="#l1.45"></a><span id="l1.45">   // 1. import bookmarks.preplaces.html</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-  // 2. run the test-suite</span>
<a href="#l1.47"></a><span id="l1.47">   // Note: we do not empty the db before this import to catch bugs like 380999</span>
<a href="#l1.48"></a><span id="l1.48">   try {</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-    importer.importHTMLFromFile(bookmarksFileOld, true);</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+    BookmarkHTMLUtils.importFromFile(bookmarksFileOld, true, after_import);</span>
<a href="#l1.51"></a><span id="l1.51">   } catch(ex) { do_throw(&quot;couldn't import legacy bookmarks file: &quot; + ex); }</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-  populate();</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-  validate();</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+  function after_import(success) {</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+    if (!success) {</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+      do_throw(&quot;Couldn't import legacy bookmarks file.&quot;);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+    }</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+    populate();</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+    // 2. run the test-suite</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+    validate();</span>
<a href="#l1.64"></a><span id="l1.64"> </span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-  waitForAsyncUpdates(function () {</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-    // Test exporting a Places canonical json file.</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-    // 1. export to bookmarks.exported.json</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-    // 2. empty bookmarks db</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-    // 3. import bookmarks.exported.json</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-    // 4. run the test-suite</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-    try {</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-      PlacesUtils.backups.saveBookmarksToJSONFile(jsonFile);</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-    } catch(ex) { do_throw(&quot;couldn't export to file: &quot; + ex); }</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-    LOG(&quot;exported json&quot;);</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-    try {</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-      PlacesUtils.restoreBookmarksFromJSONFile(jsonFile);</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-    } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-    LOG(&quot;imported json&quot;);</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-    validate();</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-    LOG(&quot;validated import&quot;);</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+    waitForAsyncUpdates(function testJsonExport() {</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+      // Test exporting a Places canonical json file.</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+      // 1. export to bookmarks.exported.json</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+      try {</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+        PlacesUtils.backups.saveBookmarksToJSONFile(jsonFile);</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+      } catch(ex) { do_throw(&quot;couldn't export to file: &quot; + ex); }</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+      LOG(&quot;exported json&quot;);</span>
<a href="#l1.88"></a><span id="l1.88"> </span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-    waitForAsyncUpdates(do_test_finished);</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-  });</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+      // 2. empty bookmarks db</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+      // 3. import bookmarks.exported.json</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+      try {</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+        PlacesUtils.restoreBookmarksFromJSONFile(jsonFile);</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+      } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+      LOG(&quot;imported json&quot;);</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+      // 4. run the test-suite</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+      validate();</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+      LOG(&quot;validated import&quot;);</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+      waitForAsyncUpdates(do_test_finished);</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+    });</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+  }</span>
<a href="#l1.105"></a><span id="l1.105"> }</span>
<a href="#l1.106"></a><span id="l1.106"> </span>
<a href="#l1.107"></a><span id="l1.107"> var tagData = [</span>
<a href="#l1.108"></a><span id="l1.108">   { uri: uri(&quot;http://slint.us&quot;), tags: [&quot;indie&quot;, &quot;kentucky&quot;, &quot;music&quot;] },</span>
<a href="#l1.109"></a><span id="l1.109">   { uri: uri(&quot;http://en.wikipedia.org/wiki/Diplodocus&quot;), tags: [&quot;dinosaur&quot;, &quot;dj&quot;, &quot;rad word&quot;] }</span>
<a href="#l1.110"></a><span id="l1.110"> ];</span>
<a href="#l1.111"></a><span id="l1.111"> </span>
<a href="#l1.112"></a><span id="l1.112"> var bookmarkData = [</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/suite/common/places/tests/unit/test_421483.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/suite/common/places/tests/unit/test_421483.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -10,17 +10,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">  *</span>
<a href="#l2.5"></a><span id="l2.5">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l2.6"></a><span id="l2.6">  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l2.7"></a><span id="l2.7">  * for the specific language governing rights and limitations under the</span>
<a href="#l2.8"></a><span id="l2.8">  * License.</span>
<a href="#l2.9"></a><span id="l2.9">  *</span>
<a href="#l2.10"></a><span id="l2.10">  * The Original Code is Places Unit Test code.</span>
<a href="#l2.11"></a><span id="l2.11">  *</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">- * The Initial Developer of the Original Code is Mozilla Corp.</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ * The Initial Developer of the Original Code is Mozilla Foundation.</span>
<a href="#l2.14"></a><span id="l2.14">  * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l2.15"></a><span id="l2.15">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l2.16"></a><span id="l2.16">  *</span>
<a href="#l2.17"></a><span id="l2.17">  * Contributor(s):</span>
<a href="#l2.18"></a><span id="l2.18">  *  Marco Bonardo &lt;mak77@supereva.it&gt;</span>
<a href="#l2.19"></a><span id="l2.19">  *</span>
<a href="#l2.20"></a><span id="l2.20">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l2.21"></a><span id="l2.21">  * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -51,16 +51,18 @@ try {</span>
<a href="#l2.23"></a><span id="l2.23"> } catch(ex) {</span>
<a href="#l2.24"></a><span id="l2.24">   do_throw(&quot;Could not get Annotation service\n&quot;);</span>
<a href="#l2.25"></a><span id="l2.25"> }</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27"> // Get browser glue</span>
<a href="#l2.28"></a><span id="l2.28"> try {</span>
<a href="#l2.29"></a><span id="l2.29">   var gluesvc = Cc[&quot;@mozilla.org/suite/suiteglue;1&quot;].</span>
<a href="#l2.30"></a><span id="l2.30">                 getService(Ci.nsISuiteGlue);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  // Avoid default bookmarks import.</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  gluesvc.QueryInterface(Ci.nsIObserver).observe(null, &quot;initial-migration&quot;, null);</span>
<a href="#l2.33"></a><span id="l2.33"> } catch(ex) {</span>
<a href="#l2.34"></a><span id="l2.34">   do_throw(&quot;Could not get SuiteGlue service\n&quot;);</span>
<a href="#l2.35"></a><span id="l2.35"> }</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37"> const SMART_BOOKMARKS_ANNO = &quot;Places/SmartBookmark&quot;;</span>
<a href="#l2.38"></a><span id="l2.38"> const SMART_BOOKMARKS_PREF = &quot;browser.places.smartBookmarksVersion&quot;;</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40"> // main</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/suite/common/places/tests/unit/test_457441-import-export-corrupt-bookmarks-html.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/suite/common/places/tests/unit/test_457441-import-export-corrupt-bookmarks-html.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -48,16 +48,17 @@ var dbConn = hs.QueryInterface(Ci.nsPIPl</span>
<a href="#l3.4"></a><span id="l3.4"> var bs = Cc[&quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;].</span>
<a href="#l3.5"></a><span id="l3.5">          getService(Ci.nsINavBookmarksService);</span>
<a href="#l3.6"></a><span id="l3.6"> var as = Cc[&quot;@mozilla.org/browser/annotation-service;1&quot;].</span>
<a href="#l3.7"></a><span id="l3.7">          getService(Ci.nsIAnnotationService);</span>
<a href="#l3.8"></a><span id="l3.8"> var icos = Cc[&quot;@mozilla.org/browser/favicon-service;1&quot;].</span>
<a href="#l3.9"></a><span id="l3.9">            getService(Ci.nsIFaviconService);</span>
<a href="#l3.10"></a><span id="l3.10"> var ies = Cc[&quot;@mozilla.org/browser/places/import-export-service;1&quot;].</span>
<a href="#l3.11"></a><span id="l3.11">           getService(Ci.nsIPlacesImportExportService);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+Cu.import(&quot;resource://gre/modules/BookmarkHTMLUtils.jsm&quot;);</span>
<a href="#l3.13"></a><span id="l3.13"> </span>
<a href="#l3.14"></a><span id="l3.14"> const DESCRIPTION_ANNO = &quot;bookmarkProperties/description&quot;;</span>
<a href="#l3.15"></a><span id="l3.15"> const LOAD_IN_SIDEBAR_ANNO = &quot;bookmarkProperties/loadInSidebar&quot;;</span>
<a href="#l3.16"></a><span id="l3.16"> const POST_DATA_ANNO = &quot;bookmarkProperties/POSTData&quot;;</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18"> const TEST_FAVICON_PAGE_URL = &quot;http://www.seamonkey-project.org/&quot;;</span>
<a href="#l3.19"></a><span id="l3.19"> const TEST_FAVICON_DATA_URL = &quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH1QwCEiUG/+wAegAAAu5JREFUOMtlk01oXFUUx3/3vfte3kydmeeQJgUTMsEaKX40tREbDHYE6UIXnZVUujCIiu3GKl0EXRh3ol1EF8WutItuuum4sRTRRXFRFGUyRPxIyVe1mK+ZZD46d968e6+LSduoFw7/c+D+Dv8D5wj+984NDQ4mz6TT/iiAMWCMRanO1urqnaJSZy/u/i12F2H46Qe5XGo6DAOMscSxQWuL1t08imI2NlRpba05CVOz/2qQSJx7+/DhfTPAPUhrQxwbJl54mHemJnCkg20pxh67sFStqlGY2pZd/OOjIyPZmTi+D91t0N+/h/enn2NuFW78aXm6dRvfd3NBIItK8bwEGB5Oz3iei1IxWpt7lrW2vPjKKKoDv65bMr5m4kiOvr4kjUaUh0+OO/DRwSBwR5WKabc1Smnu5zGFwgjfLsIv69CKDL+vG44dGyaKNK5rJ+XAQCqfTifY3Gzumrurp04dom0dlrag3gZtBc2OIZPpIZVK0tubycuxsSfD44VnsQaMBbsTxsDBIx3O/2hRsSAbWFwBf21b8vmn6N83zvz8SijL5YhGo47rguOC0YZsVjI+nuAP7RNpCANLpREzkBYMZly+vhxRLivq9Ri5vLxdqlQaaA1as2MfTp7u4fqGS0dbDvVp6hlBJrD0bFkuXarheaBUpSS1Xii1WvsxJovWXfufnX+QK5uSB3xN0tGkfIdHeyFahddfqxIEAs+DZvPv0s4iXf1CiCcmoQvf2Bvw8oEYAazUBM/sFfz8XZsLnzdRyiKlwJg15uau5XYWafYMpAvvvvd4OD+U4PRDMeYO3F7QbP7W4c1ii1YLPA+CQCBExK1b5Wk4uywArLVDxZ+aX6qeZD5ZiXjrRAXP69qUsqueJ5ASoqjC4uIP07Xaqx8CONbaK9+v2KUDuT3sV2uFky99U3TdJkEgCAJBItFVKSNqtYWlmzevT96FAYS19iiwJYSY3X3S2ewjBd8PQinBcaBaXSnV62989d/j/wcgGYelT45hgQAAAABJRU5ErkJggg==&quot;;</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -65,18 +66,24 @@ function run_test() {</span>
<a href="#l3.22"></a><span id="l3.22">   do_test_pending();</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24">   // avoid creating the places smart folder during tests</span>
<a href="#l3.25"></a><span id="l3.25">   Services.prefs.setIntPref(&quot;browser.places.smartBookmarksVersion&quot;, -1);</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">   // import bookmarks from corrupt file</span>
<a href="#l3.28"></a><span id="l3.28">   var corruptBookmarksFile = do_get_file(&quot;bookmarks.corrupt.html&quot;);</span>
<a href="#l3.29"></a><span id="l3.29">   try {</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-    ies.importHTMLFromFile(corruptBookmarksFile, true);</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+    BookmarkHTMLUtils.importFromFile(corruptBookmarksFile, true, after_import);</span>
<a href="#l3.32"></a><span id="l3.32">   } catch(ex) { do_throw(&quot;couldn't import corrupt bookmarks file: &quot; + ex); }</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+}</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+function after_import(success) {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  if (!success) {</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+    do_throw(&quot;Couldn't import corrupt bookmarks file.&quot;);</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  }</span>
<a href="#l3.39"></a><span id="l3.39"> </span>
<a href="#l3.40"></a><span id="l3.40">   // Check that every bookmark is correct</span>
<a href="#l3.41"></a><span id="l3.41">   // Corrupt bookmarks should not have been imported</span>
<a href="#l3.42"></a><span id="l3.42">   database_check();</span>
<a href="#l3.43"></a><span id="l3.43">   waitForAsyncUpdates(function() {</span>
<a href="#l3.44"></a><span id="l3.44">     // Create corruption in database</span>
<a href="#l3.45"></a><span id="l3.45">     var corruptItemId = bs.insertBookmark(bs.toolbarFolder,</span>
<a href="#l3.46"></a><span id="l3.46">                                           uri(&quot;http://test.mozilla.org&quot;),</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineat">@@ -98,24 +105,26 @@ function run_test() {</span>
<a href="#l3.48"></a><span id="l3.48">       ies.exportHTMLToFile(bookmarksFile);</span>
<a href="#l3.49"></a><span id="l3.49">     } catch(ex) { do_throw(&quot;couldn't export to bookmarks.exported.html: &quot; + ex); }</span>
<a href="#l3.50"></a><span id="l3.50"> </span>
<a href="#l3.51"></a><span id="l3.51">     // Clear all bookmarks</span>
<a href="#l3.52"></a><span id="l3.52">     remove_all_bookmarks();</span>
<a href="#l3.53"></a><span id="l3.53"> </span>
<a href="#l3.54"></a><span id="l3.54">     // Import bookmarks</span>
<a href="#l3.55"></a><span id="l3.55">     try {</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-      ies.importHTMLFromFile(bookmarksFile, true);</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+      BookmarkHTMLUtils.importFromFile(bookmarksFile, true, before_database_check);</span>
<a href="#l3.58"></a><span id="l3.58">     } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+  });</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+}</span>
<a href="#l3.61"></a><span id="l3.61"> </span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+function before_database_check(success) {</span>
<a href="#l3.63"></a><span id="l3.63">     // Check that every bookmark is correct</span>
<a href="#l3.64"></a><span id="l3.64">     database_check();</span>
<a href="#l3.65"></a><span id="l3.65"> </span>
<a href="#l3.66"></a><span id="l3.66">     waitForAsyncUpdates(do_test_finished);</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-  });</span>
<a href="#l3.68"></a><span id="l3.68"> }</span>
<a href="#l3.69"></a><span id="l3.69"> </span>
<a href="#l3.70"></a><span id="l3.70"> /*</span>
<a href="#l3.71"></a><span id="l3.71">  * Check for imported bookmarks correctness</span>
<a href="#l3.72"></a><span id="l3.72">  */</span>
<a href="#l3.73"></a><span id="l3.73"> function database_check() {</span>
<a href="#l3.74"></a><span id="l3.74">   // BOOKMARKS MENU</span>
<a href="#l3.75"></a><span id="l3.75">   var query = hs.getNewQuery();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/suite/common/places/tests/unit/test_bookmarksRestoreNotification.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/suite/common/places/tests/unit/test_bookmarksRestoreNotification.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -31,16 +31,18 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.5"></a><span id="l4.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.6"></a><span id="l4.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.7"></a><span id="l4.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.8"></a><span id="l4.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.9"></a><span id="l4.9">  *</span>
<a href="#l4.10"></a><span id="l4.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+Cu.import(&quot;resource://gre/modules/BookmarkHTMLUtils.jsm&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+</span>
<a href="#l4.14"></a><span id="l4.14"> /**</span>
<a href="#l4.15"></a><span id="l4.15">  * Tests the bookmarks-restore-* nsIObserver notifications after restoring</span>
<a href="#l4.16"></a><span id="l4.16">  * bookmarks from JSON and HTML.  See bug 470314.</span>
<a href="#l4.17"></a><span id="l4.17">  */</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> // The topics and data passed to nsIObserver.observe() on bookmarks restore</span>
<a href="#l4.20"></a><span id="l4.20"> const NSIOBSERVER_TOPIC_BEGIN    = &quot;bookmarks-restore-begin&quot;;</span>
<a href="#l4.21"></a><span id="l4.21"> const NSIOBSERVER_TOPIC_SUCCESS  = &quot;bookmarks-restore-success&quot;;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -129,37 +131,45 @@ var tests = [</span>
<a href="#l4.23"></a><span id="l4.23">     desc:       &quot;HTML restore: normal restore should succeed&quot;,</span>
<a href="#l4.24"></a><span id="l4.24">     currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l4.25"></a><span id="l4.25">     finalTopic: NSIOBSERVER_TOPIC_SUCCESS,</span>
<a href="#l4.26"></a><span id="l4.26">     data:       NSIOBSERVER_DATA_HTML,</span>
<a href="#l4.27"></a><span id="l4.27">     folderId:   null,</span>
<a href="#l4.28"></a><span id="l4.28">     run:        function () {</span>
<a href="#l4.29"></a><span id="l4.29">       this.file = createFile(&quot;bookmarks-test_restoreNotification.html&quot;);</span>
<a href="#l4.30"></a><span id="l4.30">       addBookmarks();</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-      importer.exportHTMLToFile(this.file);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+      exporter.exportHTMLToFile(this.file);</span>
<a href="#l4.33"></a><span id="l4.33">       remove_all_bookmarks();</span>
<a href="#l4.34"></a><span id="l4.34">       try {</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-        importer.importHTMLFromFile(this.file, false);</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+        BookmarkHTMLUtils.importFromFile(this.file, false, function (success) {</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+          if (!success) {</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+            do_throw(&quot;  Restore should not have failed&quot;);</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+          }</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+        });</span>
<a href="#l4.41"></a><span id="l4.41">       }</span>
<a href="#l4.42"></a><span id="l4.42">       catch (e) {</span>
<a href="#l4.43"></a><span id="l4.43">         do_throw(&quot;  Restore should not have failed&quot;);</span>
<a href="#l4.44"></a><span id="l4.44">       }</span>
<a href="#l4.45"></a><span id="l4.45">     }</span>
<a href="#l4.46"></a><span id="l4.46">   },</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48">   {</span>
<a href="#l4.49"></a><span id="l4.49">     desc:       &quot;HTML restore: empty file should succeed&quot;,</span>
<a href="#l4.50"></a><span id="l4.50">     currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l4.51"></a><span id="l4.51">     finalTopic: NSIOBSERVER_TOPIC_SUCCESS,</span>
<a href="#l4.52"></a><span id="l4.52">     data:       NSIOBSERVER_DATA_HTML,</span>
<a href="#l4.53"></a><span id="l4.53">     folderId:   null,</span>
<a href="#l4.54"></a><span id="l4.54">     run:        function () {</span>
<a href="#l4.55"></a><span id="l4.55">       this.file = createFile(&quot;bookmarks-test_restoreNotification.init.html&quot;);</span>
<a href="#l4.56"></a><span id="l4.56">       try {</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-        importer.importHTMLFromFile(this.file, false);</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+        BookmarkHTMLUtils.importFromFile(this.file, false, function (success) {</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+          if (!success) {</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+            do_throw(&quot;  Restore should not have failed&quot;);</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+          }</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+        });</span>
<a href="#l4.63"></a><span id="l4.63">       }</span>
<a href="#l4.64"></a><span id="l4.64">       catch (e) {</span>
<a href="#l4.65"></a><span id="l4.65">         do_throw(&quot;  Restore should not have failed&quot;);</span>
<a href="#l4.66"></a><span id="l4.66">       }</span>
<a href="#l4.67"></a><span id="l4.67">     }</span>
<a href="#l4.68"></a><span id="l4.68">   },</span>
<a href="#l4.69"></a><span id="l4.69"> </span>
<a href="#l4.70"></a><span id="l4.70">   {</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineat">@@ -167,53 +177,65 @@ var tests = [</span>
<a href="#l4.72"></a><span id="l4.72">     currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l4.73"></a><span id="l4.73">     finalTopic: NSIOBSERVER_TOPIC_FAILED,</span>
<a href="#l4.74"></a><span id="l4.74">     data:       NSIOBSERVER_DATA_HTML,</span>
<a href="#l4.75"></a><span id="l4.75">     folderId:   null,</span>
<a href="#l4.76"></a><span id="l4.76">     run:        function () {</span>
<a href="#l4.77"></a><span id="l4.77">       this.file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsILocalFile);</span>
<a href="#l4.78"></a><span id="l4.78">       this.file.append(&quot;this file doesn't exist because nobody created it&quot;);</span>
<a href="#l4.79"></a><span id="l4.79">       try {</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-        importer.importHTMLFromFile(this.file, false);</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-        do_throw(&quot;  Restore should have failed&quot;);</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+        BookmarkHTMLUtils.importFromFile(this.file, false, function (success) {</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+          print(&quot;callback&quot;);</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+          if (success) {</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+            do_throw(&quot;  Restore should have failed&quot;);</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+          }</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+        });</span>
<a href="#l4.88"></a><span id="l4.88">       }</span>
<a href="#l4.89"></a><span id="l4.89">       catch (e) {}</span>
<a href="#l4.90"></a><span id="l4.90">     }</span>
<a href="#l4.91"></a><span id="l4.91">   },</span>
<a href="#l4.92"></a><span id="l4.92"> </span>
<a href="#l4.93"></a><span id="l4.93">   {</span>
<a href="#l4.94"></a><span id="l4.94">     desc:       &quot;HTML initial restore: normal restore should succeed&quot;,</span>
<a href="#l4.95"></a><span id="l4.95">     currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l4.96"></a><span id="l4.96">     finalTopic: NSIOBSERVER_TOPIC_SUCCESS,</span>
<a href="#l4.97"></a><span id="l4.97">     data:       NSIOBSERVER_DATA_HTML_INIT,</span>
<a href="#l4.98"></a><span id="l4.98">     folderId:   null,</span>
<a href="#l4.99"></a><span id="l4.99">     run:        function () {</span>
<a href="#l4.100"></a><span id="l4.100">       this.file = createFile(&quot;bookmarks-test_restoreNotification.init.html&quot;);</span>
<a href="#l4.101"></a><span id="l4.101">       addBookmarks();</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-      importer.exportHTMLToFile(this.file);</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+      exporter.exportHTMLToFile(this.file);</span>
<a href="#l4.104"></a><span id="l4.104">       remove_all_bookmarks();</span>
<a href="#l4.105"></a><span id="l4.105">       try {</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-        importer.importHTMLFromFile(this.file, true);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+        BookmarkHTMLUtils.importFromFile(this.file, true, function (success) {</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+          if (!success) {</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+            do_throw(&quot;  Restore should not have failed&quot;);</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+          }</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+        });</span>
<a href="#l4.112"></a><span id="l4.112">       }</span>
<a href="#l4.113"></a><span id="l4.113">       catch (e) {</span>
<a href="#l4.114"></a><span id="l4.114">         do_throw(&quot;  Restore should not have failed&quot;);</span>
<a href="#l4.115"></a><span id="l4.115">       }</span>
<a href="#l4.116"></a><span id="l4.116">     }</span>
<a href="#l4.117"></a><span id="l4.117">   },</span>
<a href="#l4.118"></a><span id="l4.118"> </span>
<a href="#l4.119"></a><span id="l4.119">   {</span>
<a href="#l4.120"></a><span id="l4.120">     desc:       &quot;HTML initial restore: empty file should succeed&quot;,</span>
<a href="#l4.121"></a><span id="l4.121">     currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l4.122"></a><span id="l4.122">     finalTopic: NSIOBSERVER_TOPIC_SUCCESS,</span>
<a href="#l4.123"></a><span id="l4.123">     data:       NSIOBSERVER_DATA_HTML_INIT,</span>
<a href="#l4.124"></a><span id="l4.124">     folderId:   null,</span>
<a href="#l4.125"></a><span id="l4.125">     run:        function () {</span>
<a href="#l4.126"></a><span id="l4.126">       this.file = createFile(&quot;bookmarks-test_restoreNotification.init.html&quot;);</span>
<a href="#l4.127"></a><span id="l4.127">       try {</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineminus">-        importer.importHTMLFromFile(this.file, true);</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+        BookmarkHTMLUtils.importFromFile(this.file, true, function (success) {</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+          if (!success) {</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+            do_throw(&quot;  Restore should not have failed&quot;);</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+          }</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+        });</span>
<a href="#l4.134"></a><span id="l4.134">       }</span>
<a href="#l4.135"></a><span id="l4.135">       catch (e) {</span>
<a href="#l4.136"></a><span id="l4.136">         do_throw(&quot;  Restore should not have failed&quot;);</span>
<a href="#l4.137"></a><span id="l4.137">       }</span>
<a href="#l4.138"></a><span id="l4.138">     }</span>
<a href="#l4.139"></a><span id="l4.139">   },</span>
<a href="#l4.140"></a><span id="l4.140"> </span>
<a href="#l4.141"></a><span id="l4.141">   {</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineat">@@ -221,23 +243,25 @@ var tests = [</span>
<a href="#l4.143"></a><span id="l4.143">     currTopic:  NSIOBSERVER_TOPIC_BEGIN,</span>
<a href="#l4.144"></a><span id="l4.144">     finalTopic: NSIOBSERVER_TOPIC_FAILED,</span>
<a href="#l4.145"></a><span id="l4.145">     data:       NSIOBSERVER_DATA_HTML_INIT,</span>
<a href="#l4.146"></a><span id="l4.146">     folderId:   null,</span>
<a href="#l4.147"></a><span id="l4.147">     run:        function () {</span>
<a href="#l4.148"></a><span id="l4.148">       this.file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsILocalFile);</span>
<a href="#l4.149"></a><span id="l4.149">       this.file.append(&quot;this file doesn't exist because nobody created it&quot;);</span>
<a href="#l4.150"></a><span id="l4.150">       try {</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-        importer.importHTMLFromFile(this.file, true);</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineminus">-        do_throw(&quot;  Restore should have failed&quot;);</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+        BookmarkHTMLUtils.importFromFile(this.file, true, function (success) {</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+          if (success) {</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+            do_throw(&quot;  Restore should have failed&quot;);</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+          }</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+        });</span>
<a href="#l4.158"></a><span id="l4.158">       }</span>
<a href="#l4.159"></a><span id="l4.159">       catch (e) {}</span>
<a href="#l4.160"></a><span id="l4.160">     }</span>
<a href="#l4.161"></a><span id="l4.161">   }</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineminus">-</span>
<a href="#l4.163"></a><span id="l4.163"> ];</span>
<a href="#l4.164"></a><span id="l4.164"> </span>
<a href="#l4.165"></a><span id="l4.165"> // nsIObserver that observes bookmarks-restore-begin.</span>
<a href="#l4.166"></a><span id="l4.166"> var beginObserver = {</span>
<a href="#l4.167"></a><span id="l4.167">   observe: function _beginObserver(aSubject, aTopic, aData) {</span>
<a href="#l4.168"></a><span id="l4.168">     var test = tests[currTestIndex];</span>
<a href="#l4.169"></a><span id="l4.169"> </span>
<a href="#l4.170"></a><span id="l4.170">     print(&quot;  Observed &quot; + aTopic);</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineat">@@ -276,30 +300,30 @@ var successAndFailedObserver = {</span>
<a href="#l4.172"></a><span id="l4.172">     if (aSubject) {</span>
<a href="#l4.173"></a><span id="l4.173">       do_check_eq(aSubject.QueryInterface(Ci.nsISupportsPRInt64).data,</span>
<a href="#l4.174"></a><span id="l4.174">                   test.folderId);</span>
<a href="#l4.175"></a><span id="l4.175">     }</span>
<a href="#l4.176"></a><span id="l4.176">     else</span>
<a href="#l4.177"></a><span id="l4.177">       do_check_eq(test.folderId, null);</span>
<a href="#l4.178"></a><span id="l4.178"> </span>
<a href="#l4.179"></a><span id="l4.179">     remove_all_bookmarks();</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-    doNextTest();</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+    do_execute_soon(doNextTest);</span>
<a href="#l4.182"></a><span id="l4.182">   }</span>
<a href="#l4.183"></a><span id="l4.183"> };</span>
<a href="#l4.184"></a><span id="l4.184"> </span>
<a href="#l4.185"></a><span id="l4.185"> // Index of the currently running test.  See doNextTest().</span>
<a href="#l4.186"></a><span id="l4.186"> var currTestIndex = -1;</span>
<a href="#l4.187"></a><span id="l4.187"> </span>
<a href="#l4.188"></a><span id="l4.188"> var bmsvc = Cc[&quot;@mozilla.org/browser/nav-bookmarks-service;1&quot;].</span>
<a href="#l4.189"></a><span id="l4.189">             getService(Ci.nsINavBookmarksService);</span>
<a href="#l4.190"></a><span id="l4.190"> </span>
<a href="#l4.191"></a><span id="l4.191"> var obssvc = Cc[&quot;@mozilla.org/observer-service;1&quot;].</span>
<a href="#l4.192"></a><span id="l4.192">              getService(Ci.nsIObserverService);</span>
<a href="#l4.193"></a><span id="l4.193"> </span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-var importer = Cc[&quot;@mozilla.org/browser/places/import-export-service;1&quot;].</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+var exporter = Cc[&quot;@mozilla.org/browser/places/import-export-service;1&quot;].</span>
<a href="#l4.196"></a><span id="l4.196">                getService(Ci.nsIPlacesImportExportService);</span>
<a href="#l4.197"></a><span id="l4.197"> </span>
<a href="#l4.198"></a><span id="l4.198"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l4.199"></a><span id="l4.199"> </span>
<a href="#l4.200"></a><span id="l4.200"> /**</span>
<a href="#l4.201"></a><span id="l4.201">  * Adds some bookmarks for the URIs in |uris|.</span>
<a href="#l4.202"></a><span id="l4.202">  */</span>
<a href="#l4.203"></a><span id="l4.203"> function addBookmarks() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/suite/common/places/tests/unit/test_bookmarks_html.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/suite/common/places/tests/unit/test_bookmarks_html.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -129,19 +129,21 @@ let test_bookmarks = {</span>
<a href="#l5.4"></a><span id="l5.4">   ]</span>
<a href="#l5.5"></a><span id="l5.5"> };</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> // Pre-Places bookmarks.html file pointer.</span>
<a href="#l5.8"></a><span id="l5.8"> let gBookmarksFileOld;</span>
<a href="#l5.9"></a><span id="l5.9"> // Places bookmarks.html file pointer.</span>
<a href="#l5.10"></a><span id="l5.10"> let gBookmarksFileNew;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-let importer = Cc[&quot;@mozilla.org/browser/places/import-export-service;1&quot;].</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+let exporter = Cc[&quot;@mozilla.org/browser/places/import-export-service;1&quot;].</span>
<a href="#l5.14"></a><span id="l5.14">                getService(Ci.nsIPlacesImportExportService);</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+Cu.import(&quot;resource://gre/modules/BookmarkHTMLUtils.jsm&quot;);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+</span>
<a href="#l5.18"></a><span id="l5.18"> function run_test()</span>
<a href="#l5.19"></a><span id="l5.19"> {</span>
<a href="#l5.20"></a><span id="l5.20">   run_next_test();</span>
<a href="#l5.21"></a><span id="l5.21"> }</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23"> add_test(function setup() {</span>
<a href="#l5.24"></a><span id="l5.24">   // Avoid creating smart bookmarks during the test.</span>
<a href="#l5.25"></a><span id="l5.25">   Services.prefs.setIntPref(&quot;browser.places.smartBookmarksVersion&quot;, -1);</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineat">@@ -161,131 +163,157 @@ add_test(function setup() {</span>
<a href="#l5.27"></a><span id="l5.27">   }</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29">   // This test must be the first one, since it setups the new bookmarks.html.</span>
<a href="#l5.30"></a><span id="l5.30">   // Test importing a pre-Places canonical bookmarks file.</span>
<a href="#l5.31"></a><span id="l5.31">   // 1. import bookmarks.preplaces.html</span>
<a href="#l5.32"></a><span id="l5.32">   // 2. run the test-suite</span>
<a href="#l5.33"></a><span id="l5.33">   // Note: we do not empty the db before this import to catch bugs like 380999</span>
<a href="#l5.34"></a><span id="l5.34">   try {</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-    importer.importHTMLFromFile(gBookmarksFileOld, true);</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-  } catch(ex) { do_throw(&quot;couldn't import legacy bookmarks file: &quot; + ex); }</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+    BookmarkHTMLUtils.importFromFile(gBookmarksFileOld, true, function(success) {</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+      if (success) {</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+        waitForAsyncUpdates(function () {</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+          testImportedBookmarks();</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-  waitForAsyncUpdates(function () {</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-    testImportedBookmarks();</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+          // Prepare for next tests.</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+          try {</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+            exporter.exportHTMLToFile(gBookmarksFileNew);</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+          } catch(ex) { do_throw(&quot;couldn't export to file: &quot; + ex); }</span>
<a href="#l5.48"></a><span id="l5.48"> </span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-    // Prepare for next tests.</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-    try {</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-      importer.exportHTMLToFile(gBookmarksFileNew);</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-    } catch(ex) { do_throw(&quot;couldn't export to file: &quot; + ex); }</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-    waitForAsyncUpdates(function () {</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-      remove_all_bookmarks();</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-      run_next_test();</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+          waitForAsyncUpdates(function () {</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+            remove_all_bookmarks();</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+            run_next_test();</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+          });</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+        });</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+      } else {</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+        do_throw(&quot;couldn't import legacy bookmarks file.&quot;);</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+      }</span>
<a href="#l5.65"></a><span id="l5.65">     });</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-  });</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't import legacy bookmarks file: &quot; + ex); }</span>
<a href="#l5.68"></a><span id="l5.68"> });</span>
<a href="#l5.69"></a><span id="l5.69"> </span>
<a href="#l5.70"></a><span id="l5.70"> add_test(function test_import_new()</span>
<a href="#l5.71"></a><span id="l5.71"> {</span>
<a href="#l5.72"></a><span id="l5.72">   // Test importing a Places bookmarks.html file.</span>
<a href="#l5.73"></a><span id="l5.73">   // 1. import bookmarks.exported.html</span>
<a href="#l5.74"></a><span id="l5.74">   // 2. run the test-suite</span>
<a href="#l5.75"></a><span id="l5.75"> </span>
<a href="#l5.76"></a><span id="l5.76">   try {</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-    importer.importHTMLFromFile(gBookmarksFileNew, true);</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-  } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-  waitForAsyncUpdates(function () {</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-    testImportedBookmarks();</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+    BookmarkHTMLUtils.importFromFile(gBookmarksFileNew, true, function(success) {</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+      if (success) {</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+        waitForAsyncUpdates(function () {</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+          testImportedBookmarks();</span>
<a href="#l5.86"></a><span id="l5.86"> </span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-    waitForAsyncUpdates(function () {</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-      remove_all_bookmarks();</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-      run_next_test();</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+          waitForAsyncUpdates(function () {</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+            remove_all_bookmarks();</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+            run_next_test();</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+          });</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+        });</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+      } else {</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+        do_throw(&quot;couldn't import the exported file.&quot;);</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+      }</span>
<a href="#l5.98"></a><span id="l5.98">     });</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-  });</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l5.101"></a><span id="l5.101"> });</span>
<a href="#l5.102"></a><span id="l5.102"> </span>
<a href="#l5.103"></a><span id="l5.103"> add_test(function test_emptytitle_export()</span>
<a href="#l5.104"></a><span id="l5.104"> {</span>
<a href="#l5.105"></a><span id="l5.105">   // Test exporting and importing with an empty-titled bookmark.</span>
<a href="#l5.106"></a><span id="l5.106">   // 1. import bookmarks</span>
<a href="#l5.107"></a><span id="l5.107">   // 1. create an empty-titled bookmark.</span>
<a href="#l5.108"></a><span id="l5.108">   // 2. export to bookmarks.exported.html</span>
<a href="#l5.109"></a><span id="l5.109">   // 3. empty bookmarks db</span>
<a href="#l5.110"></a><span id="l5.110">   // 4. import bookmarks.exported.html</span>
<a href="#l5.111"></a><span id="l5.111">   // 5. run the test-suite</span>
<a href="#l5.112"></a><span id="l5.112"> </span>
<a href="#l5.113"></a><span id="l5.113">   try {</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-    importer.importHTMLFromFile(gBookmarksFileNew, true);</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-  } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+    BookmarkHTMLUtils.importFromFile(gBookmarksFileNew, true, function(success) {</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+      if (success) {</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+        const NOTITLE_URL = &quot;http://notitle.mozilla.org/&quot;;</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+        let id = PlacesUtils.bookmarks.insertBookmark(PlacesUtils.unfiledBookmarksFolderId,</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+                                                      NetUtil.newURI(NOTITLE_URL),</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+                                                      PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+                                                      &quot;&quot;);</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+        test_bookmarks.unfiled.push({ title: &quot;&quot;, url: NOTITLE_URL });</span>
<a href="#l5.124"></a><span id="l5.124"> </span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-  const NOTITLE_URL = &quot;http://notitle.mozilla.org/&quot;;</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-  let id = PlacesUtils.bookmarks.insertBookmark(PlacesUtils.unfiledBookmarksFolderId,</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-                                                NetUtil.newURI(NOTITLE_URL),</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-                                                PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-                                                &quot;&quot;);</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-  test_bookmarks.unfiled.push({ title: &quot;&quot;, url: NOTITLE_URL });</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+        try {</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+          exporter.exportHTMLToFile(gBookmarksFileNew);</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+        } catch(ex) { do_throw(&quot;couldn't export to file: &quot; + ex); }</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+        remove_all_bookmarks();</span>
<a href="#l5.136"></a><span id="l5.136"> </span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-  try {</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-    importer.exportHTMLToFile(gBookmarksFileNew);</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-  } catch(ex) { do_throw(&quot;couldn't export to file: &quot; + ex); }</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-  remove_all_bookmarks();</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+        try {</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+          BookmarkHTMLUtils.importFromFile(gBookmarksFileNew, true, function(success) {</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+           if (success) {</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+              waitForAsyncUpdates(function () {</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+                testImportedBookmarks();</span>
<a href="#l5.147"></a><span id="l5.147"> </span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-  try {</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-    importer.importHTMLFromFile(gBookmarksFileNew, true);</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-  } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+                // Cleanup.</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+                test_bookmarks.unfiled.pop();</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+                PlacesUtils.bookmarks.removeItem(id);</span>
<a href="#l5.154"></a><span id="l5.154"> </span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-  waitForAsyncUpdates(function () {</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-    testImportedBookmarks();</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+                try {</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+                  exporter.exportHTMLToFile(gBookmarksFileNew);</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+                } catch(ex) { do_throw(&quot;couldn't export to file: &quot; + ex); }</span>
<a href="#l5.160"></a><span id="l5.160"> </span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-    // Cleanup.</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-    test_bookmarks.unfiled.pop();</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineminus">-    PlacesUtils.bookmarks.removeItem(id);</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineminus">-</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-    try {</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-      importer.exportHTMLToFile(gBookmarksFileNew);</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-    } catch(ex) { do_throw(&quot;couldn't export to file: &quot; + ex); }</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-    waitForAsyncUpdates(function () {</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-      remove_all_bookmarks();</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-      run_next_test();</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+                waitForAsyncUpdates(function () {</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+                  remove_all_bookmarks();</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+                  run_next_test();</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+                });</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+              });</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+            } else {</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+              do_throw(&quot;couldn't import the exported file.&quot;);</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+            }</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+          });</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+        } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+      } else {</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+        do_throw(&quot;couldn't import the exported file.&quot;);</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+      }</span>
<a href="#l5.185"></a><span id="l5.185">     });</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-  });</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l5.188"></a><span id="l5.188"> });</span>
<a href="#l5.189"></a><span id="l5.189"> </span>
<a href="#l5.190"></a><span id="l5.190"> add_test(function test_import_ontop()</span>
<a href="#l5.191"></a><span id="l5.191"> {</span>
<a href="#l5.192"></a><span id="l5.192">   // Test importing the exported bookmarks.html file *on top of* the existing</span>
<a href="#l5.193"></a><span id="l5.193">   // bookmarks.</span>
<a href="#l5.194"></a><span id="l5.194">   // 1. empty bookmarks db</span>
<a href="#l5.195"></a><span id="l5.195">   // 2. import the exported bookmarks file</span>
<a href="#l5.196"></a><span id="l5.196">   // 3. export to file</span>
<a href="#l5.197"></a><span id="l5.197">   // 3. import the exported bookmarks file</span>
<a href="#l5.198"></a><span id="l5.198">   // 4. run the test-suite</span>
<a href="#l5.199"></a><span id="l5.199"> </span>
<a href="#l5.200"></a><span id="l5.200">   try {</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineminus">-    importer.importHTMLFromFile(gBookmarksFileNew, true);</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineminus">-  } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-  try {</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-    importer.exportHTMLToFile(gBookmarksFileNew);</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-  } catch(ex) { do_throw(&quot;couldn't export to file: &quot; + ex); }</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-  try {</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-    importer.importHTMLFromFile(gBookmarksFileNew, true);</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-  } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+    BookmarkHTMLUtils.importFromFile(gBookmarksFileNew, true, function(success) {</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+      if (success) {</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+        try {</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+          exporter.exportHTMLToFile(gBookmarksFileNew);</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+        } catch(ex) { do_throw(&quot;couldn't export to file: &quot; + ex); }</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+        try {</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineplus">+          BookmarkHTMLUtils.importFromFile(gBookmarksFileNew, true, function(success) {</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+            if (success) {</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+              waitForAsyncUpdates(function () {</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineplus">+                testImportedBookmarks();</span>
<a href="#l5.219"></a><span id="l5.219"> </span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-  waitForAsyncUpdates(function () {</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-    testImportedBookmarks();</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+                waitForAsyncUpdates(function () {</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+                  remove_all_bookmarks();</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+                  run_next_test();</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+                });</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+              });</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+            } else {</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+              do_throw(&quot;couldn't import the exported file.&quot;);</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+            }</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+          });</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+        } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l5.232"></a><span id="l5.232"> </span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-    waitForAsyncUpdates(function () {</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-      remove_all_bookmarks();</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineminus">-      run_next_test();</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+      } else {</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+        do_throw(&quot;couldn't import the exported file.&quot;);</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+      }</span>
<a href="#l5.239"></a><span id="l5.239">     });</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineminus">-  });</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+  } catch(ex) { do_throw(&quot;couldn't import the exported file: &quot; + ex); }</span>
<a href="#l5.242"></a><span id="l5.242"> });</span>
<a href="#l5.243"></a><span id="l5.243"> </span>
<a href="#l5.244"></a><span id="l5.244"> function testImportedBookmarks()</span>
<a href="#l5.245"></a><span id="l5.245"> {</span>
<a href="#l5.246"></a><span id="l5.246">   for (let group in test_bookmarks) {</span>
<a href="#l5.247"></a><span id="l5.247">     do_print(&quot;[testImportedBookmarks()] Checking group '&quot; + group + &quot;'&quot;);</span>
<a href="#l5.248"></a><span id="l5.248"> </span>
<a href="#l5.249"></a><span id="l5.249">     let root;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/suite/common/places/tests/unit/test_browserGlue_migrate.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/suite/common/places/tests/unit/test_browserGlue_migrate.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -87,24 +87,25 @@ function run_test() {</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">   // Initialize Places through the History Service.</span>
<a href="#l6.6"></a><span id="l6.6">   let hs = Cc[&quot;@mozilla.org/browser/nav-history-service;1&quot;].</span>
<a href="#l6.7"></a><span id="l6.7">            getService(Ci.nsINavHistoryService);</span>
<a href="#l6.8"></a><span id="l6.8">   // Check a new database has been created.</span>
<a href="#l6.9"></a><span id="l6.9">   // nsSuiteGlue uses databaseStatus to manage initialization.</span>
<a href="#l6.10"></a><span id="l6.10">   do_check_eq(hs.databaseStatus, hs.DATABASE_STATUS_CREATE);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  // A migrator would run before nsSuiteGlue, so we mimic that behavior</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  // adding a bookmark.</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  // A migrator would run before nsSuiteGlue Places initialization, so mimic</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  // that behavior adding a bookmark and notifying the migration.</span>
<a href="#l6.16"></a><span id="l6.16">   bs.insertBookmark(bs.bookmarksMenuFolder, uri(&quot;http://mozilla.org/&quot;),</span>
<a href="#l6.17"></a><span id="l6.17">                     bs.DEFAULT_INDEX, &quot;migrated&quot;);</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">   // Initialize nsSuiteGlue.</span>
<a href="#l6.20"></a><span id="l6.20">   let bg = Cc[&quot;@mozilla.org/suite/suiteglue;1&quot;].</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-           getService(Ci.nsISuiteGlue);</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+           getService(Ci.nsIObserver);</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+  bg.observe(null, &quot;initial-migration&quot;, null)</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25">   // The test will continue once import has finished and smart bookmarks</span>
<a href="#l6.26"></a><span id="l6.26">   // have been created.</span>
<a href="#l6.27"></a><span id="l6.27">   bs.addObserver(bookmarksObserver, false);</span>
<a href="#l6.28"></a><span id="l6.28"> }</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30"> function continue_test() {</span>
<a href="#l6.31"></a><span id="l6.31">   // Check the created bookmarks still exist.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/suite/common/places/tests/unit/test_browserGlue_prefs.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/suite/common/places/tests/unit/test_browserGlue_prefs.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -57,179 +57,201 @@ let bs = Cc[&quot;@mozilla.org/browser/nav-bo</span>
<a href="#l7.4"></a><span id="l7.4"> let os = Cc[&quot;@mozilla.org/observer-service;1&quot;].</span>
<a href="#l7.5"></a><span id="l7.5">          getService(Ci.nsIObserverService);</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> const PREF_IMPORT_BOOKMARKS_HTML = &quot;browser.places.importBookmarksHTML&quot;;</span>
<a href="#l7.8"></a><span id="l7.8"> const PREF_RESTORE_DEFAULT_BOOKMARKS = &quot;browser.bookmarks.restore_default_bookmarks&quot;;</span>
<a href="#l7.9"></a><span id="l7.9"> const PREF_SMART_BOOKMARKS_VERSION = &quot;browser.places.smartBookmarksVersion&quot;;</span>
<a href="#l7.10"></a><span id="l7.10"> const PREF_AUTO_EXPORT_HTML = &quot;browser.bookmarks.autoExportHTML&quot;;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+function waitForImportAndSmartBookmarks(aCallback) {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  Services.obs.addObserver(function waitImport() {</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+    Services.obs.removeObserver(waitImport, &quot;bookmarks-restore-success&quot;);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+    // Delay to test eventual smart bookmarks creation.</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+    do_execute_soon(function () {</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+      waitForAsyncUpdates(aCallback);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+    });</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+  }, &quot;bookmarks-restore-success&quot;, false);</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+}</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+</span>
<a href="#l7.22"></a><span id="l7.22"> let tests = [];</span>
<a href="#l7.23"></a><span id="l7.23"> //------------------------------------------------------------------------------</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25"> tests.push({</span>
<a href="#l7.26"></a><span id="l7.26">   description: &quot;Import from bookmarks.html if importBookmarksHTML is true.&quot;,</span>
<a href="#l7.27"></a><span id="l7.27">   exec: function() {</span>
<a href="#l7.28"></a><span id="l7.28">     // Sanity check: we should not have any bookmark on the toolbar.</span>
<a href="#l7.29"></a><span id="l7.29">     do_check_eq(bs.getIdForItemAt(bs.toolbarFolder, 0), -1);</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31">     // Set preferences.</span>
<a href="#l7.32"></a><span id="l7.32">     Services.prefs.setBoolPref(PREF_IMPORT_BOOKMARKS_HTML, true);</span>
<a href="#l7.33"></a><span id="l7.33"> </span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+    waitForImportAndSmartBookmarks(function () {</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+      // Check bookmarks.html has been imported, and a smart bookmark has been</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+      // created.</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+      let itemId = bs.getIdForItemAt(bs.toolbarFolder,</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+                                     SMART_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+      do_check_eq(bs.getItemTitle(itemId), &quot;example&quot;);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+      // Check preferences have been reverted.</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+      do_check_false(Services.prefs.getBoolPref(PREF_IMPORT_BOOKMARKS_HTML));</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+      next_test();</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+    });</span>
<a href="#l7.45"></a><span id="l7.45">     // Force nsSuiteGlue::_initPlaces().</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-    print(&quot;Simulate Places init&quot;);</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+    do_log_info(&quot;Simulate Places init&quot;);</span>
<a href="#l7.48"></a><span id="l7.48">     bg.QueryInterface(Ci.nsIObserver).observe(null,</span>
<a href="#l7.49"></a><span id="l7.49">                                               PlacesUtils.TOPIC_INIT_COMPLETE,</span>
<a href="#l7.50"></a><span id="l7.50">                                               null);</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-    // Check bookmarks.html has been imported, and a smart bookmark has been</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-    // created.</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-    let itemId = bs.getIdForItemAt(bs.toolbarFolder,</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-                                   SMART_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-    do_check_eq(bs.getItemTitle(itemId), &quot;example&quot;);</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-    // Check preferences have been reverted.</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-    do_check_false(Services.prefs.getBoolPref(PREF_IMPORT_BOOKMARKS_HTML));</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-    next_test();</span>
<a href="#l7.60"></a><span id="l7.60">   }</span>
<a href="#l7.61"></a><span id="l7.61"> });</span>
<a href="#l7.62"></a><span id="l7.62"> </span>
<a href="#l7.63"></a><span id="l7.63"> //------------------------------------------------------------------------------</span>
<a href="#l7.64"></a><span id="l7.64"> </span>
<a href="#l7.65"></a><span id="l7.65"> tests.push({</span>
<a href="#l7.66"></a><span id="l7.66">   description: &quot;import from bookmarks.html, but don't create smart bookmarks if they are disabled&quot;,</span>
<a href="#l7.67"></a><span id="l7.67">   exec: function() {</span>
<a href="#l7.68"></a><span id="l7.68">     // Sanity check: we should not have any bookmark on the toolbar.</span>
<a href="#l7.69"></a><span id="l7.69">     do_check_eq(bs.getIdForItemAt(bs.toolbarFolder, 0), -1);</span>
<a href="#l7.70"></a><span id="l7.70"> </span>
<a href="#l7.71"></a><span id="l7.71">     // Set preferences.</span>
<a href="#l7.72"></a><span id="l7.72">     Services.prefs.setIntPref(PREF_SMART_BOOKMARKS_VERSION, -1);</span>
<a href="#l7.73"></a><span id="l7.73">     Services.prefs.setBoolPref(PREF_IMPORT_BOOKMARKS_HTML, true);</span>
<a href="#l7.74"></a><span id="l7.74"> </span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+    waitForImportAndSmartBookmarks(function () {</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+      // Check bookmarks.html has been imported, but smart bookmarks have not</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+      // been created.</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+      let itemId = bs.getIdForItemAt(bs.toolbarFolder, 0);</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+      do_check_eq(bs.getItemTitle(itemId), &quot;example&quot;);</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+      // Check preferences have been reverted.</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+      do_check_false(Services.prefs.getBoolPref(PREF_IMPORT_BOOKMARKS_HTML));</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+      next_test();</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+    });</span>
<a href="#l7.85"></a><span id="l7.85">     // Force nsSuiteGlue::_initPlaces().</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-    print(&quot;Simulate Places init&quot;);</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+    do_log_info(&quot;Simulate Places init&quot;);</span>
<a href="#l7.88"></a><span id="l7.88">     bg.QueryInterface(Ci.nsIObserver).observe(null,</span>
<a href="#l7.89"></a><span id="l7.89">                                               PlacesUtils.TOPIC_INIT_COMPLETE,</span>
<a href="#l7.90"></a><span id="l7.90">                                               null);</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-    // Check bookmarks.html has been imported, but smart bookmarks have not</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-    // been created.</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-    let itemId = bs.getIdForItemAt(bs.toolbarFolder, 0);</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-    do_check_eq(bs.getItemTitle(itemId), &quot;example&quot;);</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-    // Check preferences have been reverted.</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-    do_check_false(Services.prefs.getBoolPref(PREF_IMPORT_BOOKMARKS_HTML));</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-    next_test();</span>
<a href="#l7.99"></a><span id="l7.99">   }</span>
<a href="#l7.100"></a><span id="l7.100"> });</span>
<a href="#l7.101"></a><span id="l7.101"> </span>
<a href="#l7.102"></a><span id="l7.102"> //------------------------------------------------------------------------------</span>
<a href="#l7.103"></a><span id="l7.103"> </span>
<a href="#l7.104"></a><span id="l7.104"> tests.push({</span>
<a href="#l7.105"></a><span id="l7.105">   description: &quot;Import from bookmarks.html, but don't create smart bookmarks if autoExportHTML is true and they are at latest version&quot;,</span>
<a href="#l7.106"></a><span id="l7.106">   exec: function() {</span>
<a href="#l7.107"></a><span id="l7.107">     // Sanity check: we should not have any bookmark on the toolbar.</span>
<a href="#l7.108"></a><span id="l7.108">     do_check_eq(bs.getIdForItemAt(bs.toolbarFolder, 0), -1);</span>
<a href="#l7.109"></a><span id="l7.109">     // Set preferences.</span>
<a href="#l7.110"></a><span id="l7.110">     Services.prefs.setIntPref(PREF_SMART_BOOKMARKS_VERSION, 999);</span>
<a href="#l7.111"></a><span id="l7.111">     Services.prefs.setBoolPref(PREF_AUTO_EXPORT_HTML, true);</span>
<a href="#l7.112"></a><span id="l7.112">     Services.prefs.setBoolPref(PREF_IMPORT_BOOKMARKS_HTML, true);</span>
<a href="#l7.113"></a><span id="l7.113"> </span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+    waitForImportAndSmartBookmarks(function () {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+      // Check bookmarks.html has been imported, but smart bookmarks have not</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+      // been created.</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+      let itemId = bs.getIdForItemAt(bs.toolbarFolder, 0);</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+      do_check_eq(bs.getItemTitle(itemId), &quot;example&quot;);</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+      do_check_false(Services.prefs.getBoolPref(PREF_IMPORT_BOOKMARKS_HTML));</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+      // Check preferences have been reverted.</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+      Services.prefs.setBoolPref(PREF_AUTO_EXPORT_HTML, false);</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+      next_test();</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+    });</span>
<a href="#l7.125"></a><span id="l7.125">     // Force nsSuiteGlue::_initPlaces()</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-    print(&quot;Simulate Places init&quot;);</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+    do_log_info(&quot;Simulate Places init&quot;);</span>
<a href="#l7.128"></a><span id="l7.128">     bg.QueryInterface(Ci.nsIObserver).observe(null,</span>
<a href="#l7.129"></a><span id="l7.129">                                               PlacesUtils.TOPIC_INIT_COMPLETE,</span>
<a href="#l7.130"></a><span id="l7.130">                                               null);</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-    // Check bookmarks.html has been imported, but smart bookmarks have not</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-    // been created.</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-    let itemId = bs.getIdForItemAt(bs.toolbarFolder, 0);</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-    do_check_eq(bs.getItemTitle(itemId), &quot;example&quot;);</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-    do_check_false(Services.prefs.getBoolPref(PREF_IMPORT_BOOKMARKS_HTML));</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-    // Check preferences have been reverted.</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-    Services.prefs.setBoolPref(PREF_AUTO_EXPORT_HTML, false);</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-    next_test();</span>
<a href="#l7.140"></a><span id="l7.140">   }</span>
<a href="#l7.141"></a><span id="l7.141"> });</span>
<a href="#l7.142"></a><span id="l7.142"> </span>
<a href="#l7.143"></a><span id="l7.143"> //------------------------------------------------------------------------------</span>
<a href="#l7.144"></a><span id="l7.144"> </span>
<a href="#l7.145"></a><span id="l7.145"> tests.push({</span>
<a href="#l7.146"></a><span id="l7.146">   description: &quot;Import from bookmarks.html, and create smart bookmarks if autoExportHTML is true and they are not at latest version.&quot;,</span>
<a href="#l7.147"></a><span id="l7.147">   exec: function() {</span>
<a href="#l7.148"></a><span id="l7.148">     // Sanity check: we should not have any bookmark on the toolbar.</span>
<a href="#l7.149"></a><span id="l7.149">     do_check_eq(bs.getIdForItemAt(bs.toolbarFolder, 0), -1);</span>
<a href="#l7.150"></a><span id="l7.150">     // Set preferences.</span>
<a href="#l7.151"></a><span id="l7.151">     Services.prefs.setIntPref(PREF_SMART_BOOKMARKS_VERSION, 0);</span>
<a href="#l7.152"></a><span id="l7.152">     Services.prefs.setBoolPref(PREF_AUTO_EXPORT_HTML, true);</span>
<a href="#l7.153"></a><span id="l7.153">     Services.prefs.setBoolPref(PREF_IMPORT_BOOKMARKS_HTML, true);</span>
<a href="#l7.154"></a><span id="l7.154"> </span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+    waitForImportAndSmartBookmarks(function () {</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+      // Check bookmarks.html has been imported, but smart bookmarks have not</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+      // been created.</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+      let itemId = bs.getIdForItemAt(bs.toolbarFolder, SMART_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+      do_check_eq(bs.getItemTitle(itemId), &quot;example&quot;);</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+      do_check_false(Services.prefs.getBoolPref(PREF_IMPORT_BOOKMARKS_HTML));</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+      // Check preferences have been reverted.</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+      Services.prefs.setBoolPref(PREF_AUTO_EXPORT_HTML, false);</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+      next_test();</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+    });</span>
<a href="#l7.166"></a><span id="l7.166">     // Force nsSuiteGlue::_initPlaces()</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-    print(&quot;Simulate Places init&quot;);</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+    do_log_info(&quot;Simulate Places init&quot;);</span>
<a href="#l7.169"></a><span id="l7.169">     bg.QueryInterface(Ci.nsIObserver).observe(null,</span>
<a href="#l7.170"></a><span id="l7.170">                                               PlacesUtils.TOPIC_INIT_COMPLETE,</span>
<a href="#l7.171"></a><span id="l7.171">                                               null);</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-    // Check bookmarks.html has been imported, but smart bookmarks have not</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-    // been created.</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-    let itemId = bs.getIdForItemAt(bs.toolbarFolder, SMART_BOOKMARKS_ON_TOOLBAR);</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-    do_check_eq(bs.getItemTitle(itemId), &quot;example&quot;);</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-    do_check_false(Services.prefs.getBoolPref(PREF_IMPORT_BOOKMARKS_HTML));</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-    // Check preferences have been reverted.</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-    Services.prefs.setBoolPref(PREF_AUTO_EXPORT_HTML, false);</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-    next_test();</span>
<a href="#l7.181"></a><span id="l7.181">   }</span>
<a href="#l7.182"></a><span id="l7.182"> });</span>
<a href="#l7.183"></a><span id="l7.183"> </span>
<a href="#l7.184"></a><span id="l7.184"> //------------------------------------------------------------------------------</span>
<a href="#l7.185"></a><span id="l7.185"> tests.push({</span>
<a href="#l7.186"></a><span id="l7.186">   description: &quot;restore from default bookmarks.html if restore_default_bookmarks is true.&quot;,</span>
<a href="#l7.187"></a><span id="l7.187">   exec: function() {</span>
<a href="#l7.188"></a><span id="l7.188">     // Sanity check: we should not have any bookmark on the toolbar.</span>
<a href="#l7.189"></a><span id="l7.189">     do_check_eq(bs.getIdForItemAt(bs.toolbarFolder, 0), -1);</span>
<a href="#l7.190"></a><span id="l7.190">     // Set preferences.</span>
<a href="#l7.191"></a><span id="l7.191">     Services.prefs.setBoolPref(PREF_RESTORE_DEFAULT_BOOKMARKS, true);</span>
<a href="#l7.192"></a><span id="l7.192"> </span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+    waitForImportAndSmartBookmarks(function () {</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+      // Check bookmarks.html has been restored.</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+      let itemId = bs.getIdForItemAt(bs.toolbarFolder, SMART_BOOKMARKS_ON_TOOLBAR + 1);</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+      do_check_true(itemId &gt; 0);</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+      // Check preferences have been reverted.</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+      do_check_false(Services.prefs.getBoolPref(PREF_RESTORE_DEFAULT_BOOKMARKS));</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+      next_test();</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+    });</span>
<a href="#l7.202"></a><span id="l7.202">     // Force nsSuiteGlue::_initPlaces()</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineminus">-    print(&quot;Simulate Places init&quot;);</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+    do_log_info(&quot;Simulate Places init&quot;);</span>
<a href="#l7.205"></a><span id="l7.205">     bg.QueryInterface(Ci.nsIObserver).observe(null,</span>
<a href="#l7.206"></a><span id="l7.206">                                               PlacesUtils.TOPIC_INIT_COMPLETE,</span>
<a href="#l7.207"></a><span id="l7.207">                                               null);</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">-    // Check bookmarks.html has been restored.</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-    let itemId = bs.getIdForItemAt(bs.toolbarFolder, SMART_BOOKMARKS_ON_TOOLBAR + 1);</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-    do_check_true(itemId &gt; 0);</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-    // Check preferences have been reverted.</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-    do_check_false(Services.prefs.getBoolPref(PREF_RESTORE_DEFAULT_BOOKMARKS));</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-    next_test();</span>
<a href="#l7.215"></a><span id="l7.215">   }</span>
<a href="#l7.216"></a><span id="l7.216"> });</span>
<a href="#l7.217"></a><span id="l7.217"> </span>
<a href="#l7.218"></a><span id="l7.218"> //------------------------------------------------------------------------------</span>
<a href="#l7.219"></a><span id="l7.219"> </span>
<a href="#l7.220"></a><span id="l7.220"> tests.push({</span>
<a href="#l7.221"></a><span id="l7.221">   description: &quot;setting both importBookmarksHTML and restore_default_bookmarks should restore defaults.&quot;,</span>
<a href="#l7.222"></a><span id="l7.222">   exec: function() {</span>
<a href="#l7.223"></a><span id="l7.223">     // Sanity check: we should not have any bookmark on the toolbar.</span>
<a href="#l7.224"></a><span id="l7.224">     do_check_eq(bs.getIdForItemAt(bs.toolbarFolder, 0), -1);</span>
<a href="#l7.225"></a><span id="l7.225">     // Set preferences.</span>
<a href="#l7.226"></a><span id="l7.226">     Services.prefs.setBoolPref(PREF_IMPORT_BOOKMARKS_HTML, true);</span>
<a href="#l7.227"></a><span id="l7.227">     Services.prefs.setBoolPref(PREF_RESTORE_DEFAULT_BOOKMARKS, true);</span>
<a href="#l7.228"></a><span id="l7.228"> </span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+    waitForImportAndSmartBookmarks(function () {</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+      // Check bookmarks.html has been restored.</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+      let itemId = bs.getIdForItemAt(bs.toolbarFolder, SMART_BOOKMARKS_ON_TOOLBAR + 1);</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+      do_check_true(itemId &gt; 0);</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+      // Check preferences have been reverted.</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+      do_check_false(Services.prefs.getBoolPref(PREF_RESTORE_DEFAULT_BOOKMARKS));</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+      do_check_false(Services.prefs.getBoolPref(PREF_IMPORT_BOOKMARKS_HTML));</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+      do_test_finished();</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+    });</span>
<a href="#l7.239"></a><span id="l7.239">     // Force nsSuiteGlue::_initPlaces()</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-    print(&quot;Simulate Places init&quot;);</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+    do_log_info(&quot;Simulate Places init&quot;);</span>
<a href="#l7.242"></a><span id="l7.242">     bg.QueryInterface(Ci.nsIObserver).observe(null,</span>
<a href="#l7.243"></a><span id="l7.243">                                               PlacesUtils.TOPIC_INIT_COMPLETE,</span>
<a href="#l7.244"></a><span id="l7.244">                                               null);</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineminus">-    // Check bookmarks.html has been restored.</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-    let itemId = bs.getIdForItemAt(bs.toolbarFolder, SMART_BOOKMARKS_ON_TOOLBAR + 1);</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineminus">-    do_check_true(itemId &gt; 0);</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-    // Check preferences have been reverted.</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-    do_check_false(Services.prefs.getBoolPref(PREF_RESTORE_DEFAULT_BOOKMARKS));</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-    do_check_false(Services.prefs.getBoolPref(PREF_IMPORT_BOOKMARKS_HTML));</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-    do_test_finished();</span>
<a href="#l7.253"></a><span id="l7.253">   }</span>
<a href="#l7.254"></a><span id="l7.254"> });</span>
<a href="#l7.255"></a><span id="l7.255"> </span>
<a href="#l7.256"></a><span id="l7.256"> //------------------------------------------------------------------------------</span>
<a href="#l7.257"></a><span id="l7.257"> </span>
<a href="#l7.258"></a><span id="l7.258"> function finish_test() {</span>
<a href="#l7.259"></a><span id="l7.259">   // Clean up database from all bookmarks.</span>
<a href="#l7.260"></a><span id="l7.260">   remove_all_bookmarks();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/suite/common/places/tests/unit/test_browserGlue_smartBookmarks.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/suite/common/places/tests/unit/test_browserGlue_smartBookmarks.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -279,11 +279,20 @@ function run_test() {</span>
<a href="#l8.4"></a><span id="l8.4">     // do_throw(&quot;importBookmarksHTML pref should not exist&quot;);</span>
<a href="#l8.5"></a><span id="l8.5">   }</span>
<a href="#l8.6"></a><span id="l8.6">   catch(ex) {}</span>
<a href="#l8.7"></a><span id="l8.7">   try {</span>
<a href="#l8.8"></a><span id="l8.8">     do_check_false(Services.prefs.getBoolPref(PREF_RESTORE_DEFAULT_BOOKMARKS));</span>
<a href="#l8.9"></a><span id="l8.9">   }</span>
<a href="#l8.10"></a><span id="l8.10">   catch(ex) {}</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  // Kick-off tests.</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-  next_test();</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+  waitForImportAndSmartBookmarks(next_test);</span>
<a href="#l8.15"></a><span id="l8.15"> }</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+function waitForImportAndSmartBookmarks(aCallback) {</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+  Services.obs.addObserver(function waitImport() {</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+    Services.obs.removeObserver(waitImport, &quot;bookmarks-restore-success&quot;);</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+    // Delay to test eventual smart bookmarks creation.</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+    do_execute_soon(function () {</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+      waitForAsyncUpdates(aCallback);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+    });</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+  }, &quot;bookmarks-restore-success&quot;, false);</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/suite/common/places/tests/unit/test_clearHistory_shutdown.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/suite/common/places/tests/unit/test_clearHistory_shutdown.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -105,17 +105,19 @@ let notificationsObserver = {</span>
<a href="#l9.4"></a><span id="l9.4"> }</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> let timeInMicroseconds = Date.now() * 1000;</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> function run_test() {</span>
<a href="#l9.9"></a><span id="l9.9">   do_test_pending();</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11">   print(&quot;Initialize suiteglue before Places&quot;);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  Cc[&quot;@mozilla.org/suite/suiteglue;1&quot;].getService(Ci.nsISuiteGlue);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  // Avoid default bookmarks import.</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  Cc[&quot;@mozilla.org/suite/suiteglue;1&quot;].getService(Ci.nsIObserver)</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+    .observe(null, &quot;initial-migration&quot;, null);</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17">   Services.prefs.setBoolPref(&quot;privacy.item.history&quot;, true);</span>
<a href="#l9.18"></a><span id="l9.18">   Services.prefs.setBoolPref(&quot;privacy.item.urlbar&quot;, true);</span>
<a href="#l9.19"></a><span id="l9.19">   Services.prefs.setBoolPref(&quot;privacy.item.formdata&quot;, true);</span>
<a href="#l9.20"></a><span id="l9.20">   Services.prefs.setBoolPref(&quot;privacy.item.passwords&quot;, true);</span>
<a href="#l9.21"></a><span id="l9.21">   Services.prefs.setBoolPref(&quot;privacy.item.downloads&quot;, true);</span>
<a href="#l9.22"></a><span id="l9.22">   Services.prefs.setBoolPref(&quot;privacy.item.cookies&quot;, true);</span>
<a href="#l9.23"></a><span id="l9.23">   Services.prefs.setBoolPref(&quot;privacy.item.cache&quot;, true);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

