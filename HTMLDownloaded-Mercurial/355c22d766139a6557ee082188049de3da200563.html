<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 9725:355c22d766139a6557ee082188049de3da200563</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 355c22d766139a6557ee082188049de3da200563" />
<meta property="og:url" content="/comm-central/rev/355c22d766139a6557ee082188049de3da200563" />
<meta property="og:description" content="Bug 730147 - Style fixes in mailnews/import code. r=dbienvenu" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 355c22d766139a6557ee082188049de3da200563 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/355c22d766139a6557ee082188049de3da200563">shortlog</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/355c22d766139a6557ee082188049de3da200563">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563">files</a> |
changeset |
<a href="/comm-central/raw-rev/355c22d766139a6557ee082188049de3da200563">raw</a>  | <a href="/comm-central/archive/355c22d766139a6557ee082188049de3da200563.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=730147">Bug 730147</a> - Style fixes in mailnews/import code. r=dbienvenu
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#72;&#105;&#114;&#111;&#121;&#117;&#107;&#105;&#32;&#73;&#107;&#101;&#122;&#111;&#101;&#32;&#60;&#104;&#105;&#105;&#107;&#101;&#122;&#111;&#101;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#45;&#106;&#97;&#112;&#97;&#110;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 24 Mar 2012 17:56:17 -0400</td></tr>

<tr>
 <td>changeset 9725</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/355c22d766139a6557ee082188049de3da200563">355c22d766139a6557ee082188049de3da200563</a></td>
</tr>



<tr>
<td>parent 9724</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8068bfc36b520477f0b095c1141bd34d37ac5921">8068bfc36b520477f0b095c1141bd34d37ac5921</a>
</td>
</tr>

<tr>
<td>child 9726</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9890feabdc74baf90e499ad7295a67a6f3701f6a">9890feabdc74baf90e499ad7295a67a6f3701f6a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=355c22d766139a6557ee082188049de3da200563">7434</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 24 Mar 2012 21:56:44 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@2e5685540793 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2e56855407931796a3af2aecc49c274a51e8d6b6">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2e56855407931796a3af2aecc49c274a51e8d6b6&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2e56855407931796a3af2aecc49c274a51e8d6b6&newProject=comm-central&newRevision=355c22d766139a6557ee082188049de3da200563&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2e56855407931796a3af2aecc49c274a51e8d6b6&newProject=comm-central&newRevision=355c22d766139a6557ee082188049de3da200563&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2e56855407931796a3af2aecc49c274a51e8d6b6&newProject=comm-central&newRevision=355c22d766139a6557ee082188049de3da200563&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28dbienvenu%29&revcount=50">dbienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=730147">730147</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=730147">Bug 730147</a> - Style fixes in mailnews/import code. r=dbienvenu</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraAddress.cpp">mailnews/import/eudora/src/nsEudoraAddress.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraAddress.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraAddress.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraAddress.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraAddress.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraAddress.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraAddress.h">mailnews/import/eudora/src/nsEudoraAddress.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraAddress.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraAddress.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraAddress.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraAddress.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraAddress.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraCompose.cpp">mailnews/import/eudora/src/nsEudoraCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraCompose.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraCompose.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraCompose.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraCompose.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraCompose.h">mailnews/import/eudora/src/nsEudoraCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraCompose.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraCompose.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraCompose.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraCompose.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraCompose.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraEditor.cpp">mailnews/import/eudora/src/nsEudoraEditor.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraEditor.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraEditor.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraEditor.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraEditor.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraEditor.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraFilters.cpp">mailnews/import/eudora/src/nsEudoraFilters.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraFilters.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraFilters.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraFilters.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraFilters.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraFilters.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraImport.cpp">mailnews/import/eudora/src/nsEudoraImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraImport.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraImport.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraImport.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraImport.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMac.cpp">mailnews/import/eudora/src/nsEudoraMac.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMac.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMac.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMac.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMac.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMac.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMac.h">mailnews/import/eudora/src/nsEudoraMac.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMac.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMac.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMac.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMac.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMac.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMailbox.cpp">mailnews/import/eudora/src/nsEudoraMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMailbox.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMailbox.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMailbox.h">mailnews/import/eudora/src/nsEudoraMailbox.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMailbox.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMailbox.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMailbox.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMailbox.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraMailbox.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraSettings.cpp">mailnews/import/eudora/src/nsEudoraSettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraSettings.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraSettings.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraSettings.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraSettings.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraSettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraStringBundle.cpp">mailnews/import/eudora/src/nsEudoraStringBundle.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraStringBundle.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraStringBundle.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraStringBundle.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraStringBundle.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraStringBundle.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraStringBundle.h">mailnews/import/eudora/src/nsEudoraStringBundle.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraStringBundle.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraStringBundle.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraStringBundle.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraStringBundle.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraStringBundle.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraWin32.cpp">mailnews/import/eudora/src/nsEudoraWin32.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraWin32.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraWin32.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraWin32.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraWin32.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraWin32.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraWin32.h">mailnews/import/eudora/src/nsEudoraWin32.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraWin32.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraWin32.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraWin32.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraWin32.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/eudora/src/nsEudoraWin32.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/WabObject.cpp">mailnews/import/oexpress/WabObject.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/WabObject.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/WabObject.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/WabObject.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/WabObject.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/WabObject.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/WabObject.h">mailnews/import/oexpress/WabObject.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/WabObject.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/WabObject.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/WabObject.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/WabObject.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/WabObject.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOE5File.cpp">mailnews/import/oexpress/nsOE5File.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOE5File.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOE5File.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOE5File.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOE5File.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOE5File.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOE5File.h">mailnews/import/oexpress/nsOE5File.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOE5File.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOE5File.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOE5File.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOE5File.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOE5File.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEAddressIterator.cpp">mailnews/import/oexpress/nsOEAddressIterator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEAddressIterator.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEAddressIterator.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEAddressIterator.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEAddressIterator.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEAddressIterator.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEAddressIterator.h">mailnews/import/oexpress/nsOEAddressIterator.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEAddressIterator.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEAddressIterator.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEAddressIterator.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEAddressIterator.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEAddressIterator.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEImport.cpp">mailnews/import/oexpress/nsOEImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEImport.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEImport.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEImport.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEImport.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEMailbox.cpp">mailnews/import/oexpress/nsOEMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEMailbox.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEMailbox.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEMailbox.h">mailnews/import/oexpress/nsOEMailbox.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEMailbox.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEMailbox.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEMailbox.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEMailbox.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEMailbox.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOERegUtil.cpp">mailnews/import/oexpress/nsOERegUtil.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOERegUtil.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOERegUtil.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOERegUtil.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOERegUtil.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOERegUtil.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOERegUtil.h">mailnews/import/oexpress/nsOERegUtil.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOERegUtil.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOERegUtil.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOERegUtil.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOERegUtil.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOERegUtil.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEScanBoxes.cpp">mailnews/import/oexpress/nsOEScanBoxes.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEScanBoxes.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEScanBoxes.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEScanBoxes.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEScanBoxes.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEScanBoxes.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEScanBoxes.h">mailnews/import/oexpress/nsOEScanBoxes.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEScanBoxes.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEScanBoxes.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEScanBoxes.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEScanBoxes.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEScanBoxes.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOESettings.cpp">mailnews/import/oexpress/nsOESettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOESettings.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOESettings.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOESettings.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOESettings.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOESettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEStringBundle.cpp">mailnews/import/oexpress/nsOEStringBundle.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEStringBundle.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEStringBundle.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEStringBundle.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEStringBundle.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEStringBundle.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEStringBundle.h">mailnews/import/oexpress/nsOEStringBundle.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEStringBundle.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEStringBundle.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEStringBundle.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEStringBundle.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/oexpress/nsOEStringBundle.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiApi.cpp">mailnews/import/outlook/src/MapiApi.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiApi.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiApi.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiApi.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiApi.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiApi.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiApi.h">mailnews/import/outlook/src/MapiApi.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiApi.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiApi.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiApi.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiApi.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiApi.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiDbgLog.h">mailnews/import/outlook/src/MapiDbgLog.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiDbgLog.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiDbgLog.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiDbgLog.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiDbgLog.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiDbgLog.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMessage.cpp">mailnews/import/outlook/src/MapiMessage.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMessage.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMessage.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMessage.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMessage.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMessage.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMessage.h">mailnews/import/outlook/src/MapiMessage.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMessage.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMessage.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMessage.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMessage.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMessage.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMimeTypes.cpp">mailnews/import/outlook/src/MapiMimeTypes.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMimeTypes.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMimeTypes.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMimeTypes.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMimeTypes.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMimeTypes.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMimeTypes.h">mailnews/import/outlook/src/MapiMimeTypes.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMimeTypes.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMimeTypes.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMimeTypes.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMimeTypes.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/MapiMimeTypes.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookCompose.cpp">mailnews/import/outlook/src/nsOutlookCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookCompose.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookCompose.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookCompose.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookCompose.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookCompose.h">mailnews/import/outlook/src/nsOutlookCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookCompose.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookCompose.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookCompose.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookCompose.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookCompose.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookImport.cpp">mailnews/import/outlook/src/nsOutlookImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookImport.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookImport.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookImport.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookImport.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookMail.cpp">mailnews/import/outlook/src/nsOutlookMail.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookMail.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookMail.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookMail.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookMail.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookMail.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookMail.h">mailnews/import/outlook/src/nsOutlookMail.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookMail.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookMail.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookMail.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookMail.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookMail.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookRegUtil.cpp">mailnews/import/outlook/src/nsOutlookRegUtil.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookRegUtil.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookRegUtil.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookRegUtil.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookRegUtil.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookRegUtil.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookRegUtil.h">mailnews/import/outlook/src/nsOutlookRegUtil.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookRegUtil.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookRegUtil.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookRegUtil.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookRegUtil.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookRegUtil.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookSettings.cpp">mailnews/import/outlook/src/nsOutlookSettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookSettings.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookSettings.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookSettings.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookSettings.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookSettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">mailnews/import/outlook/src/nsOutlookStringBundle.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookStringBundle.h">mailnews/import/outlook/src/nsOutlookStringBundle.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookStringBundle.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookStringBundle.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookStringBundle.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookStringBundle.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/outlook/src/nsOutlookStringBundle.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportCharSet.h">mailnews/import/src/ImportCharSet.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportCharSet.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportCharSet.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportCharSet.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportCharSet.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportCharSet.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportOutFile.cpp">mailnews/import/src/ImportOutFile.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportOutFile.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportOutFile.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportOutFile.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportOutFile.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportOutFile.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportOutFile.h">mailnews/import/src/ImportOutFile.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportOutFile.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportOutFile.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportOutFile.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportOutFile.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportOutFile.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportTranslate.cpp">mailnews/import/src/ImportTranslate.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportTranslate.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportTranslate.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportTranslate.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportTranslate.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportTranslate.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportTranslate.h">mailnews/import/src/ImportTranslate.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportTranslate.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportTranslate.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportTranslate.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportTranslate.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/ImportTranslate.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportABDescriptor.cpp">mailnews/import/src/nsImportABDescriptor.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportABDescriptor.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportABDescriptor.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportABDescriptor.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportABDescriptor.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportABDescriptor.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportABDescriptor.h">mailnews/import/src/nsImportABDescriptor.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportABDescriptor.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportABDescriptor.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportABDescriptor.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportABDescriptor.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportABDescriptor.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportAddressBooks.cpp">mailnews/import/src/nsImportAddressBooks.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportAddressBooks.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportAddressBooks.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportAddressBooks.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportAddressBooks.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportAddressBooks.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportEncodeScan.cpp">mailnews/import/src/nsImportEncodeScan.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportEncodeScan.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportEncodeScan.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportEncodeScan.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportEncodeScan.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportEncodeScan.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportEncodeScan.h">mailnews/import/src/nsImportEncodeScan.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportEncodeScan.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportEncodeScan.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportEncodeScan.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportEncodeScan.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportEncodeScan.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportFieldMap.cpp">mailnews/import/src/nsImportFieldMap.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportFieldMap.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportFieldMap.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportFieldMap.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportFieldMap.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportFieldMap.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportFieldMap.h">mailnews/import/src/nsImportFieldMap.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportFieldMap.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportFieldMap.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportFieldMap.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportFieldMap.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportFieldMap.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMail.cpp">mailnews/import/src/nsImportMail.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMail.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMail.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMail.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMail.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMail.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMailboxDescriptor.cpp">mailnews/import/src/nsImportMailboxDescriptor.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMailboxDescriptor.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMailboxDescriptor.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMailboxDescriptor.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMailboxDescriptor.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMailboxDescriptor.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMailboxDescriptor.h">mailnews/import/src/nsImportMailboxDescriptor.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMailboxDescriptor.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMailboxDescriptor.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMailboxDescriptor.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMailboxDescriptor.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMailboxDescriptor.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMimeEncode.cpp">mailnews/import/src/nsImportMimeEncode.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMimeEncode.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMimeEncode.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMimeEncode.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMimeEncode.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMimeEncode.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMimeEncode.h">mailnews/import/src/nsImportMimeEncode.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMimeEncode.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMimeEncode.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMimeEncode.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMimeEncode.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportMimeEncode.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportScanFile.cpp">mailnews/import/src/nsImportScanFile.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportScanFile.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportScanFile.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportScanFile.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportScanFile.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportScanFile.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportScanFile.h">mailnews/import/src/nsImportScanFile.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportScanFile.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportScanFile.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportScanFile.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportScanFile.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportScanFile.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportService.cpp">mailnews/import/src/nsImportService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportService.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportService.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportService.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportService.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportService.h">mailnews/import/src/nsImportService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportService.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportService.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportService.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportService.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportStringBundle.cpp">mailnews/import/src/nsImportStringBundle.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportStringBundle.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportStringBundle.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportStringBundle.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportStringBundle.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportStringBundle.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportTranslator.cpp">mailnews/import/src/nsImportTranslator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportTranslator.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportTranslator.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportTranslator.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportTranslator.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportTranslator.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportTranslator.h">mailnews/import/src/nsImportTranslator.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportTranslator.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportTranslator.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportTranslator.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportTranslator.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/src/nsImportTranslator.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextAddress.cpp">mailnews/import/text/src/nsTextAddress.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextAddress.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextAddress.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextAddress.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextAddress.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextAddress.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextAddress.h">mailnews/import/text/src/nsTextAddress.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextAddress.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextAddress.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextAddress.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextAddress.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextAddress.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextImport.cpp">mailnews/import/text/src/nsTextImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextImport.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextImport.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextImport.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextImport.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/text/src/nsTextImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/vcard/src/nsVCardImport.cpp">mailnews/import/vcard/src/nsVCardImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/vcard/src/nsVCardImport.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/vcard/src/nsVCardImport.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/vcard/src/nsVCardImport.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/vcard/src/nsVCardImport.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/vcard/src/nsVCardImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMImport.cpp">mailnews/import/winlivemail/nsWMImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMImport.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMImport.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMImport.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMImport.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMSettings.cpp">mailnews/import/winlivemail/nsWMSettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMSettings.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMSettings.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMSettings.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMSettings.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMSettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMStringBundle.cpp">mailnews/import/winlivemail/nsWMStringBundle.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMStringBundle.cpp">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMStringBundle.cpp">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMStringBundle.cpp">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMStringBundle.cpp">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMStringBundle.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMStringBundle.h">mailnews/import/winlivemail/nsWMStringBundle.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMStringBundle.h">file</a> |
<a href="/comm-central/annotate/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMStringBundle.h">annotate</a> |
<a href="/comm-central/diff/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMStringBundle.h">diff</a> |
<a href="/comm-central/comparison/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMStringBundle.h">comparison</a> |
<a href="/comm-central/log/355c22d766139a6557ee082188049de3da200563/mailnews/import/winlivemail/nsWMStringBundle.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraAddress.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraAddress.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -64,42 +64,42 @@</span>
<a href="#l1.4"></a><span id="l1.4">   }</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> // If we get a line longer than 16K it's just toooooo bad!</span>
<a href="#l1.8"></a><span id="l1.8"> #define kEudoraAddressBufferSz  (16 * 1024)</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> #ifdef IMPORT_DEBUG</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-void DumpAliasArray( nsVoidArray&amp; a);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+void DumpAliasArray(nsVoidArray&amp; a);</span>
<a href="#l1.14"></a><span id="l1.14"> #endif</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> class CAliasData {</span>
<a href="#l1.17"></a><span id="l1.17"> public:</span>
<a href="#l1.18"></a><span id="l1.18">   CAliasData() {}</span>
<a href="#l1.19"></a><span id="l1.19">   ~CAliasData() {}</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-  bool Process( const char *pLine, PRInt32 len);</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+  bool Process(const char *pLine, PRInt32 len);</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24"> public:</span>
<a href="#l1.25"></a><span id="l1.25">     nsCString   m_fullEntry;</span>
<a href="#l1.26"></a><span id="l1.26">     nsCString   m_nickName;</span>
<a href="#l1.27"></a><span id="l1.27">     nsCString   m_realName;</span>
<a href="#l1.28"></a><span id="l1.28">     nsCString   m_email;</span>
<a href="#l1.29"></a><span id="l1.29"> };</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31"> class CAliasEntry {</span>
<a href="#l1.32"></a><span id="l1.32"> public:</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-  CAliasEntry( nsCString&amp; name) { m_name = name;}</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+  CAliasEntry(nsCString&amp; name) { m_name = name;}</span>
<a href="#l1.35"></a><span id="l1.35">   ~CAliasEntry() { EmptyList();}</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-  void EmptyList( void) {</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+  void EmptyList(void) {</span>
<a href="#l1.39"></a><span id="l1.39">     CAliasData *pData;</span>
<a href="#l1.40"></a><span id="l1.40">     for (PRInt32 i = 0; i &lt; m_list.Count(); i++) {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-      pData = (CAliasData *)m_list.ElementAt( i);</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+      pData = (CAliasData *)m_list.ElementAt(i);</span>
<a href="#l1.43"></a><span id="l1.43">       delete pData;</span>
<a href="#l1.44"></a><span id="l1.44">     }</span>
<a href="#l1.45"></a><span id="l1.45">     m_list.Clear();</span>
<a href="#l1.46"></a><span id="l1.46">   }</span>
<a href="#l1.47"></a><span id="l1.47"> </span>
<a href="#l1.48"></a><span id="l1.48"> public:</span>
<a href="#l1.49"></a><span id="l1.49">   nsCString  m_name;</span>
<a href="#l1.50"></a><span id="l1.50">   nsVoidArray  m_list;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineat">@@ -111,136 +111,135 @@ nsEudoraAddress::nsEudoraAddress()</span>
<a href="#l1.52"></a><span id="l1.52"> }</span>
<a href="#l1.53"></a><span id="l1.53"> </span>
<a href="#l1.54"></a><span id="l1.54"> nsEudoraAddress::~nsEudoraAddress()</span>
<a href="#l1.55"></a><span id="l1.55"> {</span>
<a href="#l1.56"></a><span id="l1.56">   EmptyAliases();</span>
<a href="#l1.57"></a><span id="l1.57"> }</span>
<a href="#l1.58"></a><span id="l1.58"> </span>
<a href="#l1.59"></a><span id="l1.59"> </span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-nsresult nsEudoraAddress::ImportAddresses( PRUint32 *pBytes, bool *pAbort,</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+nsresult nsEudoraAddress::ImportAddresses(PRUint32 *pBytes, bool *pAbort,</span>
<a href="#l1.62"></a><span id="l1.62">                                           const PRUnichar *pName, nsIFile *pSrc,</span>
<a href="#l1.63"></a><span id="l1.63">                                           nsIAddrDatabase *pDb, nsString&amp; errors)</span>
<a href="#l1.64"></a><span id="l1.64"> {</span>
<a href="#l1.65"></a><span id="l1.65">   // Open the source file for reading, read each line and process it!</span>
<a href="#l1.66"></a><span id="l1.66"> </span>
<a href="#l1.67"></a><span id="l1.67">   EmptyAliases();</span>
<a href="#l1.68"></a><span id="l1.68">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l1.69"></a><span id="l1.69">   nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), pSrc);</span>
<a href="#l1.70"></a><span id="l1.70">   if (NS_FAILED(rv)) {</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error opening address file for reading\n&quot;);</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error opening address file for reading\n&quot;);</span>
<a href="#l1.73"></a><span id="l1.73">     return rv;</span>
<a href="#l1.74"></a><span id="l1.74">   }</span>
<a href="#l1.75"></a><span id="l1.75"> </span>
<a href="#l1.76"></a><span id="l1.76">   PRUint32 bytesLeft = 0;</span>
<a href="#l1.77"></a><span id="l1.77"> </span>
<a href="#l1.78"></a><span id="l1.78">   rv = inputStream-&gt;Available(&amp;bytesLeft);</span>
<a href="#l1.79"></a><span id="l1.79">   if (NS_FAILED(rv)) {</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error checking address file for eof\n&quot;);</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error checking address file for eof\n&quot;);</span>
<a href="#l1.82"></a><span id="l1.82">     inputStream-&gt;Close();</span>
<a href="#l1.83"></a><span id="l1.83">     return rv;</span>
<a href="#l1.84"></a><span id="l1.84">   }</span>
<a href="#l1.85"></a><span id="l1.85"> </span>
<a href="#l1.86"></a><span id="l1.86">   nsCOMPtr&lt;nsILineInputStream&gt; lineStream(do_QueryInterface(inputStream, &amp;rv));</span>
<a href="#l1.87"></a><span id="l1.87">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.88"></a><span id="l1.88"> </span>
<a href="#l1.89"></a><span id="l1.89">   bool more = true;</span>
<a href="#l1.90"></a><span id="l1.90"> </span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-  while ((!(*pAbort) &amp;&amp; more &amp;&amp; NS_SUCCEEDED( rv)))</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+  while ((!(*pAbort) &amp;&amp; more &amp;&amp; NS_SUCCEEDED(rv)))</span>
<a href="#l1.93"></a><span id="l1.93">   {</span>
<a href="#l1.94"></a><span id="l1.94">     nsCString line;</span>
<a href="#l1.95"></a><span id="l1.95">     rv = lineStream-&gt;ReadLine(line, &amp;more);</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-    if (NS_SUCCEEDED( rv))</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l1.98"></a><span id="l1.98">     {</span>
<a href="#l1.99"></a><span id="l1.99">       PRInt32  len = line.Length();</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-      ProcessLine( line.get(), len, errors);</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+      ProcessLine(line.get(), len, errors);</span>
<a href="#l1.102"></a><span id="l1.102">       if (pBytes)</span>
<a href="#l1.103"></a><span id="l1.103">         *pBytes += (len / 2);</span>
<a href="#l1.104"></a><span id="l1.104">     }</span>
<a href="#l1.105"></a><span id="l1.105">   }</span>
<a href="#l1.106"></a><span id="l1.106">   rv = inputStream-&gt;Close();</span>
<a href="#l1.107"></a><span id="l1.107"> </span>
<a href="#l1.108"></a><span id="l1.108">   if (more)</span>
<a href="#l1.109"></a><span id="l1.109">   {</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error reading the address book, didn't reach the end\n&quot;);</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error reading the address book, didn't reach the end\n&quot;);</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l1.114"></a><span id="l1.114">   }</span>
<a href="#l1.115"></a><span id="l1.115">   // Run through the alias array and make address book entries...</span>
<a href="#l1.116"></a><span id="l1.116"> #ifdef IMPORT_DEBUG</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-  DumpAliasArray( m_alias);</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+  DumpAliasArray(m_alias);</span>
<a href="#l1.119"></a><span id="l1.119"> #endif</span>
<a href="#l1.120"></a><span id="l1.120"> </span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-  BuildABCards( pBytes, pDb);</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+  BuildABCards(pBytes, pDb);</span>
<a href="#l1.123"></a><span id="l1.123"> </span>
<a href="#l1.124"></a><span id="l1.124">   return pDb-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l1.125"></a><span id="l1.125">   }</span>
<a href="#l1.126"></a><span id="l1.126"> </span>
<a href="#l1.127"></a><span id="l1.127"> </span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-PRInt32 nsEudoraAddress::CountWhiteSpace( const char *pLine, PRInt32 len)</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+PRInt32 nsEudoraAddress::CountWhiteSpace(const char *pLine, PRInt32 len)</span>
<a href="#l1.130"></a><span id="l1.130"> {</span>
<a href="#l1.131"></a><span id="l1.131">   PRInt32    cnt = 0;</span>
<a href="#l1.132"></a><span id="l1.132">   while (len &amp;&amp; ((*pLine == ' ') || (*pLine == '\t'))) {</span>
<a href="#l1.133"></a><span id="l1.133">     len--;</span>
<a href="#l1.134"></a><span id="l1.134">     pLine++;</span>
<a href="#l1.135"></a><span id="l1.135">     cnt++;</span>
<a href="#l1.136"></a><span id="l1.136">   }</span>
<a href="#l1.137"></a><span id="l1.137"> </span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-  return( cnt);</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+  return cnt;</span>
<a href="#l1.140"></a><span id="l1.140"> }</span>
<a href="#l1.141"></a><span id="l1.141"> </span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-void nsEudoraAddress::EmptyAliases( void)</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+void nsEudoraAddress::EmptyAliases(void)</span>
<a href="#l1.144"></a><span id="l1.144"> {</span>
<a href="#l1.145"></a><span id="l1.145">   CAliasEntry *pData;</span>
<a href="#l1.146"></a><span id="l1.146">   for (PRInt32 i = 0; i &lt; m_alias.Count(); i++) {</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-    pData = (CAliasEntry *)m_alias.ElementAt( i);</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+    pData = (CAliasEntry *)m_alias.ElementAt(i);</span>
<a href="#l1.149"></a><span id="l1.149">     delete pData;</span>
<a href="#l1.150"></a><span id="l1.150">   }</span>
<a href="#l1.151"></a><span id="l1.151">   m_alias.Clear();</span>
<a href="#l1.152"></a><span id="l1.152"> }</span>
<a href="#l1.153"></a><span id="l1.153"> </span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-void nsEudoraAddress::ProcessLine( const char *pLine, PRInt32 len, nsString&amp; errors)</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+void nsEudoraAddress::ProcessLine(const char *pLine, PRInt32 len, nsString&amp; errors)</span>
<a href="#l1.156"></a><span id="l1.156"> {</span>
<a href="#l1.157"></a><span id="l1.157">   if (len &lt; 6)</span>
<a href="#l1.158"></a><span id="l1.158">     return;</span>
<a href="#l1.159"></a><span id="l1.159"> </span>
<a href="#l1.160"></a><span id="l1.160">   PRInt32  cnt;</span>
<a href="#l1.161"></a><span id="l1.161">   CAliasEntry  *pEntry;</span>
<a href="#l1.162"></a><span id="l1.162"> </span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-  if (!strncmp( pLine, &quot;alias&quot;, 5)) {</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+  if (!strncmp(pLine, &quot;alias&quot;, 5)) {</span>
<a href="#l1.165"></a><span id="l1.165">     pLine += 5;</span>
<a href="#l1.166"></a><span id="l1.166">     len -= 5;</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-    cnt = CountWhiteSpace( pLine, len);</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+    cnt = CountWhiteSpace(pLine, len);</span>
<a href="#l1.169"></a><span id="l1.169">     if (cnt) {</span>
<a href="#l1.170"></a><span id="l1.170">       pLine += cnt;</span>
<a href="#l1.171"></a><span id="l1.171">       len -= cnt;</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-      if ((pEntry = ProcessAlias( pLine, len, errors)) != nsnull) {</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-        m_alias.AppendElement( pEntry);</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-      }</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+      if ((pEntry = ProcessAlias(pLine, len, errors)) != nsnull)</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+        m_alias.AppendElement(pEntry);</span>
<a href="#l1.177"></a><span id="l1.177">     }</span>
<a href="#l1.178"></a><span id="l1.178">   }</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-  else if (!strncmp( pLine, &quot;note&quot;, 4)) {</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+  else if (!strncmp(pLine, &quot;note&quot;, 4)) {</span>
<a href="#l1.181"></a><span id="l1.181">     pLine += 4;</span>
<a href="#l1.182"></a><span id="l1.182">     len -= 4;</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-    cnt = CountWhiteSpace( pLine, len);</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineplus">+    cnt = CountWhiteSpace(pLine, len);</span>
<a href="#l1.185"></a><span id="l1.185">     if (cnt) {</span>
<a href="#l1.186"></a><span id="l1.186">       pLine += cnt;</span>
<a href="#l1.187"></a><span id="l1.187">       len -= cnt;</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-      ProcessNote( pLine, len, errors);</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+      ProcessNote(pLine, len, errors);</span>
<a href="#l1.190"></a><span id="l1.190">     }</span>
<a href="#l1.191"></a><span id="l1.191">   }</span>
<a href="#l1.192"></a><span id="l1.192"> </span>
<a href="#l1.193"></a><span id="l1.193">   // as far as I know everything must be on one line</span>
<a href="#l1.194"></a><span id="l1.194">   // if not, then I need to add a state variable.</span>
<a href="#l1.195"></a><span id="l1.195"> }</span>
<a href="#l1.196"></a><span id="l1.196"> </span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-PRInt32 nsEudoraAddress::GetAliasName( const char *pLine, PRInt32 len, nsCString&amp; name)</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+PRInt32 nsEudoraAddress::GetAliasName(const char *pLine, PRInt32 len, nsCString&amp; name)</span>
<a href="#l1.199"></a><span id="l1.199"> {</span>
<a href="#l1.200"></a><span id="l1.200">   name.Truncate();</span>
<a href="#l1.201"></a><span id="l1.201">   if (!len)</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-    return( 0);</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+    return 0;</span>
<a href="#l1.204"></a><span id="l1.204">   const char *pStart = pLine;</span>
<a href="#l1.205"></a><span id="l1.205">   char  end[2] = {' ', '\t'};</span>
<a href="#l1.206"></a><span id="l1.206">   if (*pLine == '&quot;') {</span>
<a href="#l1.207"></a><span id="l1.207">     pLine++;</span>
<a href="#l1.208"></a><span id="l1.208">     pStart++;</span>
<a href="#l1.209"></a><span id="l1.209">     len--;</span>
<a href="#l1.210"></a><span id="l1.210">     end[0] = '&quot;';</span>
<a href="#l1.211"></a><span id="l1.211">     end[1] = 0;</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineat">@@ -251,209 +250,208 @@ PRInt32 nsEudoraAddress::GetAliasName( c</span>
<a href="#l1.213"></a><span id="l1.213">     if ((*pLine == end[0]) || (*pLine == end[1]))</span>
<a href="#l1.214"></a><span id="l1.214">       break;</span>
<a href="#l1.215"></a><span id="l1.215">     len--;</span>
<a href="#l1.216"></a><span id="l1.216">     pLine++;</span>
<a href="#l1.217"></a><span id="l1.217">     cnt++;</span>
<a href="#l1.218"></a><span id="l1.218">   }</span>
<a href="#l1.219"></a><span id="l1.219"> </span>
<a href="#l1.220"></a><span id="l1.220">   if (cnt)</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-    name.Append( pStart, cnt);</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+    name.Append(pStart, cnt);</span>
<a href="#l1.223"></a><span id="l1.223"> </span>
<a href="#l1.224"></a><span id="l1.224">   if (end[0] == '&quot;') {</span>
<a href="#l1.225"></a><span id="l1.225">     cnt++;</span>
<a href="#l1.226"></a><span id="l1.226">     if (len &amp;&amp; (*pLine == '&quot;')) {</span>
<a href="#l1.227"></a><span id="l1.227">       cnt++;</span>
<a href="#l1.228"></a><span id="l1.228">       pLine++;</span>
<a href="#l1.229"></a><span id="l1.229">       len--;</span>
<a href="#l1.230"></a><span id="l1.230">     }</span>
<a href="#l1.231"></a><span id="l1.231">   }</span>
<a href="#l1.232"></a><span id="l1.232"> </span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-  cnt += CountWhiteSpace( pLine, len);</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+  cnt += CountWhiteSpace(pLine, len);</span>
<a href="#l1.235"></a><span id="l1.235"> </span>
<a href="#l1.236"></a><span id="l1.236" class="difflineminus">-  return( cnt);</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineplus">+  return cnt;</span>
<a href="#l1.238"></a><span id="l1.238"> }</span>
<a href="#l1.239"></a><span id="l1.239"> </span>
<a href="#l1.240"></a><span id="l1.240"> </span>
<a href="#l1.241"></a><span id="l1.241" class="difflineminus">-CAliasEntry *nsEudoraAddress::ProcessAlias( const char *pLine, PRInt32 len, nsString&amp; errors)</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+CAliasEntry *nsEudoraAddress::ProcessAlias(const char *pLine, PRInt32 len, nsString&amp; errors)</span>
<a href="#l1.243"></a><span id="l1.243"> {</span>
<a href="#l1.244"></a><span id="l1.244">   nsCString  name;</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-  PRInt32    cnt = GetAliasName( pLine, len, name);</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+  PRInt32    cnt = GetAliasName(pLine, len, name);</span>
<a href="#l1.247"></a><span id="l1.247">   pLine += cnt;</span>
<a href="#l1.248"></a><span id="l1.248">   len -= cnt;</span>
<a href="#l1.249"></a><span id="l1.249"> </span>
<a href="#l1.250"></a><span id="l1.250">   // we have 3 known forms of addresses in Eudora</span>
<a href="#l1.251"></a><span id="l1.251">   // 1) real name &lt;email@address&gt;</span>
<a href="#l1.252"></a><span id="l1.252">   // 2) email@address</span>
<a href="#l1.253"></a><span id="l1.253">   // 3) &lt;email@address&gt;</span>
<a href="#l1.254"></a><span id="l1.254">   // 4) real name email@address</span>
<a href="#l1.255"></a><span id="l1.255">   // 5) &lt;email@address&gt; (Real name)</span>
<a href="#l1.256"></a><span id="l1.256"> </span>
<a href="#l1.257"></a><span id="l1.257" class="difflineminus">-  CAliasEntry *pEntry = new CAliasEntry( name);</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+  CAliasEntry *pEntry = new CAliasEntry(name);</span>
<a href="#l1.259"></a><span id="l1.259">   if (!cnt || !len)</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineminus">-    return(pEntry);</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+    return pEntry;</span>
<a href="#l1.262"></a><span id="l1.262"> </span>
<a href="#l1.263"></a><span id="l1.263">   // Theoretically, an alias is just an RFC822 email adress, but it may contain</span>
<a href="#l1.264"></a><span id="l1.264">   // an alias to another alias as the email!  I general, it appears close</span>
<a href="#l1.265"></a><span id="l1.265">   // but unfortunately not exact so we can't use the nsIMsgHeaderParser to do</span>
<a href="#l1.266"></a><span id="l1.266">   // the work for us!</span>
<a href="#l1.267"></a><span id="l1.267"> </span>
<a href="#l1.268"></a><span id="l1.268">   // Very big bummer!</span>
<a href="#l1.269"></a><span id="l1.269"> </span>
<a href="#l1.270"></a><span id="l1.270">   const char *pStart;</span>
<a href="#l1.271"></a><span id="l1.271">   PRInt32    tLen;</span>
<a href="#l1.272"></a><span id="l1.272">   nsCString  alias;</span>
<a href="#l1.273"></a><span id="l1.273"> </span>
<a href="#l1.274"></a><span id="l1.274" class="difflineminus">-  while ( len) {</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineplus">+  while (len) {</span>
<a href="#l1.276"></a><span id="l1.276">     pStart = pLine;</span>
<a href="#l1.277"></a><span id="l1.277">     cnt = 0;</span>
<a href="#l1.278"></a><span id="l1.278">     while (len &amp;&amp; (*pLine != ',')) {</span>
<a href="#l1.279"></a><span id="l1.279">       if (*pLine == '&quot;') {</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineminus">-        tLen = CountQuote( pLine, len);</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineplus">+        tLen = CountQuote(pLine, len);</span>
<a href="#l1.282"></a><span id="l1.282">         pLine += tLen;</span>
<a href="#l1.283"></a><span id="l1.283">         len -= tLen;</span>
<a href="#l1.284"></a><span id="l1.284">         cnt += tLen;</span>
<a href="#l1.285"></a><span id="l1.285">       }</span>
<a href="#l1.286"></a><span id="l1.286">       else if (*pLine == '(') {</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineminus">-        tLen = CountComment( pLine, len);</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineplus">+        tLen = CountComment(pLine, len);</span>
<a href="#l1.289"></a><span id="l1.289">         pLine += tLen;</span>
<a href="#l1.290"></a><span id="l1.290">         len -= tLen;</span>
<a href="#l1.291"></a><span id="l1.291">         cnt += tLen;</span>
<a href="#l1.292"></a><span id="l1.292">       }</span>
<a href="#l1.293"></a><span id="l1.293">       else if (*pLine == '&lt;') {</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineminus">-        tLen = CountAngle( pLine, len);</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+        tLen = CountAngle(pLine, len);</span>
<a href="#l1.296"></a><span id="l1.296">         pLine += tLen;</span>
<a href="#l1.297"></a><span id="l1.297">         len -= tLen;</span>
<a href="#l1.298"></a><span id="l1.298">         cnt += tLen;</span>
<a href="#l1.299"></a><span id="l1.299">       }</span>
<a href="#l1.300"></a><span id="l1.300">       else {</span>
<a href="#l1.301"></a><span id="l1.301">         cnt++;</span>
<a href="#l1.302"></a><span id="l1.302">         pLine++;</span>
<a href="#l1.303"></a><span id="l1.303">         len--;</span>
<a href="#l1.304"></a><span id="l1.304">       }</span>
<a href="#l1.305"></a><span id="l1.305">     }</span>
<a href="#l1.306"></a><span id="l1.306">     if (cnt) {</span>
<a href="#l1.307"></a><span id="l1.307">       CAliasData *pData = new CAliasData();</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineminus">-      if (pData-&gt;Process( pStart, cnt)) {</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineminus">-        pEntry-&gt;m_list.AppendElement( pData);</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineminus">-      }</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineplus">+      if (pData-&gt;Process(pStart, cnt))</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineplus">+        pEntry-&gt;m_list.AppendElement(pData);</span>
<a href="#l1.313"></a><span id="l1.313">       else</span>
<a href="#l1.314"></a><span id="l1.314">         delete pData;</span>
<a href="#l1.315"></a><span id="l1.315">     }</span>
<a href="#l1.316"></a><span id="l1.316"> </span>
<a href="#l1.317"></a><span id="l1.317">     if (len &amp;&amp; (*pLine == ',')) {</span>
<a href="#l1.318"></a><span id="l1.318">       pLine++;</span>
<a href="#l1.319"></a><span id="l1.319">       len--;</span>
<a href="#l1.320"></a><span id="l1.320">     }</span>
<a href="#l1.321"></a><span id="l1.321">   }</span>
<a href="#l1.322"></a><span id="l1.322"> </span>
<a href="#l1.323"></a><span id="l1.323">   // Always return the entry even if there's no other attribute associated with the contact.</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-  return( pEntry);</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineplus">+  return pEntry;</span>
<a href="#l1.326"></a><span id="l1.326"> }</span>
<a href="#l1.327"></a><span id="l1.327"> </span>
<a href="#l1.328"></a><span id="l1.328"> </span>
<a href="#l1.329"></a><span id="l1.329" class="difflineminus">-void nsEudoraAddress::ProcessNote( const char *pLine, PRInt32 len, nsString&amp; errors)</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineplus">+void nsEudoraAddress::ProcessNote(const char *pLine, PRInt32 len, nsString&amp; errors)</span>
<a href="#l1.331"></a><span id="l1.331"> {</span>
<a href="#l1.332"></a><span id="l1.332">   nsCString  name;</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineminus">-  PRInt32    cnt = GetAliasName( pLine, len, name);</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineplus">+  PRInt32    cnt = GetAliasName(pLine, len, name);</span>
<a href="#l1.335"></a><span id="l1.335">   pLine += cnt;</span>
<a href="#l1.336"></a><span id="l1.336">   len -= cnt;</span>
<a href="#l1.337"></a><span id="l1.337">   if (!cnt || !len)</span>
<a href="#l1.338"></a><span id="l1.338">     return;</span>
<a href="#l1.339"></a><span id="l1.339"> </span>
<a href="#l1.340"></a><span id="l1.340">   // Find the alias for this note and store the note data there!</span>
<a href="#l1.341"></a><span id="l1.341">   CAliasEntry *pEntry = nsnull;</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineminus">-  PRInt32  idx = FindAlias( name);</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineplus">+  PRInt32  idx = FindAlias(name);</span>
<a href="#l1.344"></a><span id="l1.344">   if (idx == -1)</span>
<a href="#l1.345"></a><span id="l1.345">     return;</span>
<a href="#l1.346"></a><span id="l1.346"> </span>
<a href="#l1.347"></a><span id="l1.347" class="difflineminus">-  pEntry = (CAliasEntry *) m_alias.ElementAt( idx);</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineminus">-  pEntry-&gt;m_notes.Append( pLine, len);</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineminus">-  pEntry-&gt;m_notes.Trim( kWhitespace);</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineplus">+  pEntry = (CAliasEntry *) m_alias.ElementAt(idx);</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineplus">+  pEntry-&gt;m_notes.Append(pLine, len);</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineplus">+  pEntry-&gt;m_notes.Trim(kWhitespace);</span>
<a href="#l1.353"></a><span id="l1.353"> }</span>
<a href="#l1.354"></a><span id="l1.354"> </span>
<a href="#l1.355"></a><span id="l1.355"> </span>
<a href="#l1.356"></a><span id="l1.356"> </span>
<a href="#l1.357"></a><span id="l1.357" class="difflineminus">-PRInt32 nsEudoraAddress::CountQuote( const char *pLine, PRInt32 len)</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineplus">+PRInt32 nsEudoraAddress::CountQuote(const char *pLine, PRInt32 len)</span>
<a href="#l1.359"></a><span id="l1.359"> {</span>
<a href="#l1.360"></a><span id="l1.360">   if (!len)</span>
<a href="#l1.361"></a><span id="l1.361" class="difflineminus">-    return( 0);</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineplus">+    return 0;</span>
<a href="#l1.363"></a><span id="l1.363"> </span>
<a href="#l1.364"></a><span id="l1.364">   PRInt32 cnt = 1;</span>
<a href="#l1.365"></a><span id="l1.365">   pLine++;</span>
<a href="#l1.366"></a><span id="l1.366">   len--;</span>
<a href="#l1.367"></a><span id="l1.367"> </span>
<a href="#l1.368"></a><span id="l1.368">   while (len &amp;&amp; (*pLine != '&quot;')) {</span>
<a href="#l1.369"></a><span id="l1.369">     cnt++;</span>
<a href="#l1.370"></a><span id="l1.370">     len--;</span>
<a href="#l1.371"></a><span id="l1.371">     pLine++;</span>
<a href="#l1.372"></a><span id="l1.372">   }</span>
<a href="#l1.373"></a><span id="l1.373"> </span>
<a href="#l1.374"></a><span id="l1.374">   if (len)</span>
<a href="#l1.375"></a><span id="l1.375">     cnt++;</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineminus">-  return( cnt);</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineplus">+  return cnt;</span>
<a href="#l1.378"></a><span id="l1.378"> }</span>
<a href="#l1.379"></a><span id="l1.379"> </span>
<a href="#l1.380"></a><span id="l1.380"> </span>
<a href="#l1.381"></a><span id="l1.381" class="difflineminus">-PRInt32 nsEudoraAddress::CountAngle( const char *pLine, PRInt32 len)</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineplus">+PRInt32 nsEudoraAddress::CountAngle(const char *pLine, PRInt32 len)</span>
<a href="#l1.383"></a><span id="l1.383"> {</span>
<a href="#l1.384"></a><span id="l1.384">   if (!len)</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineminus">-    return( 0);</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineplus">+    return 0;</span>
<a href="#l1.387"></a><span id="l1.387"> </span>
<a href="#l1.388"></a><span id="l1.388">   PRInt32 cnt = 1;</span>
<a href="#l1.389"></a><span id="l1.389">   pLine++;</span>
<a href="#l1.390"></a><span id="l1.390">   len--;</span>
<a href="#l1.391"></a><span id="l1.391"> </span>
<a href="#l1.392"></a><span id="l1.392">   while (len &amp;&amp; (*pLine != '&gt;')) {</span>
<a href="#l1.393"></a><span id="l1.393">     cnt++;</span>
<a href="#l1.394"></a><span id="l1.394">     len--;</span>
<a href="#l1.395"></a><span id="l1.395">     pLine++;</span>
<a href="#l1.396"></a><span id="l1.396">   }</span>
<a href="#l1.397"></a><span id="l1.397"> </span>
<a href="#l1.398"></a><span id="l1.398">   if (len)</span>
<a href="#l1.399"></a><span id="l1.399">     cnt++;</span>
<a href="#l1.400"></a><span id="l1.400" class="difflineminus">-  return( cnt);</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineplus">+  return cnt;</span>
<a href="#l1.402"></a><span id="l1.402"> }</span>
<a href="#l1.403"></a><span id="l1.403"> </span>
<a href="#l1.404"></a><span id="l1.404" class="difflineminus">-PRInt32 nsEudoraAddress::CountComment( const char *pLine, PRInt32 len)</span>
<a href="#l1.405"></a><span id="l1.405" class="difflineplus">+PRInt32 nsEudoraAddress::CountComment(const char *pLine, PRInt32 len)</span>
<a href="#l1.406"></a><span id="l1.406"> {</span>
<a href="#l1.407"></a><span id="l1.407">   if (!len)</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineminus">-    return( 0);</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineplus">+    return 0;</span>
<a href="#l1.410"></a><span id="l1.410"> </span>
<a href="#l1.411"></a><span id="l1.411">   PRInt32  cCnt;</span>
<a href="#l1.412"></a><span id="l1.412">   PRInt32 cnt = 1;</span>
<a href="#l1.413"></a><span id="l1.413">   pLine++;</span>
<a href="#l1.414"></a><span id="l1.414">   len--;</span>
<a href="#l1.415"></a><span id="l1.415"> </span>
<a href="#l1.416"></a><span id="l1.416">   while (len &amp;&amp; (*pLine != ')')) {</span>
<a href="#l1.417"></a><span id="l1.417">     if (*pLine == '(') {</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineminus">-      cCnt = CountComment( pLine, len);</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineplus">+      cCnt = CountComment(pLine, len);</span>
<a href="#l1.420"></a><span id="l1.420">       cnt += cCnt;</span>
<a href="#l1.421"></a><span id="l1.421">       pLine += cCnt;</span>
<a href="#l1.422"></a><span id="l1.422">       len -= cCnt;</span>
<a href="#l1.423"></a><span id="l1.423">     }</span>
<a href="#l1.424"></a><span id="l1.424">     else {</span>
<a href="#l1.425"></a><span id="l1.425">       cnt++;</span>
<a href="#l1.426"></a><span id="l1.426">       len--;</span>
<a href="#l1.427"></a><span id="l1.427">       pLine++;</span>
<a href="#l1.428"></a><span id="l1.428">     }</span>
<a href="#l1.429"></a><span id="l1.429">   }</span>
<a href="#l1.430"></a><span id="l1.430"> </span>
<a href="#l1.431"></a><span id="l1.431">   if (len)</span>
<a href="#l1.432"></a><span id="l1.432">     cnt++;</span>
<a href="#l1.433"></a><span id="l1.433" class="difflineminus">-  return( cnt);</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineplus">+  return cnt;</span>
<a href="#l1.435"></a><span id="l1.435"> }</span>
<a href="#l1.436"></a><span id="l1.436"> </span>
<a href="#l1.437"></a><span id="l1.437"> /*</span>
<a href="#l1.438"></a><span id="l1.438">   nsCString  m_nickName;</span>
<a href="#l1.439"></a><span id="l1.439">   nsCString  m_realName;</span>
<a href="#l1.440"></a><span id="l1.440">   nsCString  m_email;</span>
<a href="#l1.441"></a><span id="l1.441"> */</span>
<a href="#l1.442"></a><span id="l1.442"> </span>
<a href="#l1.443"></a><span id="l1.443" class="difflineminus">-bool CAliasData::Process( const char *pLine, PRInt32 len)</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineplus">+bool CAliasData::Process(const char *pLine, PRInt32 len)</span>
<a href="#l1.445"></a><span id="l1.445"> {</span>
<a href="#l1.446"></a><span id="l1.446">   // Extract any comments first!</span>
<a href="#l1.447"></a><span id="l1.447">   nsCString  str;</span>
<a href="#l1.448"></a><span id="l1.448"> </span>
<a href="#l1.449"></a><span id="l1.449">   const char *pStart = pLine;</span>
<a href="#l1.450"></a><span id="l1.450">   PRInt32    tCnt = 0;</span>
<a href="#l1.451"></a><span id="l1.451">   PRInt32    cnt = 0;</span>
<a href="#l1.452"></a><span id="l1.452">   PRInt32    max = len;</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineat">@@ -467,236 +465,241 @@ bool CAliasData::Process( const char *pL</span>
<a href="#l1.454"></a><span id="l1.454">     // ResolveAlias were failing because &quot;Smith&quot; is not the full nickname.</span>
<a href="#l1.455"></a><span id="l1.455">     // Now we just stash the full entry for nickname resolution before processing</span>
<a href="#l1.456"></a><span id="l1.456">     // the line as a potential entry in its own right.</span>
<a href="#l1.457"></a><span id="l1.457">     m_fullEntry.Append(pLine, len);</span>
<a href="#l1.458"></a><span id="l1.458"> </span>
<a href="#l1.459"></a><span id="l1.459">   while (max) {</span>
<a href="#l1.460"></a><span id="l1.460">     if (*pLine == '&quot;') {</span>
<a href="#l1.461"></a><span id="l1.461">       if (tCnt &amp;&amp; !endCollect) {</span>
<a href="#l1.462"></a><span id="l1.462" class="difflineminus">-        str.Trim( kWhitespace);</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineplus">+        str.Trim(kWhitespace);</span>
<a href="#l1.464"></a><span id="l1.464">         if (!str.IsEmpty())</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineminus">-          str.Append( &quot; &quot;, 1);</span>
<a href="#l1.466"></a><span id="l1.466" class="difflineminus">-        str.Append( pStart, tCnt);</span>
<a href="#l1.467"></a><span id="l1.467" class="difflineplus">+          str.Append(&quot; &quot;, 1);</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineplus">+        str.Append(pStart, tCnt);</span>
<a href="#l1.469"></a><span id="l1.469">       }</span>
<a href="#l1.470"></a><span id="l1.470" class="difflineminus">-      cnt = nsEudoraAddress::CountQuote( pLine, max);</span>
<a href="#l1.471"></a><span id="l1.471" class="difflineplus">+      cnt = nsEudoraAddress::CountQuote(pLine, max);</span>
<a href="#l1.472"></a><span id="l1.472">       if ((cnt &gt; 2) &amp;&amp; m_realName.IsEmpty()) {</span>
<a href="#l1.473"></a><span id="l1.473" class="difflineminus">-        m_realName.Append( pLine + 1, cnt - 2);</span>
<a href="#l1.474"></a><span id="l1.474" class="difflineplus">+        m_realName.Append(pLine + 1, cnt - 2);</span>
<a href="#l1.475"></a><span id="l1.475">       }</span>
<a href="#l1.476"></a><span id="l1.476">       pLine += cnt;</span>
<a href="#l1.477"></a><span id="l1.477">       max -= cnt;</span>
<a href="#l1.478"></a><span id="l1.478">       pStart = pLine;</span>
<a href="#l1.479"></a><span id="l1.479">       tCnt = 0;</span>
<a href="#l1.480"></a><span id="l1.480">     }</span>
<a href="#l1.481"></a><span id="l1.481">     else if (*pLine == '&lt;') {</span>
<a href="#l1.482"></a><span id="l1.482">       if (tCnt &amp;&amp; !endCollect) {</span>
<a href="#l1.483"></a><span id="l1.483" class="difflineminus">-        str.Trim( kWhitespace);</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineplus">+        str.Trim(kWhitespace);</span>
<a href="#l1.485"></a><span id="l1.485">         if (!str.IsEmpty())</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineminus">-          str.Append( &quot; &quot;, 1);</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineminus">-        str.Append( pStart, tCnt);</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineplus">+          str.Append(&quot; &quot;, 1);</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineplus">+        str.Append(pStart, tCnt);</span>
<a href="#l1.490"></a><span id="l1.490">       }</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineminus">-      cnt = nsEudoraAddress::CountAngle( pLine, max);</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineplus">+      cnt = nsEudoraAddress::CountAngle(pLine, max);</span>
<a href="#l1.493"></a><span id="l1.493">       if ((cnt &gt; 2) &amp;&amp; m_email.IsEmpty()) {</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineminus">-        m_email.Append( pLine + 1, cnt - 2);</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineplus">+        m_email.Append(pLine + 1, cnt - 2);</span>
<a href="#l1.496"></a><span id="l1.496">       }</span>
<a href="#l1.497"></a><span id="l1.497">       pLine += cnt;</span>
<a href="#l1.498"></a><span id="l1.498">       max -= cnt;</span>
<a href="#l1.499"></a><span id="l1.499">       pStart = pLine;</span>
<a href="#l1.500"></a><span id="l1.500">       tCnt = 0;</span>
<a href="#l1.501"></a><span id="l1.501">       endCollect = true;</span>
<a href="#l1.502"></a><span id="l1.502">     }</span>
<a href="#l1.503"></a><span id="l1.503">     else if (*pLine == '(') {</span>
<a href="#l1.504"></a><span id="l1.504">       if (tCnt &amp;&amp; !endCollect) {</span>
<a href="#l1.505"></a><span id="l1.505" class="difflineminus">-        str.Trim( kWhitespace);</span>
<a href="#l1.506"></a><span id="l1.506" class="difflineplus">+        str.Trim(kWhitespace);</span>
<a href="#l1.507"></a><span id="l1.507">         if (!str.IsEmpty())</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineminus">-          str.Append( &quot; &quot;, 1);</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineminus">-        str.Append( pStart, tCnt);</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineplus">+          str.Append(&quot; &quot;, 1);</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineplus">+        str.Append(pStart, tCnt);</span>
<a href="#l1.512"></a><span id="l1.512">       }</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineminus">-      cnt = nsEudoraAddress::CountComment( pLine, max);</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineplus">+      cnt = nsEudoraAddress::CountComment(pLine, max);</span>
<a href="#l1.515"></a><span id="l1.515">       if (cnt &gt; 2) {</span>
<a href="#l1.516"></a><span id="l1.516">         if (!m_realName.IsEmpty() &amp;&amp; m_nickName.IsEmpty())</span>
<a href="#l1.517"></a><span id="l1.517">           m_nickName = m_realName;</span>
<a href="#l1.518"></a><span id="l1.518">         m_realName.Truncate();</span>
<a href="#l1.519"></a><span id="l1.519" class="difflineminus">-        m_realName.Append( pLine + 1, cnt - 2);</span>
<a href="#l1.520"></a><span id="l1.520" class="difflineplus">+        m_realName.Append(pLine + 1, cnt - 2);</span>
<a href="#l1.521"></a><span id="l1.521">       }</span>
<a href="#l1.522"></a><span id="l1.522">       pLine += cnt;</span>
<a href="#l1.523"></a><span id="l1.523">       max -= cnt;</span>
<a href="#l1.524"></a><span id="l1.524">       pStart = pLine;</span>
<a href="#l1.525"></a><span id="l1.525">       tCnt = 0;</span>
<a href="#l1.526"></a><span id="l1.526">     }</span>
<a href="#l1.527"></a><span id="l1.527">     else {</span>
<a href="#l1.528"></a><span id="l1.528">       tCnt++;</span>
<a href="#l1.529"></a><span id="l1.529">       pLine++;</span>
<a href="#l1.530"></a><span id="l1.530">       max--;</span>
<a href="#l1.531"></a><span id="l1.531">     }</span>
<a href="#l1.532"></a><span id="l1.532">   }</span>
<a href="#l1.533"></a><span id="l1.533"> </span>
<a href="#l1.534"></a><span id="l1.534">   if (tCnt) {</span>
<a href="#l1.535"></a><span id="l1.535" class="difflineminus">-    str.Trim( kWhitespace);</span>
<a href="#l1.536"></a><span id="l1.536" class="difflineplus">+    str.Trim(kWhitespace);</span>
<a href="#l1.537"></a><span id="l1.537">     if (!str.IsEmpty())</span>
<a href="#l1.538"></a><span id="l1.538" class="difflineminus">-      str.Append( &quot; &quot;, 1);</span>
<a href="#l1.539"></a><span id="l1.539" class="difflineminus">-    str.Append( pStart, tCnt);</span>
<a href="#l1.540"></a><span id="l1.540" class="difflineplus">+      str.Append(&quot; &quot;, 1);</span>
<a href="#l1.541"></a><span id="l1.541" class="difflineplus">+    str.Append(pStart, tCnt);</span>
<a href="#l1.542"></a><span id="l1.542">   }</span>
<a href="#l1.543"></a><span id="l1.543"> </span>
<a href="#l1.544"></a><span id="l1.544" class="difflineminus">-  str.Trim( kWhitespace);</span>
<a href="#l1.545"></a><span id="l1.545" class="difflineplus">+  str.Trim(kWhitespace);</span>
<a href="#l1.546"></a><span id="l1.546"> </span>
<a href="#l1.547"></a><span id="l1.547">   if (!m_realName.IsEmpty() &amp;&amp; !m_email.IsEmpty())</span>
<a href="#l1.548"></a><span id="l1.548" class="difflineminus">-    return( true);</span>
<a href="#l1.549"></a><span id="l1.549" class="difflineplus">+    return true;</span>
<a href="#l1.550"></a><span id="l1.550"> </span>
<a href="#l1.551"></a><span id="l1.551">   // now we should have a string with any remaining non-delimitted text</span>
<a href="#l1.552"></a><span id="l1.552">   // we assume that the last token is the email</span>
<a href="#l1.553"></a><span id="l1.553">   // anything before that is realName</span>
<a href="#l1.554"></a><span id="l1.554">   if (!m_email.IsEmpty()) {</span>
<a href="#l1.555"></a><span id="l1.555">     m_realName = str;</span>
<a href="#l1.556"></a><span id="l1.556" class="difflineminus">-    return( true);</span>
<a href="#l1.557"></a><span id="l1.557" class="difflineplus">+    return true;</span>
<a href="#l1.558"></a><span id="l1.558">   }</span>
<a href="#l1.559"></a><span id="l1.559"> </span>
<a href="#l1.560"></a><span id="l1.560" class="difflineminus">-  tCnt = str.RFindChar( ' ');</span>
<a href="#l1.561"></a><span id="l1.561" class="difflineplus">+  tCnt = str.RFindChar(' ');</span>
<a href="#l1.562"></a><span id="l1.562">   if (tCnt == -1) {</span>
<a href="#l1.563"></a><span id="l1.563">     if (!str.IsEmpty()) {</span>
<a href="#l1.564"></a><span id="l1.564">       m_email = str;</span>
<a href="#l1.565"></a><span id="l1.565" class="difflineminus">-      return( true);</span>
<a href="#l1.566"></a><span id="l1.566" class="difflineplus">+      return true;</span>
<a href="#l1.567"></a><span id="l1.567">     }</span>
<a href="#l1.568"></a><span id="l1.568" class="difflineminus">-    return( false);</span>
<a href="#l1.569"></a><span id="l1.569" class="difflineplus">+    return false;</span>
<a href="#l1.570"></a><span id="l1.570">   }</span>
<a href="#l1.571"></a><span id="l1.571"> </span>
<a href="#l1.572"></a><span id="l1.572">   m_email = Substring(str, tCnt + 1);</span>
<a href="#l1.573"></a><span id="l1.573">   m_realName = StringHead(str, tCnt);</span>
<a href="#l1.574"></a><span id="l1.574" class="difflineminus">-  m_realName.Trim( kWhitespace);</span>
<a href="#l1.575"></a><span id="l1.575" class="difflineminus">-  m_email.Trim( kWhitespace);</span>
<a href="#l1.576"></a><span id="l1.576" class="difflineplus">+  m_realName.Trim(kWhitespace);</span>
<a href="#l1.577"></a><span id="l1.577" class="difflineplus">+  m_email.Trim(kWhitespace);</span>
<a href="#l1.578"></a><span id="l1.578"> </span>
<a href="#l1.579"></a><span id="l1.579" class="difflineminus">-  return( !m_email.IsEmpty());</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineplus">+  return !m_email.IsEmpty();</span>
<a href="#l1.581"></a><span id="l1.581"> }</span>
<a href="#l1.582"></a><span id="l1.582"> </span>
<a href="#l1.583"></a><span id="l1.583"> #ifdef IMPORT_DEBUG</span>
<a href="#l1.584"></a><span id="l1.584" class="difflineminus">-void DumpAliasArray( nsVoidArray&amp; a)</span>
<a href="#l1.585"></a><span id="l1.585" class="difflineplus">+void DumpAliasArray(nsVoidArray&amp; a)</span>
<a href="#l1.586"></a><span id="l1.586"> {</span>
<a href="#l1.587"></a><span id="l1.587">   CAliasEntry *pEntry;</span>
<a href="#l1.588"></a><span id="l1.588">   CAliasData *pData;</span>
<a href="#l1.589"></a><span id="l1.589"> </span>
<a href="#l1.590"></a><span id="l1.590">   PRInt32 cnt = a.Count();</span>
<a href="#l1.591"></a><span id="l1.591" class="difflineminus">-  IMPORT_LOG1( &quot;Alias list size: %ld\n&quot;, cnt);</span>
<a href="#l1.592"></a><span id="l1.592" class="difflineplus">+  IMPORT_LOG1(&quot;Alias list size: %ld\n&quot;, cnt);</span>
<a href="#l1.593"></a><span id="l1.593">   for (PRInt32 i = 0; i &lt; cnt; i++) {</span>
<a href="#l1.594"></a><span id="l1.594" class="difflineminus">-    pEntry = (CAliasEntry *)a.ElementAt( i);</span>
<a href="#l1.595"></a><span id="l1.595" class="difflineminus">-    IMPORT_LOG1( &quot;\tAlias: %s\n&quot;, pEntry-&gt;m_name.get());</span>
<a href="#l1.596"></a><span id="l1.596" class="difflineplus">+    pEntry = (CAliasEntry *)a.ElementAt(i);</span>
<a href="#l1.597"></a><span id="l1.597" class="difflineplus">+    IMPORT_LOG1(&quot;\tAlias: %s\n&quot;, pEntry-&gt;m_name.get());</span>
<a href="#l1.598"></a><span id="l1.598">     if (pEntry-&gt;m_list.Count() &gt; 1) {</span>
<a href="#l1.599"></a><span id="l1.599" class="difflineminus">-      IMPORT_LOG1( &quot;\tList count #%ld\n&quot;, pEntry-&gt;m_list.Count());</span>
<a href="#l1.600"></a><span id="l1.600" class="difflineplus">+      IMPORT_LOG1(&quot;\tList count #%ld\n&quot;, pEntry-&gt;m_list.Count());</span>
<a href="#l1.601"></a><span id="l1.601">       for (PRInt32 j = 0; j &lt; pEntry-&gt;m_list.Count(); j++) {</span>
<a href="#l1.602"></a><span id="l1.602" class="difflineminus">-        pData = (CAliasData *) pEntry-&gt;m_list.ElementAt( j);</span>
<a href="#l1.603"></a><span id="l1.603" class="difflineminus">-        IMPORT_LOG0( &quot;\t\t--------\n&quot;);</span>
<a href="#l1.604"></a><span id="l1.604" class="difflineminus">-        IMPORT_LOG1( &quot;\t\temail: %s\n&quot;, pData-&gt;m_email.get());</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineminus">-        IMPORT_LOG1( &quot;\t\trealName: %s\n&quot;, pData-&gt;m_realName.get());</span>
<a href="#l1.606"></a><span id="l1.606" class="difflineminus">-        IMPORT_LOG1( &quot;\t\tnickName: %s\n&quot;, pData-&gt;m_nickName.get());</span>
<a href="#l1.607"></a><span id="l1.607" class="difflineplus">+        pData = (CAliasData *) pEntry-&gt;m_list.ElementAt(j);</span>
<a href="#l1.608"></a><span id="l1.608" class="difflineplus">+        IMPORT_LOG0(&quot;\t\t--------\n&quot;);</span>
<a href="#l1.609"></a><span id="l1.609" class="difflineplus">+        IMPORT_LOG1(&quot;\t\temail: %s\n&quot;, pData-&gt;m_email.get());</span>
<a href="#l1.610"></a><span id="l1.610" class="difflineplus">+        IMPORT_LOG1(&quot;\t\trealName: %s\n&quot;, pData-&gt;m_realName.get());</span>
<a href="#l1.611"></a><span id="l1.611" class="difflineplus">+        IMPORT_LOG1(&quot;\t\tnickName: %s\n&quot;, pData-&gt;m_nickName.get());</span>
<a href="#l1.612"></a><span id="l1.612">       }</span>
<a href="#l1.613"></a><span id="l1.613">     }</span>
<a href="#l1.614"></a><span id="l1.614">     else if (pEntry-&gt;m_list.Count()) {</span>
<a href="#l1.615"></a><span id="l1.615" class="difflineminus">-      pData = (CAliasData *) pEntry-&gt;m_list.ElementAt( 0);</span>
<a href="#l1.616"></a><span id="l1.616" class="difflineminus">-      IMPORT_LOG1( &quot;\t\temail: %s\n&quot;, pData-&gt;m_email.get());</span>
<a href="#l1.617"></a><span id="l1.617" class="difflineminus">-      IMPORT_LOG1( &quot;\t\trealName: %s\n&quot;, pData-&gt;m_realName.get());</span>
<a href="#l1.618"></a><span id="l1.618" class="difflineminus">-      IMPORT_LOG1( &quot;\t\tnickName: %s\n&quot;, pData-&gt;m_nickName.get());</span>
<a href="#l1.619"></a><span id="l1.619" class="difflineplus">+      pData = (CAliasData *) pEntry-&gt;m_list.ElementAt(0);</span>
<a href="#l1.620"></a><span id="l1.620" class="difflineplus">+      IMPORT_LOG1(&quot;\t\temail: %s\n&quot;, pData-&gt;m_email.get());</span>
<a href="#l1.621"></a><span id="l1.621" class="difflineplus">+      IMPORT_LOG1(&quot;\t\trealName: %s\n&quot;, pData-&gt;m_realName.get());</span>
<a href="#l1.622"></a><span id="l1.622" class="difflineplus">+      IMPORT_LOG1(&quot;\t\tnickName: %s\n&quot;, pData-&gt;m_nickName.get());</span>
<a href="#l1.623"></a><span id="l1.623">     }</span>
<a href="#l1.624"></a><span id="l1.624">   }</span>
<a href="#l1.625"></a><span id="l1.625"> }</span>
<a href="#l1.626"></a><span id="l1.626"> #endif</span>
<a href="#l1.627"></a><span id="l1.627"> </span>
<a href="#l1.628"></a><span id="l1.628" class="difflineminus">-CAliasEntry *nsEudoraAddress::ResolveAlias( nsCString&amp; name)</span>
<a href="#l1.629"></a><span id="l1.629" class="difflineplus">+CAliasEntry *nsEudoraAddress::ResolveAlias(nsCString&amp; name)</span>
<a href="#l1.630"></a><span id="l1.630"> {</span>
<a href="#l1.631"></a><span id="l1.631">   PRInt32  max = m_alias.Count();</span>
<a href="#l1.632"></a><span id="l1.632">   CAliasEntry *pEntry;</span>
<a href="#l1.633"></a><span id="l1.633">   for (PRInt32 i = 0; i &lt; max; i++) {</span>
<a href="#l1.634"></a><span id="l1.634" class="difflineminus">-    pEntry = (CAliasEntry *) m_alias.ElementAt( i);</span>
<a href="#l1.635"></a><span id="l1.635" class="difflineminus">-    if (name.Equals( pEntry-&gt;m_name, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l1.636"></a><span id="l1.636" class="difflineminus">-      return( pEntry);</span>
<a href="#l1.637"></a><span id="l1.637" class="difflineplus">+    pEntry = (CAliasEntry *) m_alias.ElementAt(i);</span>
<a href="#l1.638"></a><span id="l1.638" class="difflineplus">+    if (name.Equals(pEntry-&gt;m_name, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l1.639"></a><span id="l1.639" class="difflineplus">+      return pEntry;</span>
<a href="#l1.640"></a><span id="l1.640">   }</span>
<a href="#l1.641"></a><span id="l1.641"> </span>
<a href="#l1.642"></a><span id="l1.642" class="difflineminus">-  return( nsnull);</span>
<a href="#l1.643"></a><span id="l1.643" class="difflineplus">+  return nsnull;</span>
<a href="#l1.644"></a><span id="l1.644"> }</span>
<a href="#l1.645"></a><span id="l1.645"> </span>
<a href="#l1.646"></a><span id="l1.646" class="difflineminus">-void nsEudoraAddress::ResolveEntries( nsCString&amp; name, nsVoidArray&amp; list,</span>
<a href="#l1.647"></a><span id="l1.647" class="difflineplus">+void nsEudoraAddress::ResolveEntries(nsCString&amp; name, nsVoidArray&amp; list,</span>
<a href="#l1.648"></a><span id="l1.648">                                      nsVoidArray&amp; result, bool addResolvedEntries,</span>
<a href="#l1.649"></a><span id="l1.649">                                      bool wasResolved, PRInt32&amp; numResolved)</span>
<a href="#l1.650"></a><span id="l1.650"> {</span>
<a href="#l1.651"></a><span id="l1.651">     /* a safe-guard against recursive entries */</span>
<a href="#l1.652"></a><span id="l1.652">     if (result.Count() &gt; m_alias.Count())</span>
<a href="#l1.653"></a><span id="l1.653">         return;</span>
<a href="#l1.654"></a><span id="l1.654"> </span>
<a href="#l1.655"></a><span id="l1.655">     PRInt32         max = list.Count();</span>
<a href="#l1.656"></a><span id="l1.656">     PRInt32         i;</span>
<a href="#l1.657"></a><span id="l1.657">     CAliasData *    pData;</span>
<a href="#l1.658"></a><span id="l1.658">     CAliasEntry *   pEntry;</span>
<a href="#l1.659"></a><span id="l1.659">     for (i = 0; i &lt; max; i++) {</span>
<a href="#l1.660"></a><span id="l1.660" class="difflineminus">-        pData = (CAliasData *)list.ElementAt( i);</span>
<a href="#l1.661"></a><span id="l1.661" class="difflineplus">+        pData = (CAliasData *)list.ElementAt(i);</span>
<a href="#l1.662"></a><span id="l1.662">         // resolve the email to an existing alias!</span>
<a href="#l1.663"></a><span id="l1.663" class="difflineminus">-        if ( !name.Equals(pData-&gt;m_email, nsCaseInsensitiveCStringComparator()) &amp;&amp;</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineminus">-             ((pEntry = ResolveAlias( pData-&gt;m_fullEntry)) != nsnull) ) {</span>
<a href="#l1.665"></a><span id="l1.665" class="difflineplus">+        if (!name.Equals(pData-&gt;m_email, nsCaseInsensitiveCStringComparator()) &amp;&amp;</span>
<a href="#l1.666"></a><span id="l1.666" class="difflineplus">+             ((pEntry = ResolveAlias(pData-&gt;m_fullEntry)) != nsnull)) {</span>
<a href="#l1.667"></a><span id="l1.667">             // This new entry has all of the entries for this puppie.</span>
<a href="#l1.668"></a><span id="l1.668">             // Resolve all of it's entries!</span>
<a href="#l1.669"></a><span id="l1.669">             numResolved++;  // Track the number of entries resolved</span>
<a href="#l1.670"></a><span id="l1.670"> </span>
<a href="#l1.671"></a><span id="l1.671">             // We pass in true for the 5th parameter so that we know that we're</span>
<a href="#l1.672"></a><span id="l1.672">             // calling ourselves recursively.</span>
<a href="#l1.673"></a><span id="l1.673" class="difflineminus">-            ResolveEntries( pEntry-&gt;m_name, pEntry-&gt;m_list, result, addResolvedEntries, true, numResolved);</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineplus">+            ResolveEntries(pEntry-&gt;m_name,</span>
<a href="#l1.675"></a><span id="l1.675" class="difflineplus">+                           pEntry-&gt;m_list,</span>
<a href="#l1.676"></a><span id="l1.676" class="difflineplus">+                           result,</span>
<a href="#l1.677"></a><span id="l1.677" class="difflineplus">+                           addResolvedEntries,</span>
<a href="#l1.678"></a><span id="l1.678" class="difflineplus">+                           true,</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineplus">+                           numResolved);</span>
<a href="#l1.680"></a><span id="l1.680">         }</span>
<a href="#l1.681"></a><span id="l1.681">         else if (addResolvedEntries || !wasResolved) {</span>
<a href="#l1.682"></a><span id="l1.682">             // This is either an ordinary entry (i.e. just contains the info) or we were told</span>
<a href="#l1.683"></a><span id="l1.683">             // to add resolved alias entries.</span>
<a href="#l1.684"></a><span id="l1.684" class="difflineminus">-            result.AppendElement( pData);</span>
<a href="#l1.685"></a><span id="l1.685" class="difflineplus">+            result.AppendElement(pData);</span>
<a href="#l1.686"></a><span id="l1.686">         }</span>
<a href="#l1.687"></a><span id="l1.687">     }</span>
<a href="#l1.688"></a><span id="l1.688"> }</span>
<a href="#l1.689"></a><span id="l1.689"> </span>
<a href="#l1.690"></a><span id="l1.690" class="difflineminus">-PRInt32 nsEudoraAddress::FindAlias( nsCString&amp; name)</span>
<a href="#l1.691"></a><span id="l1.691" class="difflineplus">+PRInt32 nsEudoraAddress::FindAlias(nsCString&amp; name)</span>
<a href="#l1.692"></a><span id="l1.692"> {</span>
<a href="#l1.693"></a><span id="l1.693">   CAliasEntry *  pEntry;</span>
<a href="#l1.694"></a><span id="l1.694">   PRInt32      max = m_alias.Count();</span>
<a href="#l1.695"></a><span id="l1.695">   PRInt32      i;</span>
<a href="#l1.696"></a><span id="l1.696"> </span>
<a href="#l1.697"></a><span id="l1.697">   for (i = 0; i &lt; max; i++) {</span>
<a href="#l1.698"></a><span id="l1.698" class="difflineminus">-    pEntry = (CAliasEntry *) m_alias.ElementAt( i);</span>
<a href="#l1.699"></a><span id="l1.699" class="difflineplus">+    pEntry = (CAliasEntry *) m_alias.ElementAt(i);</span>
<a href="#l1.700"></a><span id="l1.700">     if (pEntry-&gt;m_name == name)</span>
<a href="#l1.701"></a><span id="l1.701" class="difflineminus">-      return( i);</span>
<a href="#l1.702"></a><span id="l1.702" class="difflineplus">+      return i;</span>
<a href="#l1.703"></a><span id="l1.703">   }</span>
<a href="#l1.704"></a><span id="l1.704"> </span>
<a href="#l1.705"></a><span id="l1.705" class="difflineminus">-  return( -1);</span>
<a href="#l1.706"></a><span id="l1.706" class="difflineplus">+  return -1;</span>
<a href="#l1.707"></a><span id="l1.707"> }</span>
<a href="#l1.708"></a><span id="l1.708"> </span>
<a href="#l1.709"></a><span id="l1.709" class="difflineminus">-void nsEudoraAddress::BuildABCards( PRUint32 *pBytes, nsIAddrDatabase *pDb)</span>
<a href="#l1.710"></a><span id="l1.710" class="difflineplus">+void nsEudoraAddress::BuildABCards(PRUint32 *pBytes, nsIAddrDatabase *pDb)</span>
<a href="#l1.711"></a><span id="l1.711"> {</span>
<a href="#l1.712"></a><span id="l1.712">   CAliasEntry *  pEntry;</span>
<a href="#l1.713"></a><span id="l1.713">   PRInt32      max = m_alias.Count();</span>
<a href="#l1.714"></a><span id="l1.714">   PRInt32      i;</span>
<a href="#l1.715"></a><span id="l1.715">   nsVoidArray    emailList;</span>
<a href="#l1.716"></a><span id="l1.716">   nsVoidArray membersArray;// Remember group members.</span>
<a href="#l1.717"></a><span id="l1.717">   nsVoidArray groupsArray; // Remember groups.</span>
<a href="#l1.718"></a><span id="l1.718"> </span>
<a href="#l1.719"></a><span id="l1.719">   // First off, run through the list and build person cards - groups/lists have to be done later</span>
<a href="#l1.720"></a><span id="l1.720">   for (i = 0; i &lt; max; i++) {</span>
<a href="#l1.721"></a><span id="l1.721">     PRInt32   numResolved = 0;</span>
<a href="#l1.722"></a><span id="l1.722" class="difflineminus">-    pEntry = (CAliasEntry *) m_alias.ElementAt( i);</span>
<a href="#l1.723"></a><span id="l1.723" class="difflineplus">+    pEntry = (CAliasEntry *) m_alias.ElementAt(i);</span>
<a href="#l1.724"></a><span id="l1.724"> </span>
<a href="#l1.725"></a><span id="l1.725">     // false for 4th parameter tells ResolveEntries not to add resolved entries (avoids</span>
<a href="#l1.726"></a><span id="l1.726">     // duplicates as mailing lists are being resolved to other cards - the other cards that</span>
<a href="#l1.727"></a><span id="l1.727">     // are found have already been added and don't need to be added again).</span>
<a href="#l1.728"></a><span id="l1.728">     //</span>
<a href="#l1.729"></a><span id="l1.729">     // false for 5th parameter tells ResolveEntries that we're calling it - it's not being</span>
<a href="#l1.730"></a><span id="l1.730">     // called recursively by itself.</span>
<a href="#l1.731"></a><span id="l1.731" class="difflineminus">-    ResolveEntries( pEntry-&gt;m_name, pEntry-&gt;m_list, emailList, false, false, numResolved);</span>
<a href="#l1.732"></a><span id="l1.732" class="difflineplus">+    ResolveEntries(pEntry-&gt;m_name, pEntry-&gt;m_list, emailList, false, false, numResolved);</span>
<a href="#l1.733"></a><span id="l1.733"> </span>
<a href="#l1.734"></a><span id="l1.734">     // Treat it as a group if there's more than one email address or if we</span>
<a href="#l1.735"></a><span id="l1.735">     // needed to resolve one or more aliases. We treat single aliases to</span>
<a href="#l1.736"></a><span id="l1.736">     // other aliases as a mailing list because there's no better equivalent.</span>
<a href="#l1.737"></a><span id="l1.737" class="difflineminus">-    if ( (emailList.Count() &gt; 1) || (numResolved &gt; 0) )</span>
<a href="#l1.738"></a><span id="l1.738" class="difflineplus">+    if ((emailList.Count() &gt; 1) || (numResolved &gt; 0))</span>
<a href="#l1.739"></a><span id="l1.739">     {</span>
<a href="#l1.740"></a><span id="l1.740">       // Remember group members uniquely and add them to db later.</span>
<a href="#l1.741"></a><span id="l1.741">       RememberGroupMembers(membersArray, emailList);</span>
<a href="#l1.742"></a><span id="l1.742">       // Remember groups and add them to db later.</span>
<a href="#l1.743"></a><span id="l1.743">       groupsArray.AppendElement(pEntry);</span>
<a href="#l1.744"></a><span id="l1.744">     }</span>
<a href="#l1.745"></a><span id="l1.745">     else</span>
<a href="#l1.746"></a><span id="l1.746" class="difflineminus">-      AddSingleCard( pEntry, emailList, pDb);</span>
<a href="#l1.747"></a><span id="l1.747" class="difflineplus">+      AddSingleCard(pEntry, emailList, pDb);</span>
<a href="#l1.748"></a><span id="l1.748"> </span>
<a href="#l1.749"></a><span id="l1.749">     emailList.Clear();</span>
<a href="#l1.750"></a><span id="l1.750"> </span>
<a href="#l1.751"></a><span id="l1.751">     if (pBytes) {</span>
<a href="#l1.752"></a><span id="l1.752">       // This isn't exact but it will get us close enough</span>
<a href="#l1.753"></a><span id="l1.753">       *pBytes += (pEntry-&gt;m_name.Length() + pEntry-&gt;m_notes.Length() + 10);</span>
<a href="#l1.754"></a><span id="l1.754">     }</span>
<a href="#l1.755"></a><span id="l1.755">   }</span>
<a href="#l1.756"></a><span id="l1.756" class="difflineat">@@ -713,90 +716,90 @@ void nsEudoraAddress::BuildABCards( PRUi</span>
<a href="#l1.757"></a><span id="l1.757">     PRInt32   numResolved = 0;</span>
<a href="#l1.758"></a><span id="l1.758">     pEntry = (CAliasEntry *) groupsArray.ElementAt(i);</span>
<a href="#l1.759"></a><span id="l1.759"> </span>
<a href="#l1.760"></a><span id="l1.760">     // false for 4th parameter tells ResolveEntries to add resolved entries so that we</span>
<a href="#l1.761"></a><span id="l1.761">     // can create the mailing list with references to all entries correctly.</span>
<a href="#l1.762"></a><span id="l1.762">     //</span>
<a href="#l1.763"></a><span id="l1.763">     // false for 5th parameter tells ResolveEntries that we're calling it - it's not being</span>
<a href="#l1.764"></a><span id="l1.764">     // called recursively by itself.</span>
<a href="#l1.765"></a><span id="l1.765" class="difflineminus">-    ResolveEntries( pEntry-&gt;m_name, pEntry-&gt;m_list, emailList, true, false, numResolved);</span>
<a href="#l1.766"></a><span id="l1.766" class="difflineplus">+    ResolveEntries(pEntry-&gt;m_name, pEntry-&gt;m_list, emailList, true, false, numResolved);</span>
<a href="#l1.767"></a><span id="l1.767">     AddSingleList(pEntry, emailList, pDb);</span>
<a href="#l1.768"></a><span id="l1.768">     emailList.Clear();</span>
<a href="#l1.769"></a><span id="l1.769">   }</span>
<a href="#l1.770"></a><span id="l1.770"> }</span>
<a href="#l1.771"></a><span id="l1.771"> </span>
<a href="#l1.772"></a><span id="l1.772" class="difflineminus">-void nsEudoraAddress::ExtractNoteField( nsCString&amp; note, nsCString&amp; value, const char *pFieldName)</span>
<a href="#l1.773"></a><span id="l1.773" class="difflineplus">+void nsEudoraAddress::ExtractNoteField(nsCString&amp; note, nsCString&amp; value, const char *pFieldName)</span>
<a href="#l1.774"></a><span id="l1.774"> {</span>
<a href="#l1.775"></a><span id="l1.775">   value.Truncate();</span>
<a href="#l1.776"></a><span id="l1.776">   nsCString field(&quot;&lt;&quot;);</span>
<a href="#l1.777"></a><span id="l1.777" class="difflineminus">-  field.Append( pFieldName);</span>
<a href="#l1.778"></a><span id="l1.778" class="difflineminus">-  field.Append( ':');</span>
<a href="#l1.779"></a><span id="l1.779" class="difflineplus">+  field.Append(pFieldName);</span>
<a href="#l1.780"></a><span id="l1.780" class="difflineplus">+  field.Append(':');</span>
<a href="#l1.781"></a><span id="l1.781"> </span>
<a href="#l1.782"></a><span id="l1.782"> /*</span>
<a href="#l1.783"></a><span id="l1.783">     this is a bit of a cheat, but there's no reason it won't work</span>
<a href="#l1.784"></a><span id="l1.784">     fine for us, even better than Eudora in some cases!</span>
<a href="#l1.785"></a><span id="l1.785"> */</span>
<a href="#l1.786"></a><span id="l1.786"> </span>
<a href="#l1.787"></a><span id="l1.787" class="difflineminus">-  PRInt32 idx = note.Find( field);</span>
<a href="#l1.788"></a><span id="l1.788" class="difflineplus">+  PRInt32 idx = note.Find(field);</span>
<a href="#l1.789"></a><span id="l1.789">   if (idx != -1) {</span>
<a href="#l1.790"></a><span id="l1.790">     idx += field.Length();</span>
<a href="#l1.791"></a><span id="l1.791" class="difflineminus">-    PRInt32 endIdx = note.FindChar( '&gt;', idx);</span>
<a href="#l1.792"></a><span id="l1.792" class="difflineplus">+    PRInt32 endIdx = note.FindChar('&gt;', idx);</span>
<a href="#l1.793"></a><span id="l1.793">     if (endIdx == -1)</span>
<a href="#l1.794"></a><span id="l1.794">       endIdx = note.Length() - 1;</span>
<a href="#l1.795"></a><span id="l1.795">     value = Substring(note, idx, endIdx - idx);</span>
<a href="#l1.796"></a><span id="l1.796">     idx -= field.Length();</span>
<a href="#l1.797"></a><span id="l1.797">     note.Cut(idx, endIdx + 1);</span>
<a href="#l1.798"></a><span id="l1.798">   }</span>
<a href="#l1.799"></a><span id="l1.799"> }</span>
<a href="#l1.800"></a><span id="l1.800"> </span>
<a href="#l1.801"></a><span id="l1.801"> void nsEudoraAddress::FormatExtraDataInNoteField(PRInt32 labelStringID, nsCString&amp; extraData, nsString&amp; noteUTF16)</span>
<a href="#l1.802"></a><span id="l1.802"> {</span>
<a href="#l1.803"></a><span id="l1.803">   nsAutoString    label;</span>
<a href="#l1.804"></a><span id="l1.804">   nsEudoraStringBundle::GetStringByID(labelStringID, label);</span>
<a href="#l1.805"></a><span id="l1.805"> </span>
<a href="#l1.806"></a><span id="l1.806">   noteUTF16.Append(label);</span>
<a href="#l1.807"></a><span id="l1.807">   noteUTF16.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l1.808"></a><span id="l1.808" class="difflineminus">-  noteUTF16.Append( NS_ConvertASCIItoUTF16(extraData) );</span>
<a href="#l1.809"></a><span id="l1.809" class="difflineplus">+  noteUTF16.Append(NS_ConvertASCIItoUTF16(extraData));</span>
<a href="#l1.810"></a><span id="l1.810">   noteUTF16.AppendLiteral(&quot;\n\n&quot;);</span>
<a href="#l1.811"></a><span id="l1.811"> }</span>
<a href="#l1.812"></a><span id="l1.812"> </span>
<a href="#l1.813"></a><span id="l1.813" class="difflineminus">-void nsEudoraAddress::SanitizeValue( nsCString&amp; val)</span>
<a href="#l1.814"></a><span id="l1.814" class="difflineplus">+void nsEudoraAddress::SanitizeValue(nsCString&amp; val)</span>
<a href="#l1.815"></a><span id="l1.815"> {</span>
<a href="#l1.816"></a><span id="l1.816">   MsgReplaceSubstring(val, &quot;\n&quot;, &quot;, &quot;);</span>
<a href="#l1.817"></a><span id="l1.817">   MsgReplaceChar(val, '\r', ',');</span>
<a href="#l1.818"></a><span id="l1.818"> }</span>
<a href="#l1.819"></a><span id="l1.819"> </span>
<a href="#l1.820"></a><span id="l1.820" class="difflineminus">-void nsEudoraAddress::SplitString( nsCString&amp; val1, nsCString&amp; val2)</span>
<a href="#l1.821"></a><span id="l1.821" class="difflineplus">+void nsEudoraAddress::SplitString(nsCString&amp; val1, nsCString&amp; val2)</span>
<a href="#l1.822"></a><span id="l1.822"> {</span>
<a href="#l1.823"></a><span id="l1.823">   nsCString  temp;</span>
<a href="#l1.824"></a><span id="l1.824"> </span>
<a href="#l1.825"></a><span id="l1.825">   // Find the last line if there is more than one!</span>
<a href="#l1.826"></a><span id="l1.826" class="difflineminus">-  PRInt32 idx = val1.RFind( &quot;\x0D\x0A&quot;);</span>
<a href="#l1.827"></a><span id="l1.827" class="difflineplus">+  PRInt32 idx = val1.RFind(&quot;\x0D\x0A&quot;);</span>
<a href="#l1.828"></a><span id="l1.828">   PRInt32  cnt = 2;</span>
<a href="#l1.829"></a><span id="l1.829">   if (idx == -1) {</span>
<a href="#l1.830"></a><span id="l1.830">     cnt = 1;</span>
<a href="#l1.831"></a><span id="l1.831" class="difflineminus">-    idx = val1.RFindChar( 13);</span>
<a href="#l1.832"></a><span id="l1.832" class="difflineplus">+    idx = val1.RFindChar(13);</span>
<a href="#l1.833"></a><span id="l1.833">   }</span>
<a href="#l1.834"></a><span id="l1.834">   if (idx == -1)</span>
<a href="#l1.835"></a><span id="l1.835" class="difflineminus">-    idx= val1.RFindChar( 10);</span>
<a href="#l1.836"></a><span id="l1.836" class="difflineplus">+    idx= val1.RFindChar(10);</span>
<a href="#l1.837"></a><span id="l1.837">   if (idx != -1) {</span>
<a href="#l1.838"></a><span id="l1.838">     val2 = Substring(val1, idx + cnt);</span>
<a href="#l1.839"></a><span id="l1.839">     val1.SetLength(idx);</span>
<a href="#l1.840"></a><span id="l1.840" class="difflineminus">-    SanitizeValue( val1);</span>
<a href="#l1.841"></a><span id="l1.841" class="difflineplus">+    SanitizeValue(val1);</span>
<a href="#l1.842"></a><span id="l1.842">   }</span>
<a href="#l1.843"></a><span id="l1.843"> }</span>
<a href="#l1.844"></a><span id="l1.844"> </span>
<a href="#l1.845"></a><span id="l1.845" class="difflineminus">-void nsEudoraAddress::AddSingleCard( CAliasEntry *pEntry, nsVoidArray &amp;emailList, nsIAddrDatabase *pDb)</span>
<a href="#l1.846"></a><span id="l1.846" class="difflineplus">+void nsEudoraAddress::AddSingleCard(CAliasEntry *pEntry, nsVoidArray &amp;emailList, nsIAddrDatabase *pDb)</span>
<a href="#l1.847"></a><span id="l1.847"> {</span>
<a href="#l1.848"></a><span id="l1.848">   // We always have a nickname and everything else is optional.</span>
<a href="#l1.849"></a><span id="l1.849">   // Map both home and work related fields to our address card. Eudora</span>
<a href="#l1.850"></a><span id="l1.850">   // fields that can't be mapped will be left in the 'note' field!</span>
<a href="#l1.851"></a><span id="l1.851">   nsIMdbRow* newRow = nsnull;</span>
<a href="#l1.852"></a><span id="l1.852" class="difflineminus">-  pDb-&gt;GetNewRow( &amp;newRow);</span>
<a href="#l1.853"></a><span id="l1.853" class="difflineplus">+  pDb-&gt;GetNewRow(&amp;newRow);</span>
<a href="#l1.854"></a><span id="l1.854">   if (!newRow)</span>
<a href="#l1.855"></a><span id="l1.855">     return;</span>
<a href="#l1.856"></a><span id="l1.856"> </span>
<a href="#l1.857"></a><span id="l1.857">   nsCString                   displayName, name, firstName, lastName;</span>
<a href="#l1.858"></a><span id="l1.858">   nsCString                   fax, secondaryFax, phone, mobile, secondaryMobile, webLink;</span>
<a href="#l1.859"></a><span id="l1.859">   nsCString                   address, address2, city, state, zip, country;</span>
<a href="#l1.860"></a><span id="l1.860">   nsCString                   phoneWK, webLinkWK, title, company;</span>
<a href="#l1.861"></a><span id="l1.861">   nsCString                   addressWK, address2WK, cityWK, stateWK, zipWK, countryWK;</span>
<a href="#l1.862"></a><span id="l1.862" class="difflineat">@@ -804,53 +807,53 @@ void nsEudoraAddress::AddSingleCard( CAl</span>
<a href="#l1.863"></a><span id="l1.863">   nsCString                   additionalEmail, stillMoreEmail;</span>
<a href="#l1.864"></a><span id="l1.864">   nsCString                   note(pEntry-&gt;m_notes);</span>
<a href="#l1.865"></a><span id="l1.865">   nsString                    noteUTF16;</span>
<a href="#l1.866"></a><span id="l1.866">   bool                        isSecondaryMobileWorkNumber = true;</span>
<a href="#l1.867"></a><span id="l1.867">   bool                        isSecondaryFaxWorkNumber = true;</span>
<a href="#l1.868"></a><span id="l1.868"> </span>
<a href="#l1.869"></a><span id="l1.869">   if (!note.IsEmpty())</span>
<a href="#l1.870"></a><span id="l1.870">   {</span>
<a href="#l1.871"></a><span id="l1.871" class="difflineminus">-    ExtractNoteField( note, fax, &quot;fax&quot;);</span>
<a href="#l1.872"></a><span id="l1.872" class="difflineminus">-    ExtractNoteField( note, secondaryFax, &quot;fax2&quot;);</span>
<a href="#l1.873"></a><span id="l1.873" class="difflineminus">-    ExtractNoteField( note, phone, &quot;phone&quot;);</span>
<a href="#l1.874"></a><span id="l1.874" class="difflineminus">-    ExtractNoteField( note, mobile, &quot;mobile&quot;);</span>
<a href="#l1.875"></a><span id="l1.875" class="difflineminus">-    ExtractNoteField( note, secondaryMobile, &quot;mobile2&quot;);</span>
<a href="#l1.876"></a><span id="l1.876" class="difflineminus">-    ExtractNoteField( note, address, &quot;address&quot;);</span>
<a href="#l1.877"></a><span id="l1.877" class="difflineminus">-    ExtractNoteField( note, city, &quot;city&quot;);</span>
<a href="#l1.878"></a><span id="l1.878" class="difflineminus">-    ExtractNoteField( note, state, &quot;state&quot;);</span>
<a href="#l1.879"></a><span id="l1.879" class="difflineminus">-    ExtractNoteField( note, zip, &quot;zip&quot;);</span>
<a href="#l1.880"></a><span id="l1.880" class="difflineminus">-    ExtractNoteField( note, country, &quot;country&quot;);</span>
<a href="#l1.881"></a><span id="l1.881" class="difflineminus">-    ExtractNoteField( note, name, &quot;name&quot;);</span>
<a href="#l1.882"></a><span id="l1.882" class="difflineminus">-    ExtractNoteField( note, firstName, &quot;first&quot;);</span>
<a href="#l1.883"></a><span id="l1.883" class="difflineminus">-    ExtractNoteField( note, lastName, &quot;last&quot;);</span>
<a href="#l1.884"></a><span id="l1.884" class="difflineminus">-    ExtractNoteField( note, webLink, &quot;web&quot;);</span>
<a href="#l1.885"></a><span id="l1.885" class="difflineplus">+    ExtractNoteField(note, fax, &quot;fax&quot;);</span>
<a href="#l1.886"></a><span id="l1.886" class="difflineplus">+    ExtractNoteField(note, secondaryFax, &quot;fax2&quot;);</span>
<a href="#l1.887"></a><span id="l1.887" class="difflineplus">+    ExtractNoteField(note, phone, &quot;phone&quot;);</span>
<a href="#l1.888"></a><span id="l1.888" class="difflineplus">+    ExtractNoteField(note, mobile, &quot;mobile&quot;);</span>
<a href="#l1.889"></a><span id="l1.889" class="difflineplus">+    ExtractNoteField(note, secondaryMobile, &quot;mobile2&quot;);</span>
<a href="#l1.890"></a><span id="l1.890" class="difflineplus">+    ExtractNoteField(note, address, &quot;address&quot;);</span>
<a href="#l1.891"></a><span id="l1.891" class="difflineplus">+    ExtractNoteField(note, city, &quot;city&quot;);</span>
<a href="#l1.892"></a><span id="l1.892" class="difflineplus">+    ExtractNoteField(note, state, &quot;state&quot;);</span>
<a href="#l1.893"></a><span id="l1.893" class="difflineplus">+    ExtractNoteField(note, zip, &quot;zip&quot;);</span>
<a href="#l1.894"></a><span id="l1.894" class="difflineplus">+    ExtractNoteField(note, country, &quot;country&quot;);</span>
<a href="#l1.895"></a><span id="l1.895" class="difflineplus">+    ExtractNoteField(note, name, &quot;name&quot;);</span>
<a href="#l1.896"></a><span id="l1.896" class="difflineplus">+    ExtractNoteField(note, firstName, &quot;first&quot;);</span>
<a href="#l1.897"></a><span id="l1.897" class="difflineplus">+    ExtractNoteField(note, lastName, &quot;last&quot;);</span>
<a href="#l1.898"></a><span id="l1.898" class="difflineplus">+    ExtractNoteField(note, webLink, &quot;web&quot;);</span>
<a href="#l1.899"></a><span id="l1.899"> </span>
<a href="#l1.900"></a><span id="l1.900" class="difflineminus">-    ExtractNoteField( note, addressWK, &quot;address2&quot;);</span>
<a href="#l1.901"></a><span id="l1.901" class="difflineminus">-    ExtractNoteField( note, cityWK, &quot;city2&quot;);</span>
<a href="#l1.902"></a><span id="l1.902" class="difflineminus">-    ExtractNoteField( note, stateWK, &quot;state2&quot;);</span>
<a href="#l1.903"></a><span id="l1.903" class="difflineminus">-    ExtractNoteField( note, zipWK, &quot;zip2&quot;);</span>
<a href="#l1.904"></a><span id="l1.904" class="difflineminus">-    ExtractNoteField( note, countryWK, &quot;country2&quot;);</span>
<a href="#l1.905"></a><span id="l1.905" class="difflineminus">-    ExtractNoteField( note, phoneWK, &quot;phone2&quot;);</span>
<a href="#l1.906"></a><span id="l1.906" class="difflineminus">-    ExtractNoteField( note, title, &quot;title&quot;);</span>
<a href="#l1.907"></a><span id="l1.907" class="difflineminus">-    ExtractNoteField( note, company, &quot;company&quot;);</span>
<a href="#l1.908"></a><span id="l1.908" class="difflineminus">-    ExtractNoteField( note, webLinkWK, &quot;web2&quot;);</span>
<a href="#l1.909"></a><span id="l1.909" class="difflineplus">+    ExtractNoteField(note, addressWK, &quot;address2&quot;);</span>
<a href="#l1.910"></a><span id="l1.910" class="difflineplus">+    ExtractNoteField(note, cityWK, &quot;city2&quot;);</span>
<a href="#l1.911"></a><span id="l1.911" class="difflineplus">+    ExtractNoteField(note, stateWK, &quot;state2&quot;);</span>
<a href="#l1.912"></a><span id="l1.912" class="difflineplus">+    ExtractNoteField(note, zipWK, &quot;zip2&quot;);</span>
<a href="#l1.913"></a><span id="l1.913" class="difflineplus">+    ExtractNoteField(note, countryWK, &quot;country2&quot;);</span>
<a href="#l1.914"></a><span id="l1.914" class="difflineplus">+    ExtractNoteField(note, phoneWK, &quot;phone2&quot;);</span>
<a href="#l1.915"></a><span id="l1.915" class="difflineplus">+    ExtractNoteField(note, title, &quot;title&quot;);</span>
<a href="#l1.916"></a><span id="l1.916" class="difflineplus">+    ExtractNoteField(note, company, &quot;company&quot;);</span>
<a href="#l1.917"></a><span id="l1.917" class="difflineplus">+    ExtractNoteField(note, webLinkWK, &quot;web2&quot;);</span>
<a href="#l1.918"></a><span id="l1.918"> </span>
<a href="#l1.919"></a><span id="l1.919" class="difflineminus">-    ExtractNoteField( note, primaryLocation, &quot;primary&quot;);</span>
<a href="#l1.920"></a><span id="l1.920" class="difflineminus">-    ExtractNoteField( note, additionalEmail, &quot;otheremail&quot;);</span>
<a href="#l1.921"></a><span id="l1.921" class="difflineminus">-    ExtractNoteField( note, otherPhone, &quot;otherphone&quot;);</span>
<a href="#l1.922"></a><span id="l1.922" class="difflineminus">-    ExtractNoteField( note, otherWeb, &quot;otherweb&quot;);</span>
<a href="#l1.923"></a><span id="l1.923" class="difflineplus">+    ExtractNoteField(note, primaryLocation, &quot;primary&quot;);</span>
<a href="#l1.924"></a><span id="l1.924" class="difflineplus">+    ExtractNoteField(note, additionalEmail, &quot;otheremail&quot;);</span>
<a href="#l1.925"></a><span id="l1.925" class="difflineplus">+    ExtractNoteField(note, otherPhone, &quot;otherphone&quot;);</span>
<a href="#l1.926"></a><span id="l1.926" class="difflineplus">+    ExtractNoteField(note, otherWeb, &quot;otherweb&quot;);</span>
<a href="#l1.927"></a><span id="l1.927"> </span>
<a href="#l1.928"></a><span id="l1.928">     // Is there any &quot;extra&quot; data that we may want to format nicely and place</span>
<a href="#l1.929"></a><span id="l1.929">     // in the notes field?</span>
<a href="#l1.930"></a><span id="l1.930" class="difflineminus">-    if ( !additionalEmail.IsEmpty() || !otherPhone.IsEmpty() || !otherWeb.IsEmpty() )</span>
<a href="#l1.931"></a><span id="l1.931" class="difflineplus">+    if (!additionalEmail.IsEmpty() || !otherPhone.IsEmpty() || !otherWeb.IsEmpty())</span>
<a href="#l1.932"></a><span id="l1.932">     {</span>
<a href="#l1.933"></a><span id="l1.933">       nsCString     otherNotes(note);</span>
<a href="#l1.934"></a><span id="l1.934"> </span>
<a href="#l1.935"></a><span id="l1.935" class="difflineminus">-      if ( !additionalEmail.IsEmpty() )</span>
<a href="#l1.936"></a><span id="l1.936" class="difflineplus">+      if (!additionalEmail.IsEmpty())</span>
<a href="#l1.937"></a><span id="l1.937">       {</span>
<a href="#l1.938"></a><span id="l1.938">         // Reconstitute line breaks for additional email</span>
<a href="#l1.939"></a><span id="l1.939">         MsgReplaceSubstring(additionalEmail, &quot;\x03&quot;, &quot;\n&quot;);</span>
<a href="#l1.940"></a><span id="l1.940"> </span>
<a href="#l1.941"></a><span id="l1.941">         // Try to figure out if there are multiple email addresses in additionalEmail</span>
<a href="#l1.942"></a><span id="l1.942">         PRInt32     idx = MsgFindCharInSet(additionalEmail, &quot;\t\r\n,; &quot;);</span>
<a href="#l1.943"></a><span id="l1.943"> </span>
<a href="#l1.944"></a><span id="l1.944">         if (idx != -1)</span>
<a href="#l1.945"></a><span id="l1.945" class="difflineat">@@ -861,65 +864,65 @@ void nsEudoraAddress::AddSingleCard( CAl</span>
<a href="#l1.946"></a><span id="l1.946">           stillMoreEmail.Trim(kWhitespace);</span>
<a href="#l1.947"></a><span id="l1.947"> </span>
<a href="#l1.948"></a><span id="l1.948">           // Separate out the first address.</span>
<a href="#l1.949"></a><span id="l1.949">           additionalEmail.SetLength(idx);</span>
<a href="#l1.950"></a><span id="l1.950">         }</span>
<a href="#l1.951"></a><span id="l1.951"> </span>
<a href="#l1.952"></a><span id="l1.952">         // If there were more than one additional email addresses store all the extra</span>
<a href="#l1.953"></a><span id="l1.953">         // ones in the notes field, labeled nicely.</span>
<a href="#l1.954"></a><span id="l1.954" class="difflineminus">-        if ( !stillMoreEmail.IsEmpty() )</span>
<a href="#l1.955"></a><span id="l1.955" class="difflineplus">+        if (!stillMoreEmail.IsEmpty())</span>
<a href="#l1.956"></a><span id="l1.956">           FormatExtraDataInNoteField(EUDORAIMPORT_ADDRESS_LABEL_OTHEREMAIL, stillMoreEmail, noteUTF16);</span>
<a href="#l1.957"></a><span id="l1.957">       }</span>
<a href="#l1.958"></a><span id="l1.958"> </span>
<a href="#l1.959"></a><span id="l1.959" class="difflineminus">-      if ( !otherPhone.IsEmpty() )</span>
<a href="#l1.960"></a><span id="l1.960" class="difflineplus">+      if (!otherPhone.IsEmpty())</span>
<a href="#l1.961"></a><span id="l1.961">       {</span>
<a href="#l1.962"></a><span id="l1.962">         // Reconstitute line breaks for other phone numbers</span>
<a href="#l1.963"></a><span id="l1.963">         MsgReplaceSubstring(otherPhone, &quot;\x03&quot;, &quot;\n&quot;);</span>
<a href="#l1.964"></a><span id="l1.964"> </span>
<a href="#l1.965"></a><span id="l1.965">         // Store other phone numbers in the notes field, labeled nicely</span>
<a href="#l1.966"></a><span id="l1.966">         FormatExtraDataInNoteField(EUDORAIMPORT_ADDRESS_LABEL_OTHERPHONE, otherPhone, noteUTF16);</span>
<a href="#l1.967"></a><span id="l1.967">       }</span>
<a href="#l1.968"></a><span id="l1.968"> </span>
<a href="#l1.969"></a><span id="l1.969" class="difflineminus">-      if ( !otherWeb.IsEmpty() )</span>
<a href="#l1.970"></a><span id="l1.970" class="difflineplus">+      if (!otherWeb.IsEmpty())</span>
<a href="#l1.971"></a><span id="l1.971">       {</span>
<a href="#l1.972"></a><span id="l1.972">         // Reconstitute line breaks for other web sites</span>
<a href="#l1.973"></a><span id="l1.973">         MsgReplaceSubstring(otherWeb, &quot;\x03&quot;, &quot;\n&quot;);</span>
<a href="#l1.974"></a><span id="l1.974"> </span>
<a href="#l1.975"></a><span id="l1.975">         // Store other web sites in the notes field, labeled nicely</span>
<a href="#l1.976"></a><span id="l1.976">         FormatExtraDataInNoteField(EUDORAIMPORT_ADDRESS_LABEL_OTHERWEB, otherWeb, noteUTF16);</span>
<a href="#l1.977"></a><span id="l1.977">       }</span>
<a href="#l1.978"></a><span id="l1.978"> </span>
<a href="#l1.979"></a><span id="l1.979" class="difflineminus">-      noteUTF16.Append( NS_ConvertASCIItoUTF16(note) );</span>
<a href="#l1.980"></a><span id="l1.980" class="difflineplus">+      noteUTF16.Append(NS_ConvertASCIItoUTF16(note));</span>
<a href="#l1.981"></a><span id="l1.981">     }</span>
<a href="#l1.982"></a><span id="l1.982">   }</span>
<a href="#l1.983"></a><span id="l1.983"> </span>
<a href="#l1.984"></a><span id="l1.984">   CAliasData *pData = emailList.Count() ? (CAliasData *)emailList.ElementAt(0) : nsnull;</span>
<a href="#l1.985"></a><span id="l1.985"> </span>
<a href="#l1.986"></a><span id="l1.986">   if (pData &amp;&amp; !pData-&gt;m_realName.IsEmpty())</span>
<a href="#l1.987"></a><span id="l1.987">     displayName = pData-&gt;m_realName;</span>
<a href="#l1.988"></a><span id="l1.988">   else if (!name.IsEmpty())</span>
<a href="#l1.989"></a><span id="l1.989">     displayName = name;</span>
<a href="#l1.990"></a><span id="l1.990">   else</span>
<a href="#l1.991"></a><span id="l1.991">     displayName = pEntry-&gt;m_name;</span>
<a href="#l1.992"></a><span id="l1.992"> </span>
<a href="#l1.993"></a><span id="l1.993">   MsgReplaceSubstring(address, &quot;\x03&quot;, &quot;\n&quot;);</span>
<a href="#l1.994"></a><span id="l1.994" class="difflineminus">-  SplitString( address, address2);</span>
<a href="#l1.995"></a><span id="l1.995" class="difflineplus">+  SplitString(address, address2);</span>
<a href="#l1.996"></a><span id="l1.996">   MsgReplaceSubstring(note, &quot;\x03&quot;, &quot;\n&quot;);</span>
<a href="#l1.997"></a><span id="l1.997">   MsgReplaceSubstring(fax, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l1.998"></a><span id="l1.998">   MsgReplaceSubstring(secondaryFax, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l1.999"></a><span id="l1.999">   MsgReplaceSubstring(phone, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l1.1000"></a><span id="l1.1000">   MsgReplaceSubstring(name, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l1.1001"></a><span id="l1.1001">   MsgReplaceSubstring(city, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l1.1002"></a><span id="l1.1002">   MsgReplaceSubstring(state, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l1.1003"></a><span id="l1.1003">   MsgReplaceSubstring(zip, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l1.1004"></a><span id="l1.1004">   MsgReplaceSubstring(country, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l1.1005"></a><span id="l1.1005"> </span>
<a href="#l1.1006"></a><span id="l1.1006">   MsgReplaceSubstring(addressWK, &quot;\x03&quot;, &quot;\n&quot;);</span>
<a href="#l1.1007"></a><span id="l1.1007" class="difflineminus">-  SplitString( addressWK, address2WK);</span>
<a href="#l1.1008"></a><span id="l1.1008" class="difflineplus">+  SplitString(addressWK, address2WK);</span>
<a href="#l1.1009"></a><span id="l1.1009">   MsgReplaceSubstring(phoneWK, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l1.1010"></a><span id="l1.1010">   MsgReplaceSubstring(cityWK, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l1.1011"></a><span id="l1.1011">   MsgReplaceSubstring(stateWK, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l1.1012"></a><span id="l1.1012">   MsgReplaceSubstring(zipWK, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l1.1013"></a><span id="l1.1013">   MsgReplaceSubstring(countryWK, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l1.1014"></a><span id="l1.1014">   MsgReplaceSubstring(title, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l1.1015"></a><span id="l1.1015">   MsgReplaceSubstring(company, &quot;\x03&quot;, &quot; &quot;);</span>
<a href="#l1.1016"></a><span id="l1.1016"> </span>
<a href="#l1.1017"></a><span id="l1.1017" class="difflineat">@@ -950,18 +953,18 @@ void nsEudoraAddress::AddSingleCard( CAl</span>
<a href="#l1.1018"></a><span id="l1.1018">     ADD_FIELD_TO_DB_ROW(pDb, AddWorkPhone, newRow, phoneWK, uniStr);</span>
<a href="#l1.1019"></a><span id="l1.1019">     ADD_FIELD_TO_DB_ROW(pDb, AddWorkAddress, newRow, addressWK, uniStr);</span>
<a href="#l1.1020"></a><span id="l1.1020">     ADD_FIELD_TO_DB_ROW(pDb, AddWorkAddress2, newRow, address2WK, uniStr);</span>
<a href="#l1.1021"></a><span id="l1.1021">     ADD_FIELD_TO_DB_ROW(pDb, AddWorkCity, newRow, cityWK, uniStr);</span>
<a href="#l1.1022"></a><span id="l1.1022">     ADD_FIELD_TO_DB_ROW(pDb, AddWorkZipCode, newRow, zipWK, uniStr);</span>
<a href="#l1.1023"></a><span id="l1.1023">     ADD_FIELD_TO_DB_ROW(pDb, AddWorkState, newRow, stateWK, uniStr);</span>
<a href="#l1.1024"></a><span id="l1.1024">     ADD_FIELD_TO_DB_ROW(pDb, AddWorkCountry, newRow, countryWK, uniStr);</span>
<a href="#l1.1025"></a><span id="l1.1025"> </span>
<a href="#l1.1026"></a><span id="l1.1026" class="difflineminus">-    if ( (primaryLocation.IsEmpty() || primaryLocation.LowerCaseEqualsLiteral(&quot;home&quot;)) &amp;&amp;</span>
<a href="#l1.1027"></a><span id="l1.1027" class="difflineminus">-         !mobile.IsEmpty() )</span>
<a href="#l1.1028"></a><span id="l1.1028" class="difflineplus">+    if ((primaryLocation.IsEmpty() || primaryLocation.LowerCaseEqualsLiteral(&quot;home&quot;)) &amp;&amp;</span>
<a href="#l1.1029"></a><span id="l1.1029" class="difflineplus">+         !mobile.IsEmpty())</span>
<a href="#l1.1030"></a><span id="l1.1030">     {</span>
<a href="#l1.1031"></a><span id="l1.1031">       // Primary location field is either specified to be &quot;home&quot; or is not</span>
<a href="#l1.1032"></a><span id="l1.1032">       // specified and there is a home mobile number, so use that as the mobile number.</span>
<a href="#l1.1033"></a><span id="l1.1033">       ADD_FIELD_TO_DB_ROW(pDb, AddCellularNumber, newRow, mobile, uniStr);</span>
<a href="#l1.1034"></a><span id="l1.1034"> </span>
<a href="#l1.1035"></a><span id="l1.1035">       isSecondaryMobileWorkNumber = true;</span>
<a href="#l1.1036"></a><span id="l1.1036">     }</span>
<a href="#l1.1037"></a><span id="l1.1037">     else</span>
<a href="#l1.1038"></a><span id="l1.1038" class="difflineat">@@ -970,18 +973,18 @@ void nsEudoraAddress::AddSingleCard( CAl</span>
<a href="#l1.1039"></a><span id="l1.1039">       // home mobile number, so use work mobile number.</span>
<a href="#l1.1040"></a><span id="l1.1040">       ADD_FIELD_TO_DB_ROW(pDb, AddCellularNumber, newRow, secondaryMobile, uniStr);</span>
<a href="#l1.1041"></a><span id="l1.1041"> </span>
<a href="#l1.1042"></a><span id="l1.1042">       // Home mobile number (if any) is the secondary mobile number</span>
<a href="#l1.1043"></a><span id="l1.1043">       secondaryMobile = mobile;</span>
<a href="#l1.1044"></a><span id="l1.1044">       isSecondaryMobileWorkNumber = false;</span>
<a href="#l1.1045"></a><span id="l1.1045">     }</span>
<a href="#l1.1046"></a><span id="l1.1046"> </span>
<a href="#l1.1047"></a><span id="l1.1047" class="difflineminus">-    if ( (primaryLocation.IsEmpty() || primaryLocation.LowerCaseEqualsLiteral(&quot;home&quot;)) &amp;&amp;</span>
<a href="#l1.1048"></a><span id="l1.1048" class="difflineminus">-         !fax.IsEmpty() )</span>
<a href="#l1.1049"></a><span id="l1.1049" class="difflineplus">+    if ((primaryLocation.IsEmpty() || primaryLocation.LowerCaseEqualsLiteral(&quot;home&quot;)) &amp;&amp;</span>
<a href="#l1.1050"></a><span id="l1.1050" class="difflineplus">+         !fax.IsEmpty())</span>
<a href="#l1.1051"></a><span id="l1.1051">     {</span>
<a href="#l1.1052"></a><span id="l1.1052">       // Primary location field is either specified to be &quot;home&quot; or is not</span>
<a href="#l1.1053"></a><span id="l1.1053">       // specified and there is a home fax number, so use that as the fax number.</span>
<a href="#l1.1054"></a><span id="l1.1054">       ADD_FIELD_TO_DB_ROW(pDb, AddFaxNumber, newRow, fax, uniStr);</span>
<a href="#l1.1055"></a><span id="l1.1055"> </span>
<a href="#l1.1056"></a><span id="l1.1056">       isSecondaryFaxWorkNumber = true;</span>
<a href="#l1.1057"></a><span id="l1.1057">     }</span>
<a href="#l1.1058"></a><span id="l1.1058">     else</span>
<a href="#l1.1059"></a><span id="l1.1059" class="difflineat">@@ -998,41 +1001,41 @@ void nsEudoraAddress::AddSingleCard( CAl</span>
<a href="#l1.1060"></a><span id="l1.1060">     ADD_FIELD_TO_DB_ROW(pDb, Add2ndEmail, newRow, additionalEmail, uniStr);</span>
<a href="#l1.1061"></a><span id="l1.1061"> </span>
<a href="#l1.1062"></a><span id="l1.1062">     // Extra info fields</span>
<a href="#l1.1063"></a><span id="l1.1063">     PRInt32         stringID;</span>
<a href="#l1.1064"></a><span id="l1.1064">     nsString        pFormat;</span>
<a href="#l1.1065"></a><span id="l1.1065">     nsString        pCustomData;</span>
<a href="#l1.1066"></a><span id="l1.1066"> </span>
<a href="#l1.1067"></a><span id="l1.1067">     // Add second mobile number, if any, to the Custom 1 field</span>
<a href="#l1.1068"></a><span id="l1.1068" class="difflineminus">-    if ( !secondaryMobile.IsEmpty() )</span>
<a href="#l1.1069"></a><span id="l1.1069" class="difflineplus">+    if (!secondaryMobile.IsEmpty())</span>
<a href="#l1.1070"></a><span id="l1.1070">     {</span>
<a href="#l1.1071"></a><span id="l1.1071">       stringID = isSecondaryMobileWorkNumber ?</span>
<a href="#l1.1072"></a><span id="l1.1072">                  EUDORAIMPORT_ADDRESS_LABEL_WORKMOBILE : EUDORAIMPORT_ADDRESS_LABEL_HOMEMOBILE;</span>
<a href="#l1.1073"></a><span id="l1.1073">       pFormat.Adopt(nsEudoraStringBundle::GetStringByID(stringID));</span>
<a href="#l1.1074"></a><span id="l1.1074" class="difflineminus">-      pCustomData.Adopt( nsTextFormatter::smprintf(pFormat.get(), NS_ConvertASCIItoUTF16(secondaryMobile).get()) );</span>
<a href="#l1.1075"></a><span id="l1.1075" class="difflineminus">-      pDb-&gt;AddCustom1( newRow, NS_ConvertUTF16toUTF8(pCustomData).get() );</span>
<a href="#l1.1076"></a><span id="l1.1076" class="difflineplus">+      pCustomData.Adopt(nsTextFormatter::smprintf(pFormat.get(), NS_ConvertASCIItoUTF16(secondaryMobile).get()));</span>
<a href="#l1.1077"></a><span id="l1.1077" class="difflineplus">+      pDb-&gt;AddCustom1(newRow, NS_ConvertUTF16toUTF8(pCustomData).get());</span>
<a href="#l1.1078"></a><span id="l1.1078">     }</span>
<a href="#l1.1079"></a><span id="l1.1079"> </span>
<a href="#l1.1080"></a><span id="l1.1080">     // Add second fax number, if any, to the Custom 2 field</span>
<a href="#l1.1081"></a><span id="l1.1081" class="difflineminus">-    if ( !secondaryFax.IsEmpty() )</span>
<a href="#l1.1082"></a><span id="l1.1082" class="difflineplus">+    if (!secondaryFax.IsEmpty())</span>
<a href="#l1.1083"></a><span id="l1.1083">     {</span>
<a href="#l1.1084"></a><span id="l1.1084">       stringID = isSecondaryFaxWorkNumber ?</span>
<a href="#l1.1085"></a><span id="l1.1085">                  EUDORAIMPORT_ADDRESS_LABEL_WORKFAX : EUDORAIMPORT_ADDRESS_LABEL_HOMEFAX;</span>
<a href="#l1.1086"></a><span id="l1.1086">       pFormat.Adopt(nsEudoraStringBundle::GetStringByID(stringID));</span>
<a href="#l1.1087"></a><span id="l1.1087" class="difflineminus">-      pCustomData.Adopt( nsTextFormatter::smprintf(pFormat.get(), NS_ConvertASCIItoUTF16(secondaryFax).get()) );</span>
<a href="#l1.1088"></a><span id="l1.1088" class="difflineminus">-      pDb-&gt;AddCustom2( newRow, NS_ConvertUTF16toUTF8(pCustomData).get() );</span>
<a href="#l1.1089"></a><span id="l1.1089" class="difflineplus">+      pCustomData.Adopt(nsTextFormatter::smprintf(pFormat.get(), NS_ConvertASCIItoUTF16(secondaryFax).get()));</span>
<a href="#l1.1090"></a><span id="l1.1090" class="difflineplus">+      pDb-&gt;AddCustom2(newRow, NS_ConvertUTF16toUTF8(pCustomData).get());</span>
<a href="#l1.1091"></a><span id="l1.1091">     }</span>
<a href="#l1.1092"></a><span id="l1.1092"> </span>
<a href="#l1.1093"></a><span id="l1.1093">     // Lastly, note field.</span>
<a href="#l1.1094"></a><span id="l1.1094" class="difflineminus">-    pDb-&gt;AddNotes( newRow, NS_ConvertUTF16toUTF8(noteUTF16).get() );</span>
<a href="#l1.1095"></a><span id="l1.1095" class="difflineplus">+    pDb-&gt;AddNotes(newRow, NS_ConvertUTF16toUTF8(noteUTF16).get());</span>
<a href="#l1.1096"></a><span id="l1.1096"> </span>
<a href="#l1.1097"></a><span id="l1.1097" class="difflineminus">-    pDb-&gt;AddCardRowToDB( newRow);</span>
<a href="#l1.1098"></a><span id="l1.1098" class="difflineplus">+    pDb-&gt;AddCardRowToDB(newRow);</span>
<a href="#l1.1099"></a><span id="l1.1099"> </span>
<a href="#l1.1100"></a><span id="l1.1100" class="difflineminus">-    IMPORT_LOG1( &quot;Added card to db: %s\n&quot;, displayName.get());</span>
<a href="#l1.1101"></a><span id="l1.1101" class="difflineplus">+    IMPORT_LOG1(&quot;Added card to db: %s\n&quot;, displayName.get());</span>
<a href="#l1.1102"></a><span id="l1.1102">   }</span>
<a href="#l1.1103"></a><span id="l1.1103"> }</span>
<a href="#l1.1104"></a><span id="l1.1104"> </span>
<a href="#l1.1105"></a><span id="l1.1105"> //</span>
<a href="#l1.1106"></a><span id="l1.1106"> // Since there is no way to check if a card for a given email address already exists,</span>
<a href="#l1.1107"></a><span id="l1.1107"> // elements in 'membersArray' are make unique. So for each email address in 'emailList'</span>
<a href="#l1.1108"></a><span id="l1.1108"> // we check it in 'membersArray' and if it's not there then we add it to 'membersArray'.</span>
<a href="#l1.1109"></a><span id="l1.1109"> //</span>
<a href="#l1.1110"></a><span id="l1.1110" class="difflineat">@@ -1083,34 +1086,34 @@ nsresult nsEudoraAddress::AddGroupMember</span>
<a href="#l1.1111"></a><span id="l1.1111">       displayName = pData-&gt;m_realName;</span>
<a href="#l1.1112"></a><span id="l1.1112">     else if (!pData-&gt;m_nickName.IsEmpty())</span>
<a href="#l1.1113"></a><span id="l1.1113">       displayName = pData-&gt;m_nickName;</span>
<a href="#l1.1114"></a><span id="l1.1114">     else</span>
<a href="#l1.1115"></a><span id="l1.1115">       displayName.Truncate();</span>
<a href="#l1.1116"></a><span id="l1.1116"> </span>
<a href="#l1.1117"></a><span id="l1.1117">     ADD_FIELD_TO_DB_ROW(pDb, AddDisplayName, newRow, displayName, uniStr);</span>
<a href="#l1.1118"></a><span id="l1.1118">     ADD_FIELD_TO_DB_ROW(pDb, AddPrimaryEmail, newRow, pData-&gt;m_email, uniStr);</span>
<a href="#l1.1119"></a><span id="l1.1119" class="difflineminus">-    rv = pDb-&gt;AddCardRowToDB( newRow);</span>
<a href="#l1.1120"></a><span id="l1.1120" class="difflineplus">+    rv = pDb-&gt;AddCardRowToDB(newRow);</span>
<a href="#l1.1121"></a><span id="l1.1121">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1122"></a><span id="l1.1122">   }</span>
<a href="#l1.1123"></a><span id="l1.1123">   return rv;</span>
<a href="#l1.1124"></a><span id="l1.1124"> }</span>
<a href="#l1.1125"></a><span id="l1.1125"> </span>
<a href="#l1.1126"></a><span id="l1.1126"> nsresult nsEudoraAddress::AddSingleList(CAliasEntry *pEntry, nsVoidArray &amp;emailList, nsIAddrDatabase *pDb)</span>
<a href="#l1.1127"></a><span id="l1.1127"> {</span>
<a href="#l1.1128"></a><span id="l1.1128">   // Create a list.</span>
<a href="#l1.1129"></a><span id="l1.1129">   nsCOMPtr &lt;nsIMdbRow&gt; newRow;</span>
<a href="#l1.1130"></a><span id="l1.1130">   nsresult rv = pDb-&gt;GetNewListRow(getter_AddRefs(newRow));</span>
<a href="#l1.1131"></a><span id="l1.1131">   if (NS_FAILED(rv) || !newRow)</span>
<a href="#l1.1132"></a><span id="l1.1132">       return rv;</span>
<a href="#l1.1133"></a><span id="l1.1133"> </span>
<a href="#l1.1134"></a><span id="l1.1134">   // Extract name from notes, if any</span>
<a href="#l1.1135"></a><span id="l1.1135">   nsCString     name;</span>
<a href="#l1.1136"></a><span id="l1.1136"> </span>
<a href="#l1.1137"></a><span id="l1.1137" class="difflineminus">-  if ( !pEntry-&gt;m_notes.IsEmpty() )</span>
<a href="#l1.1138"></a><span id="l1.1138" class="difflineplus">+  if (!pEntry-&gt;m_notes.IsEmpty())</span>
<a href="#l1.1139"></a><span id="l1.1139">   {</span>
<a href="#l1.1140"></a><span id="l1.1140">     nsCString     note(pEntry-&gt;m_notes);</span>
<a href="#l1.1141"></a><span id="l1.1141">     ExtractNoteField(note, name, &quot;name&quot;);</span>
<a href="#l1.1142"></a><span id="l1.1142">   }</span>
<a href="#l1.1143"></a><span id="l1.1143"> </span>
<a href="#l1.1144"></a><span id="l1.1144">   // If we got a name from the notes, use that for the name otherwise use the</span>
<a href="#l1.1145"></a><span id="l1.1145">   // name in pEntry (which is the Eudora nickname).</span>
<a href="#l1.1146"></a><span id="l1.1146">   rv = pDb-&gt;AddListName(newRow, name.IsEmpty() ? pEntry-&gt;m_name.get() : name.get());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraAddress.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraAddress.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -59,49 +59,49 @@ class nsIStringBundle;</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> class nsEudoraAddress {</span>
<a href="#l2.6"></a><span id="l2.6"> public:</span>
<a href="#l2.7"></a><span id="l2.7">   nsEudoraAddress();</span>
<a href="#l2.8"></a><span id="l2.8">   virtual ~nsEudoraAddress();</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10">   // Things that must be overridden because they are platform specific.</span>
<a href="#l2.11"></a><span id="l2.11">     // retrieve the mail folder</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  virtual bool      FindAddressFolder( nsIFile **pFolder) { return( false);}</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  virtual bool      FindAddressFolder(nsIFile **pFolder) { return false;}</span>
<a href="#l2.14"></a><span id="l2.14">     // get the list of mailboxes</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-  virtual nsresult  FindAddressBooks( nsIFile *pRoot, nsISupportsArray **ppArray) { return( NS_ERROR_FAILURE);}</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+  virtual nsresult  FindAddressBooks(nsIFile *pRoot, nsISupportsArray **ppArray) { return NS_ERROR_FAILURE;}</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">   // Non-platform specific common stuff</span>
<a href="#l2.19"></a><span id="l2.19">     // import a mailbox</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-  nsresult ImportAddresses( PRUint32 *pBytes, bool *pAbort, const PRUnichar *pName, nsIFile *pSrc, nsIAddrDatabase *pDb, nsString&amp; errors);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+  nsresult ImportAddresses(PRUint32 *pBytes, bool *pAbort, const PRUnichar *pName, nsIFile *pSrc, nsIAddrDatabase *pDb, nsString&amp; errors);</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24"> private:</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-  void       EmptyAliases( void);</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-  void      ProcessLine( const char *pLine, PRInt32 len, nsString&amp; errors);</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-  PRInt32     CountWhiteSpace( const char *pLine, PRInt32 len);</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-  CAliasEntry  *  ProcessAlias( const char *pLine, PRInt32 len, nsString&amp; errors);</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-  void      ProcessNote( const char *pLine, PRInt32 len, nsString&amp; errors);</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-  PRInt32      GetAliasName( const char *pLine, PRInt32 len, nsCString&amp; name);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  CAliasEntry *  ResolveAlias( nsCString&amp; name);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-  void       ResolveEntries( nsCString&amp; name, nsVoidArray&amp; list, nsVoidArray&amp; result, bool addResolvedEntries, bool wasResolved, PRInt32&amp; numResolved);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-  void      BuildABCards( PRUint32 *pBytes, nsIAddrDatabase *pDb);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-  void      AddSingleCard( CAliasEntry *pEntry, nsVoidArray &amp;emailList, nsIAddrDatabase *pDb);</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-  nsresult  AddSingleList( CAliasEntry *pEntry, nsVoidArray &amp;emailList, nsIAddrDatabase *pDb);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+  void       EmptyAliases(void);</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  void      ProcessLine(const char *pLine, PRInt32 len, nsString&amp; errors);</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+  PRInt32     CountWhiteSpace(const char *pLine, PRInt32 len);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  CAliasEntry  *  ProcessAlias(const char *pLine, PRInt32 len, nsString&amp; errors);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+  void      ProcessNote(const char *pLine, PRInt32 len, nsString&amp; errors);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  PRInt32      GetAliasName(const char *pLine, PRInt32 len, nsCString&amp; name);</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+  CAliasEntry *  ResolveAlias(nsCString&amp; name);</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+  void       ResolveEntries(nsCString&amp; name, nsVoidArray&amp; list, nsVoidArray&amp; result, bool addResolvedEntries, bool wasResolved, PRInt32&amp; numResolved);</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+  void      BuildABCards(PRUint32 *pBytes, nsIAddrDatabase *pDb);</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  void      AddSingleCard(CAliasEntry *pEntry, nsVoidArray &amp;emailList, nsIAddrDatabase *pDb);</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  nsresult  AddSingleList(CAliasEntry *pEntry, nsVoidArray &amp;emailList, nsIAddrDatabase *pDb);</span>
<a href="#l2.47"></a><span id="l2.47">   nsresult  AddGroupMembersAsCards(nsVoidArray &amp;membersArray, nsIAddrDatabase *pDb);</span>
<a href="#l2.48"></a><span id="l2.48">   void      RememberGroupMembers(nsVoidArray &amp;membersArray, nsVoidArray &amp;emailList);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-  PRInt32      FindAlias( nsCString&amp; name);</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-  void      ExtractNoteField( nsCString&amp; note, nsCString&amp; field, const char *pFieldName);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+  PRInt32      FindAlias(nsCString&amp; name);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  void      ExtractNoteField(nsCString&amp; note, nsCString&amp; field, const char *pFieldName);</span>
<a href="#l2.53"></a><span id="l2.53">   void FormatExtraDataInNoteField(PRInt32 labelStringID, nsCString&amp; extraData, nsString&amp; noteUTF16);</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-  void      SanitizeValue( nsCString&amp; val);</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-  void      SplitString( nsCString&amp; val1, nsCString&amp; val2);</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+  void      SanitizeValue(nsCString&amp; val);</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  void      SplitString(nsCString&amp; val1, nsCString&amp; val2);</span>
<a href="#l2.58"></a><span id="l2.58"> </span>
<a href="#l2.59"></a><span id="l2.59"> public:</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-  static PRInt32     CountQuote( const char *pLine, PRInt32 len);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-  static PRInt32     CountComment( const char *pLine, PRInt32 len);</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-  static PRInt32     CountAngle( const char *pLine, PRInt32 len);</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+  static PRInt32     CountQuote(const char *pLine, PRInt32 len);</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+  static PRInt32     CountComment(const char *pLine, PRInt32 len);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+  static PRInt32     CountAngle(const char *pLine, PRInt32 len);</span>
<a href="#l2.66"></a><span id="l2.66"> </span>
<a href="#l2.67"></a><span id="l2.67"> private:</span>
<a href="#l2.68"></a><span id="l2.68">   nsVoidArray    m_alias;</span>
<a href="#l2.69"></a><span id="l2.69"> };</span>
<a href="#l2.70"></a><span id="l2.70"> </span>
<a href="#l2.71"></a><span id="l2.71"> </span>
<a href="#l2.72"></a><span id="l2.72"> </span>
<a href="#l2.73"></a><span id="l2.73"> #endif /* nsEudoraAddress_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraCompose.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraCompose.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -67,18 +67,18 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;EudoraDebugLog.h&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsCRT.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-static NS_DEFINE_CID( kMsgSendCID, NS_MSGSEND_CID);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-static NS_DEFINE_CID( kMsgCompFieldsCID, NS_MSGCOMPFIELDS_CID);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+static NS_DEFINE_CID(kMsgSendCID, NS_MSGSEND_CID);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+static NS_DEFINE_CID(kMsgCompFieldsCID, NS_MSGCOMPFIELDS_CID);</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> // We need to do some calculations to set these numbers to something reasonable!</span>
<a href="#l3.18"></a><span id="l3.18"> // Unless of course, CreateAndSendMessage will NEVER EVER leave us in the lurch</span>
<a href="#l3.19"></a><span id="l3.19"> #define kHungCount 100000</span>
<a href="#l3.20"></a><span id="l3.20"> #define kHungAbortCount 1000</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22"> // Define maximum possible length for content type sanity check</span>
<a href="#l3.23"></a><span id="l3.23"> #define kContentTypeLengthSanityCheck 32</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineat">@@ -154,29 +154,29 @@ public:</span>
<a href="#l3.25"></a><span id="l3.25">   }</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">     /* void OnSendNotPerformed */</span>
<a href="#l3.28"></a><span id="l3.28">     NS_IMETHOD OnSendNotPerformed(const char *aMsgID, nsresult aStatus) {return NS_OK;}</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30">   /* void OnGetDraftFolderURI (); */</span>
<a href="#l3.31"></a><span id="l3.31">   NS_IMETHOD OnGetDraftFolderURI(const char *aFolderURI) {return NS_OK;}</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-  static nsresult CreateSendListener( nsIMsgSendListener **ppListener);</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  static nsresult CreateSendListener(nsIMsgSendListener **ppListener);</span>
<a href="#l3.35"></a><span id="l3.35"> </span>
<a href="#l3.36"></a><span id="l3.36">   void Reset() { m_done = false;  m_location = nsnull;}</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38"> public:</span>
<a href="#l3.39"></a><span id="l3.39">   bool m_done;</span>
<a href="#l3.40"></a><span id="l3.40">   nsCOMPtr &lt;nsIFile&gt; m_location;</span>
<a href="#l3.41"></a><span id="l3.41"> };</span>
<a href="#l3.42"></a><span id="l3.42"> </span>
<a href="#l3.43"></a><span id="l3.43"> </span>
<a href="#l3.44"></a><span id="l3.44"> NS_IMPL_THREADSAFE_ISUPPORTS1(EudoraSendListener, nsIMsgSendListener)</span>
<a href="#l3.45"></a><span id="l3.45"> </span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-nsresult EudoraSendListener::CreateSendListener( nsIMsgSendListener **ppListener)</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+nsresult EudoraSendListener::CreateSendListener(nsIMsgSendListener **ppListener)</span>
<a href="#l3.48"></a><span id="l3.48"> {</span>
<a href="#l3.49"></a><span id="l3.49">   NS_ENSURE_ARG_POINTER(ppListener);</span>
<a href="#l3.50"></a><span id="l3.50">   *ppListener = new EudoraSendListener();</span>
<a href="#l3.51"></a><span id="l3.51">   NS_ENSURE_TRUE(*ppListener, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l3.52"></a><span id="l3.52">   NS_ADDREF(*ppListener);</span>
<a href="#l3.53"></a><span id="l3.53">   return NS_OK;</span>
<a href="#l3.54"></a><span id="l3.54"> }</span>
<a href="#l3.55"></a><span id="l3.55"> </span>
<a href="#l3.56"></a><span id="l3.56" class="difflineat">@@ -190,104 +190,109 @@ nsresult EudoraSendListener::CreateSendL</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58"> nsEudoraCompose::nsEudoraCompose()</span>
<a href="#l3.59"></a><span id="l3.59"> {</span>
<a href="#l3.60"></a><span id="l3.60">   m_pAttachments = nsnull;</span>
<a href="#l3.61"></a><span id="l3.61">   m_pListener = nsnull;</span>
<a href="#l3.62"></a><span id="l3.62">   m_pMsgFields = nsnull;</span>
<a href="#l3.63"></a><span id="l3.63">   m_pHeaders = p_test_headers;</span>
<a href="#l3.64"></a><span id="l3.64">   if (m_pHeaders)</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-    m_headerLen = strlen( m_pHeaders);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+    m_headerLen = strlen(m_pHeaders);</span>
<a href="#l3.67"></a><span id="l3.67">   else</span>
<a href="#l3.68"></a><span id="l3.68">     m_headerLen = 0;</span>
<a href="#l3.69"></a><span id="l3.69">   m_pBody = p_test_body;</span>
<a href="#l3.70"></a><span id="l3.70">   if (m_pBody)</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-    m_bodyLen = strlen( m_pBody);</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+    m_bodyLen = strlen(m_pBody);</span>
<a href="#l3.73"></a><span id="l3.73">   else</span>
<a href="#l3.74"></a><span id="l3.74">     m_bodyLen = 0;</span>
<a href="#l3.75"></a><span id="l3.75"> </span>
<a href="#l3.76"></a><span id="l3.76">   m_readHeaders.m_convertCRs = true;</span>
<a href="#l3.77"></a><span id="l3.77"> }</span>
<a href="#l3.78"></a><span id="l3.78"> </span>
<a href="#l3.79"></a><span id="l3.79"> </span>
<a href="#l3.80"></a><span id="l3.80"> nsEudoraCompose::~nsEudoraCompose()</span>
<a href="#l3.81"></a><span id="l3.81"> {</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-  NS_IF_RELEASE( m_pListener);</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-  NS_IF_RELEASE( m_pMsgFields);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+  NS_IF_RELEASE(m_pListener);</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+  NS_IF_RELEASE(m_pMsgFields);</span>
<a href="#l3.86"></a><span id="l3.86"> }</span>
<a href="#l3.87"></a><span id="l3.87"> </span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-nsresult nsEudoraCompose::CreateIdentity( void)</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+nsresult nsEudoraCompose::CreateIdentity(void)</span>
<a href="#l3.90"></a><span id="l3.90"> {</span>
<a href="#l3.91"></a><span id="l3.91">   if (s_pIdentity)</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-    return( NS_OK);</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.94"></a><span id="l3.94"> </span>
<a href="#l3.95"></a><span id="l3.95">   // Should only create identity from main thread</span>
<a href="#l3.96"></a><span id="l3.96">   NS_ENSURE_TRUE(NS_IsMainThread(), NS_ERROR_FAILURE);</span>
<a href="#l3.97"></a><span id="l3.97">   nsresult rv;</span>
<a href="#l3.98"></a><span id="l3.98">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr(do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l3.99"></a><span id="l3.99">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.100"></a><span id="l3.100"> </span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-  rv = accMgr-&gt;CreateIdentity( &amp;s_pIdentity);</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+  rv = accMgr-&gt;CreateIdentity(&amp;s_pIdentity);</span>
<a href="#l3.103"></a><span id="l3.103">   nsString name(NS_LITERAL_STRING(&quot;Import Identity&quot;));</span>
<a href="#l3.104"></a><span id="l3.104">   if (s_pIdentity) {</span>
<a href="#l3.105"></a><span id="l3.105">     s_pIdentity-&gt;SetFullName(name);</span>
<a href="#l3.106"></a><span id="l3.106">     s_pIdentity-&gt;SetIdentityName(name);</span>
<a href="#l3.107"></a><span id="l3.107">     s_pIdentity-&gt;SetEmail(NS_LITERAL_CSTRING(&quot;import@import.service&quot;));</span>
<a href="#l3.108"></a><span id="l3.108"> </span>
<a href="#l3.109"></a><span id="l3.109">     // SetDoFcc to false to save time when CreateAndSendMessage operates.</span>
<a href="#l3.110"></a><span id="l3.110">     // Profiling revealed that GetFolderURIFromUserPrefs was taking up a significant chunk</span>
<a href="#l3.111"></a><span id="l3.111">     // of time during the operation of CreateAndSendMessage. By calling SetDoFcc(false),</span>
<a href="#l3.112"></a><span id="l3.112">     // we skip Fcc handling code inside of InitCompositionFields (called indirectly during</span>
<a href="#l3.113"></a><span id="l3.113">     // CreateAndSendMessage operation). There's no point in any Fcc code firing since the</span>
<a href="#l3.114"></a><span id="l3.114">     // message will never actually be sent anyway.</span>
<a href="#l3.115"></a><span id="l3.115">     s_pIdentity-&gt;SetDoFcc(false);</span>
<a href="#l3.116"></a><span id="l3.116">   }</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-  return( rv);</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+  return rv;</span>
<a href="#l3.119"></a><span id="l3.119"> }</span>
<a href="#l3.120"></a><span id="l3.120"> </span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-void nsEudoraCompose::ReleaseIdentity( void)</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+void nsEudoraCompose::ReleaseIdentity(void)</span>
<a href="#l3.123"></a><span id="l3.123"> {</span>
<a href="#l3.124"></a><span id="l3.124">   if (s_pIdentity) {</span>
<a href="#l3.125"></a><span id="l3.125">     nsresult rv = s_pIdentity-&gt;ClearAllValues();</span>
<a href="#l3.126"></a><span id="l3.126">     NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to clear values&quot;);</span>
<a href="#l3.127"></a><span id="l3.127">     if (NS_FAILED(rv)) return;</span>
<a href="#l3.128"></a><span id="l3.128"> </span>
<a href="#l3.129"></a><span id="l3.129">     NS_RELEASE(s_pIdentity);</span>
<a href="#l3.130"></a><span id="l3.130">   }</span>
<a href="#l3.131"></a><span id="l3.131"> }</span>
<a href="#l3.132"></a><span id="l3.132"> </span>
<a href="#l3.133"></a><span id="l3.133"> </span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-nsresult nsEudoraCompose::CreateComponents( void)</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+nsresult nsEudoraCompose::CreateComponents(void)</span>
<a href="#l3.136"></a><span id="l3.136"> {</span>
<a href="#l3.137"></a><span id="l3.137">   nsresult  rv = NS_OK;</span>
<a href="#l3.138"></a><span id="l3.138"> </span>
<a href="#l3.139"></a><span id="l3.139">   if (!m_pIOService) {</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-    IMPORT_LOG0( &quot;Creating nsIOService\n&quot;);</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+    IMPORT_LOG0(&quot;Creating nsIOService\n&quot;);</span>
<a href="#l3.142"></a><span id="l3.142">     </span>
<a href="#l3.143"></a><span id="l3.143">     m_pIOService = do_GetService(NS_IOSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l3.144"></a><span id="l3.144">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.145"></a><span id="l3.145">   }</span>
<a href="#l3.146"></a><span id="l3.146"> </span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-  NS_IF_RELEASE( m_pMsgFields);</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-  if (!m_pListener &amp;&amp; NS_SUCCEEDED( rv))</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-    rv = EudoraSendListener::CreateSendListener( &amp;m_pListener);</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+  NS_IF_RELEASE(m_pMsgFields);</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+  if (!m_pListener &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+    rv = EudoraSendListener::CreateSendListener(&amp;m_pListener);</span>
<a href="#l3.153"></a><span id="l3.153"> </span>
<a href="#l3.154"></a><span id="l3.154">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-      rv = CallCreateInstance( kMsgCompFieldsCID, &amp;m_pMsgFields);</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+      rv = CallCreateInstance(kMsgCompFieldsCID, &amp;m_pMsgFields);</span>
<a href="#l3.157"></a><span id="l3.157">     if (NS_SUCCEEDED(rv) &amp;&amp; m_pMsgFields) {</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-      // IMPORT_LOG0( &quot;nsOutlookCompose - CreateComponents succeeded\n&quot;);</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-      m_pMsgFields-&gt;SetForcePlainText( false);</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-      return( NS_OK);</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+      // IMPORT_LOG0(&quot;nsOutlookCompose - CreateComponents succeeded\n&quot;);</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+      m_pMsgFields-&gt;SetForcePlainText(false);</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+      return NS_OK;</span>
<a href="#l3.164"></a><span id="l3.164">     }</span>
<a href="#l3.165"></a><span id="l3.165">   }</span>
<a href="#l3.166"></a><span id="l3.166"> </span>
<a href="#l3.167"></a><span id="l3.167">   return NS_ERROR_FAILURE;</span>
<a href="#l3.168"></a><span id="l3.168"> }</span>
<a href="#l3.169"></a><span id="l3.169"> </span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-void nsEudoraCompose::GetNthHeader( const char *pData, PRInt32 dataLen, PRInt32 n, nsCString&amp; header, nsCString&amp; val, bool unwrap)</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+void nsEudoraCompose::GetNthHeader(const char *pData,</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+                                   PRInt32 dataLen,</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+                                   PRInt32 n,</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+                                   nsCString&amp; header,</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+                                   nsCString&amp; val,</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+                                   bool unwrap)</span>
<a href="#l3.177"></a><span id="l3.177"> {</span>
<a href="#l3.178"></a><span id="l3.178">   header.Truncate();</span>
<a href="#l3.179"></a><span id="l3.179">   val.Truncate();</span>
<a href="#l3.180"></a><span id="l3.180">   if (!pData)</span>
<a href="#l3.181"></a><span id="l3.181">     return;</span>
<a href="#l3.182"></a><span id="l3.182"> </span>
<a href="#l3.183"></a><span id="l3.183">   PRInt32 index = 0;</span>
<a href="#l3.184"></a><span id="l3.184">   PRInt32 len;</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineat">@@ -297,34 +302,34 @@ void nsEudoraCompose::GetNthHeader( cons</span>
<a href="#l3.186"></a><span id="l3.186">   if (n == 0) {</span>
<a href="#l3.187"></a><span id="l3.187">     pStart = pChar;</span>
<a href="#l3.188"></a><span id="l3.188">     len = 0;</span>
<a href="#l3.189"></a><span id="l3.189">     while ((start &lt; dataLen) &amp;&amp; (*pChar != ':')) {</span>
<a href="#l3.190"></a><span id="l3.190">       start++;</span>
<a href="#l3.191"></a><span id="l3.191">       len++;</span>
<a href="#l3.192"></a><span id="l3.192">       pChar++;</span>
<a href="#l3.193"></a><span id="l3.193">     }</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-    header.Append( pStart, len);</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-    header.Trim( kWhitespace);</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+    header.Append(pStart, len);</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+    header.Trim(kWhitespace);</span>
<a href="#l3.198"></a><span id="l3.198">     start++;</span>
<a href="#l3.199"></a><span id="l3.199">     pChar++;</span>
<a href="#l3.200"></a><span id="l3.200">   }</span>
<a href="#l3.201"></a><span id="l3.201">   else {</span>
<a href="#l3.202"></a><span id="l3.202">     while (start &lt; dataLen) {</span>
<a href="#l3.203"></a><span id="l3.203">       if ((*pChar != ' ') &amp;&amp; (*pChar != '\t')) {</span>
<a href="#l3.204"></a><span id="l3.204">         if (n == index) {</span>
<a href="#l3.205"></a><span id="l3.205">           pStart = pChar;</span>
<a href="#l3.206"></a><span id="l3.206">           len = 0;</span>
<a href="#l3.207"></a><span id="l3.207">           while ((start &lt; dataLen) &amp;&amp; (*pChar != ':')) {</span>
<a href="#l3.208"></a><span id="l3.208">             start++;</span>
<a href="#l3.209"></a><span id="l3.209">             len++;</span>
<a href="#l3.210"></a><span id="l3.210">             pChar++;</span>
<a href="#l3.211"></a><span id="l3.211">           }</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-          header.Append( pStart, len);</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-          header.Trim( kWhitespace);</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+          header.Append(pStart, len);</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+          header.Trim(kWhitespace);</span>
<a href="#l3.216"></a><span id="l3.216">           start++;</span>
<a href="#l3.217"></a><span id="l3.217">           pChar++;</span>
<a href="#l3.218"></a><span id="l3.218">           break;</span>
<a href="#l3.219"></a><span id="l3.219">         }</span>
<a href="#l3.220"></a><span id="l3.220">         else</span>
<a href="#l3.221"></a><span id="l3.221">           index++;</span>
<a href="#l3.222"></a><span id="l3.222">       }</span>
<a href="#l3.223"></a><span id="l3.223"> </span>
<a href="#l3.224"></a><span id="l3.224" class="difflineat">@@ -351,17 +356,17 @@ void nsEudoraCompose::GetNthHeader( cons</span>
<a href="#l3.225"></a><span id="l3.225">   while (end &lt; dataLen) {</span>
<a href="#l3.226"></a><span id="l3.226">     // Skip to next end of line.</span>
<a href="#l3.227"></a><span id="l3.227">     while ((end &lt; dataLen) &amp;&amp; (*pChar != nsCRT::CR) &amp;&amp; (*pChar != nsCRT::LF)) {</span>
<a href="#l3.228"></a><span id="l3.228">       end++;</span>
<a href="#l3.229"></a><span id="l3.229">       pChar++;</span>
<a href="#l3.230"></a><span id="l3.230">     }</span>
<a href="#l3.231"></a><span id="l3.231"> </span>
<a href="#l3.232"></a><span id="l3.232">     if (end &gt; start) {</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-      val.Append( pData + start, end - start);</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+      val.Append(pData + start, end - start);</span>
<a href="#l3.235"></a><span id="l3.235">     }</span>
<a href="#l3.236"></a><span id="l3.236"> </span>
<a href="#l3.237"></a><span id="l3.237">     lineEnd = end;</span>
<a href="#l3.238"></a><span id="l3.238">     pStart = pChar;</span>
<a href="#l3.239"></a><span id="l3.239"> </span>
<a href="#l3.240"></a><span id="l3.240">     // Skip over end of line(s).</span>
<a href="#l3.241"></a><span id="l3.241">     while ((end &lt; dataLen) &amp;&amp;</span>
<a href="#l3.242"></a><span id="l3.242">            ((*pChar == nsCRT::CR) || (*pChar == nsCRT::LF))) {</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineat">@@ -376,38 +381,42 @@ void nsEudoraCompose::GetNthHeader( cons</span>
<a href="#l3.244"></a><span id="l3.244">       end++;</span>
<a href="#l3.245"></a><span id="l3.245">       pChar++;</span>
<a href="#l3.246"></a><span id="l3.246">     }</span>
<a href="#l3.247"></a><span id="l3.247"> </span>
<a href="#l3.248"></a><span id="l3.248">     if (start == end)</span>
<a href="#l3.249"></a><span id="l3.249">       break;</span>
<a href="#l3.250"></a><span id="l3.250"> </span>
<a href="#l3.251"></a><span id="l3.251">     if (unwrap)</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-      val.Append( ' ');</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+      val.Append(' ');</span>
<a href="#l3.254"></a><span id="l3.254">     else {</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-      val.Append( pStart, end - lineEnd);</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+      val.Append(pStart, end - lineEnd);</span>
<a href="#l3.257"></a><span id="l3.257">     }</span>
<a href="#l3.258"></a><span id="l3.258"> </span>
<a href="#l3.259"></a><span id="l3.259">     start = end;</span>
<a href="#l3.260"></a><span id="l3.260">   }</span>
<a href="#l3.261"></a><span id="l3.261"> </span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-  val.Trim( kWhitespace);</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+  val.Trim(kWhitespace);</span>
<a href="#l3.264"></a><span id="l3.264"> }</span>
<a href="#l3.265"></a><span id="l3.265"> </span>
<a href="#l3.266"></a><span id="l3.266"> </span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-void nsEudoraCompose::GetHeaderValue( const char *pData, PRInt32 dataLen, const char *pHeader, nsCString&amp; val, bool unwrap)</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+void nsEudoraCompose::GetHeaderValue(const char *pData,</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+                                     PRInt32 dataLen,</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+                                     const char *pHeader,</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+                                     nsCString&amp; val,</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+                                     bool unwrap)</span>
<a href="#l3.273"></a><span id="l3.273"> {</span>
<a href="#l3.274"></a><span id="l3.274">   val.Truncate();</span>
<a href="#l3.275"></a><span id="l3.275">   if (!pData)</span>
<a href="#l3.276"></a><span id="l3.276">     return;</span>
<a href="#l3.277"></a><span id="l3.277"> </span>
<a href="#l3.278"></a><span id="l3.278">   PRInt32  start = 0;</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-  PRInt32 len = strlen( pHeader);</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+  PRInt32 len = strlen(pHeader);</span>
<a href="#l3.281"></a><span id="l3.281">   const char *pChar = pData;</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-  if (!PL_strncasecmp( pHeader, pData, len)) {</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+  if (!PL_strncasecmp(pHeader, pData, len)) {</span>
<a href="#l3.284"></a><span id="l3.284">     start = len;</span>
<a href="#l3.285"></a><span id="l3.285">   }</span>
<a href="#l3.286"></a><span id="l3.286">   else {</span>
<a href="#l3.287"></a><span id="l3.287">     while (start &lt; dataLen) {</span>
<a href="#l3.288"></a><span id="l3.288">       // Skip to next end of line.</span>
<a href="#l3.289"></a><span id="l3.289">       while ((start &lt; dataLen) &amp;&amp;</span>
<a href="#l3.290"></a><span id="l3.290">              (*pChar != nsCRT::CR) &amp;&amp; (*pChar != nsCRT::LF)) {</span>
<a href="#l3.291"></a><span id="l3.291">         start++;</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineat">@@ -415,17 +424,17 @@ void nsEudoraCompose::GetHeaderValue( co</span>
<a href="#l3.293"></a><span id="l3.293">       }</span>
<a href="#l3.294"></a><span id="l3.294">       // Skip over end of line(s).</span>
<a href="#l3.295"></a><span id="l3.295">       while ((start &lt; dataLen) &amp;&amp;</span>
<a href="#l3.296"></a><span id="l3.296">              ((*pChar == nsCRT::CR) || (*pChar == nsCRT::LF))) {</span>
<a href="#l3.297"></a><span id="l3.297">         start++;</span>
<a href="#l3.298"></a><span id="l3.298">         pChar++;</span>
<a href="#l3.299"></a><span id="l3.299">       }</span>
<a href="#l3.300"></a><span id="l3.300"> </span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-      if ((start &lt; dataLen) &amp;&amp; !PL_strncasecmp( pChar, pHeader, len))</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+      if ((start &lt; dataLen) &amp;&amp; !PL_strncasecmp(pChar, pHeader, len))</span>
<a href="#l3.303"></a><span id="l3.303">         break;</span>
<a href="#l3.304"></a><span id="l3.304">     }</span>
<a href="#l3.305"></a><span id="l3.305">     if (start &lt; dataLen)</span>
<a href="#l3.306"></a><span id="l3.306">       start += len;</span>
<a href="#l3.307"></a><span id="l3.307">   }</span>
<a href="#l3.308"></a><span id="l3.308"> </span>
<a href="#l3.309"></a><span id="l3.309">   if (start &gt;= dataLen)</span>
<a href="#l3.310"></a><span id="l3.310">     return;</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineat">@@ -438,19 +447,18 @@ void nsEudoraCompose::GetHeaderValue( co</span>
<a href="#l3.312"></a><span id="l3.312"> </span>
<a href="#l3.313"></a><span id="l3.313">   while (end &lt; dataLen) {</span>
<a href="#l3.314"></a><span id="l3.314">     // Skip to next end of line.</span>
<a href="#l3.315"></a><span id="l3.315">     while ((end &lt; dataLen) &amp;&amp; (*pChar != nsCRT::CR) &amp;&amp; (*pChar != nsCRT::LF)) {</span>
<a href="#l3.316"></a><span id="l3.316">       end++;</span>
<a href="#l3.317"></a><span id="l3.317">       pChar++;</span>
<a href="#l3.318"></a><span id="l3.318">     }</span>
<a href="#l3.319"></a><span id="l3.319"> </span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-    if (end &gt; start) {</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-      val.Append( pData + start, end - start);</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-    }</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineplus">+    if (end &gt; start)</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+      val.Append(pData + start, end - start);</span>
<a href="#l3.325"></a><span id="l3.325"> </span>
<a href="#l3.326"></a><span id="l3.326">     lineEnd = end;</span>
<a href="#l3.327"></a><span id="l3.327">     pStart = pChar;</span>
<a href="#l3.328"></a><span id="l3.328"> </span>
<a href="#l3.329"></a><span id="l3.329">     // Skip over the end of line(s).</span>
<a href="#l3.330"></a><span id="l3.330">     while ((end &lt; dataLen) &amp;&amp;</span>
<a href="#l3.331"></a><span id="l3.331">            ((*pChar == nsCRT::CR) || (*pChar == nsCRT::LF))) {</span>
<a href="#l3.332"></a><span id="l3.332">       end++;</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineat">@@ -464,60 +472,60 @@ void nsEudoraCompose::GetHeaderValue( co</span>
<a href="#l3.334"></a><span id="l3.334">       end++;</span>
<a href="#l3.335"></a><span id="l3.335">       pChar++;</span>
<a href="#l3.336"></a><span id="l3.336">     }</span>
<a href="#l3.337"></a><span id="l3.337"> </span>
<a href="#l3.338"></a><span id="l3.338">     if (start == end)</span>
<a href="#l3.339"></a><span id="l3.339">       break;</span>
<a href="#l3.340"></a><span id="l3.340"> </span>
<a href="#l3.341"></a><span id="l3.341">     if (unwrap)</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineminus">-      val.Append( ' ');</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+      val.Append(' ');</span>
<a href="#l3.344"></a><span id="l3.344">     else {</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineminus">-      val.Append( pStart, end - lineEnd);</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineplus">+      val.Append(pStart, end - lineEnd);</span>
<a href="#l3.347"></a><span id="l3.347">     }</span>
<a href="#l3.348"></a><span id="l3.348"> </span>
<a href="#l3.349"></a><span id="l3.349">     start = end;</span>
<a href="#l3.350"></a><span id="l3.350">   }</span>
<a href="#l3.351"></a><span id="l3.351"> </span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-  val.Trim( kWhitespace);</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineplus">+  val.Trim(kWhitespace);</span>
<a href="#l3.354"></a><span id="l3.354"> }</span>
<a href="#l3.355"></a><span id="l3.355"> </span>
<a href="#l3.356"></a><span id="l3.356"> </span>
<a href="#l3.357"></a><span id="l3.357" class="difflineminus">-void nsEudoraCompose::ExtractCharset( nsString&amp; str)</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineplus">+void nsEudoraCompose::ExtractCharset(nsString&amp; str)</span>
<a href="#l3.359"></a><span id="l3.359"> {</span>
<a href="#l3.360"></a><span id="l3.360">   PRInt32 idx = MsgFind(str, &quot;charset=&quot;, true, 0);</span>
<a href="#l3.361"></a><span id="l3.361">   if (idx != -1) {</span>
<a href="#l3.362"></a><span id="l3.362">     str.Cut(0, idx + 8);</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineminus">-    idx = str.FindChar( ';');</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineplus">+    idx = str.FindChar(';');</span>
<a href="#l3.365"></a><span id="l3.365">     if (idx != -1)</span>
<a href="#l3.366"></a><span id="l3.366">       str.SetLength(idx);</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-    str.Trim( kWhitespace);</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineminus">-    if ((str.CharAt( 0) == '&quot;') &amp;&amp; (str.Length() &gt; 2)) {</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+    str.Trim(kWhitespace);</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineplus">+    if ((str.CharAt(0) == '&quot;') &amp;&amp; (str.Length() &gt; 2)) {</span>
<a href="#l3.371"></a><span id="l3.371">       str.SetLength(str.Length() - 1);</span>
<a href="#l3.372"></a><span id="l3.372">       str.Cut(0, 1);</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineminus">-      str.Trim( kWhitespace);</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+      str.Trim(kWhitespace);</span>
<a href="#l3.375"></a><span id="l3.375">     }</span>
<a href="#l3.376"></a><span id="l3.376">   }</span>
<a href="#l3.377"></a><span id="l3.377">   else</span>
<a href="#l3.378"></a><span id="l3.378">     str.Truncate();</span>
<a href="#l3.379"></a><span id="l3.379"> }</span>
<a href="#l3.380"></a><span id="l3.380"> </span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">-void nsEudoraCompose::ExtractType( nsString&amp; str)</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineplus">+void nsEudoraCompose::ExtractType(nsString&amp; str)</span>
<a href="#l3.383"></a><span id="l3.383"> {</span>
<a href="#l3.384"></a><span id="l3.384">   nsString tStr;</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-  PRInt32 idx = str.FindChar( ';');</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+  PRInt32 idx = str.FindChar(';');</span>
<a href="#l3.387"></a><span id="l3.387">   if (idx != -1)</span>
<a href="#l3.388"></a><span id="l3.388">     str.SetLength(idx);</span>
<a href="#l3.389"></a><span id="l3.389"> </span>
<a href="#l3.390"></a><span id="l3.390" class="difflineminus">-  str.Trim( kWhitespace);</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineplus">+  str.Trim(kWhitespace);</span>
<a href="#l3.392"></a><span id="l3.392"> </span>
<a href="#l3.393"></a><span id="l3.393" class="difflineminus">-  if ((str.CharAt( 0) == '&quot;') &amp;&amp; (str.Length() &gt; 2)) {</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineplus">+  if ((str.CharAt(0) == '&quot;') &amp;&amp; (str.Length() &gt; 2)) {</span>
<a href="#l3.395"></a><span id="l3.395">     str.SetLength(str.Length() - 1);</span>
<a href="#l3.396"></a><span id="l3.396">     str.Cut(0, 1);</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineminus">-    str.Trim( kWhitespace);</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineplus">+    str.Trim(kWhitespace);</span>
<a href="#l3.399"></a><span id="l3.399">   }</span>
<a href="#l3.400"></a><span id="l3.400"> </span>
<a href="#l3.401"></a><span id="l3.401">   // if multipart then ignore it since no outlook message body is ever</span>
<a href="#l3.402"></a><span id="l3.402">   // valid multipart!</span>
<a href="#l3.403"></a><span id="l3.403">   if (StringBeginsWith(str, NS_LITERAL_STRING(&quot;multipart/&quot;), nsCaseInsensitiveStringComparator()))</span>
<a href="#l3.404"></a><span id="l3.404">     str.Truncate();</span>
<a href="#l3.405"></a><span id="l3.405"> }</span>
<a href="#l3.406"></a><span id="l3.406"> </span>
<a href="#l3.407"></a><span id="l3.407" class="difflineat">@@ -540,99 +548,97 @@ nsresult nsEudoraCompose::GetLocalAttach</span>
<a href="#l3.408"></a><span id="l3.408">   ImportAttachment * pAttach;</span>
<a href="#l3.409"></a><span id="l3.409"> </span>
<a href="#l3.410"></a><span id="l3.410">   for (PRInt32 i = 0; i &lt; count; i++) {</span>
<a href="#l3.411"></a><span id="l3.411">     nsCOMPtr&lt;nsIMsgAttachedFile&gt; a(do_CreateInstance(NS_MSGATTACHEDFILE_CONTRACTID, &amp;rv));</span>
<a href="#l3.412"></a><span id="l3.412">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.413"></a><span id="l3.413">     // nsMsgNewURL(&amp;url, &quot;file://C:/boxster.jpg&quot;);</span>
<a href="#l3.414"></a><span id="l3.414">     // a[i].orig_url = url;</span>
<a href="#l3.415"></a><span id="l3.415"> </span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-    // NS_PRECONDITION( false, &quot;Forced Break&quot;);</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineminus">-    pAttach = (ImportAttachment *) m_pAttachments-&gt;ElementAt( i);</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineplus">+    pAttach = (ImportAttachment *) m_pAttachments-&gt;ElementAt(i);</span>
<a href="#l3.420"></a><span id="l3.420">     nsCOMPtr&lt;nsILocalFile&gt; tmpFile = do_QueryInterface(pAttach-&gt;pAttachment);</span>
<a href="#l3.421"></a><span id="l3.421">     a-&gt;SetTmpFile(tmpFile);</span>
<a href="#l3.422"></a><span id="l3.422">     urlStr.Adopt(0);</span>
<a href="#l3.423"></a><span id="l3.423"> </span>
<a href="#l3.424"></a><span id="l3.424">     nsCOMPtr &lt;nsIURI&gt; uri;</span>
<a href="#l3.425"></a><span id="l3.425">     nsresult rv = NS_NewFileURI(getter_AddRefs(uri), pAttach-&gt;pAttachment);</span>
<a href="#l3.426"></a><span id="l3.426">     NS_ENSURE_SUCCESS(rv, nsnull);</span>
<a href="#l3.427"></a><span id="l3.427">     uri-&gt;GetSpec(urlStr);</span>
<a href="#l3.428"></a><span id="l3.428">     if (urlStr.IsEmpty())</span>
<a href="#l3.429"></a><span id="l3.429">       return NS_ERROR_FAILURE;</span>
<a href="#l3.430"></a><span id="l3.430"> </span>
<a href="#l3.431"></a><span id="l3.431">     nsCOMPtr&lt;nsIURI&gt; origUrl;</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-    rv = m_pIOService-&gt;NewURI( urlStr, nsnull, nsnull, getter_AddRefs(origUrl));</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineplus">+    rv = m_pIOService-&gt;NewURI(urlStr, nsnull, nsnull, getter_AddRefs(origUrl));</span>
<a href="#l3.434"></a><span id="l3.434">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.435"></a><span id="l3.435">     a-&gt;SetOrigUrl(origUrl);</span>
<a href="#l3.436"></a><span id="l3.436">     a-&gt;SetType(nsDependentCString(pAttach-&gt;mimeType));</span>
<a href="#l3.437"></a><span id="l3.437">     a-&gt;SetRealName(nsDependentCString(pAttach-&gt;description));</span>
<a href="#l3.438"></a><span id="l3.438">     a-&gt;SetEncoding(NS_LITERAL_CSTRING(ENCODING_BINARY));</span>
<a href="#l3.439"></a><span id="l3.439">     attachments-&gt;AppendElement(a, false);</span>
<a href="#l3.440"></a><span id="l3.440">   }</span>
<a href="#l3.441"></a><span id="l3.441">   return NS_OK;</span>
<a href="#l3.442"></a><span id="l3.442"> }</span>
<a href="#l3.443"></a><span id="l3.443"> </span>
<a href="#l3.444"></a><span id="l3.444"> // Test a message send????</span>
<a href="#l3.445"></a><span id="l3.445"> nsresult nsEudoraCompose::SendTheMessage(nsIFile *pMailImportLocation, nsIFile **pMsg)</span>
<a href="#l3.446"></a><span id="l3.446"> {</span>
<a href="#l3.447"></a><span id="l3.447">   nsresult rv = CreateComponents();</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineminus">-    return( rv);</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineplus">+    return rv;</span>
<a href="#l3.452"></a><span id="l3.452"> </span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-  // IMPORT_LOG0( &quot;Outlook Compose created necessary components\n&quot;);</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineplus">+  // IMPORT_LOG0(&quot;Outlook Compose created necessary components\n&quot;);</span>
<a href="#l3.455"></a><span id="l3.455"> </span>
<a href="#l3.456"></a><span id="l3.456">   nsString bodyType;</span>
<a href="#l3.457"></a><span id="l3.457">   nsString charSet;</span>
<a href="#l3.458"></a><span id="l3.458">   nsString headerVal;</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineminus">-  GetHeaderValue( m_pHeaders, m_headerLen, &quot;From:&quot;, headerVal);</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineplus">+  GetHeaderValue(m_pHeaders, m_headerLen, &quot;From:&quot;, headerVal);</span>
<a href="#l3.461"></a><span id="l3.461">   if (!headerVal.IsEmpty())</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineminus">-    m_pMsgFields-&gt;SetFrom( headerVal);</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineminus">-  GetHeaderValue( m_pHeaders, m_headerLen, &quot;To:&quot;, headerVal);</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+    m_pMsgFields-&gt;SetFrom(headerVal);</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineplus">+  GetHeaderValue(m_pHeaders, m_headerLen, &quot;To:&quot;, headerVal);</span>
<a href="#l3.466"></a><span id="l3.466">   if (!headerVal.IsEmpty())</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineminus">-    m_pMsgFields-&gt;SetTo( headerVal);</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineminus">-  GetHeaderValue( m_pHeaders, m_headerLen, &quot;Subject:&quot;, headerVal);</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineplus">+    m_pMsgFields-&gt;SetTo(headerVal);</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineplus">+  GetHeaderValue(m_pHeaders, m_headerLen, &quot;Subject:&quot;, headerVal);</span>
<a href="#l3.471"></a><span id="l3.471">   if (!headerVal.IsEmpty())</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineminus">-    m_pMsgFields-&gt;SetSubject( headerVal);</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineminus">-  GetHeaderValue( m_pHeaders, m_headerLen, &quot;Content-type:&quot;, headerVal);</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineplus">+    m_pMsgFields-&gt;SetSubject(headerVal);</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineplus">+  GetHeaderValue(m_pHeaders, m_headerLen, &quot;Content-type:&quot;, headerVal);</span>
<a href="#l3.476"></a><span id="l3.476">   bodyType = headerVal;</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineminus">-  ExtractType( bodyType);</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineminus">-  ExtractCharset( headerVal);</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineplus">+  ExtractType(bodyType);</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineplus">+  ExtractCharset(headerVal);</span>
<a href="#l3.481"></a><span id="l3.481">   // Use platform charset as default if the msg doesn't specify one</span>
<a href="#l3.482"></a><span id="l3.482">   // (ie, no 'charset' param in the Content-Type: header). As the last</span>
<a href="#l3.483"></a><span id="l3.483">   // resort we'll use the mail default charset.</span>
<a href="#l3.484"></a><span id="l3.484">   // (ie, no 'charset' param in the Content-Type: header) or if the</span>
<a href="#l3.485"></a><span id="l3.485">   // charset parameter fails a length sanity check.</span>
<a href="#l3.486"></a><span id="l3.486">   // As the last resort we'll use the mail default charset.</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineminus">-  if ( headerVal.IsEmpty() || (headerVal.Length() &gt; kContentTypeLengthSanityCheck) )</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineplus">+  if (headerVal.IsEmpty() || (headerVal.Length() &gt; kContentTypeLengthSanityCheck))</span>
<a href="#l3.489"></a><span id="l3.489">   {</span>
<a href="#l3.490"></a><span id="l3.490">     headerVal.AssignASCII(nsMsgI18NFileSystemCharset());</span>
<a href="#l3.491"></a><span id="l3.491">     if (headerVal.IsEmpty())</span>
<a href="#l3.492"></a><span id="l3.492">     { // last resort</span>
<a href="#l3.493"></a><span id="l3.493">       if (m_defCharset.IsEmpty())</span>
<a href="#l3.494"></a><span id="l3.494">       {</span>
<a href="#l3.495"></a><span id="l3.495">         nsString defaultCharset;</span>
<a href="#l3.496"></a><span id="l3.496">         NS_GetLocalizedUnicharPreferenceWithDefault(nsnull, &quot;mailnews.view_default_charset&quot;,</span>
<a href="#l3.497"></a><span id="l3.497">                                                     NS_LITERAL_STRING(&quot;ISO-8859-1&quot;), defaultCharset);</span>
<a href="#l3.498"></a><span id="l3.498">         m_defCharset = defaultCharset;</span>
<a href="#l3.499"></a><span id="l3.499">       }</span>
<a href="#l3.500"></a><span id="l3.500">       headerVal = m_defCharset;</span>
<a href="#l3.501"></a><span id="l3.501">     }</span>
<a href="#l3.502"></a><span id="l3.502">   }</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineminus">-  m_pMsgFields-&gt;SetCharacterSet( NS_LossyConvertUTF16toASCII(headerVal).get() );</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineplus">+  m_pMsgFields-&gt;SetCharacterSet(NS_LossyConvertUTF16toASCII(headerVal).get());</span>
<a href="#l3.505"></a><span id="l3.505">   charSet = headerVal;</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineminus">-  GetHeaderValue( m_pHeaders, m_headerLen, &quot;CC:&quot;, headerVal);</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineplus">+  GetHeaderValue(m_pHeaders, m_headerLen, &quot;CC:&quot;, headerVal);</span>
<a href="#l3.508"></a><span id="l3.508">   if (!headerVal.IsEmpty())</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineminus">-    m_pMsgFields-&gt;SetCc( headerVal);</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineminus">-  GetHeaderValue( m_pHeaders, m_headerLen, &quot;Message-ID:&quot;, headerVal);</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineplus">+    m_pMsgFields-&gt;SetCc(headerVal);</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineplus">+  GetHeaderValue(m_pHeaders, m_headerLen, &quot;Message-ID:&quot;, headerVal);</span>
<a href="#l3.513"></a><span id="l3.513">   if (!headerVal.IsEmpty())</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineminus">-    m_pMsgFields-&gt;SetMessageId( NS_LossyConvertUTF16toASCII(headerVal).get() );</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineminus">-  GetHeaderValue( m_pHeaders, m_headerLen, &quot;Reply-To:&quot;, headerVal);</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineplus">+    m_pMsgFields-&gt;SetMessageId(NS_LossyConvertUTF16toASCII(headerVal).get());</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineplus">+  GetHeaderValue(m_pHeaders, m_headerLen, &quot;Reply-To:&quot;, headerVal);</span>
<a href="#l3.518"></a><span id="l3.518">   if (!headerVal.IsEmpty())</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineminus">-    m_pMsgFields-&gt;SetReplyTo( headerVal);</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineplus">+    m_pMsgFields-&gt;SetReplyTo(headerVal);</span>
<a href="#l3.521"></a><span id="l3.521"> </span>
<a href="#l3.522"></a><span id="l3.522">   // what about all of the other headers?!?!?!?!?!?!</span>
<a href="#l3.523"></a><span id="l3.523">   char *pMimeType;</span>
<a href="#l3.524"></a><span id="l3.524">   if (!bodyType.IsEmpty())</span>
<a href="#l3.525"></a><span id="l3.525">     pMimeType = ToNewCString(NS_LossyConvertUTF16toASCII(bodyType));</span>
<a href="#l3.526"></a><span id="l3.526">   else</span>
<a href="#l3.527"></a><span id="l3.527">     pMimeType = ToNewCString(m_bodyType);</span>
<a href="#l3.528"></a><span id="l3.528"> </span>
<a href="#l3.529"></a><span id="l3.529" class="difflineat">@@ -652,26 +658,24 @@ nsresult nsEudoraCompose::SendTheMessage</span>
<a href="#l3.530"></a><span id="l3.530">     *UNLESS* of course, I don't know what the charset of the message</span>
<a href="#l3.531"></a><span id="l3.531">     should be?  How do I determine what the charset should</span>
<a href="#l3.532"></a><span id="l3.532">     be if it doesn't exist?</span>
<a href="#l3.533"></a><span id="l3.533"> </span>
<a href="#l3.534"></a><span id="l3.534">   */</span>
<a href="#l3.535"></a><span id="l3.535"> </span>
<a href="#l3.536"></a><span id="l3.536">   nsCString body;</span>
<a href="#l3.537"></a><span id="l3.537"> </span>
<a href="#l3.538"></a><span id="l3.538" class="difflineminus">-  rv = nsMsgI18NConvertFromUnicode( NS_LossyConvertUTF16toASCII(charSet).get(),</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineplus">+  rv = nsMsgI18NConvertFromUnicode(NS_LossyConvertUTF16toASCII(charSet).get(),</span>
<a href="#l3.540"></a><span id="l3.540">                                     uniBody, body);</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineplus">+  if (NS_FAILED(rv) &amp;&amp; !charSet.Equals(m_defCharset)) {</span>
<a href="#l3.543"></a><span id="l3.543">     // in this case, if we did not use the default compose</span>
<a href="#l3.544"></a><span id="l3.544">     // charset, then try that.</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineminus">-    if (!charSet.Equals( m_defCharset)) {</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineminus">-      body.Truncate();</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineminus">-      rv = nsMsgI18NConvertFromUnicode( NS_LossyConvertUTF16toASCII(charSet).get(),</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineminus">-                                        uniBody, body);</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineminus">-    }</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineplus">+    body.Truncate();</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineplus">+    rv = nsMsgI18NConvertFromUnicode(NS_LossyConvertUTF16toASCII(charSet).get(),</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineplus">+                                     uniBody, body);</span>
<a href="#l3.553"></a><span id="l3.553">   }</span>
<a href="#l3.554"></a><span id="l3.554">   uniBody.Truncate();</span>
<a href="#l3.555"></a><span id="l3.555"> </span>
<a href="#l3.556"></a><span id="l3.556"> </span>
<a href="#l3.557"></a><span id="l3.557">   // See if it's a draft msg (ie, no From: or no To: AND no Cc: AND no Bcc:).</span>
<a href="#l3.558"></a><span id="l3.558">   // Eudora saves sent and draft msgs in Out folder (ie, mixed) and it does</span>
<a href="#l3.559"></a><span id="l3.559">   // store Bcc: header in the msg itself.</span>
<a href="#l3.560"></a><span id="l3.560">   nsAutoString from, to, cc, bcc;</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineat">@@ -691,294 +695,298 @@ nsresult nsEudoraCompose::SendTheMessage</span>
<a href="#l3.562"></a><span id="l3.562">                         body.get(),                   // body pointer</span>
<a href="#l3.563"></a><span id="l3.563">                         body.Length(),                // body length</span>
<a href="#l3.564"></a><span id="l3.564">                         createAsDraft,</span>
<a href="#l3.565"></a><span id="l3.565">                         pAttach,                      // local attachments</span>
<a href="#l3.566"></a><span id="l3.566">                         embeddedObjects,</span>
<a href="#l3.567"></a><span id="l3.567">                         m_pListener);                 // listener</span>
<a href="#l3.568"></a><span id="l3.568"> </span>
<a href="#l3.569"></a><span id="l3.569">   EudoraSendListener *pListen = (EudoraSendListener *)m_pListener;</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineminus">-    IMPORT_LOG1( &quot;*** Error, CreateAndSendMessage FAILED: 0x%lx\n&quot;, rv);</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineminus">-    // IMPORT_LOG1( &quot;Headers: %80s\n&quot;, m_pHeaders);</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineplus">+    IMPORT_LOG1(&quot;*** Error, CreateAndSendMessage FAILED: 0x%lx\n&quot;, rv);</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineplus">+    // IMPORT_LOG1(&quot;Headers: %80s\n&quot;, m_pHeaders);</span>
<a href="#l3.576"></a><span id="l3.576">   }</span>
<a href="#l3.577"></a><span id="l3.577">   else {</span>
<a href="#l3.578"></a><span id="l3.578">     // wait for the listener to get done!</span>
<a href="#l3.579"></a><span id="l3.579">     PRInt32 abortCnt = 0;</span>
<a href="#l3.580"></a><span id="l3.580">     PRInt32 cnt = 0;</span>
<a href="#l3.581"></a><span id="l3.581">     PRInt32 sleepCnt = 1;</span>
<a href="#l3.582"></a><span id="l3.582">     while (!pListen-&gt;m_done &amp;&amp; (abortCnt &lt; kHungAbortCount)) {</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineminus">-      PR_Sleep( sleepCnt);</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineplus">+      PR_Sleep(sleepCnt);</span>
<a href="#l3.585"></a><span id="l3.585">       cnt++;</span>
<a href="#l3.586"></a><span id="l3.586">       if (cnt &gt; kHungCount) {</span>
<a href="#l3.587"></a><span id="l3.587">         abortCnt++;</span>
<a href="#l3.588"></a><span id="l3.588">         sleepCnt *= 2;</span>
<a href="#l3.589"></a><span id="l3.589">         cnt = 0;</span>
<a href="#l3.590"></a><span id="l3.590">       }</span>
<a href="#l3.591"></a><span id="l3.591">     }</span>
<a href="#l3.592"></a><span id="l3.592"> </span>
<a href="#l3.593"></a><span id="l3.593">     if (abortCnt &gt;= kHungAbortCount) {</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineminus">-      IMPORT_LOG0( &quot;**** Create and send message hung\n&quot;);</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineminus">-      IMPORT_LOG1( &quot;Headers: %s\n&quot;, m_pHeaders);</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineminus">-      IMPORT_LOG1( &quot;Body: %s\n&quot;, m_pBody);</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineplus">+      IMPORT_LOG0(&quot;**** Create and send message hung\n&quot;);</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineplus">+      IMPORT_LOG1(&quot;Headers: %s\n&quot;, m_pHeaders);</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineplus">+      IMPORT_LOG1(&quot;Body: %s\n&quot;, m_pBody);</span>
<a href="#l3.600"></a><span id="l3.600">       rv = NS_ERROR_FAILURE;</span>
<a href="#l3.601"></a><span id="l3.601">     }</span>
<a href="#l3.602"></a><span id="l3.602"> </span>
<a href="#l3.603"></a><span id="l3.603">   }</span>
<a href="#l3.604"></a><span id="l3.604"> </span>
<a href="#l3.605"></a><span id="l3.605">   if (pMimeType)</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-    NS_Free( pMimeType);</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineplus">+    NS_Free(pMimeType);</span>
<a href="#l3.608"></a><span id="l3.608"> </span>
<a href="#l3.609"></a><span id="l3.609">   if (pListen-&gt;m_location) {</span>
<a href="#l3.610"></a><span id="l3.610">     pListen-&gt;m_location-&gt;Clone(pMsg);</span>
<a href="#l3.611"></a><span id="l3.611">     rv = NS_OK;</span>
<a href="#l3.612"></a><span id="l3.612">   }</span>
<a href="#l3.613"></a><span id="l3.613">   else {</span>
<a href="#l3.614"></a><span id="l3.614">     rv = NS_ERROR_FAILURE;</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error, Outlook compose unsuccessful\n&quot;);</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error, Outlook compose unsuccessful\n&quot;);</span>
<a href="#l3.617"></a><span id="l3.617">   }</span>
<a href="#l3.618"></a><span id="l3.618"> </span>
<a href="#l3.619"></a><span id="l3.619">   pListen-&gt;Reset();</span>
<a href="#l3.620"></a><span id="l3.620"> </span>
<a href="#l3.621"></a><span id="l3.621" class="difflineminus">-  return( rv);</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineplus">+  return rv;</span>
<a href="#l3.623"></a><span id="l3.623"> }</span>
<a href="#l3.624"></a><span id="l3.624"> </span>
<a href="#l3.625"></a><span id="l3.625"> </span>
<a href="#l3.626"></a><span id="l3.626" class="difflineminus">-bool SimpleBufferTonyRCopiedOnce::SpecialMemCpy( PRInt32 offset, const char *pData, PRInt32 len, PRInt32 *pWritten)</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineplus">+bool SimpleBufferTonyRCopiedOnce::SpecialMemCpy(PRInt32 offset, const char *pData, PRInt32 len, PRInt32 *pWritten)</span>
<a href="#l3.628"></a><span id="l3.628"> {</span>
<a href="#l3.629"></a><span id="l3.629">   // Arg!!!!!  Mozilla can't handle plain CRs in any mail messages.  Particularly a</span>
<a href="#l3.630"></a><span id="l3.630">   // problem with Eudora since it doesn't give a rats a**</span>
<a href="#l3.631"></a><span id="l3.631">   *pWritten = len;</span>
<a href="#l3.632"></a><span id="l3.632">   PRInt32  sz = offset + len;</span>
<a href="#l3.633"></a><span id="l3.633">   if (offset) {</span>
<a href="#l3.634"></a><span id="l3.634">     if ((m_pBuffer[offset - 1] == nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF)) {</span>
<a href="#l3.635"></a><span id="l3.635">       sz++;</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineminus">-      if (!Grow( sz)) return( false);</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineplus">+      if (!Grow(sz))</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineplus">+        return false;</span>
<a href="#l3.639"></a><span id="l3.639">       m_pBuffer[offset] = nsCRT::LF;</span>
<a href="#l3.640"></a><span id="l3.640">       offset++;</span>
<a href="#l3.641"></a><span id="l3.641">       (*pWritten)++;</span>
<a href="#l3.642"></a><span id="l3.642">     }</span>
<a href="#l3.643"></a><span id="l3.643">   }</span>
<a href="#l3.644"></a><span id="l3.644">   while (len &gt; 0) {</span>
<a href="#l3.645"></a><span id="l3.645">     if ((*pData == nsCRT::CR) &amp;&amp; (*(pData + 1) != nsCRT::LF)) {</span>
<a href="#l3.646"></a><span id="l3.646">       sz++;</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineminus">-      if (!Grow( sz)) return( false);</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineplus">+      if (!Grow(sz))</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineplus">+        return false;</span>
<a href="#l3.650"></a><span id="l3.650">       m_pBuffer[offset] = nsCRT::CR;</span>
<a href="#l3.651"></a><span id="l3.651">       offset++;</span>
<a href="#l3.652"></a><span id="l3.652">       m_pBuffer[offset] = nsCRT::LF;</span>
<a href="#l3.653"></a><span id="l3.653">       (*pWritten)++;</span>
<a href="#l3.654"></a><span id="l3.654">     }</span>
<a href="#l3.655"></a><span id="l3.655">     else {</span>
<a href="#l3.656"></a><span id="l3.656">       m_pBuffer[offset] = *pData;</span>
<a href="#l3.657"></a><span id="l3.657">     }</span>
<a href="#l3.658"></a><span id="l3.658">     offset++;</span>
<a href="#l3.659"></a><span id="l3.659">     pData++;</span>
<a href="#l3.660"></a><span id="l3.660">     len--;</span>
<a href="#l3.661"></a><span id="l3.661">   }</span>
<a href="#l3.662"></a><span id="l3.662"> </span>
<a href="#l3.663"></a><span id="l3.663" class="difflineminus">-  return( true);</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineplus">+  return true;</span>
<a href="#l3.665"></a><span id="l3.665"> }</span>
<a href="#l3.666"></a><span id="l3.666"> </span>
<a href="#l3.667"></a><span id="l3.667" class="difflineminus">-nsresult nsEudoraCompose::ReadHeaders( ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; copy, SimpleBufferTonyRCopiedOnce&amp; header)</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineplus">+nsresult nsEudoraCompose::ReadHeaders(ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; copy, SimpleBufferTonyRCopiedOnce&amp; header)</span>
<a href="#l3.669"></a><span id="l3.669"> {</span>
<a href="#l3.670"></a><span id="l3.670">   // This should be the headers...</span>
<a href="#l3.671"></a><span id="l3.671">   header.m_writeOffset = 0;</span>
<a href="#l3.672"></a><span id="l3.672"> </span>
<a href="#l3.673"></a><span id="l3.673">   nsresult rv;</span>
<a href="#l3.674"></a><span id="l3.674">   PRInt32 lineLen;</span>
<a href="#l3.675"></a><span id="l3.675">   PRInt32 endLen = -1;</span>
<a href="#l3.676"></a><span id="l3.676">   PRInt8 endBuffer = 0;</span>
<a href="#l3.677"></a><span id="l3.677"> </span>
<a href="#l3.678"></a><span id="l3.678" class="difflineminus">-  while ((endLen = IsEndHeaders( copy)) == -1) {</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineminus">-    while ((lineLen = FindNextEndLine( copy)) == -1) {</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineplus">+  while ((endLen = IsEndHeaders(copy)) == -1) {</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineplus">+    while ((lineLen = FindNextEndLine(copy)) == -1) {</span>
<a href="#l3.682"></a><span id="l3.682">       copy.m_writeOffset = copy.m_bytesInBuf;</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineminus">-      if (!header.Write( copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineminus">-        IMPORT_LOG0( &quot;*** ERROR, writing headers\n&quot;);</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineminus">-        return( NS_ERROR_FAILURE);</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineplus">+      if (!header.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineplus">+        IMPORT_LOG0(&quot;*** ERROR, writing headers\n&quot;);</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l3.689"></a><span id="l3.689">       }</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineminus">-      if (NS_FAILED( rv = FillMailBuffer( pState, copy))) {</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error reading message headers\n&quot;);</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineminus">-        return( rv);</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineplus">+      if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineplus">+        IMPORT_LOG0(&quot;*** Error reading message headers\n&quot;);</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineplus">+        return rv;</span>
<a href="#l3.696"></a><span id="l3.696">       }</span>
<a href="#l3.697"></a><span id="l3.697">       if (!copy.m_bytesInBuf) {</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error, end of file while reading headers\n&quot;);</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineminus">-        return( NS_ERROR_FAILURE);</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineplus">+        IMPORT_LOG0(&quot;*** Error, end of file while reading headers\n&quot;);</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l3.702"></a><span id="l3.702">       }</span>
<a href="#l3.703"></a><span id="l3.703">     }</span>
<a href="#l3.704"></a><span id="l3.704">     copy.m_writeOffset += lineLen;</span>
<a href="#l3.705"></a><span id="l3.705">     if ((copy.m_writeOffset + 4) &gt;= copy.m_bytesInBuf) {</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineminus">-      if (!header.Write( copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineminus">-        IMPORT_LOG0( &quot;*** ERROR, writing headers 2\n&quot;);</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineminus">-        return( NS_ERROR_FAILURE);</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineplus">+      if (!header.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineplus">+        IMPORT_LOG0(&quot;*** ERROR, writing headers 2\n&quot;);</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l3.712"></a><span id="l3.712">       }</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineminus">-      if (NS_FAILED( rv = FillMailBuffer( pState, copy))) {</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error reading message headers 2\n&quot;);</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineminus">-        return( rv);</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineplus">+      if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineplus">+        IMPORT_LOG0(&quot;*** Error reading message headers 2\n&quot;);</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineplus">+        return rv;</span>
<a href="#l3.719"></a><span id="l3.719">       }</span>
<a href="#l3.720"></a><span id="l3.720">     }</span>
<a href="#l3.721"></a><span id="l3.721">   }</span>
<a href="#l3.722"></a><span id="l3.722"> </span>
<a href="#l3.723"></a><span id="l3.723" class="difflineminus">-  if (!header.Write( copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error writing final headers\n&quot;);</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineplus">+  if (!header.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error writing final headers\n&quot;);</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l3.729"></a><span id="l3.729">   }</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineminus">-  if (!header.Write( (const char *)&amp;endBuffer, 1)) {</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error writing header trailing null\n&quot;);</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineplus">+  if (!header.Write((const char *)&amp;endBuffer, 1)) {</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error writing header trailing null\n&quot;);</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l3.736"></a><span id="l3.736">   }</span>
<a href="#l3.737"></a><span id="l3.737"> </span>
<a href="#l3.738"></a><span id="l3.738">   copy.m_writeOffset += endLen;</span>
<a href="#l3.739"></a><span id="l3.739"> </span>
<a href="#l3.740"></a><span id="l3.740" class="difflineminus">-  return( NS_OK);</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.742"></a><span id="l3.742"> }</span>
<a href="#l3.743"></a><span id="l3.743"> </span>
<a href="#l3.744"></a><span id="l3.744" class="difflineminus">-PRInt32 nsEudoraCompose::FindNextEndLine( SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineplus">+PRInt32 nsEudoraCompose::FindNextEndLine(SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l3.746"></a><span id="l3.746"> {</span>
<a href="#l3.747"></a><span id="l3.747">   PRInt32 len = data.m_bytesInBuf - data.m_writeOffset;</span>
<a href="#l3.748"></a><span id="l3.748">   if (!len)</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineminus">-    return( -1);</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineplus">+    return -1;</span>
<a href="#l3.751"></a><span id="l3.751"> </span>
<a href="#l3.752"></a><span id="l3.752">   PRInt32 count = 0;</span>
<a href="#l3.753"></a><span id="l3.753">   const char *pData = data.m_pBuffer + data.m_writeOffset;</span>
<a href="#l3.754"></a><span id="l3.754">   // Skip over end of line(s).</span>
<a href="#l3.755"></a><span id="l3.755">   while ((count &lt; len) &amp;&amp; ((*pData == nsCRT::CR) || (*pData == nsCRT::LF))) {</span>
<a href="#l3.756"></a><span id="l3.756">     pData++;</span>
<a href="#l3.757"></a><span id="l3.757">     count++;</span>
<a href="#l3.758"></a><span id="l3.758">   }</span>
<a href="#l3.759"></a><span id="l3.759">   // Skip to next end of line.</span>
<a href="#l3.760"></a><span id="l3.760">   while ((count &lt; len) &amp;&amp; (*pData != nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF)) {</span>
<a href="#l3.761"></a><span id="l3.761">     pData++;</span>
<a href="#l3.762"></a><span id="l3.762">     count++;</span>
<a href="#l3.763"></a><span id="l3.763">   }</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineminus">-  if (count &lt; len)</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineminus">-    return( count);</span>
<a href="#l3.766"></a><span id="l3.766"> </span>
<a href="#l3.767"></a><span id="l3.767" class="difflineminus">-  return( -1);</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineplus">+  return (count &lt; len) ? count : -1;</span>
<a href="#l3.769"></a><span id="l3.769"> }</span>
<a href="#l3.770"></a><span id="l3.770"> </span>
<a href="#l3.771"></a><span id="l3.771" class="difflineminus">-PRInt32 nsEudoraCompose::IsEndHeaders( SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineplus">+PRInt32 nsEudoraCompose::IsEndHeaders(SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l3.773"></a><span id="l3.773"> {</span>
<a href="#l3.774"></a><span id="l3.774">   PRInt32 len = data.m_bytesInBuf - data.m_writeOffset;</span>
<a href="#l3.775"></a><span id="l3.775">   if (len &lt; 2)</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineminus">-    return( -1);</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineplus">+    return -1;</span>
<a href="#l3.778"></a><span id="l3.778"> </span>
<a href="#l3.779"></a><span id="l3.779">   const char *pChar = data.m_pBuffer + data.m_writeOffset;</span>
<a href="#l3.780"></a><span id="l3.780">   // Double nsCRT::CR.</span>
<a href="#l3.781"></a><span id="l3.781">   if ((*pChar == nsCRT::CR) &amp;&amp; (*(pChar + 1) == nsCRT::CR))</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineminus">-    return( 2);</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineplus">+    return 2;</span>
<a href="#l3.784"></a><span id="l3.784"> </span>
<a href="#l3.785"></a><span id="l3.785">   if (len &lt; 4)</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineminus">-    return( -1);</span>
<a href="#l3.787"></a><span id="l3.787" class="difflineplus">+    return -1;</span>
<a href="#l3.788"></a><span id="l3.788"> </span>
<a href="#l3.789"></a><span id="l3.789">   // Double (nsCRT::CR + nsCRT::LF).</span>
<a href="#l3.790"></a><span id="l3.790">   if ((*pChar == nsCRT::CR) &amp;&amp; (*(pChar + 1) == nsCRT::LF) &amp;&amp;</span>
<a href="#l3.791"></a><span id="l3.791">       (*(pChar + 2) == nsCRT::CR) &amp;&amp; (*(pChar + 3) == nsCRT::LF))</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineminus">-    return( 4);</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineplus">+    return 4;</span>
<a href="#l3.794"></a><span id="l3.794"> </span>
<a href="#l3.795"></a><span id="l3.795" class="difflineminus">-  return( -1);</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineplus">+  return -1;</span>
<a href="#l3.797"></a><span id="l3.797"> }</span>
<a href="#l3.798"></a><span id="l3.798"> </span>
<a href="#l3.799"></a><span id="l3.799"> </span>
<a href="#l3.800"></a><span id="l3.800" class="difflineminus">-nsresult nsEudoraCompose::CopyComposedMessage( nsCString&amp; fromLine, nsIFile *pSrc, nsIOutputStream *pDst, SimpleBufferTonyRCopiedOnce&amp; copy)</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineplus">+nsresult nsEudoraCompose::CopyComposedMessage(nsCString&amp; fromLine,</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineplus">+                                              nsIFile *pSrc,</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineplus">+                                              nsIOutputStream *pDst,</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineplus">+                                              SimpleBufferTonyRCopiedOnce&amp; copy)</span>
<a href="#l3.805"></a><span id="l3.805"> {</span>
<a href="#l3.806"></a><span id="l3.806">   copy.m_bytesInBuf = 0;</span>
<a href="#l3.807"></a><span id="l3.807">   copy.m_writeOffset = 0;</span>
<a href="#l3.808"></a><span id="l3.808">   ReadFileState  state;</span>
<a href="#l3.809"></a><span id="l3.809">   state.pFile = pSrc;</span>
<a href="#l3.810"></a><span id="l3.810">   state.offset = 0;</span>
<a href="#l3.811"></a><span id="l3.811">   state.size = 0;</span>
<a href="#l3.812"></a><span id="l3.812"> </span>
<a href="#l3.813"></a><span id="l3.813" class="difflineminus">-  pSrc-&gt;GetFileSize( &amp;state.size);</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineplus">+  pSrc-&gt;GetFileSize(&amp;state.size);</span>
<a href="#l3.815"></a><span id="l3.815">   if (!state.size) {</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error, unexpected zero file size for composed message\n&quot;);</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error, unexpected zero file size for composed message\n&quot;);</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l3.820"></a><span id="l3.820">   }</span>
<a href="#l3.821"></a><span id="l3.821"> </span>
<a href="#l3.822"></a><span id="l3.822">         nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(state.pInputStream), pSrc);</span>
<a href="#l3.823"></a><span id="l3.823"> </span>
<a href="#l3.824"></a><span id="l3.824" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error, unable to open composed message file\n&quot;);</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error, unable to open composed message file\n&quot;);</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l3.830"></a><span id="l3.830">   }</span>
<a href="#l3.831"></a><span id="l3.831"> </span>
<a href="#l3.832"></a><span id="l3.832">   PRUint32 written;</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineminus">-  rv = pDst-&gt;Write( fromLine.get(), fromLine.Length(), &amp;written);</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineplus">+  rv = pDst-&gt;Write(fromLine.get(), fromLine.Length(), &amp;written);</span>
<a href="#l3.835"></a><span id="l3.835"> </span>
<a href="#l3.836"></a><span id="l3.836">   // well, isn't this a hoot!</span>
<a href="#l3.837"></a><span id="l3.837">   // Read the headers from the new message, get the ones we like</span>
<a href="#l3.838"></a><span id="l3.838">   // and write out only the headers we want from the new message,</span>
<a href="#l3.839"></a><span id="l3.839">   // along with all of the other headers from the &quot;old&quot; message!</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l3.841"></a><span id="l3.841" class="difflineminus">-    rv = FillMailBuffer( &amp;state, copy);</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineminus">-    rv = ReadHeaders( &amp;state, copy, m_readHeaders);</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineplus">+    rv = FillMailBuffer(&amp;state, copy);</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineplus">+    rv = ReadHeaders(&amp;state, copy, m_readHeaders);</span>
<a href="#l3.848"></a><span id="l3.848"> </span>
<a href="#l3.849"></a><span id="l3.849" class="difflineminus">-  if (NS_SUCCEEDED( rv)) {</span>
<a href="#l3.850"></a><span id="l3.850" class="difflineminus">-    rv = WriteHeaders( pDst, m_readHeaders);</span>
<a href="#l3.851"></a><span id="l3.851" class="difflineminus">-  }</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l3.853"></a><span id="l3.853" class="difflineplus">+    rv = WriteHeaders(pDst, m_readHeaders);</span>
<a href="#l3.854"></a><span id="l3.854"> </span>
<a href="#l3.855"></a><span id="l3.855">   // We need to go ahead and write out the rest of the copy buffer</span>
<a href="#l3.856"></a><span id="l3.856">   // so that the following will properly copy the rest of the body</span>
<a href="#l3.857"></a><span id="l3.857">   char lastChar = 0;</span>
<a href="#l3.858"></a><span id="l3.858"> </span>
<a href="#l3.859"></a><span id="l3.859">   rv = EscapeFromSpaceLine(pDst, copy.m_pBuffer + copy.m_writeOffset, copy.m_pBuffer+copy.m_bytesInBuf);</span>
<a href="#l3.860"></a><span id="l3.860">   if (copy.m_bytesInBuf)</span>
<a href="#l3.861"></a><span id="l3.861">     lastChar = copy.m_pBuffer[copy.m_bytesInBuf - 1];</span>
<a href="#l3.862"></a><span id="l3.862">   if (NS_SUCCEEDED(rv))</span>
<a href="#l3.863"></a><span id="l3.863">     copy.m_writeOffset = copy.m_bytesInBuf;</span>
<a href="#l3.864"></a><span id="l3.864"> </span>
<a href="#l3.865"></a><span id="l3.865" class="difflineminus">-  while ((state.offset &lt; state.size) &amp;&amp; NS_SUCCEEDED( rv)) {</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineminus">-    rv = FillMailBuffer( &amp;state, copy);</span>
<a href="#l3.867"></a><span id="l3.867" class="difflineminus">-    if (NS_SUCCEEDED( rv)) {</span>
<a href="#l3.868"></a><span id="l3.868" class="difflineplus">+  while ((state.offset &lt; state.size) &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineplus">+    rv = FillMailBuffer(&amp;state, copy);</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.871"></a><span id="l3.871">       rv = EscapeFromSpaceLine(pDst, copy.m_pBuffer + copy.m_writeOffset, copy.m_pBuffer+copy.m_bytesInBuf);</span>
<a href="#l3.872"></a><span id="l3.872">       lastChar = copy.m_pBuffer[copy.m_bytesInBuf - 1];</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineminus">-      if (NS_SUCCEEDED( rv))</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l3.875"></a><span id="l3.875">         copy.m_writeOffset = copy.m_bytesInBuf;</span>
<a href="#l3.876"></a><span id="l3.876">       else</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error writing to destination mailbox\n&quot;);</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineplus">+        IMPORT_LOG0(&quot;*** Error writing to destination mailbox\n&quot;);</span>
<a href="#l3.879"></a><span id="l3.879">     }</span>
<a href="#l3.880"></a><span id="l3.880">   }</span>
<a href="#l3.881"></a><span id="l3.881"> </span>
<a href="#l3.882"></a><span id="l3.882">   state.pInputStream-&gt;Close();</span>
<a href="#l3.883"></a><span id="l3.883"> </span>
<a href="#l3.884"></a><span id="l3.884">   if ((lastChar != nsCRT::LF) &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineminus">-    rv = pDst-&gt;Write( &quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l3.886"></a><span id="l3.886" class="difflineplus">+    rv = pDst-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l3.887"></a><span id="l3.887">     if (written != 2)</span>
<a href="#l3.888"></a><span id="l3.888">       rv = NS_ERROR_FAILURE;</span>
<a href="#l3.889"></a><span id="l3.889">   }</span>
<a href="#l3.890"></a><span id="l3.890"> </span>
<a href="#l3.891"></a><span id="l3.891" class="difflineminus">-  return( rv);</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineplus">+  return rv;</span>
<a href="#l3.893"></a><span id="l3.893"> }</span>
<a href="#l3.894"></a><span id="l3.894"> </span>
<a href="#l3.895"></a><span id="l3.895" class="difflineminus">-nsresult nsEudoraCompose::FillMailBuffer( ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; read)</span>
<a href="#l3.896"></a><span id="l3.896" class="difflineplus">+nsresult nsEudoraCompose::FillMailBuffer(ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; read)</span>
<a href="#l3.897"></a><span id="l3.897"> {</span>
<a href="#l3.898"></a><span id="l3.898">   if (read.m_writeOffset &gt;= read.m_bytesInBuf) {</span>
<a href="#l3.899"></a><span id="l3.899">     read.m_writeOffset = 0;</span>
<a href="#l3.900"></a><span id="l3.900">     read.m_bytesInBuf = 0;</span>
<a href="#l3.901"></a><span id="l3.901">   }</span>
<a href="#l3.902"></a><span id="l3.902">   else if (read.m_writeOffset) {</span>
<a href="#l3.903"></a><span id="l3.903" class="difflineminus">-    memcpy( read.m_pBuffer, read.m_pBuffer + read.m_writeOffset, read.m_bytesInBuf - read.m_writeOffset);</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineplus">+    memcpy(read.m_pBuffer, read.m_pBuffer + read.m_writeOffset, read.m_bytesInBuf - read.m_writeOffset);</span>
<a href="#l3.905"></a><span id="l3.905">     read.m_bytesInBuf -= read.m_writeOffset;</span>
<a href="#l3.906"></a><span id="l3.906">     read.m_writeOffset = 0;</span>
<a href="#l3.907"></a><span id="l3.907">   }</span>
<a href="#l3.908"></a><span id="l3.908"> </span>
<a href="#l3.909"></a><span id="l3.909">   PRUint32 count = read.m_size - read.m_bytesInBuf;</span>
<a href="#l3.910"></a><span id="l3.910">   if ((count + pState-&gt;offset) &gt; pState-&gt;size)</span>
<a href="#l3.911"></a><span id="l3.911">     count = pState-&gt;size - pState-&gt;offset;</span>
<a href="#l3.912"></a><span id="l3.912">   if (count) {</span>
<a href="#l3.913"></a><span id="l3.913">     PRUint32 bytesRead = 0;</span>
<a href="#l3.914"></a><span id="l3.914">     char * pBuffer = read.m_pBuffer + read.m_bytesInBuf;</span>
<a href="#l3.915"></a><span id="l3.915">     nsresult rv = pState-&gt;pInputStream-&gt;Read(pBuffer, count, &amp;bytesRead);</span>
<a href="#l3.916"></a><span id="l3.916" class="difflineminus">-    if (NS_FAILED( rv)) return( rv);</span>
<a href="#l3.917"></a><span id="l3.917" class="difflineminus">-    if (bytesRead != count) return( NS_ERROR_FAILURE);</span>
<a href="#l3.918"></a><span id="l3.918" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l3.919"></a><span id="l3.919" class="difflineplus">+      return rv;</span>
<a href="#l3.920"></a><span id="l3.920" class="difflineplus">+    if (bytesRead != count)</span>
<a href="#l3.921"></a><span id="l3.921" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l3.922"></a><span id="l3.922">     read.m_bytesInBuf += bytesRead;</span>
<a href="#l3.923"></a><span id="l3.923">     pState-&gt;offset += bytesRead;</span>
<a href="#l3.924"></a><span id="l3.924">   }</span>
<a href="#l3.925"></a><span id="l3.925"> </span>
<a href="#l3.926"></a><span id="l3.926" class="difflineminus">-  return( NS_OK);</span>
<a href="#l3.927"></a><span id="l3.927" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.928"></a><span id="l3.928"> }</span>
<a href="#l3.929"></a><span id="l3.929"> </span>
<a href="#l3.930"></a><span id="l3.930"> </span>
<a href="#l3.931"></a><span id="l3.931"> #define kMaxSpecialHeaders 3</span>
<a href="#l3.932"></a><span id="l3.932"> static const char *gSpecialHeaders[kMaxSpecialHeaders] = {</span>
<a href="#l3.933"></a><span id="l3.933">   &quot;Content-type&quot;,</span>
<a href="#l3.934"></a><span id="l3.934">   &quot;MIME-Version&quot;,</span>
<a href="#l3.935"></a><span id="l3.935">   &quot;Content-transfer-encoding&quot;</span>
<a href="#l3.936"></a><span id="l3.936" class="difflineat">@@ -989,34 +997,34 @@ static const char *gSpecialHeaders[kMaxS</span>
<a href="#l3.937"></a><span id="l3.937"> static const char *gReplaceHeaders[kMaxReplaceHeaders] = {</span>
<a href="#l3.938"></a><span id="l3.938">   &quot;From&quot;,</span>
<a href="#l3.939"></a><span id="l3.939">   &quot;To&quot;,</span>
<a href="#l3.940"></a><span id="l3.940">   &quot;Subject&quot;,</span>
<a href="#l3.941"></a><span id="l3.941">   &quot;Reply-to&quot;,</span>
<a href="#l3.942"></a><span id="l3.942">   &quot;cc&quot;</span>
<a href="#l3.943"></a><span id="l3.943"> };</span>
<a href="#l3.944"></a><span id="l3.944"> </span>
<a href="#l3.945"></a><span id="l3.945" class="difflineminus">-bool nsEudoraCompose::IsReplaceHeader( const char *pHeader)</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineplus">+bool nsEudoraCompose::IsReplaceHeader(const char *pHeader)</span>
<a href="#l3.947"></a><span id="l3.947"> {</span>
<a href="#l3.948"></a><span id="l3.948">   for (int i = 0; i &lt; kMaxReplaceHeaders; i++) {</span>
<a href="#l3.949"></a><span id="l3.949" class="difflineminus">-    if (!PL_strcasecmp( pHeader, gReplaceHeaders[i]))</span>
<a href="#l3.950"></a><span id="l3.950" class="difflineminus">-      return( true);</span>
<a href="#l3.951"></a><span id="l3.951" class="difflineplus">+    if (!PL_strcasecmp(pHeader, gReplaceHeaders[i]))</span>
<a href="#l3.952"></a><span id="l3.952" class="difflineplus">+      return true;</span>
<a href="#l3.953"></a><span id="l3.953">   }</span>
<a href="#l3.954"></a><span id="l3.954"> </span>
<a href="#l3.955"></a><span id="l3.955" class="difflineminus">-  return( false);</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineplus">+  return false;</span>
<a href="#l3.957"></a><span id="l3.957"> }</span>
<a href="#l3.958"></a><span id="l3.958"> </span>
<a href="#l3.959"></a><span id="l3.959" class="difflineminus">-PRInt32 nsEudoraCompose::IsSpecialHeader( const char *pHeader)</span>
<a href="#l3.960"></a><span id="l3.960" class="difflineplus">+PRInt32 nsEudoraCompose::IsSpecialHeader(const char *pHeader)</span>
<a href="#l3.961"></a><span id="l3.961"> {</span>
<a href="#l3.962"></a><span id="l3.962">   for (int i = 0; i &lt; kMaxSpecialHeaders; i++) {</span>
<a href="#l3.963"></a><span id="l3.963" class="difflineminus">-    if (!PL_strcasecmp( pHeader, gSpecialHeaders[i]))</span>
<a href="#l3.964"></a><span id="l3.964" class="difflineminus">-      return( (PRInt32) i);</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineplus">+    if (!PL_strcasecmp(pHeader, gSpecialHeaders[i]))</span>
<a href="#l3.966"></a><span id="l3.966" class="difflineplus">+      return (PRInt32) i;</span>
<a href="#l3.967"></a><span id="l3.967">   }</span>
<a href="#l3.968"></a><span id="l3.968"> </span>
<a href="#l3.969"></a><span id="l3.969" class="difflineminus">-  return( -1);</span>
<a href="#l3.970"></a><span id="l3.970" class="difflineplus">+  return -1;</span>
<a href="#l3.971"></a><span id="l3.971"> }</span>
<a href="#l3.972"></a><span id="l3.972"> </span>
<a href="#l3.973"></a><span id="l3.973"> </span>
<a href="#l3.974"></a><span id="l3.974"> nsresult nsEudoraCompose::WriteHeaders(nsIOutputStream *pDst, SimpleBufferTonyRCopiedOnce&amp; newHeaders)</span>
<a href="#l3.975"></a><span id="l3.975"> {</span>
<a href="#l3.976"></a><span id="l3.976">   // Well, ain't this a peach?</span>
<a href="#l3.977"></a><span id="l3.977">   // This is rather disgusting but there really isn't much to be done about it....</span>
<a href="#l3.978"></a><span id="l3.978"> </span>
<a href="#l3.979"></a><span id="l3.979" class="difflineat">@@ -1037,74 +1045,77 @@ nsresult nsEudoraCompose::WriteHeaders(n</span>
<a href="#l3.980"></a><span id="l3.980">   int i;</span>
<a href="#l3.981"></a><span id="l3.981"> </span>
<a href="#l3.982"></a><span id="l3.982">   for (i = 0; i &lt; kMaxSpecialHeaders; i++)</span>
<a href="#l3.983"></a><span id="l3.983">     specials[i] = false;</span>
<a href="#l3.984"></a><span id="l3.984"> </span>
<a href="#l3.985"></a><span id="l3.985">   // m_pHeaders - contains headers from a Eudora msg.</span>
<a href="#l3.986"></a><span id="l3.986">   // newHeaders - contains headers from a mozilla msg (more headers here).</span>
<a href="#l3.987"></a><span id="l3.987">   do {</span>
<a href="#l3.988"></a><span id="l3.988" class="difflineminus">-    GetNthHeader( m_pHeaders, m_headerLen, n, header, val, false);</span>
<a href="#l3.989"></a><span id="l3.989" class="difflineminus">-    // GetNthHeader( newHeaders.m_pBuffer, newHeaders.m_writeOffset, n, header, val, false);</span>
<a href="#l3.990"></a><span id="l3.990" class="difflineplus">+    GetNthHeader(m_pHeaders, m_headerLen, n, header, val, false);</span>
<a href="#l3.991"></a><span id="l3.991" class="difflineplus">+    // GetNthHeader(newHeaders.m_pBuffer, newHeaders.m_writeOffset, n, header, val, false);</span>
<a href="#l3.992"></a><span id="l3.992">     if (!header.IsEmpty()) {</span>
<a href="#l3.993"></a><span id="l3.993" class="difflineminus">-      if ((specialHeader = IsSpecialHeader( header.get())) != -1) {</span>
<a href="#l3.994"></a><span id="l3.994" class="difflineminus">-        header.Append( ':');</span>
<a href="#l3.995"></a><span id="l3.995" class="difflineminus">-        GetHeaderValue( newHeaders.m_pBuffer, newHeaders.m_writeOffset - 1, header.get(), val, false);</span>
<a href="#l3.996"></a><span id="l3.996" class="difflineminus">-        header.SetLength( header.Length() - 1);</span>
<a href="#l3.997"></a><span id="l3.997" class="difflineplus">+      if ((specialHeader = IsSpecialHeader(header.get())) != -1) {</span>
<a href="#l3.998"></a><span id="l3.998" class="difflineplus">+        header.Append(':');</span>
<a href="#l3.999"></a><span id="l3.999" class="difflineplus">+        GetHeaderValue(newHeaders.m_pBuffer, newHeaders.m_writeOffset - 1,</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineplus">+                       header.get(), val, false);</span>
<a href="#l3.1001"></a><span id="l3.1001" class="difflineplus">+        header.SetLength(header.Length() - 1);</span>
<a href="#l3.1002"></a><span id="l3.1002">         specials[specialHeader] = true;</span>
<a href="#l3.1003"></a><span id="l3.1003">       }</span>
<a href="#l3.1004"></a><span id="l3.1004" class="difflineminus">-      else if (IsReplaceHeader( header.get())) {</span>
<a href="#l3.1005"></a><span id="l3.1005" class="difflineplus">+      else if (IsReplaceHeader(header.get())) {</span>
<a href="#l3.1006"></a><span id="l3.1006">         replaceVal.Truncate();</span>
<a href="#l3.1007"></a><span id="l3.1007" class="difflineminus">-        header.Append( ':');</span>
<a href="#l3.1008"></a><span id="l3.1008" class="difflineminus">-        GetHeaderValue( newHeaders.m_pBuffer, newHeaders.m_writeOffset - 1, header.get(), replaceVal, false);</span>
<a href="#l3.1009"></a><span id="l3.1009" class="difflineminus">-        header.SetLength( header.Length() - 1);</span>
<a href="#l3.1010"></a><span id="l3.1010" class="difflineplus">+        header.Append(':');</span>
<a href="#l3.1011"></a><span id="l3.1011" class="difflineplus">+        GetHeaderValue(newHeaders.m_pBuffer, newHeaders.m_writeOffset - 1,</span>
<a href="#l3.1012"></a><span id="l3.1012" class="difflineplus">+                       header.get(), replaceVal, false);</span>
<a href="#l3.1013"></a><span id="l3.1013" class="difflineplus">+        header.SetLength(header.Length() - 1);</span>
<a href="#l3.1014"></a><span id="l3.1014">         if (!replaceVal.IsEmpty())</span>
<a href="#l3.1015"></a><span id="l3.1015">           val = replaceVal;</span>
<a href="#l3.1016"></a><span id="l3.1016">       }</span>
<a href="#l3.1017"></a><span id="l3.1017">       if (!val.IsEmpty()) {</span>
<a href="#l3.1018"></a><span id="l3.1018">         // See if we're writing out a Date: header.</span>
<a href="#l3.1019"></a><span id="l3.1019">         if (header.LowerCaseEqualsLiteral(&quot;date&quot;))</span>
<a href="#l3.1020"></a><span id="l3.1020">           hasDateHeader = true;</span>
<a href="#l3.1021"></a><span id="l3.1021" class="difflineminus">-        rv = pDst-&gt;Write( header.get(), header.Length(), &amp;written);</span>
<a href="#l3.1022"></a><span id="l3.1022" class="difflineminus">-        if (NS_SUCCEEDED( rv))</span>
<a href="#l3.1023"></a><span id="l3.1023" class="difflineminus">-          rv = pDst-&gt;Write( &quot;: &quot;, 2, &amp;written);</span>
<a href="#l3.1024"></a><span id="l3.1024" class="difflineminus">-        if (NS_SUCCEEDED( rv))</span>
<a href="#l3.1025"></a><span id="l3.1025" class="difflineminus">-          rv = pDst-&gt;Write( val.get(), val.Length(), &amp;written);</span>
<a href="#l3.1026"></a><span id="l3.1026" class="difflineminus">-        if (NS_SUCCEEDED( rv))</span>
<a href="#l3.1027"></a><span id="l3.1027" class="difflineminus">-          rv = pDst-&gt;Write( &quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l3.1028"></a><span id="l3.1028" class="difflineplus">+        rv = pDst-&gt;Write(header.get(), header.Length(), &amp;written);</span>
<a href="#l3.1029"></a><span id="l3.1029" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l3.1030"></a><span id="l3.1030" class="difflineplus">+          rv = pDst-&gt;Write(&quot;: &quot;, 2, &amp;written);</span>
<a href="#l3.1031"></a><span id="l3.1031" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l3.1032"></a><span id="l3.1032" class="difflineplus">+          rv = pDst-&gt;Write(val.get(), val.Length(), &amp;written);</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineplus">+          rv = pDst-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l3.1035"></a><span id="l3.1035"> </span>
<a href="#l3.1036"></a><span id="l3.1036">       }</span>
<a href="#l3.1037"></a><span id="l3.1037">     }</span>
<a href="#l3.1038"></a><span id="l3.1038">     n++;</span>
<a href="#l3.1039"></a><span id="l3.1039" class="difflineminus">-  } while (NS_SUCCEEDED( rv) &amp;&amp; !header.IsEmpty());</span>
<a href="#l3.1040"></a><span id="l3.1040" class="difflineplus">+  } while (NS_SUCCEEDED(rv) &amp;&amp; !header.IsEmpty());</span>
<a href="#l3.1041"></a><span id="l3.1041"> </span>
<a href="#l3.1042"></a><span id="l3.1042">   // If we don't have Date: header so far then use the default one (taken from Eudora &quot;From &quot; line).</span>
<a href="#l3.1043"></a><span id="l3.1043">   if (!hasDateHeader)</span>
<a href="#l3.1044"></a><span id="l3.1044">   {</span>
<a href="#l3.1045"></a><span id="l3.1045">     rv = pDst-&gt;Write(m_defaultDate.get(), m_defaultDate.Length(), &amp;written);</span>
<a href="#l3.1046"></a><span id="l3.1046" class="difflineminus">-    if (NS_SUCCEEDED( rv))</span>
<a href="#l3.1047"></a><span id="l3.1047" class="difflineminus">-      rv = pDst-&gt;Write( &quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l3.1048"></a><span id="l3.1048" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l3.1049"></a><span id="l3.1049" class="difflineplus">+      rv = pDst-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l3.1050"></a><span id="l3.1050">   }</span>
<a href="#l3.1051"></a><span id="l3.1051"> </span>
<a href="#l3.1052"></a><span id="l3.1052" class="difflineminus">-  for (i = 0; (i &lt; kMaxSpecialHeaders) &amp;&amp; NS_SUCCEEDED( rv); i++) {</span>
<a href="#l3.1053"></a><span id="l3.1053" class="difflineplus">+  for (i = 0; (i &lt; kMaxSpecialHeaders) &amp;&amp; NS_SUCCEEDED(rv); i++) {</span>
<a href="#l3.1054"></a><span id="l3.1054">     if (!specials[i]) {</span>
<a href="#l3.1055"></a><span id="l3.1055">       header = gSpecialHeaders[i];</span>
<a href="#l3.1056"></a><span id="l3.1056" class="difflineminus">-      header.Append( ':');</span>
<a href="#l3.1057"></a><span id="l3.1057" class="difflineminus">-      GetHeaderValue( newHeaders.m_pBuffer, newHeaders.m_writeOffset - 1, header.get(), val, false);</span>
<a href="#l3.1058"></a><span id="l3.1058" class="difflineminus">-      header.SetLength( header.Length() - 1);</span>
<a href="#l3.1059"></a><span id="l3.1059" class="difflineplus">+      header.Append(':');</span>
<a href="#l3.1060"></a><span id="l3.1060" class="difflineplus">+      GetHeaderValue(newHeaders.m_pBuffer, newHeaders.m_writeOffset - 1,</span>
<a href="#l3.1061"></a><span id="l3.1061" class="difflineplus">+                     header.get(), val, false);</span>
<a href="#l3.1062"></a><span id="l3.1062" class="difflineplus">+      header.SetLength(header.Length() - 1);</span>
<a href="#l3.1063"></a><span id="l3.1063">       if (!val.IsEmpty()) {</span>
<a href="#l3.1064"></a><span id="l3.1064" class="difflineminus">-        rv = pDst-&gt;Write( header.get(), header.Length(), &amp;written);</span>
<a href="#l3.1065"></a><span id="l3.1065" class="difflineminus">-        if (NS_SUCCEEDED( rv))</span>
<a href="#l3.1066"></a><span id="l3.1066" class="difflineminus">-          rv = pDst-&gt;Write( &quot;: &quot;, 2, &amp;written);</span>
<a href="#l3.1067"></a><span id="l3.1067" class="difflineminus">-        if (NS_SUCCEEDED( rv))</span>
<a href="#l3.1068"></a><span id="l3.1068" class="difflineminus">-          rv = pDst-&gt;Write( val.get(), val.Length(), &amp;written);</span>
<a href="#l3.1069"></a><span id="l3.1069" class="difflineminus">-        if (NS_SUCCEEDED( rv))</span>
<a href="#l3.1070"></a><span id="l3.1070" class="difflineminus">-          rv = pDst-&gt;Write( &quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l3.1071"></a><span id="l3.1071" class="difflineplus">+        rv = pDst-&gt;Write(header.get(), header.Length(), &amp;written);</span>
<a href="#l3.1072"></a><span id="l3.1072" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l3.1073"></a><span id="l3.1073" class="difflineplus">+          rv = pDst-&gt;Write(&quot;: &quot;, 2, &amp;written);</span>
<a href="#l3.1074"></a><span id="l3.1074" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l3.1075"></a><span id="l3.1075" class="difflineplus">+          rv = pDst-&gt;Write(val.get(), val.Length(), &amp;written);</span>
<a href="#l3.1076"></a><span id="l3.1076" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l3.1077"></a><span id="l3.1077" class="difflineplus">+          rv = pDst-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l3.1078"></a><span id="l3.1078">       }</span>
<a href="#l3.1079"></a><span id="l3.1079">     }</span>
<a href="#l3.1080"></a><span id="l3.1080">   }</span>
<a href="#l3.1081"></a><span id="l3.1081"> </span>
<a href="#l3.1082"></a><span id="l3.1082" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l3.1083"></a><span id="l3.1083" class="difflineminus">-    rv = pDst-&gt;Write( &quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l3.1084"></a><span id="l3.1084" class="difflineminus">-  return( rv);</span>
<a href="#l3.1085"></a><span id="l3.1085" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l3.1086"></a><span id="l3.1086" class="difflineplus">+    rv = pDst-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l3.1087"></a><span id="l3.1087" class="difflineplus">+  return rv;</span>
<a href="#l3.1088"></a><span id="l3.1088"> }</span>
<a href="#l3.1089"></a><span id="l3.1089"> </span>
<a href="#l3.1090"></a><span id="l3.1090"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraCompose.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraCompose.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -81,54 +81,59 @@ public:</span>
<a href="#l4.4"></a><span id="l4.4"> } ReadFileState;</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> class SimpleBufferTonyRCopiedOnce {</span>
<a href="#l4.7"></a><span id="l4.7"> public:</span>
<a href="#l4.8"></a><span id="l4.8">   SimpleBufferTonyRCopiedOnce() {m_pBuffer = nsnull; m_size = 0; m_growBy = 4096; m_writeOffset = 0;</span>
<a href="#l4.9"></a><span id="l4.9">           m_bytesInBuf = 0; m_convertCRs = false;}</span>
<a href="#l4.10"></a><span id="l4.10">   ~SimpleBufferTonyRCopiedOnce() { if (m_pBuffer) delete [] m_pBuffer;}</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  bool Allocate( PRInt32 sz) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-    if (m_pBuffer) delete [] m_pBuffer;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  bool Allocate(PRInt32 sz) {</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+    if (m_pBuffer)</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+      delete [] m_pBuffer;</span>
<a href="#l4.17"></a><span id="l4.17">     m_pBuffer = new char[sz];</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-    if (m_pBuffer) { m_size = sz; return( true); }</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-    else { m_size = 0; return( false);}</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+    if (m_pBuffer) {</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+      m_size = sz;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+      return true;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+    }</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+    m_size = 0;</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+    return false;</span>
<a href="#l4.26"></a><span id="l4.26">   }</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-  bool Grow( PRInt32 newSize) { if (newSize &gt; m_size) return( ReAllocate( newSize)); else return( true);}</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-  bool ReAllocate( PRInt32 newSize) {</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-    if (newSize &lt;= m_size) return( true);</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+  bool Grow(PRInt32 newSize) { if (newSize &gt; m_size) return ReAllocate(newSize); else return true;}</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  bool ReAllocate(PRInt32 newSize) {</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+    if (newSize &lt;= m_size) return true;</span>
<a href="#l4.34"></a><span id="l4.34">     char *pOldBuffer = m_pBuffer;</span>
<a href="#l4.35"></a><span id="l4.35">     PRInt32  oldSize = m_size;</span>
<a href="#l4.36"></a><span id="l4.36">     m_pBuffer = nsnull;</span>
<a href="#l4.37"></a><span id="l4.37">     while (m_size &lt; newSize) m_size += m_growBy;</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-    if (Allocate( m_size)) {</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-      if (pOldBuffer) { memcpy( m_pBuffer, pOldBuffer, oldSize); delete [] pOldBuffer;}</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-      return( true);</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+    if (Allocate(m_size)) {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+      if (pOldBuffer) { memcpy(m_pBuffer, pOldBuffer, oldSize); delete [] pOldBuffer;}</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+      return true;</span>
<a href="#l4.44"></a><span id="l4.44">     }</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-    else { m_pBuffer = pOldBuffer; m_size = oldSize; return( false);}</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+    else { m_pBuffer = pOldBuffer; m_size = oldSize; return false;}</span>
<a href="#l4.47"></a><span id="l4.47">   }</span>
<a href="#l4.48"></a><span id="l4.48"> </span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-  bool Write( PRInt32 offset, const char *pData, PRInt32 len, PRInt32 *pWritten) {</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+  bool Write(PRInt32 offset, const char *pData, PRInt32 len, PRInt32 *pWritten) {</span>
<a href="#l4.51"></a><span id="l4.51">     *pWritten = len;</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-    if (!len) return( true);</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-    if (!Grow( offset + len)) return( false);</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+    if (!len) return true;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+    if (!Grow(offset + len)) return false;</span>
<a href="#l4.56"></a><span id="l4.56">     if (m_convertCRs)</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-      return( SpecialMemCpy( offset, pData, len, pWritten));</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-    memcpy( m_pBuffer + offset, pData, len);</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-    return( true);</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+      return SpecialMemCpy(offset, pData, len, pWritten);</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+    memcpy(m_pBuffer + offset, pData, len);</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+    return true;</span>
<a href="#l4.63"></a><span id="l4.63">   }</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-  bool Write( const char *pData, PRInt32 len) {</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+  bool Write(const char *pData, PRInt32 len) {</span>
<a href="#l4.67"></a><span id="l4.67">     PRInt32 written;</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-    if (Write( m_writeOffset, pData, len, &amp;written)) { m_writeOffset += written; return( true);}</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-    else return( false);</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+    if (Write(m_writeOffset, pData, len, &amp;written)) { m_writeOffset += written; return true;}</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+    else return false;</span>
<a href="#l4.72"></a><span id="l4.72">   }</span>
<a href="#l4.73"></a><span id="l4.73"> </span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-  bool    SpecialMemCpy( PRInt32 offset, const char *pData, PRInt32 len, PRInt32 *pWritten);</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  bool    SpecialMemCpy(PRInt32 offset, const char *pData, PRInt32 len, PRInt32 *pWritten);</span>
<a href="#l4.76"></a><span id="l4.76"> </span>
<a href="#l4.77"></a><span id="l4.77">   bool    m_convertCRs;</span>
<a href="#l4.78"></a><span id="l4.78">   char *  m_pBuffer;</span>
<a href="#l4.79"></a><span id="l4.79">   PRUint32  m_bytesInBuf;  // used when reading into this buffer</span>
<a href="#l4.80"></a><span id="l4.80">   PRInt32  m_size;      // allocated size of buffer</span>
<a href="#l4.81"></a><span id="l4.81">   PRInt32  m_growBy;    // duh</span>
<a href="#l4.82"></a><span id="l4.82">   PRUint32 m_writeOffset;  // used when writing into and reading from the buffer</span>
<a href="#l4.83"></a><span id="l4.83"> };</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineat">@@ -137,49 +142,49 @@ public:</span>
<a href="#l4.85"></a><span id="l4.85"> </span>
<a href="#l4.86"></a><span id="l4.86"> class nsEudoraCompose {</span>
<a href="#l4.87"></a><span id="l4.87"> public:</span>
<a href="#l4.88"></a><span id="l4.88">   nsEudoraCompose();</span>
<a href="#l4.89"></a><span id="l4.89">   ~nsEudoraCompose();</span>
<a href="#l4.90"></a><span id="l4.90"> </span>
<a href="#l4.91"></a><span id="l4.91">   nsresult  SendTheMessage(nsIFile *pMailImportLocation, nsIFile **pMsg);</span>
<a href="#l4.92"></a><span id="l4.92"> </span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-  void    SetBody( const char *pBody, PRInt32 len, nsCString &amp;bodyType) { m_pBody = pBody; m_bodyLen = len; m_bodyType = bodyType;}</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-  void    SetHeaders( const char *pHeaders, PRInt32 len) { m_pHeaders = pHeaders; m_headerLen = len;}</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-  void    SetAttachments( nsVoidArray *pAttachments) { m_pAttachments = pAttachments;}</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-  void    SetDefaultDate( nsCString date) { m_defaultDate = date;}</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+  void    SetBody(const char *pBody, PRInt32 len, nsCString &amp;bodyType) { m_pBody = pBody; m_bodyLen = len; m_bodyType = bodyType;}</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+  void    SetHeaders(const char *pHeaders, PRInt32 len) { m_pHeaders = pHeaders; m_headerLen = len;}</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+  void    SetAttachments(nsVoidArray *pAttachments) { m_pAttachments = pAttachments;}</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+  void    SetDefaultDate(nsCString date) { m_defaultDate = date;}</span>
<a href="#l4.101"></a><span id="l4.101"> </span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-  nsresult  CopyComposedMessage( nsCString&amp; fromLine, nsIFile *pSrc, nsIOutputStream *pDst, SimpleBufferTonyRCopiedOnce&amp; copy);</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+  nsresult  CopyComposedMessage(nsCString&amp; fromLine, nsIFile *pSrc, nsIOutputStream *pDst, SimpleBufferTonyRCopiedOnce&amp; copy);</span>
<a href="#l4.104"></a><span id="l4.104"> </span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-  static nsresult  FillMailBuffer( ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; read);</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+  static nsresult  FillMailBuffer(ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; read);</span>
<a href="#l4.107"></a><span id="l4.107">   static nsresult CreateIdentity(void);</span>
<a href="#l4.108"></a><span id="l4.108">   static void    ReleaseIdentity(void);</span>
<a href="#l4.109"></a><span id="l4.109"> </span>
<a href="#l4.110"></a><span id="l4.110"> private:</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-  nsresult  CreateComponents( void);</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+  nsresult  CreateComponents(void);</span>
<a href="#l4.113"></a><span id="l4.113"> </span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-  void    GetNthHeader( const char *pData, PRInt32 dataLen, PRInt32 n, nsCString&amp; header, nsCString&amp; val, bool unwrap);</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-  void    GetHeaderValue( const char *pData, PRInt32 dataLen, const char *pHeader, nsCString&amp; val, bool unwrap = true);</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-  void    GetHeaderValue( const char *pData, PRInt32 dataLen, const char *pHeader, nsString&amp; val) {</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+  void    GetNthHeader(const char *pData, PRInt32 dataLen, PRInt32 n, nsCString&amp; header, nsCString&amp; val, bool unwrap);</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+  void    GetHeaderValue(const char *pData, PRInt32 dataLen, const char *pHeader, nsCString&amp; val, bool unwrap = true);</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+  void    GetHeaderValue(const char *pData, PRInt32 dataLen, const char *pHeader, nsString&amp; val) {</span>
<a href="#l4.120"></a><span id="l4.120">     val.Truncate();</span>
<a href="#l4.121"></a><span id="l4.121">     nsCString  hVal;</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-    GetHeaderValue( pData, dataLen, pHeader, hVal, true);</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineminus">-    NS_CopyNativeToUnicode( hVal, val);</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+    GetHeaderValue(pData, dataLen, pHeader, hVal, true);</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+    NS_CopyNativeToUnicode(hVal, val);</span>
<a href="#l4.126"></a><span id="l4.126">   }</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineminus">-  void    ExtractCharset( nsString&amp; str);</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineminus">-  void    ExtractType( nsString&amp; str);</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+  void    ExtractCharset(nsString&amp; str);</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+  void    ExtractType(nsString&amp; str);</span>
<a href="#l4.131"></a><span id="l4.131"> </span>
<a href="#l4.132"></a><span id="l4.132">   nsresult GetLocalAttachments(nsIArray **aArray);</span>
<a href="#l4.133"></a><span id="l4.133"> </span>
<a href="#l4.134"></a><span id="l4.134" class="difflineminus">-  nsresult  ReadHeaders( ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; copy, SimpleBufferTonyRCopiedOnce&amp; header);</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-  PRInt32    FindNextEndLine( SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-  PRInt32    IsEndHeaders( SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineminus">-  PRInt32    IsSpecialHeader( const char *pHeader);</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineminus">-  nsresult  WriteHeaders( nsIOutputStream *pDst, SimpleBufferTonyRCopiedOnce&amp; newHeaders);</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineminus">-  bool      IsReplaceHeader( const char *pHeader);</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+  nsresult  ReadHeaders(ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; copy, SimpleBufferTonyRCopiedOnce&amp; header);</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+  PRInt32    FindNextEndLine(SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+  PRInt32    IsEndHeaders(SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+  PRInt32    IsSpecialHeader(const char *pHeader);</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+  nsresult  WriteHeaders(nsIOutputStream *pDst, SimpleBufferTonyRCopiedOnce&amp; newHeaders);</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+  bool      IsReplaceHeader(const char *pHeader);</span>
<a href="#l4.146"></a><span id="l4.146"> </span>
<a href="#l4.147"></a><span id="l4.147"> private:</span>
<a href="#l4.148"></a><span id="l4.148">   static nsIMsgIdentity *    s_pIdentity;</span>
<a href="#l4.149"></a><span id="l4.149"> </span>
<a href="#l4.150"></a><span id="l4.150">   nsVoidArray *      m_pAttachments;</span>
<a href="#l4.151"></a><span id="l4.151">   nsIMsgSendListener *  m_pListener;</span>
<a href="#l4.152"></a><span id="l4.152">   nsIMsgCompFields *    m_pMsgFields;</span>
<a href="#l4.153"></a><span id="l4.153">   nsCOMPtr&lt;nsIIOService&gt; m_pIOService;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraEditor.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraEditor.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -73,17 +73,17 @@ static PRUint32 EudoraHashString(const c</span>
<a href="#l5.4"></a><span id="l5.4">         ulSum -= kKRHashPrime;</span>
<a href="#l5.5"></a><span id="l5.5">       if ((*pszStr) &amp; nBit)</span>
<a href="#l5.6"></a><span id="l5.6">         ++ulSum;</span>
<a href="#l5.7"></a><span id="l5.7">       if (ulSum&gt;= kKRHashPrime)</span>
<a href="#l5.8"></a><span id="l5.8">         ulSum -= kKRHashPrime;</span>
<a href="#l5.9"></a><span id="l5.9">     }</span>
<a href="#l5.10"></a><span id="l5.10">   }</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  return (ulSum + 1);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  return ulSum + 1;</span>
<a href="#l5.14"></a><span id="l5.14"> }</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17"> nsEudoraEditor::nsEudoraEditor(const char * pBody, nsIFile * pMailImportLocation)</span>
<a href="#l5.18"></a><span id="l5.18">   : m_body(pBody)</span>
<a href="#l5.19"></a><span id="l5.19"> {</span>
<a href="#l5.20"></a><span id="l5.20">   m_pMailImportLocation = pMailImportLocation;</span>
<a href="#l5.21"></a><span id="l5.21"> }</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -100,17 +100,17 @@ nsresult nsEudoraEditor::GetEmbeddedObje</span>
<a href="#l5.23"></a><span id="l5.23">   // Check to see if we were already called</span>
<a href="#l5.24"></a><span id="l5.24">   if (m_EmbeddedObjectList != nsnull)</span>
<a href="#l5.25"></a><span id="l5.25">   {</span>
<a href="#l5.26"></a><span id="l5.26">     *aNodeList = m_EmbeddedObjectList;</span>
<a href="#l5.27"></a><span id="l5.27">     return NS_OK;</span>
<a href="#l5.28"></a><span id="l5.28">   }</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30">   // Create array in m_EmbeddedObjectList</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-  nsresult rv = NS_NewISupportsArray( getter_AddRefs(m_EmbeddedObjectList) );</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  nsresult rv = NS_NewISupportsArray(getter_AddRefs(m_EmbeddedObjectList));</span>
<a href="#l5.33"></a><span id="l5.33">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35">   // Return m_EmbeddedObjectList in aNodeList and increment ref count - caller</span>
<a href="#l5.36"></a><span id="l5.36">   // assumes that we incremented the ref count.</span>
<a href="#l5.37"></a><span id="l5.37">   NS_IF_ADDREF(*aNodeList = m_EmbeddedObjectList);</span>
<a href="#l5.38"></a><span id="l5.38"> </span>
<a href="#l5.39"></a><span id="l5.39">   // Create the embedded folder spec</span>
<a href="#l5.40"></a><span id="l5.40">   nsCOMPtr&lt;nsIFile&gt;   embeddedFolderSpec;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineat">@@ -140,34 +140,36 @@ nsresult nsEudoraEditor::GetEmbeddedObje</span>
<a href="#l5.42"></a><span id="l5.42">   // one that I know of, but then again I didn't realize that Eudora translators had</span>
<a href="#l5.43"></a><span id="l5.43">   // ever translated &quot;Attachment Converted&quot; as suggested by other Eudora importing code.</span>
<a href="#l5.44"></a><span id="l5.44">   for (PRInt32 i = 0; *sEudoraEmbeddedContentLines[i] != '\0'; i++)</span>
<a href="#l5.45"></a><span id="l5.45">   {</span>
<a href="#l5.46"></a><span id="l5.46">     // Search for &quot;Embedded Content: &quot; lines starting after last closing tag (if any)</span>
<a href="#l5.47"></a><span id="l5.47">     PRInt32   startEmbeddedContentLine = startLastClosingTag;</span>
<a href="#l5.48"></a><span id="l5.48">     PRInt32   lenEmbeddedContentTag = strlen(sEudoraEmbeddedContentLines[i]);</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-    while ( (startEmbeddedContentLine = m_body.Find(sEudoraEmbeddedContentLines[i], true, startEmbeddedContentLine+1)) != kNotFound )</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+    while ((startEmbeddedContentLine = m_body.Find(sEudoraEmbeddedContentLines[i],</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+                                                   true,</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+                                                   startEmbeddedContentLine+1)) != kNotFound)</span>
<a href="#l5.54"></a><span id="l5.54">     {</span>
<a href="#l5.55"></a><span id="l5.55">       // Found this translation of &quot;Embedded Content&quot; - remember that so that we don't</span>
<a href="#l5.56"></a><span id="l5.56">       // bother looking for any other translations.</span>
<a href="#l5.57"></a><span id="l5.57">       foundEmbeddedContentLines = true;</span>
<a href="#l5.58"></a><span id="l5.58"> </span>
<a href="#l5.59"></a><span id="l5.59">       // Extract the file name from the embedded content line</span>
<a href="#l5.60"></a><span id="l5.60">       PRInt32   startFileName = startEmbeddedContentLine + lenEmbeddedContentTag;</span>
<a href="#l5.61"></a><span id="l5.61">       PRInt32   endFileName = m_body.Find(&quot;:&quot;, false, startFileName);</span>
<a href="#l5.62"></a><span id="l5.62"> </span>
<a href="#l5.63"></a><span id="l5.63">       // Create the file spec for the embedded image</span>
<a href="#l5.64"></a><span id="l5.64">       embeddedFolderSpec-&gt;Clone(getter_AddRefs(embeddedImageSpec));</span>
<a href="#l5.65"></a><span id="l5.65">       embeddedImageSpec-&gt;Append(Substring(m_body, startFileName, endFileName - startFileName));</span>
<a href="#l5.66"></a><span id="l5.66"> </span>
<a href="#l5.67"></a><span id="l5.67">       // Verify that the embedded image spec exists and is a file</span>
<a href="#l5.68"></a><span id="l5.68">       bool      isFile = false;</span>
<a href="#l5.69"></a><span id="l5.69">       bool      exists = false;</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-      if ( NS_FAILED(embeddedImageSpec-&gt;Exists( &amp;exists)) || NS_FAILED(embeddedImageSpec-&gt;IsFile(&amp;isFile)) )</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+      if (NS_FAILED(embeddedImageSpec-&gt;Exists(&amp;exists)) || NS_FAILED(embeddedImageSpec-&gt;IsFile(&amp;isFile)))</span>
<a href="#l5.72"></a><span id="l5.72">         continue;</span>
<a href="#l5.73"></a><span id="l5.73">       if (!exists || !isFile)</span>
<a href="#l5.74"></a><span id="l5.74">         continue;</span>
<a href="#l5.75"></a><span id="l5.75"> </span>
<a href="#l5.76"></a><span id="l5.76">       // Extract CID hash from the embedded content line</span>
<a href="#l5.77"></a><span id="l5.77">       PRInt32     cidHashValue;</span>
<a href="#l5.78"></a><span id="l5.78">       PRInt32     startCIDHash = m_body.Find(&quot;,&quot;, false, endFileName);</span>
<a href="#l5.79"></a><span id="l5.79">       if (startCIDHash != kNotFound)</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineat">@@ -175,17 +177,17 @@ nsresult nsEudoraEditor::GetEmbeddedObje</span>
<a href="#l5.81"></a><span id="l5.81">         startCIDHash++;</span>
<a href="#l5.82"></a><span id="l5.82">         PRInt32   endCIDHash = m_body.Find(&quot;,&quot;, false, startCIDHash);</span>
<a href="#l5.83"></a><span id="l5.83"> </span>
<a href="#l5.84"></a><span id="l5.84">         if (endCIDHash != kNotFound)</span>
<a href="#l5.85"></a><span id="l5.85">         {</span>
<a href="#l5.86"></a><span id="l5.86">           nsString    cidHash;</span>
<a href="#l5.87"></a><span id="l5.87">           cidHash.Assign(Substring(m_body, startCIDHash, endCIDHash - startCIDHash));</span>
<a href="#l5.88"></a><span id="l5.88"> </span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-          if ( !cidHash.IsEmpty() )</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+          if (!cidHash.IsEmpty())</span>
<a href="#l5.91"></a><span id="l5.91">           {</span>
<a href="#l5.92"></a><span id="l5.92">             // Convert CID hash string to numeric value</span>
<a href="#l5.93"></a><span id="l5.93">             nsresult aErrorCode;</span>
<a href="#l5.94"></a><span id="l5.94">             cidHashValue = cidHash.ToInteger(&amp;aErrorCode, 16);</span>
<a href="#l5.95"></a><span id="l5.95">           }</span>
<a href="#l5.96"></a><span id="l5.96">         }</span>
<a href="#l5.97"></a><span id="l5.97">       }</span>
<a href="#l5.98"></a><span id="l5.98"> </span>
<a href="#l5.99"></a><span id="l5.99" class="difflineat">@@ -198,18 +200,17 @@ nsresult nsEudoraEditor::GetEmbeddedObje</span>
<a href="#l5.100"></a><span id="l5.100">       nsString cid;</span>
<a href="#l5.101"></a><span id="l5.101">       // We're going to remember the original cid in the image element,</span>
<a href="#l5.102"></a><span id="l5.102">       // which the send code will retrieve as the kMozCIDAttrName property.</span>
<a href="#l5.103"></a><span id="l5.103">       GetEmbeddedImageCID(cidHashValue, srcUrl, cid);</span>
<a href="#l5.104"></a><span id="l5.104">       // Create the embedded image node</span>
<a href="#l5.105"></a><span id="l5.105">       nsEudoraHTMLImageElement *image =</span>
<a href="#l5.106"></a><span id="l5.106">         new nsEudoraHTMLImageElement(srcUrl, cid);</span>
<a href="#l5.107"></a><span id="l5.107"> </span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-      nsCOMPtr&lt;nsIDOMHTMLImageElement&gt;   imageNode;</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-      image-&gt;QueryInterface( NS_GET_IID(nsIDOMHTMLImageElement), getter_AddRefs(imageNode) );</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+      nsCOMPtr&lt;nsIDOMHTMLImageElement&gt; imageNode(do_QueryInterface(image));</span>
<a href="#l5.111"></a><span id="l5.111"> </span>
<a href="#l5.112"></a><span id="l5.112">       // Append the embedded image node to the list</span>
<a href="#l5.113"></a><span id="l5.113">       (*aNodeList)-&gt;AppendElement(imageNode);</span>
<a href="#l5.114"></a><span id="l5.114"> </span>
<a href="#l5.115"></a><span id="l5.115">       PRInt32   endEmbeddedContentLine = m_body.Find(&quot;\r\n&quot;, true, startEmbeddedContentLine+1);</span>
<a href="#l5.116"></a><span id="l5.116">       if (endEmbeddedContentLine != kNotFound)</span>
<a href="#l5.117"></a><span id="l5.117">       {</span>
<a href="#l5.118"></a><span id="l5.118">         // We recognized the &quot;Embedded Content&quot; line correctly and found the associated image.</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineat">@@ -230,50 +231,50 @@ nsresult nsEudoraEditor::GetEmbeddedObje</span>
<a href="#l5.120"></a><span id="l5.120"> }</span>
<a href="#l5.121"></a><span id="l5.121"> </span>
<a href="#l5.122"></a><span id="l5.122"> bool nsEudoraEditor::GetEmbeddedImageCID(PRUint32 aCIDHash, const nsAString &amp; aOldRef, nsString &amp;aCID)</span>
<a href="#l5.123"></a><span id="l5.123"> {</span>
<a href="#l5.124"></a><span id="l5.124">   bool      foundMatch = false;</span>
<a href="#l5.125"></a><span id="l5.125">   PRInt32   startImageTag = 0;</span>
<a href="#l5.126"></a><span id="l5.126">   PRInt32   closeImageTag = 0;</span>
<a href="#l5.127"></a><span id="l5.127"> </span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-  while ( (startImageTag = m_body.Find(&quot;&lt;img&quot;, true, closeImageTag)) != kNotFound )</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+  while ((startImageTag = m_body.Find(&quot;&lt;img&quot;, true, closeImageTag)) != kNotFound)</span>
<a href="#l5.130"></a><span id="l5.130">   {</span>
<a href="#l5.131"></a><span id="l5.131">     closeImageTag = m_body.Find(&quot;&gt;&quot;, false, startImageTag);</span>
<a href="#l5.132"></a><span id="l5.132"> </span>
<a href="#l5.133"></a><span id="l5.133">     // We should always find a close tag, bail if we don't</span>
<a href="#l5.134"></a><span id="l5.134">     if (closeImageTag == kNotFound)</span>
<a href="#l5.135"></a><span id="l5.135">       break;</span>
<a href="#l5.136"></a><span id="l5.136"> </span>
<a href="#l5.137"></a><span id="l5.137">     // Find the source attribute and make sure it's for our image tag</span>
<a href="#l5.138"></a><span id="l5.138">     PRInt32   startSrcValue = m_body.Find(&quot;src&quot;, true, startImageTag);</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-    if ( (startSrcValue == kNotFound) || (startSrcValue &gt; closeImageTag) )</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+    if ((startSrcValue == kNotFound) || (startSrcValue &gt; closeImageTag))</span>
<a href="#l5.141"></a><span id="l5.141">       continue;</span>
<a href="#l5.142"></a><span id="l5.142"> </span>
<a href="#l5.143"></a><span id="l5.143">     // Move past the src</span>
<a href="#l5.144"></a><span id="l5.144">     startSrcValue += 3;</span>
<a href="#l5.145"></a><span id="l5.145"> </span>
<a href="#l5.146"></a><span id="l5.146">     // Move past any whitespace</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-    while ( isspace(m_body.CharAt(startSrcValue)) )</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+    while (isspace(m_body.CharAt(startSrcValue)))</span>
<a href="#l5.149"></a><span id="l5.149">       ++startSrcValue;</span>
<a href="#l5.150"></a><span id="l5.150"> </span>
<a href="#l5.151"></a><span id="l5.151">     // We should find an = now</span>
<a href="#l5.152"></a><span id="l5.152">     if (m_body.CharAt(startSrcValue) != '=')</span>
<a href="#l5.153"></a><span id="l5.153">       continue;</span>
<a href="#l5.154"></a><span id="l5.154"> </span>
<a href="#l5.155"></a><span id="l5.155">     // Move past =</span>
<a href="#l5.156"></a><span id="l5.156">     ++startSrcValue;</span>
<a href="#l5.157"></a><span id="l5.157"> </span>
<a href="#l5.158"></a><span id="l5.158">     // Move past any whitespace</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-    while ( isspace(m_body.CharAt(startSrcValue)) )</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+    while (isspace(m_body.CharAt(startSrcValue)))</span>
<a href="#l5.161"></a><span id="l5.161">       ++startSrcValue;</span>
<a href="#l5.162"></a><span id="l5.162"> </span>
<a href="#l5.163"></a><span id="l5.163">     // Get the quote char and verify that it's valid</span>
<a href="#l5.164"></a><span id="l5.164">     char    quoteChar = static_cast &lt;char&gt; (m_body.CharAt(startSrcValue));</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-    if ( (quoteChar != '&quot;') &amp;&amp; (quoteChar != '\'') )</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+    if ((quoteChar != '&quot;') &amp;&amp; (quoteChar != '\''))</span>
<a href="#l5.167"></a><span id="l5.167">       continue;</span>
<a href="#l5.168"></a><span id="l5.168"> </span>
<a href="#l5.169"></a><span id="l5.169">     // Move past the quote</span>
<a href="#l5.170"></a><span id="l5.170">     ++startSrcValue;</span>
<a href="#l5.171"></a><span id="l5.171"> </span>
<a href="#l5.172"></a><span id="l5.172">     PRInt32   endSrcValue = m_body.FindChar(quoteChar, startSrcValue);</span>
<a href="#l5.173"></a><span id="l5.173">     PRInt32   srcLength = endSrcValue - startSrcValue;</span>
<a href="#l5.174"></a><span id="l5.174"> </span>
<a href="#l5.175"></a><span id="l5.175" class="difflineat">@@ -284,17 +285,17 @@ bool nsEudoraEditor::GetEmbeddedImageCID</span>
<a href="#l5.176"></a><span id="l5.176">     {</span>
<a href="#l5.177"></a><span id="l5.177">       // Verify source value starts with &quot;cid:&quot;</span>
<a href="#l5.178"></a><span id="l5.178">       if (!StringBeginsWith(aCID, NS_LITERAL_STRING(&quot;cid:&quot;), nsCaseInsensitiveStringComparator()))</span>
<a href="#l5.179"></a><span id="l5.179">         continue;</span>
<a href="#l5.180"></a><span id="l5.180"> </span>
<a href="#l5.181"></a><span id="l5.181">       // Remove &quot;cid:&quot; from the start</span>
<a href="#l5.182"></a><span id="l5.182">       aCID.Cut(0, 4);</span>
<a href="#l5.183"></a><span id="l5.183"> </span>
<a href="#l5.184"></a><span id="l5.184" class="difflineminus">-      PRUint32  hashValue = EudoraHashString( NS_LossyConvertUTF16toASCII(aCID).get() );</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+      PRUint32  hashValue = EudoraHashString(NS_LossyConvertUTF16toASCII(aCID).get());</span>
<a href="#l5.186"></a><span id="l5.186">       foundMatch = (hashValue == aCIDHash);</span>
<a href="#l5.187"></a><span id="l5.187">     }</span>
<a href="#l5.188"></a><span id="l5.188">     else</span>
<a href="#l5.189"></a><span id="l5.189">     {</span>
<a href="#l5.190"></a><span id="l5.190">       foundMatch = aCID.Equals(aOldRef);</span>
<a href="#l5.191"></a><span id="l5.191">     }</span>
<a href="#l5.192"></a><span id="l5.192">   }</span>
<a href="#l5.193"></a><span id="l5.193"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraFilters.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraFilters.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -98,34 +98,34 @@ NS_IMETHODIMP nsEudoraFilters::AutoLocat</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">   *aDescription = nsnull;</span>
<a href="#l6.6"></a><span id="l6.6">   *_retval = false;</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8">   nsresult rv;</span>
<a href="#l6.9"></a><span id="l6.9">   m_pLocation =  do_CreateInstance (NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l6.10"></a><span id="l6.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  *aDescription = nsEudoraStringBundle::GetStringByID( EUDORAIMPORT_NAME);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  *aDescription = nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_NAME);</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15"> #if defined(XP_WIN) || defined(XP_OS2)</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-  *_retval = nsEudoraWin32::FindFiltersFile( getter_AddRefs(m_pLocation) );</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+  *_retval = nsEudoraWin32::FindFiltersFile(getter_AddRefs(m_pLocation));</span>
<a href="#l6.18"></a><span id="l6.18"> #endif</span>
<a href="#l6.19"></a><span id="l6.19"> #ifdef XP_MACOSX</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-  *_retval = nsEudoraMac::FindFiltersFile( getter_AddRefs(m_pLocation) );</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  *_retval = nsEudoraMac::FindFiltersFile(getter_AddRefs(m_pLocation));</span>
<a href="#l6.22"></a><span id="l6.22"> #endif</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24">   NS_IF_ADDREF(*aLocation = m_pLocation);</span>
<a href="#l6.25"></a><span id="l6.25">   return NS_OK;</span>
<a href="#l6.26"></a><span id="l6.26"> }</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28"> NS_IMETHODIMP nsEudoraFilters::SetLocation(nsIFile *aLocation)</span>
<a href="#l6.29"></a><span id="l6.29"> {</span>
<a href="#l6.30"></a><span id="l6.30">   m_pLocation = aLocation;</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-  return( NS_OK);</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.34"></a><span id="l6.34"> }</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36"> NS_IMETHODIMP nsEudoraFilters::Import(PRUnichar **aError, bool *_retval)</span>
<a href="#l6.37"></a><span id="l6.37"> {</span>
<a href="#l6.38"></a><span id="l6.38">   NS_ENSURE_ARG_POINTER(aError);</span>
<a href="#l6.39"></a><span id="l6.39">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l6.40"></a><span id="l6.40">   nsresult rv;</span>
<a href="#l6.41"></a><span id="l6.41"> </span>
<a href="#l6.42"></a><span id="l6.42" class="difflineat">@@ -144,56 +144,56 @@ NS_IMETHODIMP nsEudoraFilters::Import(PR</span>
<a href="#l6.43"></a><span id="l6.43"> #ifdef XP_MACOSX</span>
<a href="#l6.44"></a><span id="l6.44">     if (!nsEudoraMac::FindFiltersFile(getter_AddRefs(m_pLocation)))</span>
<a href="#l6.45"></a><span id="l6.45">       m_pLocation = nsnull;</span>
<a href="#l6.46"></a><span id="l6.46"> #endif</span>
<a href="#l6.47"></a><span id="l6.47">   }</span>
<a href="#l6.48"></a><span id="l6.48"> </span>
<a href="#l6.49"></a><span id="l6.49">   if (!m_pLocation)</span>
<a href="#l6.50"></a><span id="l6.50">   {</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error, unable to locate filters file for import.\n&quot;);</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error, unable to locate filters file for import.\n&quot;);</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l6.55"></a><span id="l6.55">   }</span>
<a href="#l6.56"></a><span id="l6.56"> </span>
<a href="#l6.57"></a><span id="l6.57">   // Now perform actual importing task</span>
<a href="#l6.58"></a><span id="l6.58">   *_retval = RealImport();</span>
<a href="#l6.59"></a><span id="l6.59">   *aError = ToNewUnicode(m_errorLog);</span>
<a href="#l6.60"></a><span id="l6.60"> </span>
<a href="#l6.61"></a><span id="l6.61">   if (*_retval)</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-    IMPORT_LOG0( &quot;Successful import of eudora filters\n&quot;);</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+    IMPORT_LOG0(&quot;Successful import of eudora filters\n&quot;);</span>
<a href="#l6.64"></a><span id="l6.64">   else</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error, Unsuccessful import of eudora filters\n&quot;);</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error, Unsuccessful import of eudora filters\n&quot;);</span>
<a href="#l6.67"></a><span id="l6.67"> </span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-  return( NS_OK);</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+  return NS_OK;</span>
<a href="#l6.70"></a><span id="l6.70"> }</span>
<a href="#l6.71"></a><span id="l6.71"> </span>
<a href="#l6.72"></a><span id="l6.72"> bool nsEudoraFilters::RealImport()</span>
<a href="#l6.73"></a><span id="l6.73"> {</span>
<a href="#l6.74"></a><span id="l6.74">   nsresult rv;</span>
<a href="#l6.75"></a><span id="l6.75"> </span>
<a href="#l6.76"></a><span id="l6.76">   rv = Init();</span>
<a href="#l6.77"></a><span id="l6.77">   if (NS_FAILED(rv))</span>
<a href="#l6.78"></a><span id="l6.78">   {</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error initializing filter import process\n&quot;);</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error initializing filter import process\n&quot;);</span>
<a href="#l6.81"></a><span id="l6.81">     return false;</span>
<a href="#l6.82"></a><span id="l6.82">   }</span>
<a href="#l6.83"></a><span id="l6.83"> </span>
<a href="#l6.84"></a><span id="l6.84">   nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l6.85"></a><span id="l6.85">   rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), m_pLocation);</span>
<a href="#l6.86"></a><span id="l6.86"> </span>
<a href="#l6.87"></a><span id="l6.87">   if (NS_FAILED(rv))</span>
<a href="#l6.88"></a><span id="l6.88">   {</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error opening filters file for reading\n&quot;);</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error opening filters file for reading\n&quot;);</span>
<a href="#l6.91"></a><span id="l6.91">     return false;</span>
<a href="#l6.92"></a><span id="l6.92">   }</span>
<a href="#l6.93"></a><span id="l6.93"> </span>
<a href="#l6.94"></a><span id="l6.94">   rv = LoadServers();</span>
<a href="#l6.95"></a><span id="l6.95">   if (NS_FAILED(rv))</span>
<a href="#l6.96"></a><span id="l6.96">   {</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error loading servers with filters\n&quot;);</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error loading servers with filters\n&quot;);</span>
<a href="#l6.99"></a><span id="l6.99">     return false;</span>
<a href="#l6.100"></a><span id="l6.100">   }</span>
<a href="#l6.101"></a><span id="l6.101"> </span>
<a href="#l6.102"></a><span id="l6.102">   nsCOMPtr&lt;nsILineInputStream&gt; lineStream(do_QueryInterface(inputStream, &amp;rv));</span>
<a href="#l6.103"></a><span id="l6.103">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.104"></a><span id="l6.104"> </span>
<a href="#l6.105"></a><span id="l6.105">   nsCString     line;</span>
<a href="#l6.106"></a><span id="l6.106">   bool          more = true;</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineat">@@ -353,17 +353,17 @@ bool nsEudoraFilters::RealImport()</span>
<a href="#l6.108"></a><span id="l6.108">   // Process the last filter</span>
<a href="#l6.109"></a><span id="l6.109">   if (!more &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l6.110"></a><span id="l6.110">     rv = FinalizeFilter();</span>
<a href="#l6.111"></a><span id="l6.111"> </span>
<a href="#l6.112"></a><span id="l6.112">   inputStream-&gt;Close();</span>
<a href="#l6.113"></a><span id="l6.113"> </span>
<a href="#l6.114"></a><span id="l6.114">   if (more)</span>
<a href="#l6.115"></a><span id="l6.115">   {</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error reading the filters, didn't reach the end\n&quot;);</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error reading the filters, didn't reach the end\n&quot;);</span>
<a href="#l6.118"></a><span id="l6.118">     return false;</span>
<a href="#l6.119"></a><span id="l6.119">   }</span>
<a href="#l6.120"></a><span id="l6.120"> </span>
<a href="#l6.121"></a><span id="l6.121">   rv = SaveFilters();</span>
<a href="#l6.122"></a><span id="l6.122"> </span>
<a href="#l6.123"></a><span id="l6.123">   return NS_SUCCEEDED(rv);</span>
<a href="#l6.124"></a><span id="l6.124"> }</span>
<a href="#l6.125"></a><span id="l6.125"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraImport.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraImport.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -117,23 +117,23 @@ public:</span>
<a href="#l7.4"></a><span id="l7.4">                 PRUnichar **pErrorLog, PRUnichar **pSuccessLog, bool *fatalError);</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6">   /* unsigned long GetImportProgress (); */</span>
<a href="#l7.7"></a><span id="l7.7">   NS_IMETHOD GetImportProgress(PRUint32 *_retval);</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9">   NS_IMETHOD TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval);</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> public:</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  static void  AddLinebreak( nsString *pStream);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  static void  SetLogs( nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-  static void ReportError( PRInt32 errorNum, nsString&amp; name, nsString *pStream);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  static void  AddLinebreak(nsString *pStream);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+  static void  SetLogs(nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess);</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+  static void ReportError(PRInt32 errorNum, nsString&amp; name, nsString *pStream);</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20"> private:</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-  static void  ReportSuccess( nsString&amp; name, PRInt32 count, nsString *pStream);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+  static void  ReportSuccess(nsString&amp; name, PRInt32 count, nsString *pStream);</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24"> private:</span>
<a href="#l7.25"></a><span id="l7.25"> #if defined(XP_WIN) || defined(XP_OS2)</span>
<a href="#l7.26"></a><span id="l7.26">   nsEudoraWin32  m_eudora;</span>
<a href="#l7.27"></a><span id="l7.27"> #endif</span>
<a href="#l7.28"></a><span id="l7.28"> #ifdef XP_MACOSX</span>
<a href="#l7.29"></a><span id="l7.29">   nsEudoraMac    m_eudora;</span>
<a href="#l7.30"></a><span id="l7.30"> #endif</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineat">@@ -149,46 +149,46 @@ public:</span>
<a href="#l7.32"></a><span id="l7.32"> </span>
<a href="#l7.33"></a><span id="l7.33">   static nsresult Create(nsIImportAddressBooks** aImport);</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35">   // nsISupports interface</span>
<a href="#l7.36"></a><span id="l7.36">   NS_DECL_ISUPPORTS</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38">   // nsIImportAddressBooks interface</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-  NS_IMETHOD GetSupportsMultiple(bool *_retval) { *_retval = true; return( NS_OK);}</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+  NS_IMETHOD GetSupportsMultiple(bool *_retval) { *_retval = true; return NS_OK;}</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43">   NS_IMETHOD GetAutoFind(PRUnichar **description, bool *_retval);</span>
<a href="#l7.44"></a><span id="l7.44"> </span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-  NS_IMETHOD GetNeedsFieldMap(nsIFile *location, bool *_retval) { *_retval = false; return( NS_OK);}</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+  NS_IMETHOD GetNeedsFieldMap(nsIFile *location, bool *_retval) { *_retval = false; return NS_OK;}</span>
<a href="#l7.47"></a><span id="l7.47"> </span>
<a href="#l7.48"></a><span id="l7.48">   NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found, bool *userVerify);</span>
<a href="#l7.49"></a><span id="l7.49"> </span>
<a href="#l7.50"></a><span id="l7.50">   NS_IMETHOD FindAddressBooks(nsIFile *location, nsISupportsArray **_retval);</span>
<a href="#l7.51"></a><span id="l7.51"> </span>
<a href="#l7.52"></a><span id="l7.52">   NS_IMETHOD InitFieldMap(nsIImportFieldMap *fieldMap)</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-    { return( NS_ERROR_FAILURE); }</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+    { return NS_ERROR_FAILURE; }</span>
<a href="#l7.55"></a><span id="l7.55"> </span>
<a href="#l7.56"></a><span id="l7.56">   NS_IMETHOD ImportAddressBook(nsIImportABDescriptor *source,</span>
<a href="#l7.57"></a><span id="l7.57">                                nsIAddrDatabase *destination,</span>
<a href="#l7.58"></a><span id="l7.58">                                nsIImportFieldMap *fieldMap,</span>
<a href="#l7.59"></a><span id="l7.59">                                nsISupports *aSupportService,</span>
<a href="#l7.60"></a><span id="l7.60">                                PRUnichar **errorLog,</span>
<a href="#l7.61"></a><span id="l7.61">                                PRUnichar **successLog,</span>
<a href="#l7.62"></a><span id="l7.62">                                bool *fatalError);</span>
<a href="#l7.63"></a><span id="l7.63"> </span>
<a href="#l7.64"></a><span id="l7.64">   NS_IMETHOD GetImportProgress(PRUint32 *_retval);</span>
<a href="#l7.65"></a><span id="l7.65"> </span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-  NS_IMETHOD GetSampleData( PRInt32 index, bool *pFound, PRUnichar **pStr)</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-    { return( NS_ERROR_FAILURE);}</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+  NS_IMETHOD GetSampleData(PRInt32 index, bool *pFound, PRUnichar **pStr)</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+    { return NS_ERROR_FAILURE;}</span>
<a href="#l7.70"></a><span id="l7.70"> </span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-  NS_IMETHOD SetSampleLocation( nsIFile *) { return( NS_OK); }</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+  NS_IMETHOD SetSampleLocation(nsIFile *) { return NS_OK; }</span>
<a href="#l7.73"></a><span id="l7.73"> </span>
<a href="#l7.74"></a><span id="l7.74"> private:</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-  static void  ReportSuccess( nsString&amp; name, nsString *pStream);</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+  static void  ReportSuccess(nsString&amp; name, nsString *pStream);</span>
<a href="#l7.77"></a><span id="l7.77"> </span>
<a href="#l7.78"></a><span id="l7.78"> private:</span>
<a href="#l7.79"></a><span id="l7.79"> #if defined(XP_WIN) || defined(XP_OS2)</span>
<a href="#l7.80"></a><span id="l7.80">   nsEudoraWin32  m_eudora;</span>
<a href="#l7.81"></a><span id="l7.81"> #endif</span>
<a href="#l7.82"></a><span id="l7.82"> #ifdef XP_MACOSX</span>
<a href="#l7.83"></a><span id="l7.83">   nsEudoraMac    m_eudora;</span>
<a href="#l7.84"></a><span id="l7.84"> #endif</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineat">@@ -199,162 +199,162 @@ private:</span>
<a href="#l7.86"></a><span id="l7.86"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.87"></a><span id="l7.87"> </span>
<a href="#l7.88"></a><span id="l7.88"> </span>
<a href="#l7.89"></a><span id="l7.89"> nsEudoraImport::nsEudoraImport()</span>
<a href="#l7.90"></a><span id="l7.90"> {</span>
<a href="#l7.91"></a><span id="l7.91">   // Init logging module.</span>
<a href="#l7.92"></a><span id="l7.92">   if (!EUDORALOGMODULE)</span>
<a href="#l7.93"></a><span id="l7.93">     EUDORALOGMODULE = PR_NewLogModule(&quot;IMPORT&quot;);</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-  IMPORT_LOG0( &quot;nsEudoraImport Module Created\n&quot;);</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+  IMPORT_LOG0(&quot;nsEudoraImport Module Created\n&quot;);</span>
<a href="#l7.96"></a><span id="l7.96"> </span>
<a href="#l7.97"></a><span id="l7.97">   nsEudoraStringBundle::GetStringBundle();</span>
<a href="#l7.98"></a><span id="l7.98"> }</span>
<a href="#l7.99"></a><span id="l7.99"> </span>
<a href="#l7.100"></a><span id="l7.100"> </span>
<a href="#l7.101"></a><span id="l7.101"> nsEudoraImport::~nsEudoraImport()</span>
<a href="#l7.102"></a><span id="l7.102"> {</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-  IMPORT_LOG0( &quot;nsEudoraImport Module Deleted\n&quot;);</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+  IMPORT_LOG0(&quot;nsEudoraImport Module Deleted\n&quot;);</span>
<a href="#l7.105"></a><span id="l7.105"> }</span>
<a href="#l7.106"></a><span id="l7.106"> </span>
<a href="#l7.107"></a><span id="l7.107"> </span>
<a href="#l7.108"></a><span id="l7.108"> </span>
<a href="#l7.109"></a><span id="l7.109"> NS_IMPL_ISUPPORTS1(nsEudoraImport, nsIImportModule)</span>
<a href="#l7.110"></a><span id="l7.110"> </span>
<a href="#l7.111"></a><span id="l7.111"> </span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-NS_IMETHODIMP nsEudoraImport::GetName( PRUnichar **name)</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+NS_IMETHODIMP nsEudoraImport::GetName(PRUnichar **name)</span>
<a href="#l7.114"></a><span id="l7.114"> {</span>
<a href="#l7.115"></a><span id="l7.115">   NS_PRECONDITION(name != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.116"></a><span id="l7.116">   if (! name)</span>
<a href="#l7.117"></a><span id="l7.117">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.118"></a><span id="l7.118"> </span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-  *name = nsEudoraStringBundle::GetStringByID( EUDORAIMPORT_NAME);</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+  *name = nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_NAME);</span>
<a href="#l7.121"></a><span id="l7.121"> </span>
<a href="#l7.122"></a><span id="l7.122">   return NS_OK;</span>
<a href="#l7.123"></a><span id="l7.123"> }</span>
<a href="#l7.124"></a><span id="l7.124"> </span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-NS_IMETHODIMP nsEudoraImport::GetDescription( PRUnichar **name)</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+NS_IMETHODIMP nsEudoraImport::GetDescription(PRUnichar **name)</span>
<a href="#l7.127"></a><span id="l7.127"> {</span>
<a href="#l7.128"></a><span id="l7.128">   NS_PRECONDITION(name != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.129"></a><span id="l7.129">   if (! name)</span>
<a href="#l7.130"></a><span id="l7.130">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.131"></a><span id="l7.131"> </span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-  *name = nsEudoraStringBundle::GetStringByID( EUDORAIMPORT_DESCRIPTION);</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+  *name = nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_DESCRIPTION);</span>
<a href="#l7.134"></a><span id="l7.134"> </span>
<a href="#l7.135"></a><span id="l7.135">   return NS_OK;</span>
<a href="#l7.136"></a><span id="l7.136"> }</span>
<a href="#l7.137"></a><span id="l7.137"> </span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-NS_IMETHODIMP nsEudoraImport::GetSupports( char **supports)</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+NS_IMETHODIMP nsEudoraImport::GetSupports(char **supports)</span>
<a href="#l7.140"></a><span id="l7.140"> {</span>
<a href="#l7.141"></a><span id="l7.141">   NS_PRECONDITION(supports != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.142"></a><span id="l7.142">   if (! supports)</span>
<a href="#l7.143"></a><span id="l7.143">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.144"></a><span id="l7.144"> </span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-  *supports = strdup( kEudoraSupportsString);</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-  return( NS_OK);</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+  *supports = strdup(kEudoraSupportsString);</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.149"></a><span id="l7.149"> }</span>
<a href="#l7.150"></a><span id="l7.150"> </span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-NS_IMETHODIMP nsEudoraImport::GetSupportsUpgrade( bool *pUpgrade)</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+NS_IMETHODIMP nsEudoraImport::GetSupportsUpgrade(bool *pUpgrade)</span>
<a href="#l7.153"></a><span id="l7.153"> {</span>
<a href="#l7.154"></a><span id="l7.154">   NS_PRECONDITION(pUpgrade != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.155"></a><span id="l7.155">   if (! pUpgrade)</span>
<a href="#l7.156"></a><span id="l7.156">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.157"></a><span id="l7.157"> </span>
<a href="#l7.158"></a><span id="l7.158">   *pUpgrade = true;</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-  return( NS_OK);</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.161"></a><span id="l7.161"> }</span>
<a href="#l7.162"></a><span id="l7.162"> </span>
<a href="#l7.163"></a><span id="l7.163"> </span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-NS_IMETHODIMP nsEudoraImport::GetImportInterface( const char *pImportType, nsISupports **ppInterface)</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+NS_IMETHODIMP nsEudoraImport::GetImportInterface(const char *pImportType, nsISupports **ppInterface)</span>
<a href="#l7.166"></a><span id="l7.166"> {</span>
<a href="#l7.167"></a><span id="l7.167">   NS_PRECONDITION(pImportType != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.168"></a><span id="l7.168">   if (! pImportType)</span>
<a href="#l7.169"></a><span id="l7.169">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.170"></a><span id="l7.170">   NS_PRECONDITION(ppInterface != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.171"></a><span id="l7.171">   if (! ppInterface)</span>
<a href="#l7.172"></a><span id="l7.172">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.173"></a><span id="l7.173"> </span>
<a href="#l7.174"></a><span id="l7.174">   *ppInterface = nsnull;</span>
<a href="#l7.175"></a><span id="l7.175">   nsresult  rv;</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-  if (!strcmp( pImportType, &quot;mail&quot;))</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+  if (!strcmp(pImportType, &quot;mail&quot;))</span>
<a href="#l7.178"></a><span id="l7.178">   {</span>
<a href="#l7.179"></a><span id="l7.179">     // create the nsIImportMail interface and return it!</span>
<a href="#l7.180"></a><span id="l7.180">     nsIImportMail *  pMail = nsnull;</span>
<a href="#l7.181"></a><span id="l7.181">     nsIImportGeneric *pGeneric = nsnull;</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-    rv = ImportEudoraMailImpl::Create( &amp;pMail);</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-    if (NS_SUCCEEDED( rv)) {</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+    rv = ImportEudoraMailImpl::Create(&amp;pMail);</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.186"></a><span id="l7.186">       nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-      if (NS_SUCCEEDED( rv))</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l7.189"></a><span id="l7.189">       {</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-        rv = impSvc-&gt;CreateNewGenericMail( &amp;pGeneric);</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-        if (NS_SUCCEEDED( rv))</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+        rv = impSvc-&gt;CreateNewGenericMail(&amp;pGeneric);</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l7.194"></a><span id="l7.194">         {</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-          pGeneric-&gt;SetData( &quot;mailInterface&quot;, pMail);</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+          pGeneric-&gt;SetData(&quot;mailInterface&quot;, pMail);</span>
<a href="#l7.197"></a><span id="l7.197">           nsString name;</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-          nsEudoraStringBundle::GetStringByID( EUDORAIMPORT_NAME, name);</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+          nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_NAME, name);</span>
<a href="#l7.200"></a><span id="l7.200">           nsCOMPtr&lt;nsISupportsString&gt; nameString (do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv));</span>
<a href="#l7.201"></a><span id="l7.201">           if (NS_SUCCEEDED(rv))</span>
<a href="#l7.202"></a><span id="l7.202">           {</span>
<a href="#l7.203"></a><span id="l7.203">             nameString-&gt;SetData(name);</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-            pGeneric-&gt;SetData( &quot;name&quot;, nameString);</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-            rv = pGeneric-&gt;QueryInterface( kISupportsIID, (void **)ppInterface);</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+            pGeneric-&gt;SetData(&quot;name&quot;, nameString);</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+            rv = pGeneric-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l7.208"></a><span id="l7.208">           }</span>
<a href="#l7.209"></a><span id="l7.209">         }</span>
<a href="#l7.210"></a><span id="l7.210">       }</span>
<a href="#l7.211"></a><span id="l7.211">     }</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-    NS_IF_RELEASE( pMail);</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-    NS_IF_RELEASE( pGeneric);</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-    return( rv);</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+    NS_IF_RELEASE(pMail);</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+    NS_IF_RELEASE(pGeneric);</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+    return rv;</span>
<a href="#l7.218"></a><span id="l7.218">   }</span>
<a href="#l7.219"></a><span id="l7.219"> </span>
<a href="#l7.220"></a><span id="l7.220" class="difflineminus">-  if (!strcmp( pImportType, &quot;addressbook&quot;))</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+  if (!strcmp(pImportType, &quot;addressbook&quot;))</span>
<a href="#l7.222"></a><span id="l7.222">   {</span>
<a href="#l7.223"></a><span id="l7.223">     // create the nsIImportMail interface and return it!</span>
<a href="#l7.224"></a><span id="l7.224">     nsIImportAddressBooks *  pAddress = nsnull;</span>
<a href="#l7.225"></a><span id="l7.225">     nsIImportGeneric *    pGeneric = nsnull;</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-    rv = ImportEudoraAddressImpl::Create( &amp;pAddress);</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-    if (NS_SUCCEEDED( rv))</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+    rv = ImportEudoraAddressImpl::Create(&amp;pAddress);</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l7.230"></a><span id="l7.230">     {</span>
<a href="#l7.231"></a><span id="l7.231">       nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-      if (NS_SUCCEEDED( rv))</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l7.234"></a><span id="l7.234">       {</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineminus">-        rv = impSvc-&gt;CreateNewGenericAddressBooks( &amp;pGeneric);</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineminus">-        if (NS_SUCCEEDED( rv))</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+        rv = impSvc-&gt;CreateNewGenericAddressBooks(&amp;pGeneric);</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l7.239"></a><span id="l7.239">         {</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-          pGeneric-&gt;SetData( &quot;addressInterface&quot;, pAddress);</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineminus">-          rv = pGeneric-&gt;QueryInterface( kISupportsIID, (void **)ppInterface);</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+          pGeneric-&gt;SetData(&quot;addressInterface&quot;, pAddress);</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+          rv = pGeneric-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l7.244"></a><span id="l7.244">         }</span>
<a href="#l7.245"></a><span id="l7.245">       }</span>
<a href="#l7.246"></a><span id="l7.246">     }</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineminus">-    NS_IF_RELEASE( pAddress);</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-    NS_IF_RELEASE( pGeneric);</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-    return( rv);</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineplus">+    NS_IF_RELEASE(pAddress);</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+    NS_IF_RELEASE(pGeneric);</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+    return rv;</span>
<a href="#l7.253"></a><span id="l7.253">   }</span>
<a href="#l7.254"></a><span id="l7.254"> </span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">-  if (!strcmp( pImportType, &quot;settings&quot;))</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+  if (!strcmp(pImportType, &quot;settings&quot;))</span>
<a href="#l7.257"></a><span id="l7.257">   {</span>
<a href="#l7.258"></a><span id="l7.258">     nsIImportSettings *pSettings = nsnull;</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-    rv = nsEudoraSettings::Create( &amp;pSettings);</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-    if (NS_SUCCEEDED( rv))</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-      pSettings-&gt;QueryInterface( kISupportsIID, (void **)ppInterface);</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-    NS_IF_RELEASE( pSettings);</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">-    return( rv);</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+    rv = nsEudoraSettings::Create(&amp;pSettings);</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+      pSettings-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineplus">+    NS_IF_RELEASE(pSettings);</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+    return rv;</span>
<a href="#l7.269"></a><span id="l7.269">   }</span>
<a href="#l7.270"></a><span id="l7.270"> </span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-  if (!strcmp( pImportType, &quot;filters&quot;))</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+  if (!strcmp(pImportType, &quot;filters&quot;))</span>
<a href="#l7.273"></a><span id="l7.273">   {</span>
<a href="#l7.274"></a><span id="l7.274">     nsIImportFilters *pFilters = nsnull;</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineminus">-    rv = nsEudoraFilters::Create( &amp;pFilters);</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineminus">-    if (NS_SUCCEEDED( rv))</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-      pFilters-&gt;QueryInterface( kISupportsIID, (void **)ppInterface);</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-    NS_IF_RELEASE( pFilters);</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-    return( rv);</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+    rv = nsEudoraFilters::Create(&amp;pFilters);</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+      pFilters-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+    NS_IF_RELEASE(pFilters);</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+    return rv;</span>
<a href="#l7.285"></a><span id="l7.285">   }</span>
<a href="#l7.286"></a><span id="l7.286"> </span>
<a href="#l7.287"></a><span id="l7.287" class="difflineminus">-  return( NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l7.289"></a><span id="l7.289"> }</span>
<a href="#l7.290"></a><span id="l7.290"> </span>
<a href="#l7.291"></a><span id="l7.291"> /////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.292"></a><span id="l7.292"> nsresult ImportEudoraMailImpl::Create(nsIImportMail** aImport)</span>
<a href="#l7.293"></a><span id="l7.293"> {</span>
<a href="#l7.294"></a><span id="l7.294">   NS_PRECONDITION(aImport != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.295"></a><span id="l7.295">   if (! aImport)</span>
<a href="#l7.296"></a><span id="l7.296">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineat">@@ -374,17 +374,17 @@ ImportEudoraMailImpl::ImportEudoraMailIm</span>
<a href="#l7.298"></a><span id="l7.298">   // Ideally importing the settings will have already created these,</span>
<a href="#l7.299"></a><span id="l7.299">   // in which case we won't bother (we'll detect that each key already</span>
<a href="#l7.300"></a><span id="l7.300">   // exists). But to be sure we need to create the keys here, at</span>
<a href="#l7.301"></a><span id="l7.301">   // least until the infrastructure is improved in some fashion so</span>
<a href="#l7.302"></a><span id="l7.302">   // that we can rely on settings *always* being imported before mail.</span>
<a href="#l7.303"></a><span id="l7.303">   nsresult            rv;</span>
<a href="#l7.304"></a><span id="l7.304">   nsCOMPtr&lt;nsIMsgTagService&gt;    pTagService = do_GetService(NS_MSGTAGSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l7.305"></a><span id="l7.305"> </span>
<a href="#l7.306"></a><span id="l7.306" class="difflineminus">-  if ( NS_SUCCEEDED(rv) )</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l7.308"></a><span id="l7.308">   {</span>
<a href="#l7.309"></a><span id="l7.309">     struct EudoraDefaultLabels</span>
<a href="#l7.310"></a><span id="l7.310">     {</span>
<a href="#l7.311"></a><span id="l7.311">       char *    key;</span>
<a href="#l7.312"></a><span id="l7.312">       nsString  tag;</span>
<a href="#l7.313"></a><span id="l7.313">       char *    color;</span>
<a href="#l7.314"></a><span id="l7.314">     };</span>
<a href="#l7.315"></a><span id="l7.315"> </span>
<a href="#l7.316"></a><span id="l7.316" class="difflineat">@@ -414,20 +414,20 @@ ImportEudoraMailImpl::ImportEudoraMailIm</span>
<a href="#l7.317"></a><span id="l7.317">     nsCString      eudoraKey;</span>
<a href="#l7.318"></a><span id="l7.318">     nsString      eudoraTag;</span>
<a href="#l7.319"></a><span id="l7.319">     nsCString      eudoraColor;</span>
<a href="#l7.320"></a><span id="l7.320"> </span>
<a href="#l7.321"></a><span id="l7.321">     for (PRInt16 i = 0; i &lt; kNumEudoraLabels; i++)</span>
<a href="#l7.322"></a><span id="l7.322">     {</span>
<a href="#l7.323"></a><span id="l7.323">       eudoraKey = defaultEudoraLabels[i].key;</span>
<a href="#l7.324"></a><span id="l7.324">       rv = pTagService-&gt;GetTagForKey(eudoraKey, eudoraTag);</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineminus">-      if ( NS_FAILED(rv) || eudoraTag.IsEmpty() )</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineplus">+      if (NS_FAILED(rv) || eudoraTag.IsEmpty())</span>
<a href="#l7.327"></a><span id="l7.327">       {</span>
<a href="#l7.328"></a><span id="l7.328">         eudoraColor = defaultEudoraLabels[i].color;</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineminus">-        rv = pTagService-&gt;AddTagForKey( eudoraKey, defaultEudoraLabels[i].tag, eudoraColor, EmptyCString() );</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineplus">+        rv = pTagService-&gt;AddTagForKey(eudoraKey, defaultEudoraLabels[i].tag, eudoraColor, EmptyCString());</span>
<a href="#l7.331"></a><span id="l7.331">       }</span>
<a href="#l7.332"></a><span id="l7.332">     }</span>
<a href="#l7.333"></a><span id="l7.333">   }</span>
<a href="#l7.334"></a><span id="l7.334"> }</span>
<a href="#l7.335"></a><span id="l7.335"> </span>
<a href="#l7.336"></a><span id="l7.336"> </span>
<a href="#l7.337"></a><span id="l7.337"> ImportEudoraMailImpl::~ImportEudoraMailImpl()</span>
<a href="#l7.338"></a><span id="l7.338"> {</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineat">@@ -435,88 +435,85 @@ ImportEudoraMailImpl::~ImportEudoraMailI</span>
<a href="#l7.340"></a><span id="l7.340">   // that it creates when we import any mail.</span>
<a href="#l7.341"></a><span id="l7.341">   nsEudoraCompose::ReleaseIdentity();</span>
<a href="#l7.342"></a><span id="l7.342"> }</span>
<a href="#l7.343"></a><span id="l7.343"> </span>
<a href="#l7.344"></a><span id="l7.344"> </span>
<a href="#l7.345"></a><span id="l7.345"> </span>
<a href="#l7.346"></a><span id="l7.346"> NS_IMPL_THREADSAFE_ISUPPORTS1(ImportEudoraMailImpl, nsIImportMail)</span>
<a href="#l7.347"></a><span id="l7.347"> </span>
<a href="#l7.348"></a><span id="l7.348" class="difflineminus">-NS_IMETHODIMP ImportEudoraMailImpl::GetDefaultLocation( nsIFile **ppLoc, bool *found, bool *userVerify)</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineplus">+NS_IMETHODIMP ImportEudoraMailImpl::GetDefaultLocation(nsIFile **ppLoc, bool *found, bool *userVerify)</span>
<a href="#l7.350"></a><span id="l7.350"> {</span>
<a href="#l7.351"></a><span id="l7.351">   NS_PRECONDITION(ppLoc != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.352"></a><span id="l7.352">   NS_PRECONDITION(found != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.353"></a><span id="l7.353">   NS_PRECONDITION(userVerify != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.354"></a><span id="l7.354">   if (!ppLoc || !found || !userVerify)</span>
<a href="#l7.355"></a><span id="l7.355">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.356"></a><span id="l7.356"> </span>
<a href="#l7.357"></a><span id="l7.357">   *ppLoc = nsnull;</span>
<a href="#l7.358"></a><span id="l7.358">   *found = m_eudora.FindMailFolder(ppLoc);</span>
<a href="#l7.359"></a><span id="l7.359">   *userVerify = true;</span>
<a href="#l7.360"></a><span id="l7.360"> </span>
<a href="#l7.361"></a><span id="l7.361" class="difflineminus">-  return( NS_OK);</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.363"></a><span id="l7.363"> }</span>
<a href="#l7.364"></a><span id="l7.364"> </span>
<a href="#l7.365"></a><span id="l7.365"> </span>
<a href="#l7.366"></a><span id="l7.366" class="difflineminus">-NS_IMETHODIMP ImportEudoraMailImpl::FindMailboxes( nsIFile *pLoc, nsISupportsArray **ppArray)</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineplus">+NS_IMETHODIMP ImportEudoraMailImpl::FindMailboxes(nsIFile *pLoc, nsISupportsArray **ppArray)</span>
<a href="#l7.368"></a><span id="l7.368"> {</span>
<a href="#l7.369"></a><span id="l7.369">   NS_PRECONDITION(pLoc != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.370"></a><span id="l7.370">   NS_PRECONDITION(ppArray != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.371"></a><span id="l7.371">   if (!pLoc || !ppArray)</span>
<a href="#l7.372"></a><span id="l7.372">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.373"></a><span id="l7.373"> </span>
<a href="#l7.374"></a><span id="l7.374">   bool exists = false;</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineminus">-  nsresult rv = pLoc-&gt;Exists( &amp;exists);</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineminus">-  if (NS_FAILED( rv) || !exists)</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineplus">+  nsresult rv = pLoc-&gt;Exists(&amp;exists);</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineplus">+  if (NS_FAILED(rv) || !exists)</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l7.381"></a><span id="l7.381"> </span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-  rv = m_eudora.FindMailboxes( pLoc, ppArray);</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineminus">-  if (NS_FAILED( rv) &amp;&amp; *ppArray)</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineminus">-  {</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineminus">-    NS_RELEASE( *ppArray);</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineminus">-    *ppArray = nsnull;</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineminus">-  }</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineplus">+  rv = m_eudora.FindMailboxes(pLoc, ppArray);</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+  if (NS_FAILED(rv) &amp;&amp; *ppArray)</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineplus">+    NS_RELEASE(*ppArray);</span>
<a href="#l7.391"></a><span id="l7.391"> </span>
<a href="#l7.392"></a><span id="l7.392" class="difflineminus">-  return( rv);</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineplus">+  return rv;</span>
<a href="#l7.394"></a><span id="l7.394"> }</span>
<a href="#l7.395"></a><span id="l7.395"> </span>
<a href="#l7.396"></a><span id="l7.396" class="difflineminus">-void ImportEudoraMailImpl::AddLinebreak( nsString *pStream)</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+void ImportEudoraMailImpl::AddLinebreak(nsString *pStream)</span>
<a href="#l7.398"></a><span id="l7.398"> {</span>
<a href="#l7.399"></a><span id="l7.399">   if (pStream)</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineminus">-    pStream-&gt;Append( PRUnichar('\n'));</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineplus">+    pStream-&gt;Append(PRUnichar('\n'));</span>
<a href="#l7.402"></a><span id="l7.402"> }</span>
<a href="#l7.403"></a><span id="l7.403"> </span>
<a href="#l7.404"></a><span id="l7.404" class="difflineminus">-void ImportEudoraMailImpl::ReportSuccess( nsString&amp; name, PRInt32 count, nsString *pStream)</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineplus">+void ImportEudoraMailImpl::ReportSuccess(nsString&amp; name, PRInt32 count, nsString *pStream)</span>
<a href="#l7.406"></a><span id="l7.406"> {</span>
<a href="#l7.407"></a><span id="l7.407">   if (!pStream)</span>
<a href="#l7.408"></a><span id="l7.408">     return;</span>
<a href="#l7.409"></a><span id="l7.409">   // load the success string</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineminus">-  PRUnichar *pFmt = nsEudoraStringBundle::GetStringByID( EUDORAIMPORT_MAILBOX_SUCCESS);</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineminus">-  PRUnichar *pText = nsTextFormatter::smprintf( pFmt, name.get(), count);</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineminus">-  pStream-&gt;Append( pText);</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineminus">-  nsTextFormatter::smprintf_free( pText);</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineminus">-  nsEudoraStringBundle::FreeString( pFmt);</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineminus">-  AddLinebreak( pStream);</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineplus">+  PRUnichar *pFmt = nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_MAILBOX_SUCCESS);</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineplus">+  PRUnichar *pText = nsTextFormatter::smprintf(pFmt, name.get(), count);</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineplus">+  pStream-&gt;Append(pText);</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineplus">+  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineplus">+  nsEudoraStringBundle::FreeString(pFmt);</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineplus">+  AddLinebreak(pStream);</span>
<a href="#l7.422"></a><span id="l7.422"> }</span>
<a href="#l7.423"></a><span id="l7.423"> </span>
<a href="#l7.424"></a><span id="l7.424" class="difflineminus">-void ImportEudoraMailImpl::ReportError( PRInt32 errorNum, nsString&amp; name, nsString *pStream)</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineplus">+void ImportEudoraMailImpl::ReportError(PRInt32 errorNum, nsString&amp; name, nsString *pStream)</span>
<a href="#l7.426"></a><span id="l7.426"> {</span>
<a href="#l7.427"></a><span id="l7.427">   if (!pStream)</span>
<a href="#l7.428"></a><span id="l7.428">     return;</span>
<a href="#l7.429"></a><span id="l7.429">   // load the error string</span>
<a href="#l7.430"></a><span id="l7.430">   PRUnichar *pFmt = nsEudoraStringBundle::GetStringByID(errorNum);</span>
<a href="#l7.431"></a><span id="l7.431">   PRUnichar *pText = nsTextFormatter::smprintf(pFmt, name.get());</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineminus">-  pStream-&gt;Append( pText);</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineminus">-  nsTextFormatter::smprintf_free( pText);</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineminus">-  nsEudoraStringBundle::FreeString( pFmt);</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineminus">-  AddLinebreak( pStream);</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineplus">+  pStream-&gt;Append(pText);</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineplus">+  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineplus">+  nsEudoraStringBundle::FreeString(pFmt);</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineplus">+  AddLinebreak(pStream);</span>
<a href="#l7.440"></a><span id="l7.440"> }</span>
<a href="#l7.441"></a><span id="l7.441"> </span>
<a href="#l7.442"></a><span id="l7.442"> </span>
<a href="#l7.443"></a><span id="l7.443" class="difflineminus">-void ImportEudoraMailImpl::SetLogs( nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess)</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineplus">+void ImportEudoraMailImpl::SetLogs(nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess)</span>
<a href="#l7.445"></a><span id="l7.445"> {</span>
<a href="#l7.446"></a><span id="l7.446">   if (pError)</span>
<a href="#l7.447"></a><span id="l7.447">     *pError = ToNewUnicode(error);</span>
<a href="#l7.448"></a><span id="l7.448">   if (pSuccess)</span>
<a href="#l7.449"></a><span id="l7.449">     *pSuccess = ToNewUnicode(success);</span>
<a href="#l7.450"></a><span id="l7.450"> }</span>
<a href="#l7.451"></a><span id="l7.451"> </span>
<a href="#l7.452"></a><span id="l7.452"> NS_IMETHODIMP ImportEudoraMailImpl::ImportMailbox(nsIImportMailboxDescriptor *pSource,</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineat">@@ -528,85 +525,85 @@ NS_IMETHODIMP ImportEudoraMailImpl::Impo</span>
<a href="#l7.454"></a><span id="l7.454">   NS_PRECONDITION(pSource != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.455"></a><span id="l7.455">   NS_PRECONDITION(pDestination != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.456"></a><span id="l7.456">   NS_PRECONDITION(fatalError != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.457"></a><span id="l7.457"> </span>
<a href="#l7.458"></a><span id="l7.458">   nsString  success;</span>
<a href="#l7.459"></a><span id="l7.459">   nsString  error;</span>
<a href="#l7.460"></a><span id="l7.460">   if (!pSource || !pDestination || !fatalError)</span>
<a href="#l7.461"></a><span id="l7.461">   {</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineminus">-    IMPORT_LOG0( &quot;*** Bad param passed to eudora mailbox import\n&quot;);</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineminus">-    nsEudoraStringBundle::GetStringByID( EUDORAIMPORT_MAILBOX_BADPARAM, error);</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineplus">+    IMPORT_LOG0(&quot;*** Bad param passed to eudora mailbox import\n&quot;);</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineplus">+    nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_MAILBOX_BADPARAM, error);</span>
<a href="#l7.466"></a><span id="l7.466">     if (fatalError)</span>
<a href="#l7.467"></a><span id="l7.467">       *fatalError = true;</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineminus">-    SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l7.469"></a><span id="l7.469" class="difflineplus">+    SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l7.470"></a><span id="l7.470">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.471"></a><span id="l7.471">   }</span>
<a href="#l7.472"></a><span id="l7.472"> </span>
<a href="#l7.473"></a><span id="l7.473">   bool      abort = false;</span>
<a href="#l7.474"></a><span id="l7.474">   nsString  name;</span>
<a href="#l7.475"></a><span id="l7.475">   PRUnichar *  pName;</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineminus">-  if (NS_SUCCEEDED( pSource-&gt;GetDisplayName( &amp;pName)))</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineplus">+  if (NS_SUCCEEDED(pSource-&gt;GetDisplayName(&amp;pName)))</span>
<a href="#l7.478"></a><span id="l7.478">   {</span>
<a href="#l7.479"></a><span id="l7.479">     name = pName;</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineminus">-    NS_Free( pName);</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineplus">+    NS_Free(pName);</span>
<a href="#l7.482"></a><span id="l7.482">   }</span>
<a href="#l7.483"></a><span id="l7.483"> </span>
<a href="#l7.484"></a><span id="l7.484">   PRUint32 mailSize = 0;</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineminus">-  pSource-&gt;GetSize( &amp;mailSize);</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineplus">+  pSource-&gt;GetSize(&amp;mailSize);</span>
<a href="#l7.487"></a><span id="l7.487">   if (mailSize == 0)</span>
<a href="#l7.488"></a><span id="l7.488">   {</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineminus">-    IMPORT_LOG0( &quot;Mailbox size is 0, skipping mailbox.\n&quot;);</span>
<a href="#l7.490"></a><span id="l7.490" class="difflineminus">-    ReportSuccess( name, 0, &amp;success);</span>
<a href="#l7.491"></a><span id="l7.491" class="difflineminus">-    SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l7.492"></a><span id="l7.492" class="difflineminus">-    return( NS_OK);</span>
<a href="#l7.493"></a><span id="l7.493" class="difflineplus">+    IMPORT_LOG0(&quot;Mailbox size is 0, skipping mailbox.\n&quot;);</span>
<a href="#l7.494"></a><span id="l7.494" class="difflineplus">+    ReportSuccess(name, 0, &amp;success);</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineplus">+    SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l7.496"></a><span id="l7.496" class="difflineplus">+    return NS_OK;</span>
<a href="#l7.497"></a><span id="l7.497">   }</span>
<a href="#l7.498"></a><span id="l7.498"> </span>
<a href="#l7.499"></a><span id="l7.499"> </span>
<a href="#l7.500"></a><span id="l7.500">   nsCOMPtr &lt;nsILocalFile&gt;  inFile;</span>
<a href="#l7.501"></a><span id="l7.501" class="difflineminus">-  if (NS_FAILED(pSource-&gt;GetFile( getter_AddRefs(inFile))))</span>
<a href="#l7.502"></a><span id="l7.502" class="difflineplus">+  if (NS_FAILED(pSource-&gt;GetFile(getter_AddRefs(inFile))))</span>
<a href="#l7.503"></a><span id="l7.503">   {</span>
<a href="#l7.504"></a><span id="l7.504" class="difflineminus">-    ReportError( EUDORAIMPORT_MAILBOX_BADSOURCEFILE, name, &amp;error);</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineminus">-    SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineplus">+    ReportError(EUDORAIMPORT_MAILBOX_BADSOURCEFILE, name, &amp;error);</span>
<a href="#l7.508"></a><span id="l7.508" class="difflineplus">+    SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l7.510"></a><span id="l7.510">   }</span>
<a href="#l7.511"></a><span id="l7.511"> </span>
<a href="#l7.512"></a><span id="l7.512"> #ifdef IMPORT_DEBUG</span>
<a href="#l7.513"></a><span id="l7.513">   nsCString pPath;</span>
<a href="#l7.514"></a><span id="l7.514">   inFile-&gt;GetNativePath(pPath);</span>
<a href="#l7.515"></a><span id="l7.515" class="difflineminus">-  IMPORT_LOG1( &quot;Import mailbox: %s\n&quot;, pPath.get());</span>
<a href="#l7.516"></a><span id="l7.516" class="difflineplus">+  IMPORT_LOG1(&quot;Import mailbox: %s\n&quot;, pPath.get());</span>
<a href="#l7.517"></a><span id="l7.517"> #endif</span>
<a href="#l7.518"></a><span id="l7.518"> </span>
<a href="#l7.519"></a><span id="l7.519"> </span>
<a href="#l7.520"></a><span id="l7.520">   PRInt32  msgCount = 0;</span>
<a href="#l7.521"></a><span id="l7.521">   nsresult rv = NS_OK;</span>
<a href="#l7.522"></a><span id="l7.522"> </span>
<a href="#l7.523"></a><span id="l7.523">   m_bytes = 0;</span>
<a href="#l7.524"></a><span id="l7.524" class="difflineminus">-  rv = m_eudora.ImportMailbox( &amp;m_bytes, &amp;abort, name.get(), inFile, pDestination, &amp;msgCount);</span>
<a href="#l7.525"></a><span id="l7.525" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l7.526"></a><span id="l7.526" class="difflineminus">-    ReportSuccess( name, msgCount, &amp;success);</span>
<a href="#l7.527"></a><span id="l7.527" class="difflineplus">+  rv = m_eudora.ImportMailbox(&amp;m_bytes, &amp;abort, name.get(), inFile, pDestination, &amp;msgCount);</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l7.529"></a><span id="l7.529" class="difflineplus">+    ReportSuccess(name, msgCount, &amp;success);</span>
<a href="#l7.530"></a><span id="l7.530">   else</span>
<a href="#l7.531"></a><span id="l7.531" class="difflineminus">-    ReportError( EUDORAIMPORT_MAILBOX_CONVERTERROR, name, &amp;error);</span>
<a href="#l7.532"></a><span id="l7.532" class="difflineplus">+    ReportError(EUDORAIMPORT_MAILBOX_CONVERTERROR, name, &amp;error);</span>
<a href="#l7.533"></a><span id="l7.533"> </span>
<a href="#l7.534"></a><span id="l7.534" class="difflineminus">-  SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l7.535"></a><span id="l7.535" class="difflineplus">+  SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l7.536"></a><span id="l7.536"> </span>
<a href="#l7.537"></a><span id="l7.537" class="difflineminus">-  IMPORT_LOG0( &quot;*** Returning from eudora mailbox import\n&quot;);</span>
<a href="#l7.538"></a><span id="l7.538" class="difflineplus">+  IMPORT_LOG0(&quot;*** Returning from eudora mailbox import\n&quot;);</span>
<a href="#l7.539"></a><span id="l7.539"> </span>
<a href="#l7.540"></a><span id="l7.540" class="difflineminus">-  return( rv);</span>
<a href="#l7.541"></a><span id="l7.541" class="difflineplus">+  return rv;</span>
<a href="#l7.542"></a><span id="l7.542"> }</span>
<a href="#l7.543"></a><span id="l7.543"> </span>
<a href="#l7.544"></a><span id="l7.544"> </span>
<a href="#l7.545"></a><span id="l7.545" class="difflineminus">-NS_IMETHODIMP ImportEudoraMailImpl::GetImportProgress( PRUint32 *pDoneSoFar)</span>
<a href="#l7.546"></a><span id="l7.546" class="difflineplus">+NS_IMETHODIMP ImportEudoraMailImpl::GetImportProgress(PRUint32 *pDoneSoFar)</span>
<a href="#l7.547"></a><span id="l7.547"> {</span>
<a href="#l7.548"></a><span id="l7.548">   NS_PRECONDITION(pDoneSoFar != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.549"></a><span id="l7.549">   if (! pDoneSoFar)</span>
<a href="#l7.550"></a><span id="l7.550">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.551"></a><span id="l7.551"> </span>
<a href="#l7.552"></a><span id="l7.552">   *pDoneSoFar = m_bytes;</span>
<a href="#l7.553"></a><span id="l7.553" class="difflineminus">-  return( NS_OK);</span>
<a href="#l7.554"></a><span id="l7.554" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.555"></a><span id="l7.555"> }</span>
<a href="#l7.556"></a><span id="l7.556"> </span>
<a href="#l7.557"></a><span id="l7.557"> </span>
<a href="#l7.558"></a><span id="l7.558"> NS_IMETHODIMP ImportEudoraMailImpl::TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval)</span>
<a href="#l7.559"></a><span id="l7.559"> {</span>
<a href="#l7.560"></a><span id="l7.560">   if (aFolderName.LowerCaseEqualsLiteral(&quot;out&quot;))</span>
<a href="#l7.561"></a><span id="l7.561">     _retval = NS_LITERAL_STRING(kDestSentFolderName);</span>
<a href="#l7.562"></a><span id="l7.562">   else if (aFolderName.LowerCaseEqualsLiteral(&quot;in&quot;))</span>
<a href="#l7.563"></a><span id="l7.563" class="difflineat">@@ -648,155 +645,151 @@ NS_IMETHODIMP ImportEudoraAddressImpl::G</span>
<a href="#l7.564"></a><span id="l7.564"> {</span>
<a href="#l7.565"></a><span id="l7.565">   NS_PRECONDITION(description != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.566"></a><span id="l7.566">   NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.567"></a><span id="l7.567">   if (! description || !_retval)</span>
<a href="#l7.568"></a><span id="l7.568">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.569"></a><span id="l7.569"> </span>
<a href="#l7.570"></a><span id="l7.570">   nsString  str;</span>
<a href="#l7.571"></a><span id="l7.571">   *_retval = false;</span>
<a href="#l7.572"></a><span id="l7.572" class="difflineminus">-  nsEudoraStringBundle::GetStringByID( EUDORAIMPORT_NICKNAMES_NAME, str);</span>
<a href="#l7.573"></a><span id="l7.573" class="difflineplus">+  nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_NICKNAMES_NAME, str);</span>
<a href="#l7.574"></a><span id="l7.574">   *description = ToNewUnicode(str);</span>
<a href="#l7.575"></a><span id="l7.575"> </span>
<a href="#l7.576"></a><span id="l7.576" class="difflineminus">-  return( NS_OK);</span>
<a href="#l7.577"></a><span id="l7.577" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.578"></a><span id="l7.578"> }</span>
<a href="#l7.579"></a><span id="l7.579"> </span>
<a href="#l7.580"></a><span id="l7.580"> </span>
<a href="#l7.581"></a><span id="l7.581"> NS_IMETHODIMP ImportEudoraAddressImpl::GetDefaultLocation(nsIFile **ppLoc, bool *found, bool *userVerify)</span>
<a href="#l7.582"></a><span id="l7.582"> {</span>
<a href="#l7.583"></a><span id="l7.583">   NS_PRECONDITION(found != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.584"></a><span id="l7.584">   NS_PRECONDITION(ppLoc != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.585"></a><span id="l7.585">   NS_PRECONDITION(userVerify != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.586"></a><span id="l7.586">   if (! found || !userVerify || !ppLoc)</span>
<a href="#l7.587"></a><span id="l7.587">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.588"></a><span id="l7.588"> </span>
<a href="#l7.589"></a><span id="l7.589">   *ppLoc = nsnull;</span>
<a href="#l7.590"></a><span id="l7.590">   *found = m_eudora.FindAddressFolder(ppLoc);</span>
<a href="#l7.591"></a><span id="l7.591">   *userVerify = true;</span>
<a href="#l7.592"></a><span id="l7.592"> </span>
<a href="#l7.593"></a><span id="l7.593" class="difflineminus">-  return( NS_OK);</span>
<a href="#l7.594"></a><span id="l7.594" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.595"></a><span id="l7.595"> }</span>
<a href="#l7.596"></a><span id="l7.596"> </span>
<a href="#l7.597"></a><span id="l7.597"> </span>
<a href="#l7.598"></a><span id="l7.598"> </span>
<a href="#l7.599"></a><span id="l7.599"> NS_IMETHODIMP ImportEudoraAddressImpl::FindAddressBooks(nsIFile *pLoc, nsISupportsArray **ppArray)</span>
<a href="#l7.600"></a><span id="l7.600"> {</span>
<a href="#l7.601"></a><span id="l7.601">     NS_PRECONDITION(pLoc != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.602"></a><span id="l7.602">     NS_PRECONDITION(ppArray != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.603"></a><span id="l7.603">     if (!pLoc || !ppArray)</span>
<a href="#l7.604"></a><span id="l7.604">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.605"></a><span id="l7.605"> </span>
<a href="#l7.606"></a><span id="l7.606">   bool exists = false;</span>
<a href="#l7.607"></a><span id="l7.607" class="difflineminus">-  nsresult rv = pLoc-&gt;Exists( &amp;exists);</span>
<a href="#l7.608"></a><span id="l7.608" class="difflineminus">-  if (NS_FAILED( rv) || !exists)</span>
<a href="#l7.609"></a><span id="l7.609" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l7.610"></a><span id="l7.610" class="difflineplus">+  nsresult rv = pLoc-&gt;Exists(&amp;exists);</span>
<a href="#l7.611"></a><span id="l7.611" class="difflineplus">+  if (NS_FAILED(rv) || !exists)</span>
<a href="#l7.612"></a><span id="l7.612" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l7.613"></a><span id="l7.613"> </span>
<a href="#l7.614"></a><span id="l7.614" class="difflineminus">-  rv = m_eudora.FindAddressBooks( pLoc, ppArray);</span>
<a href="#l7.615"></a><span id="l7.615" class="difflineminus">-  if (NS_FAILED( rv) &amp;&amp; *ppArray) {</span>
<a href="#l7.616"></a><span id="l7.616" class="difflineminus">-    NS_RELEASE( *ppArray);</span>
<a href="#l7.617"></a><span id="l7.617" class="difflineminus">-    *ppArray = nsnull;</span>
<a href="#l7.618"></a><span id="l7.618" class="difflineminus">-  }</span>
<a href="#l7.619"></a><span id="l7.619" class="difflineplus">+  rv = m_eudora.FindAddressBooks(pLoc, ppArray);</span>
<a href="#l7.620"></a><span id="l7.620" class="difflineplus">+  if (NS_FAILED(rv) &amp;&amp; *ppArray)</span>
<a href="#l7.621"></a><span id="l7.621" class="difflineplus">+    NS_RELEASE(*ppArray);</span>
<a href="#l7.622"></a><span id="l7.622"> </span>
<a href="#l7.623"></a><span id="l7.623" class="difflineminus">-  return( rv);</span>
<a href="#l7.624"></a><span id="l7.624" class="difflineplus">+  return rv;</span>
<a href="#l7.625"></a><span id="l7.625"> }</span>
<a href="#l7.626"></a><span id="l7.626"> </span>
<a href="#l7.627"></a><span id="l7.627"> </span>
<a href="#l7.628"></a><span id="l7.628"> </span>
<a href="#l7.629"></a><span id="l7.629" class="difflineminus">-void ImportEudoraAddressImpl::ReportSuccess( nsString&amp; name, nsString *pStream)</span>
<a href="#l7.630"></a><span id="l7.630" class="difflineplus">+void ImportEudoraAddressImpl::ReportSuccess(nsString&amp; name, nsString *pStream)</span>
<a href="#l7.631"></a><span id="l7.631"> {</span>
<a href="#l7.632"></a><span id="l7.632">   if (!pStream)</span>
<a href="#l7.633"></a><span id="l7.633">     return;</span>
<a href="#l7.634"></a><span id="l7.634">   // load the success string</span>
<a href="#l7.635"></a><span id="l7.635" class="difflineminus">-  PRUnichar *pFmt = nsEudoraStringBundle::GetStringByID( EUDORAIMPORT_ADDRESS_SUCCESS);</span>
<a href="#l7.636"></a><span id="l7.636" class="difflineminus">-  PRUnichar *pText = nsTextFormatter::smprintf( pFmt, name.get());</span>
<a href="#l7.637"></a><span id="l7.637" class="difflineminus">-  pStream-&gt;Append( pText);</span>
<a href="#l7.638"></a><span id="l7.638" class="difflineminus">-  nsTextFormatter::smprintf_free( pText);</span>
<a href="#l7.639"></a><span id="l7.639" class="difflineminus">-  nsEudoraStringBundle::FreeString( pFmt);</span>
<a href="#l7.640"></a><span id="l7.640" class="difflineminus">-  ImportEudoraMailImpl::AddLinebreak( pStream);</span>
<a href="#l7.641"></a><span id="l7.641" class="difflineplus">+  PRUnichar *pFmt = nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_ADDRESS_SUCCESS);</span>
<a href="#l7.642"></a><span id="l7.642" class="difflineplus">+  PRUnichar *pText = nsTextFormatter::smprintf(pFmt, name.get());</span>
<a href="#l7.643"></a><span id="l7.643" class="difflineplus">+  pStream-&gt;Append(pText);</span>
<a href="#l7.644"></a><span id="l7.644" class="difflineplus">+  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l7.645"></a><span id="l7.645" class="difflineplus">+  nsEudoraStringBundle::FreeString(pFmt);</span>
<a href="#l7.646"></a><span id="l7.646" class="difflineplus">+  ImportEudoraMailImpl::AddLinebreak(pStream);</span>
<a href="#l7.647"></a><span id="l7.647"> }</span>
<a href="#l7.648"></a><span id="l7.648"> </span>
<a href="#l7.649"></a><span id="l7.649"> </span>
<a href="#l7.650"></a><span id="l7.650"> NS_IMETHODIMP</span>
<a href="#l7.651"></a><span id="l7.651"> ImportEudoraAddressImpl::ImportAddressBook(nsIImportABDescriptor *pSource,</span>
<a href="#l7.652"></a><span id="l7.652">                                            nsIAddrDatabase *pDestination,</span>
<a href="#l7.653"></a><span id="l7.653">                                            nsIImportFieldMap *fieldMap,</span>
<a href="#l7.654"></a><span id="l7.654">                                            nsISupports *aSupportService,</span>
<a href="#l7.655"></a><span id="l7.655">                                            PRUnichar **pErrorLog,</span>
<a href="#l7.656"></a><span id="l7.656">                                            PRUnichar **pSuccessLog,</span>
<a href="#l7.657"></a><span id="l7.657">                                            bool *fatalError)</span>
<a href="#l7.658"></a><span id="l7.658"> {</span>
<a href="#l7.659"></a><span id="l7.659" class="difflineminus">-    NS_PRECONDITION(pSource != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.660"></a><span id="l7.660" class="difflineminus">-    NS_PRECONDITION(pDestination != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.661"></a><span id="l7.661" class="difflineminus">-    NS_PRECONDITION(fatalError != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.662"></a><span id="l7.662" class="difflineplus">+  NS_PRECONDITION(pSource != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.663"></a><span id="l7.663" class="difflineplus">+  NS_PRECONDITION(pDestination != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.664"></a><span id="l7.664" class="difflineplus">+  NS_PRECONDITION(fatalError != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.665"></a><span id="l7.665"> </span>
<a href="#l7.666"></a><span id="l7.666" class="difflineminus">-  nsString  success;</span>
<a href="#l7.667"></a><span id="l7.667" class="difflineminus">-  nsString  error;</span>
<a href="#l7.668"></a><span id="l7.668" class="difflineminus">-    if (!pSource || !pDestination || !fatalError) {</span>
<a href="#l7.669"></a><span id="l7.669" class="difflineminus">-    IMPORT_LOG0( &quot;*** Bad param passed to eudora address import\n&quot;);</span>
<a href="#l7.670"></a><span id="l7.670" class="difflineplus">+  nsString success;</span>
<a href="#l7.671"></a><span id="l7.671" class="difflineplus">+  nsString error;</span>
<a href="#l7.672"></a><span id="l7.672" class="difflineplus">+  if (!pSource || !pDestination || !fatalError) {</span>
<a href="#l7.673"></a><span id="l7.673" class="difflineplus">+    IMPORT_LOG0(&quot;*** Bad param passed to eudora address import\n&quot;);</span>
<a href="#l7.674"></a><span id="l7.674">     nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_ADDRESS_BADPARAM, error);</span>
<a href="#l7.675"></a><span id="l7.675">     if (fatalError)</span>
<a href="#l7.676"></a><span id="l7.676">       *fatalError = true;</span>
<a href="#l7.677"></a><span id="l7.677" class="difflineminus">-    ImportEudoraMailImpl::SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l7.678"></a><span id="l7.678" class="difflineminus">-      return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.679"></a><span id="l7.679" class="difflineplus">+    ImportEudoraMailImpl::SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l7.680"></a><span id="l7.680" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.681"></a><span id="l7.681">   }</span>
<a href="#l7.682"></a><span id="l7.682"> </span>
<a href="#l7.683"></a><span id="l7.683" class="difflineminus">-    bool      abort = false;</span>
<a href="#l7.684"></a><span id="l7.684" class="difflineminus">-    nsString  name;</span>
<a href="#l7.685"></a><span id="l7.685" class="difflineminus">-    pSource-&gt;GetPreferredName(name);</span>
<a href="#l7.686"></a><span id="l7.686" class="difflineplus">+  bool abort = false;</span>
<a href="#l7.687"></a><span id="l7.687" class="difflineplus">+  nsString name;</span>
<a href="#l7.688"></a><span id="l7.688" class="difflineplus">+  pSource-&gt;GetPreferredName(name);</span>
<a href="#l7.689"></a><span id="l7.689"> </span>
<a href="#l7.690"></a><span id="l7.690">   PRUint32 addressSize = 0;</span>
<a href="#l7.691"></a><span id="l7.691" class="difflineminus">-  pSource-&gt;GetSize( &amp;addressSize);</span>
<a href="#l7.692"></a><span id="l7.692" class="difflineplus">+  pSource-&gt;GetSize(&amp;addressSize);</span>
<a href="#l7.693"></a><span id="l7.693">   if (addressSize == 0) {</span>
<a href="#l7.694"></a><span id="l7.694" class="difflineminus">-    IMPORT_LOG0( &quot;Address book size is 0, skipping mailbox.\n&quot;);</span>
<a href="#l7.695"></a><span id="l7.695" class="difflineminus">-    ReportSuccess( name, &amp;success);</span>
<a href="#l7.696"></a><span id="l7.696" class="difflineminus">-    ImportEudoraMailImpl::SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l7.697"></a><span id="l7.697" class="difflineminus">-    return( NS_OK);</span>
<a href="#l7.698"></a><span id="l7.698" class="difflineplus">+    IMPORT_LOG0(&quot;Address book size is 0, skipping mailbox.\n&quot;);</span>
<a href="#l7.699"></a><span id="l7.699" class="difflineplus">+    ReportSuccess(name, &amp;success);</span>
<a href="#l7.700"></a><span id="l7.700" class="difflineplus">+    ImportEudoraMailImpl::SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l7.701"></a><span id="l7.701" class="difflineplus">+    return NS_OK;</span>
<a href="#l7.702"></a><span id="l7.702">   }</span>
<a href="#l7.703"></a><span id="l7.703"> </span>
<a href="#l7.704"></a><span id="l7.704"> </span>
<a href="#l7.705"></a><span id="l7.705" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; inFile;</span>
<a href="#l7.706"></a><span id="l7.706" class="difflineminus">-    if (NS_FAILED(pSource-&gt;GetAbFile(getter_AddRefs(inFile)))) {</span>
<a href="#l7.707"></a><span id="l7.707" class="difflineminus">-    ImportEudoraMailImpl::ReportError( EUDORAIMPORT_ADDRESS_BADSOURCEFILE, name, &amp;error);</span>
<a href="#l7.708"></a><span id="l7.708" class="difflineminus">-    ImportEudoraMailImpl::SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l7.709"></a><span id="l7.709" class="difflineminus">-      return( NS_ERROR_FAILURE);</span>
<a href="#l7.710"></a><span id="l7.710" class="difflineminus">-    }</span>
<a href="#l7.711"></a><span id="l7.711" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; inFile;</span>
<a href="#l7.712"></a><span id="l7.712" class="difflineplus">+  if (NS_FAILED(pSource-&gt;GetAbFile(getter_AddRefs(inFile)))) {</span>
<a href="#l7.713"></a><span id="l7.713" class="difflineplus">+    ImportEudoraMailImpl::ReportError(EUDORAIMPORT_ADDRESS_BADSOURCEFILE, name, &amp;error);</span>
<a href="#l7.714"></a><span id="l7.714" class="difflineplus">+    ImportEudoraMailImpl::SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l7.715"></a><span id="l7.715" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l7.716"></a><span id="l7.716" class="difflineplus">+  }</span>
<a href="#l7.717"></a><span id="l7.717"> </span>
<a href="#l7.718"></a><span id="l7.718"> </span>
<a href="#l7.719"></a><span id="l7.719"> #ifdef IMPORT_DEBUG</span>
<a href="#l7.720"></a><span id="l7.720">   nsCString path;</span>
<a href="#l7.721"></a><span id="l7.721">   inFile-&gt;GetNativePath(path);</span>
<a href="#l7.722"></a><span id="l7.722" class="difflineminus">-  IMPORT_LOG1( &quot;Import address book: %s\n&quot;, path.get());</span>
<a href="#l7.723"></a><span id="l7.723" class="difflineplus">+  IMPORT_LOG1(&quot;Import address book: %s\n&quot;, path.get());</span>
<a href="#l7.724"></a><span id="l7.724"> #endif</span>
<a href="#l7.725"></a><span id="l7.725"> </span>
<a href="#l7.726"></a><span id="l7.726"> </span>
<a href="#l7.727"></a><span id="l7.727" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l7.728"></a><span id="l7.728" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l7.729"></a><span id="l7.729"> </span>
<a href="#l7.730"></a><span id="l7.730">   m_bytes = 0;</span>
<a href="#l7.731"></a><span id="l7.731" class="difflineminus">-  rv = m_eudora.ImportAddresses( &amp;m_bytes, &amp;abort, name.get(), inFile, pDestination, error);</span>
<a href="#l7.732"></a><span id="l7.732" class="difflineplus">+  rv = m_eudora.ImportAddresses(&amp;m_bytes, &amp;abort, name.get(), inFile, pDestination, error);</span>
<a href="#l7.733"></a><span id="l7.733"> </span>
<a href="#l7.734"></a><span id="l7.734" class="difflineminus">-  if (NS_SUCCEEDED( rv) &amp;&amp; error.IsEmpty()) {</span>
<a href="#l7.735"></a><span id="l7.735" class="difflineminus">-    ReportSuccess( name, &amp;success);</span>
<a href="#l7.736"></a><span id="l7.736" class="difflineminus">-  }</span>
<a href="#l7.737"></a><span id="l7.737" class="difflineminus">-  else {</span>
<a href="#l7.738"></a><span id="l7.738" class="difflineminus">-    ImportEudoraMailImpl::ReportError( EUDORAIMPORT_ADDRESS_CONVERTERROR, name, &amp;error);</span>
<a href="#l7.739"></a><span id="l7.739" class="difflineminus">-  }</span>
<a href="#l7.740"></a><span id="l7.740" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; error.IsEmpty())</span>
<a href="#l7.741"></a><span id="l7.741" class="difflineplus">+    ReportSuccess(name, &amp;success);</span>
<a href="#l7.742"></a><span id="l7.742" class="difflineplus">+  else</span>
<a href="#l7.743"></a><span id="l7.743" class="difflineplus">+    ImportEudoraMailImpl::ReportError(EUDORAIMPORT_ADDRESS_CONVERTERROR, name, &amp;error);</span>
<a href="#l7.744"></a><span id="l7.744"> </span>
<a href="#l7.745"></a><span id="l7.745" class="difflineminus">-  ImportEudoraMailImpl::SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l7.746"></a><span id="l7.746" class="difflineplus">+  ImportEudoraMailImpl::SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l7.747"></a><span id="l7.747"> </span>
<a href="#l7.748"></a><span id="l7.748" class="difflineminus">-  IMPORT_LOG0( &quot;*** Returning from eudora address import\n&quot;);</span>
<a href="#l7.749"></a><span id="l7.749" class="difflineplus">+  IMPORT_LOG0(&quot;*** Returning from eudora address import\n&quot;);</span>
<a href="#l7.750"></a><span id="l7.750"> </span>
<a href="#l7.751"></a><span id="l7.751" class="difflineminus">-    return( rv);</span>
<a href="#l7.752"></a><span id="l7.752" class="difflineplus">+  return rv;</span>
<a href="#l7.753"></a><span id="l7.753"> }</span>
<a href="#l7.754"></a><span id="l7.754"> </span>
<a href="#l7.755"></a><span id="l7.755"> </span>
<a href="#l7.756"></a><span id="l7.756"> NS_IMETHODIMP ImportEudoraAddressImpl::GetImportProgress(PRUint32 *_retval)</span>
<a href="#l7.757"></a><span id="l7.757"> {</span>
<a href="#l7.758"></a><span id="l7.758" class="difflineminus">-    NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.759"></a><span id="l7.759" class="difflineplus">+  NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l7.760"></a><span id="l7.760">   if (!_retval)</span>
<a href="#l7.761"></a><span id="l7.761" class="difflineminus">-    return( NS_ERROR_NULL_POINTER);</span>
<a href="#l7.762"></a><span id="l7.762" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.763"></a><span id="l7.763"> </span>
<a href="#l7.764"></a><span id="l7.764">   *_retval = m_bytes;</span>
<a href="#l7.765"></a><span id="l7.765"> </span>
<a href="#l7.766"></a><span id="l7.766" class="difflineminus">-  return( NS_OK);</span>
<a href="#l7.767"></a><span id="l7.767" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.768"></a><span id="l7.768"> }</span>
<a href="#l7.769"></a><span id="l7.769"> </span>
<a href="#l7.770"></a><span id="l7.770"> </span>
<a href="#l7.771"></a><span id="l7.771"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraMac.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraMac.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -70,101 +70,101 @@ static const char *  kWhitespace = &quot;\b\t</span>
<a href="#l8.4"></a><span id="l8.4"> nsEudoraMac::nsEudoraMac()</span>
<a href="#l8.5"></a><span id="l8.5"> {</span>
<a href="#l8.6"></a><span id="l8.6"> }</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> nsEudoraMac::~nsEudoraMac()</span>
<a href="#l8.9"></a><span id="l8.9"> {</span>
<a href="#l8.10"></a><span id="l8.10"> }</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-bool nsEudoraMac::FindMailFolder( nsIFile **pFolder)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+bool nsEudoraMac::FindMailFolder(nsIFile **pFolder)</span>
<a href="#l8.14"></a><span id="l8.14"> {</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-  return( FindEudoraLocation( pFolder));</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+  return FindEudoraLocation(pFolder);</span>
<a href="#l8.17"></a><span id="l8.17"> }</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-bool nsEudoraMac::FindEudoraLocation( nsIFile **pFolder, bool findIni, nsIFile *pLookIn)</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+bool nsEudoraMac::FindEudoraLocation(nsIFile **pFolder, bool findIni, nsIFile *pLookIn)</span>
<a href="#l8.21"></a><span id="l8.21"> {</span>
<a href="#l8.22"></a><span id="l8.22">   bool result = false;</span>
<a href="#l8.23"></a><span id="l8.23">   // Modern versions of Eudora make the Eudora Folder in ~/Documents</span>
<a href="#l8.24"></a><span id="l8.24">   // The last versions that ran MacOS Classic made the Eudora folder in the user's documents folder</span>
<a href="#l8.25"></a><span id="l8.25">   // Early versions made the Eudora Folder in the System Folder</span>
<a href="#l8.26"></a><span id="l8.26">   // Eudora searches those three locations, earliest first (System Folder:Eudora Folder), and uses the first Eudora Folder</span>
<a href="#l8.27"></a><span id="l8.27">   // it finds.  However, it's not clear that any version of OSX can actually *find* the Classic &quot;Documents&quot; folder,</span>
<a href="#l8.28"></a><span id="l8.28">   // even if there was one before the machine was updated to OSX.</span>
<a href="#l8.29"></a><span id="l8.29">   // The name &quot;Eudora Folder&quot; should not be localized.  Early localized versions of Eudora did localize the name; later</span>
<a href="#l8.30"></a><span id="l8.30">   // localized versions looked for the localized name and changed it back.  We will therefore not</span>
<a href="#l8.31"></a><span id="l8.31">   // worry about the folder name being localized.  Japan may be an issue, though.</span>
<a href="#l8.32"></a><span id="l8.32">   // SD 11/2006</span>
<a href="#l8.33"></a><span id="l8.33"> </span>
<a href="#l8.34"></a><span id="l8.34">   if (!pLookIn)</span>
<a href="#l8.35"></a><span id="l8.35">   {</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-    result = FindEudoraLocation( pFolder, findIni, NS_OS_SYSTEM_DIR );</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-    if ( !result )</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+    result = FindEudoraLocation(pFolder, findIni, NS_OS_SYSTEM_DIR);</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+    if (!result)</span>
<a href="#l8.40"></a><span id="l8.40">     {</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-      result = FindEudoraLocation( pFolder, findIni, NS_MAC_DOCUMENTS_DIR );</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-      if ( !result )</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-        result = FindEudoraLocation( pFolder, findIni, NS_OSX_USER_DOCUMENTS_DIR );</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+      result = FindEudoraLocation(pFolder, findIni, NS_MAC_DOCUMENTS_DIR);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+      if (!result)</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+        result = FindEudoraLocation(pFolder, findIni, NS_OSX_USER_DOCUMENTS_DIR);</span>
<a href="#l8.47"></a><span id="l8.47">     }</span>
<a href="#l8.48"></a><span id="l8.48">   }</span>
<a href="#l8.49"></a><span id="l8.49">   else</span>
<a href="#l8.50"></a><span id="l8.50">   {</span>
<a href="#l8.51"></a><span id="l8.51">     *pFolder = pLookIn;</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-    result = VerifyEudoraLocation( pFolder, findIni );</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+    result = VerifyEudoraLocation(pFolder, findIni);</span>
<a href="#l8.54"></a><span id="l8.54">   }</span>
<a href="#l8.55"></a><span id="l8.55"> </span>
<a href="#l8.56"></a><span id="l8.56">   return result;</span>
<a href="#l8.57"></a><span id="l8.57"> }</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-bool nsEudoraMac::FindEudoraLocation( nsIFile **pFolder, bool findIni, const char *specialDirName )</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+bool nsEudoraMac::FindEudoraLocation(nsIFile **pFolder, bool findIni, const char *specialDirName)</span>
<a href="#l8.61"></a><span id="l8.61"> {</span>
<a href="#l8.62"></a><span id="l8.62">   nsCOMPtr &lt;nsIFile&gt; searchDir;</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-  nsresult rv = NS_GetSpecialDirectory( specialDirName, getter_AddRefs(searchDir) );</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+  nsresult rv = NS_GetSpecialDirectory(specialDirName, getter_AddRefs(searchDir));</span>
<a href="#l8.65"></a><span id="l8.65">   if (NS_FAILED(rv))</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-    return (false);</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+    return false;</span>
<a href="#l8.68"></a><span id="l8.68"> </span>
<a href="#l8.69"></a><span id="l8.69">   // Turn it into a mac file, so we can resolve aliases</span>
<a href="#l8.70"></a><span id="l8.70">   nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(searchDir);</span>
<a href="#l8.71"></a><span id="l8.71">   if (!macFile)</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-    return (false);</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+    return false;</span>
<a href="#l8.74"></a><span id="l8.74">   macFile-&gt;SetFollowLinks(true);</span>
<a href="#l8.75"></a><span id="l8.75"> </span>
<a href="#l8.76"></a><span id="l8.76">   // It's always called &quot;Eudora Folder&quot;, so add that to the path</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-  macFile-&gt;AppendNative( NS_LITERAL_CSTRING( &quot;Eudora Folder&quot;  ) );</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+  macFile-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Eudora Folder&quot; ));</span>
<a href="#l8.79"></a><span id="l8.79"> </span>
<a href="#l8.80"></a><span id="l8.80">   // If it's an alias, the &quot;target&quot; will be the real file.  Fetch this as a string</span>
<a href="#l8.81"></a><span id="l8.81">   // and set is back as the file</span>
<a href="#l8.82"></a><span id="l8.82">   nsCString path;</span>
<a href="#l8.83"></a><span id="l8.83">   macFile-&gt;GetNativeTarget(path);</span>
<a href="#l8.84"></a><span id="l8.84">   macFile-&gt;InitWithNativePath(path);</span>
<a href="#l8.85"></a><span id="l8.85"> </span>
<a href="#l8.86"></a><span id="l8.86">   // Resolve any unix-style symlinks (this won't do MacOS aliases, hence the machinations above)</span>
<a href="#l8.87"></a><span id="l8.87">   bool link = false;</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-  rv = searchDir-&gt;IsSymlink( &amp;link);</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-  if (NS_SUCCEEDED( rv) &amp;&amp; link)</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+  rv = searchDir-&gt;IsSymlink(&amp;link);</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; link)</span>
<a href="#l8.92"></a><span id="l8.92">   {</span>
<a href="#l8.93"></a><span id="l8.93">     rv = macFile-&gt;SetFollowLinks(true);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-    if (NS_FAILED( rv))</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-      return( false);</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+      return false;</span>
<a href="#l8.98"></a><span id="l8.98">   }</span>
<a href="#l8.99"></a><span id="l8.99"> </span>
<a href="#l8.100"></a><span id="l8.100">   // Check for existence and directoriness</span>
<a href="#l8.101"></a><span id="l8.101">   bool exists = false;</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-  rv = searchDir-&gt;Exists( &amp;exists);</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+  rv = searchDir-&gt;Exists(&amp;exists);</span>
<a href="#l8.104"></a><span id="l8.104">   bool isFolder = false;</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-  if (NS_SUCCEEDED( rv) &amp;&amp; exists)</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-    rv = searchDir-&gt;IsDirectory( &amp;isFolder);</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+    rv = searchDir-&gt;IsDirectory(&amp;isFolder);</span>
<a href="#l8.109"></a><span id="l8.109">   if (!exists || !isFolder)</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-    return( false);</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+    return false;</span>
<a href="#l8.112"></a><span id="l8.112"> </span>
<a href="#l8.113"></a><span id="l8.113">   NS_IF_ADDREF(*pFolder = searchDir);</span>
<a href="#l8.114"></a><span id="l8.114"> </span>
<a href="#l8.115"></a><span id="l8.115">   return true;</span>
<a href="#l8.116"></a><span id="l8.116"> }</span>
<a href="#l8.117"></a><span id="l8.117"> </span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-bool nsEudoraMac::VerifyEudoraLocation( nsIFile **pFolder, bool findIni )</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+bool nsEudoraMac::VerifyEudoraLocation(nsIFile **pFolder, bool findIni)</span>
<a href="#l8.120"></a><span id="l8.120"> {</span>
<a href="#l8.121"></a><span id="l8.121">   bool result = false;</span>
<a href="#l8.122"></a><span id="l8.122">   bool foundPref = false;</span>
<a href="#l8.123"></a><span id="l8.123"> </span>
<a href="#l8.124"></a><span id="l8.124"> </span>
<a href="#l8.125"></a><span id="l8.125">   bool hasMore;</span>
<a href="#l8.126"></a><span id="l8.126">   nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l8.127"></a><span id="l8.127">   nsresult rv = (*pFolder)-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineat">@@ -188,17 +188,17 @@ bool nsEudoraMac::VerifyEudoraLocation( </span>
<a href="#l8.129"></a><span id="l8.129">     {</span>
<a href="#l8.130"></a><span id="l8.130">       nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(entry, &amp;rv);</span>
<a href="#l8.131"></a><span id="l8.131">       if (NS_SUCCEEDED(rv))</span>
<a href="#l8.132"></a><span id="l8.132">       {</span>
<a href="#l8.133"></a><span id="l8.133">         macFile-&gt;GetFileCreator(&amp;creator);</span>
<a href="#l8.134"></a><span id="l8.134">         macFile-&gt;GetFileType(&amp;type);</span>
<a href="#l8.135"></a><span id="l8.135">       }</span>
<a href="#l8.136"></a><span id="l8.136">     }</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-    if (NS_SUCCEEDED( rv))</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l8.139"></a><span id="l8.139">     {</span>
<a href="#l8.140"></a><span id="l8.140">       if ((type == 'TEXT') &amp;&amp; (creator == 'CSOm'))</span>
<a href="#l8.141"></a><span id="l8.141">         count++;</span>
<a href="#l8.142"></a><span id="l8.142">       else if ((type == 'PREF') &amp;&amp; (creator == 'CSOm'))</span>
<a href="#l8.143"></a><span id="l8.143">       {</span>
<a href="#l8.144"></a><span id="l8.144">         if (!foundPref)</span>
<a href="#l8.145"></a><span id="l8.145">         {</span>
<a href="#l8.146"></a><span id="l8.146">           prefFile = entry;</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineat">@@ -232,63 +232,63 @@ bool nsEudoraMac::VerifyEudoraLocation( </span>
<a href="#l8.148"></a><span id="l8.148">         }</span>
<a href="#l8.149"></a><span id="l8.149">       }</span>
<a href="#l8.150"></a><span id="l8.150">     }</span>
<a href="#l8.151"></a><span id="l8.151">   }</span>
<a href="#l8.152"></a><span id="l8.152">   if (count &gt;= 2)</span>
<a href="#l8.153"></a><span id="l8.153">     result = true;</span>
<a href="#l8.154"></a><span id="l8.154"> </span>
<a href="#l8.155"></a><span id="l8.155">   if (!findIni)</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-    return( result);</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+    return result;</span>
<a href="#l8.158"></a><span id="l8.158"> </span>
<a href="#l8.159"></a><span id="l8.159">   if (!foundPref)</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-    return( false);</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+    return false;</span>
<a href="#l8.162"></a><span id="l8.162"> </span>
<a href="#l8.163"></a><span id="l8.163">   NS_IF_ADDREF(*pFolder = prefFile);</span>
<a href="#l8.164"></a><span id="l8.164"> </span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-  return( true);</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+  return true;</span>
<a href="#l8.167"></a><span id="l8.167"> }</span>
<a href="#l8.168"></a><span id="l8.168"> </span>
<a href="#l8.169"></a><span id="l8.169"> </span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-nsresult nsEudoraMac::FindMailboxes( nsIFile *pRoot, nsISupportsArray **ppArray)</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+nsresult nsEudoraMac::FindMailboxes(nsIFile *pRoot, nsISupportsArray **ppArray)</span>
<a href="#l8.172"></a><span id="l8.172"> {</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-  nsresult rv = NS_NewISupportsArray( ppArray);</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+  nsresult rv = NS_NewISupportsArray(ppArray);</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l8.177"></a><span id="l8.177">   {</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineminus">-    IMPORT_LOG0( &quot;FAILED to allocate the nsISupportsArray\n&quot;);</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineminus">-    return( rv);</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+    IMPORT_LOG0(&quot;FAILED to allocate the nsISupportsArray\n&quot;);</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+    return rv;</span>
<a href="#l8.182"></a><span id="l8.182">   }</span>
<a href="#l8.183"></a><span id="l8.183"> </span>
<a href="#l8.184"></a><span id="l8.184">   nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineminus">-    return( rv);</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+    return rv;</span>
<a href="#l8.189"></a><span id="l8.189"> </span>
<a href="#l8.190"></a><span id="l8.190">   m_depth = 0;</span>
<a href="#l8.191"></a><span id="l8.191">   m_mailImportLocation = do_QueryInterface(pRoot);</span>
<a href="#l8.192"></a><span id="l8.192"> </span>
<a href="#l8.193"></a><span id="l8.193" class="difflineminus">-  return( ScanMailDir( pRoot, *ppArray, impSvc));</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+  return ScanMailDir(pRoot, *ppArray, impSvc);</span>
<a href="#l8.195"></a><span id="l8.195"> }</span>
<a href="#l8.196"></a><span id="l8.196"> </span>
<a href="#l8.197"></a><span id="l8.197"> </span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-nsresult nsEudoraMac::ScanMailDir( nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport)</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+nsresult nsEudoraMac::ScanMailDir(nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport)</span>
<a href="#l8.200"></a><span id="l8.200"> {</span>
<a href="#l8.201"></a><span id="l8.201"> </span>
<a href="#l8.202"></a><span id="l8.202">   // On Windows, we look for a descmap file but on Mac we just iterate</span>
<a href="#l8.203"></a><span id="l8.203">   // the directory</span>
<a href="#l8.204"></a><span id="l8.204"> </span>
<a href="#l8.205"></a><span id="l8.205">   m_depth++;</span>
<a href="#l8.206"></a><span id="l8.206"> </span>
<a href="#l8.207"></a><span id="l8.207" class="difflineminus">-  nsresult rv = IterateMailDir( pFolder, pArray, pImport);</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+  nsresult rv = IterateMailDir(pFolder, pArray, pImport);</span>
<a href="#l8.209"></a><span id="l8.209"> </span>
<a href="#l8.210"></a><span id="l8.210">   m_depth--;</span>
<a href="#l8.211"></a><span id="l8.211"> </span>
<a href="#l8.212"></a><span id="l8.212" class="difflineminus">-  return( rv);</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+  return rv;</span>
<a href="#l8.214"></a><span id="l8.214"> }</span>
<a href="#l8.215"></a><span id="l8.215"> </span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-nsresult nsEudoraMac::IterateMailDir( nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport)</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+nsresult nsEudoraMac::IterateMailDir(nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport)</span>
<a href="#l8.218"></a><span id="l8.218"> {</span>
<a href="#l8.219"></a><span id="l8.219">   bool hasMore;</span>
<a href="#l8.220"></a><span id="l8.220">   nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l8.221"></a><span id="l8.221">   nsresult rv = pFolder-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l8.222"></a><span id="l8.222">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.223"></a><span id="l8.223"> </span>
<a href="#l8.224"></a><span id="l8.224">   directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l8.225"></a><span id="l8.225"> </span>
<a href="#l8.226"></a><span id="l8.226" class="difflineat">@@ -304,241 +304,241 @@ nsresult nsEudoraMac::IterateMailDir( ns</span>
<a href="#l8.227"></a><span id="l8.227">     nsCString fName;</span>
<a href="#l8.228"></a><span id="l8.228">     nsCString ext;</span>
<a href="#l8.229"></a><span id="l8.229">     nsCString name;</span>
<a href="#l8.230"></a><span id="l8.230">     OSType type;</span>
<a href="#l8.231"></a><span id="l8.231">     OSType creator;</span>
<a href="#l8.232"></a><span id="l8.232"> </span>
<a href="#l8.233"></a><span id="l8.233">     isFolder = false;</span>
<a href="#l8.234"></a><span id="l8.234">     isFile = false;</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-    rv = entry-&gt;IsDirectory( &amp;isFolder);</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineminus">-    rv = entry-&gt;IsFile( &amp;isFile);</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+    rv = entry-&gt;IsDirectory(&amp;isFolder);</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+    rv = entry-&gt;IsFile(&amp;isFile);</span>
<a href="#l8.239"></a><span id="l8.239">     rv = entry-&gt;GetNativeLeafName(fName);</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; !fName.IsEmpty())</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !fName.IsEmpty())</span>
<a href="#l8.242"></a><span id="l8.242">     {</span>
<a href="#l8.243"></a><span id="l8.243">       if (isFolder)</span>
<a href="#l8.244"></a><span id="l8.244">       {</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineminus">-        if (IsValidMailFolderName( fName))</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+        if (IsValidMailFolderName(fName))</span>
<a href="#l8.247"></a><span id="l8.247">         {</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineminus">-          rv = FoundMailFolder( entry, fName.get(), pArray, pImport);</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineminus">-          if (NS_SUCCEEDED( rv))</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+          rv = FoundMailFolder(entry, fName.get(), pArray, pImport);</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+          if (NS_SUCCEEDED(rv))</span>
<a href="#l8.252"></a><span id="l8.252">           {</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineminus">-            rv = ScanMailDir( entry, pArray, pImport);</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineminus">-            if (NS_FAILED( rv))</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineminus">-              IMPORT_LOG0( &quot;*** Error scanning mail directory\n&quot;);</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+            rv = ScanMailDir(entry, pArray, pImport);</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+            if (NS_FAILED(rv))</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+              IMPORT_LOG0(&quot;*** Error scanning mail directory\n&quot;);</span>
<a href="#l8.259"></a><span id="l8.259">           }</span>
<a href="#l8.260"></a><span id="l8.260">         }</span>
<a href="#l8.261"></a><span id="l8.261">       }</span>
<a href="#l8.262"></a><span id="l8.262">       else if (isFile)</span>
<a href="#l8.263"></a><span id="l8.263">       {</span>
<a href="#l8.264"></a><span id="l8.264">         type = 0;</span>
<a href="#l8.265"></a><span id="l8.265">         creator = 0;</span>
<a href="#l8.266"></a><span id="l8.266">         {</span>
<a href="#l8.267"></a><span id="l8.267">           nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(entry, &amp;rv);</span>
<a href="#l8.268"></a><span id="l8.268">           if (NS_SUCCEEDED(rv))</span>
<a href="#l8.269"></a><span id="l8.269">           {</span>
<a href="#l8.270"></a><span id="l8.270">             macFile-&gt;GetFileCreator(&amp;creator);</span>
<a href="#l8.271"></a><span id="l8.271">             macFile-&gt;GetFileType(&amp;type);</span>
<a href="#l8.272"></a><span id="l8.272">           }</span>
<a href="#l8.273"></a><span id="l8.273">         }</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineminus">-        if ((type == 'TEXT') &amp;&amp; IsValidMailboxName( fName) &amp;&amp; IsValidMailboxFile( entry))</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineminus">-          rv = FoundMailbox( entry, fName.get(), pArray, pImport);</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+        if ((type == 'TEXT') &amp;&amp; IsValidMailboxName(fName) &amp;&amp; IsValidMailboxFile(entry))</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+          rv = FoundMailbox(entry, fName.get(), pArray, pImport);</span>
<a href="#l8.278"></a><span id="l8.278">       }</span>
<a href="#l8.279"></a><span id="l8.279">     }</span>
<a href="#l8.280"></a><span id="l8.280">   }</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineminus">-  return( rv);</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineplus">+  return rv;</span>
<a href="#l8.283"></a><span id="l8.283"> }</span>
<a href="#l8.284"></a><span id="l8.284"> </span>
<a href="#l8.285"></a><span id="l8.285"> </span>
<a href="#l8.286"></a><span id="l8.286" class="difflineminus">-nsresult nsEudoraMac::FoundMailbox( nsIFile *mailFile, const char *pName, nsISupportsArray *pArray, nsIImportService *pImport)</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineplus">+nsresult nsEudoraMac::FoundMailbox(nsIFile *mailFile, const char *pName, nsISupportsArray *pArray, nsIImportService *pImport)</span>
<a href="#l8.288"></a><span id="l8.288"> {</span>
<a href="#l8.289"></a><span id="l8.289">   nsAutoString              displayName;</span>
<a href="#l8.290"></a><span id="l8.290">   nsCOMPtr&lt;nsIImportMailboxDescriptor&gt;  desc;</span>
<a href="#l8.291"></a><span id="l8.291">   nsISupports *              pInterface;</span>
<a href="#l8.292"></a><span id="l8.292"> </span>
<a href="#l8.293"></a><span id="l8.293">   NS_CopyNativeToUnicode(nsDependentCString(pName), displayName);</span>
<a href="#l8.294"></a><span id="l8.294"> </span>
<a href="#l8.295"></a><span id="l8.295"> #ifdef IMPORT_DEBUG</span>
<a href="#l8.296"></a><span id="l8.296">   nsCString path;</span>
<a href="#l8.297"></a><span id="l8.297">   mailFile-&gt;GetNativePath(path);</span>
<a href="#l8.298"></a><span id="l8.298">   if (!path.IsEmpty())</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineminus">-    IMPORT_LOG2( &quot;Found eudora mailbox, %s: %s\n&quot;, path.get(), pName);</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+    IMPORT_LOG2(&quot;Found eudora mailbox, %s: %s\n&quot;, path.get(), pName);</span>
<a href="#l8.301"></a><span id="l8.301">   else</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineminus">-    IMPORT_LOG1( &quot;Found eudora mailbox, %s\n&quot;, pName);</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineminus">-  IMPORT_LOG1( &quot;\tm_depth = %d\n&quot;, (int)m_depth);</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+    IMPORT_LOG1(&quot;Found eudora mailbox, %s\n&quot;, pName);</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineplus">+  IMPORT_LOG1(&quot;\tm_depth = %d\n&quot;, (int)m_depth);</span>
<a href="#l8.306"></a><span id="l8.306"> #endif</span>
<a href="#l8.307"></a><span id="l8.307"> </span>
<a href="#l8.308"></a><span id="l8.308" class="difflineminus">-  nsresult rv = pImport-&gt;CreateNewMailboxDescriptor( getter_AddRefs( desc));</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineplus">+  nsresult rv = pImport-&gt;CreateNewMailboxDescriptor(getter_AddRefs(desc));</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l8.312"></a><span id="l8.312">   {</span>
<a href="#l8.313"></a><span id="l8.313">     PRInt64    sz = 0;</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineminus">-    mailFile-&gt;GetFileSize( &amp;sz);</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineminus">-    desc-&gt;SetDisplayName( displayName.get());</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineminus">-    desc-&gt;SetDepth( m_depth);</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineplus">+    mailFile-&gt;GetFileSize(&amp;sz);</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineplus">+    desc-&gt;SetDisplayName(displayName.get());</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineplus">+    desc-&gt;SetDepth(m_depth);</span>
<a href="#l8.320"></a><span id="l8.320">     nsCOMPtr &lt;nsILocalFile&gt; pLocalFile;</span>
<a href="#l8.321"></a><span id="l8.321">     desc-&gt;GetFile(getter_AddRefs(pLocalFile));</span>
<a href="#l8.322"></a><span id="l8.322">     if (pLocalFile)</span>
<a href="#l8.323"></a><span id="l8.323">     {</span>
<a href="#l8.324"></a><span id="l8.324">       nsCOMPtr &lt;nsILocalFile&gt; localMailFile = do_QueryInterface(mailFile);</span>
<a href="#l8.325"></a><span id="l8.325">       pLocalFile-&gt;InitWithFile(localMailFile);</span>
<a href="#l8.326"></a><span id="l8.326">     }</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineminus">-    rv = desc-&gt;QueryInterface( kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineminus">-    pArray-&gt;AppendElement( pInterface);</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineplus">+    rv = desc-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineplus">+    pArray-&gt;AppendElement(pInterface);</span>
<a href="#l8.331"></a><span id="l8.331">     pInterface-&gt;Release();</span>
<a href="#l8.332"></a><span id="l8.332">   }</span>
<a href="#l8.333"></a><span id="l8.333"> </span>
<a href="#l8.334"></a><span id="l8.334" class="difflineminus">-  return( NS_OK);</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.336"></a><span id="l8.336"> }</span>
<a href="#l8.337"></a><span id="l8.337"> </span>
<a href="#l8.338"></a><span id="l8.338"> </span>
<a href="#l8.339"></a><span id="l8.339" class="difflineminus">-nsresult nsEudoraMac::FoundMailFolder( nsILocalFile *mailFolder, const char *pName, nsISupportsArray *pArray, nsIImportService *pImport)</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineplus">+nsresult nsEudoraMac::FoundMailFolder(nsILocalFile *mailFolder, const char *pName, nsISupportsArray *pArray, nsIImportService *pImport)</span>
<a href="#l8.341"></a><span id="l8.341"> {</span>
<a href="#l8.342"></a><span id="l8.342">   nsAutoString          displayName;</span>
<a href="#l8.343"></a><span id="l8.343">   nsCOMPtr&lt;nsIImportMailboxDescriptor&gt;  desc;</span>
<a href="#l8.344"></a><span id="l8.344">   nsISupports *              pInterface;</span>
<a href="#l8.345"></a><span id="l8.345"> </span>
<a href="#l8.346"></a><span id="l8.346">   NS_CopyNativeToUnicode(nsDependentCString(pName), displayName);</span>
<a href="#l8.347"></a><span id="l8.347"> </span>
<a href="#l8.348"></a><span id="l8.348"> #ifdef IMPORT_DEBUG</span>
<a href="#l8.349"></a><span id="l8.349">   nsCString path;</span>
<a href="#l8.350"></a><span id="l8.350">   mailFolder-&gt;GetNativePath(path);</span>
<a href="#l8.351"></a><span id="l8.351">   if (!path.IsEmpty())</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineminus">-    IMPORT_LOG2( &quot;Found eudora folder, %s: %s\n&quot;,path.get(), pName);</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineplus">+    IMPORT_LOG2(&quot;Found eudora folder, %s: %s\n&quot;,path.get(), pName);</span>
<a href="#l8.354"></a><span id="l8.354">   else</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineminus">-    IMPORT_LOG1( &quot;Found eudora folder, %s\n&quot;, pName);</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineminus">-  IMPORT_LOG1( &quot;\tm_depth = %d\n&quot;, (int)m_depth);</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineplus">+    IMPORT_LOG1(&quot;Found eudora folder, %s\n&quot;, pName);</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineplus">+  IMPORT_LOG1(&quot;\tm_depth = %d\n&quot;, (int)m_depth);</span>
<a href="#l8.359"></a><span id="l8.359"> #endif</span>
<a href="#l8.360"></a><span id="l8.360"> </span>
<a href="#l8.361"></a><span id="l8.361" class="difflineminus">-  nsresult rv = pImport-&gt;CreateNewMailboxDescriptor( getter_AddRefs( desc));</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineplus">+  nsresult rv = pImport-&gt;CreateNewMailboxDescriptor(getter_AddRefs(desc));</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l8.365"></a><span id="l8.365">   {</span>
<a href="#l8.366"></a><span id="l8.366">     PRInt64    sz = 0;</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineminus">-    desc-&gt;SetDisplayName( displayName.get());</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineminus">-    desc-&gt;SetDepth( m_depth);</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineminus">-    desc-&gt;SetSize( sz);</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineplus">+    desc-&gt;SetDisplayName(displayName.get());</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineplus">+    desc-&gt;SetDepth(m_depth);</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineplus">+    desc-&gt;SetSize(sz);</span>
<a href="#l8.373"></a><span id="l8.373">     nsCOMPtr &lt;nsILocalFile&gt; pFile;</span>
<a href="#l8.374"></a><span id="l8.374">     desc-&gt;GetFile(getter_AddRefs(pFile));</span>
<a href="#l8.375"></a><span id="l8.375">     if (pFile)</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineminus">-      pFile-&gt;InitWithFile( mailFolder);</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineminus">-    rv = desc-&gt;QueryInterface( kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineminus">-    pArray-&gt;AppendElement( pInterface);</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineplus">+      pFile-&gt;InitWithFile(mailFolder);</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineplus">+    rv = desc-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineplus">+    pArray-&gt;AppendElement(pInterface);</span>
<a href="#l8.382"></a><span id="l8.382">     pInterface-&gt;Release();</span>
<a href="#l8.383"></a><span id="l8.383">   }</span>
<a href="#l8.384"></a><span id="l8.384"> </span>
<a href="#l8.385"></a><span id="l8.385" class="difflineminus">-  return( NS_OK);</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.387"></a><span id="l8.387"> }</span>
<a href="#l8.388"></a><span id="l8.388"> </span>
<a href="#l8.389"></a><span id="l8.389" class="difflineminus">-bool nsEudoraMac::CreateTocFromResource( nsIFile *pMail, nsIFile **pToc)</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineplus">+bool nsEudoraMac::CreateTocFromResource(nsIFile *pMail, nsIFile **pToc)</span>
<a href="#l8.391"></a><span id="l8.391"> {</span>
<a href="#l8.392"></a><span id="l8.392">   ResFileRefNum resFile = -1;</span>
<a href="#l8.393"></a><span id="l8.393"> </span>
<a href="#l8.394"></a><span id="l8.394">   {</span>
<a href="#l8.395"></a><span id="l8.395">     nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(pMail);</span>
<a href="#l8.396"></a><span id="l8.396"> </span>
<a href="#l8.397"></a><span id="l8.397">     FSRef fsRef;</span>
<a href="#l8.398"></a><span id="l8.398">     nsresult rv = macFile-&gt;GetFSRef(&amp;fsRef);</span>
<a href="#l8.399"></a><span id="l8.399">     if (NS_FAILED(rv))</span>
<a href="#l8.400"></a><span id="l8.400">       return false;</span>
<a href="#l8.401"></a><span id="l8.401"> </span>
<a href="#l8.402"></a><span id="l8.402" class="difflineminus">-    resFile = FSOpenResFile( &amp;fsRef, fsRdPerm);</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineplus">+    resFile = FSOpenResFile(&amp;fsRef, fsRdPerm);</span>
<a href="#l8.404"></a><span id="l8.404">   }</span>
<a href="#l8.405"></a><span id="l8.405"> </span>
<a href="#l8.406"></a><span id="l8.406">   if (resFile == -1)</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineminus">-    return( false);</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineplus">+    return false;</span>
<a href="#l8.409"></a><span id="l8.409">   Handle  resH = nil;</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineminus">-  short max = Count1Resources( 'TOCF');</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineplus">+  short max = Count1Resources('TOCF');</span>
<a href="#l8.412"></a><span id="l8.412">   if (max)</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineminus">-    resH = Get1IndResource( 'TOCF', 1);</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineplus">+    resH = Get1IndResource('TOCF', 1);</span>
<a href="#l8.415"></a><span id="l8.415">   bool     result = false;</span>
<a href="#l8.416"></a><span id="l8.416">   if (resH)</span>
<a href="#l8.417"></a><span id="l8.417">   {</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineminus">-    PRInt32 sz = (PRInt32) GetHandleSize( resH);</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineplus">+    PRInt32 sz = (PRInt32) GetHandleSize(resH);</span>
<a href="#l8.420"></a><span id="l8.420">     if (sz)</span>
<a href="#l8.421"></a><span id="l8.421">     {</span>
<a href="#l8.422"></a><span id="l8.422">       // Create the new TOC file</span>
<a href="#l8.423"></a><span id="l8.423">       nsCOMPtr&lt;nsIFile&gt; tempDir;</span>
<a href="#l8.424"></a><span id="l8.424">       nsresult rv = NS_GetSpecialDirectory(NS_OS_TEMP_DIR, getter_AddRefs(tempDir));</span>
<a href="#l8.425"></a><span id="l8.425">       if (NS_FAILED(rv))</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineminus">-        return (false);</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineplus">+        return false;</span>
<a href="#l8.428"></a><span id="l8.428"> </span>
<a href="#l8.429"></a><span id="l8.429">       nsCOMPtr &lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l8.430"></a><span id="l8.430">         rv = tempDir-&gt;Clone(pToc);</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineminus">-      if (NS_SUCCEEDED( rv))</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineminus">-        rv = (*pToc)-&gt;AppendNative( NS_LITERAL_CSTRING(&quot;temp.toc&quot;));</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineminus">-      if (NS_SUCCEEDED( rv))</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineplus">+        rv = (*pToc)-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;temp.toc&quot;));</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l8.437"></a><span id="l8.437">         rv = (*pToc)-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineminus">-      if (NS_SUCCEEDED( rv))</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l8.440"></a><span id="l8.440">         rv = NS_NewLocalFileOutputStream(getter_AddRefs(outputStream), (*pToc));</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineminus">-      if (NS_SUCCEEDED( rv))</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l8.443"></a><span id="l8.443">       {</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineminus">-        HLock( resH);</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineplus">+        HLock(resH);</span>
<a href="#l8.446"></a><span id="l8.446">         PRUint32 written = 0;</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineminus">-        rv = outputStream-&gt;Write( *resH, sz, &amp;written);</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineminus">-        HUnlock( resH);</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineplus">+        rv = outputStream-&gt;Write(*resH, sz, &amp;written);</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineplus">+        HUnlock(resH);</span>
<a href="#l8.451"></a><span id="l8.451">         outputStream-&gt;Close();</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineminus">-        if (NS_FAILED( rv) || (written != sz))</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineminus">-          (*pToc)-&gt;Remove( false);</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineplus">+        if (NS_FAILED(rv) || (written != sz))</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineplus">+          (*pToc)-&gt;Remove(false);</span>
<a href="#l8.456"></a><span id="l8.456">         else</span>
<a href="#l8.457"></a><span id="l8.457">           result = true;</span>
<a href="#l8.458"></a><span id="l8.458">       }</span>
<a href="#l8.459"></a><span id="l8.459">     }</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineminus">-    ReleaseResource( resH);</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineplus">+    ReleaseResource(resH);</span>
<a href="#l8.462"></a><span id="l8.462">   }</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineminus">-  CloseResFile( resFile);</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineplus">+  CloseResFile(resFile);</span>
<a href="#l8.465"></a><span id="l8.465"> </span>
<a href="#l8.466"></a><span id="l8.466" class="difflineminus">-  return( result);</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineplus">+  return result;</span>
<a href="#l8.468"></a><span id="l8.468"> }</span>
<a href="#l8.469"></a><span id="l8.469"> </span>
<a href="#l8.470"></a><span id="l8.470"> </span>
<a href="#l8.471"></a><span id="l8.471" class="difflineminus">-nsresult nsEudoraMac::FindTOCFile( nsIFile *pMailFile, nsIFile **ppTOCFile, bool *pDeleteToc)</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineplus">+nsresult nsEudoraMac::FindTOCFile(nsIFile *pMailFile, nsIFile **ppTOCFile, bool *pDeleteToc)</span>
<a href="#l8.473"></a><span id="l8.473"> {</span>
<a href="#l8.474"></a><span id="l8.474">   nsresult    rv;</span>
<a href="#l8.475"></a><span id="l8.475"> </span>
<a href="#l8.476"></a><span id="l8.476">   *pDeleteToc = false;</span>
<a href="#l8.477"></a><span id="l8.477">   *ppTOCFile = nsnull;</span>
<a href="#l8.478"></a><span id="l8.478">   nsCString leaf;</span>
<a href="#l8.479"></a><span id="l8.479">   rv = pMailFile-&gt;GetNativeLeafName(leaf);</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineminus">-    return( rv);</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineminus">-  rv = pMailFile-&gt;GetParent( ppTOCFile);</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineminus">-    return( rv);</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineplus">+    return rv;</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineplus">+  rv = pMailFile-&gt;GetParent(ppTOCFile);</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineplus">+    return rv;</span>
<a href="#l8.490"></a><span id="l8.490"> </span>
<a href="#l8.491"></a><span id="l8.491" class="difflineminus">-  leaf.Append( &quot;.toc&quot;);</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineplus">+  leaf.Append(&quot;.toc&quot;);</span>
<a href="#l8.493"></a><span id="l8.493"> </span>
<a href="#l8.494"></a><span id="l8.494">   OSType  type = 0;</span>
<a href="#l8.495"></a><span id="l8.495">   OSType  creator = 0;</span>
<a href="#l8.496"></a><span id="l8.496">   bool    exists = false;</span>
<a href="#l8.497"></a><span id="l8.497">   bool    isFile = false;</span>
<a href="#l8.498"></a><span id="l8.498">   rv = (*ppTOCFile)-&gt;AppendNative(leaf);</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineminus">-    rv = (*ppTOCFile)-&gt;Exists( &amp;exists);</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineminus">-  if (NS_SUCCEEDED( rv) &amp;&amp; exists)</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineminus">-    rv = (*ppTOCFile)-&gt;IsFile( &amp;isFile);</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineplus">+    rv = (*ppTOCFile)-&gt;Exists(&amp;exists);</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineplus">+    rv = (*ppTOCFile)-&gt;IsFile(&amp;isFile);</span>
<a href="#l8.507"></a><span id="l8.507">   if (isFile)</span>
<a href="#l8.508"></a><span id="l8.508">   {</span>
<a href="#l8.509"></a><span id="l8.509">     nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(*ppTOCFile);</span>
<a href="#l8.510"></a><span id="l8.510">     if (macFile)</span>
<a href="#l8.511"></a><span id="l8.511">     {</span>
<a href="#l8.512"></a><span id="l8.512">       macFile-&gt;GetFileCreator(&amp;creator);</span>
<a href="#l8.513"></a><span id="l8.513">       macFile-&gt;GetFileType(&amp;type);</span>
<a href="#l8.514"></a><span id="l8.514">     }</span>
<a href="#l8.515"></a><span id="l8.515">   }</span>
<a href="#l8.516"></a><span id="l8.516"> </span>
<a href="#l8.517"></a><span id="l8.517"> </span>
<a href="#l8.518"></a><span id="l8.518">   if (exists &amp;&amp; isFile &amp;&amp; (type == 'TOCF') &amp;&amp; (creator == 'CSOm'))</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineminus">-    return( NS_OK);</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineplus">+    return NS_OK;</span>
<a href="#l8.521"></a><span id="l8.521"> </span>
<a href="#l8.522"></a><span id="l8.522">   // try and create the file from a resource.</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineminus">-  if (CreateTocFromResource( pMailFile, ppTOCFile))</span>
<a href="#l8.524"></a><span id="l8.524" class="difflineplus">+  if (CreateTocFromResource(pMailFile, ppTOCFile))</span>
<a href="#l8.525"></a><span id="l8.525">   {</span>
<a href="#l8.526"></a><span id="l8.526">     *pDeleteToc = true;</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineminus">-    return( NS_OK);</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineplus">+    return NS_OK;</span>
<a href="#l8.529"></a><span id="l8.529">   }</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineminus">-  return( NS_ERROR_FAILURE);</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l8.532"></a><span id="l8.532"> }</span>
<a href="#l8.533"></a><span id="l8.533"> </span>
<a href="#l8.534"></a><span id="l8.534"> // GetIndString isn't supported on 64-bit Mac OS X</span>
<a href="#l8.535"></a><span id="l8.535"> // This code is emulation for GetIndString.</span>
<a href="#l8.536"></a><span id="l8.536"> static StringPtr GetStringFromHandle(Handle aResource,</span>
<a href="#l8.537"></a><span id="l8.537">                                      ResourceIndex aId)</span>
<a href="#l8.538"></a><span id="l8.538"> {</span>
<a href="#l8.539"></a><span id="l8.539">   if (!aResource)</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineat">@@ -582,181 +582,175 @@ static StringPtr GetStringFromHandle(Han</span>
<a href="#l8.541"></a><span id="l8.541"> // resource IDs</span>
<a href="#l8.542"></a><span id="l8.542"> #define kSmtpServerID         4</span>
<a href="#l8.543"></a><span id="l8.543"> #define kEmailAddressID       3</span>
<a href="#l8.544"></a><span id="l8.544"> #define kReturnAddressID      5</span>
<a href="#l8.545"></a><span id="l8.545"> #define kFullNameID           77</span>
<a href="#l8.546"></a><span id="l8.546"> #define kLeaveMailOnServerID  18</span>
<a href="#l8.547"></a><span id="l8.547"> </span>
<a href="#l8.548"></a><span id="l8.548"> </span>
<a href="#l8.549"></a><span id="l8.549" class="difflineminus">-bool nsEudoraMac::GetSettingsFromResource( nsIFile *pSettings, short resId, nsCString **pStrs, bool *pIMAP)</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineplus">+bool nsEudoraMac::GetSettingsFromResource(nsIFile *pSettings, short resId, nsCString **pStrs, bool *pIMAP)</span>
<a href="#l8.551"></a><span id="l8.551"> {</span>
<a href="#l8.552"></a><span id="l8.552">   nsresult rv;</span>
<a href="#l8.553"></a><span id="l8.553">   *pIMAP = false;</span>
<a href="#l8.554"></a><span id="l8.554">   // Get settings from the resources...</span>
<a href="#l8.555"></a><span id="l8.555">   ResFileRefNum resFile = -1;</span>
<a href="#l8.556"></a><span id="l8.556">   {</span>
<a href="#l8.557"></a><span id="l8.557">     nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(pSettings, &amp;rv);</span>
<a href="#l8.558"></a><span id="l8.558">     if (NS_FAILED(rv))</span>
<a href="#l8.559"></a><span id="l8.559">       return false;</span>
<a href="#l8.560"></a><span id="l8.560"> </span>
<a href="#l8.561"></a><span id="l8.561">     FSRef fsRef;</span>
<a href="#l8.562"></a><span id="l8.562">     rv = macFile-&gt;GetFSRef(&amp;fsRef);</span>
<a href="#l8.563"></a><span id="l8.563">     if (NS_FAILED(rv))</span>
<a href="#l8.564"></a><span id="l8.564">       return false;</span>
<a href="#l8.565"></a><span id="l8.565"> </span>
<a href="#l8.566"></a><span id="l8.566" class="difflineminus">-    resFile = FSOpenResFile( &amp;fsRef, fsRdPerm);</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineplus">+    resFile = FSOpenResFile(&amp;fsRef, fsRdPerm);</span>
<a href="#l8.568"></a><span id="l8.568">   }</span>
<a href="#l8.569"></a><span id="l8.569">   if (resFile == -1)</span>
<a href="#l8.570"></a><span id="l8.570" class="difflineminus">-    return( false);</span>
<a href="#l8.571"></a><span id="l8.571" class="difflineplus">+    return false;</span>
<a href="#l8.572"></a><span id="l8.572"> </span>
<a href="#l8.573"></a><span id="l8.573">   UseResFile(resFile);</span>
<a href="#l8.574"></a><span id="l8.574"> </span>
<a href="#l8.575"></a><span id="l8.575">   // smtp server, STR# 1000, 4</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineminus">-  Handle  resH = Get1Resource( 'STR#', resId /* 1000 */);</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineplus">+  Handle  resH = Get1Resource('STR#', resId /* 1000 */);</span>
<a href="#l8.578"></a><span id="l8.578">   int    idx;</span>
<a href="#l8.579"></a><span id="l8.579">   if (resH)</span>
<a href="#l8.580"></a><span id="l8.580">   {</span>
<a href="#l8.581"></a><span id="l8.581">     StringPtr  pStr[5];</span>
<a href="#l8.582"></a><span id="l8.582">     StringPtr   theStr;</span>
<a href="#l8.583"></a><span id="l8.583"> </span>
<a href="#l8.584"></a><span id="l8.584">     // Cannot use GetIndString due to 64-bit support</span>
<a href="#l8.585"></a><span id="l8.585">     pStr[0] = GetStringFromHandle(resH, kSmtpServerID);</span>
<a href="#l8.586"></a><span id="l8.586">     pStr[1] = GetStringFromHandle(resH, kEmailAddressID);</span>
<a href="#l8.587"></a><span id="l8.587">     pStr[2] = GetStringFromHandle(resH, kReturnAddressID);</span>
<a href="#l8.588"></a><span id="l8.588">     pStr[3] = GetStringFromHandle(resH, kFullNameID);</span>
<a href="#l8.589"></a><span id="l8.589">     pStr[4] = GetStringFromHandle(resH, kLeaveMailOnServerID);</span>
<a href="#l8.590"></a><span id="l8.590"> </span>
<a href="#l8.591"></a><span id="l8.591">     theStr = pStr[0];</span>
<a href="#l8.592"></a><span id="l8.592">     if (theStr &amp;&amp; *theStr)</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineminus">-      pStrs[0]-&gt;Append( (const char *) (theStr + 1), *theStr);</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineplus">+      pStrs[0]-&gt;Append((const char *) (theStr + 1), *theStr);</span>
<a href="#l8.595"></a><span id="l8.595">     theStr = pStr[1];</span>
<a href="#l8.596"></a><span id="l8.596">     if (theStr &amp;&amp; *theStr)</span>
<a href="#l8.597"></a><span id="l8.597">     {</span>
<a href="#l8.598"></a><span id="l8.598">       idx = 1;</span>
<a href="#l8.599"></a><span id="l8.599">       while (idx &lt;= *theStr)</span>
<a href="#l8.600"></a><span id="l8.600">       {</span>
<a href="#l8.601"></a><span id="l8.601">         if (theStr[idx] == '@')</span>
<a href="#l8.602"></a><span id="l8.602">           break;</span>
<a href="#l8.603"></a><span id="l8.603">         else</span>
<a href="#l8.604"></a><span id="l8.604">           idx++;</span>
<a href="#l8.605"></a><span id="l8.605">       }</span>
<a href="#l8.606"></a><span id="l8.606">       if (idx &lt;= *theStr)</span>
<a href="#l8.607"></a><span id="l8.607">       {</span>
<a href="#l8.608"></a><span id="l8.608">         PRUint8  save = *theStr;</span>
<a href="#l8.609"></a><span id="l8.609">         *theStr = idx - 1;</span>
<a href="#l8.610"></a><span id="l8.610">         if (*theStr)</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineminus">-          pStrs[1]-&gt;Append( (const char *) (theStr + 1), *theStr);</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineplus">+          pStrs[1]-&gt;Append((const char *) (theStr + 1), *theStr);</span>
<a href="#l8.613"></a><span id="l8.613">         *theStr = save;</span>
<a href="#l8.614"></a><span id="l8.614">       }</span>
<a href="#l8.615"></a><span id="l8.615">       else</span>
<a href="#l8.616"></a><span id="l8.616">         idx = 0;</span>
<a href="#l8.617"></a><span id="l8.617">       theStr[idx] = theStr[0] - idx;</span>
<a href="#l8.618"></a><span id="l8.618">       if (theStr[idx])</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineminus">-        pStrs[2]-&gt;Append( (const char *) (theStr + idx + 1), *(theStr + idx));</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineplus">+        pStrs[2]-&gt;Append((const char *) (theStr + idx + 1), *(theStr + idx));</span>
<a href="#l8.621"></a><span id="l8.621">     }</span>
<a href="#l8.622"></a><span id="l8.622">     theStr = pStr[2];</span>
<a href="#l8.623"></a><span id="l8.623">     if (theStr &amp;&amp; *theStr)</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineminus">-      pStrs[3]-&gt;Append( (const char *) (theStr + 1), *theStr);</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineplus">+      pStrs[3]-&gt;Append((const char *) (theStr + 1), *theStr);</span>
<a href="#l8.626"></a><span id="l8.626">     theStr = pStr[3];</span>
<a href="#l8.627"></a><span id="l8.627">     if (theStr &amp;&amp; *theStr)</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineminus">-      pStrs[4]-&gt;Append( (const char *) (theStr + 1), *theStr);</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineplus">+      pStrs[4]-&gt;Append((const char *) (theStr + 1), *theStr);</span>
<a href="#l8.630"></a><span id="l8.630">     theStr = pStr[4];</span>
<a href="#l8.631"></a><span id="l8.631">     if (theStr &amp;&amp; *theStr)</span>
<a href="#l8.632"></a><span id="l8.632">     {</span>
<a href="#l8.633"></a><span id="l8.633">       if (theStr[1] == 'y')</span>
<a href="#l8.634"></a><span id="l8.634">         *(pStrs[5]) = &quot;Y&quot;;</span>
<a href="#l8.635"></a><span id="l8.635">       else</span>
<a href="#l8.636"></a><span id="l8.636">         *(pStrs[5]) = &quot;N&quot;;</span>
<a href="#l8.637"></a><span id="l8.637">     }</span>
<a href="#l8.638"></a><span id="l8.638"> </span>
<a href="#l8.639"></a><span id="l8.639">     ReleaseResource(resH);</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineminus">-    CloseResFile( resFile);</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineplus">+    CloseResFile(resFile);</span>
<a href="#l8.642"></a><span id="l8.642"> </span>
<a href="#l8.643"></a><span id="l8.643" class="difflineminus">-    return( true);</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineplus">+    return true;</span>
<a href="#l8.645"></a><span id="l8.645">   }</span>
<a href="#l8.646"></a><span id="l8.646">   else</span>
<a href="#l8.647"></a><span id="l8.647">   {</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineminus">-    CloseResFile( resFile);</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineminus">-    return( false);</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineplus">+    CloseResFile(resFile);</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineplus">+    return false;</span>
<a href="#l8.652"></a><span id="l8.652">   }</span>
<a href="#l8.653"></a><span id="l8.653"> }</span>
<a href="#l8.654"></a><span id="l8.654"> </span>
<a href="#l8.655"></a><span id="l8.655" class="difflineminus">-bool nsEudoraMac::ImportSettings( nsIFile *pIniFile, nsIMsgAccount **localMailAccount)</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineplus">+bool nsEudoraMac::ImportSettings(nsIFile *pIniFile, nsIMsgAccount **localMailAccount)</span>
<a href="#l8.657"></a><span id="l8.657"> {</span>
<a href="#l8.658"></a><span id="l8.658">   nsresult  rv;</span>
<a href="#l8.659"></a><span id="l8.659"> </span>
<a href="#l8.660"></a><span id="l8.660">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr =</span>
<a href="#l8.661"></a><span id="l8.661">            do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l8.662"></a><span id="l8.662">   if (NS_FAILED(rv))</span>
<a href="#l8.663"></a><span id="l8.663">   {</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineminus">-    IMPORT_LOG0( &quot;*** Failed to create a account manager!\n&quot;);</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineminus">-    return( false);</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineplus">+    IMPORT_LOG0(&quot;*** Failed to create a account manager!\n&quot;);</span>
<a href="#l8.667"></a><span id="l8.667" class="difflineplus">+    return false;</span>
<a href="#l8.668"></a><span id="l8.668">   }</span>
<a href="#l8.669"></a><span id="l8.669"> </span>
<a href="#l8.670"></a><span id="l8.670">   short  baseResId = 1000;</span>
<a href="#l8.671"></a><span id="l8.671">   nsCString **pStrs = new nsCString *[kNumSettingStrs];</span>
<a href="#l8.672"></a><span id="l8.672">   int    i;</span>
<a href="#l8.673"></a><span id="l8.673"> </span>
<a href="#l8.674"></a><span id="l8.674">   for (i = 0; i &lt; kNumSettingStrs; i++)</span>
<a href="#l8.675"></a><span id="l8.675">     pStrs[i] = new nsCString;</span>
<a href="#l8.676"></a><span id="l8.676"> </span>
<a href="#l8.677"></a><span id="l8.677">   nsString accName(NS_LITERAL_STRING(&quot;Eudora Settings&quot;));</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineminus">-  nsEudoraStringBundle::GetStringByID( EUDORAIMPORT_ACCOUNTNAME, accName);</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineplus">+  nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_ACCOUNTNAME, accName);</span>
<a href="#l8.680"></a><span id="l8.680"> </span>
<a href="#l8.681"></a><span id="l8.681">   // This is a little overkill but we're not sure yet how multiple accounts</span>
<a href="#l8.682"></a><span id="l8.682">   // are stored in the Mac preferences, hopefully similar to existing prefs</span>
<a href="#l8.683"></a><span id="l8.683">   // which means the following is a good start!</span>
<a href="#l8.684"></a><span id="l8.684">   bool    isIMAP = false;</span>
<a href="#l8.685"></a><span id="l8.685"> </span>
<a href="#l8.686"></a><span id="l8.686">   int        popCount = 0;</span>
<a href="#l8.687"></a><span id="l8.687">   int        accounts = 0;</span>
<a href="#l8.688"></a><span id="l8.688">   nsIMsgAccount *  pAccount;</span>
<a href="#l8.689"></a><span id="l8.689"> </span>
<a href="#l8.690"></a><span id="l8.690">   while (baseResId)</span>
<a href="#l8.691"></a><span id="l8.691">   {</span>
<a href="#l8.692"></a><span id="l8.692">     isIMAP = false;</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineminus">-    if (GetSettingsFromResource( pIniFile, baseResId, pStrs, &amp;isIMAP))</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineplus">+    if (GetSettingsFromResource(pIniFile, baseResId, pStrs, &amp;isIMAP))</span>
<a href="#l8.695"></a><span id="l8.695">     {</span>
<a href="#l8.696"></a><span id="l8.696">       pAccount = nsnull;</span>
<a href="#l8.697"></a><span id="l8.697">       if (!isIMAP)</span>
<a href="#l8.698"></a><span id="l8.698">       {</span>
<a href="#l8.699"></a><span id="l8.699">         // This is a POP account</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineminus">-        if (BuildPOPAccount( accMgr, pStrs, &amp;pAccount, accName))</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineplus">+        if (BuildPOPAccount(accMgr, pStrs, &amp;pAccount, accName))</span>
<a href="#l8.702"></a><span id="l8.702">         {</span>
<a href="#l8.703"></a><span id="l8.703">           accounts++;</span>
<a href="#l8.704"></a><span id="l8.704">           popCount++;</span>
<a href="#l8.705"></a><span id="l8.705">           if (popCount &gt; 1)</span>
<a href="#l8.706"></a><span id="l8.706">           {</span>
<a href="#l8.707"></a><span id="l8.707">             if (localMailAccount &amp;&amp; *localMailAccount)</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineminus">-            {</span>
<a href="#l8.709"></a><span id="l8.709" class="difflineminus">-              NS_RELEASE( *localMailAccount);</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineminus">-              *localMailAccount = nsnull;</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineminus">-            }</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineplus">+              NS_RELEASE(*localMailAccount);</span>
<a href="#l8.713"></a><span id="l8.713">           }</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineminus">-          else</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineplus">+          else if (localMailAccount)</span>
<a href="#l8.716"></a><span id="l8.716">           {</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineminus">-            if (localMailAccount)</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineminus">-            {</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineminus">-              *localMailAccount = pAccount;</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineminus">-              NS_IF_ADDREF( pAccount);</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineminus">-            }</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineplus">+            *localMailAccount = pAccount;</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineplus">+            NS_IF_ADDREF(pAccount);</span>
<a href="#l8.724"></a><span id="l8.724">           }</span>
<a href="#l8.725"></a><span id="l8.725">         }</span>
<a href="#l8.726"></a><span id="l8.726">       }</span>
<a href="#l8.727"></a><span id="l8.727">       else</span>
<a href="#l8.728"></a><span id="l8.728">       {</span>
<a href="#l8.729"></a><span id="l8.729">         // This is an IMAP account</span>
<a href="#l8.730"></a><span id="l8.730" class="difflineminus">-        if (BuildIMAPAccount( accMgr, pStrs, &amp;pAccount, accName))</span>
<a href="#l8.731"></a><span id="l8.731" class="difflineplus">+        if (BuildIMAPAccount(accMgr, pStrs, &amp;pAccount, accName))</span>
<a href="#l8.732"></a><span id="l8.732">           accounts++;</span>
<a href="#l8.733"></a><span id="l8.733">       }</span>
<a href="#l8.734"></a><span id="l8.734">       if (pAccount &amp;&amp; (baseResId == 1000))</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineminus">-        accMgr-&gt;SetDefaultAccount( pAccount);</span>
<a href="#l8.736"></a><span id="l8.736" class="difflineplus">+        accMgr-&gt;SetDefaultAccount(pAccount);</span>
<a href="#l8.737"></a><span id="l8.737"> </span>
<a href="#l8.738"></a><span id="l8.738" class="difflineminus">-      NS_IF_RELEASE( pAccount);</span>
<a href="#l8.739"></a><span id="l8.739" class="difflineplus">+      NS_IF_RELEASE(pAccount);</span>
<a href="#l8.740"></a><span id="l8.740">     }</span>
<a href="#l8.741"></a><span id="l8.741"> </span>
<a href="#l8.742"></a><span id="l8.742">     baseResId = 0;</span>
<a href="#l8.743"></a><span id="l8.743">     // Set the next account name???</span>
<a href="#l8.744"></a><span id="l8.744"> </span>
<a href="#l8.745"></a><span id="l8.745">     if (baseResId)</span>
<a href="#l8.746"></a><span id="l8.746">     {</span>
<a href="#l8.747"></a><span id="l8.747">       for (i = 0; i &lt; kNumSettingStrs; i++)</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineat">@@ -767,143 +761,143 @@ bool nsEudoraMac::ImportSettings( nsIFil</span>
<a href="#l8.749"></a><span id="l8.749">   // Now save the new acct info to pref file.</span>
<a href="#l8.750"></a><span id="l8.750">   rv = accMgr-&gt;SaveAccountInfo();</span>
<a href="#l8.751"></a><span id="l8.751">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Can't save account info to pref file&quot;);</span>
<a href="#l8.752"></a><span id="l8.752"> </span>
<a href="#l8.753"></a><span id="l8.753">   for (i = 0; i &lt; kNumSettingStrs; i++)</span>
<a href="#l8.754"></a><span id="l8.754">     delete pStrs[i];</span>
<a href="#l8.755"></a><span id="l8.755">   delete pStrs;</span>
<a href="#l8.756"></a><span id="l8.756"> </span>
<a href="#l8.757"></a><span id="l8.757" class="difflineminus">-  return( accounts != 0);</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineplus">+  return accounts != 0;</span>
<a href="#l8.759"></a><span id="l8.759"> }</span>
<a href="#l8.760"></a><span id="l8.760"> </span>
<a href="#l8.761"></a><span id="l8.761" class="difflineminus">-bool nsEudoraMac::FindFiltersFile( nsIFile **pFiltersFile)</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineplus">+bool nsEudoraMac::FindFiltersFile(nsIFile **pFiltersFile)</span>
<a href="#l8.763"></a><span id="l8.763"> {</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineminus">-  bool result = FindEudoraLocation( pFiltersFile, false);</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineplus">+  bool result = FindEudoraLocation(pFiltersFile, false);</span>
<a href="#l8.766"></a><span id="l8.766"> </span>
<a href="#l8.767"></a><span id="l8.767">   if (result)</span>
<a href="#l8.768"></a><span id="l8.768">   {</span>
<a href="#l8.769"></a><span id="l8.769" class="difflineminus">-    (*pFiltersFile)-&gt;AppendNative( NS_LITERAL_CSTRING(&quot;Eudora Filters&quot;) );</span>
<a href="#l8.770"></a><span id="l8.770" class="difflineplus">+    (*pFiltersFile)-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Eudora Filters&quot;));</span>
<a href="#l8.771"></a><span id="l8.771">     (*pFiltersFile)-&gt;IsFile(&amp;result);</span>
<a href="#l8.772"></a><span id="l8.772">   }</span>
<a href="#l8.773"></a><span id="l8.773"> </span>
<a href="#l8.774"></a><span id="l8.774">   return result;</span>
<a href="#l8.775"></a><span id="l8.775"> }</span>
<a href="#l8.776"></a><span id="l8.776"> </span>
<a href="#l8.777"></a><span id="l8.777"> </span>
<a href="#l8.778"></a><span id="l8.778"> </span>
<a href="#l8.779"></a><span id="l8.779" class="difflineminus">-bool nsEudoraMac::BuildPOPAccount( nsIMsgAccountManager *accMgr, nsCString **pStrs, nsIMsgAccount **ppAccount, nsString&amp; accName)</span>
<a href="#l8.780"></a><span id="l8.780" class="difflineplus">+bool nsEudoraMac::BuildPOPAccount(nsIMsgAccountManager *accMgr, nsCString **pStrs, nsIMsgAccount **ppAccount, nsString&amp; accName)</span>
<a href="#l8.781"></a><span id="l8.781"> {</span>
<a href="#l8.782"></a><span id="l8.782">   if (ppAccount)</span>
<a href="#l8.783"></a><span id="l8.783">     *ppAccount = nsnull;</span>
<a href="#l8.784"></a><span id="l8.784"> </span>
<a href="#l8.785"></a><span id="l8.785"> </span>
<a href="#l8.786"></a><span id="l8.786">   if (!pStrs[kPopServerStr]-&gt;Length() || !pStrs[kPopAccountNameStr]-&gt;Length())</span>
<a href="#l8.787"></a><span id="l8.787" class="difflineminus">-    return( false);</span>
<a href="#l8.788"></a><span id="l8.788" class="difflineplus">+    return false;</span>
<a href="#l8.789"></a><span id="l8.789"> </span>
<a href="#l8.790"></a><span id="l8.790">   bool    result = false;</span>
<a href="#l8.791"></a><span id="l8.791"> </span>
<a href="#l8.792"></a><span id="l8.792">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l8.793"></a><span id="l8.793">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l8.794"></a><span id="l8.794" class="difflineminus">-  nsresult rv = accMgr-&gt;FindServer( *(pStrs[kPopAccountNameStr]), *(pStrs[kPopServerStr]), NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs( in));</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineminus">-  if (NS_FAILED( rv) || (in == nsnull))</span>
<a href="#l8.796"></a><span id="l8.796" class="difflineplus">+  nsresult rv = accMgr-&gt;FindServer(*(pStrs[kPopAccountNameStr]), *(pStrs[kPopServerStr]), NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l8.797"></a><span id="l8.797" class="difflineplus">+  if (NS_FAILED(rv) || (in == nsnull))</span>
<a href="#l8.798"></a><span id="l8.798">   {</span>
<a href="#l8.799"></a><span id="l8.799">     // Create the incoming server and an account for it?</span>
<a href="#l8.800"></a><span id="l8.800" class="difflineminus">-    rv = accMgr-&gt;CreateIncomingServer( *(pStrs[kPopAccountNameStr]), *(pStrs[kPopServerStr]), NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs( in));</span>
<a href="#l8.801"></a><span id="l8.801" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; in)</span>
<a href="#l8.802"></a><span id="l8.802" class="difflineplus">+    rv = accMgr-&gt;CreateIncomingServer(*(pStrs[kPopAccountNameStr]), *(pStrs[kPopServerStr]), NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l8.803"></a><span id="l8.803" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; in)</span>
<a href="#l8.804"></a><span id="l8.804">     {</span>
<a href="#l8.805"></a><span id="l8.805">       rv = in-&gt;SetType(NS_LITERAL_CSTRING(&quot;pop3&quot;));</span>
<a href="#l8.806"></a><span id="l8.806" class="difflineminus">-      // rv = in-&gt;SetHostName( pStrs[kPopServerStr]-&gt;get());</span>
<a href="#l8.807"></a><span id="l8.807" class="difflineminus">-      // rv = in-&gt;SetUsername( pStrs[kPopAccountNameStr]-&gt;get());</span>
<a href="#l8.808"></a><span id="l8.808" class="difflineplus">+      // rv = in-&gt;SetHostName(pStrs[kPopServerStr]-&gt;get());</span>
<a href="#l8.809"></a><span id="l8.809" class="difflineplus">+      // rv = in-&gt;SetUsername(pStrs[kPopAccountNameStr]-&gt;get());</span>
<a href="#l8.810"></a><span id="l8.810"> </span>
<a href="#l8.811"></a><span id="l8.811" class="difflineminus">-      IMPORT_LOG2( &quot;Created POP3 server named: %s, userName: %s\n&quot;, pStrs[kPopServerStr]-&gt;get(), pStrs[kPopAccountNameStr]-&gt;get());</span>
<a href="#l8.812"></a><span id="l8.812" class="difflineminus">-      IMPORT_LOG1( &quot;\tSet pretty name to: %S\n&quot;, accName.get());</span>
<a href="#l8.813"></a><span id="l8.813" class="difflineminus">-      rv = in-&gt;SetPrettyName( accName);</span>
<a href="#l8.814"></a><span id="l8.814" class="difflineplus">+      IMPORT_LOG2(&quot;Created POP3 server named: %s, userName: %s\n&quot;, pStrs[kPopServerStr]-&gt;get(), pStrs[kPopAccountNameStr]-&gt;get());</span>
<a href="#l8.815"></a><span id="l8.815" class="difflineplus">+      IMPORT_LOG1(&quot;\tSet pretty name to: %S\n&quot;, accName.get());</span>
<a href="#l8.816"></a><span id="l8.816" class="difflineplus">+      rv = in-&gt;SetPrettyName(accName);</span>
<a href="#l8.817"></a><span id="l8.817"> </span>
<a href="#l8.818"></a><span id="l8.818">       // We have a server, create an account.</span>
<a href="#l8.819"></a><span id="l8.819">       nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l8.820"></a><span id="l8.820" class="difflineminus">-      rv = accMgr-&gt;CreateAccount( getter_AddRefs( account));</span>
<a href="#l8.821"></a><span id="l8.821" class="difflineminus">-      if (NS_SUCCEEDED( rv) &amp;&amp; account)</span>
<a href="#l8.822"></a><span id="l8.822" class="difflineplus">+      rv = accMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l8.823"></a><span id="l8.823" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; account)</span>
<a href="#l8.824"></a><span id="l8.824">       {</span>
<a href="#l8.825"></a><span id="l8.825" class="difflineminus">-        rv = account-&gt;SetIncomingServer( in);</span>
<a href="#l8.826"></a><span id="l8.826" class="difflineplus">+        rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l8.827"></a><span id="l8.827"> </span>
<a href="#l8.828"></a><span id="l8.828" class="difflineminus">-        IMPORT_LOG0( &quot;Created a new account and set the incoming server to the POP3 server.\n&quot;);</span>
<a href="#l8.829"></a><span id="l8.829" class="difflineplus">+        IMPORT_LOG0(&quot;Created a new account and set the incoming server to the POP3 server.\n&quot;);</span>
<a href="#l8.830"></a><span id="l8.830"> </span>
<a href="#l8.831"></a><span id="l8.831">         nsCOMPtr&lt;nsIPop3IncomingServer&gt; pop3Server = do_QueryInterface(in, &amp;rv);</span>
<a href="#l8.832"></a><span id="l8.832">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.833"></a><span id="l8.833">         pop3Server-&gt;SetLeaveMessagesOnServer(pStrs[kLeaveOnServerStr]-&gt;First() == 'Y' ? true : false);</span>
<a href="#l8.834"></a><span id="l8.834"> </span>
<a href="#l8.835"></a><span id="l8.835">         // Fiddle with the identities</span>
<a href="#l8.836"></a><span id="l8.836">         SetIdentities(accMgr, account, pStrs[kPopAccountNameStr]-&gt;get(), pStrs[kPopServerStr]-&gt;get(), pStrs);</span>
<a href="#l8.837"></a><span id="l8.837">         result = true;</span>
<a href="#l8.838"></a><span id="l8.838">         if (ppAccount)</span>
<a href="#l8.839"></a><span id="l8.839" class="difflineminus">-          account-&gt;QueryInterface( NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l8.840"></a><span id="l8.840" class="difflineplus">+          account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l8.841"></a><span id="l8.841">       }</span>
<a href="#l8.842"></a><span id="l8.842">     }</span>
<a href="#l8.843"></a><span id="l8.843">   }</span>
<a href="#l8.844"></a><span id="l8.844">   else</span>
<a href="#l8.845"></a><span id="l8.845">     result = true;</span>
<a href="#l8.846"></a><span id="l8.846"> </span>
<a href="#l8.847"></a><span id="l8.847" class="difflineminus">-  return( result);</span>
<a href="#l8.848"></a><span id="l8.848" class="difflineplus">+  return result;</span>
<a href="#l8.849"></a><span id="l8.849"> }</span>
<a href="#l8.850"></a><span id="l8.850"> </span>
<a href="#l8.851"></a><span id="l8.851"> </span>
<a href="#l8.852"></a><span id="l8.852" class="difflineminus">-bool nsEudoraMac::BuildIMAPAccount( nsIMsgAccountManager *accMgr, nsCString **pStrs, nsIMsgAccount **ppAccount, nsString&amp; accName)</span>
<a href="#l8.853"></a><span id="l8.853" class="difflineplus">+bool nsEudoraMac::BuildIMAPAccount(nsIMsgAccountManager *accMgr, nsCString **pStrs, nsIMsgAccount **ppAccount, nsString&amp; accName)</span>
<a href="#l8.854"></a><span id="l8.854"> {</span>
<a href="#l8.855"></a><span id="l8.855">   if (!pStrs[kPopServerStr]-&gt;Length() || !pStrs[kPopAccountNameStr]-&gt;Length())</span>
<a href="#l8.856"></a><span id="l8.856" class="difflineminus">-    return( false);</span>
<a href="#l8.857"></a><span id="l8.857" class="difflineplus">+    return false;</span>
<a href="#l8.858"></a><span id="l8.858"> </span>
<a href="#l8.859"></a><span id="l8.859">   bool result = false;</span>
<a href="#l8.860"></a><span id="l8.860"> </span>
<a href="#l8.861"></a><span id="l8.861">   nsCOMPtr&lt;nsIMsgIncomingServer&gt;  in;</span>
<a href="#l8.862"></a><span id="l8.862" class="difflineminus">-  nsresult rv = accMgr-&gt;FindServer(*(pStrs[kPopAccountNameStr]), *(pStrs[kPopServerStr]), NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs( in));</span>
<a href="#l8.863"></a><span id="l8.863" class="difflineminus">-  if (NS_FAILED( rv) || (in == nsnull))</span>
<a href="#l8.864"></a><span id="l8.864" class="difflineplus">+  nsresult rv = accMgr-&gt;FindServer(*(pStrs[kPopAccountNameStr]), *(pStrs[kPopServerStr]), NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l8.865"></a><span id="l8.865" class="difflineplus">+  if (NS_FAILED(rv) || (in == nsnull))</span>
<a href="#l8.866"></a><span id="l8.866">   {</span>
<a href="#l8.867"></a><span id="l8.867">     // Create the incoming server and an account for it?</span>
<a href="#l8.868"></a><span id="l8.868" class="difflineminus">-    rv = accMgr-&gt;CreateIncomingServer( *(pStrs[kPopAccountNameStr]), *(pStrs[kPopServerStr]), NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs( in));</span>
<a href="#l8.869"></a><span id="l8.869" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; in)</span>
<a href="#l8.870"></a><span id="l8.870" class="difflineplus">+    rv = accMgr-&gt;CreateIncomingServer(*(pStrs[kPopAccountNameStr]), *(pStrs[kPopServerStr]), NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l8.871"></a><span id="l8.871" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; in)</span>
<a href="#l8.872"></a><span id="l8.872">     {</span>
<a href="#l8.873"></a><span id="l8.873">       rv = in-&gt;SetType(NS_LITERAL_CSTRING(&quot;imap&quot;));</span>
<a href="#l8.874"></a><span id="l8.874" class="difflineminus">-      // rv = in-&gt;SetHostName( pStrs[kPopServerStr]-&gt;get());</span>
<a href="#l8.875"></a><span id="l8.875" class="difflineminus">-      // rv = in-&gt;SetUsername( pStrs[kPopAccountNameStr]-&gt;get());</span>
<a href="#l8.876"></a><span id="l8.876" class="difflineplus">+      // rv = in-&gt;SetHostName(pStrs[kPopServerStr]-&gt;get());</span>
<a href="#l8.877"></a><span id="l8.877" class="difflineplus">+      // rv = in-&gt;SetUsername(pStrs[kPopAccountNameStr]-&gt;get());</span>
<a href="#l8.878"></a><span id="l8.878"> </span>
<a href="#l8.879"></a><span id="l8.879" class="difflineminus">-      IMPORT_LOG2( &quot;Created IMAP server named: %s, userName: %s\n&quot;, pStrs[kPopServerStr]-&gt;get(), pStrs[kPopAccountNameStr]-&gt;get());</span>
<a href="#l8.880"></a><span id="l8.880" class="difflineminus">-      IMPORT_LOG1( &quot;\tSet pretty name to: %S\n&quot;, accName.get());</span>
<a href="#l8.881"></a><span id="l8.881" class="difflineminus">-      rv = in-&gt;SetPrettyName( accName);</span>
<a href="#l8.882"></a><span id="l8.882" class="difflineplus">+      IMPORT_LOG2(&quot;Created IMAP server named: %s, userName: %s\n&quot;, pStrs[kPopServerStr]-&gt;get(), pStrs[kPopAccountNameStr]-&gt;get());</span>
<a href="#l8.883"></a><span id="l8.883" class="difflineplus">+      IMPORT_LOG1(&quot;\tSet pretty name to: %S\n&quot;, accName.get());</span>
<a href="#l8.884"></a><span id="l8.884" class="difflineplus">+      rv = in-&gt;SetPrettyName(accName);</span>
<a href="#l8.885"></a><span id="l8.885"> </span>
<a href="#l8.886"></a><span id="l8.886">       // We have a server, create an account.</span>
<a href="#l8.887"></a><span id="l8.887">       nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l8.888"></a><span id="l8.888" class="difflineminus">-      rv = accMgr-&gt;CreateAccount( getter_AddRefs( account));</span>
<a href="#l8.889"></a><span id="l8.889" class="difflineminus">-      if (NS_SUCCEEDED( rv) &amp;&amp; account)</span>
<a href="#l8.890"></a><span id="l8.890" class="difflineplus">+      rv = accMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l8.891"></a><span id="l8.891" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; account)</span>
<a href="#l8.892"></a><span id="l8.892">       {</span>
<a href="#l8.893"></a><span id="l8.893" class="difflineminus">-        rv = account-&gt;SetIncomingServer( in);</span>
<a href="#l8.894"></a><span id="l8.894" class="difflineplus">+        rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l8.895"></a><span id="l8.895"> </span>
<a href="#l8.896"></a><span id="l8.896" class="difflineminus">-        IMPORT_LOG0( &quot;Created an account and set the IMAP server as the incoming server\n&quot;);</span>
<a href="#l8.897"></a><span id="l8.897" class="difflineplus">+        IMPORT_LOG0(&quot;Created an account and set the IMAP server as the incoming server\n&quot;);</span>
<a href="#l8.898"></a><span id="l8.898"> </span>
<a href="#l8.899"></a><span id="l8.899">         // Fiddle with the identities</span>
<a href="#l8.900"></a><span id="l8.900">         SetIdentities(accMgr, account, pStrs[kPopAccountNameStr]-&gt;get(), pStrs[kPopServerStr]-&gt;get(), pStrs);</span>
<a href="#l8.901"></a><span id="l8.901">         result = true;</span>
<a href="#l8.902"></a><span id="l8.902">         if (ppAccount)</span>
<a href="#l8.903"></a><span id="l8.903" class="difflineminus">-          account-&gt;QueryInterface( NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l8.904"></a><span id="l8.904" class="difflineplus">+          account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l8.905"></a><span id="l8.905">       }</span>
<a href="#l8.906"></a><span id="l8.906">     }</span>
<a href="#l8.907"></a><span id="l8.907">   }</span>
<a href="#l8.908"></a><span id="l8.908">   else</span>
<a href="#l8.909"></a><span id="l8.909">     result = true;</span>
<a href="#l8.910"></a><span id="l8.910"> </span>
<a href="#l8.911"></a><span id="l8.911" class="difflineminus">-  return( result);</span>
<a href="#l8.912"></a><span id="l8.912" class="difflineplus">+  return result;</span>
<a href="#l8.913"></a><span id="l8.913"> }</span>
<a href="#l8.914"></a><span id="l8.914"> </span>
<a href="#l8.915"></a><span id="l8.915"> </span>
<a href="#l8.916"></a><span id="l8.916"> void nsEudoraMac::SetIdentities(nsIMsgAccountManager *accMgr, nsIMsgAccount *acc, const char *userName, const char *serverName, nsCString **pStrs)</span>
<a href="#l8.917"></a><span id="l8.917"> {</span>
<a href="#l8.918"></a><span id="l8.918">   nsresult rv;</span>
<a href="#l8.919"></a><span id="l8.919"> </span>
<a href="#l8.920"></a><span id="l8.920">   nsCOMPtr&lt;nsIMsgIdentity&gt; id;</span>
<a href="#l8.921"></a><span id="l8.921" class="difflineminus">-  rv = accMgr-&gt;CreateIdentity( getter_AddRefs( id));</span>
<a href="#l8.922"></a><span id="l8.922" class="difflineplus">+  rv = accMgr-&gt;CreateIdentity(getter_AddRefs(id));</span>
<a href="#l8.923"></a><span id="l8.923">   if (id)</span>
<a href="#l8.924"></a><span id="l8.924">   {</span>
<a href="#l8.925"></a><span id="l8.925">     nsAutoString fullName;</span>
<a href="#l8.926"></a><span id="l8.926">     if (pStrs[kFullNameStr]-&gt;Length())</span>
<a href="#l8.927"></a><span id="l8.927">       CopyASCIItoUTF16(pStrs[kFullNameStr]-&gt;get(), fullName);</span>
<a href="#l8.928"></a><span id="l8.928">     id-&gt;SetFullName(fullName);</span>
<a href="#l8.929"></a><span id="l8.929">     id-&gt;SetIdentityName(fullName);</span>
<a href="#l8.930"></a><span id="l8.930">     if (pStrs[kReturnAddressStr]-&gt;Length())</span>
<a href="#l8.931"></a><span id="l8.931" class="difflineat">@@ -911,57 +905,57 @@ void nsEudoraMac::SetIdentities(nsIMsgAc</span>
<a href="#l8.932"></a><span id="l8.932">     else</span>
<a href="#l8.933"></a><span id="l8.933">     {</span>
<a href="#l8.934"></a><span id="l8.934">       nsCAutoString emailAddress;</span>
<a href="#l8.935"></a><span id="l8.935">       emailAddress = userName;</span>
<a href="#l8.936"></a><span id="l8.936">       emailAddress += &quot;@&quot;;</span>
<a href="#l8.937"></a><span id="l8.937">       emailAddress += serverName;</span>
<a href="#l8.938"></a><span id="l8.938">       id-&gt;SetEmail(emailAddress);</span>
<a href="#l8.939"></a><span id="l8.939">     }</span>
<a href="#l8.940"></a><span id="l8.940" class="difflineminus">-    acc-&gt;AddIdentity( id);</span>
<a href="#l8.941"></a><span id="l8.941" class="difflineminus">-    IMPORT_LOG0( &quot;Created identity and added to the account\n&quot;);</span>
<a href="#l8.942"></a><span id="l8.942" class="difflineminus">-    IMPORT_LOG1( &quot;\tname: %s\n&quot;, pStrs[kFullNameStr]-&gt;get());</span>
<a href="#l8.943"></a><span id="l8.943" class="difflineminus">-    IMPORT_LOG1( &quot;\temail: %s\n&quot;, pStrs[kReturnAddressStr]-&gt;get());</span>
<a href="#l8.944"></a><span id="l8.944" class="difflineplus">+    acc-&gt;AddIdentity(id);</span>
<a href="#l8.945"></a><span id="l8.945" class="difflineplus">+    IMPORT_LOG0(&quot;Created identity and added to the account\n&quot;);</span>
<a href="#l8.946"></a><span id="l8.946" class="difflineplus">+    IMPORT_LOG1(&quot;\tname: %s\n&quot;, pStrs[kFullNameStr]-&gt;get());</span>
<a href="#l8.947"></a><span id="l8.947" class="difflineplus">+    IMPORT_LOG1(&quot;\temail: %s\n&quot;, pStrs[kReturnAddressStr]-&gt;get());</span>
<a href="#l8.948"></a><span id="l8.948">   }</span>
<a href="#l8.949"></a><span id="l8.949"> </span>
<a href="#l8.950"></a><span id="l8.950" class="difflineminus">-  SetSmtpServer( accMgr, acc, pStrs[kSmtpServerStr]-&gt;get(), userName);</span>
<a href="#l8.951"></a><span id="l8.951" class="difflineplus">+  SetSmtpServer(accMgr, acc, pStrs[kSmtpServerStr]-&gt;get(), userName);</span>
<a href="#l8.952"></a><span id="l8.952"> }</span>
<a href="#l8.953"></a><span id="l8.953"> </span>
<a href="#l8.954"></a><span id="l8.954"> </span>
<a href="#l8.955"></a><span id="l8.955" class="difflineminus">-void nsEudoraMac::SetSmtpServer( nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, const char *pServer, const char *pUser)</span>
<a href="#l8.956"></a><span id="l8.956" class="difflineplus">+void nsEudoraMac::SetSmtpServer(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, const char *pServer, const char *pUser)</span>
<a href="#l8.957"></a><span id="l8.957"> {</span>
<a href="#l8.958"></a><span id="l8.958">   nsresult  rv;</span>
<a href="#l8.959"></a><span id="l8.959"> </span>
<a href="#l8.960"></a><span id="l8.960">   nsCOMPtr&lt;nsISmtpService&gt; smtpService(do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l8.961"></a><span id="l8.961">   if (NS_SUCCEEDED(rv) &amp;&amp; smtpService)</span>
<a href="#l8.962"></a><span id="l8.962">   {</span>
<a href="#l8.963"></a><span id="l8.963">     nsCOMPtr&lt;nsISmtpServer&gt;    foundServer;</span>
<a href="#l8.964"></a><span id="l8.964"> </span>
<a href="#l8.965"></a><span id="l8.965" class="difflineminus">-    rv = smtpService-&gt;FindServer( pUser, pServer, getter_AddRefs( foundServer));</span>
<a href="#l8.966"></a><span id="l8.966" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; foundServer)</span>
<a href="#l8.967"></a><span id="l8.967" class="difflineplus">+    rv = smtpService-&gt;FindServer(pUser, pServer, getter_AddRefs(foundServer));</span>
<a href="#l8.968"></a><span id="l8.968" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; foundServer)</span>
<a href="#l8.969"></a><span id="l8.969">     {</span>
<a href="#l8.970"></a><span id="l8.970" class="difflineminus">-      IMPORT_LOG1( &quot;SMTP server already exists: %s\n&quot;, pServer);</span>
<a href="#l8.971"></a><span id="l8.971" class="difflineplus">+      IMPORT_LOG1(&quot;SMTP server already exists: %s\n&quot;, pServer);</span>
<a href="#l8.972"></a><span id="l8.972">       return;</span>
<a href="#l8.973"></a><span id="l8.973">     }</span>
<a href="#l8.974"></a><span id="l8.974">     nsCOMPtr&lt;nsISmtpServer&gt;    smtpServer;</span>
<a href="#l8.975"></a><span id="l8.975"> </span>
<a href="#l8.976"></a><span id="l8.976" class="difflineminus">-    rv = smtpService-&gt;CreateSmtpServer( getter_AddRefs( smtpServer));</span>
<a href="#l8.977"></a><span id="l8.977" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; smtpServer)</span>
<a href="#l8.978"></a><span id="l8.978" class="difflineplus">+    rv = smtpService-&gt;CreateSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l8.979"></a><span id="l8.979" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; smtpServer)</span>
<a href="#l8.980"></a><span id="l8.980">     {</span>
<a href="#l8.981"></a><span id="l8.981">       smtpServer-&gt;SetHostname(nsDependentCString(pServer));</span>
<a href="#l8.982"></a><span id="l8.982">       if (pUser)</span>
<a href="#l8.983"></a><span id="l8.983">         smtpServer-&gt;SetUsername(nsDependentCString(pUser));</span>
<a href="#l8.984"></a><span id="l8.984"> </span>
<a href="#l8.985"></a><span id="l8.985" class="difflineminus">-      IMPORT_LOG1( &quot;Created new SMTP server: %s\n&quot;, pServer);</span>
<a href="#l8.986"></a><span id="l8.986" class="difflineplus">+      IMPORT_LOG1(&quot;Created new SMTP server: %s\n&quot;, pServer);</span>
<a href="#l8.987"></a><span id="l8.987">     }</span>
<a href="#l8.988"></a><span id="l8.988">   }</span>
<a href="#l8.989"></a><span id="l8.989"> }</span>
<a href="#l8.990"></a><span id="l8.990"> </span>
<a href="#l8.991"></a><span id="l8.991"> </span>
<a href="#l8.992"></a><span id="l8.992" class="difflineminus">-nsresult nsEudoraMac::GetAttachmentInfo( const char *pFileName, nsIFile *pFile, nsCString&amp; mimeType, nsCString&amp; aAttachment)</span>
<a href="#l8.993"></a><span id="l8.993" class="difflineplus">+nsresult nsEudoraMac::GetAttachmentInfo(const char *pFileName, nsIFile *pFile, nsCString&amp; mimeType, nsCString&amp; aAttachment)</span>
<a href="#l8.994"></a><span id="l8.994"> {</span>
<a href="#l8.995"></a><span id="l8.995">   mimeType.Truncate();</span>
<a href="#l8.996"></a><span id="l8.996"> </span>
<a href="#l8.997"></a><span id="l8.997">   // Sample attachment line</span>
<a href="#l8.998"></a><span id="l8.998">   // Internet:sandh.jpg (JPEG/JVWR) (0003C2E8)</span>
<a href="#l8.999"></a><span id="l8.999"> </span>
<a href="#l8.1000"></a><span id="l8.1000">   OSType    type = '????';</span>
<a href="#l8.1001"></a><span id="l8.1001">   OSType    creator = '????';</span>
<a href="#l8.1002"></a><span id="l8.1002" class="difflineat">@@ -971,81 +965,81 @@ nsresult nsEudoraMac::GetAttachmentInfo(</span>
<a href="#l8.1003"></a><span id="l8.1003"> </span>
<a href="#l8.1004"></a><span id="l8.1004">   nsCString  str(pFileName);</span>
<a href="#l8.1005"></a><span id="l8.1005">   if (str.Length() &gt; 22)</span>
<a href="#l8.1006"></a><span id="l8.1006">   {</span>
<a href="#l8.1007"></a><span id="l8.1007">     // try and extract the mac file info from the attachment line</span>
<a href="#l8.1008"></a><span id="l8.1008">     nsCString  fileNum;</span>
<a href="#l8.1009"></a><span id="l8.1009">     nsCString  types;</span>
<a href="#l8.1010"></a><span id="l8.1010"> </span>
<a href="#l8.1011"></a><span id="l8.1011" class="difflineminus">-    str.Right( fileNum, 10);</span>
<a href="#l8.1012"></a><span id="l8.1012" class="difflineminus">-    if ((fileNum.CharAt( 0) == '(') &amp;&amp; (fileNum.CharAt( 9) == ')'))</span>
<a href="#l8.1013"></a><span id="l8.1013" class="difflineplus">+    str.Right(fileNum, 10);</span>
<a href="#l8.1014"></a><span id="l8.1014" class="difflineplus">+    if ((fileNum.CharAt(0) == '(') &amp;&amp; (fileNum.CharAt(9) == ')'))</span>
<a href="#l8.1015"></a><span id="l8.1015">     {</span>
<a href="#l8.1016"></a><span id="l8.1016">       for (i = 1; i &lt; 9; i++)</span>
<a href="#l8.1017"></a><span id="l8.1017">       {</span>
<a href="#l8.1018"></a><span id="l8.1018">         fNum *= 16;</span>
<a href="#l8.1019"></a><span id="l8.1019" class="difflineminus">-        c = fileNum.CharAt( i);</span>
<a href="#l8.1020"></a><span id="l8.1020" class="difflineplus">+        c = fileNum.CharAt(i);</span>
<a href="#l8.1021"></a><span id="l8.1021">         if ((c &gt;= '0') &amp;&amp; (c &lt;= '9'))</span>
<a href="#l8.1022"></a><span id="l8.1022">           fNum += (c - '0');</span>
<a href="#l8.1023"></a><span id="l8.1023">         else if ((c &gt;= 'a') &amp;&amp; (c &lt;= 'f'))</span>
<a href="#l8.1024"></a><span id="l8.1024">           fNum += (c - 'a' + 10);</span>
<a href="#l8.1025"></a><span id="l8.1025">         else if ((c &gt;= 'A') &amp;&amp; (c &lt;= 'F'))</span>
<a href="#l8.1026"></a><span id="l8.1026">           fNum += (c - 'A' + 10);</span>
<a href="#l8.1027"></a><span id="l8.1027">         else</span>
<a href="#l8.1028"></a><span id="l8.1028">           break;</span>
<a href="#l8.1029"></a><span id="l8.1029">       }</span>
<a href="#l8.1030"></a><span id="l8.1030">       if (i == 9)</span>
<a href="#l8.1031"></a><span id="l8.1031">       {</span>
<a href="#l8.1032"></a><span id="l8.1032" class="difflineminus">-        str.Left( fileNum, str.Length() - 10);</span>
<a href="#l8.1033"></a><span id="l8.1033" class="difflineplus">+        str.Left(fileNum, str.Length() - 10);</span>
<a href="#l8.1034"></a><span id="l8.1034">         str = fileNum;</span>
<a href="#l8.1035"></a><span id="l8.1035" class="difflineminus">-        str.Trim( kWhitespace);</span>
<a href="#l8.1036"></a><span id="l8.1036" class="difflineminus">-        str.Right( types, 11);</span>
<a href="#l8.1037"></a><span id="l8.1037" class="difflineminus">-        if ((types.CharAt( 0) == '(') &amp;&amp; (types.CharAt( 5) == '/') &amp;&amp; (types.CharAt( 10) == ')'))</span>
<a href="#l8.1038"></a><span id="l8.1038" class="difflineplus">+        str.Trim(kWhitespace);</span>
<a href="#l8.1039"></a><span id="l8.1039" class="difflineplus">+        str.Right(types, 11);</span>
<a href="#l8.1040"></a><span id="l8.1040" class="difflineplus">+        if ((types.CharAt(0) == '(') &amp;&amp; (types.CharAt(5) == '/') &amp;&amp; (types.CharAt(10) == ')'))</span>
<a href="#l8.1041"></a><span id="l8.1041">         {</span>
<a href="#l8.1042"></a><span id="l8.1042" class="difflineminus">-          type = ((PRUint32)types.CharAt( 1)) &lt;&lt; 24;</span>
<a href="#l8.1043"></a><span id="l8.1043" class="difflineminus">-          type |= ((PRUint32)types.CharAt( 2)) &lt;&lt; 16;</span>
<a href="#l8.1044"></a><span id="l8.1044" class="difflineminus">-          type |= types.CharAt( 3) &lt;&lt; 8;</span>
<a href="#l8.1045"></a><span id="l8.1045" class="difflineminus">-          type |= types.CharAt( 4);</span>
<a href="#l8.1046"></a><span id="l8.1046" class="difflineminus">-          creator = ((PRUint32)types.CharAt( 6)) &lt;&lt; 24;</span>
<a href="#l8.1047"></a><span id="l8.1047" class="difflineminus">-          creator |= ((PRUint32)types.CharAt( 7)) &lt;&lt; 16;</span>
<a href="#l8.1048"></a><span id="l8.1048" class="difflineminus">-          creator |= types.CharAt( 8) &lt;&lt; 8;</span>
<a href="#l8.1049"></a><span id="l8.1049" class="difflineminus">-          creator |= types.CharAt( 9);</span>
<a href="#l8.1050"></a><span id="l8.1050" class="difflineminus">-          str.Left( types, str.Length() - 11);</span>
<a href="#l8.1051"></a><span id="l8.1051" class="difflineplus">+          type = ((PRUint32)types.CharAt(1)) &lt;&lt; 24;</span>
<a href="#l8.1052"></a><span id="l8.1052" class="difflineplus">+          type |= ((PRUint32)types.CharAt(2)) &lt;&lt; 16;</span>
<a href="#l8.1053"></a><span id="l8.1053" class="difflineplus">+          type |= types.CharAt(3) &lt;&lt; 8;</span>
<a href="#l8.1054"></a><span id="l8.1054" class="difflineplus">+          type |= types.CharAt(4);</span>
<a href="#l8.1055"></a><span id="l8.1055" class="difflineplus">+          creator = ((PRUint32)types.CharAt(6)) &lt;&lt; 24;</span>
<a href="#l8.1056"></a><span id="l8.1056" class="difflineplus">+          creator |= ((PRUint32)types.CharAt(7)) &lt;&lt; 16;</span>
<a href="#l8.1057"></a><span id="l8.1057" class="difflineplus">+          creator |= types.CharAt(8) &lt;&lt; 8;</span>
<a href="#l8.1058"></a><span id="l8.1058" class="difflineplus">+          creator |= types.CharAt(9);</span>
<a href="#l8.1059"></a><span id="l8.1059" class="difflineplus">+          str.Left(types, str.Length() - 11);</span>
<a href="#l8.1060"></a><span id="l8.1060">           str = types;</span>
<a href="#l8.1061"></a><span id="l8.1061" class="difflineminus">-          str.Trim( kWhitespace);</span>
<a href="#l8.1062"></a><span id="l8.1062" class="difflineplus">+          str.Trim(kWhitespace);</span>
<a href="#l8.1063"></a><span id="l8.1063">         }</span>
<a href="#l8.1064"></a><span id="l8.1064">       }</span>
<a href="#l8.1065"></a><span id="l8.1065">       else</span>
<a href="#l8.1066"></a><span id="l8.1066">         fNum = 0;</span>
<a href="#l8.1067"></a><span id="l8.1067">     }</span>
<a href="#l8.1068"></a><span id="l8.1068">   }</span>
<a href="#l8.1069"></a><span id="l8.1069"> </span>
<a href="#l8.1070"></a><span id="l8.1070"> #ifdef IMPORT_DEBUG</span>
<a href="#l8.1071"></a><span id="l8.1071">   nsCString  typeStr;</span>
<a href="#l8.1072"></a><span id="l8.1072">   nsCString  creatStr;</span>
<a href="#l8.1073"></a><span id="l8.1073"> </span>
<a href="#l8.1074"></a><span id="l8.1074" class="difflineminus">-  creatStr.Append( (const char *)&amp;creator, 4);</span>
<a href="#l8.1075"></a><span id="l8.1075" class="difflineminus">-  typeStr.Append( (const char *)&amp;type, 4);</span>
<a href="#l8.1076"></a><span id="l8.1076" class="difflineminus">-  IMPORT_LOG3( &quot;\tAttachment type: %s, creator: %s, fileNum: %ld\n&quot;, typeStr.get(), creatStr.get(), fNum);</span>
<a href="#l8.1077"></a><span id="l8.1077" class="difflineminus">-  IMPORT_LOG1( &quot;\tAttachment file name: %s\n&quot;, str.get());</span>
<a href="#l8.1078"></a><span id="l8.1078" class="difflineplus">+  creatStr.Append((const char *)&amp;creator, 4);</span>
<a href="#l8.1079"></a><span id="l8.1079" class="difflineplus">+  typeStr.Append((const char *)&amp;type, 4);</span>
<a href="#l8.1080"></a><span id="l8.1080" class="difflineplus">+  IMPORT_LOG3(&quot;\tAttachment type: %s, creator: %s, fileNum: %ld\n&quot;, typeStr.get(), creatStr.get(), fNum);</span>
<a href="#l8.1081"></a><span id="l8.1081" class="difflineplus">+  IMPORT_LOG1(&quot;\tAttachment file name: %s\n&quot;, str.get());</span>
<a href="#l8.1082"></a><span id="l8.1082"> #endif</span>
<a href="#l8.1083"></a><span id="l8.1083">   FSRef  fsRef;</span>
<a href="#l8.1084"></a><span id="l8.1084" class="difflineminus">-  memset( &amp;fsRef, 0, sizeof( fsRef));</span>
<a href="#l8.1085"></a><span id="l8.1085" class="difflineplus">+  memset(&amp;fsRef, 0, sizeof(fsRef));</span>
<a href="#l8.1086"></a><span id="l8.1086">   {</span>
<a href="#l8.1087"></a><span id="l8.1087">     nsresult rv;</span>
<a href="#l8.1088"></a><span id="l8.1088">     nsCOMPtr &lt;nsILocalFile&gt; pLocalFile = do_QueryInterface(pFile, &amp;rv);</span>
<a href="#l8.1089"></a><span id="l8.1089">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.1090"></a><span id="l8.1090">     pLocalFile-&gt;InitWithNativePath(str);</span>
<a href="#l8.1091"></a><span id="l8.1091">     if (NS_FAILED(rv))</span>
<a href="#l8.1092"></a><span id="l8.1092">     {</span>
<a href="#l8.1093"></a><span id="l8.1093">       IMPORT_LOG0(&quot;\tfailed to set native path\n&quot;);</span>
<a href="#l8.1094"></a><span id="l8.1094">       return rv;</span>
<a href="#l8.1095"></a><span id="l8.1095">     }</span>
<a href="#l8.1096"></a><span id="l8.1096"> </span>
<a href="#l8.1097"></a><span id="l8.1097" class="difflineminus">-    pFile-&gt;GetNativeLeafName( aAttachment);</span>
<a href="#l8.1098"></a><span id="l8.1098" class="difflineplus">+    pFile-&gt;GetNativeLeafName(aAttachment);</span>
<a href="#l8.1099"></a><span id="l8.1099"> </span>
<a href="#l8.1100"></a><span id="l8.1100">     nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(pFile, &amp;rv);</span>
<a href="#l8.1101"></a><span id="l8.1101">     if (NS_FAILED(rv))</span>
<a href="#l8.1102"></a><span id="l8.1102">     {</span>
<a href="#l8.1103"></a><span id="l8.1103">       IMPORT_LOG0(&quot;\tfailed to get local mac file\n&quot;);</span>
<a href="#l8.1104"></a><span id="l8.1104">       return rv;</span>
<a href="#l8.1105"></a><span id="l8.1105">     }</span>
<a href="#l8.1106"></a><span id="l8.1106"> </span>
<a href="#l8.1107"></a><span id="l8.1107" class="difflineat">@@ -1057,19 +1051,19 @@ nsresult nsEudoraMac::GetAttachmentInfo(</span>
<a href="#l8.1108"></a><span id="l8.1108">     }</span>
<a href="#l8.1109"></a><span id="l8.1109">   }</span>
<a href="#l8.1110"></a><span id="l8.1110"> </span>
<a href="#l8.1111"></a><span id="l8.1111">   if (HasResourceFork(&amp;fsRef))</span>
<a href="#l8.1112"></a><span id="l8.1112">     mimeType = &quot;application/applefile&quot;;</span>
<a href="#l8.1113"></a><span id="l8.1113">   else</span>
<a href="#l8.1114"></a><span id="l8.1114">     mimeType = &quot;application/octet-stream&quot;;</span>
<a href="#l8.1115"></a><span id="l8.1115"> </span>
<a href="#l8.1116"></a><span id="l8.1116" class="difflineminus">-  IMPORT_LOG1( &quot;\tMimeType: %s\n&quot;, mimeType.get());</span>
<a href="#l8.1117"></a><span id="l8.1117" class="difflineplus">+  IMPORT_LOG1(&quot;\tMimeType: %s\n&quot;, mimeType.get());</span>
<a href="#l8.1118"></a><span id="l8.1118"> </span>
<a href="#l8.1119"></a><span id="l8.1119" class="difflineminus">-  return( NS_OK);</span>
<a href="#l8.1120"></a><span id="l8.1120" class="difflineplus">+  return NS_OK;</span>
<a href="#l8.1121"></a><span id="l8.1121"> }</span>
<a href="#l8.1122"></a><span id="l8.1122"> </span>
<a href="#l8.1123"></a><span id="l8.1123"> bool nsEudoraMac::HasResourceFork(FSRef *fsRef)</span>
<a href="#l8.1124"></a><span id="l8.1124"> {</span>
<a href="#l8.1125"></a><span id="l8.1125">   FSCatalogInfo catalogInfo;</span>
<a href="#l8.1126"></a><span id="l8.1126">   OSErr err = FSGetCatalogInfo(fsRef,</span>
<a href="#l8.1127"></a><span id="l8.1127">                                kFSCatInfoDataSizes + kFSCatInfoRsrcSizes,</span>
<a href="#l8.1128"></a><span id="l8.1128">                                &amp;catalogInfo, nsnull, nsnull, nsnull);</span>
<a href="#l8.1129"></a><span id="l8.1129" class="difflineat">@@ -1084,151 +1078,149 @@ const char *cBadFolderNames[kNumBadFolde</span>
<a href="#l8.1130"></a><span id="l8.1130">   &quot;Eudora Items&quot;,</span>
<a href="#l8.1131"></a><span id="l8.1131">   &quot;Nicknames Folder&quot;,</span>
<a href="#l8.1132"></a><span id="l8.1132">   &quot;Parts Folder&quot;,</span>
<a href="#l8.1133"></a><span id="l8.1133">   &quot;Signature Folder&quot;,</span>
<a href="#l8.1134"></a><span id="l8.1134">   &quot;Spool Folder&quot;,</span>
<a href="#l8.1135"></a><span id="l8.1135">   &quot;Stationery Folder&quot;</span>
<a href="#l8.1136"></a><span id="l8.1136"> };</span>
<a href="#l8.1137"></a><span id="l8.1137"> </span>
<a href="#l8.1138"></a><span id="l8.1138" class="difflineminus">-bool nsEudoraMac::IsValidMailFolderName( nsCString&amp; name)</span>
<a href="#l8.1139"></a><span id="l8.1139" class="difflineplus">+bool nsEudoraMac::IsValidMailFolderName(nsCString&amp; name)</span>
<a href="#l8.1140"></a><span id="l8.1140"> {</span>
<a href="#l8.1141"></a><span id="l8.1141">   if (m_depth &gt; 1)</span>
<a href="#l8.1142"></a><span id="l8.1142" class="difflineminus">-    return( true);</span>
<a href="#l8.1143"></a><span id="l8.1143" class="difflineplus">+    return true;</span>
<a href="#l8.1144"></a><span id="l8.1144"> </span>
<a href="#l8.1145"></a><span id="l8.1145">   for (int i = 0; i &lt; kNumBadFolderNames; i++)</span>
<a href="#l8.1146"></a><span id="l8.1146">   {</span>
<a href="#l8.1147"></a><span id="l8.1147" class="difflineminus">-    if (name.Equals( cBadFolderNames[i], nsCaseInsensitiveCStringComparator()))</span>
<a href="#l8.1148"></a><span id="l8.1148" class="difflineminus">-      return( false);</span>
<a href="#l8.1149"></a><span id="l8.1149" class="difflineplus">+    if (name.Equals(cBadFolderNames[i], nsCaseInsensitiveCStringComparator()))</span>
<a href="#l8.1150"></a><span id="l8.1150" class="difflineplus">+      return false;</span>
<a href="#l8.1151"></a><span id="l8.1151">   }</span>
<a href="#l8.1152"></a><span id="l8.1152"> </span>
<a href="#l8.1153"></a><span id="l8.1153" class="difflineminus">-  return( true);</span>
<a href="#l8.1154"></a><span id="l8.1154" class="difflineplus">+  return true;</span>
<a href="#l8.1155"></a><span id="l8.1155"> }</span>
<a href="#l8.1156"></a><span id="l8.1156"> </span>
<a href="#l8.1157"></a><span id="l8.1157"> </span>
<a href="#l8.1158"></a><span id="l8.1158" class="difflineminus">-bool nsEudoraMac::IsValidMailboxName( nsCString&amp; fName)</span>
<a href="#l8.1159"></a><span id="l8.1159" class="difflineplus">+bool nsEudoraMac::IsValidMailboxName(nsCString&amp; fName)</span>
<a href="#l8.1160"></a><span id="l8.1160"> {</span>
<a href="#l8.1161"></a><span id="l8.1161">   if (m_depth &gt; 1)</span>
<a href="#l8.1162"></a><span id="l8.1162" class="difflineminus">-    return( true);</span>
<a href="#l8.1163"></a><span id="l8.1163" class="difflineminus">-  if (fName.LowerCaseEqualsLiteral(&quot;eudora nicknames&quot;))</span>
<a href="#l8.1164"></a><span id="l8.1164" class="difflineminus">-    return( false);</span>
<a href="#l8.1165"></a><span id="l8.1165" class="difflineminus">-  return( true);</span>
<a href="#l8.1166"></a><span id="l8.1166" class="difflineplus">+    return true;</span>
<a href="#l8.1167"></a><span id="l8.1167" class="difflineplus">+  return !fName.LowerCaseEqualsLiteral(&quot;eudora nicknames&quot;);</span>
<a href="#l8.1168"></a><span id="l8.1168"> }</span>
<a href="#l8.1169"></a><span id="l8.1169"> </span>
<a href="#l8.1170"></a><span id="l8.1170"> </span>
<a href="#l8.1171"></a><span id="l8.1171" class="difflineminus">-bool nsEudoraMac::IsValidMailboxFile( nsIFile *pFile)</span>
<a href="#l8.1172"></a><span id="l8.1172" class="difflineplus">+bool nsEudoraMac::IsValidMailboxFile(nsIFile *pFile)</span>
<a href="#l8.1173"></a><span id="l8.1173"> {</span>
<a href="#l8.1174"></a><span id="l8.1174">   PRInt64  size = 0;</span>
<a href="#l8.1175"></a><span id="l8.1175" class="difflineminus">-  nsresult rv = pFile-&gt;GetFileSize( &amp;size);</span>
<a href="#l8.1176"></a><span id="l8.1176" class="difflineplus">+  nsresult rv = pFile-&gt;GetFileSize(&amp;size);</span>
<a href="#l8.1177"></a><span id="l8.1177">   if (size)</span>
<a href="#l8.1178"></a><span id="l8.1178">   {</span>
<a href="#l8.1179"></a><span id="l8.1179">     if (size &lt; 10)</span>
<a href="#l8.1180"></a><span id="l8.1180" class="difflineminus">-      return( false);</span>
<a href="#l8.1181"></a><span id="l8.1181" class="difflineplus">+      return false;</span>
<a href="#l8.1182"></a><span id="l8.1182">     nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l8.1183"></a><span id="l8.1183">     rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), pFile);</span>
<a href="#l8.1184"></a><span id="l8.1184" class="difflineminus">-    if (NS_FAILED( rv))</span>
<a href="#l8.1185"></a><span id="l8.1185" class="difflineminus">-      return( false);</span>
<a href="#l8.1186"></a><span id="l8.1186" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l8.1187"></a><span id="l8.1187" class="difflineplus">+      return false;</span>
<a href="#l8.1188"></a><span id="l8.1188">     PRUint32  read = 0;</span>
<a href="#l8.1189"></a><span id="l8.1189">     char  buffer[6];</span>
<a href="#l8.1190"></a><span id="l8.1190">     char *  pBuf = buffer;</span>
<a href="#l8.1191"></a><span id="l8.1191" class="difflineminus">-    rv = inputStream-&gt;Read( pBuf, 5, &amp;read);</span>
<a href="#l8.1192"></a><span id="l8.1192" class="difflineplus">+    rv = inputStream-&gt;Read(pBuf, 5, &amp;read);</span>
<a href="#l8.1193"></a><span id="l8.1193">     inputStream-&gt;Close();</span>
<a href="#l8.1194"></a><span id="l8.1194" class="difflineminus">-    if (NS_FAILED( rv) || (read != 5))</span>
<a href="#l8.1195"></a><span id="l8.1195" class="difflineminus">-      return( false);</span>
<a href="#l8.1196"></a><span id="l8.1196" class="difflineplus">+    if (NS_FAILED(rv) || (read != 5))</span>
<a href="#l8.1197"></a><span id="l8.1197" class="difflineplus">+      return false;</span>
<a href="#l8.1198"></a><span id="l8.1198">     buffer[5] = 0;</span>
<a href="#l8.1199"></a><span id="l8.1199" class="difflineminus">-    if (strcmp( buffer, &quot;From &quot;))</span>
<a href="#l8.1200"></a><span id="l8.1200" class="difflineminus">-      return( false);</span>
<a href="#l8.1201"></a><span id="l8.1201" class="difflineplus">+    if (strcmp(buffer, &quot;From &quot;))</span>
<a href="#l8.1202"></a><span id="l8.1202" class="difflineplus">+      return false;</span>
<a href="#l8.1203"></a><span id="l8.1203">   }</span>
<a href="#l8.1204"></a><span id="l8.1204"> </span>
<a href="#l8.1205"></a><span id="l8.1205" class="difflineminus">-  return( true);</span>
<a href="#l8.1206"></a><span id="l8.1206" class="difflineplus">+  return true;</span>
<a href="#l8.1207"></a><span id="l8.1207"> }</span>
<a href="#l8.1208"></a><span id="l8.1208"> </span>
<a href="#l8.1209"></a><span id="l8.1209"> </span>
<a href="#l8.1210"></a><span id="l8.1210"> </span>
<a href="#l8.1211"></a><span id="l8.1211"> </span>
<a href="#l8.1212"></a><span id="l8.1212" class="difflineminus">-bool nsEudoraMac::FindAddressFolder( nsIFile **pFolder)</span>
<a href="#l8.1213"></a><span id="l8.1213" class="difflineplus">+bool nsEudoraMac::FindAddressFolder(nsIFile **pFolder)</span>
<a href="#l8.1214"></a><span id="l8.1214"> {</span>
<a href="#l8.1215"></a><span id="l8.1215" class="difflineminus">-  return( FindEudoraLocation( pFolder));</span>
<a href="#l8.1216"></a><span id="l8.1216" class="difflineplus">+  return FindEudoraLocation(pFolder);</span>
<a href="#l8.1217"></a><span id="l8.1217"> }</span>
<a href="#l8.1218"></a><span id="l8.1218"> </span>
<a href="#l8.1219"></a><span id="l8.1219" class="difflineminus">-nsresult nsEudoraMac::FindAddressBooks( nsIFile *pRoot, nsISupportsArray **ppArray)</span>
<a href="#l8.1220"></a><span id="l8.1220" class="difflineplus">+nsresult nsEudoraMac::FindAddressBooks(nsIFile *pRoot, nsISupportsArray **ppArray)</span>
<a href="#l8.1221"></a><span id="l8.1221"> {</span>
<a href="#l8.1222"></a><span id="l8.1222">   // Look for the nicknames file in this folder and then</span>
<a href="#l8.1223"></a><span id="l8.1223">   // additional files in the Nicknames folder</span>
<a href="#l8.1224"></a><span id="l8.1224">   // Try and find the nickNames file</span>
<a href="#l8.1225"></a><span id="l8.1225">   nsresult rv;</span>
<a href="#l8.1226"></a><span id="l8.1226">   nsCOMPtr&lt;nsILocalFile&gt; file = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l8.1227"></a><span id="l8.1227">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.1228"></a><span id="l8.1228">   nsCOMPtr&lt;nsILocalFile&gt; localRoot = do_QueryInterface(pRoot);</span>
<a href="#l8.1229"></a><span id="l8.1229">   rv = file-&gt;InitWithFile(localRoot);</span>
<a href="#l8.1230"></a><span id="l8.1230" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l8.1231"></a><span id="l8.1231" class="difflineminus">-    return( rv);</span>
<a href="#l8.1232"></a><span id="l8.1232" class="difflineminus">-  rv = NS_NewISupportsArray( ppArray);</span>
<a href="#l8.1233"></a><span id="l8.1233" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l8.1234"></a><span id="l8.1234" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l8.1235"></a><span id="l8.1235" class="difflineplus">+    return rv;</span>
<a href="#l8.1236"></a><span id="l8.1236" class="difflineplus">+  rv = NS_NewISupportsArray(ppArray);</span>
<a href="#l8.1237"></a><span id="l8.1237" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l8.1238"></a><span id="l8.1238">   {</span>
<a href="#l8.1239"></a><span id="l8.1239" class="difflineminus">-    IMPORT_LOG0( &quot;FAILED to allocate the nsISupportsArray\n&quot;);</span>
<a href="#l8.1240"></a><span id="l8.1240" class="difflineminus">-    return( rv);</span>
<a href="#l8.1241"></a><span id="l8.1241" class="difflineplus">+    IMPORT_LOG0(&quot;FAILED to allocate the nsISupportsArray\n&quot;);</span>
<a href="#l8.1242"></a><span id="l8.1242" class="difflineplus">+    return rv;</span>
<a href="#l8.1243"></a><span id="l8.1243">   }</span>
<a href="#l8.1244"></a><span id="l8.1244"> </span>
<a href="#l8.1245"></a><span id="l8.1245">   nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l8.1246"></a><span id="l8.1246" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l8.1247"></a><span id="l8.1247" class="difflineminus">-    return( rv);</span>
<a href="#l8.1248"></a><span id="l8.1248" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l8.1249"></a><span id="l8.1249" class="difflineplus">+    return rv;</span>
<a href="#l8.1250"></a><span id="l8.1250"> </span>
<a href="#l8.1251"></a><span id="l8.1251">   nsString displayName;</span>
<a href="#l8.1252"></a><span id="l8.1252" class="difflineminus">-  nsEudoraStringBundle::GetStringByID( EUDORAIMPORT_NICKNAMES_NAME, displayName);</span>
<a href="#l8.1253"></a><span id="l8.1253" class="difflineplus">+  nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_NICKNAMES_NAME, displayName);</span>
<a href="#l8.1254"></a><span id="l8.1254">   PRInt64  sz = 0;</span>
<a href="#l8.1255"></a><span id="l8.1255"> </span>
<a href="#l8.1256"></a><span id="l8.1256">   // First find the Nicknames file itself</span>
<a href="#l8.1257"></a><span id="l8.1257" class="difflineminus">-  rv = file-&gt;AppendNative( NS_LITERAL_CSTRING(&quot;Eudora Nicknames&quot;));</span>
<a href="#l8.1258"></a><span id="l8.1258" class="difflineplus">+  rv = file-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Eudora Nicknames&quot;));</span>
<a href="#l8.1259"></a><span id="l8.1259">   bool exists = false;</span>
<a href="#l8.1260"></a><span id="l8.1260">   bool isFile = false;</span>
<a href="#l8.1261"></a><span id="l8.1261" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l8.1262"></a><span id="l8.1262" class="difflineminus">-    rv = file-&gt;Exists( &amp;exists);</span>
<a href="#l8.1263"></a><span id="l8.1263" class="difflineminus">-  if (NS_SUCCEEDED( rv) &amp;&amp; exists)</span>
<a href="#l8.1264"></a><span id="l8.1264" class="difflineminus">-    rv = file-&gt;IsFile( &amp;isFile);</span>
<a href="#l8.1265"></a><span id="l8.1265" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l8.1266"></a><span id="l8.1266" class="difflineplus">+    rv = file-&gt;Exists(&amp;exists);</span>
<a href="#l8.1267"></a><span id="l8.1267" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l8.1268"></a><span id="l8.1268" class="difflineplus">+    rv = file-&gt;IsFile(&amp;isFile);</span>
<a href="#l8.1269"></a><span id="l8.1269"> </span>
<a href="#l8.1270"></a><span id="l8.1270"> </span>
<a href="#l8.1271"></a><span id="l8.1271">   nsCOMPtr&lt;nsIImportABDescriptor&gt;  desc;</span>
<a href="#l8.1272"></a><span id="l8.1272">   nsISupports *pInterface;</span>
<a href="#l8.1273"></a><span id="l8.1273"> </span>
<a href="#l8.1274"></a><span id="l8.1274">   if (exists &amp;&amp; isFile)</span>
<a href="#l8.1275"></a><span id="l8.1275">   {</span>
<a href="#l8.1276"></a><span id="l8.1276" class="difflineminus">-    rv = impSvc-&gt;CreateNewABDescriptor( getter_AddRefs( desc));</span>
<a href="#l8.1277"></a><span id="l8.1277" class="difflineminus">-    if (NS_SUCCEEDED( rv))</span>
<a href="#l8.1278"></a><span id="l8.1278" class="difflineplus">+    rv = impSvc-&gt;CreateNewABDescriptor(getter_AddRefs(desc));</span>
<a href="#l8.1279"></a><span id="l8.1279" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l8.1280"></a><span id="l8.1280">     {</span>
<a href="#l8.1281"></a><span id="l8.1281">       sz = 0;</span>
<a href="#l8.1282"></a><span id="l8.1282" class="difflineminus">-      file-&gt;GetFileSize( &amp;sz);</span>
<a href="#l8.1283"></a><span id="l8.1283" class="difflineplus">+      file-&gt;GetFileSize(&amp;sz);</span>
<a href="#l8.1284"></a><span id="l8.1284">       desc-&gt;SetPreferredName(displayName);</span>
<a href="#l8.1285"></a><span id="l8.1285" class="difflineminus">-      desc-&gt;SetSize( sz);</span>
<a href="#l8.1286"></a><span id="l8.1286" class="difflineplus">+      desc-&gt;SetSize(sz);</span>
<a href="#l8.1287"></a><span id="l8.1287">       // SetAbFile will clone the file we pass to it.</span>
<a href="#l8.1288"></a><span id="l8.1288">       desc-&gt;SetAbFile(file);</span>
<a href="#l8.1289"></a><span id="l8.1289" class="difflineminus">-      rv = desc-&gt;QueryInterface( kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l8.1290"></a><span id="l8.1290" class="difflineminus">-      (*ppArray)-&gt;AppendElement( pInterface);</span>
<a href="#l8.1291"></a><span id="l8.1291" class="difflineplus">+      rv = desc-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l8.1292"></a><span id="l8.1292" class="difflineplus">+      (*ppArray)-&gt;AppendElement(pInterface);</span>
<a href="#l8.1293"></a><span id="l8.1293">       pInterface-&gt;Release();</span>
<a href="#l8.1294"></a><span id="l8.1294">     }</span>
<a href="#l8.1295"></a><span id="l8.1295" class="difflineminus">-    if (NS_FAILED( rv))</span>
<a href="#l8.1296"></a><span id="l8.1296" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l8.1297"></a><span id="l8.1297">     {</span>
<a href="#l8.1298"></a><span id="l8.1298" class="difflineminus">-      IMPORT_LOG0( &quot;*** Error creating address book descriptor for eudora nicknames\n&quot;);</span>
<a href="#l8.1299"></a><span id="l8.1299" class="difflineminus">-      return( rv);</span>
<a href="#l8.1300"></a><span id="l8.1300" class="difflineplus">+      IMPORT_LOG0(&quot;*** Error creating address book descriptor for eudora nicknames\n&quot;);</span>
<a href="#l8.1301"></a><span id="l8.1301" class="difflineplus">+      return rv;</span>
<a href="#l8.1302"></a><span id="l8.1302">     }</span>
<a href="#l8.1303"></a><span id="l8.1303">   }</span>
<a href="#l8.1304"></a><span id="l8.1304"> </span>
<a href="#l8.1305"></a><span id="l8.1305">   // Now try the directory of address books!</span>
<a href="#l8.1306"></a><span id="l8.1306">   rv = file-&gt;InitWithFile(localRoot);</span>
<a href="#l8.1307"></a><span id="l8.1307" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l8.1308"></a><span id="l8.1308" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l8.1309"></a><span id="l8.1309">     rv = file-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Nicknames Folder&quot;));</span>
<a href="#l8.1310"></a><span id="l8.1310">   exists = false;</span>
<a href="#l8.1311"></a><span id="l8.1311">   bool    isDir = false;</span>
<a href="#l8.1312"></a><span id="l8.1312" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l8.1313"></a><span id="l8.1313" class="difflineminus">-    rv = file-&gt;Exists( &amp;exists);</span>
<a href="#l8.1314"></a><span id="l8.1314" class="difflineminus">-  if (NS_SUCCEEDED( rv) &amp;&amp; exists)</span>
<a href="#l8.1315"></a><span id="l8.1315" class="difflineminus">-    rv = file-&gt;IsDirectory( &amp;isDir);</span>
<a href="#l8.1316"></a><span id="l8.1316" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l8.1317"></a><span id="l8.1317" class="difflineplus">+    rv = file-&gt;Exists(&amp;exists);</span>
<a href="#l8.1318"></a><span id="l8.1318" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l8.1319"></a><span id="l8.1319" class="difflineplus">+    rv = file-&gt;IsDirectory(&amp;isDir);</span>
<a href="#l8.1320"></a><span id="l8.1320"> </span>
<a href="#l8.1321"></a><span id="l8.1321">   if (!isDir)</span>
<a href="#l8.1322"></a><span id="l8.1322" class="difflineminus">-    return( NS_OK);</span>
<a href="#l8.1323"></a><span id="l8.1323" class="difflineplus">+    return NS_OK;</span>
<a href="#l8.1324"></a><span id="l8.1324"> </span>
<a href="#l8.1325"></a><span id="l8.1325">   bool hasMore;</span>
<a href="#l8.1326"></a><span id="l8.1326">   nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l8.1327"></a><span id="l8.1327">    rv = file-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l8.1328"></a><span id="l8.1328">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.1329"></a><span id="l8.1329"> </span>
<a href="#l8.1330"></a><span id="l8.1330">   directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l8.1331"></a><span id="l8.1331"> </span>
<a href="#l8.1332"></a><span id="l8.1332" class="difflineat">@@ -1238,56 +1230,56 @@ nsresult nsEudoraMac::FindAddressBooks( </span>
<a href="#l8.1333"></a><span id="l8.1333"> </span>
<a href="#l8.1334"></a><span id="l8.1334">   while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l8.1335"></a><span id="l8.1335">   {</span>
<a href="#l8.1336"></a><span id="l8.1336">     nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l8.1337"></a><span id="l8.1337">     rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l8.1338"></a><span id="l8.1338">     nsCOMPtr&lt;nsILocalFile&gt; entry(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l8.1339"></a><span id="l8.1339">     directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l8.1340"></a><span id="l8.1340"> </span>
<a href="#l8.1341"></a><span id="l8.1341" class="difflineminus">-    if (NS_SUCCEEDED( rv))</span>
<a href="#l8.1342"></a><span id="l8.1342" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l8.1343"></a><span id="l8.1343">     {</span>
<a href="#l8.1344"></a><span id="l8.1344">       isFile = false;</span>
<a href="#l8.1345"></a><span id="l8.1345" class="difflineminus">-      rv = entry-&gt;IsFile( &amp;isFile);</span>
<a href="#l8.1346"></a><span id="l8.1346" class="difflineplus">+      rv = entry-&gt;IsFile(&amp;isFile);</span>
<a href="#l8.1347"></a><span id="l8.1347">       rv = entry-&gt;GetLeafName(displayName);</span>
<a href="#l8.1348"></a><span id="l8.1348" class="difflineminus">-      if (NS_SUCCEEDED( rv) &amp;&amp; !displayName.IsEmpty() &amp;&amp; isFile)</span>
<a href="#l8.1349"></a><span id="l8.1349" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; !displayName.IsEmpty() &amp;&amp; isFile)</span>
<a href="#l8.1350"></a><span id="l8.1350">       {</span>
<a href="#l8.1351"></a><span id="l8.1351" class="difflineminus">-        if (NS_SUCCEEDED( rv))</span>
<a href="#l8.1352"></a><span id="l8.1352" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l8.1353"></a><span id="l8.1353">         {</span>
<a href="#l8.1354"></a><span id="l8.1354">           type = 0;</span>
<a href="#l8.1355"></a><span id="l8.1355">           creator = 0;</span>
<a href="#l8.1356"></a><span id="l8.1356">           {</span>
<a href="#l8.1357"></a><span id="l8.1357">             nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(entry, &amp;rv);</span>
<a href="#l8.1358"></a><span id="l8.1358">             if (NS_SUCCEEDED(rv))</span>
<a href="#l8.1359"></a><span id="l8.1359">             {</span>
<a href="#l8.1360"></a><span id="l8.1360">               macFile-&gt;GetFileCreator(&amp;creator);</span>
<a href="#l8.1361"></a><span id="l8.1361">               macFile-&gt;GetFileType(&amp;type);</span>
<a href="#l8.1362"></a><span id="l8.1362">             }</span>
<a href="#l8.1363"></a><span id="l8.1363">           }</span>
<a href="#l8.1364"></a><span id="l8.1364">           if (type == 'TEXT')</span>
<a href="#l8.1365"></a><span id="l8.1365">           {</span>
<a href="#l8.1366"></a><span id="l8.1366"> </span>
<a href="#l8.1367"></a><span id="l8.1367" class="difflineminus">-            rv = impSvc-&gt;CreateNewABDescriptor( getter_AddRefs( desc));</span>
<a href="#l8.1368"></a><span id="l8.1368" class="difflineminus">-            if (NS_SUCCEEDED( rv))</span>
<a href="#l8.1369"></a><span id="l8.1369" class="difflineplus">+            rv = impSvc-&gt;CreateNewABDescriptor(getter_AddRefs(desc));</span>
<a href="#l8.1370"></a><span id="l8.1370" class="difflineplus">+            if (NS_SUCCEEDED(rv))</span>
<a href="#l8.1371"></a><span id="l8.1371">             {</span>
<a href="#l8.1372"></a><span id="l8.1372">               sz = 0;</span>
<a href="#l8.1373"></a><span id="l8.1373" class="difflineminus">-              entry-&gt;GetFileSize( &amp;sz);</span>
<a href="#l8.1374"></a><span id="l8.1374" class="difflineplus">+              entry-&gt;GetFileSize(&amp;sz);</span>
<a href="#l8.1375"></a><span id="l8.1375">               desc-&gt;SetPreferredName(displayName);</span>
<a href="#l8.1376"></a><span id="l8.1376" class="difflineminus">-              desc-&gt;SetSize( sz);</span>
<a href="#l8.1377"></a><span id="l8.1377" class="difflineplus">+              desc-&gt;SetSize(sz);</span>
<a href="#l8.1378"></a><span id="l8.1378">               // SetAbFile will clone the file we pass to it.</span>
<a href="#l8.1379"></a><span id="l8.1379">               desc-&gt;SetAbFile(entry);</span>
<a href="#l8.1380"></a><span id="l8.1380" class="difflineminus">-              rv = desc-&gt;QueryInterface( kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l8.1381"></a><span id="l8.1381" class="difflineminus">-              (*ppArray)-&gt;AppendElement( pInterface);</span>
<a href="#l8.1382"></a><span id="l8.1382" class="difflineplus">+              rv = desc-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l8.1383"></a><span id="l8.1383" class="difflineplus">+              (*ppArray)-&gt;AppendElement(pInterface);</span>
<a href="#l8.1384"></a><span id="l8.1384">               pInterface-&gt;Release();</span>
<a href="#l8.1385"></a><span id="l8.1385">             }</span>
<a href="#l8.1386"></a><span id="l8.1386" class="difflineminus">-            if (NS_FAILED( rv))</span>
<a href="#l8.1387"></a><span id="l8.1387" class="difflineplus">+            if (NS_FAILED(rv))</span>
<a href="#l8.1388"></a><span id="l8.1388">             {</span>
<a href="#l8.1389"></a><span id="l8.1389" class="difflineminus">-              IMPORT_LOG0( &quot;*** Error creating address book descriptor for eudora address book\n&quot;);</span>
<a href="#l8.1390"></a><span id="l8.1390" class="difflineminus">-              return( rv);</span>
<a href="#l8.1391"></a><span id="l8.1391" class="difflineplus">+              IMPORT_LOG0(&quot;*** Error creating address book descriptor for eudora address book\n&quot;);</span>
<a href="#l8.1392"></a><span id="l8.1392" class="difflineplus">+              return rv;</span>
<a href="#l8.1393"></a><span id="l8.1393">             }</span>
<a href="#l8.1394"></a><span id="l8.1394">           }</span>
<a href="#l8.1395"></a><span id="l8.1395">         }</span>
<a href="#l8.1396"></a><span id="l8.1396">       }</span>
<a href="#l8.1397"></a><span id="l8.1397">     }</span>
<a href="#l8.1398"></a><span id="l8.1398">   }</span>
<a href="#l8.1399"></a><span id="l8.1399" class="difflineminus">-  return( rv);</span>
<a href="#l8.1400"></a><span id="l8.1400" class="difflineplus">+  return rv;</span>
<a href="#l8.1401"></a><span id="l8.1401"> }</span>
<a href="#l8.1402"></a><span id="l8.1402"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraMac.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraMac.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -55,60 +55,98 @@ class nsIMsgAccount;</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> class nsEudoraMac : public nsEudoraMailbox, public nsEudoraAddress {</span>
<a href="#l9.7"></a><span id="l9.7"> public:</span>
<a href="#l9.8"></a><span id="l9.8">   nsEudoraMac();</span>
<a href="#l9.9"></a><span id="l9.9">   ~nsEudoraMac();</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11">     // retrieve the mail folder</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  virtual bool      FindMailFolder( nsIFile **pFolder);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  virtual bool      FindMailFolder(nsIFile **pFolder);</span>
<a href="#l9.14"></a><span id="l9.14">     // get the list of mailboxes</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-  virtual nsresult  FindMailboxes( nsIFile *pRoot, nsISupportsArray **ppArray);</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+  virtual nsresult  FindMailboxes(nsIFile *pRoot,</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+                                  nsISupportsArray **ppArray);</span>
<a href="#l9.18"></a><span id="l9.18">     // get a TOC file from a mailbox file</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-  virtual nsresult  FindTOCFile( nsIFile *pMailFile, nsIFile **pTOCFile, bool *pDeleteToc);</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+  virtual nsresult  FindTOCFile(nsIFile *pMailFile,</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+                                nsIFile **pTOCFile,</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+                                bool *pDeleteToc);</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-  virtual nsresult  GetAttachmentInfo( const char *pFileName, nsIFile *pFile, nsCString&amp; mimeType, nsCString&amp; aAttachment);</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+  virtual nsresult  GetAttachmentInfo(const char *pFileName,</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+                                      nsIFile *pFile,</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+                                      nsCString&amp; mimeType,</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+                                      nsCString&amp; aAttachment);</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30">     // Address book stuff</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-  virtual bool      FindAddressFolder( nsIFile **pFolder);</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  virtual bool      FindAddressFolder(nsIFile **pFolder);</span>
<a href="#l9.33"></a><span id="l9.33">     // get the list of mailboxes</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-  virtual nsresult  FindAddressBooks( nsIFile *pRoot, nsISupportsArray **ppArray);</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+  virtual nsresult  FindAddressBooks(nsIFile *pRoot,</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+                                     nsISupportsArray **ppArray);</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38">     // import settings</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-  static bool    ImportSettings( nsIFile *pIniFile, nsIMsgAccount **localMailAccount);</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-  static bool    FindSettingsFile( nsIFile **pIniFile) { return( FindEudoraLocation( pIniFile, true));}</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+  static bool    ImportSettings(nsIFile *pIniFile,</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+                                nsIMsgAccount **localMailAccount);</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+  static bool    FindSettingsFile(nsIFile **pIniFile) { return FindEudoraLocation(pIniFile, true);}</span>
<a href="#l9.44"></a><span id="l9.44"> </span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-  static bool    FindFiltersFile( nsIFile **pFiltersFile);</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+  static bool    FindFiltersFile(nsIFile **pFiltersFile);</span>
<a href="#l9.47"></a><span id="l9.47"> </span>
<a href="#l9.48"></a><span id="l9.48"> private:</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-  static bool    FindEudoraLocation( nsIFile **pFolder, bool findIni = false, nsIFile *pLookIn = nsnull);</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-  static bool    FindEudoraLocation( nsIFile **pFolder, bool findIni, const char *specialDirName );</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-  static bool    VerifyEudoraLocation( nsIFile **pFolder, bool findIni );</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+  static bool    FindEudoraLocation(nsIFile **pFolder,</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+                                    bool findIni = false,</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+                                    nsIFile *pLookIn = nsnull);</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+  static bool    FindEudoraLocation(nsIFile **pFolder,</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+                                    bool findIni,</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+                                    const char *specialDirName);</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+  static bool    VerifyEudoraLocation(nsIFile **pFolder, bool findIni);</span>
<a href="#l9.59"></a><span id="l9.59"> </span>
<a href="#l9.60"></a><span id="l9.60"> </span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-  nsresult  ScanMailDir( nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport);</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-  nsresult  IterateMailDir( nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport);</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-  nsresult  FoundMailFolder( nsILocalFile *mailFolder, const char *pName, nsISupportsArray *pArray, nsIImportService *pImport);</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-  nsresult  FoundMailbox( nsIFile *mailFile, const char *pName, nsISupportsArray *pArray, nsIImportService *pImport);</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+  nsresult  ScanMailDir(nsIFile *pFolder,</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+                        nsISupportsArray *pArray,</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+                        nsIImportService *pImport);</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+  nsresult  IterateMailDir(nsIFile *pFolder,</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+                           nsISupportsArray *pArray,</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+                           nsIImportService *pImport);</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+  nsresult  FoundMailFolder(nsILocalFile *mailFolder,</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+                            const char *pName,</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+                            nsISupportsArray *pArray,</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+                            nsIImportService *pImport);</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+  nsresult  FoundMailbox(nsIFile *mailFile,</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+                         const char *pName,</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+                         nsISupportsArray *pArray,</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+                         nsIImportService *pImport);</span>
<a href="#l9.79"></a><span id="l9.79"> </span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-  bool      IsValidMailFolderName( nsCString&amp; name);</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-  bool      IsValidMailboxName( nsCString&amp; fName);</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-  bool      IsValidMailboxFile( nsIFile *pFile);</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+  bool      IsValidMailFolderName(nsCString&amp; name);</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+  bool      IsValidMailboxName(nsCString&amp; fName);</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+  bool      IsValidMailboxFile(nsIFile *pFile);</span>
<a href="#l9.86"></a><span id="l9.86"> </span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-  bool      CreateTocFromResource( nsIFile *pMail, nsIFile **pToc);</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+  bool      CreateTocFromResource(nsIFile *pMail, nsIFile **pToc);</span>
<a href="#l9.89"></a><span id="l9.89"> </span>
<a href="#l9.90"></a><span id="l9.90"> </span>
<a href="#l9.91"></a><span id="l9.91"> </span>
<a href="#l9.92"></a><span id="l9.92">     // Settings support</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-  static bool    BuildPOPAccount( nsIMsgAccountManager *accMgr, nsCString **pStrs, nsIMsgAccount **ppAccount, nsString&amp; accName);</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-  static bool    BuildIMAPAccount( nsIMsgAccountManager *accMgr, nsCString **pStrs, nsIMsgAccount **ppAccount, nsString&amp; accName);</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-  static void    SetIdentities( nsIMsgAccountManager *accMgr, nsIMsgAccount *acc, const char *userName, const char *serverName, nsCString **pStrs);</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-  static void    SetSmtpServer( nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, const char *pServer, const char *pUser);</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-  static bool    GetSettingsFromResource( nsIFile *pSettings, short resId, nsCString **pStrs, bool *pIMAP);</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+  static bool    BuildPOPAccount(nsIMsgAccountManager *accMgr,</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+                                 nsCString **pStrs,</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+                                 nsIMsgAccount **ppAccount,</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+                                 nsString&amp; accName);</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+  static bool    BuildIMAPAccount(nsIMsgAccountManager *accMgr,</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+                                  nsCString **pStrs,</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+                                  nsIMsgAccount **ppAccount,</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+                                  nsString&amp; accName);</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+  static void    SetIdentities(nsIMsgAccountManager *accMgr,</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+                               nsIMsgAccount *acc,</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+                               const char *userName,</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+                               const char *serverName,</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+                               nsCString **pStrs);</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+  static void    SetSmtpServer(nsIMsgAccountManager *pMgr,</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+                               nsIMsgAccount *pAcc,</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+                               const char *pServer,</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+                               const char *pUser);</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+  static bool    GetSettingsFromResource(nsIFile *pSettings,</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+                                         short resId,</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+                                         nsCString **pStrs,</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+                                         bool *pIMAP);</span>
<a href="#l9.119"></a><span id="l9.119"> </span>
<a href="#l9.120"></a><span id="l9.120"> </span>
<a href="#l9.121"></a><span id="l9.121"> private:</span>
<a href="#l9.122"></a><span id="l9.122">   PRUint32 m_depth;</span>
<a href="#l9.123"></a><span id="l9.123">   nsCOMPtr &lt;nsILocalFile&gt; m_mailImportLocation;</span>
<a href="#l9.124"></a><span id="l9.124">   bool HasResourceFork(FSRef *fsRef);</span>
<a href="#l9.125"></a><span id="l9.125"> };</span>
<a href="#l9.126"></a><span id="l9.126"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraMailbox.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraMailbox.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -57,38 +57,35 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #define  kMailReadBufferSize  16384</span>
<a href="#l10.5"></a><span id="l10.5"> #define DATE_STR_LEN      64      // 64 bytes is plenty to hold the date header.</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> #define  kWhitespace  &quot; \t\b\r\n&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> const char *eudoraFromLine = &quot;From - Mon Jan 1 00:00:00 1965\x0D\x0A&quot;;</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> #ifdef IMPORT_DEBUG</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-void DUMP_FILENAME( nsIFile *pFile, bool endLine);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+void DUMP_FILENAME(nsIFile *pFile, bool endLine);</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-void DUMP_FILENAME( nsIFile *pFile, bool endLine)</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+void DUMP_FILENAME(nsIFile *pFile, bool endLine)</span>
<a href="#l10.17"></a><span id="l10.17"> {</span>
<a href="#l10.18"></a><span id="l10.18">   nsCString pPath;</span>
<a href="#l10.19"></a><span id="l10.19">   if (pFile)</span>
<a href="#l10.20"></a><span id="l10.20">     pFile-&gt;GetNativePath(pPath);</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-  if (!pPath.IsEmpty()) {</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-    IMPORT_LOG1( &quot;%s&quot;, pPath.get());</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-  }</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-  else {</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-    IMPORT_LOG0( &quot;Unknown&quot;);</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-  }</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-  if (endLine) {</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-    IMPORT_LOG0( &quot;\n&quot;);</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-  }</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+  if (!pPath.IsEmpty())</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+    IMPORT_LOG1(&quot;%s&quot;, pPath.get());</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+  else</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+    IMPORT_LOG0(&quot;Unknown&quot;);</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+  if (endLine)</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+    IMPORT_LOG0(&quot;\n&quot;);</span>
<a href="#l10.36"></a><span id="l10.36"> }</span>
<a href="#l10.37"></a><span id="l10.37"> </span>
<a href="#l10.38"></a><span id="l10.38"> // #define  DONT_DELETE_EUDORA_TEMP_FILES    1</span>
<a href="#l10.39"></a><span id="l10.39"> </span>
<a href="#l10.40"></a><span id="l10.40"> #else</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-#define DUMP_FILENAME( x, y)</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+#define DUMP_FILENAME(x, y)</span>
<a href="#l10.43"></a><span id="l10.43"> #endif</span>
<a href="#l10.44"></a><span id="l10.44"> </span>
<a href="#l10.45"></a><span id="l10.45"> static const char *eudoraWeekDays[7] = {</span>
<a href="#l10.46"></a><span id="l10.46">   &quot;Mon&quot;,</span>
<a href="#l10.47"></a><span id="l10.47">   &quot;Tue&quot;,</span>
<a href="#l10.48"></a><span id="l10.48">   &quot;Wed&quot;,</span>
<a href="#l10.49"></a><span id="l10.49">   &quot;Thu&quot;,</span>
<a href="#l10.50"></a><span id="l10.50">   &quot;Fri&quot;,</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineat">@@ -195,154 +192,154 @@ nsEudoraMailbox::nsEudoraMailbox()</span>
<a href="#l10.52"></a><span id="l10.52"> {</span>
<a href="#l10.53"></a><span id="l10.53"> }</span>
<a href="#l10.54"></a><span id="l10.54"> </span>
<a href="#l10.55"></a><span id="l10.55"> nsEudoraMailbox::~nsEudoraMailbox()</span>
<a href="#l10.56"></a><span id="l10.56"> {</span>
<a href="#l10.57"></a><span id="l10.57">   EmptyAttachments();</span>
<a href="#l10.58"></a><span id="l10.58"> }</span>
<a href="#l10.59"></a><span id="l10.59"> </span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-nsresult nsEudoraMailbox::CreateTempFile( nsIFile **ppFile)</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+nsresult nsEudoraMailbox::CreateTempFile(nsIFile **ppFile)</span>
<a href="#l10.62"></a><span id="l10.62"> {</span>
<a href="#l10.63"></a><span id="l10.63">   nsresult rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l10.64"></a><span id="l10.64">                                                 &quot;impmail.txt&quot;,</span>
<a href="#l10.65"></a><span id="l10.65">                                                 ppFile);</span>
<a href="#l10.66"></a><span id="l10.66">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.67"></a><span id="l10.67"> </span>
<a href="#l10.68"></a><span id="l10.68">   return (*ppFile)-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l10.69"></a><span id="l10.69"> }</span>
<a href="#l10.70"></a><span id="l10.70"> </span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-nsresult nsEudoraMailbox::DeleteFile( nsIFile *pFile)</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+nsresult nsEudoraMailbox::DeleteFile(nsIFile *pFile)</span>
<a href="#l10.73"></a><span id="l10.73"> {</span>
<a href="#l10.74"></a><span id="l10.74">   bool      result;</span>
<a href="#l10.75"></a><span id="l10.75">   nsresult  rv = NS_OK;</span>
<a href="#l10.76"></a><span id="l10.76"> </span>
<a href="#l10.77"></a><span id="l10.77">   result = false;</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-  pFile-&gt;Exists( &amp;result);</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+  pFile-&gt;Exists(&amp;result);</span>
<a href="#l10.80"></a><span id="l10.80">   if (result) {</span>
<a href="#l10.81"></a><span id="l10.81">     result = false;</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-    pFile-&gt;IsFile( &amp;result);</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+    pFile-&gt;IsFile(&amp;result);</span>
<a href="#l10.84"></a><span id="l10.84">     if (result) {</span>
<a href="#l10.85"></a><span id="l10.85"> #ifndef DONT_DELETE_EUDORA_TEMP_FILES</span>
<a href="#l10.86"></a><span id="l10.86">         rv = pFile-&gt;Remove(false);</span>
<a href="#l10.87"></a><span id="l10.87"> #endif</span>
<a href="#l10.88"></a><span id="l10.88">     }</span>
<a href="#l10.89"></a><span id="l10.89">   }</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-  return( rv);</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+  return rv;</span>
<a href="#l10.92"></a><span id="l10.92"> }</span>
<a href="#l10.93"></a><span id="l10.93"> </span>
<a href="#l10.94"></a><span id="l10.94"> #define kComposeErrorStr  &quot;X-Eudora-Compose-Error: *****&quot; &quot;\x0D\x0A&quot;</span>
<a href="#l10.95"></a><span id="l10.95"> #define kHTMLTag &quot;&lt;html&gt;&quot;</span>
<a href="#l10.96"></a><span id="l10.96"> </span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-nsresult nsEudoraMailbox::ImportMailbox( PRUint32 *pBytes, bool *pAbort, const PRUnichar *pName, nsIFile *pSrc, nsIFile *pDst, PRInt32 *pMsgCount)</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+nsresult nsEudoraMailbox::ImportMailbox(PRUint32 *pBytes, bool *pAbort, const PRUnichar *pName, nsIFile *pSrc, nsIFile *pDst, PRInt32 *pMsgCount)</span>
<a href="#l10.99"></a><span id="l10.99"> {</span>
<a href="#l10.100"></a><span id="l10.100">   nsCOMPtr&lt;nsIFile&gt;   tocFile;</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-        nsCOMPtr &lt;nsIInputStream&gt; srcInputStream;</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-        nsCOMPtr &lt;nsIInputStream&gt; tocInputStream;</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-        nsCOMPtr &lt;nsIOutputStream&gt; mailOutputStream;</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-   bool                importWithoutToc = true;</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; srcInputStream;</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; tocInputStream;</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; mailOutputStream;</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+  bool                importWithoutToc = true;</span>
<a href="#l10.109"></a><span id="l10.109">   bool                deleteToc = false;</span>
<a href="#l10.110"></a><span id="l10.110">   nsresult            rv;</span>
<a href="#l10.111"></a><span id="l10.111">   nsCOMPtr&lt;nsIFile&gt;   mailFile;</span>
<a href="#l10.112"></a><span id="l10.112"> </span>
<a href="#l10.113"></a><span id="l10.113">   if (pMsgCount)</span>
<a href="#l10.114"></a><span id="l10.114">     *pMsgCount = 0;</span>
<a href="#l10.115"></a><span id="l10.115"> </span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-  rv = pSrc-&gt;GetFileSize( &amp;m_mailSize);</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+  rv = pSrc-&gt;GetFileSize(&amp;m_mailSize);</span>
<a href="#l10.118"></a><span id="l10.118"> </span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-        rv = NS_NewLocalFileInputStream(getter_AddRefs(srcInputStream), pSrc);</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-        if (NS_FAILED( rv))</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-    return( rv);</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+  rv = NS_NewLocalFileInputStream(getter_AddRefs(srcInputStream), pSrc);</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+    return rv;</span>
<a href="#l10.125"></a><span id="l10.125"> </span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-  NS_ADDREF( pSrc);</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+  NS_ADDREF(pSrc);</span>
<a href="#l10.128"></a><span id="l10.128"> </span>
<a href="#l10.129"></a><span id="l10.129">   // First, get the index file for this mailbox</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-  rv = FindTOCFile( pSrc, getter_AddRefs( tocFile), &amp;deleteToc);</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-  if (NS_SUCCEEDED( rv) &amp;&amp; tocFile)</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-        {</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineminus">-    IMPORT_LOG0( &quot;Reading euroda toc file: &quot;);</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-    DUMP_FILENAME( tocFile, true);</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+  rv = FindTOCFile(pSrc, getter_AddRefs(tocFile), &amp;deleteToc);</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; tocFile)</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+  {</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+    IMPORT_LOG0(&quot;Reading euroda toc file: &quot;);</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+    DUMP_FILENAME(tocFile, true);</span>
<a href="#l10.140"></a><span id="l10.140"> </span>
<a href="#l10.141"></a><span id="l10.141" class="difflineminus">-                rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mailOutputStream), pDst);</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineminus">-                NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+    rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mailOutputStream), pDst);</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.145"></a><span id="l10.145">     // Read the toc and import the messages</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-    rv = ImportMailboxUsingTOC( pBytes, pAbort, srcInputStream, tocFile, mailOutputStream, pMsgCount);</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+    rv = ImportMailboxUsingTOC(pBytes, pAbort, srcInputStream, tocFile, mailOutputStream, pMsgCount);</span>
<a href="#l10.148"></a><span id="l10.148"> </span>
<a href="#l10.149"></a><span id="l10.149">     // clean up</span>
<a href="#l10.150"></a><span id="l10.150">     if (deleteToc)</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineminus">-      DeleteFile( tocFile);</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+      DeleteFile(tocFile);</span>
<a href="#l10.153"></a><span id="l10.153"> </span>
<a href="#l10.154"></a><span id="l10.154">     // If we were able to import with the TOC, then we don't need to bother</span>
<a href="#l10.155"></a><span id="l10.155">     // importing without the TOC.</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineminus">-    if ( NS_SUCCEEDED(rv) ) {</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.158"></a><span id="l10.158">       importWithoutToc = false;</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-      IMPORT_LOG0( &quot;Imported mailbox: &quot;); DUMP_FILENAME( pSrc, false);</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineminus">-      IMPORT_LOG0( &quot;  Using TOC: &quot;); DUMP_FILENAME(tocFile, true);</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+      IMPORT_LOG0(&quot;Imported mailbox: &quot;); DUMP_FILENAME(pSrc, false);</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+      IMPORT_LOG0(&quot;  Using TOC: &quot;); DUMP_FILENAME(tocFile, true);</span>
<a href="#l10.163"></a><span id="l10.163">     }</span>
<a href="#l10.164"></a><span id="l10.164">     else {</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineminus">-      IMPORT_LOG0( &quot;*** Error importing with TOC - will import without TOC.\n&quot;);</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+      IMPORT_LOG0(&quot;*** Error importing with TOC - will import without TOC.\n&quot;);</span>
<a href="#l10.167"></a><span id="l10.167">     }</span>
<a href="#l10.168"></a><span id="l10.168">   }</span>
<a href="#l10.169"></a><span id="l10.169"> </span>
<a href="#l10.170"></a><span id="l10.170">   // pSrc must be Released before returning</span>
<a href="#l10.171"></a><span id="l10.171"> </span>
<a href="#l10.172"></a><span id="l10.172">   if (importWithoutToc) {</span>
<a href="#l10.173"></a><span id="l10.173">     // The source file contains partially constructed mail messages,</span>
<a href="#l10.174"></a><span id="l10.174">     // and attachments.  We should first investigate if we can use the mailnews msgCompose</span>
<a href="#l10.175"></a><span id="l10.175">     // stuff to do the work for us.  If not we have to scan the mailboxes and do TONS</span>
<a href="#l10.176"></a><span id="l10.176">     // of work to properly reconstruct the message - Eudora is so nice that it strips things</span>
<a href="#l10.177"></a><span id="l10.177">     // like MIME headers, character encoding, and attachments - beautiful!</span>
<a href="#l10.178"></a><span id="l10.178"> </span>
<a href="#l10.179"></a><span id="l10.179" class="difflineminus">-    rv = pSrc-&gt;GetFileSize( &amp;m_mailSize);</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+    rv = pSrc-&gt;GetFileSize(&amp;m_mailSize);</span>
<a href="#l10.181"></a><span id="l10.181"> </span>
<a href="#l10.182"></a><span id="l10.182">     SimpleBufferTonyRCopiedOnce    readBuffer;</span>
<a href="#l10.183"></a><span id="l10.183">     SimpleBufferTonyRCopiedOnce    headers;</span>
<a href="#l10.184"></a><span id="l10.184">     SimpleBufferTonyRCopiedOnce    body;</span>
<a href="#l10.185"></a><span id="l10.185">     SimpleBufferTonyRCopiedOnce    copy;</span>
<a href="#l10.186"></a><span id="l10.186"> </span>
<a href="#l10.187"></a><span id="l10.187">     headers.m_convertCRs = true;</span>
<a href="#l10.188"></a><span id="l10.188">     body.m_convertCRs = true;</span>
<a href="#l10.189"></a><span id="l10.189"> </span>
<a href="#l10.190"></a><span id="l10.190" class="difflineminus">-    copy.Allocate( kCopyBufferSize);</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineminus">-    readBuffer.Allocate( kMailReadBufferSize);</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineplus">+    copy.Allocate(kCopyBufferSize);</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineplus">+    readBuffer.Allocate(kMailReadBufferSize);</span>
<a href="#l10.194"></a><span id="l10.194">     ReadFileState      state;</span>
<a href="#l10.195"></a><span id="l10.195">     state.offset = 0;</span>
<a href="#l10.196"></a><span id="l10.196">     state.size = m_mailSize;</span>
<a href="#l10.197"></a><span id="l10.197">     state.pFile = pSrc;</span>
<a href="#l10.198"></a><span id="l10.198"> </span>
<a href="#l10.199"></a><span id="l10.199" class="difflineminus">-    IMPORT_LOG0( &quot;Reading mailbox\n&quot;);</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineplus">+    IMPORT_LOG0(&quot;Reading mailbox\n&quot;);</span>
<a href="#l10.201"></a><span id="l10.201"> </span>
<a href="#l10.202"></a><span id="l10.202" class="difflineminus">-    if (NS_SUCCEEDED( rv ))</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l10.204"></a><span id="l10.204">                 {</span>
<a href="#l10.205"></a><span id="l10.205">       nsCString defaultDate;</span>
<a href="#l10.206"></a><span id="l10.206">       nsCAutoString bodyType;</span>
<a href="#l10.207"></a><span id="l10.207"> </span>
<a href="#l10.208"></a><span id="l10.208" class="difflineminus">-      IMPORT_LOG0( &quot;Reading first message\n&quot;);</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineplus">+      IMPORT_LOG0(&quot;Reading first message\n&quot;);</span>
<a href="#l10.210"></a><span id="l10.210"> </span>
<a href="#l10.211"></a><span id="l10.211" class="difflineminus">-      while (!*pAbort &amp;&amp; NS_SUCCEEDED( rv = ReadNextMessage( &amp;state, readBuffer, headers, body, defaultDate, bodyType, NULL))) {</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineplus">+      while (!*pAbort &amp;&amp; NS_SUCCEEDED(rv = ReadNextMessage(&amp;state, readBuffer, headers, body, defaultDate, bodyType, NULL))) {</span>
<a href="#l10.213"></a><span id="l10.213"> </span>
<a href="#l10.214"></a><span id="l10.214">         if (pBytes) {</span>
<a href="#l10.215"></a><span id="l10.215">           *pBytes += body.m_writeOffset - 1 + headers.m_writeOffset - 1;</span>
<a href="#l10.216"></a><span id="l10.216">         }</span>
<a href="#l10.217"></a><span id="l10.217"> </span>
<a href="#l10.218"></a><span id="l10.218">         rv = ImportMessage(headers, body, defaultDate, bodyType, mailOutputStream, pMsgCount);</span>
<a href="#l10.219"></a><span id="l10.219"> </span>
<a href="#l10.220"></a><span id="l10.220">         if (!readBuffer.m_bytesInBuf &amp;&amp; (state.offset &gt;= state.size))</span>
<a href="#l10.221"></a><span id="l10.221">           break;</span>
<a href="#l10.222"></a><span id="l10.222">       }</span>
<a href="#l10.223"></a><span id="l10.223"> </span>
<a href="#l10.224"></a><span id="l10.224">     }</span>
<a href="#l10.225"></a><span id="l10.225">     else {</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineminus">-      IMPORT_LOG0( &quot;*** Error creating file spec for composition\n&quot;);</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineplus">+      IMPORT_LOG0(&quot;*** Error creating file spec for composition\n&quot;);</span>
<a href="#l10.228"></a><span id="l10.228">     }</span>
<a href="#l10.229"></a><span id="l10.229">   }</span>
<a href="#l10.230"></a><span id="l10.230"> </span>
<a href="#l10.231"></a><span id="l10.231">   pSrc-&gt;Release();</span>
<a href="#l10.232"></a><span id="l10.232"> </span>
<a href="#l10.233"></a><span id="l10.233" class="difflineminus">-  return( rv);</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineplus">+  return rv;</span>
<a href="#l10.235"></a><span id="l10.235"> }</span>
<a href="#l10.236"></a><span id="l10.236"> </span>
<a href="#l10.237"></a><span id="l10.237"> #ifdef XP_MACOSX</span>
<a href="#l10.238"></a><span id="l10.238"> #define kMsgHeaderSize    220</span>
<a href="#l10.239"></a><span id="l10.239"> #define  kMsgFirstOffset    278</span>
<a href="#l10.240"></a><span id="l10.240"> #else</span>
<a href="#l10.241"></a><span id="l10.241"> #define  kMsgHeaderSize    218</span>
<a href="#l10.242"></a><span id="l10.242"> #define kMsgFirstOffset    104</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineat">@@ -358,45 +355,45 @@ nsresult nsEudoraMailbox::ImportMailboxU</span>
<a href="#l10.244"></a><span id="l10.244"> {</span>
<a href="#l10.245"></a><span id="l10.245">   nsresult        rv = NS_OK;</span>
<a href="#l10.246"></a><span id="l10.246"> </span>
<a href="#l10.247"></a><span id="l10.247">   PRInt64  mailSize = m_mailSize;</span>
<a href="#l10.248"></a><span id="l10.248">   PRInt64  tocSize = 0;</span>
<a href="#l10.249"></a><span id="l10.249">   PRUint32  saveBytes = pBytes ? *pBytes : 0;</span>
<a href="#l10.250"></a><span id="l10.250">   nsCOMPtr &lt;nsIInputStream&gt; tocInputStream;</span>
<a href="#l10.251"></a><span id="l10.251"> </span>
<a href="#l10.252"></a><span id="l10.252" class="difflineminus">-  rv = tocFile-&gt;GetFileSize( &amp;tocSize);</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineplus">+  rv = tocFile-&gt;GetFileSize(&amp;tocSize);</span>
<a href="#l10.254"></a><span id="l10.254"> </span>
<a href="#l10.255"></a><span id="l10.255">   // if the index or the mail file is empty then just</span>
<a href="#l10.256"></a><span id="l10.256">   // use the original mail file.</span>
<a href="#l10.257"></a><span id="l10.257">   if (!mailSize || !tocSize)</span>
<a href="#l10.258"></a><span id="l10.258">     return NS_ERROR_FAILURE;</span>
<a href="#l10.259"></a><span id="l10.259">   rv = NS_NewLocalFileInputStream(getter_AddRefs(tocInputStream), tocFile);</span>
<a href="#l10.260"></a><span id="l10.260">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.261"></a><span id="l10.261"> </span>
<a href="#l10.262"></a><span id="l10.262">   SimpleBufferTonyRCopiedOnce readBuffer;</span>
<a href="#l10.263"></a><span id="l10.263">   SimpleBufferTonyRCopiedOnce headers;</span>
<a href="#l10.264"></a><span id="l10.264">   SimpleBufferTonyRCopiedOnce body;</span>
<a href="#l10.265"></a><span id="l10.265">   SimpleBufferTonyRCopiedOnce copy;</span>
<a href="#l10.266"></a><span id="l10.266">   PRInt32 tocOffset = kMsgFirstOffset;</span>
<a href="#l10.267"></a><span id="l10.267">   EudoraTOCEntry tocEntry;</span>
<a href="#l10.268"></a><span id="l10.268"> </span>
<a href="#l10.269"></a><span id="l10.269" class="difflineminus">-  copy.Allocate( kCopyBufferSize);</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineplus">+  copy.Allocate(kCopyBufferSize);</span>
<a href="#l10.271"></a><span id="l10.271">   readBuffer.Allocate(kMailReadBufferSize);</span>
<a href="#l10.272"></a><span id="l10.272"> </span>
<a href="#l10.273"></a><span id="l10.273" class="difflineminus">-  IMPORT_LOG0( &quot;Importing mailbox using TOC: &quot;);</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineminus">-  DUMP_FILENAME( tocFile, true);</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineplus">+  IMPORT_LOG0(&quot;Importing mailbox using TOC: &quot;);</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+  DUMP_FILENAME(tocFile, true);</span>
<a href="#l10.277"></a><span id="l10.277"> </span>
<a href="#l10.278"></a><span id="l10.278">   nsCOMPtr &lt;nsISeekableStream&gt; tocSeekableStream = do_QueryInterface(tocInputStream);</span>
<a href="#l10.279"></a><span id="l10.279">   nsCOMPtr &lt;nsISeekableStream&gt; mailboxSeekableStream = do_QueryInterface(pInputStream);</span>
<a href="#l10.280"></a><span id="l10.280">   while (!*pAbort &amp;&amp; (tocOffset &lt; (PRInt32)tocSize)) {</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineminus">-    if ( NS_FAILED(rv = tocSeekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, tocOffset)) )</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+    if (NS_FAILED(rv = tocSeekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, tocOffset)))</span>
<a href="#l10.283"></a><span id="l10.283">       break;</span>
<a href="#l10.284"></a><span id="l10.284"> </span>
<a href="#l10.285"></a><span id="l10.285" class="difflineminus">-    if ( NS_FAILED(rv = ReadTOCEntry(tocInputStream, tocEntry)) )</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineplus">+    if (NS_FAILED(rv = ReadTOCEntry(tocInputStream, tocEntry)))</span>
<a href="#l10.287"></a><span id="l10.287">       break;</span>
<a href="#l10.288"></a><span id="l10.288"> </span>
<a href="#l10.289"></a><span id="l10.289">     // Quick and dirty way to read in and parse the message the way the rest</span>
<a href="#l10.290"></a><span id="l10.290">     // of the code expects.</span>
<a href="#l10.291"></a><span id="l10.291">     nsCString              defaultDate;</span>
<a href="#l10.292"></a><span id="l10.292">     nsCAutoString            bodyType;</span>
<a href="#l10.293"></a><span id="l10.293">     ReadFileState            state;</span>
<a href="#l10.294"></a><span id="l10.294"> </span>
<a href="#l10.295"></a><span id="l10.295" class="difflineat">@@ -407,39 +404,39 @@ nsresult nsEudoraMailbox::ImportMailboxU</span>
<a href="#l10.296"></a><span id="l10.296">     // state.size is meant to be the size of the entire file, because it's</span>
<a href="#l10.297"></a><span id="l10.297">     // assumed that ReadNextMessage will actually have to parse. We know</span>
<a href="#l10.298"></a><span id="l10.298">     // exactly how big the message is, so we simply set the &quot;size&quot; to be</span>
<a href="#l10.299"></a><span id="l10.299">     // immediately where the message ends.</span>
<a href="#l10.300"></a><span id="l10.300">     state.offset = tocEntry.m_Offset;</span>
<a href="#l10.301"></a><span id="l10.301">     state.pInputStream = pInputStream;</span>
<a href="#l10.302"></a><span id="l10.302">     state.size = state.offset + tocEntry.m_Length;</span>
<a href="#l10.303"></a><span id="l10.303"> </span>
<a href="#l10.304"></a><span id="l10.304" class="difflineminus">-    if ( NS_SUCCEEDED(rv = ReadNextMessage(&amp;state, readBuffer, headers, body, defaultDate, bodyType, &amp;tocEntry) ) )</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineplus">+    if (NS_SUCCEEDED(rv = ReadNextMessage(&amp;state, readBuffer, headers, body, defaultDate, bodyType, &amp;tocEntry)))</span>
<a href="#l10.306"></a><span id="l10.306">     {</span>
<a href="#l10.307"></a><span id="l10.307">       rv = ImportMessage(headers, body, defaultDate, bodyType, pDst, pMsgCount);</span>
<a href="#l10.308"></a><span id="l10.308"> </span>
<a href="#l10.309"></a><span id="l10.309">       if (pBytes)</span>
<a href="#l10.310"></a><span id="l10.310">         *pBytes += tocEntry.m_Length;</span>
<a href="#l10.311"></a><span id="l10.311">     }</span>
<a href="#l10.312"></a><span id="l10.312"> </span>
<a href="#l10.313"></a><span id="l10.313">     // We currently don't consider an error from ReadNextMessage or ImportMessage to be fatal.</span>
<a href="#l10.314"></a><span id="l10.314">     // Reset the error back to no error in case this is the last time through the loop.</span>
<a href="#l10.315"></a><span id="l10.315">     rv = NS_OK;</span>
<a href="#l10.316"></a><span id="l10.316"> </span>
<a href="#l10.317"></a><span id="l10.317">     tocOffset += kMsgHeaderSize;</span>
<a href="#l10.318"></a><span id="l10.318">   }</span>
<a href="#l10.319"></a><span id="l10.319"> </span>
<a href="#l10.320"></a><span id="l10.320" class="difflineminus">-  if ( NS_SUCCEEDED(rv) ) {</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineminus">-    IMPORT_LOG0( &quot; finished\n&quot;);</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineplus">+    IMPORT_LOG0(&quot; finished\n&quot;);</span>
<a href="#l10.324"></a><span id="l10.324">   }</span>
<a href="#l10.325"></a><span id="l10.325">   else {</span>
<a href="#l10.326"></a><span id="l10.326">     // We failed somewhere important enough that we kept the error.</span>
<a href="#l10.327"></a><span id="l10.327">     // Bail on all that we imported since we'll be importing everything</span>
<a href="#l10.328"></a><span id="l10.328">     // again using just the mailbox.</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error importing mailbox using TOC: &quot;);</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error importing mailbox using TOC: &quot;);</span>
<a href="#l10.331"></a><span id="l10.331"> //    DUMP_FILENAME(pMail, true);</span>
<a href="#l10.332"></a><span id="l10.332"> </span>
<a href="#l10.333"></a><span id="l10.333">     // Reset pBytes back to where it was before we imported this mailbox.</span>
<a href="#l10.334"></a><span id="l10.334">     // This will likely result in a funky progress bar which will move</span>
<a href="#l10.335"></a><span id="l10.335">     // backwards, but that's probably the best we can do to keep the</span>
<a href="#l10.336"></a><span id="l10.336">     // progress accurate since we'll be re-importing the same mailbox.</span>
<a href="#l10.337"></a><span id="l10.337">     if (pBytes)</span>
<a href="#l10.338"></a><span id="l10.338">       *pBytes = saveBytes;</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineat">@@ -450,17 +447,17 @@ nsresult nsEudoraMailbox::ImportMailboxU</span>
<a href="#l10.340"></a><span id="l10.340">   }</span>
<a href="#l10.341"></a><span id="l10.341"> </span>
<a href="#l10.342"></a><span id="l10.342">   return rv;</span>
<a href="#l10.343"></a><span id="l10.343"> }</span>
<a href="#l10.344"></a><span id="l10.344"> </span>
<a href="#l10.345"></a><span id="l10.345"> nsresult nsEudoraMailbox::ReadTOCEntry(nsIInputStream *pToc, EudoraTOCEntry&amp; tocEntry)</span>
<a href="#l10.346"></a><span id="l10.346"> {</span>
<a href="#l10.347"></a><span id="l10.347"> #define READ_TOC_FIELD(entry) pBuffer = (char *)&amp;entry;\</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineminus">-  if ( NS_FAILED(pToc-&gt;Read(pBuffer, sizeof(entry), &amp;bytesRead)) || (bytesRead != sizeof(entry)) )\</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineplus">+  if (NS_FAILED(pToc-&gt;Read(pBuffer, sizeof(entry), &amp;bytesRead)) || (bytesRead != sizeof(entry)))\</span>
<a href="#l10.350"></a><span id="l10.350">     return NS_ERROR_FAILURE</span>
<a href="#l10.351"></a><span id="l10.351"> </span>
<a href="#l10.352"></a><span id="l10.352">   PRUint32 bytesRead = 0;</span>
<a href="#l10.353"></a><span id="l10.353">   char * pBuffer;</span>
<a href="#l10.354"></a><span id="l10.354"> </span>
<a href="#l10.355"></a><span id="l10.355">   // Here we'll read any initial data that's in the same format on both Mac and Windows</span>
<a href="#l10.356"></a><span id="l10.356">   READ_TOC_FIELD(tocEntry.m_Offset);</span>
<a href="#l10.357"></a><span id="l10.357">   READ_TOC_FIELD(tocEntry.m_Length);</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineat">@@ -538,359 +535,355 @@ nsresult nsEudoraMailbox::ImportMessage(</span>
<a href="#l10.359"></a><span id="l10.359"> {</span>
<a href="#l10.360"></a><span id="l10.360">   nsresult rv = NS_OK;</span>
<a href="#l10.361"></a><span id="l10.361">   PRUint32 written = 0;</span>
<a href="#l10.362"></a><span id="l10.362">   nsEudoraCompose compose;</span>
<a href="#l10.363"></a><span id="l10.363"> </span>
<a href="#l10.364"></a><span id="l10.364">   // Unfortunately Eudora stores HTML messages in the sent folder</span>
<a href="#l10.365"></a><span id="l10.365">   // without any content type header at all. If the first line of the message body is &lt;html&gt;</span>
<a href="#l10.366"></a><span id="l10.366">   // then mark the message as html internally...See Bug #258489</span>
<a href="#l10.367"></a><span id="l10.367" class="difflineminus">-  if (body.m_pBuffer &amp;&amp; (body.m_writeOffset &gt; (PRInt32)strlen(kHTMLTag)) &amp;&amp; (strncmp(body.m_pBuffer, kHTMLTag, strlen(kHTMLTag)) == 0 ))</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineplus">+  if (body.m_pBuffer &amp;&amp; (body.m_writeOffset &gt; (PRInt32)strlen(kHTMLTag)) &amp;&amp; (strncmp(body.m_pBuffer, kHTMLTag, strlen(kHTMLTag)) == 0))</span>
<a href="#l10.369"></a><span id="l10.369">     bodyType = &quot;text/html&quot;; // ignore whatever body type we were given...force html</span>
<a href="#l10.370"></a><span id="l10.370"> </span>
<a href="#l10.371"></a><span id="l10.371" class="difflineminus">-  compose.SetBody( body.m_pBuffer, body.m_writeOffset - 1, bodyType);</span>
<a href="#l10.372"></a><span id="l10.372" class="difflineminus">-  compose.SetHeaders( headers.m_pBuffer, headers.m_writeOffset - 1);</span>
<a href="#l10.373"></a><span id="l10.373" class="difflineminus">-  compose.SetAttachments( &amp;m_attachments);</span>
<a href="#l10.374"></a><span id="l10.374" class="difflineplus">+  compose.SetBody(body.m_pBuffer, body.m_writeOffset - 1, bodyType);</span>
<a href="#l10.375"></a><span id="l10.375" class="difflineplus">+  compose.SetHeaders(headers.m_pBuffer, headers.m_writeOffset - 1);</span>
<a href="#l10.376"></a><span id="l10.376" class="difflineplus">+  compose.SetAttachments(&amp;m_attachments);</span>
<a href="#l10.377"></a><span id="l10.377">   compose.SetDefaultDate(defaultDate);</span>
<a href="#l10.378"></a><span id="l10.378"> </span>
<a href="#l10.379"></a><span id="l10.379">         nsCOMPtr &lt;nsIFile&gt; compositionFile;</span>
<a href="#l10.380"></a><span id="l10.380">   rv = compose.SendTheMessage(m_mailImportLocation, getter_AddRefs(compositionFile));</span>
<a href="#l10.381"></a><span id="l10.381" class="difflineminus">-  if (NS_SUCCEEDED( rv)) {</span>
<a href="#l10.382"></a><span id="l10.382" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l10.383"></a><span id="l10.383">     nsCString            fromLine(eudoraFromLine);</span>
<a href="#l10.384"></a><span id="l10.384">     SimpleBufferTonyRCopiedOnce    copy;</span>
<a href="#l10.385"></a><span id="l10.385"> </span>
<a href="#l10.386"></a><span id="l10.386" class="difflineminus">-    copy.Allocate( kCopyBufferSize);</span>
<a href="#l10.387"></a><span id="l10.387" class="difflineplus">+    copy.Allocate(kCopyBufferSize);</span>
<a href="#l10.388"></a><span id="l10.388"> </span>
<a href="#l10.389"></a><span id="l10.389" class="difflineminus">-    /* IMPORT_LOG0( &quot;Composed message in file: &quot;); DUMP_FILENAME( compositionFile, true); */</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineplus">+    /* IMPORT_LOG0(&quot;Composed message in file: &quot;); DUMP_FILENAME(compositionFile, true); */</span>
<a href="#l10.391"></a><span id="l10.391">     // copy the resulting file into the destination file!</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineminus">-    rv = compose.CopyComposedMessage( fromLine, compositionFile, pDst, copy);</span>
<a href="#l10.393"></a><span id="l10.393" class="difflineplus">+    rv = compose.CopyComposedMessage(fromLine, compositionFile, pDst, copy);</span>
<a href="#l10.394"></a><span id="l10.394">     DeleteFile(compositionFile);</span>
<a href="#l10.395"></a><span id="l10.395" class="difflineminus">-    if (NS_FAILED( rv)) {</span>
<a href="#l10.396"></a><span id="l10.396" class="difflineminus">-      IMPORT_LOG0( &quot;*** Error copying composed message to destination mailbox\n&quot;);</span>
<a href="#l10.397"></a><span id="l10.397" class="difflineminus">-    }</span>
<a href="#l10.398"></a><span id="l10.398" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineplus">+      IMPORT_LOG0(&quot;*** Error copying composed message to destination mailbox\n&quot;);</span>
<a href="#l10.400"></a><span id="l10.400">     if (pMsgCount)</span>
<a href="#l10.401"></a><span id="l10.401">       (*pMsgCount)++;</span>
<a href="#l10.402"></a><span id="l10.402">   }</span>
<a href="#l10.403"></a><span id="l10.403">   else {</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error composing message, writing raw message\n&quot;);</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineminus">-    rv = WriteFromSep( pDst);</span>
<a href="#l10.406"></a><span id="l10.406" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error composing message, writing raw message\n&quot;);</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineplus">+    rv = WriteFromSep(pDst);</span>
<a href="#l10.408"></a><span id="l10.408"> </span>
<a href="#l10.409"></a><span id="l10.409" class="difflineminus">-    rv = pDst-&gt;Write( kComposeErrorStr,</span>
<a href="#l10.410"></a><span id="l10.410" class="difflineminus">-      strlen( kComposeErrorStr),</span>
<a href="#l10.411"></a><span id="l10.411" class="difflineminus">-      &amp;written );</span>
<a href="#l10.412"></a><span id="l10.412" class="difflineplus">+    rv = pDst-&gt;Write(kComposeErrorStr, strlen(kComposeErrorStr), &amp;written);</span>
<a href="#l10.413"></a><span id="l10.413"> </span>
<a href="#l10.414"></a><span id="l10.414" class="difflineminus">-    if (NS_SUCCEEDED( rv))</span>
<a href="#l10.415"></a><span id="l10.415" class="difflineminus">-      rv = pDst-&gt;Write( headers.m_pBuffer, headers.m_writeOffset - 1, &amp;written);</span>
<a href="#l10.416"></a><span id="l10.416" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; (written == (headers.m_writeOffset - 1)))</span>
<a href="#l10.417"></a><span id="l10.417" class="difflineminus">-      rv = pDst-&gt;Write( &quot;\x0D\x0A&quot; &quot;\x0D\x0A&quot;, 4, &amp;written);</span>
<a href="#l10.418"></a><span id="l10.418" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; (written == 4))</span>
<a href="#l10.419"></a><span id="l10.419" class="difflineminus">-      rv = pDst-&gt;Write( body.m_pBuffer, body.m_writeOffset - 1, &amp;written);</span>
<a href="#l10.420"></a><span id="l10.420" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; (written == (body.m_writeOffset - 1))) {</span>
<a href="#l10.421"></a><span id="l10.421" class="difflineminus">-      rv = pDst-&gt;Write( &quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l10.422"></a><span id="l10.422" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l10.423"></a><span id="l10.423" class="difflineplus">+      rv = pDst-&gt;Write(headers.m_pBuffer, headers.m_writeOffset - 1, &amp;written);</span>
<a href="#l10.424"></a><span id="l10.424" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; (written == (headers.m_writeOffset - 1)))</span>
<a href="#l10.425"></a><span id="l10.425" class="difflineplus">+      rv = pDst-&gt;Write(&quot;\x0D\x0A&quot; &quot;\x0D\x0A&quot;, 4, &amp;written);</span>
<a href="#l10.426"></a><span id="l10.426" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; (written == 4))</span>
<a href="#l10.427"></a><span id="l10.427" class="difflineplus">+      rv = pDst-&gt;Write(body.m_pBuffer, body.m_writeOffset - 1, &amp;written);</span>
<a href="#l10.428"></a><span id="l10.428" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; (written == (body.m_writeOffset - 1))) {</span>
<a href="#l10.429"></a><span id="l10.429" class="difflineplus">+      rv = pDst-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l10.430"></a><span id="l10.430">       if (written != 2)</span>
<a href="#l10.431"></a><span id="l10.431">         rv = NS_ERROR_FAILURE;</span>
<a href="#l10.432"></a><span id="l10.432">     }</span>
<a href="#l10.433"></a><span id="l10.433"> </span>
<a href="#l10.434"></a><span id="l10.434" class="difflineminus">-    if (NS_FAILED( rv)) {</span>
<a href="#l10.435"></a><span id="l10.435" class="difflineminus">-      IMPORT_LOG0( &quot;*** Error writing to destination mailbox\n&quot;);</span>
<a href="#l10.436"></a><span id="l10.436" class="difflineminus">-    }</span>
<a href="#l10.437"></a><span id="l10.437" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l10.438"></a><span id="l10.438" class="difflineplus">+      IMPORT_LOG0(&quot;*** Error writing to destination mailbox\n&quot;);</span>
<a href="#l10.439"></a><span id="l10.439">   }</span>
<a href="#l10.440"></a><span id="l10.440"> </span>
<a href="#l10.441"></a><span id="l10.441">   return rv;</span>
<a href="#l10.442"></a><span id="l10.442"> }</span>
<a href="#l10.443"></a><span id="l10.443"> </span>
<a href="#l10.444"></a><span id="l10.444" class="difflineminus">-nsresult nsEudoraMailbox::ReadNextMessage( ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; copy,</span>
<a href="#l10.445"></a><span id="l10.445" class="difflineplus">+nsresult nsEudoraMailbox::ReadNextMessage(ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; copy,</span>
<a href="#l10.446"></a><span id="l10.446">                                           SimpleBufferTonyRCopiedOnce&amp; header, SimpleBufferTonyRCopiedOnce&amp; body,</span>
<a href="#l10.447"></a><span id="l10.447">                                           nsCString&amp; defaultDate, nsCString&amp; bodyType, EudoraTOCEntry *pTocEntry)</span>
<a href="#l10.448"></a><span id="l10.448"> {</span>
<a href="#l10.449"></a><span id="l10.449">   header.m_writeOffset = 0;</span>
<a href="#l10.450"></a><span id="l10.450">   body.m_writeOffset = 0;</span>
<a href="#l10.451"></a><span id="l10.451"> </span>
<a href="#l10.452"></a><span id="l10.452">   nsresult    rv;</span>
<a href="#l10.453"></a><span id="l10.453">   PRInt32      lineLen;</span>
<a href="#l10.454"></a><span id="l10.454">   char      endBuffer = 0;</span>
<a href="#l10.455"></a><span id="l10.455"> </span>
<a href="#l10.456"></a><span id="l10.456">   lineLen = -1;</span>
<a href="#l10.457"></a><span id="l10.457">   // Find the from separator - we should actually be positioned at the</span>
<a href="#l10.458"></a><span id="l10.458">   // from separator, but for now, we'll verify this.</span>
<a href="#l10.459"></a><span id="l10.459">   while (lineLen == -1) {</span>
<a href="#l10.460"></a><span id="l10.460" class="difflineminus">-    if (NS_FAILED( rv = FillMailBuffer( pState, copy))) {</span>
<a href="#l10.461"></a><span id="l10.461" class="difflineminus">-      IMPORT_LOG0( &quot;*** Error, FillMailBuffer FAILED in ReadNextMessage\n&quot;);</span>
<a href="#l10.462"></a><span id="l10.462" class="difflineminus">-      return( rv);</span>
<a href="#l10.463"></a><span id="l10.463" class="difflineplus">+    if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l10.464"></a><span id="l10.464" class="difflineplus">+      IMPORT_LOG0(&quot;*** Error, FillMailBuffer FAILED in ReadNextMessage\n&quot;);</span>
<a href="#l10.465"></a><span id="l10.465" class="difflineplus">+      return rv;</span>
<a href="#l10.466"></a><span id="l10.466">     }</span>
<a href="#l10.467"></a><span id="l10.467" class="difflineminus">-    lineLen = IsEudoraFromSeparator( copy.m_pBuffer + copy.m_writeOffset, copy.m_bytesInBuf - copy.m_writeOffset, defaultDate);</span>
<a href="#l10.468"></a><span id="l10.468" class="difflineplus">+    lineLen = IsEudoraFromSeparator(copy.m_pBuffer + copy.m_writeOffset, copy.m_bytesInBuf - copy.m_writeOffset, defaultDate);</span>
<a href="#l10.469"></a><span id="l10.469"> </span>
<a href="#l10.470"></a><span id="l10.470">     if (lineLen == -1) {</span>
<a href="#l10.471"></a><span id="l10.471" class="difflineminus">-      while ((lineLen = FindStartLine( copy)) == -1) {</span>
<a href="#l10.472"></a><span id="l10.472" class="difflineplus">+      while ((lineLen = FindStartLine(copy)) == -1) {</span>
<a href="#l10.473"></a><span id="l10.473">         copy.m_writeOffset = copy.m_bytesInBuf;</span>
<a href="#l10.474"></a><span id="l10.474" class="difflineminus">-        if (NS_FAILED( rv = FillMailBuffer( pState, copy))) {</span>
<a href="#l10.475"></a><span id="l10.475" class="difflineminus">-          IMPORT_LOG0( &quot;*** Error, FillMailBuffer FAILED in ReadNextMessage, looking for next start line\n&quot;);</span>
<a href="#l10.476"></a><span id="l10.476" class="difflineminus">-          return( rv);</span>
<a href="#l10.477"></a><span id="l10.477" class="difflineplus">+        if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l10.478"></a><span id="l10.478" class="difflineplus">+          IMPORT_LOG0(&quot;*** Error, FillMailBuffer FAILED in ReadNextMessage, looking for next start line\n&quot;);</span>
<a href="#l10.479"></a><span id="l10.479" class="difflineplus">+          return rv;</span>
<a href="#l10.480"></a><span id="l10.480">         }</span>
<a href="#l10.481"></a><span id="l10.481">         if (!copy.m_bytesInBuf) {</span>
<a href="#l10.482"></a><span id="l10.482" class="difflineminus">-          IMPORT_LOG0( &quot;*** Error, ReadNextMessage, looking for start of next line, got end of file.\n&quot;);</span>
<a href="#l10.483"></a><span id="l10.483" class="difflineminus">-          return( NS_ERROR_FAILURE);</span>
<a href="#l10.484"></a><span id="l10.484" class="difflineplus">+          IMPORT_LOG0(&quot;*** Error, ReadNextMessage, looking for start of next line, got end of file.\n&quot;);</span>
<a href="#l10.485"></a><span id="l10.485" class="difflineplus">+          return NS_ERROR_FAILURE;</span>
<a href="#l10.486"></a><span id="l10.486">         }</span>
<a href="#l10.487"></a><span id="l10.487">       }</span>
<a href="#l10.488"></a><span id="l10.488">       copy.m_writeOffset += lineLen;</span>
<a href="#l10.489"></a><span id="l10.489">       lineLen = -1;</span>
<a href="#l10.490"></a><span id="l10.490">     }</span>
<a href="#l10.491"></a><span id="l10.491">   }</span>
<a href="#l10.492"></a><span id="l10.492"> </span>
<a href="#l10.493"></a><span id="l10.493">   // Skip past the from line separator</span>
<a href="#l10.494"></a><span id="l10.494" class="difflineminus">-  while ((lineLen = FindStartLine( copy)) == -1) {</span>
<a href="#l10.495"></a><span id="l10.495" class="difflineplus">+  while ((lineLen = FindStartLine(copy)) == -1) {</span>
<a href="#l10.496"></a><span id="l10.496">     copy.m_writeOffset = copy.m_bytesInBuf;</span>
<a href="#l10.497"></a><span id="l10.497" class="difflineminus">-    if (NS_FAILED( rv = FillMailBuffer( pState, copy))) {</span>
<a href="#l10.498"></a><span id="l10.498" class="difflineminus">-      IMPORT_LOG0( &quot;*** Error, ReadNextMessage, FillMailBuffer failed looking for from sep\n&quot;);</span>
<a href="#l10.499"></a><span id="l10.499" class="difflineminus">-      return( rv);</span>
<a href="#l10.500"></a><span id="l10.500" class="difflineplus">+    if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l10.501"></a><span id="l10.501" class="difflineplus">+      IMPORT_LOG0(&quot;*** Error, ReadNextMessage, FillMailBuffer failed looking for from sep\n&quot;);</span>
<a href="#l10.502"></a><span id="l10.502" class="difflineplus">+      return rv;</span>
<a href="#l10.503"></a><span id="l10.503">     }</span>
<a href="#l10.504"></a><span id="l10.504">     if (!copy.m_bytesInBuf) {</span>
<a href="#l10.505"></a><span id="l10.505" class="difflineminus">-      IMPORT_LOG0( &quot;*** Error, ReadNextMessage, end of file looking for from sep\n&quot;);</span>
<a href="#l10.506"></a><span id="l10.506" class="difflineminus">-      return( NS_ERROR_FAILURE);</span>
<a href="#l10.507"></a><span id="l10.507" class="difflineplus">+      IMPORT_LOG0(&quot;*** Error, ReadNextMessage, end of file looking for from sep\n&quot;);</span>
<a href="#l10.508"></a><span id="l10.508" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l10.509"></a><span id="l10.509">     }</span>
<a href="#l10.510"></a><span id="l10.510">   }</span>
<a href="#l10.511"></a><span id="l10.511">   copy.m_writeOffset += lineLen;</span>
<a href="#l10.512"></a><span id="l10.512" class="difflineminus">-  if (NS_FAILED( rv = FillMailBuffer( pState, copy))) {</span>
<a href="#l10.513"></a><span id="l10.513" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error, Unable to fill mail buffer after from sep.\n&quot;);</span>
<a href="#l10.514"></a><span id="l10.514" class="difflineminus">-    return( rv);</span>
<a href="#l10.515"></a><span id="l10.515" class="difflineplus">+  if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l10.516"></a><span id="l10.516" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error, Unable to fill mail buffer after from sep.\n&quot;);</span>
<a href="#l10.517"></a><span id="l10.517" class="difflineplus">+    return rv;</span>
<a href="#l10.518"></a><span id="l10.518">   }</span>
<a href="#l10.519"></a><span id="l10.519"> </span>
<a href="#l10.520"></a><span id="l10.520">   // This should be the headers...</span>
<a href="#l10.521"></a><span id="l10.521">   PRInt32 endLen = -1;</span>
<a href="#l10.522"></a><span id="l10.522" class="difflineminus">-  while ((endLen = IsEndHeaders( copy)) == -1) {</span>
<a href="#l10.523"></a><span id="l10.523" class="difflineminus">-    while ((lineLen = FindNextEndLine( copy)) == -1) {</span>
<a href="#l10.524"></a><span id="l10.524" class="difflineplus">+  while ((endLen = IsEndHeaders(copy)) == -1) {</span>
<a href="#l10.525"></a><span id="l10.525" class="difflineplus">+    while ((lineLen = FindNextEndLine(copy)) == -1) {</span>
<a href="#l10.526"></a><span id="l10.526">       copy.m_writeOffset = copy.m_bytesInBuf;</span>
<a href="#l10.527"></a><span id="l10.527" class="difflineminus">-      if (!header.Write( copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l10.528"></a><span id="l10.528" class="difflineminus">-        IMPORT_LOG0( &quot;*** ERROR, writing headers\n&quot;);</span>
<a href="#l10.529"></a><span id="l10.529" class="difflineminus">-        return( NS_ERROR_FAILURE);</span>
<a href="#l10.530"></a><span id="l10.530" class="difflineplus">+      if (!header.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l10.531"></a><span id="l10.531" class="difflineplus">+        IMPORT_LOG0(&quot;*** ERROR, writing headers\n&quot;);</span>
<a href="#l10.532"></a><span id="l10.532" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l10.533"></a><span id="l10.533">       }</span>
<a href="#l10.534"></a><span id="l10.534" class="difflineminus">-      if (NS_FAILED( rv = FillMailBuffer( pState, copy))) {</span>
<a href="#l10.535"></a><span id="l10.535" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error reading message headers\n&quot;);</span>
<a href="#l10.536"></a><span id="l10.536" class="difflineminus">-        return( rv);</span>
<a href="#l10.537"></a><span id="l10.537" class="difflineplus">+      if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l10.538"></a><span id="l10.538" class="difflineplus">+        IMPORT_LOG0(&quot;*** Error reading message headers\n&quot;);</span>
<a href="#l10.539"></a><span id="l10.539" class="difflineplus">+        return rv;</span>
<a href="#l10.540"></a><span id="l10.540">       }</span>
<a href="#l10.541"></a><span id="l10.541">       if (!copy.m_bytesInBuf) {</span>
<a href="#l10.542"></a><span id="l10.542" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error, end of file while reading headers\n&quot;);</span>
<a href="#l10.543"></a><span id="l10.543" class="difflineminus">-        return( NS_ERROR_FAILURE);</span>
<a href="#l10.544"></a><span id="l10.544" class="difflineplus">+        IMPORT_LOG0(&quot;*** Error, end of file while reading headers\n&quot;);</span>
<a href="#l10.545"></a><span id="l10.545" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l10.546"></a><span id="l10.546">       }</span>
<a href="#l10.547"></a><span id="l10.547">     }</span>
<a href="#l10.548"></a><span id="l10.548">     copy.m_writeOffset += lineLen;</span>
<a href="#l10.549"></a><span id="l10.549">     if ((copy.m_writeOffset + 4) &gt;= copy.m_bytesInBuf) {</span>
<a href="#l10.550"></a><span id="l10.550" class="difflineminus">-      if (!header.Write( copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l10.551"></a><span id="l10.551" class="difflineminus">-        IMPORT_LOG0( &quot;*** ERROR, writing headers 2\n&quot;);</span>
<a href="#l10.552"></a><span id="l10.552" class="difflineminus">-        return( NS_ERROR_FAILURE);</span>
<a href="#l10.553"></a><span id="l10.553" class="difflineplus">+      if (!header.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l10.554"></a><span id="l10.554" class="difflineplus">+        IMPORT_LOG0(&quot;*** ERROR, writing headers 2\n&quot;);</span>
<a href="#l10.555"></a><span id="l10.555" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l10.556"></a><span id="l10.556">       }</span>
<a href="#l10.557"></a><span id="l10.557" class="difflineminus">-      if (NS_FAILED( rv = FillMailBuffer( pState, copy))) {</span>
<a href="#l10.558"></a><span id="l10.558" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error reading message headers 2\n&quot;);</span>
<a href="#l10.559"></a><span id="l10.559" class="difflineminus">-        return( rv);</span>
<a href="#l10.560"></a><span id="l10.560" class="difflineplus">+      if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l10.561"></a><span id="l10.561" class="difflineplus">+        IMPORT_LOG0(&quot;*** Error reading message headers 2\n&quot;);</span>
<a href="#l10.562"></a><span id="l10.562" class="difflineplus">+        return rv;</span>
<a href="#l10.563"></a><span id="l10.563">       }</span>
<a href="#l10.564"></a><span id="l10.564">     }</span>
<a href="#l10.565"></a><span id="l10.565">   }</span>
<a href="#l10.566"></a><span id="l10.566"> </span>
<a href="#l10.567"></a><span id="l10.567" class="difflineminus">-  if (!header.Write( copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l10.568"></a><span id="l10.568" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error writing final headers\n&quot;);</span>
<a href="#l10.569"></a><span id="l10.569" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l10.570"></a><span id="l10.570" class="difflineplus">+  if (!header.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l10.571"></a><span id="l10.571" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error writing final headers\n&quot;);</span>
<a href="#l10.572"></a><span id="l10.572" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l10.573"></a><span id="l10.573">   }</span>
<a href="#l10.574"></a><span id="l10.574"> </span>
<a href="#l10.575"></a><span id="l10.575">   if (pTocEntry) {</span>
<a href="#l10.576"></a><span id="l10.576">     // This is not the prettiest spot to stick this code, but it works and it was convenient.</span>
<a href="#l10.577"></a><span id="l10.577">     char    header_str[128];</span>
<a href="#l10.578"></a><span id="l10.578"> </span>
<a href="#l10.579"></a><span id="l10.579">     // Write X-Mozilla-Status header</span>
<a href="#l10.580"></a><span id="l10.580" class="difflineminus">-    PR_snprintf( header_str, 128, MSG_LINEBREAK X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, pTocEntry-&gt;GetMozillaStatusFlags() );</span>
<a href="#l10.581"></a><span id="l10.581" class="difflineminus">-    header.Write( header_str, strlen(header_str) );</span>
<a href="#l10.582"></a><span id="l10.582" class="difflineplus">+    PR_snprintf(header_str, 128, MSG_LINEBREAK X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, pTocEntry-&gt;GetMozillaStatusFlags());</span>
<a href="#l10.583"></a><span id="l10.583" class="difflineplus">+    header.Write(header_str, strlen(header_str));</span>
<a href="#l10.584"></a><span id="l10.584"> </span>
<a href="#l10.585"></a><span id="l10.585">     // Write X-Mozilla-Status2 header</span>
<a href="#l10.586"></a><span id="l10.586" class="difflineminus">-    PR_snprintf( header_str, 128, X_MOZILLA_STATUS2_FORMAT MSG_LINEBREAK, pTocEntry-&gt;GetMozillaStatus2Flags() );</span>
<a href="#l10.587"></a><span id="l10.587" class="difflineminus">-    header.Write( header_str, strlen(header_str) );</span>
<a href="#l10.588"></a><span id="l10.588" class="difflineplus">+    PR_snprintf(header_str, 128, X_MOZILLA_STATUS2_FORMAT MSG_LINEBREAK, pTocEntry-&gt;GetMozillaStatus2Flags());</span>
<a href="#l10.589"></a><span id="l10.589" class="difflineplus">+    header.Write(header_str, strlen(header_str));</span>
<a href="#l10.590"></a><span id="l10.590"> </span>
<a href="#l10.591"></a><span id="l10.591">     // Format and write X-Mozilla-Keys header</span>
<a href="#l10.592"></a><span id="l10.592">     nsCString  keywordHdr(X_MOZILLA_KEYWORDS);</span>
<a href="#l10.593"></a><span id="l10.593" class="difflineminus">-    if ( pTocEntry-&gt;HasEudoraLabel() ) {</span>
<a href="#l10.594"></a><span id="l10.594" class="difflineminus">-      PR_snprintf( header_str, 128, &quot;eudoralabel%d&quot;, pTocEntry-&gt;GetLabelNumber() );</span>
<a href="#l10.595"></a><span id="l10.595" class="difflineplus">+    if (pTocEntry-&gt;HasEudoraLabel()) {</span>
<a href="#l10.596"></a><span id="l10.596" class="difflineplus">+      PR_snprintf(header_str, 128, &quot;eudoralabel%d&quot;, pTocEntry-&gt;GetLabelNumber());</span>
<a href="#l10.597"></a><span id="l10.597">       keywordHdr.Replace(sizeof(HEADER_X_MOZILLA_KEYWORDS) + 1, strlen(header_str), header_str);</span>
<a href="#l10.598"></a><span id="l10.598">     }</span>
<a href="#l10.599"></a><span id="l10.599" class="difflineminus">-    header.Write( keywordHdr.get(), keywordHdr.Length() );</span>
<a href="#l10.600"></a><span id="l10.600" class="difflineplus">+    header.Write(keywordHdr.get(), keywordHdr.Length());</span>
<a href="#l10.601"></a><span id="l10.601">   }</span>
<a href="#l10.602"></a><span id="l10.602"> </span>
<a href="#l10.603"></a><span id="l10.603" class="difflineminus">-  if (!header.Write( &amp;endBuffer, 1)) {</span>
<a href="#l10.604"></a><span id="l10.604" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error writing header trailing null\n&quot;);</span>
<a href="#l10.605"></a><span id="l10.605" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l10.606"></a><span id="l10.606" class="difflineplus">+  if (!header.Write(&amp;endBuffer, 1)) {</span>
<a href="#l10.607"></a><span id="l10.607" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error writing header trailing null\n&quot;);</span>
<a href="#l10.608"></a><span id="l10.608" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l10.609"></a><span id="l10.609">   }</span>
<a href="#l10.610"></a><span id="l10.610"> </span>
<a href="#l10.611"></a><span id="l10.611">   copy.m_writeOffset += endLen;</span>
<a href="#l10.612"></a><span id="l10.612" class="difflineminus">-  if (NS_FAILED( rv = FillMailBuffer( pState, copy))) {</span>
<a href="#l10.613"></a><span id="l10.613" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error reading beginning of message body\n&quot;);</span>
<a href="#l10.614"></a><span id="l10.614" class="difflineminus">-    return( rv);</span>
<a href="#l10.615"></a><span id="l10.615" class="difflineplus">+  if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l10.616"></a><span id="l10.616" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error reading beginning of message body\n&quot;);</span>
<a href="#l10.617"></a><span id="l10.617" class="difflineplus">+    return rv;</span>
<a href="#l10.618"></a><span id="l10.618">   }</span>
<a href="#l10.619"></a><span id="l10.619"> </span>
<a href="#l10.620"></a><span id="l10.620">   EmptyAttachments();</span>
<a href="#l10.621"></a><span id="l10.621"> </span>
<a href="#l10.622"></a><span id="l10.622">   // Get the body!</span>
<a href="#l10.623"></a><span id="l10.623">   // Read one line at a time here and look for the next separator</span>
<a href="#l10.624"></a><span id="l10.624">   nsCString tmp;</span>
<a href="#l10.625"></a><span id="l10.625">   bool insideEudoraTags = false;</span>
<a href="#l10.626"></a><span id="l10.626">   // by default we consider the body text to be plain text</span>
<a href="#l10.627"></a><span id="l10.627">   bodyType = &quot;text/plain&quot;;</span>
<a href="#l10.628"></a><span id="l10.628"> </span>
<a href="#l10.629"></a><span id="l10.629" class="difflineminus">-  while ((lineLen = IsEudoraFromSeparator( copy.m_pBuffer + copy.m_writeOffset, copy.m_bytesInBuf - copy.m_writeOffset, tmp)) == -1) {</span>
<a href="#l10.630"></a><span id="l10.630" class="difflineplus">+  while ((lineLen = IsEudoraFromSeparator(copy.m_pBuffer + copy.m_writeOffset, copy.m_bytesInBuf - copy.m_writeOffset, tmp)) == -1) {</span>
<a href="#l10.631"></a><span id="l10.631">     PRInt32 tagLength = 0;</span>
<a href="#l10.632"></a><span id="l10.632" class="difflineminus">-    if (IsEudoraTag ( copy.m_pBuffer + copy.m_writeOffset, copy.m_bytesInBuf - copy.m_writeOffset, insideEudoraTags, bodyType, tagLength)) {</span>
<a href="#l10.633"></a><span id="l10.633" class="difflineplus">+    if (IsEudoraTag (copy.m_pBuffer + copy.m_writeOffset, copy.m_bytesInBuf - copy.m_writeOffset, insideEudoraTags, bodyType, tagLength)) {</span>
<a href="#l10.634"></a><span id="l10.634">       // We don't want to keep eudora tags so skip over them.</span>
<a href="#l10.635"></a><span id="l10.635"> </span>
<a href="#l10.636"></a><span id="l10.636">       // let's write the previous text</span>
<a href="#l10.637"></a><span id="l10.637" class="difflineminus">-      if (!body.Write( copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l10.638"></a><span id="l10.638" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error writing to message body\n&quot;);</span>
<a href="#l10.639"></a><span id="l10.639" class="difflineminus">-        return( NS_ERROR_FAILURE);</span>
<a href="#l10.640"></a><span id="l10.640" class="difflineplus">+      if (!body.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l10.641"></a><span id="l10.641" class="difflineplus">+        IMPORT_LOG0(&quot;*** Error writing to message body\n&quot;);</span>
<a href="#l10.642"></a><span id="l10.642" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l10.643"></a><span id="l10.643">       }</span>
<a href="#l10.644"></a><span id="l10.644"> </span>
<a href="#l10.645"></a><span id="l10.645">       // we want to skip over the tag...for now we are assuming the tag is always at the start of line.</span>
<a href="#l10.646"></a><span id="l10.646">       copy.m_writeOffset += tagLength;</span>
<a href="#l10.647"></a><span id="l10.647" class="difflineminus">-        if (NS_FAILED( rv = FillMailBuffer( pState, copy))) {</span>
<a href="#l10.648"></a><span id="l10.648" class="difflineminus">-          IMPORT_LOG0( &quot;*** Error reading message body\n&quot;);</span>
<a href="#l10.649"></a><span id="l10.649" class="difflineminus">-          return( rv);</span>
<a href="#l10.650"></a><span id="l10.650" class="difflineplus">+        if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l10.651"></a><span id="l10.651" class="difflineplus">+          IMPORT_LOG0(&quot;*** Error reading message body\n&quot;);</span>
<a href="#l10.652"></a><span id="l10.652" class="difflineplus">+          return rv;</span>
<a href="#l10.653"></a><span id="l10.653">         }</span>
<a href="#l10.654"></a><span id="l10.654"> </span>
<a href="#l10.655"></a><span id="l10.655">       if (!copy.m_bytesInBuf)</span>
<a href="#l10.656"></a><span id="l10.656">         break;</span>
<a href="#l10.657"></a><span id="l10.657"> </span>
<a href="#l10.658"></a><span id="l10.658">       continue;</span>
<a href="#l10.659"></a><span id="l10.659">     }</span>
<a href="#l10.660"></a><span id="l10.660"> </span>
<a href="#l10.661"></a><span id="l10.661">     // Eudora Attachment lines are always outside Eudora Tags</span>
<a href="#l10.662"></a><span id="l10.662">     // so we shouldn't try to find one here</span>
<a href="#l10.663"></a><span id="l10.663">     if (!insideEudoraTags) {</span>
<a href="#l10.664"></a><span id="l10.664">     // Debatable is whether or not to exclude these lines from the</span>
<a href="#l10.665"></a><span id="l10.665">     // text of the message, I prefer not to in case the original</span>
<a href="#l10.666"></a><span id="l10.666">     // attachment is actually missing.</span>
<a href="#l10.667"></a><span id="l10.667" class="difflineminus">-    rv = ExamineAttachment( copy);</span>
<a href="#l10.668"></a><span id="l10.668" class="difflineminus">-    if (NS_FAILED( rv)) {</span>
<a href="#l10.669"></a><span id="l10.669" class="difflineminus">-      IMPORT_LOG0( &quot;*** Error examining attachment line\n&quot;);</span>
<a href="#l10.670"></a><span id="l10.670" class="difflineminus">-      return( rv);</span>
<a href="#l10.671"></a><span id="l10.671" class="difflineplus">+    rv = ExamineAttachment(copy);</span>
<a href="#l10.672"></a><span id="l10.672" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l10.673"></a><span id="l10.673" class="difflineplus">+      IMPORT_LOG0(&quot;*** Error examining attachment line\n&quot;);</span>
<a href="#l10.674"></a><span id="l10.674" class="difflineplus">+      return rv;</span>
<a href="#l10.675"></a><span id="l10.675">     }</span>
<a href="#l10.676"></a><span id="l10.676">     }</span>
<a href="#l10.677"></a><span id="l10.677"> </span>
<a href="#l10.678"></a><span id="l10.678" class="difflineminus">-    while (((lineLen = FindStartLine( copy)) == -1) &amp;&amp; copy.m_bytesInBuf) {</span>
<a href="#l10.679"></a><span id="l10.679" class="difflineplus">+    while (((lineLen = FindStartLine(copy)) == -1) &amp;&amp; copy.m_bytesInBuf) {</span>
<a href="#l10.680"></a><span id="l10.680">       copy.m_writeOffset = copy.m_bytesInBuf;</span>
<a href="#l10.681"></a><span id="l10.681" class="difflineminus">-      if (!body.Write( copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l10.682"></a><span id="l10.682" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error writing to message body\n&quot;);</span>
<a href="#l10.683"></a><span id="l10.683" class="difflineminus">-        return( NS_ERROR_FAILURE);</span>
<a href="#l10.684"></a><span id="l10.684" class="difflineplus">+      if (!body.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l10.685"></a><span id="l10.685" class="difflineplus">+        IMPORT_LOG0(&quot;*** Error writing to message body\n&quot;);</span>
<a href="#l10.686"></a><span id="l10.686" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l10.687"></a><span id="l10.687">       }</span>
<a href="#l10.688"></a><span id="l10.688" class="difflineminus">-      if (NS_FAILED( rv = FillMailBuffer( pState, copy))) {</span>
<a href="#l10.689"></a><span id="l10.689" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error reading message body\n&quot;);</span>
<a href="#l10.690"></a><span id="l10.690" class="difflineminus">-        return( rv);</span>
<a href="#l10.691"></a><span id="l10.691" class="difflineplus">+      if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l10.692"></a><span id="l10.692" class="difflineplus">+        IMPORT_LOG0(&quot;*** Error reading message body\n&quot;);</span>
<a href="#l10.693"></a><span id="l10.693" class="difflineplus">+        return rv;</span>
<a href="#l10.694"></a><span id="l10.694">       }</span>
<a href="#l10.695"></a><span id="l10.695">     }</span>
<a href="#l10.696"></a><span id="l10.696">     if (!copy.m_bytesInBuf)</span>
<a href="#l10.697"></a><span id="l10.697">       break;</span>
<a href="#l10.698"></a><span id="l10.698"> </span>
<a href="#l10.699"></a><span id="l10.699">     copy.m_writeOffset += lineLen;</span>
<a href="#l10.700"></a><span id="l10.700"> </span>
<a href="#l10.701"></a><span id="l10.701">     // found the start of the next line</span>
<a href="#l10.702"></a><span id="l10.702">     // make sure it's long enough to check for the from line</span>
<a href="#l10.703"></a><span id="l10.703">     if ((copy.m_writeOffset + 2048) &gt;= copy.m_bytesInBuf) {</span>
<a href="#l10.704"></a><span id="l10.704" class="difflineminus">-      if (!body.Write( copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l10.705"></a><span id="l10.705" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error writing to message body 2\n&quot;);</span>
<a href="#l10.706"></a><span id="l10.706" class="difflineminus">-        return( NS_ERROR_FAILURE);</span>
<a href="#l10.707"></a><span id="l10.707" class="difflineplus">+      if (!body.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l10.708"></a><span id="l10.708" class="difflineplus">+        IMPORT_LOG0(&quot;*** Error writing to message body 2\n&quot;);</span>
<a href="#l10.709"></a><span id="l10.709" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l10.710"></a><span id="l10.710">       }</span>
<a href="#l10.711"></a><span id="l10.711" class="difflineminus">-      if (NS_FAILED( rv = FillMailBuffer( pState, copy))) {</span>
<a href="#l10.712"></a><span id="l10.712" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error reading message body 2\n&quot;);</span>
<a href="#l10.713"></a><span id="l10.713" class="difflineminus">-        return( rv);</span>
<a href="#l10.714"></a><span id="l10.714" class="difflineplus">+      if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l10.715"></a><span id="l10.715" class="difflineplus">+        IMPORT_LOG0(&quot;*** Error reading message body 2\n&quot;);</span>
<a href="#l10.716"></a><span id="l10.716" class="difflineplus">+        return rv;</span>
<a href="#l10.717"></a><span id="l10.717">       }</span>
<a href="#l10.718"></a><span id="l10.718">     }</span>
<a href="#l10.719"></a><span id="l10.719">   }</span>
<a href="#l10.720"></a><span id="l10.720"> </span>
<a href="#l10.721"></a><span id="l10.721">   // the start of the current line is a from, we-re done</span>
<a href="#l10.722"></a><span id="l10.722" class="difflineminus">-  if (!body.Write( copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l10.723"></a><span id="l10.723" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error writing final message body\n&quot;);</span>
<a href="#l10.724"></a><span id="l10.724" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l10.725"></a><span id="l10.725" class="difflineplus">+  if (!body.Write(copy.m_pBuffer, copy.m_writeOffset)) {</span>
<a href="#l10.726"></a><span id="l10.726" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error writing final message body\n&quot;);</span>
<a href="#l10.727"></a><span id="l10.727" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l10.728"></a><span id="l10.728">   }</span>
<a href="#l10.729"></a><span id="l10.729" class="difflineminus">-  if (!body.Write( &amp;endBuffer, 1)) {</span>
<a href="#l10.730"></a><span id="l10.730" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error writing body trailing null\n&quot;);</span>
<a href="#l10.731"></a><span id="l10.731" class="difflineminus">-    IMPORT_LOG2( &quot;\tbody.m_size: %ld, body.m_writeOffset: %ld\n&quot;, body.m_size, body.m_writeOffset);</span>
<a href="#l10.732"></a><span id="l10.732" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l10.733"></a><span id="l10.733" class="difflineplus">+  if (!body.Write(&amp;endBuffer, 1)) {</span>
<a href="#l10.734"></a><span id="l10.734" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error writing body trailing null\n&quot;);</span>
<a href="#l10.735"></a><span id="l10.735" class="difflineplus">+    IMPORT_LOG2(&quot;\tbody.m_size: %ld, body.m_writeOffset: %ld\n&quot;, body.m_size, body.m_writeOffset);</span>
<a href="#l10.736"></a><span id="l10.736" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l10.737"></a><span id="l10.737">   }</span>
<a href="#l10.738"></a><span id="l10.738" class="difflineminus">-  if (NS_FAILED( rv = FillMailBuffer( pState, copy))) {</span>
<a href="#l10.739"></a><span id="l10.739" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error filling mail buffer for next read message\n&quot;);</span>
<a href="#l10.740"></a><span id="l10.740" class="difflineminus">-    return( rv);</span>
<a href="#l10.741"></a><span id="l10.741" class="difflineplus">+  if (NS_FAILED(rv = FillMailBuffer(pState, copy))) {</span>
<a href="#l10.742"></a><span id="l10.742" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error filling mail buffer for next read message\n&quot;);</span>
<a href="#l10.743"></a><span id="l10.743" class="difflineplus">+    return rv;</span>
<a href="#l10.744"></a><span id="l10.744">   }</span>
<a href="#l10.745"></a><span id="l10.745"> </span>
<a href="#l10.746"></a><span id="l10.746" class="difflineminus">-  return( NS_OK);</span>
<a href="#l10.747"></a><span id="l10.747" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.748"></a><span id="l10.748"> }</span>
<a href="#l10.749"></a><span id="l10.749"> </span>
<a href="#l10.750"></a><span id="l10.750" class="difflineminus">-PRInt32  nsEudoraMailbox::FindStartLine( SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l10.751"></a><span id="l10.751" class="difflineplus">+PRInt32  nsEudoraMailbox::FindStartLine(SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l10.752"></a><span id="l10.752"> {</span>
<a href="#l10.753"></a><span id="l10.753">   PRInt32 len = data.m_bytesInBuf - data.m_writeOffset;</span>
<a href="#l10.754"></a><span id="l10.754">   if (!len)</span>
<a href="#l10.755"></a><span id="l10.755" class="difflineminus">-    return( -1);</span>
<a href="#l10.756"></a><span id="l10.756" class="difflineplus">+    return -1;</span>
<a href="#l10.757"></a><span id="l10.757"> </span>
<a href="#l10.758"></a><span id="l10.758">   PRInt32 count = 0;</span>
<a href="#l10.759"></a><span id="l10.759">   const char *pData = data.m_pBuffer + data.m_writeOffset;</span>
<a href="#l10.760"></a><span id="l10.760">   // Skip to next end of line.</span>
<a href="#l10.761"></a><span id="l10.761">   while ((count &lt; len) &amp;&amp; (*pData != nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF)) {</span>
<a href="#l10.762"></a><span id="l10.762">     pData++;</span>
<a href="#l10.763"></a><span id="l10.763">     count++;</span>
<a href="#l10.764"></a><span id="l10.764">   }</span>
<a href="#l10.765"></a><span id="l10.765">   if (count == len)</span>
<a href="#l10.766"></a><span id="l10.766" class="difflineminus">-    return( -1);</span>
<a href="#l10.767"></a><span id="l10.767" class="difflineplus">+    return -1;</span>
<a href="#l10.768"></a><span id="l10.768"> </span>
<a href="#l10.769"></a><span id="l10.769">   // Skip over end of line(s).</span>
<a href="#l10.770"></a><span id="l10.770">   while ((count &lt; len) &amp;&amp; ((*pData == nsCRT::CR) || (*pData == nsCRT::LF))) {</span>
<a href="#l10.771"></a><span id="l10.771">     pData++;</span>
<a href="#l10.772"></a><span id="l10.772">     count++;</span>
<a href="#l10.773"></a><span id="l10.773">   }</span>
<a href="#l10.774"></a><span id="l10.774">   if (count &lt; len)</span>
<a href="#l10.775"></a><span id="l10.775" class="difflineminus">-    return( count);</span>
<a href="#l10.776"></a><span id="l10.776" class="difflineplus">+    return count;</span>
<a href="#l10.777"></a><span id="l10.777"> </span>
<a href="#l10.778"></a><span id="l10.778" class="difflineminus">-  return( -1);</span>
<a href="#l10.779"></a><span id="l10.779" class="difflineplus">+  return -1;</span>
<a href="#l10.780"></a><span id="l10.780"> }</span>
<a href="#l10.781"></a><span id="l10.781"> </span>
<a href="#l10.782"></a><span id="l10.782" class="difflineminus">-PRInt32 nsEudoraMailbox::FindNextEndLine( SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l10.783"></a><span id="l10.783" class="difflineplus">+PRInt32 nsEudoraMailbox::FindNextEndLine(SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l10.784"></a><span id="l10.784"> {</span>
<a href="#l10.785"></a><span id="l10.785">   PRInt32 len = data.m_bytesInBuf - data.m_writeOffset;</span>
<a href="#l10.786"></a><span id="l10.786">   if (!len)</span>
<a href="#l10.787"></a><span id="l10.787" class="difflineminus">-    return( -1);</span>
<a href="#l10.788"></a><span id="l10.788" class="difflineplus">+    return -1;</span>
<a href="#l10.789"></a><span id="l10.789"> </span>
<a href="#l10.790"></a><span id="l10.790">   PRInt32 count = 0;</span>
<a href="#l10.791"></a><span id="l10.791">   const char *pData = data.m_pBuffer + data.m_writeOffset;</span>
<a href="#l10.792"></a><span id="l10.792">   // Skip over end of line(s).</span>
<a href="#l10.793"></a><span id="l10.793">   while ((count &lt; len) &amp;&amp; ((*pData == nsCRT::CR) || (*pData == nsCRT::LF))) {</span>
<a href="#l10.794"></a><span id="l10.794">     pData++;</span>
<a href="#l10.795"></a><span id="l10.795">     count++;</span>
<a href="#l10.796"></a><span id="l10.796">   }</span>
<a href="#l10.797"></a><span id="l10.797">   // Skip to next end of line.</span>
<a href="#l10.798"></a><span id="l10.798">   while ((count &lt; len) &amp;&amp; (*pData != nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF)) {</span>
<a href="#l10.799"></a><span id="l10.799">     pData++;</span>
<a href="#l10.800"></a><span id="l10.800">     count++;</span>
<a href="#l10.801"></a><span id="l10.801">   }</span>
<a href="#l10.802"></a><span id="l10.802">   if (count &lt; len)</span>
<a href="#l10.803"></a><span id="l10.803" class="difflineminus">-    return( count);</span>
<a href="#l10.804"></a><span id="l10.804" class="difflineplus">+    return count;</span>
<a href="#l10.805"></a><span id="l10.805"> </span>
<a href="#l10.806"></a><span id="l10.806" class="difflineminus">-  return( -1);</span>
<a href="#l10.807"></a><span id="l10.807" class="difflineplus">+  return -1;</span>
<a href="#l10.808"></a><span id="l10.808"> }</span>
<a href="#l10.809"></a><span id="l10.809"> </span>
<a href="#l10.810"></a><span id="l10.810" class="difflineminus">-PRInt32 nsEudoraMailbox::IsEndHeaders( SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l10.811"></a><span id="l10.811" class="difflineplus">+PRInt32 nsEudoraMailbox::IsEndHeaders(SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l10.812"></a><span id="l10.812"> {</span>
<a href="#l10.813"></a><span id="l10.813">   PRInt32 len = data.m_bytesInBuf - data.m_writeOffset;</span>
<a href="#l10.814"></a><span id="l10.814">   if (len &lt; 2)</span>
<a href="#l10.815"></a><span id="l10.815" class="difflineminus">-    return( -1);</span>
<a href="#l10.816"></a><span id="l10.816" class="difflineplus">+    return -1;</span>
<a href="#l10.817"></a><span id="l10.817"> </span>
<a href="#l10.818"></a><span id="l10.818">   const char *pChar = data.m_pBuffer + data.m_writeOffset;</span>
<a href="#l10.819"></a><span id="l10.819">   // Double nsCRT::CR.</span>
<a href="#l10.820"></a><span id="l10.820">   if ((*pChar == nsCRT::CR) &amp;&amp; (*(pChar + 1) == nsCRT::CR))</span>
<a href="#l10.821"></a><span id="l10.821" class="difflineminus">-    return( 2);</span>
<a href="#l10.822"></a><span id="l10.822" class="difflineplus">+    return 2;</span>
<a href="#l10.823"></a><span id="l10.823"> </span>
<a href="#l10.824"></a><span id="l10.824">   if (len &lt; 4)</span>
<a href="#l10.825"></a><span id="l10.825" class="difflineminus">-    return( -1);</span>
<a href="#l10.826"></a><span id="l10.826" class="difflineplus">+    return -1;</span>
<a href="#l10.827"></a><span id="l10.827"> </span>
<a href="#l10.828"></a><span id="l10.828">   // Double (nsCRT::CR + nsCRT::LF).</span>
<a href="#l10.829"></a><span id="l10.829">   if ((*pChar == nsCRT::CR) &amp;&amp; (*(pChar + 1) == nsCRT::LF) &amp;&amp;</span>
<a href="#l10.830"></a><span id="l10.830">       (*(pChar + 2) == nsCRT::CR) &amp;&amp; (*(pChar + 3) == nsCRT::LF))</span>
<a href="#l10.831"></a><span id="l10.831" class="difflineminus">-    return( 4);</span>
<a href="#l10.832"></a><span id="l10.832" class="difflineplus">+    return 4;</span>
<a href="#l10.833"></a><span id="l10.833"> </span>
<a href="#l10.834"></a><span id="l10.834" class="difflineminus">-  return( -1);</span>
<a href="#l10.835"></a><span id="l10.835" class="difflineplus">+  return -1;</span>
<a href="#l10.836"></a><span id="l10.836"> }</span>
<a href="#l10.837"></a><span id="l10.837"> </span>
<a href="#l10.838"></a><span id="l10.838"> static const char *eudoraTag[] = {</span>
<a href="#l10.839"></a><span id="l10.839">   &quot;&lt;x-html&gt;&quot;,</span>
<a href="#l10.840"></a><span id="l10.840">   &quot;&lt;/x-html&gt;&quot;,</span>
<a href="#l10.841"></a><span id="l10.841">   &quot;&lt;x-rich&gt;&quot;,</span>
<a href="#l10.842"></a><span id="l10.842">   &quot;&lt;/x-rich&gt;&quot;,</span>
<a href="#l10.843"></a><span id="l10.843">   &quot;&lt;x-flowed&gt;&quot;,</span>
<a href="#l10.844"></a><span id="l10.844" class="difflineat">@@ -912,97 +905,97 @@ static const char *TagContentType[] = {</span>
<a href="#l10.845"></a><span id="l10.845">   &quot;text/html&quot;,</span>
<a href="#l10.846"></a><span id="l10.846">   &quot;text/enriched&quot;,</span>
<a href="#l10.847"></a><span id="l10.847">   &quot;text/enriched&quot;,</span>
<a href="#l10.848"></a><span id="l10.848">   &quot;text/plain&quot;,</span>
<a href="#l10.849"></a><span id="l10.849">   &quot;text/plain&quot;,</span>
<a href="#l10.850"></a><span id="l10.850"> };</span>
<a href="#l10.851"></a><span id="l10.851"> </span>
<a href="#l10.852"></a><span id="l10.852">   // Determine if this line contains an eudora special tag</span>
<a href="#l10.853"></a><span id="l10.853" class="difflineminus">-bool    nsEudoraMailbox::IsEudoraTag( const char *pChar, PRInt32 maxLen, bool &amp;insideEudoraTags, nsCString &amp;bodyType, PRInt32 &amp;tagLength)</span>
<a href="#l10.854"></a><span id="l10.854" class="difflineplus">+bool    nsEudoraMailbox::IsEudoraTag(const char *pChar, PRInt32 maxLen, bool &amp;insideEudoraTags, nsCString &amp;bodyType, PRInt32 &amp;tagLength)</span>
<a href="#l10.855"></a><span id="l10.855"> {</span>
<a href="#l10.856"></a><span id="l10.856">   PRInt32  idx = 0;</span>
<a href="#l10.857"></a><span id="l10.857">   while ((tagLength = eudoraTagLen[idx]) != 0) {</span>
<a href="#l10.858"></a><span id="l10.858" class="difflineminus">-    if (maxLen &gt;= tagLength &amp;&amp; !strncmp( eudoraTag[idx], pChar, tagLength)) {</span>
<a href="#l10.859"></a><span id="l10.859" class="difflineplus">+    if (maxLen &gt;= tagLength &amp;&amp; !strncmp(eudoraTag[idx], pChar, tagLength)) {</span>
<a href="#l10.860"></a><span id="l10.860">       insideEudoraTags = (pChar[1] != '/');</span>
<a href="#l10.861"></a><span id="l10.861">       bodyType = TagContentType[idx];</span>
<a href="#l10.862"></a><span id="l10.862">       return true;</span>
<a href="#l10.863"></a><span id="l10.863">     }</span>
<a href="#l10.864"></a><span id="l10.864">     idx++;</span>
<a href="#l10.865"></a><span id="l10.865">   }</span>
<a href="#l10.866"></a><span id="l10.866"> </span>
<a href="#l10.867"></a><span id="l10.867">   return false;</span>
<a href="#l10.868"></a><span id="l10.868"> }</span>
<a href="#l10.869"></a><span id="l10.869"> </span>
<a href="#l10.870"></a><span id="l10.870">   // Determine if this line meets Eudora standards for a separator line</span>
<a href="#l10.871"></a><span id="l10.871">   // This logic is based on Eudora 1.3.1's strict requirements for what</span>
<a href="#l10.872"></a><span id="l10.872">   // makes a valid separator line.  This may need to be relaxed for newer</span>
<a href="#l10.873"></a><span id="l10.873">   // versions of Eudora.</span>
<a href="#l10.874"></a><span id="l10.874">   // A sample from line:</span>
<a href="#l10.875"></a><span id="l10.875">   // From john@uxc.cso.uiuc.edu Wed Jan 14 12:36:18 1989</span>
<a href="#l10.876"></a><span id="l10.876" class="difflineminus">-PRInt32  nsEudoraMailbox::IsEudoraFromSeparator( const char *pChar, PRInt32 maxLen, nsCString&amp; defaultDate)</span>
<a href="#l10.877"></a><span id="l10.877" class="difflineplus">+PRInt32  nsEudoraMailbox::IsEudoraFromSeparator(const char *pChar, PRInt32 maxLen, nsCString&amp; defaultDate)</span>
<a href="#l10.878"></a><span id="l10.878"> {</span>
<a href="#l10.879"></a><span id="l10.879">   if (maxLen &lt; 12)</span>
<a href="#l10.880"></a><span id="l10.880" class="difflineminus">-    return( -1);</span>
<a href="#l10.881"></a><span id="l10.881" class="difflineplus">+    return -1;</span>
<a href="#l10.882"></a><span id="l10.882"> </span>
<a href="#l10.883"></a><span id="l10.883">   PRInt32    len = 0;</span>
<a href="#l10.884"></a><span id="l10.884">   if ((*pChar != 'F') || (*(pChar + 1) != 'r') || (*(pChar + 2) != 'o') || (*(pChar + 3) != 'm'))</span>
<a href="#l10.885"></a><span id="l10.885" class="difflineminus">-    return( -1);</span>
<a href="#l10.886"></a><span id="l10.886" class="difflineplus">+    return -1;</span>
<a href="#l10.887"></a><span id="l10.887">   pChar += 4;</span>
<a href="#l10.888"></a><span id="l10.888">   len += 4;</span>
<a href="#l10.889"></a><span id="l10.889"> </span>
<a href="#l10.890"></a><span id="l10.890">   // According to Eudora the next char MUST be a space, and there can only be 1 space</span>
<a href="#l10.891"></a><span id="l10.891">   // before the return mail address.</span>
<a href="#l10.892"></a><span id="l10.892">   // I'll be nicer and allow any amount of whitespace</span>
<a href="#l10.893"></a><span id="l10.893">   while (((*pChar == ' ') || (*pChar == '\t')) &amp;&amp; (len &lt; maxLen)) {</span>
<a href="#l10.894"></a><span id="l10.894">     pChar++;</span>
<a href="#l10.895"></a><span id="l10.895">     len++;</span>
<a href="#l10.896"></a><span id="l10.896">   }</span>
<a href="#l10.897"></a><span id="l10.897">   if (len == maxLen)</span>
<a href="#l10.898"></a><span id="l10.898" class="difflineminus">-    return( -1);</span>
<a href="#l10.899"></a><span id="l10.899" class="difflineplus">+    return -1;</span>
<a href="#l10.900"></a><span id="l10.900"> </span>
<a href="#l10.901"></a><span id="l10.901">   // Determine the length of the line</span>
<a href="#l10.902"></a><span id="l10.902">   PRInt32      lineLen = len;</span>
<a href="#l10.903"></a><span id="l10.903">   const char *  pTok = pChar;</span>
<a href="#l10.904"></a><span id="l10.904">   // Skip to next end of line.</span>
<a href="#l10.905"></a><span id="l10.905">   while ((lineLen &lt; maxLen) &amp;&amp; (*pTok != nsCRT::CR) &amp;&amp; (*pTok != nsCRT::LF)) {</span>
<a href="#l10.906"></a><span id="l10.906">     lineLen++;</span>
<a href="#l10.907"></a><span id="l10.907">     pTok++;</span>
<a href="#l10.908"></a><span id="l10.908">   }</span>
<a href="#l10.909"></a><span id="l10.909">   if (len &gt;= lineLen)</span>
<a href="#l10.910"></a><span id="l10.910" class="difflineminus">-    return( -1);</span>
<a href="#l10.911"></a><span id="l10.911" class="difflineplus">+    return -1;</span>
<a href="#l10.912"></a><span id="l10.912"> </span>
<a href="#l10.913"></a><span id="l10.913">   // Eudora allows the return address to be double quoted or not at all..</span>
<a href="#l10.914"></a><span id="l10.914">   // I'll allow single or double quote, but other than that, just skip</span>
<a href="#l10.915"></a><span id="l10.915">   // the return address until you hit a space char (I allow tab as well)</span>
<a href="#l10.916"></a><span id="l10.916">   char  quote = *pChar;</span>
<a href="#l10.917"></a><span id="l10.917">   if ((quote == '&quot;') || (quote == '\'')) {</span>
<a href="#l10.918"></a><span id="l10.918">     pChar++;</span>
<a href="#l10.919"></a><span id="l10.919">     len++;</span>
<a href="#l10.920"></a><span id="l10.920">     while ((len &lt; lineLen) &amp;&amp; (*pChar != quote)) {</span>
<a href="#l10.921"></a><span id="l10.921">       pChar++;</span>
<a href="#l10.922"></a><span id="l10.922">       len++;</span>
<a href="#l10.923"></a><span id="l10.923">     }</span>
<a href="#l10.924"></a><span id="l10.924">     if (len == lineLen)</span>
<a href="#l10.925"></a><span id="l10.925" class="difflineminus">-      return( -1);</span>
<a href="#l10.926"></a><span id="l10.926" class="difflineplus">+      return -1;</span>
<a href="#l10.927"></a><span id="l10.927">     len++;</span>
<a href="#l10.928"></a><span id="l10.928">     pChar++;</span>
<a href="#l10.929"></a><span id="l10.929">   }</span>
<a href="#l10.930"></a><span id="l10.930">   else {</span>
<a href="#l10.931"></a><span id="l10.931">     while ((len &lt; lineLen) &amp;&amp; (*pChar != ' ') &amp;&amp; (*pChar != '\t')) {</span>
<a href="#l10.932"></a><span id="l10.932">       pChar++;</span>
<a href="#l10.933"></a><span id="l10.933">       len++;</span>
<a href="#l10.934"></a><span id="l10.934">     }</span>
<a href="#l10.935"></a><span id="l10.935">   }</span>
<a href="#l10.936"></a><span id="l10.936">   while (((*pChar == ' ') || (*pChar == '\t')) &amp;&amp; (len &lt; lineLen)) {</span>
<a href="#l10.937"></a><span id="l10.937">     pChar++;</span>
<a href="#l10.938"></a><span id="l10.938">     len++;</span>
<a href="#l10.939"></a><span id="l10.939">   }</span>
<a href="#l10.940"></a><span id="l10.940">   if (len == lineLen)</span>
<a href="#l10.941"></a><span id="l10.941" class="difflineminus">-    return( -1);</span>
<a href="#l10.942"></a><span id="l10.942" class="difflineplus">+    return -1;</span>
<a href="#l10.943"></a><span id="l10.943"> </span>
<a href="#l10.944"></a><span id="l10.944">   // we've passed the address, now check for the remaining data</span>
<a href="#l10.945"></a><span id="l10.945">   // Now it gets really funky!</span>
<a href="#l10.946"></a><span id="l10.946">   // In no particular order, with token separators space, tab, comma, newline</span>
<a href="#l10.947"></a><span id="l10.947">   // a - the phrase &quot;remote from&quot;, remote must be first, from is optional.  2 froms or 2 remotes fails</span>
<a href="#l10.948"></a><span id="l10.948">   // b - one and only one time value xx:xx or xx:xx:xx</span>
<a href="#l10.949"></a><span id="l10.949">   // c - one and only one day, 1 to 31</span>
<a href="#l10.950"></a><span id="l10.950">   // d - one and only one year, 2 digit anything or 4 digit &gt; 1900</span>
<a href="#l10.951"></a><span id="l10.951" class="difflineat">@@ -1029,40 +1022,40 @@ PRInt32  nsEudoraMailbox::IsEudoraFromSe</span>
<a href="#l10.952"></a><span id="l10.952">     pTok = pChar;</span>
<a href="#l10.953"></a><span id="l10.953">     tokStart = len;</span>
<a href="#l10.954"></a><span id="l10.954">     while ((len &lt; lineLen) &amp;&amp; (*pChar != ' ') &amp;&amp; (*pChar != '\t') &amp;&amp; (*pChar != ',')) {</span>
<a href="#l10.955"></a><span id="l10.955">       pChar++;</span>
<a href="#l10.956"></a><span id="l10.956">       len++;</span>
<a href="#l10.957"></a><span id="l10.957">     }</span>
<a href="#l10.958"></a><span id="l10.958">     tokLen = len - tokStart;</span>
<a href="#l10.959"></a><span id="l10.959">     if (tokLen) {</span>
<a href="#l10.960"></a><span id="l10.960" class="difflineminus">-      num = AsciiToLong( pTok, tokLen);</span>
<a href="#l10.961"></a><span id="l10.961" class="difflineminus">-      if ((tokLen == 3) &amp;&amp; ((result = IsWeekDayStr( pTok)) != 0)) {</span>
<a href="#l10.962"></a><span id="l10.962" class="difflineplus">+      num = AsciiToLong(pTok, tokLen);</span>
<a href="#l10.963"></a><span id="l10.963" class="difflineplus">+      if ((tokLen == 3) &amp;&amp; ((result = IsWeekDayStr(pTok)) != 0)) {</span>
<a href="#l10.964"></a><span id="l10.964">         if (weekDay)</span>
<a href="#l10.965"></a><span id="l10.965" class="difflineminus">-          return( -1);</span>
<a href="#l10.966"></a><span id="l10.966" class="difflineplus">+          return -1;</span>
<a href="#l10.967"></a><span id="l10.967">         weekDay = result;</span>
<a href="#l10.968"></a><span id="l10.968">       }</span>
<a href="#l10.969"></a><span id="l10.969" class="difflineminus">-      else if ((tokLen == 3) &amp;&amp; ((result = IsMonthStr( pTok)) != 0)) {</span>
<a href="#l10.970"></a><span id="l10.970" class="difflineplus">+      else if ((tokLen == 3) &amp;&amp; ((result = IsMonthStr(pTok)) != 0)) {</span>
<a href="#l10.971"></a><span id="l10.971">         if (month)</span>
<a href="#l10.972"></a><span id="l10.972" class="difflineminus">-          return( -1);</span>
<a href="#l10.973"></a><span id="l10.973" class="difflineplus">+          return -1;</span>
<a href="#l10.974"></a><span id="l10.974">         month = result;</span>
<a href="#l10.975"></a><span id="l10.975">       }</span>
<a href="#l10.976"></a><span id="l10.976" class="difflineminus">-      else if ((tokLen == 6) &amp;&amp; !PL_strncasecmp( pTok, &quot;remote&quot;, 6)) {</span>
<a href="#l10.977"></a><span id="l10.977" class="difflineplus">+      else if ((tokLen == 6) &amp;&amp; !PL_strncasecmp(pTok, &quot;remote&quot;, 6)) {</span>
<a href="#l10.978"></a><span id="l10.978">         if (remote || from)</span>
<a href="#l10.979"></a><span id="l10.979" class="difflineminus">-          return( -1);</span>
<a href="#l10.980"></a><span id="l10.980" class="difflineplus">+          return -1;</span>
<a href="#l10.981"></a><span id="l10.981">         remote = true;</span>
<a href="#l10.982"></a><span id="l10.982">       }</span>
<a href="#l10.983"></a><span id="l10.983" class="difflineminus">-      else if ((tokLen == 4) &amp;&amp; !PL_strncasecmp( pTok, &quot;from&quot;, 4)) {</span>
<a href="#l10.984"></a><span id="l10.984" class="difflineplus">+      else if ((tokLen == 4) &amp;&amp; !PL_strncasecmp(pTok, &quot;from&quot;, 4)) {</span>
<a href="#l10.985"></a><span id="l10.985">         if (!remote || from)</span>
<a href="#l10.986"></a><span id="l10.986" class="difflineminus">-          return( -1);</span>
<a href="#l10.987"></a><span id="l10.987" class="difflineplus">+          return -1;</span>
<a href="#l10.988"></a><span id="l10.988">         from = true;</span>
<a href="#l10.989"></a><span id="l10.989">       }</span>
<a href="#l10.990"></a><span id="l10.990" class="difflineminus">-      else if ((tokLen == 4) &amp;&amp; ((num &gt; 1900) || !strncmp( pTok, &quot;0000&quot;, 4))) {</span>
<a href="#l10.991"></a><span id="l10.991" class="difflineplus">+      else if ((tokLen == 4) &amp;&amp; ((num &gt; 1900) || !strncmp(pTok, &quot;0000&quot;, 4))) {</span>
<a href="#l10.992"></a><span id="l10.992">         if (year)</span>
<a href="#l10.993"></a><span id="l10.993" class="difflineminus">-          return( -1);</span>
<a href="#l10.994"></a><span id="l10.994" class="difflineplus">+          return -1;</span>
<a href="#l10.995"></a><span id="l10.995">         year = (int)num;</span>
<a href="#l10.996"></a><span id="l10.996">         if (!year)</span>
<a href="#l10.997"></a><span id="l10.997">           year = 1900;</span>
<a href="#l10.998"></a><span id="l10.998">       }</span>
<a href="#l10.999"></a><span id="l10.999">       else if (!year &amp;&amp; day &amp;&amp; (tokLen == 2) &amp;&amp; (*(pTok + 1) &gt;= '0') &amp;&amp; (*(pTok + 1) &lt;= '9')) {</span>
<a href="#l10.1000"></a><span id="l10.1000">         if (num &lt; 65)</span>
<a href="#l10.1001"></a><span id="l10.1001">           num += 1900;</span>
<a href="#l10.1002"></a><span id="l10.1002">         else</span>
<a href="#l10.1003"></a><span id="l10.1003" class="difflineat">@@ -1080,20 +1073,20 @@ PRInt32  nsEudoraMailbox::IsEudoraFromSe</span>
<a href="#l10.1004"></a><span id="l10.1004">           if ((result != 2) &amp;&amp; (result != 5)) {</span>
<a href="#l10.1005"></a><span id="l10.1005">             if ((pTok[result] &lt; '0') || (pTok[result] &gt; '9')) {</span>
<a href="#l10.1006"></a><span id="l10.1006">               break;</span>
<a href="#l10.1007"></a><span id="l10.1007">             }</span>
<a href="#l10.1008"></a><span id="l10.1008">           }</span>
<a href="#l10.1009"></a><span id="l10.1009">         }</span>
<a href="#l10.1010"></a><span id="l10.1010">         if (result == tokLen) {</span>
<a href="#l10.1011"></a><span id="l10.1011">           if (tym)</span>
<a href="#l10.1012"></a><span id="l10.1012" class="difflineminus">-            return( -1);</span>
<a href="#l10.1013"></a><span id="l10.1013" class="difflineplus">+            return -1;</span>
<a href="#l10.1014"></a><span id="l10.1014">           tym = true;</span>
<a href="#l10.1015"></a><span id="l10.1015">           // for future use, get the time value</span>
<a href="#l10.1016"></a><span id="l10.1016" class="difflineminus">-          memcpy( tymStr, pTok, tokLen);</span>
<a href="#l10.1017"></a><span id="l10.1017" class="difflineplus">+          memcpy(tymStr, pTok, tokLen);</span>
<a href="#l10.1018"></a><span id="l10.1018">           if (tokLen == 5) {</span>
<a href="#l10.1019"></a><span id="l10.1019">             tymStr[5] = ':';</span>
<a href="#l10.1020"></a><span id="l10.1020">             tymStr[6] = '0';</span>
<a href="#l10.1021"></a><span id="l10.1021">             tymStr[7] = '0';</span>
<a href="#l10.1022"></a><span id="l10.1022">           }</span>
<a href="#l10.1023"></a><span id="l10.1023">           tymStr[8] = 0;</span>
<a href="#l10.1024"></a><span id="l10.1024">         }</span>
<a href="#l10.1025"></a><span id="l10.1025">         else {</span>
<a href="#l10.1026"></a><span id="l10.1026" class="difflineat">@@ -1114,112 +1107,112 @@ PRInt32  nsEudoraMailbox::IsEudoraFromSe</span>
<a href="#l10.1027"></a><span id="l10.1027">   if (day &amp;&amp; year &amp;&amp; month &amp;&amp; tym &amp;&amp; (other &lt; 3)) {</span>
<a href="#l10.1028"></a><span id="l10.1028">     // Now we need to make sure the next line</span>
<a href="#l10.1029"></a><span id="l10.1029">     // isn't blank!</span>
<a href="#l10.1030"></a><span id="l10.1030">     while (len &lt; lineLen) {</span>
<a href="#l10.1031"></a><span id="l10.1031">       len++;</span>
<a href="#l10.1032"></a><span id="l10.1032">       pChar++;</span>
<a href="#l10.1033"></a><span id="l10.1033">     }</span>
<a href="#l10.1034"></a><span id="l10.1034">     if (len == maxLen)</span>
<a href="#l10.1035"></a><span id="l10.1035" class="difflineminus">-      return( -1);</span>
<a href="#l10.1036"></a><span id="l10.1036" class="difflineplus">+      return -1;</span>
<a href="#l10.1037"></a><span id="l10.1037"> </span>
<a href="#l10.1038"></a><span id="l10.1038">     if (*pChar == nsCRT::CR) {</span>
<a href="#l10.1039"></a><span id="l10.1039">       len++;</span>
<a href="#l10.1040"></a><span id="l10.1040">       pChar++;</span>
<a href="#l10.1041"></a><span id="l10.1041">       if (*pChar == nsCRT::LF) {</span>
<a href="#l10.1042"></a><span id="l10.1042">         len++;</span>
<a href="#l10.1043"></a><span id="l10.1043">         pChar++;</span>
<a href="#l10.1044"></a><span id="l10.1044">       }</span>
<a href="#l10.1045"></a><span id="l10.1045">     }</span>
<a href="#l10.1046"></a><span id="l10.1046">     else if (*pChar == nsCRT::LF) {</span>
<a href="#l10.1047"></a><span id="l10.1047">       len++;</span>
<a href="#l10.1048"></a><span id="l10.1048">       pChar++;</span>
<a href="#l10.1049"></a><span id="l10.1049">     }</span>
<a href="#l10.1050"></a><span id="l10.1050">     else</span>
<a href="#l10.1051"></a><span id="l10.1051" class="difflineminus">-      return( -1);</span>
<a href="#l10.1052"></a><span id="l10.1052" class="difflineplus">+      return -1;</span>
<a href="#l10.1053"></a><span id="l10.1053"> </span>
<a href="#l10.1054"></a><span id="l10.1054">     if (len &gt;= maxLen)</span>
<a href="#l10.1055"></a><span id="l10.1055" class="difflineminus">-      return( -1);</span>
<a href="#l10.1056"></a><span id="l10.1056" class="difflineplus">+      return -1;</span>
<a href="#l10.1057"></a><span id="l10.1057"> </span>
<a href="#l10.1058"></a><span id="l10.1058">     while (len &lt; maxLen) {</span>
<a href="#l10.1059"></a><span id="l10.1059">       if ((*pChar == nsCRT::CR) || (*pChar == nsCRT::LF))</span>
<a href="#l10.1060"></a><span id="l10.1060" class="difflineminus">-        return( -1);</span>
<a href="#l10.1061"></a><span id="l10.1061" class="difflineplus">+        return -1;</span>
<a href="#l10.1062"></a><span id="l10.1062"> </span>
<a href="#l10.1063"></a><span id="l10.1063">       if ((*pChar != ' ') &amp;&amp; (*pChar != '\t'))</span>
<a href="#l10.1064"></a><span id="l10.1064">         break;</span>
<a href="#l10.1065"></a><span id="l10.1065"> </span>
<a href="#l10.1066"></a><span id="l10.1066">       pChar++;</span>
<a href="#l10.1067"></a><span id="l10.1067">       len++;</span>
<a href="#l10.1068"></a><span id="l10.1068">     }</span>
<a href="#l10.1069"></a><span id="l10.1069"> </span>
<a href="#l10.1070"></a><span id="l10.1070">     // Whew!, the next line isn't blank.</span>
<a href="#l10.1071"></a><span id="l10.1071">     // Generate the default date header in case the date header is missing when we</span>
<a href="#l10.1072"></a><span id="l10.1072">     // write out headers later. The header looks like &quot;Date: Tue, 5 Feb 2002 23:05:04&quot;</span>
<a href="#l10.1073"></a><span id="l10.1073">     char date_header_str[DATE_STR_LEN];</span>
<a href="#l10.1074"></a><span id="l10.1074">     PR_snprintf(date_header_str, DATE_STR_LEN, &quot;Date: %s, %2d %s %4d %s&quot;, eudoraWeekDays[weekDay-1], day, eudoraMonths[month-1], year, tymStr);</span>
<a href="#l10.1075"></a><span id="l10.1075">     defaultDate.Assign(date_header_str);</span>
<a href="#l10.1076"></a><span id="l10.1076"> </span>
<a href="#l10.1077"></a><span id="l10.1077" class="difflineminus">-    return( lineLen);</span>
<a href="#l10.1078"></a><span id="l10.1078" class="difflineplus">+    return lineLen;</span>
<a href="#l10.1079"></a><span id="l10.1079">   }</span>
<a href="#l10.1080"></a><span id="l10.1080"> </span>
<a href="#l10.1081"></a><span id="l10.1081" class="difflineminus">-  return( -1);</span>
<a href="#l10.1082"></a><span id="l10.1082" class="difflineplus">+  return -1;</span>
<a href="#l10.1083"></a><span id="l10.1083"> }</span>
<a href="#l10.1084"></a><span id="l10.1084"> </span>
<a href="#l10.1085"></a><span id="l10.1085" class="difflineminus">-PRInt32 nsEudoraMailbox::AsciiToLong( const char *pChar, PRInt32 len)</span>
<a href="#l10.1086"></a><span id="l10.1086" class="difflineplus">+PRInt32 nsEudoraMailbox::AsciiToLong(const char *pChar, PRInt32 len)</span>
<a href="#l10.1087"></a><span id="l10.1087"> {</span>
<a href="#l10.1088"></a><span id="l10.1088">   PRInt32 num = 0;</span>
<a href="#l10.1089"></a><span id="l10.1089">   while (len) {</span>
<a href="#l10.1090"></a><span id="l10.1090">     if ((*pChar &lt; '0') || (*pChar &gt; '9'))</span>
<a href="#l10.1091"></a><span id="l10.1091" class="difflineminus">-      return( num);</span>
<a href="#l10.1092"></a><span id="l10.1092" class="difflineplus">+      return num;</span>
<a href="#l10.1093"></a><span id="l10.1093">     num *= 10;</span>
<a href="#l10.1094"></a><span id="l10.1094">     num += (*pChar - '0');</span>
<a href="#l10.1095"></a><span id="l10.1095">     len--;</span>
<a href="#l10.1096"></a><span id="l10.1096">     pChar++;</span>
<a href="#l10.1097"></a><span id="l10.1097">   }</span>
<a href="#l10.1098"></a><span id="l10.1098" class="difflineminus">-  return( num);</span>
<a href="#l10.1099"></a><span id="l10.1099" class="difflineplus">+  return num;</span>
<a href="#l10.1100"></a><span id="l10.1100"> }</span>
<a href="#l10.1101"></a><span id="l10.1101"> </span>
<a href="#l10.1102"></a><span id="l10.1102" class="difflineminus">-int nsEudoraMailbox::IsWeekDayStr( const char *pStr)</span>
<a href="#l10.1103"></a><span id="l10.1103" class="difflineplus">+int nsEudoraMailbox::IsWeekDayStr(const char *pStr)</span>
<a href="#l10.1104"></a><span id="l10.1104"> {</span>
<a href="#l10.1105"></a><span id="l10.1105">   for (int i = 0; i &lt; 7; i++) {</span>
<a href="#l10.1106"></a><span id="l10.1106" class="difflineminus">-    if (!PL_strncasecmp( pStr, eudoraWeekDays[i], 3))</span>
<a href="#l10.1107"></a><span id="l10.1107" class="difflineminus">-      return( i + 1);</span>
<a href="#l10.1108"></a><span id="l10.1108" class="difflineplus">+    if (!PL_strncasecmp(pStr, eudoraWeekDays[i], 3))</span>
<a href="#l10.1109"></a><span id="l10.1109" class="difflineplus">+      return i + 1;</span>
<a href="#l10.1110"></a><span id="l10.1110">   }</span>
<a href="#l10.1111"></a><span id="l10.1111" class="difflineminus">-  return( 0);</span>
<a href="#l10.1112"></a><span id="l10.1112" class="difflineplus">+  return 0;</span>
<a href="#l10.1113"></a><span id="l10.1113"> }</span>
<a href="#l10.1114"></a><span id="l10.1114"> </span>
<a href="#l10.1115"></a><span id="l10.1115" class="difflineminus">-int nsEudoraMailbox::IsMonthStr( const char *pStr)</span>
<a href="#l10.1116"></a><span id="l10.1116" class="difflineplus">+int nsEudoraMailbox::IsMonthStr(const char *pStr)</span>
<a href="#l10.1117"></a><span id="l10.1117"> {</span>
<a href="#l10.1118"></a><span id="l10.1118">   for (int i = 0; i &lt; 12; i++) {</span>
<a href="#l10.1119"></a><span id="l10.1119" class="difflineminus">-    if (!PL_strncasecmp( pStr, eudoraMonths[i], 3))</span>
<a href="#l10.1120"></a><span id="l10.1120" class="difflineminus">-      return( i + 1);</span>
<a href="#l10.1121"></a><span id="l10.1121" class="difflineplus">+    if (!PL_strncasecmp(pStr, eudoraMonths[i], 3))</span>
<a href="#l10.1122"></a><span id="l10.1122" class="difflineplus">+      return i + 1;</span>
<a href="#l10.1123"></a><span id="l10.1123">   }</span>
<a href="#l10.1124"></a><span id="l10.1124" class="difflineminus">-  return( 0);</span>
<a href="#l10.1125"></a><span id="l10.1125" class="difflineplus">+  return 0;</span>
<a href="#l10.1126"></a><span id="l10.1126"> }</span>
<a href="#l10.1127"></a><span id="l10.1127"> </span>
<a href="#l10.1128"></a><span id="l10.1128" class="difflineminus">-nsresult nsEudoraMailbox::WriteFromSep( nsIOutputStream *pDst)</span>
<a href="#l10.1129"></a><span id="l10.1129" class="difflineplus">+nsresult nsEudoraMailbox::WriteFromSep(nsIOutputStream *pDst)</span>
<a href="#l10.1130"></a><span id="l10.1130"> {</span>
<a href="#l10.1131"></a><span id="l10.1131">   if (!m_fromLen)</span>
<a href="#l10.1132"></a><span id="l10.1132" class="difflineminus">-    m_fromLen = strlen( eudoraFromLine);</span>
<a href="#l10.1133"></a><span id="l10.1133" class="difflineplus">+    m_fromLen = strlen(eudoraFromLine);</span>
<a href="#l10.1134"></a><span id="l10.1134">   PRUint32  written = 0;</span>
<a href="#l10.1135"></a><span id="l10.1135" class="difflineminus">-  nsresult rv = pDst-&gt;Write( eudoraFromLine, m_fromLen, &amp;written);</span>
<a href="#l10.1136"></a><span id="l10.1136" class="difflineminus">-  if (NS_SUCCEEDED( rv) &amp;&amp; (written != m_fromLen))</span>
<a href="#l10.1137"></a><span id="l10.1137" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l10.1138"></a><span id="l10.1138" class="difflineminus">-  return( rv);</span>
<a href="#l10.1139"></a><span id="l10.1139" class="difflineplus">+  nsresult rv = pDst-&gt;Write(eudoraFromLine, m_fromLen, &amp;written);</span>
<a href="#l10.1140"></a><span id="l10.1140" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; (written != m_fromLen))</span>
<a href="#l10.1141"></a><span id="l10.1141" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l10.1142"></a><span id="l10.1142" class="difflineplus">+  return rv;</span>
<a href="#l10.1143"></a><span id="l10.1143"> }</span>
<a href="#l10.1144"></a><span id="l10.1144"> </span>
<a href="#l10.1145"></a><span id="l10.1145" class="difflineminus">-void nsEudoraMailbox::EmptyAttachments( void)</span>
<a href="#l10.1146"></a><span id="l10.1146" class="difflineplus">+void nsEudoraMailbox::EmptyAttachments(void)</span>
<a href="#l10.1147"></a><span id="l10.1147"> {</span>
<a href="#l10.1148"></a><span id="l10.1148">   PRInt32 max = m_attachments.Count();</span>
<a href="#l10.1149"></a><span id="l10.1149">   ImportAttachment *  pAttach;</span>
<a href="#l10.1150"></a><span id="l10.1150">   for (PRInt32 i = 0; i &lt; max; i++) {</span>
<a href="#l10.1151"></a><span id="l10.1151" class="difflineminus">-    pAttach = (ImportAttachment *) m_attachments.ElementAt( i);</span>
<a href="#l10.1152"></a><span id="l10.1152" class="difflineplus">+    pAttach = (ImportAttachment *) m_attachments.ElementAt(i);</span>
<a href="#l10.1153"></a><span id="l10.1153">     if (pAttach) {</span>
<a href="#l10.1154"></a><span id="l10.1154" class="difflineminus">-      NS_Free( pAttach-&gt;description);</span>
<a href="#l10.1155"></a><span id="l10.1155" class="difflineminus">-      NS_Free( pAttach-&gt;mimeType);</span>
<a href="#l10.1156"></a><span id="l10.1156" class="difflineplus">+      NS_Free(pAttach-&gt;description);</span>
<a href="#l10.1157"></a><span id="l10.1157" class="difflineplus">+      NS_Free(pAttach-&gt;mimeType);</span>
<a href="#l10.1158"></a><span id="l10.1158">       delete pAttach;</span>
<a href="#l10.1159"></a><span id="l10.1159">     }</span>
<a href="#l10.1160"></a><span id="l10.1160">   }</span>
<a href="#l10.1161"></a><span id="l10.1161"> </span>
<a href="#l10.1162"></a><span id="l10.1162">   m_attachments.Clear();</span>
<a href="#l10.1163"></a><span id="l10.1163"> }</span>
<a href="#l10.1164"></a><span id="l10.1164"> </span>
<a href="#l10.1165"></a><span id="l10.1165"> static const char *eudoraAttachLines[] = {</span>
<a href="#l10.1166"></a><span id="l10.1166" class="difflineat">@@ -1234,30 +1227,30 @@ static const char *eudoraAttachLines[] =</span>
<a href="#l10.1167"></a><span id="l10.1167"> static PRInt32 eudoraAttachLen[] = {</span>
<a href="#l10.1168"></a><span id="l10.1168">   21,</span>
<a href="#l10.1169"></a><span id="l10.1169">   21,</span>
<a href="#l10.1170"></a><span id="l10.1170">   24,</span>
<a href="#l10.1171"></a><span id="l10.1171">   24,</span>
<a href="#l10.1172"></a><span id="l10.1172">   0</span>
<a href="#l10.1173"></a><span id="l10.1173"> };</span>
<a href="#l10.1174"></a><span id="l10.1174"> </span>
<a href="#l10.1175"></a><span id="l10.1175" class="difflineminus">-nsresult nsEudoraMailbox::ExamineAttachment( SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l10.1176"></a><span id="l10.1176" class="difflineplus">+nsresult nsEudoraMailbox::ExamineAttachment(SimpleBufferTonyRCopiedOnce&amp; data)</span>
<a href="#l10.1177"></a><span id="l10.1177"> {</span>
<a href="#l10.1178"></a><span id="l10.1178">   // get the file, then get the mime type, and add it to the array</span>
<a href="#l10.1179"></a><span id="l10.1179">   // of attachments.</span>
<a href="#l10.1180"></a><span id="l10.1180">   PRInt32    len = data.m_bytesInBuf - data.m_writeOffset;</span>
<a href="#l10.1181"></a><span id="l10.1181">   const char *pChar = data.m_pBuffer + data.m_writeOffset;</span>
<a href="#l10.1182"></a><span id="l10.1182">   const char *pData;</span>
<a href="#l10.1183"></a><span id="l10.1183">   const char *pStart;</span>
<a href="#l10.1184"></a><span id="l10.1184">   PRInt32  nameLen;</span>
<a href="#l10.1185"></a><span id="l10.1185">   char  quote;</span>
<a href="#l10.1186"></a><span id="l10.1186">   PRInt32  cnt;</span>
<a href="#l10.1187"></a><span id="l10.1187">   PRInt32  idx = 0;</span>
<a href="#l10.1188"></a><span id="l10.1188">   while ((cnt = eudoraAttachLen[idx]) != 0) {</span>
<a href="#l10.1189"></a><span id="l10.1189" class="difflineminus">-    if (!strncmp( eudoraAttachLines[idx], pChar, cnt)) {</span>
<a href="#l10.1190"></a><span id="l10.1190" class="difflineplus">+    if (!strncmp(eudoraAttachLines[idx], pChar, cnt)) {</span>
<a href="#l10.1191"></a><span id="l10.1191">       pData = pChar + cnt;</span>
<a href="#l10.1192"></a><span id="l10.1192">       while (((*pData == ' ') || (*pData == '\t')) &amp;&amp; (cnt &lt; len)) {</span>
<a href="#l10.1193"></a><span id="l10.1193">         cnt++;</span>
<a href="#l10.1194"></a><span id="l10.1194">         pData++;</span>
<a href="#l10.1195"></a><span id="l10.1195">       }</span>
<a href="#l10.1196"></a><span id="l10.1196">       if (pData != pChar) {</span>
<a href="#l10.1197"></a><span id="l10.1197">         quote = *pData;</span>
<a href="#l10.1198"></a><span id="l10.1198">         nameLen = 0;</span>
<a href="#l10.1199"></a><span id="l10.1199" class="difflineat">@@ -1277,77 +1270,79 @@ nsresult nsEudoraMailbox::ExamineAttachm</span>
<a href="#l10.1200"></a><span id="l10.1200">           while ((cnt &lt; len) &amp;&amp;</span>
<a href="#l10.1201"></a><span id="l10.1201">                  (*pData != nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF)) {</span>
<a href="#l10.1202"></a><span id="l10.1202">             pData++;</span>
<a href="#l10.1203"></a><span id="l10.1203">             cnt++;</span>
<a href="#l10.1204"></a><span id="l10.1204">             nameLen++;</span>
<a href="#l10.1205"></a><span id="l10.1205">           }</span>
<a href="#l10.1206"></a><span id="l10.1206">         }</span>
<a href="#l10.1207"></a><span id="l10.1207">         nsCString  fileName;</span>
<a href="#l10.1208"></a><span id="l10.1208" class="difflineminus">-        fileName.Append( pStart, nameLen);</span>
<a href="#l10.1209"></a><span id="l10.1209" class="difflineminus">-        fileName.Trim( kWhitespace);</span>
<a href="#l10.1210"></a><span id="l10.1210" class="difflineplus">+        fileName.Append(pStart, nameLen);</span>
<a href="#l10.1211"></a><span id="l10.1211" class="difflineplus">+        fileName.Trim(kWhitespace);</span>
<a href="#l10.1212"></a><span id="l10.1212">         if (fileName.Length()) {</span>
<a href="#l10.1213"></a><span id="l10.1213"> #ifdef XP_MACOSX</span>
<a href="#l10.1214"></a><span id="l10.1214">           return NS_OK;</span>
<a href="#l10.1215"></a><span id="l10.1215"> #else</span>
<a href="#l10.1216"></a><span id="l10.1216" class="difflineminus">-          if( AddAttachment( fileName))</span>
<a href="#l10.1217"></a><span id="l10.1217" class="difflineminus">-            return( NS_OK);</span>
<a href="#l10.1218"></a><span id="l10.1218" class="difflineplus">+          if(AddAttachment(fileName))</span>
<a href="#l10.1219"></a><span id="l10.1219" class="difflineplus">+            return NS_OK;</span>
<a href="#l10.1220"></a><span id="l10.1220"> #endif</span>
<a href="#l10.1221"></a><span id="l10.1221">         }</span>
<a href="#l10.1222"></a><span id="l10.1222">       }</span>
<a href="#l10.1223"></a><span id="l10.1223">     }</span>
<a href="#l10.1224"></a><span id="l10.1224">     idx++;</span>
<a href="#l10.1225"></a><span id="l10.1225">   }</span>
<a href="#l10.1226"></a><span id="l10.1226"> </span>
<a href="#l10.1227"></a><span id="l10.1227" class="difflineminus">-  return( NS_OK);</span>
<a href="#l10.1228"></a><span id="l10.1228" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.1229"></a><span id="l10.1229"> }</span>
<a href="#l10.1230"></a><span id="l10.1230"> </span>
<a href="#l10.1231"></a><span id="l10.1231" class="difflineminus">-bool nsEudoraMailbox::AddAttachment( nsCString&amp; fileName)</span>
<a href="#l10.1232"></a><span id="l10.1232" class="difflineplus">+bool nsEudoraMailbox::AddAttachment(nsCString&amp; fileName)</span>
<a href="#l10.1233"></a><span id="l10.1233"> {</span>
<a href="#l10.1234"></a><span id="l10.1234" class="difflineminus">-  IMPORT_LOG1( &quot;Found attachment: %s\n&quot;, fileName.get());</span>
<a href="#l10.1235"></a><span id="l10.1235" class="difflineplus">+  IMPORT_LOG1(&quot;Found attachment: %s\n&quot;, fileName.get());</span>
<a href="#l10.1236"></a><span id="l10.1236"> </span>
<a href="#l10.1237"></a><span id="l10.1237">   nsresult rv;</span>
<a href="#l10.1238"></a><span id="l10.1238">   nsCOMPtr &lt;nsILocalFile&gt;  pFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l10.1239"></a><span id="l10.1239" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l10.1240"></a><span id="l10.1240" class="difflineminus">-    return( false);</span>
<a href="#l10.1241"></a><span id="l10.1241" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l10.1242"></a><span id="l10.1242" class="difflineplus">+    return false;</span>
<a href="#l10.1243"></a><span id="l10.1243"> </span>
<a href="#l10.1244"></a><span id="l10.1244">   nsCString mimeType;</span>
<a href="#l10.1245"></a><span id="l10.1245">   nsCString attachmentName;</span>
<a href="#l10.1246"></a><span id="l10.1246" class="difflineminus">-  if (NS_FAILED( GetAttachmentInfo( fileName.get(), pFile, mimeType, attachmentName)))</span>
<a href="#l10.1247"></a><span id="l10.1247" class="difflineminus">-    return( false);</span>
<a href="#l10.1248"></a><span id="l10.1248" class="difflineplus">+  if (NS_FAILED(GetAttachmentInfo(fileName.get(), pFile, mimeType, attachmentName)))</span>
<a href="#l10.1249"></a><span id="l10.1249" class="difflineplus">+    return false;</span>
<a href="#l10.1250"></a><span id="l10.1250"> </span>
<a href="#l10.1251"></a><span id="l10.1251">   ImportAttachment *a = new ImportAttachment;</span>
<a href="#l10.1252"></a><span id="l10.1252">   a-&gt;mimeType = ToNewCString(mimeType);</span>
<a href="#l10.1253"></a><span id="l10.1253" class="difflineminus">-  a-&gt;description = !attachmentName.IsEmpty() ? ToNewCString(attachmentName) : strdup( &quot;Attached File&quot;);</span>
<a href="#l10.1254"></a><span id="l10.1254" class="difflineplus">+  a-&gt;description = !attachmentName.IsEmpty() ? ToNewCString(attachmentName) : strdup(&quot;Attached File&quot;);</span>
<a href="#l10.1255"></a><span id="l10.1255">   a-&gt;pAttachment = pFile;</span>
<a href="#l10.1256"></a><span id="l10.1256"> </span>
<a href="#l10.1257"></a><span id="l10.1257" class="difflineminus">-  m_attachments.AppendElement( a);</span>
<a href="#l10.1258"></a><span id="l10.1258" class="difflineplus">+  m_attachments.AppendElement(a);</span>
<a href="#l10.1259"></a><span id="l10.1259"> </span>
<a href="#l10.1260"></a><span id="l10.1260" class="difflineminus">-  return( true);</span>
<a href="#l10.1261"></a><span id="l10.1261" class="difflineplus">+  return true;</span>
<a href="#l10.1262"></a><span id="l10.1262"> }</span>
<a href="#l10.1263"></a><span id="l10.1263"> </span>
<a href="#l10.1264"></a><span id="l10.1264" class="difflineminus">-nsresult nsEudoraMailbox::FillMailBuffer( ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; read)</span>
<a href="#l10.1265"></a><span id="l10.1265" class="difflineplus">+nsresult nsEudoraMailbox::FillMailBuffer(ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; read)</span>
<a href="#l10.1266"></a><span id="l10.1266"> {</span>
<a href="#l10.1267"></a><span id="l10.1267">   if (read.m_writeOffset &gt;= read.m_bytesInBuf) {</span>
<a href="#l10.1268"></a><span id="l10.1268">     read.m_writeOffset = 0;</span>
<a href="#l10.1269"></a><span id="l10.1269">     read.m_bytesInBuf = 0;</span>
<a href="#l10.1270"></a><span id="l10.1270">   }</span>
<a href="#l10.1271"></a><span id="l10.1271">   else if (read.m_writeOffset) {</span>
<a href="#l10.1272"></a><span id="l10.1272" class="difflineminus">-    memcpy( read.m_pBuffer, read.m_pBuffer + read.m_writeOffset, read.m_bytesInBuf - read.m_writeOffset);</span>
<a href="#l10.1273"></a><span id="l10.1273" class="difflineplus">+    memcpy(read.m_pBuffer, read.m_pBuffer + read.m_writeOffset, read.m_bytesInBuf - read.m_writeOffset);</span>
<a href="#l10.1274"></a><span id="l10.1274">     read.m_bytesInBuf -= read.m_writeOffset;</span>
<a href="#l10.1275"></a><span id="l10.1275">     read.m_writeOffset = 0;</span>
<a href="#l10.1276"></a><span id="l10.1276">   }</span>
<a href="#l10.1277"></a><span id="l10.1277"> </span>
<a href="#l10.1278"></a><span id="l10.1278">   PRUint32  count = read.m_size - read.m_bytesInBuf;</span>
<a href="#l10.1279"></a><span id="l10.1279">   if ((count + pState-&gt;offset) &gt; pState-&gt;size)</span>
<a href="#l10.1280"></a><span id="l10.1280">     count = pState-&gt;size - pState-&gt;offset;</span>
<a href="#l10.1281"></a><span id="l10.1281">   if (count) {</span>
<a href="#l10.1282"></a><span id="l10.1282">     PRUint32    bytesRead = 0;</span>
<a href="#l10.1283"></a><span id="l10.1283">     char *    pBuffer = read.m_pBuffer + read.m_bytesInBuf;</span>
<a href="#l10.1284"></a><span id="l10.1284">     nsresult  rv = pState-&gt;pInputStream-&gt;Read(pBuffer, count, &amp;bytesRead);</span>
<a href="#l10.1285"></a><span id="l10.1285" class="difflineminus">-    if (NS_FAILED( rv)) return( rv);</span>
<a href="#l10.1286"></a><span id="l10.1286" class="difflineminus">-    if (bytesRead != PRUint32(count)) return( NS_ERROR_FAILURE);</span>
<a href="#l10.1287"></a><span id="l10.1287" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l10.1288"></a><span id="l10.1288" class="difflineplus">+      return rv;</span>
<a href="#l10.1289"></a><span id="l10.1289" class="difflineplus">+    if (bytesRead != PRUint32(count))</span>
<a href="#l10.1290"></a><span id="l10.1290" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l10.1291"></a><span id="l10.1291">     read.m_bytesInBuf += bytesRead;</span>
<a href="#l10.1292"></a><span id="l10.1292">     pState-&gt;offset += bytesRead;</span>
<a href="#l10.1293"></a><span id="l10.1293">   }</span>
<a href="#l10.1294"></a><span id="l10.1294"> </span>
<a href="#l10.1295"></a><span id="l10.1295" class="difflineminus">-  return( NS_OK);</span>
<a href="#l10.1296"></a><span id="l10.1296" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.1297"></a><span id="l10.1297"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraMailbox.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraMailbox.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -166,56 +166,56 @@ public:</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5"> class nsEudoraMailbox {</span>
<a href="#l11.6"></a><span id="l11.6"> public:</span>
<a href="#l11.7"></a><span id="l11.7">   nsEudoraMailbox();</span>
<a href="#l11.8"></a><span id="l11.8">   virtual ~nsEudoraMailbox();</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10">   // Things that must be overridden because they are platform specific.</span>
<a href="#l11.11"></a><span id="l11.11">     // retrieve the mail folder</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  virtual bool      FindMailFolder( nsIFile **pFolder) { return( false);}</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  virtual bool      FindMailFolder(nsIFile **pFolder) { return false;}</span>
<a href="#l11.14"></a><span id="l11.14">     // get the list of mailboxes</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-  virtual nsresult  FindMailboxes( nsIFile *pRoot, nsISupportsArray **ppArray) { return( NS_ERROR_FAILURE);}</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+  virtual nsresult  FindMailboxes(nsIFile *pRoot, nsISupportsArray **ppArray) { return NS_ERROR_FAILURE;}</span>
<a href="#l11.17"></a><span id="l11.17">     // get the toc file corresponding to this mailbox</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-  virtual nsresult  FindTOCFile( nsIFile *pMailFile, nsIFile **pTOCFile, bool *pDeleteToc) { return( NS_ERROR_FAILURE);}</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+  virtual nsresult  FindTOCFile(nsIFile *pMailFile, nsIFile **pTOCFile, bool *pDeleteToc) { return NS_ERROR_FAILURE;}</span>
<a href="#l11.20"></a><span id="l11.20">     // interpret the attachment line and return the attached file</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-  virtual nsresult  GetAttachmentInfo( const char *pFileName, nsIFile *pFile, nsCString&amp; mimeType, nsCString&amp; aAttachment) { return( NS_ERROR_FAILURE);}</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+  virtual nsresult  GetAttachmentInfo(const char *pFileName, nsIFile *pFile, nsCString&amp; mimeType, nsCString&amp; aAttachment) { return NS_ERROR_FAILURE;}</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24">   // Non-platform specific common stuff</span>
<a href="#l11.25"></a><span id="l11.25">     // import a mailbox</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-  nsresult ImportMailbox( PRUint32 *pBytes, bool *pAbort, const PRUnichar *pName, nsIFile *pSrc, nsIFile *pDst, PRInt32 *pMsgCount);</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+  nsresult ImportMailbox(PRUint32 *pBytes, bool *pAbort, const PRUnichar *pName, nsIFile *pSrc, nsIFile *pDst, PRInt32 *pMsgCount);</span>
<a href="#l11.28"></a><span id="l11.28"> </span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-  static PRInt32    IsEudoraFromSeparator( const char *pData, PRInt32 maxLen, nsCString&amp; defaultDate);</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-  static bool      IsEudoraTag( const char *pChar, PRInt32 maxLen, bool &amp;insideEudoraTags, nsCString &amp;bodyType, PRInt32&amp; tagLength);</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+  static PRInt32    IsEudoraFromSeparator(const char *pData, PRInt32 maxLen, nsCString&amp; defaultDate);</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+  static bool      IsEudoraTag(const char *pChar, PRInt32 maxLen, bool &amp;insideEudoraTags, nsCString &amp;bodyType, PRInt32&amp; tagLength);</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34"> protected:</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-  nsresult  CreateTempFile( nsIFile **ppFile);</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-  nsresult  DeleteFile( nsIFile *pFile);</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+  nsresult  CreateTempFile(nsIFile **ppFile);</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+  nsresult  DeleteFile(nsIFile *pFile);</span>
<a href="#l11.39"></a><span id="l11.39"> </span>
<a href="#l11.40"></a><span id="l11.40"> </span>
<a href="#l11.41"></a><span id="l11.41"> private:</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-   nsresult  ImportMailboxUsingTOC( PRUint32 *pBytes, bool *pAbort, nsIInputStream *pInputStream, nsIFile *tocFile, nsIOutputStream *pDst, PRInt32 *pMsgCount);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+   nsresult  ImportMailboxUsingTOC(PRUint32 *pBytes, bool *pAbort, nsIInputStream *pInputStream, nsIFile *tocFile, nsIOutputStream *pDst, PRInt32 *pMsgCount);</span>
<a href="#l11.44"></a><span id="l11.44">    nsresult  ReadTOCEntry(nsIInputStream *pToc, EudoraTOCEntry&amp; tocEntry);</span>
<a href="#l11.45"></a><span id="l11.45">    nsresult  ImportMessage(SimpleBufferTonyRCopiedOnce&amp; headers, SimpleBufferTonyRCopiedOnce&amp; body, nsCString&amp; defaultDate, nsCAutoString&amp; bodyType, nsIOutputStream *pDst, PRInt32 *pMsgCount);</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-   nsresult  ReadNextMessage( ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; copy, SimpleBufferTonyRCopiedOnce&amp; header,</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+   nsresult  ReadNextMessage(ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; copy, SimpleBufferTonyRCopiedOnce&amp; header,</span>
<a href="#l11.48"></a><span id="l11.48">                                         SimpleBufferTonyRCopiedOnce&amp; body, nsCString&amp; defaultDate,</span>
<a href="#l11.49"></a><span id="l11.49">                                         nsCString &amp;defBodyType, EudoraTOCEntry *pTocEntry);</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-  PRInt32    FindStartLine( SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-  PRInt32    FindNextEndLine( SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-  PRInt32    IsEndHeaders( SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-  nsresult  WriteFromSep( nsIOutputStream *pDst);</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-  nsresult  FillMailBuffer( ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; read);</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+  PRInt32    FindStartLine(SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+  PRInt32    FindNextEndLine(SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+  PRInt32    IsEndHeaders(SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+  nsresult  WriteFromSep(nsIOutputStream *pDst);</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+  nsresult  FillMailBuffer(ReadFileState *pState, SimpleBufferTonyRCopiedOnce&amp; read);</span>
<a href="#l11.60"></a><span id="l11.60"> </span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-  void    EmptyAttachments( void);</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-  nsresult  ExamineAttachment( SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-  bool      AddAttachment( nsCString&amp; fileName);</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+  void    EmptyAttachments(void);</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+  nsresult  ExamineAttachment(SimpleBufferTonyRCopiedOnce&amp; data);</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+  bool      AddAttachment(nsCString&amp; fileName);</span>
<a href="#l11.67"></a><span id="l11.67"> </span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-  static PRInt32    AsciiToLong( const char *pChar, PRInt32 len);</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-  static int      IsWeekDayStr( const char *pStr);</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-  static int      IsMonthStr( const char *pStr);</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+  static PRInt32    AsciiToLong(const char *pChar, PRInt32 len);</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+  static int      IsWeekDayStr(const char *pStr);</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+  static int      IsMonthStr(const char *pStr);</span>
<a href="#l11.74"></a><span id="l11.74"> </span>
<a href="#l11.75"></a><span id="l11.75"> protected:</span>
<a href="#l11.76"></a><span id="l11.76">   nsCOMPtr &lt;nsILocalFile&gt;    m_mailImportLocation;</span>
<a href="#l11.77"></a><span id="l11.77"> </span>
<a href="#l11.78"></a><span id="l11.78"> private:</span>
<a href="#l11.79"></a><span id="l11.79">   PRInt64    m_mailSize;</span>
<a href="#l11.80"></a><span id="l11.80">   PRUint32      m_fromLen;</span>
<a href="#l11.81"></a><span id="l11.81">   nsVoidArray    m_attachments;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraSettings.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraSettings.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -82,76 +82,76 @@ nsEudoraSettings::~nsEudoraSettings()</span>
<a href="#l12.4"></a><span id="l12.4"> NS_IMPL_ISUPPORTS1(nsEudoraSettings, nsIImportSettings)</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> NS_IMETHODIMP nsEudoraSettings::AutoLocate(PRUnichar **description, nsIFile **location, bool *_retval)</span>
<a href="#l12.7"></a><span id="l12.7"> {</span>
<a href="#l12.8"></a><span id="l12.8">     NS_PRECONDITION(description != nsnull, &quot;null ptr&quot;);</span>
<a href="#l12.9"></a><span id="l12.9">     NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l12.10"></a><span id="l12.10">     NS_PRECONDITION(location != nsnull, &quot;null ptr&quot;);</span>
<a href="#l12.11"></a><span id="l12.11">   if (!description || !_retval || !location)</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    return( NS_ERROR_NULL_POINTER);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15">   *description = nsnull;</span>
<a href="#l12.16"></a><span id="l12.16">   *_retval = false;</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18">   nsresult  rv;</span>
<a href="#l12.19"></a><span id="l12.19">         m_pLocation =  do_CreateInstance (NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l12.20"></a><span id="l12.20">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-  *description = nsEudoraStringBundle::GetStringByID( EUDORAIMPORT_NAME);</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+  *description = nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_NAME);</span>
<a href="#l12.23"></a><span id="l12.23"> </span>
<a href="#l12.24"></a><span id="l12.24"> #if defined(XP_WIN) || defined(XP_OS2)</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-  *_retval = nsEudoraWin32::FindSettingsFile( getter_AddRefs(m_pLocation));</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+  *_retval = nsEudoraWin32::FindSettingsFile(getter_AddRefs(m_pLocation));</span>
<a href="#l12.27"></a><span id="l12.27"> #endif</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29">   NS_IF_ADDREF(*location = m_pLocation);</span>
<a href="#l12.30"></a><span id="l12.30">   return NS_OK;</span>
<a href="#l12.31"></a><span id="l12.31"> }</span>
<a href="#l12.32"></a><span id="l12.32"> </span>
<a href="#l12.33"></a><span id="l12.33"> NS_IMETHODIMP nsEudoraSettings::SetLocation(nsIFile *location)</span>
<a href="#l12.34"></a><span id="l12.34"> {</span>
<a href="#l12.35"></a><span id="l12.35">   m_pLocation = location;</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-  return( NS_OK);</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.38"></a><span id="l12.38"> }</span>
<a href="#l12.39"></a><span id="l12.39"> </span>
<a href="#l12.40"></a><span id="l12.40"> NS_IMETHODIMP nsEudoraSettings::Import(nsIMsgAccount **localMailAccount, bool *_retval)</span>
<a href="#l12.41"></a><span id="l12.41"> {</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-  NS_PRECONDITION( _retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+  NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l12.44"></a><span id="l12.44"> </span>
<a href="#l12.45"></a><span id="l12.45">   *_retval = false;</span>
<a href="#l12.46"></a><span id="l12.46"> </span>
<a href="#l12.47"></a><span id="l12.47">   // Get the settings file if it doesn't exist</span>
<a href="#l12.48"></a><span id="l12.48">   if (!m_pLocation) {</span>
<a href="#l12.49"></a><span id="l12.49"> #if defined(XP_WIN) || defined(XP_OS2)</span>
<a href="#l12.50"></a><span id="l12.50">     nsresult  rv;</span>
<a href="#l12.51"></a><span id="l12.51">                 m_pLocation =  do_CreateInstance (NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l12.52"></a><span id="l12.52">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.53"></a><span id="l12.53">       if (!nsEudoraWin32::FindSettingsFile(getter_AddRefs(m_pLocation))) {</span>
<a href="#l12.54"></a><span id="l12.54">         m_pLocation = nsnull;</span>
<a href="#l12.55"></a><span id="l12.55">       }</span>
<a href="#l12.56"></a><span id="l12.56">     }</span>
<a href="#l12.57"></a><span id="l12.57"> #endif</span>
<a href="#l12.58"></a><span id="l12.58"> #ifdef XP_MACOSX</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-                nsEudoraMac::FindSettingsFile( getter_AddRefs(m_pLocation));</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+                nsEudoraMac::FindSettingsFile(getter_AddRefs(m_pLocation));</span>
<a href="#l12.61"></a><span id="l12.61"> #endif</span>
<a href="#l12.62"></a><span id="l12.62">   }</span>
<a href="#l12.63"></a><span id="l12.63"> </span>
<a href="#l12.64"></a><span id="l12.64">   if (!m_pLocation) {</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error, unable to locate settings file for import.\n&quot;);</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error, unable to locate settings file for import.\n&quot;);</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l12.69"></a><span id="l12.69">   }</span>
<a href="#l12.70"></a><span id="l12.70"> </span>
<a href="#l12.71"></a><span id="l12.71">   // do the settings import</span>
<a href="#l12.72"></a><span id="l12.72"> #if defined(XP_WIN) || defined(XP_OS2)</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-  *_retval = nsEudoraWin32::ImportSettings( m_pLocation, localMailAccount);</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+  *_retval = nsEudoraWin32::ImportSettings(m_pLocation, localMailAccount);</span>
<a href="#l12.75"></a><span id="l12.75"> #endif</span>
<a href="#l12.76"></a><span id="l12.76"> #ifdef XP_MACOSX</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-  *_retval = nsEudoraMac::ImportSettings( m_pLocation, localMailAccount);</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+  *_retval = nsEudoraMac::ImportSettings(m_pLocation, localMailAccount);</span>
<a href="#l12.79"></a><span id="l12.79"> #endif</span>
<a href="#l12.80"></a><span id="l12.80"> </span>
<a href="#l12.81"></a><span id="l12.81">   if (*_retval) {</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineminus">-    IMPORT_LOG0( &quot;Successful import of eudora settings\n&quot;);</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+    IMPORT_LOG0(&quot;Successful import of eudora settings\n&quot;);</span>
<a href="#l12.84"></a><span id="l12.84">   }</span>
<a href="#l12.85"></a><span id="l12.85">   else {</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error, Unsuccessful import of eudora settings\n&quot;);</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error, Unsuccessful import of eudora settings\n&quot;);</span>
<a href="#l12.88"></a><span id="l12.88">   }</span>
<a href="#l12.89"></a><span id="l12.89"> </span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-  return( NS_OK);</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.92"></a><span id="l12.92"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraStringBundle.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraStringBundle.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -46,53 +46,53 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;nsIURI.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> #define EUDORA_MSGS_URL       &quot;chrome://messenger/locale/eudoraImportMsgs.properties&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> nsIStringBundle *  nsEudoraStringBundle::m_pBundle = nsnull;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-nsIStringBundle *nsEudoraStringBundle::GetStringBundle( void)</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+nsIStringBundle *nsEudoraStringBundle::GetStringBundle(void)</span>
<a href="#l13.14"></a><span id="l13.14"> {</span>
<a href="#l13.15"></a><span id="l13.15">   if (m_pBundle)</span>
<a href="#l13.16"></a><span id="l13.16">     return m_pBundle;</span>
<a href="#l13.17"></a><span id="l13.17"> </span>
<a href="#l13.18"></a><span id="l13.18">   const char*       propertyURL = EUDORA_MSGS_URL;</span>
<a href="#l13.19"></a><span id="l13.19">   nsIStringBundle*  sBundle = nsnull;</span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21">   nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l13.22"></a><span id="l13.22">     mozilla::services::GetStringBundleService();</span>
<a href="#l13.23"></a><span id="l13.23">   if (sBundleService)</span>
<a href="#l13.24"></a><span id="l13.24">     sBundleService-&gt;CreateBundle(propertyURL, &amp;sBundle);</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26">   m_pBundle = sBundle;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-  return( sBundle);</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+  return sBundle;</span>
<a href="#l13.29"></a><span id="l13.29"> }</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-void nsEudoraStringBundle::GetStringByID( PRInt32 stringID, nsString&amp; result)</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+void nsEudoraStringBundle::GetStringByID(PRInt32 stringID, nsString&amp; result)</span>
<a href="#l13.33"></a><span id="l13.33"> {</span>
<a href="#l13.34"></a><span id="l13.34"> </span>
<a href="#l13.35"></a><span id="l13.35">   PRUnichar *ptrv = GetStringByID(stringID);</span>
<a href="#l13.36"></a><span id="l13.36">   result = ptrv;</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-  FreeString( ptrv);</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+  FreeString(ptrv);</span>
<a href="#l13.39"></a><span id="l13.39"> }</span>
<a href="#l13.40"></a><span id="l13.40"> </span>
<a href="#l13.41"></a><span id="l13.41"> PRUnichar *nsEudoraStringBundle::GetStringByID(PRInt32 stringID)</span>
<a href="#l13.42"></a><span id="l13.42"> {</span>
<a href="#l13.43"></a><span id="l13.43">   if (!m_pBundle)</span>
<a href="#l13.44"></a><span id="l13.44">     m_pBundle = GetStringBundle();</span>
<a href="#l13.45"></a><span id="l13.45"> </span>
<a href="#l13.46"></a><span id="l13.46">   if (m_pBundle)</span>
<a href="#l13.47"></a><span id="l13.47">   {</span>
<a href="#l13.48"></a><span id="l13.48">     PRUnichar *ptrv = nsnull;</span>
<a href="#l13.49"></a><span id="l13.49">     nsresult rv = m_pBundle-&gt;GetStringFromID(stringID, &amp;ptrv);</span>
<a href="#l13.50"></a><span id="l13.50"> </span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; ptrv)</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-      return( ptrv);</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; ptrv)</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+      return ptrv;</span>
<a href="#l13.55"></a><span id="l13.55">   }</span>
<a href="#l13.56"></a><span id="l13.56"> </span>
<a href="#l13.57"></a><span id="l13.57">   nsString resultString(NS_LITERAL_STRING(&quot;[StringID &quot;));</span>
<a href="#l13.58"></a><span id="l13.58">   resultString.AppendInt(stringID);</span>
<a href="#l13.59"></a><span id="l13.59">   resultString.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l13.60"></a><span id="l13.60"> </span>
<a href="#l13.61"></a><span id="l13.61">   return ToNewUnicode(resultString);</span>
<a href="#l13.62"></a><span id="l13.62"> }</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineat">@@ -110,14 +110,14 @@ nsString nsEudoraStringBundle::FormatStr</span>
<a href="#l13.64"></a><span id="l13.64">   PRUnichar *pText = nsTextFormatter::vsmprintf(format.get(), args);</span>
<a href="#l13.65"></a><span id="l13.65">   va_end(args);</span>
<a href="#l13.66"></a><span id="l13.66"> </span>
<a href="#l13.67"></a><span id="l13.67">   nsString result(pText);</span>
<a href="#l13.68"></a><span id="l13.68">   nsTextFormatter::smprintf_free(pText);</span>
<a href="#l13.69"></a><span id="l13.69">   return result;</span>
<a href="#l13.70"></a><span id="l13.70"> }</span>
<a href="#l13.71"></a><span id="l13.71"> </span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-void nsEudoraStringBundle::Cleanup( void)</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+void nsEudoraStringBundle::Cleanup(void)</span>
<a href="#l13.74"></a><span id="l13.74"> {</span>
<a href="#l13.75"></a><span id="l13.75">   if (m_pBundle)</span>
<a href="#l13.76"></a><span id="l13.76">     m_pBundle-&gt;Release();</span>
<a href="#l13.77"></a><span id="l13.77">   m_pBundle = nsnull;</span>
<a href="#l13.78"></a><span id="l13.78"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraStringBundle.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraStringBundle.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -43,19 +43,19 @@</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> class nsIStringBundle;</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7"> class nsEudoraStringBundle {</span>
<a href="#l14.8"></a><span id="l14.8"> public:</span>
<a href="#l14.9"></a><span id="l14.9">   static PRUnichar       *  GetStringByID(PRInt32 stringID);</span>
<a href="#l14.10"></a><span id="l14.10">   static void               GetStringByID(PRInt32 stringID, nsString&amp; result);</span>
<a href="#l14.11"></a><span id="l14.11">   static nsString           FormatString(PRInt32 stringID, ...);</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  static nsIStringBundle *  GetStringBundle( void); // don't release</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-  static void               FreeString( PRUnichar *pStr) { NS_Free( pStr);}</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-  static void               Cleanup( void);</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+  static nsIStringBundle *  GetStringBundle(void); // don't release</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+  static void               FreeString(PRUnichar *pStr) { NS_Free(pStr);}</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+  static void               Cleanup(void);</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19"> private:</span>
<a href="#l14.20"></a><span id="l14.20">   static nsIStringBundle *  m_pBundle;</span>
<a href="#l14.21"></a><span id="l14.21"> };</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23"> </span>
<a href="#l14.24"></a><span id="l14.24"> </span>
<a href="#l14.25"></a><span id="l14.25"> #define EUDORAIMPORT_NAME                               2000</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraWin32.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraWin32.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -62,216 +62,214 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #include &quot;EudoraDebugLog.h&quot;</span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;prmem.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;plstr.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> static NS_DEFINE_IID(kISupportsIID,      NS_ISUPPORTS_IID);</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10"> static const char *  kWhitespace = &quot;\b\t\r\n &quot;;</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-// ::RegOpenKeyEx( HKEY_CURRENT_USER, &quot;Software\\Accounts&quot;, 0, KEY_QUERY_VALUE | KEY_ENUMERATE_SUB_KEYS, &amp;sKey) == ERROR_SUCCESS)</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-BYTE * nsEudoraWin32::GetValueBytes( HKEY hKey, const char *pValueName)</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+BYTE * nsEudoraWin32::GetValueBytes(HKEY hKey, const char *pValueName)</span>
<a href="#l15.16"></a><span id="l15.16"> {</span>
<a href="#l15.17"></a><span id="l15.17">   LONG err;</span>
<a href="#l15.18"></a><span id="l15.18">   DWORD bufSz;</span>
<a href="#l15.19"></a><span id="l15.19">   LPBYTE pBytes = NULL;</span>
<a href="#l15.20"></a><span id="l15.20"> </span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-  err = ::RegQueryValueEx( hKey, pValueName, NULL, NULL, NULL, &amp;bufSz);</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+  err = ::RegQueryValueEx(hKey, pValueName, NULL, NULL, NULL, &amp;bufSz);</span>
<a href="#l15.23"></a><span id="l15.23">   if (err == ERROR_SUCCESS)</span>
<a href="#l15.24"></a><span id="l15.24">   {</span>
<a href="#l15.25"></a><span id="l15.25">     pBytes = new BYTE[bufSz];</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-    err = ::RegQueryValueEx( hKey, pValueName, NULL, NULL, pBytes, &amp;bufSz);</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+    err = ::RegQueryValueEx(hKey, pValueName, NULL, NULL, pBytes, &amp;bufSz);</span>
<a href="#l15.28"></a><span id="l15.28">     if (err != ERROR_SUCCESS)</span>
<a href="#l15.29"></a><span id="l15.29">     {</span>
<a href="#l15.30"></a><span id="l15.30">       delete [] pBytes;</span>
<a href="#l15.31"></a><span id="l15.31">       pBytes = NULL;</span>
<a href="#l15.32"></a><span id="l15.32">     }</span>
<a href="#l15.33"></a><span id="l15.33">   }</span>
<a href="#l15.34"></a><span id="l15.34"> </span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-  return( pBytes);</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+  return pBytes;</span>
<a href="#l15.37"></a><span id="l15.37"> }</span>
<a href="#l15.38"></a><span id="l15.38"> </span>
<a href="#l15.39"></a><span id="l15.39"> </span>
<a href="#l15.40"></a><span id="l15.40"> nsEudoraWin32::nsEudoraWin32()</span>
<a href="#l15.41"></a><span id="l15.41"> {</span>
<a href="#l15.42"></a><span id="l15.42">   m_pMimeSection = nsnull;</span>
<a href="#l15.43"></a><span id="l15.43"> }</span>
<a href="#l15.44"></a><span id="l15.44"> </span>
<a href="#l15.45"></a><span id="l15.45"> nsEudoraWin32::~nsEudoraWin32()</span>
<a href="#l15.46"></a><span id="l15.46"> {</span>
<a href="#l15.47"></a><span id="l15.47">   delete [] m_pMimeSection;</span>
<a href="#l15.48"></a><span id="l15.48"> }</span>
<a href="#l15.49"></a><span id="l15.49"> </span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-bool nsEudoraWin32::FindMailFolder( nsIFile **pFolder)</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+bool nsEudoraWin32::FindMailFolder(nsIFile **pFolder)</span>
<a href="#l15.52"></a><span id="l15.52"> {</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-  return( FindEudoraLocation( pFolder));</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+  return FindEudoraLocation(pFolder);</span>
<a href="#l15.55"></a><span id="l15.55"> }</span>
<a href="#l15.56"></a><span id="l15.56"> </span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-bool nsEudoraWin32::FindEudoraLocation( nsIFile **pFolder, bool findIni)</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+bool nsEudoraWin32::FindEudoraLocation(nsIFile **pFolder, bool findIni)</span>
<a href="#l15.59"></a><span id="l15.59"> {</span>
<a href="#l15.60"></a><span id="l15.60">   bool result = false;</span>
<a href="#l15.61"></a><span id="l15.61">   bool    exists = false;</span>
<a href="#l15.62"></a><span id="l15.62">   nsCOMPtr &lt;nsILocalFile&gt; eudoraPath = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l15.63"></a><span id="l15.63">   // look in the registry to see where eudora is installed?</span>
<a href="#l15.64"></a><span id="l15.64">   HKEY  sKey;</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-  if (::RegOpenKeyEx( HKEY_CURRENT_USER, &quot;Software\\Qualcomm\\Eudora\\CommandLine&quot;, 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS)</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+  if (::RegOpenKeyEx(HKEY_CURRENT_USER, &quot;Software\\Qualcomm\\Eudora\\CommandLine&quot;, 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS)</span>
<a href="#l15.67"></a><span id="l15.67">   {</span>
<a href="#l15.68"></a><span id="l15.68">     // get the value of &quot;Current&quot;</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-    BYTE *pBytes = GetValueBytes( sKey, &quot;Current&quot;);</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+    BYTE *pBytes = GetValueBytes(sKey, &quot;Current&quot;);</span>
<a href="#l15.71"></a><span id="l15.71">     if (pBytes)</span>
<a href="#l15.72"></a><span id="l15.72">     {</span>
<a href="#l15.73"></a><span id="l15.73">       nsCString str((const char *)pBytes);</span>
<a href="#l15.74"></a><span id="l15.74">       delete [] pBytes;</span>
<a href="#l15.75"></a><span id="l15.75"> </span>
<a href="#l15.76"></a><span id="l15.76">       MsgCompressWhitespace(str);</span>
<a href="#l15.77"></a><span id="l15.77"> </span>
<a href="#l15.78"></a><span id="l15.78">       // Command line is Eudora mailfolder eudora.ini</span>
<a href="#l15.79"></a><span id="l15.79">       if (findIni)</span>
<a href="#l15.80"></a><span id="l15.80">       {</span>
<a href="#l15.81"></a><span id="l15.81">         // find the string coming after the last space</span>
<a href="#l15.82"></a><span id="l15.82">         PRInt32 index = str.RFind(&quot; &quot;);</span>
<a href="#l15.83"></a><span id="l15.83">         if (index != -1)</span>
<a href="#l15.84"></a><span id="l15.84">         {</span>
<a href="#l15.85"></a><span id="l15.85">           index++; // skip the space</span>
<a href="#l15.86"></a><span id="l15.86">           eudoraPath-&gt;InitWithNativePath(Substring(str, index));</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineminus">-          eudoraPath-&gt;IsFile( &amp;exists);</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+          eudoraPath-&gt;IsFile(&amp;exists);</span>
<a href="#l15.89"></a><span id="l15.89">           if (exists)</span>
<a href="#l15.90"></a><span id="l15.90">             result = exists;</span>
<a href="#l15.91"></a><span id="l15.91">           else // it may just be the mailbox location....guess that there will be a eudora.ini file there</span>
<a href="#l15.92"></a><span id="l15.92">           {</span>
<a href="#l15.93"></a><span id="l15.93">             eudoraPath-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;eudora.ini&quot;));</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineminus">-            eudoraPath-&gt;IsFile( &amp;exists);</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+            eudoraPath-&gt;IsFile(&amp;exists);</span>
<a href="#l15.96"></a><span id="l15.96">             result = exists;</span>
<a href="#l15.97"></a><span id="l15.97">           }</span>
<a href="#l15.98"></a><span id="l15.98">         }</span>
<a href="#l15.99"></a><span id="l15.99">       } // if findIni</span>
<a href="#l15.100"></a><span id="l15.100">       else</span>
<a href="#l15.101"></a><span id="l15.101">       {</span>
<a href="#l15.102"></a><span id="l15.102">         int  idx = -1;</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineminus">-        if (str.CharAt( 0) == '&quot;')</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+        if (str.CharAt(0) == '&quot;')</span>
<a href="#l15.105"></a><span id="l15.105">         {</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-          idx = str.FindChar( '&quot;', 1);</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+          idx = str.FindChar('&quot;', 1);</span>
<a href="#l15.108"></a><span id="l15.108">           if (idx != -1)</span>
<a href="#l15.109"></a><span id="l15.109">             idx++;</span>
<a href="#l15.110"></a><span id="l15.110">         }</span>
<a href="#l15.111"></a><span id="l15.111">         else</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-          idx = str.FindChar( ' ');</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+          idx = str.FindChar(' ');</span>
<a href="#l15.114"></a><span id="l15.114"> </span>
<a href="#l15.115"></a><span id="l15.115">         if (idx != -1)</span>
<a href="#l15.116"></a><span id="l15.116">         {</span>
<a href="#l15.117"></a><span id="l15.117">           idx++;</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-          while (str.CharAt( idx) == ' ') idx++;</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+          while (str.CharAt(idx) == ' ') idx++;</span>
<a href="#l15.120"></a><span id="l15.120">           int endIdx = -1;</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-          if (str.CharAt( idx) == '&quot;')</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-            endIdx = str.FindChar( '&quot;', idx);</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineplus">+          if (str.CharAt(idx) == '&quot;')</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineplus">+            endIdx = str.FindChar('&quot;', idx);</span>
<a href="#l15.125"></a><span id="l15.125">           else {</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-            endIdx = str.FindChar( ' ', idx);</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineplus">+            endIdx = str.FindChar(' ', idx);</span>
<a href="#l15.128"></a><span id="l15.128">             if (endIdx == -1)</span>
<a href="#l15.129"></a><span id="l15.129">               endIdx = str.Length();</span>
<a href="#l15.130"></a><span id="l15.130">           }</span>
<a href="#l15.131"></a><span id="l15.131">           if (endIdx != -1)</span>
<a href="#l15.132"></a><span id="l15.132">           {</span>
<a href="#l15.133"></a><span id="l15.133">             eudoraPath-&gt;InitWithNativePath(Substring(str, idx, endIdx - idx));</span>
<a href="#l15.134"></a><span id="l15.134"> </span>
<a href="#l15.135"></a><span id="l15.135" class="difflineminus">-            if (NS_SUCCEEDED( eudoraPath-&gt;IsDirectory( &amp;exists)))</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineplus">+            if (NS_SUCCEEDED(eudoraPath-&gt;IsDirectory(&amp;exists)))</span>
<a href="#l15.137"></a><span id="l15.137">               result = exists;</span>
<a href="#l15.138"></a><span id="l15.138">           }</span>
<a href="#l15.139"></a><span id="l15.139">         }</span>
<a href="#l15.140"></a><span id="l15.140">       }</span>
<a href="#l15.141"></a><span id="l15.141">     } // if pBytes</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineminus">-    ::RegCloseKey( sKey);</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineplus">+    ::RegCloseKey(sKey);</span>
<a href="#l15.144"></a><span id="l15.144">   }</span>
<a href="#l15.145"></a><span id="l15.145"> </span>
<a href="#l15.146"></a><span id="l15.146">   NS_IF_ADDREF(*pFolder = eudoraPath);</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-  return( result);</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineplus">+  return result;</span>
<a href="#l15.149"></a><span id="l15.149"> }</span>
<a href="#l15.150"></a><span id="l15.150"> </span>
<a href="#l15.151"></a><span id="l15.151" class="difflineminus">-nsresult nsEudoraWin32::FindMailboxes( nsIFile *pRoot, nsISupportsArray **ppArray)</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineplus">+nsresult nsEudoraWin32::FindMailboxes(nsIFile *pRoot, nsISupportsArray **ppArray)</span>
<a href="#l15.153"></a><span id="l15.153"> {</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineminus">-  nsresult rv = NS_NewISupportsArray( ppArray);</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineplus">+  nsresult rv = NS_NewISupportsArray(ppArray);</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l15.158"></a><span id="l15.158">   {</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineminus">-    IMPORT_LOG0( &quot;FAILED to allocate the nsISupportsArray\n&quot;);</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineminus">-    return( rv);</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineplus">+    IMPORT_LOG0(&quot;FAILED to allocate the nsISupportsArray\n&quot;);</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineplus">+    return rv;</span>
<a href="#l15.163"></a><span id="l15.163">   }</span>
<a href="#l15.164"></a><span id="l15.164"> </span>
<a href="#l15.165"></a><span id="l15.165">   nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineminus">-    return( rv);</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineplus">+    return rv;</span>
<a href="#l15.170"></a><span id="l15.170"> </span>
<a href="#l15.171"></a><span id="l15.171">   m_depth = 0;</span>
<a href="#l15.172"></a><span id="l15.172">   m_mailImportLocation = do_QueryInterface(pRoot);</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineminus">-  return( ScanMailDir( pRoot, *ppArray, impSvc));</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineplus">+  return ScanMailDir(pRoot, *ppArray, impSvc);</span>
<a href="#l15.175"></a><span id="l15.175"> }</span>
<a href="#l15.176"></a><span id="l15.176"> </span>
<a href="#l15.177"></a><span id="l15.177"> </span>
<a href="#l15.178"></a><span id="l15.178" class="difflineminus">-nsresult nsEudoraWin32::ScanMailDir( nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport)</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineplus">+nsresult nsEudoraWin32::ScanMailDir(nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport)</span>
<a href="#l15.180"></a><span id="l15.180"> {</span>
<a href="#l15.181"></a><span id="l15.181">   bool            exists = false;</span>
<a href="#l15.182"></a><span id="l15.182">   bool            isFile = false;</span>
<a href="#l15.183"></a><span id="l15.183">   char *          pContents = nsnull;</span>
<a href="#l15.184"></a><span id="l15.184">   PRInt32          len = 0;</span>
<a href="#l15.185"></a><span id="l15.185">   nsCOMPtr&lt;nsIFile&gt;  descMap;</span>
<a href="#l15.186"></a><span id="l15.186">   nsresult        rv;</span>
<a href="#l15.187"></a><span id="l15.187"> </span>
<a href="#l15.188"></a><span id="l15.188" class="difflineminus">-  if (NS_FAILED( rv = pFolder-&gt;Clone(getter_AddRefs(descMap))))</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineminus">-    return( rv);</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineplus">+  if (NS_FAILED(rv = pFolder-&gt;Clone(getter_AddRefs(descMap))))</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineplus">+    return rv;</span>
<a href="#l15.192"></a><span id="l15.192"> </span>
<a href="#l15.193"></a><span id="l15.193">   m_depth++;</span>
<a href="#l15.194"></a><span id="l15.194"> </span>
<a href="#l15.195"></a><span id="l15.195">   rv = descMap-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;descmap.pce&quot;));</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineminus">-    rv = descMap-&gt;IsFile( &amp;isFile);</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineminus">-    rv = descMap-&gt;Exists( &amp;exists);</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineminus">-  if (NS_SUCCEEDED( rv) &amp;&amp; exists &amp;&amp; isFile)</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineplus">+    rv = descMap-&gt;IsFile(&amp;isFile);</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineplus">+    rv = descMap-&gt;Exists(&amp;exists);</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; exists &amp;&amp; isFile)</span>
<a href="#l15.206"></a><span id="l15.206">   {</span>
<a href="#l15.207"></a><span id="l15.207">     nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l15.208"></a><span id="l15.208">     nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), descMap);</span>
<a href="#l15.209"></a><span id="l15.209">     if (NS_FAILED(rv))</span>
<a href="#l15.210"></a><span id="l15.210">       return rv;</span>
<a href="#l15.211"></a><span id="l15.211"> </span>
<a href="#l15.212"></a><span id="l15.212">     PRUint32 bytesLeft = 0;</span>
<a href="#l15.213"></a><span id="l15.213"> </span>
<a href="#l15.214"></a><span id="l15.214">     rv = inputStream-&gt;Available(&amp;bytesLeft);</span>
<a href="#l15.215"></a><span id="l15.215">     if (NS_FAILED(rv))</span>
<a href="#l15.216"></a><span id="l15.216">     {</span>
<a href="#l15.217"></a><span id="l15.217" class="difflineminus">-      IMPORT_LOG0( &quot;*** Error checking address file for eof\n&quot;);</span>
<a href="#l15.218"></a><span id="l15.218" class="difflineplus">+      IMPORT_LOG0(&quot;*** Error checking address file for eof\n&quot;);</span>
<a href="#l15.219"></a><span id="l15.219">       inputStream-&gt;Close();</span>
<a href="#l15.220"></a><span id="l15.220">       return rv;</span>
<a href="#l15.221"></a><span id="l15.221">     }</span>
<a href="#l15.222"></a><span id="l15.222">     pContents = (char *) PR_Malloc(bytesLeft + 1);</span>
<a href="#l15.223"></a><span id="l15.223">     if (!pContents)</span>
<a href="#l15.224"></a><span id="l15.224">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l15.225"></a><span id="l15.225">     PRUint32 bytesRead;</span>
<a href="#l15.226"></a><span id="l15.226">     rv = inputStream-&gt;Read(pContents, bytesLeft, &amp;bytesRead);</span>
<a href="#l15.227"></a><span id="l15.227">     if (bytesRead != bytesLeft)</span>
<a href="#l15.228"></a><span id="l15.228">       return NS_ERROR_FAILURE;</span>
<a href="#l15.229"></a><span id="l15.229">     pContents[bytesRead] = '\0';</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; pContents)</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; pContents)</span>
<a href="#l15.232"></a><span id="l15.232">     {</span>
<a href="#l15.233"></a><span id="l15.233">       len = bytesRead;</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineminus">-      if (NS_SUCCEEDED( rv))</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineminus">-        rv = ScanDescmap( pFolder, pArray, pImport, pContents, len);</span>
<a href="#l15.236"></a><span id="l15.236" class="difflineminus">-      PR_Free( pContents);</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l15.238"></a><span id="l15.238" class="difflineplus">+        rv = ScanDescmap(pFolder, pArray, pImport, pContents, len);</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineplus">+      PR_Free(pContents);</span>
<a href="#l15.240"></a><span id="l15.240">     }</span>
<a href="#l15.241"></a><span id="l15.241">     else</span>
<a href="#l15.242"></a><span id="l15.242">       rv = NS_ERROR_FAILURE;</span>
<a href="#l15.243"></a><span id="l15.243">   }</span>
<a href="#l15.244"></a><span id="l15.244"> </span>
<a href="#l15.245"></a><span id="l15.245" class="difflineminus">-  if (NS_FAILED( rv) || !isFile || !exists)</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineminus">-    rv = IterateMailDir( pFolder, pArray, pImport);</span>
<a href="#l15.247"></a><span id="l15.247" class="difflineplus">+  if (NS_FAILED(rv) || !isFile || !exists)</span>
<a href="#l15.248"></a><span id="l15.248" class="difflineplus">+    rv = IterateMailDir(pFolder, pArray, pImport);</span>
<a href="#l15.249"></a><span id="l15.249"> </span>
<a href="#l15.250"></a><span id="l15.250">   m_depth--;</span>
<a href="#l15.251"></a><span id="l15.251"> </span>
<a href="#l15.252"></a><span id="l15.252" class="difflineminus">-  return( rv);</span>
<a href="#l15.253"></a><span id="l15.253" class="difflineplus">+  return rv;</span>
<a href="#l15.254"></a><span id="l15.254"> }</span>
<a href="#l15.255"></a><span id="l15.255"> </span>
<a href="#l15.256"></a><span id="l15.256" class="difflineminus">-nsresult nsEudoraWin32::IterateMailDir( nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport)</span>
<a href="#l15.257"></a><span id="l15.257" class="difflineplus">+nsresult nsEudoraWin32::IterateMailDir(nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport)</span>
<a href="#l15.258"></a><span id="l15.258"> {</span>
<a href="#l15.259"></a><span id="l15.259">   bool hasMore;</span>
<a href="#l15.260"></a><span id="l15.260">   nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l15.261"></a><span id="l15.261">   nsresult rv = pFolder-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l15.262"></a><span id="l15.262">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.263"></a><span id="l15.263"> </span>
<a href="#l15.264"></a><span id="l15.264">   directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l15.265"></a><span id="l15.265">   bool              isFolder;</span>
<a href="#l15.266"></a><span id="l15.266" class="difflineat">@@ -283,70 +281,70 @@ nsresult nsEudoraWin32::IterateMailDir( </span>
<a href="#l15.267"></a><span id="l15.267"> </span>
<a href="#l15.268"></a><span id="l15.268">   while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l15.269"></a><span id="l15.269">   {</span>
<a href="#l15.270"></a><span id="l15.270">     nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l15.271"></a><span id="l15.271">     rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l15.272"></a><span id="l15.272">     nsCOMPtr&lt;nsILocalFile&gt; entry(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l15.273"></a><span id="l15.273">     directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l15.274"></a><span id="l15.274"> </span>
<a href="#l15.275"></a><span id="l15.275" class="difflineminus">-    if (NS_SUCCEEDED( rv))</span>
<a href="#l15.276"></a><span id="l15.276" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l15.277"></a><span id="l15.277">     {</span>
<a href="#l15.278"></a><span id="l15.278">       rv = entry-&gt;GetNativeLeafName(fName);</span>
<a href="#l15.279"></a><span id="l15.279" class="difflineminus">-      if (NS_SUCCEEDED( rv) &amp;&amp; !fName.IsEmpty())</span>
<a href="#l15.280"></a><span id="l15.280" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; !fName.IsEmpty())</span>
<a href="#l15.281"></a><span id="l15.281">       {</span>
<a href="#l15.282"></a><span id="l15.282">         if (fName.Length() &gt; 4)</span>
<a href="#l15.283"></a><span id="l15.283">         {</span>
<a href="#l15.284"></a><span id="l15.284">           ext = StringTail(fName, 4);</span>
<a href="#l15.285"></a><span id="l15.285">           name = StringHead(fName, fName.Length() - 4);</span>
<a href="#l15.286"></a><span id="l15.286">         }</span>
<a href="#l15.287"></a><span id="l15.287">         else</span>
<a href="#l15.288"></a><span id="l15.288">         {</span>
<a href="#l15.289"></a><span id="l15.289">           ext.Truncate();</span>
<a href="#l15.290"></a><span id="l15.290">           name = fName;</span>
<a href="#l15.291"></a><span id="l15.291">         }</span>
<a href="#l15.292"></a><span id="l15.292">         ToLowerCase(ext);</span>
<a href="#l15.293"></a><span id="l15.293">         if (ext.EqualsLiteral(&quot;.fol&quot;))</span>
<a href="#l15.294"></a><span id="l15.294">         {</span>
<a href="#l15.295"></a><span id="l15.295">           isFolder = false;</span>
<a href="#l15.296"></a><span id="l15.296" class="difflineminus">-          entry-&gt;IsDirectory( &amp;isFolder);</span>
<a href="#l15.297"></a><span id="l15.297" class="difflineplus">+          entry-&gt;IsDirectory(&amp;isFolder);</span>
<a href="#l15.298"></a><span id="l15.298">           if (isFolder)</span>
<a href="#l15.299"></a><span id="l15.299">           {</span>
<a href="#l15.300"></a><span id="l15.300">             // add the folder</span>
<a href="#l15.301"></a><span id="l15.301" class="difflineminus">-            rv = FoundMailFolder( entry, name.get(), pArray, pImport);</span>
<a href="#l15.302"></a><span id="l15.302" class="difflineminus">-            if (NS_SUCCEEDED( rv))</span>
<a href="#l15.303"></a><span id="l15.303" class="difflineplus">+            rv = FoundMailFolder(entry, name.get(), pArray, pImport);</span>
<a href="#l15.304"></a><span id="l15.304" class="difflineplus">+            if (NS_SUCCEEDED(rv))</span>
<a href="#l15.305"></a><span id="l15.305">             {</span>
<a href="#l15.306"></a><span id="l15.306" class="difflineminus">-              rv = ScanMailDir( entry, pArray, pImport);</span>
<a href="#l15.307"></a><span id="l15.307" class="difflineminus">-              if (NS_FAILED( rv))</span>
<a href="#l15.308"></a><span id="l15.308" class="difflineminus">-                IMPORT_LOG0( &quot;*** Error scanning mail directory\n&quot;);</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineplus">+              rv = ScanMailDir(entry, pArray, pImport);</span>
<a href="#l15.310"></a><span id="l15.310" class="difflineplus">+              if (NS_FAILED(rv))</span>
<a href="#l15.311"></a><span id="l15.311" class="difflineplus">+                IMPORT_LOG0(&quot;*** Error scanning mail directory\n&quot;);</span>
<a href="#l15.312"></a><span id="l15.312">             }</span>
<a href="#l15.313"></a><span id="l15.313">           }</span>
<a href="#l15.314"></a><span id="l15.314">         }</span>
<a href="#l15.315"></a><span id="l15.315">         else if (ext.EqualsLiteral(&quot;.mbx&quot;))</span>
<a href="#l15.316"></a><span id="l15.316">         {</span>
<a href="#l15.317"></a><span id="l15.317">           isFile = false;</span>
<a href="#l15.318"></a><span id="l15.318" class="difflineminus">-          entry-&gt;IsFile( &amp;isFile);</span>
<a href="#l15.319"></a><span id="l15.319" class="difflineplus">+          entry-&gt;IsFile(&amp;isFile);</span>
<a href="#l15.320"></a><span id="l15.320">           if (isFile)</span>
<a href="#l15.321"></a><span id="l15.321" class="difflineminus">-            rv = FoundMailbox( entry, name.get(), pArray, pImport);</span>
<a href="#l15.322"></a><span id="l15.322" class="difflineplus">+            rv = FoundMailbox(entry, name.get(), pArray, pImport);</span>
<a href="#l15.323"></a><span id="l15.323">         }</span>
<a href="#l15.324"></a><span id="l15.324">       }</span>
<a href="#l15.325"></a><span id="l15.325">     }</span>
<a href="#l15.326"></a><span id="l15.326">   }</span>
<a href="#l15.327"></a><span id="l15.327" class="difflineminus">-  return( rv);</span>
<a href="#l15.328"></a><span id="l15.328" class="difflineplus">+  return rv;</span>
<a href="#l15.329"></a><span id="l15.329"> }</span>
<a href="#l15.330"></a><span id="l15.330"> </span>
<a href="#l15.331"></a><span id="l15.331" class="difflineminus">-nsresult nsEudoraWin32::ScanDescmap( nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport, const char *pData, PRInt32 len)</span>
<a href="#l15.332"></a><span id="l15.332" class="difflineplus">+nsresult nsEudoraWin32::ScanDescmap(nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport, const char *pData, PRInt32 len)</span>
<a href="#l15.333"></a><span id="l15.333"> {</span>
<a href="#l15.334"></a><span id="l15.334">   // use this to find stuff in the directory.</span>
<a href="#l15.335"></a><span id="l15.335"> </span>
<a href="#l15.336"></a><span id="l15.336">   nsCOMPtr&lt;nsIFile&gt;  entry;</span>
<a href="#l15.337"></a><span id="l15.337">   nsresult        rv;</span>
<a href="#l15.338"></a><span id="l15.338"> </span>
<a href="#l15.339"></a><span id="l15.339" class="difflineminus">-  if (NS_FAILED( rv = pFolder-&gt;Clone(getter_AddRefs(entry))))</span>
<a href="#l15.340"></a><span id="l15.340" class="difflineminus">-    return( rv);</span>
<a href="#l15.341"></a><span id="l15.341" class="difflineplus">+  if (NS_FAILED(rv = pFolder-&gt;Clone(getter_AddRefs(entry))))</span>
<a href="#l15.342"></a><span id="l15.342" class="difflineplus">+    return rv;</span>
<a href="#l15.343"></a><span id="l15.343">   entry-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;dummy&quot;));</span>
<a href="#l15.344"></a><span id="l15.344">   // format is Name,FileName,Type,Flag?</span>
<a href="#l15.345"></a><span id="l15.345">   //  Type = M or S for mailbox</span>
<a href="#l15.346"></a><span id="l15.346">   //       = F for folder</span>
<a href="#l15.347"></a><span id="l15.347"> </span>
<a href="#l15.348"></a><span id="l15.348">   PRInt32      fieldLen;</span>
<a href="#l15.349"></a><span id="l15.349">   PRInt32      pos = 0;</span>
<a href="#l15.350"></a><span id="l15.350">   const char * pStart;</span>
<a href="#l15.351"></a><span id="l15.351" class="difflineat">@@ -363,353 +361,347 @@ nsresult nsEudoraWin32::ScanDescmap( nsI</span>
<a href="#l15.352"></a><span id="l15.352">     while ((pos &lt; len) &amp;&amp; (*pData != ','))</span>
<a href="#l15.353"></a><span id="l15.353">     {</span>
<a href="#l15.354"></a><span id="l15.354">       pos++;</span>
<a href="#l15.355"></a><span id="l15.355">       pData++;</span>
<a href="#l15.356"></a><span id="l15.356">       fieldLen++;</span>
<a href="#l15.357"></a><span id="l15.357">     }</span>
<a href="#l15.358"></a><span id="l15.358">     name.Truncate();</span>
<a href="#l15.359"></a><span id="l15.359">     if (fieldLen)</span>
<a href="#l15.360"></a><span id="l15.360" class="difflineminus">-      name.Append( pStart, fieldLen);</span>
<a href="#l15.361"></a><span id="l15.361" class="difflineminus">-    name.Trim( kWhitespace);</span>
<a href="#l15.362"></a><span id="l15.362" class="difflineplus">+      name.Append(pStart, fieldLen);</span>
<a href="#l15.363"></a><span id="l15.363" class="difflineplus">+    name.Trim(kWhitespace);</span>
<a href="#l15.364"></a><span id="l15.364">     pos++;</span>
<a href="#l15.365"></a><span id="l15.365">     pData++;</span>
<a href="#l15.366"></a><span id="l15.366">     pStart = pData;</span>
<a href="#l15.367"></a><span id="l15.367">     fieldLen = 0;</span>
<a href="#l15.368"></a><span id="l15.368">     while ((pos &lt; len) &amp;&amp; (*pData != ','))</span>
<a href="#l15.369"></a><span id="l15.369">     {</span>
<a href="#l15.370"></a><span id="l15.370">       pos++;</span>
<a href="#l15.371"></a><span id="l15.371">       pData++;</span>
<a href="#l15.372"></a><span id="l15.372">       fieldLen++;</span>
<a href="#l15.373"></a><span id="l15.373">     }</span>
<a href="#l15.374"></a><span id="l15.374">     fName.Truncate();</span>
<a href="#l15.375"></a><span id="l15.375">     if (fieldLen)</span>
<a href="#l15.376"></a><span id="l15.376" class="difflineminus">-      fName.Append( pStart, fieldLen);</span>
<a href="#l15.377"></a><span id="l15.377" class="difflineplus">+      fName.Append(pStart, fieldLen);</span>
<a href="#l15.378"></a><span id="l15.378">     // Descmap file name is written without any extraneous white space - i.e.</span>
<a href="#l15.379"></a><span id="l15.379">     // if there's whitespace present it's intentional and important. Don't</span>
<a href="#l15.380"></a><span id="l15.380">     // strip whitespace from the fName.</span>
<a href="#l15.381"></a><span id="l15.381">     pos++;</span>
<a href="#l15.382"></a><span id="l15.382">     pData++;</span>
<a href="#l15.383"></a><span id="l15.383">     pStart = pData;</span>
<a href="#l15.384"></a><span id="l15.384">     fieldLen = 0;</span>
<a href="#l15.385"></a><span id="l15.385">     while ((pos &lt; len) &amp;&amp; (*pData != ','))</span>
<a href="#l15.386"></a><span id="l15.386">     {</span>
<a href="#l15.387"></a><span id="l15.387">       pos++;</span>
<a href="#l15.388"></a><span id="l15.388">       pData++;</span>
<a href="#l15.389"></a><span id="l15.389">       fieldLen++;</span>
<a href="#l15.390"></a><span id="l15.390">     }</span>
<a href="#l15.391"></a><span id="l15.391">     type.Truncate();</span>
<a href="#l15.392"></a><span id="l15.392">     if (fieldLen)</span>
<a href="#l15.393"></a><span id="l15.393" class="difflineminus">-      type.Append( pStart, fieldLen);</span>
<a href="#l15.394"></a><span id="l15.394" class="difflineminus">-    type.Trim( kWhitespace);</span>
<a href="#l15.395"></a><span id="l15.395" class="difflineplus">+      type.Append(pStart, fieldLen);</span>
<a href="#l15.396"></a><span id="l15.396" class="difflineplus">+    type.Trim(kWhitespace);</span>
<a href="#l15.397"></a><span id="l15.397">     pos++;</span>
<a href="#l15.398"></a><span id="l15.398">     pData++;</span>
<a href="#l15.399"></a><span id="l15.399">     pStart = pData;</span>
<a href="#l15.400"></a><span id="l15.400">     fieldLen = 0;</span>
<a href="#l15.401"></a><span id="l15.401">     // Skip to next end of line, or ',' separator.</span>
<a href="#l15.402"></a><span id="l15.402">     while ((pos &lt; len) &amp;&amp;</span>
<a href="#l15.403"></a><span id="l15.403">            (*pData != nsCRT::CR) &amp;&amp; (*pData != nsCRT::LF) &amp;&amp; (*pData != ','))</span>
<a href="#l15.404"></a><span id="l15.404">     {</span>
<a href="#l15.405"></a><span id="l15.405">       pos++;</span>
<a href="#l15.406"></a><span id="l15.406">       pData++;</span>
<a href="#l15.407"></a><span id="l15.407">       fieldLen++;</span>
<a href="#l15.408"></a><span id="l15.408">     }</span>
<a href="#l15.409"></a><span id="l15.409">     flag.Truncate();</span>
<a href="#l15.410"></a><span id="l15.410">     if (fieldLen)</span>
<a href="#l15.411"></a><span id="l15.411" class="difflineminus">-      flag.Append( pStart, fieldLen);</span>
<a href="#l15.412"></a><span id="l15.412" class="difflineminus">-    flag.Trim( kWhitespace);</span>
<a href="#l15.413"></a><span id="l15.413" class="difflineplus">+      flag.Append(pStart, fieldLen);</span>
<a href="#l15.414"></a><span id="l15.414" class="difflineplus">+    flag.Trim(kWhitespace);</span>
<a href="#l15.415"></a><span id="l15.415">     // Skip over end of line(s).</span>
<a href="#l15.416"></a><span id="l15.416">     while ((pos &lt; len) &amp;&amp; ((*pData == nsCRT::CR) || (*pData == nsCRT::LF)))</span>
<a href="#l15.417"></a><span id="l15.417">     {</span>
<a href="#l15.418"></a><span id="l15.418">       pos++;</span>
<a href="#l15.419"></a><span id="l15.419">       pData++;</span>
<a href="#l15.420"></a><span id="l15.420">     }</span>
<a href="#l15.421"></a><span id="l15.421"> </span>
<a href="#l15.422"></a><span id="l15.422" class="difflineminus">-    IMPORT_LOG2( &quot;name: %s, fName: %s\n&quot;, name.get(), fName.get());</span>
<a href="#l15.423"></a><span id="l15.423" class="difflineplus">+    IMPORT_LOG2(&quot;name: %s, fName: %s\n&quot;, name.get(), fName.get());</span>
<a href="#l15.424"></a><span id="l15.424"> </span>
<a href="#l15.425"></a><span id="l15.425">     if (!fName.IsEmpty() &amp;&amp; !name.IsEmpty() &amp;&amp; (type.Length() == 1))</span>
<a href="#l15.426"></a><span id="l15.426">     {</span>
<a href="#l15.427"></a><span id="l15.427">       rv = entry-&gt;SetNativeLeafName(fName);</span>
<a href="#l15.428"></a><span id="l15.428" class="difflineminus">-      if (NS_SUCCEEDED( rv))</span>
<a href="#l15.429"></a><span id="l15.429" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l15.430"></a><span id="l15.430">       {</span>
<a href="#l15.431"></a><span id="l15.431" class="difflineminus">-        if (type.CharAt( 0) == 'F')</span>
<a href="#l15.432"></a><span id="l15.432" class="difflineplus">+        if (type.CharAt(0) == 'F')</span>
<a href="#l15.433"></a><span id="l15.433">         {</span>
<a href="#l15.434"></a><span id="l15.434">           isFolder = false;</span>
<a href="#l15.435"></a><span id="l15.435" class="difflineminus">-          entry-&gt;IsDirectory( &amp;isFolder);</span>
<a href="#l15.436"></a><span id="l15.436" class="difflineplus">+          entry-&gt;IsDirectory(&amp;isFolder);</span>
<a href="#l15.437"></a><span id="l15.437">           if (isFolder)</span>
<a href="#l15.438"></a><span id="l15.438">           {</span>
<a href="#l15.439"></a><span id="l15.439" class="difflineminus">-            rv = FoundMailFolder( entry, name.get(), pArray, pImport);</span>
<a href="#l15.440"></a><span id="l15.440" class="difflineminus">-            if (NS_SUCCEEDED( rv))</span>
<a href="#l15.441"></a><span id="l15.441" class="difflineplus">+            rv = FoundMailFolder(entry, name.get(), pArray, pImport);</span>
<a href="#l15.442"></a><span id="l15.442" class="difflineplus">+            if (NS_SUCCEEDED(rv))</span>
<a href="#l15.443"></a><span id="l15.443">             {</span>
<a href="#l15.444"></a><span id="l15.444" class="difflineminus">-              rv = ScanMailDir( entry, pArray, pImport);</span>
<a href="#l15.445"></a><span id="l15.445" class="difflineminus">-              if (NS_FAILED( rv))</span>
<a href="#l15.446"></a><span id="l15.446" class="difflineminus">-                IMPORT_LOG0( &quot;*** Error scanning mail directory\n&quot;);</span>
<a href="#l15.447"></a><span id="l15.447" class="difflineplus">+              rv = ScanMailDir(entry, pArray, pImport);</span>
<a href="#l15.448"></a><span id="l15.448" class="difflineplus">+              if (NS_FAILED(rv))</span>
<a href="#l15.449"></a><span id="l15.449" class="difflineplus">+                IMPORT_LOG0(&quot;*** Error scanning mail directory\n&quot;);</span>
<a href="#l15.450"></a><span id="l15.450">             }</span>
<a href="#l15.451"></a><span id="l15.451">           }</span>
<a href="#l15.452"></a><span id="l15.452">         }</span>
<a href="#l15.453"></a><span id="l15.453" class="difflineminus">-        else if ((type.CharAt( 0) == 'M') || (type.CharAt( 0) == 'S'))</span>
<a href="#l15.454"></a><span id="l15.454" class="difflineplus">+        else if ((type.CharAt(0) == 'M') || (type.CharAt(0) == 'S'))</span>
<a href="#l15.455"></a><span id="l15.455">         {</span>
<a href="#l15.456"></a><span id="l15.456">           isFile = false;</span>
<a href="#l15.457"></a><span id="l15.457" class="difflineminus">-          entry-&gt;IsFile( &amp;isFile);</span>
<a href="#l15.458"></a><span id="l15.458" class="difflineplus">+          entry-&gt;IsFile(&amp;isFile);</span>
<a href="#l15.459"></a><span id="l15.459">           if (isFile)</span>
<a href="#l15.460"></a><span id="l15.460" class="difflineminus">-            FoundMailbox( entry, name.get(), pArray, pImport);</span>
<a href="#l15.461"></a><span id="l15.461" class="difflineplus">+            FoundMailbox(entry, name.get(), pArray, pImport);</span>
<a href="#l15.462"></a><span id="l15.462">         }</span>
<a href="#l15.463"></a><span id="l15.463">       }</span>
<a href="#l15.464"></a><span id="l15.464">     }</span>
<a href="#l15.465"></a><span id="l15.465">   }</span>
<a href="#l15.466"></a><span id="l15.466"> </span>
<a href="#l15.467"></a><span id="l15.467" class="difflineminus">-  return( NS_OK);</span>
<a href="#l15.468"></a><span id="l15.468" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.469"></a><span id="l15.469"> }</span>
<a href="#l15.470"></a><span id="l15.470"> </span>
<a href="#l15.471"></a><span id="l15.471"> </span>
<a href="#l15.472"></a><span id="l15.472" class="difflineminus">-nsresult nsEudoraWin32::FoundMailbox( nsIFile *mailFile, const char *pName, nsISupportsArray *pArray, nsIImportService *pImport)</span>
<a href="#l15.473"></a><span id="l15.473" class="difflineplus">+nsresult nsEudoraWin32::FoundMailbox(nsIFile *mailFile, const char *pName, nsISupportsArray *pArray, nsIImportService *pImport)</span>
<a href="#l15.474"></a><span id="l15.474"> {</span>
<a href="#l15.475"></a><span id="l15.475">   nsString displayName;</span>
<a href="#l15.476"></a><span id="l15.476">   nsCOMPtr&lt;nsIImportMailboxDescriptor&gt; desc;</span>
<a href="#l15.477"></a><span id="l15.477">   nsISupports * pInterface;</span>
<a href="#l15.478"></a><span id="l15.478"> </span>
<a href="#l15.479"></a><span id="l15.479">   NS_CopyNativeToUnicode(nsDependentCString(pName), displayName);</span>
<a href="#l15.480"></a><span id="l15.480"> </span>
<a href="#l15.481"></a><span id="l15.481"> #ifdef IMPORT_DEBUG</span>
<a href="#l15.482"></a><span id="l15.482">   nsCAutoString path;</span>
<a href="#l15.483"></a><span id="l15.483">   mailFile-&gt;GetNativePath(path);</span>
<a href="#l15.484"></a><span id="l15.484">   if (!path.IsEmpty())</span>
<a href="#l15.485"></a><span id="l15.485" class="difflineminus">-    IMPORT_LOG2( &quot;Found eudora mailbox, %s: %s\n&quot;, path.get(), pName);</span>
<a href="#l15.486"></a><span id="l15.486" class="difflineplus">+    IMPORT_LOG2(&quot;Found eudora mailbox, %s: %s\n&quot;, path.get(), pName);</span>
<a href="#l15.487"></a><span id="l15.487">   else</span>
<a href="#l15.488"></a><span id="l15.488" class="difflineminus">-    IMPORT_LOG1( &quot;Found eudora mailbox, %s\n&quot;, pName);</span>
<a href="#l15.489"></a><span id="l15.489" class="difflineminus">-  IMPORT_LOG1( &quot;\tm_depth = %d\n&quot;, (int)m_depth);</span>
<a href="#l15.490"></a><span id="l15.490" class="difflineplus">+    IMPORT_LOG1(&quot;Found eudora mailbox, %s\n&quot;, pName);</span>
<a href="#l15.491"></a><span id="l15.491" class="difflineplus">+  IMPORT_LOG1(&quot;\tm_depth = %d\n&quot;, (int)m_depth);</span>
<a href="#l15.492"></a><span id="l15.492"> #endif</span>
<a href="#l15.493"></a><span id="l15.493"> </span>
<a href="#l15.494"></a><span id="l15.494" class="difflineminus">-  nsresult rv = pImport-&gt;CreateNewMailboxDescriptor( getter_AddRefs( desc));</span>
<a href="#l15.495"></a><span id="l15.495" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l15.496"></a><span id="l15.496" class="difflineplus">+  nsresult rv = pImport-&gt;CreateNewMailboxDescriptor(getter_AddRefs(desc));</span>
<a href="#l15.497"></a><span id="l15.497" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l15.498"></a><span id="l15.498">   {</span>
<a href="#l15.499"></a><span id="l15.499">     PRInt64 sz = 0;</span>
<a href="#l15.500"></a><span id="l15.500" class="difflineminus">-    mailFile-&gt;GetFileSize( &amp;sz);</span>
<a href="#l15.501"></a><span id="l15.501" class="difflineminus">-    desc-&gt;SetDisplayName( displayName.get());</span>
<a href="#l15.502"></a><span id="l15.502" class="difflineminus">-    desc-&gt;SetDepth( m_depth);</span>
<a href="#l15.503"></a><span id="l15.503" class="difflineminus">-    desc-&gt;SetSize( sz);</span>
<a href="#l15.504"></a><span id="l15.504" class="difflineplus">+    mailFile-&gt;GetFileSize(&amp;sz);</span>
<a href="#l15.505"></a><span id="l15.505" class="difflineplus">+    desc-&gt;SetDisplayName(displayName.get());</span>
<a href="#l15.506"></a><span id="l15.506" class="difflineplus">+    desc-&gt;SetDepth(m_depth);</span>
<a href="#l15.507"></a><span id="l15.507" class="difflineplus">+    desc-&gt;SetSize(sz);</span>
<a href="#l15.508"></a><span id="l15.508">     nsCOMPtr &lt;nsILocalFile&gt; pFile = nsnull;</span>
<a href="#l15.509"></a><span id="l15.509">     desc-&gt;GetFile(getter_AddRefs(pFile));</span>
<a href="#l15.510"></a><span id="l15.510">     if (pFile)</span>
<a href="#l15.511"></a><span id="l15.511">     {</span>
<a href="#l15.512"></a><span id="l15.512">       nsCOMPtr &lt;nsILocalFile&gt; localMailFile = do_QueryInterface(mailFile);</span>
<a href="#l15.513"></a><span id="l15.513" class="difflineminus">-      pFile-&gt;InitWithFile( localMailFile);</span>
<a href="#l15.514"></a><span id="l15.514" class="difflineplus">+      pFile-&gt;InitWithFile(localMailFile);</span>
<a href="#l15.515"></a><span id="l15.515">     }</span>
<a href="#l15.516"></a><span id="l15.516" class="difflineminus">-    rv = desc-&gt;QueryInterface( kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l15.517"></a><span id="l15.517" class="difflineminus">-    pArray-&gt;AppendElement( pInterface);</span>
<a href="#l15.518"></a><span id="l15.518" class="difflineplus">+    rv = desc-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l15.519"></a><span id="l15.519" class="difflineplus">+    pArray-&gt;AppendElement(pInterface);</span>
<a href="#l15.520"></a><span id="l15.520">     pInterface-&gt;Release();</span>
<a href="#l15.521"></a><span id="l15.521">   }</span>
<a href="#l15.522"></a><span id="l15.522"> </span>
<a href="#l15.523"></a><span id="l15.523" class="difflineminus">-  return( NS_OK);</span>
<a href="#l15.524"></a><span id="l15.524" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.525"></a><span id="l15.525"> }</span>
<a href="#l15.526"></a><span id="l15.526"> </span>
<a href="#l15.527"></a><span id="l15.527"> </span>
<a href="#l15.528"></a><span id="l15.528" class="difflineminus">-nsresult nsEudoraWin32::FoundMailFolder( nsIFile *mailFolder, const char *pName, nsISupportsArray *pArray, nsIImportService *pImport)</span>
<a href="#l15.529"></a><span id="l15.529" class="difflineplus">+nsresult nsEudoraWin32::FoundMailFolder(nsIFile *mailFolder, const char *pName, nsISupportsArray *pArray, nsIImportService *pImport)</span>
<a href="#l15.530"></a><span id="l15.530"> {</span>
<a href="#l15.531"></a><span id="l15.531">   nsString                displayName;</span>
<a href="#l15.532"></a><span id="l15.532">   nsCOMPtr&lt;nsIImportMailboxDescriptor&gt;  desc;</span>
<a href="#l15.533"></a><span id="l15.533">   nsISupports *              pInterface;</span>
<a href="#l15.534"></a><span id="l15.534"> </span>
<a href="#l15.535"></a><span id="l15.535">   NS_CopyNativeToUnicode(nsDependentCString(pName), displayName);</span>
<a href="#l15.536"></a><span id="l15.536"> </span>
<a href="#l15.537"></a><span id="l15.537"> #ifdef IMPORT_DEBUG</span>
<a href="#l15.538"></a><span id="l15.538">   nsCAutoString path;</span>
<a href="#l15.539"></a><span id="l15.539">   mailFolder-&gt;GetNativePath(path);</span>
<a href="#l15.540"></a><span id="l15.540">   if (!path.IsEmpty())</span>
<a href="#l15.541"></a><span id="l15.541" class="difflineminus">-    IMPORT_LOG2( &quot;Found eudora folder, %s: %s\n&quot;, path.get(), pName);</span>
<a href="#l15.542"></a><span id="l15.542" class="difflineplus">+    IMPORT_LOG2(&quot;Found eudora folder, %s: %s\n&quot;, path.get(), pName);</span>
<a href="#l15.543"></a><span id="l15.543">   else</span>
<a href="#l15.544"></a><span id="l15.544" class="difflineminus">-    IMPORT_LOG1( &quot;Found eudora folder, %s\n&quot;, pName);</span>
<a href="#l15.545"></a><span id="l15.545" class="difflineminus">-  IMPORT_LOG1( &quot;\tm_depth = %d\n&quot;, (int)m_depth);</span>
<a href="#l15.546"></a><span id="l15.546" class="difflineplus">+    IMPORT_LOG1(&quot;Found eudora folder, %s\n&quot;, pName);</span>
<a href="#l15.547"></a><span id="l15.547" class="difflineplus">+  IMPORT_LOG1(&quot;\tm_depth = %d\n&quot;, (int)m_depth);</span>
<a href="#l15.548"></a><span id="l15.548"> #endif</span>
<a href="#l15.549"></a><span id="l15.549"> </span>
<a href="#l15.550"></a><span id="l15.550" class="difflineminus">-  nsresult rv = pImport-&gt;CreateNewMailboxDescriptor( getter_AddRefs( desc));</span>
<a href="#l15.551"></a><span id="l15.551" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l15.552"></a><span id="l15.552" class="difflineplus">+  nsresult rv = pImport-&gt;CreateNewMailboxDescriptor(getter_AddRefs(desc));</span>
<a href="#l15.553"></a><span id="l15.553" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l15.554"></a><span id="l15.554">   {</span>
<a href="#l15.555"></a><span id="l15.555">     PRUint32    sz = 0;</span>
<a href="#l15.556"></a><span id="l15.556" class="difflineminus">-    desc-&gt;SetDisplayName( displayName.get());</span>
<a href="#l15.557"></a><span id="l15.557" class="difflineminus">-    desc-&gt;SetDepth( m_depth);</span>
<a href="#l15.558"></a><span id="l15.558" class="difflineminus">-    desc-&gt;SetSize( sz);</span>
<a href="#l15.559"></a><span id="l15.559" class="difflineplus">+    desc-&gt;SetDisplayName(displayName.get());</span>
<a href="#l15.560"></a><span id="l15.560" class="difflineplus">+    desc-&gt;SetDepth(m_depth);</span>
<a href="#l15.561"></a><span id="l15.561" class="difflineplus">+    desc-&gt;SetSize(sz);</span>
<a href="#l15.562"></a><span id="l15.562">     nsCOMPtr &lt;nsILocalFile&gt; pFile = nsnull;</span>
<a href="#l15.563"></a><span id="l15.563">     desc-&gt;GetFile(getter_AddRefs(pFile));</span>
<a href="#l15.564"></a><span id="l15.564">     if (pFile)</span>
<a href="#l15.565"></a><span id="l15.565">     {</span>
<a href="#l15.566"></a><span id="l15.566">       nsCOMPtr &lt;nsILocalFile&gt; localMailFile = do_QueryInterface(mailFolder);</span>
<a href="#l15.567"></a><span id="l15.567" class="difflineminus">-      pFile-&gt;InitWithFile( localMailFile);</span>
<a href="#l15.568"></a><span id="l15.568" class="difflineplus">+      pFile-&gt;InitWithFile(localMailFile);</span>
<a href="#l15.569"></a><span id="l15.569">     }</span>
<a href="#l15.570"></a><span id="l15.570" class="difflineminus">-    rv = desc-&gt;QueryInterface( kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l15.571"></a><span id="l15.571" class="difflineminus">-    pArray-&gt;AppendElement( pInterface);</span>
<a href="#l15.572"></a><span id="l15.572" class="difflineplus">+    rv = desc-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l15.573"></a><span id="l15.573" class="difflineplus">+    pArray-&gt;AppendElement(pInterface);</span>
<a href="#l15.574"></a><span id="l15.574">     pInterface-&gt;Release();</span>
<a href="#l15.575"></a><span id="l15.575">   }</span>
<a href="#l15.576"></a><span id="l15.576"> </span>
<a href="#l15.577"></a><span id="l15.577" class="difflineminus">-  return( NS_OK);</span>
<a href="#l15.578"></a><span id="l15.578" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.579"></a><span id="l15.579"> }</span>
<a href="#l15.580"></a><span id="l15.580"> </span>
<a href="#l15.581"></a><span id="l15.581"> </span>
<a href="#l15.582"></a><span id="l15.582" class="difflineminus">-nsresult nsEudoraWin32::FindTOCFile( nsIFile *pMailFile, nsIFile **ppTOCFile, bool *pDeleteToc)</span>
<a href="#l15.583"></a><span id="l15.583" class="difflineplus">+nsresult nsEudoraWin32::FindTOCFile(nsIFile *pMailFile, nsIFile **ppTOCFile, bool *pDeleteToc)</span>
<a href="#l15.584"></a><span id="l15.584"> {</span>
<a href="#l15.585"></a><span id="l15.585">   nsresult    rv;</span>
<a href="#l15.586"></a><span id="l15.586">   nsCAutoString  leaf;</span>
<a href="#l15.587"></a><span id="l15.587"> </span>
<a href="#l15.588"></a><span id="l15.588">   *pDeleteToc = false;</span>
<a href="#l15.589"></a><span id="l15.589">   *ppTOCFile = nsnull;</span>
<a href="#l15.590"></a><span id="l15.590">   rv = pMailFile-&gt;GetNativeLeafName(leaf);</span>
<a href="#l15.591"></a><span id="l15.591" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l15.592"></a><span id="l15.592" class="difflineminus">-    return( rv);</span>
<a href="#l15.593"></a><span id="l15.593" class="difflineminus">-  rv = pMailFile-&gt;GetParent( ppTOCFile);</span>
<a href="#l15.594"></a><span id="l15.594" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l15.595"></a><span id="l15.595" class="difflineminus">-    return( rv);</span>
<a href="#l15.596"></a><span id="l15.596" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l15.597"></a><span id="l15.597" class="difflineplus">+    return rv;</span>
<a href="#l15.598"></a><span id="l15.598" class="difflineplus">+  rv = pMailFile-&gt;GetParent(ppTOCFile);</span>
<a href="#l15.599"></a><span id="l15.599" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l15.600"></a><span id="l15.600" class="difflineplus">+    return rv;</span>
<a href="#l15.601"></a><span id="l15.601"> </span>
<a href="#l15.602"></a><span id="l15.602">   nsCString  name;</span>
<a href="#l15.603"></a><span id="l15.603" class="difflineminus">-  if ((leaf.Length() &gt; 4) &amp;&amp; (leaf.CharAt( leaf.Length() - 4) == '.'))</span>
<a href="#l15.604"></a><span id="l15.604" class="difflineplus">+  if ((leaf.Length() &gt; 4) &amp;&amp; (leaf.CharAt(leaf.Length() - 4) == '.'))</span>
<a href="#l15.605"></a><span id="l15.605">     name = StringHead(leaf, leaf.Length() - 4);</span>
<a href="#l15.606"></a><span id="l15.606">   else</span>
<a href="#l15.607"></a><span id="l15.607">     name = leaf;</span>
<a href="#l15.608"></a><span id="l15.608" class="difflineminus">-  name.Append( &quot;.toc&quot;);</span>
<a href="#l15.609"></a><span id="l15.609" class="difflineplus">+  name.Append(&quot;.toc&quot;);</span>
<a href="#l15.610"></a><span id="l15.610">   rv = (*ppTOCFile)-&gt;AppendNative(name);</span>
<a href="#l15.611"></a><span id="l15.611" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l15.612"></a><span id="l15.612" class="difflineminus">-    return( rv);</span>
<a href="#l15.613"></a><span id="l15.613" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l15.614"></a><span id="l15.614" class="difflineplus">+    return rv;</span>
<a href="#l15.615"></a><span id="l15.615"> </span>
<a href="#l15.616"></a><span id="l15.616">   bool    exists = false;</span>
<a href="#l15.617"></a><span id="l15.617" class="difflineminus">-  rv = (*ppTOCFile)-&gt;Exists( &amp;exists);</span>
<a href="#l15.618"></a><span id="l15.618" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l15.619"></a><span id="l15.619" class="difflineminus">-    return( rv);</span>
<a href="#l15.620"></a><span id="l15.620" class="difflineplus">+  rv = (*ppTOCFile)-&gt;Exists(&amp;exists);</span>
<a href="#l15.621"></a><span id="l15.621" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l15.622"></a><span id="l15.622" class="difflineplus">+    return rv;</span>
<a href="#l15.623"></a><span id="l15.623">   bool    isFile = false;</span>
<a href="#l15.624"></a><span id="l15.624" class="difflineminus">-  rv = (*ppTOCFile)-&gt;IsFile( &amp;isFile);</span>
<a href="#l15.625"></a><span id="l15.625" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l15.626"></a><span id="l15.626" class="difflineminus">-    return( rv);</span>
<a href="#l15.627"></a><span id="l15.627" class="difflineplus">+  rv = (*ppTOCFile)-&gt;IsFile(&amp;isFile);</span>
<a href="#l15.628"></a><span id="l15.628" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l15.629"></a><span id="l15.629" class="difflineplus">+    return rv;</span>
<a href="#l15.630"></a><span id="l15.630">   if (exists &amp;&amp; isFile)</span>
<a href="#l15.631"></a><span id="l15.631" class="difflineminus">-    return( NS_OK);</span>
<a href="#l15.632"></a><span id="l15.632" class="difflineplus">+    return NS_OK;</span>
<a href="#l15.633"></a><span id="l15.633"> </span>
<a href="#l15.634"></a><span id="l15.634" class="difflineminus">-  return( NS_ERROR_FAILURE);</span>
<a href="#l15.635"></a><span id="l15.635" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l15.636"></a><span id="l15.636"> }</span>
<a href="#l15.637"></a><span id="l15.637"> </span>
<a href="#l15.638"></a><span id="l15.638"> </span>
<a href="#l15.639"></a><span id="l15.639" class="difflineminus">-bool nsEudoraWin32::ImportSettings( nsIFile *pIniFile, nsIMsgAccount **localMailAccount)</span>
<a href="#l15.640"></a><span id="l15.640" class="difflineplus">+bool nsEudoraWin32::ImportSettings(nsIFile *pIniFile, nsIMsgAccount **localMailAccount)</span>
<a href="#l15.641"></a><span id="l15.641"> {</span>
<a href="#l15.642"></a><span id="l15.642">   bool      result = false;</span>
<a href="#l15.643"></a><span id="l15.643">   nsresult  rv;</span>
<a href="#l15.644"></a><span id="l15.644"> </span>
<a href="#l15.645"></a><span id="l15.645">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr =</span>
<a href="#l15.646"></a><span id="l15.646">            do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l15.647"></a><span id="l15.647">   if (NS_FAILED(rv))</span>
<a href="#l15.648"></a><span id="l15.648">   {</span>
<a href="#l15.649"></a><span id="l15.649" class="difflineminus">-    IMPORT_LOG0( &quot;*** Failed to create a account manager!\n&quot;);</span>
<a href="#l15.650"></a><span id="l15.650" class="difflineminus">-    return( false);</span>
<a href="#l15.651"></a><span id="l15.651" class="difflineplus">+    IMPORT_LOG0(&quot;*** Failed to create a account manager!\n&quot;);</span>
<a href="#l15.652"></a><span id="l15.652" class="difflineplus">+    return false;</span>
<a href="#l15.653"></a><span id="l15.653">   }</span>
<a href="#l15.654"></a><span id="l15.654"> </span>
<a href="#l15.655"></a><span id="l15.655">   // Eudora info is arranged by key, 1 for the default, then persona's for additional</span>
<a href="#l15.656"></a><span id="l15.656">   // accounts.</span>
<a href="#l15.657"></a><span id="l15.657">   // Start with the first one, then do each persona</span>
<a href="#l15.658"></a><span id="l15.658">   nsCString iniPath;</span>
<a href="#l15.659"></a><span id="l15.659">   pIniFile-&gt;GetNativePath(iniPath);</span>
<a href="#l15.660"></a><span id="l15.660">   if (iniPath.IsEmpty())</span>
<a href="#l15.661"></a><span id="l15.661" class="difflineminus">-    return( false);</span>
<a href="#l15.662"></a><span id="l15.662" class="difflineplus">+    return false;</span>
<a href="#l15.663"></a><span id="l15.663">   UINT       valInt;</span>
<a href="#l15.664"></a><span id="l15.664">   SimpleBufferTonyRCopiedOnce  section;</span>
<a href="#l15.665"></a><span id="l15.665">   DWORD      sSize;</span>
<a href="#l15.666"></a><span id="l15.666">   DWORD      sOffset = 0;</span>
<a href="#l15.667"></a><span id="l15.667">   DWORD      start;</span>
<a href="#l15.668"></a><span id="l15.668">   nsCString  sectionName(&quot;Settings&quot;);</span>
<a href="#l15.669"></a><span id="l15.669">   int        popCount = 0;</span>
<a href="#l15.670"></a><span id="l15.670">   int        accounts = 0;</span>
<a href="#l15.671"></a><span id="l15.671"> </span>
<a href="#l15.672"></a><span id="l15.672">   DWORD  allocSize = 0;</span>
<a href="#l15.673"></a><span id="l15.673">   do</span>
<a href="#l15.674"></a><span id="l15.674">   {</span>
<a href="#l15.675"></a><span id="l15.675">     allocSize += 2048;</span>
<a href="#l15.676"></a><span id="l15.676" class="difflineminus">-    section.Allocate( allocSize);</span>
<a href="#l15.677"></a><span id="l15.677" class="difflineminus">-    sSize = ::GetPrivateProfileSection( &quot;Personalities&quot;, section.m_pBuffer, allocSize, iniPath.get());</span>
<a href="#l15.678"></a><span id="l15.678" class="difflineplus">+    section.Allocate(allocSize);</span>
<a href="#l15.679"></a><span id="l15.679" class="difflineplus">+    sSize = ::GetPrivateProfileSection(&quot;Personalities&quot;, section.m_pBuffer, allocSize, iniPath.get());</span>
<a href="#l15.680"></a><span id="l15.680">   } while (sSize == (allocSize - 2));</span>
<a href="#l15.681"></a><span id="l15.681"> </span>
<a href="#l15.682"></a><span id="l15.682">   nsIMsgAccount *  pAccount;</span>
<a href="#l15.683"></a><span id="l15.683"> </span>
<a href="#l15.684"></a><span id="l15.684">   do</span>
<a href="#l15.685"></a><span id="l15.685">   {</span>
<a href="#l15.686"></a><span id="l15.686">     if (!sectionName.IsEmpty())</span>
<a href="#l15.687"></a><span id="l15.687">     {</span>
<a href="#l15.688"></a><span id="l15.688">       pAccount = nsnull;</span>
<a href="#l15.689"></a><span id="l15.689" class="difflineminus">-      valInt = ::GetPrivateProfileInt( sectionName.get(), &quot;UsesPOP&quot;, 1, iniPath.get());</span>
<a href="#l15.690"></a><span id="l15.690" class="difflineplus">+      valInt = ::GetPrivateProfileInt(sectionName.get(), &quot;UsesPOP&quot;, 1, iniPath.get());</span>
<a href="#l15.691"></a><span id="l15.691">       if (valInt)</span>
<a href="#l15.692"></a><span id="l15.692">       {</span>
<a href="#l15.693"></a><span id="l15.693">         // This is a POP account</span>
<a href="#l15.694"></a><span id="l15.694" class="difflineminus">-        if (BuildPOPAccount( accMgr, sectionName.get(), iniPath.get(), &amp;pAccount))</span>
<a href="#l15.695"></a><span id="l15.695" class="difflineplus">+        if (BuildPOPAccount(accMgr, sectionName.get(), iniPath.get(), &amp;pAccount))</span>
<a href="#l15.696"></a><span id="l15.696">         {</span>
<a href="#l15.697"></a><span id="l15.697">           accounts++;</span>
<a href="#l15.698"></a><span id="l15.698">           popCount++;</span>
<a href="#l15.699"></a><span id="l15.699">           if (popCount &gt; 1)</span>
<a href="#l15.700"></a><span id="l15.700">           {</span>
<a href="#l15.701"></a><span id="l15.701">             if (localMailAccount &amp;&amp; *localMailAccount)</span>
<a href="#l15.702"></a><span id="l15.702" class="difflineminus">-            {</span>
<a href="#l15.703"></a><span id="l15.703" class="difflineminus">-              NS_RELEASE( *localMailAccount);</span>
<a href="#l15.704"></a><span id="l15.704" class="difflineminus">-              *localMailAccount = nsnull;</span>
<a href="#l15.705"></a><span id="l15.705" class="difflineminus">-            }</span>
<a href="#l15.706"></a><span id="l15.706" class="difflineplus">+              NS_RELEASE(*localMailAccount);</span>
<a href="#l15.707"></a><span id="l15.707">           }</span>
<a href="#l15.708"></a><span id="l15.708" class="difflineminus">-          else</span>
<a href="#l15.709"></a><span id="l15.709" class="difflineplus">+          else if (localMailAccount)</span>
<a href="#l15.710"></a><span id="l15.710">           {</span>
<a href="#l15.711"></a><span id="l15.711" class="difflineminus">-            if (localMailAccount)</span>
<a href="#l15.712"></a><span id="l15.712" class="difflineminus">-            {</span>
<a href="#l15.713"></a><span id="l15.713" class="difflineminus">-              *localMailAccount = pAccount;</span>
<a href="#l15.714"></a><span id="l15.714" class="difflineminus">-              NS_IF_ADDREF( pAccount);</span>
<a href="#l15.715"></a><span id="l15.715" class="difflineminus">-            }</span>
<a href="#l15.716"></a><span id="l15.716" class="difflineplus">+            *localMailAccount = pAccount;</span>
<a href="#l15.717"></a><span id="l15.717" class="difflineplus">+            NS_IF_ADDREF(pAccount);</span>
<a href="#l15.718"></a><span id="l15.718">           }</span>
<a href="#l15.719"></a><span id="l15.719">         }</span>
<a href="#l15.720"></a><span id="l15.720">       }</span>
<a href="#l15.721"></a><span id="l15.721">       else</span>
<a href="#l15.722"></a><span id="l15.722">       {</span>
<a href="#l15.723"></a><span id="l15.723" class="difflineminus">-        valInt = ::GetPrivateProfileInt( sectionName.get(), &quot;UsesIMAP&quot;, 0, iniPath.get());</span>
<a href="#l15.724"></a><span id="l15.724" class="difflineplus">+        valInt = ::GetPrivateProfileInt(sectionName.get(), &quot;UsesIMAP&quot;, 0, iniPath.get());</span>
<a href="#l15.725"></a><span id="l15.725">         if (valInt)</span>
<a href="#l15.726"></a><span id="l15.726">         {</span>
<a href="#l15.727"></a><span id="l15.727">           // This is an IMAP account</span>
<a href="#l15.728"></a><span id="l15.728" class="difflineminus">-          if (BuildIMAPAccount( accMgr, sectionName.get(), iniPath.get(), &amp;pAccount))</span>
<a href="#l15.729"></a><span id="l15.729" class="difflineplus">+          if (BuildIMAPAccount(accMgr, sectionName.get(), iniPath.get(), &amp;pAccount))</span>
<a href="#l15.730"></a><span id="l15.730">             accounts++;</span>
<a href="#l15.731"></a><span id="l15.731">         }</span>
<a href="#l15.732"></a><span id="l15.732">       }</span>
<a href="#l15.733"></a><span id="l15.733">       if (pAccount &amp;&amp; (sOffset == 0))</span>
<a href="#l15.734"></a><span id="l15.734" class="difflineminus">-        accMgr-&gt;SetDefaultAccount( pAccount);</span>
<a href="#l15.735"></a><span id="l15.735" class="difflineplus">+        accMgr-&gt;SetDefaultAccount(pAccount);</span>
<a href="#l15.736"></a><span id="l15.736"> </span>
<a href="#l15.737"></a><span id="l15.737" class="difflineminus">-      NS_IF_RELEASE( pAccount);</span>
<a href="#l15.738"></a><span id="l15.738" class="difflineplus">+      NS_IF_RELEASE(pAccount);</span>
<a href="#l15.739"></a><span id="l15.739">     }</span>
<a href="#l15.740"></a><span id="l15.740"> </span>
<a href="#l15.741"></a><span id="l15.741">     sectionName.Truncate();</span>
<a href="#l15.742"></a><span id="l15.742">     while ((sOffset &lt; sSize) &amp;&amp; (section.m_pBuffer[sOffset] != '='))</span>
<a href="#l15.743"></a><span id="l15.743">       sOffset++;</span>
<a href="#l15.744"></a><span id="l15.744">     sOffset++;</span>
<a href="#l15.745"></a><span id="l15.745">     start = sOffset;</span>
<a href="#l15.746"></a><span id="l15.746">     while ((sOffset &lt; sSize) &amp;&amp; (section.m_pBuffer[sOffset] != 0))</span>
<a href="#l15.747"></a><span id="l15.747">       sOffset++;</span>
<a href="#l15.748"></a><span id="l15.748">     if (sOffset &gt; start)</span>
<a href="#l15.749"></a><span id="l15.749">     {</span>
<a href="#l15.750"></a><span id="l15.750" class="difflineminus">-      sectionName.Append( section.m_pBuffer + start, sOffset - start);</span>
<a href="#l15.751"></a><span id="l15.751" class="difflineminus">-      sectionName.Trim( kWhitespace);</span>
<a href="#l15.752"></a><span id="l15.752" class="difflineplus">+      sectionName.Append(section.m_pBuffer + start, sOffset - start);</span>
<a href="#l15.753"></a><span id="l15.753" class="difflineplus">+      sectionName.Trim(kWhitespace);</span>
<a href="#l15.754"></a><span id="l15.754">     }</span>
<a href="#l15.755"></a><span id="l15.755"> </span>
<a href="#l15.756"></a><span id="l15.756">   } while (sOffset &lt; sSize);</span>
<a href="#l15.757"></a><span id="l15.757"> </span>
<a href="#l15.758"></a><span id="l15.758">   // Now save the new acct info to pref file.</span>
<a href="#l15.759"></a><span id="l15.759">   rv = accMgr-&gt;SaveAccountInfo();</span>
<a href="#l15.760"></a><span id="l15.760">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Can't save account info to pref file&quot;);</span>
<a href="#l15.761"></a><span id="l15.761"> </span>
<a href="#l15.762"></a><span id="l15.762"> </span>
<a href="#l15.763"></a><span id="l15.763" class="difflineminus">-  return( accounts != 0);</span>
<a href="#l15.764"></a><span id="l15.764" class="difflineplus">+  return accounts != 0;</span>
<a href="#l15.765"></a><span id="l15.765"> }</span>
<a href="#l15.766"></a><span id="l15.766"> </span>
<a href="#l15.767"></a><span id="l15.767" class="difflineminus">-bool nsEudoraWin32::FindFiltersFile( nsIFile **pFiltersFile)</span>
<a href="#l15.768"></a><span id="l15.768" class="difflineplus">+bool nsEudoraWin32::FindFiltersFile(nsIFile **pFiltersFile)</span>
<a href="#l15.769"></a><span id="l15.769"> {</span>
<a href="#l15.770"></a><span id="l15.770" class="difflineminus">-  bool result = FindEudoraLocation( pFiltersFile, false);</span>
<a href="#l15.771"></a><span id="l15.771" class="difflineplus">+  bool result = FindEudoraLocation(pFiltersFile, false);</span>
<a href="#l15.772"></a><span id="l15.772"> </span>
<a href="#l15.773"></a><span id="l15.773">   if (result)</span>
<a href="#l15.774"></a><span id="l15.774">   {</span>
<a href="#l15.775"></a><span id="l15.775" class="difflineminus">-    (*pFiltersFile)-&gt;AppendNative( NS_LITERAL_CSTRING(&quot;Filters.pce&quot;) );</span>
<a href="#l15.776"></a><span id="l15.776" class="difflineplus">+    (*pFiltersFile)-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Filters.pce&quot;));</span>
<a href="#l15.777"></a><span id="l15.777">     (*pFiltersFile)-&gt;IsFile(&amp;result);</span>
<a href="#l15.778"></a><span id="l15.778">   }</span>
<a href="#l15.779"></a><span id="l15.779"> </span>
<a href="#l15.780"></a><span id="l15.780">   return result;</span>
<a href="#l15.781"></a><span id="l15.781"> }</span>
<a href="#l15.782"></a><span id="l15.782"> </span>
<a href="#l15.783"></a><span id="l15.783" class="difflineminus">-bool nsEudoraWin32::GetMailboxNameHierarchy( const nsACString&amp; pEudoraLocation, const char* pEudoraFilePath, nsCString&amp; nameHierarchy)</span>
<a href="#l15.784"></a><span id="l15.784" class="difflineplus">+bool nsEudoraWin32::GetMailboxNameHierarchy(const nsACString&amp; pEudoraLocation, const char* pEudoraFilePath, nsCString&amp; nameHierarchy)</span>
<a href="#l15.785"></a><span id="l15.785"> {</span>
<a href="#l15.786"></a><span id="l15.786">   if (pEudoraLocation.IsEmpty() || !pEudoraFilePath || !*pEudoraFilePath)</span>
<a href="#l15.787"></a><span id="l15.787">     return false;</span>
<a href="#l15.788"></a><span id="l15.788"> </span>
<a href="#l15.789"></a><span id="l15.789">   nsresult rv;</span>
<a href="#l15.790"></a><span id="l15.790">   nsCOMPtr &lt;nsILocalFile&gt; descMap = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l15.791"></a><span id="l15.791"> </span>
<a href="#l15.792"></a><span id="l15.792">   rv = descMap-&gt;InitWithNativePath(pEudoraLocation);</span>
<a href="#l15.793"></a><span id="l15.793" class="difflineat">@@ -769,56 +761,56 @@ bool nsEudoraWin32::GetMailboxNameHierar</span>
<a href="#l15.794"></a><span id="l15.794"> </span>
<a href="#l15.795"></a><span id="l15.795">   return false;</span>
<a href="#l15.796"></a><span id="l15.796"> }</span>
<a href="#l15.797"></a><span id="l15.797"> </span>
<a href="#l15.798"></a><span id="l15.798"> // maximium size of settings strings</span>
<a href="#l15.799"></a><span id="l15.799"> #define  kIniValueSize    384</span>
<a href="#l15.800"></a><span id="l15.800"> </span>
<a href="#l15.801"></a><span id="l15.801"> </span>
<a href="#l15.802"></a><span id="l15.802" class="difflineminus">-void nsEudoraWin32::GetServerAndUserName( const char *pSection, const char *pIni, nsCString&amp; serverName, nsCString&amp; userName, char *pBuff)</span>
<a href="#l15.803"></a><span id="l15.803" class="difflineplus">+void nsEudoraWin32::GetServerAndUserName(const char *pSection, const char *pIni, nsCString&amp; serverName, nsCString&amp; userName, char *pBuff)</span>
<a href="#l15.804"></a><span id="l15.804"> {</span>
<a href="#l15.805"></a><span id="l15.805">   DWORD    valSize;</span>
<a href="#l15.806"></a><span id="l15.806">   int      idx;</span>
<a href="#l15.807"></a><span id="l15.807">   nsCString  tStr;</span>
<a href="#l15.808"></a><span id="l15.808"> </span>
<a href="#l15.809"></a><span id="l15.809">   serverName.Truncate();</span>
<a href="#l15.810"></a><span id="l15.810">   userName.Truncate();</span>
<a href="#l15.811"></a><span id="l15.811"> </span>
<a href="#l15.812"></a><span id="l15.812" class="difflineminus">-  valSize = ::GetPrivateProfileString( pSection, &quot;PopServer&quot;, &quot;&quot;, pBuff, kIniValueSize, pIni);</span>
<a href="#l15.813"></a><span id="l15.813" class="difflineplus">+  valSize = ::GetPrivateProfileString(pSection, &quot;PopServer&quot;, &quot;&quot;, pBuff, kIniValueSize, pIni);</span>
<a href="#l15.814"></a><span id="l15.814">   if (valSize)</span>
<a href="#l15.815"></a><span id="l15.815">     serverName = pBuff;</span>
<a href="#l15.816"></a><span id="l15.816">   else</span>
<a href="#l15.817"></a><span id="l15.817">   {</span>
<a href="#l15.818"></a><span id="l15.818" class="difflineminus">-    valSize = ::GetPrivateProfileString( pSection, &quot;POPAccount&quot;, &quot;&quot;, pBuff, kIniValueSize, pIni);</span>
<a href="#l15.819"></a><span id="l15.819" class="difflineplus">+    valSize = ::GetPrivateProfileString(pSection, &quot;POPAccount&quot;, &quot;&quot;, pBuff, kIniValueSize, pIni);</span>
<a href="#l15.820"></a><span id="l15.820">     if (valSize)</span>
<a href="#l15.821"></a><span id="l15.821">     {</span>
<a href="#l15.822"></a><span id="l15.822">       serverName = pBuff;</span>
<a href="#l15.823"></a><span id="l15.823" class="difflineminus">-      idx = serverName.FindChar( '@');</span>
<a href="#l15.824"></a><span id="l15.824" class="difflineplus">+      idx = serverName.FindChar('@');</span>
<a href="#l15.825"></a><span id="l15.825">       if (idx != -1)</span>
<a href="#l15.826"></a><span id="l15.826">         serverName = Substring(serverName, idx + 1);</span>
<a href="#l15.827"></a><span id="l15.827">     }</span>
<a href="#l15.828"></a><span id="l15.828">   }</span>
<a href="#l15.829"></a><span id="l15.829" class="difflineminus">-  valSize = ::GetPrivateProfileString( pSection, &quot;LoginName&quot;, &quot;&quot;, pBuff, kIniValueSize, pIni);</span>
<a href="#l15.830"></a><span id="l15.830" class="difflineplus">+  valSize = ::GetPrivateProfileString(pSection, &quot;LoginName&quot;, &quot;&quot;, pBuff, kIniValueSize, pIni);</span>
<a href="#l15.831"></a><span id="l15.831">   if (valSize)</span>
<a href="#l15.832"></a><span id="l15.832">     userName = pBuff;</span>
<a href="#l15.833"></a><span id="l15.833">   else</span>
<a href="#l15.834"></a><span id="l15.834">   {</span>
<a href="#l15.835"></a><span id="l15.835" class="difflineminus">-    valSize = ::GetPrivateProfileString( pSection, &quot;POPAccount&quot;, &quot;&quot;, pBuff, kIniValueSize, pIni);</span>
<a href="#l15.836"></a><span id="l15.836" class="difflineplus">+    valSize = ::GetPrivateProfileString(pSection, &quot;POPAccount&quot;, &quot;&quot;, pBuff, kIniValueSize, pIni);</span>
<a href="#l15.837"></a><span id="l15.837">     if (valSize)</span>
<a href="#l15.838"></a><span id="l15.838">     {</span>
<a href="#l15.839"></a><span id="l15.839">       userName = pBuff;</span>
<a href="#l15.840"></a><span id="l15.840" class="difflineminus">-      idx = userName.FindChar( '@');</span>
<a href="#l15.841"></a><span id="l15.841" class="difflineplus">+      idx = userName.FindChar('@');</span>
<a href="#l15.842"></a><span id="l15.842">       if (idx != -1)</span>
<a href="#l15.843"></a><span id="l15.843">         userName.SetLength(idx);</span>
<a href="#l15.844"></a><span id="l15.844">     }</span>
<a href="#l15.845"></a><span id="l15.845">   }</span>
<a href="#l15.846"></a><span id="l15.846"> }</span>
<a href="#l15.847"></a><span id="l15.847"> </span>
<a href="#l15.848"></a><span id="l15.848" class="difflineminus">-void nsEudoraWin32::GetAccountName( const char *pSection, nsString&amp; str)</span>
<a href="#l15.849"></a><span id="l15.849" class="difflineplus">+void nsEudoraWin32::GetAccountName(const char *pSection, nsString&amp; str)</span>
<a href="#l15.850"></a><span id="l15.850"> {</span>
<a href="#l15.851"></a><span id="l15.851">   str.Truncate();</span>
<a href="#l15.852"></a><span id="l15.852"> </span>
<a href="#l15.853"></a><span id="l15.853">   nsCString s(pSection);</span>
<a href="#l15.854"></a><span id="l15.854"> </span>
<a href="#l15.855"></a><span id="l15.855">   if (s.LowerCaseEqualsLiteral(&quot;settings&quot;))</span>
<a href="#l15.856"></a><span id="l15.856">   {</span>
<a href="#l15.857"></a><span id="l15.857">     str.AssignLiteral(&quot;Eudora &quot;);</span>
<a href="#l15.858"></a><span id="l15.858" class="difflineat">@@ -828,236 +820,236 @@ void nsEudoraWin32::GetAccountName( cons</span>
<a href="#l15.859"></a><span id="l15.859">   {</span>
<a href="#l15.860"></a><span id="l15.860">     str.AssignASCII(pSection);</span>
<a href="#l15.861"></a><span id="l15.861">     if (StringBeginsWith(s, NS_LITERAL_CSTRING(&quot;persona-&quot;), nsCaseInsensitiveCStringComparator()))</span>
<a href="#l15.862"></a><span id="l15.862">       CopyASCIItoUTF16(Substring(s, 8), str);</span>
<a href="#l15.863"></a><span id="l15.863">   }</span>
<a href="#l15.864"></a><span id="l15.864"> }</span>
<a href="#l15.865"></a><span id="l15.865"> </span>
<a href="#l15.866"></a><span id="l15.866"> </span>
<a href="#l15.867"></a><span id="l15.867" class="difflineminus">-bool nsEudoraWin32::BuildPOPAccount( nsIMsgAccountManager *accMgr, const char *pSection, const char *pIni, nsIMsgAccount **ppAccount)</span>
<a href="#l15.868"></a><span id="l15.868" class="difflineplus">+bool nsEudoraWin32::BuildPOPAccount(nsIMsgAccountManager *accMgr, const char *pSection, const char *pIni, nsIMsgAccount **ppAccount)</span>
<a href="#l15.869"></a><span id="l15.869"> {</span>
<a href="#l15.870"></a><span id="l15.870">   if (ppAccount)</span>
<a href="#l15.871"></a><span id="l15.871">     *ppAccount = nsnull;</span>
<a href="#l15.872"></a><span id="l15.872"> </span>
<a href="#l15.873"></a><span id="l15.873">   char valBuff[kIniValueSize];</span>
<a href="#l15.874"></a><span id="l15.874">   nsCString serverName;</span>
<a href="#l15.875"></a><span id="l15.875">   nsCString userName;</span>
<a href="#l15.876"></a><span id="l15.876"> </span>
<a href="#l15.877"></a><span id="l15.877" class="difflineminus">-  GetServerAndUserName( pSection, pIni, serverName, userName, valBuff);</span>
<a href="#l15.878"></a><span id="l15.878" class="difflineplus">+  GetServerAndUserName(pSection, pIni, serverName, userName, valBuff);</span>
<a href="#l15.879"></a><span id="l15.879"> </span>
<a href="#l15.880"></a><span id="l15.880">   if (serverName.IsEmpty() || userName.IsEmpty())</span>
<a href="#l15.881"></a><span id="l15.881" class="difflineminus">-    return( false);</span>
<a href="#l15.882"></a><span id="l15.882" class="difflineplus">+    return false;</span>
<a href="#l15.883"></a><span id="l15.883"> </span>
<a href="#l15.884"></a><span id="l15.884">   bool result = false;</span>
<a href="#l15.885"></a><span id="l15.885"> </span>
<a href="#l15.886"></a><span id="l15.886">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l15.887"></a><span id="l15.887">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l15.888"></a><span id="l15.888" class="difflineminus">-  nsresult rv = accMgr-&gt;FindServer( userName, serverName, NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l15.889"></a><span id="l15.889" class="difflineplus">+  nsresult rv = accMgr-&gt;FindServer(userName, serverName, NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l15.890"></a><span id="l15.890">   if (NS_FAILED(rv) || !in)</span>
<a href="#l15.891"></a><span id="l15.891">   {</span>
<a href="#l15.892"></a><span id="l15.892">     // Create the incoming server and an account for it?</span>
<a href="#l15.893"></a><span id="l15.893" class="difflineminus">-    rv = accMgr-&gt;CreateIncomingServer( userName, serverName, NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l15.894"></a><span id="l15.894" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; in)</span>
<a href="#l15.895"></a><span id="l15.895" class="difflineplus">+    rv = accMgr-&gt;CreateIncomingServer(userName, serverName, NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l15.896"></a><span id="l15.896" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; in)</span>
<a href="#l15.897"></a><span id="l15.897">     {</span>
<a href="#l15.898"></a><span id="l15.898">       rv = in-&gt;SetType(NS_LITERAL_CSTRING(&quot;pop3&quot;));</span>
<a href="#l15.899"></a><span id="l15.899" class="difflineminus">-      // rv = in-&gt;SetHostName( serverName);</span>
<a href="#l15.900"></a><span id="l15.900" class="difflineminus">-      // rv = in-&gt;SetUsername( userName);</span>
<a href="#l15.901"></a><span id="l15.901" class="difflineplus">+      // rv = in-&gt;SetHostName(serverName);</span>
<a href="#l15.902"></a><span id="l15.902" class="difflineplus">+      // rv = in-&gt;SetUsername(userName);</span>
<a href="#l15.903"></a><span id="l15.903"> </span>
<a href="#l15.904"></a><span id="l15.904" class="difflineminus">-      IMPORT_LOG2( &quot;Created POP3 server named: %s, userName: %s\n&quot;, serverName.get(), userName.get());</span>
<a href="#l15.905"></a><span id="l15.905" class="difflineplus">+      IMPORT_LOG2(&quot;Created POP3 server named: %s, userName: %s\n&quot;, serverName.get(), userName.get());</span>
<a href="#l15.906"></a><span id="l15.906"> </span>
<a href="#l15.907"></a><span id="l15.907">       nsString prettyName;</span>
<a href="#l15.908"></a><span id="l15.908" class="difflineminus">-      GetAccountName( pSection, prettyName);</span>
<a href="#l15.909"></a><span id="l15.909" class="difflineminus">-      IMPORT_LOG1( &quot;\tSet pretty name to: %S\n&quot;, prettyName.get());</span>
<a href="#l15.910"></a><span id="l15.910" class="difflineminus">-      rv = in-&gt;SetPrettyName( prettyName);</span>
<a href="#l15.911"></a><span id="l15.911" class="difflineplus">+      GetAccountName(pSection, prettyName);</span>
<a href="#l15.912"></a><span id="l15.912" class="difflineplus">+      IMPORT_LOG1(&quot;\tSet pretty name to: %S\n&quot;, prettyName.get());</span>
<a href="#l15.913"></a><span id="l15.913" class="difflineplus">+      rv = in-&gt;SetPrettyName(prettyName);</span>
<a href="#l15.914"></a><span id="l15.914"> </span>
<a href="#l15.915"></a><span id="l15.915">       // We have a server, create an account.</span>
<a href="#l15.916"></a><span id="l15.916">       nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l15.917"></a><span id="l15.917" class="difflineminus">-      rv = accMgr-&gt;CreateAccount( getter_AddRefs( account));</span>
<a href="#l15.918"></a><span id="l15.918" class="difflineminus">-      if (NS_SUCCEEDED( rv) &amp;&amp; account)</span>
<a href="#l15.919"></a><span id="l15.919" class="difflineplus">+      rv = accMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l15.920"></a><span id="l15.920" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; account)</span>
<a href="#l15.921"></a><span id="l15.921">       {</span>
<a href="#l15.922"></a><span id="l15.922" class="difflineminus">-        rv = account-&gt;SetIncomingServer( in);</span>
<a href="#l15.923"></a><span id="l15.923" class="difflineplus">+        rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l15.924"></a><span id="l15.924"> </span>
<a href="#l15.925"></a><span id="l15.925" class="difflineminus">-        IMPORT_LOG0( &quot;Created a new account and set the incoming server to the POP3 server.\n&quot;);</span>
<a href="#l15.926"></a><span id="l15.926" class="difflineplus">+        IMPORT_LOG0(&quot;Created a new account and set the incoming server to the POP3 server.\n&quot;);</span>
<a href="#l15.927"></a><span id="l15.927"> </span>
<a href="#l15.928"></a><span id="l15.928">         nsCOMPtr&lt;nsIPop3IncomingServer&gt; pop3Server = do_QueryInterface(in, &amp;rv);</span>
<a href="#l15.929"></a><span id="l15.929">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.930"></a><span id="l15.930">         UINT valInt = ::GetPrivateProfileInt(pSection, &quot;LeaveMailOnServer&quot;, 0, pIni);</span>
<a href="#l15.931"></a><span id="l15.931">         pop3Server-&gt;SetLeaveMessagesOnServer(valInt ? true : false);</span>
<a href="#l15.932"></a><span id="l15.932"> </span>
<a href="#l15.933"></a><span id="l15.933">         // Fiddle with the identities</span>
<a href="#l15.934"></a><span id="l15.934">         SetIdentities(accMgr, account, pSection, pIni, userName.get(), serverName.get(), valBuff);</span>
<a href="#l15.935"></a><span id="l15.935">         result = true;</span>
<a href="#l15.936"></a><span id="l15.936">         if (ppAccount)</span>
<a href="#l15.937"></a><span id="l15.937" class="difflineminus">-          account-&gt;QueryInterface( NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l15.938"></a><span id="l15.938" class="difflineplus">+          account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l15.939"></a><span id="l15.939">       }</span>
<a href="#l15.940"></a><span id="l15.940">     }</span>
<a href="#l15.941"></a><span id="l15.941">   }</span>
<a href="#l15.942"></a><span id="l15.942">   else</span>
<a href="#l15.943"></a><span id="l15.943">     result = true;</span>
<a href="#l15.944"></a><span id="l15.944"> </span>
<a href="#l15.945"></a><span id="l15.945" class="difflineminus">-  return( result);</span>
<a href="#l15.946"></a><span id="l15.946" class="difflineplus">+  return result;</span>
<a href="#l15.947"></a><span id="l15.947"> }</span>
<a href="#l15.948"></a><span id="l15.948"> </span>
<a href="#l15.949"></a><span id="l15.949" class="difflineminus">-bool nsEudoraWin32::BuildIMAPAccount( nsIMsgAccountManager *accMgr, const char *pSection, const char *pIni, nsIMsgAccount **ppAccount)</span>
<a href="#l15.950"></a><span id="l15.950" class="difflineplus">+bool nsEudoraWin32::BuildIMAPAccount(nsIMsgAccountManager *accMgr, const char *pSection, const char *pIni, nsIMsgAccount **ppAccount)</span>
<a href="#l15.951"></a><span id="l15.951"> {</span>
<a href="#l15.952"></a><span id="l15.952">   char valBuff[kIniValueSize];</span>
<a href="#l15.953"></a><span id="l15.953">   nsCString serverName;</span>
<a href="#l15.954"></a><span id="l15.954">   nsCString userName;</span>
<a href="#l15.955"></a><span id="l15.955"> </span>
<a href="#l15.956"></a><span id="l15.956" class="difflineminus">-  GetServerAndUserName( pSection, pIni, serverName, userName, valBuff);</span>
<a href="#l15.957"></a><span id="l15.957" class="difflineplus">+  GetServerAndUserName(pSection, pIni, serverName, userName, valBuff);</span>
<a href="#l15.958"></a><span id="l15.958"> </span>
<a href="#l15.959"></a><span id="l15.959">   if (serverName.IsEmpty() || userName.IsEmpty())</span>
<a href="#l15.960"></a><span id="l15.960" class="difflineminus">-    return( false);</span>
<a href="#l15.961"></a><span id="l15.961" class="difflineplus">+    return false;</span>
<a href="#l15.962"></a><span id="l15.962"> </span>
<a href="#l15.963"></a><span id="l15.963">   bool result = false;</span>
<a href="#l15.964"></a><span id="l15.964"> </span>
<a href="#l15.965"></a><span id="l15.965">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l15.966"></a><span id="l15.966" class="difflineminus">-  nsresult rv = accMgr-&gt;FindServer( userName, serverName, NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l15.967"></a><span id="l15.967" class="difflineminus">-  if (NS_FAILED( rv) || (in == nsnull))</span>
<a href="#l15.968"></a><span id="l15.968" class="difflineplus">+  nsresult rv = accMgr-&gt;FindServer(userName, serverName, NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l15.969"></a><span id="l15.969" class="difflineplus">+  if (NS_FAILED(rv) || (in == nsnull))</span>
<a href="#l15.970"></a><span id="l15.970">   {</span>
<a href="#l15.971"></a><span id="l15.971">     // Create the incoming server and an account for it?</span>
<a href="#l15.972"></a><span id="l15.972" class="difflineminus">-    rv = accMgr-&gt;CreateIncomingServer( userName, serverName, NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l15.973"></a><span id="l15.973" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; in)</span>
<a href="#l15.974"></a><span id="l15.974" class="difflineplus">+    rv = accMgr-&gt;CreateIncomingServer(userName, serverName, NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l15.975"></a><span id="l15.975" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; in)</span>
<a href="#l15.976"></a><span id="l15.976">     {</span>
<a href="#l15.977"></a><span id="l15.977">       rv = in-&gt;SetType(NS_LITERAL_CSTRING(&quot;imap&quot;));</span>
<a href="#l15.978"></a><span id="l15.978" class="difflineminus">-      // rv = in-&gt;SetHostName( serverName);</span>
<a href="#l15.979"></a><span id="l15.979" class="difflineminus">-      // rv = in-&gt;SetUsername( userName);</span>
<a href="#l15.980"></a><span id="l15.980" class="difflineplus">+      // rv = in-&gt;SetHostName(serverName);</span>
<a href="#l15.981"></a><span id="l15.981" class="difflineplus">+      // rv = in-&gt;SetUsername(userName);</span>
<a href="#l15.982"></a><span id="l15.982"> </span>
<a href="#l15.983"></a><span id="l15.983" class="difflineminus">-      IMPORT_LOG2( &quot;Created IMAP server named: %s, userName: %s\n&quot;, serverName.get(), userName.get());</span>
<a href="#l15.984"></a><span id="l15.984" class="difflineplus">+      IMPORT_LOG2(&quot;Created IMAP server named: %s, userName: %s\n&quot;, serverName.get(), userName.get());</span>
<a href="#l15.985"></a><span id="l15.985"> </span>
<a href="#l15.986"></a><span id="l15.986">       nsString prettyName;</span>
<a href="#l15.987"></a><span id="l15.987" class="difflineminus">-      GetAccountName( pSection, prettyName);</span>
<a href="#l15.988"></a><span id="l15.988" class="difflineminus">-      IMPORT_LOG1( &quot;\tSet pretty name to: %S\n&quot;, prettyName.get());</span>
<a href="#l15.989"></a><span id="l15.989" class="difflineplus">+      GetAccountName(pSection, prettyName);</span>
<a href="#l15.990"></a><span id="l15.990" class="difflineplus">+      IMPORT_LOG1(&quot;\tSet pretty name to: %S\n&quot;, prettyName.get());</span>
<a href="#l15.991"></a><span id="l15.991">       rv = in-&gt;SetPrettyName(prettyName);</span>
<a href="#l15.992"></a><span id="l15.992"> </span>
<a href="#l15.993"></a><span id="l15.993">       // We have a server, create an account.</span>
<a href="#l15.994"></a><span id="l15.994">       nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l15.995"></a><span id="l15.995" class="difflineminus">-      rv = accMgr-&gt;CreateAccount( getter_AddRefs( account));</span>
<a href="#l15.996"></a><span id="l15.996" class="difflineminus">-      if (NS_SUCCEEDED( rv) &amp;&amp; account)</span>
<a href="#l15.997"></a><span id="l15.997" class="difflineplus">+      rv = accMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l15.998"></a><span id="l15.998" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; account)</span>
<a href="#l15.999"></a><span id="l15.999">       {</span>
<a href="#l15.1000"></a><span id="l15.1000">         rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l15.1001"></a><span id="l15.1001"> </span>
<a href="#l15.1002"></a><span id="l15.1002" class="difflineminus">-        IMPORT_LOG0( &quot;Created an account and set the IMAP server as the incoming server\n&quot;);</span>
<a href="#l15.1003"></a><span id="l15.1003" class="difflineplus">+        IMPORT_LOG0(&quot;Created an account and set the IMAP server as the incoming server\n&quot;);</span>
<a href="#l15.1004"></a><span id="l15.1004"> </span>
<a href="#l15.1005"></a><span id="l15.1005">         // Fiddle with the identities</span>
<a href="#l15.1006"></a><span id="l15.1006">         SetIdentities(accMgr, account, pSection, pIni, userName.get(), serverName.get(), valBuff);</span>
<a href="#l15.1007"></a><span id="l15.1007">         result = true;</span>
<a href="#l15.1008"></a><span id="l15.1008">         if (ppAccount)</span>
<a href="#l15.1009"></a><span id="l15.1009" class="difflineminus">-          account-&gt;QueryInterface( NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l15.1010"></a><span id="l15.1010" class="difflineplus">+          account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l15.1011"></a><span id="l15.1011">       }</span>
<a href="#l15.1012"></a><span id="l15.1012">     }</span>
<a href="#l15.1013"></a><span id="l15.1013">   }</span>
<a href="#l15.1014"></a><span id="l15.1014">   else</span>
<a href="#l15.1015"></a><span id="l15.1015">     result = true;</span>
<a href="#l15.1016"></a><span id="l15.1016"> </span>
<a href="#l15.1017"></a><span id="l15.1017" class="difflineminus">-  return( result);</span>
<a href="#l15.1018"></a><span id="l15.1018" class="difflineplus">+  return result;</span>
<a href="#l15.1019"></a><span id="l15.1019"> }</span>
<a href="#l15.1020"></a><span id="l15.1020"> </span>
<a href="#l15.1021"></a><span id="l15.1021"> void nsEudoraWin32::SetIdentities(nsIMsgAccountManager *accMgr, nsIMsgAccount *acc, const char *pSection, const char *pIniFile, const char *userName, const char *serverName, char *pBuff)</span>
<a href="#l15.1022"></a><span id="l15.1022"> {</span>
<a href="#l15.1023"></a><span id="l15.1023">   nsCAutoString realName;</span>
<a href="#l15.1024"></a><span id="l15.1024">   nsCAutoString email;</span>
<a href="#l15.1025"></a><span id="l15.1025">   nsCAutoString server;</span>
<a href="#l15.1026"></a><span id="l15.1026">   DWORD valSize;</span>
<a href="#l15.1027"></a><span id="l15.1027">   nsresult rv;</span>
<a href="#l15.1028"></a><span id="l15.1028"> </span>
<a href="#l15.1029"></a><span id="l15.1029" class="difflineminus">-  valSize = ::GetPrivateProfileString( pSection, &quot;RealName&quot;, &quot;&quot;, pBuff, kIniValueSize, pIniFile);</span>
<a href="#l15.1030"></a><span id="l15.1030" class="difflineplus">+  valSize = ::GetPrivateProfileString(pSection, &quot;RealName&quot;, &quot;&quot;, pBuff, kIniValueSize, pIniFile);</span>
<a href="#l15.1031"></a><span id="l15.1031">   if (valSize)</span>
<a href="#l15.1032"></a><span id="l15.1032">     realName = pBuff;</span>
<a href="#l15.1033"></a><span id="l15.1033" class="difflineminus">-  valSize = ::GetPrivateProfileString( pSection, &quot;SMTPServer&quot;, &quot;&quot;, pBuff, kIniValueSize, pIniFile);</span>
<a href="#l15.1034"></a><span id="l15.1034" class="difflineplus">+  valSize = ::GetPrivateProfileString(pSection, &quot;SMTPServer&quot;, &quot;&quot;, pBuff, kIniValueSize, pIniFile);</span>
<a href="#l15.1035"></a><span id="l15.1035">   if (valSize)</span>
<a href="#l15.1036"></a><span id="l15.1036">     server = pBuff;</span>
<a href="#l15.1037"></a><span id="l15.1037" class="difflineminus">-  valSize = ::GetPrivateProfileString( pSection, &quot;ReturnAddress&quot;, &quot;&quot;, pBuff, kIniValueSize, pIniFile);</span>
<a href="#l15.1038"></a><span id="l15.1038" class="difflineplus">+  valSize = ::GetPrivateProfileString(pSection, &quot;ReturnAddress&quot;, &quot;&quot;, pBuff, kIniValueSize, pIniFile);</span>
<a href="#l15.1039"></a><span id="l15.1039">   if (valSize)</span>
<a href="#l15.1040"></a><span id="l15.1040">     email = pBuff;</span>
<a href="#l15.1041"></a><span id="l15.1041"> </span>
<a href="#l15.1042"></a><span id="l15.1042">   nsCOMPtr&lt;nsIMsgIdentity&gt; id;</span>
<a href="#l15.1043"></a><span id="l15.1043" class="difflineminus">-  rv = accMgr-&gt;CreateIdentity( getter_AddRefs( id));</span>
<a href="#l15.1044"></a><span id="l15.1044" class="difflineplus">+  rv = accMgr-&gt;CreateIdentity(getter_AddRefs(id));</span>
<a href="#l15.1045"></a><span id="l15.1045">   if (id)</span>
<a href="#l15.1046"></a><span id="l15.1046">   {</span>
<a href="#l15.1047"></a><span id="l15.1047">     nsAutoString fullName;</span>
<a href="#l15.1048"></a><span id="l15.1048">     fullName.Assign(NS_ConvertASCIItoUTF16(realName));</span>
<a href="#l15.1049"></a><span id="l15.1049">     id-&gt;SetFullName(fullName);</span>
<a href="#l15.1050"></a><span id="l15.1050">     id-&gt;SetIdentityName(fullName);</span>
<a href="#l15.1051"></a><span id="l15.1051">     if (email.IsEmpty())</span>
<a href="#l15.1052"></a><span id="l15.1052">     {</span>
<a href="#l15.1053"></a><span id="l15.1053">       email = userName;</span>
<a href="#l15.1054"></a><span id="l15.1054">       email += &quot;@&quot;;</span>
<a href="#l15.1055"></a><span id="l15.1055">       email += serverName;</span>
<a href="#l15.1056"></a><span id="l15.1056">     }</span>
<a href="#l15.1057"></a><span id="l15.1057">     id-&gt;SetEmail(email);</span>
<a href="#l15.1058"></a><span id="l15.1058" class="difflineminus">-    acc-&gt;AddIdentity( id);</span>
<a href="#l15.1059"></a><span id="l15.1059" class="difflineplus">+    acc-&gt;AddIdentity(id);</span>
<a href="#l15.1060"></a><span id="l15.1060"> </span>
<a href="#l15.1061"></a><span id="l15.1061" class="difflineminus">-    IMPORT_LOG0( &quot;Created identity and added to the account\n&quot;);</span>
<a href="#l15.1062"></a><span id="l15.1062" class="difflineminus">-    IMPORT_LOG1( &quot;\tname: %s\n&quot;, realName.get());</span>
<a href="#l15.1063"></a><span id="l15.1063" class="difflineminus">-    IMPORT_LOG1( &quot;\temail: %s\n&quot;, email.get());</span>
<a href="#l15.1064"></a><span id="l15.1064" class="difflineplus">+    IMPORT_LOG0(&quot;Created identity and added to the account\n&quot;);</span>
<a href="#l15.1065"></a><span id="l15.1065" class="difflineplus">+    IMPORT_LOG1(&quot;\tname: %s\n&quot;, realName.get());</span>
<a href="#l15.1066"></a><span id="l15.1066" class="difflineplus">+    IMPORT_LOG1(&quot;\temail: %s\n&quot;, email.get());</span>
<a href="#l15.1067"></a><span id="l15.1067">   }</span>
<a href="#l15.1068"></a><span id="l15.1068" class="difflineminus">-  SetSmtpServer( accMgr, acc, server.get(), userName);</span>
<a href="#l15.1069"></a><span id="l15.1069" class="difflineplus">+  SetSmtpServer(accMgr, acc, server.get(), userName);</span>
<a href="#l15.1070"></a><span id="l15.1070"> }</span>
<a href="#l15.1071"></a><span id="l15.1071"> </span>
<a href="#l15.1072"></a><span id="l15.1072"> </span>
<a href="#l15.1073"></a><span id="l15.1073" class="difflineminus">-void nsEudoraWin32::SetSmtpServer( nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, const char *pServer, const char *pUser)</span>
<a href="#l15.1074"></a><span id="l15.1074" class="difflineplus">+void nsEudoraWin32::SetSmtpServer(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, const char *pServer, const char *pUser)</span>
<a href="#l15.1075"></a><span id="l15.1075"> {</span>
<a href="#l15.1076"></a><span id="l15.1076">   nsresult  rv;</span>
<a href="#l15.1077"></a><span id="l15.1077"> </span>
<a href="#l15.1078"></a><span id="l15.1078">   nsCOMPtr&lt;nsISmtpService&gt; smtpService(do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l15.1079"></a><span id="l15.1079">   if (NS_SUCCEEDED(rv) &amp;&amp; smtpService)</span>
<a href="#l15.1080"></a><span id="l15.1080">   {</span>
<a href="#l15.1081"></a><span id="l15.1081">     nsCOMPtr&lt;nsISmtpServer&gt;    foundServer;</span>
<a href="#l15.1082"></a><span id="l15.1082"> </span>
<a href="#l15.1083"></a><span id="l15.1083" class="difflineminus">-    rv = smtpService-&gt;FindServer( pUser, pServer, getter_AddRefs( foundServer));</span>
<a href="#l15.1084"></a><span id="l15.1084" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; foundServer)</span>
<a href="#l15.1085"></a><span id="l15.1085" class="difflineplus">+    rv = smtpService-&gt;FindServer(pUser, pServer, getter_AddRefs(foundServer));</span>
<a href="#l15.1086"></a><span id="l15.1086" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; foundServer)</span>
<a href="#l15.1087"></a><span id="l15.1087">     {</span>
<a href="#l15.1088"></a><span id="l15.1088" class="difflineminus">-      IMPORT_LOG1( &quot;SMTP server already exists: %s\n&quot;, pServer);</span>
<a href="#l15.1089"></a><span id="l15.1089" class="difflineplus">+      IMPORT_LOG1(&quot;SMTP server already exists: %s\n&quot;, pServer);</span>
<a href="#l15.1090"></a><span id="l15.1090">       return;</span>
<a href="#l15.1091"></a><span id="l15.1091">     }</span>
<a href="#l15.1092"></a><span id="l15.1092">     nsCOMPtr&lt;nsISmtpServer&gt;    smtpServer;</span>
<a href="#l15.1093"></a><span id="l15.1093"> </span>
<a href="#l15.1094"></a><span id="l15.1094" class="difflineminus">-    rv = smtpService-&gt;CreateSmtpServer( getter_AddRefs( smtpServer));</span>
<a href="#l15.1095"></a><span id="l15.1095" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; smtpServer)</span>
<a href="#l15.1096"></a><span id="l15.1096" class="difflineplus">+    rv = smtpService-&gt;CreateSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l15.1097"></a><span id="l15.1097" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; smtpServer)</span>
<a href="#l15.1098"></a><span id="l15.1098">     {</span>
<a href="#l15.1099"></a><span id="l15.1099">       smtpServer-&gt;SetHostname(nsDependentCString(pServer));</span>
<a href="#l15.1100"></a><span id="l15.1100">       if (pUser)</span>
<a href="#l15.1101"></a><span id="l15.1101">         smtpServer-&gt;SetUsername(nsDependentCString(pUser));</span>
<a href="#l15.1102"></a><span id="l15.1102"> </span>
<a href="#l15.1103"></a><span id="l15.1103" class="difflineminus">-      IMPORT_LOG1( &quot;Created new SMTP server: %s\n&quot;, pServer);</span>
<a href="#l15.1104"></a><span id="l15.1104" class="difflineplus">+      IMPORT_LOG1(&quot;Created new SMTP server: %s\n&quot;, pServer);</span>
<a href="#l15.1105"></a><span id="l15.1105">     }</span>
<a href="#l15.1106"></a><span id="l15.1106">   }</span>
<a href="#l15.1107"></a><span id="l15.1107"> }</span>
<a href="#l15.1108"></a><span id="l15.1108"> </span>
<a href="#l15.1109"></a><span id="l15.1109" class="difflineminus">-nsresult nsEudoraWin32::GetAttachmentInfo( const char *pFileName, nsIFile *pFile, nsCString&amp; mimeType, nsCString&amp; aAttachmentName)</span>
<a href="#l15.1110"></a><span id="l15.1110" class="difflineplus">+nsresult nsEudoraWin32::GetAttachmentInfo(const char *pFileName, nsIFile *pFile, nsCString&amp; mimeType, nsCString&amp; aAttachmentName)</span>
<a href="#l15.1111"></a><span id="l15.1111"> {</span>
<a href="#l15.1112"></a><span id="l15.1112">   nsresult  rv;</span>
<a href="#l15.1113"></a><span id="l15.1113">   mimeType.Truncate();</span>
<a href="#l15.1114"></a><span id="l15.1114">   nsCOMPtr &lt;nsILocalFile&gt; pLocalFile = do_QueryInterface(pFile, &amp;rv);</span>
<a href="#l15.1115"></a><span id="l15.1115">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1116"></a><span id="l15.1116">   pLocalFile-&gt;InitWithNativePath(nsDependentCString(pFileName));</span>
<a href="#l15.1117"></a><span id="l15.1117">   bool      isFile = false;</span>
<a href="#l15.1118"></a><span id="l15.1118">   bool      exists = false;</span>
<a href="#l15.1119"></a><span id="l15.1119" class="difflineminus">-  if (NS_FAILED( rv = pFile-&gt;Exists( &amp;exists)))</span>
<a href="#l15.1120"></a><span id="l15.1120" class="difflineminus">-    return( rv);</span>
<a href="#l15.1121"></a><span id="l15.1121" class="difflineminus">-  if ( exists &amp;&amp; NS_FAILED( rv = pFile-&gt;IsFile(&amp;isFile) ) )</span>
<a href="#l15.1122"></a><span id="l15.1122" class="difflineminus">-    return( rv);</span>
<a href="#l15.1123"></a><span id="l15.1123" class="difflineplus">+  if (NS_FAILED(rv = pFile-&gt;Exists(&amp;exists)))</span>
<a href="#l15.1124"></a><span id="l15.1124" class="difflineplus">+    return rv;</span>
<a href="#l15.1125"></a><span id="l15.1125" class="difflineplus">+  if (exists &amp;&amp; NS_FAILED(rv = pFile-&gt;IsFile(&amp;isFile)))</span>
<a href="#l15.1126"></a><span id="l15.1126" class="difflineplus">+    return rv;</span>
<a href="#l15.1127"></a><span id="l15.1127"> </span>
<a href="#l15.1128"></a><span id="l15.1128">   if (!exists || !isFile)</span>
<a href="#l15.1129"></a><span id="l15.1129">   {</span>
<a href="#l15.1130"></a><span id="l15.1130">     // Windows Eudora writes the full path to the attachment when the message</span>
<a href="#l15.1131"></a><span id="l15.1131">     // is received, but doesn't update that path if the attachment directory</span>
<a href="#l15.1132"></a><span id="l15.1132">     // changes (e.g. if email directory is moved). When operating on an</span>
<a href="#l15.1133"></a><span id="l15.1133">     // attachment (opening, etc.) Eudora will first check the full path</span>
<a href="#l15.1134"></a><span id="l15.1134">     // and then if the file doesn't exist there Eudora will check the</span>
<a href="#l15.1135"></a><span id="l15.1135">     // current attachment directory for a file with the same name.</span>
<a href="#l15.1136"></a><span id="l15.1136">     //</span>
<a href="#l15.1137"></a><span id="l15.1137">     // Check to see if we have any better luck looking for the attachment</span>
<a href="#l15.1138"></a><span id="l15.1138">     // in the current attachment directory.</span>
<a href="#l15.1139"></a><span id="l15.1139">     nsCAutoString name;</span>
<a href="#l15.1140"></a><span id="l15.1140">     pFile-&gt;GetNativeLeafName(name);</span>
<a href="#l15.1141"></a><span id="l15.1141">     if (name.IsEmpty())</span>
<a href="#l15.1142"></a><span id="l15.1142" class="difflineminus">-      return( NS_ERROR_FAILURE);</span>
<a href="#l15.1143"></a><span id="l15.1143" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l15.1144"></a><span id="l15.1144"> </span>
<a href="#l15.1145"></a><span id="l15.1145">     nsCOMPtr &lt;nsIFile&gt; altFile;</span>
<a href="#l15.1146"></a><span id="l15.1146">     rv = m_mailImportLocation-&gt;Clone(getter_AddRefs(altFile));</span>
<a href="#l15.1147"></a><span id="l15.1147">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1148"></a><span id="l15.1148">     // For now, we'll do that using a hard coded name and location for the</span>
<a href="#l15.1149"></a><span id="l15.1149">     // attachment directory on Windows (the default location) &quot;attach&quot; inside</span>
<a href="#l15.1150"></a><span id="l15.1150">     // of the Eudora mail directory. Once settings from Eudora are imported</span>
<a href="#l15.1151"></a><span id="l15.1151">     // better, we'll want to check where the settings say attachments are stored.</span>
<a href="#l15.1152"></a><span id="l15.1152" class="difflineat">@@ -1067,41 +1059,41 @@ nsresult nsEudoraWin32::GetAttachmentInf</span>
<a href="#l15.1153"></a><span id="l15.1153">     // Did we come up with a different path or was the original path already</span>
<a href="#l15.1154"></a><span id="l15.1154">     // in the current attachment directory?</span>
<a href="#l15.1155"></a><span id="l15.1155">     bool    isSamePath = true;</span>
<a href="#l15.1156"></a><span id="l15.1156">     rv = altFile-&gt;Equals(pFile, &amp;isSamePath);</span>
<a href="#l15.1157"></a><span id="l15.1157"> </span>
<a href="#l15.1158"></a><span id="l15.1158">     if (NS_SUCCEEDED(rv) &amp;&amp; !isSamePath)</span>
<a href="#l15.1159"></a><span id="l15.1159">     {</span>
<a href="#l15.1160"></a><span id="l15.1160">       // We came up with a different path - check the new path.</span>
<a href="#l15.1161"></a><span id="l15.1161" class="difflineminus">-      if (NS_FAILED( rv = altFile-&gt;Exists( &amp;exists)))</span>
<a href="#l15.1162"></a><span id="l15.1162" class="difflineminus">-        return( rv);</span>
<a href="#l15.1163"></a><span id="l15.1163" class="difflineminus">-      if ( exists &amp;&amp; NS_FAILED( rv = altFile-&gt;IsFile( &amp;isFile) ) )</span>
<a href="#l15.1164"></a><span id="l15.1164" class="difflineminus">-        return( rv);</span>
<a href="#l15.1165"></a><span id="l15.1165" class="difflineplus">+      if (NS_FAILED(rv = altFile-&gt;Exists(&amp;exists)))</span>
<a href="#l15.1166"></a><span id="l15.1166" class="difflineplus">+        return rv;</span>
<a href="#l15.1167"></a><span id="l15.1167" class="difflineplus">+      if (exists &amp;&amp; NS_FAILED(rv = altFile-&gt;IsFile(&amp;isFile)))</span>
<a href="#l15.1168"></a><span id="l15.1168" class="difflineplus">+        return rv;</span>
<a href="#l15.1169"></a><span id="l15.1169"> </span>
<a href="#l15.1170"></a><span id="l15.1170">       // Keep the new path if it helped us.</span>
<a href="#l15.1171"></a><span id="l15.1171">       if (exists &amp;&amp; isFile)</span>
<a href="#l15.1172"></a><span id="l15.1172">       {</span>
<a href="#l15.1173"></a><span id="l15.1173">         nsCString   nativePath;</span>
<a href="#l15.1174"></a><span id="l15.1174">         altFile-&gt;GetNativePath(nativePath);</span>
<a href="#l15.1175"></a><span id="l15.1175">         pLocalFile-&gt;InitWithNativePath(nativePath);</span>
<a href="#l15.1176"></a><span id="l15.1176">       }</span>
<a href="#l15.1177"></a><span id="l15.1177">     }</span>
<a href="#l15.1178"></a><span id="l15.1178">   }</span>
<a href="#l15.1179"></a><span id="l15.1179"> </span>
<a href="#l15.1180"></a><span id="l15.1180">   if (exists &amp;&amp; isFile)</span>
<a href="#l15.1181"></a><span id="l15.1181">   {</span>
<a href="#l15.1182"></a><span id="l15.1182">     nsCAutoString name;</span>
<a href="#l15.1183"></a><span id="l15.1183">     pFile-&gt;GetNativeLeafName(name);</span>
<a href="#l15.1184"></a><span id="l15.1184">     if (name.IsEmpty())</span>
<a href="#l15.1185"></a><span id="l15.1185" class="difflineminus">-      return( NS_ERROR_FAILURE);</span>
<a href="#l15.1186"></a><span id="l15.1186" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l15.1187"></a><span id="l15.1187">     if (name.Length() &gt; 4)</span>
<a href="#l15.1188"></a><span id="l15.1188">     {</span>
<a href="#l15.1189"></a><span id="l15.1189">       nsCString ext;</span>
<a href="#l15.1190"></a><span id="l15.1190" class="difflineminus">-      PRInt32 idx = name.RFindChar( '.');</span>
<a href="#l15.1191"></a><span id="l15.1191" class="difflineplus">+      PRInt32 idx = name.RFindChar('.');</span>
<a href="#l15.1192"></a><span id="l15.1192">       if (idx != -1)</span>
<a href="#l15.1193"></a><span id="l15.1193">       {</span>
<a href="#l15.1194"></a><span id="l15.1194">         ext = Substring(name, idx);</span>
<a href="#l15.1195"></a><span id="l15.1195">         GetMimeTypeFromExtension(ext, mimeType);</span>
<a href="#l15.1196"></a><span id="l15.1196">       }</span>
<a href="#l15.1197"></a><span id="l15.1197">     }</span>
<a href="#l15.1198"></a><span id="l15.1198">     if (mimeType.IsEmpty())</span>
<a href="#l15.1199"></a><span id="l15.1199">       mimeType = &quot;application/octet-stream&quot;;</span>
<a href="#l15.1200"></a><span id="l15.1200" class="difflineat">@@ -1109,23 +1101,23 @@ nsresult nsEudoraWin32::GetAttachmentInf</span>
<a href="#l15.1201"></a><span id="l15.1201">     nsAutoString description;</span>
<a href="#l15.1202"></a><span id="l15.1202">     rv = NS_CopyNativeToUnicode(name, description);</span>
<a href="#l15.1203"></a><span id="l15.1203">  </span>
<a href="#l15.1204"></a><span id="l15.1204">     if (NS_SUCCEEDED(rv))</span>
<a href="#l15.1205"></a><span id="l15.1205">       aAttachmentName = NS_ConvertUTF16toUTF8(description);</span>
<a href="#l15.1206"></a><span id="l15.1206">     else</span>
<a href="#l15.1207"></a><span id="l15.1207">       aAttachmentName = name;</span>
<a href="#l15.1208"></a><span id="l15.1208"> </span>
<a href="#l15.1209"></a><span id="l15.1209" class="difflineminus">-    return( NS_OK);</span>
<a href="#l15.1210"></a><span id="l15.1210" class="difflineplus">+    return NS_OK;</span>
<a href="#l15.1211"></a><span id="l15.1211">   }</span>
<a href="#l15.1212"></a><span id="l15.1212"> </span>
<a href="#l15.1213"></a><span id="l15.1213" class="difflineminus">-  return( NS_ERROR_FAILURE);</span>
<a href="#l15.1214"></a><span id="l15.1214" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l15.1215"></a><span id="l15.1215"> }</span>
<a href="#l15.1216"></a><span id="l15.1216"> </span>
<a href="#l15.1217"></a><span id="l15.1217" class="difflineminus">-bool nsEudoraWin32::FindMimeIniFile( nsIFile *pFile)</span>
<a href="#l15.1218"></a><span id="l15.1218" class="difflineplus">+bool nsEudoraWin32::FindMimeIniFile(nsIFile *pFile)</span>
<a href="#l15.1219"></a><span id="l15.1219"> {</span>
<a href="#l15.1220"></a><span id="l15.1220">   bool hasMore;</span>
<a href="#l15.1221"></a><span id="l15.1221">   nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l15.1222"></a><span id="l15.1222">   nsresult rv = pFile-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l15.1223"></a><span id="l15.1223">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1224"></a><span id="l15.1224"> </span>
<a href="#l15.1225"></a><span id="l15.1225">   nsCOMPtr &lt;nsILocalFile&gt; pLocalFile = do_QueryInterface(pFile, &amp;rv);</span>
<a href="#l15.1226"></a><span id="l15.1226">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1227"></a><span id="l15.1227" class="difflineat">@@ -1142,74 +1134,74 @@ bool nsEudoraWin32::FindMimeIniFile( nsI</span>
<a href="#l15.1228"></a><span id="l15.1228">   while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l15.1229"></a><span id="l15.1229">   {</span>
<a href="#l15.1230"></a><span id="l15.1230">     nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l15.1231"></a><span id="l15.1231">     rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l15.1232"></a><span id="l15.1232">     nsCOMPtr&lt;nsILocalFile&gt; entry(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l15.1233"></a><span id="l15.1233">     directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l15.1234"></a><span id="l15.1234"> </span>
<a href="#l15.1235"></a><span id="l15.1235"> </span>
<a href="#l15.1236"></a><span id="l15.1236" class="difflineminus">-    if (NS_SUCCEEDED( rv))</span>
<a href="#l15.1237"></a><span id="l15.1237" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l15.1238"></a><span id="l15.1238">     {</span>
<a href="#l15.1239"></a><span id="l15.1239">       rv = entry-&gt;GetNativeLeafName(fName);</span>
<a href="#l15.1240"></a><span id="l15.1240" class="difflineminus">-      if (NS_SUCCEEDED( rv) &amp;&amp; !fName.IsEmpty())</span>
<a href="#l15.1241"></a><span id="l15.1241" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; !fName.IsEmpty())</span>
<a href="#l15.1242"></a><span id="l15.1242">       {</span>
<a href="#l15.1243"></a><span id="l15.1243">         if (fName.Length() &gt; 4)</span>
<a href="#l15.1244"></a><span id="l15.1244">         {</span>
<a href="#l15.1245"></a><span id="l15.1245">           ext = StringTail(fName, 4);</span>
<a href="#l15.1246"></a><span id="l15.1246">           name = StringHead(fName, fName.Length() - 4);</span>
<a href="#l15.1247"></a><span id="l15.1247">         }</span>
<a href="#l15.1248"></a><span id="l15.1248">         else</span>
<a href="#l15.1249"></a><span id="l15.1249">         {</span>
<a href="#l15.1250"></a><span id="l15.1250">           ext.Truncate();</span>
<a href="#l15.1251"></a><span id="l15.1251">           name = fName;</span>
<a href="#l15.1252"></a><span id="l15.1252">         }</span>
<a href="#l15.1253"></a><span id="l15.1253">         ToLowerCase(ext);</span>
<a href="#l15.1254"></a><span id="l15.1254">         if (ext.EqualsLiteral(&quot;.ini&quot;))</span>
<a href="#l15.1255"></a><span id="l15.1255">         {</span>
<a href="#l15.1256"></a><span id="l15.1256">           isFile = false;</span>
<a href="#l15.1257"></a><span id="l15.1257" class="difflineminus">-          entry-&gt;IsFile( &amp;isFile);</span>
<a href="#l15.1258"></a><span id="l15.1258" class="difflineplus">+          entry-&gt;IsFile(&amp;isFile);</span>
<a href="#l15.1259"></a><span id="l15.1259">           if (isFile)</span>
<a href="#l15.1260"></a><span id="l15.1260">           {</span>
<a href="#l15.1261"></a><span id="l15.1261">             if (found)</span>
<a href="#l15.1262"></a><span id="l15.1262">             {</span>
<a href="#l15.1263"></a><span id="l15.1263">               // which one of these files is newer?</span>
<a href="#l15.1264"></a><span id="l15.1264">               PRInt64  modDate1, modDate2;</span>
<a href="#l15.1265"></a><span id="l15.1265" class="difflineminus">-              entry-&gt;GetLastModifiedTime( &amp;modDate2);</span>
<a href="#l15.1266"></a><span id="l15.1266" class="difflineminus">-              pFile-&gt;GetLastModifiedTime( &amp;modDate1);</span>
<a href="#l15.1267"></a><span id="l15.1267" class="difflineplus">+              entry-&gt;GetLastModifiedTime(&amp;modDate2);</span>
<a href="#l15.1268"></a><span id="l15.1268" class="difflineplus">+              pFile-&gt;GetLastModifiedTime(&amp;modDate1);</span>
<a href="#l15.1269"></a><span id="l15.1269">               if (modDate2 &gt; modDate1)</span>
<a href="#l15.1270"></a><span id="l15.1270" class="difflineminus">-                                  pLocalFile-&gt;InitWithFile( entry);</span>
<a href="#l15.1271"></a><span id="l15.1271" class="difflineplus">+                pLocalFile-&gt;InitWithFile(entry);</span>
<a href="#l15.1272"></a><span id="l15.1272">             }</span>
<a href="#l15.1273"></a><span id="l15.1273">             else</span>
<a href="#l15.1274"></a><span id="l15.1274">             {</span>
<a href="#l15.1275"></a><span id="l15.1275" class="difflineminus">-              pLocalFile-&gt;InitWithFile( entry);</span>
<a href="#l15.1276"></a><span id="l15.1276" class="difflineplus">+              pLocalFile-&gt;InitWithFile(entry);</span>
<a href="#l15.1277"></a><span id="l15.1277">               found = true;</span>
<a href="#l15.1278"></a><span id="l15.1278">             }</span>
<a href="#l15.1279"></a><span id="l15.1279">           }</span>
<a href="#l15.1280"></a><span id="l15.1280">         }</span>
<a href="#l15.1281"></a><span id="l15.1281">       }</span>
<a href="#l15.1282"></a><span id="l15.1282">     }</span>
<a href="#l15.1283"></a><span id="l15.1283">   }</span>
<a href="#l15.1284"></a><span id="l15.1284">   return found;</span>
<a href="#l15.1285"></a><span id="l15.1285"> }</span>
<a href="#l15.1286"></a><span id="l15.1286"> </span>
<a href="#l15.1287"></a><span id="l15.1287"> </span>
<a href="#l15.1288"></a><span id="l15.1288" class="difflineminus">-void nsEudoraWin32::GetMimeTypeFromExtension( nsCString&amp; ext, nsCString&amp; mimeType)</span>
<a href="#l15.1289"></a><span id="l15.1289" class="difflineplus">+void nsEudoraWin32::GetMimeTypeFromExtension(nsCString&amp; ext, nsCString&amp; mimeType)</span>
<a href="#l15.1290"></a><span id="l15.1290"> {</span>
<a href="#l15.1291"></a><span id="l15.1291">   HKEY  sKey;</span>
<a href="#l15.1292"></a><span id="l15.1292" class="difflineminus">-  if (::RegOpenKeyEx( HKEY_CLASSES_ROOT, ext.get(), 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS)</span>
<a href="#l15.1293"></a><span id="l15.1293" class="difflineplus">+  if (::RegOpenKeyEx(HKEY_CLASSES_ROOT, ext.get(), 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS)</span>
<a href="#l15.1294"></a><span id="l15.1294">   {</span>
<a href="#l15.1295"></a><span id="l15.1295">     // get the value of &quot;Current&quot;</span>
<a href="#l15.1296"></a><span id="l15.1296" class="difflineminus">-    BYTE *pBytes = GetValueBytes( sKey, &quot;Content Type&quot;);</span>
<a href="#l15.1297"></a><span id="l15.1297" class="difflineplus">+    BYTE *pBytes = GetValueBytes(sKey, &quot;Content Type&quot;);</span>
<a href="#l15.1298"></a><span id="l15.1298">     if (pBytes)</span>
<a href="#l15.1299"></a><span id="l15.1299">     {</span>
<a href="#l15.1300"></a><span id="l15.1300">       mimeType = (const char *)pBytes;</span>
<a href="#l15.1301"></a><span id="l15.1301">       delete [] pBytes;</span>
<a href="#l15.1302"></a><span id="l15.1302">     }</span>
<a href="#l15.1303"></a><span id="l15.1303" class="difflineminus">-    ::RegCloseKey( sKey);</span>
<a href="#l15.1304"></a><span id="l15.1304" class="difflineplus">+    ::RegCloseKey(sKey);</span>
<a href="#l15.1305"></a><span id="l15.1305">   }</span>
<a href="#l15.1306"></a><span id="l15.1306"> </span>
<a href="#l15.1307"></a><span id="l15.1307">   if (!mimeType.IsEmpty() || !m_mailImportLocation || (ext.Length() &gt; 10))</span>
<a href="#l15.1308"></a><span id="l15.1308">     return;</span>
<a href="#l15.1309"></a><span id="l15.1309"> </span>
<a href="#l15.1310"></a><span id="l15.1310">   // TLR: FIXME: We should/could cache the extension to mime type maps we find</span>
<a href="#l15.1311"></a><span id="l15.1311">   // and check the cache first before scanning all of eudora's mappings?</span>
<a href="#l15.1312"></a><span id="l15.1312"> </span>
<a href="#l15.1313"></a><span id="l15.1313" class="difflineat">@@ -1221,49 +1213,49 @@ void nsEudoraWin32::GetMimeTypeFromExten</span>
<a href="#l15.1314"></a><span id="l15.1314">     if (!pFile)</span>
<a href="#l15.1315"></a><span id="l15.1315">       return;</span>
<a href="#l15.1316"></a><span id="l15.1316"> </span>
<a href="#l15.1317"></a><span id="l15.1317">     pFile-&gt;InitWithFile(m_mailImportLocation);</span>
<a href="#l15.1318"></a><span id="l15.1318"> </span>
<a href="#l15.1319"></a><span id="l15.1319">     pFile-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;eudora.ini&quot;));</span>
<a href="#l15.1320"></a><span id="l15.1320">     bool exists = false;</span>
<a href="#l15.1321"></a><span id="l15.1321">     bool isFile = false;</span>
<a href="#l15.1322"></a><span id="l15.1322" class="difflineminus">-    nsresult rv = pFile-&gt;Exists( &amp;exists);</span>
<a href="#l15.1323"></a><span id="l15.1323" class="difflineminus">-    if (NS_SUCCEEDED( rv))</span>
<a href="#l15.1324"></a><span id="l15.1324" class="difflineminus">-      rv = pFile-&gt;IsFile( &amp;isFile);</span>
<a href="#l15.1325"></a><span id="l15.1325" class="difflineplus">+    nsresult rv = pFile-&gt;Exists(&amp;exists);</span>
<a href="#l15.1326"></a><span id="l15.1326" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l15.1327"></a><span id="l15.1327" class="difflineplus">+      rv = pFile-&gt;IsFile(&amp;isFile);</span>
<a href="#l15.1328"></a><span id="l15.1328">     if (!isFile || !exists)</span>
<a href="#l15.1329"></a><span id="l15.1329">     {</span>
<a href="#l15.1330"></a><span id="l15.1330" class="difflineminus">-      rv = pFile-&gt;InitWithFile( m_mailImportLocation);</span>
<a href="#l15.1331"></a><span id="l15.1331" class="difflineminus">-      if (NS_FAILED( rv))</span>
<a href="#l15.1332"></a><span id="l15.1332" class="difflineplus">+      rv = pFile-&gt;InitWithFile(m_mailImportLocation);</span>
<a href="#l15.1333"></a><span id="l15.1333" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l15.1334"></a><span id="l15.1334">         return;</span>
<a href="#l15.1335"></a><span id="l15.1335" class="difflineminus">-      if (!FindMimeIniFile( pFile))</span>
<a href="#l15.1336"></a><span id="l15.1336" class="difflineplus">+      if (!FindMimeIniFile(pFile))</span>
<a href="#l15.1337"></a><span id="l15.1337">         return;</span>
<a href="#l15.1338"></a><span id="l15.1338">     }</span>
<a href="#l15.1339"></a><span id="l15.1339"> </span>
<a href="#l15.1340"></a><span id="l15.1340">     nsCAutoString fileName;</span>
<a href="#l15.1341"></a><span id="l15.1341">     pFile-&gt;GetNativePath(fileName);</span>
<a href="#l15.1342"></a><span id="l15.1342">     if (fileName.IsEmpty())</span>
<a href="#l15.1343"></a><span id="l15.1343">       return;</span>
<a href="#l15.1344"></a><span id="l15.1344">     // Read the mime map section</span>
<a href="#l15.1345"></a><span id="l15.1345">     DWORD  size = 1024;</span>
<a href="#l15.1346"></a><span id="l15.1346">     DWORD  dSize = size - 2;</span>
<a href="#l15.1347"></a><span id="l15.1347">     while (dSize == (size - 2))</span>
<a href="#l15.1348"></a><span id="l15.1348">     {</span>
<a href="#l15.1349"></a><span id="l15.1349">       if (m_pMimeSection)</span>
<a href="#l15.1350"></a><span id="l15.1350">         delete [] m_pMimeSection;</span>
<a href="#l15.1351"></a><span id="l15.1351">       size += 1024;</span>
<a href="#l15.1352"></a><span id="l15.1352">       m_pMimeSection = new char[size];</span>
<a href="#l15.1353"></a><span id="l15.1353" class="difflineminus">-      dSize = ::GetPrivateProfileSection( &quot;Mappings&quot;, m_pMimeSection, size, fileName.get());</span>
<a href="#l15.1354"></a><span id="l15.1354" class="difflineplus">+      dSize = ::GetPrivateProfileSection(&quot;Mappings&quot;, m_pMimeSection, size, fileName.get());</span>
<a href="#l15.1355"></a><span id="l15.1355">     }</span>
<a href="#l15.1356"></a><span id="l15.1356">   }</span>
<a href="#l15.1357"></a><span id="l15.1357"> </span>
<a href="#l15.1358"></a><span id="l15.1358">   if (!m_pMimeSection)</span>
<a href="#l15.1359"></a><span id="l15.1359">     return;</span>
<a href="#l15.1360"></a><span id="l15.1360"> </span>
<a href="#l15.1361"></a><span id="l15.1361" class="difflineminus">-  IMPORT_LOG1( &quot;Looking for mime type for extension: %s\n&quot;, ext.get());</span>
<a href="#l15.1362"></a><span id="l15.1362" class="difflineplus">+  IMPORT_LOG1(&quot;Looking for mime type for extension: %s\n&quot;, ext.get());</span>
<a href="#l15.1363"></a><span id="l15.1363"> </span>
<a href="#l15.1364"></a><span id="l15.1364">   // out/in/both=extension,mac creator,mac type,mime type1,mime type2</span>
<a href="#l15.1365"></a><span id="l15.1365">   const char *pExt = ext.get();</span>
<a href="#l15.1366"></a><span id="l15.1366">   pExt++;</span>
<a href="#l15.1367"></a><span id="l15.1367"> </span>
<a href="#l15.1368"></a><span id="l15.1368">   char  *  pChar = m_pMimeSection;</span>
<a href="#l15.1369"></a><span id="l15.1369">   char  *  pStart;</span>
<a href="#l15.1370"></a><span id="l15.1370">   int      len;</span>
<a href="#l15.1371"></a><span id="l15.1371" class="difflineat">@@ -1284,19 +1276,19 @@ void nsEudoraWin32::GetMimeTypeFromExten</span>
<a href="#l15.1372"></a><span id="l15.1372">     {</span>
<a href="#l15.1373"></a><span id="l15.1373">       pChar++;</span>
<a href="#l15.1374"></a><span id="l15.1374">       len++;</span>
<a href="#l15.1375"></a><span id="l15.1375">     }</span>
<a href="#l15.1376"></a><span id="l15.1376">     if (!*pChar)</span>
<a href="#l15.1377"></a><span id="l15.1377">       return;</span>
<a href="#l15.1378"></a><span id="l15.1378"> </span>
<a href="#l15.1379"></a><span id="l15.1379">     tStr.Truncate();</span>
<a href="#l15.1380"></a><span id="l15.1380" class="difflineminus">-    tStr.Append( pStart, len);</span>
<a href="#l15.1381"></a><span id="l15.1381" class="difflineminus">-    tStr.Trim( kWhitespace);</span>
<a href="#l15.1382"></a><span id="l15.1382" class="difflineminus">-    if (!PL_strcasecmp( tStr.get(), pExt))</span>
<a href="#l15.1383"></a><span id="l15.1383" class="difflineplus">+    tStr.Append(pStart, len);</span>
<a href="#l15.1384"></a><span id="l15.1384" class="difflineplus">+    tStr.Trim(kWhitespace);</span>
<a href="#l15.1385"></a><span id="l15.1385" class="difflineplus">+    if (!PL_strcasecmp(tStr.get(), pExt))</span>
<a href="#l15.1386"></a><span id="l15.1386">     {</span>
<a href="#l15.1387"></a><span id="l15.1387">       // skip the mac creator and type</span>
<a href="#l15.1388"></a><span id="l15.1388">       pChar++;</span>
<a href="#l15.1389"></a><span id="l15.1389">       while (*pChar &amp;&amp; (*pChar != ','))</span>
<a href="#l15.1390"></a><span id="l15.1390">         pChar++;</span>
<a href="#l15.1391"></a><span id="l15.1391">       if (!*pChar)</span>
<a href="#l15.1392"></a><span id="l15.1392">         return;</span>
<a href="#l15.1393"></a><span id="l15.1393"> </span>
<a href="#l15.1394"></a><span id="l15.1394" class="difflineat">@@ -1318,79 +1310,79 @@ void nsEudoraWin32::GetMimeTypeFromExten</span>
<a href="#l15.1395"></a><span id="l15.1395">       if (!*pChar)</span>
<a href="#l15.1396"></a><span id="l15.1396">         return;</span>
<a href="#l15.1397"></a><span id="l15.1397"> </span>
<a href="#l15.1398"></a><span id="l15.1398">       pChar++;</span>
<a href="#l15.1399"></a><span id="l15.1399">       if (!len)</span>
<a href="#l15.1400"></a><span id="l15.1400">         continue;</span>
<a href="#l15.1401"></a><span id="l15.1401"> </span>
<a href="#l15.1402"></a><span id="l15.1402">       tStr.Truncate();</span>
<a href="#l15.1403"></a><span id="l15.1403" class="difflineminus">-      tStr.Append( pStart, len);</span>
<a href="#l15.1404"></a><span id="l15.1404" class="difflineminus">-      tStr.Trim( kWhitespace);</span>
<a href="#l15.1405"></a><span id="l15.1405" class="difflineplus">+      tStr.Append(pStart, len);</span>
<a href="#l15.1406"></a><span id="l15.1406" class="difflineplus">+      tStr.Trim(kWhitespace);</span>
<a href="#l15.1407"></a><span id="l15.1407">       if (tStr.IsEmpty())</span>
<a href="#l15.1408"></a><span id="l15.1408">         continue;</span>
<a href="#l15.1409"></a><span id="l15.1409"> </span>
<a href="#l15.1410"></a><span id="l15.1410">       mimeType.Truncate();</span>
<a href="#l15.1411"></a><span id="l15.1411" class="difflineminus">-      mimeType.Append( tStr.get());</span>
<a href="#l15.1412"></a><span id="l15.1412" class="difflineminus">-      mimeType.Append( &quot;/&quot;);</span>
<a href="#l15.1413"></a><span id="l15.1413" class="difflineplus">+      mimeType.Append(tStr.get());</span>
<a href="#l15.1414"></a><span id="l15.1414" class="difflineplus">+      mimeType.Append(&quot;/&quot;);</span>
<a href="#l15.1415"></a><span id="l15.1415">       pStart = pChar;</span>
<a href="#l15.1416"></a><span id="l15.1416">       len = 0;</span>
<a href="#l15.1417"></a><span id="l15.1417">       // Skip to next end of line.</span>
<a href="#l15.1418"></a><span id="l15.1418">       while (*pChar &amp;&amp; (*pChar != nsCRT::CR) &amp;&amp; (*pChar != nsCRT::LF))</span>
<a href="#l15.1419"></a><span id="l15.1419">       {</span>
<a href="#l15.1420"></a><span id="l15.1420">         pChar++;</span>
<a href="#l15.1421"></a><span id="l15.1421">         len++;</span>
<a href="#l15.1422"></a><span id="l15.1422">       }</span>
<a href="#l15.1423"></a><span id="l15.1423">       if (!len)</span>
<a href="#l15.1424"></a><span id="l15.1424">         continue;</span>
<a href="#l15.1425"></a><span id="l15.1425"> </span>
<a href="#l15.1426"></a><span id="l15.1426">       tStr.Truncate();</span>
<a href="#l15.1427"></a><span id="l15.1427" class="difflineminus">-      tStr.Append( pStart, len);</span>
<a href="#l15.1428"></a><span id="l15.1428" class="difflineminus">-      tStr.Trim( kWhitespace);</span>
<a href="#l15.1429"></a><span id="l15.1429" class="difflineplus">+      tStr.Append(pStart, len);</span>
<a href="#l15.1430"></a><span id="l15.1430" class="difflineplus">+      tStr.Trim(kWhitespace);</span>
<a href="#l15.1431"></a><span id="l15.1431">       if (tStr.IsEmpty())</span>
<a href="#l15.1432"></a><span id="l15.1432">         continue;</span>
<a href="#l15.1433"></a><span id="l15.1433"> </span>
<a href="#l15.1434"></a><span id="l15.1434" class="difflineminus">-      mimeType.Append( tStr.get());</span>
<a href="#l15.1435"></a><span id="l15.1435" class="difflineplus">+      mimeType.Append(tStr.get());</span>
<a href="#l15.1436"></a><span id="l15.1436"> </span>
<a href="#l15.1437"></a><span id="l15.1437" class="difflineminus">-      IMPORT_LOG1( &quot;Found Mime Type: %s\n&quot;, mimeType.get());</span>
<a href="#l15.1438"></a><span id="l15.1438" class="difflineplus">+      IMPORT_LOG1(&quot;Found Mime Type: %s\n&quot;, mimeType.get());</span>
<a href="#l15.1439"></a><span id="l15.1439"> </span>
<a href="#l15.1440"></a><span id="l15.1440">       return;</span>
<a href="#l15.1441"></a><span id="l15.1441">     }</span>
<a href="#l15.1442"></a><span id="l15.1442">   }</span>
<a href="#l15.1443"></a><span id="l15.1443"> }</span>
<a href="#l15.1444"></a><span id="l15.1444"> </span>
<a href="#l15.1445"></a><span id="l15.1445" class="difflineminus">-bool nsEudoraWin32::FindAddressFolder( nsIFile **pFolder)</span>
<a href="#l15.1446"></a><span id="l15.1446" class="difflineplus">+bool nsEudoraWin32::FindAddressFolder(nsIFile **pFolder)</span>
<a href="#l15.1447"></a><span id="l15.1447"> {</span>
<a href="#l15.1448"></a><span id="l15.1448" class="difflineminus">-  IMPORT_LOG0( &quot;*** Looking for Eudora address folder\n&quot;);</span>
<a href="#l15.1449"></a><span id="l15.1449" class="difflineplus">+  IMPORT_LOG0(&quot;*** Looking for Eudora address folder\n&quot;);</span>
<a href="#l15.1450"></a><span id="l15.1450"> </span>
<a href="#l15.1451"></a><span id="l15.1451" class="difflineminus">-  return( FindEudoraLocation( pFolder));</span>
<a href="#l15.1452"></a><span id="l15.1452" class="difflineplus">+  return FindEudoraLocation(pFolder);</span>
<a href="#l15.1453"></a><span id="l15.1453"> }</span>
<a href="#l15.1454"></a><span id="l15.1454"> </span>
<a href="#l15.1455"></a><span id="l15.1455" class="difflineminus">-nsresult nsEudoraWin32::FindAddressBooks( nsIFile *pRoot, nsISupportsArray **ppArray)</span>
<a href="#l15.1456"></a><span id="l15.1456" class="difflineplus">+nsresult nsEudoraWin32::FindAddressBooks(nsIFile *pRoot, nsISupportsArray **ppArray)</span>
<a href="#l15.1457"></a><span id="l15.1457"> {</span>
<a href="#l15.1458"></a><span id="l15.1458">   nsresult rv;</span>
<a href="#l15.1459"></a><span id="l15.1459">   nsCOMPtr&lt;nsILocalFile&gt; file = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l15.1460"></a><span id="l15.1460">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1461"></a><span id="l15.1461">   nsCOMPtr&lt;nsILocalFile&gt; localRoot = do_QueryInterface(pRoot);</span>
<a href="#l15.1462"></a><span id="l15.1462" class="difflineminus">-  rv = file-&gt;InitWithFile( localRoot);</span>
<a href="#l15.1463"></a><span id="l15.1463" class="difflineplus">+  rv = file-&gt;InitWithFile(localRoot);</span>
<a href="#l15.1464"></a><span id="l15.1464">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1465"></a><span id="l15.1465"> </span>
<a href="#l15.1466"></a><span id="l15.1466" class="difflineminus">-  rv = NS_NewISupportsArray( ppArray);</span>
<a href="#l15.1467"></a><span id="l15.1467" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l15.1468"></a><span id="l15.1468" class="difflineplus">+  rv = NS_NewISupportsArray(ppArray);</span>
<a href="#l15.1469"></a><span id="l15.1469" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l15.1470"></a><span id="l15.1470">   {</span>
<a href="#l15.1471"></a><span id="l15.1471" class="difflineminus">-    IMPORT_LOG0( &quot;FAILED to allocate the nsISupportsArray\n&quot;);</span>
<a href="#l15.1472"></a><span id="l15.1472" class="difflineminus">-    return( rv);</span>
<a href="#l15.1473"></a><span id="l15.1473" class="difflineplus">+    IMPORT_LOG0(&quot;FAILED to allocate the nsISupportsArray\n&quot;);</span>
<a href="#l15.1474"></a><span id="l15.1474" class="difflineplus">+    return rv;</span>
<a href="#l15.1475"></a><span id="l15.1475">   }</span>
<a href="#l15.1476"></a><span id="l15.1476"> </span>
<a href="#l15.1477"></a><span id="l15.1477">   nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l15.1478"></a><span id="l15.1478" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l15.1479"></a><span id="l15.1479" class="difflineminus">-    return( rv);</span>
<a href="#l15.1480"></a><span id="l15.1480" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l15.1481"></a><span id="l15.1481" class="difflineplus">+    return rv;</span>
<a href="#l15.1482"></a><span id="l15.1482">   m_addressImportFolder = pRoot;</span>
<a href="#l15.1483"></a><span id="l15.1483">   nsString    displayName;</span>
<a href="#l15.1484"></a><span id="l15.1484" class="difflineminus">-  nsEudoraStringBundle::GetStringByID( EUDORAIMPORT_NICKNAMES_NAME, displayName);</span>
<a href="#l15.1485"></a><span id="l15.1485" class="difflineplus">+  nsEudoraStringBundle::GetStringByID(EUDORAIMPORT_NICKNAMES_NAME, displayName);</span>
<a href="#l15.1486"></a><span id="l15.1486"> </span>
<a href="#l15.1487"></a><span id="l15.1487">   // First off, get the default nndbase.txt, then scan the default nicknames subdir,</span>
<a href="#l15.1488"></a><span id="l15.1488">   // then look in the .ini file for additional directories to scan for address books!</span>
<a href="#l15.1489"></a><span id="l15.1489">   bool exists = false;</span>
<a href="#l15.1490"></a><span id="l15.1490">   bool isFile = false;</span>
<a href="#l15.1491"></a><span id="l15.1491"> </span>
<a href="#l15.1492"></a><span id="l15.1492">   rv = file-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;nndbase.txt&quot;));</span>
<a href="#l15.1493"></a><span id="l15.1493">   bool checkedBoth = false;</span>
<a href="#l15.1494"></a><span id="l15.1494" class="difflineat">@@ -1409,119 +1401,119 @@ nsresult nsEudoraWin32::FindAddressBooks</span>
<a href="#l15.1495"></a><span id="l15.1495">     // Check for alternate file extension &quot;.nnt&quot; which Windows Eudora uses as an option</span>
<a href="#l15.1496"></a><span id="l15.1496">     // to hide from simple minded viruses that scan &quot;.txt&quot; files for addresses.</span>
<a href="#l15.1497"></a><span id="l15.1497">     rv = file-&gt;SetNativeLeafName(NS_LITERAL_CSTRING(&quot;nndbase.nnt&quot;));</span>
<a href="#l15.1498"></a><span id="l15.1498">     checkedBoth = true;</span>
<a href="#l15.1499"></a><span id="l15.1499">   } while (NS_SUCCEEDED(rv));</span>
<a href="#l15.1500"></a><span id="l15.1500"> </span>
<a href="#l15.1501"></a><span id="l15.1501">   if (exists &amp;&amp; isFile)</span>
<a href="#l15.1502"></a><span id="l15.1502">   {</span>
<a href="#l15.1503"></a><span id="l15.1503" class="difflineminus">-    if (NS_FAILED( rv = FoundAddressBook( file, displayName.get(), *ppArray, impSvc)))</span>
<a href="#l15.1504"></a><span id="l15.1504" class="difflineminus">-      return( rv);</span>
<a href="#l15.1505"></a><span id="l15.1505" class="difflineplus">+    if (NS_FAILED(rv = FoundAddressBook(file, displayName.get(), *ppArray, impSvc)))</span>
<a href="#l15.1506"></a><span id="l15.1506" class="difflineplus">+      return rv;</span>
<a href="#l15.1507"></a><span id="l15.1507">   }</span>
<a href="#l15.1508"></a><span id="l15.1508"> </span>
<a href="#l15.1509"></a><span id="l15.1509">   // Try the default directory</span>
<a href="#l15.1510"></a><span id="l15.1510" class="difflineminus">-  rv =   rv = file-&gt;InitWithFile( localRoot);</span>
<a href="#l15.1511"></a><span id="l15.1511" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l15.1512"></a><span id="l15.1512" class="difflineminus">-    return( rv);</span>
<a href="#l15.1513"></a><span id="l15.1513" class="difflineplus">+  rv =   rv = file-&gt;InitWithFile(localRoot);</span>
<a href="#l15.1514"></a><span id="l15.1514" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l15.1515"></a><span id="l15.1515" class="difflineplus">+    return rv;</span>
<a href="#l15.1516"></a><span id="l15.1516">   rv = file-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Nickname&quot;));</span>
<a href="#l15.1517"></a><span id="l15.1517">   bool isDir = false;</span>
<a href="#l15.1518"></a><span id="l15.1518">   exists = false;</span>
<a href="#l15.1519"></a><span id="l15.1519" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l15.1520"></a><span id="l15.1520" class="difflineminus">-    rv = file-&gt;Exists( &amp;exists);</span>
<a href="#l15.1521"></a><span id="l15.1521" class="difflineminus">-  if (NS_SUCCEEDED( rv) &amp;&amp; exists)</span>
<a href="#l15.1522"></a><span id="l15.1522" class="difflineminus">-    rv = file-&gt;IsDirectory( &amp;isDir);</span>
<a href="#l15.1523"></a><span id="l15.1523" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l15.1524"></a><span id="l15.1524" class="difflineplus">+    rv = file-&gt;Exists(&amp;exists);</span>
<a href="#l15.1525"></a><span id="l15.1525" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l15.1526"></a><span id="l15.1526" class="difflineplus">+    rv = file-&gt;IsDirectory(&amp;isDir);</span>
<a href="#l15.1527"></a><span id="l15.1527">   if (exists &amp;&amp; isDir)</span>
<a href="#l15.1528"></a><span id="l15.1528">   {</span>
<a href="#l15.1529"></a><span id="l15.1529" class="difflineminus">-    if (NS_FAILED( rv = ScanAddressDir(file, *ppArray, impSvc)))</span>
<a href="#l15.1530"></a><span id="l15.1530" class="difflineminus">-      return( rv);</span>
<a href="#l15.1531"></a><span id="l15.1531" class="difflineplus">+    if (NS_FAILED(rv = ScanAddressDir(file, *ppArray, impSvc)))</span>
<a href="#l15.1532"></a><span id="l15.1532" class="difflineplus">+      return rv;</span>
<a href="#l15.1533"></a><span id="l15.1533">   }</span>
<a href="#l15.1534"></a><span id="l15.1534"> </span>
<a href="#l15.1535"></a><span id="l15.1535">   // Try the ini file to find other directories!</span>
<a href="#l15.1536"></a><span id="l15.1536" class="difflineminus">-  rv =   rv = file-&gt;InitWithFile( localRoot);</span>
<a href="#l15.1537"></a><span id="l15.1537" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l15.1538"></a><span id="l15.1538" class="difflineminus">-    return( rv);</span>
<a href="#l15.1539"></a><span id="l15.1539" class="difflineplus">+  rv =   rv = file-&gt;InitWithFile(localRoot);</span>
<a href="#l15.1540"></a><span id="l15.1540" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l15.1541"></a><span id="l15.1541" class="difflineplus">+    return rv;</span>
<a href="#l15.1542"></a><span id="l15.1542">   rv = file-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;eudora.ini&quot;));</span>
<a href="#l15.1543"></a><span id="l15.1543">   exists = false;</span>
<a href="#l15.1544"></a><span id="l15.1544">   isFile = false;</span>
<a href="#l15.1545"></a><span id="l15.1545" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l15.1546"></a><span id="l15.1546" class="difflineminus">-    rv = file-&gt;Exists( &amp;exists);</span>
<a href="#l15.1547"></a><span id="l15.1547" class="difflineminus">-  if (NS_SUCCEEDED( rv) &amp;&amp; exists)</span>
<a href="#l15.1548"></a><span id="l15.1548" class="difflineminus">-    rv = file-&gt;IsFile( &amp;isFile);</span>
<a href="#l15.1549"></a><span id="l15.1549" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l15.1550"></a><span id="l15.1550" class="difflineplus">+    rv = file-&gt;Exists(&amp;exists);</span>
<a href="#l15.1551"></a><span id="l15.1551" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l15.1552"></a><span id="l15.1552" class="difflineplus">+    rv = file-&gt;IsFile(&amp;isFile);</span>
<a href="#l15.1553"></a><span id="l15.1553"> </span>
<a href="#l15.1554"></a><span id="l15.1554">   if (!isFile || !exists)</span>
<a href="#l15.1555"></a><span id="l15.1555">   {</span>
<a href="#l15.1556"></a><span id="l15.1556" class="difflineminus">-    rv = file-&gt;InitWithFile( localRoot);</span>
<a href="#l15.1557"></a><span id="l15.1557" class="difflineminus">-    if (NS_FAILED( rv))</span>
<a href="#l15.1558"></a><span id="l15.1558" class="difflineminus">-      return( NS_OK);</span>
<a href="#l15.1559"></a><span id="l15.1559" class="difflineplus">+    rv = file-&gt;InitWithFile(localRoot);</span>
<a href="#l15.1560"></a><span id="l15.1560" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l15.1561"></a><span id="l15.1561" class="difflineplus">+      return NS_OK;</span>
<a href="#l15.1562"></a><span id="l15.1562">     if (!FindMimeIniFile(file))</span>
<a href="#l15.1563"></a><span id="l15.1563" class="difflineminus">-      return( NS_OK);</span>
<a href="#l15.1564"></a><span id="l15.1564" class="difflineplus">+      return NS_OK;</span>
<a href="#l15.1565"></a><span id="l15.1565">   }</span>
<a href="#l15.1566"></a><span id="l15.1566"> </span>
<a href="#l15.1567"></a><span id="l15.1567">   nsCString fileName;</span>
<a href="#l15.1568"></a><span id="l15.1568">   file-&gt;GetNativePath(fileName);</span>
<a href="#l15.1569"></a><span id="l15.1569">   // This is the supposed ini file name!</span>
<a href="#l15.1570"></a><span id="l15.1570">   // Get the extra directories for nicknames and parse it for valid nickname directories</span>
<a href="#l15.1571"></a><span id="l15.1571">   // to look into...</span>
<a href="#l15.1572"></a><span id="l15.1572">   char *pBuffer = new char[2048];</span>
<a href="#l15.1573"></a><span id="l15.1573" class="difflineminus">-  DWORD len = ::GetPrivateProfileString( &quot;Settings&quot;, &quot;ExtraNicknameDirs&quot;, &quot;&quot;, pBuffer, 2048, fileName.get());</span>
<a href="#l15.1574"></a><span id="l15.1574" class="difflineplus">+  DWORD len = ::GetPrivateProfileString(&quot;Settings&quot;, &quot;ExtraNicknameDirs&quot;, &quot;&quot;, pBuffer, 2048, fileName.get());</span>
<a href="#l15.1575"></a><span id="l15.1575">   if (len == 2047)</span>
<a href="#l15.1576"></a><span id="l15.1576">   {</span>
<a href="#l15.1577"></a><span id="l15.1577">     // If the value is really that large then don't bother!</span>
<a href="#l15.1578"></a><span id="l15.1578">     delete [] pBuffer;</span>
<a href="#l15.1579"></a><span id="l15.1579" class="difflineminus">-    return( NS_OK);</span>
<a href="#l15.1580"></a><span id="l15.1580" class="difflineplus">+    return NS_OK;</span>
<a href="#l15.1581"></a><span id="l15.1581">   }</span>
<a href="#l15.1582"></a><span id="l15.1582">   nsCString  dirs(pBuffer);</span>
<a href="#l15.1583"></a><span id="l15.1583">   delete [] pBuffer;</span>
<a href="#l15.1584"></a><span id="l15.1584" class="difflineminus">-  dirs.Trim( kWhitespace);</span>
<a href="#l15.1585"></a><span id="l15.1585" class="difflineplus">+  dirs.Trim(kWhitespace);</span>
<a href="#l15.1586"></a><span id="l15.1586">   PRInt32  idx = 0;</span>
<a href="#l15.1587"></a><span id="l15.1587">   nsCString  currentDir;</span>
<a href="#l15.1588"></a><span id="l15.1588" class="difflineminus">-  while ((idx = dirs.FindChar( ';')) != -1)</span>
<a href="#l15.1589"></a><span id="l15.1589" class="difflineplus">+  while ((idx = dirs.FindChar(';')) != -1)</span>
<a href="#l15.1590"></a><span id="l15.1590">   {</span>
<a href="#l15.1591"></a><span id="l15.1591">     currentDir = StringHead(dirs, idx);</span>
<a href="#l15.1592"></a><span id="l15.1592" class="difflineminus">-    currentDir.Trim( kWhitespace);</span>
<a href="#l15.1593"></a><span id="l15.1593" class="difflineplus">+    currentDir.Trim(kWhitespace);</span>
<a href="#l15.1594"></a><span id="l15.1594">     if (!currentDir.IsEmpty())</span>
<a href="#l15.1595"></a><span id="l15.1595">     {</span>
<a href="#l15.1596"></a><span id="l15.1596">       rv = file-&gt;InitWithNativePath(currentDir);</span>
<a href="#l15.1597"></a><span id="l15.1597">       exists = false;</span>
<a href="#l15.1598"></a><span id="l15.1598">       isDir = false;</span>
<a href="#l15.1599"></a><span id="l15.1599" class="difflineminus">-      if (NS_SUCCEEDED( rv))</span>
<a href="#l15.1600"></a><span id="l15.1600" class="difflineminus">-        rv = file-&gt;Exists( &amp;exists);</span>
<a href="#l15.1601"></a><span id="l15.1601" class="difflineminus">-      if (NS_SUCCEEDED( rv) &amp;&amp; exists)</span>
<a href="#l15.1602"></a><span id="l15.1602" class="difflineminus">-        rv = file-&gt;IsDirectory( &amp;isDir);</span>
<a href="#l15.1603"></a><span id="l15.1603" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l15.1604"></a><span id="l15.1604" class="difflineplus">+        rv = file-&gt;Exists(&amp;exists);</span>
<a href="#l15.1605"></a><span id="l15.1605" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l15.1606"></a><span id="l15.1606" class="difflineplus">+        rv = file-&gt;IsDirectory(&amp;isDir);</span>
<a href="#l15.1607"></a><span id="l15.1607">       if (exists &amp;&amp; isDir)</span>
<a href="#l15.1608"></a><span id="l15.1608">       {</span>
<a href="#l15.1609"></a><span id="l15.1609" class="difflineminus">-        if (NS_FAILED( rv = ScanAddressDir(file, *ppArray, impSvc)))</span>
<a href="#l15.1610"></a><span id="l15.1610" class="difflineminus">-          return( rv);</span>
<a href="#l15.1611"></a><span id="l15.1611" class="difflineplus">+        if (NS_FAILED(rv = ScanAddressDir(file, *ppArray, impSvc)))</span>
<a href="#l15.1612"></a><span id="l15.1612" class="difflineplus">+          return rv;</span>
<a href="#l15.1613"></a><span id="l15.1613">       }</span>
<a href="#l15.1614"></a><span id="l15.1614">     }</span>
<a href="#l15.1615"></a><span id="l15.1615">     dirs = Substring(dirs, idx + 1);</span>
<a href="#l15.1616"></a><span id="l15.1616" class="difflineminus">-    dirs.Trim( kWhitespace);</span>
<a href="#l15.1617"></a><span id="l15.1617" class="difflineplus">+    dirs.Trim(kWhitespace);</span>
<a href="#l15.1618"></a><span id="l15.1618">   }</span>
<a href="#l15.1619"></a><span id="l15.1619">   if (!dirs.IsEmpty())</span>
<a href="#l15.1620"></a><span id="l15.1620">   {</span>
<a href="#l15.1621"></a><span id="l15.1621">     rv = file-&gt;InitWithNativePath(dirs);</span>
<a href="#l15.1622"></a><span id="l15.1622">     exists = false;</span>
<a href="#l15.1623"></a><span id="l15.1623">     isDir = false;</span>
<a href="#l15.1624"></a><span id="l15.1624" class="difflineminus">-    if (NS_SUCCEEDED( rv))</span>
<a href="#l15.1625"></a><span id="l15.1625" class="difflineminus">-      rv = file-&gt;Exists( &amp;exists);</span>
<a href="#l15.1626"></a><span id="l15.1626" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; exists)</span>
<a href="#l15.1627"></a><span id="l15.1627" class="difflineminus">-      rv = file-&gt;IsDirectory( &amp;isDir);</span>
<a href="#l15.1628"></a><span id="l15.1628" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l15.1629"></a><span id="l15.1629" class="difflineplus">+      rv = file-&gt;Exists(&amp;exists);</span>
<a href="#l15.1630"></a><span id="l15.1630" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; exists)</span>
<a href="#l15.1631"></a><span id="l15.1631" class="difflineplus">+      rv = file-&gt;IsDirectory(&amp;isDir);</span>
<a href="#l15.1632"></a><span id="l15.1632">     if (exists &amp;&amp; isDir)</span>
<a href="#l15.1633"></a><span id="l15.1633">     {</span>
<a href="#l15.1634"></a><span id="l15.1634" class="difflineminus">-      if (NS_FAILED( rv = ScanAddressDir(file, *ppArray, impSvc)))</span>
<a href="#l15.1635"></a><span id="l15.1635" class="difflineminus">-        return( rv);</span>
<a href="#l15.1636"></a><span id="l15.1636" class="difflineplus">+      if (NS_FAILED(rv = ScanAddressDir(file, *ppArray, impSvc)))</span>
<a href="#l15.1637"></a><span id="l15.1637" class="difflineplus">+        return rv;</span>
<a href="#l15.1638"></a><span id="l15.1638">     }</span>
<a href="#l15.1639"></a><span id="l15.1639">   }</span>
<a href="#l15.1640"></a><span id="l15.1640"> </span>
<a href="#l15.1641"></a><span id="l15.1641" class="difflineminus">-  return( NS_OK);</span>
<a href="#l15.1642"></a><span id="l15.1642" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.1643"></a><span id="l15.1643"> }</span>
<a href="#l15.1644"></a><span id="l15.1644"> </span>
<a href="#l15.1645"></a><span id="l15.1645"> </span>
<a href="#l15.1646"></a><span id="l15.1646" class="difflineminus">-nsresult nsEudoraWin32::ScanAddressDir( nsIFile *pDir, nsISupportsArray *pArray, nsIImportService *impSvc)</span>
<a href="#l15.1647"></a><span id="l15.1647" class="difflineplus">+nsresult nsEudoraWin32::ScanAddressDir(nsIFile *pDir, nsISupportsArray *pArray, nsIImportService *impSvc)</span>
<a href="#l15.1648"></a><span id="l15.1648"> {</span>
<a href="#l15.1649"></a><span id="l15.1649">   bool hasMore;</span>
<a href="#l15.1650"></a><span id="l15.1650">   nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l15.1651"></a><span id="l15.1651">   nsresult rv = pDir-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l15.1652"></a><span id="l15.1652">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1653"></a><span id="l15.1653"> </span>
<a href="#l15.1654"></a><span id="l15.1654">   nsCOMPtr &lt;nsILocalFile&gt; pLocalFile = do_QueryInterface(pDir, &amp;rv);</span>
<a href="#l15.1655"></a><span id="l15.1655">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1656"></a><span id="l15.1656" class="difflineat">@@ -1537,134 +1529,134 @@ nsresult nsEudoraWin32::ScanAddressDir( </span>
<a href="#l15.1657"></a><span id="l15.1657"> </span>
<a href="#l15.1658"></a><span id="l15.1658">   while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l15.1659"></a><span id="l15.1659">   {</span>
<a href="#l15.1660"></a><span id="l15.1660">     nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l15.1661"></a><span id="l15.1661">     rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l15.1662"></a><span id="l15.1662">     nsCOMPtr&lt;nsILocalFile&gt; entry(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l15.1663"></a><span id="l15.1663">     directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l15.1664"></a><span id="l15.1664"> </span>
<a href="#l15.1665"></a><span id="l15.1665" class="difflineminus">-    if (NS_SUCCEEDED( rv))</span>
<a href="#l15.1666"></a><span id="l15.1666" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l15.1667"></a><span id="l15.1667">     {</span>
<a href="#l15.1668"></a><span id="l15.1668">       rv = entry-&gt;GetNativeLeafName(fName);</span>
<a href="#l15.1669"></a><span id="l15.1669" class="difflineminus">-      if (NS_SUCCEEDED( rv) &amp;&amp; !fName.IsEmpty())</span>
<a href="#l15.1670"></a><span id="l15.1670" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; !fName.IsEmpty())</span>
<a href="#l15.1671"></a><span id="l15.1671">       {</span>
<a href="#l15.1672"></a><span id="l15.1672">         if (fName.Length() &gt; 4)</span>
<a href="#l15.1673"></a><span id="l15.1673">         {</span>
<a href="#l15.1674"></a><span id="l15.1674">           ext = StringTail(fName, 4);</span>
<a href="#l15.1675"></a><span id="l15.1675">           name = StringHead(fName, fName.Length() - 4);</span>
<a href="#l15.1676"></a><span id="l15.1676">         }</span>
<a href="#l15.1677"></a><span id="l15.1677">         else</span>
<a href="#l15.1678"></a><span id="l15.1678">         {</span>
<a href="#l15.1679"></a><span id="l15.1679">           ext.Truncate();</span>
<a href="#l15.1680"></a><span id="l15.1680">           name = fName;</span>
<a href="#l15.1681"></a><span id="l15.1681">         }</span>
<a href="#l15.1682"></a><span id="l15.1682">         ToLowerCase(ext);</span>
<a href="#l15.1683"></a><span id="l15.1683">         if (ext.EqualsLiteral(&quot;.txt&quot;))</span>
<a href="#l15.1684"></a><span id="l15.1684">         {</span>
<a href="#l15.1685"></a><span id="l15.1685">           isFile = false;</span>
<a href="#l15.1686"></a><span id="l15.1686" class="difflineminus">-          entry-&gt;IsFile( &amp;isFile);</span>
<a href="#l15.1687"></a><span id="l15.1687" class="difflineplus">+          entry-&gt;IsFile(&amp;isFile);</span>
<a href="#l15.1688"></a><span id="l15.1688">           if (isFile)</span>
<a href="#l15.1689"></a><span id="l15.1689">           {</span>
<a href="#l15.1690"></a><span id="l15.1690" class="difflineminus">-            rv = FoundAddressBook( entry, nsnull, pArray, impSvc);</span>
<a href="#l15.1691"></a><span id="l15.1691" class="difflineminus">-            if (NS_FAILED( rv))</span>
<a href="#l15.1692"></a><span id="l15.1692" class="difflineminus">-              return( rv);</span>
<a href="#l15.1693"></a><span id="l15.1693" class="difflineplus">+            rv = FoundAddressBook(entry, nsnull, pArray, impSvc);</span>
<a href="#l15.1694"></a><span id="l15.1694" class="difflineplus">+            if (NS_FAILED(rv))</span>
<a href="#l15.1695"></a><span id="l15.1695" class="difflineplus">+              return rv;</span>
<a href="#l15.1696"></a><span id="l15.1696">           }</span>
<a href="#l15.1697"></a><span id="l15.1697">         }</span>
<a href="#l15.1698"></a><span id="l15.1698">       }</span>
<a href="#l15.1699"></a><span id="l15.1699">     }</span>
<a href="#l15.1700"></a><span id="l15.1700">   }</span>
<a href="#l15.1701"></a><span id="l15.1701"> </span>
<a href="#l15.1702"></a><span id="l15.1702" class="difflineminus">-  return( rv);</span>
<a href="#l15.1703"></a><span id="l15.1703" class="difflineplus">+  return rv;</span>
<a href="#l15.1704"></a><span id="l15.1704"> }</span>
<a href="#l15.1705"></a><span id="l15.1705"> </span>
<a href="#l15.1706"></a><span id="l15.1706"> </span>
<a href="#l15.1707"></a><span id="l15.1707" class="difflineminus">-nsresult nsEudoraWin32::FoundAddressBook( nsIFile *file, const PRUnichar *pName, nsISupportsArray *pArray, nsIImportService *impSvc)</span>
<a href="#l15.1708"></a><span id="l15.1708" class="difflineplus">+nsresult nsEudoraWin32::FoundAddressBook(nsIFile *file, const PRUnichar *pName, nsISupportsArray *pArray, nsIImportService *impSvc)</span>
<a href="#l15.1709"></a><span id="l15.1709"> {</span>
<a href="#l15.1710"></a><span id="l15.1710">   nsCOMPtr&lt;nsIImportABDescriptor&gt; desc;</span>
<a href="#l15.1711"></a><span id="l15.1711">   nsISupports *  pInterface;</span>
<a href="#l15.1712"></a><span id="l15.1712">   nsString name;</span>
<a href="#l15.1713"></a><span id="l15.1713">   nsresult rv;</span>
<a href="#l15.1714"></a><span id="l15.1714"> </span>
<a href="#l15.1715"></a><span id="l15.1715">   if (pName)</span>
<a href="#l15.1716"></a><span id="l15.1716">     name = pName;</span>
<a href="#l15.1717"></a><span id="l15.1717">   else {</span>
<a href="#l15.1718"></a><span id="l15.1718">     nsAutoString leaf;</span>
<a href="#l15.1719"></a><span id="l15.1719">     rv = file-&gt;GetLeafName(leaf);</span>
<a href="#l15.1720"></a><span id="l15.1720" class="difflineminus">-    if (NS_FAILED( rv))</span>
<a href="#l15.1721"></a><span id="l15.1721" class="difflineminus">-      return( rv);</span>
<a href="#l15.1722"></a><span id="l15.1722" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l15.1723"></a><span id="l15.1723" class="difflineplus">+      return rv;</span>
<a href="#l15.1724"></a><span id="l15.1724">     if (leaf.IsEmpty())</span>
<a href="#l15.1725"></a><span id="l15.1725" class="difflineminus">-      return( NS_ERROR_FAILURE);</span>
<a href="#l15.1726"></a><span id="l15.1726" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l15.1727"></a><span id="l15.1727">     nsString  tStr;</span>
<a href="#l15.1728"></a><span id="l15.1728">     tStr = StringTail(leaf, 4);</span>
<a href="#l15.1729"></a><span id="l15.1729">     if (tStr.LowerCaseEqualsLiteral(&quot;.txt&quot;)  || tStr.LowerCaseEqualsLiteral(&quot;.nnt&quot;))</span>
<a href="#l15.1730"></a><span id="l15.1730">       leaf.SetLength(leaf.Length() - 4);</span>
<a href="#l15.1731"></a><span id="l15.1731">   }</span>
<a href="#l15.1732"></a><span id="l15.1732"> </span>
<a href="#l15.1733"></a><span id="l15.1733">   nsCOMPtr&lt;nsILocalFile&gt; fileLoc = do_QueryInterface(file, &amp;rv);</span>
<a href="#l15.1734"></a><span id="l15.1734">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.1735"></a><span id="l15.1735"> </span>
<a href="#l15.1736"></a><span id="l15.1736" class="difflineminus">-  rv = impSvc-&gt;CreateNewABDescriptor( getter_AddRefs( desc));</span>
<a href="#l15.1737"></a><span id="l15.1737" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l15.1738"></a><span id="l15.1738" class="difflineplus">+  rv = impSvc-&gt;CreateNewABDescriptor(getter_AddRefs(desc));</span>
<a href="#l15.1739"></a><span id="l15.1739" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l15.1740"></a><span id="l15.1740">   {</span>
<a href="#l15.1741"></a><span id="l15.1741">     PRInt64 sz = 0;</span>
<a href="#l15.1742"></a><span id="l15.1742" class="difflineminus">-    file-&gt;GetFileSize( &amp;sz);</span>
<a href="#l15.1743"></a><span id="l15.1743" class="difflineplus">+    file-&gt;GetFileSize(&amp;sz);</span>
<a href="#l15.1744"></a><span id="l15.1744">     desc-&gt;SetPreferredName(name);</span>
<a href="#l15.1745"></a><span id="l15.1745">     desc-&gt;SetSize((PRUint32) sz);</span>
<a href="#l15.1746"></a><span id="l15.1746">     desc-&gt;SetAbFile(fileLoc);</span>
<a href="#l15.1747"></a><span id="l15.1747" class="difflineminus">-    rv = desc-&gt;QueryInterface( kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l15.1748"></a><span id="l15.1748" class="difflineminus">-    pArray-&gt;AppendElement( pInterface);</span>
<a href="#l15.1749"></a><span id="l15.1749" class="difflineplus">+    rv = desc-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l15.1750"></a><span id="l15.1750" class="difflineplus">+    pArray-&gt;AppendElement(pInterface);</span>
<a href="#l15.1751"></a><span id="l15.1751">     pInterface-&gt;Release();</span>
<a href="#l15.1752"></a><span id="l15.1752">   }</span>
<a href="#l15.1753"></a><span id="l15.1753" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l15.1754"></a><span id="l15.1754" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l15.1755"></a><span id="l15.1755">   {</span>
<a href="#l15.1756"></a><span id="l15.1756" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error creating address book descriptor for eudora\n&quot;);</span>
<a href="#l15.1757"></a><span id="l15.1757" class="difflineminus">-    return( rv);</span>
<a href="#l15.1758"></a><span id="l15.1758" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error creating address book descriptor for eudora\n&quot;);</span>
<a href="#l15.1759"></a><span id="l15.1759" class="difflineplus">+    return rv;</span>
<a href="#l15.1760"></a><span id="l15.1760">   }</span>
<a href="#l15.1761"></a><span id="l15.1761"> </span>
<a href="#l15.1762"></a><span id="l15.1762" class="difflineminus">-  return( NS_OK);</span>
<a href="#l15.1763"></a><span id="l15.1763" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.1764"></a><span id="l15.1764"> }</span>
<a href="#l15.1765"></a><span id="l15.1765"> </span>
<a href="#l15.1766"></a><span id="l15.1766"> </span>
<a href="#l15.1767"></a><span id="l15.1767" class="difflineminus">-void nsEudoraWin32::ConvertPath( nsCString&amp; str)</span>
<a href="#l15.1768"></a><span id="l15.1768" class="difflineplus">+void nsEudoraWin32::ConvertPath(nsCString&amp; str)</span>
<a href="#l15.1769"></a><span id="l15.1769"> {</span>
<a href="#l15.1770"></a><span id="l15.1770">   nsCString  temp;</span>
<a href="#l15.1771"></a><span id="l15.1771">   nsCString  path;</span>
<a href="#l15.1772"></a><span id="l15.1772">   PRInt32    idx = 0;</span>
<a href="#l15.1773"></a><span id="l15.1773">   PRInt32    start = 0;</span>
<a href="#l15.1774"></a><span id="l15.1774">   nsCString  search;</span>
<a href="#l15.1775"></a><span id="l15.1775"> </span>
<a href="#l15.1776"></a><span id="l15.1776" class="difflineminus">-  idx = str.FindChar( '\\', idx);</span>
<a href="#l15.1777"></a><span id="l15.1777" class="difflineminus">-  if ((idx == 2) &amp;&amp; (str.CharAt( 1) == ':'))</span>
<a href="#l15.1778"></a><span id="l15.1778" class="difflineplus">+  idx = str.FindChar('\\', idx);</span>
<a href="#l15.1779"></a><span id="l15.1779" class="difflineplus">+  if ((idx == 2) &amp;&amp; (str.CharAt(1) == ':'))</span>
<a href="#l15.1780"></a><span id="l15.1780">   {</span>
<a href="#l15.1781"></a><span id="l15.1781">     path = StringHead(str, 3);</span>
<a href="#l15.1782"></a><span id="l15.1782">     idx++;</span>
<a href="#l15.1783"></a><span id="l15.1783" class="difflineminus">-    idx = str.FindChar( '\\', idx);</span>
<a href="#l15.1784"></a><span id="l15.1784" class="difflineplus">+    idx = str.FindChar('\\', idx);</span>
<a href="#l15.1785"></a><span id="l15.1785">     start = 3;</span>
<a href="#l15.1786"></a><span id="l15.1786">     if ((idx == -1) &amp;&amp; (str.Length() &gt; 3))</span>
<a href="#l15.1787"></a><span id="l15.1787">       path.Append(Substring(str, start));</span>
<a href="#l15.1788"></a><span id="l15.1788">   }</span>
<a href="#l15.1789"></a><span id="l15.1789"> </span>
<a href="#l15.1790"></a><span id="l15.1790">   WIN32_FIND_DATA findFileData;</span>
<a href="#l15.1791"></a><span id="l15.1791">   while (idx != -1)</span>
<a href="#l15.1792"></a><span id="l15.1792">   {</span>
<a href="#l15.1793"></a><span id="l15.1793">     search = path;</span>
<a href="#l15.1794"></a><span id="l15.1794">     search.Append(Substring(str, start, idx - start));</span>
<a href="#l15.1795"></a><span id="l15.1795" class="difflineminus">-    HANDLE h = FindFirstFile( search.get(), &amp;findFileData);</span>
<a href="#l15.1796"></a><span id="l15.1796" class="difflineplus">+    HANDLE h = FindFirstFile(search.get(), &amp;findFileData);</span>
<a href="#l15.1797"></a><span id="l15.1797">     if (h == INVALID_HANDLE_VALUE)</span>
<a href="#l15.1798"></a><span id="l15.1798">       return;</span>
<a href="#l15.1799"></a><span id="l15.1799" class="difflineminus">-    path.Append( findFileData.cFileName);</span>
<a href="#l15.1800"></a><span id="l15.1800" class="difflineplus">+    path.Append(findFileData.cFileName);</span>
<a href="#l15.1801"></a><span id="l15.1801">     idx++;</span>
<a href="#l15.1802"></a><span id="l15.1802">     start = idx;</span>
<a href="#l15.1803"></a><span id="l15.1803" class="difflineminus">-    idx = str.FindChar( '\\', idx);</span>
<a href="#l15.1804"></a><span id="l15.1804" class="difflineminus">-    FindClose( h);</span>
<a href="#l15.1805"></a><span id="l15.1805" class="difflineplus">+    idx = str.FindChar('\\', idx);</span>
<a href="#l15.1806"></a><span id="l15.1806" class="difflineplus">+    FindClose(h);</span>
<a href="#l15.1807"></a><span id="l15.1807">     if (idx != -1)</span>
<a href="#l15.1808"></a><span id="l15.1808" class="difflineminus">-      path.Append( '\\');</span>
<a href="#l15.1809"></a><span id="l15.1809" class="difflineplus">+      path.Append('\\');</span>
<a href="#l15.1810"></a><span id="l15.1810">     else</span>
<a href="#l15.1811"></a><span id="l15.1811">     {</span>
<a href="#l15.1812"></a><span id="l15.1812" class="difflineminus">-      path.Append( '\\');</span>
<a href="#l15.1813"></a><span id="l15.1813" class="difflineplus">+      path.Append('\\');</span>
<a href="#l15.1814"></a><span id="l15.1814">       path.Append(Substring(str, start));</span>
<a href="#l15.1815"></a><span id="l15.1815">     }</span>
<a href="#l15.1816"></a><span id="l15.1816">   }</span>
<a href="#l15.1817"></a><span id="l15.1817"> </span>
<a href="#l15.1818"></a><span id="l15.1818">   str = path;</span>
<a href="#l15.1819"></a><span id="l15.1819"> }</span>
<a href="#l15.1820"></a><span id="l15.1820"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/import/eudora/src/nsEudoraWin32.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/import/eudora/src/nsEudoraWin32.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -55,64 +55,64 @@ class nsIMsgAccount;</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6"> class nsEudoraWin32 : public nsEudoraMailbox, public nsEudoraAddress {</span>
<a href="#l16.7"></a><span id="l16.7"> public:</span>
<a href="#l16.8"></a><span id="l16.8">   nsEudoraWin32();</span>
<a href="#l16.9"></a><span id="l16.9">   ~nsEudoraWin32();</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11">     // retrieve the mail folder</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  virtual bool      FindMailFolder( nsIFile **pFolder);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+  virtual bool      FindMailFolder(nsIFile **pFolder);</span>
<a href="#l16.14"></a><span id="l16.14">     // get the list of mailboxes</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-  virtual nsresult  FindMailboxes( nsIFile *pRoot, nsISupportsArray **ppArray);</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+  virtual nsresult  FindMailboxes(nsIFile *pRoot, nsISupportsArray **ppArray);</span>
<a href="#l16.17"></a><span id="l16.17">     // get a TOC file from a mailbox file</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-  virtual nsresult  FindTOCFile( nsIFile *pMailFile, nsIFile **pTOCFile, bool *pDeleteToc);</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+  virtual nsresult  FindTOCFile(nsIFile *pMailFile, nsIFile **pTOCFile, bool *pDeleteToc);</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-  virtual nsresult  GetAttachmentInfo( const char *pFileName, nsIFile *pFile, nsCString&amp; mimeType, nsCString&amp; aAttachment);</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+  virtual nsresult  GetAttachmentInfo(const char *pFileName, nsIFile *pFile, nsCString&amp; mimeType, nsCString&amp; aAttachment);</span>
<a href="#l16.23"></a><span id="l16.23"> </span>
<a href="#l16.24"></a><span id="l16.24">   // Things that must be overridden because they are platform specific.</span>
<a href="#l16.25"></a><span id="l16.25">     // retrieve the address book folder</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-  virtual bool      FindAddressFolder( nsIFile **pFolder);</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+  virtual bool      FindAddressFolder(nsIFile **pFolder);</span>
<a href="#l16.28"></a><span id="l16.28">     // get the list of address books</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-  virtual nsresult  FindAddressBooks( nsIFile *pRoot, nsISupportsArray **ppArray);</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+  virtual nsresult  FindAddressBooks(nsIFile *pRoot, nsISupportsArray **ppArray);</span>
<a href="#l16.31"></a><span id="l16.31"> </span>
<a href="#l16.32"></a><span id="l16.32">     // import settings from Win32 ini file</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-  static bool    ImportSettings( nsIFile *pIniFile, nsIMsgAccount **localMailAccount);</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-  static bool    FindSettingsFile( nsIFile **pIniFile) { return( FindEudoraLocation( pIniFile, true));}</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+  static bool    ImportSettings(nsIFile *pIniFile, nsIMsgAccount **localMailAccount);</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+  static bool    FindSettingsFile(nsIFile **pIniFile) { return FindEudoraLocation(pIniFile, true);}</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-  static bool    FindFiltersFile( nsIFile **pFiltersFile);</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+  static bool    FindFiltersFile(nsIFile **pFiltersFile);</span>
<a href="#l16.40"></a><span id="l16.40"> </span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-  static bool    GetMailboxNameHierarchy( const nsACString&amp; pEudoraLocation, const char* pEudoraFilePath, nsCString&amp; nameHierarchy);</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+  static bool    GetMailboxNameHierarchy(const nsACString&amp; pEudoraLocation, const char* pEudoraFilePath, nsCString&amp; nameHierarchy);</span>
<a href="#l16.43"></a><span id="l16.43"> </span>
<a href="#l16.44"></a><span id="l16.44"> private:</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-  nsresult  ScanMailDir( nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport);</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-  nsresult  IterateMailDir( nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport);</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-  nsresult  ScanDescmap( nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport, const char *pData, PRInt32 len);</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-  nsresult  FoundMailFolder( nsIFile *mailFolder, const char *pName, nsISupportsArray *pArray, nsIImportService *pImport);</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-  nsresult  FoundMailbox( nsIFile *mailFile, const char *pName, nsISupportsArray *pArray, nsIImportService *pImport);</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-  bool      FindMimeIniFile( nsIFile *pFile);</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-  void    GetMimeTypeFromExtension( nsCString&amp; ext, nsCString&amp; mimeType);</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-  nsresult  FoundAddressBook( nsIFile *file, const PRUnichar *pName, nsISupportsArray *pArray, nsIImportService *impSvc);</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-  nsresult  ScanAddressDir( nsIFile *pDir, nsISupportsArray *pArray, nsIImportService *impSvc);</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+  nsresult  ScanMailDir(nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport);</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+  nsresult  IterateMailDir(nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport);</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+  nsresult  ScanDescmap(nsIFile *pFolder, nsISupportsArray *pArray, nsIImportService *pImport, const char *pData, PRInt32 len);</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+  nsresult  FoundMailFolder(nsIFile *mailFolder, const char *pName, nsISupportsArray *pArray, nsIImportService *pImport);</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+  nsresult  FoundMailbox(nsIFile *mailFile, const char *pName, nsISupportsArray *pArray, nsIImportService *pImport);</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+  bool      FindMimeIniFile(nsIFile *pFile);</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+  void    GetMimeTypeFromExtension(nsCString&amp; ext, nsCString&amp; mimeType);</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+  nsresult  FoundAddressBook(nsIFile *file, const PRUnichar *pName, nsISupportsArray *pArray, nsIImportService *impSvc);</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+  nsresult  ScanAddressDir(nsIFile *pDir, nsISupportsArray *pArray, nsIImportService *impSvc);</span>
<a href="#l16.63"></a><span id="l16.63"> </span>
<a href="#l16.64"></a><span id="l16.64"> </span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-  static bool      FindEudoraLocation( nsIFile **pFolder, bool findIni = false);</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+  static bool      FindEudoraLocation(nsIFile **pFolder, bool findIni = false);</span>
<a href="#l16.67"></a><span id="l16.67"> </span>
<a href="#l16.68"></a><span id="l16.68">     // Settings support</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-  static bool    BuildPOPAccount( nsIMsgAccountManager *accMgr, const char *pSection, const char *pIni, nsIMsgAccount **ppAccount);</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-  static bool    BuildIMAPAccount( nsIMsgAccountManager *accMgr, const char *pSection, const char *pIni, nsIMsgAccount **ppAccount);</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-  static void    GetServerAndUserName( const char *pSection, const char *pIni, nsCString&amp; serverName, nsCString&amp; userName, char *pBuff);</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineminus">-  static void    GetAccountName( const char *pSection, nsString&amp; str);</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-  static void    SetIdentities( nsIMsgAccountManager *accMgr, nsIMsgAccount *acc, const char *pSection, const char *pIniFile, const char *userName, const char *serverName, char *pBuff);</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-  static void    SetSmtpServer( nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, const char *pServer, const char *pUser);</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+  static bool    BuildPOPAccount(nsIMsgAccountManager *accMgr, const char *pSection, const char *pIni, nsIMsgAccount **ppAccount);</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+  static bool    BuildIMAPAccount(nsIMsgAccountManager *accMgr, const char *pSection, const char *pIni, nsIMsgAccount **ppAccount);</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+  static void    GetServerAndUserName(const char *pSection, const char *pIni, nsCString&amp; serverName, nsCString&amp; userName, char *pBuff);</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+  static void    GetAccountName(const char *pSection, nsString&amp; str);</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+  static void    SetIdentities(nsIMsgAccountManager *accMgr, nsIMsgAccount *acc, const char *pSection, const char *pIniFile, const char *userName, const char *serverName, char *pBuff);</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+  static void    SetSmtpServer(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, const char *pServer, const char *pUser);</span>
<a href="#l16.81"></a><span id="l16.81"> </span>
<a href="#l16.82"></a><span id="l16.82"> </span>
<a href="#l16.83"></a><span id="l16.83"> </span>
<a href="#l16.84"></a><span id="l16.84" class="difflineminus">-  static BYTE *  GetValueBytes( HKEY hKey, const char *pValueName);</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineminus">-  static void    ConvertPath( nsCString&amp; str);</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+  static BYTE *  GetValueBytes(HKEY hKey, const char *pValueName);</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+  static void    ConvertPath(nsCString&amp; str);</span>
<a href="#l16.88"></a><span id="l16.88"> </span>
<a href="#l16.89"></a><span id="l16.89"> private:</span>
<a href="#l16.90"></a><span id="l16.90">   PRUint32    m_depth;</span>
<a href="#l16.91"></a><span id="l16.91">   nsCOMPtr &lt;nsIFile&gt;  m_addressImportFolder;</span>
<a href="#l16.92"></a><span id="l16.92">   char *      m_pMimeSection;</span>
<a href="#l16.93"></a><span id="l16.93"> };</span>
<a href="#l16.94"></a><span id="l16.94"> </span>
<a href="#l16.95"></a><span id="l16.95"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/import/oexpress/WabObject.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/import/oexpress/WabObject.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -130,17 +130,17 @@ CWAB::CWAB(nsILocalFile *file)</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5">         *szWABDllPath = '\0';</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7">         // First we look under the default WAB DLL path location in the</span>
<a href="#l17.8"></a><span id="l17.8">         // Registry.</span>
<a href="#l17.9"></a><span id="l17.9">         // WAB_DLL_PATH_KEY is defined in wabapi.h</span>
<a href="#l17.10"></a><span id="l17.10">         //</span>
<a href="#l17.11"></a><span id="l17.11">         if (ERROR_SUCCESS == RegOpenKeyEx(HKEY_LOCAL_MACHINE, WAB_DLL_PATH_KEY, 0, KEY_READ, &amp;hKey)) {</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-            RegQueryValueEx( hKey, &quot;&quot;, NULL, &amp;dwType, (LPBYTE) szWABDllPath, &amp;cbData);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+            RegQueryValueEx(hKey, &quot;&quot;, NULL, &amp;dwType, (LPBYTE) szWABDllPath, &amp;cbData);</span>
<a href="#l17.14"></a><span id="l17.14">             if (dwType == REG_EXPAND_SZ) {</span>
<a href="#l17.15"></a><span id="l17.15">                 // Expand the environment variables</span>
<a href="#l17.16"></a><span id="l17.16">                 DWORD bufferSize = ExpandEnvironmentStrings(szWABDllPath, NULL, 0);</span>
<a href="#l17.17"></a><span id="l17.17">                 if (bufferSize &amp;&amp; bufferSize &lt; MAX_PATH) {</span>
<a href="#l17.18"></a><span id="l17.18">                     TCHAR tmp[MAX_PATH];</span>
<a href="#l17.19"></a><span id="l17.19">                     ExpandEnvironmentStrings(szWABDllPath, tmp, bufferSize);</span>
<a href="#l17.20"></a><span id="l17.20">                     _tcscpy(szWABDllPath, tmp);</span>
<a href="#l17.21"></a><span id="l17.21">                 }</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -162,17 +162,17 @@ CWAB::CWAB(nsILocalFile *file)</span>
<a href="#l17.23"></a><span id="l17.23">             }</span>
<a href="#l17.24"></a><span id="l17.24">         }</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26">         if(hKey) RegCloseKey(hKey);</span>
<a href="#l17.27"></a><span id="l17.27"> </span>
<a href="#l17.28"></a><span id="l17.28">         // if the Registry came up blank, we do a loadlibrary on the wab32.dll</span>
<a href="#l17.29"></a><span id="l17.29">         // WAB_DLL_NAME is defined in wabapi.h</span>
<a href="#l17.30"></a><span id="l17.30">         //</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-        m_hinstWAB = LoadLibrary( (lstrlen(szWABDllPath)) ? szWABDllPath : WAB_DLL_NAME );</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+        m_hinstWAB = LoadLibrary((lstrlen(szWABDllPath)) ? szWABDllPath : WAB_DLL_NAME);</span>
<a href="#l17.33"></a><span id="l17.33">     }</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35">     if(m_hinstWAB)</span>
<a href="#l17.36"></a><span id="l17.36">     {</span>
<a href="#l17.37"></a><span id="l17.37">         // if we loaded the dll, get the entry point</span>
<a href="#l17.38"></a><span id="l17.38">         //</span>
<a href="#l17.39"></a><span id="l17.39">         m_lpfnWABOpen = (LPWABOPEN) GetProcAddress(m_hinstWAB, &quot;WABOpen&quot;);</span>
<a href="#l17.40"></a><span id="l17.40"> </span>
<a href="#l17.41"></a><span id="l17.41" class="difflineat">@@ -223,17 +223,17 @@ CWAB::~CWAB()</span>
<a href="#l17.42"></a><span id="l17.42">             FreeLibrary(m_hinstWAB);</span>
<a href="#l17.43"></a><span id="l17.43">     }</span>
<a href="#l17.44"></a><span id="l17.44"> }</span>
<a href="#l17.45"></a><span id="l17.45"> </span>
<a href="#l17.46"></a><span id="l17.46"> </span>
<a href="#l17.47"></a><span id="l17.47"> HRESULT CWAB::IterateWABContents(CWabIterator *pIter, int *pDone)</span>
<a href="#l17.48"></a><span id="l17.48"> {</span>
<a href="#l17.49"></a><span id="l17.49">   if (!m_bInitialized || !m_lpAdrBook)</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-    return( E_FAIL);</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+    return E_FAIL;</span>
<a href="#l17.52"></a><span id="l17.52"> </span>
<a href="#l17.53"></a><span id="l17.53">   ULONG      ulObjType =   0;</span>
<a href="#l17.54"></a><span id="l17.54">   LPMAPITABLE    lpAB =  NULL;</span>
<a href="#l17.55"></a><span id="l17.55">   ULONG      cRows =       0;</span>
<a href="#l17.56"></a><span id="l17.56">   LPSRowSet    lpRowAB = NULL;</span>
<a href="#l17.57"></a><span id="l17.57">   LPABCONT    lpContainer = NULL;</span>
<a href="#l17.58"></a><span id="l17.58">   int        cNumRows = 0;</span>
<a href="#l17.59"></a><span id="l17.59">   nsresult      keepGoing;</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineat">@@ -244,19 +244,19 @@ HRESULT CWAB::IterateWABContents(CWabIte</span>
<a href="#l17.61"></a><span id="l17.61">   LPENTRYID    lpEID = NULL;</span>
<a href="#l17.62"></a><span id="l17.62">   ULONG      rowCount = 0;</span>
<a href="#l17.63"></a><span id="l17.63">   ULONG      curCount = 0;</span>
<a href="#l17.64"></a><span id="l17.64"> </span>
<a href="#l17.65"></a><span id="l17.65">   nsString    uniStr;</span>
<a href="#l17.66"></a><span id="l17.66"> </span>
<a href="#l17.67"></a><span id="l17.67">   // Get the entryid of the root PAB container</span>
<a href="#l17.68"></a><span id="l17.68">   //</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-  hr = m_lpAdrBook-&gt;GetPAB( &amp;lpcbEID, &amp;lpEID);</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+  hr = m_lpAdrBook-&gt;GetPAB(&amp;lpcbEID, &amp;lpEID);</span>
<a href="#l17.71"></a><span id="l17.71"> </span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-  if (HR_FAILED( hr))</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+  if (HR_FAILED(hr))</span>
<a href="#l17.74"></a><span id="l17.74">     goto exit;</span>
<a href="#l17.75"></a><span id="l17.75"> </span>
<a href="#l17.76"></a><span id="l17.76">   ulObjType = 0;</span>
<a href="#l17.77"></a><span id="l17.77"> </span>
<a href="#l17.78"></a><span id="l17.78">   // Open the root PAB container</span>
<a href="#l17.79"></a><span id="l17.79">   // This is where all the WAB contents reside</span>
<a href="#l17.80"></a><span id="l17.80">   //</span>
<a href="#l17.81"></a><span id="l17.81">   hr = m_lpAdrBook-&gt;OpenEntry(lpcbEID,</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineat">@@ -271,43 +271,42 @@ HRESULT CWAB::IterateWABContents(CWabIte</span>
<a href="#l17.83"></a><span id="l17.83">   lpEID = NULL;</span>
<a href="#l17.84"></a><span id="l17.84"> </span>
<a href="#l17.85"></a><span id="l17.85">   if(HR_FAILED(hr))</span>
<a href="#l17.86"></a><span id="l17.86">     goto exit;</span>
<a href="#l17.87"></a><span id="l17.87"> </span>
<a href="#l17.88"></a><span id="l17.88">   // Get a contents table of all the contents in the</span>
<a href="#l17.89"></a><span id="l17.89">   // WABs root container</span>
<a href="#l17.90"></a><span id="l17.90">   //</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-  hr = lpContainer-&gt;GetContentsTable( 0,</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-    &amp;lpAB);</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+  hr = lpContainer-&gt;GetContentsTable(0, &amp;lpAB);</span>
<a href="#l17.94"></a><span id="l17.94"> </span>
<a href="#l17.95"></a><span id="l17.95">   if(HR_FAILED(hr))</span>
<a href="#l17.96"></a><span id="l17.96">     goto exit;</span>
<a href="#l17.97"></a><span id="l17.97"> </span>
<a href="#l17.98"></a><span id="l17.98" class="difflineminus">-  hr = lpAB-&gt;GetRowCount( 0, &amp;rowCount);</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+  hr = lpAB-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l17.100"></a><span id="l17.100">   if (HR_FAILED(hr))</span>
<a href="#l17.101"></a><span id="l17.101">     rowCount = 100;</span>
<a href="#l17.102"></a><span id="l17.102">   if (rowCount == 0)</span>
<a href="#l17.103"></a><span id="l17.103">     rowCount = 1;</span>
<a href="#l17.104"></a><span id="l17.104"> </span>
<a href="#l17.105"></a><span id="l17.105">   // Order the columns in the ContentsTable to conform to the</span>
<a href="#l17.106"></a><span id="l17.106">   // ones we want - which are mainly DisplayName, EntryID and</span>
<a href="#l17.107"></a><span id="l17.107">   // ObjectType</span>
<a href="#l17.108"></a><span id="l17.108">   // The table is gauranteed to set the columns in the order</span>
<a href="#l17.109"></a><span id="l17.109">   // requested</span>
<a href="#l17.110"></a><span id="l17.110">   //</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineminus">-  hr =lpAB-&gt;SetColumns( (LPSPropTagArray)&amp;ptaEid, 0 );</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+  hr =lpAB-&gt;SetColumns((LPSPropTagArray)&amp;ptaEid, 0);</span>
<a href="#l17.113"></a><span id="l17.113"> </span>
<a href="#l17.114"></a><span id="l17.114">   if(HR_FAILED(hr))</span>
<a href="#l17.115"></a><span id="l17.115">     goto exit;</span>
<a href="#l17.116"></a><span id="l17.116"> </span>
<a href="#l17.117"></a><span id="l17.117"> </span>
<a href="#l17.118"></a><span id="l17.118">   // Reset to the beginning of the table</span>
<a href="#l17.119"></a><span id="l17.119">   //</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineminus">-  hr = lpAB-&gt;SeekRow( BOOKMARK_BEGINNING, 0, NULL );</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+  hr = lpAB-&gt;SeekRow(BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l17.122"></a><span id="l17.122"> </span>
<a href="#l17.123"></a><span id="l17.123">   if(HR_FAILED(hr))</span>
<a href="#l17.124"></a><span id="l17.124">     goto exit;</span>
<a href="#l17.125"></a><span id="l17.125"> </span>
<a href="#l17.126"></a><span id="l17.126">   // Read all the rows of the table one by one</span>
<a href="#l17.127"></a><span id="l17.127">   //</span>
<a href="#l17.128"></a><span id="l17.128"> </span>
<a href="#l17.129"></a><span id="l17.129">   do {</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineat">@@ -333,33 +332,33 @@ HRESULT CWAB::IterateWABContents(CWabIte</span>
<a href="#l17.131"></a><span id="l17.131">         // objects</span>
<a href="#l17.132"></a><span id="l17.132">         //</span>
<a href="#l17.133"></a><span id="l17.133">         if(lpRowAB-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.l == MAPI_MAILUSER)</span>
<a href="#l17.134"></a><span id="l17.134">         {</span>
<a href="#l17.135"></a><span id="l17.135">           // We will now take the entry-id of each object and cache it</span>
<a href="#l17.136"></a><span id="l17.136">           // on the listview item representing that object. This enables</span>
<a href="#l17.137"></a><span id="l17.137">           // us to uniquely identify the object later if we need to</span>
<a href="#l17.138"></a><span id="l17.138">           //</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineminus">-          CStrToUnicode( lpsz, uniStr);</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineminus">-          keepGoing = pIter-&gt;EnumUser( uniStr.get(), lpEID, cbEID);</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+          CStrToUnicode(lpsz, uniStr);</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+          keepGoing = pIter-&gt;EnumUser(uniStr.get(), lpEID, cbEID);</span>
<a href="#l17.143"></a><span id="l17.143">           curCount++;</span>
<a href="#l17.144"></a><span id="l17.144">           if (pDone) {</span>
<a href="#l17.145"></a><span id="l17.145">             *pDone = (curCount * 100) / rowCount;</span>
<a href="#l17.146"></a><span id="l17.146">             if (*pDone &gt; 100)</span>
<a href="#l17.147"></a><span id="l17.147">               *pDone = 100;</span>
<a href="#l17.148"></a><span id="l17.148">           }</span>
<a href="#l17.149"></a><span id="l17.149">         }</span>
<a href="#l17.150"></a><span id="l17.150">       }</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineminus">-      FreeProws(lpRowAB );</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineplus">+      FreeProws(lpRowAB);</span>
<a href="#l17.153"></a><span id="l17.153">     }</span>
<a href="#l17.154"></a><span id="l17.154"> </span>
<a href="#l17.155"></a><span id="l17.155"> </span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-  } while ( SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRowAB &amp;&amp; NS_SUCCEEDED(keepGoing) )  ;</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+  } while (SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRowAB &amp;&amp; NS_SUCCEEDED(keepGoing))  ;</span>
<a href="#l17.158"></a><span id="l17.158"> </span>
<a href="#l17.159"></a><span id="l17.159" class="difflineminus">-  hr = lpAB-&gt;SeekRow( BOOKMARK_BEGINNING, 0, NULL );</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+  hr = lpAB-&gt;SeekRow(BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l17.161"></a><span id="l17.161"> </span>
<a href="#l17.162"></a><span id="l17.162">   if(HR_FAILED(hr))</span>
<a href="#l17.163"></a><span id="l17.163">     goto exit;</span>
<a href="#l17.164"></a><span id="l17.164"> </span>
<a href="#l17.165"></a><span id="l17.165">   // Read all the rows of the table one by one</span>
<a href="#l17.166"></a><span id="l17.166">   //</span>
<a href="#l17.167"></a><span id="l17.167">   keepGoing = TRUE;</span>
<a href="#l17.168"></a><span id="l17.168">   do {</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineat">@@ -394,59 +393,59 @@ HRESULT CWAB::IterateWABContents(CWabIte</span>
<a href="#l17.170"></a><span id="l17.170">           hr = m_lpAdrBook-&gt;OpenEntry(cbEID, lpEID, NULL,</span>
<a href="#l17.171"></a><span id="l17.171">             0,&amp;ulObjType,(LPUNKNOWN *)&amp;distListContainer);</span>
<a href="#l17.172"></a><span id="l17.172"> </span>
<a href="#l17.173"></a><span id="l17.173">           LPMAPITABLE    distListTable =  NULL;</span>
<a href="#l17.174"></a><span id="l17.174"> </span>
<a href="#l17.175"></a><span id="l17.175"> </span>
<a href="#l17.176"></a><span id="l17.176">           // Get a contents table of the dist list</span>
<a href="#l17.177"></a><span id="l17.177">           //</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineminus">-          hr = distListContainer-&gt;GetContentsTable( 0, &amp;distListTable);</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineplus">+          hr = distListContainer-&gt;GetContentsTable(0, &amp;distListTable);</span>
<a href="#l17.180"></a><span id="l17.180">           if (lpAB)</span>
<a href="#l17.181"></a><span id="l17.181">           {</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineminus">-            hr = distListTable-&gt;GetRowCount( 0, &amp;rowCount);</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineplus">+            hr = distListTable-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l17.184"></a><span id="l17.184">             if (HR_FAILED(hr))</span>
<a href="#l17.185"></a><span id="l17.185">               rowCount = 100;</span>
<a href="#l17.186"></a><span id="l17.186">             if (rowCount == 0)</span>
<a href="#l17.187"></a><span id="l17.187">               rowCount = 1;</span>
<a href="#l17.188"></a><span id="l17.188"> </span>
<a href="#l17.189"></a><span id="l17.189">             // Order the columns in the ContentsTable to conform to the</span>
<a href="#l17.190"></a><span id="l17.190">             // ones we want - which are mainly DisplayName, EntryID and</span>
<a href="#l17.191"></a><span id="l17.191">             // ObjectType</span>
<a href="#l17.192"></a><span id="l17.192">             // The table is gauranteed to set the columns in the order</span>
<a href="#l17.193"></a><span id="l17.193">             // requested</span>
<a href="#l17.194"></a><span id="l17.194">             //</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineminus">-            hr = distListTable-&gt;SetColumns( (LPSPropTagArray)&amp;ptaEid, 0 );</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineminus">-            CStrToUnicode( lpsz, uniStr);</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineminus">-            keepGoing = pIter-&gt;EnumList( uniStr.get(), lpEID, cbEID, distListTable);</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineplus">+            hr = distListTable-&gt;SetColumns((LPSPropTagArray)&amp;ptaEid, 0);</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineplus">+            CStrToUnicode(lpsz, uniStr);</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineplus">+            keepGoing = pIter-&gt;EnumList(uniStr.get(), lpEID, cbEID, distListTable);</span>
<a href="#l17.201"></a><span id="l17.201">             curCount++;</span>
<a href="#l17.202"></a><span id="l17.202">             if (pDone) {</span>
<a href="#l17.203"></a><span id="l17.203">               *pDone = (curCount * 100) / rowCount;</span>
<a href="#l17.204"></a><span id="l17.204">               if (*pDone &gt; 100)</span>
<a href="#l17.205"></a><span id="l17.205">                 *pDone = 100;</span>
<a href="#l17.206"></a><span id="l17.206">             }</span>
<a href="#l17.207"></a><span id="l17.207">           }</span>
<a href="#l17.208"></a><span id="l17.208">           if (distListContainer)</span>
<a href="#l17.209"></a><span id="l17.209">             distListContainer-&gt;Release();</span>
<a href="#l17.210"></a><span id="l17.210">           if (distListTable)</span>
<a href="#l17.211"></a><span id="l17.211">             distListTable-&gt;Release();</span>
<a href="#l17.212"></a><span id="l17.212">         }</span>
<a href="#l17.213"></a><span id="l17.213">       }</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineminus">-      FreeProws(lpRowAB );</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineplus">+      FreeProws(lpRowAB);</span>
<a href="#l17.216"></a><span id="l17.216">     }</span>
<a href="#l17.217"></a><span id="l17.217"> </span>
<a href="#l17.218"></a><span id="l17.218" class="difflineminus">-  } while ( SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRowAB &amp;&amp; NS_SUCCEEDED(keepGoing) )  ;</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineplus">+  } while (SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRowAB &amp;&amp; NS_SUCCEEDED(keepGoing))  ;</span>
<a href="#l17.220"></a><span id="l17.220"> </span>
<a href="#l17.221"></a><span id="l17.221"> </span>
<a href="#l17.222"></a><span id="l17.222"> exit:</span>
<a href="#l17.223"></a><span id="l17.223"> </span>
<a href="#l17.224"></a><span id="l17.224" class="difflineminus">-  if ( lpContainer )</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineplus">+  if (lpContainer)</span>
<a href="#l17.226"></a><span id="l17.226">     lpContainer-&gt;Release();</span>
<a href="#l17.227"></a><span id="l17.227"> </span>
<a href="#l17.228"></a><span id="l17.228" class="difflineminus">-  if ( lpAB )</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineplus">+  if (lpAB)</span>
<a href="#l17.230"></a><span id="l17.230">     lpAB-&gt;Release();</span>
<a href="#l17.231"></a><span id="l17.231"> </span>
<a href="#l17.232"></a><span id="l17.232">   return hr;</span>
<a href="#l17.233"></a><span id="l17.233"> }</span>
<a href="#l17.234"></a><span id="l17.234"> </span>
<a href="#l17.235"></a><span id="l17.235"> </span>
<a href="#l17.236"></a><span id="l17.236"> </span>
<a href="#l17.237"></a><span id="l17.237"> </span>
<a href="#l17.238"></a><span id="l17.238" class="difflineat">@@ -458,176 +457,174 @@ void CWAB::FreeProws(LPSRowSet prows)</span>
<a href="#l17.239"></a><span id="l17.239">   if (!prows)</span>
<a href="#l17.240"></a><span id="l17.240">     return;</span>
<a href="#l17.241"></a><span id="l17.241">   for (irow = 0; irow &lt; prows-&gt;cRows; ++irow)</span>
<a href="#l17.242"></a><span id="l17.242">     m_lpWABObject-&gt;FreeBuffer(prows-&gt;aRow[irow].lpProps);</span>
<a href="#l17.243"></a><span id="l17.243">   m_lpWABObject-&gt;FreeBuffer(prows);</span>
<a href="#l17.244"></a><span id="l17.244"> }</span>
<a href="#l17.245"></a><span id="l17.245"> </span>
<a href="#l17.246"></a><span id="l17.246"> </span>
<a href="#l17.247"></a><span id="l17.247" class="difflineminus">-LPDISTLIST CWAB::GetDistList( ULONG cbEid, LPENTRYID pEid)</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineplus">+LPDISTLIST CWAB::GetDistList(ULONG cbEid, LPENTRYID pEid)</span>
<a href="#l17.249"></a><span id="l17.249"> {</span>
<a href="#l17.250"></a><span id="l17.250">   if (!m_bInitialized || !m_lpAdrBook)</span>
<a href="#l17.251"></a><span id="l17.251" class="difflineminus">-    return( NULL);</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineplus">+    return NULL;</span>
<a href="#l17.253"></a><span id="l17.253"> </span>
<a href="#l17.254"></a><span id="l17.254">   LPDISTLIST  lpDistList = NULL;</span>
<a href="#l17.255"></a><span id="l17.255">   ULONG    ulObjType;</span>
<a href="#l17.256"></a><span id="l17.256"> </span>
<a href="#l17.257"></a><span id="l17.257" class="difflineminus">-  m_lpAdrBook-&gt;OpenEntry( cbEid, pEid, NULL, 0, &amp;ulObjType, (LPUNKNOWN *)&amp;lpDistList);</span>
<a href="#l17.258"></a><span id="l17.258" class="difflineminus">-  return( lpDistList);</span>
<a href="#l17.259"></a><span id="l17.259" class="difflineplus">+  m_lpAdrBook-&gt;OpenEntry(cbEid, pEid, NULL, 0, &amp;ulObjType, (LPUNKNOWN *)&amp;lpDistList);</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineplus">+  return lpDistList;</span>
<a href="#l17.261"></a><span id="l17.261"> }</span>
<a href="#l17.262"></a><span id="l17.262"> </span>
<a href="#l17.263"></a><span id="l17.263" class="difflineminus">-LPSPropValue CWAB::GetListProperty( LPDISTLIST pUser, ULONG tag)</span>
<a href="#l17.264"></a><span id="l17.264" class="difflineplus">+LPSPropValue CWAB::GetListProperty(LPDISTLIST pUser, ULONG tag)</span>
<a href="#l17.265"></a><span id="l17.265"> {</span>
<a href="#l17.266"></a><span id="l17.266">   if (!pUser)</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineminus">-    return( NULL);</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineplus">+    return NULL;</span>
<a href="#l17.269"></a><span id="l17.269"> </span>
<a href="#l17.270"></a><span id="l17.270" class="difflineminus">-  int  sz = CbNewSPropTagArray( 1);</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineplus">+  int  sz = CbNewSPropTagArray(1);</span>
<a href="#l17.272"></a><span id="l17.272">   SPropTagArray *pTag = (SPropTagArray *) new char[sz];</span>
<a href="#l17.273"></a><span id="l17.273">   pTag-&gt;cValues = 1;</span>
<a href="#l17.274"></a><span id="l17.274">   pTag-&gt;aulPropTag[0] = tag;</span>
<a href="#l17.275"></a><span id="l17.275">   LPSPropValue  lpProp = NULL;</span>
<a href="#l17.276"></a><span id="l17.276">   ULONG  cValues = 0;</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineminus">-  HRESULT hr = pUser-&gt;GetProps( pTag, 0, &amp;cValues, &amp;lpProp);</span>
<a href="#l17.278"></a><span id="l17.278" class="difflineplus">+  HRESULT hr = pUser-&gt;GetProps(pTag, 0, &amp;cValues, &amp;lpProp);</span>
<a href="#l17.279"></a><span id="l17.279">   delete [] pTag;</span>
<a href="#l17.280"></a><span id="l17.280" class="difflineminus">-  if (HR_FAILED( hr) || (cValues != 1)) {</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineplus">+  if (HR_FAILED(hr) || (cValues != 1)) {</span>
<a href="#l17.282"></a><span id="l17.282">     if (lpProp)</span>
<a href="#l17.283"></a><span id="l17.283" class="difflineminus">-      m_lpWABObject-&gt;FreeBuffer( lpProp);</span>
<a href="#l17.284"></a><span id="l17.284" class="difflineminus">-    return( NULL);</span>
<a href="#l17.285"></a><span id="l17.285" class="difflineplus">+      m_lpWABObject-&gt;FreeBuffer(lpProp);</span>
<a href="#l17.286"></a><span id="l17.286" class="difflineplus">+    return NULL;</span>
<a href="#l17.287"></a><span id="l17.287">   }</span>
<a href="#l17.288"></a><span id="l17.288" class="difflineminus">-  return( lpProp);</span>
<a href="#l17.289"></a><span id="l17.289" class="difflineplus">+  return lpProp;</span>
<a href="#l17.290"></a><span id="l17.290"> }</span>
<a href="#l17.291"></a><span id="l17.291"> </span>
<a href="#l17.292"></a><span id="l17.292" class="difflineminus">-LPMAILUSER CWAB::GetUser( ULONG cbEid, LPENTRYID pEid)</span>
<a href="#l17.293"></a><span id="l17.293" class="difflineplus">+LPMAILUSER CWAB::GetUser(ULONG cbEid, LPENTRYID pEid)</span>
<a href="#l17.294"></a><span id="l17.294"> {</span>
<a href="#l17.295"></a><span id="l17.295">   if (!m_bInitialized || !m_lpAdrBook)</span>
<a href="#l17.296"></a><span id="l17.296" class="difflineminus">-    return( NULL);</span>
<a href="#l17.297"></a><span id="l17.297" class="difflineplus">+    return NULL;</span>
<a href="#l17.298"></a><span id="l17.298"> </span>
<a href="#l17.299"></a><span id="l17.299">   LPMAILUSER  lpMailUser = NULL;</span>
<a href="#l17.300"></a><span id="l17.300">   ULONG    ulObjType;</span>
<a href="#l17.301"></a><span id="l17.301"> </span>
<a href="#l17.302"></a><span id="l17.302" class="difflineminus">-  m_lpAdrBook-&gt;OpenEntry( cbEid, pEid, NULL, 0, &amp;ulObjType, (LPUNKNOWN *)&amp;lpMailUser);</span>
<a href="#l17.303"></a><span id="l17.303" class="difflineminus">-  return( lpMailUser);</span>
<a href="#l17.304"></a><span id="l17.304" class="difflineplus">+  m_lpAdrBook-&gt;OpenEntry(cbEid, pEid, NULL, 0, &amp;ulObjType, (LPUNKNOWN *)&amp;lpMailUser);</span>
<a href="#l17.305"></a><span id="l17.305" class="difflineplus">+  return lpMailUser;</span>
<a href="#l17.306"></a><span id="l17.306"> }</span>
<a href="#l17.307"></a><span id="l17.307"> </span>
<a href="#l17.308"></a><span id="l17.308" class="difflineminus">-LPSPropValue CWAB::GetUserProperty( LPMAILUSER pUser, ULONG tag)</span>
<a href="#l17.309"></a><span id="l17.309" class="difflineplus">+LPSPropValue CWAB::GetUserProperty(LPMAILUSER pUser, ULONG tag)</span>
<a href="#l17.310"></a><span id="l17.310"> {</span>
<a href="#l17.311"></a><span id="l17.311">   if (!pUser)</span>
<a href="#l17.312"></a><span id="l17.312" class="difflineminus">-    return( NULL);</span>
<a href="#l17.313"></a><span id="l17.313" class="difflineplus">+    return NULL;</span>
<a href="#l17.314"></a><span id="l17.314"> </span>
<a href="#l17.315"></a><span id="l17.315">   ULONG  uTag = tag;</span>
<a href="#l17.316"></a><span id="l17.316">   /*</span>
<a href="#l17.317"></a><span id="l17.317">     Getting Unicode does not help with getting the right</span>
<a href="#l17.318"></a><span id="l17.318">     international charset.  Windoze bloze.</span>
<a href="#l17.319"></a><span id="l17.319">   */</span>
<a href="#l17.320"></a><span id="l17.320">   /*</span>
<a href="#l17.321"></a><span id="l17.321" class="difflineminus">-  if (PROP_TYPE( uTag) == PT_STRING8) {</span>
<a href="#l17.322"></a><span id="l17.322" class="difflineminus">-    uTag = CHANGE_PROP_TYPE( tag, PT_UNICODE);</span>
<a href="#l17.323"></a><span id="l17.323" class="difflineplus">+  if (PROP_TYPE(uTag) == PT_STRING8) {</span>
<a href="#l17.324"></a><span id="l17.324" class="difflineplus">+    uTag = CHANGE_PROP_TYPE(tag, PT_UNICODE);</span>
<a href="#l17.325"></a><span id="l17.325">   }</span>
<a href="#l17.326"></a><span id="l17.326">   */</span>
<a href="#l17.327"></a><span id="l17.327"> </span>
<a href="#l17.328"></a><span id="l17.328" class="difflineminus">-  int  sz = CbNewSPropTagArray( 1);</span>
<a href="#l17.329"></a><span id="l17.329" class="difflineplus">+  int  sz = CbNewSPropTagArray(1);</span>
<a href="#l17.330"></a><span id="l17.330">   SPropTagArray *pTag = (SPropTagArray *) new char[sz];</span>
<a href="#l17.331"></a><span id="l17.331">   pTag-&gt;cValues = 1;</span>
<a href="#l17.332"></a><span id="l17.332">   pTag-&gt;aulPropTag[0] = uTag;</span>
<a href="#l17.333"></a><span id="l17.333">   LPSPropValue  lpProp = NULL;</span>
<a href="#l17.334"></a><span id="l17.334">   ULONG  cValues = 0;</span>
<a href="#l17.335"></a><span id="l17.335" class="difflineminus">-  HRESULT hr = pUser-&gt;GetProps( pTag, 0, &amp;cValues, &amp;lpProp);</span>
<a href="#l17.336"></a><span id="l17.336" class="difflineminus">-  if (HR_FAILED( hr) || (cValues != 1)) {</span>
<a href="#l17.337"></a><span id="l17.337" class="difflineplus">+  HRESULT hr = pUser-&gt;GetProps(pTag, 0, &amp;cValues, &amp;lpProp);</span>
<a href="#l17.338"></a><span id="l17.338" class="difflineplus">+  if (HR_FAILED(hr) || (cValues != 1)) {</span>
<a href="#l17.339"></a><span id="l17.339">     if (lpProp)</span>
<a href="#l17.340"></a><span id="l17.340" class="difflineminus">-      m_lpWABObject-&gt;FreeBuffer( lpProp);</span>
<a href="#l17.341"></a><span id="l17.341" class="difflineplus">+      m_lpWABObject-&gt;FreeBuffer(lpProp);</span>
<a href="#l17.342"></a><span id="l17.342">     lpProp = NULL;</span>
<a href="#l17.343"></a><span id="l17.343">     if (uTag != tag) {</span>
<a href="#l17.344"></a><span id="l17.344">       pTag-&gt;cValues = 1;</span>
<a href="#l17.345"></a><span id="l17.345">       pTag-&gt;aulPropTag[0] = tag;</span>
<a href="#l17.346"></a><span id="l17.346">       cValues = 0;</span>
<a href="#l17.347"></a><span id="l17.347" class="difflineminus">-      hr = pUser-&gt;GetProps( pTag, 0, &amp;cValues, &amp;lpProp);</span>
<a href="#l17.348"></a><span id="l17.348" class="difflineminus">-      if (HR_FAILED( hr) || (cValues != 1)) {</span>
<a href="#l17.349"></a><span id="l17.349" class="difflineplus">+      hr = pUser-&gt;GetProps(pTag, 0, &amp;cValues, &amp;lpProp);</span>
<a href="#l17.350"></a><span id="l17.350" class="difflineplus">+      if (HR_FAILED(hr) || (cValues != 1)) {</span>
<a href="#l17.351"></a><span id="l17.351">         if (lpProp)</span>
<a href="#l17.352"></a><span id="l17.352" class="difflineminus">-          m_lpWABObject-&gt;FreeBuffer( lpProp);</span>
<a href="#l17.353"></a><span id="l17.353" class="difflineplus">+          m_lpWABObject-&gt;FreeBuffer(lpProp);</span>
<a href="#l17.354"></a><span id="l17.354">         lpProp = NULL;</span>
<a href="#l17.355"></a><span id="l17.355">       }</span>
<a href="#l17.356"></a><span id="l17.356">     }</span>
<a href="#l17.357"></a><span id="l17.357">   }</span>
<a href="#l17.358"></a><span id="l17.358">   delete [] pTag;</span>
<a href="#l17.359"></a><span id="l17.359" class="difflineminus">-  return( lpProp);</span>
<a href="#l17.360"></a><span id="l17.360" class="difflineplus">+  return lpProp;</span>
<a href="#l17.361"></a><span id="l17.361"> }</span>
<a href="#l17.362"></a><span id="l17.362"> </span>
<a href="#l17.363"></a><span id="l17.363" class="difflineminus">-void CWAB::CStrToUnicode( const char *pStr, nsString&amp; result)</span>
<a href="#l17.364"></a><span id="l17.364" class="difflineplus">+void CWAB::CStrToUnicode(const char *pStr, nsString&amp; result)</span>
<a href="#l17.365"></a><span id="l17.365"> {</span>
<a href="#l17.366"></a><span id="l17.366">   result.Truncate();</span>
<a href="#l17.367"></a><span id="l17.367" class="difflineminus">-  int wLen = MultiByteToWideChar( CP_ACP, 0, pStr, -1, m_pUniBuff, 0);</span>
<a href="#l17.368"></a><span id="l17.368" class="difflineplus">+  int wLen = MultiByteToWideChar(CP_ACP, 0, pStr, -1, m_pUniBuff, 0);</span>
<a href="#l17.369"></a><span id="l17.369">   if (wLen &gt;= m_uniBuffLen) {</span>
<a href="#l17.370"></a><span id="l17.370">     if (m_pUniBuff)</span>
<a href="#l17.371"></a><span id="l17.371">       delete [] m_pUniBuff;</span>
<a href="#l17.372"></a><span id="l17.372">     m_pUniBuff = new PRUnichar[wLen + 64];</span>
<a href="#l17.373"></a><span id="l17.373">     m_uniBuffLen = wLen + 64;</span>
<a href="#l17.374"></a><span id="l17.374">   }</span>
<a href="#l17.375"></a><span id="l17.375">   if (wLen) {</span>
<a href="#l17.376"></a><span id="l17.376" class="difflineminus">-    MultiByteToWideChar( CP_ACP, 0, pStr, -1, m_pUniBuff, m_uniBuffLen);</span>
<a href="#l17.377"></a><span id="l17.377" class="difflineplus">+    MultiByteToWideChar(CP_ACP, 0, pStr, -1, m_pUniBuff, m_uniBuffLen);</span>
<a href="#l17.378"></a><span id="l17.378">     result = m_pUniBuff;</span>
<a href="#l17.379"></a><span id="l17.379">   }</span>
<a href="#l17.380"></a><span id="l17.380"> }</span>
<a href="#l17.381"></a><span id="l17.381"> </span>
<a href="#l17.382"></a><span id="l17.382"> // If the value is a string, get it...</span>
<a href="#l17.383"></a><span id="l17.383" class="difflineminus">-void CWAB::GetValueString( LPSPropValue pVal, nsString&amp; val)</span>
<a href="#l17.384"></a><span id="l17.384" class="difflineplus">+void CWAB::GetValueString(LPSPropValue pVal, nsString&amp; val)</span>
<a href="#l17.385"></a><span id="l17.385"> {</span>
<a href="#l17.386"></a><span id="l17.386">   val.Truncate();</span>
<a href="#l17.387"></a><span id="l17.387"> </span>
<a href="#l17.388"></a><span id="l17.388">   if (!pVal)</span>
<a href="#l17.389"></a><span id="l17.389">     return;</span>
<a href="#l17.390"></a><span id="l17.390"> </span>
<a href="#l17.391"></a><span id="l17.391" class="difflineminus">-    switch( PROP_TYPE( pVal-&gt;ulPropTag)) {</span>
<a href="#l17.392"></a><span id="l17.392" class="difflineminus">-  case PT_STRING8: {</span>
<a href="#l17.393"></a><span id="l17.393" class="difflineminus">-      CStrToUnicode( (const char *) (pVal-&gt;Value.lpszA), val);</span>
<a href="#l17.394"></a><span id="l17.394" class="difflineminus">-    }</span>
<a href="#l17.395"></a><span id="l17.395" class="difflineminus">-        break;</span>
<a href="#l17.396"></a><span id="l17.396" class="difflineplus">+  switch(PROP_TYPE(pVal-&gt;ulPropTag)) {</span>
<a href="#l17.397"></a><span id="l17.397" class="difflineplus">+    case PT_STRING8:</span>
<a href="#l17.398"></a><span id="l17.398" class="difflineplus">+      CStrToUnicode((const char *) (pVal-&gt;Value.lpszA), val);</span>
<a href="#l17.399"></a><span id="l17.399" class="difflineplus">+      break;</span>
<a href="#l17.400"></a><span id="l17.400">     case PT_UNICODE:</span>
<a href="#l17.401"></a><span id="l17.401">       val = (PRUnichar *) (pVal-&gt;Value.lpszW);</span>
<a href="#l17.402"></a><span id="l17.402" class="difflineminus">-    break;</span>
<a href="#l17.403"></a><span id="l17.403" class="difflineplus">+      break;</span>
<a href="#l17.404"></a><span id="l17.404">     case PT_MV_STRING8: {</span>
<a href="#l17.405"></a><span id="l17.405">       nsString  tmp;</span>
<a href="#l17.406"></a><span id="l17.406" class="difflineminus">-            ULONG  j;</span>
<a href="#l17.407"></a><span id="l17.407" class="difflineminus">-            for(j = 0; j &lt; pVal-&gt;Value.MVszA.cValues; j++) {</span>
<a href="#l17.408"></a><span id="l17.408" class="difflineminus">-        CStrToUnicode( (const char *) (pVal-&gt;Value.MVszA.lppszA[j]), tmp);</span>
<a href="#l17.409"></a><span id="l17.409" class="difflineminus">-                val += tmp;</span>
<a href="#l17.410"></a><span id="l17.410" class="difflineminus">-                val.Append(NS_ConvertASCIItoUTF16(TR_OUTPUT_EOL));</span>
<a href="#l17.411"></a><span id="l17.411" class="difflineminus">-            }</span>
<a href="#l17.412"></a><span id="l17.412" class="difflineminus">-        }</span>
<a href="#l17.413"></a><span id="l17.413" class="difflineminus">-        break;</span>
<a href="#l17.414"></a><span id="l17.414" class="difflineplus">+      ULONG  j;</span>
<a href="#l17.415"></a><span id="l17.415" class="difflineplus">+      for(j = 0; j &lt; pVal-&gt;Value.MVszA.cValues; j++) {</span>
<a href="#l17.416"></a><span id="l17.416" class="difflineplus">+        CStrToUnicode((const char *) (pVal-&gt;Value.MVszA.lppszA[j]), tmp);</span>
<a href="#l17.417"></a><span id="l17.417" class="difflineplus">+        val += tmp;</span>
<a href="#l17.418"></a><span id="l17.418" class="difflineplus">+        val.Append(NS_ConvertASCIItoUTF16(TR_OUTPUT_EOL));</span>
<a href="#l17.419"></a><span id="l17.419" class="difflineplus">+      }</span>
<a href="#l17.420"></a><span id="l17.420" class="difflineplus">+      break;</span>
<a href="#l17.421"></a><span id="l17.421" class="difflineplus">+    }</span>
<a href="#l17.422"></a><span id="l17.422">     case PT_MV_UNICODE: {</span>
<a href="#l17.423"></a><span id="l17.423" class="difflineminus">-            ULONG  j;</span>
<a href="#l17.424"></a><span id="l17.424" class="difflineminus">-            for(j = 0; j &lt; pVal-&gt;Value.MVszW.cValues; j++) {</span>
<a href="#l17.425"></a><span id="l17.425" class="difflineminus">-                val += (PRUnichar *) (pVal-&gt;Value.MVszW.lppszW[j]);</span>
<a href="#l17.426"></a><span id="l17.426" class="difflineminus">-                val.Append(NS_ConvertASCIItoUTF16(TR_OUTPUT_EOL));</span>
<a href="#l17.427"></a><span id="l17.427" class="difflineminus">-            }</span>
<a href="#l17.428"></a><span id="l17.428" class="difflineminus">-        }</span>
<a href="#l17.429"></a><span id="l17.429" class="difflineminus">-        break;</span>
<a href="#l17.430"></a><span id="l17.430" class="difflineminus">-</span>
<a href="#l17.431"></a><span id="l17.431" class="difflineplus">+      ULONG  j;</span>
<a href="#l17.432"></a><span id="l17.432" class="difflineplus">+      for(j = 0; j &lt; pVal-&gt;Value.MVszW.cValues; j++) {</span>
<a href="#l17.433"></a><span id="l17.433" class="difflineplus">+        val += (PRUnichar *) (pVal-&gt;Value.MVszW.lppszW[j]);</span>
<a href="#l17.434"></a><span id="l17.434" class="difflineplus">+        val.Append(NS_ConvertASCIItoUTF16(TR_OUTPUT_EOL));</span>
<a href="#l17.435"></a><span id="l17.435" class="difflineplus">+      }</span>
<a href="#l17.436"></a><span id="l17.436" class="difflineplus">+      break;</span>
<a href="#l17.437"></a><span id="l17.437" class="difflineplus">+    }</span>
<a href="#l17.438"></a><span id="l17.438">     case PT_I2:</span>
<a href="#l17.439"></a><span id="l17.439">     case PT_LONG:</span>
<a href="#l17.440"></a><span id="l17.440">     case PT_R4:</span>
<a href="#l17.441"></a><span id="l17.441">     case PT_DOUBLE:</span>
<a href="#l17.442"></a><span id="l17.442">     case PT_BOOLEAN: {</span>
<a href="#l17.443"></a><span id="l17.443">       /*</span>
<a href="#l17.444"></a><span id="l17.444">       TCHAR sz[256];</span>
<a href="#l17.445"></a><span id="l17.445">             wsprintf(sz,&quot;%d&quot;, pVal-&gt;Value.l);</span>
<a href="#l17.446"></a><span id="l17.446">             val = sz;</span>
<a href="#l17.447"></a><span id="l17.447">       */</span>
<a href="#l17.448"></a><span id="l17.448" class="difflineminus">-        }</span>
<a href="#l17.449"></a><span id="l17.449" class="difflineminus">-        break;</span>
<a href="#l17.450"></a><span id="l17.450" class="difflineplus">+      break;</span>
<a href="#l17.451"></a><span id="l17.451" class="difflineplus">+    }</span>
<a href="#l17.452"></a><span id="l17.452"> </span>
<a href="#l17.453"></a><span id="l17.453">     case PT_BINARY:</span>
<a href="#l17.454"></a><span id="l17.454" class="difflineminus">-    break;</span>
<a href="#l17.455"></a><span id="l17.455" class="difflineplus">+      break;</span>
<a href="#l17.456"></a><span id="l17.456"> </span>
<a href="#l17.457"></a><span id="l17.457">     default:</span>
<a href="#l17.458"></a><span id="l17.458" class="difflineminus">-        break;</span>
<a href="#l17.459"></a><span id="l17.459" class="difflineminus">-    }</span>
<a href="#l17.460"></a><span id="l17.460" class="difflineplus">+      break;</span>
<a href="#l17.461"></a><span id="l17.461" class="difflineplus">+  }</span>
<a href="#l17.462"></a><span id="l17.462"> </span>
<a href="#l17.463"></a><span id="l17.463" class="difflineminus">-  val.Trim( kWhitespace, true, true);</span>
<a href="#l17.464"></a><span id="l17.464" class="difflineplus">+  val.Trim(kWhitespace, true, true);</span>
<a href="#l17.465"></a><span id="l17.465"> }</span>
<a href="#l17.466"></a><span id="l17.466"> </span>
<a href="#l17.467"></a><span id="l17.467"> </span>
<a href="#l17.468"></a><span id="l17.468"> void CWAB::GetValueTime(LPSPropValue pVal, PRTime&amp; val)</span>
<a href="#l17.469"></a><span id="l17.469"> {</span>
<a href="#l17.470"></a><span id="l17.470">   if (!pVal)</span>
<a href="#l17.471"></a><span id="l17.471">     return;</span>
<a href="#l17.472"></a><span id="l17.472"> </span>
<a href="#l17.473"></a><span id="l17.473" class="difflineat">@@ -635,81 +632,81 @@ void CWAB::GetValueTime(LPSPropValue pVa</span>
<a href="#l17.474"></a><span id="l17.474">     return;</span>
<a href="#l17.475"></a><span id="l17.475"> </span>
<a href="#l17.476"></a><span id="l17.476">   nsOE5File::FileTimeToPRTime(&amp;pVal-&gt;Value.ft, &amp;val);</span>
<a href="#l17.477"></a><span id="l17.477"> }</span>
<a href="#l17.478"></a><span id="l17.478"> </span>
<a href="#l17.479"></a><span id="l17.479"> </span>
<a href="#l17.480"></a><span id="l17.480"> </span>
<a href="#l17.481"></a><span id="l17.481"> /*</span>
<a href="#l17.482"></a><span id="l17.482" class="difflineminus">-BOOL CWabIterateProcess::SanitizeMultiLine( CString&amp; val)</span>
<a href="#l17.483"></a><span id="l17.483" class="difflineplus">+BOOL CWabIterateProcess::SanitizeMultiLine(CString&amp; val)</span>
<a href="#l17.484"></a><span id="l17.484"> {</span>
<a href="#l17.485"></a><span id="l17.485">   val.TrimLeft();</span>
<a href="#l17.486"></a><span id="l17.486">   val.TrimRight();</span>
<a href="#l17.487"></a><span id="l17.487" class="difflineminus">-  int idx = val.FindOneOf( &quot;\x0D\x0A&quot;);</span>
<a href="#l17.488"></a><span id="l17.488" class="difflineplus">+  int idx = val.FindOneOf(&quot;\x0D\x0A&quot;);</span>
<a href="#l17.489"></a><span id="l17.489">   if (idx == -1)</span>
<a href="#l17.490"></a><span id="l17.490" class="difflineminus">-    return( FALSE);</span>
<a href="#l17.491"></a><span id="l17.491" class="difflineplus">+    return FALSE;</span>
<a href="#l17.492"></a><span id="l17.492"> </span>
<a href="#l17.493"></a><span id="l17.493">   // needs encoding</span>
<a href="#l17.494"></a><span id="l17.494" class="difflineminus">-  U32 bufSz = UMimeEncode::GetBufferSize( val.GetLength());</span>
<a href="#l17.495"></a><span id="l17.495" class="difflineplus">+  U32 bufSz = UMimeEncode::GetBufferSize(val.GetLength());</span>
<a href="#l17.496"></a><span id="l17.496">   P_U8 pBuf = new U8[bufSz];</span>
<a href="#l17.497"></a><span id="l17.497" class="difflineminus">-  U32 len = UMimeEncode::ConvertBuffer( (PC_U8)((PC_S8)val), val.GetLength(), pBuf, 66, 52, &quot;\x0D\x0A &quot;);</span>
<a href="#l17.498"></a><span id="l17.498" class="difflineplus">+  U32 len = UMimeEncode::ConvertBuffer((PC_U8)((PC_S8)val), val.GetLength(), pBuf, 66, 52, &quot;\x0D\x0A &quot;);</span>
<a href="#l17.499"></a><span id="l17.499">   pBuf[len] = 0;</span>
<a href="#l17.500"></a><span id="l17.500">   val = pBuf;</span>
<a href="#l17.501"></a><span id="l17.501">   delete pBuf;</span>
<a href="#l17.502"></a><span id="l17.502" class="difflineminus">-  return( TRUE);</span>
<a href="#l17.503"></a><span id="l17.503" class="difflineplus">+  return TRUE;</span>
<a href="#l17.504"></a><span id="l17.504"> }</span>
<a href="#l17.505"></a><span id="l17.505"> </span>
<a href="#l17.506"></a><span id="l17.506" class="difflineminus">-BOOL CWabIterateProcess::EnumUser( LPCTSTR pName, LPENTRYID pEid, ULONG cbEid)</span>
<a href="#l17.507"></a><span id="l17.507" class="difflineplus">+BOOL CWabIterateProcess::EnumUser(LPCTSTR pName, LPENTRYID pEid, ULONG cbEid)</span>
<a href="#l17.508"></a><span id="l17.508"> {</span>
<a href="#l17.509"></a><span id="l17.509" class="difflineminus">-  TRACE1( &quot;User: %s\n&quot;, pName);</span>
<a href="#l17.510"></a><span id="l17.510" class="difflineplus">+  TRACE1(&quot;User: %s\n&quot;, pName);</span>
<a href="#l17.511"></a><span id="l17.511"> </span>
<a href="#l17.512"></a><span id="l17.512" class="difflineminus">-  LPMAILUSER  pUser = m_pWab-&gt;GetUser( cbEid, pEid);</span>
<a href="#l17.513"></a><span id="l17.513" class="difflineplus">+  LPMAILUSER  pUser = m_pWab-&gt;GetUser(cbEid, pEid);</span>
<a href="#l17.514"></a><span id="l17.514"> </span>
<a href="#l17.515"></a><span id="l17.515">   // Get the &quot;required&quot; strings first</span>
<a href="#l17.516"></a><span id="l17.516">   CString    lastName;</span>
<a href="#l17.517"></a><span id="l17.517">   CString    firstName;</span>
<a href="#l17.518"></a><span id="l17.518">   CString    eMail;</span>
<a href="#l17.519"></a><span id="l17.519">   CString    nickName;</span>
<a href="#l17.520"></a><span id="l17.520">   CString    middleName;</span>
<a href="#l17.521"></a><span id="l17.521"> </span>
<a href="#l17.522"></a><span id="l17.522">   if (!pUser) {</span>
<a href="#l17.523"></a><span id="l17.523" class="difflineminus">-    UDialogs::ErrMessage1( IDS_ENTRY_ERROR, pName);</span>
<a href="#l17.524"></a><span id="l17.524" class="difflineminus">-    return( FALSE);</span>
<a href="#l17.525"></a><span id="l17.525" class="difflineplus">+    UDialogs::ErrMessage1(IDS_ENTRY_ERROR, pName);</span>
<a href="#l17.526"></a><span id="l17.526" class="difflineplus">+    return FALSE;</span>
<a href="#l17.527"></a><span id="l17.527">   }</span>
<a href="#l17.528"></a><span id="l17.528"> </span>
<a href="#l17.529"></a><span id="l17.529" class="difflineminus">-  LPSPropValue  pProp = m_pWab-&gt;GetUserProperty( pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l17.530"></a><span id="l17.530" class="difflineplus">+  LPSPropValue  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l17.531"></a><span id="l17.531">   if (pProp) {</span>
<a href="#l17.532"></a><span id="l17.532" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, eMail);</span>
<a href="#l17.533"></a><span id="l17.533" class="difflineminus">-    SanitizeValue( eMail);</span>
<a href="#l17.534"></a><span id="l17.534" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l17.535"></a><span id="l17.535" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, eMail);</span>
<a href="#l17.536"></a><span id="l17.536" class="difflineplus">+    SanitizeValue(eMail);</span>
<a href="#l17.537"></a><span id="l17.537" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l17.538"></a><span id="l17.538">   }</span>
<a href="#l17.539"></a><span id="l17.539" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty( pUser, PR_GIVEN_NAME);</span>
<a href="#l17.540"></a><span id="l17.540" class="difflineplus">+  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_GIVEN_NAME);</span>
<a href="#l17.541"></a><span id="l17.541">   if (pProp) {</span>
<a href="#l17.542"></a><span id="l17.542" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, firstName);</span>
<a href="#l17.543"></a><span id="l17.543" class="difflineminus">-    SanitizeValue( firstName);</span>
<a href="#l17.544"></a><span id="l17.544" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l17.545"></a><span id="l17.545" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, firstName);</span>
<a href="#l17.546"></a><span id="l17.546" class="difflineplus">+    SanitizeValue(firstName);</span>
<a href="#l17.547"></a><span id="l17.547" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l17.548"></a><span id="l17.548">   }</span>
<a href="#l17.549"></a><span id="l17.549" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty( pUser, PR_SURNAME);</span>
<a href="#l17.550"></a><span id="l17.550" class="difflineplus">+  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_SURNAME);</span>
<a href="#l17.551"></a><span id="l17.551">   if (pProp) {</span>
<a href="#l17.552"></a><span id="l17.552" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, lastName);</span>
<a href="#l17.553"></a><span id="l17.553" class="difflineminus">-    SanitizeValue( lastName);</span>
<a href="#l17.554"></a><span id="l17.554" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l17.555"></a><span id="l17.555" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, lastName);</span>
<a href="#l17.556"></a><span id="l17.556" class="difflineplus">+    SanitizeValue(lastName);</span>
<a href="#l17.557"></a><span id="l17.557" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l17.558"></a><span id="l17.558">   }</span>
<a href="#l17.559"></a><span id="l17.559" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty( pUser, PR_MIDDLE_NAME);</span>
<a href="#l17.560"></a><span id="l17.560" class="difflineplus">+  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_MIDDLE_NAME);</span>
<a href="#l17.561"></a><span id="l17.561">   if (pProp) {</span>
<a href="#l17.562"></a><span id="l17.562" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, middleName);</span>
<a href="#l17.563"></a><span id="l17.563" class="difflineminus">-    SanitizeValue( middleName);</span>
<a href="#l17.564"></a><span id="l17.564" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l17.565"></a><span id="l17.565" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, middleName);</span>
<a href="#l17.566"></a><span id="l17.566" class="difflineplus">+    SanitizeValue(middleName);</span>
<a href="#l17.567"></a><span id="l17.567" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l17.568"></a><span id="l17.568">   }</span>
<a href="#l17.569"></a><span id="l17.569" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty( pUser, PR_NICKNAME);</span>
<a href="#l17.570"></a><span id="l17.570" class="difflineplus">+  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_NICKNAME);</span>
<a href="#l17.571"></a><span id="l17.571">   if (pProp) {</span>
<a href="#l17.572"></a><span id="l17.572" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, nickName);</span>
<a href="#l17.573"></a><span id="l17.573" class="difflineminus">-    SanitizeValue( nickName);</span>
<a href="#l17.574"></a><span id="l17.574" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l17.575"></a><span id="l17.575" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, nickName);</span>
<a href="#l17.576"></a><span id="l17.576" class="difflineplus">+    SanitizeValue(nickName);</span>
<a href="#l17.577"></a><span id="l17.577" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l17.578"></a><span id="l17.578">   }</span>
<a href="#l17.579"></a><span id="l17.579">   if (nickName.IsEmpty())</span>
<a href="#l17.580"></a><span id="l17.580">     nickName = pName;</span>
<a href="#l17.581"></a><span id="l17.581">   if (firstName.IsEmpty()) {</span>
<a href="#l17.582"></a><span id="l17.582">     firstName = nickName;</span>
<a href="#l17.583"></a><span id="l17.583">     middleName.Empty();</span>
<a href="#l17.584"></a><span id="l17.584">     lastName.Empty();</span>
<a href="#l17.585"></a><span id="l17.585">   }</span>
<a href="#l17.586"></a><span id="l17.586" class="difflineat">@@ -724,410 +721,410 @@ BOOL CWabIterateProcess::EnumUser( LPCTS</span>
<a href="#l17.587"></a><span id="l17.587">   // write them out followed by any optional fields!</span>
<a href="#l17.588"></a><span id="l17.588">   BOOL  result = TRUE;</span>
<a href="#l17.589"></a><span id="l17.589"> </span>
<a href="#l17.590"></a><span id="l17.590">   if (m_recordsDone)</span>
<a href="#l17.591"></a><span id="l17.591">     result = m_out.WriteEol();</span>
<a href="#l17.592"></a><span id="l17.592"> </span>
<a href="#l17.593"></a><span id="l17.593">   CString    line;</span>
<a href="#l17.594"></a><span id="l17.594">   CString    header;</span>
<a href="#l17.595"></a><span id="l17.595" class="difflineminus">-  line.LoadString( IDS_LDIF_DN_START);</span>
<a href="#l17.596"></a><span id="l17.596" class="difflineplus">+  line.LoadString(IDS_LDIF_DN_START);</span>
<a href="#l17.597"></a><span id="l17.597">   line += firstName;</span>
<a href="#l17.598"></a><span id="l17.598">   if (!middleName.IsEmpty()) {</span>
<a href="#l17.599"></a><span id="l17.599">     line += ' ';</span>
<a href="#l17.600"></a><span id="l17.600">     line += middleName;</span>
<a href="#l17.601"></a><span id="l17.601">   }</span>
<a href="#l17.602"></a><span id="l17.602">   if (!lastName.IsEmpty()) {</span>
<a href="#l17.603"></a><span id="l17.603">     line += ' ';</span>
<a href="#l17.604"></a><span id="l17.604">     line += lastName;</span>
<a href="#l17.605"></a><span id="l17.605">   }</span>
<a href="#l17.606"></a><span id="l17.606" class="difflineminus">-  header.LoadString( IDS_LDIF_DN_MIDDLE);</span>
<a href="#l17.607"></a><span id="l17.607" class="difflineplus">+  header.LoadString(IDS_LDIF_DN_MIDDLE);</span>
<a href="#l17.608"></a><span id="l17.608">   line += header;</span>
<a href="#l17.609"></a><span id="l17.609">   line += eMail;</span>
<a href="#l17.610"></a><span id="l17.610" class="difflineminus">-  result = result &amp;&amp; m_out.WriteStr( line);</span>
<a href="#l17.611"></a><span id="l17.611" class="difflineplus">+  result = result &amp;&amp; m_out.WriteStr(line);</span>
<a href="#l17.612"></a><span id="l17.612">   result = result &amp;&amp; m_out.WriteEol();</span>
<a href="#l17.613"></a><span id="l17.613"> </span>
<a href="#l17.614"></a><span id="l17.614" class="difflineminus">-  line.LoadString( IDS_FIELD_LDIF_FULLNAME);</span>
<a href="#l17.615"></a><span id="l17.615" class="difflineplus">+  line.LoadString(IDS_FIELD_LDIF_FULLNAME);</span>
<a href="#l17.616"></a><span id="l17.616">   line += ' ';</span>
<a href="#l17.617"></a><span id="l17.617">   line += firstName;</span>
<a href="#l17.618"></a><span id="l17.618">   if (!middleName.IsEmpty()) {</span>
<a href="#l17.619"></a><span id="l17.619">     line += ' ';</span>
<a href="#l17.620"></a><span id="l17.620">     line += middleName;</span>
<a href="#l17.621"></a><span id="l17.621">   }</span>
<a href="#l17.622"></a><span id="l17.622">   if (!lastName.IsEmpty()) {</span>
<a href="#l17.623"></a><span id="l17.623">     line += ' ';</span>
<a href="#l17.624"></a><span id="l17.624">     line += lastName;</span>
<a href="#l17.625"></a><span id="l17.625">   }</span>
<a href="#l17.626"></a><span id="l17.626" class="difflineminus">-  result = result &amp;&amp; m_out.WriteStr( line);</span>
<a href="#l17.627"></a><span id="l17.627" class="difflineplus">+  result = result &amp;&amp; m_out.WriteStr(line);</span>
<a href="#l17.628"></a><span id="l17.628">   result = result &amp;&amp; m_out.WriteEol();</span>
<a href="#l17.629"></a><span id="l17.629"> </span>
<a href="#l17.630"></a><span id="l17.630"> </span>
<a href="#l17.631"></a><span id="l17.631" class="difflineminus">-  line.LoadString( IDS_FIELD_LDIF_GIVENNAME);</span>
<a href="#l17.632"></a><span id="l17.632" class="difflineplus">+  line.LoadString(IDS_FIELD_LDIF_GIVENNAME);</span>
<a href="#l17.633"></a><span id="l17.633">   line += ' ';</span>
<a href="#l17.634"></a><span id="l17.634">   line += firstName;</span>
<a href="#l17.635"></a><span id="l17.635" class="difflineminus">-  result = result &amp;&amp; m_out.WriteStr( line);</span>
<a href="#l17.636"></a><span id="l17.636" class="difflineplus">+  result = result &amp;&amp; m_out.WriteStr(line);</span>
<a href="#l17.637"></a><span id="l17.637">   result = result &amp;&amp; m_out.WriteEol();</span>
<a href="#l17.638"></a><span id="l17.638"> </span>
<a href="#l17.639"></a><span id="l17.639">   if (!lastName.IsEmpty()) {</span>
<a href="#l17.640"></a><span id="l17.640" class="difflineminus">-    line.LoadString( IDS_FIELD_LDIF_LASTNAME);</span>
<a href="#l17.641"></a><span id="l17.641" class="difflineplus">+    line.LoadString(IDS_FIELD_LDIF_LASTNAME);</span>
<a href="#l17.642"></a><span id="l17.642">     if (!middleName.IsEmpty()) {</span>
<a href="#l17.643"></a><span id="l17.643">       line += ' ';</span>
<a href="#l17.644"></a><span id="l17.644">       line += middleName;</span>
<a href="#l17.645"></a><span id="l17.645">     }</span>
<a href="#l17.646"></a><span id="l17.646">     line += ' ';</span>
<a href="#l17.647"></a><span id="l17.647">     line += lastName;</span>
<a href="#l17.648"></a><span id="l17.648" class="difflineminus">-    result = result &amp;&amp; m_out.WriteStr( line);</span>
<a href="#l17.649"></a><span id="l17.649" class="difflineplus">+    result = result &amp;&amp; m_out.WriteStr(line);</span>
<a href="#l17.650"></a><span id="l17.650">     result = result &amp;&amp; m_out.WriteEol();</span>
<a href="#l17.651"></a><span id="l17.651">   }</span>
<a href="#l17.652"></a><span id="l17.652"> </span>
<a href="#l17.653"></a><span id="l17.653" class="difflineminus">-  result = result &amp;&amp; m_out.WriteStr( kLDIFPerson);</span>
<a href="#l17.654"></a><span id="l17.654" class="difflineplus">+  result = result &amp;&amp; m_out.WriteStr(kLDIFPerson);</span>
<a href="#l17.655"></a><span id="l17.655"> </span>
<a href="#l17.656"></a><span id="l17.656" class="difflineminus">-  line.LoadString( IDS_FIELD_LDIF_EMAIL);</span>
<a href="#l17.657"></a><span id="l17.657" class="difflineplus">+  line.LoadString(IDS_FIELD_LDIF_EMAIL);</span>
<a href="#l17.658"></a><span id="l17.658">   line += ' ';</span>
<a href="#l17.659"></a><span id="l17.659">   line += eMail;</span>
<a href="#l17.660"></a><span id="l17.660" class="difflineminus">-  result = result &amp;&amp; m_out.WriteStr( line);</span>
<a href="#l17.661"></a><span id="l17.661" class="difflineplus">+  result = result &amp;&amp; m_out.WriteStr(line);</span>
<a href="#l17.662"></a><span id="l17.662">   result = result &amp;&amp; m_out.WriteEol();</span>
<a href="#l17.663"></a><span id="l17.663"> </span>
<a href="#l17.664"></a><span id="l17.664" class="difflineminus">-  line.LoadString( IDS_FIELD_LDIF_NICKNAME);</span>
<a href="#l17.665"></a><span id="l17.665" class="difflineplus">+  line.LoadString(IDS_FIELD_LDIF_NICKNAME);</span>
<a href="#l17.666"></a><span id="l17.666">   line += ' ';</span>
<a href="#l17.667"></a><span id="l17.667">   line += nickName;</span>
<a href="#l17.668"></a><span id="l17.668" class="difflineminus">-  result = result &amp;&amp; m_out.WriteStr( line);</span>
<a href="#l17.669"></a><span id="l17.669" class="difflineplus">+  result = result &amp;&amp; m_out.WriteStr(line);</span>
<a href="#l17.670"></a><span id="l17.670">   result = result &amp;&amp; m_out.WriteEol();</span>
<a href="#l17.671"></a><span id="l17.671"> </span>
<a href="#l17.672"></a><span id="l17.672">   // Do all of the extra fields!</span>
<a href="#l17.673"></a><span id="l17.673">   CString  value;</span>
<a href="#l17.674"></a><span id="l17.674">   BOOL  encoded = FALSE;</span>
<a href="#l17.675"></a><span id="l17.675">   for (int i = 0; i &lt; kExtraUserFields; i++) {</span>
<a href="#l17.676"></a><span id="l17.676">     value.Empty();</span>
<a href="#l17.677"></a><span id="l17.677" class="difflineminus">-    pProp = m_pWab-&gt;GetUserProperty( pUser, extraUserFields[i].tag);</span>
<a href="#l17.678"></a><span id="l17.678" class="difflineplus">+    pProp = m_pWab-&gt;GetUserProperty(pUser, extraUserFields[i].tag);</span>
<a href="#l17.679"></a><span id="l17.679">     if (pProp) {</span>
<a href="#l17.680"></a><span id="l17.680" class="difflineminus">-      m_pWab-&gt;GetValueString( pProp, value);</span>
<a href="#l17.681"></a><span id="l17.681" class="difflineminus">-      m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l17.682"></a><span id="l17.682" class="difflineplus">+      m_pWab-&gt;GetValueString(pProp, value);</span>
<a href="#l17.683"></a><span id="l17.683" class="difflineplus">+      m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l17.684"></a><span id="l17.684">     }</span>
<a href="#l17.685"></a><span id="l17.685">     if (extraUserFields[i].multiLine) {</span>
<a href="#l17.686"></a><span id="l17.686" class="difflineminus">-      encoded = SanitizeMultiLine( value);</span>
<a href="#l17.687"></a><span id="l17.687" class="difflineplus">+      encoded = SanitizeMultiLine(value);</span>
<a href="#l17.688"></a><span id="l17.688">     }</span>
<a href="#l17.689"></a><span id="l17.689">     else</span>
<a href="#l17.690"></a><span id="l17.690" class="difflineminus">-      SanitizeValue( value);</span>
<a href="#l17.691"></a><span id="l17.691" class="difflineplus">+      SanitizeValue(value);</span>
<a href="#l17.692"></a><span id="l17.692">     if (!value.IsEmpty()) {</span>
<a href="#l17.693"></a><span id="l17.693">       line = extraUserFields[i].pLDIF;</span>
<a href="#l17.694"></a><span id="l17.694">       if (encoded) {</span>
<a href="#l17.695"></a><span id="l17.695">         line += &quot;: &quot;;</span>
<a href="#l17.696"></a><span id="l17.696">         encoded = FALSE;</span>
<a href="#l17.697"></a><span id="l17.697">       }</span>
<a href="#l17.698"></a><span id="l17.698">       else</span>
<a href="#l17.699"></a><span id="l17.699">         line += ' ';</span>
<a href="#l17.700"></a><span id="l17.700">       line += value;</span>
<a href="#l17.701"></a><span id="l17.701" class="difflineminus">-      result = result &amp;&amp; m_out.WriteStr( line);</span>
<a href="#l17.702"></a><span id="l17.702" class="difflineplus">+      result = result &amp;&amp; m_out.WriteStr(line);</span>
<a href="#l17.703"></a><span id="l17.703">       result = result &amp;&amp; m_out.WriteEol();</span>
<a href="#l17.704"></a><span id="l17.704">     }</span>
<a href="#l17.705"></a><span id="l17.705">   }</span>
<a href="#l17.706"></a><span id="l17.706"> </span>
<a href="#l17.707"></a><span id="l17.707" class="difflineminus">-  m_pWab-&gt;ReleaseUser( pUser);</span>
<a href="#l17.708"></a><span id="l17.708" class="difflineplus">+  m_pWab-&gt;ReleaseUser(pUser);</span>
<a href="#l17.709"></a><span id="l17.709"> </span>
<a href="#l17.710"></a><span id="l17.710">   if (!result) {</span>
<a href="#l17.711"></a><span id="l17.711" class="difflineminus">-    UDialogs::ErrMessage0( IDS_ADDRESS_SAVE_ERROR);</span>
<a href="#l17.712"></a><span id="l17.712" class="difflineplus">+    UDialogs::ErrMessage0(IDS_ADDRESS_SAVE_ERROR);</span>
<a href="#l17.713"></a><span id="l17.713">   }</span>
<a href="#l17.714"></a><span id="l17.714"> </span>
<a href="#l17.715"></a><span id="l17.715">   m_totalDone += kValuePerUser;</span>
<a href="#l17.716"></a><span id="l17.716">   m_recordsDone++;</span>
<a href="#l17.717"></a><span id="l17.717"> </span>
<a href="#l17.718"></a><span id="l17.718" class="difflineminus">-  return( result);</span>
<a href="#l17.719"></a><span id="l17.719" class="difflineplus">+  return result;</span>
<a href="#l17.720"></a><span id="l17.720"> }</span>
<a href="#l17.721"></a><span id="l17.721"> */</span>
<a href="#l17.722"></a><span id="l17.722"> </span>
<a href="#l17.723"></a><span id="l17.723"> </span>
<a href="#l17.724"></a><span id="l17.724"> </span>
<a href="#l17.725"></a><span id="l17.725"> </span>
<a href="#l17.726"></a><span id="l17.726"> /*</span>
<a href="#l17.727"></a><span id="l17.727" class="difflineminus">-BOOL CWabIterateProcess::EnumList( LPCTSTR pName, LPENTRYID pEid, ULONG cbEid)</span>
<a href="#l17.728"></a><span id="l17.728" class="difflineplus">+BOOL CWabIterateProcess::EnumList(LPCTSTR pName, LPENTRYID pEid, ULONG cbEid)</span>
<a href="#l17.729"></a><span id="l17.729"> {</span>
<a href="#l17.730"></a><span id="l17.730" class="difflineminus">-  TRACE1( &quot;List: %s\n&quot;, pName);</span>
<a href="#l17.731"></a><span id="l17.731" class="difflineplus">+  TRACE1(&quot;List: %s\n&quot;, pName);</span>
<a href="#l17.732"></a><span id="l17.732"> </span>
<a href="#l17.733"></a><span id="l17.733" class="difflineminus">-  LPDISTLIST    pList = m_pWab-&gt;GetDistList( cbEid, pEid);</span>
<a href="#l17.734"></a><span id="l17.734" class="difflineplus">+  LPDISTLIST    pList = m_pWab-&gt;GetDistList(cbEid, pEid);</span>
<a href="#l17.735"></a><span id="l17.735">   if (!pList) {</span>
<a href="#l17.736"></a><span id="l17.736" class="difflineminus">-    UDialogs::ErrMessage1( IDS_ENTRY_ERROR, pName);</span>
<a href="#l17.737"></a><span id="l17.737" class="difflineminus">-    return( FALSE);</span>
<a href="#l17.738"></a><span id="l17.738" class="difflineplus">+    UDialogs::ErrMessage1(IDS_ENTRY_ERROR, pName);</span>
<a href="#l17.739"></a><span id="l17.739" class="difflineplus">+    return FALSE;</span>
<a href="#l17.740"></a><span id="l17.740">   }</span>
<a href="#l17.741"></a><span id="l17.741"> </span>
<a href="#l17.742"></a><span id="l17.742">   // Find out if this is just a regular entry or a true list...</span>
<a href="#l17.743"></a><span id="l17.743">   CString      eMail;</span>
<a href="#l17.744"></a><span id="l17.744" class="difflineminus">-  LPSPropValue  pProp = m_pWab-&gt;GetListProperty( pList, PR_EMAIL_ADDRESS);</span>
<a href="#l17.745"></a><span id="l17.745" class="difflineplus">+  LPSPropValue  pProp = m_pWab-&gt;GetListProperty(pList, PR_EMAIL_ADDRESS);</span>
<a href="#l17.746"></a><span id="l17.746">   if (pProp) {</span>
<a href="#l17.747"></a><span id="l17.747" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, eMail);</span>
<a href="#l17.748"></a><span id="l17.748" class="difflineminus">-    SanitizeValue( eMail);</span>
<a href="#l17.749"></a><span id="l17.749" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l17.750"></a><span id="l17.750" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, eMail);</span>
<a href="#l17.751"></a><span id="l17.751" class="difflineplus">+    SanitizeValue(eMail);</span>
<a href="#l17.752"></a><span id="l17.752" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l17.753"></a><span id="l17.753">     // Treat this like a regular entry...</span>
<a href="#l17.754"></a><span id="l17.754">     if (!eMail.IsEmpty()) {</span>
<a href="#l17.755"></a><span id="l17.755" class="difflineminus">-      m_pWab-&gt;ReleaseDistList( pList);</span>
<a href="#l17.756"></a><span id="l17.756" class="difflineminus">-      return( WriteListUserEntry( pName, eMail));</span>
<a href="#l17.757"></a><span id="l17.757" class="difflineplus">+      m_pWab-&gt;ReleaseDistList(pList);</span>
<a href="#l17.758"></a><span id="l17.758" class="difflineplus">+      return WriteListUserEntry(pName, eMail);</span>
<a href="#l17.759"></a><span id="l17.759">     }</span>
<a href="#l17.760"></a><span id="l17.760">   }</span>
<a href="#l17.761"></a><span id="l17.761"> </span>
<a href="#l17.762"></a><span id="l17.762">   // This may very well be a list, find the entries...</span>
<a href="#l17.763"></a><span id="l17.763" class="difflineminus">-  m_pListTable = OpenDistList( pList);</span>
<a href="#l17.764"></a><span id="l17.764" class="difflineplus">+  m_pListTable = OpenDistList(pList);</span>
<a href="#l17.765"></a><span id="l17.765">   if (m_pListTable) {</span>
<a href="#l17.766"></a><span id="l17.766">     m_pList = pList;</span>
<a href="#l17.767"></a><span id="l17.767">     m_listName = pName;</span>
<a href="#l17.768"></a><span id="l17.768">     m_listDone = 0;</span>
<a href="#l17.769"></a><span id="l17.769">     m_listHeaderDone = FALSE;</span>
<a href="#l17.770"></a><span id="l17.770">     m_state = kEnumListState;</span>
<a href="#l17.771"></a><span id="l17.771">   }</span>
<a href="#l17.772"></a><span id="l17.772">   else {</span>
<a href="#l17.773"></a><span id="l17.773" class="difflineminus">-    m_pWab-&gt;ReleaseDistList( pList);</span>
<a href="#l17.774"></a><span id="l17.774" class="difflineplus">+    m_pWab-&gt;ReleaseDistList(pList);</span>
<a href="#l17.775"></a><span id="l17.775">     m_recordsDone++;</span>
<a href="#l17.776"></a><span id="l17.776">     m_totalDone += kValuePerUser;</span>
<a href="#l17.777"></a><span id="l17.777">   }</span>
<a href="#l17.778"></a><span id="l17.778"> </span>
<a href="#l17.779"></a><span id="l17.779" class="difflineminus">-  return( TRUE);</span>
<a href="#l17.780"></a><span id="l17.780" class="difflineplus">+  return TRUE;</span>
<a href="#l17.781"></a><span id="l17.781"> }</span>
<a href="#l17.782"></a><span id="l17.782"> </span>
<a href="#l17.783"></a><span id="l17.783" class="difflineminus">-BOOL CWabIterateProcess::EnumNextListUser( BOOL *pDone)</span>
<a href="#l17.784"></a><span id="l17.784" class="difflineplus">+BOOL CWabIterateProcess::EnumNextListUser(BOOL *pDone)</span>
<a href="#l17.785"></a><span id="l17.785"> {</span>
<a href="#l17.786"></a><span id="l17.786">   HRESULT      hr;</span>
<a href="#l17.787"></a><span id="l17.787">   int        cNumRows = 0;</span>
<a href="#l17.788"></a><span id="l17.788">   LPSRowSet    lpRowAB = NULL;</span>
<a href="#l17.789"></a><span id="l17.789">   BOOL      keepGoing = TRUE;</span>
<a href="#l17.790"></a><span id="l17.790"> </span>
<a href="#l17.791"></a><span id="l17.791">   if (!m_pListTable)</span>
<a href="#l17.792"></a><span id="l17.792" class="difflineminus">-    return( FALSE);</span>
<a href="#l17.793"></a><span id="l17.793" class="difflineplus">+    return FALSE;</span>
<a href="#l17.794"></a><span id="l17.794"> </span>
<a href="#l17.795"></a><span id="l17.795" class="difflineminus">-  hr = m_pListTable-&gt;QueryRows( 1, 0, &amp;lpRowAB);</span>
<a href="#l17.796"></a><span id="l17.796" class="difflineplus">+  hr = m_pListTable-&gt;QueryRows(1, 0, &amp;lpRowAB);</span>
<a href="#l17.797"></a><span id="l17.797"> </span>
<a href="#l17.798"></a><span id="l17.798">   if(HR_FAILED(hr)) {</span>
<a href="#l17.799"></a><span id="l17.799" class="difflineminus">-    UDialogs::ErrMessage0( IDS_ERROR_READING_WAB);</span>
<a href="#l17.800"></a><span id="l17.800" class="difflineminus">-    return( FALSE);</span>
<a href="#l17.801"></a><span id="l17.801" class="difflineplus">+    UDialogs::ErrMessage0(IDS_ERROR_READING_WAB);</span>
<a href="#l17.802"></a><span id="l17.802" class="difflineplus">+    return FALSE;</span>
<a href="#l17.803"></a><span id="l17.803">   }</span>
<a href="#l17.804"></a><span id="l17.804"> </span>
<a href="#l17.805"></a><span id="l17.805">   if(lpRowAB) {</span>
<a href="#l17.806"></a><span id="l17.806">     cNumRows = lpRowAB-&gt;cRows;</span>
<a href="#l17.807"></a><span id="l17.807"> </span>
<a href="#l17.808"></a><span id="l17.808">     if (cNumRows) {</span>
<a href="#l17.809"></a><span id="l17.809">       LPTSTR lpsz = lpRowAB-&gt;aRow[0].lpProps[ieidPR_DISPLAY_NAME].Value.lpszA;</span>
<a href="#l17.810"></a><span id="l17.810">       LPENTRYID lpEID = (LPENTRYID) lpRowAB-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l17.811"></a><span id="l17.811">       ULONG cbEID = lpRowAB-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l17.812"></a><span id="l17.812">             if(lpRowAB-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.l == MAPI_DISTLIST) {</span>
<a href="#l17.813"></a><span id="l17.813" class="difflineminus">-        keepGoing = HandleListList( lpsz, lpEID, cbEID);</span>
<a href="#l17.814"></a><span id="l17.814" class="difflineplus">+        keepGoing = HandleListList(lpsz, lpEID, cbEID);</span>
<a href="#l17.815"></a><span id="l17.815">         }</span>
<a href="#l17.816"></a><span id="l17.816">       else if (lpRowAB-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.l == MAPI_MAILUSER) {</span>
<a href="#l17.817"></a><span id="l17.817" class="difflineminus">-        keepGoing = HandleListUser( lpsz, lpEID, cbEID);</span>
<a href="#l17.818"></a><span id="l17.818" class="difflineplus">+        keepGoing = HandleListUser(lpsz, lpEID, cbEID);</span>
<a href="#l17.819"></a><span id="l17.819">       }</span>
<a href="#l17.820"></a><span id="l17.820">     }</span>
<a href="#l17.821"></a><span id="l17.821" class="difflineminus">-    m_pWab-&gt;FreeProws( lpRowAB);</span>
<a href="#l17.822"></a><span id="l17.822" class="difflineplus">+    m_pWab-&gt;FreeProws(lpRowAB);</span>
<a href="#l17.823"></a><span id="l17.823">    }</span>
<a href="#l17.824"></a><span id="l17.824"> </span>
<a href="#l17.825"></a><span id="l17.825">   if (!cNumRows || !lpRowAB) {</span>
<a href="#l17.826"></a><span id="l17.826">     *pDone = TRUE;</span>
<a href="#l17.827"></a><span id="l17.827">     m_pListTable-&gt;Release();</span>
<a href="#l17.828"></a><span id="l17.828">     m_pListTable = NULL;</span>
<a href="#l17.829"></a><span id="l17.829">     if (m_pList)</span>
<a href="#l17.830"></a><span id="l17.830" class="difflineminus">-      m_pWab-&gt;ReleaseDistList( m_pList);</span>
<a href="#l17.831"></a><span id="l17.831" class="difflineplus">+      m_pWab-&gt;ReleaseDistList(m_pList);</span>
<a href="#l17.832"></a><span id="l17.832">     m_pList = NULL;</span>
<a href="#l17.833"></a><span id="l17.833">     if (m_listDone &lt; kValuePerUser)</span>
<a href="#l17.834"></a><span id="l17.834">       m_totalDone += (kValuePerUser - m_listDone);</span>
<a href="#l17.835"></a><span id="l17.835">     m_recordsDone++;</span>
<a href="#l17.836"></a><span id="l17.836" class="difflineminus">-    return( keepGoing);</span>
<a href="#l17.837"></a><span id="l17.837" class="difflineplus">+    return keepGoing;</span>
<a href="#l17.838"></a><span id="l17.838">   }</span>
<a href="#l17.839"></a><span id="l17.839"> </span>
<a href="#l17.840"></a><span id="l17.840">   if (!keepGoing)</span>
<a href="#l17.841"></a><span id="l17.841" class="difflineminus">-    return( FALSE);</span>
<a href="#l17.842"></a><span id="l17.842" class="difflineplus">+    return FALSE;</span>
<a href="#l17.843"></a><span id="l17.843"> </span>
<a href="#l17.844"></a><span id="l17.844">   if (m_listDone &lt; kValuePerUser) {</span>
<a href="#l17.845"></a><span id="l17.845">     m_listDone++;</span>
<a href="#l17.846"></a><span id="l17.846">     m_totalDone++;</span>
<a href="#l17.847"></a><span id="l17.847">   }</span>
<a href="#l17.848"></a><span id="l17.848"> </span>
<a href="#l17.849"></a><span id="l17.849" class="difflineminus">-  return( TRUE);</span>
<a href="#l17.850"></a><span id="l17.850" class="difflineplus">+  return TRUE;</span>
<a href="#l17.851"></a><span id="l17.851"> }</span>
<a href="#l17.852"></a><span id="l17.852"> </span>
<a href="#l17.853"></a><span id="l17.853" class="difflineminus">-BOOL CWabIterateProcess::HandleListList( LPCTSTR pName, LPENTRYID lpEid, ULONG cbEid)</span>
<a href="#l17.854"></a><span id="l17.854" class="difflineplus">+BOOL CWabIterateProcess::HandleListList(LPCTSTR pName, LPENTRYID lpEid, ULONG cbEid)</span>
<a href="#l17.855"></a><span id="l17.855"> {</span>
<a href="#l17.856"></a><span id="l17.856">   BOOL      result;</span>
<a href="#l17.857"></a><span id="l17.857" class="difflineminus">-  LPDISTLIST    pList = m_pWab-&gt;GetDistList( cbEid, lpEid);</span>
<a href="#l17.858"></a><span id="l17.858" class="difflineplus">+  LPDISTLIST    pList = m_pWab-&gt;GetDistList(cbEid, lpEid);</span>
<a href="#l17.859"></a><span id="l17.859">   if (!pList) {</span>
<a href="#l17.860"></a><span id="l17.860" class="difflineminus">-    UDialogs::ErrMessage1( IDS_ENTRY_ERROR, pName);</span>
<a href="#l17.861"></a><span id="l17.861" class="difflineminus">-    return( FALSE);</span>
<a href="#l17.862"></a><span id="l17.862" class="difflineplus">+    UDialogs::ErrMessage1(IDS_ENTRY_ERROR, pName);</span>
<a href="#l17.863"></a><span id="l17.863" class="difflineplus">+    return FALSE;</span>
<a href="#l17.864"></a><span id="l17.864">   }</span>
<a href="#l17.865"></a><span id="l17.865"> </span>
<a href="#l17.866"></a><span id="l17.866">   CString      eMail;</span>
<a href="#l17.867"></a><span id="l17.867" class="difflineminus">-  LPSPropValue  pProp = m_pWab-&gt;GetListProperty( pList, PR_EMAIL_ADDRESS);</span>
<a href="#l17.868"></a><span id="l17.868" class="difflineplus">+  LPSPropValue  pProp = m_pWab-&gt;GetListProperty(pList, PR_EMAIL_ADDRESS);</span>
<a href="#l17.869"></a><span id="l17.869">   if (pProp) {</span>
<a href="#l17.870"></a><span id="l17.870" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, eMail);</span>
<a href="#l17.871"></a><span id="l17.871" class="difflineminus">-    SanitizeValue( eMail);</span>
<a href="#l17.872"></a><span id="l17.872" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l17.873"></a><span id="l17.873" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, eMail);</span>
<a href="#l17.874"></a><span id="l17.874" class="difflineplus">+    SanitizeValue(eMail);</span>
<a href="#l17.875"></a><span id="l17.875" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l17.876"></a><span id="l17.876">     // Treat this like a regular entry...</span>
<a href="#l17.877"></a><span id="l17.877">     if (!eMail.IsEmpty()) {</span>
<a href="#l17.878"></a><span id="l17.878">       // write out a member based on pName and eMail</span>
<a href="#l17.879"></a><span id="l17.879" class="difflineminus">-      result = WriteGroupMember( pName, eMail);</span>
<a href="#l17.880"></a><span id="l17.880" class="difflineminus">-      m_pWab-&gt;ReleaseDistList( pList);</span>
<a href="#l17.881"></a><span id="l17.881" class="difflineminus">-      return( result);</span>
<a href="#l17.882"></a><span id="l17.882" class="difflineplus">+      result = WriteGroupMember(pName, eMail);</span>
<a href="#l17.883"></a><span id="l17.883" class="difflineplus">+      m_pWab-&gt;ReleaseDistList(pList);</span>
<a href="#l17.884"></a><span id="l17.884" class="difflineplus">+      return result;</span>
<a href="#l17.885"></a><span id="l17.885">     }</span>
<a href="#l17.886"></a><span id="l17.886">   }</span>
<a href="#l17.887"></a><span id="l17.887"> </span>
<a href="#l17.888"></a><span id="l17.888">   // iterate the list and add each member to the top level list</span>
<a href="#l17.889"></a><span id="l17.889" class="difflineminus">-  LPMAPITABLE  pTable = OpenDistList( pList);</span>
<a href="#l17.890"></a><span id="l17.890" class="difflineplus">+  LPMAPITABLE  pTable = OpenDistList(pList);</span>
<a href="#l17.891"></a><span id="l17.891">   if (!pTable) {</span>
<a href="#l17.892"></a><span id="l17.892" class="difflineminus">-    TRACE0( &quot;Error opening table for list\n&quot;);</span>
<a href="#l17.893"></a><span id="l17.893" class="difflineminus">-    m_pWab-&gt;ReleaseDistList( pList);</span>
<a href="#l17.894"></a><span id="l17.894" class="difflineminus">-    UDialogs::ErrMessage1( IDS_ENTRY_ERROR, pName);</span>
<a href="#l17.895"></a><span id="l17.895" class="difflineminus">-    return( FALSE);</span>
<a href="#l17.896"></a><span id="l17.896" class="difflineplus">+    TRACE0(&quot;Error opening table for list\n&quot;);</span>
<a href="#l17.897"></a><span id="l17.897" class="difflineplus">+    m_pWab-&gt;ReleaseDistList(pList);</span>
<a href="#l17.898"></a><span id="l17.898" class="difflineplus">+    UDialogs::ErrMessage1(IDS_ENTRY_ERROR, pName);</span>
<a href="#l17.899"></a><span id="l17.899" class="difflineplus">+    return FALSE;</span>
<a href="#l17.900"></a><span id="l17.900">   }</span>
<a href="#l17.901"></a><span id="l17.901"> </span>
<a href="#l17.902"></a><span id="l17.902">   int        cNumRows = 0;</span>
<a href="#l17.903"></a><span id="l17.903">   LPSRowSet    lpRowAB = NULL;</span>
<a href="#l17.904"></a><span id="l17.904">   HRESULT      hr;</span>
<a href="#l17.905"></a><span id="l17.905">   BOOL      keepGoing = TRUE;</span>
<a href="#l17.906"></a><span id="l17.906"> </span>
<a href="#l17.907"></a><span id="l17.907">   do {</span>
<a href="#l17.908"></a><span id="l17.908" class="difflineminus">-    hr = pTable-&gt;QueryRows( 1, 0, &amp;lpRowAB);</span>
<a href="#l17.909"></a><span id="l17.909" class="difflineplus">+    hr = pTable-&gt;QueryRows(1, 0, &amp;lpRowAB);</span>
<a href="#l17.910"></a><span id="l17.910"> </span>
<a href="#l17.911"></a><span id="l17.911">     if(HR_FAILED(hr)) {</span>
<a href="#l17.912"></a><span id="l17.912" class="difflineminus">-      UDialogs::ErrMessage0( IDS_ERROR_READING_WAB);</span>
<a href="#l17.913"></a><span id="l17.913" class="difflineplus">+      UDialogs::ErrMessage0(IDS_ERROR_READING_WAB);</span>
<a href="#l17.914"></a><span id="l17.914">       pTable-&gt;Release();</span>
<a href="#l17.915"></a><span id="l17.915" class="difflineminus">-      m_pWab-&gt;ReleaseDistList( pList);</span>
<a href="#l17.916"></a><span id="l17.916" class="difflineminus">-      return( FALSE);</span>
<a href="#l17.917"></a><span id="l17.917" class="difflineplus">+      m_pWab-&gt;ReleaseDistList(pList);</span>
<a href="#l17.918"></a><span id="l17.918" class="difflineplus">+      return FALSE;</span>
<a href="#l17.919"></a><span id="l17.919">     }</span>
<a href="#l17.920"></a><span id="l17.920"> </span>
<a href="#l17.921"></a><span id="l17.921">     if(lpRowAB) {</span>
<a href="#l17.922"></a><span id="l17.922">       cNumRows = lpRowAB-&gt;cRows;</span>
<a href="#l17.923"></a><span id="l17.923"> </span>
<a href="#l17.924"></a><span id="l17.924">       if (cNumRows) {</span>
<a href="#l17.925"></a><span id="l17.925">         LPTSTR lpsz = lpRowAB-&gt;aRow[0].lpProps[ieidPR_DISPLAY_NAME].Value.lpszA;</span>
<a href="#l17.926"></a><span id="l17.926">         LPENTRYID lpEID = (LPENTRYID) lpRowAB-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l17.927"></a><span id="l17.927">         ULONG cbEID = lpRowAB-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l17.928"></a><span id="l17.928">         if(lpRowAB-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.l == MAPI_DISTLIST) {</span>
<a href="#l17.929"></a><span id="l17.929" class="difflineminus">-          keepGoing = HandleListList( lpsz, lpEID, cbEID);</span>
<a href="#l17.930"></a><span id="l17.930" class="difflineplus">+          keepGoing = HandleListList(lpsz, lpEID, cbEID);</span>
<a href="#l17.931"></a><span id="l17.931">         }</span>
<a href="#l17.932"></a><span id="l17.932">         else if (lpRowAB-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.l == MAPI_MAILUSER) {</span>
<a href="#l17.933"></a><span id="l17.933" class="difflineminus">-          keepGoing = HandleListUser( lpsz, lpEID, cbEID);</span>
<a href="#l17.934"></a><span id="l17.934" class="difflineplus">+          keepGoing = HandleListUser(lpsz, lpEID, cbEID);</span>
<a href="#l17.935"></a><span id="l17.935">         }</span>
<a href="#l17.936"></a><span id="l17.936">       }</span>
<a href="#l17.937"></a><span id="l17.937" class="difflineminus">-      m_pWab-&gt;FreeProws( lpRowAB);</span>
<a href="#l17.938"></a><span id="l17.938" class="difflineplus">+      m_pWab-&gt;FreeProws(lpRowAB);</span>
<a href="#l17.939"></a><span id="l17.939">      }</span>
<a href="#l17.940"></a><span id="l17.940">   }</span>
<a href="#l17.941"></a><span id="l17.941">   while (keepGoing &amp;&amp; cNumRows &amp;&amp; lpRowAB);</span>
<a href="#l17.942"></a><span id="l17.942"> </span>
<a href="#l17.943"></a><span id="l17.943">   pTable-&gt;Release();</span>
<a href="#l17.944"></a><span id="l17.944" class="difflineminus">-  m_pWab-&gt;ReleaseDistList( pList);</span>
<a href="#l17.945"></a><span id="l17.945" class="difflineminus">-  return( keepGoing);</span>
<a href="#l17.946"></a><span id="l17.946" class="difflineplus">+  m_pWab-&gt;ReleaseDistList(pList);</span>
<a href="#l17.947"></a><span id="l17.947" class="difflineplus">+  return keepGoing;</span>
<a href="#l17.948"></a><span id="l17.948"> }</span>
<a href="#l17.949"></a><span id="l17.949"> </span>
<a href="#l17.950"></a><span id="l17.950" class="difflineminus">-BOOL CWabIterateProcess::HandleListUser( LPCTSTR pName, LPENTRYID lpEid, ULONG cbEid)</span>
<a href="#l17.951"></a><span id="l17.951" class="difflineplus">+BOOL CWabIterateProcess::HandleListUser(LPCTSTR pName, LPENTRYID lpEid, ULONG cbEid)</span>
<a href="#l17.952"></a><span id="l17.952"> {</span>
<a href="#l17.953"></a><span id="l17.953">   // Get the basic properties for building the member line</span>
<a href="#l17.954"></a><span id="l17.954" class="difflineminus">-  LPMAILUSER  pUser = m_pWab-&gt;GetUser( cbEid, lpEid);</span>
<a href="#l17.955"></a><span id="l17.955" class="difflineplus">+  LPMAILUSER  pUser = m_pWab-&gt;GetUser(cbEid, lpEid);</span>
<a href="#l17.956"></a><span id="l17.956"> </span>
<a href="#l17.957"></a><span id="l17.957">   // Get the &quot;required&quot; strings first</span>
<a href="#l17.958"></a><span id="l17.958">   CString    lastName;</span>
<a href="#l17.959"></a><span id="l17.959">   CString    firstName;</span>
<a href="#l17.960"></a><span id="l17.960">   CString    eMail;</span>
<a href="#l17.961"></a><span id="l17.961">   CString    nickName;</span>
<a href="#l17.962"></a><span id="l17.962">   CString    middleName;</span>
<a href="#l17.963"></a><span id="l17.963"> </span>
<a href="#l17.964"></a><span id="l17.964">   if (!pUser) {</span>
<a href="#l17.965"></a><span id="l17.965" class="difflineminus">-    UDialogs::ErrMessage1( IDS_ENTRY_ERROR, pName);</span>
<a href="#l17.966"></a><span id="l17.966" class="difflineminus">-    return( FALSE);</span>
<a href="#l17.967"></a><span id="l17.967" class="difflineplus">+    UDialogs::ErrMessage1(IDS_ENTRY_ERROR, pName);</span>
<a href="#l17.968"></a><span id="l17.968" class="difflineplus">+    return FALSE;</span>
<a href="#l17.969"></a><span id="l17.969">   }</span>
<a href="#l17.970"></a><span id="l17.970"> </span>
<a href="#l17.971"></a><span id="l17.971" class="difflineminus">-  LPSPropValue  pProp = m_pWab-&gt;GetUserProperty( pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l17.972"></a><span id="l17.972" class="difflineplus">+  LPSPropValue  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l17.973"></a><span id="l17.973">   if (pProp) {</span>
<a href="#l17.974"></a><span id="l17.974" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, eMail);</span>
<a href="#l17.975"></a><span id="l17.975" class="difflineminus">-    SanitizeValue( eMail);</span>
<a href="#l17.976"></a><span id="l17.976" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l17.977"></a><span id="l17.977" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, eMail);</span>
<a href="#l17.978"></a><span id="l17.978" class="difflineplus">+    SanitizeValue(eMail);</span>
<a href="#l17.979"></a><span id="l17.979" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l17.980"></a><span id="l17.980">   }</span>
<a href="#l17.981"></a><span id="l17.981" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty( pUser, PR_GIVEN_NAME);</span>
<a href="#l17.982"></a><span id="l17.982" class="difflineplus">+  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_GIVEN_NAME);</span>
<a href="#l17.983"></a><span id="l17.983">   if (pProp) {</span>
<a href="#l17.984"></a><span id="l17.984" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, firstName);</span>
<a href="#l17.985"></a><span id="l17.985" class="difflineminus">-    SanitizeValue( firstName);</span>
<a href="#l17.986"></a><span id="l17.986" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l17.987"></a><span id="l17.987" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, firstName);</span>
<a href="#l17.988"></a><span id="l17.988" class="difflineplus">+    SanitizeValue(firstName);</span>
<a href="#l17.989"></a><span id="l17.989" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l17.990"></a><span id="l17.990">   }</span>
<a href="#l17.991"></a><span id="l17.991" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty( pUser, PR_SURNAME);</span>
<a href="#l17.992"></a><span id="l17.992" class="difflineplus">+  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_SURNAME);</span>
<a href="#l17.993"></a><span id="l17.993">   if (pProp) {</span>
<a href="#l17.994"></a><span id="l17.994" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, lastName);</span>
<a href="#l17.995"></a><span id="l17.995" class="difflineminus">-    SanitizeValue( lastName);</span>
<a href="#l17.996"></a><span id="l17.996" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l17.997"></a><span id="l17.997" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, lastName);</span>
<a href="#l17.998"></a><span id="l17.998" class="difflineplus">+    SanitizeValue(lastName);</span>
<a href="#l17.999"></a><span id="l17.999" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l17.1000"></a><span id="l17.1000">   }</span>
<a href="#l17.1001"></a><span id="l17.1001" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty( pUser, PR_MIDDLE_NAME);</span>
<a href="#l17.1002"></a><span id="l17.1002" class="difflineplus">+  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_MIDDLE_NAME);</span>
<a href="#l17.1003"></a><span id="l17.1003">   if (pProp) {</span>
<a href="#l17.1004"></a><span id="l17.1004" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, middleName);</span>
<a href="#l17.1005"></a><span id="l17.1005" class="difflineminus">-    SanitizeValue( middleName);</span>
<a href="#l17.1006"></a><span id="l17.1006" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l17.1007"></a><span id="l17.1007" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, middleName);</span>
<a href="#l17.1008"></a><span id="l17.1008" class="difflineplus">+    SanitizeValue(middleName);</span>
<a href="#l17.1009"></a><span id="l17.1009" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l17.1010"></a><span id="l17.1010">   }</span>
<a href="#l17.1011"></a><span id="l17.1011" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty( pUser, PR_NICKNAME);</span>
<a href="#l17.1012"></a><span id="l17.1012" class="difflineplus">+  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_NICKNAME);</span>
<a href="#l17.1013"></a><span id="l17.1013">   if (pProp) {</span>
<a href="#l17.1014"></a><span id="l17.1014" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, nickName);</span>
<a href="#l17.1015"></a><span id="l17.1015" class="difflineminus">-    SanitizeValue( nickName);</span>
<a href="#l17.1016"></a><span id="l17.1016" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l17.1017"></a><span id="l17.1017" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, nickName);</span>
<a href="#l17.1018"></a><span id="l17.1018" class="difflineplus">+    SanitizeValue(nickName);</span>
<a href="#l17.1019"></a><span id="l17.1019" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l17.1020"></a><span id="l17.1020">   }</span>
<a href="#l17.1021"></a><span id="l17.1021">   if (nickName.IsEmpty())</span>
<a href="#l17.1022"></a><span id="l17.1022">     nickName = pName;</span>
<a href="#l17.1023"></a><span id="l17.1023">   if (firstName.IsEmpty()) {</span>
<a href="#l17.1024"></a><span id="l17.1024">     firstName = nickName;</span>
<a href="#l17.1025"></a><span id="l17.1025">     middleName.Empty();</span>
<a href="#l17.1026"></a><span id="l17.1026">     lastName.Empty();</span>
<a href="#l17.1027"></a><span id="l17.1027">   }</span>
<a href="#l17.1028"></a><span id="l17.1028">   if (lastName.IsEmpty())</span>
<a href="#l17.1029"></a><span id="l17.1029">     middleName.Empty();</span>
<a href="#l17.1030"></a><span id="l17.1030"> </span>
<a href="#l17.1031"></a><span id="l17.1031">   if (eMail.IsEmpty())</span>
<a href="#l17.1032"></a><span id="l17.1032">     eMail = nickName;</span>
<a href="#l17.1033"></a><span id="l17.1033"> </span>
<a href="#l17.1034"></a><span id="l17.1034" class="difflineminus">-  m_pWab-&gt;ReleaseUser( pUser);</span>
<a href="#l17.1035"></a><span id="l17.1035" class="difflineplus">+  m_pWab-&gt;ReleaseUser(pUser);</span>
<a href="#l17.1036"></a><span id="l17.1036"> </span>
<a href="#l17.1037"></a><span id="l17.1037">   CString  name = firstName;</span>
<a href="#l17.1038"></a><span id="l17.1038">   if (!middleName.IsEmpty()) {</span>
<a href="#l17.1039"></a><span id="l17.1039">     name += ' ';</span>
<a href="#l17.1040"></a><span id="l17.1040">     name += middleName;</span>
<a href="#l17.1041"></a><span id="l17.1041">   }</span>
<a href="#l17.1042"></a><span id="l17.1042">   if (!lastName.IsEmpty()) {</span>
<a href="#l17.1043"></a><span id="l17.1043">     name += ' ';</span>
<a href="#l17.1044"></a><span id="l17.1044">     name += lastName;</span>
<a href="#l17.1045"></a><span id="l17.1045">   }</span>
<a href="#l17.1046"></a><span id="l17.1046" class="difflineminus">-  return( WriteGroupMember( name, eMail));</span>
<a href="#l17.1047"></a><span id="l17.1047" class="difflineplus">+  return WriteGroupMember(name, eMail);</span>
<a href="#l17.1048"></a><span id="l17.1048"> }</span>
<a href="#l17.1049"></a><span id="l17.1049"> </span>
<a href="#l17.1050"></a><span id="l17.1050" class="difflineminus">-BOOL CWabIterateProcess::WriteGroupMember( const char *pName, const char *pEmail)</span>
<a href="#l17.1051"></a><span id="l17.1051" class="difflineplus">+BOOL CWabIterateProcess::WriteGroupMember(const char *pName, const char *pEmail)</span>
<a href="#l17.1052"></a><span id="l17.1052"> {</span>
<a href="#l17.1053"></a><span id="l17.1053">   CString    middle;</span>
<a href="#l17.1054"></a><span id="l17.1054">   CString    line;</span>
<a href="#l17.1055"></a><span id="l17.1055">   BOOL    result;</span>
<a href="#l17.1056"></a><span id="l17.1056"> </span>
<a href="#l17.1057"></a><span id="l17.1057">   // Check for the header first</span>
<a href="#l17.1058"></a><span id="l17.1058">   if (!m_listHeaderDone) {</span>
<a href="#l17.1059"></a><span id="l17.1059">     if (m_recordsDone)</span>
<a href="#l17.1060"></a><span id="l17.1060">       result = m_out.WriteEol();</span>
<a href="#l17.1061"></a><span id="l17.1061">     else</span>
<a href="#l17.1062"></a><span id="l17.1062">       result = TRUE;</span>
<a href="#l17.1063"></a><span id="l17.1063" class="difflineminus">-    line.LoadString( IDS_LDIF_DN_START);</span>
<a href="#l17.1064"></a><span id="l17.1064" class="difflineplus">+    line.LoadString(IDS_LDIF_DN_START);</span>
<a href="#l17.1065"></a><span id="l17.1065">     line += m_listName;</span>
<a href="#l17.1066"></a><span id="l17.1066">     line += TR_OUTPUT_EOL;</span>
<a href="#l17.1067"></a><span id="l17.1067" class="difflineminus">-    middle.LoadString( IDS_FIELD_LDIF_FULLNAME);</span>
<a href="#l17.1068"></a><span id="l17.1068" class="difflineplus">+    middle.LoadString(IDS_FIELD_LDIF_FULLNAME);</span>
<a href="#l17.1069"></a><span id="l17.1069">     line += middle;</span>
<a href="#l17.1070"></a><span id="l17.1070">     line += m_listName;</span>
<a href="#l17.1071"></a><span id="l17.1071">     line += TR_OUTPUT_EOL;</span>
<a href="#l17.1072"></a><span id="l17.1072" class="difflineminus">-    if (!result || !m_out.WriteStr( line) || !m_out.WriteStr( kLDIFGroup)) {</span>
<a href="#l17.1073"></a><span id="l17.1073" class="difflineminus">-      UDialogs::ErrMessage0( IDS_ADDRESS_SAVE_ERROR);</span>
<a href="#l17.1074"></a><span id="l17.1074" class="difflineminus">-      return( FALSE);</span>
<a href="#l17.1075"></a><span id="l17.1075" class="difflineplus">+    if (!result || !m_out.WriteStr(line) || !m_out.WriteStr(kLDIFGroup)) {</span>
<a href="#l17.1076"></a><span id="l17.1076" class="difflineplus">+      UDialogs::ErrMessage0(IDS_ADDRESS_SAVE_ERROR);</span>
<a href="#l17.1077"></a><span id="l17.1077" class="difflineplus">+      return FALSE;</span>
<a href="#l17.1078"></a><span id="l17.1078">     }</span>
<a href="#l17.1079"></a><span id="l17.1079">     m_listHeaderDone = TRUE;</span>
<a href="#l17.1080"></a><span id="l17.1080">   }</span>
<a href="#l17.1081"></a><span id="l17.1081"> </span>
<a href="#l17.1082"></a><span id="l17.1082"> </span>
<a href="#l17.1083"></a><span id="l17.1083" class="difflineminus">-  line.LoadString( IDS_FIELD_LDIF_MEMBER_START);</span>
<a href="#l17.1084"></a><span id="l17.1084" class="difflineplus">+  line.LoadString(IDS_FIELD_LDIF_MEMBER_START);</span>
<a href="#l17.1085"></a><span id="l17.1085">   line += pName;</span>
<a href="#l17.1086"></a><span id="l17.1086" class="difflineminus">-  middle.LoadString( IDS_LDIF_DN_MIDDLE);</span>
<a href="#l17.1087"></a><span id="l17.1087" class="difflineplus">+  middle.LoadString(IDS_LDIF_DN_MIDDLE);</span>
<a href="#l17.1088"></a><span id="l17.1088">   line += middle;</span>
<a href="#l17.1089"></a><span id="l17.1089">   line += pEmail;</span>
<a href="#l17.1090"></a><span id="l17.1090">   line += TR_OUTPUT_EOL;</span>
<a href="#l17.1091"></a><span id="l17.1091" class="difflineminus">-  if (!m_out.WriteStr( line)) {</span>
<a href="#l17.1092"></a><span id="l17.1092" class="difflineminus">-    UDialogs::ErrMessage0( IDS_ADDRESS_SAVE_ERROR);</span>
<a href="#l17.1093"></a><span id="l17.1093" class="difflineminus">-    return( FALSE);</span>
<a href="#l17.1094"></a><span id="l17.1094" class="difflineplus">+  if (!m_out.WriteStr(line)) {</span>
<a href="#l17.1095"></a><span id="l17.1095" class="difflineplus">+    UDialogs::ErrMessage0(IDS_ADDRESS_SAVE_ERROR);</span>
<a href="#l17.1096"></a><span id="l17.1096" class="difflineplus">+    return FALSE;</span>
<a href="#l17.1097"></a><span id="l17.1097">   }</span>
<a href="#l17.1098"></a><span id="l17.1098"> </span>
<a href="#l17.1099"></a><span id="l17.1099">   if (m_listDone &lt; kValuePerUser) {</span>
<a href="#l17.1100"></a><span id="l17.1100">     m_listDone++;</span>
<a href="#l17.1101"></a><span id="l17.1101">     m_totalDone++;</span>
<a href="#l17.1102"></a><span id="l17.1102">   }</span>
<a href="#l17.1103"></a><span id="l17.1103"> </span>
<a href="#l17.1104"></a><span id="l17.1104" class="difflineminus">-  return( TRUE);</span>
<a href="#l17.1105"></a><span id="l17.1105" class="difflineplus">+  return TRUE;</span>
<a href="#l17.1106"></a><span id="l17.1106"> }</span>
<a href="#l17.1107"></a><span id="l17.1107"> */</span>
<a href="#l17.1108"></a><span id="l17.1108"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/import/oexpress/WabObject.h</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/import/oexpress/WabObject.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -44,43 +44,43 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6"> #include &lt;windows.h&gt;</span>
<a href="#l18.7"></a><span id="l18.7"> #include &lt;wab.h&gt;</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10"> class CWabIterator {</span>
<a href="#l18.11"></a><span id="l18.11"> public:</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  virtual nsresult  EnumUser( const PRUnichar *pName, LPENTRYID pEid, ULONG cbEid) = 0;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-  virtual nsresult  EnumList( const PRUnichar *pName, LPENTRYID pEid, ULONG cbEid, LPMAPITABLE lpTable) = 0;</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+  virtual nsresult  EnumUser(const PRUnichar *pName, LPENTRYID pEid, ULONG cbEid) = 0;</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+  virtual nsresult  EnumList(const PRUnichar *pName, LPENTRYID pEid, ULONG cbEid, LPMAPITABLE lpTable) = 0;</span>
<a href="#l18.16"></a><span id="l18.16"> };</span>
<a href="#l18.17"></a><span id="l18.17"> </span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19"> class CWAB</span>
<a href="#l18.20"></a><span id="l18.20"> {</span>
<a href="#l18.21"></a><span id="l18.21"> public:</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-    CWAB( nsILocalFile *fileName);</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+    CWAB(nsILocalFile *fileName);</span>
<a href="#l18.24"></a><span id="l18.24">     ~CWAB();</span>
<a href="#l18.25"></a><span id="l18.25"> </span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-  bool      Loaded( void) { return( m_bInitialized);}</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+  bool      Loaded(void) { return m_bInitialized;}</span>
<a href="#l18.28"></a><span id="l18.28"> </span>
<a href="#l18.29"></a><span id="l18.29">   HRESULT    IterateWABContents(CWabIterator *pIter, int *pDone);</span>
<a href="#l18.30"></a><span id="l18.30"> </span>
<a href="#l18.31"></a><span id="l18.31">   // Methods for User entries</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-  LPDISTLIST    GetDistList( ULONG cbEid, LPENTRYID pEid);</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-  void      ReleaseDistList( LPDISTLIST pList) { if (pList) pList-&gt;Release();}</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-  LPMAILUSER    GetUser( ULONG cbEid, LPENTRYID pEid);</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-  void      ReleaseUser( LPMAILUSER pUser) { if (pUser) pUser-&gt;Release();}</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-  LPSPropValue  GetUserProperty( LPMAILUSER pUser, ULONG tag);</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-  LPSPropValue  GetListProperty( LPDISTLIST pList, ULONG tag);</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-  void      FreeProperty( LPSPropValue pVal) { if (pVal) m_lpWABObject-&gt;FreeBuffer( pVal);}</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-  void      GetValueString( LPSPropValue pVal, nsString&amp; val);</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+  LPDISTLIST    GetDistList(ULONG cbEid, LPENTRYID pEid);</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+  void      ReleaseDistList(LPDISTLIST pList) { if (pList) pList-&gt;Release();}</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+  LPMAILUSER    GetUser(ULONG cbEid, LPENTRYID pEid);</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+  void      ReleaseUser(LPMAILUSER pUser) { if (pUser) pUser-&gt;Release();}</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+  LPSPropValue  GetUserProperty(LPMAILUSER pUser, ULONG tag);</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+  LPSPropValue  GetListProperty(LPDISTLIST pList, ULONG tag);</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+  void      FreeProperty(LPSPropValue pVal) { if (pVal) m_lpWABObject-&gt;FreeBuffer(pVal);}</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+  void      GetValueString(LPSPropValue pVal, nsString&amp; val);</span>
<a href="#l18.48"></a><span id="l18.48">   void      GetValueTime(LPSPropValue pVal, PRTime&amp; val);</span>
<a href="#l18.49"></a><span id="l18.49"> </span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-  void      CStrToUnicode( const char *pStr, nsString&amp; result);</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+  void      CStrToUnicode(const char *pStr, nsString&amp; result);</span>
<a href="#l18.52"></a><span id="l18.52"> </span>
<a href="#l18.53"></a><span id="l18.53">   // Utility stuff used by iterate</span>
<a href="#l18.54"></a><span id="l18.54">   void      FreeProws(LPSRowSet prows);</span>
<a href="#l18.55"></a><span id="l18.55"> </span>
<a href="#l18.56"></a><span id="l18.56"> </span>
<a href="#l18.57"></a><span id="l18.57"> private:</span>
<a href="#l18.58"></a><span id="l18.58">   PRUnichar *  m_pUniBuff;</span>
<a href="#l18.59"></a><span id="l18.59">   int      m_uniBuffLen;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOE5File.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOE5File.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -59,17 +59,17 @@</span>
<a href="#l19.4"></a><span id="l19.4"> #define  ISWATCHED     0x400000 //  256</span>
<a href="#l19.5"></a><span id="l19.5"> #define  ISIGNORED     0x800000 //  262144</span>
<a href="#l19.6"></a><span id="l19.6"> #define  XLATFLAGS(s)  (((MARKED &amp; s) ? nsMsgMessageFlags::Marked : 0) | \</span>
<a href="#l19.7"></a><span id="l19.7">                         ((READ &amp; s) ? nsMsgMessageFlags::Read : 0) | \</span>
<a href="#l19.8"></a><span id="l19.8">                         ((HASATTACHMENT &amp; s) ? nsMsgMessageFlags::Attachment : 0) | \</span>
<a href="#l19.9"></a><span id="l19.9">                         ((ISANSWERED &amp; s) ? nsMsgMessageFlags::Replied : 0) | \</span>
<a href="#l19.10"></a><span id="l19.10">                         ((ISFORWARDED &amp; s) ? nsMsgMessageFlags::Forwarded : 0) | \</span>
<a href="#l19.11"></a><span id="l19.11">                         ((ISWATCHED &amp; s) ? nsMsgMessageFlags::Watched : 0) | \</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-                        ((ISIGNORED &amp; s) ? nsMsgMessageFlags::Ignored : 0) )</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+                        ((ISIGNORED &amp; s) ? nsMsgMessageFlags::Ignored : 0))</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15"> static char *gSig =</span>
<a href="#l19.16"></a><span id="l19.16">   &quot;\xCF\xAD\x12\xFE\xC5\xFD\x74\x6F\x66\xE3\xD1\x11&quot;;</span>
<a href="#l19.17"></a><span id="l19.17"> </span>
<a href="#l19.18"></a><span id="l19.18"> // copied from nsprpub/pr/src/{io/prfile.c | md/windows/w95io.c} :</span>
<a href="#l19.19"></a><span id="l19.19"> // PR_FileTimeToPRTime and _PR_FileTimeToPRTime</span>
<a href="#l19.20"></a><span id="l19.20"> void nsOE5File::FileTimeToPRTime(const FILETIME *filetime, PRTime *prtm)</span>
<a href="#l19.21"></a><span id="l19.21"> {</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -83,106 +83,106 @@ void nsOE5File::FileTimeToPRTime(const F</span>
<a href="#l19.23"></a><span id="l19.23">     ::CopyMemory(prtm, filetime, sizeof(PRTime));</span>
<a href="#l19.24"></a><span id="l19.24"> #ifdef __GNUC__</span>
<a href="#l19.25"></a><span id="l19.25">     *prtm = (*prtm - _pr_filetime_offset) / 10LL;</span>
<a href="#l19.26"></a><span id="l19.26"> #else</span>
<a href="#l19.27"></a><span id="l19.27">     *prtm = (*prtm - _pr_filetime_offset) / 10i64;</span>
<a href="#l19.28"></a><span id="l19.28"> #endif</span>
<a href="#l19.29"></a><span id="l19.29"> }</span>
<a href="#l19.30"></a><span id="l19.30"> </span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-bool nsOE5File::VerifyLocalMailFile( nsIFile *pFile)</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+bool nsOE5File::VerifyLocalMailFile(nsIFile *pFile)</span>
<a href="#l19.33"></a><span id="l19.33"> {</span>
<a href="#l19.34"></a><span id="l19.34">   char    sig[kSignatureSize];</span>
<a href="#l19.35"></a><span id="l19.35"> </span>
<a href="#l19.36"></a><span id="l19.36">   nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l19.37"></a><span id="l19.37"> </span>
<a href="#l19.38"></a><span id="l19.38">   if (NS_FAILED(NS_NewLocalFileInputStream(getter_AddRefs(inputStream), pFile)))</span>
<a href="#l19.39"></a><span id="l19.39">     return false;</span>
<a href="#l19.40"></a><span id="l19.40"> </span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-  if (!ReadBytes( inputStream, sig, 0, kSignatureSize))</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+  if (!ReadBytes(inputStream, sig, 0, kSignatureSize))</span>
<a href="#l19.43"></a><span id="l19.43">     return false;</span>
<a href="#l19.44"></a><span id="l19.44"> </span>
<a href="#l19.45"></a><span id="l19.45">   bool    result = true;</span>
<a href="#l19.46"></a><span id="l19.46"> </span>
<a href="#l19.47"></a><span id="l19.47">   for (int i = 0; (i &lt; kSignatureSize) &amp;&amp; result; i++) {</span>
<a href="#l19.48"></a><span id="l19.48">     if (sig[i] != gSig[i])</span>
<a href="#l19.49"></a><span id="l19.49">       result = false;</span>
<a href="#l19.50"></a><span id="l19.50">   }</span>
<a href="#l19.51"></a><span id="l19.51"> </span>
<a href="#l19.52"></a><span id="l19.52">   char  storeName[14];</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">-  if (!ReadBytes( inputStream, storeName, 0x24C1, 12))</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+  if (!ReadBytes(inputStream, storeName, 0x24C1, 12))</span>
<a href="#l19.55"></a><span id="l19.55">     result = false;</span>
<a href="#l19.56"></a><span id="l19.56"> </span>
<a href="#l19.57"></a><span id="l19.57">   storeName[12] = 0;</span>
<a href="#l19.58"></a><span id="l19.58"> </span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-  if (PL_strcasecmp( &quot;LocalStore&quot;, storeName))</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+  if (PL_strcasecmp(&quot;LocalStore&quot;, storeName))</span>
<a href="#l19.61"></a><span id="l19.61">     result = false;</span>
<a href="#l19.62"></a><span id="l19.62"> </span>
<a href="#l19.63"></a><span id="l19.63">   return result;</span>
<a href="#l19.64"></a><span id="l19.64"> }</span>
<a href="#l19.65"></a><span id="l19.65"> </span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-bool nsOE5File::IsLocalMailFile( nsIFile *pFile)</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+bool nsOE5File::IsLocalMailFile(nsIFile *pFile)</span>
<a href="#l19.68"></a><span id="l19.68"> {</span>
<a href="#l19.69"></a><span id="l19.69">   nsresult  rv;</span>
<a href="#l19.70"></a><span id="l19.70">   bool      isFile = false;</span>
<a href="#l19.71"></a><span id="l19.71"> </span>
<a href="#l19.72"></a><span id="l19.72" class="difflineminus">-  rv = pFile-&gt;IsFile( &amp;isFile);</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineminus">-  if (NS_FAILED( rv) || !isFile)</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-    return( false);</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+  rv = pFile-&gt;IsFile(&amp;isFile);</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+  if (NS_FAILED(rv) || !isFile)</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+    return false;</span>
<a href="#l19.78"></a><span id="l19.78"> </span>
<a href="#l19.79"></a><span id="l19.79" class="difflineminus">-  bool result = VerifyLocalMailFile( pFile);</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+  bool result = VerifyLocalMailFile(pFile);</span>
<a href="#l19.81"></a><span id="l19.81"> </span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-  return( result);</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+  return result;</span>
<a href="#l19.84"></a><span id="l19.84"> }</span>
<a href="#l19.85"></a><span id="l19.85"> </span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-bool nsOE5File::ReadIndex( nsIInputStream *pInputStream, PRUint32 **ppIndex, PRUint32 *pSize)</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+bool nsOE5File::ReadIndex(nsIInputStream *pInputStream, PRUint32 **ppIndex, PRUint32 *pSize)</span>
<a href="#l19.88"></a><span id="l19.88"> {</span>
<a href="#l19.89"></a><span id="l19.89">   *ppIndex = nsnull;</span>
<a href="#l19.90"></a><span id="l19.90">   *pSize = 0;</span>
<a href="#l19.91"></a><span id="l19.91"> </span>
<a href="#l19.92"></a><span id="l19.92">   char    signature[4];</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineminus">-  if (!ReadBytes( pInputStream, signature, 0, 4))</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineminus">-    return( false);</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+  if (!ReadBytes(pInputStream, signature, 0, 4))</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+    return false;</span>
<a href="#l19.97"></a><span id="l19.97"> </span>
<a href="#l19.98"></a><span id="l19.98">   for (int i = 0; i &lt; 4; i++) {</span>
<a href="#l19.99"></a><span id="l19.99">     if (signature[i] != gSig[i]) {</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineminus">-      IMPORT_LOG0( &quot;*** Outlook 5.0 dbx file signature doesn't match\n&quot;);</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineminus">-      return( false);</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+      IMPORT_LOG0(&quot;*** Outlook 5.0 dbx file signature doesn't match\n&quot;);</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+      return false;</span>
<a href="#l19.104"></a><span id="l19.104">     }</span>
<a href="#l19.105"></a><span id="l19.105">   }</span>
<a href="#l19.106"></a><span id="l19.106"> </span>
<a href="#l19.107"></a><span id="l19.107">   PRUint32  offset = 0x00e4;</span>
<a href="#l19.108"></a><span id="l19.108">   PRUint32  indexStart = 0;</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineminus">-  if (!ReadBytes( pInputStream, &amp;indexStart, offset, 4)) {</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineminus">-    IMPORT_LOG0( &quot;*** Unable to read offset to index start\n&quot;);</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineminus">-    return( false);</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineplus">+  if (!ReadBytes(pInputStream, &amp;indexStart, offset, 4)) {</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineplus">+    IMPORT_LOG0(&quot;*** Unable to read offset to index start\n&quot;);</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineplus">+    return false;</span>
<a href="#l19.115"></a><span id="l19.115">   }</span>
<a href="#l19.116"></a><span id="l19.116"> </span>
<a href="#l19.117"></a><span id="l19.117">   PRUint32Array array;</span>
<a href="#l19.118"></a><span id="l19.118">   array.count = 0;</span>
<a href="#l19.119"></a><span id="l19.119">   array.alloc = kIndexGrowBy;</span>
<a href="#l19.120"></a><span id="l19.120">   array.pIndex = new PRUint32[kIndexGrowBy];</span>
<a href="#l19.121"></a><span id="l19.121"> </span>
<a href="#l19.122"></a><span id="l19.122" class="difflineminus">-  PRUint32 next = ReadMsgIndex( pInputStream, indexStart, &amp;array);</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineplus">+  PRUint32 next = ReadMsgIndex(pInputStream, indexStart, &amp;array);</span>
<a href="#l19.124"></a><span id="l19.124">   while (next) {</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineminus">-    next = ReadMsgIndex( pInputStream, next, &amp;array);</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineplus">+    next = ReadMsgIndex(pInputStream, next, &amp;array);</span>
<a href="#l19.127"></a><span id="l19.127">   }</span>
<a href="#l19.128"></a><span id="l19.128"> </span>
<a href="#l19.129"></a><span id="l19.129">   if (array.count) {</span>
<a href="#l19.130"></a><span id="l19.130">     *pSize = array.count;</span>
<a href="#l19.131"></a><span id="l19.131">     *ppIndex = array.pIndex;</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineminus">-    return( true);</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineplus">+    return true;</span>
<a href="#l19.134"></a><span id="l19.134">   }</span>
<a href="#l19.135"></a><span id="l19.135"> </span>
<a href="#l19.136"></a><span id="l19.136">   delete [] array.pIndex;</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineminus">-  return( false);</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineplus">+  return false;</span>
<a href="#l19.139"></a><span id="l19.139"> }</span>
<a href="#l19.140"></a><span id="l19.140"> </span>
<a href="#l19.141"></a><span id="l19.141"> </span>
<a href="#l19.142"></a><span id="l19.142" class="difflineminus">-PRUint32 nsOE5File::ReadMsgIndex( nsIInputStream *pInputStream, PRUint32 offset, PRUint32Array *pArray)</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineplus">+PRUint32 nsOE5File::ReadMsgIndex(nsIInputStream *pInputStream, PRUint32 offset, PRUint32Array *pArray)</span>
<a href="#l19.144"></a><span id="l19.144"> {</span>
<a href="#l19.145"></a><span id="l19.145">   // Record is:</span>
<a href="#l19.146"></a><span id="l19.146">     // 4 byte marker</span>
<a href="#l19.147"></a><span id="l19.147">     // 4 byte unknown</span>
<a href="#l19.148"></a><span id="l19.148">     // 4 byte nextSubIndex</span>
<a href="#l19.149"></a><span id="l19.149">     // 4 byte (parentIndex?)</span>
<a href="#l19.150"></a><span id="l19.150">     // 2 bytes unknown</span>
<a href="#l19.151"></a><span id="l19.151">     // 1 byte length - # of entries in this record</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineat">@@ -190,55 +190,55 @@ PRUint32 nsOE5File::ReadMsgIndex( nsIInp</span>
<a href="#l19.153"></a><span id="l19.153">     // 4 byte unknown</span>
<a href="#l19.154"></a><span id="l19.154">     // length records consisting of 3 longs</span>
<a href="#l19.155"></a><span id="l19.155">   //  1 - pointer to record</span>
<a href="#l19.156"></a><span id="l19.156">   //  2 - child index pointer</span>
<a href="#l19.157"></a><span id="l19.157">   //  3 - number of records in child</span>
<a href="#l19.158"></a><span id="l19.158"> </span>
<a href="#l19.159"></a><span id="l19.159">   PRUint32  marker;</span>
<a href="#l19.160"></a><span id="l19.160"> </span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-  if (!ReadBytes( pInputStream, &amp;marker, offset, 4))</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineminus">-    return( 0);</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineplus">+  if (!ReadBytes(pInputStream, &amp;marker, offset, 4))</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineplus">+    return 0;</span>
<a href="#l19.165"></a><span id="l19.165"> </span>
<a href="#l19.166"></a><span id="l19.166">   if (marker != offset)</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineminus">-    return( 0);</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineplus">+    return 0;</span>
<a href="#l19.169"></a><span id="l19.169"> </span>
<a href="#l19.170"></a><span id="l19.170"> </span>
<a href="#l19.171"></a><span id="l19.171">   PRUint32  vals[3];</span>
<a href="#l19.172"></a><span id="l19.172"> </span>
<a href="#l19.173"></a><span id="l19.173" class="difflineminus">-  if (!ReadBytes( pInputStream, vals, offset + 4, 12))</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineminus">-    return( 0);</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineplus">+  if (!ReadBytes(pInputStream, vals, offset + 4, 12))</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineplus">+    return 0;</span>
<a href="#l19.177"></a><span id="l19.177"> </span>
<a href="#l19.178"></a><span id="l19.178"> </span>
<a href="#l19.179"></a><span id="l19.179">   PRUint8  len[4];</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineminus">-  if (!ReadBytes( pInputStream, len, offset + 16, 4))</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineminus">-    return( 0);</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineplus">+  if (!ReadBytes(pInputStream, len, offset + 16, 4))</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineplus">+    return 0;</span>
<a href="#l19.184"></a><span id="l19.184"> </span>
<a href="#l19.185"></a><span id="l19.185"> </span>
<a href="#l19.186"></a><span id="l19.186"> </span>
<a href="#l19.187"></a><span id="l19.187">   PRUint32  cnt = (PRUint32) len[1];</span>
<a href="#l19.188"></a><span id="l19.188">   cnt *= 3;</span>
<a href="#l19.189"></a><span id="l19.189">   PRUint32  *pData = new PRUint32[cnt];</span>
<a href="#l19.190"></a><span id="l19.190"> </span>
<a href="#l19.191"></a><span id="l19.191" class="difflineminus">-  if (!ReadBytes( pInputStream, pData, offset + 24, cnt * 4)) {</span>
<a href="#l19.192"></a><span id="l19.192" class="difflineplus">+  if (!ReadBytes(pInputStream, pData, offset + 24, cnt * 4)) {</span>
<a href="#l19.193"></a><span id="l19.193">     delete [] pData;</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineminus">-    return( 0);</span>
<a href="#l19.195"></a><span id="l19.195" class="difflineplus">+    return 0;</span>
<a href="#l19.196"></a><span id="l19.196">   }</span>
<a href="#l19.197"></a><span id="l19.197"> </span>
<a href="#l19.198"></a><span id="l19.198">   PRUint32  next;</span>
<a href="#l19.199"></a><span id="l19.199">   PRUint32  indexOffset;</span>
<a href="#l19.200"></a><span id="l19.200">   PRUint32 *  pRecord = pData;</span>
<a href="#l19.201"></a><span id="l19.201">   PRUint32 *  pNewIndex;</span>
<a href="#l19.202"></a><span id="l19.202"> </span>
<a href="#l19.203"></a><span id="l19.203">   for (PRUint8 i = 0; i &lt; (PRUint8)len[1]; i++, pRecord += 3) {</span>
<a href="#l19.204"></a><span id="l19.204">     indexOffset = pRecord[0];</span>
<a href="#l19.205"></a><span id="l19.205"> </span>
<a href="#l19.206"></a><span id="l19.206">     if (pArray-&gt;count &gt;= pArray-&gt;alloc) {</span>
<a href="#l19.207"></a><span id="l19.207">       pNewIndex = new PRUint32[ pArray-&gt;alloc + kIndexGrowBy];</span>
<a href="#l19.208"></a><span id="l19.208" class="difflineminus">-      memcpy( pNewIndex, pArray-&gt;pIndex, (pArray-&gt;alloc * 4));</span>
<a href="#l19.209"></a><span id="l19.209" class="difflineplus">+      memcpy(pNewIndex, pArray-&gt;pIndex, (pArray-&gt;alloc * 4));</span>
<a href="#l19.210"></a><span id="l19.210">       (pArray-&gt;alloc) += kIndexGrowBy;</span>
<a href="#l19.211"></a><span id="l19.211">       delete [] pArray-&gt;pIndex;</span>
<a href="#l19.212"></a><span id="l19.212">       pArray-&gt;pIndex = pNewIndex;</span>
<a href="#l19.213"></a><span id="l19.213">     }</span>
<a href="#l19.214"></a><span id="l19.214"> </span>
<a href="#l19.215"></a><span id="l19.215">     /*</span>
<a href="#l19.216"></a><span id="l19.216">     We could do some checking here if we wanted -</span>
<a href="#l19.217"></a><span id="l19.217">     make sure the index is within the file,</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineat">@@ -247,67 +247,68 @@ PRUint32 nsOE5File::ReadMsgIndex( nsIInp</span>
<a href="#l19.219"></a><span id="l19.219"> </span>
<a href="#l19.220"></a><span id="l19.220">     pArray-&gt;pIndex[pArray-&gt;count] = indexOffset;</span>
<a href="#l19.221"></a><span id="l19.221">     (pArray-&gt;count)++;</span>
<a href="#l19.222"></a><span id="l19.222"> </span>
<a href="#l19.223"></a><span id="l19.223"> </span>
<a href="#l19.224"></a><span id="l19.224"> </span>
<a href="#l19.225"></a><span id="l19.225">     next = pRecord[1];</span>
<a href="#l19.226"></a><span id="l19.226">     if (next)</span>
<a href="#l19.227"></a><span id="l19.227" class="difflineminus">-      while ((next = ReadMsgIndex( pInputStream, next, pArray)) != 0);</span>
<a href="#l19.228"></a><span id="l19.228" class="difflineplus">+      while ((next = ReadMsgIndex(pInputStream, next, pArray)) != 0);</span>
<a href="#l19.229"></a><span id="l19.229">   }</span>
<a href="#l19.230"></a><span id="l19.230">   delete [] pData;</span>
<a href="#l19.231"></a><span id="l19.231"> </span>
<a href="#l19.232"></a><span id="l19.232">   // return the pointer to the next subIndex</span>
<a href="#l19.233"></a><span id="l19.233" class="difflineminus">-  return( vals[1]);</span>
<a href="#l19.234"></a><span id="l19.234" class="difflineplus">+  return vals[1];</span>
<a href="#l19.235"></a><span id="l19.235"> }</span>
<a href="#l19.236"></a><span id="l19.236"> </span>
<a href="#l19.237"></a><span id="l19.237" class="difflineminus">-bool nsOE5File::IsFromLine( char *pLine, PRUint32 len)</span>
<a href="#l19.238"></a><span id="l19.238" class="difflineplus">+bool nsOE5File::IsFromLine(char *pLine, PRUint32 len)</span>
<a href="#l19.239"></a><span id="l19.239"> {</span>
<a href="#l19.240"></a><span id="l19.240">    return (len &gt; 5 &amp;&amp; (pLine[0] == 'F') &amp;&amp; (pLine[1] == 'r') &amp;&amp; (pLine[2] == 'o') &amp;&amp; (pLine[3] == 'm') &amp;&amp; (pLine[4] == ' '));</span>
<a href="#l19.241"></a><span id="l19.241"> }</span>
<a href="#l19.242"></a><span id="l19.242"> </span>
<a href="#l19.243"></a><span id="l19.243"> // Anything over 16K will be assumed BAD, BAD, BAD!</span>
<a href="#l19.244"></a><span id="l19.244"> #define  kMailboxBufferSize  0x4000</span>
<a href="#l19.245"></a><span id="l19.245"> #define  kMaxAttrCount       0x0030</span>
<a href="#l19.246"></a><span id="l19.246"> const char *nsOE5File::m_pFromLineSep = &quot;From - Mon Jan 1 00:00:00 1965\x0D\x0A&quot;;</span>
<a href="#l19.247"></a><span id="l19.247"> </span>
<a href="#l19.248"></a><span id="l19.248" class="difflineminus">-nsresult nsOE5File::ImportMailbox( PRUint32 *pBytesDone, bool *pAbort, nsString&amp; name, nsIFile *inFile, nsIFile *pDestination, PRUint32 *pCount)</span>
<a href="#l19.249"></a><span id="l19.249" class="difflineplus">+nsresult nsOE5File::ImportMailbox(PRUint32 *pBytesDone, bool *pAbort, nsString&amp; name, nsIFile *inFile, nsIFile *pDestination, PRUint32 *pCount)</span>
<a href="#l19.250"></a><span id="l19.250"> {</span>
<a href="#l19.251"></a><span id="l19.251">   nsresult  rv;</span>
<a href="#l19.252"></a><span id="l19.252">   PRInt32    msgCount = 0;</span>
<a href="#l19.253"></a><span id="l19.253">   if (pCount)</span>
<a href="#l19.254"></a><span id="l19.254">     *pCount = 0;</span>
<a href="#l19.255"></a><span id="l19.255"> </span>
<a href="#l19.256"></a><span id="l19.256">   nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l19.257"></a><span id="l19.257">   rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), inFile);</span>
<a href="#l19.258"></a><span id="l19.258" class="difflineminus">-  if (NS_FAILED( rv)) return( rv);</span>
<a href="#l19.259"></a><span id="l19.259" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l19.260"></a><span id="l19.260" class="difflineplus">+    return rv;</span>
<a href="#l19.261"></a><span id="l19.261">   nsCOMPtr &lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l19.262"></a><span id="l19.262">   rv = MsgNewBufferedFileOutputStream(getter_AddRefs(outputStream), pDestination, -1, 0600);</span>
<a href="#l19.263"></a><span id="l19.263" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l19.264"></a><span id="l19.264" class="difflineminus">-    return( rv);</span>
<a href="#l19.265"></a><span id="l19.265" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l19.266"></a><span id="l19.266" class="difflineplus">+    return rv;</span>
<a href="#l19.267"></a><span id="l19.267"> </span>
<a href="#l19.268"></a><span id="l19.268">   PRUint32 *  pIndex;</span>
<a href="#l19.269"></a><span id="l19.269">   PRUint32  indexSize;</span>
<a href="#l19.270"></a><span id="l19.270">   PRUint32 *  pFlags;</span>
<a href="#l19.271"></a><span id="l19.271">   PRUint64  *  pTime;</span>
<a href="#l19.272"></a><span id="l19.272"> </span>
<a href="#l19.273"></a><span id="l19.273" class="difflineminus">-  if (!ReadIndex( inputStream, &amp;pIndex, &amp;indexSize)) {</span>
<a href="#l19.274"></a><span id="l19.274" class="difflineminus">-    IMPORT_LOG1( &quot;No messages found in mailbox: %s\n&quot;, NS_LossyConvertUTF16toASCII(name.get()));</span>
<a href="#l19.275"></a><span id="l19.275" class="difflineminus">-    return( NS_OK);</span>
<a href="#l19.276"></a><span id="l19.276" class="difflineplus">+  if (!ReadIndex(inputStream, &amp;pIndex, &amp;indexSize)) {</span>
<a href="#l19.277"></a><span id="l19.277" class="difflineplus">+    IMPORT_LOG1(&quot;No messages found in mailbox: %s\n&quot;, NS_LossyConvertUTF16toASCII(name.get()));</span>
<a href="#l19.278"></a><span id="l19.278" class="difflineplus">+    return NS_OK;</span>
<a href="#l19.279"></a><span id="l19.279">   }</span>
<a href="#l19.280"></a><span id="l19.280"> </span>
<a href="#l19.281"></a><span id="l19.281">   pTime  = new PRUint64[ indexSize];</span>
<a href="#l19.282"></a><span id="l19.282">   pFlags = new PRUint32[ indexSize];</span>
<a href="#l19.283"></a><span id="l19.283">   char *  pBuffer = new char[kMailboxBufferSize];</span>
<a href="#l19.284"></a><span id="l19.284">   if (!(*pAbort))</span>
<a href="#l19.285"></a><span id="l19.285" class="difflineminus">-    ConvertIndex( inputStream, pBuffer, pIndex, indexSize, pFlags, pTime);</span>
<a href="#l19.286"></a><span id="l19.286" class="difflineplus">+    ConvertIndex(inputStream, pBuffer, pIndex, indexSize, pFlags, pTime);</span>
<a href="#l19.287"></a><span id="l19.287"> </span>
<a href="#l19.288"></a><span id="l19.288">   PRUint32  block[4];</span>
<a href="#l19.289"></a><span id="l19.289" class="difflineminus">-  PRInt32   sepLen = (PRInt32) strlen( m_pFromLineSep);</span>
<a href="#l19.290"></a><span id="l19.290" class="difflineplus">+  PRInt32   sepLen = (PRInt32) strlen(m_pFromLineSep);</span>
<a href="#l19.291"></a><span id="l19.291">   PRUint32   written;</span>
<a href="#l19.292"></a><span id="l19.292"> </span>
<a href="#l19.293"></a><span id="l19.293">   /*</span>
<a href="#l19.294"></a><span id="l19.294">       Each block is:</span>
<a href="#l19.295"></a><span id="l19.295">       marker - matches file offset</span>
<a href="#l19.296"></a><span id="l19.296">       block length</span>
<a href="#l19.297"></a><span id="l19.297">       text length in block</span>
<a href="#l19.298"></a><span id="l19.298">       pointer to next block. (0 if end)</span>
<a href="#l19.299"></a><span id="l19.299" class="difflineat">@@ -332,38 +333,38 @@ nsresult nsOE5File::ImportMailbox( PRUin</span>
<a href="#l19.300"></a><span id="l19.300">   nsCAutoString partialLine, tempLine;</span>
<a href="#l19.301"></a><span id="l19.301">   rv = NS_OK;</span>
<a href="#l19.302"></a><span id="l19.302"> </span>
<a href="#l19.303"></a><span id="l19.303">   for (PRUint32 i = 0; (i &lt; indexSize) &amp;&amp; !(*pAbort); i++)</span>
<a href="#l19.304"></a><span id="l19.304">   {</span>
<a href="#l19.305"></a><span id="l19.305">     if (! pIndex[i])</span>
<a href="#l19.306"></a><span id="l19.306">       continue;</span>
<a href="#l19.307"></a><span id="l19.307"> </span>
<a href="#l19.308"></a><span id="l19.308" class="difflineminus">-    if (ReadBytes( inputStream, block, pIndex[i], 16) &amp;&amp; (block[0] == pIndex[i]) &amp;&amp;</span>
<a href="#l19.309"></a><span id="l19.309" class="difflineminus">-      (block[2] &lt; kMailboxBufferSize) &amp;&amp; (ReadBytes( inputStream, pBuffer, kDontSeek, block[2])))</span>
<a href="#l19.310"></a><span id="l19.310" class="difflineplus">+    if (ReadBytes(inputStream, block, pIndex[i], 16) &amp;&amp; (block[0] == pIndex[i]) &amp;&amp;</span>
<a href="#l19.311"></a><span id="l19.311" class="difflineplus">+      (block[2] &lt; kMailboxBufferSize) &amp;&amp; (ReadBytes(inputStream, pBuffer, kDontSeek, block[2])))</span>
<a href="#l19.312"></a><span id="l19.312">     {</span>
<a href="#l19.313"></a><span id="l19.313">       // block[2] contains the chars in the buffer (ie, buf content size).</span>
<a href="#l19.314"></a><span id="l19.314">       // block[3] contains offset to the next block of data (0 means no more data).</span>
<a href="#l19.315"></a><span id="l19.315">       size = block[2];</span>
<a href="#l19.316"></a><span id="l19.316">       pStart = pBuffer;</span>
<a href="#l19.317"></a><span id="l19.317">       pEnd = pStart + size;</span>
<a href="#l19.318"></a><span id="l19.318"> </span>
<a href="#l19.319"></a><span id="l19.319">       // write out the from separator.</span>
<a href="#l19.320"></a><span id="l19.320">       rv = NS_ERROR_FAILURE;</span>
<a href="#l19.321"></a><span id="l19.321" class="difflineminus">-      if (IsFromLine( pBuffer, size))</span>
<a href="#l19.322"></a><span id="l19.322" class="difflineplus">+      if (IsFromLine(pBuffer, size))</span>
<a href="#l19.323"></a><span id="l19.323">       {</span>
<a href="#l19.324"></a><span id="l19.324">         char *pChar = pStart;</span>
<a href="#l19.325"></a><span id="l19.325">         while ((pChar &lt; pEnd) &amp;&amp; (*pChar != '\r') &amp;&amp; (*(pChar+1) != '\n'))</span>
<a href="#l19.326"></a><span id="l19.326">           pChar++;</span>
<a href="#l19.327"></a><span id="l19.327"> </span>
<a href="#l19.328"></a><span id="l19.328">         if (pChar &lt; pEnd)</span>
<a href="#l19.329"></a><span id="l19.329">         {</span>
<a href="#l19.330"></a><span id="l19.330">           // Get the &quot;From &quot; line so write it out.</span>
<a href="#l19.331"></a><span id="l19.331">           rv = outputStream-&gt;Write(pStart, pChar-pStart+2, &amp;written);</span>
<a href="#l19.332"></a><span id="l19.332" class="difflineminus">-          if ( rv)</span>
<a href="#l19.333"></a><span id="l19.333" class="difflineplus">+          if (rv)</span>
<a href="#l19.334"></a><span id="l19.334">             // Now buffer starts from the 2nd line.</span>
<a href="#l19.335"></a><span id="l19.335">             pStart = pChar + 2;</span>
<a href="#l19.336"></a><span id="l19.336">         }</span>
<a href="#l19.337"></a><span id="l19.337">       }</span>
<a href="#l19.338"></a><span id="l19.338">       else if (pTime[i])</span>
<a href="#l19.339"></a><span id="l19.339">       {</span>
<a href="#l19.340"></a><span id="l19.340">         char              result[156] = &quot;&quot;;</span>
<a href="#l19.341"></a><span id="l19.341">         PRExplodedTime    xpldTime;</span>
<a href="#l19.342"></a><span id="l19.342" class="difflineat">@@ -375,24 +376,24 @@ nsresult nsOE5File::ImportMailbox( PRUin</span>
<a href="#l19.343"></a><span id="l19.343">         PR_ExplodeTime(prt, PR_LocalTimeParameters, &amp;xpldTime);</span>
<a href="#l19.344"></a><span id="l19.344">         PR_FormatTimeUSEnglish(buffer, sizeof(buffer),</span>
<a href="#l19.345"></a><span id="l19.345">                                 &quot;%a %b %d %H:%M:%S %Y&quot;,</span>
<a href="#l19.346"></a><span id="l19.346">                                 &amp;xpldTime);</span>
<a href="#l19.347"></a><span id="l19.347">         PL_strcpy(result, &quot;From - &quot;);</span>
<a href="#l19.348"></a><span id="l19.348">         PL_strcpy(result + 7, buffer);</span>
<a href="#l19.349"></a><span id="l19.349">         PL_strcpy(result + 7 + 24, CRLF);</span>
<a href="#l19.350"></a><span id="l19.350"> </span>
<a href="#l19.351"></a><span id="l19.351" class="difflineminus">-        rv = outputStream-&gt;Write(result, (PRInt32) strlen( result), &amp;written);</span>
<a href="#l19.352"></a><span id="l19.352" class="difflineplus">+        rv = outputStream-&gt;Write(result, (PRInt32) strlen(result), &amp;written);</span>
<a href="#l19.353"></a><span id="l19.353">       }</span>
<a href="#l19.354"></a><span id="l19.354" class="difflineminus">-      if (NS_FAILED( rv))</span>
<a href="#l19.355"></a><span id="l19.355" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l19.356"></a><span id="l19.356">       {</span>
<a href="#l19.357"></a><span id="l19.357">         // Write out the default from line since there is none in the msg.</span>
<a href="#l19.358"></a><span id="l19.358">         rv = outputStream-&gt;Write(m_pFromLineSep, sepLen, &amp;written);</span>
<a href="#l19.359"></a><span id="l19.359">         // FIXME: Do I need to check the return value of written???</span>
<a href="#l19.360"></a><span id="l19.360" class="difflineminus">-        if (NS_FAILED( rv))</span>
<a href="#l19.361"></a><span id="l19.361" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l19.362"></a><span id="l19.362">           break;</span>
<a href="#l19.363"></a><span id="l19.363">       }</span>
<a href="#l19.364"></a><span id="l19.364"> </span>
<a href="#l19.365"></a><span id="l19.365">       char statusLine[50];</span>
<a href="#l19.366"></a><span id="l19.366">       PRUint32 msgFlags = XLATFLAGS(pFlags[i]);</span>
<a href="#l19.367"></a><span id="l19.367">       PR_snprintf(statusLine, sizeof(statusLine), X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, msgFlags &amp; 0xFFFF);</span>
<a href="#l19.368"></a><span id="l19.368">       rv = outputStream-&gt;Write(statusLine, strlen(statusLine), &amp;written);</span>
<a href="#l19.369"></a><span id="l19.369">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l19.370"></a><span id="l19.370" class="difflineat">@@ -402,17 +403,17 @@ nsresult nsOE5File::ImportMailbox( PRUin</span>
<a href="#l19.371"></a><span id="l19.371"> </span>
<a href="#l19.372"></a><span id="l19.372">       do</span>
<a href="#l19.373"></a><span id="l19.373">       {</span>
<a href="#l19.374"></a><span id="l19.374">         partialLine.Truncate();</span>
<a href="#l19.375"></a><span id="l19.375">         partialLineStart = pEnd;</span>
<a href="#l19.376"></a><span id="l19.376"> </span>
<a href="#l19.377"></a><span id="l19.377">         // If the buffer doesn't end with CRLF then a line is broken into two blocks,</span>
<a href="#l19.378"></a><span id="l19.378">         // so save the incomplete line for later process when we read the next block.</span>
<a href="#l19.379"></a><span id="l19.379" class="difflineminus">-        if ( (size &gt; 1) &amp;&amp; !(*(pEnd - 2) == '\r' &amp;&amp; *(pEnd - 1) == '\n') )</span>
<a href="#l19.380"></a><span id="l19.380" class="difflineplus">+        if ((size &gt; 1) &amp;&amp; !(*(pEnd - 2) == '\r' &amp;&amp; *(pEnd - 1) == '\n'))</span>
<a href="#l19.381"></a><span id="l19.381">         {</span>
<a href="#l19.382"></a><span id="l19.382">           partialLineStart -= 2;</span>
<a href="#l19.383"></a><span id="l19.383">           while ((partialLineStart &gt;= pStart) &amp;&amp; (*partialLineStart != '\r') &amp;&amp; (*(partialLineStart+1) != '\n'))</span>
<a href="#l19.384"></a><span id="l19.384">             partialLineStart--;</span>
<a href="#l19.385"></a><span id="l19.385">           if (partialLineStart != (pEnd - 2))</span>
<a href="#l19.386"></a><span id="l19.386">             partialLineStart += 2; // skip over CRLF if we find them.</span>
<a href="#l19.387"></a><span id="l19.387">           partialLine.Assign(partialLineStart, pEnd - partialLineStart);</span>
<a href="#l19.388"></a><span id="l19.388">         }</span>
<a href="#l19.389"></a><span id="l19.389" class="difflineat">@@ -454,18 +455,18 @@ nsresult nsOE5File::ImportMailbox( PRUin</span>
<a href="#l19.390"></a><span id="l19.390">                 break;</span>
<a href="#l19.391"></a><span id="l19.391"> </span>
<a href="#l19.392"></a><span id="l19.392">               // Adjust where data start and size (since some of the data has been processed).</span>
<a href="#l19.393"></a><span id="l19.393">               size -= (pStart - pBuffer);</span>
<a href="#l19.394"></a><span id="l19.394">             }</span>
<a href="#l19.395"></a><span id="l19.395">           }</span>
<a href="#l19.396"></a><span id="l19.396">           else</span>
<a href="#l19.397"></a><span id="l19.397">           {</span>
<a href="#l19.398"></a><span id="l19.398" class="difflineminus">-            IMPORT_LOG2( &quot;Error reading message from %s at 0x%lx\n&quot;, NS_LossyConvertUTF16toASCII(name.get()), pIndex[i]);</span>
<a href="#l19.399"></a><span id="l19.399" class="difflineminus">-            rv = outputStream-&gt;Write( &quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l19.400"></a><span id="l19.400" class="difflineplus">+            IMPORT_LOG2(&quot;Error reading message from %s at 0x%lx\n&quot;, NS_LossyConvertUTF16toASCII(name.get()), pIndex[i]);</span>
<a href="#l19.401"></a><span id="l19.401" class="difflineplus">+            rv = outputStream-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l19.402"></a><span id="l19.402">             next = 0;</span>
<a href="#l19.403"></a><span id="l19.403">           }</span>
<a href="#l19.404"></a><span id="l19.404">       } while (next);</span>
<a href="#l19.405"></a><span id="l19.405"> </span>
<a href="#l19.406"></a><span id="l19.406">       // Always end a msg with CRLF. This will make sure that OE msgs without body is</span>
<a href="#l19.407"></a><span id="l19.407">       // correctly recognized as msgs. Otherwise, we'll end up with the following in</span>
<a href="#l19.408"></a><span id="l19.408">       // the msg folder where the 2nd msg starts right after the headers of the 1st msg:</span>
<a href="#l19.409"></a><span id="l19.409">       //</span>
<a href="#l19.410"></a><span id="l19.410" class="difflineat">@@ -474,42 +475,42 @@ nsresult nsOE5File::ImportMailbox( PRUin</span>
<a href="#l19.411"></a><span id="l19.411">       // . . . (more headers)</span>
<a href="#l19.412"></a><span id="l19.412">       // To: &lt;someone@netscape.com&gt;</span>
<a href="#l19.413"></a><span id="l19.413">       // From - Jan 1965 00:00:00     &lt;&lt;&lt;--- 2nd msg starts here</span>
<a href="#l19.414"></a><span id="l19.414">       // Subject: How are you</span>
<a href="#l19.415"></a><span id="l19.415">       // . . .(more headers)</span>
<a href="#l19.416"></a><span id="l19.416">       //</span>
<a href="#l19.417"></a><span id="l19.417">       // In this case, the 1st msg is not recognized as a msg (it's skipped)</span>
<a href="#l19.418"></a><span id="l19.418">       // when you open the folder.</span>
<a href="#l19.419"></a><span id="l19.419" class="difflineminus">-      rv = outputStream-&gt;Write( &quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l19.420"></a><span id="l19.420" class="difflineplus">+      rv = outputStream-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l19.421"></a><span id="l19.421"> </span>
<a href="#l19.422"></a><span id="l19.422">       if (NS_FAILED(rv))</span>
<a href="#l19.423"></a><span id="l19.423">         break;</span>
<a href="#l19.424"></a><span id="l19.424"> </span>
<a href="#l19.425"></a><span id="l19.425">       msgCount++;</span>
<a href="#l19.426"></a><span id="l19.426">       if (pCount)</span>
<a href="#l19.427"></a><span id="l19.427">         *pCount = msgCount;</span>
<a href="#l19.428"></a><span id="l19.428">       if (pBytesDone)</span>
<a href="#l19.429"></a><span id="l19.429">         *pBytesDone = didBytes;</span>
<a href="#l19.430"></a><span id="l19.430">     }</span>
<a href="#l19.431"></a><span id="l19.431">     else {</span>
<a href="#l19.432"></a><span id="l19.432">       // Error reading message, should this be logged???</span>
<a href="#l19.433"></a><span id="l19.433" class="difflineminus">-      IMPORT_LOG2( &quot;Error reading message from %s at 0x%lx\n&quot;, NS_LossyConvertUTF16toASCII(name.get()), pIndex[i]);</span>
<a href="#l19.434"></a><span id="l19.434" class="difflineplus">+      IMPORT_LOG2(&quot;Error reading message from %s at 0x%lx\n&quot;, NS_LossyConvertUTF16toASCII(name.get()), pIndex[i]);</span>
<a href="#l19.435"></a><span id="l19.435">       *pAbort = true;</span>
<a href="#l19.436"></a><span id="l19.436">     }</span>
<a href="#l19.437"></a><span id="l19.437">   }</span>
<a href="#l19.438"></a><span id="l19.438"> </span>
<a href="#l19.439"></a><span id="l19.439">   delete [] pBuffer;</span>
<a href="#l19.440"></a><span id="l19.440">   delete [] pFlags;</span>
<a href="#l19.441"></a><span id="l19.441">   delete [] pTime;</span>
<a href="#l19.442"></a><span id="l19.442"> </span>
<a href="#l19.443"></a><span id="l19.443">   if (NS_FAILED(rv))</span>
<a href="#l19.444"></a><span id="l19.444">     *pAbort = true;</span>
<a href="#l19.445"></a><span id="l19.445"> </span>
<a href="#l19.446"></a><span id="l19.446" class="difflineminus">-  return( rv);</span>
<a href="#l19.447"></a><span id="l19.447" class="difflineplus">+  return rv;</span>
<a href="#l19.448"></a><span id="l19.448"> }</span>
<a href="#l19.449"></a><span id="l19.449"> </span>
<a href="#l19.450"></a><span id="l19.450"> </span>
<a href="#l19.451"></a><span id="l19.451"> /*</span>
<a href="#l19.452"></a><span id="l19.452">   A message index record consists of:</span>
<a href="#l19.453"></a><span id="l19.453">   4 byte marker - matches record offset</span>
<a href="#l19.454"></a><span id="l19.454">   4 bytes size - size of data after this header</span>
<a href="#l19.455"></a><span id="l19.455">   2 bytes header length - not dependable</span>
<a href="#l19.456"></a><span id="l19.456" class="difflineat">@@ -540,17 +541,17 @@ nsresult nsOE5File::ImportMailbox( PRUin</span>
<a href="#l19.457"></a><span id="l19.457">   0x0D - offset to from</span>
<a href="#l19.458"></a><span id="l19.458">   0x0E - offset to from addresses</span>
<a href="#l19.459"></a><span id="l19.459">   0x13 - offset to to name</span>
<a href="#l19.460"></a><span id="l19.460">   0x45 - offset to to address &lt;----correct --&gt; 0x14</span>
<a href="#l19.461"></a><span id="l19.461">   0x80 - msgId &lt;-correction-&gt; 0x07 addr to msg id</span>
<a href="#l19.462"></a><span id="l19.462">   0x84 - direct text offset, direct pointer to message text</span>
<a href="#l19.463"></a><span id="l19.463"> */</span>
<a href="#l19.464"></a><span id="l19.464"> </span>
<a href="#l19.465"></a><span id="l19.465" class="difflineminus">-void nsOE5File::ConvertIndex( nsIInputStream *pFile, char *pBuffer,</span>
<a href="#l19.466"></a><span id="l19.466" class="difflineplus">+void nsOE5File::ConvertIndex(nsIInputStream *pFile, char *pBuffer,</span>
<a href="#l19.467"></a><span id="l19.467">                               PRUint32 *pIndex, PRUint32 size,</span>
<a href="#l19.468"></a><span id="l19.468">                               PRUint32 *pFlags, PRUint64 *pTime)</span>
<a href="#l19.469"></a><span id="l19.469"> {</span>
<a href="#l19.470"></a><span id="l19.470">   // for each index record, get the actual message offset!  If there is a</span>
<a href="#l19.471"></a><span id="l19.471">   // problem just record the message offset as 0 and the message reading code</span>
<a href="#l19.472"></a><span id="l19.472">   // can log that error information.</span>
<a href="#l19.473"></a><span id="l19.473">   // XXXTODO- above error reporting is not done</span>
<a href="#l19.474"></a><span id="l19.474"> </span>
<a href="#l19.475"></a><span id="l19.475" class="difflineat">@@ -566,75 +567,75 @@ void nsOE5File::ConvertIndex( nsIInputSt</span>
<a href="#l19.476"></a><span id="l19.476">   PRUint32  flags;</span>
<a href="#l19.477"></a><span id="l19.477">   PRUint64  time;</span>
<a href="#l19.478"></a><span id="l19.478">   PRUint32  dataStart;</span>
<a href="#l19.479"></a><span id="l19.479"> </span>
<a href="#l19.480"></a><span id="l19.480">   for (PRUint32 i = 0; i &lt; size; i++) {</span>
<a href="#l19.481"></a><span id="l19.481">     offset = 0;</span>
<a href="#l19.482"></a><span id="l19.482">     flags = 0;</span>
<a href="#l19.483"></a><span id="l19.483">     time = 0;</span>
<a href="#l19.484"></a><span id="l19.484" class="difflineminus">-    if (ReadBytes( pFile, recordHead, pIndex[i], 12)) {</span>
<a href="#l19.485"></a><span id="l19.485" class="difflineminus">-      memcpy( &amp;marker, recordHead, 4);</span>
<a href="#l19.486"></a><span id="l19.486" class="difflineminus">-      memcpy( &amp;recordSize, recordHead + 4, 4);</span>
<a href="#l19.487"></a><span id="l19.487" class="difflineplus">+    if (ReadBytes(pFile, recordHead, pIndex[i], 12)) {</span>
<a href="#l19.488"></a><span id="l19.488" class="difflineplus">+      memcpy(&amp;marker, recordHead, 4);</span>
<a href="#l19.489"></a><span id="l19.489" class="difflineplus">+      memcpy(&amp;recordSize, recordHead + 4, 4);</span>
<a href="#l19.490"></a><span id="l19.490">       numAttrs = (PRUint32) recordHead[10];</span>
<a href="#l19.491"></a><span id="l19.491">       if (marker == pIndex[i] &amp;&amp; numAttrs &lt;= kMaxAttrCount) {</span>
<a href="#l19.492"></a><span id="l19.492">         dataStart = pIndex[i] + 12 + (numAttrs * 4);</span>
<a href="#l19.493"></a><span id="l19.493" class="difflineminus">-        if (ReadBytes( pFile, pBuffer, kDontSeek, numAttrs * 4)) {</span>
<a href="#l19.494"></a><span id="l19.494" class="difflineplus">+        if (ReadBytes(pFile, pBuffer, kDontSeek, numAttrs * 4)) {</span>
<a href="#l19.495"></a><span id="l19.495">           attrOffset = 0;</span>
<a href="#l19.496"></a><span id="l19.496">           for (attrIndex = 0; attrIndex &lt; numAttrs; attrIndex++, attrOffset += 4) {</span>
<a href="#l19.497"></a><span id="l19.497">             tag = (PRUint8) pBuffer[attrOffset];</span>
<a href="#l19.498"></a><span id="l19.498">             if (tag == (PRUint8) 0x84) {</span>
<a href="#l19.499"></a><span id="l19.499">               tagData = 0;</span>
<a href="#l19.500"></a><span id="l19.500" class="difflineminus">-              memcpy( &amp;tagData, pBuffer + attrOffset + 1, 3);</span>
<a href="#l19.501"></a><span id="l19.501" class="difflineplus">+              memcpy(&amp;tagData, pBuffer + attrOffset + 1, 3);</span>
<a href="#l19.502"></a><span id="l19.502">               offset = tagData;</span>
<a href="#l19.503"></a><span id="l19.503">             }</span>
<a href="#l19.504"></a><span id="l19.504">             else if (tag == (PRUint8) 0x04) {</span>
<a href="#l19.505"></a><span id="l19.505">               tagData = 0;</span>
<a href="#l19.506"></a><span id="l19.506" class="difflineminus">-              memcpy( &amp;tagData, pBuffer + attrOffset + 1, 3);</span>
<a href="#l19.507"></a><span id="l19.507" class="difflineplus">+              memcpy(&amp;tagData, pBuffer + attrOffset + 1, 3);</span>
<a href="#l19.508"></a><span id="l19.508">               ReadBytes(pFile, &amp;offset, dataStart + tagData, 4);</span>
<a href="#l19.509"></a><span id="l19.509">             }</span>
<a href="#l19.510"></a><span id="l19.510">             else if (tag == (PRUint8) 0x81) {</span>
<a href="#l19.511"></a><span id="l19.511">               tagData = 0;</span>
<a href="#l19.512"></a><span id="l19.512" class="difflineminus">-              memcpy( &amp;tagData, pBuffer + attrOffset +1, 3);</span>
<a href="#l19.513"></a><span id="l19.513" class="difflineplus">+              memcpy(&amp;tagData, pBuffer + attrOffset +1, 3);</span>
<a href="#l19.514"></a><span id="l19.514">               flags = tagData;</span>
<a href="#l19.515"></a><span id="l19.515">             }</span>
<a href="#l19.516"></a><span id="l19.516">             else if (tag == (PRUint8) 0x01) {</span>
<a href="#l19.517"></a><span id="l19.517">               tagData = 0;</span>
<a href="#l19.518"></a><span id="l19.518" class="difflineminus">-              memcpy( &amp;tagData, pBuffer + attrOffset +1, 3);</span>
<a href="#l19.519"></a><span id="l19.519" class="difflineplus">+              memcpy(&amp;tagData, pBuffer + attrOffset +1, 3);</span>
<a href="#l19.520"></a><span id="l19.520">               ReadBytes(pFile, &amp;flags, dataStart + tagData, 4);</span>
<a href="#l19.521"></a><span id="l19.521">             }</span>
<a href="#l19.522"></a><span id="l19.522">             else if (tag == (PRUint8) 0x02) {</span>
<a href="#l19.523"></a><span id="l19.523">               tagData = 0;</span>
<a href="#l19.524"></a><span id="l19.524" class="difflineminus">-              memcpy( &amp;tagData, pBuffer + attrOffset +1, 3);</span>
<a href="#l19.525"></a><span id="l19.525" class="difflineplus">+              memcpy(&amp;tagData, pBuffer + attrOffset +1, 3);</span>
<a href="#l19.526"></a><span id="l19.526">               ReadBytes(pFile, &amp;time, dataStart + tagData, 4);</span>
<a href="#l19.527"></a><span id="l19.527">             }</span>
<a href="#l19.528"></a><span id="l19.528">           }</span>
<a href="#l19.529"></a><span id="l19.529">         }</span>
<a href="#l19.530"></a><span id="l19.530">       }</span>
<a href="#l19.531"></a><span id="l19.531">     }</span>
<a href="#l19.532"></a><span id="l19.532">     pIndex[i] = offset;</span>
<a href="#l19.533"></a><span id="l19.533">     pFlags[i] = flags;</span>
<a href="#l19.534"></a><span id="l19.534">     pTime[i] = time;</span>
<a href="#l19.535"></a><span id="l19.535">   }</span>
<a href="#l19.536"></a><span id="l19.536"> }</span>
<a href="#l19.537"></a><span id="l19.537"> </span>
<a href="#l19.538"></a><span id="l19.538"> </span>
<a href="#l19.539"></a><span id="l19.539" class="difflineminus">-bool nsOE5File::ReadBytes( nsIInputStream *stream, void *pBuffer, PRUint32 offset, PRUint32 bytes)</span>
<a href="#l19.540"></a><span id="l19.540" class="difflineplus">+bool nsOE5File::ReadBytes(nsIInputStream *stream, void *pBuffer, PRUint32 offset, PRUint32 bytes)</span>
<a href="#l19.541"></a><span id="l19.541"> {</span>
<a href="#l19.542"></a><span id="l19.542">   nsresult  rv;</span>
<a href="#l19.543"></a><span id="l19.543"> </span>
<a href="#l19.544"></a><span id="l19.544">   nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(stream);</span>
<a href="#l19.545"></a><span id="l19.545">   if (offset != kDontSeek) {</span>
<a href="#l19.546"></a><span id="l19.546">     rv = seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, offset);</span>
<a href="#l19.547"></a><span id="l19.547" class="difflineminus">-    if (NS_FAILED( rv))</span>
<a href="#l19.548"></a><span id="l19.548" class="difflineminus">-      return( false);</span>
<a href="#l19.549"></a><span id="l19.549" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l19.550"></a><span id="l19.550" class="difflineplus">+      return false;</span>
<a href="#l19.551"></a><span id="l19.551">   }</span>
<a href="#l19.552"></a><span id="l19.552"> </span>
<a href="#l19.553"></a><span id="l19.553">   if (!bytes)</span>
<a href="#l19.554"></a><span id="l19.554" class="difflineminus">-    return( true);</span>
<a href="#l19.555"></a><span id="l19.555" class="difflineplus">+    return true;</span>
<a href="#l19.556"></a><span id="l19.556"> </span>
<a href="#l19.557"></a><span id="l19.557">   PRUint32  cntRead;</span>
<a href="#l19.558"></a><span id="l19.558">   char *  pReadTo = (char *)pBuffer;</span>
<a href="#l19.559"></a><span id="l19.559">   rv = stream-&gt;Read(pReadTo, bytes, &amp;cntRead);</span>
<a href="#l19.560"></a><span id="l19.560">   return NS_SUCCEEDED(rv) &amp;&amp; cntRead == bytes;</span>
<a href="#l19.561"></a><span id="l19.561"> </span>
<a href="#l19.562"></a><span id="l19.562"> }</span>
<a href="#l19.563"></a><span id="l19.563"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOE5File.h</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOE5File.h</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -43,23 +43,23 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #include &lt;windows.h&gt;</span>
<a href="#l20.5"></a><span id="l20.5"> </span>
<a href="#l20.6"></a><span id="l20.6"> class nsIInputStream;</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8"> class nsOE5File</span>
<a href="#l20.9"></a><span id="l20.9"> {</span>
<a href="#l20.10"></a><span id="l20.10"> public:</span>
<a href="#l20.11"></a><span id="l20.11">     /* pFile must already be open for reading. */</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-  static bool    VerifyLocalMailFile( nsIFile *pFile);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+  static bool    VerifyLocalMailFile(nsIFile *pFile);</span>
<a href="#l20.14"></a><span id="l20.14">     /* pFile must NOT be open for reading   */</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-  static bool    IsLocalMailFile( nsIFile *pFile);</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+  static bool    IsLocalMailFile(nsIFile *pFile);</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-  static bool    ReadIndex( nsIInputStream *pFile, PRUint32 **ppIndex, PRUint32 *pSize);</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+  static bool    ReadIndex(nsIInputStream *pFile, PRUint32 **ppIndex, PRUint32 *pSize);</span>
<a href="#l20.20"></a><span id="l20.20"> </span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-  static nsresult  ImportMailbox( PRUint32 *pBytesDone, bool *pAbort, nsString&amp; name, nsIFile *inFile, nsIFile *pDestination, PRUint32 *pCount);</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+  static nsresult  ImportMailbox(PRUint32 *pBytesDone, bool *pAbort, nsString&amp; name, nsIFile *inFile, nsIFile *pDestination, PRUint32 *pCount);</span>
<a href="#l20.23"></a><span id="l20.23"> </span>
<a href="#l20.24"></a><span id="l20.24">   static void FileTimeToPRTime(const FILETIME *filetime, PRTime *prtm);</span>
<a href="#l20.25"></a><span id="l20.25"> </span>
<a href="#l20.26"></a><span id="l20.26"> private:</span>
<a href="#l20.27"></a><span id="l20.27">   typedef struct {</span>
<a href="#l20.28"></a><span id="l20.28">     PRUint32 *  pIndex;</span>
<a href="#l20.29"></a><span id="l20.29">     PRUint32  count;</span>
<a href="#l20.30"></a><span id="l20.30">     PRUint32  alloc;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOEAddressIterator.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOEAddressIterator.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -105,68 +105,68 @@ static MAPIFields  gMapiFields[] = {</span>
<a href="#l21.4"></a><span id="l21.4">   { 13, kNoMultiLine, PR_HOME_ADDRESS_CITY},</span>
<a href="#l21.5"></a><span id="l21.5">   { 16, kNoMultiLine, PR_HOME_ADDRESS_COUNTRY},</span>
<a href="#l21.6"></a><span id="l21.6">   { 15, kNoMultiLine, PR_HOME_ADDRESS_POSTAL_CODE},</span>
<a href="#l21.7"></a><span id="l21.7">   { 14, kNoMultiLine, PR_HOME_ADDRESS_STATE_OR_PROVINCE},</span>
<a href="#l21.8"></a><span id="l21.8">   { 11, 12, PR_HOME_ADDRESS_STREET},</span>
<a href="#l21.9"></a><span id="l21.9">   { 24, kNoMultiLine, PR_DEPARTMENT_NAME}</span>
<a href="#l21.10"></a><span id="l21.10"> };</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-nsOEAddressIterator::nsOEAddressIterator( CWAB *pWab, nsIAddrDatabase *database)</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+nsOEAddressIterator::nsOEAddressIterator(CWAB *pWab, nsIAddrDatabase *database)</span>
<a href="#l21.14"></a><span id="l21.14"> {</span>
<a href="#l21.15"></a><span id="l21.15">   m_pWab = pWab;</span>
<a href="#l21.16"></a><span id="l21.16">   m_database = database;</span>
<a href="#l21.17"></a><span id="l21.17">   m_listRows.Init();</span>
<a href="#l21.18"></a><span id="l21.18"> }</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20"> nsOEAddressIterator::~nsOEAddressIterator()</span>
<a href="#l21.21"></a><span id="l21.21"> {</span>
<a href="#l21.22"></a><span id="l21.22"> }</span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-nsresult nsOEAddressIterator::EnumUser( const PRUnichar * pName, LPENTRYID pEid, ULONG cbEid)</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+nsresult nsOEAddressIterator::EnumUser(const PRUnichar * pName, LPENTRYID pEid, ULONG cbEid)</span>
<a href="#l21.26"></a><span id="l21.26"> {</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-  IMPORT_LOG1( &quot;User: %S\n&quot;, pName);</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+  IMPORT_LOG1(&quot;User: %S\n&quot;, pName);</span>
<a href="#l21.29"></a><span id="l21.29">   nsresult   rv = NS_OK;</span>
<a href="#l21.30"></a><span id="l21.30">   </span>
<a href="#l21.31"></a><span id="l21.31">   if (m_database) {</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-    LPMAILUSER  pUser = m_pWab-&gt;GetUser( cbEid, pEid);</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+    LPMAILUSER  pUser = m_pWab-&gt;GetUser(cbEid, pEid);</span>
<a href="#l21.34"></a><span id="l21.34">     if (pUser) {</span>
<a href="#l21.35"></a><span id="l21.35">       // Get a new row from the database!</span>
<a href="#l21.36"></a><span id="l21.36">       nsCOMPtr &lt;nsIMdbRow&gt; newRow;</span>
<a href="#l21.37"></a><span id="l21.37">       rv = m_database-&gt;GetNewRow(getter_AddRefs(newRow));</span>
<a href="#l21.38"></a><span id="l21.38">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-      if (newRow &amp;&amp; BuildCard( pName, newRow, pUser))</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+      if (newRow &amp;&amp; BuildCard(pName, newRow, pUser))</span>
<a href="#l21.41"></a><span id="l21.41">       {</span>
<a href="#l21.42"></a><span id="l21.42">         rv = m_database-&gt;AddCardRowToDB(newRow);</span>
<a href="#l21.43"></a><span id="l21.43">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-        IMPORT_LOG0( &quot;* Added entry to address book database\n&quot;);</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+        IMPORT_LOG0(&quot;* Added entry to address book database\n&quot;);</span>
<a href="#l21.46"></a><span id="l21.46">         nsString  eMail;</span>
<a href="#l21.47"></a><span id="l21.47"> </span>
<a href="#l21.48"></a><span id="l21.48" class="difflineminus">-        LPSPropValue  pProp = m_pWab-&gt;GetUserProperty( pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+        LPSPropValue  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l21.50"></a><span id="l21.50">         if (pProp) </span>
<a href="#l21.51"></a><span id="l21.51">         {</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-          m_pWab-&gt;GetValueString( pProp, eMail);</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineminus">-          SanitizeValue( eMail);</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-          m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+          m_pWab-&gt;GetValueString(pProp, eMail);</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+          SanitizeValue(eMail);</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+          m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l21.58"></a><span id="l21.58">           m_listRows.Put(eMail, newRow);</span>
<a href="#l21.59"></a><span id="l21.59">         }</span>
<a href="#l21.60"></a><span id="l21.60">       }</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineminus">-      m_pWab-&gt;ReleaseUser( pUser);</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+      m_pWab-&gt;ReleaseUser(pUser);</span>
<a href="#l21.63"></a><span id="l21.63">     }</span>
<a href="#l21.64"></a><span id="l21.64">   }  </span>
<a href="#l21.65"></a><span id="l21.65">   </span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-  return(rv);</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+  return rv;</span>
<a href="#l21.68"></a><span id="l21.68"> }</span>
<a href="#l21.69"></a><span id="l21.69"> </span>
<a href="#l21.70"></a><span id="l21.70"> void nsOEAddressIterator::FindListRow(nsString &amp;eMail, nsIMdbRow **cardRow)</span>
<a href="#l21.71"></a><span id="l21.71"> {</span>
<a href="#l21.72"></a><span id="l21.72">   m_listRows.Get(eMail,cardRow);</span>
<a href="#l21.73"></a><span id="l21.73"> }</span>
<a href="#l21.74"></a><span id="l21.74"> </span>
<a href="#l21.75"></a><span id="l21.75" class="difflineminus">-nsresult nsOEAddressIterator::EnumList( const PRUnichar * pName, LPENTRYID pEid, ULONG cbEid, LPMAPITABLE lpTable)</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+nsresult nsOEAddressIterator::EnumList(const PRUnichar * pName, LPENTRYID pEid, ULONG cbEid, LPMAPITABLE lpTable)</span>
<a href="#l21.77"></a><span id="l21.77"> {</span>
<a href="#l21.78"></a><span id="l21.78">   // If no name provided then we're done.</span>
<a href="#l21.79"></a><span id="l21.79">   if (!pName || !(*pName))</span>
<a href="#l21.80"></a><span id="l21.80">     return NS_OK;</span>
<a href="#l21.81"></a><span id="l21.81"> </span>
<a href="#l21.82"></a><span id="l21.82">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l21.83"></a><span id="l21.83">   HRESULT hr = E_FAIL;</span>
<a href="#l21.84"></a><span id="l21.84">   // Make sure we have db to work with.</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineat">@@ -187,19 +187,19 @@ nsresult nsOEAddressIterator::EnumList( </span>
<a href="#l21.86"></a><span id="l21.86">   LPSRowSet   lpRowAB = NULL;</span>
<a href="#l21.87"></a><span id="l21.87">   ULONG        lpcbEID = 0;</span>
<a href="#l21.88"></a><span id="l21.88">   LPENTRYID   lpEID = NULL;</span>
<a href="#l21.89"></a><span id="l21.89">   ULONG        rowCount = 0;</span>
<a href="#l21.90"></a><span id="l21.90">   int         cNumRows = 0;</span>
<a href="#l21.91"></a><span id="l21.91">   int         numListElems = 0;</span>
<a href="#l21.92"></a><span id="l21.92">   nsAutoString    uniStr;</span>
<a href="#l21.93"></a><span id="l21.93"> </span>
<a href="#l21.94"></a><span id="l21.94" class="difflineminus">-  hr = lpTable-&gt;GetRowCount( 0, &amp;rowCount);</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineplus">+  hr = lpTable-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l21.96"></a><span id="l21.96">   //</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineminus">-  hr = lpTable-&gt;SeekRow( BOOKMARK_BEGINNING, 0, NULL );</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineplus">+  hr = lpTable-&gt;SeekRow(BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l21.99"></a><span id="l21.99"> </span>
<a href="#l21.100"></a><span id="l21.100">   if(HR_FAILED(hr))</span>
<a href="#l21.101"></a><span id="l21.101">     return NS_ERROR_FAILURE;</span>
<a href="#l21.102"></a><span id="l21.102"> </span>
<a href="#l21.103"></a><span id="l21.103">   // Read all the rows of the table one by one</span>
<a href="#l21.104"></a><span id="l21.104">   do </span>
<a href="#l21.105"></a><span id="l21.105">   {</span>
<a href="#l21.106"></a><span id="l21.106">     hr = lpTable-&gt;QueryRows(1, 0, &amp;lpRowAB);</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineat">@@ -217,70 +217,70 @@ nsresult nsOEAddressIterator::EnumList( </span>
<a href="#l21.108"></a><span id="l21.108">         ULONG cbEID = lpRowAB-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l21.109"></a><span id="l21.109">       </span>
<a href="#l21.110"></a><span id="l21.110">         // There are 2 kinds of objects - the MAPI_MAILUSER contact object</span>
<a href="#l21.111"></a><span id="l21.111">         // and the MAPI_DISTLIST contact object</span>
<a href="#l21.112"></a><span id="l21.112">         // For distribution lists, we will only consider MAILUSER</span>
<a href="#l21.113"></a><span id="l21.113">         // objects since we can't nest lists yet.</span>
<a href="#l21.114"></a><span id="l21.114">         if(lpRowAB-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.l == MAPI_MAILUSER)</span>
<a href="#l21.115"></a><span id="l21.115">         {</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineminus">-          LPMAILUSER  pUser = m_pWab-&gt;GetUser( cbEID, lpEID);</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineminus">-          LPSPropValue pProp = m_pWab-&gt;GetUserProperty( pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineminus">-    nsString  eMail;</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineplus">+          LPMAILUSER  pUser = m_pWab-&gt;GetUser(cbEID, lpEID);</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineplus">+          LPSPropValue pProp = m_pWab-&gt;GetUserProperty(pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineplus">+          nsString  eMail;</span>
<a href="#l21.122"></a><span id="l21.122"> </span>
<a href="#l21.123"></a><span id="l21.123">           nsCOMPtr &lt;nsIMdbRow&gt; cardRow;</span>
<a href="#l21.124"></a><span id="l21.124"> </span>
<a href="#l21.125"></a><span id="l21.125" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, eMail);</span>
<a href="#l21.126"></a><span id="l21.126" class="difflineminus">-    SanitizeValue( eMail);</span>
<a href="#l21.127"></a><span id="l21.127" class="difflineplus">+          m_pWab-&gt;GetValueString(pProp, eMail);</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineplus">+          SanitizeValue(eMail);</span>
<a href="#l21.129"></a><span id="l21.129">           FindListRow(eMail, getter_AddRefs(cardRow));</span>
<a href="#l21.130"></a><span id="l21.130">           if (cardRow)</span>
<a href="#l21.131"></a><span id="l21.131">           {</span>
<a href="#l21.132"></a><span id="l21.132">             nsCOMPtr &lt;nsIAbCard&gt; userCard;</span>
<a href="#l21.133"></a><span id="l21.133">             nsCOMPtr &lt;nsIAbCard&gt; newCard;</span>
<a href="#l21.134"></a><span id="l21.134">             userCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l21.135"></a><span id="l21.135">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.136"></a><span id="l21.136">             m_database-&gt;InitCardFromRow(userCard,cardRow);</span>
<a href="#l21.137"></a><span id="l21.137"> </span>
<a href="#l21.138"></a><span id="l21.138">             m_database-&gt;AddListCardColumnsToRow(userCard, listRow, ++numListElems,</span>
<a href="#l21.139"></a><span id="l21.139">                                                 getter_AddRefs(newCard),</span>
<a href="#l21.140"></a><span id="l21.140">                                                 true, nsnull, nsnull);</span>
<a href="#l21.141"></a><span id="l21.141">           }</span>
<a href="#l21.142"></a><span id="l21.142" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l21.143"></a><span id="l21.143" class="difflineminus">-          m_pWab-&gt;ReleaseUser( pUser);</span>
<a href="#l21.144"></a><span id="l21.144" class="difflineplus">+          m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l21.145"></a><span id="l21.145" class="difflineplus">+          m_pWab-&gt;ReleaseUser(pUser);</span>
<a href="#l21.146"></a><span id="l21.146">         }</span>
<a href="#l21.147"></a><span id="l21.147">       }</span>
<a href="#l21.148"></a><span id="l21.148" class="difflineminus">-      m_pWab-&gt;FreeProws(lpRowAB );    </span>
<a href="#l21.149"></a><span id="l21.149" class="difflineplus">+      m_pWab-&gt;FreeProws(lpRowAB);    </span>
<a href="#l21.150"></a><span id="l21.150">     }</span>
<a href="#l21.151"></a><span id="l21.151">   } while (SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRowAB);</span>
<a href="#l21.152"></a><span id="l21.152"> </span>
<a href="#l21.153"></a><span id="l21.153">   m_database-&gt;SetListAddressTotal(listRow, numListElems);</span>
<a href="#l21.154"></a><span id="l21.154">   return rv;</span>
<a href="#l21.155"></a><span id="l21.155"> }</span>
<a href="#l21.156"></a><span id="l21.156"> </span>
<a href="#l21.157"></a><span id="l21.157" class="difflineminus">-void nsOEAddressIterator::SanitizeValue( nsString&amp; val)</span>
<a href="#l21.158"></a><span id="l21.158" class="difflineplus">+void nsOEAddressIterator::SanitizeValue(nsString&amp; val)</span>
<a href="#l21.159"></a><span id="l21.159"> {</span>
<a href="#l21.160"></a><span id="l21.160">   MsgReplaceSubstring(val, NS_LITERAL_STRING(&quot;\r\n&quot;), NS_LITERAL_STRING(&quot;, &quot;));</span>
<a href="#l21.161"></a><span id="l21.161">   MsgReplaceChar(val, &quot;\r\n&quot;, ',');</span>
<a href="#l21.162"></a><span id="l21.162"> }</span>
<a href="#l21.163"></a><span id="l21.163"> </span>
<a href="#l21.164"></a><span id="l21.164" class="difflineminus">-void nsOEAddressIterator::SplitString( nsString&amp; val1, nsString&amp; val2)</span>
<a href="#l21.165"></a><span id="l21.165" class="difflineplus">+void nsOEAddressIterator::SplitString(nsString&amp; val1, nsString&amp; val2)</span>
<a href="#l21.166"></a><span id="l21.166"> {</span>
<a href="#l21.167"></a><span id="l21.167">   // Find the last line if there is more than one!</span>
<a href="#l21.168"></a><span id="l21.168" class="difflineminus">-  PRInt32 idx = val1.RFind( &quot;\x0D\x0A&quot;);</span>
<a href="#l21.169"></a><span id="l21.169" class="difflineplus">+  PRInt32 idx = val1.RFind(&quot;\x0D\x0A&quot;);</span>
<a href="#l21.170"></a><span id="l21.170">   PRInt32  cnt = 2;</span>
<a href="#l21.171"></a><span id="l21.171">   if (idx == -1) {</span>
<a href="#l21.172"></a><span id="l21.172">     cnt = 1;</span>
<a href="#l21.173"></a><span id="l21.173" class="difflineminus">-    idx = val1.RFindChar( 13);</span>
<a href="#l21.174"></a><span id="l21.174" class="difflineplus">+    idx = val1.RFindChar(13);</span>
<a href="#l21.175"></a><span id="l21.175">   }</span>
<a href="#l21.176"></a><span id="l21.176">   if (idx == -1)</span>
<a href="#l21.177"></a><span id="l21.177" class="difflineminus">-    idx= val1.RFindChar( 10);</span>
<a href="#l21.178"></a><span id="l21.178" class="difflineplus">+    idx= val1.RFindChar(10);</span>
<a href="#l21.179"></a><span id="l21.179">   if (idx != -1) {</span>
<a href="#l21.180"></a><span id="l21.180">     val2 = Substring(val1, idx + cnt);</span>
<a href="#l21.181"></a><span id="l21.181">     val1.SetLength(idx);</span>
<a href="#l21.182"></a><span id="l21.182" class="difflineminus">-    SanitizeValue( val1);</span>
<a href="#l21.183"></a><span id="l21.183" class="difflineplus">+    SanitizeValue(val1);</span>
<a href="#l21.184"></a><span id="l21.184">   }</span>
<a href="#l21.185"></a><span id="l21.185"> }</span>
<a href="#l21.186"></a><span id="l21.186"> </span>
<a href="#l21.187"></a><span id="l21.187"> void nsOEAddressIterator::SetBirthDay(nsIMdbRow *newRow, PRTime&amp; birthDay)</span>
<a href="#l21.188"></a><span id="l21.188"> {</span>
<a href="#l21.189"></a><span id="l21.189">   PRExplodedTime exploded;</span>
<a href="#l21.190"></a><span id="l21.190">   PR_ExplodeTime(birthDay, PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l21.191"></a><span id="l21.191"> </span>
<a href="#l21.192"></a><span id="l21.192" class="difflineat">@@ -288,148 +288,142 @@ void nsOEAddressIterator::SetBirthDay(ns</span>
<a href="#l21.193"></a><span id="l21.193">   PR_snprintf(stringValue, sizeof(stringValue), &quot;%04d&quot;, exploded.tm_year);</span>
<a href="#l21.194"></a><span id="l21.194">   m_database-&gt;AddBirthYear(newRow, stringValue);</span>
<a href="#l21.195"></a><span id="l21.195">   PR_snprintf(stringValue, sizeof(stringValue), &quot;%02d&quot;, exploded.tm_month + 1);</span>
<a href="#l21.196"></a><span id="l21.196">   m_database-&gt;AddBirthMonth(newRow, stringValue);</span>
<a href="#l21.197"></a><span id="l21.197">   PR_snprintf(stringValue, sizeof(stringValue), &quot;%02d&quot;, exploded.tm_mday);</span>
<a href="#l21.198"></a><span id="l21.198">   m_database-&gt;AddBirthDay(newRow, stringValue);</span>
<a href="#l21.199"></a><span id="l21.199"> }</span>
<a href="#l21.200"></a><span id="l21.200"> </span>
<a href="#l21.201"></a><span id="l21.201" class="difflineminus">-bool nsOEAddressIterator::BuildCard( const PRUnichar * pName, nsIMdbRow *newRow, LPMAILUSER pUser)</span>
<a href="#l21.202"></a><span id="l21.202" class="difflineplus">+bool nsOEAddressIterator::BuildCard(const PRUnichar * pName, nsIMdbRow *newRow, LPMAILUSER pUser)</span>
<a href="#l21.203"></a><span id="l21.203"> {</span>
<a href="#l21.204"></a><span id="l21.204">   </span>
<a href="#l21.205"></a><span id="l21.205">   nsString    lastName;</span>
<a href="#l21.206"></a><span id="l21.206">   nsString    firstName;</span>
<a href="#l21.207"></a><span id="l21.207">   nsString    eMail;</span>
<a href="#l21.208"></a><span id="l21.208">   nsString    nickName;</span>
<a href="#l21.209"></a><span id="l21.209">   nsString    middleName;</span>
<a href="#l21.210"></a><span id="l21.210">   PRTime      birthDay = 0;</span>
<a href="#l21.211"></a><span id="l21.211">   </span>
<a href="#l21.212"></a><span id="l21.212" class="difflineminus">-  LPSPropValue  pProp = m_pWab-&gt;GetUserProperty( pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l21.213"></a><span id="l21.213" class="difflineplus">+  LPSPropValue  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l21.214"></a><span id="l21.214">   if (pProp) {</span>
<a href="#l21.215"></a><span id="l21.215" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, eMail);</span>
<a href="#l21.216"></a><span id="l21.216" class="difflineminus">-    SanitizeValue( eMail);</span>
<a href="#l21.217"></a><span id="l21.217" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l21.218"></a><span id="l21.218" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, eMail);</span>
<a href="#l21.219"></a><span id="l21.219" class="difflineplus">+    SanitizeValue(eMail);</span>
<a href="#l21.220"></a><span id="l21.220" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l21.221"></a><span id="l21.221">   }</span>
<a href="#l21.222"></a><span id="l21.222" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty( pUser, PR_GIVEN_NAME);</span>
<a href="#l21.223"></a><span id="l21.223" class="difflineplus">+  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_GIVEN_NAME);</span>
<a href="#l21.224"></a><span id="l21.224">   if (pProp) {</span>
<a href="#l21.225"></a><span id="l21.225" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, firstName);</span>
<a href="#l21.226"></a><span id="l21.226" class="difflineminus">-    SanitizeValue( firstName);</span>
<a href="#l21.227"></a><span id="l21.227" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l21.228"></a><span id="l21.228" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, firstName);</span>
<a href="#l21.229"></a><span id="l21.229" class="difflineplus">+    SanitizeValue(firstName);</span>
<a href="#l21.230"></a><span id="l21.230" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l21.231"></a><span id="l21.231">   }</span>
<a href="#l21.232"></a><span id="l21.232" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty( pUser, PR_SURNAME);</span>
<a href="#l21.233"></a><span id="l21.233" class="difflineplus">+  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_SURNAME);</span>
<a href="#l21.234"></a><span id="l21.234">   if (pProp) {</span>
<a href="#l21.235"></a><span id="l21.235" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, lastName);</span>
<a href="#l21.236"></a><span id="l21.236" class="difflineminus">-    SanitizeValue( lastName);</span>
<a href="#l21.237"></a><span id="l21.237" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l21.238"></a><span id="l21.238" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, lastName);</span>
<a href="#l21.239"></a><span id="l21.239" class="difflineplus">+    SanitizeValue(lastName);</span>
<a href="#l21.240"></a><span id="l21.240" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l21.241"></a><span id="l21.241">   }</span>
<a href="#l21.242"></a><span id="l21.242" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty( pUser, PR_MIDDLE_NAME);</span>
<a href="#l21.243"></a><span id="l21.243" class="difflineplus">+  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_MIDDLE_NAME);</span>
<a href="#l21.244"></a><span id="l21.244">   if (pProp) {</span>
<a href="#l21.245"></a><span id="l21.245" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, middleName);</span>
<a href="#l21.246"></a><span id="l21.246" class="difflineminus">-    SanitizeValue( middleName);</span>
<a href="#l21.247"></a><span id="l21.247" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l21.248"></a><span id="l21.248" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, middleName);</span>
<a href="#l21.249"></a><span id="l21.249" class="difflineplus">+    SanitizeValue(middleName);</span>
<a href="#l21.250"></a><span id="l21.250" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l21.251"></a><span id="l21.251">   }</span>
<a href="#l21.252"></a><span id="l21.252" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty( pUser, PR_NICKNAME);</span>
<a href="#l21.253"></a><span id="l21.253" class="difflineplus">+  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_NICKNAME);</span>
<a href="#l21.254"></a><span id="l21.254">   if (pProp) {</span>
<a href="#l21.255"></a><span id="l21.255" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, nickName);</span>
<a href="#l21.256"></a><span id="l21.256" class="difflineminus">-    SanitizeValue( nickName);</span>
<a href="#l21.257"></a><span id="l21.257" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l21.258"></a><span id="l21.258" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, nickName);</span>
<a href="#l21.259"></a><span id="l21.259" class="difflineplus">+    SanitizeValue(nickName);</span>
<a href="#l21.260"></a><span id="l21.260" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l21.261"></a><span id="l21.261">   }</span>
<a href="#l21.262"></a><span id="l21.262">   </span>
<a href="#l21.263"></a><span id="l21.263">   // The idea here is that firstName and lastName cannot both be empty!</span>
<a href="#l21.264"></a><span id="l21.264">   if (firstName.IsEmpty() &amp;&amp; lastName.IsEmpty())</span>
<a href="#l21.265"></a><span id="l21.265">     firstName = pName;</span>
<a href="#l21.266"></a><span id="l21.266">   </span>
<a href="#l21.267"></a><span id="l21.267">   nsString  displayName;</span>
<a href="#l21.268"></a><span id="l21.268" class="difflineminus">-  pProp = m_pWab-&gt;GetUserProperty( pUser, PR_DISPLAY_NAME);</span>
<a href="#l21.269"></a><span id="l21.269" class="difflineplus">+  pProp = m_pWab-&gt;GetUserProperty(pUser, PR_DISPLAY_NAME);</span>
<a href="#l21.270"></a><span id="l21.270">   if (pProp) {</span>
<a href="#l21.271"></a><span id="l21.271" class="difflineminus">-    m_pWab-&gt;GetValueString( pProp, displayName);</span>
<a href="#l21.272"></a><span id="l21.272" class="difflineminus">-    SanitizeValue( displayName);</span>
<a href="#l21.273"></a><span id="l21.273" class="difflineminus">-    m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l21.274"></a><span id="l21.274" class="difflineplus">+    m_pWab-&gt;GetValueString(pProp, displayName);</span>
<a href="#l21.275"></a><span id="l21.275" class="difflineplus">+    SanitizeValue(displayName);</span>
<a href="#l21.276"></a><span id="l21.276" class="difflineplus">+    m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l21.277"></a><span id="l21.277">   }</span>
<a href="#l21.278"></a><span id="l21.278">   if (displayName.IsEmpty()) {</span>
<a href="#l21.279"></a><span id="l21.279">     if (firstName.IsEmpty())</span>
<a href="#l21.280"></a><span id="l21.280">       displayName = pName;</span>
<a href="#l21.281"></a><span id="l21.281">     else {</span>
<a href="#l21.282"></a><span id="l21.282">       displayName = firstName;</span>
<a href="#l21.283"></a><span id="l21.283">       if (!middleName.IsEmpty()) {</span>
<a href="#l21.284"></a><span id="l21.284">         displayName.Append(PRUnichar(' '));</span>
<a href="#l21.285"></a><span id="l21.285" class="difflineminus">-        displayName.Append( middleName);</span>
<a href="#l21.286"></a><span id="l21.286" class="difflineplus">+        displayName.Append(middleName);</span>
<a href="#l21.287"></a><span id="l21.287">       }</span>
<a href="#l21.288"></a><span id="l21.288">       if (!lastName.IsEmpty()) {</span>
<a href="#l21.289"></a><span id="l21.289">         displayName.Append(PRUnichar(' '));</span>
<a href="#l21.290"></a><span id="l21.290" class="difflineminus">-        displayName.Append( lastName);</span>
<a href="#l21.291"></a><span id="l21.291" class="difflineplus">+        displayName.Append(lastName);</span>
<a href="#l21.292"></a><span id="l21.292">       }</span>
<a href="#l21.293"></a><span id="l21.293">     }</span>
<a href="#l21.294"></a><span id="l21.294">   }</span>
<a href="#l21.295"></a><span id="l21.295"> </span>
<a href="#l21.296"></a><span id="l21.296">   pProp = m_pWab-&gt;GetUserProperty(pUser, PR_BIRTHDAY);</span>
<a href="#l21.297"></a><span id="l21.297">   if (pProp) {</span>
<a href="#l21.298"></a><span id="l21.298">     m_pWab-&gt;GetValueTime(pProp, birthDay);</span>
<a href="#l21.299"></a><span id="l21.299">     m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l21.300"></a><span id="l21.300">   }</span>
<a href="#l21.301"></a><span id="l21.301">   </span>
<a href="#l21.302"></a><span id="l21.302">   // We now have the required fields</span>
<a href="#l21.303"></a><span id="l21.303">   // write them out followed by any optional fields!</span>
<a href="#l21.304"></a><span id="l21.304" class="difflineminus">-  if (!displayName.IsEmpty()) {</span>
<a href="#l21.305"></a><span id="l21.305" class="difflineminus">-    m_database-&gt;AddDisplayName( newRow, NS_ConvertUTF16toUTF8(displayName).get());</span>
<a href="#l21.306"></a><span id="l21.306" class="difflineminus">-  }</span>
<a href="#l21.307"></a><span id="l21.307" class="difflineminus">-  if (!firstName.IsEmpty()) {</span>
<a href="#l21.308"></a><span id="l21.308" class="difflineminus">-    m_database-&gt;AddFirstName( newRow, NS_ConvertUTF16toUTF8(firstName).get());</span>
<a href="#l21.309"></a><span id="l21.309" class="difflineminus">-  }</span>
<a href="#l21.310"></a><span id="l21.310" class="difflineminus">-  if (!lastName.IsEmpty()) {</span>
<a href="#l21.311"></a><span id="l21.311" class="difflineminus">-    m_database-&gt;AddLastName( newRow, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l21.312"></a><span id="l21.312" class="difflineminus">-  }</span>
<a href="#l21.313"></a><span id="l21.313" class="difflineminus">-  if (!nickName.IsEmpty()) {</span>
<a href="#l21.314"></a><span id="l21.314" class="difflineminus">-    m_database-&gt;AddNickName( newRow, NS_ConvertUTF16toUTF8(nickName).get());</span>
<a href="#l21.315"></a><span id="l21.315" class="difflineminus">-  }</span>
<a href="#l21.316"></a><span id="l21.316" class="difflineminus">-  if (!eMail.IsEmpty()) {</span>
<a href="#l21.317"></a><span id="l21.317" class="difflineminus">-    m_database-&gt;AddPrimaryEmail( newRow, NS_ConvertUTF16toUTF8(eMail).get());</span>
<a href="#l21.318"></a><span id="l21.318" class="difflineminus">-  }</span>
<a href="#l21.319"></a><span id="l21.319" class="difflineplus">+  if (!displayName.IsEmpty())</span>
<a href="#l21.320"></a><span id="l21.320" class="difflineplus">+    m_database-&gt;AddDisplayName(newRow, NS_ConvertUTF16toUTF8(displayName).get());</span>
<a href="#l21.321"></a><span id="l21.321" class="difflineplus">+  if (!firstName.IsEmpty())</span>
<a href="#l21.322"></a><span id="l21.322" class="difflineplus">+    m_database-&gt;AddFirstName(newRow, NS_ConvertUTF16toUTF8(firstName).get());</span>
<a href="#l21.323"></a><span id="l21.323" class="difflineplus">+  if (!lastName.IsEmpty())</span>
<a href="#l21.324"></a><span id="l21.324" class="difflineplus">+    m_database-&gt;AddLastName(newRow, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l21.325"></a><span id="l21.325" class="difflineplus">+  if (!nickName.IsEmpty())</span>
<a href="#l21.326"></a><span id="l21.326" class="difflineplus">+    m_database-&gt;AddNickName(newRow, NS_ConvertUTF16toUTF8(nickName).get());</span>
<a href="#l21.327"></a><span id="l21.327" class="difflineplus">+  if (!eMail.IsEmpty())</span>
<a href="#l21.328"></a><span id="l21.328" class="difflineplus">+    m_database-&gt;AddPrimaryEmail(newRow, NS_ConvertUTF16toUTF8(eMail).get());</span>
<a href="#l21.329"></a><span id="l21.329"> </span>
<a href="#l21.330"></a><span id="l21.330" class="difflineminus">-  if (birthDay) {</span>
<a href="#l21.331"></a><span id="l21.331" class="difflineplus">+  if (birthDay)</span>
<a href="#l21.332"></a><span id="l21.332">     SetBirthDay(newRow, birthDay);</span>
<a href="#l21.333"></a><span id="l21.333" class="difflineminus">-  }</span>
<a href="#l21.334"></a><span id="l21.334">   </span>
<a href="#l21.335"></a><span id="l21.335">   // Do all of the extra fields!</span>
<a href="#l21.336"></a><span id="l21.336">   </span>
<a href="#l21.337"></a><span id="l21.337">   nsString  value;</span>
<a href="#l21.338"></a><span id="l21.338">   nsString  line2;</span>
<a href="#l21.339"></a><span id="l21.339">   nsresult  rv;</span>
<a href="#l21.340"></a><span id="l21.340">   // Create a field map</span>
<a href="#l21.341"></a><span id="l21.341">   </span>
<a href="#l21.342"></a><span id="l21.342">   nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l21.343"></a><span id="l21.343" class="difflineminus">-  if (NS_SUCCEEDED( rv)) {</span>
<a href="#l21.344"></a><span id="l21.344" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l21.345"></a><span id="l21.345">     nsIImportFieldMap *    pFieldMap = nsnull;</span>
<a href="#l21.346"></a><span id="l21.346" class="difflineminus">-    rv = impSvc-&gt;CreateNewFieldMap( &amp;pFieldMap);</span>
<a href="#l21.347"></a><span id="l21.347" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; pFieldMap) {</span>
<a href="#l21.348"></a><span id="l21.348" class="difflineminus">-      int max = sizeof( gMapiFields) / sizeof( MAPIFields);</span>
<a href="#l21.349"></a><span id="l21.349" class="difflineplus">+    rv = impSvc-&gt;CreateNewFieldMap(&amp;pFieldMap);</span>
<a href="#l21.350"></a><span id="l21.350" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; pFieldMap) {</span>
<a href="#l21.351"></a><span id="l21.351" class="difflineplus">+      int max = sizeof(gMapiFields) / sizeof(MAPIFields);</span>
<a href="#l21.352"></a><span id="l21.352">       for (int i = 0; i &lt; max; i++) {</span>
<a href="#l21.353"></a><span id="l21.353" class="difflineminus">-        pProp = m_pWab-&gt;GetUserProperty( pUser, gMapiFields[i].mapiTag);</span>
<a href="#l21.354"></a><span id="l21.354" class="difflineplus">+        pProp = m_pWab-&gt;GetUserProperty(pUser, gMapiFields[i].mapiTag);</span>
<a href="#l21.355"></a><span id="l21.355">         if (pProp) {</span>
<a href="#l21.356"></a><span id="l21.356" class="difflineminus">-          m_pWab-&gt;GetValueString( pProp, value);</span>
<a href="#l21.357"></a><span id="l21.357" class="difflineminus">-          m_pWab-&gt;FreeProperty( pProp);</span>
<a href="#l21.358"></a><span id="l21.358" class="difflineplus">+          m_pWab-&gt;GetValueString(pProp, value);</span>
<a href="#l21.359"></a><span id="l21.359" class="difflineplus">+          m_pWab-&gt;FreeProperty(pProp);</span>
<a href="#l21.360"></a><span id="l21.360">           if (!value.IsEmpty()) {</span>
<a href="#l21.361"></a><span id="l21.361">             if (gMapiFields[i].multiLine == kNoMultiLine) {</span>
<a href="#l21.362"></a><span id="l21.362" class="difflineminus">-              SanitizeValue( value);</span>
<a href="#l21.363"></a><span id="l21.363" class="difflineminus">-              pFieldMap-&gt;SetFieldValue( m_database, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l21.364"></a><span id="l21.364" class="difflineplus">+              SanitizeValue(value);</span>
<a href="#l21.365"></a><span id="l21.365" class="difflineplus">+              pFieldMap-&gt;SetFieldValue(m_database, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l21.366"></a><span id="l21.366">             }</span>
<a href="#l21.367"></a><span id="l21.367">             else if (gMapiFields[i].multiLine == kIsMultiLine) {</span>
<a href="#l21.368"></a><span id="l21.368" class="difflineminus">-              pFieldMap-&gt;SetFieldValue( m_database, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l21.369"></a><span id="l21.369" class="difflineplus">+              pFieldMap-&gt;SetFieldValue(m_database, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l21.370"></a><span id="l21.370">             }</span>
<a href="#l21.371"></a><span id="l21.371">             else {</span>
<a href="#l21.372"></a><span id="l21.372">               line2.Truncate();</span>
<a href="#l21.373"></a><span id="l21.373" class="difflineminus">-              SplitString( value, line2);</span>
<a href="#l21.374"></a><span id="l21.374" class="difflineplus">+              SplitString(value, line2);</span>
<a href="#l21.375"></a><span id="l21.375">               if (!value.IsEmpty())</span>
<a href="#l21.376"></a><span id="l21.376" class="difflineminus">-                pFieldMap-&gt;SetFieldValue( m_database, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l21.377"></a><span id="l21.377" class="difflineplus">+                pFieldMap-&gt;SetFieldValue(m_database, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l21.378"></a><span id="l21.378">               if (!line2.IsEmpty())</span>
<a href="#l21.379"></a><span id="l21.379" class="difflineminus">-                pFieldMap-&gt;SetFieldValue( m_database, newRow, gMapiFields[i].multiLine, line2.get());</span>
<a href="#l21.380"></a><span id="l21.380" class="difflineplus">+                pFieldMap-&gt;SetFieldValue(m_database, newRow, gMapiFields[i].multiLine, line2.get());</span>
<a href="#l21.381"></a><span id="l21.381">             }</span>
<a href="#l21.382"></a><span id="l21.382">           }</span>
<a href="#l21.383"></a><span id="l21.383">         }</span>
<a href="#l21.384"></a><span id="l21.384">       }</span>
<a href="#l21.385"></a><span id="l21.385">       // call fieldMap SetFieldValue based on the table of fields</span>
<a href="#l21.386"></a><span id="l21.386">       </span>
<a href="#l21.387"></a><span id="l21.387" class="difflineminus">-      NS_RELEASE( pFieldMap);</span>
<a href="#l21.388"></a><span id="l21.388" class="difflineplus">+      NS_RELEASE(pFieldMap);</span>
<a href="#l21.389"></a><span id="l21.389">     }</span>
<a href="#l21.390"></a><span id="l21.390">   }</span>
<a href="#l21.391"></a><span id="l21.391" class="difflineminus">-  return( true);</span>
<a href="#l21.392"></a><span id="l21.392" class="difflineplus">+  return true;</span>
<a href="#l21.393"></a><span id="l21.393"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOEAddressIterator.h</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOEAddressIterator.h</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -41,27 +41,27 @@</span>
<a href="#l22.4"></a><span id="l22.4"> #include &quot;WabObject.h&quot;</span>
<a href="#l22.5"></a><span id="l22.5"> #include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l22.6"></a><span id="l22.6"> #include &quot;mdb.h&quot;</span>
<a href="#l22.7"></a><span id="l22.7"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l22.8"></a><span id="l22.8"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10"> class nsOEAddressIterator : public CWabIterator {</span>
<a href="#l22.11"></a><span id="l22.11"> public:</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-  nsOEAddressIterator( CWAB *pWab, nsIAddrDatabase *database);</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+  nsOEAddressIterator(CWAB *pWab, nsIAddrDatabase *database);</span>
<a href="#l22.14"></a><span id="l22.14">   ~nsOEAddressIterator();</span>
<a href="#l22.15"></a><span id="l22.15">   </span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-  virtual nsresult  EnumUser( const PRUnichar * pName, LPENTRYID pEid, ULONG cbEid);</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-  virtual nsresult  EnumList( const PRUnichar * pName, LPENTRYID pEid, ULONG cbEid, LPMAPITABLE table);</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+  virtual nsresult  EnumUser(const PRUnichar * pName, LPENTRYID pEid, ULONG cbEid);</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+  virtual nsresult  EnumList(const PRUnichar * pName, LPENTRYID pEid, ULONG cbEid, LPMAPITABLE table);</span>
<a href="#l22.20"></a><span id="l22.20">         void FindListRow(nsString &amp;eMail, nsIMdbRow **cardRow);</span>
<a href="#l22.21"></a><span id="l22.21"> </span>
<a href="#l22.22"></a><span id="l22.22"> private:</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-  bool      BuildCard( const PRUnichar * pName, nsIMdbRow *card, LPMAILUSER pUser);</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-  void    SanitizeValue( nsString&amp; val);</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-  void    SplitString( nsString&amp; val1, nsString&amp; val2);</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+  bool      BuildCard(const PRUnichar * pName, nsIMdbRow *card, LPMAILUSER pUser);</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+  void    SanitizeValue(nsString&amp; val);</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+  void    SplitString(nsString&amp; val1, nsString&amp; val2);</span>
<a href="#l22.29"></a><span id="l22.29">   void    SetBirthDay(nsIMdbRow *card, PRTime&amp; birthDay);</span>
<a href="#l22.30"></a><span id="l22.30"> </span>
<a href="#l22.31"></a><span id="l22.31">   CWAB *                m_pWab;</span>
<a href="#l22.32"></a><span id="l22.32">   nsCOMPtr&lt;nsIAddrDatabase&gt;     m_database;</span>
<a href="#l22.33"></a><span id="l22.33">   nsInterfaceHashtable &lt;nsStringHashKey, nsIMdbRow&gt; m_listRows;</span>
<a href="#l22.34"></a><span id="l22.34"> };</span>
<a href="#l22.35"></a><span id="l22.35"> </span>
<a href="#l22.36"></a><span id="l22.36"> #endif </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOEImport.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOEImport.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -105,20 +105,20 @@ public:</span>
<a href="#l23.4"></a><span id="l23.4">                 PRUnichar **pErrorLog, PRUnichar **pSuccessLog, bool *fatalError);</span>
<a href="#l23.5"></a><span id="l23.5"> </span>
<a href="#l23.6"></a><span id="l23.6">   /* unsigned long GetImportProgress (); */</span>
<a href="#l23.7"></a><span id="l23.7">   NS_IMETHOD GetImportProgress(PRUint32 *_retval);</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9">     NS_IMETHOD TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval);</span>
<a href="#l23.10"></a><span id="l23.10"> </span>
<a href="#l23.11"></a><span id="l23.11"> public:</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  static void ReportSuccess( nsString&amp; name, PRInt32 count, nsString *pStream);</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-  static void ReportError( PRInt32 errorNum, nsString&amp; name, nsString *pStream);</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-  static void AddLinebreak( nsString *pStream);</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-  static void SetLogs( nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess);</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+  static void ReportSuccess(nsString&amp; name, PRInt32 count, nsString *pStream);</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+  static void ReportError(PRInt32 errorNum, nsString&amp; name, nsString *pStream);</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+  static void AddLinebreak(nsString *pStream);</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+  static void SetLogs(nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess);</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21"> private:</span>
<a href="#l23.22"></a><span id="l23.22">   PRUint32 m_bytesDone;</span>
<a href="#l23.23"></a><span id="l23.23"> };</span>
<a href="#l23.24"></a><span id="l23.24"> </span>
<a href="#l23.25"></a><span id="l23.25"> </span>
<a href="#l23.26"></a><span id="l23.26"> class ImportOEAddressImpl : public nsIImportAddressBooks</span>
<a href="#l23.27"></a><span id="l23.27"> {</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineat">@@ -128,178 +128,177 @@ public:</span>
<a href="#l23.29"></a><span id="l23.29"> </span>
<a href="#l23.30"></a><span id="l23.30">   static nsresult Create(nsIImportAddressBooks** aImport);</span>
<a href="#l23.31"></a><span id="l23.31"> </span>
<a href="#l23.32"></a><span id="l23.32">     // nsISupports interface</span>
<a href="#l23.33"></a><span id="l23.33">     NS_DECL_ISUPPORTS</span>
<a href="#l23.34"></a><span id="l23.34"> </span>
<a href="#l23.35"></a><span id="l23.35">     // nsIImportAddressBooks interface</span>
<a href="#l23.36"></a><span id="l23.36"> </span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-  NS_IMETHOD GetSupportsMultiple(bool *_retval) { *_retval = false; return( NS_OK);}</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+  NS_IMETHOD GetSupportsMultiple(bool *_retval) { *_retval = false; return NS_OK;}</span>
<a href="#l23.39"></a><span id="l23.39"> </span>
<a href="#l23.40"></a><span id="l23.40">   NS_IMETHOD GetAutoFind(PRUnichar **description, bool *_retval);</span>
<a href="#l23.41"></a><span id="l23.41"> </span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-  NS_IMETHOD GetNeedsFieldMap(nsIFile *pLoc, bool *_retval) { *_retval = false; return( NS_OK);}</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+  NS_IMETHOD GetNeedsFieldMap(nsIFile *pLoc, bool *_retval) { *_retval = false; return NS_OK;}</span>
<a href="#l23.44"></a><span id="l23.44"> </span>
<a href="#l23.45"></a><span id="l23.45">   NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found, bool *userVerify)</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-    { return( NS_ERROR_FAILURE);}</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineplus">+    { return NS_ERROR_FAILURE;}</span>
<a href="#l23.48"></a><span id="l23.48"> </span>
<a href="#l23.49"></a><span id="l23.49">   NS_IMETHOD FindAddressBooks(nsIFile *location, nsISupportsArray **_retval);</span>
<a href="#l23.50"></a><span id="l23.50"> </span>
<a href="#l23.51"></a><span id="l23.51">   NS_IMETHOD InitFieldMap(nsIImportFieldMap *fieldMap)</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineminus">-    { return( NS_ERROR_FAILURE); }</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+    { return NS_ERROR_FAILURE; }</span>
<a href="#l23.54"></a><span id="l23.54"> </span>
<a href="#l23.55"></a><span id="l23.55">   NS_IMETHOD ImportAddressBook(nsIImportABDescriptor *source,</span>
<a href="#l23.56"></a><span id="l23.56">                                nsIAddrDatabase *destination,</span>
<a href="#l23.57"></a><span id="l23.57">                                nsIImportFieldMap *fieldMap,</span>
<a href="#l23.58"></a><span id="l23.58">                                nsISupports *aSupportService,</span>
<a href="#l23.59"></a><span id="l23.59">                                PRUnichar **errorLog,</span>
<a href="#l23.60"></a><span id="l23.60">                                PRUnichar **successLog,</span>
<a href="#l23.61"></a><span id="l23.61">                                bool *fatalError);</span>
<a href="#l23.62"></a><span id="l23.62"> </span>
<a href="#l23.63"></a><span id="l23.63">   NS_IMETHOD GetImportProgress(PRUint32 *_retval);</span>
<a href="#l23.64"></a><span id="l23.64"> </span>
<a href="#l23.65"></a><span id="l23.65" class="difflineminus">-  NS_IMETHOD GetSampleData( PRInt32 index, bool *pFound, PRUnichar **pStr)</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-    { return( NS_ERROR_FAILURE);}</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineplus">+  NS_IMETHOD GetSampleData(PRInt32 index, bool *pFound, PRUnichar **pStr)</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineplus">+    { return NS_ERROR_FAILURE;}</span>
<a href="#l23.69"></a><span id="l23.69"> </span>
<a href="#l23.70"></a><span id="l23.70" class="difflineminus">-  NS_IMETHOD SetSampleLocation( nsIFile *) { return( NS_OK); }</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineplus">+  NS_IMETHOD SetSampleLocation(nsIFile *) { return NS_OK; }</span>
<a href="#l23.72"></a><span id="l23.72"> </span>
<a href="#l23.73"></a><span id="l23.73"> private:</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineminus">-  static void ReportSuccess( nsString&amp; name, nsString *pStream);</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineplus">+  static void ReportSuccess(nsString&amp; name, nsString *pStream);</span>
<a href="#l23.76"></a><span id="l23.76"> </span>
<a href="#l23.77"></a><span id="l23.77"> private:</span>
<a href="#l23.78"></a><span id="l23.78">   CWAB * m_pWab;</span>
<a href="#l23.79"></a><span id="l23.79">   int m_doneSoFar;</span>
<a href="#l23.80"></a><span id="l23.80"> };</span>
<a href="#l23.81"></a><span id="l23.81"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l23.82"></a><span id="l23.82"> </span>
<a href="#l23.83"></a><span id="l23.83"> </span>
<a href="#l23.84"></a><span id="l23.84"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l23.85"></a><span id="l23.85"> </span>
<a href="#l23.86"></a><span id="l23.86"> </span>
<a href="#l23.87"></a><span id="l23.87"> nsOEImport::nsOEImport()</span>
<a href="#l23.88"></a><span id="l23.88"> {</span>
<a href="#l23.89"></a><span id="l23.89">   // Init logging module.</span>
<a href="#l23.90"></a><span id="l23.90">   if (!OELOGMODULE)</span>
<a href="#l23.91"></a><span id="l23.91">     OELOGMODULE = PR_NewLogModule(&quot;IMPORT&quot;);</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineminus">-  IMPORT_LOG0( &quot;nsOEImport Module Created\n&quot;);</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineplus">+  IMPORT_LOG0(&quot;nsOEImport Module Created\n&quot;);</span>
<a href="#l23.94"></a><span id="l23.94">   nsOEStringBundle::GetStringBundle();</span>
<a href="#l23.95"></a><span id="l23.95"> }</span>
<a href="#l23.96"></a><span id="l23.96"> </span>
<a href="#l23.97"></a><span id="l23.97"> </span>
<a href="#l23.98"></a><span id="l23.98"> nsOEImport::~nsOEImport()</span>
<a href="#l23.99"></a><span id="l23.99"> {</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineminus">-  IMPORT_LOG0( &quot;nsOEImport Module Deleted\n&quot;);</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineplus">+  IMPORT_LOG0(&quot;nsOEImport Module Deleted\n&quot;);</span>
<a href="#l23.102"></a><span id="l23.102"> }</span>
<a href="#l23.103"></a><span id="l23.103"> </span>
<a href="#l23.104"></a><span id="l23.104"> NS_IMPL_ISUPPORTS1(nsOEImport, nsIImportModule)</span>
<a href="#l23.105"></a><span id="l23.105"> </span>
<a href="#l23.106"></a><span id="l23.106" class="difflineminus">-NS_IMETHODIMP nsOEImport::GetName( PRUnichar **name)</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineplus">+NS_IMETHODIMP nsOEImport::GetName(PRUnichar **name)</span>
<a href="#l23.108"></a><span id="l23.108"> {</span>
<a href="#l23.109"></a><span id="l23.109">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l23.110"></a><span id="l23.110"> </span>
<a href="#l23.111"></a><span id="l23.111" class="difflineminus">-  *name = nsOEStringBundle::GetStringByID( OEIMPORT_NAME);</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineplus">+  *name = nsOEStringBundle::GetStringByID(OEIMPORT_NAME);</span>
<a href="#l23.113"></a><span id="l23.113"> </span>
<a href="#l23.114"></a><span id="l23.114">     return NS_OK;</span>
<a href="#l23.115"></a><span id="l23.115"> }</span>
<a href="#l23.116"></a><span id="l23.116"> </span>
<a href="#l23.117"></a><span id="l23.117" class="difflineminus">-NS_IMETHODIMP nsOEImport::GetDescription( PRUnichar **name)</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineplus">+NS_IMETHODIMP nsOEImport::GetDescription(PRUnichar **name)</span>
<a href="#l23.119"></a><span id="l23.119"> {</span>
<a href="#l23.120"></a><span id="l23.120">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l23.121"></a><span id="l23.121"> </span>
<a href="#l23.122"></a><span id="l23.122" class="difflineminus">-  *name = nsOEStringBundle::GetStringByID( OEIMPORT_DESCRIPTION);</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineplus">+  *name = nsOEStringBundle::GetStringByID(OEIMPORT_DESCRIPTION);</span>
<a href="#l23.124"></a><span id="l23.124">   return NS_OK;</span>
<a href="#l23.125"></a><span id="l23.125"> }</span>
<a href="#l23.126"></a><span id="l23.126"> </span>
<a href="#l23.127"></a><span id="l23.127" class="difflineminus">-NS_IMETHODIMP nsOEImport::GetSupports( char **supports)</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineplus">+NS_IMETHODIMP nsOEImport::GetSupports(char **supports)</span>
<a href="#l23.129"></a><span id="l23.129"> {</span>
<a href="#l23.130"></a><span id="l23.130">   NS_PRECONDITION(supports != nsnull, &quot;null ptr&quot;);</span>
<a href="#l23.131"></a><span id="l23.131">   if (! supports)</span>
<a href="#l23.132"></a><span id="l23.132">       return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.133"></a><span id="l23.133"> </span>
<a href="#l23.134"></a><span id="l23.134" class="difflineminus">-  *supports = strdup( kOESupportsString);</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineminus">-  return( NS_OK);</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineplus">+  *supports = strdup(kOESupportsString);</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.138"></a><span id="l23.138"> }</span>
<a href="#l23.139"></a><span id="l23.139"> </span>
<a href="#l23.140"></a><span id="l23.140"> </span>
<a href="#l23.141"></a><span id="l23.141" class="difflineminus">-NS_IMETHODIMP nsOEImport::GetSupportsUpgrade( bool *pUpgrade)</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineplus">+NS_IMETHODIMP nsOEImport::GetSupportsUpgrade(bool *pUpgrade)</span>
<a href="#l23.143"></a><span id="l23.143"> {</span>
<a href="#l23.144"></a><span id="l23.144">   NS_PRECONDITION(pUpgrade != nsnull, &quot;null ptr&quot;);</span>
<a href="#l23.145"></a><span id="l23.145">   if (! pUpgrade)</span>
<a href="#l23.146"></a><span id="l23.146">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.147"></a><span id="l23.147"> </span>
<a href="#l23.148"></a><span id="l23.148">   *pUpgrade = true;</span>
<a href="#l23.149"></a><span id="l23.149" class="difflineminus">-  return( NS_OK);</span>
<a href="#l23.150"></a><span id="l23.150" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.151"></a><span id="l23.151"> }</span>
<a href="#l23.152"></a><span id="l23.152"> </span>
<a href="#l23.153"></a><span id="l23.153" class="difflineminus">-NS_IMETHODIMP nsOEImport::GetImportInterface( const char *pImportType, nsISupports **ppInterface)</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineplus">+NS_IMETHODIMP nsOEImport::GetImportInterface(const char *pImportType, nsISupports **ppInterface)</span>
<a href="#l23.155"></a><span id="l23.155"> {</span>
<a href="#l23.156"></a><span id="l23.156">   NS_ENSURE_ARG_POINTER(pImportType);</span>
<a href="#l23.157"></a><span id="l23.157">   NS_ENSURE_ARG_POINTER(ppInterface);</span>
<a href="#l23.158"></a><span id="l23.158"> </span>
<a href="#l23.159"></a><span id="l23.159">   *ppInterface = nsnull;</span>
<a href="#l23.160"></a><span id="l23.160">   nsresult rv;</span>
<a href="#l23.161"></a><span id="l23.161" class="difflineminus">-  if (!strcmp( pImportType, &quot;mail&quot;)) {</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineplus">+  if (!strcmp(pImportType, &quot;mail&quot;)) {</span>
<a href="#l23.163"></a><span id="l23.163">     // create the nsIImportMail interface and return it!</span>
<a href="#l23.164"></a><span id="l23.164">     nsIImportMail *  pMail = nsnull;</span>
<a href="#l23.165"></a><span id="l23.165">     nsIImportGeneric *pGeneric = nsnull;</span>
<a href="#l23.166"></a><span id="l23.166" class="difflineminus">-    rv = ImportOEMailImpl::Create( &amp;pMail);</span>
<a href="#l23.167"></a><span id="l23.167" class="difflineminus">-    if (NS_SUCCEEDED( rv)) {</span>
<a href="#l23.168"></a><span id="l23.168" class="difflineplus">+    rv = ImportOEMailImpl::Create(&amp;pMail);</span>
<a href="#l23.169"></a><span id="l23.169" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.170"></a><span id="l23.170">       nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineminus">-      if (NS_SUCCEEDED( rv)) {</span>
<a href="#l23.172"></a><span id="l23.172" class="difflineminus">-        rv = impSvc-&gt;CreateNewGenericMail( &amp;pGeneric);</span>
<a href="#l23.173"></a><span id="l23.173" class="difflineminus">-        if (NS_SUCCEEDED( rv)) {</span>
<a href="#l23.174"></a><span id="l23.174" class="difflineminus">-          pGeneric-&gt;SetData( &quot;mailInterface&quot;, pMail);</span>
<a href="#l23.175"></a><span id="l23.175" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.176"></a><span id="l23.176" class="difflineplus">+        rv = impSvc-&gt;CreateNewGenericMail(&amp;pGeneric);</span>
<a href="#l23.177"></a><span id="l23.177" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.178"></a><span id="l23.178" class="difflineplus">+          pGeneric-&gt;SetData(&quot;mailInterface&quot;, pMail);</span>
<a href="#l23.179"></a><span id="l23.179">           nsString name;</span>
<a href="#l23.180"></a><span id="l23.180" class="difflineminus">-          nsOEStringBundle::GetStringByID( OEIMPORT_NAME, name);</span>
<a href="#l23.181"></a><span id="l23.181" class="difflineplus">+          nsOEStringBundle::GetStringByID(OEIMPORT_NAME, name);</span>
<a href="#l23.182"></a><span id="l23.182">           nsCOMPtr&lt;nsISupportsString&gt; nameString (do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv));</span>
<a href="#l23.183"></a><span id="l23.183">           if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.184"></a><span id="l23.184">             nameString-&gt;SetData(name);</span>
<a href="#l23.185"></a><span id="l23.185" class="difflineminus">-            pGeneric-&gt;SetData( &quot;name&quot;, nameString);</span>
<a href="#l23.186"></a><span id="l23.186" class="difflineminus">-            rv = pGeneric-&gt;QueryInterface( kISupportsIID, (void **)ppInterface);</span>
<a href="#l23.187"></a><span id="l23.187" class="difflineplus">+            pGeneric-&gt;SetData(&quot;name&quot;, nameString);</span>
<a href="#l23.188"></a><span id="l23.188" class="difflineplus">+            rv = pGeneric-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l23.189"></a><span id="l23.189">           }</span>
<a href="#l23.190"></a><span id="l23.190">         }</span>
<a href="#l23.191"></a><span id="l23.191">       }</span>
<a href="#l23.192"></a><span id="l23.192">     }</span>
<a href="#l23.193"></a><span id="l23.193" class="difflineminus">-    NS_IF_RELEASE( pMail);</span>
<a href="#l23.194"></a><span id="l23.194" class="difflineminus">-    NS_IF_RELEASE( pGeneric);</span>
<a href="#l23.195"></a><span id="l23.195" class="difflineminus">-    return( rv);</span>
<a href="#l23.196"></a><span id="l23.196" class="difflineplus">+    NS_IF_RELEASE(pMail);</span>
<a href="#l23.197"></a><span id="l23.197" class="difflineplus">+    NS_IF_RELEASE(pGeneric);</span>
<a href="#l23.198"></a><span id="l23.198" class="difflineplus">+    return rv;</span>
<a href="#l23.199"></a><span id="l23.199">   }</span>
<a href="#l23.200"></a><span id="l23.200"> </span>
<a href="#l23.201"></a><span id="l23.201" class="difflineminus">-  if (!strcmp( pImportType, &quot;addressbook&quot;)) {</span>
<a href="#l23.202"></a><span id="l23.202" class="difflineplus">+  if (!strcmp(pImportType, &quot;addressbook&quot;)) {</span>
<a href="#l23.203"></a><span id="l23.203">     // create the nsIImportMail interface and return it!</span>
<a href="#l23.204"></a><span id="l23.204">     nsIImportAddressBooks * pAddress = nsnull;</span>
<a href="#l23.205"></a><span id="l23.205">     nsIImportGeneric * pGeneric = nsnull;</span>
<a href="#l23.206"></a><span id="l23.206" class="difflineminus">-    rv = ImportOEAddressImpl::Create( &amp;pAddress);</span>
<a href="#l23.207"></a><span id="l23.207" class="difflineminus">-    if (NS_SUCCEEDED( rv)) {</span>
<a href="#l23.208"></a><span id="l23.208" class="difflineplus">+    rv = ImportOEAddressImpl::Create(&amp;pAddress);</span>
<a href="#l23.209"></a><span id="l23.209" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.210"></a><span id="l23.210">       nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.211"></a><span id="l23.211" class="difflineminus">-      if (NS_SUCCEEDED( rv)) {</span>
<a href="#l23.212"></a><span id="l23.212" class="difflineminus">-        rv = impSvc-&gt;CreateNewGenericAddressBooks( &amp;pGeneric);</span>
<a href="#l23.213"></a><span id="l23.213" class="difflineminus">-        if (NS_SUCCEEDED( rv)) {</span>
<a href="#l23.214"></a><span id="l23.214" class="difflineminus">-          pGeneric-&gt;SetData( &quot;addressInterface&quot;, pAddress);</span>
<a href="#l23.215"></a><span id="l23.215" class="difflineminus">-          rv = pGeneric-&gt;QueryInterface( kISupportsIID, (void **)ppInterface);</span>
<a href="#l23.216"></a><span id="l23.216" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.217"></a><span id="l23.217" class="difflineplus">+        rv = impSvc-&gt;CreateNewGenericAddressBooks(&amp;pGeneric);</span>
<a href="#l23.218"></a><span id="l23.218" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.219"></a><span id="l23.219" class="difflineplus">+          pGeneric-&gt;SetData(&quot;addressInterface&quot;, pAddress);</span>
<a href="#l23.220"></a><span id="l23.220" class="difflineplus">+          rv = pGeneric-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l23.221"></a><span id="l23.221">         }</span>
<a href="#l23.222"></a><span id="l23.222">       }</span>
<a href="#l23.223"></a><span id="l23.223">     }</span>
<a href="#l23.224"></a><span id="l23.224" class="difflineminus">-    NS_IF_RELEASE( pAddress);</span>
<a href="#l23.225"></a><span id="l23.225" class="difflineminus">-    NS_IF_RELEASE( pGeneric);</span>
<a href="#l23.226"></a><span id="l23.226" class="difflineminus">-    return( rv);</span>
<a href="#l23.227"></a><span id="l23.227" class="difflineplus">+    NS_IF_RELEASE(pAddress);</span>
<a href="#l23.228"></a><span id="l23.228" class="difflineplus">+    NS_IF_RELEASE(pGeneric);</span>
<a href="#l23.229"></a><span id="l23.229" class="difflineplus">+    return rv;</span>
<a href="#l23.230"></a><span id="l23.230">   }</span>
<a href="#l23.231"></a><span id="l23.231"> </span>
<a href="#l23.232"></a><span id="l23.232" class="difflineminus">-  if (!strcmp( pImportType, &quot;settings&quot;)) {</span>
<a href="#l23.233"></a><span id="l23.233" class="difflineplus">+  if (!strcmp(pImportType, &quot;settings&quot;)) {</span>
<a href="#l23.234"></a><span id="l23.234">     nsIImportSettings *pSettings = nsnull;</span>
<a href="#l23.235"></a><span id="l23.235" class="difflineminus">-    rv = nsOESettings::Create( &amp;pSettings);</span>
<a href="#l23.236"></a><span id="l23.236" class="difflineminus">-    if (NS_SUCCEEDED( rv)) {</span>
<a href="#l23.237"></a><span id="l23.237" class="difflineminus">-      pSettings-&gt;QueryInterface( kISupportsIID, (void **)ppInterface);</span>
<a href="#l23.238"></a><span id="l23.238" class="difflineminus">-    }</span>
<a href="#l23.239"></a><span id="l23.239" class="difflineminus">-    NS_IF_RELEASE( pSettings);</span>
<a href="#l23.240"></a><span id="l23.240" class="difflineminus">-    return( rv);</span>
<a href="#l23.241"></a><span id="l23.241" class="difflineplus">+    rv = nsOESettings::Create(&amp;pSettings);</span>
<a href="#l23.242"></a><span id="l23.242" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l23.243"></a><span id="l23.243" class="difflineplus">+      pSettings-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l23.244"></a><span id="l23.244" class="difflineplus">+    NS_IF_RELEASE(pSettings);</span>
<a href="#l23.245"></a><span id="l23.245" class="difflineplus">+    return rv;</span>
<a href="#l23.246"></a><span id="l23.246">   }</span>
<a href="#l23.247"></a><span id="l23.247"> </span>
<a href="#l23.248"></a><span id="l23.248" class="difflineminus">-  return( NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l23.249"></a><span id="l23.249" class="difflineplus">+  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l23.250"></a><span id="l23.250"> }</span>
<a href="#l23.251"></a><span id="l23.251"> </span>
<a href="#l23.252"></a><span id="l23.252"> /////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l23.253"></a><span id="l23.253"> nsresult ImportOEMailImpl::Create(nsIImportMail** aImport)</span>
<a href="#l23.254"></a><span id="l23.254"> {</span>
<a href="#l23.255"></a><span id="l23.255">   NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l23.256"></a><span id="l23.256">   *aImport = new ImportOEMailImpl();</span>
<a href="#l23.257"></a><span id="l23.257">   NS_ENSURE_TRUE(*aImport, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l23.258"></a><span id="l23.258" class="difflineat">@@ -327,17 +326,17 @@ NS_IMETHODIMP ImportOEMailImpl::Translat</span>
<a href="#l23.259"></a><span id="l23.259">   else if (aFolderName.LowerCaseEqualsLiteral(&quot;outbox&quot;))</span>
<a href="#l23.260"></a><span id="l23.260">       _retval = NS_LITERAL_STRING(kDestUnsentMessagesFolderName);</span>
<a href="#l23.261"></a><span id="l23.261">   else</span>
<a href="#l23.262"></a><span id="l23.262">       _retval = aFolderName;</span>
<a href="#l23.263"></a><span id="l23.263"> </span>
<a href="#l23.264"></a><span id="l23.264">   return NS_OK;</span>
<a href="#l23.265"></a><span id="l23.265"> }</span>
<a href="#l23.266"></a><span id="l23.266"> </span>
<a href="#l23.267"></a><span id="l23.267" class="difflineminus">-NS_IMETHODIMP ImportOEMailImpl::GetDefaultLocation( nsIFile **ppLoc, bool *found, bool *userVerify)</span>
<a href="#l23.268"></a><span id="l23.268" class="difflineplus">+NS_IMETHODIMP ImportOEMailImpl::GetDefaultLocation(nsIFile **ppLoc, bool *found, bool *userVerify)</span>
<a href="#l23.269"></a><span id="l23.269"> {</span>
<a href="#l23.270"></a><span id="l23.270">   NS_PRECONDITION(ppLoc != nsnull, &quot;null ptr&quot;);</span>
<a href="#l23.271"></a><span id="l23.271">   NS_PRECONDITION(found != nsnull, &quot;null ptr&quot;);</span>
<a href="#l23.272"></a><span id="l23.272">   NS_PRECONDITION(userVerify != nsnull, &quot;null ptr&quot;);</span>
<a href="#l23.273"></a><span id="l23.273">   if (!ppLoc || !found || !userVerify)</span>
<a href="#l23.274"></a><span id="l23.274">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.275"></a><span id="l23.275"> </span>
<a href="#l23.276"></a><span id="l23.276">   // use scanboxes to find the location.</span>
<a href="#l23.277"></a><span id="l23.277" class="difflineat">@@ -350,74 +349,74 @@ NS_IMETHODIMP ImportOEMailImpl::GetDefau</span>
<a href="#l23.278"></a><span id="l23.278">     *found = true;</span>
<a href="#l23.279"></a><span id="l23.279">     NS_IF_ADDREF(*ppLoc = file);</span>
<a href="#l23.280"></a><span id="l23.280">   }</span>
<a href="#l23.281"></a><span id="l23.281">   else {</span>
<a href="#l23.282"></a><span id="l23.282">     *found = false;</span>
<a href="#l23.283"></a><span id="l23.283">     *ppLoc = nsnull;</span>
<a href="#l23.284"></a><span id="l23.284">   }</span>
<a href="#l23.285"></a><span id="l23.285">   *userVerify = true;</span>
<a href="#l23.286"></a><span id="l23.286" class="difflineminus">-  return( NS_OK);</span>
<a href="#l23.287"></a><span id="l23.287" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.288"></a><span id="l23.288"> }</span>
<a href="#l23.289"></a><span id="l23.289"> </span>
<a href="#l23.290"></a><span id="l23.290"> </span>
<a href="#l23.291"></a><span id="l23.291" class="difflineminus">-NS_IMETHODIMP ImportOEMailImpl::FindMailboxes( nsIFile *pLoc, nsISupportsArray **ppArray)</span>
<a href="#l23.292"></a><span id="l23.292" class="difflineplus">+NS_IMETHODIMP ImportOEMailImpl::FindMailboxes(nsIFile *pLoc, nsISupportsArray **ppArray)</span>
<a href="#l23.293"></a><span id="l23.293"> {</span>
<a href="#l23.294"></a><span id="l23.294">     NS_PRECONDITION(pLoc != nsnull, &quot;null ptr&quot;);</span>
<a href="#l23.295"></a><span id="l23.295">     NS_PRECONDITION(ppArray != nsnull, &quot;null ptr&quot;);</span>
<a href="#l23.296"></a><span id="l23.296">     if (!pLoc || !ppArray)</span>
<a href="#l23.297"></a><span id="l23.297">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.298"></a><span id="l23.298"> </span>
<a href="#l23.299"></a><span id="l23.299">   bool exists = false;</span>
<a href="#l23.300"></a><span id="l23.300" class="difflineminus">-  nsresult rv = pLoc-&gt;Exists( &amp;exists);</span>
<a href="#l23.301"></a><span id="l23.301" class="difflineminus">-  if (NS_FAILED( rv) || !exists)</span>
<a href="#l23.302"></a><span id="l23.302" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l23.303"></a><span id="l23.303" class="difflineplus">+  nsresult rv = pLoc-&gt;Exists(&amp;exists);</span>
<a href="#l23.304"></a><span id="l23.304" class="difflineplus">+  if (NS_FAILED(rv) || !exists)</span>
<a href="#l23.305"></a><span id="l23.305" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l23.306"></a><span id="l23.306"> </span>
<a href="#l23.307"></a><span id="l23.307">   nsOEScanBoxes  scan;</span>
<a href="#l23.308"></a><span id="l23.308"> </span>
<a href="#l23.309"></a><span id="l23.309" class="difflineminus">-  if (!scan.GetMailboxes( pLoc, ppArray))</span>
<a href="#l23.310"></a><span id="l23.310" class="difflineplus">+  if (!scan.GetMailboxes(pLoc, ppArray))</span>
<a href="#l23.311"></a><span id="l23.311">     *ppArray = nsnull;</span>
<a href="#l23.312"></a><span id="l23.312"> </span>
<a href="#l23.313"></a><span id="l23.313" class="difflineminus">-  return( NS_OK);</span>
<a href="#l23.314"></a><span id="l23.314" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.315"></a><span id="l23.315"> }</span>
<a href="#l23.316"></a><span id="l23.316"> </span>
<a href="#l23.317"></a><span id="l23.317" class="difflineminus">-void ImportOEMailImpl::AddLinebreak( nsString *pStream)</span>
<a href="#l23.318"></a><span id="l23.318" class="difflineplus">+void ImportOEMailImpl::AddLinebreak(nsString *pStream)</span>
<a href="#l23.319"></a><span id="l23.319"> {</span>
<a href="#l23.320"></a><span id="l23.320">   if (pStream)</span>
<a href="#l23.321"></a><span id="l23.321" class="difflineminus">-    pStream-&gt;Append( PRUnichar('\n'));</span>
<a href="#l23.322"></a><span id="l23.322" class="difflineplus">+    pStream-&gt;Append(PRUnichar('\n'));</span>
<a href="#l23.323"></a><span id="l23.323"> }</span>
<a href="#l23.324"></a><span id="l23.324"> </span>
<a href="#l23.325"></a><span id="l23.325" class="difflineminus">-void ImportOEMailImpl::ReportSuccess( nsString&amp; name, PRInt32 count, nsString *pStream)</span>
<a href="#l23.326"></a><span id="l23.326" class="difflineplus">+void ImportOEMailImpl::ReportSuccess(nsString&amp; name, PRInt32 count, nsString *pStream)</span>
<a href="#l23.327"></a><span id="l23.327"> {</span>
<a href="#l23.328"></a><span id="l23.328">   if (!pStream)</span>
<a href="#l23.329"></a><span id="l23.329">     return;</span>
<a href="#l23.330"></a><span id="l23.330">   // load the success string</span>
<a href="#l23.331"></a><span id="l23.331" class="difflineminus">-  PRUnichar *pFmt = nsOEStringBundle::GetStringByID( OEIMPORT_MAILBOX_SUCCESS);</span>
<a href="#l23.332"></a><span id="l23.332" class="difflineminus">-  PRUnichar *pText = nsTextFormatter::smprintf( pFmt, name.get(), count);</span>
<a href="#l23.333"></a><span id="l23.333" class="difflineminus">-  pStream-&gt;Append( pText);</span>
<a href="#l23.334"></a><span id="l23.334" class="difflineminus">-  nsTextFormatter::smprintf_free( pText);</span>
<a href="#l23.335"></a><span id="l23.335" class="difflineminus">-  nsOEStringBundle::FreeString( pFmt);</span>
<a href="#l23.336"></a><span id="l23.336" class="difflineminus">-  AddLinebreak( pStream);</span>
<a href="#l23.337"></a><span id="l23.337" class="difflineplus">+  PRUnichar *pFmt = nsOEStringBundle::GetStringByID(OEIMPORT_MAILBOX_SUCCESS);</span>
<a href="#l23.338"></a><span id="l23.338" class="difflineplus">+  PRUnichar *pText = nsTextFormatter::smprintf(pFmt, name.get(), count);</span>
<a href="#l23.339"></a><span id="l23.339" class="difflineplus">+  pStream-&gt;Append(pText);</span>
<a href="#l23.340"></a><span id="l23.340" class="difflineplus">+  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l23.341"></a><span id="l23.341" class="difflineplus">+  nsOEStringBundle::FreeString(pFmt);</span>
<a href="#l23.342"></a><span id="l23.342" class="difflineplus">+  AddLinebreak(pStream);</span>
<a href="#l23.343"></a><span id="l23.343"> }</span>
<a href="#l23.344"></a><span id="l23.344"> </span>
<a href="#l23.345"></a><span id="l23.345" class="difflineminus">-void ImportOEMailImpl::ReportError( PRInt32 errorNum, nsString&amp; name, nsString *pStream)</span>
<a href="#l23.346"></a><span id="l23.346" class="difflineplus">+void ImportOEMailImpl::ReportError(PRInt32 errorNum, nsString&amp; name, nsString *pStream)</span>
<a href="#l23.347"></a><span id="l23.347"> {</span>
<a href="#l23.348"></a><span id="l23.348">   if (!pStream)</span>
<a href="#l23.349"></a><span id="l23.349">     return;</span>
<a href="#l23.350"></a><span id="l23.350">   // load the error string</span>
<a href="#l23.351"></a><span id="l23.351">   PRUnichar *pFmt = nsOEStringBundle::GetStringByID(errorNum);</span>
<a href="#l23.352"></a><span id="l23.352" class="difflineminus">-  PRUnichar *pText = nsTextFormatter::smprintf( pFmt, name.get());</span>
<a href="#l23.353"></a><span id="l23.353" class="difflineminus">-  pStream-&gt;Append( pText);</span>
<a href="#l23.354"></a><span id="l23.354" class="difflineminus">-  nsTextFormatter::smprintf_free( pText);</span>
<a href="#l23.355"></a><span id="l23.355" class="difflineminus">-  nsOEStringBundle::FreeString( pFmt);</span>
<a href="#l23.356"></a><span id="l23.356" class="difflineminus">-  AddLinebreak( pStream);</span>
<a href="#l23.357"></a><span id="l23.357" class="difflineplus">+  PRUnichar *pText = nsTextFormatter::smprintf(pFmt, name.get());</span>
<a href="#l23.358"></a><span id="l23.358" class="difflineplus">+  pStream-&gt;Append(pText);</span>
<a href="#l23.359"></a><span id="l23.359" class="difflineplus">+  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l23.360"></a><span id="l23.360" class="difflineplus">+  nsOEStringBundle::FreeString(pFmt);</span>
<a href="#l23.361"></a><span id="l23.361" class="difflineplus">+  AddLinebreak(pStream);</span>
<a href="#l23.362"></a><span id="l23.362"> }</span>
<a href="#l23.363"></a><span id="l23.363"> </span>
<a href="#l23.364"></a><span id="l23.364"> </span>
<a href="#l23.365"></a><span id="l23.365" class="difflineminus">-void ImportOEMailImpl::SetLogs( nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess)</span>
<a href="#l23.366"></a><span id="l23.366" class="difflineplus">+void ImportOEMailImpl::SetLogs(nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess)</span>
<a href="#l23.367"></a><span id="l23.367"> {</span>
<a href="#l23.368"></a><span id="l23.368">   if (pError)</span>
<a href="#l23.369"></a><span id="l23.369">     *pError = ToNewUnicode(error);</span>
<a href="#l23.370"></a><span id="l23.370">   if (pSuccess)</span>
<a href="#l23.371"></a><span id="l23.371">     *pSuccess = ToNewUnicode(success);</span>
<a href="#l23.372"></a><span id="l23.372"> }</span>
<a href="#l23.373"></a><span id="l23.373"> </span>
<a href="#l23.374"></a><span id="l23.374"> NS_IMETHODIMP ImportOEMailImpl::ImportMailbox(nsIImportMailboxDescriptor *pSource,</span>
<a href="#l23.375"></a><span id="l23.375" class="difflineat">@@ -428,79 +427,77 @@ NS_IMETHODIMP ImportOEMailImpl::ImportMa</span>
<a href="#l23.376"></a><span id="l23.376"> {</span>
<a href="#l23.377"></a><span id="l23.377">   NS_PRECONDITION(pSource != nsnull, &quot;null ptr&quot;);</span>
<a href="#l23.378"></a><span id="l23.378">   NS_PRECONDITION(pDestination != nsnull, &quot;null ptr&quot;);</span>
<a href="#l23.379"></a><span id="l23.379">   NS_PRECONDITION(fatalError != nsnull, &quot;null ptr&quot;);</span>
<a href="#l23.380"></a><span id="l23.380"> </span>
<a href="#l23.381"></a><span id="l23.381">   nsString success;</span>
<a href="#l23.382"></a><span id="l23.382">   nsString error;</span>
<a href="#l23.383"></a><span id="l23.383">   if (!pSource || !pDestination || !fatalError) {</span>
<a href="#l23.384"></a><span id="l23.384" class="difflineminus">-    nsOEStringBundle::GetStringByID( OEIMPORT_MAILBOX_BADPARAM, error);</span>
<a href="#l23.385"></a><span id="l23.385" class="difflineplus">+    nsOEStringBundle::GetStringByID(OEIMPORT_MAILBOX_BADPARAM, error);</span>
<a href="#l23.386"></a><span id="l23.386">     if (fatalError)</span>
<a href="#l23.387"></a><span id="l23.387">       *fatalError = true;</span>
<a href="#l23.388"></a><span id="l23.388" class="difflineminus">-    SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l23.389"></a><span id="l23.389" class="difflineplus">+    SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l23.390"></a><span id="l23.390">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.391"></a><span id="l23.391">   }</span>
<a href="#l23.392"></a><span id="l23.392"> </span>
<a href="#l23.393"></a><span id="l23.393">   bool abort = false;</span>
<a href="#l23.394"></a><span id="l23.394">   nsString name;</span>
<a href="#l23.395"></a><span id="l23.395">   nsString pName;</span>
<a href="#l23.396"></a><span id="l23.396" class="difflineminus">-  if (NS_SUCCEEDED( pSource-&gt;GetDisplayName( getter_Copies(pName))))</span>
<a href="#l23.397"></a><span id="l23.397" class="difflineplus">+  if (NS_SUCCEEDED(pSource-&gt;GetDisplayName(getter_Copies(pName))))</span>
<a href="#l23.398"></a><span id="l23.398">     name = pName;</span>
<a href="#l23.399"></a><span id="l23.399"> </span>
<a href="#l23.400"></a><span id="l23.400">   PRUint32 mailSize = 0;</span>
<a href="#l23.401"></a><span id="l23.401" class="difflineminus">-  pSource-&gt;GetSize( &amp;mailSize);</span>
<a href="#l23.402"></a><span id="l23.402" class="difflineplus">+  pSource-&gt;GetSize(&amp;mailSize);</span>
<a href="#l23.403"></a><span id="l23.403">   if (mailSize == 0) {</span>
<a href="#l23.404"></a><span id="l23.404" class="difflineminus">-    ReportSuccess( name, 0, &amp;success);</span>
<a href="#l23.405"></a><span id="l23.405" class="difflineminus">-    SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l23.406"></a><span id="l23.406" class="difflineminus">-    return( NS_OK);</span>
<a href="#l23.407"></a><span id="l23.407" class="difflineplus">+    ReportSuccess(name, 0, &amp;success);</span>
<a href="#l23.408"></a><span id="l23.408" class="difflineplus">+    SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l23.409"></a><span id="l23.409" class="difflineplus">+    return NS_OK;</span>
<a href="#l23.410"></a><span id="l23.410">   }</span>
<a href="#l23.411"></a><span id="l23.411"> </span>
<a href="#l23.412"></a><span id="l23.412">   nsCOMPtr &lt;nsILocalFile&gt; inFile;</span>
<a href="#l23.413"></a><span id="l23.413" class="difflineminus">-  if (NS_FAILED( pSource-&gt;GetFile(getter_AddRefs(inFile)))) {</span>
<a href="#l23.414"></a><span id="l23.414" class="difflineminus">-    ReportError( OEIMPORT_MAILBOX_BADSOURCEFILE, name, &amp;error);</span>
<a href="#l23.415"></a><span id="l23.415" class="difflineminus">-    SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l23.416"></a><span id="l23.416" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l23.417"></a><span id="l23.417" class="difflineplus">+  if (NS_FAILED(pSource-&gt;GetFile(getter_AddRefs(inFile)))) {</span>
<a href="#l23.418"></a><span id="l23.418" class="difflineplus">+    ReportError(OEIMPORT_MAILBOX_BADSOURCEFILE, name, &amp;error);</span>
<a href="#l23.419"></a><span id="l23.419" class="difflineplus">+    SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l23.420"></a><span id="l23.420" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l23.421"></a><span id="l23.421">   }</span>
<a href="#l23.422"></a><span id="l23.422"> </span>
<a href="#l23.423"></a><span id="l23.423">   nsCString pPath;</span>
<a href="#l23.424"></a><span id="l23.424">   inFile-&gt;GetNativePath(pPath);</span>
<a href="#l23.425"></a><span id="l23.425" class="difflineminus">-  IMPORT_LOG1( &quot;Importing Outlook Express mailbox: %s\n&quot;, pPath.get());</span>
<a href="#l23.426"></a><span id="l23.426" class="difflineplus">+  IMPORT_LOG1(&quot;Importing Outlook Express mailbox: %s\n&quot;, pPath.get());</span>
<a href="#l23.427"></a><span id="l23.427"> </span>
<a href="#l23.428"></a><span id="l23.428">   m_bytesDone = 0;</span>
<a href="#l23.429"></a><span id="l23.429">   PRUint32 msgCount = 0;</span>
<a href="#l23.430"></a><span id="l23.430">   nsresult rv;</span>
<a href="#l23.431"></a><span id="l23.431" class="difflineminus">-  if (nsOE5File::IsLocalMailFile( inFile)) {</span>
<a href="#l23.432"></a><span id="l23.432" class="difflineminus">-    IMPORT_LOG1( &quot;Importing OE5 mailbox: %s!\n&quot;, NS_LossyConvertUTF16toASCII(name.get()));</span>
<a href="#l23.433"></a><span id="l23.433" class="difflineminus">-    rv = nsOE5File::ImportMailbox( &amp;m_bytesDone, &amp;abort, name, inFile, pDestination, &amp;msgCount);</span>
<a href="#l23.434"></a><span id="l23.434" class="difflineplus">+  if (nsOE5File::IsLocalMailFile(inFile)) {</span>
<a href="#l23.435"></a><span id="l23.435" class="difflineplus">+    IMPORT_LOG1(&quot;Importing OE5 mailbox: %s!\n&quot;, NS_LossyConvertUTF16toASCII(name.get()));</span>
<a href="#l23.436"></a><span id="l23.436" class="difflineplus">+    rv = nsOE5File::ImportMailbox(&amp;m_bytesDone, &amp;abort, name, inFile, pDestination, &amp;msgCount);</span>
<a href="#l23.437"></a><span id="l23.437">   }</span>
<a href="#l23.438"></a><span id="l23.438">   else {</span>
<a href="#l23.439"></a><span id="l23.439" class="difflineminus">-    if (CImportMailbox::ImportMailbox( &amp;m_bytesDone, &amp;abort, name, inFile, pDestination, &amp;msgCount))</span>
<a href="#l23.440"></a><span id="l23.440" class="difflineplus">+    if (CImportMailbox::ImportMailbox(&amp;m_bytesDone, &amp;abort, name, inFile, pDestination, &amp;msgCount))</span>
<a href="#l23.441"></a><span id="l23.441">       rv = NS_OK;</span>
<a href="#l23.442"></a><span id="l23.442">     else</span>
<a href="#l23.443"></a><span id="l23.443">       rv = NS_ERROR_FAILURE;</span>
<a href="#l23.444"></a><span id="l23.444">   }</span>
<a href="#l23.445"></a><span id="l23.445"> </span>
<a href="#l23.446"></a><span id="l23.446" class="difflineminus">-  if (NS_SUCCEEDED( rv)) {</span>
<a href="#l23.447"></a><span id="l23.447" class="difflineminus">-    ReportSuccess( name, msgCount, &amp;success);</span>
<a href="#l23.448"></a><span id="l23.448" class="difflineminus">-  }</span>
<a href="#l23.449"></a><span id="l23.449" class="difflineminus">-  else {</span>
<a href="#l23.450"></a><span id="l23.450" class="difflineminus">-    ReportError( OEIMPORT_MAILBOX_CONVERTERROR, name, &amp;error);</span>
<a href="#l23.451"></a><span id="l23.451" class="difflineminus">-  }</span>
<a href="#l23.452"></a><span id="l23.452" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l23.453"></a><span id="l23.453" class="difflineplus">+    ReportSuccess(name, msgCount, &amp;success);</span>
<a href="#l23.454"></a><span id="l23.454" class="difflineplus">+  else</span>
<a href="#l23.455"></a><span id="l23.455" class="difflineplus">+    ReportError(OEIMPORT_MAILBOX_CONVERTERROR, name, &amp;error);</span>
<a href="#l23.456"></a><span id="l23.456"> </span>
<a href="#l23.457"></a><span id="l23.457" class="difflineminus">-  SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l23.458"></a><span id="l23.458" class="difflineplus">+  SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l23.459"></a><span id="l23.459"> </span>
<a href="#l23.460"></a><span id="l23.460" class="difflineminus">-  return( rv);</span>
<a href="#l23.461"></a><span id="l23.461" class="difflineplus">+  return rv;</span>
<a href="#l23.462"></a><span id="l23.462"> }</span>
<a href="#l23.463"></a><span id="l23.463"> </span>
<a href="#l23.464"></a><span id="l23.464" class="difflineminus">-NS_IMETHODIMP ImportOEMailImpl::GetImportProgress( PRUint32 *pDoneSoFar)</span>
<a href="#l23.465"></a><span id="l23.465" class="difflineplus">+NS_IMETHODIMP ImportOEMailImpl::GetImportProgress(PRUint32 *pDoneSoFar)</span>
<a href="#l23.466"></a><span id="l23.466"> {</span>
<a href="#l23.467"></a><span id="l23.467">   NS_ENSURE_ARG_POINTER(pDoneSoFar);</span>
<a href="#l23.468"></a><span id="l23.468">   *pDoneSoFar = m_bytesDone;</span>
<a href="#l23.469"></a><span id="l23.469" class="difflineminus">-  return( NS_OK);</span>
<a href="#l23.470"></a><span id="l23.470" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.471"></a><span id="l23.471"> }</span>
<a href="#l23.472"></a><span id="l23.472"> </span>
<a href="#l23.473"></a><span id="l23.473"> nsresult ImportOEAddressImpl::Create(nsIImportAddressBooks** aImport)</span>
<a href="#l23.474"></a><span id="l23.474"> {</span>
<a href="#l23.475"></a><span id="l23.475">   NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l23.476"></a><span id="l23.476"> </span>
<a href="#l23.477"></a><span id="l23.477">   *aImport = new ImportOEAddressImpl();</span>
<a href="#l23.478"></a><span id="l23.478">   NS_ENSURE_TRUE(*aImport, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l23.479"></a><span id="l23.479" class="difflineat">@@ -528,66 +525,66 @@ NS_IMETHODIMP ImportOEAddressImpl::GetAu</span>
<a href="#l23.480"></a><span id="l23.480">   NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l23.481"></a><span id="l23.481">   if (! description || !_retval)</span>
<a href="#l23.482"></a><span id="l23.482">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.483"></a><span id="l23.483"> </span>
<a href="#l23.484"></a><span id="l23.484">   *_retval = true;</span>
<a href="#l23.485"></a><span id="l23.485">   nsString str;</span>
<a href="#l23.486"></a><span id="l23.486">   str.Append(nsOEStringBundle::GetStringByID(OEIMPORT_AUTOFIND));</span>
<a href="#l23.487"></a><span id="l23.487">   *description = ToNewUnicode(str);</span>
<a href="#l23.488"></a><span id="l23.488" class="difflineminus">-  return( NS_OK);</span>
<a href="#l23.489"></a><span id="l23.489" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.490"></a><span id="l23.490"> }</span>
<a href="#l23.491"></a><span id="l23.491"> </span>
<a href="#l23.492"></a><span id="l23.492"> </span>
<a href="#l23.493"></a><span id="l23.493"> </span>
<a href="#l23.494"></a><span id="l23.494"> NS_IMETHODIMP ImportOEAddressImpl::FindAddressBooks(nsIFile *location, nsISupportsArray **_retval)</span>
<a href="#l23.495"></a><span id="l23.495"> {</span>
<a href="#l23.496"></a><span id="l23.496">   NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l23.497"></a><span id="l23.497">   if (!_retval)</span>
<a href="#l23.498"></a><span id="l23.498">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.499"></a><span id="l23.499"> </span>
<a href="#l23.500"></a><span id="l23.500" class="difflineminus">-  nsresult rv = NS_NewISupportsArray( _retval);</span>
<a href="#l23.501"></a><span id="l23.501" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l23.502"></a><span id="l23.502" class="difflineminus">-    return( rv);</span>
<a href="#l23.503"></a><span id="l23.503" class="difflineplus">+  nsresult rv = NS_NewISupportsArray(_retval);</span>
<a href="#l23.504"></a><span id="l23.504" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l23.505"></a><span id="l23.505" class="difflineplus">+    return rv;</span>
<a href="#l23.506"></a><span id="l23.506"> </span>
<a href="#l23.507"></a><span id="l23.507">   // Make sure we can load up the windows address book...</span>
<a href="#l23.508"></a><span id="l23.508">   rv = NS_ERROR_FAILURE;</span>
<a href="#l23.509"></a><span id="l23.509"> </span>
<a href="#l23.510"></a><span id="l23.510">   if (m_pWab)</span>
<a href="#l23.511"></a><span id="l23.511">     delete m_pWab;</span>
<a href="#l23.512"></a><span id="l23.512" class="difflineminus">-  m_pWab = new CWAB( nsnull);</span>
<a href="#l23.513"></a><span id="l23.513" class="difflineplus">+  m_pWab = new CWAB(nsnull);</span>
<a href="#l23.514"></a><span id="l23.514"> </span>
<a href="#l23.515"></a><span id="l23.515">   nsIImportABDescriptor * pID;</span>
<a href="#l23.516"></a><span id="l23.516">   nsISupports * pInterface;</span>
<a href="#l23.517"></a><span id="l23.517">   nsString str;</span>
<a href="#l23.518"></a><span id="l23.518" class="difflineminus">-  str.Append(nsOEStringBundle::GetStringByID( OEIMPORT_DEFAULT_NAME));</span>
<a href="#l23.519"></a><span id="l23.519" class="difflineplus">+  str.Append(nsOEStringBundle::GetStringByID(OEIMPORT_DEFAULT_NAME));</span>
<a href="#l23.520"></a><span id="l23.520"> </span>
<a href="#l23.521"></a><span id="l23.521">   if (m_pWab-&gt;Loaded()) {</span>
<a href="#l23.522"></a><span id="l23.522">     // create a new nsIImportABDescriptor and add it to the array</span>
<a href="#l23.523"></a><span id="l23.523">     nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.524"></a><span id="l23.524" class="difflineminus">-    if (NS_SUCCEEDED( rv)) {</span>
<a href="#l23.525"></a><span id="l23.525" class="difflineminus">-      rv = impSvc-&gt;CreateNewABDescriptor( &amp;pID);</span>
<a href="#l23.526"></a><span id="l23.526" class="difflineminus">-      if (NS_SUCCEEDED( rv)) {</span>
<a href="#l23.527"></a><span id="l23.527" class="difflineminus">-        pID-&gt;SetIdentifier( 0x4F453334);</span>
<a href="#l23.528"></a><span id="l23.528" class="difflineminus">-        pID-&gt;SetRef( 1);</span>
<a href="#l23.529"></a><span id="l23.529" class="difflineminus">-        pID-&gt;SetSize( 100);</span>
<a href="#l23.530"></a><span id="l23.530" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.531"></a><span id="l23.531" class="difflineplus">+      rv = impSvc-&gt;CreateNewABDescriptor(&amp;pID);</span>
<a href="#l23.532"></a><span id="l23.532" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.533"></a><span id="l23.533" class="difflineplus">+        pID-&gt;SetIdentifier(0x4F453334);</span>
<a href="#l23.534"></a><span id="l23.534" class="difflineplus">+        pID-&gt;SetRef(1);</span>
<a href="#l23.535"></a><span id="l23.535" class="difflineplus">+        pID-&gt;SetSize(100);</span>
<a href="#l23.536"></a><span id="l23.536">         pID-&gt;SetPreferredName(str);</span>
<a href="#l23.537"></a><span id="l23.537" class="difflineminus">-        rv = pID-&gt;QueryInterface( kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l23.538"></a><span id="l23.538" class="difflineminus">-        (*_retval)-&gt;AppendElement( pInterface);</span>
<a href="#l23.539"></a><span id="l23.539" class="difflineplus">+        rv = pID-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l23.540"></a><span id="l23.540" class="difflineplus">+        (*_retval)-&gt;AppendElement(pInterface);</span>
<a href="#l23.541"></a><span id="l23.541">         pInterface-&gt;Release();</span>
<a href="#l23.542"></a><span id="l23.542">         pID-&gt;Release();</span>
<a href="#l23.543"></a><span id="l23.543">       }</span>
<a href="#l23.544"></a><span id="l23.544">     }</span>
<a href="#l23.545"></a><span id="l23.545">   }</span>
<a href="#l23.546"></a><span id="l23.546"> </span>
<a href="#l23.547"></a><span id="l23.547" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l23.548"></a><span id="l23.548" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l23.549"></a><span id="l23.549">     delete m_pWab;</span>
<a href="#l23.550"></a><span id="l23.550">     m_pWab = nsnull;</span>
<a href="#l23.551"></a><span id="l23.551">   }</span>
<a href="#l23.552"></a><span id="l23.552" class="difflineminus">-  return( NS_OK);</span>
<a href="#l23.553"></a><span id="l23.553" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.554"></a><span id="l23.554"> }</span>
<a href="#l23.555"></a><span id="l23.555"> </span>
<a href="#l23.556"></a><span id="l23.556"> </span>
<a href="#l23.557"></a><span id="l23.557"> </span>
<a href="#l23.558"></a><span id="l23.558"> NS_IMETHODIMP ImportOEAddressImpl::ImportAddressBook(nsIImportABDescriptor *source,</span>
<a href="#l23.559"></a><span id="l23.559">                                                      nsIAddrDatabase *destination,</span>
<a href="#l23.560"></a><span id="l23.560">                                                      nsIImportFieldMap *fieldMap,</span>
<a href="#l23.561"></a><span id="l23.561">                                                      nsISupports *aSupportService,</span>
<a href="#l23.562"></a><span id="l23.562" class="difflineat">@@ -599,70 +596,65 @@ NS_IMETHODIMP ImportOEAddressImpl::Impor</span>
<a href="#l23.563"></a><span id="l23.563">     // NS_PRECONDITION(destination != nsnull, &quot;null ptr&quot;);</span>
<a href="#l23.564"></a><span id="l23.564">     // NS_PRECONDITION(fieldMap != nsnull, &quot;null ptr&quot;);</span>
<a href="#l23.565"></a><span id="l23.565">     NS_PRECONDITION(fatalError != nsnull, &quot;null ptr&quot;);</span>
<a href="#l23.566"></a><span id="l23.566">     if (!source || !fatalError)</span>
<a href="#l23.567"></a><span id="l23.567">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.568"></a><span id="l23.568"> </span>
<a href="#l23.569"></a><span id="l23.569">   // we assume it is our one and only address book.</span>
<a href="#l23.570"></a><span id="l23.570">   if (!m_pWab) {</span>
<a href="#l23.571"></a><span id="l23.571" class="difflineminus">-    IMPORT_LOG0( &quot;Wab not loaded in ImportAddressBook call\n&quot;);</span>
<a href="#l23.572"></a><span id="l23.572" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l23.573"></a><span id="l23.573" class="difflineplus">+    IMPORT_LOG0(&quot;Wab not loaded in ImportAddressBook call\n&quot;);</span>
<a href="#l23.574"></a><span id="l23.574" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l23.575"></a><span id="l23.575">   }</span>
<a href="#l23.576"></a><span id="l23.576"> </span>
<a href="#l23.577"></a><span id="l23.577" class="difflineminus">-  IMPORT_LOG0( &quot;IMPORTING OUTLOOK EXPRESS ADDRESS BOOK\n&quot;);</span>
<a href="#l23.578"></a><span id="l23.578" class="difflineplus">+  IMPORT_LOG0(&quot;IMPORTING OUTLOOK EXPRESS ADDRESS BOOK\n&quot;);</span>
<a href="#l23.579"></a><span id="l23.579"> </span>
<a href="#l23.580"></a><span id="l23.580">   nsString success;</span>
<a href="#l23.581"></a><span id="l23.581">   nsString error;</span>
<a href="#l23.582"></a><span id="l23.582">   if (!source || !destination || !fatalError)</span>
<a href="#l23.583"></a><span id="l23.583">   {</span>
<a href="#l23.584"></a><span id="l23.584" class="difflineminus">-    nsOEStringBundle::GetStringByID( OEIMPORT_ADDRESS_BADPARAM, error);</span>
<a href="#l23.585"></a><span id="l23.585" class="difflineplus">+    nsOEStringBundle::GetStringByID(OEIMPORT_ADDRESS_BADPARAM, error);</span>
<a href="#l23.586"></a><span id="l23.586">     if (fatalError)</span>
<a href="#l23.587"></a><span id="l23.587">       *fatalError = true;</span>
<a href="#l23.588"></a><span id="l23.588" class="difflineminus">-    ImportOEMailImpl::SetLogs( success, error, errorLog, successLog);</span>
<a href="#l23.589"></a><span id="l23.589" class="difflineplus">+    ImportOEMailImpl::SetLogs(success, error, errorLog, successLog);</span>
<a href="#l23.590"></a><span id="l23.590">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.591"></a><span id="l23.591">   }</span>
<a href="#l23.592"></a><span id="l23.592"> </span>
<a href="#l23.593"></a><span id="l23.593">   m_doneSoFar = 0;</span>
<a href="#l23.594"></a><span id="l23.594" class="difflineminus">-  nsOEAddressIterator * pIter = new nsOEAddressIterator( m_pWab, destination);</span>
<a href="#l23.595"></a><span id="l23.595" class="difflineminus">-  HRESULT hr = m_pWab-&gt;IterateWABContents( pIter, &amp;m_doneSoFar);</span>
<a href="#l23.596"></a><span id="l23.596" class="difflineplus">+  nsOEAddressIterator * pIter = new nsOEAddressIterator(m_pWab, destination);</span>
<a href="#l23.597"></a><span id="l23.597" class="difflineplus">+  HRESULT hr = m_pWab-&gt;IterateWABContents(pIter, &amp;m_doneSoFar);</span>
<a href="#l23.598"></a><span id="l23.598">   delete pIter;</span>
<a href="#l23.599"></a><span id="l23.599"> </span>
<a href="#l23.600"></a><span id="l23.600">   nsString name;</span>
<a href="#l23.601"></a><span id="l23.601" class="difflineminus">-  if (SUCCEEDED(hr))</span>
<a href="#l23.602"></a><span id="l23.602" class="difflineminus">-  {</span>
<a href="#l23.603"></a><span id="l23.603" class="difflineminus">-    if (NS_SUCCEEDED(source-&gt;GetPreferredName(name)))</span>
<a href="#l23.604"></a><span id="l23.604" class="difflineminus">-    {</span>
<a href="#l23.605"></a><span id="l23.605" class="difflineminus">-      ReportSuccess( name, &amp;success);</span>
<a href="#l23.606"></a><span id="l23.606" class="difflineminus">-    }</span>
<a href="#l23.607"></a><span id="l23.607" class="difflineminus">-  }</span>
<a href="#l23.608"></a><span id="l23.608" class="difflineplus">+  if (SUCCEEDED(hr) &amp;&amp; NS_SUCCEEDED(source-&gt;GetPreferredName(name)))</span>
<a href="#l23.609"></a><span id="l23.609" class="difflineplus">+    ReportSuccess(name, &amp;success);</span>
<a href="#l23.610"></a><span id="l23.610">   else</span>
<a href="#l23.611"></a><span id="l23.611" class="difflineminus">-    ImportOEMailImpl::ReportError( OEIMPORT_ADDRESS_CONVERTERROR, name, &amp;error);</span>
<a href="#l23.612"></a><span id="l23.612" class="difflineplus">+    ImportOEMailImpl::ReportError(OEIMPORT_ADDRESS_CONVERTERROR, name, &amp;error);</span>
<a href="#l23.613"></a><span id="l23.613"> </span>
<a href="#l23.614"></a><span id="l23.614" class="difflineminus">-  ImportOEMailImpl::SetLogs( success, error, errorLog, successLog);</span>
<a href="#l23.615"></a><span id="l23.615" class="difflineplus">+  ImportOEMailImpl::SetLogs(success, error, errorLog, successLog);</span>
<a href="#l23.616"></a><span id="l23.616"> </span>
<a href="#l23.617"></a><span id="l23.617">   nsresult rv = destination-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l23.618"></a><span id="l23.618">   return rv;</span>
<a href="#l23.619"></a><span id="l23.619"> }</span>
<a href="#l23.620"></a><span id="l23.620"> </span>
<a href="#l23.621"></a><span id="l23.621"> </span>
<a href="#l23.622"></a><span id="l23.622"> NS_IMETHODIMP ImportOEAddressImpl::GetImportProgress(PRUint32 *_retval)</span>
<a href="#l23.623"></a><span id="l23.623"> {</span>
<a href="#l23.624"></a><span id="l23.624">   NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l23.625"></a><span id="l23.625">   if (! _retval)</span>
<a href="#l23.626"></a><span id="l23.626">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.627"></a><span id="l23.627"> </span>
<a href="#l23.628"></a><span id="l23.628">   *_retval = (PRUint32) m_doneSoFar;</span>
<a href="#l23.629"></a><span id="l23.629" class="difflineminus">-  return( NS_OK);</span>
<a href="#l23.630"></a><span id="l23.630" class="difflineplus">+  return NS_OK;</span>
<a href="#l23.631"></a><span id="l23.631"> }</span>
<a href="#l23.632"></a><span id="l23.632"> </span>
<a href="#l23.633"></a><span id="l23.633" class="difflineminus">-void ImportOEAddressImpl::ReportSuccess( nsString&amp; name, nsString *pStream)</span>
<a href="#l23.634"></a><span id="l23.634" class="difflineplus">+void ImportOEAddressImpl::ReportSuccess(nsString&amp; name, nsString *pStream)</span>
<a href="#l23.635"></a><span id="l23.635"> {</span>
<a href="#l23.636"></a><span id="l23.636">   if (!pStream)</span>
<a href="#l23.637"></a><span id="l23.637">     return;</span>
<a href="#l23.638"></a><span id="l23.638">   // load the success string</span>
<a href="#l23.639"></a><span id="l23.639" class="difflineminus">-  PRUnichar *pFmt = nsOEStringBundle::GetStringByID( OEIMPORT_ADDRESS_SUCCESS);</span>
<a href="#l23.640"></a><span id="l23.640" class="difflineminus">-  PRUnichar *pText = nsTextFormatter::smprintf( pFmt, name.get());</span>
<a href="#l23.641"></a><span id="l23.641" class="difflineminus">-  pStream-&gt;Append( pText);</span>
<a href="#l23.642"></a><span id="l23.642" class="difflineminus">-  nsTextFormatter::smprintf_free( pText);</span>
<a href="#l23.643"></a><span id="l23.643" class="difflineminus">-  nsOEStringBundle::FreeString( pFmt);</span>
<a href="#l23.644"></a><span id="l23.644" class="difflineminus">-  ImportOEMailImpl::AddLinebreak( pStream);</span>
<a href="#l23.645"></a><span id="l23.645" class="difflineplus">+  PRUnichar *pFmt = nsOEStringBundle::GetStringByID(OEIMPORT_ADDRESS_SUCCESS);</span>
<a href="#l23.646"></a><span id="l23.646" class="difflineplus">+  PRUnichar *pText = nsTextFormatter::smprintf(pFmt, name.get());</span>
<a href="#l23.647"></a><span id="l23.647" class="difflineplus">+  pStream-&gt;Append(pText);</span>
<a href="#l23.648"></a><span id="l23.648" class="difflineplus">+  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l23.649"></a><span id="l23.649" class="difflineplus">+  nsOEStringBundle::FreeString(pFmt);</span>
<a href="#l23.650"></a><span id="l23.650" class="difflineplus">+  ImportOEMailImpl::AddLinebreak(pStream);</span>
<a href="#l23.651"></a><span id="l23.651"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOEMailbox.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOEMailbox.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -43,34 +43,34 @@</span>
<a href="#l24.4"></a><span id="l24.4"> #include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l24.5"></a><span id="l24.5"> #include &quot;nsCRT.h&quot;</span>
<a href="#l24.6"></a><span id="l24.6"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l24.7"></a><span id="l24.7"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l24.8"></a><span id="l24.8"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> class CMbxScanner {</span>
<a href="#l24.11"></a><span id="l24.11"> public:</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-  CMbxScanner( nsString&amp; name, nsIFile * mbxFile, nsIFile * dstFile);</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+  CMbxScanner(nsString&amp; name, nsIFile * mbxFile, nsIFile * dstFile);</span>
<a href="#l24.14"></a><span id="l24.14">   ~CMbxScanner();</span>
<a href="#l24.15"></a><span id="l24.15"> </span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-  virtual bool    Initialize( void);</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-  virtual bool    DoWork( bool *pAbort, PRUint32 *pDone, PRUint32 *pCount);</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+  virtual bool    Initialize(void);</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+  virtual bool    DoWork(bool *pAbort, PRUint32 *pDone, PRUint32 *pCount);</span>
<a href="#l24.20"></a><span id="l24.20"> </span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-  bool      WasErrorFatal( void) { return( m_fatalError);}</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-  PRUint32  BytesProcessed( void) { return( m_didBytes);}</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineplus">+  bool      WasErrorFatal(void) { return m_fatalError;}</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+  PRUint32  BytesProcessed(void) { return m_didBytes;}</span>
<a href="#l24.25"></a><span id="l24.25"> </span>
<a href="#l24.26"></a><span id="l24.26"> protected:</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineminus">-  bool    WriteMailItem( PRUint32 flags, PRUint32 offset, PRUint32 size, PRUint32 *pTotalMsgSize = nsnull);</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineminus">-  virtual void  CleanUp( void);</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+  bool    WriteMailItem(PRUint32 flags, PRUint32 offset, PRUint32 size, PRUint32 *pTotalMsgSize = nsnull);</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+  virtual void  CleanUp(void);</span>
<a href="#l24.31"></a><span id="l24.31"> </span>
<a href="#l24.32"></a><span id="l24.32"> private:</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-  void  ReportWriteError( nsIFile * file, bool fatal = true);</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-  void  ReportReadError( nsIFile * file, bool fatal = true);</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+  void  ReportWriteError(nsIFile * file, bool fatal = true);</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+  void  ReportReadError(nsIFile * file, bool fatal = true);</span>
<a href="#l24.37"></a><span id="l24.37">   bool CopyMbxFileBytes(PRUint32 flags, PRUint32 numBytes);</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">-  bool IsFromLineKey( PRUint8 *pBuf, PRUint32 max);</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+  bool IsFromLineKey(PRUint8 *pBuf, PRUint32 max);</span>
<a href="#l24.40"></a><span id="l24.40"> </span>
<a href="#l24.41"></a><span id="l24.41"> public:</span>
<a href="#l24.42"></a><span id="l24.42">   PRUint32      m_msgCount;</span>
<a href="#l24.43"></a><span id="l24.43"> </span>
<a href="#l24.44"></a><span id="l24.44"> protected:</span>
<a href="#l24.45"></a><span id="l24.45">   PRUint32 *    m_pDone;</span>
<a href="#l24.46"></a><span id="l24.46">   nsString      m_name;</span>
<a href="#l24.47"></a><span id="l24.47">   nsCOMPtr &lt;nsIFile&gt; m_mbxFile;</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineat">@@ -87,128 +87,128 @@ protected:</span>
<a href="#l24.49"></a><span id="l24.49"> </span>
<a href="#l24.50"></a><span id="l24.50">   static const char *  m_pFromLine;</span>
<a href="#l24.51"></a><span id="l24.51"> </span>
<a href="#l24.52"></a><span id="l24.52"> };</span>
<a href="#l24.53"></a><span id="l24.53"> </span>
<a href="#l24.54"></a><span id="l24.54"> </span>
<a href="#l24.55"></a><span id="l24.55"> class CIndexScanner : public CMbxScanner {</span>
<a href="#l24.56"></a><span id="l24.56"> public:</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-  CIndexScanner( nsString&amp; name, nsIFile * idxFile, nsIFile * mbxFile, nsIFile *dstFile);</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineplus">+  CIndexScanner(nsString&amp; name, nsIFile * idxFile, nsIFile * mbxFile, nsIFile *dstFile);</span>
<a href="#l24.59"></a><span id="l24.59">   ~CIndexScanner();</span>
<a href="#l24.60"></a><span id="l24.60"> </span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-  virtual bool    Initialize( void);</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-  virtual bool    DoWork( bool *pAbort, PRUint32 *pDone, PRUint32 *pCount);</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+  virtual bool    Initialize(void);</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineplus">+  virtual bool    DoWork(bool *pAbort, PRUint32 *pDone, PRUint32 *pCount);</span>
<a href="#l24.65"></a><span id="l24.65"> </span>
<a href="#l24.66"></a><span id="l24.66"> protected:</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineminus">-  virtual void    CleanUp( void);</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineplus">+  virtual void    CleanUp(void);</span>
<a href="#l24.69"></a><span id="l24.69"> </span>
<a href="#l24.70"></a><span id="l24.70"> private:</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineminus">-  bool            ValidateIdxFile( void);</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineminus">-  bool            GetMailItem( PRUint32 *pFlags, PRUint32 *pOffset, PRUint32 *pSize);</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+  bool            ValidateIdxFile(void);</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+  bool            GetMailItem(PRUint32 *pFlags, PRUint32 *pOffset, PRUint32 *pSize);</span>
<a href="#l24.75"></a><span id="l24.75"> </span>
<a href="#l24.76"></a><span id="l24.76"> </span>
<a href="#l24.77"></a><span id="l24.77"> private:</span>
<a href="#l24.78"></a><span id="l24.78">   nsCOMPtr &lt;nsIFile&gt;   m_idxFile;</span>
<a href="#l24.79"></a><span id="l24.79">   nsCOMPtr &lt;nsIInputStream&gt; m_idxFileInputStream;</span>
<a href="#l24.80"></a><span id="l24.80">   PRUint32        m_numMessages;</span>
<a href="#l24.81"></a><span id="l24.81">   PRUint32        m_idxOffset;</span>
<a href="#l24.82"></a><span id="l24.82">   PRUint32        m_curItemIndex;</span>
<a href="#l24.83"></a><span id="l24.83"> };</span>
<a href="#l24.84"></a><span id="l24.84"> </span>
<a href="#l24.85"></a><span id="l24.85"> </span>
<a href="#l24.86"></a><span id="l24.86" class="difflineminus">-bool CImportMailbox::ImportMailbox( PRUint32 *pDone, bool *pAbort, nsString&amp; name, nsIFile * inFile, nsIFile * outFile, PRUint32 *pCount)</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineplus">+bool CImportMailbox::ImportMailbox(PRUint32 *pDone, bool *pAbort, nsString&amp; name, nsIFile * inFile, nsIFile * outFile, PRUint32 *pCount)</span>
<a href="#l24.88"></a><span id="l24.88"> {</span>
<a href="#l24.89"></a><span id="l24.89">   bool    done = false;</span>
<a href="#l24.90"></a><span id="l24.90">   nsresult rv;</span>
<a href="#l24.91"></a><span id="l24.91">   nsCOMPtr &lt;nsILocalFile&gt; localInFile = do_QueryInterface(inFile, &amp;rv);</span>
<a href="#l24.92"></a><span id="l24.92">   nsCOMPtr &lt;nsILocalFile&gt; idxFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l24.93"></a><span id="l24.93">   if (NS_SUCCEEDED(rv))</span>
<a href="#l24.94"></a><span id="l24.94">     rv  = idxFile-&gt;InitWithFile(localInFile);</span>
<a href="#l24.95"></a><span id="l24.95">   if (NS_FAILED(rv)) {</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineminus">-    IMPORT_LOG0( &quot;New file spec failed!\n&quot;);</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineminus">-    return( false);</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineplus">+    IMPORT_LOG0(&quot;New file spec failed!\n&quot;);</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+    return false;</span>
<a href="#l24.100"></a><span id="l24.100">   }</span>
<a href="#l24.101"></a><span id="l24.101"> </span>
<a href="#l24.102"></a><span id="l24.102">   if (GetIndexFile(idxFile)) {</span>
<a href="#l24.103"></a><span id="l24.103"> </span>
<a href="#l24.104"></a><span id="l24.104" class="difflineminus">-    IMPORT_LOG1( &quot;Using index file for: %S\n&quot;, name.get());</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineplus">+    IMPORT_LOG1(&quot;Using index file for: %S\n&quot;, name.get());</span>
<a href="#l24.106"></a><span id="l24.106"> </span>
<a href="#l24.107"></a><span id="l24.107" class="difflineminus">-    CIndexScanner *pIdxScanner = new CIndexScanner( name, idxFile, inFile, outFile);</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineplus">+    CIndexScanner *pIdxScanner = new CIndexScanner(name, idxFile, inFile, outFile);</span>
<a href="#l24.109"></a><span id="l24.109">     if (pIdxScanner-&gt;Initialize()) {</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineminus">-      if (pIdxScanner-&gt;DoWork( pAbort, pDone, pCount)) {</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineplus">+      if (pIdxScanner-&gt;DoWork(pAbort, pDone, pCount)) {</span>
<a href="#l24.112"></a><span id="l24.112">         done = true;</span>
<a href="#l24.113"></a><span id="l24.113">       }</span>
<a href="#l24.114"></a><span id="l24.114">       else {</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineminus">-        IMPORT_LOG0( &quot;CIndexScanner::DoWork() failed\n&quot;);</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineplus">+        IMPORT_LOG0(&quot;CIndexScanner::DoWork() failed\n&quot;);</span>
<a href="#l24.117"></a><span id="l24.117">       }</span>
<a href="#l24.118"></a><span id="l24.118">     }</span>
<a href="#l24.119"></a><span id="l24.119">     else {</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineminus">-      IMPORT_LOG0( &quot;CIndexScanner::Initialize() failed\n&quot;);</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineplus">+      IMPORT_LOG0(&quot;CIndexScanner::Initialize() failed\n&quot;);</span>
<a href="#l24.122"></a><span id="l24.122">     }</span>
<a href="#l24.123"></a><span id="l24.123"> </span>
<a href="#l24.124"></a><span id="l24.124">     delete pIdxScanner;</span>
<a href="#l24.125"></a><span id="l24.125">   }</span>
<a href="#l24.126"></a><span id="l24.126"> </span>
<a href="#l24.127"></a><span id="l24.127">   if (done)</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineminus">-    return( done);</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineplus">+    return done;</span>
<a href="#l24.130"></a><span id="l24.130"> </span>
<a href="#l24.131"></a><span id="l24.131">     /*</span>
<a href="#l24.132"></a><span id="l24.132">     something went wrong with the index file, just scan the mailbox</span>
<a href="#l24.133"></a><span id="l24.133">     file itself.</span>
<a href="#l24.134"></a><span id="l24.134">   */</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineminus">-  CMbxScanner *pMbx = new CMbxScanner( name, inFile, outFile);</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineplus">+  CMbxScanner *pMbx = new CMbxScanner(name, inFile, outFile);</span>
<a href="#l24.137"></a><span id="l24.137">   if (pMbx-&gt;Initialize()) {</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineminus">-    if (pMbx-&gt;DoWork( pAbort, pDone, pCount)) {</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineplus">+    if (pMbx-&gt;DoWork(pAbort, pDone, pCount)) {</span>
<a href="#l24.140"></a><span id="l24.140">       done = true;</span>
<a href="#l24.141"></a><span id="l24.141">     }</span>
<a href="#l24.142"></a><span id="l24.142">     else {</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineminus">-      IMPORT_LOG0( &quot;CMbxScanner::DoWork() failed\n&quot;);</span>
<a href="#l24.144"></a><span id="l24.144" class="difflineplus">+      IMPORT_LOG0(&quot;CMbxScanner::DoWork() failed\n&quot;);</span>
<a href="#l24.145"></a><span id="l24.145">     }</span>
<a href="#l24.146"></a><span id="l24.146">   }</span>
<a href="#l24.147"></a><span id="l24.147">   else {</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineminus">-    IMPORT_LOG0( &quot;CMbxScanner::Initialize() failed\n&quot;);</span>
<a href="#l24.149"></a><span id="l24.149" class="difflineplus">+    IMPORT_LOG0(&quot;CMbxScanner::Initialize() failed\n&quot;);</span>
<a href="#l24.150"></a><span id="l24.150">   }</span>
<a href="#l24.151"></a><span id="l24.151"> </span>
<a href="#l24.152"></a><span id="l24.152">   delete pMbx;</span>
<a href="#l24.153"></a><span id="l24.153" class="difflineminus">-  return( done);</span>
<a href="#l24.154"></a><span id="l24.154" class="difflineplus">+  return done;</span>
<a href="#l24.155"></a><span id="l24.155"> }</span>
<a href="#l24.156"></a><span id="l24.156"> </span>
<a href="#l24.157"></a><span id="l24.157"> </span>
<a href="#l24.158"></a><span id="l24.158" class="difflineminus">-bool CImportMailbox::GetIndexFile( nsIFile* file)</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineplus">+bool CImportMailbox::GetIndexFile(nsIFile* file)</span>
<a href="#l24.160"></a><span id="l24.160"> {</span>
<a href="#l24.161"></a><span id="l24.161">   nsCString pLeaf;</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineminus">-  if (NS_FAILED( file-&gt;GetNativeLeafName(pLeaf)))</span>
<a href="#l24.163"></a><span id="l24.163" class="difflineminus">-    return( false);</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineplus">+  if (NS_FAILED(file-&gt;GetNativeLeafName(pLeaf)))</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineplus">+    return false;</span>
<a href="#l24.166"></a><span id="l24.166">   PRInt32  len = pLeaf.Length();</span>
<a href="#l24.167"></a><span id="l24.167">   if (len &lt; 5)</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineminus">-    return( false);</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineplus">+    return false;</span>
<a href="#l24.170"></a><span id="l24.170"> </span>
<a href="#l24.171"></a><span id="l24.171">   pLeaf.Replace(len - 3, 3, NS_LITERAL_CSTRING(&quot;idx&quot;));</span>
<a href="#l24.172"></a><span id="l24.172"> </span>
<a href="#l24.173"></a><span id="l24.173" class="difflineminus">-  IMPORT_LOG1( &quot;Looking for index leaf name: %s\n&quot;, pLeaf);</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineplus">+  IMPORT_LOG1(&quot;Looking for index leaf name: %s\n&quot;, pLeaf);</span>
<a href="#l24.175"></a><span id="l24.175"> </span>
<a href="#l24.176"></a><span id="l24.176">   nsresult  rv;</span>
<a href="#l24.177"></a><span id="l24.177" class="difflineminus">-  rv = file-&gt;SetNativeLeafName( pLeaf);</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineplus">+  rv = file-&gt;SetNativeLeafName(pLeaf);</span>
<a href="#l24.179"></a><span id="l24.179"> </span>
<a href="#l24.180"></a><span id="l24.180">   bool    isFile = false;</span>
<a href="#l24.181"></a><span id="l24.181">   bool    exists = false;</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineminus">-  if (NS_SUCCEEDED( rv)) rv = file-&gt;IsFile( &amp;isFile);</span>
<a href="#l24.183"></a><span id="l24.183" class="difflineminus">-  if (NS_SUCCEEDED( rv)) rv = file-&gt;Exists( &amp;exists);</span>
<a href="#l24.184"></a><span id="l24.184" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = file-&gt;IsFile(&amp;isFile);</span>
<a href="#l24.185"></a><span id="l24.185" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = file-&gt;Exists(&amp;exists);</span>
<a href="#l24.186"></a><span id="l24.186"> </span>
<a href="#l24.187"></a><span id="l24.187">   return (isFile &amp;&amp; exists);</span>
<a href="#l24.188"></a><span id="l24.188"> }</span>
<a href="#l24.189"></a><span id="l24.189"> </span>
<a href="#l24.190"></a><span id="l24.190"> </span>
<a href="#l24.191"></a><span id="l24.191"> const char *CMbxScanner::m_pFromLine = &quot;From - Mon Jan 1 00:00:00 1965\x0D\x0A&quot;;</span>
<a href="#l24.192"></a><span id="l24.192"> // let's try a 16K buffer and see how well that works?</span>
<a href="#l24.193"></a><span id="l24.193"> #define  kBufferKB  16</span>
<a href="#l24.194"></a><span id="l24.194"> </span>
<a href="#l24.195"></a><span id="l24.195"> </span>
<a href="#l24.196"></a><span id="l24.196" class="difflineminus">-CMbxScanner::CMbxScanner( nsString&amp; name, nsIFile* mbxFile, nsIFile* dstFile)</span>
<a href="#l24.197"></a><span id="l24.197" class="difflineplus">+CMbxScanner::CMbxScanner(nsString&amp; name, nsIFile* mbxFile, nsIFile* dstFile)</span>
<a href="#l24.198"></a><span id="l24.198"> {</span>
<a href="#l24.199"></a><span id="l24.199">   m_msgCount = 0;</span>
<a href="#l24.200"></a><span id="l24.200">   m_name = name;</span>
<a href="#l24.201"></a><span id="l24.201">   m_mbxFile = mbxFile;</span>
<a href="#l24.202"></a><span id="l24.202">   m_dstFile = dstFile;</span>
<a href="#l24.203"></a><span id="l24.203">   m_pInBuffer = nsnull;</span>
<a href="#l24.204"></a><span id="l24.204">   m_pOutBuffer = nsnull;</span>
<a href="#l24.205"></a><span id="l24.205">   m_bufSz = 0;</span>
<a href="#l24.206"></a><span id="l24.206" class="difflineat">@@ -218,220 +218,220 @@ CMbxScanner::CMbxScanner( nsString&amp; name</span>
<a href="#l24.207"></a><span id="l24.207">   m_mbxOffset = 0;</span>
<a href="#l24.208"></a><span id="l24.208"> }</span>
<a href="#l24.209"></a><span id="l24.209"> </span>
<a href="#l24.210"></a><span id="l24.210"> CMbxScanner::~CMbxScanner()</span>
<a href="#l24.211"></a><span id="l24.211"> {</span>
<a href="#l24.212"></a><span id="l24.212">   CleanUp();</span>
<a href="#l24.213"></a><span id="l24.213"> }</span>
<a href="#l24.214"></a><span id="l24.214"> </span>
<a href="#l24.215"></a><span id="l24.215" class="difflineminus">-void CMbxScanner::ReportWriteError( nsIFile * file, bool fatal)</span>
<a href="#l24.216"></a><span id="l24.216" class="difflineplus">+void CMbxScanner::ReportWriteError(nsIFile * file, bool fatal)</span>
<a href="#l24.217"></a><span id="l24.217"> {</span>
<a href="#l24.218"></a><span id="l24.218">   m_fatalError = fatal;</span>
<a href="#l24.219"></a><span id="l24.219"> }</span>
<a href="#l24.220"></a><span id="l24.220"> </span>
<a href="#l24.221"></a><span id="l24.221" class="difflineminus">-void CMbxScanner::ReportReadError( nsIFile * file, bool fatal)</span>
<a href="#l24.222"></a><span id="l24.222" class="difflineplus">+void CMbxScanner::ReportReadError(nsIFile * file, bool fatal)</span>
<a href="#l24.223"></a><span id="l24.223"> {</span>
<a href="#l24.224"></a><span id="l24.224">   m_fatalError = fatal;</span>
<a href="#l24.225"></a><span id="l24.225"> }</span>
<a href="#l24.226"></a><span id="l24.226"> </span>
<a href="#l24.227"></a><span id="l24.227" class="difflineminus">-bool CMbxScanner::Initialize( void)</span>
<a href="#l24.228"></a><span id="l24.228" class="difflineplus">+bool CMbxScanner::Initialize(void)</span>
<a href="#l24.229"></a><span id="l24.229"> {</span>
<a href="#l24.230"></a><span id="l24.230">   m_bufSz = (kBufferKB * 1024);</span>
<a href="#l24.231"></a><span id="l24.231">   m_pInBuffer = new PRUint8[m_bufSz];</span>
<a href="#l24.232"></a><span id="l24.232">   m_pOutBuffer = new PRUint8[m_bufSz];</span>
<a href="#l24.233"></a><span id="l24.233">   if (!m_pInBuffer || !m_pOutBuffer) {</span>
<a href="#l24.234"></a><span id="l24.234" class="difflineminus">-    return( false);</span>
<a href="#l24.235"></a><span id="l24.235" class="difflineplus">+    return false;</span>
<a href="#l24.236"></a><span id="l24.236">   }</span>
<a href="#l24.237"></a><span id="l24.237"> </span>
<a href="#l24.238"></a><span id="l24.238" class="difflineminus">-  m_mbxFile-&gt;GetFileSize( &amp;m_mbxFileSize);</span>
<a href="#l24.239"></a><span id="l24.239" class="difflineplus">+  m_mbxFile-&gt;GetFileSize(&amp;m_mbxFileSize);</span>
<a href="#l24.240"></a><span id="l24.240">   // open the mailbox file...</span>
<a href="#l24.241"></a><span id="l24.241" class="difflineminus">-  if (NS_FAILED( NS_NewLocalFileInputStream(getter_AddRefs(m_mbxFileInputStream), m_mbxFile))) {</span>
<a href="#l24.242"></a><span id="l24.242" class="difflineplus">+  if (NS_FAILED(NS_NewLocalFileInputStream(getter_AddRefs(m_mbxFileInputStream), m_mbxFile))) {</span>
<a href="#l24.243"></a><span id="l24.243">     CleanUp();</span>
<a href="#l24.244"></a><span id="l24.244" class="difflineminus">-    return( false);</span>
<a href="#l24.245"></a><span id="l24.245" class="difflineplus">+    return false;</span>
<a href="#l24.246"></a><span id="l24.246">   }</span>
<a href="#l24.247"></a><span id="l24.247"> </span>
<a href="#l24.248"></a><span id="l24.248">   if (NS_FAILED(MsgNewBufferedFileOutputStream(getter_AddRefs(m_dstFileOutputStream), m_dstFile, -1, 0600))) {</span>
<a href="#l24.249"></a><span id="l24.249">     CleanUp();</span>
<a href="#l24.250"></a><span id="l24.250" class="difflineminus">-    return( false);</span>
<a href="#l24.251"></a><span id="l24.251" class="difflineplus">+    return false;</span>
<a href="#l24.252"></a><span id="l24.252">   }</span>
<a href="#l24.253"></a><span id="l24.253"> </span>
<a href="#l24.254"></a><span id="l24.254" class="difflineminus">-  return( true);</span>
<a href="#l24.255"></a><span id="l24.255" class="difflineplus">+  return true;</span>
<a href="#l24.256"></a><span id="l24.256"> }</span>
<a href="#l24.257"></a><span id="l24.257"> </span>
<a href="#l24.258"></a><span id="l24.258"> </span>
<a href="#l24.259"></a><span id="l24.259"> #define  kMbxHeaderSize    0x0054</span>
<a href="#l24.260"></a><span id="l24.260"> #define kMbxMessageHeaderSz  16</span>
<a href="#l24.261"></a><span id="l24.261"> </span>
<a href="#l24.262"></a><span id="l24.262" class="difflineminus">-bool CMbxScanner::DoWork( bool *pAbort, PRUint32 *pDone, PRUint32 *pCount)</span>
<a href="#l24.263"></a><span id="l24.263" class="difflineplus">+bool CMbxScanner::DoWork(bool *pAbort, PRUint32 *pDone, PRUint32 *pCount)</span>
<a href="#l24.264"></a><span id="l24.264"> {</span>
<a href="#l24.265"></a><span id="l24.265">   m_mbxOffset = kMbxHeaderSize;</span>
<a href="#l24.266"></a><span id="l24.266">   m_didBytes = kMbxHeaderSize;</span>
<a href="#l24.267"></a><span id="l24.267"> </span>
<a href="#l24.268"></a><span id="l24.268">   while (!(*pAbort) &amp;&amp; ((m_mbxOffset + kMbxMessageHeaderSz) &lt; m_mbxFileSize)) {</span>
<a href="#l24.269"></a><span id="l24.269">     PRUint32    msgSz;</span>
<a href="#l24.270"></a><span id="l24.270" class="difflineminus">-    if (!WriteMailItem( 0, m_mbxOffset, 0, &amp;msgSz)) {</span>
<a href="#l24.271"></a><span id="l24.271" class="difflineplus">+    if (!WriteMailItem(0, m_mbxOffset, 0, &amp;msgSz)) {</span>
<a href="#l24.272"></a><span id="l24.272">       if (!WasErrorFatal())</span>
<a href="#l24.273"></a><span id="l24.273" class="difflineminus">-        ReportReadError( m_mbxFile);</span>
<a href="#l24.274"></a><span id="l24.274" class="difflineminus">-      return( false);</span>
<a href="#l24.275"></a><span id="l24.275" class="difflineplus">+        ReportReadError(m_mbxFile);</span>
<a href="#l24.276"></a><span id="l24.276" class="difflineplus">+      return false;</span>
<a href="#l24.277"></a><span id="l24.277">     }</span>
<a href="#l24.278"></a><span id="l24.278">     m_mbxOffset += msgSz;</span>
<a href="#l24.279"></a><span id="l24.279">     m_didBytes += msgSz;</span>
<a href="#l24.280"></a><span id="l24.280">     m_msgCount++;</span>
<a href="#l24.281"></a><span id="l24.281">     if (pDone)</span>
<a href="#l24.282"></a><span id="l24.282">       *pDone = m_didBytes;</span>
<a href="#l24.283"></a><span id="l24.283">     if (pCount)</span>
<a href="#l24.284"></a><span id="l24.284">       *pCount = m_msgCount;</span>
<a href="#l24.285"></a><span id="l24.285">   }</span>
<a href="#l24.286"></a><span id="l24.286"> </span>
<a href="#l24.287"></a><span id="l24.287">   CleanUp();</span>
<a href="#l24.288"></a><span id="l24.288"> </span>
<a href="#l24.289"></a><span id="l24.289" class="difflineminus">-  return( true);</span>
<a href="#l24.290"></a><span id="l24.290" class="difflineplus">+  return true;</span>
<a href="#l24.291"></a><span id="l24.291"> }</span>
<a href="#l24.292"></a><span id="l24.292"> </span>
<a href="#l24.293"></a><span id="l24.293"> </span>
<a href="#l24.294"></a><span id="l24.294" class="difflineminus">-void CMbxScanner::CleanUp( void)</span>
<a href="#l24.295"></a><span id="l24.295" class="difflineplus">+void CMbxScanner::CleanUp(void)</span>
<a href="#l24.296"></a><span id="l24.296"> {</span>
<a href="#l24.297"></a><span id="l24.297">   if (m_mbxFileInputStream)</span>
<a href="#l24.298"></a><span id="l24.298">     m_mbxFileInputStream-&gt;Close();</span>
<a href="#l24.299"></a><span id="l24.299">   if (m_dstFileOutputStream)</span>
<a href="#l24.300"></a><span id="l24.300">     m_dstFileOutputStream-&gt;Close();</span>
<a href="#l24.301"></a><span id="l24.301"> </span>
<a href="#l24.302"></a><span id="l24.302">   delete [] m_pInBuffer;</span>
<a href="#l24.303"></a><span id="l24.303">   m_pInBuffer = nsnull;</span>
<a href="#l24.304"></a><span id="l24.304"> </span>
<a href="#l24.305"></a><span id="l24.305">   delete [] m_pOutBuffer;</span>
<a href="#l24.306"></a><span id="l24.306">   m_pOutBuffer = nsnull;</span>
<a href="#l24.307"></a><span id="l24.307"> }</span>
<a href="#l24.308"></a><span id="l24.308"> </span>
<a href="#l24.309"></a><span id="l24.309"> </span>
<a href="#l24.310"></a><span id="l24.310"> #define  kNumMbxLongsToRead  4</span>
<a href="#l24.311"></a><span id="l24.311"> </span>
<a href="#l24.312"></a><span id="l24.312" class="difflineminus">-bool CMbxScanner::WriteMailItem( PRUint32 flags, PRUint32 offset, PRUint32 size, PRUint32 *pTotalMsgSize)</span>
<a href="#l24.313"></a><span id="l24.313" class="difflineplus">+bool CMbxScanner::WriteMailItem(PRUint32 flags, PRUint32 offset, PRUint32 size, PRUint32 *pTotalMsgSize)</span>
<a href="#l24.314"></a><span id="l24.314"> {</span>
<a href="#l24.315"></a><span id="l24.315">   PRUint32  values[kNumMbxLongsToRead];</span>
<a href="#l24.316"></a><span id="l24.316" class="difflineminus">-  PRInt32    cnt = kNumMbxLongsToRead * sizeof( PRUint32);</span>
<a href="#l24.317"></a><span id="l24.317" class="difflineplus">+  PRInt32    cnt = kNumMbxLongsToRead * sizeof(PRUint32);</span>
<a href="#l24.318"></a><span id="l24.318">   nsresult  rv;</span>
<a href="#l24.319"></a><span id="l24.319">   PRUint32    cntRead;</span>
<a href="#l24.320"></a><span id="l24.320">   PRInt8 *  pChar = (PRInt8 *) values;</span>
<a href="#l24.321"></a><span id="l24.321"> </span>
<a href="#l24.322"></a><span id="l24.322">   nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(m_mbxFileInputStream);</span>
<a href="#l24.323"></a><span id="l24.323">   rv = seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET,  offset);</span>
<a href="#l24.324"></a><span id="l24.324"> </span>
<a href="#l24.325"></a><span id="l24.325" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l24.326"></a><span id="l24.326" class="difflineminus">-    IMPORT_LOG1( &quot;Mbx seek error: 0x%lx\n&quot;, offset);</span>
<a href="#l24.327"></a><span id="l24.327" class="difflineminus">-    return( false);</span>
<a href="#l24.328"></a><span id="l24.328" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l24.329"></a><span id="l24.329" class="difflineplus">+    IMPORT_LOG1(&quot;Mbx seek error: 0x%lx\n&quot;, offset);</span>
<a href="#l24.330"></a><span id="l24.330" class="difflineplus">+    return false;</span>
<a href="#l24.331"></a><span id="l24.331">   }</span>
<a href="#l24.332"></a><span id="l24.332" class="difflineminus">-  rv = m_mbxFileInputStream-&gt;Read( (char *) pChar, cnt, &amp;cntRead);</span>
<a href="#l24.333"></a><span id="l24.333" class="difflineminus">-  if (NS_FAILED( rv) || (cntRead != cnt)) {</span>
<a href="#l24.334"></a><span id="l24.334" class="difflineminus">-    IMPORT_LOG1( &quot;Mbx read error at: 0x%lx\n&quot;, offset);</span>
<a href="#l24.335"></a><span id="l24.335" class="difflineminus">-    return( false);</span>
<a href="#l24.336"></a><span id="l24.336" class="difflineplus">+  rv = m_mbxFileInputStream-&gt;Read((char *) pChar, cnt, &amp;cntRead);</span>
<a href="#l24.337"></a><span id="l24.337" class="difflineplus">+  if (NS_FAILED(rv) || (cntRead != cnt)) {</span>
<a href="#l24.338"></a><span id="l24.338" class="difflineplus">+    IMPORT_LOG1(&quot;Mbx read error at: 0x%lx\n&quot;, offset);</span>
<a href="#l24.339"></a><span id="l24.339" class="difflineplus">+    return false;</span>
<a href="#l24.340"></a><span id="l24.340">   }</span>
<a href="#l24.341"></a><span id="l24.341">   if (values[0] != 0x7F007F00) {</span>
<a href="#l24.342"></a><span id="l24.342" class="difflineminus">-    IMPORT_LOG2( &quot;Mbx tag field doesn't match: 0x%lx, at offset: 0x%lx\n&quot;, values[0], offset);</span>
<a href="#l24.343"></a><span id="l24.343" class="difflineminus">-    return( false);</span>
<a href="#l24.344"></a><span id="l24.344" class="difflineplus">+    IMPORT_LOG2(&quot;Mbx tag field doesn't match: 0x%lx, at offset: 0x%lx\n&quot;, values[0], offset);</span>
<a href="#l24.345"></a><span id="l24.345" class="difflineplus">+    return false;</span>
<a href="#l24.346"></a><span id="l24.346">   }</span>
<a href="#l24.347"></a><span id="l24.347">   if (size &amp;&amp; (values[2] != size)) {</span>
<a href="#l24.348"></a><span id="l24.348" class="difflineminus">-    IMPORT_LOG3( &quot;Mbx size doesn't match idx, mbx: %ld, idx: %ld, at offset: 0x%lx\n&quot;, values[2], size, offset);</span>
<a href="#l24.349"></a><span id="l24.349" class="difflineminus">-    return( false);</span>
<a href="#l24.350"></a><span id="l24.350" class="difflineplus">+    IMPORT_LOG3(&quot;Mbx size doesn't match idx, mbx: %ld, idx: %ld, at offset: 0x%lx\n&quot;, values[2], size, offset);</span>
<a href="#l24.351"></a><span id="l24.351" class="difflineplus">+    return false;</span>
<a href="#l24.352"></a><span id="l24.352">   }</span>
<a href="#l24.353"></a><span id="l24.353"> </span>
<a href="#l24.354"></a><span id="l24.354">   if (pTotalMsgSize != nsnull)</span>
<a href="#l24.355"></a><span id="l24.355">     *pTotalMsgSize = values[2];</span>
<a href="#l24.356"></a><span id="l24.356"> </span>
<a href="#l24.357"></a><span id="l24.357">   // everything looks kosher...</span>
<a href="#l24.358"></a><span id="l24.358">   // the actual message text follows and is values[3] bytes long...</span>
<a href="#l24.359"></a><span id="l24.359" class="difflineminus">-  return( CopyMbxFileBytes(flags,  values[3]));</span>
<a href="#l24.360"></a><span id="l24.360" class="difflineplus">+  return CopyMbxFileBytes(flags,  values[3]);</span>
<a href="#l24.361"></a><span id="l24.361"> }</span>
<a href="#l24.362"></a><span id="l24.362"> </span>
<a href="#l24.363"></a><span id="l24.363" class="difflineminus">-bool CMbxScanner::IsFromLineKey( PRUint8 * pBuf, PRUint32 max)</span>
<a href="#l24.364"></a><span id="l24.364" class="difflineplus">+bool CMbxScanner::IsFromLineKey(PRUint8 * pBuf, PRUint32 max)</span>
<a href="#l24.365"></a><span id="l24.365"> {</span>
<a href="#l24.366"></a><span id="l24.366">   return (max &gt; 5 &amp;&amp; (pBuf[0] == 'F') &amp;&amp; (pBuf[1] == 'r') &amp;&amp; (pBuf[2] == 'o') &amp;&amp; (pBuf[3] == 'm') &amp;&amp; (pBuf[4] == ' '));</span>
<a href="#l24.367"></a><span id="l24.367"> }</span>
<a href="#l24.368"></a><span id="l24.368"> </span>
<a href="#l24.369"></a><span id="l24.369"> </span>
<a href="#l24.370"></a><span id="l24.370" class="difflineminus">-#define IS_ANY_SPACE( _ch) ((_ch == ' ') || (_ch == '\t') || (_ch == 10) || (_ch == 13))</span>
<a href="#l24.371"></a><span id="l24.371" class="difflineplus">+#define IS_ANY_SPACE(_ch) ((_ch == ' ') || (_ch == '\t') || (_ch == 10) || (_ch == 13))</span>
<a href="#l24.372"></a><span id="l24.372"> </span>
<a href="#l24.373"></a><span id="l24.373"> </span>
<a href="#l24.374"></a><span id="l24.374"> bool CMbxScanner::CopyMbxFileBytes(PRUint32 flags, PRUint32 numBytes)</span>
<a href="#l24.375"></a><span id="l24.375"> {</span>
<a href="#l24.376"></a><span id="l24.376">   if (!numBytes)</span>
<a href="#l24.377"></a><span id="l24.377" class="difflineminus">-    return( true);</span>
<a href="#l24.378"></a><span id="l24.378" class="difflineplus">+    return true;</span>
<a href="#l24.379"></a><span id="l24.379"> </span>
<a href="#l24.380"></a><span id="l24.380">   PRUint32  cnt;</span>
<a href="#l24.381"></a><span id="l24.381">   PRUint8   last[2] = {0, 0};</span>
<a href="#l24.382"></a><span id="l24.382">   PRUint32  inIdx = 0;</span>
<a href="#l24.383"></a><span id="l24.383">   bool      first = true;</span>
<a href="#l24.384"></a><span id="l24.384">   PRUint8 * pIn;</span>
<a href="#l24.385"></a><span id="l24.385">   PRUint8 * pStart;</span>
<a href="#l24.386"></a><span id="l24.386" class="difflineminus">-  PRInt32   fromLen = strlen( m_pFromLine);</span>
<a href="#l24.387"></a><span id="l24.387" class="difflineplus">+  PRInt32   fromLen = strlen(m_pFromLine);</span>
<a href="#l24.388"></a><span id="l24.388">   nsresult  rv;</span>
<a href="#l24.389"></a><span id="l24.389">   PRUint32   cntRead;</span>
<a href="#l24.390"></a><span id="l24.390">   PRUint8 * pChar;</span>
<a href="#l24.391"></a><span id="l24.391"> </span>
<a href="#l24.392"></a><span id="l24.392">   while (numBytes) {</span>
<a href="#l24.393"></a><span id="l24.393">     if (numBytes &gt; (m_bufSz - inIdx))</span>
<a href="#l24.394"></a><span id="l24.394">       cnt = m_bufSz - inIdx;</span>
<a href="#l24.395"></a><span id="l24.395">     else</span>
<a href="#l24.396"></a><span id="l24.396">       cnt = numBytes;</span>
<a href="#l24.397"></a><span id="l24.397">     // Read some of the message from the file...</span>
<a href="#l24.398"></a><span id="l24.398">     pChar = m_pInBuffer + inIdx;</span>
<a href="#l24.399"></a><span id="l24.399" class="difflineminus">-    rv = m_mbxFileInputStream-&gt;Read( (char *) pChar, (PRInt32)cnt, &amp;cntRead);</span>
<a href="#l24.400"></a><span id="l24.400" class="difflineminus">-    if (NS_FAILED( rv) || (cntRead != (PRInt32)cnt)) {</span>
<a href="#l24.401"></a><span id="l24.401" class="difflineminus">-      ReportReadError( m_mbxFile);</span>
<a href="#l24.402"></a><span id="l24.402" class="difflineminus">-      return( false);</span>
<a href="#l24.403"></a><span id="l24.403" class="difflineplus">+    rv = m_mbxFileInputStream-&gt;Read((char *) pChar, (PRInt32)cnt, &amp;cntRead);</span>
<a href="#l24.404"></a><span id="l24.404" class="difflineplus">+    if (NS_FAILED(rv) || (cntRead != (PRInt32)cnt)) {</span>
<a href="#l24.405"></a><span id="l24.405" class="difflineplus">+      ReportReadError(m_mbxFile);</span>
<a href="#l24.406"></a><span id="l24.406" class="difflineplus">+      return false;</span>
<a href="#l24.407"></a><span id="l24.407">     }</span>
<a href="#l24.408"></a><span id="l24.408">     // Keep track of the last 2 bytes of the message for terminating EOL logic</span>
<a href="#l24.409"></a><span id="l24.409">     if (cnt &lt; 2) {</span>
<a href="#l24.410"></a><span id="l24.410">       last[0] = last[1];</span>
<a href="#l24.411"></a><span id="l24.411">       last[1] = m_pInBuffer[cnt - 1];</span>
<a href="#l24.412"></a><span id="l24.412">     }</span>
<a href="#l24.413"></a><span id="l24.413">     else {</span>
<a href="#l24.414"></a><span id="l24.414">       last[0] = m_pInBuffer[cnt - 2];</span>
<a href="#l24.415"></a><span id="l24.415">       last[1] = m_pInBuffer[cnt - 1];</span>
<a href="#l24.416"></a><span id="l24.416">     }</span>
<a href="#l24.417"></a><span id="l24.417"> </span>
<a href="#l24.418"></a><span id="l24.418">     inIdx = 0;</span>
<a href="#l24.419"></a><span id="l24.419">     // Handle the beginning line, don't duplicate an existing From separator</span>
<a href="#l24.420"></a><span id="l24.420">     if (first) {</span>
<a href="#l24.421"></a><span id="l24.421">       // check the first buffer to see if it already starts with a From line</span>
<a href="#l24.422"></a><span id="l24.422">       // If it does, throw it away and use our own</span>
<a href="#l24.423"></a><span id="l24.423" class="difflineminus">-      if (IsFromLineKey( m_pInBuffer, cnt)) {</span>
<a href="#l24.424"></a><span id="l24.424" class="difflineplus">+      if (IsFromLineKey(m_pInBuffer, cnt)) {</span>
<a href="#l24.425"></a><span id="l24.425">         // skip past the first line</span>
<a href="#l24.426"></a><span id="l24.426">         while ((inIdx &lt; cnt) &amp;&amp; (m_pInBuffer[inIdx] != nsCRT::CR))</span>
<a href="#l24.427"></a><span id="l24.427">           inIdx++;</span>
<a href="#l24.428"></a><span id="l24.428" class="difflineminus">-        while ((inIdx &lt; cnt) &amp;&amp; (IS_ANY_SPACE( m_pInBuffer[inIdx])))</span>
<a href="#l24.429"></a><span id="l24.429" class="difflineplus">+        while ((inIdx &lt; cnt) &amp;&amp; (IS_ANY_SPACE(m_pInBuffer[inIdx])))</span>
<a href="#l24.430"></a><span id="l24.430">           inIdx++;</span>
<a href="#l24.431"></a><span id="l24.431">         if (inIdx &gt;= cnt) {</span>
<a href="#l24.432"></a><span id="l24.432">           // This should not occurr - it means the message starts</span>
<a href="#l24.433"></a><span id="l24.433">           // with a From separator line that is longer than our</span>
<a href="#l24.434"></a><span id="l24.434">           // file buffer!  In this bizarre case, just skip this message</span>
<a href="#l24.435"></a><span id="l24.435">           // since it is probably bogus anyway.</span>
<a href="#l24.436"></a><span id="l24.436" class="difflineminus">-          return( true);</span>
<a href="#l24.437"></a><span id="l24.437" class="difflineplus">+          return true;</span>
<a href="#l24.438"></a><span id="l24.438">         }</span>
<a href="#l24.439"></a><span id="l24.439"> </span>
<a href="#l24.440"></a><span id="l24.440">       }</span>
<a href="#l24.441"></a><span id="l24.441">       // Begin every message with a From separator</span>
<a href="#l24.442"></a><span id="l24.442" class="difflineminus">-      rv = m_dstFileOutputStream-&gt;Write( m_pFromLine, fromLen, &amp;cntRead);</span>
<a href="#l24.443"></a><span id="l24.443" class="difflineminus">-      if (NS_FAILED( rv) || (cntRead != fromLen)) {</span>
<a href="#l24.444"></a><span id="l24.444" class="difflineminus">-        ReportWriteError( m_dstFile);</span>
<a href="#l24.445"></a><span id="l24.445" class="difflineminus">-        return( false);</span>
<a href="#l24.446"></a><span id="l24.446" class="difflineplus">+      rv = m_dstFileOutputStream-&gt;Write(m_pFromLine, fromLen, &amp;cntRead);</span>
<a href="#l24.447"></a><span id="l24.447" class="difflineplus">+      if (NS_FAILED(rv) || (cntRead != fromLen)) {</span>
<a href="#l24.448"></a><span id="l24.448" class="difflineplus">+        ReportWriteError(m_dstFile);</span>
<a href="#l24.449"></a><span id="l24.449" class="difflineplus">+        return false;</span>
<a href="#l24.450"></a><span id="l24.450">       }</span>
<a href="#l24.451"></a><span id="l24.451">       char statusLine[50];</span>
<a href="#l24.452"></a><span id="l24.452">       PRUint32 msgFlags = flags; // need to convert from OE flags to mozilla flags</span>
<a href="#l24.453"></a><span id="l24.453">       PR_snprintf(statusLine, sizeof(statusLine), X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, msgFlags &amp; 0xFFFF);</span>
<a href="#l24.454"></a><span id="l24.454">       rv = m_dstFileOutputStream-&gt;Write(statusLine, strlen(statusLine), &amp;cntRead);</span>
<a href="#l24.455"></a><span id="l24.455">       if (NS_SUCCEEDED(rv) &amp;&amp; cntRead == fromLen)</span>
<a href="#l24.456"></a><span id="l24.456">       {</span>
<a href="#l24.457"></a><span id="l24.457">         PR_snprintf(statusLine, sizeof(statusLine), X_MOZILLA_STATUS2_FORMAT MSG_LINEBREAK, msgFlags &amp; 0xFFFF0000);</span>
<a href="#l24.458"></a><span id="l24.458">         rv = m_dstFileOutputStream-&gt;Write(statusLine, strlen(statusLine), &amp;cntRead);</span>
<a href="#l24.459"></a><span id="l24.459">       }</span>
<a href="#l24.460"></a><span id="l24.460" class="difflineminus">-      if (NS_FAILED( rv) || (cntRead != fromLen)) {</span>
<a href="#l24.461"></a><span id="l24.461" class="difflineminus">-        ReportWriteError( m_dstFile);</span>
<a href="#l24.462"></a><span id="l24.462" class="difflineminus">-        return( false);</span>
<a href="#l24.463"></a><span id="l24.463" class="difflineplus">+      if (NS_FAILED(rv) || (cntRead != fromLen)) {</span>
<a href="#l24.464"></a><span id="l24.464" class="difflineplus">+        ReportWriteError(m_dstFile);</span>
<a href="#l24.465"></a><span id="l24.465" class="difflineplus">+        return false;</span>
<a href="#l24.466"></a><span id="l24.466">       }</span>
<a href="#l24.467"></a><span id="l24.467">       first = false;</span>
<a href="#l24.468"></a><span id="l24.468">     }</span>
<a href="#l24.469"></a><span id="l24.469"> </span>
<a href="#l24.470"></a><span id="l24.470">     // Handle generic data, escape any lines that begin with &quot;From &quot;</span>
<a href="#l24.471"></a><span id="l24.471">     pIn = m_pInBuffer + inIdx;</span>
<a href="#l24.472"></a><span id="l24.472">     numBytes -= cnt;</span>
<a href="#l24.473"></a><span id="l24.473">     m_didBytes += cnt;</span>
<a href="#l24.474"></a><span id="l24.474" class="difflineat">@@ -443,130 +443,130 @@ bool CMbxScanner::CopyMbxFileBytes(PRUin</span>
<a href="#l24.475"></a><span id="l24.475">         // need more in buffer?</span>
<a href="#l24.476"></a><span id="l24.476">         if ((cnt &lt; 7) &amp;&amp; numBytes)</span>
<a href="#l24.477"></a><span id="l24.477">           break;</span>
<a href="#l24.478"></a><span id="l24.478"> </span>
<a href="#l24.479"></a><span id="l24.479">         if (cnt &gt; 6) {</span>
<a href="#l24.480"></a><span id="l24.480">           if ((pIn[1] == nsCRT::LF) &amp;&amp; IsFromLineKey(pIn + 2, cnt)) {</span>
<a href="#l24.481"></a><span id="l24.481">             inIdx += 2;</span>
<a href="#l24.482"></a><span id="l24.482">             // Match, escape it</span>
<a href="#l24.483"></a><span id="l24.483" class="difflineminus">-            rv = m_dstFileOutputStream-&gt;Write( (const char *)pStart, (PRInt32)inIdx, &amp;cntRead);</span>
<a href="#l24.484"></a><span id="l24.484" class="difflineminus">-            if (NS_SUCCEEDED( rv) &amp;&amp; (cntRead == (PRInt32)inIdx))</span>
<a href="#l24.485"></a><span id="l24.485" class="difflineminus">-              rv = m_dstFileOutputStream-&gt;Write( &quot;&gt;&quot;, 1, &amp;cntRead);</span>
<a href="#l24.486"></a><span id="l24.486" class="difflineminus">-            if (NS_FAILED( rv) || (cntRead != 1)) {</span>
<a href="#l24.487"></a><span id="l24.487" class="difflineminus">-              ReportWriteError( m_dstFile);</span>
<a href="#l24.488"></a><span id="l24.488" class="difflineminus">-              return( false);</span>
<a href="#l24.489"></a><span id="l24.489" class="difflineplus">+            rv = m_dstFileOutputStream-&gt;Write((const char *)pStart, (PRInt32)inIdx, &amp;cntRead);</span>
<a href="#l24.490"></a><span id="l24.490" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; (cntRead == (PRInt32)inIdx))</span>
<a href="#l24.491"></a><span id="l24.491" class="difflineplus">+              rv = m_dstFileOutputStream-&gt;Write(&quot;&gt;&quot;, 1, &amp;cntRead);</span>
<a href="#l24.492"></a><span id="l24.492" class="difflineplus">+            if (NS_FAILED(rv) || (cntRead != 1)) {</span>
<a href="#l24.493"></a><span id="l24.493" class="difflineplus">+              ReportWriteError(m_dstFile);</span>
<a href="#l24.494"></a><span id="l24.494" class="difflineplus">+              return false;</span>
<a href="#l24.495"></a><span id="l24.495">             }</span>
<a href="#l24.496"></a><span id="l24.496"> </span>
<a href="#l24.497"></a><span id="l24.497">             cnt -= 2;</span>
<a href="#l24.498"></a><span id="l24.498">             pIn += 2;</span>
<a href="#l24.499"></a><span id="l24.499">             inIdx = 0;</span>
<a href="#l24.500"></a><span id="l24.500">             pStart = pIn;</span>
<a href="#l24.501"></a><span id="l24.501">             continue;</span>
<a href="#l24.502"></a><span id="l24.502">           }</span>
<a href="#l24.503"></a><span id="l24.503">         }</span>
<a href="#l24.504"></a><span id="l24.504">       } // == nsCRT::CR</span>
<a href="#l24.505"></a><span id="l24.505"> </span>
<a href="#l24.506"></a><span id="l24.506">       cnt--;</span>
<a href="#l24.507"></a><span id="l24.507">       inIdx++;</span>
<a href="#l24.508"></a><span id="l24.508">       pIn++;</span>
<a href="#l24.509"></a><span id="l24.509">     }</span>
<a href="#l24.510"></a><span id="l24.510" class="difflineminus">-    rv = m_dstFileOutputStream-&gt;Write( (const char *)pStart, (PRInt32)inIdx, &amp;cntRead);</span>
<a href="#l24.511"></a><span id="l24.511" class="difflineminus">-    if (NS_FAILED( rv) || (cntRead != (PRInt32)inIdx)) {</span>
<a href="#l24.512"></a><span id="l24.512" class="difflineminus">-      ReportWriteError( m_dstFile);</span>
<a href="#l24.513"></a><span id="l24.513" class="difflineminus">-      return( false);</span>
<a href="#l24.514"></a><span id="l24.514" class="difflineplus">+    rv = m_dstFileOutputStream-&gt;Write((const char *)pStart, (PRInt32)inIdx, &amp;cntRead);</span>
<a href="#l24.515"></a><span id="l24.515" class="difflineplus">+    if (NS_FAILED(rv) || (cntRead != (PRInt32)inIdx)) {</span>
<a href="#l24.516"></a><span id="l24.516" class="difflineplus">+      ReportWriteError(m_dstFile);</span>
<a href="#l24.517"></a><span id="l24.517" class="difflineplus">+      return false;</span>
<a href="#l24.518"></a><span id="l24.518">     }</span>
<a href="#l24.519"></a><span id="l24.519"> </span>
<a href="#l24.520"></a><span id="l24.520">     if (cnt) {</span>
<a href="#l24.521"></a><span id="l24.521">       inIdx = cnt;</span>
<a href="#l24.522"></a><span id="l24.522" class="difflineminus">-      memcpy( m_pInBuffer, pIn, cnt);</span>
<a href="#l24.523"></a><span id="l24.523" class="difflineplus">+      memcpy(m_pInBuffer, pIn, cnt);</span>
<a href="#l24.524"></a><span id="l24.524">     }</span>
<a href="#l24.525"></a><span id="l24.525">     else</span>
<a href="#l24.526"></a><span id="l24.526">       inIdx = 0;</span>
<a href="#l24.527"></a><span id="l24.527">   }</span>
<a href="#l24.528"></a><span id="l24.528"> </span>
<a href="#l24.529"></a><span id="l24.529">   // I used to check for an eol before writing one but</span>
<a href="#l24.530"></a><span id="l24.530">   // it turns out that adding a proper EOL before the next</span>
<a href="#l24.531"></a><span id="l24.531">   // separator never really hurts so better to be safe</span>
<a href="#l24.532"></a><span id="l24.532">   // and always do it.</span>
<a href="#l24.533"></a><span id="l24.533">   //  if ((last[0] != nsCRT::CR) || (last[1] != nsCRT::LF)) {</span>
<a href="#l24.534"></a><span id="l24.534" class="difflineminus">-  rv = m_dstFileOutputStream-&gt;Write( &quot;\x0D\x0A&quot;, 2, &amp;cntRead);</span>
<a href="#l24.535"></a><span id="l24.535" class="difflineminus">-  if (NS_FAILED( rv) || (cntRead != 2)) {</span>
<a href="#l24.536"></a><span id="l24.536" class="difflineminus">-    ReportWriteError( m_dstFile);</span>
<a href="#l24.537"></a><span id="l24.537" class="difflineminus">-    return( false);</span>
<a href="#l24.538"></a><span id="l24.538" class="difflineplus">+  rv = m_dstFileOutputStream-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;cntRead);</span>
<a href="#l24.539"></a><span id="l24.539" class="difflineplus">+  if (NS_FAILED(rv) || (cntRead != 2)) {</span>
<a href="#l24.540"></a><span id="l24.540" class="difflineplus">+    ReportWriteError(m_dstFile);</span>
<a href="#l24.541"></a><span id="l24.541" class="difflineplus">+    return false;</span>
<a href="#l24.542"></a><span id="l24.542">   }</span>
<a href="#l24.543"></a><span id="l24.543">   //  } // != nsCRT::CR || != nsCRT::LF</span>
<a href="#l24.544"></a><span id="l24.544"> </span>
<a href="#l24.545"></a><span id="l24.545" class="difflineminus">-  return( true);</span>
<a href="#l24.546"></a><span id="l24.546" class="difflineplus">+  return true;</span>
<a href="#l24.547"></a><span id="l24.547"> }</span>
<a href="#l24.548"></a><span id="l24.548"> </span>
<a href="#l24.549"></a><span id="l24.549"> </span>
<a href="#l24.550"></a><span id="l24.550" class="difflineminus">-CIndexScanner::CIndexScanner( nsString&amp; name, nsIFile * idxFile, nsIFile * mbxFile, nsIFile * dstFile)</span>
<a href="#l24.551"></a><span id="l24.551" class="difflineminus">-: CMbxScanner( name, mbxFile, dstFile)</span>
<a href="#l24.552"></a><span id="l24.552" class="difflineplus">+CIndexScanner::CIndexScanner(nsString&amp; name, nsIFile * idxFile, nsIFile * mbxFile, nsIFile * dstFile)</span>
<a href="#l24.553"></a><span id="l24.553" class="difflineplus">+: CMbxScanner(name, mbxFile, dstFile)</span>
<a href="#l24.554"></a><span id="l24.554"> {</span>
<a href="#l24.555"></a><span id="l24.555">   m_idxFile = idxFile;</span>
<a href="#l24.556"></a><span id="l24.556">   m_curItemIndex = 0;</span>
<a href="#l24.557"></a><span id="l24.557">   m_idxOffset = 0;</span>
<a href="#l24.558"></a><span id="l24.558"> }</span>
<a href="#l24.559"></a><span id="l24.559"> </span>
<a href="#l24.560"></a><span id="l24.560"> CIndexScanner::~CIndexScanner()</span>
<a href="#l24.561"></a><span id="l24.561"> {</span>
<a href="#l24.562"></a><span id="l24.562">   CleanUp();</span>
<a href="#l24.563"></a><span id="l24.563"> }</span>
<a href="#l24.564"></a><span id="l24.564"> </span>
<a href="#l24.565"></a><span id="l24.565" class="difflineminus">-bool CIndexScanner::Initialize( void)</span>
<a href="#l24.566"></a><span id="l24.566" class="difflineplus">+bool CIndexScanner::Initialize(void)</span>
<a href="#l24.567"></a><span id="l24.567"> {</span>
<a href="#l24.568"></a><span id="l24.568">   if (!CMbxScanner::Initialize())</span>
<a href="#l24.569"></a><span id="l24.569" class="difflineminus">-    return( false);</span>
<a href="#l24.570"></a><span id="l24.570" class="difflineplus">+    return false;</span>
<a href="#l24.571"></a><span id="l24.571"> </span>
<a href="#l24.572"></a><span id="l24.572"> </span>
<a href="#l24.573"></a><span id="l24.573">   nsresult   rv = NS_NewLocalFileInputStream(getter_AddRefs(m_idxFileInputStream), m_idxFile);</span>
<a href="#l24.574"></a><span id="l24.574" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l24.575"></a><span id="l24.575" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l24.576"></a><span id="l24.576">     CleanUp();</span>
<a href="#l24.577"></a><span id="l24.577" class="difflineminus">-    return( false);</span>
<a href="#l24.578"></a><span id="l24.578" class="difflineplus">+    return false;</span>
<a href="#l24.579"></a><span id="l24.579">   }</span>
<a href="#l24.580"></a><span id="l24.580"> </span>
<a href="#l24.581"></a><span id="l24.581" class="difflineminus">-  return( true);</span>
<a href="#l24.582"></a><span id="l24.582" class="difflineplus">+  return true;</span>
<a href="#l24.583"></a><span id="l24.583"> }</span>
<a href="#l24.584"></a><span id="l24.584"> </span>
<a href="#l24.585"></a><span id="l24.585" class="difflineminus">-bool CIndexScanner::ValidateIdxFile( void)</span>
<a href="#l24.586"></a><span id="l24.586" class="difflineplus">+bool CIndexScanner::ValidateIdxFile(void)</span>
<a href="#l24.587"></a><span id="l24.587"> {</span>
<a href="#l24.588"></a><span id="l24.588">   PRInt8      id[4];</span>
<a href="#l24.589"></a><span id="l24.589">   PRInt32      cnt = 4;</span>
<a href="#l24.590"></a><span id="l24.590">   nsresult    rv;</span>
<a href="#l24.591"></a><span id="l24.591">   PRUint32      cntRead;</span>
<a href="#l24.592"></a><span id="l24.592">   PRInt8 *    pReadTo;</span>
<a href="#l24.593"></a><span id="l24.593"> </span>
<a href="#l24.594"></a><span id="l24.594">   pReadTo = id;</span>
<a href="#l24.595"></a><span id="l24.595" class="difflineminus">-  rv = m_idxFileInputStream-&gt;Read( (char *) pReadTo, cnt, &amp;cntRead);</span>
<a href="#l24.596"></a><span id="l24.596" class="difflineminus">-  if (NS_FAILED( rv) || (cntRead != cnt))</span>
<a href="#l24.597"></a><span id="l24.597" class="difflineminus">-    return( false);</span>
<a href="#l24.598"></a><span id="l24.598" class="difflineplus">+  rv = m_idxFileInputStream-&gt;Read((char *) pReadTo, cnt, &amp;cntRead);</span>
<a href="#l24.599"></a><span id="l24.599" class="difflineplus">+  if (NS_FAILED(rv) || (cntRead != cnt))</span>
<a href="#l24.600"></a><span id="l24.600" class="difflineplus">+    return false;</span>
<a href="#l24.601"></a><span id="l24.601">   if ((id[0] != 'J') || (id[1] != 'M') || (id[2] != 'F') || (id[3] != '9'))</span>
<a href="#l24.602"></a><span id="l24.602" class="difflineminus">-    return( false);</span>
<a href="#l24.603"></a><span id="l24.603" class="difflineplus">+    return false;</span>
<a href="#l24.604"></a><span id="l24.604">   cnt = 4;</span>
<a href="#l24.605"></a><span id="l24.605">   PRUint32    subId;</span>
<a href="#l24.606"></a><span id="l24.606">   pReadTo = (PRInt8 *) &amp;subId;</span>
<a href="#l24.607"></a><span id="l24.607">   rv = m_idxFileInputStream-&gt;Read((char *) pReadTo, cnt, &amp;cntRead);</span>
<a href="#l24.608"></a><span id="l24.608" class="difflineminus">-  if (NS_FAILED( rv) || (cntRead != cnt))</span>
<a href="#l24.609"></a><span id="l24.609" class="difflineminus">-    return( false);</span>
<a href="#l24.610"></a><span id="l24.610" class="difflineplus">+  if (NS_FAILED(rv) || (cntRead != cnt))</span>
<a href="#l24.611"></a><span id="l24.611" class="difflineplus">+    return false;</span>
<a href="#l24.612"></a><span id="l24.612">   if (subId != 0x00010004) {</span>
<a href="#l24.613"></a><span id="l24.613" class="difflineminus">-    IMPORT_LOG1( &quot;Idx file subid doesn't match: 0x%lx\n&quot;, subId);</span>
<a href="#l24.614"></a><span id="l24.614" class="difflineminus">-    return( false);</span>
<a href="#l24.615"></a><span id="l24.615" class="difflineplus">+    IMPORT_LOG1(&quot;Idx file subid doesn't match: 0x%lx\n&quot;, subId);</span>
<a href="#l24.616"></a><span id="l24.616" class="difflineplus">+    return false;</span>
<a href="#l24.617"></a><span id="l24.617">   }</span>
<a href="#l24.618"></a><span id="l24.618"> </span>
<a href="#l24.619"></a><span id="l24.619">   pReadTo = (PRInt8 *) &amp;m_numMessages;</span>
<a href="#l24.620"></a><span id="l24.620" class="difflineminus">-  rv = m_idxFileInputStream-&gt;Read( (char *) pReadTo, cnt, &amp;cntRead);</span>
<a href="#l24.621"></a><span id="l24.621" class="difflineminus">-  if (NS_FAILED( rv) || (cntRead != cnt))</span>
<a href="#l24.622"></a><span id="l24.622" class="difflineminus">-    return( false);</span>
<a href="#l24.623"></a><span id="l24.623" class="difflineplus">+  rv = m_idxFileInputStream-&gt;Read((char *) pReadTo, cnt, &amp;cntRead);</span>
<a href="#l24.624"></a><span id="l24.624" class="difflineplus">+  if (NS_FAILED(rv) || (cntRead != cnt))</span>
<a href="#l24.625"></a><span id="l24.625" class="difflineplus">+    return false;</span>
<a href="#l24.626"></a><span id="l24.626"> </span>
<a href="#l24.627"></a><span id="l24.627" class="difflineminus">-  IMPORT_LOG1( &quot;Idx file num messages: %ld\n&quot;, m_numMessages);</span>
<a href="#l24.628"></a><span id="l24.628" class="difflineplus">+  IMPORT_LOG1(&quot;Idx file num messages: %ld\n&quot;, m_numMessages);</span>
<a href="#l24.629"></a><span id="l24.629"> </span>
<a href="#l24.630"></a><span id="l24.630">   m_didBytes += 80;</span>
<a href="#l24.631"></a><span id="l24.631">   m_idxOffset = 80;</span>
<a href="#l24.632"></a><span id="l24.632" class="difflineminus">-  return( true);</span>
<a href="#l24.633"></a><span id="l24.633" class="difflineplus">+  return true;</span>
<a href="#l24.634"></a><span id="l24.634"> }</span>
<a href="#l24.635"></a><span id="l24.635"> </span>
<a href="#l24.636"></a><span id="l24.636"> /*</span>
<a href="#l24.637"></a><span id="l24.637"> Idx file...</span>
<a href="#l24.638"></a><span id="l24.638"> Header is 80 bytes, JMF9, subId? 0x00010004, numMessages, fileSize, 1, 0x00010010</span>
<a href="#l24.639"></a><span id="l24.639"> Entries start at byte 80</span>
<a href="#l24.640"></a><span id="l24.640"> 4 byte numbers</span>
<a href="#l24.641"></a><span id="l24.641"> Flags? maybe</span>
<a href="#l24.642"></a><span id="l24.642" class="difflineat">@@ -577,97 +577,97 @@ length of this record</span>
<a href="#l24.643"></a><span id="l24.643"> msg offset in mbx</span>
<a href="#l24.644"></a><span id="l24.644"> msg length in mbx</span>
<a href="#l24.645"></a><span id="l24.645"> </span>
<a href="#l24.646"></a><span id="l24.646"> */</span>
<a href="#l24.647"></a><span id="l24.647"> </span>
<a href="#l24.648"></a><span id="l24.648"> // #define DEBUG_SUBJECT_AND_FLAGS  1</span>
<a href="#l24.649"></a><span id="l24.649"> #define  kNumIdxLongsToRead    7</span>
<a href="#l24.650"></a><span id="l24.650"> </span>
<a href="#l24.651"></a><span id="l24.651" class="difflineminus">-bool CIndexScanner::GetMailItem( PRUint32 *pFlags, PRUint32 *pOffset, PRUint32 *pSize)</span>
<a href="#l24.652"></a><span id="l24.652" class="difflineplus">+bool CIndexScanner::GetMailItem(PRUint32 *pFlags, PRUint32 *pOffset, PRUint32 *pSize)</span>
<a href="#l24.653"></a><span id="l24.653"> {</span>
<a href="#l24.654"></a><span id="l24.654">   PRUint32  values[kNumIdxLongsToRead];</span>
<a href="#l24.655"></a><span id="l24.655" class="difflineminus">-  PRInt32    cnt = kNumIdxLongsToRead * sizeof( PRUint32);</span>
<a href="#l24.656"></a><span id="l24.656" class="difflineplus">+  PRInt32    cnt = kNumIdxLongsToRead * sizeof(PRUint32);</span>
<a href="#l24.657"></a><span id="l24.657">   PRInt8 *  pReadTo = (PRInt8 *) values;</span>
<a href="#l24.658"></a><span id="l24.658">   PRUint32    cntRead;</span>
<a href="#l24.659"></a><span id="l24.659">   nsresult  rv;</span>
<a href="#l24.660"></a><span id="l24.660"> </span>
<a href="#l24.661"></a><span id="l24.661">   nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(m_idxFileInputStream);</span>
<a href="#l24.662"></a><span id="l24.662">   rv = seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, m_idxOffset);</span>
<a href="#l24.663"></a><span id="l24.663" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l24.664"></a><span id="l24.664" class="difflineminus">-    return( false);</span>
<a href="#l24.665"></a><span id="l24.665" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l24.666"></a><span id="l24.666" class="difflineplus">+    return false;</span>
<a href="#l24.667"></a><span id="l24.667"> </span>
<a href="#l24.668"></a><span id="l24.668" class="difflineminus">-  rv = m_idxFileInputStream-&gt;Read( (char *) pReadTo, cnt, &amp;cntRead);</span>
<a href="#l24.669"></a><span id="l24.669" class="difflineminus">-  if (NS_FAILED( rv) || (cntRead != cnt))</span>
<a href="#l24.670"></a><span id="l24.670" class="difflineminus">-    return( false);</span>
<a href="#l24.671"></a><span id="l24.671" class="difflineplus">+  rv = m_idxFileInputStream-&gt;Read((char *) pReadTo, cnt, &amp;cntRead);</span>
<a href="#l24.672"></a><span id="l24.672" class="difflineplus">+  if (NS_FAILED(rv) || (cntRead != cnt))</span>
<a href="#l24.673"></a><span id="l24.673" class="difflineplus">+    return false;</span>
<a href="#l24.674"></a><span id="l24.674"> </span>
<a href="#l24.675"></a><span id="l24.675">   if (values[3] != m_idxOffset) {</span>
<a href="#l24.676"></a><span id="l24.676" class="difflineminus">-    IMPORT_LOG2( &quot;Self pointer invalid: m_idxOffset=0x%lx, self=0x%lx\n&quot;, m_idxOffset, values[3]);</span>
<a href="#l24.677"></a><span id="l24.677" class="difflineminus">-    return( false);</span>
<a href="#l24.678"></a><span id="l24.678" class="difflineplus">+    IMPORT_LOG2(&quot;Self pointer invalid: m_idxOffset=0x%lx, self=0x%lx\n&quot;, m_idxOffset, values[3]);</span>
<a href="#l24.679"></a><span id="l24.679" class="difflineplus">+    return false;</span>
<a href="#l24.680"></a><span id="l24.680">   }</span>
<a href="#l24.681"></a><span id="l24.681"> </span>
<a href="#l24.682"></a><span id="l24.682">   // So... what do we have here???</span>
<a href="#l24.683"></a><span id="l24.683"> #ifdef DEBUG_SUBJECT_AND_FLAGS</span>
<a href="#l24.684"></a><span id="l24.684" class="difflineminus">-  IMPORT_LOG2( &quot;Number: %ld, msg offset: 0x%lx, &quot;, values[2], values[5]);</span>
<a href="#l24.685"></a><span id="l24.685" class="difflineminus">-  IMPORT_LOG2( &quot;msg length: %ld, Flags: 0x%lx\n&quot;, values[6], values[0]);</span>
<a href="#l24.686"></a><span id="l24.686" class="difflineplus">+  IMPORT_LOG2(&quot;Number: %ld, msg offset: 0x%lx, &quot;, values[2], values[5]);</span>
<a href="#l24.687"></a><span id="l24.687" class="difflineplus">+  IMPORT_LOG2(&quot;msg length: %ld, Flags: 0x%lx\n&quot;, values[6], values[0]);</span>
<a href="#l24.688"></a><span id="l24.688">   seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, m_idxOffset + 212);</span>
<a href="#l24.689"></a><span id="l24.689">   PRUint32  subSz = 0;</span>
<a href="#l24.690"></a><span id="l24.690">   cnt = 4;</span>
<a href="#l24.691"></a><span id="l24.691">   pReadTo = (PRInt8 *) &amp;subSz;</span>
<a href="#l24.692"></a><span id="l24.692" class="difflineminus">-  m_idxFileInputStream-&gt;Read( (char *) pReadTo, cnt, &amp;cntRead);</span>
<a href="#l24.693"></a><span id="l24.693" class="difflineplus">+  m_idxFileInputStream-&gt;Read((char *) pReadTo, cnt, &amp;cntRead);</span>
<a href="#l24.694"></a><span id="l24.694">   if ((subSz &gt;= 0) &amp;&amp; (subSz &lt; 1024)) {</span>
<a href="#l24.695"></a><span id="l24.695">     char *pSub = new char[subSz + 1];</span>
<a href="#l24.696"></a><span id="l24.696" class="difflineminus">-    m_idxFileInputStream-&gt;Read( pSub, subSz, &amp;cntRead);</span>
<a href="#l24.697"></a><span id="l24.697" class="difflineplus">+    m_idxFileInputStream-&gt;Read(pSub, subSz, &amp;cntRead);</span>
<a href="#l24.698"></a><span id="l24.698">     pSub[subSz] = 0;</span>
<a href="#l24.699"></a><span id="l24.699" class="difflineminus">-    IMPORT_LOG1( &quot;    Subject: %s\n&quot;, pSub);</span>
<a href="#l24.700"></a><span id="l24.700" class="difflineplus">+    IMPORT_LOG1(&quot;    Subject: %s\n&quot;, pSub);</span>
<a href="#l24.701"></a><span id="l24.701">     delete [] pSub;</span>
<a href="#l24.702"></a><span id="l24.702">   }</span>
<a href="#l24.703"></a><span id="l24.703"> #endif</span>
<a href="#l24.704"></a><span id="l24.704"> </span>
<a href="#l24.705"></a><span id="l24.705">   m_idxOffset += values[4];</span>
<a href="#l24.706"></a><span id="l24.706">   m_didBytes += values[4];</span>
<a href="#l24.707"></a><span id="l24.707"> </span>
<a href="#l24.708"></a><span id="l24.708">   *pFlags = values[0];</span>
<a href="#l24.709"></a><span id="l24.709">   *pOffset = values[5];</span>
<a href="#l24.710"></a><span id="l24.710">   *pSize = values[6];</span>
<a href="#l24.711"></a><span id="l24.711" class="difflineminus">-  return( true);</span>
<a href="#l24.712"></a><span id="l24.712" class="difflineplus">+  return true;</span>
<a href="#l24.713"></a><span id="l24.713"> }</span>
<a href="#l24.714"></a><span id="l24.714"> </span>
<a href="#l24.715"></a><span id="l24.715"> #define  kOEDeletedFlag    0x0001</span>
<a href="#l24.716"></a><span id="l24.716"> </span>
<a href="#l24.717"></a><span id="l24.717" class="difflineminus">-bool CIndexScanner::DoWork( bool *pAbort, PRUint32 *pDone, PRUint32 *pCount)</span>
<a href="#l24.718"></a><span id="l24.718" class="difflineplus">+bool CIndexScanner::DoWork(bool *pAbort, PRUint32 *pDone, PRUint32 *pCount)</span>
<a href="#l24.719"></a><span id="l24.719"> {</span>
<a href="#l24.720"></a><span id="l24.720">   m_didBytes = 0;</span>
<a href="#l24.721"></a><span id="l24.721">   if (!ValidateIdxFile())</span>
<a href="#l24.722"></a><span id="l24.722" class="difflineminus">-    return( false);</span>
<a href="#l24.723"></a><span id="l24.723" class="difflineplus">+    return false;</span>
<a href="#l24.724"></a><span id="l24.724"> </span>
<a href="#l24.725"></a><span id="l24.725">   bool    failed = false;</span>
<a href="#l24.726"></a><span id="l24.726">   while ((m_curItemIndex &lt; m_numMessages) &amp;&amp; !failed &amp;&amp; !(*pAbort)) {</span>
<a href="#l24.727"></a><span id="l24.727">     PRUint32  flags, offset, size;</span>
<a href="#l24.728"></a><span id="l24.728" class="difflineminus">-    if (!GetMailItem( &amp;flags, &amp;offset, &amp;size)) {</span>
<a href="#l24.729"></a><span id="l24.729" class="difflineplus">+    if (!GetMailItem(&amp;flags, &amp;offset, &amp;size)) {</span>
<a href="#l24.730"></a><span id="l24.730">       CleanUp();</span>
<a href="#l24.731"></a><span id="l24.731" class="difflineminus">-      return( false);</span>
<a href="#l24.732"></a><span id="l24.732" class="difflineplus">+      return false;</span>
<a href="#l24.733"></a><span id="l24.733">     }</span>
<a href="#l24.734"></a><span id="l24.734">     m_curItemIndex++;</span>
<a href="#l24.735"></a><span id="l24.735">     if (!(flags &amp; kOEDeletedFlag)) {</span>
<a href="#l24.736"></a><span id="l24.736" class="difflineminus">-      if (!WriteMailItem( flags, offset, size))</span>
<a href="#l24.737"></a><span id="l24.737" class="difflineplus">+      if (!WriteMailItem(flags, offset, size))</span>
<a href="#l24.738"></a><span id="l24.738">         failed = true;</span>
<a href="#l24.739"></a><span id="l24.739">       else {</span>
<a href="#l24.740"></a><span id="l24.740">         m_msgCount++;</span>
<a href="#l24.741"></a><span id="l24.741">       }</span>
<a href="#l24.742"></a><span id="l24.742">     }</span>
<a href="#l24.743"></a><span id="l24.743">     m_didBytes += size;</span>
<a href="#l24.744"></a><span id="l24.744">     if (pDone)</span>
<a href="#l24.745"></a><span id="l24.745">       *pDone = m_didBytes;</span>
<a href="#l24.746"></a><span id="l24.746">     if (pCount)</span>
<a href="#l24.747"></a><span id="l24.747">       *pCount = m_msgCount;</span>
<a href="#l24.748"></a><span id="l24.748">   }</span>
<a href="#l24.749"></a><span id="l24.749"> </span>
<a href="#l24.750"></a><span id="l24.750">   CleanUp();</span>
<a href="#l24.751"></a><span id="l24.751" class="difflineminus">-  return( !failed);</span>
<a href="#l24.752"></a><span id="l24.752" class="difflineplus">+  return !failed;</span>
<a href="#l24.753"></a><span id="l24.753"> }</span>
<a href="#l24.754"></a><span id="l24.754"> </span>
<a href="#l24.755"></a><span id="l24.755"> </span>
<a href="#l24.756"></a><span id="l24.756" class="difflineminus">-void CIndexScanner::CleanUp( void)</span>
<a href="#l24.757"></a><span id="l24.757" class="difflineplus">+void CIndexScanner::CleanUp(void)</span>
<a href="#l24.758"></a><span id="l24.758"> {</span>
<a href="#l24.759"></a><span id="l24.759">   CMbxScanner::CleanUp();</span>
<a href="#l24.760"></a><span id="l24.760">   m_idxFileInputStream-&gt;Close();</span>
<a href="#l24.761"></a><span id="l24.761"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOEMailbox.h</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOEMailbox.h</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -40,17 +40,17 @@</span>
<a href="#l25.4"></a><span id="l25.4"> </span>
<a href="#l25.5"></a><span id="l25.5"> #include &quot;nscore.h&quot;</span>
<a href="#l25.6"></a><span id="l25.6"> #include &quot;prtypes.h&quot;</span>
<a href="#l25.7"></a><span id="l25.7"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l25.8"></a><span id="l25.8"> #include &quot;nsIFile.h&quot;</span>
<a href="#l25.9"></a><span id="l25.9"> </span>
<a href="#l25.10"></a><span id="l25.10"> class CImportMailbox {</span>
<a href="#l25.11"></a><span id="l25.11"> public:</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  static bool    ImportMailbox( PRUint32 *pDone, bool *pAbort, nsString&amp; name, nsIFile * inFile, nsIFile * outFile, PRUint32 *pCount);</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+  static bool    ImportMailbox(PRUint32 *pDone, bool *pAbort, nsString&amp; name, nsIFile * inFile, nsIFile * outFile, PRUint32 *pCount);</span>
<a href="#l25.14"></a><span id="l25.14"> </span>
<a href="#l25.15"></a><span id="l25.15"> private:</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-  static bool    GetIndexFile( nsIFile* mbxFile);</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+  static bool    GetIndexFile(nsIFile* mbxFile);</span>
<a href="#l25.18"></a><span id="l25.18"> };</span>
<a href="#l25.19"></a><span id="l25.19"> </span>
<a href="#l25.20"></a><span id="l25.20"> </span>
<a href="#l25.21"></a><span id="l25.21"> </span>
<a href="#l25.22"></a><span id="l25.22"> #endif // nsOEMailbox_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOERegUtil.cpp</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOERegUtil.cpp</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -33,53 +33,53 @@</span>
<a href="#l26.4"></a><span id="l26.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l26.5"></a><span id="l26.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l26.6"></a><span id="l26.6">  *</span>
<a href="#l26.7"></a><span id="l26.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l26.8"></a><span id="l26.8"> #include &quot;nsOERegUtil.h&quot;</span>
<a href="#l26.9"></a><span id="l26.9"> </span>
<a href="#l26.10"></a><span id="l26.10"> #include &quot;OEDebugLog.h&quot;</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-BYTE * nsOERegUtil::GetValueBytes( HKEY hKey, const char *pValueName)</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+BYTE * nsOERegUtil::GetValueBytes(HKEY hKey, const char *pValueName)</span>
<a href="#l26.14"></a><span id="l26.14"> {</span>
<a href="#l26.15"></a><span id="l26.15">   LONG  err;</span>
<a href="#l26.16"></a><span id="l26.16">   DWORD  bufSz;</span>
<a href="#l26.17"></a><span id="l26.17">   LPBYTE  pBytes = NULL;</span>
<a href="#l26.18"></a><span id="l26.18">   DWORD  type = 0;</span>
<a href="#l26.19"></a><span id="l26.19"> </span>
<a href="#l26.20"></a><span id="l26.20" class="difflineminus">-  err = ::RegQueryValueEx( hKey, pValueName, NULL, &amp;type, NULL, &amp;bufSz);</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+  err = ::RegQueryValueEx(hKey, pValueName, NULL, &amp;type, NULL, &amp;bufSz);</span>
<a href="#l26.22"></a><span id="l26.22">   if (err == ERROR_SUCCESS) {</span>
<a href="#l26.23"></a><span id="l26.23">     pBytes = new BYTE[bufSz];</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-    err = ::RegQueryValueEx( hKey, pValueName, NULL, NULL, pBytes, &amp;bufSz);</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+    err = ::RegQueryValueEx(hKey, pValueName, NULL, NULL, pBytes, &amp;bufSz);</span>
<a href="#l26.26"></a><span id="l26.26">     if (err != ERROR_SUCCESS) {</span>
<a href="#l26.27"></a><span id="l26.27">       delete [] pBytes;</span>
<a href="#l26.28"></a><span id="l26.28">       pBytes = NULL;</span>
<a href="#l26.29"></a><span id="l26.29">     }</span>
<a href="#l26.30"></a><span id="l26.30">     else {</span>
<a href="#l26.31"></a><span id="l26.31">       if (type == REG_EXPAND_SZ) {</span>
<a href="#l26.32"></a><span id="l26.32">         DWORD sz = bufSz;</span>
<a href="#l26.33"></a><span id="l26.33">         LPBYTE pExpand = NULL;</span>
<a href="#l26.34"></a><span id="l26.34">         DWORD  rSz;</span>
<a href="#l26.35"></a><span id="l26.35"> </span>
<a href="#l26.36"></a><span id="l26.36">         do {</span>
<a href="#l26.37"></a><span id="l26.37">           if (pExpand)</span>
<a href="#l26.38"></a><span id="l26.38">             delete [] pExpand;</span>
<a href="#l26.39"></a><span id="l26.39">           sz += 1024;</span>
<a href="#l26.40"></a><span id="l26.40">           pExpand = new BYTE[sz];</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineminus">-          rSz = ::ExpandEnvironmentStrings( (LPCSTR) pBytes, (LPSTR) pExpand, sz);</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineplus">+          rSz = ::ExpandEnvironmentStrings((LPCSTR) pBytes, (LPSTR) pExpand, sz);</span>
<a href="#l26.43"></a><span id="l26.43">         } while (rSz &gt; sz);</span>
<a href="#l26.44"></a><span id="l26.44"> </span>
<a href="#l26.45"></a><span id="l26.45">         delete [] pBytes;</span>
<a href="#l26.46"></a><span id="l26.46"> </span>
<a href="#l26.47"></a><span id="l26.47" class="difflineminus">-        return( pExpand);</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineplus">+        return pExpand;</span>
<a href="#l26.49"></a><span id="l26.49">       }</span>
<a href="#l26.50"></a><span id="l26.50">     }</span>
<a href="#l26.51"></a><span id="l26.51">   }</span>
<a href="#l26.52"></a><span id="l26.52"> </span>
<a href="#l26.53"></a><span id="l26.53" class="difflineminus">-  return( pBytes);</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineplus">+  return pBytes;</span>
<a href="#l26.55"></a><span id="l26.55"> }</span>
<a href="#l26.56"></a><span id="l26.56"> </span>
<a href="#l26.57"></a><span id="l26.57" class="difflineminus">-void nsOERegUtil::FreeValueBytes( BYTE *pBytes)</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineplus">+void nsOERegUtil::FreeValueBytes(BYTE *pBytes)</span>
<a href="#l26.59"></a><span id="l26.59"> {</span>
<a href="#l26.60"></a><span id="l26.60">   if (pBytes)</span>
<a href="#l26.61"></a><span id="l26.61">     delete [] pBytes;</span>
<a href="#l26.62"></a><span id="l26.62"> }</span>
<a href="#l26.63"></a><span id="l26.63"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOERegUtil.h</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOERegUtil.h</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -38,15 +38,15 @@</span>
<a href="#l27.4"></a><span id="l27.4"> #ifndef nsOERegUtil_h___</span>
<a href="#l27.5"></a><span id="l27.5"> #define nsOERegUtil_h___</span>
<a href="#l27.6"></a><span id="l27.6"> </span>
<a href="#l27.7"></a><span id="l27.7"> #include &lt;windows.h&gt;</span>
<a href="#l27.8"></a><span id="l27.8"> </span>
<a href="#l27.9"></a><span id="l27.9"> class nsOERegUtil</span>
<a href="#l27.10"></a><span id="l27.10"> {</span>
<a href="#l27.11"></a><span id="l27.11"> public:</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  static BYTE *  GetValueBytes( HKEY hKey, const char *pValueName);</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-  static void    FreeValueBytes( BYTE *pBytes);</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+  static BYTE *  GetValueBytes(HKEY hKey, const char *pValueName);</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+  static void    FreeValueBytes(BYTE *pBytes);</span>
<a href="#l27.16"></a><span id="l27.16"> };</span>
<a href="#l27.17"></a><span id="l27.17"> </span>
<a href="#l27.18"></a><span id="l27.18"> </span>
<a href="#l27.19"></a><span id="l27.19"> </span>
<a href="#l27.20"></a><span id="l27.20"> #endif /* nsOERegUtil_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOEScanBoxes.cpp</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOEScanBoxes.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -71,17 +71,17 @@ nsOEScanBoxes::nsOEScanBoxes()</span>
<a href="#l28.4"></a><span id="l28.4">   m_pFirst = nsnull;</span>
<a href="#l28.5"></a><span id="l28.5"> }</span>
<a href="#l28.6"></a><span id="l28.6"> </span>
<a href="#l28.7"></a><span id="l28.7"> nsOEScanBoxes::~nsOEScanBoxes()</span>
<a href="#l28.8"></a><span id="l28.8"> {</span>
<a href="#l28.9"></a><span id="l28.9">   int i, max;</span>
<a href="#l28.10"></a><span id="l28.10">   MailboxEntry *pEntry;</span>
<a href="#l28.11"></a><span id="l28.11">   for (i = 0, max = m_entryArray.Count(); i &lt; max; i++) {</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-    pEntry = (MailboxEntry *) m_entryArray.ElementAt( i);</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+    pEntry = (MailboxEntry *) m_entryArray.ElementAt(i);</span>
<a href="#l28.14"></a><span id="l28.14">     delete pEntry;</span>
<a href="#l28.15"></a><span id="l28.15">   }</span>
<a href="#l28.16"></a><span id="l28.16">   // Now free the unprocessed child entries (ie, those without parents for some reason).</span>
<a href="#l28.17"></a><span id="l28.17">   for (i = 0, max = m_pendingChildArray.Count(); i &lt; max; i++)</span>
<a href="#l28.18"></a><span id="l28.18">   {</span>
<a href="#l28.19"></a><span id="l28.19">     pEntry = (MailboxEntry *) m_pendingChildArray.ElementAt(i);</span>
<a href="#l28.20"></a><span id="l28.20">     if (!pEntry-&gt;processed)</span>
<a href="#l28.21"></a><span id="l28.21">       delete pEntry;</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineat">@@ -92,92 +92,92 @@ nsOEScanBoxes::~nsOEScanBoxes()</span>
<a href="#l28.23"></a><span id="l28.23">  3.x &amp; 4.x registry</span>
<a href="#l28.24"></a><span id="l28.24">   Software/Microsoft/Outlook Express/</span>
<a href="#l28.25"></a><span id="l28.25"> </span>
<a href="#l28.26"></a><span id="l28.26">  5.0 registry</span>
<a href="#l28.27"></a><span id="l28.27">   Identies - value of &quot;Default User ID&quot; is {GUID}</span>
<a href="#l28.28"></a><span id="l28.28">   Identities/{GUID}/Software/Microsoft/Outlook Express/5.0/</span>
<a href="#l28.29"></a><span id="l28.29"> */</span>
<a href="#l28.30"></a><span id="l28.30"> </span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">-bool nsOEScanBoxes::Find50Mail( nsIFile *pWhere)</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+bool nsOEScanBoxes::Find50Mail(nsIFile *pWhere)</span>
<a href="#l28.33"></a><span id="l28.33"> {</span>
<a href="#l28.34"></a><span id="l28.34">   nsresult   rv;</span>
<a href="#l28.35"></a><span id="l28.35">   bool      success = false;</span>
<a href="#l28.36"></a><span id="l28.36">   HKEY    sKey;</span>
<a href="#l28.37"></a><span id="l28.37">         nsCOMPtr &lt;nsILocalFile&gt; localWhere = do_QueryInterface(pWhere);</span>
<a href="#l28.38"></a><span id="l28.38"> </span>
<a href="#l28.39"></a><span id="l28.39" class="difflineminus">-  if (::RegOpenKeyEx( HKEY_CURRENT_USER, &quot;Identities&quot;, 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineminus">-    BYTE *  pBytes = nsOERegUtil::GetValueBytes( sKey, &quot;Default User ID&quot;);</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineminus">-    ::RegCloseKey( sKey);</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineplus">+  if (::RegOpenKeyEx(HKEY_CURRENT_USER, &quot;Identities&quot;, 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineplus">+    BYTE *  pBytes = nsOERegUtil::GetValueBytes(sKey, &quot;Default User ID&quot;);</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+    ::RegCloseKey(sKey);</span>
<a href="#l28.45"></a><span id="l28.45">     if (pBytes) {</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineminus">-      nsCString  key( &quot;Identities\\&quot;);</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineplus">+      nsCString  key(&quot;Identities\\&quot;);</span>
<a href="#l28.48"></a><span id="l28.48">       key += (const char *)pBytes;</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineminus">-      nsOERegUtil::FreeValueBytes( pBytes);</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineplus">+      nsOERegUtil::FreeValueBytes(pBytes);</span>
<a href="#l28.51"></a><span id="l28.51">       key += &quot;\\Software\\Microsoft\\Outlook Express\\5.0&quot;;</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineminus">-      if (::RegOpenKeyEx( HKEY_CURRENT_USER, key.get(), 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineminus">-        pBytes = nsOERegUtil::GetValueBytes( sKey, &quot;Store Root&quot;);</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+      if (::RegOpenKeyEx(HKEY_CURRENT_USER, key.get(), 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineplus">+        pBytes = nsOERegUtil::GetValueBytes(sKey, &quot;Store Root&quot;);</span>
<a href="#l28.56"></a><span id="l28.56">         if (pBytes) {</span>
<a href="#l28.57"></a><span id="l28.57">           localWhere-&gt;InitWithNativePath(nsDependentCString((const char *)pBytes));</span>
<a href="#l28.58"></a><span id="l28.58"> </span>
<a href="#l28.59"></a><span id="l28.59" class="difflineminus">-          IMPORT_LOG1( &quot;Setting native path: %s\n&quot;, pBytes);</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineplus">+          IMPORT_LOG1(&quot;Setting native path: %s\n&quot;, pBytes);</span>
<a href="#l28.61"></a><span id="l28.61"> </span>
<a href="#l28.62"></a><span id="l28.62" class="difflineminus">-          nsOERegUtil::FreeValueBytes( pBytes);</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineplus">+          nsOERegUtil::FreeValueBytes(pBytes);</span>
<a href="#l28.64"></a><span id="l28.64">           bool    isDir = false;</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineminus">-          rv = pWhere-&gt;IsDirectory( &amp;isDir);</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">-          if (isDir &amp;&amp; NS_SUCCEEDED( rv))</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineplus">+          rv = pWhere-&gt;IsDirectory(&amp;isDir);</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineplus">+          if (isDir &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l28.69"></a><span id="l28.69">             success = true;</span>
<a href="#l28.70"></a><span id="l28.70">         }</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineminus">-        ::RegCloseKey( sKey);</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineplus">+        ::RegCloseKey(sKey);</span>
<a href="#l28.73"></a><span id="l28.73">       }</span>
<a href="#l28.74"></a><span id="l28.74">     }</span>
<a href="#l28.75"></a><span id="l28.75">   }</span>
<a href="#l28.76"></a><span id="l28.76"> </span>
<a href="#l28.77"></a><span id="l28.77" class="difflineminus">-  return( success);</span>
<a href="#l28.78"></a><span id="l28.78" class="difflineplus">+  return success;</span>
<a href="#l28.79"></a><span id="l28.79"> }</span>
<a href="#l28.80"></a><span id="l28.80"> </span>
<a href="#l28.81"></a><span id="l28.81" class="difflineminus">-bool nsOEScanBoxes::FindMail( nsIFile *pWhere)</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineplus">+bool nsOEScanBoxes::FindMail(nsIFile *pWhere)</span>
<a href="#l28.83"></a><span id="l28.83"> {</span>
<a href="#l28.84"></a><span id="l28.84">   nsresult   rv;</span>
<a href="#l28.85"></a><span id="l28.85">   bool      success = false;</span>
<a href="#l28.86"></a><span id="l28.86">   HKEY    sKey;</span>
<a href="#l28.87"></a><span id="l28.87">         nsCOMPtr &lt;nsILocalFile&gt; localWhere = do_QueryInterface(pWhere);</span>
<a href="#l28.88"></a><span id="l28.88"> </span>
<a href="#l28.89"></a><span id="l28.89" class="difflineminus">-  if (Find50Mail( pWhere))</span>
<a href="#l28.90"></a><span id="l28.90" class="difflineminus">-    return( true);</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineplus">+  if (Find50Mail(pWhere))</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineplus">+    return true;</span>
<a href="#l28.93"></a><span id="l28.93"> </span>
<a href="#l28.94"></a><span id="l28.94" class="difflineminus">-  if (::RegOpenKeyEx( HKEY_CURRENT_USER, &quot;Software\\Microsoft\\Outlook Express&quot;, 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineminus">-    LPBYTE  pBytes = nsOERegUtil::GetValueBytes( sKey, &quot;Store Root&quot;);</span>
<a href="#l28.96"></a><span id="l28.96" class="difflineplus">+  if (::RegOpenKeyEx(HKEY_CURRENT_USER, &quot;Software\\Microsoft\\Outlook Express&quot;, 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l28.97"></a><span id="l28.97" class="difflineplus">+    LPBYTE  pBytes = nsOERegUtil::GetValueBytes(sKey, &quot;Store Root&quot;);</span>
<a href="#l28.98"></a><span id="l28.98">     if (pBytes) {</span>
<a href="#l28.99"></a><span id="l28.99">       localWhere-&gt;InitWithNativePath(nsDependentCString((const char *) pBytes));</span>
<a href="#l28.100"></a><span id="l28.100">       pWhere-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Mail&quot;));</span>
<a href="#l28.101"></a><span id="l28.101">       bool    isDir = false;</span>
<a href="#l28.102"></a><span id="l28.102" class="difflineminus">-      rv = pWhere-&gt;IsDirectory( &amp;isDir);</span>
<a href="#l28.103"></a><span id="l28.103" class="difflineminus">-      if (isDir &amp;&amp; NS_SUCCEEDED( rv))</span>
<a href="#l28.104"></a><span id="l28.104" class="difflineplus">+      rv = pWhere-&gt;IsDirectory(&amp;isDir);</span>
<a href="#l28.105"></a><span id="l28.105" class="difflineplus">+      if (isDir &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l28.106"></a><span id="l28.106">         success = true;</span>
<a href="#l28.107"></a><span id="l28.107">       delete [] pBytes;</span>
<a href="#l28.108"></a><span id="l28.108">     }</span>
<a href="#l28.109"></a><span id="l28.109" class="difflineminus">-    ::RegCloseKey( sKey);</span>
<a href="#l28.110"></a><span id="l28.110" class="difflineplus">+    ::RegCloseKey(sKey);</span>
<a href="#l28.111"></a><span id="l28.111">   }</span>
<a href="#l28.112"></a><span id="l28.112"> </span>
<a href="#l28.113"></a><span id="l28.113" class="difflineminus">-  return( success);</span>
<a href="#l28.114"></a><span id="l28.114" class="difflineplus">+  return success;</span>
<a href="#l28.115"></a><span id="l28.115"> }</span>
<a href="#l28.116"></a><span id="l28.116"> </span>
<a href="#l28.117"></a><span id="l28.117" class="difflineminus">-bool nsOEScanBoxes::GetMailboxes( nsIFile *pWhere, nsISupportsArray **pArray)</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineplus">+bool nsOEScanBoxes::GetMailboxes(nsIFile *pWhere, nsISupportsArray **pArray)</span>
<a href="#l28.119"></a><span id="l28.119"> {</span>
<a href="#l28.120"></a><span id="l28.120">   nsCString path;</span>
<a href="#l28.121"></a><span id="l28.121">   pWhere-&gt;GetNativePath(path);</span>
<a href="#l28.122"></a><span id="l28.122">   if (!path.IsEmpty()) {</span>
<a href="#l28.123"></a><span id="l28.123" class="difflineminus">-    IMPORT_LOG1( &quot;Looking for mail in: %s\n&quot;, path.get());</span>
<a href="#l28.124"></a><span id="l28.124" class="difflineplus">+    IMPORT_LOG1(&quot;Looking for mail in: %s\n&quot;, path.get());</span>
<a href="#l28.125"></a><span id="l28.125">   }</span>
<a href="#l28.126"></a><span id="l28.126">   else {</span>
<a href="#l28.127"></a><span id="l28.127">     pWhere-&gt;GetNativeLeafName(path);</span>
<a href="#l28.128"></a><span id="l28.128">     if (!path.IsEmpty())</span>
<a href="#l28.129"></a><span id="l28.129" class="difflineminus">-      IMPORT_LOG1( &quot;Looking for mail in: %s\n&quot;, path.get());</span>
<a href="#l28.130"></a><span id="l28.130" class="difflineplus">+      IMPORT_LOG1(&quot;Looking for mail in: %s\n&quot;, path.get());</span>
<a href="#l28.131"></a><span id="l28.131">     else</span>
<a href="#l28.132"></a><span id="l28.132" class="difflineminus">-      IMPORT_LOG0( &quot;Unable to get info about where to look for mail\n&quot;);</span>
<a href="#l28.133"></a><span id="l28.133" class="difflineplus">+      IMPORT_LOG0(&quot;Unable to get info about where to look for mail\n&quot;);</span>
<a href="#l28.134"></a><span id="l28.134">   }</span>
<a href="#l28.135"></a><span id="l28.135"> </span>
<a href="#l28.136"></a><span id="l28.136">   nsCOMPtr &lt;nsIFile&gt; location;</span>
<a href="#l28.137"></a><span id="l28.137">   pWhere-&gt;Clone(getter_AddRefs(location));</span>
<a href="#l28.138"></a><span id="l28.138">   // 1. Look for 5.0 folders.dbx</span>
<a href="#l28.139"></a><span id="l28.139">   // 2. Look for 3.x &amp; 4.x folders.nch</span>
<a href="#l28.140"></a><span id="l28.140">   // 3. Look for 5.0 *.dbx mailboxes</span>
<a href="#l28.141"></a><span id="l28.141">   // 4. Look for 3.x &amp; 4.x *.mbx mailboxes</span>
<a href="#l28.142"></a><span id="l28.142" class="difflineat">@@ -199,142 +199,142 @@ bool nsOEScanBoxes::GetMailboxes( nsIFil</span>
<a href="#l28.143"></a><span id="l28.143">     else {</span>
<a href="#l28.144"></a><span id="l28.144">       // 3 &amp; 4, look for the specific mailbox files.</span>
<a href="#l28.145"></a><span id="l28.145">       pWhere-&gt;Clone(getter_AddRefs(location));</span>
<a href="#l28.146"></a><span id="l28.146">       ScanMailboxDir(location);</span>
<a href="#l28.147"></a><span id="l28.147">       result = GetMailboxList(pWhere, pArray);</span>
<a href="#l28.148"></a><span id="l28.148">     }</span>
<a href="#l28.149"></a><span id="l28.149">   }</span>
<a href="#l28.150"></a><span id="l28.150"> </span>
<a href="#l28.151"></a><span id="l28.151" class="difflineminus">-  return( result);</span>
<a href="#l28.152"></a><span id="l28.152" class="difflineplus">+  return result;</span>
<a href="#l28.153"></a><span id="l28.153"> }</span>
<a href="#l28.154"></a><span id="l28.154"> </span>
<a href="#l28.155"></a><span id="l28.155"> </span>
<a href="#l28.156"></a><span id="l28.156"> </span>
<a href="#l28.157"></a><span id="l28.157" class="difflineminus">-void nsOEScanBoxes::Reset( void)</span>
<a href="#l28.158"></a><span id="l28.158" class="difflineplus">+void nsOEScanBoxes::Reset(void)</span>
<a href="#l28.159"></a><span id="l28.159"> {</span>
<a href="#l28.160"></a><span id="l28.160">   int max = m_entryArray.Count();</span>
<a href="#l28.161"></a><span id="l28.161">   for (int i = 0; i &lt; max; i++)</span>
<a href="#l28.162"></a><span id="l28.162">         {</span>
<a href="#l28.163"></a><span id="l28.163" class="difflineminus">-    MailboxEntry *pEntry = (MailboxEntry *) m_entryArray.ElementAt( i);</span>
<a href="#l28.164"></a><span id="l28.164" class="difflineplus">+    MailboxEntry *pEntry = (MailboxEntry *) m_entryArray.ElementAt(i);</span>
<a href="#l28.165"></a><span id="l28.165">     delete pEntry;</span>
<a href="#l28.166"></a><span id="l28.166">   }</span>
<a href="#l28.167"></a><span id="l28.167">   m_entryArray.Clear();</span>
<a href="#l28.168"></a><span id="l28.168">   m_pFirst = nsnull;</span>
<a href="#l28.169"></a><span id="l28.169"> }</span>
<a href="#l28.170"></a><span id="l28.170"> </span>
<a href="#l28.171"></a><span id="l28.171"> </span>
<a href="#l28.172"></a><span id="l28.172" class="difflineminus">-bool nsOEScanBoxes::FindMailBoxes( nsIFile* descFile)</span>
<a href="#l28.173"></a><span id="l28.173" class="difflineplus">+bool nsOEScanBoxes::FindMailBoxes(nsIFile* descFile)</span>
<a href="#l28.174"></a><span id="l28.174"> {</span>
<a href="#l28.175"></a><span id="l28.175">   Reset();</span>
<a href="#l28.176"></a><span id="l28.176"> </span>
<a href="#l28.177"></a><span id="l28.177">   nsresult  rv;</span>
<a href="#l28.178"></a><span id="l28.178">   bool      isFile = false;</span>
<a href="#l28.179"></a><span id="l28.179"> </span>
<a href="#l28.180"></a><span id="l28.180" class="difflineminus">-  rv = descFile-&gt;IsFile( &amp;isFile);</span>
<a href="#l28.181"></a><span id="l28.181" class="difflineminus">-  if (NS_FAILED( rv) || !isFile)</span>
<a href="#l28.182"></a><span id="l28.182" class="difflineminus">-    return( false);</span>
<a href="#l28.183"></a><span id="l28.183" class="difflineplus">+  rv = descFile-&gt;IsFile(&amp;isFile);</span>
<a href="#l28.184"></a><span id="l28.184" class="difflineplus">+  if (NS_FAILED(rv) || !isFile)</span>
<a href="#l28.185"></a><span id="l28.185" class="difflineplus">+    return false;</span>
<a href="#l28.186"></a><span id="l28.186"> </span>
<a href="#l28.187"></a><span id="l28.187">         nsCOMPtr &lt;nsIInputStream&gt; descInputStream;</span>
<a href="#l28.188"></a><span id="l28.188"> </span>
<a href="#l28.189"></a><span id="l28.189">         rv = NS_NewLocalFileInputStream(getter_AddRefs(descInputStream), descFile);</span>
<a href="#l28.190"></a><span id="l28.190" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l28.191"></a><span id="l28.191" class="difflineminus">-    return( false);</span>
<a href="#l28.192"></a><span id="l28.192" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l28.193"></a><span id="l28.193" class="difflineplus">+    return false;</span>
<a href="#l28.194"></a><span id="l28.194"> </span>
<a href="#l28.195"></a><span id="l28.195" class="difflineminus">-  IMPORT_LOG0( &quot;Reading the folders.nch file\n&quot;);</span>
<a href="#l28.196"></a><span id="l28.196" class="difflineplus">+  IMPORT_LOG0(&quot;Reading the folders.nch file\n&quot;);</span>
<a href="#l28.197"></a><span id="l28.197"> </span>
<a href="#l28.198"></a><span id="l28.198">   PRUint32    curRec;</span>
<a href="#l28.199"></a><span id="l28.199" class="difflineminus">-  if (!ReadLong( descInputStream, curRec, 20)) {</span>
<a href="#l28.200"></a><span id="l28.200" class="difflineminus">-    return( false);</span>
<a href="#l28.201"></a><span id="l28.201" class="difflineplus">+  if (!ReadLong(descInputStream, curRec, 20)) {</span>
<a href="#l28.202"></a><span id="l28.202" class="difflineplus">+    return false;</span>
<a href="#l28.203"></a><span id="l28.203">   }</span>
<a href="#l28.204"></a><span id="l28.204"> </span>
<a href="#l28.205"></a><span id="l28.205">   // Now for each record</span>
<a href="#l28.206"></a><span id="l28.206">   bool        done = false;</span>
<a href="#l28.207"></a><span id="l28.207">   PRUint32    equal;</span>
<a href="#l28.208"></a><span id="l28.208">   PRUint32    size;</span>
<a href="#l28.209"></a><span id="l28.209">   PRUint32    previous;</span>
<a href="#l28.210"></a><span id="l28.210">   PRUint32    next;</span>
<a href="#l28.211"></a><span id="l28.211">   MailboxEntry *  pEntry;</span>
<a href="#l28.212"></a><span id="l28.212">   bool        failed;</span>
<a href="#l28.213"></a><span id="l28.213"> </span>
<a href="#l28.214"></a><span id="l28.214">   while (!done) {</span>
<a href="#l28.215"></a><span id="l28.215"> </span>
<a href="#l28.216"></a><span id="l28.216" class="difflineminus">-    if (!ReadLong( descInputStream, equal, curRec)) return( false);</span>
<a href="#l28.217"></a><span id="l28.217" class="difflineplus">+    if (!ReadLong(descInputStream, equal, curRec)) return false;</span>
<a href="#l28.218"></a><span id="l28.218">     if (curRec != equal) {</span>
<a href="#l28.219"></a><span id="l28.219" class="difflineminus">-      IMPORT_LOG1( &quot;Record start invalid: %ld\n&quot;, curRec);</span>
<a href="#l28.220"></a><span id="l28.220" class="difflineplus">+      IMPORT_LOG1(&quot;Record start invalid: %ld\n&quot;, curRec);</span>
<a href="#l28.221"></a><span id="l28.221">       break;</span>
<a href="#l28.222"></a><span id="l28.222">     }</span>
<a href="#l28.223"></a><span id="l28.223" class="difflineminus">-    if (!ReadLong( descInputStream, size, curRec + 4)) return( false);</span>
<a href="#l28.224"></a><span id="l28.224" class="difflineminus">-    if (!ReadLong( descInputStream, previous, curRec + 8)) return( false);</span>
<a href="#l28.225"></a><span id="l28.225" class="difflineminus">-    if (!ReadLong( descInputStream, next, curRec + 12)) return( false);</span>
<a href="#l28.226"></a><span id="l28.226" class="difflineplus">+    if (!ReadLong(descInputStream, size, curRec + 4)) return false;</span>
<a href="#l28.227"></a><span id="l28.227" class="difflineplus">+    if (!ReadLong(descInputStream, previous, curRec + 8)) return false;</span>
<a href="#l28.228"></a><span id="l28.228" class="difflineplus">+    if (!ReadLong(descInputStream, next, curRec + 12)) return false;</span>
<a href="#l28.229"></a><span id="l28.229">     failed = false;</span>
<a href="#l28.230"></a><span id="l28.230">     pEntry = new MailboxEntry;</span>
<a href="#l28.231"></a><span id="l28.231" class="difflineminus">-    if (!ReadLong( descInputStream, pEntry-&gt;index, curRec + 16)) failed = true;</span>
<a href="#l28.232"></a><span id="l28.232" class="difflineminus">-    if (!ReadString( descInputStream, pEntry-&gt;mailName, curRec + 20)) failed = true;</span>
<a href="#l28.233"></a><span id="l28.233" class="difflineminus">-    if (!ReadString( descInputStream, pEntry-&gt;fileName, curRec + 279)) failed = true;</span>
<a href="#l28.234"></a><span id="l28.234" class="difflineminus">-    if (!ReadLong( descInputStream, pEntry-&gt;parent, curRec + 539)) failed = true;</span>
<a href="#l28.235"></a><span id="l28.235" class="difflineminus">-    if (!ReadLong( descInputStream, pEntry-&gt;child, curRec + 543)) failed = true;</span>
<a href="#l28.236"></a><span id="l28.236" class="difflineminus">-    if (!ReadLong( descInputStream, pEntry-&gt;sibling, curRec + 547)) failed = true;</span>
<a href="#l28.237"></a><span id="l28.237" class="difflineminus">-    if (!ReadLong( descInputStream, pEntry-&gt;type, curRec + 551)) failed = true;</span>
<a href="#l28.238"></a><span id="l28.238" class="difflineplus">+    if (!ReadLong(descInputStream, pEntry-&gt;index, curRec + 16)) failed = true;</span>
<a href="#l28.239"></a><span id="l28.239" class="difflineplus">+    if (!ReadString(descInputStream, pEntry-&gt;mailName, curRec + 20)) failed = true;</span>
<a href="#l28.240"></a><span id="l28.240" class="difflineplus">+    if (!ReadString(descInputStream, pEntry-&gt;fileName, curRec + 279)) failed = true;</span>
<a href="#l28.241"></a><span id="l28.241" class="difflineplus">+    if (!ReadLong(descInputStream, pEntry-&gt;parent, curRec + 539)) failed = true;</span>
<a href="#l28.242"></a><span id="l28.242" class="difflineplus">+    if (!ReadLong(descInputStream, pEntry-&gt;child, curRec + 543)) failed = true;</span>
<a href="#l28.243"></a><span id="l28.243" class="difflineplus">+    if (!ReadLong(descInputStream, pEntry-&gt;sibling, curRec + 547)) failed = true;</span>
<a href="#l28.244"></a><span id="l28.244" class="difflineplus">+    if (!ReadLong(descInputStream, pEntry-&gt;type, curRec + 551)) failed = true;</span>
<a href="#l28.245"></a><span id="l28.245">     if (failed) {</span>
<a href="#l28.246"></a><span id="l28.246">       delete pEntry;</span>
<a href="#l28.247"></a><span id="l28.247" class="difflineminus">-      return( false);</span>
<a href="#l28.248"></a><span id="l28.248" class="difflineplus">+      return false;</span>
<a href="#l28.249"></a><span id="l28.249">     }</span>
<a href="#l28.250"></a><span id="l28.250"> </span>
<a href="#l28.251"></a><span id="l28.251">     #ifdef _TRACE_MAILBOX_ENTRIES</span>
<a href="#l28.252"></a><span id="l28.252" class="difflineminus">-    IMPORT_LOG0( &quot;------------\n&quot;);</span>
<a href="#l28.253"></a><span id="l28.253" class="difflineminus">-    IMPORT_LOG2( &quot;    Offset: %lx, index: %ld\n&quot;, curRec, pEntry-&gt;index);</span>
<a href="#l28.254"></a><span id="l28.254" class="difflineminus">-    IMPORT_LOG2( &quot;      previous: %lx, next: %lx\n&quot;, previous, next);</span>
<a href="#l28.255"></a><span id="l28.255" class="difflineminus">-    IMPORT_LOG2( &quot;      Name: %S, File: %s\n&quot;, (PRUnichar *) pEntry-&gt;mailName, (const char *) pEntry-&gt;fileName);</span>
<a href="#l28.256"></a><span id="l28.256" class="difflineminus">-    IMPORT_LOG3( &quot;      Parent: %ld, Child: %ld, Sibling: %ld\n&quot;, pEntry-&gt;parent, pEntry-&gt;child, pEntry-&gt;sibling);</span>
<a href="#l28.257"></a><span id="l28.257" class="difflineplus">+    IMPORT_LOG0(&quot;------------\n&quot;);</span>
<a href="#l28.258"></a><span id="l28.258" class="difflineplus">+    IMPORT_LOG2(&quot;    Offset: %lx, index: %ld\n&quot;, curRec, pEntry-&gt;index);</span>
<a href="#l28.259"></a><span id="l28.259" class="difflineplus">+    IMPORT_LOG2(&quot;      previous: %lx, next: %lx\n&quot;, previous, next);</span>
<a href="#l28.260"></a><span id="l28.260" class="difflineplus">+    IMPORT_LOG2(&quot;      Name: %S, File: %s\n&quot;, (PRUnichar *) pEntry-&gt;mailName, (const char *) pEntry-&gt;fileName);</span>
<a href="#l28.261"></a><span id="l28.261" class="difflineplus">+    IMPORT_LOG3(&quot;      Parent: %ld, Child: %ld, Sibling: %ld\n&quot;, pEntry-&gt;parent, pEntry-&gt;child, pEntry-&gt;sibling);</span>
<a href="#l28.262"></a><span id="l28.262">     #endif</span>
<a href="#l28.263"></a><span id="l28.263"> </span>
<a href="#l28.264"></a><span id="l28.264">     if (!StringEndsWith(pEntry-&gt;fileName, NS_LITERAL_CSTRING(&quot;.mbx&quot;)))</span>
<a href="#l28.265"></a><span id="l28.265" class="difflineminus">-      pEntry-&gt;fileName.Append( &quot;.mbx&quot;);</span>
<a href="#l28.266"></a><span id="l28.266" class="difflineplus">+      pEntry-&gt;fileName.Append(&quot;.mbx&quot;);</span>
<a href="#l28.267"></a><span id="l28.267"> </span>
<a href="#l28.268"></a><span id="l28.268" class="difflineminus">-    m_entryArray.AppendElement( pEntry);</span>
<a href="#l28.269"></a><span id="l28.269" class="difflineplus">+    m_entryArray.AppendElement(pEntry);</span>
<a href="#l28.270"></a><span id="l28.270"> </span>
<a href="#l28.271"></a><span id="l28.271">     curRec = next;</span>
<a href="#l28.272"></a><span id="l28.272">     if (!next)</span>
<a href="#l28.273"></a><span id="l28.273">       done = true;</span>
<a href="#l28.274"></a><span id="l28.274">   }</span>
<a href="#l28.275"></a><span id="l28.275"> </span>
<a href="#l28.276"></a><span id="l28.276" class="difflineminus">-  MailboxEntry *pZero = GetIndexEntry( 0);</span>
<a href="#l28.277"></a><span id="l28.277" class="difflineplus">+  MailboxEntry *pZero = GetIndexEntry(0);</span>
<a href="#l28.278"></a><span id="l28.278">   if (pZero)</span>
<a href="#l28.279"></a><span id="l28.279" class="difflineminus">-    m_pFirst = GetIndexEntry( pZero-&gt;child);</span>
<a href="#l28.280"></a><span id="l28.280" class="difflineplus">+    m_pFirst = GetIndexEntry(pZero-&gt;child);</span>
<a href="#l28.281"></a><span id="l28.281"> </span>
<a href="#l28.282"></a><span id="l28.282" class="difflineminus">-  IMPORT_LOG1( &quot;Read the folders.nch file, found %ld mailboxes\n&quot;, (long) m_entryArray.Count());</span>
<a href="#l28.283"></a><span id="l28.283" class="difflineplus">+  IMPORT_LOG1(&quot;Read the folders.nch file, found %ld mailboxes\n&quot;, (long) m_entryArray.Count());</span>
<a href="#l28.284"></a><span id="l28.284"> </span>
<a href="#l28.285"></a><span id="l28.285" class="difflineminus">-  return( true);</span>
<a href="#l28.286"></a><span id="l28.286" class="difflineplus">+  return true;</span>
<a href="#l28.287"></a><span id="l28.287"> }</span>
<a href="#l28.288"></a><span id="l28.288"> </span>
<a href="#l28.289"></a><span id="l28.289" class="difflineminus">-bool nsOEScanBoxes::Find50MailBoxes( nsIFile* descFile)</span>
<a href="#l28.290"></a><span id="l28.290" class="difflineplus">+bool nsOEScanBoxes::Find50MailBoxes(nsIFile* descFile)</span>
<a href="#l28.291"></a><span id="l28.291"> {</span>
<a href="#l28.292"></a><span id="l28.292">   Reset();</span>
<a href="#l28.293"></a><span id="l28.293"> </span>
<a href="#l28.294"></a><span id="l28.294">   nsresult  rv;</span>
<a href="#l28.295"></a><span id="l28.295">   bool      isFile = false;</span>
<a href="#l28.296"></a><span id="l28.296"> </span>
<a href="#l28.297"></a><span id="l28.297" class="difflineminus">-  rv = descFile-&gt;IsFile( &amp;isFile);</span>
<a href="#l28.298"></a><span id="l28.298" class="difflineminus">-  if (NS_FAILED( rv) || !isFile)</span>
<a href="#l28.299"></a><span id="l28.299" class="difflineminus">-    return( false);</span>
<a href="#l28.300"></a><span id="l28.300" class="difflineplus">+  rv = descFile-&gt;IsFile(&amp;isFile);</span>
<a href="#l28.301"></a><span id="l28.301" class="difflineplus">+  if (NS_FAILED(rv) || !isFile)</span>
<a href="#l28.302"></a><span id="l28.302" class="difflineplus">+    return false;</span>
<a href="#l28.303"></a><span id="l28.303"> </span>
<a href="#l28.304"></a><span id="l28.304">         nsCOMPtr &lt;nsIInputStream&gt; descInputStream;</span>
<a href="#l28.305"></a><span id="l28.305"> </span>
<a href="#l28.306"></a><span id="l28.306">         rv = NS_NewLocalFileInputStream(getter_AddRefs(descInputStream), descFile);</span>
<a href="#l28.307"></a><span id="l28.307" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l28.308"></a><span id="l28.308" class="difflineminus">-    return( false);</span>
<a href="#l28.309"></a><span id="l28.309" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l28.310"></a><span id="l28.310" class="difflineplus">+    return false;</span>
<a href="#l28.311"></a><span id="l28.311"> </span>
<a href="#l28.312"></a><span id="l28.312" class="difflineminus">-  IMPORT_LOG0( &quot;Reading the folders.dbx file\n&quot;);</span>
<a href="#l28.313"></a><span id="l28.313" class="difflineplus">+  IMPORT_LOG0(&quot;Reading the folders.dbx file\n&quot;);</span>
<a href="#l28.314"></a><span id="l28.314"> </span>
<a href="#l28.315"></a><span id="l28.315">   PRUint32 *    pIndex;</span>
<a href="#l28.316"></a><span id="l28.316">   PRUint32    indexSize = 0;</span>
<a href="#l28.317"></a><span id="l28.317" class="difflineminus">-  if (!nsOE5File::ReadIndex( descInputStream, &amp;pIndex, &amp;indexSize)) {</span>
<a href="#l28.318"></a><span id="l28.318" class="difflineminus">-    IMPORT_LOG0( &quot;*** NOT USING FOLDERS.DBX!!!\n&quot;);</span>
<a href="#l28.319"></a><span id="l28.319" class="difflineminus">-    return( false);</span>
<a href="#l28.320"></a><span id="l28.320" class="difflineplus">+  if (!nsOE5File::ReadIndex(descInputStream, &amp;pIndex, &amp;indexSize)) {</span>
<a href="#l28.321"></a><span id="l28.321" class="difflineplus">+    IMPORT_LOG0(&quot;*** NOT USING FOLDERS.DBX!!!\n&quot;);</span>
<a href="#l28.322"></a><span id="l28.322" class="difflineplus">+    return false;</span>
<a href="#l28.323"></a><span id="l28.323">   }</span>
<a href="#l28.324"></a><span id="l28.324"> </span>
<a href="#l28.325"></a><span id="l28.325">   PRUint32  marker;</span>
<a href="#l28.326"></a><span id="l28.326">   PRUint32  size;</span>
<a href="#l28.327"></a><span id="l28.327">   char  *  pBytes;</span>
<a href="#l28.328"></a><span id="l28.328">   PRUint32    cntRead;</span>
<a href="#l28.329"></a><span id="l28.329">   PRInt32    recordId;</span>
<a href="#l28.330"></a><span id="l28.330">   PRInt32    strOffset;</span>
<a href="#l28.331"></a><span id="l28.331" class="difflineat">@@ -350,23 +350,23 @@ bool nsOEScanBoxes::Find50MailBoxes( nsI</span>
<a href="#l28.332"></a><span id="l28.332">   char *      pDataSource;</span>
<a href="#l28.333"></a><span id="l28.333"> </span>
<a href="#l28.334"></a><span id="l28.334">   MailboxEntry *  pEntry;</span>
<a href="#l28.335"></a><span id="l28.335">   MailboxEntry *  pLastEntry = nsnull;</span>
<a href="#l28.336"></a><span id="l28.336"> </span>
<a href="#l28.337"></a><span id="l28.337">   PRUint32  localStoreId = 0;</span>
<a href="#l28.338"></a><span id="l28.338"> </span>
<a href="#l28.339"></a><span id="l28.339">   for (PRUint32 i = 0; i &lt; indexSize; i++) {</span>
<a href="#l28.340"></a><span id="l28.340" class="difflineminus">-    if (!ReadLong( descInputStream, marker, pIndex[i])) continue;</span>
<a href="#l28.341"></a><span id="l28.341" class="difflineplus">+    if (!ReadLong(descInputStream, marker, pIndex[i])) continue;</span>
<a href="#l28.342"></a><span id="l28.342">     if (marker != pIndex[i]) continue;</span>
<a href="#l28.343"></a><span id="l28.343" class="difflineminus">-    if (!ReadLong( descInputStream, size, pIndex[i] + 4)) continue;</span>
<a href="#l28.344"></a><span id="l28.344" class="difflineplus">+    if (!ReadLong(descInputStream, size, pIndex[i] + 4)) continue;</span>
<a href="#l28.345"></a><span id="l28.345">     size += 4;</span>
<a href="#l28.346"></a><span id="l28.346">     pBytes = new char[size];</span>
<a href="#l28.347"></a><span id="l28.347" class="difflineminus">-    rv = descInputStream-&gt;Read( pBytes, size, &amp;cntRead);</span>
<a href="#l28.348"></a><span id="l28.348" class="difflineminus">-    if (NS_FAILED( rv) || ((PRUint32)cntRead != size)) {</span>
<a href="#l28.349"></a><span id="l28.349" class="difflineplus">+    rv = descInputStream-&gt;Read(pBytes, size, &amp;cntRead);</span>
<a href="#l28.350"></a><span id="l28.350" class="difflineplus">+    if (NS_FAILED(rv) || ((PRUint32)cntRead != size)) {</span>
<a href="#l28.351"></a><span id="l28.351">       delete [] pBytes;</span>
<a href="#l28.352"></a><span id="l28.352">       continue;</span>
<a href="#l28.353"></a><span id="l28.353">     }</span>
<a href="#l28.354"></a><span id="l28.354">     recordId = pBytes[2];</span>
<a href="#l28.355"></a><span id="l28.355">     strOffset = (recordId * 4) + 4;</span>
<a href="#l28.356"></a><span id="l28.356">     if (recordId == 4)</span>
<a href="#l28.357"></a><span id="l28.357">       strOffset += 4;</span>
<a href="#l28.358"></a><span id="l28.358"> </span>
<a href="#l28.359"></a><span id="l28.359" class="difflineat">@@ -375,18 +375,18 @@ bool nsOEScanBoxes::Find50MailBoxes( nsI</span>
<a href="#l28.360"></a><span id="l28.360">     numMessages = 0;</span>
<a href="#l28.361"></a><span id="l28.361">     pFileName = nsnull;</span>
<a href="#l28.362"></a><span id="l28.362">     pDataSource = nsnull;</span>
<a href="#l28.363"></a><span id="l28.363">     dataOffset = 4;</span>
<a href="#l28.364"></a><span id="l28.364">     while (dataOffset &lt; strOffset) {</span>
<a href="#l28.365"></a><span id="l28.365">       tag = (PRUint8) pBytes[dataOffset];</span>
<a href="#l28.366"></a><span id="l28.366"> </span>
<a href="#l28.367"></a><span id="l28.367">       data = 0; // make sure all bytes are 0 before copying 3 bytes over.</span>
<a href="#l28.368"></a><span id="l28.368" class="difflineminus">-      memcpy( &amp;data, &amp;(pBytes[dataOffset + 1]), 3);</span>
<a href="#l28.369"></a><span id="l28.369" class="difflineminus">-      switch( tag) {</span>
<a href="#l28.370"></a><span id="l28.370" class="difflineplus">+      memcpy(&amp;data, &amp;(pBytes[dataOffset + 1]), 3);</span>
<a href="#l28.371"></a><span id="l28.371" class="difflineplus">+      switch(tag) {</span>
<a href="#l28.372"></a><span id="l28.372">         case 0x80: // id record</span>
<a href="#l28.373"></a><span id="l28.373">           id = data;</span>
<a href="#l28.374"></a><span id="l28.374">         break;</span>
<a href="#l28.375"></a><span id="l28.375">         case 0x81:  // parent id</span>
<a href="#l28.376"></a><span id="l28.376">           parent = data;</span>
<a href="#l28.377"></a><span id="l28.377">         break;</span>
<a href="#l28.378"></a><span id="l28.378">         case 0x87:  // number of messages in this mailbox</span>
<a href="#l28.379"></a><span id="l28.379">           numMessages = data;</span>
<a href="#l28.380"></a><span id="l28.380" class="difflineat">@@ -400,41 +400,41 @@ bool nsOEScanBoxes::Find50MailBoxes( nsI</span>
<a href="#l28.381"></a><span id="l28.381">             pDataSource = (char *) (pBytes + strOffset + data);</span>
<a href="#l28.382"></a><span id="l28.382">         break;</span>
<a href="#l28.383"></a><span id="l28.383">       }</span>
<a href="#l28.384"></a><span id="l28.384">       dataOffset += 4;</span>
<a href="#l28.385"></a><span id="l28.385">     }</span>
<a href="#l28.386"></a><span id="l28.386"> </span>
<a href="#l28.387"></a><span id="l28.387">     // now build an entry if necessary!</span>
<a href="#l28.388"></a><span id="l28.388">     if (pDataSource) {</span>
<a href="#l28.389"></a><span id="l28.389" class="difflineminus">-      if (!PL_strcasecmp( pDataSource, &quot;LocalStore&quot;))</span>
<a href="#l28.390"></a><span id="l28.390" class="difflineplus">+      if (!PL_strcasecmp(pDataSource, &quot;LocalStore&quot;))</span>
<a href="#l28.391"></a><span id="l28.391">       {</span>
<a href="#l28.392"></a><span id="l28.392">         localStoreId = id;</span>
<a href="#l28.393"></a><span id="l28.393">         // See if we have any child folders that need to be added/processed for this top level parent.</span>
<a href="#l28.394"></a><span id="l28.394">         ProcessPendingChildEntries(localStoreId, localStoreId, m_pendingChildArray);</span>
<a href="#l28.395"></a><span id="l28.395">         // Clean up the pending list.</span>
<a href="#l28.396"></a><span id="l28.396">         RemoveProcessedChildEntries();</span>
<a href="#l28.397"></a><span id="l28.397">       }</span>
<a href="#l28.398"></a><span id="l28.398">     }</span>
<a href="#l28.399"></a><span id="l28.399">     else if (id &amp;&amp; localStoreId &amp;&amp; parent) {</span>
<a href="#l28.400"></a><span id="l28.400">       // veryify that this mailbox is in the local store</span>
<a href="#l28.401"></a><span id="l28.401">       data = parent;</span>
<a href="#l28.402"></a><span id="l28.402">       while (data &amp;&amp; (data != localStoreId)) {</span>
<a href="#l28.403"></a><span id="l28.403" class="difflineminus">-        pEntry = GetIndexEntry( data);</span>
<a href="#l28.404"></a><span id="l28.404" class="difflineplus">+        pEntry = GetIndexEntry(data);</span>
<a href="#l28.405"></a><span id="l28.405">         if (pEntry)</span>
<a href="#l28.406"></a><span id="l28.406">           data = pEntry-&gt;parent;</span>
<a href="#l28.407"></a><span id="l28.407">         else</span>
<a href="#l28.408"></a><span id="l28.408">           data = 0;</span>
<a href="#l28.409"></a><span id="l28.409">       }</span>
<a href="#l28.410"></a><span id="l28.410">       if (data == localStoreId) {</span>
<a href="#l28.411"></a><span id="l28.411">         // Create an entry for this bugger</span>
<a href="#l28.412"></a><span id="l28.412">         pEntry = NewMailboxEntry(id, parent, (const char *) (pBytes + strOffset), pFileName);</span>
<a href="#l28.413"></a><span id="l28.413">         if (pEntry)</span>
<a href="#l28.414"></a><span id="l28.414">         {</span>
<a href="#l28.415"></a><span id="l28.415" class="difflineminus">-          AddChildEntry( pEntry, localStoreId);</span>
<a href="#l28.416"></a><span id="l28.416" class="difflineplus">+          AddChildEntry(pEntry, localStoreId);</span>
<a href="#l28.417"></a><span id="l28.417">           pEntry-&gt;processed =  true;</span>
<a href="#l28.418"></a><span id="l28.418">           // See if we have any child folders that need to be added/processed.</span>
<a href="#l28.419"></a><span id="l28.419">           ProcessPendingChildEntries(id, localStoreId, m_pendingChildArray);</span>
<a href="#l28.420"></a><span id="l28.420">           // Clean up the pending list.</span>
<a href="#l28.421"></a><span id="l28.421">           RemoveProcessedChildEntries();</span>
<a href="#l28.422"></a><span id="l28.422">         }</span>
<a href="#l28.423"></a><span id="l28.423">       }</span>
<a href="#l28.424"></a><span id="l28.424">       else</span>
<a href="#l28.425"></a><span id="l28.425" class="difflineat">@@ -455,20 +455,17 @@ bool nsOEScanBoxes::Find50MailBoxes( nsI</span>
<a href="#l28.426"></a><span id="l28.426">     }</span>
<a href="#l28.427"></a><span id="l28.427"> </span>
<a href="#l28.428"></a><span id="l28.428">     delete [] pBytes;</span>
<a href="#l28.429"></a><span id="l28.429">   }</span>
<a href="#l28.430"></a><span id="l28.430"> </span>
<a href="#l28.431"></a><span id="l28.431"> </span>
<a href="#l28.432"></a><span id="l28.432">   delete [] pIndex;</span>
<a href="#l28.433"></a><span id="l28.433"> </span>
<a href="#l28.434"></a><span id="l28.434" class="difflineminus">-  if (m_entryArray.Count())</span>
<a href="#l28.435"></a><span id="l28.435" class="difflineminus">-    return( true);</span>
<a href="#l28.436"></a><span id="l28.436" class="difflineminus">-  else</span>
<a href="#l28.437"></a><span id="l28.437" class="difflineminus">-    return( false);</span>
<a href="#l28.438"></a><span id="l28.438" class="difflineplus">+  return m_entryArray.Count();</span>
<a href="#l28.439"></a><span id="l28.439"> }</span>
<a href="#l28.440"></a><span id="l28.440"> </span>
<a href="#l28.441"></a><span id="l28.441"> nsOEScanBoxes::MailboxEntry *nsOEScanBoxes::NewMailboxEntry(PRUint32 id, PRUint32 parent, const char *prettyName, char *pFileName)</span>
<a href="#l28.442"></a><span id="l28.442"> {</span>
<a href="#l28.443"></a><span id="l28.443">   MailboxEntry *pEntry = new MailboxEntry();</span>
<a href="#l28.444"></a><span id="l28.444">   if (!pEntry)</span>
<a href="#l28.445"></a><span id="l28.445">     return nsnull;</span>
<a href="#l28.446"></a><span id="l28.446"> </span>
<a href="#l28.447"></a><span id="l28.447" class="difflineat">@@ -511,66 +508,66 @@ void nsOEScanBoxes::RemoveProcessedChild</span>
<a href="#l28.448"></a><span id="l28.448">   for (i = m_pendingChildArray.Count()-1; i &gt;= 0; i--)</span>
<a href="#l28.449"></a><span id="l28.449">   {</span>
<a href="#l28.450"></a><span id="l28.450">     pEntry = (MailboxEntry *) m_pendingChildArray.ElementAt(i);</span>
<a href="#l28.451"></a><span id="l28.451">     if (pEntry-&gt;processed)</span>
<a href="#l28.452"></a><span id="l28.452">       m_pendingChildArray.RemoveElementAt(i);</span>
<a href="#l28.453"></a><span id="l28.453">   }</span>
<a href="#l28.454"></a><span id="l28.454"> }</span>
<a href="#l28.455"></a><span id="l28.455"> </span>
<a href="#l28.456"></a><span id="l28.456" class="difflineminus">-void nsOEScanBoxes::AddChildEntry( MailboxEntry *pEntry, PRUint32 rootIndex)</span>
<a href="#l28.457"></a><span id="l28.457" class="difflineplus">+void nsOEScanBoxes::AddChildEntry(MailboxEntry *pEntry, PRUint32 rootIndex)</span>
<a href="#l28.458"></a><span id="l28.458"> {</span>
<a href="#l28.459"></a><span id="l28.459">   if (!m_pFirst) {</span>
<a href="#l28.460"></a><span id="l28.460">     if (pEntry-&gt;parent == rootIndex) {</span>
<a href="#l28.461"></a><span id="l28.461">       m_pFirst = pEntry;</span>
<a href="#l28.462"></a><span id="l28.462" class="difflineminus">-      m_entryArray.AppendElement( pEntry);</span>
<a href="#l28.463"></a><span id="l28.463" class="difflineplus">+      m_entryArray.AppendElement(pEntry);</span>
<a href="#l28.464"></a><span id="l28.464">     }</span>
<a href="#l28.465"></a><span id="l28.465">     else {</span>
<a href="#l28.466"></a><span id="l28.466">       delete pEntry;</span>
<a href="#l28.467"></a><span id="l28.467">     }</span>
<a href="#l28.468"></a><span id="l28.468">     return;</span>
<a href="#l28.469"></a><span id="l28.469">   }</span>
<a href="#l28.470"></a><span id="l28.470"> </span>
<a href="#l28.471"></a><span id="l28.471">   MailboxEntry *  pParent = nsnull;</span>
<a href="#l28.472"></a><span id="l28.472">   MailboxEntry *  pSibling = nsnull;</span>
<a href="#l28.473"></a><span id="l28.473">   if (pEntry-&gt;parent == rootIndex) {</span>
<a href="#l28.474"></a><span id="l28.474">     pSibling = m_pFirst;</span>
<a href="#l28.475"></a><span id="l28.475">   }</span>
<a href="#l28.476"></a><span id="l28.476">   else {</span>
<a href="#l28.477"></a><span id="l28.477" class="difflineminus">-    pParent = GetIndexEntry( pEntry-&gt;parent);</span>
<a href="#l28.478"></a><span id="l28.478" class="difflineplus">+    pParent = GetIndexEntry(pEntry-&gt;parent);</span>
<a href="#l28.479"></a><span id="l28.479">   }</span>
<a href="#l28.480"></a><span id="l28.480"> </span>
<a href="#l28.481"></a><span id="l28.481">   if (!pParent &amp;&amp; !pSibling) {</span>
<a href="#l28.482"></a><span id="l28.482">     delete pEntry;</span>
<a href="#l28.483"></a><span id="l28.483">     return;</span>
<a href="#l28.484"></a><span id="l28.484">   }</span>
<a href="#l28.485"></a><span id="l28.485"> </span>
<a href="#l28.486"></a><span id="l28.486">   if (pParent &amp;&amp; (pParent-&gt;child == 0)) {</span>
<a href="#l28.487"></a><span id="l28.487">     pParent-&gt;child = pEntry-&gt;index;</span>
<a href="#l28.488"></a><span id="l28.488" class="difflineminus">-    m_entryArray.AppendElement( pEntry);</span>
<a href="#l28.489"></a><span id="l28.489" class="difflineplus">+    m_entryArray.AppendElement(pEntry);</span>
<a href="#l28.490"></a><span id="l28.490">     return;</span>
<a href="#l28.491"></a><span id="l28.491">   }</span>
<a href="#l28.492"></a><span id="l28.492"> </span>
<a href="#l28.493"></a><span id="l28.493">   if (!pSibling)</span>
<a href="#l28.494"></a><span id="l28.494" class="difflineminus">-    pSibling = GetIndexEntry( pParent-&gt;child);</span>
<a href="#l28.495"></a><span id="l28.495" class="difflineplus">+    pSibling = GetIndexEntry(pParent-&gt;child);</span>
<a href="#l28.496"></a><span id="l28.496"> </span>
<a href="#l28.497"></a><span id="l28.497">   while (pSibling &amp;&amp; (pSibling-&gt;sibling != -1)) {</span>
<a href="#l28.498"></a><span id="l28.498" class="difflineminus">-    pSibling = GetIndexEntry( pSibling-&gt;sibling);</span>
<a href="#l28.499"></a><span id="l28.499" class="difflineplus">+    pSibling = GetIndexEntry(pSibling-&gt;sibling);</span>
<a href="#l28.500"></a><span id="l28.500">   }</span>
<a href="#l28.501"></a><span id="l28.501"> </span>
<a href="#l28.502"></a><span id="l28.502">   if (!pSibling) {</span>
<a href="#l28.503"></a><span id="l28.503">     delete pEntry;</span>
<a href="#l28.504"></a><span id="l28.504">     return;</span>
<a href="#l28.505"></a><span id="l28.505">   }</span>
<a href="#l28.506"></a><span id="l28.506"> </span>
<a href="#l28.507"></a><span id="l28.507">   pSibling-&gt;sibling = pEntry-&gt;index;</span>
<a href="#l28.508"></a><span id="l28.508" class="difflineminus">-  m_entryArray.AppendElement( pEntry);</span>
<a href="#l28.509"></a><span id="l28.509" class="difflineplus">+  m_entryArray.AppendElement(pEntry);</span>
<a href="#l28.510"></a><span id="l28.510"> }</span>
<a href="#l28.511"></a><span id="l28.511"> </span>
<a href="#l28.512"></a><span id="l28.512" class="difflineminus">-bool nsOEScanBoxes::Scan50MailboxDir( nsIFile * srcDir)</span>
<a href="#l28.513"></a><span id="l28.513" class="difflineplus">+bool nsOEScanBoxes::Scan50MailboxDir(nsIFile * srcDir)</span>
<a href="#l28.514"></a><span id="l28.514"> {</span>
<a href="#l28.515"></a><span id="l28.515">   Reset();</span>
<a href="#l28.516"></a><span id="l28.516"> </span>
<a href="#l28.517"></a><span id="l28.517">   MailboxEntry *  pEntry;</span>
<a href="#l28.518"></a><span id="l28.518">   PRInt32      index = 1;</span>
<a href="#l28.519"></a><span id="l28.519">   char *      pLeaf;</span>
<a href="#l28.520"></a><span id="l28.520"> </span>
<a href="#l28.521"></a><span id="l28.521">   bool hasMore;</span>
<a href="#l28.522"></a><span id="l28.522" class="difflineat">@@ -586,53 +583,53 @@ bool nsOEScanBoxes::Scan50MailboxDir( ns</span>
<a href="#l28.523"></a><span id="l28.523">   while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l28.524"></a><span id="l28.524">   {</span>
<a href="#l28.525"></a><span id="l28.525">     nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l28.526"></a><span id="l28.526">     rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l28.527"></a><span id="l28.527">     nsCOMPtr&lt;nsILocalFile&gt; entry(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l28.528"></a><span id="l28.528">     directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l28.529"></a><span id="l28.529"> </span>
<a href="#l28.530"></a><span id="l28.530">     isFile = false;</span>
<a href="#l28.531"></a><span id="l28.531" class="difflineminus">-    rv = entry-&gt;IsFile( &amp;isFile);</span>
<a href="#l28.532"></a><span id="l28.532" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; isFile) {</span>
<a href="#l28.533"></a><span id="l28.533" class="difflineplus">+    rv = entry-&gt;IsFile(&amp;isFile);</span>
<a href="#l28.534"></a><span id="l28.534" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; isFile) {</span>
<a href="#l28.535"></a><span id="l28.535">       pLeaf = nsnull;</span>
<a href="#l28.536"></a><span id="l28.536" class="difflineminus">-      rv = entry-&gt;GetNativeLeafName( fName);</span>
<a href="#l28.537"></a><span id="l28.537" class="difflineminus">-      if (NS_SUCCEEDED( rv)  &amp;&amp;</span>
<a href="#l28.538"></a><span id="l28.538" class="difflineplus">+      rv = entry-&gt;GetNativeLeafName(fName);</span>
<a href="#l28.539"></a><span id="l28.539" class="difflineplus">+      if (NS_SUCCEEDED(rv)  &amp;&amp;</span>
<a href="#l28.540"></a><span id="l28.540">         (StringEndsWith(fName, NS_LITERAL_CSTRING(&quot;.dbx&quot;)))) {</span>
<a href="#l28.541"></a><span id="l28.541">           // This is a *.dbx file in the mail directory</span>
<a href="#l28.542"></a><span id="l28.542">           if (nsOE5File::IsLocalMailFile(entry)) {</span>
<a href="#l28.543"></a><span id="l28.543">             pEntry = new MailboxEntry;</span>
<a href="#l28.544"></a><span id="l28.544">             pEntry-&gt;index = index;</span>
<a href="#l28.545"></a><span id="l28.545">             index++;</span>
<a href="#l28.546"></a><span id="l28.546">             pEntry-&gt;parent = 0;</span>
<a href="#l28.547"></a><span id="l28.547">             pEntry-&gt;child = 0;</span>
<a href="#l28.548"></a><span id="l28.548">             pEntry-&gt;sibling = index;</span>
<a href="#l28.549"></a><span id="l28.549">             pEntry-&gt;type = -1;</span>
<a href="#l28.550"></a><span id="l28.550">             fName.SetLength(fName.Length() - 4);</span>
<a href="#l28.551"></a><span id="l28.551">             pEntry-&gt;fileName = fName.get();</span>
<a href="#l28.552"></a><span id="l28.552">             NS_CopyNativeToUnicode(fName, pEntry-&gt;mailName);</span>
<a href="#l28.553"></a><span id="l28.553" class="difflineminus">-            m_entryArray.AppendElement( pEntry);</span>
<a href="#l28.554"></a><span id="l28.554" class="difflineplus">+            m_entryArray.AppendElement(pEntry);</span>
<a href="#l28.555"></a><span id="l28.555">           }</span>
<a href="#l28.556"></a><span id="l28.556">       }</span>
<a href="#l28.557"></a><span id="l28.557">     }</span>
<a href="#l28.558"></a><span id="l28.558">   }</span>
<a href="#l28.559"></a><span id="l28.559"> </span>
<a href="#l28.560"></a><span id="l28.560">   if (m_entryArray.Count() &gt; 0) {</span>
<a href="#l28.561"></a><span id="l28.561" class="difflineminus">-    pEntry = (MailboxEntry *)m_entryArray.ElementAt( m_entryArray.Count() - 1);</span>
<a href="#l28.562"></a><span id="l28.562" class="difflineplus">+    pEntry = (MailboxEntry *)m_entryArray.ElementAt(m_entryArray.Count() - 1);</span>
<a href="#l28.563"></a><span id="l28.563">     pEntry-&gt;sibling = -1;</span>
<a href="#l28.564"></a><span id="l28.564" class="difflineminus">-    return( true);</span>
<a href="#l28.565"></a><span id="l28.565" class="difflineplus">+    return true;</span>
<a href="#l28.566"></a><span id="l28.566">   }</span>
<a href="#l28.567"></a><span id="l28.567"> </span>
<a href="#l28.568"></a><span id="l28.568" class="difflineminus">-  return( false);</span>
<a href="#l28.569"></a><span id="l28.569" class="difflineplus">+  return false;</span>
<a href="#l28.570"></a><span id="l28.570"> }</span>
<a href="#l28.571"></a><span id="l28.571"> </span>
<a href="#l28.572"></a><span id="l28.572"> </span>
<a href="#l28.573"></a><span id="l28.573" class="difflineminus">-void nsOEScanBoxes::ScanMailboxDir( nsIFile * srcDir)</span>
<a href="#l28.574"></a><span id="l28.574" class="difflineplus">+void nsOEScanBoxes::ScanMailboxDir(nsIFile * srcDir)</span>
<a href="#l28.575"></a><span id="l28.575"> {</span>
<a href="#l28.576"></a><span id="l28.576" class="difflineminus">-  if (Scan50MailboxDir( srcDir))</span>
<a href="#l28.577"></a><span id="l28.577" class="difflineplus">+  if (Scan50MailboxDir(srcDir))</span>
<a href="#l28.578"></a><span id="l28.578">     return;</span>
<a href="#l28.579"></a><span id="l28.579"> </span>
<a href="#l28.580"></a><span id="l28.580">   Reset();</span>
<a href="#l28.581"></a><span id="l28.581"> </span>
<a href="#l28.582"></a><span id="l28.582">   MailboxEntry *  pEntry;</span>
<a href="#l28.583"></a><span id="l28.583">   PRInt32      index = 1;</span>
<a href="#l28.584"></a><span id="l28.584">   nsCAutoString pLeaf;</span>
<a href="#l28.585"></a><span id="l28.585">   PRUint32    sLen;</span>
<a href="#l28.586"></a><span id="l28.586" class="difflineat">@@ -653,252 +650,250 @@ void nsOEScanBoxes::ScanMailboxDir( nsIF</span>
<a href="#l28.587"></a><span id="l28.587">   while (hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l28.588"></a><span id="l28.588">   {</span>
<a href="#l28.589"></a><span id="l28.589">     nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l28.590"></a><span id="l28.590">     rv = directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l28.591"></a><span id="l28.591">     nsCOMPtr&lt;nsILocalFile&gt; entry(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l28.592"></a><span id="l28.592">     directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l28.593"></a><span id="l28.593"> </span>
<a href="#l28.594"></a><span id="l28.594">     isFile = false;</span>
<a href="#l28.595"></a><span id="l28.595" class="difflineminus">-    rv = entry-&gt;IsFile( &amp;isFile);</span>
<a href="#l28.596"></a><span id="l28.596" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; isFile)</span>
<a href="#l28.597"></a><span id="l28.597" class="difflineplus">+    rv = entry-&gt;IsFile(&amp;isFile);</span>
<a href="#l28.598"></a><span id="l28.598" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; isFile)</span>
<a href="#l28.599"></a><span id="l28.599">     {</span>
<a href="#l28.600"></a><span id="l28.600">       rv = entry-&gt;GetNativeLeafName(pLeaf);</span>
<a href="#l28.601"></a><span id="l28.601" class="difflineminus">-      if (NS_SUCCEEDED( rv) &amp;&amp; !pLeaf.IsEmpty() &amp;&amp;</span>
<a href="#l28.602"></a><span id="l28.602" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; !pLeaf.IsEmpty() &amp;&amp;</span>
<a href="#l28.603"></a><span id="l28.603">         ((sLen = pLeaf.Length()) &gt; 4) &amp;&amp;</span>
<a href="#l28.604"></a><span id="l28.604" class="difflineminus">-        (!PL_strcasecmp( pLeaf.get() + sLen - 3, &quot;mbx&quot;)))</span>
<a href="#l28.605"></a><span id="l28.605" class="difflineplus">+        (!PL_strcasecmp(pLeaf.get() + sLen - 3, &quot;mbx&quot;)))</span>
<a href="#l28.606"></a><span id="l28.606">       {</span>
<a href="#l28.607"></a><span id="l28.607">           // This is a *.mbx file in the mail directory</span>
<a href="#l28.608"></a><span id="l28.608">           pEntry = new MailboxEntry;</span>
<a href="#l28.609"></a><span id="l28.609">           pEntry-&gt;index = index;</span>
<a href="#l28.610"></a><span id="l28.610">           index++;</span>
<a href="#l28.611"></a><span id="l28.611">           pEntry-&gt;parent = 0;</span>
<a href="#l28.612"></a><span id="l28.612">           pEntry-&gt;child = 0;</span>
<a href="#l28.613"></a><span id="l28.613">           pEntry-&gt;sibling = index;</span>
<a href="#l28.614"></a><span id="l28.614">           pEntry-&gt;type = -1;</span>
<a href="#l28.615"></a><span id="l28.615">           pEntry-&gt;fileName = pLeaf;</span>
<a href="#l28.616"></a><span id="l28.616">           pLeaf.SetLength(sLen - 4);</span>
<a href="#l28.617"></a><span id="l28.617">           NS_CopyNativeToUnicode(pLeaf, pEntry-&gt;mailName);</span>
<a href="#l28.618"></a><span id="l28.618" class="difflineminus">-          m_entryArray.AppendElement( pEntry);</span>
<a href="#l28.619"></a><span id="l28.619" class="difflineplus">+          m_entryArray.AppendElement(pEntry);</span>
<a href="#l28.620"></a><span id="l28.620">       }</span>
<a href="#l28.621"></a><span id="l28.621">     }</span>
<a href="#l28.622"></a><span id="l28.622">   }</span>
<a href="#l28.623"></a><span id="l28.623"> </span>
<a href="#l28.624"></a><span id="l28.624">   if (m_entryArray.Count() &gt; 0) {</span>
<a href="#l28.625"></a><span id="l28.625" class="difflineminus">-    pEntry = (MailboxEntry *)m_entryArray.ElementAt( m_entryArray.Count() - 1);</span>
<a href="#l28.626"></a><span id="l28.626" class="difflineplus">+    pEntry = (MailboxEntry *)m_entryArray.ElementAt(m_entryArray.Count() - 1);</span>
<a href="#l28.627"></a><span id="l28.627">     pEntry-&gt;sibling = -1;</span>
<a href="#l28.628"></a><span id="l28.628">   }</span>
<a href="#l28.629"></a><span id="l28.629"> }</span>
<a href="#l28.630"></a><span id="l28.630"> </span>
<a href="#l28.631"></a><span id="l28.631"> </span>
<a href="#l28.632"></a><span id="l28.632" class="difflineminus">-PRUint32 nsOEScanBoxes::CountMailboxes( MailboxEntry *pBox)</span>
<a href="#l28.633"></a><span id="l28.633" class="difflineplus">+PRUint32 nsOEScanBoxes::CountMailboxes(MailboxEntry *pBox)</span>
<a href="#l28.634"></a><span id="l28.634"> {</span>
<a href="#l28.635"></a><span id="l28.635">   if (pBox == nsnull) {</span>
<a href="#l28.636"></a><span id="l28.636">     if (m_pFirst != nsnull)</span>
<a href="#l28.637"></a><span id="l28.637">       pBox = m_pFirst;</span>
<a href="#l28.638"></a><span id="l28.638">     else {</span>
<a href="#l28.639"></a><span id="l28.639">       if (m_entryArray.Count() &gt; 0)</span>
<a href="#l28.640"></a><span id="l28.640" class="difflineminus">-        pBox = (MailboxEntry *) m_entryArray.ElementAt( 0);</span>
<a href="#l28.641"></a><span id="l28.641" class="difflineplus">+        pBox = (MailboxEntry *) m_entryArray.ElementAt(0);</span>
<a href="#l28.642"></a><span id="l28.642">     }</span>
<a href="#l28.643"></a><span id="l28.643">   }</span>
<a href="#l28.644"></a><span id="l28.644">   PRUint32    count = 0;</span>
<a href="#l28.645"></a><span id="l28.645"> </span>
<a href="#l28.646"></a><span id="l28.646">   MailboxEntry *  pChild;</span>
<a href="#l28.647"></a><span id="l28.647">   while (pBox) {</span>
<a href="#l28.648"></a><span id="l28.648">     count++;</span>
<a href="#l28.649"></a><span id="l28.649">     if (pBox-&gt;child) {</span>
<a href="#l28.650"></a><span id="l28.650" class="difflineminus">-      pChild = GetIndexEntry( pBox-&gt;child);</span>
<a href="#l28.651"></a><span id="l28.651" class="difflineplus">+      pChild = GetIndexEntry(pBox-&gt;child);</span>
<a href="#l28.652"></a><span id="l28.652">       if (pChild != nsnull)</span>
<a href="#l28.653"></a><span id="l28.653" class="difflineminus">-        count += CountMailboxes( pChild);</span>
<a href="#l28.654"></a><span id="l28.654" class="difflineplus">+        count += CountMailboxes(pChild);</span>
<a href="#l28.655"></a><span id="l28.655">     }</span>
<a href="#l28.656"></a><span id="l28.656">     if (pBox-&gt;sibling != -1) {</span>
<a href="#l28.657"></a><span id="l28.657" class="difflineminus">-      pBox = GetIndexEntry( pBox-&gt;sibling);</span>
<a href="#l28.658"></a><span id="l28.658" class="difflineplus">+      pBox = GetIndexEntry(pBox-&gt;sibling);</span>
<a href="#l28.659"></a><span id="l28.659">     }</span>
<a href="#l28.660"></a><span id="l28.660">     else</span>
<a href="#l28.661"></a><span id="l28.661">       pBox = nsnull;</span>
<a href="#l28.662"></a><span id="l28.662">   }</span>
<a href="#l28.663"></a><span id="l28.663"> </span>
<a href="#l28.664"></a><span id="l28.664" class="difflineminus">-  return( count);</span>
<a href="#l28.665"></a><span id="l28.665" class="difflineplus">+  return count;</span>
<a href="#l28.666"></a><span id="l28.666"> }</span>
<a href="#l28.667"></a><span id="l28.667"> </span>
<a href="#l28.668"></a><span id="l28.668" class="difflineminus">-bool nsOEScanBoxes::GetMailboxList( nsIFile * root, nsISupportsArray **pArray)</span>
<a href="#l28.669"></a><span id="l28.669" class="difflineplus">+bool nsOEScanBoxes::GetMailboxList(nsIFile * root, nsISupportsArray **pArray)</span>
<a href="#l28.670"></a><span id="l28.670"> {</span>
<a href="#l28.671"></a><span id="l28.671" class="difflineminus">-  nsresult rv = NS_NewISupportsArray( pArray);</span>
<a href="#l28.672"></a><span id="l28.672" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l28.673"></a><span id="l28.673" class="difflineminus">-    IMPORT_LOG0( &quot;FAILED to allocate the nsISupportsArray\n&quot;);</span>
<a href="#l28.674"></a><span id="l28.674" class="difflineminus">-    return( false);</span>
<a href="#l28.675"></a><span id="l28.675" class="difflineplus">+  nsresult rv = NS_NewISupportsArray(pArray);</span>
<a href="#l28.676"></a><span id="l28.676" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l28.677"></a><span id="l28.677" class="difflineplus">+    IMPORT_LOG0(&quot;FAILED to allocate the nsISupportsArray\n&quot;);</span>
<a href="#l28.678"></a><span id="l28.678" class="difflineplus">+    return false;</span>
<a href="#l28.679"></a><span id="l28.679">   }</span>
<a href="#l28.680"></a><span id="l28.680"> </span>
<a href="#l28.681"></a><span id="l28.681" class="difflineminus">-  BuildMailboxList( nsnull, root, 1, *pArray);</span>
<a href="#l28.682"></a><span id="l28.682" class="difflineplus">+  BuildMailboxList(nsnull, root, 1, *pArray);</span>
<a href="#l28.683"></a><span id="l28.683"> </span>
<a href="#l28.684"></a><span id="l28.684" class="difflineminus">-  return( true);</span>
<a href="#l28.685"></a><span id="l28.685" class="difflineplus">+  return true;</span>
<a href="#l28.686"></a><span id="l28.686"> }</span>
<a href="#l28.687"></a><span id="l28.687"> </span>
<a href="#l28.688"></a><span id="l28.688" class="difflineminus">-void nsOEScanBoxes::BuildMailboxList( MailboxEntry *pBox, nsIFile * root, PRInt32 depth, nsISupportsArray *pArray)</span>
<a href="#l28.689"></a><span id="l28.689" class="difflineplus">+void nsOEScanBoxes::BuildMailboxList(MailboxEntry *pBox, nsIFile * root, PRInt32 depth, nsISupportsArray *pArray)</span>
<a href="#l28.690"></a><span id="l28.690"> {</span>
<a href="#l28.691"></a><span id="l28.691">   if (pBox == nsnull) {</span>
<a href="#l28.692"></a><span id="l28.692">     if (m_pFirst != nsnull) {</span>
<a href="#l28.693"></a><span id="l28.693">       pBox = m_pFirst;</span>
<a href="#l28.694"></a><span id="l28.694"> </span>
<a href="#l28.695"></a><span id="l28.695" class="difflineminus">-      IMPORT_LOG0( &quot;Assigning start of mailbox list to m_pFirst\n&quot;);</span>
<a href="#l28.696"></a><span id="l28.696" class="difflineplus">+      IMPORT_LOG0(&quot;Assigning start of mailbox list to m_pFirst\n&quot;);</span>
<a href="#l28.697"></a><span id="l28.697">     }</span>
<a href="#l28.698"></a><span id="l28.698">     else {</span>
<a href="#l28.699"></a><span id="l28.699">       if (m_entryArray.Count() &gt; 0) {</span>
<a href="#l28.700"></a><span id="l28.700" class="difflineminus">-        pBox = (MailboxEntry *) m_entryArray.ElementAt( 0);</span>
<a href="#l28.701"></a><span id="l28.701" class="difflineplus">+        pBox = (MailboxEntry *) m_entryArray.ElementAt(0);</span>
<a href="#l28.702"></a><span id="l28.702"> </span>
<a href="#l28.703"></a><span id="l28.703" class="difflineminus">-        IMPORT_LOG0( &quot;Assigning start of mailbox list to entry at index 0\n&quot;);</span>
<a href="#l28.704"></a><span id="l28.704" class="difflineplus">+        IMPORT_LOG0(&quot;Assigning start of mailbox list to entry at index 0\n&quot;);</span>
<a href="#l28.705"></a><span id="l28.705">       }</span>
<a href="#l28.706"></a><span id="l28.706">     }</span>
<a href="#l28.707"></a><span id="l28.707"> </span>
<a href="#l28.708"></a><span id="l28.708">     if (pBox == nsnull) {</span>
<a href="#l28.709"></a><span id="l28.709" class="difflineminus">-      IMPORT_LOG0( &quot;ERROR ASSIGNING STARTING MAILBOX\n&quot;);</span>
<a href="#l28.710"></a><span id="l28.710" class="difflineplus">+      IMPORT_LOG0(&quot;ERROR ASSIGNING STARTING MAILBOX\n&quot;);</span>
<a href="#l28.711"></a><span id="l28.711">     }</span>
<a href="#l28.712"></a><span id="l28.712"> </span>
<a href="#l28.713"></a><span id="l28.713">   }</span>
<a href="#l28.714"></a><span id="l28.714"> </span>
<a href="#l28.715"></a><span id="l28.715">   nsresult            rv;</span>
<a href="#l28.716"></a><span id="l28.716">   nsCOMPtr &lt;nsILocalFile&gt; file;</span>
<a href="#l28.717"></a><span id="l28.717">   MailboxEntry *  pChild;</span>
<a href="#l28.718"></a><span id="l28.718">   nsIImportMailboxDescriptor *  pID;</span>
<a href="#l28.719"></a><span id="l28.719">   nsISupports *          pInterface;</span>
<a href="#l28.720"></a><span id="l28.720">   PRInt64            size;</span>
<a href="#l28.721"></a><span id="l28.721"> </span>
<a href="#l28.722"></a><span id="l28.722">   nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l28.723"></a><span id="l28.723" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l28.724"></a><span id="l28.724" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l28.725"></a><span id="l28.725">     return;</span>
<a href="#l28.726"></a><span id="l28.726"> </span>
<a href="#l28.727"></a><span id="l28.727">   while (pBox) {</span>
<a href="#l28.728"></a><span id="l28.728" class="difflineminus">-    rv = impSvc-&gt;CreateNewMailboxDescriptor( &amp;pID);</span>
<a href="#l28.729"></a><span id="l28.729" class="difflineminus">-    if (NS_SUCCEEDED( rv)) {</span>
<a href="#l28.730"></a><span id="l28.730" class="difflineminus">-      pID-&gt;SetDepth( depth);</span>
<a href="#l28.731"></a><span id="l28.731" class="difflineminus">-      pID-&gt;SetIdentifier( pBox-&gt;index);</span>
<a href="#l28.732"></a><span id="l28.732" class="difflineminus">-      pID-&gt;SetDisplayName( (PRUnichar *)pBox-&gt;mailName.get());</span>
<a href="#l28.733"></a><span id="l28.733" class="difflineplus">+    rv = impSvc-&gt;CreateNewMailboxDescriptor(&amp;pID);</span>
<a href="#l28.734"></a><span id="l28.734" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l28.735"></a><span id="l28.735" class="difflineplus">+      pID-&gt;SetDepth(depth);</span>
<a href="#l28.736"></a><span id="l28.736" class="difflineplus">+      pID-&gt;SetIdentifier(pBox-&gt;index);</span>
<a href="#l28.737"></a><span id="l28.737" class="difflineplus">+      pID-&gt;SetDisplayName((PRUnichar *)pBox-&gt;mailName.get());</span>
<a href="#l28.738"></a><span id="l28.738">       if (!pBox-&gt;fileName.IsEmpty()) {</span>
<a href="#l28.739"></a><span id="l28.739" class="difflineminus">-        pID-&gt;GetFile( getter_AddRefs(file));</span>
<a href="#l28.740"></a><span id="l28.740" class="difflineplus">+        pID-&gt;GetFile(getter_AddRefs(file));</span>
<a href="#l28.741"></a><span id="l28.741">                                 nsCOMPtr &lt;nsILocalFile&gt; localRoot = do_QueryInterface(root);</span>
<a href="#l28.742"></a><span id="l28.742">         file-&gt;InitWithFile(localRoot);</span>
<a href="#l28.743"></a><span id="l28.743" class="difflineminus">-        file-&gt;AppendNative( pBox-&gt;fileName);</span>
<a href="#l28.744"></a><span id="l28.744" class="difflineplus">+        file-&gt;AppendNative(pBox-&gt;fileName);</span>
<a href="#l28.745"></a><span id="l28.745">         size = 0;</span>
<a href="#l28.746"></a><span id="l28.746" class="difflineminus">-        file-&gt;GetFileSize( &amp;size);</span>
<a href="#l28.747"></a><span id="l28.747" class="difflineminus">-        pID-&gt;SetSize( size);</span>
<a href="#l28.748"></a><span id="l28.748" class="difflineplus">+        file-&gt;GetFileSize(&amp;size);</span>
<a href="#l28.749"></a><span id="l28.749" class="difflineplus">+        pID-&gt;SetSize(size);</span>
<a href="#l28.750"></a><span id="l28.750">       }</span>
<a href="#l28.751"></a><span id="l28.751" class="difflineminus">-      rv = pID-&gt;QueryInterface( kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l28.752"></a><span id="l28.752" class="difflineminus">-      pArray-&gt;AppendElement( pInterface);</span>
<a href="#l28.753"></a><span id="l28.753" class="difflineplus">+      rv = pID-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l28.754"></a><span id="l28.754" class="difflineplus">+      pArray-&gt;AppendElement(pInterface);</span>
<a href="#l28.755"></a><span id="l28.755">       pInterface-&gt;Release();</span>
<a href="#l28.756"></a><span id="l28.756">       pID-&gt;Release();</span>
<a href="#l28.757"></a><span id="l28.757">     }</span>
<a href="#l28.758"></a><span id="l28.758"> </span>
<a href="#l28.759"></a><span id="l28.759">     if (pBox-&gt;child) {</span>
<a href="#l28.760"></a><span id="l28.760" class="difflineminus">-      pChild = GetIndexEntry( pBox-&gt;child);</span>
<a href="#l28.761"></a><span id="l28.761" class="difflineplus">+      pChild = GetIndexEntry(pBox-&gt;child);</span>
<a href="#l28.762"></a><span id="l28.762">       if (pChild != nsnull)</span>
<a href="#l28.763"></a><span id="l28.763" class="difflineminus">-        BuildMailboxList( pChild, root, depth + 1, pArray);</span>
<a href="#l28.764"></a><span id="l28.764" class="difflineplus">+        BuildMailboxList(pChild, root, depth + 1, pArray);</span>
<a href="#l28.765"></a><span id="l28.765">     }</span>
<a href="#l28.766"></a><span id="l28.766">     if (pBox-&gt;sibling != -1) {</span>
<a href="#l28.767"></a><span id="l28.767" class="difflineminus">-      pBox = GetIndexEntry( pBox-&gt;sibling);</span>
<a href="#l28.768"></a><span id="l28.768" class="difflineplus">+      pBox = GetIndexEntry(pBox-&gt;sibling);</span>
<a href="#l28.769"></a><span id="l28.769">     }</span>
<a href="#l28.770"></a><span id="l28.770">     else</span>
<a href="#l28.771"></a><span id="l28.771">       pBox = nsnull;</span>
<a href="#l28.772"></a><span id="l28.772">   }</span>
<a href="#l28.773"></a><span id="l28.773"> </span>
<a href="#l28.774"></a><span id="l28.774"> }</span>
<a href="#l28.775"></a><span id="l28.775"> </span>
<a href="#l28.776"></a><span id="l28.776"> </span>
<a href="#l28.777"></a><span id="l28.777"> </span>
<a href="#l28.778"></a><span id="l28.778" class="difflineminus">-nsOEScanBoxes::MailboxEntry * nsOEScanBoxes::GetIndexEntry( PRUint32 index)</span>
<a href="#l28.779"></a><span id="l28.779" class="difflineplus">+nsOEScanBoxes::MailboxEntry * nsOEScanBoxes::GetIndexEntry(PRUint32 index)</span>
<a href="#l28.780"></a><span id="l28.780"> {</span>
<a href="#l28.781"></a><span id="l28.781">   PRInt32 max = m_entryArray.Count();</span>
<a href="#l28.782"></a><span id="l28.782">   for (PRInt32 i = 0; i &lt; max; i++) {</span>
<a href="#l28.783"></a><span id="l28.783" class="difflineminus">-    MailboxEntry *pEntry = (MailboxEntry *) m_entryArray.ElementAt( i);</span>
<a href="#l28.784"></a><span id="l28.784" class="difflineplus">+    MailboxEntry *pEntry = (MailboxEntry *) m_entryArray.ElementAt(i);</span>
<a href="#l28.785"></a><span id="l28.785">     if (pEntry-&gt;index == index)</span>
<a href="#l28.786"></a><span id="l28.786" class="difflineminus">-      return( pEntry);</span>
<a href="#l28.787"></a><span id="l28.787" class="difflineplus">+      return pEntry;</span>
<a href="#l28.788"></a><span id="l28.788">   }</span>
<a href="#l28.789"></a><span id="l28.789"> </span>
<a href="#l28.790"></a><span id="l28.790" class="difflineminus">-  return( nsnull);</span>
<a href="#l28.791"></a><span id="l28.791" class="difflineplus">+  return nsnull;</span>
<a href="#l28.792"></a><span id="l28.792"> }</span>
<a href="#l28.793"></a><span id="l28.793"> </span>
<a href="#l28.794"></a><span id="l28.794"> </span>
<a href="#l28.795"></a><span id="l28.795"> // -------------------------------------------------------</span>
<a href="#l28.796"></a><span id="l28.796"> // File utility routines</span>
<a href="#l28.797"></a><span id="l28.797"> // -------------------------------------------------------</span>
<a href="#l28.798"></a><span id="l28.798"> </span>
<a href="#l28.799"></a><span id="l28.799" class="difflineminus">-bool nsOEScanBoxes::ReadLong( nsIInputStream * stream, PRInt32&amp; val, PRUint32 offset)</span>
<a href="#l28.800"></a><span id="l28.800" class="difflineplus">+bool nsOEScanBoxes::ReadLong(nsIInputStream * stream, PRInt32&amp; val, PRUint32 offset)</span>
<a href="#l28.801"></a><span id="l28.801"> {</span>
<a href="#l28.802"></a><span id="l28.802">   nsresult  rv;</span>
<a href="#l28.803"></a><span id="l28.803">         nsCOMPtr &lt;nsISeekableStream&gt; seekStream = do_QueryInterface(stream, &amp;rv);</span>
<a href="#l28.804"></a><span id="l28.804">         NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l28.805"></a><span id="l28.805">   rv = seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, offset);</span>
<a href="#l28.806"></a><span id="l28.806" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l28.807"></a><span id="l28.807" class="difflineminus">-    return( false);</span>
<a href="#l28.808"></a><span id="l28.808" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l28.809"></a><span id="l28.809" class="difflineplus">+    return false;</span>
<a href="#l28.810"></a><span id="l28.810"> </span>
<a href="#l28.811"></a><span id="l28.811">   PRUint32  cntRead;</span>
<a href="#l28.812"></a><span id="l28.812">   char * pReadTo = (char *)&amp;val;</span>
<a href="#l28.813"></a><span id="l28.813" class="difflineminus">-  rv = stream-&gt;Read(pReadTo, sizeof( val), &amp;cntRead);</span>
<a href="#l28.814"></a><span id="l28.814" class="difflineplus">+  rv = stream-&gt;Read(pReadTo, sizeof(val), &amp;cntRead);</span>
<a href="#l28.815"></a><span id="l28.815"> </span>
<a href="#l28.816"></a><span id="l28.816" class="difflineminus">-  if (NS_FAILED( rv) || (cntRead != sizeof( val)))</span>
<a href="#l28.817"></a><span id="l28.817" class="difflineminus">-    return( false);</span>
<a href="#l28.818"></a><span id="l28.818" class="difflineminus">-  return( true);</span>
<a href="#l28.819"></a><span id="l28.819" class="difflineplus">+  return NS_SUCCEEDED(rv) &amp;&amp; cntRead == sizeof(val);</span>
<a href="#l28.820"></a><span id="l28.820"> }</span>
<a href="#l28.821"></a><span id="l28.821"> </span>
<a href="#l28.822"></a><span id="l28.822" class="difflineminus">-bool nsOEScanBoxes::ReadLong( nsIInputStream * stream, PRUint32&amp; val, PRUint32 offset)</span>
<a href="#l28.823"></a><span id="l28.823" class="difflineplus">+bool nsOEScanBoxes::ReadLong(nsIInputStream * stream, PRUint32&amp; val, PRUint32 offset)</span>
<a href="#l28.824"></a><span id="l28.824"> {</span>
<a href="#l28.825"></a><span id="l28.825">   nsresult  rv;</span>
<a href="#l28.826"></a><span id="l28.826">         nsCOMPtr &lt;nsISeekableStream&gt; seekStream = do_QueryInterface(stream, &amp;rv);</span>
<a href="#l28.827"></a><span id="l28.827">         NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l28.828"></a><span id="l28.828">   rv = seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, offset);</span>
<a href="#l28.829"></a><span id="l28.829" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l28.830"></a><span id="l28.830" class="difflineminus">-    return( false);</span>
<a href="#l28.831"></a><span id="l28.831" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l28.832"></a><span id="l28.832" class="difflineplus">+    return false;</span>
<a href="#l28.833"></a><span id="l28.833"> </span>
<a href="#l28.834"></a><span id="l28.834">   PRUint32  cntRead;</span>
<a href="#l28.835"></a><span id="l28.835">   char * pReadTo = (char *)&amp;val;</span>
<a href="#l28.836"></a><span id="l28.836" class="difflineminus">-  rv = stream-&gt;Read(pReadTo, sizeof( val), &amp;cntRead);</span>
<a href="#l28.837"></a><span id="l28.837" class="difflineplus">+  rv = stream-&gt;Read(pReadTo, sizeof(val), &amp;cntRead);</span>
<a href="#l28.838"></a><span id="l28.838"> </span>
<a href="#l28.839"></a><span id="l28.839" class="difflineminus">-  if (NS_FAILED( rv) || (cntRead != sizeof( val)))</span>
<a href="#l28.840"></a><span id="l28.840" class="difflineminus">-    return( false);</span>
<a href="#l28.841"></a><span id="l28.841" class="difflineminus">-  return( true);</span>
<a href="#l28.842"></a><span id="l28.842" class="difflineplus">+  if (NS_FAILED(rv) || (cntRead != sizeof(val)))</span>
<a href="#l28.843"></a><span id="l28.843" class="difflineplus">+    return false;</span>
<a href="#l28.844"></a><span id="l28.844" class="difflineplus">+  return true;</span>
<a href="#l28.845"></a><span id="l28.845"> }</span>
<a href="#l28.846"></a><span id="l28.846"> </span>
<a href="#l28.847"></a><span id="l28.847"> // It appears as though the strings for file name and mailbox</span>
<a href="#l28.848"></a><span id="l28.848"> // name are at least 254 chars - verified - they are probably 255</span>
<a href="#l28.849"></a><span id="l28.849"> // but why bother going that far!  If a file name is that long then</span>
<a href="#l28.850"></a><span id="l28.850"> // the heck with it.</span>
<a href="#l28.851"></a><span id="l28.851"> #define  kOutlookExpressStringLength  252</span>
<a href="#l28.852"></a><span id="l28.852" class="difflineminus">-bool nsOEScanBoxes::ReadString( nsIInputStream * stream, nsString&amp; str, PRUint32 offset)</span>
<a href="#l28.853"></a><span id="l28.853" class="difflineplus">+bool nsOEScanBoxes::ReadString(nsIInputStream * stream, nsString&amp; str, PRUint32 offset)</span>
<a href="#l28.854"></a><span id="l28.854"> {</span>
<a href="#l28.855"></a><span id="l28.855">   nsresult rv;</span>
<a href="#l28.856"></a><span id="l28.856">   nsCOMPtr &lt;nsISeekableStream&gt; seekStream = do_QueryInterface(stream, &amp;rv);</span>
<a href="#l28.857"></a><span id="l28.857">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l28.858"></a><span id="l28.858">   rv = seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, offset);</span>
<a href="#l28.859"></a><span id="l28.859" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l28.860"></a><span id="l28.860" class="difflineminus">-    return( false);</span>
<a href="#l28.861"></a><span id="l28.861" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l28.862"></a><span id="l28.862" class="difflineplus">+    return false;</span>
<a href="#l28.863"></a><span id="l28.863"> </span>
<a href="#l28.864"></a><span id="l28.864"> </span>
<a href="#l28.865"></a><span id="l28.865">   PRUint32 cntRead;</span>
<a href="#l28.866"></a><span id="l28.866">   char buffer[kOutlookExpressStringLength];</span>
<a href="#l28.867"></a><span id="l28.867">   char * pReadTo = buffer;</span>
<a href="#l28.868"></a><span id="l28.868" class="difflineminus">-  rv = stream-&gt;Read( pReadTo, kOutlookExpressStringLength, &amp;cntRead);</span>
<a href="#l28.869"></a><span id="l28.869" class="difflineplus">+  rv = stream-&gt;Read(pReadTo, kOutlookExpressStringLength, &amp;cntRead);</span>
<a href="#l28.870"></a><span id="l28.870"> </span>
<a href="#l28.871"></a><span id="l28.871" class="difflineminus">-  if (NS_FAILED( rv) || (cntRead != kOutlookExpressStringLength))</span>
<a href="#l28.872"></a><span id="l28.872" class="difflineminus">-    return( false);</span>
<a href="#l28.873"></a><span id="l28.873" class="difflineplus">+  if (NS_FAILED(rv) || (cntRead != kOutlookExpressStringLength))</span>
<a href="#l28.874"></a><span id="l28.874" class="difflineplus">+    return false;</span>
<a href="#l28.875"></a><span id="l28.875">   buffer[kOutlookExpressStringLength - 1] = 0;</span>
<a href="#l28.876"></a><span id="l28.876">   str.AssignASCII(buffer);</span>
<a href="#l28.877"></a><span id="l28.877" class="difflineminus">-  return( true);</span>
<a href="#l28.878"></a><span id="l28.878" class="difflineplus">+  return true;</span>
<a href="#l28.879"></a><span id="l28.879"> }</span>
<a href="#l28.880"></a><span id="l28.880"> </span>
<a href="#l28.881"></a><span id="l28.881" class="difflineminus">-bool nsOEScanBoxes::ReadString( nsIInputStream * stream, nsCString&amp; str, PRUint32 offset)</span>
<a href="#l28.882"></a><span id="l28.882" class="difflineplus">+bool nsOEScanBoxes::ReadString(nsIInputStream * stream, nsCString&amp; str, PRUint32 offset)</span>
<a href="#l28.883"></a><span id="l28.883"> {</span>
<a href="#l28.884"></a><span id="l28.884">   nsresult  rv;</span>
<a href="#l28.885"></a><span id="l28.885">         nsCOMPtr &lt;nsISeekableStream&gt; seekStream = do_QueryInterface(stream, &amp;rv);</span>
<a href="#l28.886"></a><span id="l28.886">         NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l28.887"></a><span id="l28.887">   rv = seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, offset);</span>
<a href="#l28.888"></a><span id="l28.888" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l28.889"></a><span id="l28.889" class="difflineminus">-    return( false);</span>
<a href="#l28.890"></a><span id="l28.890" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l28.891"></a><span id="l28.891" class="difflineplus">+    return false;</span>
<a href="#l28.892"></a><span id="l28.892"> </span>
<a href="#l28.893"></a><span id="l28.893">   PRUint32  cntRead;</span>
<a href="#l28.894"></a><span id="l28.894">   char  buffer[kOutlookExpressStringLength];</span>
<a href="#l28.895"></a><span id="l28.895">   char *  pReadTo = buffer;</span>
<a href="#l28.896"></a><span id="l28.896" class="difflineminus">-  rv = stream-&gt;Read( pReadTo, kOutlookExpressStringLength, &amp;cntRead);</span>
<a href="#l28.897"></a><span id="l28.897" class="difflineplus">+  rv = stream-&gt;Read(pReadTo, kOutlookExpressStringLength, &amp;cntRead);</span>
<a href="#l28.898"></a><span id="l28.898"> </span>
<a href="#l28.899"></a><span id="l28.899" class="difflineminus">-  if (NS_FAILED( rv) || (cntRead != kOutlookExpressStringLength))</span>
<a href="#l28.900"></a><span id="l28.900" class="difflineminus">-    return( false);</span>
<a href="#l28.901"></a><span id="l28.901" class="difflineplus">+  if (NS_FAILED(rv) || (cntRead != kOutlookExpressStringLength))</span>
<a href="#l28.902"></a><span id="l28.902" class="difflineplus">+    return false;</span>
<a href="#l28.903"></a><span id="l28.903">   buffer[kOutlookExpressStringLength - 1] = 0;</span>
<a href="#l28.904"></a><span id="l28.904">   str = buffer;</span>
<a href="#l28.905"></a><span id="l28.905" class="difflineminus">-  return( true);</span>
<a href="#l28.906"></a><span id="l28.906" class="difflineplus">+  return true;</span>
<a href="#l28.907"></a><span id="l28.907"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOEScanBoxes.h</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOEScanBoxes.h</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -48,58 +48,58 @@</span>
<a href="#l29.4"></a><span id="l29.4"> </span>
<a href="#l29.5"></a><span id="l29.5"> class nsIInputStream;</span>
<a href="#l29.6"></a><span id="l29.6"> </span>
<a href="#l29.7"></a><span id="l29.7"> class nsOEScanBoxes {</span>
<a href="#l29.8"></a><span id="l29.8"> public:</span>
<a href="#l29.9"></a><span id="l29.9">   nsOEScanBoxes();</span>
<a href="#l29.10"></a><span id="l29.10">   ~nsOEScanBoxes();</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-  static bool    FindMail( nsIFile *pWhere);</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+  static bool    FindMail(nsIFile *pWhere);</span>
<a href="#l29.14"></a><span id="l29.14"> </span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">-  bool    GetMailboxes( nsIFile *pWhere, nsISupportsArray **pArray);</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+  bool    GetMailboxes(nsIFile *pWhere, nsISupportsArray **pArray);</span>
<a href="#l29.17"></a><span id="l29.17"> </span>
<a href="#l29.18"></a><span id="l29.18"> </span>
<a href="#l29.19"></a><span id="l29.19"> private:</span>
<a href="#l29.20"></a><span id="l29.20">   typedef struct {</span>
<a href="#l29.21"></a><span id="l29.21">     PRUint32  index;</span>
<a href="#l29.22"></a><span id="l29.22">     PRUint32  parent;</span>
<a href="#l29.23"></a><span id="l29.23">     PRInt32    child;</span>
<a href="#l29.24"></a><span id="l29.24">     PRInt32    sibling;</span>
<a href="#l29.25"></a><span id="l29.25">     PRInt32    type;</span>
<a href="#l29.26"></a><span id="l29.26">     nsString  mailName;</span>
<a href="#l29.27"></a><span id="l29.27">     nsCString  fileName;</span>
<a href="#l29.28"></a><span id="l29.28">     bool      processed; // used by entries on m_pendingChildArray list</span>
<a href="#l29.29"></a><span id="l29.29">   } MailboxEntry;</span>
<a href="#l29.30"></a><span id="l29.30"> </span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-  static bool    Find50Mail( nsIFile *pWhere);</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+  static bool    Find50Mail(nsIFile *pWhere);</span>
<a href="#l29.33"></a><span id="l29.33"> </span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-  void  Reset( void);</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineminus">-  bool    FindMailBoxes( nsIFile * descFile);</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineminus">-  bool    Find50MailBoxes( nsIFile * descFile);</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineplus">+  void  Reset(void);</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineplus">+  bool    FindMailBoxes(nsIFile * descFile);</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineplus">+  bool    Find50MailBoxes(nsIFile * descFile);</span>
<a href="#l29.40"></a><span id="l29.40"> </span>
<a href="#l29.41"></a><span id="l29.41">   // If find mailboxes fails you can use this routine to get the raw mailbox file names</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineminus">-  void  ScanMailboxDir( nsIFile * srcDir);</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineminus">-  bool    Scan50MailboxDir( nsIFile * srcDir);</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineplus">+  void  ScanMailboxDir(nsIFile * srcDir);</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineplus">+  bool    Scan50MailboxDir(nsIFile * srcDir);</span>
<a href="#l29.46"></a><span id="l29.46"> </span>
<a href="#l29.47"></a><span id="l29.47" class="difflineminus">-  MailboxEntry *  GetIndexEntry( PRUint32 index);</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineminus">-  void      AddChildEntry( MailboxEntry *pEntry, PRUint32 rootIndex);</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineplus">+  MailboxEntry *  GetIndexEntry(PRUint32 index);</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineplus">+  void      AddChildEntry(MailboxEntry *pEntry, PRUint32 rootIndex);</span>
<a href="#l29.51"></a><span id="l29.51">   MailboxEntry *  NewMailboxEntry(PRUint32 id, PRUint32 parent, const char *prettyName, char *pFileName);</span>
<a href="#l29.52"></a><span id="l29.52">   void        ProcessPendingChildEntries(PRUint32 parent, PRUint32 rootIndex, nsVoidArray &amp;childArray);</span>
<a href="#l29.53"></a><span id="l29.53">   void        RemoveProcessedChildEntries();</span>
<a href="#l29.54"></a><span id="l29.54"> </span>
<a href="#l29.55"></a><span id="l29.55"> </span>
<a href="#l29.56"></a><span id="l29.56" class="difflineminus">-  bool        ReadLong( nsIInputStream * stream, PRInt32&amp; val, PRUint32 offset);</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineminus">-  bool        ReadLong( nsIInputStream * stream, PRUint32&amp; val, PRUint32 offset);</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineminus">-  bool        ReadString( nsIInputStream * stream, nsString&amp; str, PRUint32 offset);</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineminus">-  bool        ReadString( nsIInputStream * stream, nsCString&amp; str, PRUint32 offset);</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineminus">-  PRUint32     CountMailboxes( MailboxEntry *pBox);</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineplus">+  bool        ReadLong(nsIInputStream * stream, PRInt32&amp; val, PRUint32 offset);</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineplus">+  bool        ReadLong(nsIInputStream * stream, PRUint32&amp; val, PRUint32 offset);</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineplus">+  bool        ReadString(nsIInputStream * stream, nsString&amp; str, PRUint32 offset);</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineplus">+  bool        ReadString(nsIInputStream * stream, nsCString&amp; str, PRUint32 offset);</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineplus">+  PRUint32     CountMailboxes(MailboxEntry *pBox);</span>
<a href="#l29.66"></a><span id="l29.66"> </span>
<a href="#l29.67"></a><span id="l29.67" class="difflineminus">-  void       BuildMailboxList( MailboxEntry *pBox, nsIFile * root, PRInt32 depth, nsISupportsArray *pArray);</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineminus">-  bool         GetMailboxList( nsIFile * root, nsISupportsArray **pArray);</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineplus">+  void       BuildMailboxList(MailboxEntry *pBox, nsIFile * root, PRInt32 depth, nsISupportsArray *pArray);</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineplus">+  bool         GetMailboxList(nsIFile * root, nsISupportsArray **pArray);</span>
<a href="#l29.71"></a><span id="l29.71"> </span>
<a href="#l29.72"></a><span id="l29.72"> private:</span>
<a href="#l29.73"></a><span id="l29.73">   MailboxEntry *        m_pFirst;</span>
<a href="#l29.74"></a><span id="l29.74">   nsVoidArray          m_entryArray;</span>
<a href="#l29.75"></a><span id="l29.75">   nsVoidArray          m_pendingChildArray; // contains child folders whose parent folders have not showed up.</span>
<a href="#l29.76"></a><span id="l29.76"> </span>
<a href="#l29.77"></a><span id="l29.77">   nsCOMPtr&lt;nsIImportService&gt;  mService;</span>
<a href="#l29.78"></a><span id="l29.78"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOESettings.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOESettings.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -62,29 +62,29 @@</span>
<a href="#l30.4"></a><span id="l30.4"> #include &quot;OEDebugLog.h&quot;</span>
<a href="#l30.5"></a><span id="l30.5"> #include &quot;nsIPop3IncomingServer.h&quot;</span>
<a href="#l30.6"></a><span id="l30.6"> #include &quot;nsIImapIncomingServer.h&quot;</span>
<a href="#l30.7"></a><span id="l30.7"> #include &quot;nsINntpIncomingServer.h&quot;</span>
<a href="#l30.8"></a><span id="l30.8"> #include &quot;stdlib.h&quot;</span>
<a href="#l30.9"></a><span id="l30.9"> </span>
<a href="#l30.10"></a><span id="l30.10"> class OESettings {</span>
<a href="#l30.11"></a><span id="l30.11"> public:</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-  static HKEY Find50Key( void);</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-  static HKEY Find40Key( void);</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-  static HKEY FindAccountsKey( void);</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+  static HKEY Find50Key(void);</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+  static HKEY Find40Key(void);</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+  static HKEY FindAccountsKey(void);</span>
<a href="#l30.18"></a><span id="l30.18"> </span>
<a href="#l30.19"></a><span id="l30.19" class="difflineminus">-  static bool DoImport( nsIMsgAccount **ppAccount);</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+  static bool DoImport(nsIMsgAccount **ppAccount);</span>
<a href="#l30.21"></a><span id="l30.21"> </span>
<a href="#l30.22"></a><span id="l30.22" class="difflineminus">-  static bool DoIMAPServer( nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount);</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineminus">-  static bool DoPOP3Server( nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount);</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineminus">-  static bool DoNNTPServer( nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount);</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineplus">+  static bool DoIMAPServer(nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount);</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineplus">+  static bool DoPOP3Server(nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount);</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineplus">+  static bool DoNNTPServer(nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount);</span>
<a href="#l30.28"></a><span id="l30.28"> </span>
<a href="#l30.29"></a><span id="l30.29" class="difflineminus">-  static void SetIdentities( nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, HKEY hKey,</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+  static void SetIdentities(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, HKEY hKey,</span>
<a href="#l30.31"></a><span id="l30.31">                              char *pIncomgUserName, PRInt32 authMethodIncoming, bool isNNTP);</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineminus">-  static void SetSmtpServer( char *pSmtpServer, HKEY hKey, nsIMsgIdentity *id,</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+  static void SetSmtpServer(char *pSmtpServer, HKEY hKey, nsIMsgIdentity *id,</span>
<a href="#l30.34"></a><span id="l30.34">                              char *pIncomgUserName, PRInt32 authMethodIncoming);</span>
<a href="#l30.35"></a><span id="l30.35">   static nsresult GetAccountName(HKEY hKey, char *defaultName, nsString &amp;acctName);</span>
<a href="#l30.36"></a><span id="l30.36">   static bool IsKB933612Applied();</span>
<a href="#l30.37"></a><span id="l30.37"> };</span>
<a href="#l30.38"></a><span id="l30.38"> </span>
<a href="#l30.39"></a><span id="l30.39"> static PRInt32 checkNewMailTime;// OE global setting, let's default to 30</span>
<a href="#l30.40"></a><span id="l30.40"> static bool    checkNewMail;    // OE global setting, let's default to false</span>
<a href="#l30.41"></a><span id="l30.41">                                 // This won't cause unwanted autodownloads-</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineat">@@ -115,322 +115,323 @@ nsOESettings::~nsOESettings()</span>
<a href="#l30.43"></a><span id="l30.43"> </span>
<a href="#l30.44"></a><span id="l30.44"> NS_IMPL_ISUPPORTS1(nsOESettings, nsIImportSettings)</span>
<a href="#l30.45"></a><span id="l30.45"> </span>
<a href="#l30.46"></a><span id="l30.46"> NS_IMETHODIMP nsOESettings::AutoLocate(PRUnichar **description, nsIFile **location, bool *_retval)</span>
<a href="#l30.47"></a><span id="l30.47"> {</span>
<a href="#l30.48"></a><span id="l30.48">   NS_PRECONDITION(description != nsnull, &quot;null ptr&quot;);</span>
<a href="#l30.49"></a><span id="l30.49">   NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l30.50"></a><span id="l30.50">   if (!description || !_retval)</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineminus">-    return( NS_ERROR_NULL_POINTER);</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.53"></a><span id="l30.53"> </span>
<a href="#l30.54"></a><span id="l30.54" class="difflineminus">-  *description = nsOEStringBundle::GetStringByID( OEIMPORT_NAME);</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+  *description = nsOEStringBundle::GetStringByID(OEIMPORT_NAME);</span>
<a href="#l30.56"></a><span id="l30.56">   *_retval = false;</span>
<a href="#l30.57"></a><span id="l30.57"> </span>
<a href="#l30.58"></a><span id="l30.58">   if (location)</span>
<a href="#l30.59"></a><span id="l30.59">     *location = nsnull;</span>
<a href="#l30.60"></a><span id="l30.60">   HKEY  key;</span>
<a href="#l30.61"></a><span id="l30.61">   key = OESettings::Find50Key();</span>
<a href="#l30.62"></a><span id="l30.62">   if (key != nsnull) {</span>
<a href="#l30.63"></a><span id="l30.63">     *_retval = true;</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineminus">-    ::RegCloseKey( key);</span>
<a href="#l30.65"></a><span id="l30.65" class="difflineplus">+    ::RegCloseKey(key);</span>
<a href="#l30.66"></a><span id="l30.66">   }</span>
<a href="#l30.67"></a><span id="l30.67">   else {</span>
<a href="#l30.68"></a><span id="l30.68">     key = OESettings::Find40Key();</span>
<a href="#l30.69"></a><span id="l30.69">     if (key != nsnull) {</span>
<a href="#l30.70"></a><span id="l30.70">       *_retval = true;</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineminus">-      ::RegCloseKey( key);</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineplus">+      ::RegCloseKey(key);</span>
<a href="#l30.73"></a><span id="l30.73">     }</span>
<a href="#l30.74"></a><span id="l30.74">   }</span>
<a href="#l30.75"></a><span id="l30.75">   if (*_retval) {</span>
<a href="#l30.76"></a><span id="l30.76">     key = OESettings::FindAccountsKey();</span>
<a href="#l30.77"></a><span id="l30.77">     if (key == nsnull) {</span>
<a href="#l30.78"></a><span id="l30.78">       *_retval = false;</span>
<a href="#l30.79"></a><span id="l30.79">     }</span>
<a href="#l30.80"></a><span id="l30.80">     else {</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineminus">-      ::RegCloseKey( key);</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineplus">+      ::RegCloseKey(key);</span>
<a href="#l30.83"></a><span id="l30.83">     }</span>
<a href="#l30.84"></a><span id="l30.84">   }</span>
<a href="#l30.85"></a><span id="l30.85"> </span>
<a href="#l30.86"></a><span id="l30.86" class="difflineminus">-  return( NS_OK);</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineplus">+  return NS_OK;</span>
<a href="#l30.88"></a><span id="l30.88"> }</span>
<a href="#l30.89"></a><span id="l30.89"> </span>
<a href="#l30.90"></a><span id="l30.90"> NS_IMETHODIMP nsOESettings::SetLocation(nsIFile *location)</span>
<a href="#l30.91"></a><span id="l30.91"> {</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineminus">-  return( NS_OK);</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineplus">+  return NS_OK;</span>
<a href="#l30.94"></a><span id="l30.94"> }</span>
<a href="#l30.95"></a><span id="l30.95"> </span>
<a href="#l30.96"></a><span id="l30.96"> NS_IMETHODIMP nsOESettings::Import(nsIMsgAccount **localMailAccount, bool *_retval)</span>
<a href="#l30.97"></a><span id="l30.97"> {</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineminus">-  NS_PRECONDITION( _retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineplus">+  NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l30.100"></a><span id="l30.100"> </span>
<a href="#l30.101"></a><span id="l30.101" class="difflineminus">-  if (OESettings::DoImport( localMailAccount)) {</span>
<a href="#l30.102"></a><span id="l30.102" class="difflineplus">+  if (OESettings::DoImport(localMailAccount)) {</span>
<a href="#l30.103"></a><span id="l30.103">     *_retval = true;</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineminus">-    IMPORT_LOG0( &quot;Settings import appears successful\n&quot;);</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineplus">+    IMPORT_LOG0(&quot;Settings import appears successful\n&quot;);</span>
<a href="#l30.106"></a><span id="l30.106">   }</span>
<a href="#l30.107"></a><span id="l30.107">   else {</span>
<a href="#l30.108"></a><span id="l30.108">     *_retval = false;</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineminus">-    IMPORT_LOG0( &quot;Settings import returned FALSE\n&quot;);</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineplus">+    IMPORT_LOG0(&quot;Settings import returned FALSE\n&quot;);</span>
<a href="#l30.111"></a><span id="l30.111">   }</span>
<a href="#l30.112"></a><span id="l30.112"> </span>
<a href="#l30.113"></a><span id="l30.113" class="difflineminus">-  return( NS_OK);</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineplus">+  return NS_OK;</span>
<a href="#l30.115"></a><span id="l30.115"> }</span>
<a href="#l30.116"></a><span id="l30.116"> </span>
<a href="#l30.117"></a><span id="l30.117" class="difflineminus">-HKEY OESettings::FindAccountsKey( void)</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineplus">+HKEY OESettings::FindAccountsKey(void)</span>
<a href="#l30.119"></a><span id="l30.119"> {</span>
<a href="#l30.120"></a><span id="l30.120">   HKEY  sKey;</span>
<a href="#l30.121"></a><span id="l30.121"> </span>
<a href="#l30.122"></a><span id="l30.122" class="difflineminus">-  if (::RegOpenKeyEx( HKEY_CURRENT_USER, &quot;Identities&quot;, 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineminus">-    BYTE *  pBytes = nsOERegUtil::GetValueBytes( sKey, &quot;Default User ID&quot;);</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineminus">-    ::RegCloseKey( sKey);</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineplus">+  if (::RegOpenKeyEx(HKEY_CURRENT_USER, &quot;Identities&quot;, 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineplus">+    BYTE *  pBytes = nsOERegUtil::GetValueBytes(sKey, &quot;Default User ID&quot;);</span>
<a href="#l30.127"></a><span id="l30.127" class="difflineplus">+    ::RegCloseKey(sKey);</span>
<a href="#l30.128"></a><span id="l30.128">     if (pBytes) {</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineminus">-      nsCString  key( &quot;Identities\\&quot;);</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineplus">+      nsCString  key(&quot;Identities\\&quot;);</span>
<a href="#l30.131"></a><span id="l30.131">       key += (const char *)pBytes;</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineminus">-      nsOERegUtil::FreeValueBytes( pBytes);</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineplus">+      nsOERegUtil::FreeValueBytes(pBytes);</span>
<a href="#l30.134"></a><span id="l30.134">       key += &quot;\\Software\\Microsoft\\Internet Account Manager\\Accounts&quot;;</span>
<a href="#l30.135"></a><span id="l30.135" class="difflineminus">-      if (::RegOpenKeyEx( HKEY_CURRENT_USER, key.get(), 0, KEY_QUERY_VALUE | KEY_ENUMERATE_SUB_KEYS, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l30.136"></a><span id="l30.136" class="difflineminus">-        return( sKey);</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineplus">+      if (::RegOpenKeyEx(HKEY_CURRENT_USER, key.get(), 0, KEY_QUERY_VALUE | KEY_ENUMERATE_SUB_KEYS, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineplus">+        return sKey;</span>
<a href="#l30.139"></a><span id="l30.139">       }</span>
<a href="#l30.140"></a><span id="l30.140">     }</span>
<a href="#l30.141"></a><span id="l30.141">   }</span>
<a href="#l30.142"></a><span id="l30.142"> </span>
<a href="#l30.143"></a><span id="l30.143" class="difflineminus">-  if (::RegOpenKeyEx( HKEY_CURRENT_USER, &quot;Software\\Microsoft\\Internet Account Manager\\Accounts&quot;, 0, KEY_QUERY_VALUE | KEY_ENUMERATE_SUB_KEYS, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineminus">-    return( sKey);</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineplus">+  if (::RegOpenKeyEx(HKEY_CURRENT_USER, &quot;Software\\Microsoft\\Internet Account Manager\\Accounts&quot;, 0, KEY_QUERY_VALUE | KEY_ENUMERATE_SUB_KEYS, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineplus">+    return sKey;</span>
<a href="#l30.147"></a><span id="l30.147">   }</span>
<a href="#l30.148"></a><span id="l30.148"> </span>
<a href="#l30.149"></a><span id="l30.149" class="difflineminus">-  return( nsnull);</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineplus">+  return nsnull;</span>
<a href="#l30.151"></a><span id="l30.151"> }</span>
<a href="#l30.152"></a><span id="l30.152"> </span>
<a href="#l30.153"></a><span id="l30.153" class="difflineminus">-HKEY OESettings::Find50Key( void)</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineplus">+HKEY OESettings::Find50Key(void)</span>
<a href="#l30.155"></a><span id="l30.155"> {</span>
<a href="#l30.156"></a><span id="l30.156">   bool      success = false;</span>
<a href="#l30.157"></a><span id="l30.157">   HKEY    sKey;</span>
<a href="#l30.158"></a><span id="l30.158"> </span>
<a href="#l30.159"></a><span id="l30.159" class="difflineminus">-  if (::RegOpenKeyEx( HKEY_CURRENT_USER, &quot;Identities&quot;, 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l30.160"></a><span id="l30.160" class="difflineminus">-    BYTE *  pBytes = nsOERegUtil::GetValueBytes( sKey, &quot;Default User ID&quot;);</span>
<a href="#l30.161"></a><span id="l30.161" class="difflineminus">-    ::RegCloseKey( sKey);</span>
<a href="#l30.162"></a><span id="l30.162" class="difflineplus">+  if (::RegOpenKeyEx(HKEY_CURRENT_USER, &quot;Identities&quot;, 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l30.163"></a><span id="l30.163" class="difflineplus">+    BYTE *  pBytes = nsOERegUtil::GetValueBytes(sKey, &quot;Default User ID&quot;);</span>
<a href="#l30.164"></a><span id="l30.164" class="difflineplus">+    ::RegCloseKey(sKey);</span>
<a href="#l30.165"></a><span id="l30.165">     if (pBytes) {</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineminus">-      nsCString  key( &quot;Identities\\&quot;);</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineplus">+      nsCString  key(&quot;Identities\\&quot;);</span>
<a href="#l30.168"></a><span id="l30.168">       key += (const char *)pBytes;</span>
<a href="#l30.169"></a><span id="l30.169" class="difflineminus">-      nsOERegUtil::FreeValueBytes( pBytes);</span>
<a href="#l30.170"></a><span id="l30.170" class="difflineplus">+      nsOERegUtil::FreeValueBytes(pBytes);</span>
<a href="#l30.171"></a><span id="l30.171">       key += &quot;\\Software\\Microsoft\\Outlook Express\\5.0&quot;;</span>
<a href="#l30.172"></a><span id="l30.172" class="difflineminus">-      if (::RegOpenKeyEx( HKEY_CURRENT_USER, key.get(), 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l30.173"></a><span id="l30.173" class="difflineminus">-        return( sKey);</span>
<a href="#l30.174"></a><span id="l30.174" class="difflineplus">+      if (::RegOpenKeyEx(HKEY_CURRENT_USER, key.get(), 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineplus">+        return sKey;</span>
<a href="#l30.176"></a><span id="l30.176">       }</span>
<a href="#l30.177"></a><span id="l30.177">     }</span>
<a href="#l30.178"></a><span id="l30.178">   }</span>
<a href="#l30.179"></a><span id="l30.179"> </span>
<a href="#l30.180"></a><span id="l30.180" class="difflineminus">-  return( nsnull);</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineplus">+  return nsnull;</span>
<a href="#l30.182"></a><span id="l30.182"> }</span>
<a href="#l30.183"></a><span id="l30.183"> </span>
<a href="#l30.184"></a><span id="l30.184" class="difflineminus">-HKEY OESettings::Find40Key( void)</span>
<a href="#l30.185"></a><span id="l30.185" class="difflineplus">+HKEY OESettings::Find40Key(void)</span>
<a href="#l30.186"></a><span id="l30.186"> {</span>
<a href="#l30.187"></a><span id="l30.187">   HKEY  sKey;</span>
<a href="#l30.188"></a><span id="l30.188" class="difflineminus">-  if (::RegOpenKeyEx( HKEY_CURRENT_USER, &quot;Software\\Microsoft\\Outlook Express&quot;, 0, KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l30.189"></a><span id="l30.189" class="difflineminus">-    return( sKey);</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineminus">-  }</span>
<a href="#l30.191"></a><span id="l30.191" class="difflineplus">+  if (::RegOpenKeyEx(HKEY_CURRENT_USER,</span>
<a href="#l30.192"></a><span id="l30.192" class="difflineplus">+                     &quot;Software\\Microsoft\\Outlook Express&quot;, 0,</span>
<a href="#l30.193"></a><span id="l30.193" class="difflineplus">+                     KEY_QUERY_VALUE, &amp;sKey) == ERROR_SUCCESS)</span>
<a href="#l30.194"></a><span id="l30.194" class="difflineplus">+    return sKey;</span>
<a href="#l30.195"></a><span id="l30.195"> </span>
<a href="#l30.196"></a><span id="l30.196" class="difflineminus">-  return( nsnull);</span>
<a href="#l30.197"></a><span id="l30.197" class="difflineplus">+  return nsnull;</span>
<a href="#l30.198"></a><span id="l30.198"> }</span>
<a href="#l30.199"></a><span id="l30.199"> </span>
<a href="#l30.200"></a><span id="l30.200" class="difflineminus">-bool OESettings::DoImport( nsIMsgAccount **ppAccount)</span>
<a href="#l30.201"></a><span id="l30.201" class="difflineplus">+bool OESettings::DoImport(nsIMsgAccount **ppAccount)</span>
<a href="#l30.202"></a><span id="l30.202"> {</span>
<a href="#l30.203"></a><span id="l30.203">   HKEY  hKey = FindAccountsKey();</span>
<a href="#l30.204"></a><span id="l30.204">   if (hKey == nsnull) {</span>
<a href="#l30.205"></a><span id="l30.205" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error finding Outlook Express registry account keys\n&quot;);</span>
<a href="#l30.206"></a><span id="l30.206" class="difflineminus">-    return( false);</span>
<a href="#l30.207"></a><span id="l30.207" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error finding Outlook Express registry account keys\n&quot;);</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineplus">+    return false;</span>
<a href="#l30.209"></a><span id="l30.209">   }</span>
<a href="#l30.210"></a><span id="l30.210"> </span>
<a href="#l30.211"></a><span id="l30.211">   nsresult  rv;</span>
<a href="#l30.212"></a><span id="l30.212"> </span>
<a href="#l30.213"></a><span id="l30.213">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr =</span>
<a href="#l30.214"></a><span id="l30.214">            do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l30.215"></a><span id="l30.215">     if (NS_FAILED(rv)) {</span>
<a href="#l30.216"></a><span id="l30.216" class="difflineminus">-    IMPORT_LOG0( &quot;*** Failed to create a account manager!\n&quot;);</span>
<a href="#l30.217"></a><span id="l30.217" class="difflineminus">-    ::RegCloseKey( hKey);</span>
<a href="#l30.218"></a><span id="l30.218" class="difflineminus">-    return( false);</span>
<a href="#l30.219"></a><span id="l30.219" class="difflineplus">+    IMPORT_LOG0(&quot;*** Failed to create a account manager!\n&quot;);</span>
<a href="#l30.220"></a><span id="l30.220" class="difflineplus">+    ::RegCloseKey(hKey);</span>
<a href="#l30.221"></a><span id="l30.221" class="difflineplus">+    return false;</span>
<a href="#l30.222"></a><span id="l30.222">   }</span>
<a href="#l30.223"></a><span id="l30.223"> </span>
<a href="#l30.224"></a><span id="l30.224">   HKEY    subKey;</span>
<a href="#l30.225"></a><span id="l30.225">   nsCString  defMailName;</span>
<a href="#l30.226"></a><span id="l30.226">   // OE has default mail account here when it has been</span>
<a href="#l30.227"></a><span id="l30.227">   // set up by transfer or has multiple identities</span>
<a href="#l30.228"></a><span id="l30.228">   // look below for orig code that looked in new OE installs</span>
<a href="#l30.229"></a><span id="l30.229">   if (::RegOpenKeyEx(HKEY_CURRENT_USER, &quot;Identities&quot;, 0,</span>
<a href="#l30.230"></a><span id="l30.230">                      KEY_QUERY_VALUE, &amp;subKey) == ERROR_SUCCESS) {</span>
<a href="#l30.231"></a><span id="l30.231">     BYTE *  pBytes = nsOERegUtil::GetValueBytes(subKey, &quot;Default User ID&quot;);</span>
<a href="#l30.232"></a><span id="l30.232" class="difflineminus">-    ::RegCloseKey( subKey);</span>
<a href="#l30.233"></a><span id="l30.233" class="difflineplus">+    ::RegCloseKey(subKey);</span>
<a href="#l30.234"></a><span id="l30.234">     if (pBytes) {</span>
<a href="#l30.235"></a><span id="l30.235" class="difflineminus">-      nsCString  key( &quot;Identities\\&quot;);</span>
<a href="#l30.236"></a><span id="l30.236" class="difflineplus">+      nsCString  key(&quot;Identities\\&quot;);</span>
<a href="#l30.237"></a><span id="l30.237">       key += (const char *)pBytes;</span>
<a href="#l30.238"></a><span id="l30.238" class="difflineminus">-      nsOERegUtil::FreeValueBytes( pBytes);</span>
<a href="#l30.239"></a><span id="l30.239" class="difflineplus">+      nsOERegUtil::FreeValueBytes(pBytes);</span>
<a href="#l30.240"></a><span id="l30.240">       key += &quot;\\Software\\Microsoft\\Internet Account Manager&quot;;</span>
<a href="#l30.241"></a><span id="l30.241">       if (::RegOpenKeyEx(HKEY_CURRENT_USER, key.get(), 0,</span>
<a href="#l30.242"></a><span id="l30.242">                          KEY_QUERY_VALUE , &amp;subKey) == ERROR_SUCCESS) {</span>
<a href="#l30.243"></a><span id="l30.243">         BYTE * pBytes = nsOERegUtil::GetValueBytes(subKey,</span>
<a href="#l30.244"></a><span id="l30.244">                                                    &quot;Default Mail Account&quot;);</span>
<a href="#l30.245"></a><span id="l30.245" class="difflineminus">-        ::RegCloseKey( subKey);</span>
<a href="#l30.246"></a><span id="l30.246" class="difflineplus">+        ::RegCloseKey(subKey);</span>
<a href="#l30.247"></a><span id="l30.247">         if (pBytes) {</span>
<a href="#l30.248"></a><span id="l30.248">           defMailName = (const char *)pBytes;</span>
<a href="#l30.249"></a><span id="l30.249" class="difflineminus">-          nsOERegUtil::FreeValueBytes( pBytes);</span>
<a href="#l30.250"></a><span id="l30.250" class="difflineplus">+          nsOERegUtil::FreeValueBytes(pBytes);</span>
<a href="#l30.251"></a><span id="l30.251">         }</span>
<a href="#l30.252"></a><span id="l30.252">       }</span>
<a href="#l30.253"></a><span id="l30.253">     }</span>
<a href="#l30.254"></a><span id="l30.254">   }</span>
<a href="#l30.255"></a><span id="l30.255"> </span>
<a href="#l30.256"></a><span id="l30.256">   // else it must be here in original install location from orig code</span>
<a href="#l30.257"></a><span id="l30.257">   if (defMailName.IsEmpty()) {</span>
<a href="#l30.258"></a><span id="l30.258">     if (::RegOpenKeyEx(HKEY_CURRENT_USER,</span>
<a href="#l30.259"></a><span id="l30.259">                        &quot;Software\\Microsoft\\Outlook Express&quot;,  0,</span>
<a href="#l30.260"></a><span id="l30.260">                        KEY_QUERY_VALUE, &amp;subKey) == ERROR_SUCCESS) {</span>
<a href="#l30.261"></a><span id="l30.261">       BYTE *  pBytes = nsOERegUtil::GetValueBytes(subKey,</span>
<a href="#l30.262"></a><span id="l30.262">                                                   &quot;Default Mail Account&quot;);</span>
<a href="#l30.263"></a><span id="l30.263" class="difflineminus">-      ::RegCloseKey( subKey);</span>
<a href="#l30.264"></a><span id="l30.264" class="difflineplus">+      ::RegCloseKey(subKey);</span>
<a href="#l30.265"></a><span id="l30.265">       if (pBytes) {</span>
<a href="#l30.266"></a><span id="l30.266">         defMailName = (const char *)pBytes;</span>
<a href="#l30.267"></a><span id="l30.267" class="difflineminus">-        nsOERegUtil::FreeValueBytes( pBytes);</span>
<a href="#l30.268"></a><span id="l30.268" class="difflineplus">+        nsOERegUtil::FreeValueBytes(pBytes);</span>
<a href="#l30.269"></a><span id="l30.269">       }</span>
<a href="#l30.270"></a><span id="l30.270">     }</span>
<a href="#l30.271"></a><span id="l30.271">   }</span>
<a href="#l30.272"></a><span id="l30.272">   // else defmailname will be &quot;&quot;.  No big deal.</span>
<a href="#l30.273"></a><span id="l30.273"> </span>
<a href="#l30.274"></a><span id="l30.274">   // 'poll for messages' setting in OE is a global setting</span>
<a href="#l30.275"></a><span id="l30.275">   // in OE options general tab and in following global OE</span>
<a href="#l30.276"></a><span id="l30.276">   // registry location.</span>
<a href="#l30.277"></a><span id="l30.277">   // for all accounts poll interval is a 32 bit value, 0 for</span>
<a href="#l30.278"></a><span id="l30.278">   // &quot;don't poll&quot;, else milliseconds</span>
<a href="#l30.279"></a><span id="l30.279">   HKEY    subSubKey;</span>
<a href="#l30.280"></a><span id="l30.280"> </span>
<a href="#l30.281"></a><span id="l30.281">   subKey = Find50Key();</span>
<a href="#l30.282"></a><span id="l30.282" class="difflineminus">-  if (!subKey )</span>
<a href="#l30.283"></a><span id="l30.283" class="difflineplus">+  if (!subKey)</span>
<a href="#l30.284"></a><span id="l30.284">     subKey = Find40Key();</span>
<a href="#l30.285"></a><span id="l30.285">   // above key not critical</span>
<a href="#l30.286"></a><span id="l30.286"> </span>
<a href="#l30.287"></a><span id="l30.287">   checkNewMailTime = 30;</span>
<a href="#l30.288"></a><span id="l30.288">   checkNewMail = false;</span>
<a href="#l30.289"></a><span id="l30.289">   if (subKey){</span>
<a href="#l30.290"></a><span id="l30.290">     if (::RegOpenKeyEx(subKey, &quot;Mail&quot;, 0, KEY_QUERY_VALUE,</span>
<a href="#l30.291"></a><span id="l30.291">                        &amp;subSubKey) == ERROR_SUCCESS) {</span>
<a href="#l30.292"></a><span id="l30.292" class="difflineminus">-      ::RegCloseKey( subKey);</span>
<a href="#l30.293"></a><span id="l30.293" class="difflineminus">-      BYTE *  pBytes = nsOERegUtil::GetValueBytes( subSubKey, &quot;Poll For Mail&quot;);</span>
<a href="#l30.294"></a><span id="l30.294" class="difflineminus">-      ::RegCloseKey( subSubKey);</span>
<a href="#l30.295"></a><span id="l30.295" class="difflineplus">+      ::RegCloseKey(subKey);</span>
<a href="#l30.296"></a><span id="l30.296" class="difflineplus">+      BYTE *  pBytes = nsOERegUtil::GetValueBytes(subSubKey, &quot;Poll For Mail&quot;);</span>
<a href="#l30.297"></a><span id="l30.297" class="difflineplus">+      ::RegCloseKey(subSubKey);</span>
<a href="#l30.298"></a><span id="l30.298">       if (pBytes) {</span>
<a href="#l30.299"></a><span id="l30.299">         if (*(PRInt32 *)pBytes != -1){</span>
<a href="#l30.300"></a><span id="l30.300">           checkNewMail = true;</span>
<a href="#l30.301"></a><span id="l30.301">           checkNewMailTime = *(PRInt32 *)pBytes / 60000;</span>
<a href="#l30.302"></a><span id="l30.302">         }</span>
<a href="#l30.303"></a><span id="l30.303" class="difflineminus">-        nsOERegUtil::FreeValueBytes( pBytes);</span>
<a href="#l30.304"></a><span id="l30.304" class="difflineplus">+        nsOERegUtil::FreeValueBytes(pBytes);</span>
<a href="#l30.305"></a><span id="l30.305">       }</span>
<a href="#l30.306"></a><span id="l30.306">     }</span>
<a href="#l30.307"></a><span id="l30.307">   }</span>
<a href="#l30.308"></a><span id="l30.308"> </span>
<a href="#l30.309"></a><span id="l30.309">   // Iterate the accounts looking for POP3 &amp; IMAP accounts...</span>
<a href="#l30.310"></a><span id="l30.310">   // Ignore LDAP for now!</span>
<a href="#l30.311"></a><span id="l30.311">   DWORD      index = 0;</span>
<a href="#l30.312"></a><span id="l30.312">   DWORD      numChars;</span>
<a href="#l30.313"></a><span id="l30.313">   TCHAR      keyName[256];</span>
<a href="#l30.314"></a><span id="l30.314">   LONG       result = ERROR_SUCCESS;</span>
<a href="#l30.315"></a><span id="l30.315">   BYTE *     pBytes;</span>
<a href="#l30.316"></a><span id="l30.316">   int        accounts = 0;</span>
<a href="#l30.317"></a><span id="l30.317">   nsCString  keyComp;</span>
<a href="#l30.318"></a><span id="l30.318"> </span>
<a href="#l30.319"></a><span id="l30.319">   while (result == ERROR_SUCCESS) {</span>
<a href="#l30.320"></a><span id="l30.320">     numChars = 256;</span>
<a href="#l30.321"></a><span id="l30.321" class="difflineminus">-    result = ::RegEnumKeyEx( hKey, index, keyName, &amp;numChars, NULL, NULL, NULL, NULL);</span>
<a href="#l30.322"></a><span id="l30.322" class="difflineplus">+    result = ::RegEnumKeyEx(hKey, index, keyName, &amp;numChars, NULL, NULL, NULL, NULL);</span>
<a href="#l30.323"></a><span id="l30.323">     index++;</span>
<a href="#l30.324"></a><span id="l30.324">     if (result == ERROR_SUCCESS) {</span>
<a href="#l30.325"></a><span id="l30.325" class="difflineminus">-      if (::RegOpenKeyEx( hKey, keyName, 0, KEY_QUERY_VALUE, &amp;subKey) == ERROR_SUCCESS) {</span>
<a href="#l30.326"></a><span id="l30.326" class="difflineplus">+      if (::RegOpenKeyEx(hKey, keyName, 0, KEY_QUERY_VALUE, &amp;subKey) == ERROR_SUCCESS) {</span>
<a href="#l30.327"></a><span id="l30.327">         // Get the values for this account.</span>
<a href="#l30.328"></a><span id="l30.328" class="difflineminus">-        IMPORT_LOG1( &quot;Opened Outlook Express account: %s\n&quot;, (char *)keyName);</span>
<a href="#l30.329"></a><span id="l30.329" class="difflineplus">+        IMPORT_LOG1(&quot;Opened Outlook Express account: %s\n&quot;, (char *)keyName);</span>
<a href="#l30.330"></a><span id="l30.330"> </span>
<a href="#l30.331"></a><span id="l30.331">         nsIMsgAccount  *anAccount = nsnull;</span>
<a href="#l30.332"></a><span id="l30.332" class="difflineminus">-        pBytes = nsOERegUtil::GetValueBytes( subKey, &quot;IMAP Server&quot;);</span>
<a href="#l30.333"></a><span id="l30.333" class="difflineplus">+        pBytes = nsOERegUtil::GetValueBytes(subKey, &quot;IMAP Server&quot;);</span>
<a href="#l30.334"></a><span id="l30.334">         if (pBytes) {</span>
<a href="#l30.335"></a><span id="l30.335" class="difflineminus">-          if (DoIMAPServer( accMgr, subKey, (char *)pBytes, &amp;anAccount))</span>
<a href="#l30.336"></a><span id="l30.336" class="difflineplus">+          if (DoIMAPServer(accMgr, subKey, (char *)pBytes, &amp;anAccount))</span>
<a href="#l30.337"></a><span id="l30.337">             accounts++;</span>
<a href="#l30.338"></a><span id="l30.338" class="difflineminus">-          nsOERegUtil::FreeValueBytes( pBytes);</span>
<a href="#l30.339"></a><span id="l30.339" class="difflineplus">+          nsOERegUtil::FreeValueBytes(pBytes);</span>
<a href="#l30.340"></a><span id="l30.340">         }</span>
<a href="#l30.341"></a><span id="l30.341"> </span>
<a href="#l30.342"></a><span id="l30.342" class="difflineminus">-        pBytes = nsOERegUtil::GetValueBytes( subKey, &quot;NNTP Server&quot;);</span>
<a href="#l30.343"></a><span id="l30.343" class="difflineplus">+        pBytes = nsOERegUtil::GetValueBytes(subKey, &quot;NNTP Server&quot;);</span>
<a href="#l30.344"></a><span id="l30.344">         if (pBytes) {</span>
<a href="#l30.345"></a><span id="l30.345" class="difflineminus">-          if (DoNNTPServer( accMgr, subKey, (char *)pBytes, &amp;anAccount))</span>
<a href="#l30.346"></a><span id="l30.346" class="difflineplus">+          if (DoNNTPServer(accMgr, subKey, (char *)pBytes, &amp;anAccount))</span>
<a href="#l30.347"></a><span id="l30.347">             accounts++;</span>
<a href="#l30.348"></a><span id="l30.348" class="difflineminus">-          nsOERegUtil::FreeValueBytes( pBytes);</span>
<a href="#l30.349"></a><span id="l30.349" class="difflineplus">+          nsOERegUtil::FreeValueBytes(pBytes);</span>
<a href="#l30.350"></a><span id="l30.350">         }</span>
<a href="#l30.351"></a><span id="l30.351"> </span>
<a href="#l30.352"></a><span id="l30.352" class="difflineminus">-        pBytes = nsOERegUtil::GetValueBytes( subKey, &quot;POP3 Server&quot;);</span>
<a href="#l30.353"></a><span id="l30.353" class="difflineplus">+        pBytes = nsOERegUtil::GetValueBytes(subKey, &quot;POP3 Server&quot;);</span>
<a href="#l30.354"></a><span id="l30.354">         if (pBytes) {</span>
<a href="#l30.355"></a><span id="l30.355" class="difflineminus">-            if (DoPOP3Server( accMgr, subKey, (char *)pBytes, &amp;anAccount)) {</span>
<a href="#l30.356"></a><span id="l30.356" class="difflineplus">+            if (DoPOP3Server(accMgr, subKey, (char *)pBytes, &amp;anAccount)) {</span>
<a href="#l30.357"></a><span id="l30.357">               accounts++;</span>
<a href="#l30.358"></a><span id="l30.358">           }</span>
<a href="#l30.359"></a><span id="l30.359" class="difflineminus">-          nsOERegUtil::FreeValueBytes( pBytes);</span>
<a href="#l30.360"></a><span id="l30.360" class="difflineplus">+          nsOERegUtil::FreeValueBytes(pBytes);</span>
<a href="#l30.361"></a><span id="l30.361">         }</span>
<a href="#l30.362"></a><span id="l30.362"> </span>
<a href="#l30.363"></a><span id="l30.363">         if (anAccount) {</span>
<a href="#l30.364"></a><span id="l30.364">           // Is this the default account?</span>
<a href="#l30.365"></a><span id="l30.365">           keyComp = keyName;</span>
<a href="#l30.366"></a><span id="l30.366" class="difflineminus">-          if (keyComp.Equals( defMailName)) {</span>
<a href="#l30.367"></a><span id="l30.367" class="difflineminus">-            accMgr-&gt;SetDefaultAccount( anAccount);</span>
<a href="#l30.368"></a><span id="l30.368" class="difflineplus">+          if (keyComp.Equals(defMailName)) {</span>
<a href="#l30.369"></a><span id="l30.369" class="difflineplus">+            accMgr-&gt;SetDefaultAccount(anAccount);</span>
<a href="#l30.370"></a><span id="l30.370">           }</span>
<a href="#l30.371"></a><span id="l30.371" class="difflineminus">-          NS_RELEASE( anAccount);</span>
<a href="#l30.372"></a><span id="l30.372" class="difflineplus">+          NS_RELEASE(anAccount);</span>
<a href="#l30.373"></a><span id="l30.373">         }</span>
<a href="#l30.374"></a><span id="l30.374"> </span>
<a href="#l30.375"></a><span id="l30.375" class="difflineminus">-        ::RegCloseKey( subKey);</span>
<a href="#l30.376"></a><span id="l30.376" class="difflineplus">+        ::RegCloseKey(subKey);</span>
<a href="#l30.377"></a><span id="l30.377">       }</span>
<a href="#l30.378"></a><span id="l30.378">     }</span>
<a href="#l30.379"></a><span id="l30.379">   }</span>
<a href="#l30.380"></a><span id="l30.380" class="difflineminus">-  ::RegCloseKey( hKey);</span>
<a href="#l30.381"></a><span id="l30.381" class="difflineplus">+  ::RegCloseKey(hKey);</span>
<a href="#l30.382"></a><span id="l30.382"> </span>
<a href="#l30.383"></a><span id="l30.383">   // Now save the new acct info to pref file.</span>
<a href="#l30.384"></a><span id="l30.384">   rv = accMgr-&gt;SaveAccountInfo();</span>
<a href="#l30.385"></a><span id="l30.385">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Can't save account info to pref file&quot;);</span>
<a href="#l30.386"></a><span id="l30.386"> </span>
<a href="#l30.387"></a><span id="l30.387" class="difflineminus">-  return( accounts != 0);</span>
<a href="#l30.388"></a><span id="l30.388" class="difflineplus">+  return accounts != 0;</span>
<a href="#l30.389"></a><span id="l30.389"> }</span>
<a href="#l30.390"></a><span id="l30.390"> </span>
<a href="#l30.391"></a><span id="l30.391"> nsresult OESettings::GetAccountName(HKEY hKey, char *defaultName, nsString &amp;acctName)</span>
<a href="#l30.392"></a><span id="l30.392"> {</span>
<a href="#l30.393"></a><span id="l30.393" class="difflineminus">-  BYTE *pAccName = nsOERegUtil::GetValueBytes( hKey, &quot;Account Name&quot;);</span>
<a href="#l30.394"></a><span id="l30.394" class="difflineplus">+  BYTE *pAccName = nsOERegUtil::GetValueBytes(hKey, &quot;Account Name&quot;);</span>
<a href="#l30.395"></a><span id="l30.395">   nsresult rv = NS_OK;</span>
<a href="#l30.396"></a><span id="l30.396">   if (pAccName) {</span>
<a href="#l30.397"></a><span id="l30.397">     rv = nsMsgI18NConvertToUnicode(nsMsgI18NFileSystemCharset(),</span>
<a href="#l30.398"></a><span id="l30.398">                                    nsDependentCString((const char *)pAccName), acctName);</span>
<a href="#l30.399"></a><span id="l30.399" class="difflineminus">-    nsOERegUtil::FreeValueBytes( pAccName);</span>
<a href="#l30.400"></a><span id="l30.400" class="difflineplus">+    nsOERegUtil::FreeValueBytes(pAccName);</span>
<a href="#l30.401"></a><span id="l30.401">   }</span>
<a href="#l30.402"></a><span id="l30.402">   else</span>
<a href="#l30.403"></a><span id="l30.403">     acctName.AssignASCII(defaultName);</span>
<a href="#l30.404"></a><span id="l30.404">   return rv;</span>
<a href="#l30.405"></a><span id="l30.405"> }</span>
<a href="#l30.406"></a><span id="l30.406"> </span>
<a href="#l30.407"></a><span id="l30.407" class="difflineminus">-bool OESettings::DoIMAPServer( nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount)</span>
<a href="#l30.408"></a><span id="l30.408" class="difflineplus">+bool OESettings::DoIMAPServer(nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount)</span>
<a href="#l30.409"></a><span id="l30.409"> {</span>
<a href="#l30.410"></a><span id="l30.410">   PRInt32 authMethod;</span>
<a href="#l30.411"></a><span id="l30.411">   if (ppAccount)</span>
<a href="#l30.412"></a><span id="l30.412">     *ppAccount = nsnull;</span>
<a href="#l30.413"></a><span id="l30.413"> </span>
<a href="#l30.414"></a><span id="l30.414">   char * pUserName;</span>
<a href="#l30.415"></a><span id="l30.415">   pUserName = (char *)nsOERegUtil::GetValueBytes(hKey, &quot;IMAP User Name&quot;);</span>
<a href="#l30.416"></a><span id="l30.416">   if (!pUserName)</span>
<a href="#l30.417"></a><span id="l30.417" class="difflineminus">-    return( false);</span>
<a href="#l30.418"></a><span id="l30.418" class="difflineplus">+    return false;</span>
<a href="#l30.419"></a><span id="l30.419"> </span>
<a href="#l30.420"></a><span id="l30.420">   bool result = false;</span>
<a href="#l30.421"></a><span id="l30.421"> </span>
<a href="#l30.422"></a><span id="l30.422">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l30.423"></a><span id="l30.423">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l30.424"></a><span id="l30.424">   nsresult rv = pMgr-&gt;FindServer(nsDependentCString(pUserName),</span>
<a href="#l30.425"></a><span id="l30.425">                                  nsDependentCString(pServerName),</span>
<a href="#l30.426"></a><span id="l30.426">                                  NS_LITERAL_CSTRING(&quot;imap&quot;),</span>
<a href="#l30.427"></a><span id="l30.427">                                  getter_AddRefs(in));</span>
<a href="#l30.428"></a><span id="l30.428" class="difflineminus">-  if (NS_FAILED( rv) || (in == nsnull)) {</span>
<a href="#l30.429"></a><span id="l30.429" class="difflineplus">+  if (NS_FAILED(rv) || (in == nsnull)) {</span>
<a href="#l30.430"></a><span id="l30.430">     // Create the incoming server and an account for it?</span>
<a href="#l30.431"></a><span id="l30.431">     rv = pMgr-&gt;CreateIncomingServer(nsDependentCString(pUserName),</span>
<a href="#l30.432"></a><span id="l30.432">                                     nsDependentCString(pServerName),</span>
<a href="#l30.433"></a><span id="l30.433">                                     NS_LITERAL_CSTRING(&quot;imap&quot;),</span>
<a href="#l30.434"></a><span id="l30.434">                                     getter_AddRefs(in));</span>
<a href="#l30.435"></a><span id="l30.435" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; in) {</span>
<a href="#l30.436"></a><span id="l30.436" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l30.437"></a><span id="l30.437">       BYTE * pRootFolder = nsOERegUtil::GetValueBytes(hKey, &quot;IMAP Root Folder&quot;);</span>
<a href="#l30.438"></a><span id="l30.438">       if (pRootFolder)</span>
<a href="#l30.439"></a><span id="l30.439">       {</span>
<a href="#l30.440"></a><span id="l30.440">         nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(in);</span>
<a href="#l30.441"></a><span id="l30.441">         imapServer-&gt;SetServerDirectory(nsDependentCString((const char *) pRootFolder));</span>
<a href="#l30.442"></a><span id="l30.442">         nsOERegUtil::FreeValueBytes(pRootFolder);</span>
<a href="#l30.443"></a><span id="l30.443">       }</span>
<a href="#l30.444"></a><span id="l30.444"> </span>
<a href="#l30.445"></a><span id="l30.445" class="difflineat">@@ -469,94 +470,94 @@ bool OESettings::DoIMAPServer( nsIMsgAcc</span>
<a href="#l30.446"></a><span id="l30.446">                    pServerName, pUserName);</span>
<a href="#l30.447"></a><span id="l30.447"> </span>
<a href="#l30.448"></a><span id="l30.448">       nsString prettyName;</span>
<a href="#l30.449"></a><span id="l30.449">       if (NS_SUCCEEDED(GetAccountName(hKey, pServerName, prettyName)))</span>
<a href="#l30.450"></a><span id="l30.450">         rv = in-&gt;SetPrettyName(prettyName);</span>
<a href="#l30.451"></a><span id="l30.451"> </span>
<a href="#l30.452"></a><span id="l30.452">       // We have a server, create an account.</span>
<a href="#l30.453"></a><span id="l30.453">       nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l30.454"></a><span id="l30.454" class="difflineminus">-      rv = pMgr-&gt;CreateAccount(getter_AddRefs( account));</span>
<a href="#l30.455"></a><span id="l30.455" class="difflineminus">-      if (NS_SUCCEEDED( rv) &amp;&amp; account) {</span>
<a href="#l30.456"></a><span id="l30.456" class="difflineplus">+      rv = pMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l30.457"></a><span id="l30.457" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l30.458"></a><span id="l30.458">         rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l30.459"></a><span id="l30.459"> </span>
<a href="#l30.460"></a><span id="l30.460">         IMPORT_LOG0(&quot;Created an account and set the IMAP server as the incoming server\n&quot;);</span>
<a href="#l30.461"></a><span id="l30.461"> </span>
<a href="#l30.462"></a><span id="l30.462">         // Fiddle with the identities</span>
<a href="#l30.463"></a><span id="l30.463">         SetIdentities(pMgr, account, hKey, pUserName, authMethod, false);</span>
<a href="#l30.464"></a><span id="l30.464">         result = true;</span>
<a href="#l30.465"></a><span id="l30.465">         if (ppAccount)</span>
<a href="#l30.466"></a><span id="l30.466">           account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l30.467"></a><span id="l30.467">       }</span>
<a href="#l30.468"></a><span id="l30.468">     }</span>
<a href="#l30.469"></a><span id="l30.469">   }</span>
<a href="#l30.470"></a><span id="l30.470">   else if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l30.471"></a><span id="l30.471">     // for an existing server we create another identity,</span>
<a href="#l30.472"></a><span id="l30.472">     //  TB lists under 'manage identities'</span>
<a href="#l30.473"></a><span id="l30.473">     nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l30.474"></a><span id="l30.474" class="difflineminus">-    rv = pMgr-&gt;FindAccountForServer(in, getter_AddRefs( account));</span>
<a href="#l30.475"></a><span id="l30.475" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; account) {</span>
<a href="#l30.476"></a><span id="l30.476" class="difflineplus">+    rv = pMgr-&gt;FindAccountForServer(in, getter_AddRefs(account));</span>
<a href="#l30.477"></a><span id="l30.477" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l30.478"></a><span id="l30.478">       IMPORT_LOG0(&quot;Created an identity and added to existing IMAP incoming server\n&quot;);</span>
<a href="#l30.479"></a><span id="l30.479">       // Fiddle with the identities</span>
<a href="#l30.480"></a><span id="l30.480">       in-&gt;GetAuthMethod(&amp;authMethod);</span>
<a href="#l30.481"></a><span id="l30.481">       SetIdentities(pMgr, account, hKey, pUserName, authMethod, false);</span>
<a href="#l30.482"></a><span id="l30.482">       result = true;</span>
<a href="#l30.483"></a><span id="l30.483">       if (ppAccount)</span>
<a href="#l30.484"></a><span id="l30.484">         account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount),</span>
<a href="#l30.485"></a><span id="l30.485">                                  (void **)ppAccount);</span>
<a href="#l30.486"></a><span id="l30.486">     }</span>
<a href="#l30.487"></a><span id="l30.487">   }</span>
<a href="#l30.488"></a><span id="l30.488">   else</span>
<a href="#l30.489"></a><span id="l30.489">     result = true;</span>
<a href="#l30.490"></a><span id="l30.490">   nsOERegUtil::FreeValueBytes((BYTE *) pUserName);</span>
<a href="#l30.491"></a><span id="l30.491" class="difflineminus">-  return( result);</span>
<a href="#l30.492"></a><span id="l30.492" class="difflineplus">+  return result;</span>
<a href="#l30.493"></a><span id="l30.493"> }</span>
<a href="#l30.494"></a><span id="l30.494"> </span>
<a href="#l30.495"></a><span id="l30.495" class="difflineminus">-bool OESettings::DoPOP3Server( nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount)</span>
<a href="#l30.496"></a><span id="l30.496" class="difflineplus">+bool OESettings::DoPOP3Server(nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount)</span>
<a href="#l30.497"></a><span id="l30.497"> {</span>
<a href="#l30.498"></a><span id="l30.498">   PRInt32 authMethod;    // Secure Password Authentication</span>
<a href="#l30.499"></a><span id="l30.499">   if (ppAccount)</span>
<a href="#l30.500"></a><span id="l30.500">     *ppAccount = nsnull;</span>
<a href="#l30.501"></a><span id="l30.501"> </span>
<a href="#l30.502"></a><span id="l30.502">   char * pUserName;</span>
<a href="#l30.503"></a><span id="l30.503" class="difflineminus">-  pUserName = (char *)nsOERegUtil::GetValueBytes( hKey, &quot;POP3 User Name&quot;);</span>
<a href="#l30.504"></a><span id="l30.504" class="difflineplus">+  pUserName = (char *)nsOERegUtil::GetValueBytes(hKey, &quot;POP3 User Name&quot;);</span>
<a href="#l30.505"></a><span id="l30.505">   if (!pUserName)</span>
<a href="#l30.506"></a><span id="l30.506" class="difflineminus">-    return( false);</span>
<a href="#l30.507"></a><span id="l30.507" class="difflineplus">+    return false;</span>
<a href="#l30.508"></a><span id="l30.508"> </span>
<a href="#l30.509"></a><span id="l30.509">   bool result = false;</span>
<a href="#l30.510"></a><span id="l30.510"> </span>
<a href="#l30.511"></a><span id="l30.511">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l30.512"></a><span id="l30.512">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l30.513"></a><span id="l30.513">   nsresult rv = pMgr-&gt;FindServer(nsDependentCString(pUserName),</span>
<a href="#l30.514"></a><span id="l30.514">                                  nsDependentCString(pServerName),</span>
<a href="#l30.515"></a><span id="l30.515">                                  NS_LITERAL_CSTRING(&quot;pop3&quot;),</span>
<a href="#l30.516"></a><span id="l30.516" class="difflineminus">-                                 getter_AddRefs( in));</span>
<a href="#l30.517"></a><span id="l30.517" class="difflineminus">-  if (NS_FAILED( rv) || (in == nsnull)) {</span>
<a href="#l30.518"></a><span id="l30.518" class="difflineplus">+                                 getter_AddRefs(in));</span>
<a href="#l30.519"></a><span id="l30.519" class="difflineplus">+  if (NS_FAILED(rv) || (in == nsnull)) {</span>
<a href="#l30.520"></a><span id="l30.520">     // Create the incoming server and an account for it?</span>
<a href="#l30.521"></a><span id="l30.521">     rv = pMgr-&gt;CreateIncomingServer(nsDependentCString(pUserName),</span>
<a href="#l30.522"></a><span id="l30.522">                                     nsDependentCString(pServerName),</span>
<a href="#l30.523"></a><span id="l30.523">                                     NS_LITERAL_CSTRING(&quot;pop3&quot;),</span>
<a href="#l30.524"></a><span id="l30.524" class="difflineminus">-                                    getter_AddRefs( in));</span>
<a href="#l30.525"></a><span id="l30.525" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; in) {</span>
<a href="#l30.526"></a><span id="l30.526" class="difflineminus">-      BYTE * pSecureConnection = nsOERegUtil::GetValueBytes( hKey, &quot;POP3 Secure Connection&quot;);</span>
<a href="#l30.527"></a><span id="l30.527" class="difflineplus">+                                    getter_AddRefs(in));</span>
<a href="#l30.528"></a><span id="l30.528" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l30.529"></a><span id="l30.529" class="difflineplus">+      BYTE * pSecureConnection = nsOERegUtil::GetValueBytes(hKey, &quot;POP3 Secure Connection&quot;);</span>
<a href="#l30.530"></a><span id="l30.530">       if (pSecureConnection)</span>
<a href="#l30.531"></a><span id="l30.531">       {</span>
<a href="#l30.532"></a><span id="l30.532">         if (*pSecureConnection)</span>
<a href="#l30.533"></a><span id="l30.533">           in-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l30.534"></a><span id="l30.534">         nsOERegUtil::FreeValueBytes(pSecureConnection);</span>
<a href="#l30.535"></a><span id="l30.535">       }</span>
<a href="#l30.536"></a><span id="l30.536"> </span>
<a href="#l30.537"></a><span id="l30.537" class="difflineminus">-      BYTE * pPort = nsOERegUtil::GetValueBytes( hKey, &quot;POP3 Port&quot;);</span>
<a href="#l30.538"></a><span id="l30.538" class="difflineplus">+      BYTE * pPort = nsOERegUtil::GetValueBytes(hKey, &quot;POP3 Port&quot;);</span>
<a href="#l30.539"></a><span id="l30.539">       if (pPort)</span>
<a href="#l30.540"></a><span id="l30.540">       {</span>
<a href="#l30.541"></a><span id="l30.541">         in-&gt;SetPort(*(PRInt32 *) pPort);</span>
<a href="#l30.542"></a><span id="l30.542">         nsOERegUtil::FreeValueBytes(pPort);</span>
<a href="#l30.543"></a><span id="l30.543">       }</span>
<a href="#l30.544"></a><span id="l30.544"> </span>
<a href="#l30.545"></a><span id="l30.545" class="difflineminus">-      BYTE * pBytesTemp = nsOERegUtil::GetValueBytes( hKey, &quot;POP3 Use Sicily&quot;);</span>
<a href="#l30.546"></a><span id="l30.546" class="difflineplus">+      BYTE * pBytesTemp = nsOERegUtil::GetValueBytes(hKey, &quot;POP3 Use Sicily&quot;);</span>
<a href="#l30.547"></a><span id="l30.547">       if (pBytesTemp)</span>
<a href="#l30.548"></a><span id="l30.548">       {</span>
<a href="#l30.549"></a><span id="l30.549">         bool secAuth = *(bool *)pBytesTemp;</span>
<a href="#l30.550"></a><span id="l30.550">         nsOERegUtil::FreeValueBytes(pBytesTemp);</span>
<a href="#l30.551"></a><span id="l30.551">         authMethod = secAuth ? nsMsgAuthMethod::secure</span>
<a href="#l30.552"></a><span id="l30.552">             : nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l30.553"></a><span id="l30.553">       }</span>
<a href="#l30.554"></a><span id="l30.554">       else {</span>
<a href="#l30.555"></a><span id="l30.555" class="difflineat">@@ -620,30 +621,30 @@ bool OESettings::DoPOP3Server( nsIMsgAcc</span>
<a href="#l30.556"></a><span id="l30.556">         if (pBytesTemp)</span>
<a href="#l30.557"></a><span id="l30.557">         {</span>
<a href="#l30.558"></a><span id="l30.558">           pop3Server-&gt;SetDeleteByAgeFromServer(*pBytesTemp == 1);</span>
<a href="#l30.559"></a><span id="l30.559">           nsOERegUtil::FreeValueBytes(pBytesTemp);</span>
<a href="#l30.560"></a><span id="l30.560">         }</span>
<a href="#l30.561"></a><span id="l30.561">         pBytesTemp = nsOERegUtil::GetValueBytes(hKey, &quot;Expire Days&quot;);</span>
<a href="#l30.562"></a><span id="l30.562">         if (pBytesTemp)</span>
<a href="#l30.563"></a><span id="l30.563">         {</span>
<a href="#l30.564"></a><span id="l30.564" class="difflineminus">-          pop3Server-&gt;SetNumDaysToLeaveOnServer(*(PRInt32*)pBytesTemp );</span>
<a href="#l30.565"></a><span id="l30.565" class="difflineplus">+          pop3Server-&gt;SetNumDaysToLeaveOnServer(*(PRInt32*)pBytesTemp);</span>
<a href="#l30.566"></a><span id="l30.566">           nsOERegUtil::FreeValueBytes(pBytesTemp);</span>
<a href="#l30.567"></a><span id="l30.567">         }</span>
<a href="#l30.568"></a><span id="l30.568">       }</span>
<a href="#l30.569"></a><span id="l30.569">       IMPORT_LOG2(&quot;Created POP3 server named: %s, userName: %s\n&quot;,</span>
<a href="#l30.570"></a><span id="l30.570">                    pServerName, pUserName);</span>
<a href="#l30.571"></a><span id="l30.571">       nsString prettyName;</span>
<a href="#l30.572"></a><span id="l30.572">       if (NS_SUCCEEDED(GetAccountName(hKey, pServerName, prettyName)))</span>
<a href="#l30.573"></a><span id="l30.573" class="difflineminus">-        rv = in-&gt;SetPrettyName( prettyName);</span>
<a href="#l30.574"></a><span id="l30.574" class="difflineplus">+        rv = in-&gt;SetPrettyName(prettyName);</span>
<a href="#l30.575"></a><span id="l30.575"> </span>
<a href="#l30.576"></a><span id="l30.576">       // We have a server, create an account.</span>
<a href="#l30.577"></a><span id="l30.577">       nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l30.578"></a><span id="l30.578" class="difflineminus">-      rv = pMgr-&gt;CreateAccount(getter_AddRefs( account));</span>
<a href="#l30.579"></a><span id="l30.579" class="difflineminus">-      if (NS_SUCCEEDED( rv) &amp;&amp; account) {</span>
<a href="#l30.580"></a><span id="l30.580" class="difflineplus">+      rv = pMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l30.581"></a><span id="l30.581" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l30.582"></a><span id="l30.582">         rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l30.583"></a><span id="l30.583">         IMPORT_LOG0(&quot;Created a new account and set the incoming server to the POP3 server.\n&quot;);</span>
<a href="#l30.584"></a><span id="l30.584"> </span>
<a href="#l30.585"></a><span id="l30.585">         // Fiddle with the identities</span>
<a href="#l30.586"></a><span id="l30.586">         SetIdentities(pMgr, account, hKey, pUserName, authMethod, false);</span>
<a href="#l30.587"></a><span id="l30.587">         result = true;</span>
<a href="#l30.588"></a><span id="l30.588">         if (ppAccount)</span>
<a href="#l30.589"></a><span id="l30.589">           account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount),</span>
<a href="#l30.590"></a><span id="l30.590" class="difflineat">@@ -652,34 +653,34 @@ bool OESettings::DoPOP3Server( nsIMsgAcc</span>
<a href="#l30.591"></a><span id="l30.591">     }</span>
<a href="#l30.592"></a><span id="l30.592">   } </span>
<a href="#l30.593"></a><span id="l30.593">   else if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l30.594"></a><span id="l30.594">     IMPORT_LOG2(&quot;Existing POP3 server named: %s, userName: %s\n&quot;,</span>
<a href="#l30.595"></a><span id="l30.595">                 pServerName, pUserName);</span>
<a href="#l30.596"></a><span id="l30.596">     // for an existing server we create another identity,</span>
<a href="#l30.597"></a><span id="l30.597">     // TB listed under 'manage identities'</span>
<a href="#l30.598"></a><span id="l30.598">     nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l30.599"></a><span id="l30.599" class="difflineminus">-    rv = pMgr-&gt;FindAccountForServer(in, getter_AddRefs( account));</span>
<a href="#l30.600"></a><span id="l30.600" class="difflineplus">+    rv = pMgr-&gt;FindAccountForServer(in, getter_AddRefs(account));</span>
<a href="#l30.601"></a><span id="l30.601">     if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l30.602"></a><span id="l30.602">       IMPORT_LOG0(&quot;Created identity and added to existing POP3 incoming server.\n&quot;);</span>
<a href="#l30.603"></a><span id="l30.603">       // Fiddle with the identities</span>
<a href="#l30.604"></a><span id="l30.604">       in-&gt;GetAuthMethod(&amp;authMethod);</span>
<a href="#l30.605"></a><span id="l30.605">       SetIdentities(pMgr, account, hKey, pUserName, authMethod, false);</span>
<a href="#l30.606"></a><span id="l30.606">       result = true;</span>
<a href="#l30.607"></a><span id="l30.607">       if (ppAccount)</span>
<a href="#l30.608"></a><span id="l30.608">         account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l30.609"></a><span id="l30.609">     }</span>
<a href="#l30.610"></a><span id="l30.610">   }</span>
<a href="#l30.611"></a><span id="l30.611">   else</span>
<a href="#l30.612"></a><span id="l30.612">     result = true;</span>
<a href="#l30.613"></a><span id="l30.613">   nsOERegUtil::FreeValueBytes((BYTE *) pUserName);</span>
<a href="#l30.614"></a><span id="l30.614">   return result;</span>
<a href="#l30.615"></a><span id="l30.615"> }</span>
<a href="#l30.616"></a><span id="l30.616"> </span>
<a href="#l30.617"></a><span id="l30.617" class="difflineminus">-bool OESettings::DoNNTPServer( nsIMsgAccountManager *pMgr, HKEY hKey,</span>
<a href="#l30.618"></a><span id="l30.618" class="difflineplus">+bool OESettings::DoNNTPServer(nsIMsgAccountManager *pMgr, HKEY hKey,</span>
<a href="#l30.619"></a><span id="l30.619">                                 char *pServerName, nsIMsgAccount **ppAccount)</span>
<a href="#l30.620"></a><span id="l30.620"> {</span>
<a href="#l30.621"></a><span id="l30.621">   if (ppAccount)</span>
<a href="#l30.622"></a><span id="l30.622">     *ppAccount = nsnull;</span>
<a href="#l30.623"></a><span id="l30.623"> </span>
<a href="#l30.624"></a><span id="l30.624">   char * pUserName;</span>
<a href="#l30.625"></a><span id="l30.625">   // this only exists if NNTP server requires it or not anon login</span>
<a href="#l30.626"></a><span id="l30.626">   pUserName = (char *)nsOERegUtil::GetValueBytes(hKey, &quot;NNTP User Name&quot;);</span>
<a href="#l30.627"></a><span id="l30.627" class="difflineat">@@ -688,23 +689,23 @@ bool OESettings::DoNNTPServer( nsIMsgAcc</span>
<a href="#l30.628"></a><span id="l30.628"> </span>
<a href="#l30.629"></a><span id="l30.629">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l30.630"></a><span id="l30.630">   // NNTP can have empty user name.  This is wild card in findserver</span>
<a href="#l30.631"></a><span id="l30.631">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l30.632"></a><span id="l30.632">   nsresult rv = pMgr-&gt;FindServer(EmptyCString(),</span>
<a href="#l30.633"></a><span id="l30.633">                                  nsDependentCString(pServerName),</span>
<a href="#l30.634"></a><span id="l30.634">                                  NS_LITERAL_CSTRING(&quot;nntp&quot;),</span>
<a href="#l30.635"></a><span id="l30.635">                                  getter_AddRefs(in));</span>
<a href="#l30.636"></a><span id="l30.636" class="difflineminus">-  if (NS_FAILED( rv) || (in == nsnull)) {</span>
<a href="#l30.637"></a><span id="l30.637" class="difflineplus">+  if (NS_FAILED(rv) || (in == nsnull)) {</span>
<a href="#l30.638"></a><span id="l30.638">     // Create the incoming server and an account for it?</span>
<a href="#l30.639"></a><span id="l30.639">     rv = pMgr-&gt;CreateIncomingServer(EmptyCString(),</span>
<a href="#l30.640"></a><span id="l30.640">                                     nsDependentCString(pServerName),</span>
<a href="#l30.641"></a><span id="l30.641">                                     NS_LITERAL_CSTRING(&quot;nntp&quot;),</span>
<a href="#l30.642"></a><span id="l30.642">                                     getter_AddRefs(in));</span>
<a href="#l30.643"></a><span id="l30.643" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; in) {</span>
<a href="#l30.644"></a><span id="l30.644" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l30.645"></a><span id="l30.645">       BYTE * pBytesTemp = nsOERegUtil::GetValueBytes(hKey, &quot;NNTP Port&quot;);</span>
<a href="#l30.646"></a><span id="l30.646">       if (pBytesTemp &amp;&amp; *(PRInt32 *)pBytesTemp != 119)</span>
<a href="#l30.647"></a><span id="l30.647">         in-&gt;SetPort(*(PRInt32 *) pBytesTemp);</span>
<a href="#l30.648"></a><span id="l30.648">       nsOERegUtil::FreeValueBytes(pBytesTemp);</span>
<a href="#l30.649"></a><span id="l30.649"> </span>
<a href="#l30.650"></a><span id="l30.650">       // do nntpincomingserver stuff</span>
<a href="#l30.651"></a><span id="l30.651">       nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer = do_QueryInterface(in);</span>
<a href="#l30.652"></a><span id="l30.652">       if (nntpServer &amp;&amp; pUserName &amp;&amp; *pUserName) {</span>
<a href="#l30.653"></a><span id="l30.653" class="difflineat">@@ -716,35 +717,35 @@ bool OESettings::DoNNTPServer( nsIMsgAcc</span>
<a href="#l30.654"></a><span id="l30.654">                    pServerName, pUserName? pUserName : &quot;&quot;);</span>
<a href="#l30.655"></a><span id="l30.655"> </span>
<a href="#l30.656"></a><span id="l30.656">       nsString prettyName;</span>
<a href="#l30.657"></a><span id="l30.657">       if (NS_SUCCEEDED(GetAccountName(hKey, pServerName, prettyName)))</span>
<a href="#l30.658"></a><span id="l30.658">         rv = in-&gt;SetPrettyName(prettyName);</span>
<a href="#l30.659"></a><span id="l30.659"> </span>
<a href="#l30.660"></a><span id="l30.660">       // We have a server, create an account.</span>
<a href="#l30.661"></a><span id="l30.661">       nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l30.662"></a><span id="l30.662" class="difflineminus">-      rv = pMgr-&gt;CreateAccount(getter_AddRefs( account));</span>
<a href="#l30.663"></a><span id="l30.663" class="difflineplus">+      rv = pMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l30.664"></a><span id="l30.664">       if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l30.665"></a><span id="l30.665">         rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l30.666"></a><span id="l30.666"> </span>
<a href="#l30.667"></a><span id="l30.667">         IMPORT_LOG0(&quot;Created an account and set the NNTP server as the incoming server\n&quot;);</span>
<a href="#l30.668"></a><span id="l30.668"> </span>
<a href="#l30.669"></a><span id="l30.669">         // Fiddle with the identities</span>
<a href="#l30.670"></a><span id="l30.670">         SetIdentities(pMgr, account, hKey, pUserName, 0, true);</span>
<a href="#l30.671"></a><span id="l30.671">         result = true;</span>
<a href="#l30.672"></a><span id="l30.672">         if (ppAccount)</span>
<a href="#l30.673"></a><span id="l30.673">           account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l30.674"></a><span id="l30.674">       }</span>
<a href="#l30.675"></a><span id="l30.675">     }</span>
<a href="#l30.676"></a><span id="l30.676">   }</span>
<a href="#l30.677"></a><span id="l30.677">   else if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l30.678"></a><span id="l30.678">     // for the existing server...</span>
<a href="#l30.679"></a><span id="l30.679">     nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l30.680"></a><span id="l30.680" class="difflineminus">-    rv = pMgr-&gt;FindAccountForServer(in, getter_AddRefs( account));</span>
<a href="#l30.681"></a><span id="l30.681" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; account) {</span>
<a href="#l30.682"></a><span id="l30.682" class="difflineplus">+    rv = pMgr-&gt;FindAccountForServer(in, getter_AddRefs(account));</span>
<a href="#l30.683"></a><span id="l30.683" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l30.684"></a><span id="l30.684">       IMPORT_LOG0(&quot;Using existing account and set the NNTP server as the incoming server\n&quot;);</span>
<a href="#l30.685"></a><span id="l30.685">       // Fiddle with the identities</span>
<a href="#l30.686"></a><span id="l30.686">       SetIdentities(pMgr, account, hKey, pUserName, 0, true);</span>
<a href="#l30.687"></a><span id="l30.687">       result = true;</span>
<a href="#l30.688"></a><span id="l30.688">       if (ppAccount)</span>
<a href="#l30.689"></a><span id="l30.689">         account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount),</span>
<a href="#l30.690"></a><span id="l30.690">                                  (void **)ppAccount);</span>
<a href="#l30.691"></a><span id="l30.691">     }</span>
<a href="#l30.692"></a><span id="l30.692" class="difflineat">@@ -752,17 +753,17 @@ bool OESettings::DoNNTPServer( nsIMsgAcc</span>
<a href="#l30.693"></a><span id="l30.693">   else</span>
<a href="#l30.694"></a><span id="l30.694">     result = true;</span>
<a href="#l30.695"></a><span id="l30.695">   nsOERegUtil::FreeValueBytes((BYTE *) pUserName);</span>
<a href="#l30.696"></a><span id="l30.696">   return result;</span>
<a href="#l30.697"></a><span id="l30.697"> }</span>
<a href="#l30.698"></a><span id="l30.698"> </span>
<a href="#l30.699"></a><span id="l30.699"> void OESettings::SetIdentities(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc,</span>
<a href="#l30.700"></a><span id="l30.700">                                HKEY hKey, char *pIncomgUserName,</span>
<a href="#l30.701"></a><span id="l30.701" class="difflineminus">-                               PRInt32 authMethodIncoming, bool isNNTP )</span>
<a href="#l30.702"></a><span id="l30.702" class="difflineplus">+                               PRInt32 authMethodIncoming, bool isNNTP)</span>
<a href="#l30.703"></a><span id="l30.703"> {</span>
<a href="#l30.704"></a><span id="l30.704">   // Get the relevant information for an identity</span>
<a href="#l30.705"></a><span id="l30.705">   char *pSmtpServer = (char *)nsOERegUtil::GetValueBytes(hKey, &quot;SMTP Server&quot;);</span>
<a href="#l30.706"></a><span id="l30.706">   char *pName = (char *)nsOERegUtil::GetValueBytes(hKey, isNNTP ? &quot;NNTP Display Name&quot; : &quot;SMTP Display Name&quot;);</span>
<a href="#l30.707"></a><span id="l30.707">   char *pEmail = (char *)nsOERegUtil::GetValueBytes(hKey, isNNTP ? &quot;NNTP Email Address&quot; : &quot;SMTP Email Address&quot;);</span>
<a href="#l30.708"></a><span id="l30.708">   char *pReply = (char *)nsOERegUtil::GetValueBytes(hKey, isNNTP ? &quot;NNTP Reply To Email Address&quot; : &quot;SMTP Reply To Email Address&quot;);</span>
<a href="#l30.709"></a><span id="l30.709">   char *pOrgName = (char *)nsOERegUtil::GetValueBytes(hKey, isNNTP ? &quot;NNTP Organization Name&quot; : &quot;SMTP Organization Name&quot;);</span>
<a href="#l30.710"></a><span id="l30.710"> </span>
<a href="#l30.711"></a><span id="l30.711" class="difflineat">@@ -839,29 +840,29 @@ void OESettings::SetSmtpServer(char *pSm</span>
<a href="#l30.712"></a><span id="l30.712"> </span>
<a href="#l30.713"></a><span id="l30.713">   nsresult rv;</span>
<a href="#l30.714"></a><span id="l30.714">   nsCOMPtr&lt;nsISmtpService&gt; smtpService(do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l30.715"></a><span id="l30.715">   if (NS_SUCCEEDED(rv) &amp;&amp; smtpService) {</span>
<a href="#l30.716"></a><span id="l30.716">     nsCOMPtr&lt;nsISmtpServer&gt; foundServer;</span>
<a href="#l30.717"></a><span id="l30.717">     // don't try to make another server</span>
<a href="#l30.718"></a><span id="l30.718">     // regardless if username doesn't match</span>
<a href="#l30.719"></a><span id="l30.719">     rv = smtpService-&gt;FindServer(userName.get(), pSmtpServer,</span>
<a href="#l30.720"></a><span id="l30.720" class="difflineminus">-                                 getter_AddRefs( foundServer));</span>
<a href="#l30.721"></a><span id="l30.721" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; foundServer) {</span>
<a href="#l30.722"></a><span id="l30.722" class="difflineplus">+                                 getter_AddRefs(foundServer));</span>
<a href="#l30.723"></a><span id="l30.723" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; foundServer) {</span>
<a href="#l30.724"></a><span id="l30.724">       // set our account keyed to this smptserver key</span>
<a href="#l30.725"></a><span id="l30.725">       foundServer-&gt;GetKey(getter_Copies(smtpServerKey));</span>
<a href="#l30.726"></a><span id="l30.726">       id-&gt;SetSmtpServerKey(smtpServerKey);</span>
<a href="#l30.727"></a><span id="l30.727"> </span>
<a href="#l30.728"></a><span id="l30.728">       IMPORT_LOG1(&quot;SMTP server already exists: %s\n&quot;, pSmtpServer);</span>
<a href="#l30.729"></a><span id="l30.729">     }</span>
<a href="#l30.730"></a><span id="l30.730">     else {</span>
<a href="#l30.731"></a><span id="l30.731">       nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l30.732"></a><span id="l30.732">       PRInt32 port;</span>
<a href="#l30.733"></a><span id="l30.733" class="difflineminus">-      rv = smtpService-&gt;CreateSmtpServer(getter_AddRefs( smtpServer));</span>
<a href="#l30.734"></a><span id="l30.734" class="difflineminus">-      if (NS_SUCCEEDED( rv) &amp;&amp; smtpServer) {</span>
<a href="#l30.735"></a><span id="l30.735" class="difflineplus">+      rv = smtpService-&gt;CreateSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l30.736"></a><span id="l30.736" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; smtpServer) {</span>
<a href="#l30.737"></a><span id="l30.737">         pBytes = nsOERegUtil::GetValueBytes(hKey, &quot;SMTP Port&quot;);</span>
<a href="#l30.738"></a><span id="l30.738">         if (pBytes)</span>
<a href="#l30.739"></a><span id="l30.739">         {</span>
<a href="#l30.740"></a><span id="l30.740">           smtpServer-&gt;SetPort(*(PRInt32 *) pBytes);</span>
<a href="#l30.741"></a><span id="l30.741">           port = *(PRInt32 *) pBytes;</span>
<a href="#l30.742"></a><span id="l30.742">           nsOERegUtil::FreeValueBytes(pBytes);</span>
<a href="#l30.743"></a><span id="l30.743">         }</span>
<a href="#l30.744"></a><span id="l30.744">         pBytes = nsOERegUtil::GetValueBytes(hKey,&quot;SMTP Secure Connection&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOEStringBundle.cpp</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOEStringBundle.cpp</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -43,62 +43,61 @@</span>
<a href="#l31.4"></a><span id="l31.4"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l31.5"></a><span id="l31.5"> #include &quot;nsIURI.h&quot;</span>
<a href="#l31.6"></a><span id="l31.6"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l31.7"></a><span id="l31.7"> </span>
<a href="#l31.8"></a><span id="l31.8"> #define OE_MSGS_URL       &quot;chrome://messenger/locale/oeImportMsgs.properties&quot;</span>
<a href="#l31.9"></a><span id="l31.9"> </span>
<a href="#l31.10"></a><span id="l31.10"> nsIStringBundle *  nsOEStringBundle::m_pBundle = nsnull;</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-nsIStringBundle *nsOEStringBundle::GetStringBundle( void)</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+nsIStringBundle *nsOEStringBundle::GetStringBundle(void)</span>
<a href="#l31.14"></a><span id="l31.14"> {</span>
<a href="#l31.15"></a><span id="l31.15">   if (m_pBundle)</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineminus">-    return( m_pBundle);</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineplus">+    return m_pBundle;</span>
<a href="#l31.18"></a><span id="l31.18"> </span>
<a href="#l31.19"></a><span id="l31.19">   char*        propertyURL = OE_MSGS_URL;</span>
<a href="#l31.20"></a><span id="l31.20">   nsIStringBundle*  sBundle = nsnull;</span>
<a href="#l31.21"></a><span id="l31.21"> </span>
<a href="#l31.22"></a><span id="l31.22">   nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l31.23"></a><span id="l31.23">     mozilla::services::GetStringBundleService();</span>
<a href="#l31.24"></a><span id="l31.24">   if (sBundleService) {</span>
<a href="#l31.25"></a><span id="l31.25">     sBundleService-&gt;CreateBundle(propertyURL, &amp;sBundle);</span>
<a href="#l31.26"></a><span id="l31.26">   }</span>
<a href="#l31.27"></a><span id="l31.27"> </span>
<a href="#l31.28"></a><span id="l31.28">   m_pBundle = sBundle;</span>
<a href="#l31.29"></a><span id="l31.29"> </span>
<a href="#l31.30"></a><span id="l31.30" class="difflineminus">-  return( sBundle);</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+  return sBundle;</span>
<a href="#l31.32"></a><span id="l31.32"> }</span>
<a href="#l31.33"></a><span id="l31.33"> </span>
<a href="#l31.34"></a><span id="l31.34"> </span>
<a href="#l31.35"></a><span id="l31.35" class="difflineminus">-void nsOEStringBundle::GetStringByID( PRInt32 stringID, nsString&amp; result)</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineplus">+void nsOEStringBundle::GetStringByID(PRInt32 stringID, nsString&amp; result)</span>
<a href="#l31.37"></a><span id="l31.37"> {</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineminus">-  PRUnichar *ptrv = GetStringByID( stringID);</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineminus">-  result = ptrv;</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineminus">-  FreeString( ptrv);</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineplus">+  PRUnichar *ptrv = GetStringByID(stringID);</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineplus">+  result.Adopt(ptrv);</span>
<a href="#l31.43"></a><span id="l31.43"> }</span>
<a href="#l31.44"></a><span id="l31.44"> </span>
<a href="#l31.45"></a><span id="l31.45"> PRUnichar *nsOEStringBundle::GetStringByID(PRInt32 stringID)</span>
<a href="#l31.46"></a><span id="l31.46"> {</span>
<a href="#l31.47"></a><span id="l31.47">   if (!m_pBundle)</span>
<a href="#l31.48"></a><span id="l31.48">     m_pBundle = GetStringBundle();</span>
<a href="#l31.49"></a><span id="l31.49"> </span>
<a href="#l31.50"></a><span id="l31.50">   if (m_pBundle) {</span>
<a href="#l31.51"></a><span id="l31.51">     PRUnichar *ptrv = nsnull;</span>
<a href="#l31.52"></a><span id="l31.52">     nsresult rv = m_pBundle-&gt;GetStringFromID(stringID, &amp;ptrv);</span>
<a href="#l31.53"></a><span id="l31.53"> </span>
<a href="#l31.54"></a><span id="l31.54" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; ptrv)</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineminus">-      return( ptrv);</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; ptrv)</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineplus">+      return ptrv;</span>
<a href="#l31.58"></a><span id="l31.58">   }</span>
<a href="#l31.59"></a><span id="l31.59"> </span>
<a href="#l31.60"></a><span id="l31.60">   nsString resultString;</span>
<a href="#l31.61"></a><span id="l31.61">   resultString.AppendLiteral(&quot;[StringID &quot;);</span>
<a href="#l31.62"></a><span id="l31.62">   resultString.AppendInt(stringID);</span>
<a href="#l31.63"></a><span id="l31.63">   resultString.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l31.64"></a><span id="l31.64"> </span>
<a href="#l31.65"></a><span id="l31.65" class="difflineminus">-  return( ToNewUnicode(resultString));</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineplus">+  return ToNewUnicode(resultString);</span>
<a href="#l31.67"></a><span id="l31.67"> }</span>
<a href="#l31.68"></a><span id="l31.68"> </span>
<a href="#l31.69"></a><span id="l31.69" class="difflineminus">-void nsOEStringBundle::Cleanup( void)</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineplus">+void nsOEStringBundle::Cleanup(void)</span>
<a href="#l31.71"></a><span id="l31.71"> {</span>
<a href="#l31.72"></a><span id="l31.72">   if (m_pBundle)</span>
<a href="#l31.73"></a><span id="l31.73">     m_pBundle-&gt;Release();</span>
<a href="#l31.74"></a><span id="l31.74">   m_pBundle = nsnull;</span>
<a href="#l31.75"></a><span id="l31.75"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/import/oexpress/nsOEStringBundle.h</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/import/oexpress/nsOEStringBundle.h</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -40,19 +40,19 @@</span>
<a href="#l32.4"></a><span id="l32.4"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l32.5"></a><span id="l32.5"> </span>
<a href="#l32.6"></a><span id="l32.6"> class nsIStringBundle;</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8"> class nsOEStringBundle {</span>
<a href="#l32.9"></a><span id="l32.9"> public:</span>
<a href="#l32.10"></a><span id="l32.10">   static PRUnichar     *    GetStringByID(PRInt32 stringID);</span>
<a href="#l32.11"></a><span id="l32.11">   static void          GetStringByID(PRInt32 stringID, nsString&amp; result);</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  static nsIStringBundle *  GetStringBundle( void); // don't release</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-  static void          FreeString( PRUnichar *pStr) { NS_Free( pStr);}</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-  static void          Cleanup( void);</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+  static nsIStringBundle *  GetStringBundle(void); // don't release</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+  static void          FreeString(PRUnichar *pStr) { NS_Free(pStr);}</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+  static void          Cleanup(void);</span>
<a href="#l32.18"></a><span id="l32.18"> </span>
<a href="#l32.19"></a><span id="l32.19"> private:</span>
<a href="#l32.20"></a><span id="l32.20">   static nsIStringBundle *  m_pBundle;</span>
<a href="#l32.21"></a><span id="l32.21"> };</span>
<a href="#l32.22"></a><span id="l32.22"> </span>
<a href="#l32.23"></a><span id="l32.23"> </span>
<a href="#l32.24"></a><span id="l32.24"> </span>
<a href="#l32.25"></a><span id="l32.25"> #define OEIMPORT_NAME                     2000</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiApi.cpp</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiApi.cpp</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -124,17 +124,17 @@ BOOL CMapiApi::LoadMapiEntryPoints(void)</span>
<a href="#l33.4"></a><span id="l33.4">   gpWrapCompressedRTFStream = (LPWRAPCOMPRESSEDRTFSTREAM) GetProcAddress(</span>
<a href="#l33.5"></a><span id="l33.5">     m_hMapi32, &quot;WrapCompressedRTFStream&quot;);</span>
<a href="#l33.6"></a><span id="l33.6"> </span>
<a href="#l33.7"></a><span id="l33.7">   return TRUE;</span>
<a href="#l33.8"></a><span id="l33.8"> }</span>
<a href="#l33.9"></a><span id="l33.9"> </span>
<a href="#l33.10"></a><span id="l33.10"> // Gets the PR_RTF_COMPRESSED tag property</span>
<a href="#l33.11"></a><span id="l33.11"> // Codepage is used only if the WrapCompressedRTFStreamEx is available</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-BOOL CMapiApi::GetRTFPropertyDecodedAsUTF16( LPMAPIPROP pProp, nsString&amp; val,</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+BOOL CMapiApi::GetRTFPropertyDecodedAsUTF16(LPMAPIPROP pProp, nsString&amp; val,</span>
<a href="#l33.14"></a><span id="l33.14">                                             unsigned long&amp; nativeBodyType,</span>
<a href="#l33.15"></a><span id="l33.15">                                             unsigned long codepage)</span>
<a href="#l33.16"></a><span id="l33.16"> {</span>
<a href="#l33.17"></a><span id="l33.17">   if (!m_hMapi32 || !(gpWrapCompressedRTFStreamEx || gpWrapCompressedRTFStream))</span>
<a href="#l33.18"></a><span id="l33.18">     return FALSE; // Fallback to the default processing</span>
<a href="#l33.19"></a><span id="l33.19"> </span>
<a href="#l33.20"></a><span id="l33.20">   LPSTREAM icstream = 0; // for the compressed stream</span>
<a href="#l33.21"></a><span id="l33.21">   LPSTREAM iunstream = 0; // for the uncompressed stream</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineat">@@ -204,17 +204,17 @@ BOOL CMapiApi::GetRTFPropertyDecodedAsUT</span>
<a href="#l33.23"></a><span id="l33.23"> void CMapiApi::MAPIUninitialize(void)</span>
<a href="#l33.24"></a><span id="l33.24"> {</span>
<a href="#l33.25"></a><span id="l33.25">   if (m_hMapi32 &amp;&amp; gpMapiUninitialize)</span>
<a href="#l33.26"></a><span id="l33.26">     (*gpMapiUninitialize)();</span>
<a href="#l33.27"></a><span id="l33.27"> }</span>
<a href="#l33.28"></a><span id="l33.28"> </span>
<a href="#l33.29"></a><span id="l33.29"> HRESULT CMapiApi::MAPIInitialize(LPVOID lpInit)</span>
<a href="#l33.30"></a><span id="l33.30"> {</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">-  return (m_hMapi32 &amp;&amp; gpMapiInitialize) ? (*gpMapiInitialize)( lpInit) :</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+  return (m_hMapi32 &amp;&amp; gpMapiInitialize) ? (*gpMapiInitialize)(lpInit) :</span>
<a href="#l33.33"></a><span id="l33.33">           MAPI_E_NOT_INITIALIZED;</span>
<a href="#l33.34"></a><span id="l33.34"> }</span>
<a href="#l33.35"></a><span id="l33.35"> </span>
<a href="#l33.36"></a><span id="l33.36"> SCODE CMapiApi::MAPIAllocateBuffer(ULONG cbSize, LPVOID FAR * lppBuffer)</span>
<a href="#l33.37"></a><span id="l33.37"> {</span>
<a href="#l33.38"></a><span id="l33.38">   return (m_hMapi32 &amp;&amp; gpMapiAllocateBuffer) ?</span>
<a href="#l33.39"></a><span id="l33.39">           (*gpMapiAllocateBuffer)(cbSize, lppBuffer) : MAPI_E_NOT_INITIALIZED;</span>
<a href="#l33.40"></a><span id="l33.40"> }</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineat">@@ -240,50 +240,50 @@ HRESULT CMapiApi::OpenStreamOnFile(LPALL</span>
<a href="#l33.42"></a><span id="l33.42">                                    LPSTREAM FAR * lppStream)</span>
<a href="#l33.43"></a><span id="l33.43"> {</span>
<a href="#l33.44"></a><span id="l33.44">   return (m_hMapi32 &amp;&amp; gpMapiOpenStreamOnFile) ?</span>
<a href="#l33.45"></a><span id="l33.45">     (*gpMapiOpenStreamOnFile)(lpAllocateBuffer, lpFreeBuffer, ulFlags,</span>
<a href="#l33.46"></a><span id="l33.46">                               lpszFileName, lpszPrefix, lppStream) :</span>
<a href="#l33.47"></a><span id="l33.47">     MAPI_E_NOT_INITIALIZED;</span>
<a href="#l33.48"></a><span id="l33.48"> }</span>
<a href="#l33.49"></a><span id="l33.49"> </span>
<a href="#l33.50"></a><span id="l33.50" class="difflineminus">-void CMapiApi::FreeProws( LPSRowSet prows)</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+void CMapiApi::FreeProws(LPSRowSet prows)</span>
<a href="#l33.52"></a><span id="l33.52"> {</span>
<a href="#l33.53"></a><span id="l33.53">   ULONG    irow;</span>
<a href="#l33.54"></a><span id="l33.54">   if (!prows)</span>
<a href="#l33.55"></a><span id="l33.55">     return;</span>
<a href="#l33.56"></a><span id="l33.56">   for (irow = 0; irow &lt; prows-&gt;cRows; ++irow)</span>
<a href="#l33.57"></a><span id="l33.57">     MAPIFreeBuffer(prows-&gt;aRow[irow].lpProps);</span>
<a href="#l33.58"></a><span id="l33.58">   MAPIFreeBuffer(prows);</span>
<a href="#l33.59"></a><span id="l33.59"> }</span>
<a href="#l33.60"></a><span id="l33.60"> </span>
<a href="#l33.61"></a><span id="l33.61" class="difflineminus">-BOOL CMapiApi::LoadMapi( void)</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineplus">+BOOL CMapiApi::LoadMapi(void)</span>
<a href="#l33.63"></a><span id="l33.63"> {</span>
<a href="#l33.64"></a><span id="l33.64">   if (m_hMapi32)</span>
<a href="#l33.65"></a><span id="l33.65">     return TRUE;</span>
<a href="#l33.66"></a><span id="l33.66"> </span>
<a href="#l33.67"></a><span id="l33.67" class="difflineminus">-  HINSTANCE  hInst = ::LoadLibrary( &quot;MAPI32.DLL&quot;);</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineplus">+  HINSTANCE  hInst = ::LoadLibrary(&quot;MAPI32.DLL&quot;);</span>
<a href="#l33.69"></a><span id="l33.69">   if (!hInst)</span>
<a href="#l33.70"></a><span id="l33.70">     return FALSE;</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineminus">-  FARPROC pProc = GetProcAddress( hInst, &quot;MAPIGetNetscapeVersion&quot;);</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineplus">+  FARPROC pProc = GetProcAddress(hInst, &quot;MAPIGetNetscapeVersion&quot;);</span>
<a href="#l33.73"></a><span id="l33.73">   if (pProc) {</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineminus">-    ::FreeLibrary( hInst);</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineminus">-    hInst = ::LoadLibrary( &quot;MAPI32BAK.DLL&quot;);</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineplus">+    ::FreeLibrary(hInst);</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineplus">+    hInst = ::LoadLibrary(&quot;MAPI32BAK.DLL&quot;);</span>
<a href="#l33.78"></a><span id="l33.78">     if (!hInst)</span>
<a href="#l33.79"></a><span id="l33.79">       return FALSE;</span>
<a href="#l33.80"></a><span id="l33.80">   }</span>
<a href="#l33.81"></a><span id="l33.81"> </span>
<a href="#l33.82"></a><span id="l33.82">   m_hMapi32 = hInst;</span>
<a href="#l33.83"></a><span id="l33.83">   return LoadMapiEntryPoints();</span>
<a href="#l33.84"></a><span id="l33.84"> }</span>
<a href="#l33.85"></a><span id="l33.85"> </span>
<a href="#l33.86"></a><span id="l33.86"> void CMapiApi::UnloadMapi(void)</span>
<a href="#l33.87"></a><span id="l33.87"> {</span>
<a href="#l33.88"></a><span id="l33.88">   if (m_hMapi32)</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineminus">-    ::FreeLibrary( m_hMapi32);</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineplus">+    ::FreeLibrary(m_hMapi32);</span>
<a href="#l33.91"></a><span id="l33.91">   m_hMapi32 = NULL;</span>
<a href="#l33.92"></a><span id="l33.92"> }</span>
<a href="#l33.93"></a><span id="l33.93"> </span>
<a href="#l33.94"></a><span id="l33.94"> CMapiApi::CMapiApi()</span>
<a href="#l33.95"></a><span id="l33.95"> {</span>
<a href="#l33.96"></a><span id="l33.96">   m_clients++;</span>
<a href="#l33.97"></a><span id="l33.97">   LoadMapi();</span>
<a href="#l33.98"></a><span id="l33.98">   if (!m_pStores)</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineat">@@ -298,19 +298,19 @@ CMapiApi::~CMapiApi()</span>
<a href="#l33.100"></a><span id="l33.100"> </span>
<a href="#l33.101"></a><span id="l33.101">     ClearMessageStores();</span>
<a href="#l33.102"></a><span id="l33.102">     delete m_pStores;</span>
<a href="#l33.103"></a><span id="l33.103">     m_pStores = NULL;</span>
<a href="#l33.104"></a><span id="l33.104"> </span>
<a href="#l33.105"></a><span id="l33.105">     m_lpMdb = NULL;</span>
<a href="#l33.106"></a><span id="l33.106"> </span>
<a href="#l33.107"></a><span id="l33.107">     if (m_lpSession) {</span>
<a href="#l33.108"></a><span id="l33.108" class="difflineminus">-      hr = m_lpSession-&gt;Logoff( NULL, 0, 0);</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineplus">+      hr = m_lpSession-&gt;Logoff(NULL, 0, 0);</span>
<a href="#l33.110"></a><span id="l33.110">       if (FAILED(hr)) {</span>
<a href="#l33.111"></a><span id="l33.111" class="difflineminus">-        MAPI_TRACE2( &quot;Logoff failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineplus">+        MAPI_TRACE2(&quot;Logoff failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.113"></a><span id="l33.113">       }</span>
<a href="#l33.114"></a><span id="l33.114">       m_lpSession-&gt;Release();</span>
<a href="#l33.115"></a><span id="l33.115">       m_lpSession = NULL;</span>
<a href="#l33.116"></a><span id="l33.116">     }</span>
<a href="#l33.117"></a><span id="l33.117"> </span>
<a href="#l33.118"></a><span id="l33.118">     if (m_initialized) {</span>
<a href="#l33.119"></a><span id="l33.119">       MAPIUninitialize();</span>
<a href="#l33.120"></a><span id="l33.120">       m_initialized = FALSE;</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineat">@@ -320,107 +320,107 @@ CMapiApi::~CMapiApi()</span>
<a href="#l33.122"></a><span id="l33.122"> </span>
<a href="#l33.123"></a><span id="l33.123">     if (m_pUniBuff)</span>
<a href="#l33.124"></a><span id="l33.124">       delete [] m_pUniBuff;</span>
<a href="#l33.125"></a><span id="l33.125">     m_pUniBuff = NULL;</span>
<a href="#l33.126"></a><span id="l33.126">     m_uniBuffLen = 0;</span>
<a href="#l33.127"></a><span id="l33.127">   }</span>
<a href="#l33.128"></a><span id="l33.128"> }</span>
<a href="#l33.129"></a><span id="l33.129"> </span>
<a href="#l33.130"></a><span id="l33.130" class="difflineminus">-void CMapiApi::CStrToUnicode( const char *pStr, nsString&amp; result)</span>
<a href="#l33.131"></a><span id="l33.131" class="difflineplus">+void CMapiApi::CStrToUnicode(const char *pStr, nsString&amp; result)</span>
<a href="#l33.132"></a><span id="l33.132"> {</span>
<a href="#l33.133"></a><span id="l33.133">   result.Truncate();</span>
<a href="#l33.134"></a><span id="l33.134" class="difflineminus">-  int wLen = MultiByteToWideChar( CP_ACP, 0, pStr, -1, m_pUniBuff, 0);</span>
<a href="#l33.135"></a><span id="l33.135" class="difflineplus">+  int wLen = MultiByteToWideChar(CP_ACP, 0, pStr, -1, m_pUniBuff, 0);</span>
<a href="#l33.136"></a><span id="l33.136">   if (wLen &gt;= m_uniBuffLen) {</span>
<a href="#l33.137"></a><span id="l33.137">     if (m_pUniBuff)</span>
<a href="#l33.138"></a><span id="l33.138">       delete [] m_pUniBuff;</span>
<a href="#l33.139"></a><span id="l33.139">     m_pUniBuff = new PRUnichar[wLen + 64];</span>
<a href="#l33.140"></a><span id="l33.140">     m_uniBuffLen = wLen + 64;</span>
<a href="#l33.141"></a><span id="l33.141">   }</span>
<a href="#l33.142"></a><span id="l33.142">   if (wLen) {</span>
<a href="#l33.143"></a><span id="l33.143" class="difflineminus">-    MultiByteToWideChar( CP_ACP, 0, pStr, -1, m_pUniBuff, m_uniBuffLen);</span>
<a href="#l33.144"></a><span id="l33.144" class="difflineplus">+    MultiByteToWideChar(CP_ACP, 0, pStr, -1, m_pUniBuff, m_uniBuffLen);</span>
<a href="#l33.145"></a><span id="l33.145">     result = m_pUniBuff;</span>
<a href="#l33.146"></a><span id="l33.146">   }</span>
<a href="#l33.147"></a><span id="l33.147"> }</span>
<a href="#l33.148"></a><span id="l33.148"> </span>
<a href="#l33.149"></a><span id="l33.149" class="difflineminus">-BOOL CMapiApi::Initialize( void)</span>
<a href="#l33.150"></a><span id="l33.150" class="difflineplus">+BOOL CMapiApi::Initialize(void)</span>
<a href="#l33.151"></a><span id="l33.151"> {</span>
<a href="#l33.152"></a><span id="l33.152">   if (m_initialized)</span>
<a href="#l33.153"></a><span id="l33.153" class="difflineminus">-    return( TRUE);</span>
<a href="#l33.154"></a><span id="l33.154" class="difflineplus">+    return TRUE;</span>
<a href="#l33.155"></a><span id="l33.155"> </span>
<a href="#l33.156"></a><span id="l33.156">   HRESULT    hr;</span>
<a href="#l33.157"></a><span id="l33.157"> </span>
<a href="#l33.158"></a><span id="l33.158" class="difflineminus">-  hr = MAPIInitialize( NULL);</span>
<a href="#l33.159"></a><span id="l33.159" class="difflineplus">+  hr = MAPIInitialize(NULL);</span>
<a href="#l33.160"></a><span id="l33.160"> </span>
<a href="#l33.161"></a><span id="l33.161">   if (FAILED(hr)) {</span>
<a href="#l33.162"></a><span id="l33.162" class="difflineminus">-    MAPI_TRACE2( &quot;MAPI Initialize failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.163"></a><span id="l33.163" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.164"></a><span id="l33.164" class="difflineplus">+    MAPI_TRACE2(&quot;MAPI Initialize failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.165"></a><span id="l33.165" class="difflineplus">+    return FALSE;</span>
<a href="#l33.166"></a><span id="l33.166">   }</span>
<a href="#l33.167"></a><span id="l33.167"> </span>
<a href="#l33.168"></a><span id="l33.168">   m_initialized = TRUE;</span>
<a href="#l33.169"></a><span id="l33.169" class="difflineminus">-  MAPI_TRACE0( &quot;MAPI Initialized\n&quot;);</span>
<a href="#l33.170"></a><span id="l33.170" class="difflineplus">+  MAPI_TRACE0(&quot;MAPI Initialized\n&quot;);</span>
<a href="#l33.171"></a><span id="l33.171"> </span>
<a href="#l33.172"></a><span id="l33.172" class="difflineminus">-  return( TRUE);</span>
<a href="#l33.173"></a><span id="l33.173" class="difflineplus">+  return TRUE;</span>
<a href="#l33.174"></a><span id="l33.174"> }</span>
<a href="#l33.175"></a><span id="l33.175"> </span>
<a href="#l33.176"></a><span id="l33.176" class="difflineminus">-BOOL CMapiApi::LogOn( void)</span>
<a href="#l33.177"></a><span id="l33.177" class="difflineplus">+BOOL CMapiApi::LogOn(void)</span>
<a href="#l33.178"></a><span id="l33.178"> {</span>
<a href="#l33.179"></a><span id="l33.179">   if (!m_initialized) {</span>
<a href="#l33.180"></a><span id="l33.180" class="difflineminus">-    MAPI_TRACE0( &quot;Tried to LogOn before initializing MAPI\n&quot;);</span>
<a href="#l33.181"></a><span id="l33.181" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.182"></a><span id="l33.182" class="difflineplus">+    MAPI_TRACE0(&quot;Tried to LogOn before initializing MAPI\n&quot;);</span>
<a href="#l33.183"></a><span id="l33.183" class="difflineplus">+    return FALSE;</span>
<a href="#l33.184"></a><span id="l33.184">   }</span>
<a href="#l33.185"></a><span id="l33.185"> </span>
<a href="#l33.186"></a><span id="l33.186">   if (m_lpSession)</span>
<a href="#l33.187"></a><span id="l33.187" class="difflineminus">-    return( TRUE);</span>
<a href="#l33.188"></a><span id="l33.188" class="difflineplus">+    return TRUE;</span>
<a href="#l33.189"></a><span id="l33.189"> </span>
<a href="#l33.190"></a><span id="l33.190">   HRESULT hr;</span>
<a href="#l33.191"></a><span id="l33.191"> </span>
<a href="#l33.192"></a><span id="l33.192" class="difflineminus">-  hr = MAPILogonEx(  0, // might need to be passed in HWND</span>
<a href="#l33.193"></a><span id="l33.193" class="difflineplus">+  hr = MAPILogonEx( 0, // might need to be passed in HWND</span>
<a href="#l33.194"></a><span id="l33.194">             NULL, // profile name, 64 char max (LPTSTR)</span>
<a href="#l33.195"></a><span id="l33.195">             NULL, // profile password, 64 char max (LPTSTR)</span>
<a href="#l33.196"></a><span id="l33.196">             // MAPI_NEW_SESSION | MAPI_NO_MAIL | MAPI_LOGON_UI | MAPI_EXPLICIT_PROFILE,</span>
<a href="#l33.197"></a><span id="l33.197">             // MAPI_NEW_SESSION | MAPI_NO_MAIL | MAPI_LOGON_UI,</span>
<a href="#l33.198"></a><span id="l33.198">             // MAPI_NO_MAIL | MAPI_LOGON_UI,</span>
<a href="#l33.199"></a><span id="l33.199">             MAPI_NO_MAIL | MAPI_USE_DEFAULT | MAPI_EXTENDED | MAPI_NEW_SESSION,</span>
<a href="#l33.200"></a><span id="l33.200">             &amp;m_lpSession);</span>
<a href="#l33.201"></a><span id="l33.201"> </span>
<a href="#l33.202"></a><span id="l33.202">   if (FAILED(hr)) {</span>
<a href="#l33.203"></a><span id="l33.203">     m_lpSession = NULL;</span>
<a href="#l33.204"></a><span id="l33.204" class="difflineminus">-    MAPI_TRACE2( &quot;LogOn failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.205"></a><span id="l33.205" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.206"></a><span id="l33.206" class="difflineplus">+    MAPI_TRACE2(&quot;LogOn failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.207"></a><span id="l33.207" class="difflineplus">+    return FALSE;</span>
<a href="#l33.208"></a><span id="l33.208">   }</span>
<a href="#l33.209"></a><span id="l33.209"> </span>
<a href="#l33.210"></a><span id="l33.210" class="difflineminus">-  MAPI_TRACE0( &quot;MAPI Logged on\n&quot;);</span>
<a href="#l33.211"></a><span id="l33.211" class="difflineminus">-  return( TRUE);</span>
<a href="#l33.212"></a><span id="l33.212" class="difflineplus">+  MAPI_TRACE0(&quot;MAPI Logged on\n&quot;);</span>
<a href="#l33.213"></a><span id="l33.213" class="difflineplus">+  return TRUE;</span>
<a href="#l33.214"></a><span id="l33.214"> }</span>
<a href="#l33.215"></a><span id="l33.215"> </span>
<a href="#l33.216"></a><span id="l33.216"> class CGetStoreFoldersIter : public CMapiHierarchyIter {</span>
<a href="#l33.217"></a><span id="l33.217"> public:</span>
<a href="#l33.218"></a><span id="l33.218" class="difflineminus">-  CGetStoreFoldersIter( CMapiApi *pApi, CMapiFolderList&amp; folders, int depth, BOOL isMail = TRUE);</span>
<a href="#l33.219"></a><span id="l33.219" class="difflineplus">+  CGetStoreFoldersIter(CMapiApi *pApi, CMapiFolderList&amp; folders, int depth, BOOL isMail = TRUE);</span>
<a href="#l33.220"></a><span id="l33.220"> </span>
<a href="#l33.221"></a><span id="l33.221" class="difflineminus">-  virtual BOOL HandleHierarchyItem( ULONG oType, ULONG cb, LPENTRYID pEntry);</span>
<a href="#l33.222"></a><span id="l33.222" class="difflineplus">+  virtual BOOL HandleHierarchyItem(ULONG oType, ULONG cb, LPENTRYID pEntry);</span>
<a href="#l33.223"></a><span id="l33.223"> </span>
<a href="#l33.224"></a><span id="l33.224"> protected:</span>
<a href="#l33.225"></a><span id="l33.225" class="difflineminus">-  BOOL  ExcludeFolderClass( const PRUnichar *pName);</span>
<a href="#l33.226"></a><span id="l33.226" class="difflineplus">+  BOOL  ExcludeFolderClass(const PRUnichar *pName);</span>
<a href="#l33.227"></a><span id="l33.227"> </span>
<a href="#l33.228"></a><span id="l33.228">   BOOL        m_isMail;</span>
<a href="#l33.229"></a><span id="l33.229">   CMapiApi *      m_pApi;</span>
<a href="#l33.230"></a><span id="l33.230">   CMapiFolderList *  m_pList;</span>
<a href="#l33.231"></a><span id="l33.231">   int          m_depth;</span>
<a href="#l33.232"></a><span id="l33.232"> };</span>
<a href="#l33.233"></a><span id="l33.233"> </span>
<a href="#l33.234"></a><span id="l33.234" class="difflineminus">-CGetStoreFoldersIter::CGetStoreFoldersIter( CMapiApi *pApi, CMapiFolderList&amp; folders, int depth, BOOL isMail)</span>
<a href="#l33.235"></a><span id="l33.235" class="difflineplus">+CGetStoreFoldersIter::CGetStoreFoldersIter(CMapiApi *pApi, CMapiFolderList&amp; folders, int depth, BOOL isMail)</span>
<a href="#l33.236"></a><span id="l33.236"> {</span>
<a href="#l33.237"></a><span id="l33.237">   m_pApi = pApi;</span>
<a href="#l33.238"></a><span id="l33.238">   m_pList = &amp;folders;</span>
<a href="#l33.239"></a><span id="l33.239">   m_depth = depth;</span>
<a href="#l33.240"></a><span id="l33.240">   m_isMail = isMail;</span>
<a href="#l33.241"></a><span id="l33.241"> }</span>
<a href="#l33.242"></a><span id="l33.242"> </span>
<a href="#l33.243"></a><span id="l33.243" class="difflineminus">-BOOL CGetStoreFoldersIter::ExcludeFolderClass( const PRUnichar *pName)</span>
<a href="#l33.244"></a><span id="l33.244" class="difflineplus">+BOOL CGetStoreFoldersIter::ExcludeFolderClass(const PRUnichar *pName)</span>
<a href="#l33.245"></a><span id="l33.245"> {</span>
<a href="#l33.246"></a><span id="l33.246">   BOOL bResult;</span>
<a href="#l33.247"></a><span id="l33.247">     nsDependentString pNameStr(pName);</span>
<a href="#l33.248"></a><span id="l33.248">   if (m_isMail) {</span>
<a href="#l33.249"></a><span id="l33.249">     bResult = FALSE;</span>
<a href="#l33.250"></a><span id="l33.250">         if (pNameStr.EqualsLiteral(&quot;IPF.Appointment&quot;))</span>
<a href="#l33.251"></a><span id="l33.251">       bResult = TRUE;</span>
<a href="#l33.252"></a><span id="l33.252">     else if (pNameStr.EqualsLiteral(&quot;IPF.Contact&quot;))</span>
<a href="#l33.253"></a><span id="l33.253" class="difflineat">@@ -429,209 +429,209 @@ BOOL CGetStoreFoldersIter::ExcludeFolder</span>
<a href="#l33.254"></a><span id="l33.254">       bResult = TRUE;</span>
<a href="#l33.255"></a><span id="l33.255">         else if (pNameStr.EqualsLiteral(&quot;IPF.StickyNote&quot;))</span>
<a href="#l33.256"></a><span id="l33.256">       bResult = TRUE;</span>
<a href="#l33.257"></a><span id="l33.257">     else if (pNameStr.EqualsLiteral(&quot;IPF.Task&quot;))</span>
<a href="#l33.258"></a><span id="l33.258">       bResult = TRUE;</span>
<a href="#l33.259"></a><span id="l33.259">     // Skip IMAP folders</span>
<a href="#l33.260"></a><span id="l33.260">     else if (pNameStr.EqualsLiteral(&quot;IPF.Imap&quot;))</span>
<a href="#l33.261"></a><span id="l33.261">       bResult = TRUE;</span>
<a href="#l33.262"></a><span id="l33.262" class="difflineminus">-    // else if (!stricmp( pName, &quot;IPF.Note&quot;))</span>
<a href="#l33.263"></a><span id="l33.263" class="difflineplus">+    // else if (!stricmp(pName, &quot;IPF.Note&quot;))</span>
<a href="#l33.264"></a><span id="l33.264">     //  bResult = TRUE;</span>
<a href="#l33.265"></a><span id="l33.265">   }</span>
<a href="#l33.266"></a><span id="l33.266">   else {</span>
<a href="#l33.267"></a><span id="l33.267">     bResult = TRUE;</span>
<a href="#l33.268"></a><span id="l33.268">     if (pNameStr.EqualsLiteral(&quot;IPF.Contact&quot;))</span>
<a href="#l33.269"></a><span id="l33.269">       bResult = FALSE;</span>
<a href="#l33.270"></a><span id="l33.270">   }</span>
<a href="#l33.271"></a><span id="l33.271"> </span>
<a href="#l33.272"></a><span id="l33.272" class="difflineminus">-  return( bResult);</span>
<a href="#l33.273"></a><span id="l33.273" class="difflineplus">+  return bResult;</span>
<a href="#l33.274"></a><span id="l33.274"> }</span>
<a href="#l33.275"></a><span id="l33.275"> </span>
<a href="#l33.276"></a><span id="l33.276" class="difflineminus">-BOOL CGetStoreFoldersIter::HandleHierarchyItem( ULONG oType, ULONG cb, LPENTRYID pEntry)</span>
<a href="#l33.277"></a><span id="l33.277" class="difflineplus">+BOOL CGetStoreFoldersIter::HandleHierarchyItem(ULONG oType, ULONG cb, LPENTRYID pEntry)</span>
<a href="#l33.278"></a><span id="l33.278"> {</span>
<a href="#l33.279"></a><span id="l33.279">   if (oType == MAPI_FOLDER) {</span>
<a href="#l33.280"></a><span id="l33.280">     LPMAPIFOLDER pFolder;</span>
<a href="#l33.281"></a><span id="l33.281" class="difflineminus">-    if (m_pApi-&gt;OpenEntry( cb, pEntry, (LPUNKNOWN *) &amp;pFolder)) {</span>
<a href="#l33.282"></a><span id="l33.282" class="difflineplus">+    if (m_pApi-&gt;OpenEntry(cb, pEntry, (LPUNKNOWN *) &amp;pFolder)) {</span>
<a href="#l33.283"></a><span id="l33.283">       LPSPropValue    pVal;</span>
<a href="#l33.284"></a><span id="l33.284">       nsString      name;</span>
<a href="#l33.285"></a><span id="l33.285"> </span>
<a href="#l33.286"></a><span id="l33.286" class="difflineminus">-      pVal = m_pApi-&gt;GetMapiProperty( pFolder, PR_CONTAINER_CLASS);</span>
<a href="#l33.287"></a><span id="l33.287" class="difflineplus">+      pVal = m_pApi-&gt;GetMapiProperty(pFolder, PR_CONTAINER_CLASS);</span>
<a href="#l33.288"></a><span id="l33.288">       if (pVal)</span>
<a href="#l33.289"></a><span id="l33.289" class="difflineminus">-        m_pApi-&gt;GetStringFromProp( pVal, name);</span>
<a href="#l33.290"></a><span id="l33.290" class="difflineplus">+        m_pApi-&gt;GetStringFromProp(pVal, name);</span>
<a href="#l33.291"></a><span id="l33.291">       else</span>
<a href="#l33.292"></a><span id="l33.292">         name.Truncate();</span>
<a href="#l33.293"></a><span id="l33.293"> </span>
<a href="#l33.294"></a><span id="l33.294">       if ((name.IsEmpty() &amp;&amp; m_isMail) || (!ExcludeFolderClass(name.get()))) {</span>
<a href="#l33.295"></a><span id="l33.295" class="difflineminus">-        pVal = m_pApi-&gt;GetMapiProperty( pFolder, PR_DISPLAY_NAME);</span>
<a href="#l33.296"></a><span id="l33.296" class="difflineminus">-        m_pApi-&gt;GetStringFromProp( pVal, name);</span>
<a href="#l33.297"></a><span id="l33.297" class="difflineplus">+        pVal = m_pApi-&gt;GetMapiProperty(pFolder, PR_DISPLAY_NAME);</span>
<a href="#l33.298"></a><span id="l33.298" class="difflineplus">+        m_pApi-&gt;GetStringFromProp(pVal, name);</span>
<a href="#l33.299"></a><span id="l33.299">         CMapiFolder  *pNewFolder = new CMapiFolder(name.get(), cb, pEntry, m_depth);</span>
<a href="#l33.300"></a><span id="l33.300" class="difflineminus">-        m_pList-&gt;AddItem( pNewFolder);</span>
<a href="#l33.301"></a><span id="l33.301" class="difflineplus">+        m_pList-&gt;AddItem(pNewFolder);</span>
<a href="#l33.302"></a><span id="l33.302"> </span>
<a href="#l33.303"></a><span id="l33.303" class="difflineminus">-        pVal = m_pApi-&gt;GetMapiProperty( pFolder, PR_FOLDER_TYPE);</span>
<a href="#l33.304"></a><span id="l33.304" class="difflineplus">+        pVal = m_pApi-&gt;GetMapiProperty(pFolder, PR_FOLDER_TYPE);</span>
<a href="#l33.305"></a><span id="l33.305">         MAPI_TRACE2(&quot;Type: %d, name: %s\n&quot;,</span>
<a href="#l33.306"></a><span id="l33.306">                     m_pApi-&gt;GetLongFromProp(pVal), name.get());</span>
<a href="#l33.307"></a><span id="l33.307" class="difflineminus">-        // m_pApi-&gt;ListProperties( pFolder);</span>
<a href="#l33.308"></a><span id="l33.308" class="difflineplus">+        // m_pApi-&gt;ListProperties(pFolder);</span>
<a href="#l33.309"></a><span id="l33.309"> </span>
<a href="#l33.310"></a><span id="l33.310" class="difflineminus">-        CGetStoreFoldersIter  nextIter( m_pApi, *m_pList, m_depth + 1, m_isMail);</span>
<a href="#l33.311"></a><span id="l33.311" class="difflineminus">-        m_pApi-&gt;IterateHierarchy( &amp;nextIter, pFolder);</span>
<a href="#l33.312"></a><span id="l33.312" class="difflineplus">+        CGetStoreFoldersIter  nextIter(m_pApi, *m_pList, m_depth + 1, m_isMail);</span>
<a href="#l33.313"></a><span id="l33.313" class="difflineplus">+        m_pApi-&gt;IterateHierarchy(&amp;nextIter, pFolder);</span>
<a href="#l33.314"></a><span id="l33.314">       }</span>
<a href="#l33.315"></a><span id="l33.315">       pFolder-&gt;Release();</span>
<a href="#l33.316"></a><span id="l33.316">     }</span>
<a href="#l33.317"></a><span id="l33.317">     else {</span>
<a href="#l33.318"></a><span id="l33.318" class="difflineminus">-      MAPI_TRACE0( &quot;GetStoreFolders - HandleHierarchyItem: Error opening folder entry.\n&quot;);</span>
<a href="#l33.319"></a><span id="l33.319" class="difflineminus">-      return( FALSE);</span>
<a href="#l33.320"></a><span id="l33.320" class="difflineplus">+      MAPI_TRACE0(&quot;GetStoreFolders - HandleHierarchyItem: Error opening folder entry.\n&quot;);</span>
<a href="#l33.321"></a><span id="l33.321" class="difflineplus">+      return FALSE;</span>
<a href="#l33.322"></a><span id="l33.322">     }</span>
<a href="#l33.323"></a><span id="l33.323">   }</span>
<a href="#l33.324"></a><span id="l33.324">   else</span>
<a href="#l33.325"></a><span id="l33.325" class="difflineminus">-    MAPI_TRACE1( &quot;GetStoreFolders - HandleHierarchyItem: Unhandled ObjectType: %ld\n&quot;, oType);</span>
<a href="#l33.326"></a><span id="l33.326" class="difflineminus">-  return( TRUE);</span>
<a href="#l33.327"></a><span id="l33.327" class="difflineplus">+    MAPI_TRACE1(&quot;GetStoreFolders - HandleHierarchyItem: Unhandled ObjectType: %ld\n&quot;, oType);</span>
<a href="#l33.328"></a><span id="l33.328" class="difflineplus">+  return TRUE;</span>
<a href="#l33.329"></a><span id="l33.329"> }</span>
<a href="#l33.330"></a><span id="l33.330"> </span>
<a href="#l33.331"></a><span id="l33.331" class="difflineminus">-BOOL CMapiApi::GetStoreFolders( ULONG cbEid, LPENTRYID lpEid, CMapiFolderList&amp; folders, int startDepth)</span>
<a href="#l33.332"></a><span id="l33.332" class="difflineplus">+BOOL CMapiApi::GetStoreFolders(ULONG cbEid, LPENTRYID lpEid, CMapiFolderList&amp; folders, int startDepth)</span>
<a href="#l33.333"></a><span id="l33.333"> {</span>
<a href="#l33.334"></a><span id="l33.334">   // Fill in the array with the folders in the given store</span>
<a href="#l33.335"></a><span id="l33.335">   if (!m_initialized || !m_lpSession) {</span>
<a href="#l33.336"></a><span id="l33.336" class="difflineminus">-    MAPI_TRACE0( &quot;MAPI not initialized for GetStoreFolders\n&quot;);</span>
<a href="#l33.337"></a><span id="l33.337" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.338"></a><span id="l33.338" class="difflineplus">+    MAPI_TRACE0(&quot;MAPI not initialized for GetStoreFolders\n&quot;);</span>
<a href="#l33.339"></a><span id="l33.339" class="difflineplus">+    return FALSE;</span>
<a href="#l33.340"></a><span id="l33.340">   }</span>
<a href="#l33.341"></a><span id="l33.341"> </span>
<a href="#l33.342"></a><span id="l33.342">   m_lpMdb = NULL;</span>
<a href="#l33.343"></a><span id="l33.343"> </span>
<a href="#l33.344"></a><span id="l33.344" class="difflineminus">-  CMsgStore *    pStore = FindMessageStore( cbEid, lpEid);</span>
<a href="#l33.345"></a><span id="l33.345" class="difflineplus">+  CMsgStore *    pStore = FindMessageStore(cbEid, lpEid);</span>
<a href="#l33.346"></a><span id="l33.346">   BOOL      bResult = FALSE;</span>
<a href="#l33.347"></a><span id="l33.347">   LPSPropValue  pVal;</span>
<a href="#l33.348"></a><span id="l33.348"> </span>
<a href="#l33.349"></a><span id="l33.349" class="difflineminus">-  if (pStore &amp;&amp; pStore-&gt;Open( m_lpSession, &amp;m_lpMdb)) {</span>
<a href="#l33.350"></a><span id="l33.350" class="difflineplus">+  if (pStore &amp;&amp; pStore-&gt;Open(m_lpSession, &amp;m_lpMdb)) {</span>
<a href="#l33.351"></a><span id="l33.351">     // Successful open, do the iteration of the store</span>
<a href="#l33.352"></a><span id="l33.352" class="difflineminus">-    pVal = GetMapiProperty( m_lpMdb, PR_IPM_SUBTREE_ENTRYID);</span>
<a href="#l33.353"></a><span id="l33.353" class="difflineplus">+    pVal = GetMapiProperty(m_lpMdb, PR_IPM_SUBTREE_ENTRYID);</span>
<a href="#l33.354"></a><span id="l33.354">     if (pVal) {</span>
<a href="#l33.355"></a><span id="l33.355">       ULONG      cbEntry;</span>
<a href="#l33.356"></a><span id="l33.356">       LPENTRYID    pEntry;</span>
<a href="#l33.357"></a><span id="l33.357">       LPMAPIFOLDER  lpSubTree = NULL;</span>
<a href="#l33.358"></a><span id="l33.358"> </span>
<a href="#l33.359"></a><span id="l33.359" class="difflineminus">-      if (GetEntryIdFromProp( pVal, cbEntry, pEntry)) {</span>
<a href="#l33.360"></a><span id="l33.360" class="difflineplus">+      if (GetEntryIdFromProp(pVal, cbEntry, pEntry)) {</span>
<a href="#l33.361"></a><span id="l33.361">         // Open up the folder!</span>
<a href="#l33.362"></a><span id="l33.362" class="difflineminus">-        bResult = OpenEntry( cbEntry, pEntry, (LPUNKNOWN *)&amp;lpSubTree);</span>
<a href="#l33.363"></a><span id="l33.363" class="difflineminus">-        MAPIFreeBuffer( pEntry);</span>
<a href="#l33.364"></a><span id="l33.364" class="difflineplus">+        bResult = OpenEntry(cbEntry, pEntry, (LPUNKNOWN *)&amp;lpSubTree);</span>
<a href="#l33.365"></a><span id="l33.365" class="difflineplus">+        MAPIFreeBuffer(pEntry);</span>
<a href="#l33.366"></a><span id="l33.366">         if (bResult &amp;&amp; lpSubTree) {</span>
<a href="#l33.367"></a><span id="l33.367">           // Iterate the subtree with the results going into the folder list</span>
<a href="#l33.368"></a><span id="l33.368" class="difflineminus">-          CGetStoreFoldersIter iterHandler( this, folders, startDepth);</span>
<a href="#l33.369"></a><span id="l33.369" class="difflineminus">-          bResult = IterateHierarchy( &amp;iterHandler, lpSubTree);</span>
<a href="#l33.370"></a><span id="l33.370" class="difflineplus">+          CGetStoreFoldersIter iterHandler(this, folders, startDepth);</span>
<a href="#l33.371"></a><span id="l33.371" class="difflineplus">+          bResult = IterateHierarchy(&amp;iterHandler, lpSubTree);</span>
<a href="#l33.372"></a><span id="l33.372">           lpSubTree-&gt;Release();</span>
<a href="#l33.373"></a><span id="l33.373">         }</span>
<a href="#l33.374"></a><span id="l33.374">         else {</span>
<a href="#l33.375"></a><span id="l33.375" class="difflineminus">-          MAPI_TRACE0( &quot;GetStoreFolders: Error opening sub tree.\n&quot;);</span>
<a href="#l33.376"></a><span id="l33.376" class="difflineplus">+          MAPI_TRACE0(&quot;GetStoreFolders: Error opening sub tree.\n&quot;);</span>
<a href="#l33.377"></a><span id="l33.377">         }</span>
<a href="#l33.378"></a><span id="l33.378">       }</span>
<a href="#l33.379"></a><span id="l33.379">       else {</span>
<a href="#l33.380"></a><span id="l33.380" class="difflineminus">-        MAPI_TRACE0( &quot;GetStoreFolders: Error getting entryID from sub tree property val.\n&quot;);</span>
<a href="#l33.381"></a><span id="l33.381" class="difflineplus">+        MAPI_TRACE0(&quot;GetStoreFolders: Error getting entryID from sub tree property val.\n&quot;);</span>
<a href="#l33.382"></a><span id="l33.382">       }</span>
<a href="#l33.383"></a><span id="l33.383">     }</span>
<a href="#l33.384"></a><span id="l33.384">     else {</span>
<a href="#l33.385"></a><span id="l33.385" class="difflineminus">-      MAPI_TRACE0( &quot;GetStoreFolders: Error getting sub tree property.\n&quot;);</span>
<a href="#l33.386"></a><span id="l33.386" class="difflineplus">+      MAPI_TRACE0(&quot;GetStoreFolders: Error getting sub tree property.\n&quot;);</span>
<a href="#l33.387"></a><span id="l33.387">     }</span>
<a href="#l33.388"></a><span id="l33.388">   }</span>
<a href="#l33.389"></a><span id="l33.389">   else {</span>
<a href="#l33.390"></a><span id="l33.390" class="difflineminus">-    MAPI_TRACE0( &quot;GetStoreFolders: Error opening message store.\n&quot;);</span>
<a href="#l33.391"></a><span id="l33.391" class="difflineplus">+    MAPI_TRACE0(&quot;GetStoreFolders: Error opening message store.\n&quot;);</span>
<a href="#l33.392"></a><span id="l33.392">   }</span>
<a href="#l33.393"></a><span id="l33.393"> </span>
<a href="#l33.394"></a><span id="l33.394" class="difflineminus">-  return( bResult);</span>
<a href="#l33.395"></a><span id="l33.395" class="difflineplus">+  return bResult;</span>
<a href="#l33.396"></a><span id="l33.396"> }</span>
<a href="#l33.397"></a><span id="l33.397"> </span>
<a href="#l33.398"></a><span id="l33.398" class="difflineminus">-BOOL CMapiApi::GetStoreAddressFolders( ULONG cbEid, LPENTRYID lpEid, CMapiFolderList&amp; folders)</span>
<a href="#l33.399"></a><span id="l33.399" class="difflineplus">+BOOL CMapiApi::GetStoreAddressFolders(ULONG cbEid, LPENTRYID lpEid, CMapiFolderList&amp; folders)</span>
<a href="#l33.400"></a><span id="l33.400"> {</span>
<a href="#l33.401"></a><span id="l33.401">   // Fill in the array with the folders in the given store</span>
<a href="#l33.402"></a><span id="l33.402">   if (!m_initialized || !m_lpSession) {</span>
<a href="#l33.403"></a><span id="l33.403" class="difflineminus">-    MAPI_TRACE0( &quot;MAPI not initialized for GetStoreAddressFolders\n&quot;);</span>
<a href="#l33.404"></a><span id="l33.404" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.405"></a><span id="l33.405" class="difflineplus">+    MAPI_TRACE0(&quot;MAPI not initialized for GetStoreAddressFolders\n&quot;);</span>
<a href="#l33.406"></a><span id="l33.406" class="difflineplus">+    return FALSE;</span>
<a href="#l33.407"></a><span id="l33.407">   }</span>
<a href="#l33.408"></a><span id="l33.408"> </span>
<a href="#l33.409"></a><span id="l33.409">   m_lpMdb = NULL;</span>
<a href="#l33.410"></a><span id="l33.410"> </span>
<a href="#l33.411"></a><span id="l33.411" class="difflineminus">-  CMsgStore *    pStore = FindMessageStore( cbEid, lpEid);</span>
<a href="#l33.412"></a><span id="l33.412" class="difflineplus">+  CMsgStore *    pStore = FindMessageStore(cbEid, lpEid);</span>
<a href="#l33.413"></a><span id="l33.413">   BOOL      bResult = FALSE;</span>
<a href="#l33.414"></a><span id="l33.414">   LPSPropValue  pVal;</span>
<a href="#l33.415"></a><span id="l33.415"> </span>
<a href="#l33.416"></a><span id="l33.416" class="difflineminus">-  if (pStore &amp;&amp; pStore-&gt;Open( m_lpSession, &amp;m_lpMdb)) {</span>
<a href="#l33.417"></a><span id="l33.417" class="difflineplus">+  if (pStore &amp;&amp; pStore-&gt;Open(m_lpSession, &amp;m_lpMdb)) {</span>
<a href="#l33.418"></a><span id="l33.418">     // Successful open, do the iteration of the store</span>
<a href="#l33.419"></a><span id="l33.419" class="difflineminus">-    pVal = GetMapiProperty( m_lpMdb, PR_IPM_SUBTREE_ENTRYID);</span>
<a href="#l33.420"></a><span id="l33.420" class="difflineplus">+    pVal = GetMapiProperty(m_lpMdb, PR_IPM_SUBTREE_ENTRYID);</span>
<a href="#l33.421"></a><span id="l33.421">     if (pVal) {</span>
<a href="#l33.422"></a><span id="l33.422">       ULONG      cbEntry;</span>
<a href="#l33.423"></a><span id="l33.423">       LPENTRYID    pEntry;</span>
<a href="#l33.424"></a><span id="l33.424">       LPMAPIFOLDER  lpSubTree = NULL;</span>
<a href="#l33.425"></a><span id="l33.425"> </span>
<a href="#l33.426"></a><span id="l33.426" class="difflineminus">-      if (GetEntryIdFromProp( pVal, cbEntry, pEntry)) {</span>
<a href="#l33.427"></a><span id="l33.427" class="difflineplus">+      if (GetEntryIdFromProp(pVal, cbEntry, pEntry)) {</span>
<a href="#l33.428"></a><span id="l33.428">         // Open up the folder!</span>
<a href="#l33.429"></a><span id="l33.429" class="difflineminus">-        bResult = OpenEntry( cbEntry, pEntry, (LPUNKNOWN *)&amp;lpSubTree);</span>
<a href="#l33.430"></a><span id="l33.430" class="difflineminus">-        MAPIFreeBuffer( pEntry);</span>
<a href="#l33.431"></a><span id="l33.431" class="difflineplus">+        bResult = OpenEntry(cbEntry, pEntry, (LPUNKNOWN *)&amp;lpSubTree);</span>
<a href="#l33.432"></a><span id="l33.432" class="difflineplus">+        MAPIFreeBuffer(pEntry);</span>
<a href="#l33.433"></a><span id="l33.433">         if (bResult &amp;&amp; lpSubTree) {</span>
<a href="#l33.434"></a><span id="l33.434">           // Iterate the subtree with the results going into the folder list</span>
<a href="#l33.435"></a><span id="l33.435" class="difflineminus">-          CGetStoreFoldersIter iterHandler( this, folders, 1, FALSE);</span>
<a href="#l33.436"></a><span id="l33.436" class="difflineminus">-          bResult = IterateHierarchy( &amp;iterHandler, lpSubTree);</span>
<a href="#l33.437"></a><span id="l33.437" class="difflineplus">+          CGetStoreFoldersIter iterHandler(this, folders, 1, FALSE);</span>
<a href="#l33.438"></a><span id="l33.438" class="difflineplus">+          bResult = IterateHierarchy(&amp;iterHandler, lpSubTree);</span>
<a href="#l33.439"></a><span id="l33.439">           lpSubTree-&gt;Release();</span>
<a href="#l33.440"></a><span id="l33.440">         }</span>
<a href="#l33.441"></a><span id="l33.441">         else {</span>
<a href="#l33.442"></a><span id="l33.442" class="difflineminus">-          MAPI_TRACE0( &quot;GetStoreAddressFolders: Error opening sub tree.\n&quot;);</span>
<a href="#l33.443"></a><span id="l33.443" class="difflineplus">+          MAPI_TRACE0(&quot;GetStoreAddressFolders: Error opening sub tree.\n&quot;);</span>
<a href="#l33.444"></a><span id="l33.444">         }</span>
<a href="#l33.445"></a><span id="l33.445">       }</span>
<a href="#l33.446"></a><span id="l33.446">       else {</span>
<a href="#l33.447"></a><span id="l33.447" class="difflineminus">-        MAPI_TRACE0( &quot;GetStoreAddressFolders: Error getting entryID from sub tree property val.\n&quot;);</span>
<a href="#l33.448"></a><span id="l33.448" class="difflineplus">+        MAPI_TRACE0(&quot;GetStoreAddressFolders: Error getting entryID from sub tree property val.\n&quot;);</span>
<a href="#l33.449"></a><span id="l33.449">       }</span>
<a href="#l33.450"></a><span id="l33.450">     }</span>
<a href="#l33.451"></a><span id="l33.451">     else {</span>
<a href="#l33.452"></a><span id="l33.452" class="difflineminus">-      MAPI_TRACE0( &quot;GetStoreAddressFolders: Error getting sub tree property.\n&quot;);</span>
<a href="#l33.453"></a><span id="l33.453" class="difflineplus">+      MAPI_TRACE0(&quot;GetStoreAddressFolders: Error getting sub tree property.\n&quot;);</span>
<a href="#l33.454"></a><span id="l33.454">     }</span>
<a href="#l33.455"></a><span id="l33.455">   }</span>
<a href="#l33.456"></a><span id="l33.456">   else</span>
<a href="#l33.457"></a><span id="l33.457" class="difflineminus">-    MAPI_TRACE0( &quot;GetStoreAddressFolders: Error opening message store.\n&quot;);</span>
<a href="#l33.458"></a><span id="l33.458" class="difflineplus">+    MAPI_TRACE0(&quot;GetStoreAddressFolders: Error opening message store.\n&quot;);</span>
<a href="#l33.459"></a><span id="l33.459"> </span>
<a href="#l33.460"></a><span id="l33.460" class="difflineminus">-  return( bResult);</span>
<a href="#l33.461"></a><span id="l33.461" class="difflineplus">+  return bResult;</span>
<a href="#l33.462"></a><span id="l33.462"> }</span>
<a href="#l33.463"></a><span id="l33.463"> </span>
<a href="#l33.464"></a><span id="l33.464"> </span>
<a href="#l33.465"></a><span id="l33.465" class="difflineminus">-BOOL CMapiApi::OpenStore( ULONG cbEid, LPENTRYID lpEid, LPMDB *ppMdb)</span>
<a href="#l33.466"></a><span id="l33.466" class="difflineplus">+BOOL CMapiApi::OpenStore(ULONG cbEid, LPENTRYID lpEid, LPMDB *ppMdb)</span>
<a href="#l33.467"></a><span id="l33.467"> {</span>
<a href="#l33.468"></a><span id="l33.468">   if (!m_lpSession) {</span>
<a href="#l33.469"></a><span id="l33.469" class="difflineminus">-    MAPI_TRACE0( &quot;OpenStore called before a session was opened\n&quot;);</span>
<a href="#l33.470"></a><span id="l33.470" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.471"></a><span id="l33.471" class="difflineplus">+    MAPI_TRACE0(&quot;OpenStore called before a session was opened\n&quot;);</span>
<a href="#l33.472"></a><span id="l33.472" class="difflineplus">+    return FALSE;</span>
<a href="#l33.473"></a><span id="l33.473">   }</span>
<a href="#l33.474"></a><span id="l33.474"> </span>
<a href="#l33.475"></a><span id="l33.475" class="difflineminus">-  CMsgStore *    pStore = FindMessageStore( cbEid, lpEid);</span>
<a href="#l33.476"></a><span id="l33.476" class="difflineminus">-  if (pStore &amp;&amp; pStore-&gt;Open( m_lpSession, ppMdb))</span>
<a href="#l33.477"></a><span id="l33.477" class="difflineminus">-    return( TRUE);</span>
<a href="#l33.478"></a><span id="l33.478" class="difflineminus">-  return( FALSE);</span>
<a href="#l33.479"></a><span id="l33.479" class="difflineplus">+  CMsgStore *    pStore = FindMessageStore(cbEid, lpEid);</span>
<a href="#l33.480"></a><span id="l33.480" class="difflineplus">+  if (pStore &amp;&amp; pStore-&gt;Open(m_lpSession, ppMdb))</span>
<a href="#l33.481"></a><span id="l33.481" class="difflineplus">+    return TRUE;</span>
<a href="#l33.482"></a><span id="l33.482" class="difflineplus">+  return FALSE;</span>
<a href="#l33.483"></a><span id="l33.483"> }</span>
<a href="#l33.484"></a><span id="l33.484"> </span>
<a href="#l33.485"></a><span id="l33.485"> </span>
<a href="#l33.486"></a><span id="l33.486" class="difflineminus">-BOOL CMapiApi::OpenEntry( ULONG cbEntry, LPENTRYID pEntryId, LPUNKNOWN *ppOpen)</span>
<a href="#l33.487"></a><span id="l33.487" class="difflineplus">+BOOL CMapiApi::OpenEntry(ULONG cbEntry, LPENTRYID pEntryId, LPUNKNOWN *ppOpen)</span>
<a href="#l33.488"></a><span id="l33.488"> {</span>
<a href="#l33.489"></a><span id="l33.489">   if (!m_lpMdb) {</span>
<a href="#l33.490"></a><span id="l33.490" class="difflineminus">-    MAPI_TRACE0( &quot;OpenEntry called before the message store is open\n&quot;);</span>
<a href="#l33.491"></a><span id="l33.491" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.492"></a><span id="l33.492" class="difflineplus">+    MAPI_TRACE0(&quot;OpenEntry called before the message store is open\n&quot;);</span>
<a href="#l33.493"></a><span id="l33.493" class="difflineplus">+    return FALSE;</span>
<a href="#l33.494"></a><span id="l33.494">   }</span>
<a href="#l33.495"></a><span id="l33.495"> </span>
<a href="#l33.496"></a><span id="l33.496" class="difflineminus">-  return( OpenMdbEntry( m_lpMdb, cbEntry, pEntryId, ppOpen));</span>
<a href="#l33.497"></a><span id="l33.497" class="difflineplus">+  return OpenMdbEntry(m_lpMdb, cbEntry, pEntryId, ppOpen);</span>
<a href="#l33.498"></a><span id="l33.498"> }</span>
<a href="#l33.499"></a><span id="l33.499"> </span>
<a href="#l33.500"></a><span id="l33.500" class="difflineminus">-BOOL CMapiApi::OpenMdbEntry( LPMDB lpMdb, ULONG cbEntry, LPENTRYID pEntryId, LPUNKNOWN *ppOpen)</span>
<a href="#l33.501"></a><span id="l33.501" class="difflineplus">+BOOL CMapiApi::OpenMdbEntry(LPMDB lpMdb, ULONG cbEntry, LPENTRYID pEntryId, LPUNKNOWN *ppOpen)</span>
<a href="#l33.502"></a><span id="l33.502"> {</span>
<a href="#l33.503"></a><span id="l33.503">   ULONG    ulObjType;</span>
<a href="#l33.504"></a><span id="l33.504">   HRESULT    hr;</span>
<a href="#l33.505"></a><span id="l33.505">   hr = m_lpSession-&gt;OpenEntry(cbEntry,</span>
<a href="#l33.506"></a><span id="l33.506">               pEntryId,</span>
<a href="#l33.507"></a><span id="l33.507">               NULL,</span>
<a href="#l33.508"></a><span id="l33.508">               0,</span>
<a href="#l33.509"></a><span id="l33.509">               &amp;ulObjType,</span>
<a href="#l33.510"></a><span id="l33.510">               (LPUNKNOWN *) ppOpen);</span>
<a href="#l33.511"></a><span id="l33.511">   if (FAILED(hr)) {</span>
<a href="#l33.512"></a><span id="l33.512" class="difflineminus">-    MAPI_TRACE2( &quot;OpenMdbEntry failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.513"></a><span id="l33.513" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.514"></a><span id="l33.514" class="difflineplus">+    MAPI_TRACE2(&quot;OpenMdbEntry failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.515"></a><span id="l33.515" class="difflineplus">+    return FALSE;</span>
<a href="#l33.516"></a><span id="l33.516">   }</span>
<a href="#l33.517"></a><span id="l33.517" class="difflineminus">-  return( TRUE);</span>
<a href="#l33.518"></a><span id="l33.518" class="difflineplus">+  return TRUE;</span>
<a href="#l33.519"></a><span id="l33.519"> }</span>
<a href="#l33.520"></a><span id="l33.520"> </span>
<a href="#l33.521"></a><span id="l33.521"> enum {</span>
<a href="#l33.522"></a><span id="l33.522">   ieidPR_ENTRYID = 0,</span>
<a href="#l33.523"></a><span id="l33.523">   ieidPR_OBJECT_TYPE,</span>
<a href="#l33.524"></a><span id="l33.524">   ieidMax</span>
<a href="#l33.525"></a><span id="l33.525"> };</span>
<a href="#l33.526"></a><span id="l33.526"> </span>
<a href="#l33.527"></a><span id="l33.527" class="difflineat">@@ -639,142 +639,142 @@ static const SizedSPropTagArray(ieidMax,</span>
<a href="#l33.528"></a><span id="l33.528"> {</span>
<a href="#l33.529"></a><span id="l33.529">   ieidMax,</span>
<a href="#l33.530"></a><span id="l33.530">   {</span>
<a href="#l33.531"></a><span id="l33.531">       PR_ENTRYID,</span>
<a href="#l33.532"></a><span id="l33.532">     PR_OBJECT_TYPE,</span>
<a href="#l33.533"></a><span id="l33.533">   }</span>
<a href="#l33.534"></a><span id="l33.534"> };</span>
<a href="#l33.535"></a><span id="l33.535"> </span>
<a href="#l33.536"></a><span id="l33.536" class="difflineminus">-BOOL CMapiApi::IterateContents( CMapiContentIter *pIter, LPMAPIFOLDER pFolder, ULONG flags)</span>
<a href="#l33.537"></a><span id="l33.537" class="difflineplus">+BOOL CMapiApi::IterateContents(CMapiContentIter *pIter, LPMAPIFOLDER pFolder, ULONG flags)</span>
<a href="#l33.538"></a><span id="l33.538"> {</span>
<a href="#l33.539"></a><span id="l33.539">   // flags can be 0 or MAPI_ASSOCIATED</span>
<a href="#l33.540"></a><span id="l33.540">   // MAPI_ASSOCIATED is usually used for forms and views</span>
<a href="#l33.541"></a><span id="l33.541"> </span>
<a href="#l33.542"></a><span id="l33.542">   HRESULT    hr;</span>
<a href="#l33.543"></a><span id="l33.543">   LPMAPITABLE  lpTable;</span>
<a href="#l33.544"></a><span id="l33.544" class="difflineminus">-  hr = pFolder-&gt;GetContentsTable( flags, &amp;lpTable);</span>
<a href="#l33.545"></a><span id="l33.545" class="difflineplus">+  hr = pFolder-&gt;GetContentsTable(flags, &amp;lpTable);</span>
<a href="#l33.546"></a><span id="l33.546">   if (FAILED(hr)) {</span>
<a href="#l33.547"></a><span id="l33.547" class="difflineminus">-    MAPI_TRACE2( &quot;GetContentsTable failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.548"></a><span id="l33.548" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.549"></a><span id="l33.549" class="difflineplus">+    MAPI_TRACE2(&quot;GetContentsTable failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.550"></a><span id="l33.550" class="difflineplus">+    return FALSE;</span>
<a href="#l33.551"></a><span id="l33.551">   }</span>
<a href="#l33.552"></a><span id="l33.552"> </span>
<a href="#l33.553"></a><span id="l33.553">   ULONG rowCount;</span>
<a href="#l33.554"></a><span id="l33.554" class="difflineminus">-  hr = lpTable-&gt;GetRowCount( 0, &amp;rowCount);</span>
<a href="#l33.555"></a><span id="l33.555" class="difflineplus">+  hr = lpTable-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l33.556"></a><span id="l33.556">   if (!rowCount) {</span>
<a href="#l33.557"></a><span id="l33.557" class="difflineminus">-    MAPI_TRACE0( &quot;  Empty Table\n&quot;);</span>
<a href="#l33.558"></a><span id="l33.558" class="difflineplus">+    MAPI_TRACE0(&quot;  Empty Table\n&quot;);</span>
<a href="#l33.559"></a><span id="l33.559">   }</span>
<a href="#l33.560"></a><span id="l33.560"> </span>
<a href="#l33.561"></a><span id="l33.561" class="difflineminus">-  hr = lpTable-&gt;SetColumns( (LPSPropTagArray)&amp;ptaEid, 0);</span>
<a href="#l33.562"></a><span id="l33.562" class="difflineplus">+  hr = lpTable-&gt;SetColumns((LPSPropTagArray)&amp;ptaEid, 0);</span>
<a href="#l33.563"></a><span id="l33.563">   if (FAILED(hr)) {</span>
<a href="#l33.564"></a><span id="l33.564">     lpTable-&gt;Release();</span>
<a href="#l33.565"></a><span id="l33.565" class="difflineminus">-    MAPI_TRACE2( &quot;SetColumns failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.566"></a><span id="l33.566" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.567"></a><span id="l33.567" class="difflineplus">+    MAPI_TRACE2(&quot;SetColumns failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.568"></a><span id="l33.568" class="difflineplus">+    return FALSE;</span>
<a href="#l33.569"></a><span id="l33.569">   }</span>
<a href="#l33.570"></a><span id="l33.570"> </span>
<a href="#l33.571"></a><span id="l33.571" class="difflineminus">-  hr = lpTable-&gt;SeekRow( BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l33.572"></a><span id="l33.572" class="difflineplus">+  hr = lpTable-&gt;SeekRow(BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l33.573"></a><span id="l33.573">   if (FAILED(hr)) {</span>
<a href="#l33.574"></a><span id="l33.574">     lpTable-&gt;Release();</span>
<a href="#l33.575"></a><span id="l33.575" class="difflineminus">-    MAPI_TRACE2( &quot;SeekRow failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.576"></a><span id="l33.576" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.577"></a><span id="l33.577" class="difflineplus">+    MAPI_TRACE2(&quot;SeekRow failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.578"></a><span id="l33.578" class="difflineplus">+    return FALSE;</span>
<a href="#l33.579"></a><span id="l33.579">   }</span>
<a href="#l33.580"></a><span id="l33.580"> </span>
<a href="#l33.581"></a><span id="l33.581">   int      cNumRows = 0;</span>
<a href="#l33.582"></a><span id="l33.582">   LPSRowSet  lpRow;</span>
<a href="#l33.583"></a><span id="l33.583">   BOOL    keepGoing = TRUE;</span>
<a href="#l33.584"></a><span id="l33.584">   BOOL    bResult = TRUE;</span>
<a href="#l33.585"></a><span id="l33.585">   do {</span>
<a href="#l33.586"></a><span id="l33.586">     lpRow = NULL;</span>
<a href="#l33.587"></a><span id="l33.587" class="difflineminus">-    hr = lpTable-&gt;QueryRows( 1, 0, &amp;lpRow);</span>
<a href="#l33.588"></a><span id="l33.588" class="difflineplus">+    hr = lpTable-&gt;QueryRows(1, 0, &amp;lpRow);</span>
<a href="#l33.589"></a><span id="l33.589">     if(HR_FAILED(hr)) {</span>
<a href="#l33.590"></a><span id="l33.590" class="difflineminus">-      MAPI_TRACE2( &quot;QueryRows failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.591"></a><span id="l33.591" class="difflineplus">+      MAPI_TRACE2(&quot;QueryRows failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.592"></a><span id="l33.592">       bResult = FALSE;</span>
<a href="#l33.593"></a><span id="l33.593">       break;</span>
<a href="#l33.594"></a><span id="l33.594">     }</span>
<a href="#l33.595"></a><span id="l33.595"> </span>
<a href="#l33.596"></a><span id="l33.596">     if(lpRow) {</span>
<a href="#l33.597"></a><span id="l33.597">       cNumRows = lpRow-&gt;cRows;</span>
<a href="#l33.598"></a><span id="l33.598">       if (cNumRows) {</span>
<a href="#l33.599"></a><span id="l33.599">         LPENTRYID  lpEID = (LPENTRYID) lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l33.600"></a><span id="l33.600">         ULONG    cbEID = lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l33.601"></a><span id="l33.601">         ULONG    oType = lpRow-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.ul;</span>
<a href="#l33.602"></a><span id="l33.602" class="difflineminus">-        keepGoing = HandleContentsItem( oType, cbEID, lpEID);</span>
<a href="#l33.603"></a><span id="l33.603" class="difflineminus">-        MAPI_TRACE1( &quot;    ObjectType: %ld\n&quot;, oType);</span>
<a href="#l33.604"></a><span id="l33.604" class="difflineplus">+        keepGoing = HandleContentsItem(oType, cbEID, lpEID);</span>
<a href="#l33.605"></a><span id="l33.605" class="difflineplus">+        MAPI_TRACE1(&quot;    ObjectType: %ld\n&quot;, oType);</span>
<a href="#l33.606"></a><span id="l33.606">       }</span>
<a href="#l33.607"></a><span id="l33.607" class="difflineminus">-      FreeProws( lpRow);</span>
<a href="#l33.608"></a><span id="l33.608" class="difflineplus">+      FreeProws(lpRow);</span>
<a href="#l33.609"></a><span id="l33.609">     }</span>
<a href="#l33.610"></a><span id="l33.610"> </span>
<a href="#l33.611"></a><span id="l33.611" class="difflineminus">-  } while ( SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRow &amp;&amp; keepGoing);</span>
<a href="#l33.612"></a><span id="l33.612" class="difflineplus">+  } while (SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRow &amp;&amp; keepGoing);</span>
<a href="#l33.613"></a><span id="l33.613"> </span>
<a href="#l33.614"></a><span id="l33.614">   lpTable-&gt;Release();</span>
<a href="#l33.615"></a><span id="l33.615" class="difflineminus">-  return( bResult);</span>
<a href="#l33.616"></a><span id="l33.616" class="difflineplus">+  return bResult;</span>
<a href="#l33.617"></a><span id="l33.617"> }</span>
<a href="#l33.618"></a><span id="l33.618"> </span>
<a href="#l33.619"></a><span id="l33.619" class="difflineminus">-BOOL CMapiApi::HandleContentsItem( ULONG oType, ULONG cb, LPENTRYID pEntry)</span>
<a href="#l33.620"></a><span id="l33.620" class="difflineplus">+BOOL CMapiApi::HandleContentsItem(ULONG oType, ULONG cb, LPENTRYID pEntry)</span>
<a href="#l33.621"></a><span id="l33.621"> {</span>
<a href="#l33.622"></a><span id="l33.622">   if (oType == MAPI_MESSAGE) {</span>
<a href="#l33.623"></a><span id="l33.623">     LPMESSAGE pMsg;</span>
<a href="#l33.624"></a><span id="l33.624" class="difflineminus">-    if (OpenEntry( cb, pEntry, (LPUNKNOWN *) &amp;pMsg)) {</span>
<a href="#l33.625"></a><span id="l33.625" class="difflineplus">+    if (OpenEntry(cb, pEntry, (LPUNKNOWN *) &amp;pMsg)) {</span>
<a href="#l33.626"></a><span id="l33.626">       LPSPropValue pVal;</span>
<a href="#l33.627"></a><span id="l33.627" class="difflineminus">-      pVal = GetMapiProperty( pMsg, PR_SUBJECT);</span>
<a href="#l33.628"></a><span id="l33.628" class="difflineminus">-      ReportStringProp( &quot;PR_SUBJECT:&quot;, pVal);</span>
<a href="#l33.629"></a><span id="l33.629" class="difflineminus">-      pVal = GetMapiProperty( pMsg, PR_DISPLAY_BCC);</span>
<a href="#l33.630"></a><span id="l33.630" class="difflineminus">-      ReportStringProp( &quot;PR_DISPLAY_BCC:&quot;, pVal);</span>
<a href="#l33.631"></a><span id="l33.631" class="difflineminus">-      pVal = GetMapiProperty( pMsg, PR_DISPLAY_CC);</span>
<a href="#l33.632"></a><span id="l33.632" class="difflineminus">-      ReportStringProp( &quot;PR_DISPLAY_CC:&quot;, pVal);</span>
<a href="#l33.633"></a><span id="l33.633" class="difflineminus">-      pVal = GetMapiProperty( pMsg, PR_DISPLAY_TO);</span>
<a href="#l33.634"></a><span id="l33.634" class="difflineminus">-      ReportStringProp( &quot;PR_DISPLAY_TO:&quot;, pVal);</span>
<a href="#l33.635"></a><span id="l33.635" class="difflineminus">-      pVal = GetMapiProperty( pMsg, PR_MESSAGE_CLASS);</span>
<a href="#l33.636"></a><span id="l33.636" class="difflineminus">-      ReportStringProp( &quot;PR_MESSAGE_CLASS:&quot;, pVal);</span>
<a href="#l33.637"></a><span id="l33.637" class="difflineminus">-      ListProperties( pMsg);</span>
<a href="#l33.638"></a><span id="l33.638" class="difflineplus">+      pVal = GetMapiProperty(pMsg, PR_SUBJECT);</span>
<a href="#l33.639"></a><span id="l33.639" class="difflineplus">+      ReportStringProp(&quot;PR_SUBJECT:&quot;, pVal);</span>
<a href="#l33.640"></a><span id="l33.640" class="difflineplus">+      pVal = GetMapiProperty(pMsg, PR_DISPLAY_BCC);</span>
<a href="#l33.641"></a><span id="l33.641" class="difflineplus">+      ReportStringProp(&quot;PR_DISPLAY_BCC:&quot;, pVal);</span>
<a href="#l33.642"></a><span id="l33.642" class="difflineplus">+      pVal = GetMapiProperty(pMsg, PR_DISPLAY_CC);</span>
<a href="#l33.643"></a><span id="l33.643" class="difflineplus">+      ReportStringProp(&quot;PR_DISPLAY_CC:&quot;, pVal);</span>
<a href="#l33.644"></a><span id="l33.644" class="difflineplus">+      pVal = GetMapiProperty(pMsg, PR_DISPLAY_TO);</span>
<a href="#l33.645"></a><span id="l33.645" class="difflineplus">+      ReportStringProp(&quot;PR_DISPLAY_TO:&quot;, pVal);</span>
<a href="#l33.646"></a><span id="l33.646" class="difflineplus">+      pVal = GetMapiProperty(pMsg, PR_MESSAGE_CLASS);</span>
<a href="#l33.647"></a><span id="l33.647" class="difflineplus">+      ReportStringProp(&quot;PR_MESSAGE_CLASS:&quot;, pVal);</span>
<a href="#l33.648"></a><span id="l33.648" class="difflineplus">+      ListProperties(pMsg);</span>
<a href="#l33.649"></a><span id="l33.649">       pMsg-&gt;Release();</span>
<a href="#l33.650"></a><span id="l33.650">     }</span>
<a href="#l33.651"></a><span id="l33.651">     else {</span>
<a href="#l33.652"></a><span id="l33.652" class="difflineminus">-      MAPI_TRACE0( &quot;    Folder type - error opening\n&quot;);</span>
<a href="#l33.653"></a><span id="l33.653" class="difflineplus">+      MAPI_TRACE0(&quot;    Folder type - error opening\n&quot;);</span>
<a href="#l33.654"></a><span id="l33.654">     }</span>
<a href="#l33.655"></a><span id="l33.655">   }</span>
<a href="#l33.656"></a><span id="l33.656">   else</span>
<a href="#l33.657"></a><span id="l33.657" class="difflineminus">-    MAPI_TRACE1( &quot;    ObjectType: %ld\n&quot;, oType);</span>
<a href="#l33.658"></a><span id="l33.658" class="difflineplus">+    MAPI_TRACE1(&quot;    ObjectType: %ld\n&quot;, oType);</span>
<a href="#l33.659"></a><span id="l33.659"> </span>
<a href="#l33.660"></a><span id="l33.660" class="difflineminus">-  return( TRUE);</span>
<a href="#l33.661"></a><span id="l33.661" class="difflineplus">+  return TRUE;</span>
<a href="#l33.662"></a><span id="l33.662"> }</span>
<a href="#l33.663"></a><span id="l33.663"> </span>
<a href="#l33.664"></a><span id="l33.664" class="difflineminus">-void CMapiApi::ListProperties( LPMAPIPROP lpProp, BOOL getValues)</span>
<a href="#l33.665"></a><span id="l33.665" class="difflineplus">+void CMapiApi::ListProperties(LPMAPIPROP lpProp, BOOL getValues)</span>
<a href="#l33.666"></a><span id="l33.666"> {</span>
<a href="#l33.667"></a><span id="l33.667">   LPSPropTagArray    pArray;</span>
<a href="#l33.668"></a><span id="l33.668" class="difflineminus">-  HRESULT        hr = lpProp-&gt;GetPropList( 0, &amp;pArray);</span>
<a href="#l33.669"></a><span id="l33.669" class="difflineplus">+  HRESULT        hr = lpProp-&gt;GetPropList(0, &amp;pArray);</span>
<a href="#l33.670"></a><span id="l33.670">   if (FAILED(hr)) {</span>
<a href="#l33.671"></a><span id="l33.671" class="difflineminus">-    MAPI_TRACE0( &quot;    Unable to retrieve property list\n&quot;);</span>
<a href="#l33.672"></a><span id="l33.672" class="difflineplus">+    MAPI_TRACE0(&quot;    Unable to retrieve property list\n&quot;);</span>
<a href="#l33.673"></a><span id="l33.673">     return;</span>
<a href="#l33.674"></a><span id="l33.674">   }</span>
<a href="#l33.675"></a><span id="l33.675">   ULONG count = 0;</span>
<a href="#l33.676"></a><span id="l33.676">   LPMAPINAMEID FAR * lppPropNames;</span>
<a href="#l33.677"></a><span id="l33.677">   SPropTagArray    tagArray;</span>
<a href="#l33.678"></a><span id="l33.678">   LPSPropTagArray lpTagArray = &amp;tagArray;</span>
<a href="#l33.679"></a><span id="l33.679">   tagArray.cValues = (ULONG)1;</span>
<a href="#l33.680"></a><span id="l33.680">   nsCString  desc;</span>
<a href="#l33.681"></a><span id="l33.681">   for (ULONG i = 0; i &lt; pArray-&gt;cValues; i++) {</span>
<a href="#l33.682"></a><span id="l33.682" class="difflineminus">-    GetPropTagName( pArray-&gt;aulPropTag[i], desc);</span>
<a href="#l33.683"></a><span id="l33.683" class="difflineplus">+    GetPropTagName(pArray-&gt;aulPropTag[i], desc);</span>
<a href="#l33.684"></a><span id="l33.684">     if (getValues) {</span>
<a href="#l33.685"></a><span id="l33.685">       tagArray.aulPropTag[0] = pArray-&gt;aulPropTag[i];</span>
<a href="#l33.686"></a><span id="l33.686">       hr = lpProp-&gt;GetNamesFromIDs(&amp;lpTagArray, nsnull, 0, &amp;count, &amp;lppPropNames);</span>
<a href="#l33.687"></a><span id="l33.687">       if (hr == S_OK)</span>
<a href="#l33.688"></a><span id="l33.688">         MAPIFreeBuffer(lppPropNames);</span>
<a href="#l33.689"></a><span id="l33.689"> </span>
<a href="#l33.690"></a><span id="l33.690" class="difflineminus">-      LPSPropValue pVal = GetMapiProperty( lpProp, pArray-&gt;aulPropTag[i]);</span>
<a href="#l33.691"></a><span id="l33.691" class="difflineplus">+      LPSPropValue pVal = GetMapiProperty(lpProp, pArray-&gt;aulPropTag[i]);</span>
<a href="#l33.692"></a><span id="l33.692">       if (pVal) {</span>
<a href="#l33.693"></a><span id="l33.693">         desc += &quot;, &quot;;</span>
<a href="#l33.694"></a><span id="l33.694" class="difflineminus">-        ListPropertyValue( pVal, desc);</span>
<a href="#l33.695"></a><span id="l33.695" class="difflineminus">-        MAPIFreeBuffer( pVal);</span>
<a href="#l33.696"></a><span id="l33.696" class="difflineplus">+        ListPropertyValue(pVal, desc);</span>
<a href="#l33.697"></a><span id="l33.697" class="difflineplus">+        MAPIFreeBuffer(pVal);</span>
<a href="#l33.698"></a><span id="l33.698">       }</span>
<a href="#l33.699"></a><span id="l33.699">     }</span>
<a href="#l33.700"></a><span id="l33.700">     MAPI_TRACE2(&quot;    Tag #%d: %s\n&quot;, (int) i, desc.get());</span>
<a href="#l33.701"></a><span id="l33.701">   }</span>
<a href="#l33.702"></a><span id="l33.702"> </span>
<a href="#l33.703"></a><span id="l33.703" class="difflineminus">-  MAPIFreeBuffer( pArray);</span>
<a href="#l33.704"></a><span id="l33.704" class="difflineplus">+  MAPIFreeBuffer(pArray);</span>
<a href="#l33.705"></a><span id="l33.705"> }</span>
<a href="#l33.706"></a><span id="l33.706"> </span>
<a href="#l33.707"></a><span id="l33.707"> ULONG CMapiApi::GetEmailPropertyTag(LPMAPIPROP lpProp, LONG nameID)</span>
<a href="#l33.708"></a><span id="l33.708"> {</span>
<a href="#l33.709"></a><span id="l33.709"> static GUID emailGUID = {</span>
<a href="#l33.710"></a><span id="l33.710">    0x00062004, 0x0000, 0x0000, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x46</span>
<a href="#l33.711"></a><span id="l33.711"> };</span>
<a href="#l33.712"></a><span id="l33.712"> </span>
<a href="#l33.713"></a><span id="l33.713" class="difflineat">@@ -792,116 +792,114 @@ static GUID emailGUID = {</span>
<a href="#l33.714"></a><span id="l33.714">     ULONG lTag = lpMailTagArray-&gt;aulPropTag[0];</span>
<a href="#l33.715"></a><span id="l33.715">     MAPIFreeBuffer(lpMailTagArray);</span>
<a href="#l33.716"></a><span id="l33.716">     return lTag;</span>
<a href="#l33.717"></a><span id="l33.717">   }</span>
<a href="#l33.718"></a><span id="l33.718">   else</span>
<a href="#l33.719"></a><span id="l33.719">     return 0L;</span>
<a href="#l33.720"></a><span id="l33.720"> }</span>
<a href="#l33.721"></a><span id="l33.721"> </span>
<a href="#l33.722"></a><span id="l33.722" class="difflineminus">-BOOL CMapiApi::HandleHierarchyItem( ULONG oType, ULONG cb, LPENTRYID pEntry)</span>
<a href="#l33.723"></a><span id="l33.723" class="difflineplus">+BOOL CMapiApi::HandleHierarchyItem(ULONG oType, ULONG cb, LPENTRYID pEntry)</span>
<a href="#l33.724"></a><span id="l33.724"> {</span>
<a href="#l33.725"></a><span id="l33.725">   if (oType == MAPI_FOLDER) {</span>
<a href="#l33.726"></a><span id="l33.726">     LPMAPIFOLDER pFolder;</span>
<a href="#l33.727"></a><span id="l33.727" class="difflineminus">-    if (OpenEntry( cb, pEntry, (LPUNKNOWN *) &amp;pFolder)) {</span>
<a href="#l33.728"></a><span id="l33.728" class="difflineplus">+    if (OpenEntry(cb, pEntry, (LPUNKNOWN *) &amp;pFolder)) {</span>
<a href="#l33.729"></a><span id="l33.729">       LPSPropValue pVal;</span>
<a href="#l33.730"></a><span id="l33.730" class="difflineminus">-      pVal = GetMapiProperty( pFolder, PR_DISPLAY_NAME);</span>
<a href="#l33.731"></a><span id="l33.731" class="difflineminus">-      ReportStringProp( &quot;Folder name:&quot;, pVal);</span>
<a href="#l33.732"></a><span id="l33.732" class="difflineminus">-      IterateContents( NULL, pFolder);</span>
<a href="#l33.733"></a><span id="l33.733" class="difflineminus">-      IterateHierarchy( NULL, pFolder);</span>
<a href="#l33.734"></a><span id="l33.734" class="difflineplus">+      pVal = GetMapiProperty(pFolder, PR_DISPLAY_NAME);</span>
<a href="#l33.735"></a><span id="l33.735" class="difflineplus">+      ReportStringProp(&quot;Folder name:&quot;, pVal);</span>
<a href="#l33.736"></a><span id="l33.736" class="difflineplus">+      IterateContents(NULL, pFolder);</span>
<a href="#l33.737"></a><span id="l33.737" class="difflineplus">+      IterateHierarchy(NULL, pFolder);</span>
<a href="#l33.738"></a><span id="l33.738">       pFolder-&gt;Release();</span>
<a href="#l33.739"></a><span id="l33.739">     }</span>
<a href="#l33.740"></a><span id="l33.740">     else {</span>
<a href="#l33.741"></a><span id="l33.741" class="difflineminus">-      MAPI_TRACE0( &quot;    Folder type - error opening\n&quot;);</span>
<a href="#l33.742"></a><span id="l33.742" class="difflineplus">+      MAPI_TRACE0(&quot;    Folder type - error opening\n&quot;);</span>
<a href="#l33.743"></a><span id="l33.743">     }</span>
<a href="#l33.744"></a><span id="l33.744">   }</span>
<a href="#l33.745"></a><span id="l33.745">   else</span>
<a href="#l33.746"></a><span id="l33.746" class="difflineminus">-    MAPI_TRACE1( &quot;    ObjectType: %ld\n&quot;, oType);</span>
<a href="#l33.747"></a><span id="l33.747" class="difflineplus">+    MAPI_TRACE1(&quot;    ObjectType: %ld\n&quot;, oType);</span>
<a href="#l33.748"></a><span id="l33.748"> </span>
<a href="#l33.749"></a><span id="l33.749" class="difflineminus">-  return( TRUE);</span>
<a href="#l33.750"></a><span id="l33.750" class="difflineplus">+  return TRUE;</span>
<a href="#l33.751"></a><span id="l33.751"> }</span>
<a href="#l33.752"></a><span id="l33.752"> </span>
<a href="#l33.753"></a><span id="l33.753" class="difflineminus">-BOOL CMapiApi::IterateHierarchy( CMapiHierarchyIter *pIter, LPMAPIFOLDER pFolder, ULONG flags)</span>
<a href="#l33.754"></a><span id="l33.754" class="difflineplus">+BOOL CMapiApi::IterateHierarchy(CMapiHierarchyIter *pIter, LPMAPIFOLDER pFolder, ULONG flags)</span>
<a href="#l33.755"></a><span id="l33.755"> {</span>
<a href="#l33.756"></a><span id="l33.756">   // flags can be CONVENIENT_DEPTH or 0</span>
<a href="#l33.757"></a><span id="l33.757">   // CONVENIENT_DEPTH will return all depths I believe instead</span>
<a href="#l33.758"></a><span id="l33.758">   // of just children</span>
<a href="#l33.759"></a><span id="l33.759">   HRESULT    hr;</span>
<a href="#l33.760"></a><span id="l33.760">   LPMAPITABLE  lpTable;</span>
<a href="#l33.761"></a><span id="l33.761" class="difflineminus">-  hr = pFolder-&gt;GetHierarchyTable( flags, &amp;lpTable);</span>
<a href="#l33.762"></a><span id="l33.762" class="difflineplus">+  hr = pFolder-&gt;GetHierarchyTable(flags, &amp;lpTable);</span>
<a href="#l33.763"></a><span id="l33.763">   if (HR_FAILED(hr)) {</span>
<a href="#l33.764"></a><span id="l33.764">     m_lastError = hr;</span>
<a href="#l33.765"></a><span id="l33.765" class="difflineminus">-    MAPI_TRACE2( &quot;IterateHierarchy: GetContentsTable failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.766"></a><span id="l33.766" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.767"></a><span id="l33.767" class="difflineplus">+    MAPI_TRACE2(&quot;IterateHierarchy: GetContentsTable failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.768"></a><span id="l33.768" class="difflineplus">+    return FALSE;</span>
<a href="#l33.769"></a><span id="l33.769">   }</span>
<a href="#l33.770"></a><span id="l33.770"> </span>
<a href="#l33.771"></a><span id="l33.771">   ULONG rowCount;</span>
<a href="#l33.772"></a><span id="l33.772" class="difflineminus">-  hr = lpTable-&gt;GetRowCount( 0, &amp;rowCount);</span>
<a href="#l33.773"></a><span id="l33.773" class="difflineplus">+  hr = lpTable-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l33.774"></a><span id="l33.774">   if (!rowCount) {</span>
<a href="#l33.775"></a><span id="l33.775">     lpTable-&gt;Release();</span>
<a href="#l33.776"></a><span id="l33.776" class="difflineminus">-    return( TRUE);</span>
<a href="#l33.777"></a><span id="l33.777" class="difflineplus">+    return TRUE;</span>
<a href="#l33.778"></a><span id="l33.778">   }</span>
<a href="#l33.779"></a><span id="l33.779"> </span>
<a href="#l33.780"></a><span id="l33.780" class="difflineminus">-  hr = lpTable-&gt;SetColumns( (LPSPropTagArray)&amp;ptaEid, 0);</span>
<a href="#l33.781"></a><span id="l33.781" class="difflineplus">+  hr = lpTable-&gt;SetColumns((LPSPropTagArray)&amp;ptaEid, 0);</span>
<a href="#l33.782"></a><span id="l33.782">   if (HR_FAILED(hr)) {</span>
<a href="#l33.783"></a><span id="l33.783">     m_lastError = hr;</span>
<a href="#l33.784"></a><span id="l33.784">     lpTable-&gt;Release();</span>
<a href="#l33.785"></a><span id="l33.785" class="difflineminus">-    MAPI_TRACE2( &quot;IterateHierarchy: SetColumns failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.786"></a><span id="l33.786" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.787"></a><span id="l33.787" class="difflineplus">+    MAPI_TRACE2(&quot;IterateHierarchy: SetColumns failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.788"></a><span id="l33.788" class="difflineplus">+    return FALSE;</span>
<a href="#l33.789"></a><span id="l33.789">   }</span>
<a href="#l33.790"></a><span id="l33.790"> </span>
<a href="#l33.791"></a><span id="l33.791" class="difflineminus">-  hr = lpTable-&gt;SeekRow( BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l33.792"></a><span id="l33.792" class="difflineplus">+  hr = lpTable-&gt;SeekRow(BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l33.793"></a><span id="l33.793">   if (HR_FAILED(hr)) {</span>
<a href="#l33.794"></a><span id="l33.794">     m_lastError = hr;</span>
<a href="#l33.795"></a><span id="l33.795">     lpTable-&gt;Release();</span>
<a href="#l33.796"></a><span id="l33.796" class="difflineminus">-    MAPI_TRACE2( &quot;IterateHierarchy: SeekRow failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.797"></a><span id="l33.797" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.798"></a><span id="l33.798" class="difflineplus">+    MAPI_TRACE2(&quot;IterateHierarchy: SeekRow failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.799"></a><span id="l33.799" class="difflineplus">+    return FALSE;</span>
<a href="#l33.800"></a><span id="l33.800">   }</span>
<a href="#l33.801"></a><span id="l33.801"> </span>
<a href="#l33.802"></a><span id="l33.802">   int      cNumRows = 0;</span>
<a href="#l33.803"></a><span id="l33.803">   LPSRowSet  lpRow;</span>
<a href="#l33.804"></a><span id="l33.804">   BOOL    keepGoing = TRUE;</span>
<a href="#l33.805"></a><span id="l33.805">   BOOL    bResult = TRUE;</span>
<a href="#l33.806"></a><span id="l33.806">   do {</span>
<a href="#l33.807"></a><span id="l33.807" class="difflineminus">-</span>
<a href="#l33.808"></a><span id="l33.808">     lpRow = NULL;</span>
<a href="#l33.809"></a><span id="l33.809" class="difflineminus">-    hr = lpTable-&gt;QueryRows( 1, 0, &amp;lpRow);</span>
<a href="#l33.810"></a><span id="l33.810" class="difflineplus">+    hr = lpTable-&gt;QueryRows(1, 0, &amp;lpRow);</span>
<a href="#l33.811"></a><span id="l33.811"> </span>
<a href="#l33.812"></a><span id="l33.812" class="difflineminus">-        if(HR_FAILED(hr)) {</span>
<a href="#l33.813"></a><span id="l33.813" class="difflineminus">-      MAPI_TRACE2( &quot;QueryRows failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.814"></a><span id="l33.814" class="difflineplus">+    if(HR_FAILED(hr)) {</span>
<a href="#l33.815"></a><span id="l33.815" class="difflineplus">+      MAPI_TRACE2(&quot;QueryRows failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.816"></a><span id="l33.816">       m_lastError = hr;</span>
<a href="#l33.817"></a><span id="l33.817" class="difflineminus">-            bResult = FALSE;</span>
<a href="#l33.818"></a><span id="l33.818" class="difflineplus">+      bResult = FALSE;</span>
<a href="#l33.819"></a><span id="l33.819">       break;</span>
<a href="#l33.820"></a><span id="l33.820">     }</span>
<a href="#l33.821"></a><span id="l33.821"> </span>
<a href="#l33.822"></a><span id="l33.822" class="difflineminus">-        if(lpRow) {</span>
<a href="#l33.823"></a><span id="l33.823" class="difflineminus">-            cNumRows = lpRow-&gt;cRows;</span>
<a href="#l33.824"></a><span id="l33.824" class="difflineplus">+    if(lpRow) {</span>
<a href="#l33.825"></a><span id="l33.825" class="difflineplus">+      cNumRows = lpRow-&gt;cRows;</span>
<a href="#l33.826"></a><span id="l33.826"> </span>
<a href="#l33.827"></a><span id="l33.827" class="difflineminus">-        if (cNumRows) {</span>
<a href="#l33.828"></a><span id="l33.828" class="difflineminus">-                LPENTRYID  lpEntry = (LPENTRYID) lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l33.829"></a><span id="l33.829" class="difflineminus">-                ULONG    cb = lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l33.830"></a><span id="l33.830" class="difflineplus">+      if (cNumRows) {</span>
<a href="#l33.831"></a><span id="l33.831" class="difflineplus">+        LPENTRYID  lpEntry = (LPENTRYID) lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l33.832"></a><span id="l33.832" class="difflineplus">+        ULONG    cb = lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l33.833"></a><span id="l33.833">         ULONG    oType = lpRow-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.ul;</span>
<a href="#l33.834"></a><span id="l33.834"> </span>
<a href="#l33.835"></a><span id="l33.835">         if (pIter)</span>
<a href="#l33.836"></a><span id="l33.836" class="difflineminus">-          keepGoing = pIter-&gt;HandleHierarchyItem( oType, cb, lpEntry);</span>
<a href="#l33.837"></a><span id="l33.837" class="difflineplus">+          keepGoing = pIter-&gt;HandleHierarchyItem(oType, cb, lpEntry);</span>
<a href="#l33.838"></a><span id="l33.838">         else</span>
<a href="#l33.839"></a><span id="l33.839" class="difflineminus">-          keepGoing = HandleHierarchyItem( oType, cb, lpEntry);</span>
<a href="#l33.840"></a><span id="l33.840" class="difflineplus">+          keepGoing = HandleHierarchyItem(oType, cb, lpEntry);</span>
<a href="#l33.841"></a><span id="l33.841"> </span>
<a href="#l33.842"></a><span id="l33.842" class="difflineminus">-        }</span>
<a href="#l33.843"></a><span id="l33.843" class="difflineminus">-      FreeProws( lpRow);</span>
<a href="#l33.844"></a><span id="l33.844" class="difflineminus">-        }</span>
<a href="#l33.845"></a><span id="l33.845" class="difflineminus">-</span>
<a href="#l33.846"></a><span id="l33.846" class="difflineminus">-  } while ( SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRow &amp;&amp; keepGoing);</span>
<a href="#l33.847"></a><span id="l33.847" class="difflineplus">+      }</span>
<a href="#l33.848"></a><span id="l33.848" class="difflineplus">+      FreeProws(lpRow);</span>
<a href="#l33.849"></a><span id="l33.849" class="difflineplus">+    }</span>
<a href="#l33.850"></a><span id="l33.850" class="difflineplus">+  } while (SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRow &amp;&amp; keepGoing);</span>
<a href="#l33.851"></a><span id="l33.851"> </span>
<a href="#l33.852"></a><span id="l33.852">   lpTable-&gt;Release();</span>
<a href="#l33.853"></a><span id="l33.853"> </span>
<a href="#l33.854"></a><span id="l33.854">   if (bResult &amp;&amp; !keepGoing)</span>
<a href="#l33.855"></a><span id="l33.855">     bResult = FALSE;</span>
<a href="#l33.856"></a><span id="l33.856"> </span>
<a href="#l33.857"></a><span id="l33.857" class="difflineminus">-  return( bResult);</span>
<a href="#l33.858"></a><span id="l33.858" class="difflineplus">+  return bResult;</span>
<a href="#l33.859"></a><span id="l33.859"> }</span>
<a href="#l33.860"></a><span id="l33.860"> </span>
<a href="#l33.861"></a><span id="l33.861"> </span>
<a href="#l33.862"></a><span id="l33.862"> enum {</span>
<a href="#l33.863"></a><span id="l33.863">   itblPR_DISPLAY_NAME,</span>
<a href="#l33.864"></a><span id="l33.864">     itblPR_ENTRYID,</span>
<a href="#l33.865"></a><span id="l33.865">     itblMax</span>
<a href="#l33.866"></a><span id="l33.866"> };</span>
<a href="#l33.867"></a><span id="l33.867" class="difflineat">@@ -910,341 +908,335 @@ static const SizedSPropTagArray(itblMax,</span>
<a href="#l33.868"></a><span id="l33.868"> {</span>
<a href="#l33.869"></a><span id="l33.869">     itblMax,</span>
<a href="#l33.870"></a><span id="l33.870">     {</span>
<a href="#l33.871"></a><span id="l33.871">     PR_DISPLAY_NAME,</span>
<a href="#l33.872"></a><span id="l33.872">         PR_ENTRYID,</span>
<a href="#l33.873"></a><span id="l33.873">     }</span>
<a href="#l33.874"></a><span id="l33.874"> };</span>
<a href="#l33.875"></a><span id="l33.875"> </span>
<a href="#l33.876"></a><span id="l33.876" class="difflineminus">-BOOL CMapiApi::IterateStores( CMapiFolderList&amp; stores)</span>
<a href="#l33.877"></a><span id="l33.877" class="difflineplus">+BOOL CMapiApi::IterateStores(CMapiFolderList&amp; stores)</span>
<a href="#l33.878"></a><span id="l33.878"> {</span>
<a href="#l33.879"></a><span id="l33.879">   stores.ClearAll();</span>
<a href="#l33.880"></a><span id="l33.880"> </span>
<a href="#l33.881"></a><span id="l33.881">   if (!m_lpSession) {</span>
<a href="#l33.882"></a><span id="l33.882" class="difflineminus">-    MAPI_TRACE0( &quot;IterateStores called before session is open\n&quot;);</span>
<a href="#l33.883"></a><span id="l33.883" class="difflineplus">+    MAPI_TRACE0(&quot;IterateStores called before session is open\n&quot;);</span>
<a href="#l33.884"></a><span id="l33.884">     m_lastError = -1;</span>
<a href="#l33.885"></a><span id="l33.885" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.886"></a><span id="l33.886" class="difflineplus">+    return FALSE;</span>
<a href="#l33.887"></a><span id="l33.887">   }</span>
<a href="#l33.888"></a><span id="l33.888"> </span>
<a href="#l33.889"></a><span id="l33.889"> </span>
<a href="#l33.890"></a><span id="l33.890">   HRESULT    hr;</span>
<a href="#l33.891"></a><span id="l33.891"> </span>
<a href="#l33.892"></a><span id="l33.892">   /* -- Some Microsoft sample code just to see if things are working --- *//*</span>
<a href="#l33.893"></a><span id="l33.893"> </span>
<a href="#l33.894"></a><span id="l33.894">   ULONG    cbEIDStore;</span>
<a href="#l33.895"></a><span id="l33.895">   LPENTRYID  lpEIDStore;</span>
<a href="#l33.896"></a><span id="l33.896"> </span>
<a href="#l33.897"></a><span id="l33.897" class="difflineminus">-    hr = HrMAPIFindDefaultMsgStore( m_lpSession, &amp;cbEIDStore, &amp;lpEIDStore);</span>
<a href="#l33.898"></a><span id="l33.898" class="difflineplus">+    hr = HrMAPIFindDefaultMsgStore(m_lpSession, &amp;cbEIDStore, &amp;lpEIDStore);</span>
<a href="#l33.899"></a><span id="l33.899">     if (HR_FAILED(hr)) {</span>
<a href="#l33.900"></a><span id="l33.900" class="difflineminus">-        MAPI_TRACE0( &quot;Default message store not found\n&quot;);</span>
<a href="#l33.901"></a><span id="l33.901" class="difflineplus">+        MAPI_TRACE0(&quot;Default message store not found\n&quot;);</span>
<a href="#l33.902"></a><span id="l33.902">     // MessageBoxW(NULL, L&quot;Message Store Not Found&quot;, NULL, MB_OK);</span>
<a href="#l33.903"></a><span id="l33.903">     }</span>
<a href="#l33.904"></a><span id="l33.904">   else {</span>
<a href="#l33.905"></a><span id="l33.905">     LPMDB  lpStore;</span>
<a href="#l33.906"></a><span id="l33.906" class="difflineminus">-    MAPI_TRACE0( &quot;Default Message store FOUND\n&quot;);</span>
<a href="#l33.907"></a><span id="l33.907" class="difflineminus">-    hr = m_lpSession-&gt;OpenMsgStore( NULL, cbEIDStore,</span>
<a href="#l33.908"></a><span id="l33.908" class="difflineplus">+    MAPI_TRACE0(&quot;Default Message store FOUND\n&quot;);</span>
<a href="#l33.909"></a><span id="l33.909" class="difflineplus">+    hr = m_lpSession-&gt;OpenMsgStore(NULL, cbEIDStore,</span>
<a href="#l33.910"></a><span id="l33.910">                                   lpEIDStore, NULL,</span>
<a href="#l33.911"></a><span id="l33.911">                                   MDB_NO_MAIL | MDB_NO_DIALOG, &amp;lpStore);</span>
<a href="#l33.912"></a><span id="l33.912">     if (HR_FAILED(hr)) {</span>
<a href="#l33.913"></a><span id="l33.913" class="difflineminus">-      MAPI_TRACE1( &quot;Unable to open default message store: 0x%lx\n&quot;, hr);</span>
<a href="#l33.914"></a><span id="l33.914" class="difflineplus">+      MAPI_TRACE1(&quot;Unable to open default message store: 0x%lx\n&quot;, hr);</span>
<a href="#l33.915"></a><span id="l33.915">     }</span>
<a href="#l33.916"></a><span id="l33.916">     else {</span>
<a href="#l33.917"></a><span id="l33.917" class="difflineminus">-      MAPI_TRACE0( &quot;Default message store OPENED\n&quot;);</span>
<a href="#l33.918"></a><span id="l33.918" class="difflineplus">+      MAPI_TRACE0(&quot;Default message store OPENED\n&quot;);</span>
<a href="#l33.919"></a><span id="l33.919">       lpStore-&gt;Release();</span>
<a href="#l33.920"></a><span id="l33.920">     }</span>
<a href="#l33.921"></a><span id="l33.921">    }</span>
<a href="#l33.922"></a><span id="l33.922">      */</span>
<a href="#l33.923"></a><span id="l33.923"> </span>
<a href="#l33.924"></a><span id="l33.924"> </span>
<a href="#l33.925"></a><span id="l33.925"> </span>
<a href="#l33.926"></a><span id="l33.926">   LPMAPITABLE  lpTable;</span>
<a href="#l33.927"></a><span id="l33.927"> </span>
<a href="#l33.928"></a><span id="l33.928" class="difflineminus">-  hr = m_lpSession-&gt;GetMsgStoresTable( 0, &amp;lpTable);</span>
<a href="#l33.929"></a><span id="l33.929" class="difflineplus">+  hr = m_lpSession-&gt;GetMsgStoresTable(0, &amp;lpTable);</span>
<a href="#l33.930"></a><span id="l33.930">   if (FAILED(hr)) {</span>
<a href="#l33.931"></a><span id="l33.931" class="difflineminus">-    MAPI_TRACE0( &quot;GetMsgStoresTable failed\n&quot;);</span>
<a href="#l33.932"></a><span id="l33.932" class="difflineplus">+    MAPI_TRACE0(&quot;GetMsgStoresTable failed\n&quot;);</span>
<a href="#l33.933"></a><span id="l33.933">     m_lastError = hr;</span>
<a href="#l33.934"></a><span id="l33.934" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.935"></a><span id="l33.935" class="difflineplus">+    return FALSE;</span>
<a href="#l33.936"></a><span id="l33.936">   }</span>
<a href="#l33.937"></a><span id="l33.937"> </span>
<a href="#l33.938"></a><span id="l33.938"> </span>
<a href="#l33.939"></a><span id="l33.939">   ULONG rowCount;</span>
<a href="#l33.940"></a><span id="l33.940" class="difflineminus">-  hr = lpTable-&gt;GetRowCount( 0, &amp;rowCount);</span>
<a href="#l33.941"></a><span id="l33.941" class="difflineminus">-  MAPI_TRACE1( &quot;MsgStores Table rowCount: %ld\n&quot;, rowCount);</span>
<a href="#l33.942"></a><span id="l33.942" class="difflineplus">+  hr = lpTable-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l33.943"></a><span id="l33.943" class="difflineplus">+  MAPI_TRACE1(&quot;MsgStores Table rowCount: %ld\n&quot;, rowCount);</span>
<a href="#l33.944"></a><span id="l33.944"> </span>
<a href="#l33.945"></a><span id="l33.945" class="difflineminus">-  hr = lpTable-&gt;SetColumns( (LPSPropTagArray)&amp;ptaTbl, 0);</span>
<a href="#l33.946"></a><span id="l33.946" class="difflineplus">+  hr = lpTable-&gt;SetColumns((LPSPropTagArray)&amp;ptaTbl, 0);</span>
<a href="#l33.947"></a><span id="l33.947">   if (FAILED(hr)) {</span>
<a href="#l33.948"></a><span id="l33.948">     lpTable-&gt;Release();</span>
<a href="#l33.949"></a><span id="l33.949" class="difflineminus">-    MAPI_TRACE2( &quot;SetColumns failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.950"></a><span id="l33.950" class="difflineplus">+    MAPI_TRACE2(&quot;SetColumns failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.951"></a><span id="l33.951">     m_lastError = hr;</span>
<a href="#l33.952"></a><span id="l33.952" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.953"></a><span id="l33.953" class="difflineplus">+    return FALSE;</span>
<a href="#l33.954"></a><span id="l33.954">   }</span>
<a href="#l33.955"></a><span id="l33.955"> </span>
<a href="#l33.956"></a><span id="l33.956" class="difflineminus">-  hr = lpTable-&gt;SeekRow( BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l33.957"></a><span id="l33.957" class="difflineplus">+  hr = lpTable-&gt;SeekRow(BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l33.958"></a><span id="l33.958">   if (FAILED(hr)) {</span>
<a href="#l33.959"></a><span id="l33.959">     lpTable-&gt;Release();</span>
<a href="#l33.960"></a><span id="l33.960" class="difflineminus">-    MAPI_TRACE2( &quot;SeekRow failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.961"></a><span id="l33.961" class="difflineplus">+    MAPI_TRACE2(&quot;SeekRow failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.962"></a><span id="l33.962">     m_lastError = hr;</span>
<a href="#l33.963"></a><span id="l33.963" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.964"></a><span id="l33.964" class="difflineplus">+    return FALSE;</span>
<a href="#l33.965"></a><span id="l33.965">   }</span>
<a href="#l33.966"></a><span id="l33.966"> </span>
<a href="#l33.967"></a><span id="l33.967">   int      cNumRows = 0;</span>
<a href="#l33.968"></a><span id="l33.968">   LPSRowSet  lpRow;</span>
<a href="#l33.969"></a><span id="l33.969">   BOOL    keepGoing = TRUE;</span>
<a href="#l33.970"></a><span id="l33.970">   BOOL    bResult = TRUE;</span>
<a href="#l33.971"></a><span id="l33.971">   do {</span>
<a href="#l33.972"></a><span id="l33.972" class="difflineminus">-</span>
<a href="#l33.973"></a><span id="l33.973">     lpRow = NULL;</span>
<a href="#l33.974"></a><span id="l33.974" class="difflineminus">-    hr = lpTable-&gt;QueryRows( 1, 0, &amp;lpRow);</span>
<a href="#l33.975"></a><span id="l33.975" class="difflineplus">+    hr = lpTable-&gt;QueryRows(1, 0, &amp;lpRow);</span>
<a href="#l33.976"></a><span id="l33.976"> </span>
<a href="#l33.977"></a><span id="l33.977" class="difflineminus">-        if(HR_FAILED(hr)) {</span>
<a href="#l33.978"></a><span id="l33.978" class="difflineminus">-      MAPI_TRACE2( &quot;QueryRows failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.979"></a><span id="l33.979" class="difflineminus">-            bResult = FALSE;</span>
<a href="#l33.980"></a><span id="l33.980" class="difflineplus">+    if(HR_FAILED(hr)) {</span>
<a href="#l33.981"></a><span id="l33.981" class="difflineplus">+      MAPI_TRACE2(&quot;QueryRows failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.982"></a><span id="l33.982" class="difflineplus">+      bResult = FALSE;</span>
<a href="#l33.983"></a><span id="l33.983">       m_lastError = hr;</span>
<a href="#l33.984"></a><span id="l33.984">       break;</span>
<a href="#l33.985"></a><span id="l33.985">     }</span>
<a href="#l33.986"></a><span id="l33.986"> </span>
<a href="#l33.987"></a><span id="l33.987" class="difflineminus">-        if(lpRow) {</span>
<a href="#l33.988"></a><span id="l33.988" class="difflineminus">-            cNumRows = lpRow-&gt;cRows;</span>
<a href="#l33.989"></a><span id="l33.989" class="difflineplus">+    if(lpRow) {</span>
<a href="#l33.990"></a><span id="l33.990" class="difflineplus">+      cNumRows = lpRow-&gt;cRows;</span>
<a href="#l33.991"></a><span id="l33.991"> </span>
<a href="#l33.992"></a><span id="l33.992" class="difflineminus">-        if (cNumRows) {</span>
<a href="#l33.993"></a><span id="l33.993" class="difflineplus">+      if (cNumRows) {</span>
<a href="#l33.994"></a><span id="l33.994">         LPCTSTR    lpStr = (LPCTSTR) lpRow-&gt;aRow[0].lpProps[itblPR_DISPLAY_NAME].Value.LPSZ;</span>
<a href="#l33.995"></a><span id="l33.995" class="difflineminus">-                LPENTRYID  lpEID = (LPENTRYID) lpRow-&gt;aRow[0].lpProps[itblPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l33.996"></a><span id="l33.996" class="difflineminus">-                ULONG    cbEID = lpRow-&gt;aRow[0].lpProps[itblPR_ENTRYID].Value.bin.cb;</span>
<a href="#l33.997"></a><span id="l33.997" class="difflineplus">+        LPENTRYID  lpEID = (LPENTRYID) lpRow-&gt;aRow[0].lpProps[itblPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l33.998"></a><span id="l33.998" class="difflineplus">+        ULONG    cbEID = lpRow-&gt;aRow[0].lpProps[itblPR_ENTRYID].Value.bin.cb;</span>
<a href="#l33.999"></a><span id="l33.999"> </span>
<a href="#l33.1000"></a><span id="l33.1000">         // In the future, GetStoreInfo needs to somehow return</span>
<a href="#l33.1001"></a><span id="l33.1001">         // whether or not the store is from an IMAP server.</span>
<a href="#l33.1002"></a><span id="l33.1002">         // Currently, GetStoreInfo opens the store and attempts</span>
<a href="#l33.1003"></a><span id="l33.1003">         // to get the hierarchy tree.  If the tree is empty or</span>
<a href="#l33.1004"></a><span id="l33.1004">         // does not exist, then szContents will be zero.  We'll</span>
<a href="#l33.1005"></a><span id="l33.1005">         // assume that any store that doesn't have anything in</span>
<a href="#l33.1006"></a><span id="l33.1006">         // it's hierarchy tree is not a store we want to import -</span>
<a href="#l33.1007"></a><span id="l33.1007">         // there would be nothing to import from anyway!</span>
<a href="#l33.1008"></a><span id="l33.1008">         // Currently, this does exclude IMAP server accounts</span>
<a href="#l33.1009"></a><span id="l33.1009">         // which is the desired behaviour.</span>
<a href="#l33.1010"></a><span id="l33.1010"> </span>
<a href="#l33.1011"></a><span id="l33.1011" class="difflineminus">-                int         strLen = strlen(lpStr);</span>
<a href="#l33.1012"></a><span id="l33.1012" class="difflineminus">-                PRUnichar * pwszStr = (PRUnichar *) nsMemory::Alloc((strLen + 1) * sizeof(WCHAR));</span>
<a href="#l33.1013"></a><span id="l33.1013" class="difflineminus">-                if (!pwszStr) {</span>
<a href="#l33.1014"></a><span id="l33.1014" class="difflineminus">-                    // out of memory</span>
<a href="#l33.1015"></a><span id="l33.1015" class="difflineminus">-                    FreeProws( lpRow);</span>
<a href="#l33.1016"></a><span id="l33.1016" class="difflineminus">-                    lpTable-&gt;Release();</span>
<a href="#l33.1017"></a><span id="l33.1017" class="difflineminus">-                    return FALSE;</span>
<a href="#l33.1018"></a><span id="l33.1018" class="difflineminus">-                }</span>
<a href="#l33.1019"></a><span id="l33.1019" class="difflineminus">-                ::MultiByteToWideChar(CP_ACP, 0, lpStr, strlen(lpStr) + 1, pwszStr, (strLen + 1) * sizeof(WCHAR));</span>
<a href="#l33.1020"></a><span id="l33.1020" class="difflineminus">-        CMapiFolder *pFolder = new CMapiFolder( pwszStr, cbEID, lpEID, 0, MAPI_STORE);</span>
<a href="#l33.1021"></a><span id="l33.1021" class="difflineminus">-                nsMemory::Free(pwszStr);</span>
<a href="#l33.1022"></a><span id="l33.1022" class="difflineplus">+        int         strLen = strlen(lpStr);</span>
<a href="#l33.1023"></a><span id="l33.1023" class="difflineplus">+        PRUnichar * pwszStr = (PRUnichar *) nsMemory::Alloc((strLen + 1) * sizeof(WCHAR));</span>
<a href="#l33.1024"></a><span id="l33.1024" class="difflineplus">+        if (!pwszStr) {</span>
<a href="#l33.1025"></a><span id="l33.1025" class="difflineplus">+          // out of memory</span>
<a href="#l33.1026"></a><span id="l33.1026" class="difflineplus">+          FreeProws(lpRow);</span>
<a href="#l33.1027"></a><span id="l33.1027" class="difflineplus">+          lpTable-&gt;Release();</span>
<a href="#l33.1028"></a><span id="l33.1028" class="difflineplus">+          return FALSE;</span>
<a href="#l33.1029"></a><span id="l33.1029" class="difflineplus">+        }</span>
<a href="#l33.1030"></a><span id="l33.1030" class="difflineplus">+        ::MultiByteToWideChar(CP_ACP, 0, lpStr, strlen(lpStr) + 1, pwszStr, (strLen + 1) * sizeof(WCHAR));</span>
<a href="#l33.1031"></a><span id="l33.1031" class="difflineplus">+        CMapiFolder *pFolder = new CMapiFolder(pwszStr, cbEID, lpEID, 0, MAPI_STORE);</span>
<a href="#l33.1032"></a><span id="l33.1032" class="difflineplus">+        nsMemory::Free(pwszStr);</span>
<a href="#l33.1033"></a><span id="l33.1033"> </span>
<a href="#l33.1034"></a><span id="l33.1034">         long szContents = 1;</span>
<a href="#l33.1035"></a><span id="l33.1035" class="difflineminus">-         GetStoreInfo( pFolder, &amp;szContents);</span>
<a href="#l33.1036"></a><span id="l33.1036" class="difflineplus">+        GetStoreInfo(pFolder, &amp;szContents);</span>
<a href="#l33.1037"></a><span id="l33.1037"> </span>
<a href="#l33.1038"></a><span id="l33.1038" class="difflineminus">-        MAPI_TRACE1( &quot;    DisplayName: %s\n&quot;, lpStr);</span>
<a href="#l33.1039"></a><span id="l33.1039" class="difflineminus">-        if (szContents) {</span>
<a href="#l33.1040"></a><span id="l33.1040" class="difflineminus">-          stores.AddItem( pFolder);</span>
<a href="#l33.1041"></a><span id="l33.1041" class="difflineminus">-        }</span>
<a href="#l33.1042"></a><span id="l33.1042" class="difflineplus">+        MAPI_TRACE1(&quot;    DisplayName: %s\n&quot;, lpStr);</span>
<a href="#l33.1043"></a><span id="l33.1043" class="difflineplus">+        if (szContents)</span>
<a href="#l33.1044"></a><span id="l33.1044" class="difflineplus">+          stores.AddItem(pFolder);</span>
<a href="#l33.1045"></a><span id="l33.1045">         else {</span>
<a href="#l33.1046"></a><span id="l33.1046">           delete pFolder;</span>
<a href="#l33.1047"></a><span id="l33.1047" class="difflineminus">-          MAPI_TRACE0( &quot;    ^^^^^ Not added to store list\n&quot;);</span>
<a href="#l33.1048"></a><span id="l33.1048" class="difflineplus">+          MAPI_TRACE0(&quot;    ^^^^^ Not added to store list\n&quot;);</span>
<a href="#l33.1049"></a><span id="l33.1049">         }</span>
<a href="#l33.1050"></a><span id="l33.1050"> </span>
<a href="#l33.1051"></a><span id="l33.1051">         keepGoing = TRUE;</span>
<a href="#l33.1052"></a><span id="l33.1052" class="difflineminus">-        }</span>
<a href="#l33.1053"></a><span id="l33.1053" class="difflineminus">-      FreeProws( lpRow);</span>
<a href="#l33.1054"></a><span id="l33.1054" class="difflineminus">-        }</span>
<a href="#l33.1055"></a><span id="l33.1055" class="difflineminus">-</span>
<a href="#l33.1056"></a><span id="l33.1056" class="difflineminus">-  } while ( SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRow &amp;&amp; keepGoing);</span>
<a href="#l33.1057"></a><span id="l33.1057" class="difflineplus">+      }</span>
<a href="#l33.1058"></a><span id="l33.1058" class="difflineplus">+      FreeProws(lpRow);</span>
<a href="#l33.1059"></a><span id="l33.1059" class="difflineplus">+    }</span>
<a href="#l33.1060"></a><span id="l33.1060" class="difflineplus">+  } while (SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRow &amp;&amp; keepGoing);</span>
<a href="#l33.1061"></a><span id="l33.1061"> </span>
<a href="#l33.1062"></a><span id="l33.1062">   lpTable-&gt;Release();</span>
<a href="#l33.1063"></a><span id="l33.1063"> </span>
<a href="#l33.1064"></a><span id="l33.1064" class="difflineminus">-  return( bResult);</span>
<a href="#l33.1065"></a><span id="l33.1065" class="difflineplus">+  return bResult;</span>
<a href="#l33.1066"></a><span id="l33.1066"> }</span>
<a href="#l33.1067"></a><span id="l33.1067"> </span>
<a href="#l33.1068"></a><span id="l33.1068" class="difflineminus">-void CMapiApi::GetStoreInfo( CMapiFolder *pFolder, long *pSzContents)</span>
<a href="#l33.1069"></a><span id="l33.1069" class="difflineplus">+void CMapiApi::GetStoreInfo(CMapiFolder *pFolder, long *pSzContents)</span>
<a href="#l33.1070"></a><span id="l33.1070"> {</span>
<a href="#l33.1071"></a><span id="l33.1071">   HRESULT  hr;</span>
<a href="#l33.1072"></a><span id="l33.1072">   LPMDB  lpMdb;</span>
<a href="#l33.1073"></a><span id="l33.1073"> </span>
<a href="#l33.1074"></a><span id="l33.1074">   if (pSzContents)</span>
<a href="#l33.1075"></a><span id="l33.1075">     *pSzContents = 0;</span>
<a href="#l33.1076"></a><span id="l33.1076"> </span>
<a href="#l33.1077"></a><span id="l33.1077" class="difflineminus">-  if (!OpenStore( pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID(), &amp;lpMdb))</span>
<a href="#l33.1078"></a><span id="l33.1078" class="difflineplus">+  if (!OpenStore(pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID(), &amp;lpMdb))</span>
<a href="#l33.1079"></a><span id="l33.1079">     return;</span>
<a href="#l33.1080"></a><span id="l33.1080"> </span>
<a href="#l33.1081"></a><span id="l33.1081">   LPSPropValue pVal;</span>
<a href="#l33.1082"></a><span id="l33.1082">   /*</span>
<a href="#l33.1083"></a><span id="l33.1083" class="difflineminus">-  pVal = GetMapiProperty( lpMdb, PR_DISPLAY_NAME);</span>
<a href="#l33.1084"></a><span id="l33.1084" class="difflineminus">-  ReportStringProp( &quot;    Message store name:&quot;, pVal);</span>
<a href="#l33.1085"></a><span id="l33.1085" class="difflineminus">-  pVal = GetMapiProperty( lpMdb, PR_MDB_PROVIDER);</span>
<a href="#l33.1086"></a><span id="l33.1086" class="difflineminus">-  ReportUIDProp( &quot;    Message store provider:&quot;, pVal);</span>
<a href="#l33.1087"></a><span id="l33.1087" class="difflineminus">-  pVal = GetMapiProperty( lpMdb, PR_COMMENT);</span>
<a href="#l33.1088"></a><span id="l33.1088" class="difflineminus">-  ReportStringProp( &quot;    Message comment:&quot;, pVal);</span>
<a href="#l33.1089"></a><span id="l33.1089" class="difflineminus">-  pVal = GetMapiProperty( lpMdb, PR_ACCESS_LEVEL);</span>
<a href="#l33.1090"></a><span id="l33.1090" class="difflineminus">-  ReportLongProp( &quot;    Message store Access Level:&quot;, pVal);</span>
<a href="#l33.1091"></a><span id="l33.1091" class="difflineminus">-  pVal = GetMapiProperty( lpMdb, PR_STORE_SUPPORT_MASK);</span>
<a href="#l33.1092"></a><span id="l33.1092" class="difflineminus">-  ReportLongProp( &quot;    Message store support mask:&quot;, pVal);</span>
<a href="#l33.1093"></a><span id="l33.1093" class="difflineminus">-  pVal = GetMapiProperty( lpMdb, PR_STORE_STATE);</span>
<a href="#l33.1094"></a><span id="l33.1094" class="difflineminus">-  ReportLongProp( &quot;    Message store state:&quot;, pVal);</span>
<a href="#l33.1095"></a><span id="l33.1095" class="difflineminus">-  pVal = GetMapiProperty( lpMdb, PR_OBJECT_TYPE);</span>
<a href="#l33.1096"></a><span id="l33.1096" class="difflineminus">-  ReportLongProp( &quot;    Message store object type:&quot;, pVal);</span>
<a href="#l33.1097"></a><span id="l33.1097" class="difflineminus">-  pVal = GetMapiProperty( lpMdb, PR_VALID_FOLDER_MASK);</span>
<a href="#l33.1098"></a><span id="l33.1098" class="difflineminus">-  ReportLongProp( &quot;    Message store valid folder mask:&quot;, pVal);</span>
<a href="#l33.1099"></a><span id="l33.1099" class="difflineplus">+  pVal = GetMapiProperty(lpMdb, PR_DISPLAY_NAME);</span>
<a href="#l33.1100"></a><span id="l33.1100" class="difflineplus">+  ReportStringProp(&quot;    Message store name:&quot;, pVal);</span>
<a href="#l33.1101"></a><span id="l33.1101" class="difflineplus">+  pVal = GetMapiProperty(lpMdb, PR_MDB_PROVIDER);</span>
<a href="#l33.1102"></a><span id="l33.1102" class="difflineplus">+  ReportUIDProp(&quot;    Message store provider:&quot;, pVal);</span>
<a href="#l33.1103"></a><span id="l33.1103" class="difflineplus">+  pVal = GetMapiProperty(lpMdb, PR_COMMENT);</span>
<a href="#l33.1104"></a><span id="l33.1104" class="difflineplus">+  ReportStringProp(&quot;    Message comment:&quot;, pVal);</span>
<a href="#l33.1105"></a><span id="l33.1105" class="difflineplus">+  pVal = GetMapiProperty(lpMdb, PR_ACCESS_LEVEL);</span>
<a href="#l33.1106"></a><span id="l33.1106" class="difflineplus">+  ReportLongProp(&quot;    Message store Access Level:&quot;, pVal);</span>
<a href="#l33.1107"></a><span id="l33.1107" class="difflineplus">+  pVal = GetMapiProperty(lpMdb, PR_STORE_SUPPORT_MASK);</span>
<a href="#l33.1108"></a><span id="l33.1108" class="difflineplus">+  ReportLongProp(&quot;    Message store support mask:&quot;, pVal);</span>
<a href="#l33.1109"></a><span id="l33.1109" class="difflineplus">+  pVal = GetMapiProperty(lpMdb, PR_STORE_STATE);</span>
<a href="#l33.1110"></a><span id="l33.1110" class="difflineplus">+  ReportLongProp(&quot;    Message store state:&quot;, pVal);</span>
<a href="#l33.1111"></a><span id="l33.1111" class="difflineplus">+  pVal = GetMapiProperty(lpMdb, PR_OBJECT_TYPE);</span>
<a href="#l33.1112"></a><span id="l33.1112" class="difflineplus">+  ReportLongProp(&quot;    Message store object type:&quot;, pVal);</span>
<a href="#l33.1113"></a><span id="l33.1113" class="difflineplus">+  pVal = GetMapiProperty(lpMdb, PR_VALID_FOLDER_MASK);</span>
<a href="#l33.1114"></a><span id="l33.1114" class="difflineplus">+  ReportLongProp(&quot;    Message store valid folder mask:&quot;, pVal);</span>
<a href="#l33.1115"></a><span id="l33.1115"> </span>
<a href="#l33.1116"></a><span id="l33.1116" class="difflineminus">-  pVal = GetMapiProperty( lpMdb, 0x8001001e);</span>
<a href="#l33.1117"></a><span id="l33.1117" class="difflineminus">-  ReportStringProp( &quot;    Message prop 0x8001001e:&quot;, pVal);</span>
<a href="#l33.1118"></a><span id="l33.1118" class="difflineplus">+  pVal = GetMapiProperty(lpMdb, 0x8001001e);</span>
<a href="#l33.1119"></a><span id="l33.1119" class="difflineplus">+  ReportStringProp(&quot;    Message prop 0x8001001e:&quot;, pVal);</span>
<a href="#l33.1120"></a><span id="l33.1120"> </span>
<a href="#l33.1121"></a><span id="l33.1121">   // This key appears to be the OMI Account Manager account that corresponds</span>
<a href="#l33.1122"></a><span id="l33.1122">   // to this message store.  This is important for IMAP accounts</span>
<a href="#l33.1123"></a><span id="l33.1123">   // since we may not want to import messages from an IMAP store!</span>
<a href="#l33.1124"></a><span id="l33.1124">   // Seems silly if you ask me!</span>
<a href="#l33.1125"></a><span id="l33.1125">   // In order to test this, we'll need the registry key to look under to determine</span>
<a href="#l33.1126"></a><span id="l33.1126">   // if it contains the &quot;IMAP Server&quot; value, if it does then we are an</span>
<a href="#l33.1127"></a><span id="l33.1127">   // IMAP store, if not, then we are a non-IMAP store - which may always mean</span>
<a href="#l33.1128"></a><span id="l33.1128">   // a regular store that should be imported.</span>
<a href="#l33.1129"></a><span id="l33.1129"> </span>
<a href="#l33.1130"></a><span id="l33.1130" class="difflineminus">-  pVal = GetMapiProperty( lpMdb, 0x80000003);</span>
<a href="#l33.1131"></a><span id="l33.1131" class="difflineminus">-  ReportLongProp( &quot;    Message prop 0x80000003:&quot;, pVal);</span>
<a href="#l33.1132"></a><span id="l33.1132" class="difflineplus">+  pVal = GetMapiProperty(lpMdb, 0x80000003);</span>
<a href="#l33.1133"></a><span id="l33.1133" class="difflineplus">+  ReportLongProp(&quot;    Message prop 0x80000003:&quot;, pVal);</span>
<a href="#l33.1134"></a><span id="l33.1134"> </span>
<a href="#l33.1135"></a><span id="l33.1135" class="difflineminus">-  // ListProperties( lpMdb);</span>
<a href="#l33.1136"></a><span id="l33.1136" class="difflineplus">+  // ListProperties(lpMdb);</span>
<a href="#l33.1137"></a><span id="l33.1137">   */</span>
<a href="#l33.1138"></a><span id="l33.1138"> </span>
<a href="#l33.1139"></a><span id="l33.1139" class="difflineminus">-  pVal = GetMapiProperty( lpMdb, PR_IPM_SUBTREE_ENTRYID);</span>
<a href="#l33.1140"></a><span id="l33.1140" class="difflineplus">+  pVal = GetMapiProperty(lpMdb, PR_IPM_SUBTREE_ENTRYID);</span>
<a href="#l33.1141"></a><span id="l33.1141">   if (pVal) {</span>
<a href="#l33.1142"></a><span id="l33.1142">     ULONG      cbEntry;</span>
<a href="#l33.1143"></a><span id="l33.1143">     LPENTRYID    pEntry;</span>
<a href="#l33.1144"></a><span id="l33.1144">     LPMAPIFOLDER  lpSubTree = NULL;</span>
<a href="#l33.1145"></a><span id="l33.1145"> </span>
<a href="#l33.1146"></a><span id="l33.1146" class="difflineminus">-    if (GetEntryIdFromProp( pVal, cbEntry, pEntry)) {</span>
<a href="#l33.1147"></a><span id="l33.1147" class="difflineplus">+    if (GetEntryIdFromProp(pVal, cbEntry, pEntry)) {</span>
<a href="#l33.1148"></a><span id="l33.1148">       // Open up the folder!</span>
<a href="#l33.1149"></a><span id="l33.1149">       ULONG    ulObjType;</span>
<a href="#l33.1150"></a><span id="l33.1150" class="difflineminus">-      hr = lpMdb-&gt;OpenEntry( cbEntry, pEntry, NULL, 0, &amp;ulObjType, (LPUNKNOWN *) &amp;lpSubTree);</span>
<a href="#l33.1151"></a><span id="l33.1151" class="difflineminus">-      MAPIFreeBuffer( pEntry);</span>
<a href="#l33.1152"></a><span id="l33.1152" class="difflineminus">-      if (SUCCEEDED( hr) &amp;&amp; lpSubTree) {</span>
<a href="#l33.1153"></a><span id="l33.1153" class="difflineplus">+      hr = lpMdb-&gt;OpenEntry(cbEntry, pEntry, NULL, 0, &amp;ulObjType, (LPUNKNOWN *) &amp;lpSubTree);</span>
<a href="#l33.1154"></a><span id="l33.1154" class="difflineplus">+      MAPIFreeBuffer(pEntry);</span>
<a href="#l33.1155"></a><span id="l33.1155" class="difflineplus">+      if (SUCCEEDED(hr) &amp;&amp; lpSubTree) {</span>
<a href="#l33.1156"></a><span id="l33.1156">         // Find out if there are any contents in the</span>
<a href="#l33.1157"></a><span id="l33.1157">         // tree.</span>
<a href="#l33.1158"></a><span id="l33.1158">         LPMAPITABLE  lpTable;</span>
<a href="#l33.1159"></a><span id="l33.1159" class="difflineminus">-        hr = lpSubTree-&gt;GetHierarchyTable( 0, &amp;lpTable);</span>
<a href="#l33.1160"></a><span id="l33.1160" class="difflineplus">+        hr = lpSubTree-&gt;GetHierarchyTable(0, &amp;lpTable);</span>
<a href="#l33.1161"></a><span id="l33.1161">         if (HR_FAILED(hr)) {</span>
<a href="#l33.1162"></a><span id="l33.1162" class="difflineminus">-          MAPI_TRACE2( &quot;GetStoreInfo: GetHierarchyTable failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.1163"></a><span id="l33.1163" class="difflineplus">+          MAPI_TRACE2(&quot;GetStoreInfo: GetHierarchyTable failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.1164"></a><span id="l33.1164">         }</span>
<a href="#l33.1165"></a><span id="l33.1165">         else {</span>
<a href="#l33.1166"></a><span id="l33.1166">           ULONG rowCount;</span>
<a href="#l33.1167"></a><span id="l33.1167" class="difflineminus">-          hr = lpTable-&gt;GetRowCount( 0, &amp;rowCount);</span>
<a href="#l33.1168"></a><span id="l33.1168" class="difflineplus">+          hr = lpTable-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l33.1169"></a><span id="l33.1169">           lpTable-&gt;Release();</span>
<a href="#l33.1170"></a><span id="l33.1170" class="difflineminus">-          if (SUCCEEDED( hr) &amp;&amp; pSzContents)</span>
<a href="#l33.1171"></a><span id="l33.1171" class="difflineplus">+          if (SUCCEEDED(hr) &amp;&amp; pSzContents)</span>
<a href="#l33.1172"></a><span id="l33.1172">             *pSzContents = (long) rowCount;</span>
<a href="#l33.1173"></a><span id="l33.1173">         }</span>
<a href="#l33.1174"></a><span id="l33.1174"> </span>
<a href="#l33.1175"></a><span id="l33.1175">         lpSubTree-&gt;Release();</span>
<a href="#l33.1176"></a><span id="l33.1176">       }</span>
<a href="#l33.1177"></a><span id="l33.1177">     }</span>
<a href="#l33.1178"></a><span id="l33.1178">   }</span>
<a href="#l33.1179"></a><span id="l33.1179"> }</span>
<a href="#l33.1180"></a><span id="l33.1180"> </span>
<a href="#l33.1181"></a><span id="l33.1181"> </span>
<a href="#l33.1182"></a><span id="l33.1182" class="difflineminus">-void CMapiApi::ClearMessageStores( void)</span>
<a href="#l33.1183"></a><span id="l33.1183" class="difflineplus">+void CMapiApi::ClearMessageStores(void)</span>
<a href="#l33.1184"></a><span id="l33.1184"> {</span>
<a href="#l33.1185"></a><span id="l33.1185">   if (m_pStores) {</span>
<a href="#l33.1186"></a><span id="l33.1186">     CMsgStore *  pStore;</span>
<a href="#l33.1187"></a><span id="l33.1187">     for (int i = 0; i &lt; m_pStores-&gt;Count(); i++) {</span>
<a href="#l33.1188"></a><span id="l33.1188" class="difflineminus">-      pStore = (CMsgStore *) m_pStores-&gt;ElementAt( i);</span>
<a href="#l33.1189"></a><span id="l33.1189" class="difflineplus">+      pStore = (CMsgStore *) m_pStores-&gt;ElementAt(i);</span>
<a href="#l33.1190"></a><span id="l33.1190">       delete pStore;</span>
<a href="#l33.1191"></a><span id="l33.1191">     }</span>
<a href="#l33.1192"></a><span id="l33.1192">     m_pStores-&gt;Clear();</span>
<a href="#l33.1193"></a><span id="l33.1193">   }</span>
<a href="#l33.1194"></a><span id="l33.1194"> }</span>
<a href="#l33.1195"></a><span id="l33.1195"> </span>
<a href="#l33.1196"></a><span id="l33.1196" class="difflineminus">-void CMapiApi::AddMessageStore( CMsgStore *pStore)</span>
<a href="#l33.1197"></a><span id="l33.1197" class="difflineplus">+void CMapiApi::AddMessageStore(CMsgStore *pStore)</span>
<a href="#l33.1198"></a><span id="l33.1198"> {</span>
<a href="#l33.1199"></a><span id="l33.1199">   if (m_pStores)</span>
<a href="#l33.1200"></a><span id="l33.1200" class="difflineminus">-    m_pStores-&gt;AppendElement( pStore);</span>
<a href="#l33.1201"></a><span id="l33.1201" class="difflineplus">+    m_pStores-&gt;AppendElement(pStore);</span>
<a href="#l33.1202"></a><span id="l33.1202"> }</span>
<a href="#l33.1203"></a><span id="l33.1203"> </span>
<a href="#l33.1204"></a><span id="l33.1204" class="difflineminus">-CMsgStore *  CMapiApi::FindMessageStore( ULONG cbEid, LPENTRYID lpEid)</span>
<a href="#l33.1205"></a><span id="l33.1205" class="difflineplus">+CMsgStore *  CMapiApi::FindMessageStore(ULONG cbEid, LPENTRYID lpEid)</span>
<a href="#l33.1206"></a><span id="l33.1206"> {</span>
<a href="#l33.1207"></a><span id="l33.1207">   if (!m_lpSession) {</span>
<a href="#l33.1208"></a><span id="l33.1208" class="difflineminus">-    MAPI_TRACE0( &quot;FindMessageStore called before session is open\n&quot;);</span>
<a href="#l33.1209"></a><span id="l33.1209" class="difflineplus">+    MAPI_TRACE0(&quot;FindMessageStore called before session is open\n&quot;);</span>
<a href="#l33.1210"></a><span id="l33.1210">     m_lastError = -1;</span>
<a href="#l33.1211"></a><span id="l33.1211" class="difflineminus">-    return( NULL);</span>
<a href="#l33.1212"></a><span id="l33.1212" class="difflineplus">+    return NULL;</span>
<a href="#l33.1213"></a><span id="l33.1213">   }</span>
<a href="#l33.1214"></a><span id="l33.1214"> </span>
<a href="#l33.1215"></a><span id="l33.1215">   ULONG    result;</span>
<a href="#l33.1216"></a><span id="l33.1216">   HRESULT    hr;</span>
<a href="#l33.1217"></a><span id="l33.1217">   CMsgStore *  pStore;</span>
<a href="#l33.1218"></a><span id="l33.1218">   for (int i = 0; i &lt; m_pStores-&gt;Count(); i++) {</span>
<a href="#l33.1219"></a><span id="l33.1219" class="difflineminus">-    pStore = (CMsgStore *) m_pStores-&gt;ElementAt( i);</span>
<a href="#l33.1220"></a><span id="l33.1220" class="difflineminus">-    hr = m_lpSession-&gt;CompareEntryIDs( cbEid, lpEid, pStore-&gt;GetCBEntryID(), pStore-&gt;GetLPEntryID(),</span>
<a href="#l33.1221"></a><span id="l33.1221" class="difflineplus">+    pStore = (CMsgStore *) m_pStores-&gt;ElementAt(i);</span>
<a href="#l33.1222"></a><span id="l33.1222" class="difflineplus">+    hr = m_lpSession-&gt;CompareEntryIDs(cbEid, lpEid, pStore-&gt;GetCBEntryID(), pStore-&gt;GetLPEntryID(),</span>
<a href="#l33.1223"></a><span id="l33.1223">                       0, &amp;result);</span>
<a href="#l33.1224"></a><span id="l33.1224" class="difflineminus">-    if (HR_FAILED( hr)) {</span>
<a href="#l33.1225"></a><span id="l33.1225" class="difflineminus">-      MAPI_TRACE2( &quot;CompareEntryIDs failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.1226"></a><span id="l33.1226" class="difflineplus">+    if (HR_FAILED(hr)) {</span>
<a href="#l33.1227"></a><span id="l33.1227" class="difflineplus">+      MAPI_TRACE2(&quot;CompareEntryIDs failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.1228"></a><span id="l33.1228">       m_lastError = hr;</span>
<a href="#l33.1229"></a><span id="l33.1229" class="difflineminus">-      return( NULL);</span>
<a href="#l33.1230"></a><span id="l33.1230" class="difflineplus">+      return NULL;</span>
<a href="#l33.1231"></a><span id="l33.1231">     }</span>
<a href="#l33.1232"></a><span id="l33.1232" class="difflineminus">-    if ( result) {</span>
<a href="#l33.1233"></a><span id="l33.1233" class="difflineminus">-      return( pStore);</span>
<a href="#l33.1234"></a><span id="l33.1234" class="difflineplus">+    if (result) {</span>
<a href="#l33.1235"></a><span id="l33.1235" class="difflineplus">+      return pStore;</span>
<a href="#l33.1236"></a><span id="l33.1236">     }</span>
<a href="#l33.1237"></a><span id="l33.1237">   }</span>
<a href="#l33.1238"></a><span id="l33.1238"> </span>
<a href="#l33.1239"></a><span id="l33.1239" class="difflineminus">-  pStore = new CMsgStore( cbEid, lpEid);</span>
<a href="#l33.1240"></a><span id="l33.1240" class="difflineminus">-  AddMessageStore( pStore);</span>
<a href="#l33.1241"></a><span id="l33.1241" class="difflineminus">-  return( pStore);</span>
<a href="#l33.1242"></a><span id="l33.1242" class="difflineplus">+  pStore = new CMsgStore(cbEid, lpEid);</span>
<a href="#l33.1243"></a><span id="l33.1243" class="difflineplus">+  AddMessageStore(pStore);</span>
<a href="#l33.1244"></a><span id="l33.1244" class="difflineplus">+  return pStore;</span>
<a href="#l33.1245"></a><span id="l33.1245"> }</span>
<a href="#l33.1246"></a><span id="l33.1246"> </span>
<a href="#l33.1247"></a><span id="l33.1247"> // --------------------------------------------------------------------</span>
<a href="#l33.1248"></a><span id="l33.1248"> // Utility stuff</span>
<a href="#l33.1249"></a><span id="l33.1249"> // --------------------------------------------------------------------</span>
<a href="#l33.1250"></a><span id="l33.1250"> </span>
<a href="#l33.1251"></a><span id="l33.1251" class="difflineminus">-LPSPropValue CMapiApi::GetMapiProperty( LPMAPIPROP pProp, ULONG tag)</span>
<a href="#l33.1252"></a><span id="l33.1252" class="difflineplus">+LPSPropValue CMapiApi::GetMapiProperty(LPMAPIPROP pProp, ULONG tag)</span>
<a href="#l33.1253"></a><span id="l33.1253"> {</span>
<a href="#l33.1254"></a><span id="l33.1254">   if (!pProp)</span>
<a href="#l33.1255"></a><span id="l33.1255" class="difflineminus">-    return( NULL);</span>
<a href="#l33.1256"></a><span id="l33.1256" class="difflineplus">+    return NULL;</span>
<a href="#l33.1257"></a><span id="l33.1257"> </span>
<a href="#l33.1258"></a><span id="l33.1258" class="difflineminus">-  int  sz = CbNewSPropTagArray( 1);</span>
<a href="#l33.1259"></a><span id="l33.1259" class="difflineplus">+  int  sz = CbNewSPropTagArray(1);</span>
<a href="#l33.1260"></a><span id="l33.1260">   SPropTagArray *pTag = (SPropTagArray *) new char[sz];</span>
<a href="#l33.1261"></a><span id="l33.1261">   pTag-&gt;cValues = 1;</span>
<a href="#l33.1262"></a><span id="l33.1262">   pTag-&gt;aulPropTag[0] = tag;</span>
<a href="#l33.1263"></a><span id="l33.1263">   LPSPropValue  lpProp = NULL;</span>
<a href="#l33.1264"></a><span id="l33.1264">   ULONG  cValues = 0;</span>
<a href="#l33.1265"></a><span id="l33.1265" class="difflineminus">-  HRESULT hr = pProp-&gt;GetProps( pTag, 0, &amp;cValues, &amp;lpProp);</span>
<a href="#l33.1266"></a><span id="l33.1266" class="difflineplus">+  HRESULT hr = pProp-&gt;GetProps(pTag, 0, &amp;cValues, &amp;lpProp);</span>
<a href="#l33.1267"></a><span id="l33.1267">   delete [] pTag;</span>
<a href="#l33.1268"></a><span id="l33.1268" class="difflineminus">-  if (HR_FAILED( hr) || (cValues != 1)) {</span>
<a href="#l33.1269"></a><span id="l33.1269" class="difflineplus">+  if (HR_FAILED(hr) || (cValues != 1)) {</span>
<a href="#l33.1270"></a><span id="l33.1270">     if (lpProp)</span>
<a href="#l33.1271"></a><span id="l33.1271" class="difflineminus">-      MAPIFreeBuffer( lpProp);</span>
<a href="#l33.1272"></a><span id="l33.1272" class="difflineminus">-    return( NULL);</span>
<a href="#l33.1273"></a><span id="l33.1273" class="difflineplus">+      MAPIFreeBuffer(lpProp);</span>
<a href="#l33.1274"></a><span id="l33.1274" class="difflineplus">+    return NULL;</span>
<a href="#l33.1275"></a><span id="l33.1275">   }</span>
<a href="#l33.1276"></a><span id="l33.1276">   else {</span>
<a href="#l33.1277"></a><span id="l33.1277" class="difflineminus">-    if (PROP_TYPE( lpProp-&gt;ulPropTag) == PT_ERROR) {</span>
<a href="#l33.1278"></a><span id="l33.1278" class="difflineplus">+    if (PROP_TYPE(lpProp-&gt;ulPropTag) == PT_ERROR) {</span>
<a href="#l33.1279"></a><span id="l33.1279">       if (lpProp-&gt;Value.l == MAPI_E_NOT_FOUND) {</span>
<a href="#l33.1280"></a><span id="l33.1280" class="difflineminus">-        MAPIFreeBuffer( lpProp);</span>
<a href="#l33.1281"></a><span id="l33.1281" class="difflineplus">+        MAPIFreeBuffer(lpProp);</span>
<a href="#l33.1282"></a><span id="l33.1282">         lpProp = NULL;</span>
<a href="#l33.1283"></a><span id="l33.1283">       }</span>
<a href="#l33.1284"></a><span id="l33.1284">     }</span>
<a href="#l33.1285"></a><span id="l33.1285">   }</span>
<a href="#l33.1286"></a><span id="l33.1286"> </span>
<a href="#l33.1287"></a><span id="l33.1287" class="difflineminus">-  return( lpProp);</span>
<a href="#l33.1288"></a><span id="l33.1288" class="difflineplus">+  return lpProp;</span>
<a href="#l33.1289"></a><span id="l33.1289"> }</span>
<a href="#l33.1290"></a><span id="l33.1290"> </span>
<a href="#l33.1291"></a><span id="l33.1291" class="difflineminus">-BOOL CMapiApi::IsLargeProperty( LPSPropValue pVal)</span>
<a href="#l33.1292"></a><span id="l33.1292" class="difflineplus">+BOOL CMapiApi::IsLargeProperty(LPSPropValue pVal)</span>
<a href="#l33.1293"></a><span id="l33.1293"> {</span>
<a href="#l33.1294"></a><span id="l33.1294" class="difflineminus">-  if ((PROP_TYPE( pVal-&gt;ulPropTag) == PT_ERROR) &amp;&amp; (pVal-&gt;Value.l == E_OUTOFMEMORY)) {</span>
<a href="#l33.1295"></a><span id="l33.1295" class="difflineminus">-    return( TRUE);</span>
<a href="#l33.1296"></a><span id="l33.1296" class="difflineminus">-  }</span>
<a href="#l33.1297"></a><span id="l33.1297" class="difflineminus">-  return( FALSE);</span>
<a href="#l33.1298"></a><span id="l33.1298" class="difflineplus">+  return ((PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR) &amp;&amp; (pVal-&gt;Value.l == E_OUTOFMEMORY));</span>
<a href="#l33.1299"></a><span id="l33.1299"> }</span>
<a href="#l33.1300"></a><span id="l33.1300"> </span>
<a href="#l33.1301"></a><span id="l33.1301"> // The output buffer (result) must be freed with operator delete[]</span>
<a href="#l33.1302"></a><span id="l33.1302" class="difflineminus">-BOOL CMapiApi::GetLargeProperty( LPMAPIPROP pProp, ULONG tag, void** result)</span>
<a href="#l33.1303"></a><span id="l33.1303" class="difflineplus">+BOOL CMapiApi::GetLargeProperty(LPMAPIPROP pProp, ULONG tag, void** result)</span>
<a href="#l33.1304"></a><span id="l33.1304"> {</span>
<a href="#l33.1305"></a><span id="l33.1305">   LPSTREAM  lpStream;</span>
<a href="#l33.1306"></a><span id="l33.1306" class="difflineminus">-  HRESULT    hr = pProp-&gt;OpenProperty( tag, &amp;IID_IStream, 0, 0, (LPUNKNOWN *)&amp;lpStream);</span>
<a href="#l33.1307"></a><span id="l33.1307" class="difflineminus">-  if (HR_FAILED( hr))</span>
<a href="#l33.1308"></a><span id="l33.1308" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.1309"></a><span id="l33.1309" class="difflineplus">+  HRESULT    hr = pProp-&gt;OpenProperty(tag, &amp;IID_IStream, 0, 0, (LPUNKNOWN *)&amp;lpStream);</span>
<a href="#l33.1310"></a><span id="l33.1310" class="difflineplus">+  if (HR_FAILED(hr))</span>
<a href="#l33.1311"></a><span id="l33.1311" class="difflineplus">+    return FALSE;</span>
<a href="#l33.1312"></a><span id="l33.1312">   STATSTG    st;</span>
<a href="#l33.1313"></a><span id="l33.1313">   BOOL bResult = TRUE;</span>
<a href="#l33.1314"></a><span id="l33.1314" class="difflineminus">-  hr = lpStream-&gt;Stat( &amp;st, STATFLAG_NONAME);</span>
<a href="#l33.1315"></a><span id="l33.1315" class="difflineminus">-  if (HR_FAILED( hr))</span>
<a href="#l33.1316"></a><span id="l33.1316" class="difflineplus">+  hr = lpStream-&gt;Stat(&amp;st, STATFLAG_NONAME);</span>
<a href="#l33.1317"></a><span id="l33.1317" class="difflineplus">+  if (HR_FAILED(hr))</span>
<a href="#l33.1318"></a><span id="l33.1318">     bResult = FALSE;</span>
<a href="#l33.1319"></a><span id="l33.1319">   else {</span>
<a href="#l33.1320"></a><span id="l33.1320">     if (!st.cbSize.QuadPart)</span>
<a href="#l33.1321"></a><span id="l33.1321">       st.cbSize.QuadPart = 1;</span>
<a href="#l33.1322"></a><span id="l33.1322">     char *pVal = new char[ (int) st.cbSize.QuadPart + 2];</span>
<a href="#l33.1323"></a><span id="l33.1323">     if (pVal) {</span>
<a href="#l33.1324"></a><span id="l33.1324">       ULONG  sz;</span>
<a href="#l33.1325"></a><span id="l33.1325">       hr = lpStream-&gt;Read(pVal, (ULONG) st.cbSize.QuadPart, &amp;sz);</span>
<a href="#l33.1326"></a><span id="l33.1326" class="difflineat">@@ -1259,20 +1251,20 @@ BOOL CMapiApi::GetLargeProperty( LPMAPIP</span>
<a href="#l33.1327"></a><span id="l33.1327">       }</span>
<a href="#l33.1328"></a><span id="l33.1328">     }</span>
<a href="#l33.1329"></a><span id="l33.1329">     else</span>
<a href="#l33.1330"></a><span id="l33.1330">       bResult = FALSE;</span>
<a href="#l33.1331"></a><span id="l33.1331">   }</span>
<a href="#l33.1332"></a><span id="l33.1332"> </span>
<a href="#l33.1333"></a><span id="l33.1333">   lpStream-&gt;Release();</span>
<a href="#l33.1334"></a><span id="l33.1334"> </span>
<a href="#l33.1335"></a><span id="l33.1335" class="difflineminus">-  return( bResult);</span>
<a href="#l33.1336"></a><span id="l33.1336" class="difflineplus">+  return bResult;</span>
<a href="#l33.1337"></a><span id="l33.1337"> }</span>
<a href="#l33.1338"></a><span id="l33.1338"> </span>
<a href="#l33.1339"></a><span id="l33.1339" class="difflineminus">-BOOL CMapiApi::GetLargeStringProperty( LPMAPIPROP pProp, ULONG tag, nsCString&amp; val)</span>
<a href="#l33.1340"></a><span id="l33.1340" class="difflineplus">+BOOL CMapiApi::GetLargeStringProperty(LPMAPIPROP pProp, ULONG tag, nsCString&amp; val)</span>
<a href="#l33.1341"></a><span id="l33.1341"> {</span>
<a href="#l33.1342"></a><span id="l33.1342">   void* result;</span>
<a href="#l33.1343"></a><span id="l33.1343">   if (!GetLargeProperty(pProp, tag, &amp;result))</span>
<a href="#l33.1344"></a><span id="l33.1344">     return FALSE;</span>
<a href="#l33.1345"></a><span id="l33.1345">   if (PROP_TYPE(tag) == PT_UNICODE) // unicode string</span>
<a href="#l33.1346"></a><span id="l33.1346">     LossyCopyUTF16toASCII(nsDependentString(static_cast&lt;wchar_t*&gt;(result)), val);</span>
<a href="#l33.1347"></a><span id="l33.1347">   else // either PT_STRING8 or some other binary - use as is</span>
<a href="#l33.1348"></a><span id="l33.1348">     val.Assign(static_cast&lt;char*&gt;(result));</span>
<a href="#l33.1349"></a><span id="l33.1349" class="difflineat">@@ -1295,204 +1287,204 @@ BOOL CMapiApi::GetLargeStringProperty(LP</span>
<a href="#l33.1350"></a><span id="l33.1350"> // If the value is a string, get it...</span>
<a href="#l33.1351"></a><span id="l33.1351"> BOOL CMapiApi::GetEntryIdFromProp(LPSPropValue pVal, ULONG&amp; cbEntryId,</span>
<a href="#l33.1352"></a><span id="l33.1352">                                   LPENTRYID&amp; lpEntryId, BOOL delVal)</span>
<a href="#l33.1353"></a><span id="l33.1353"> {</span>
<a href="#l33.1354"></a><span id="l33.1354">   if (!pVal)</span>
<a href="#l33.1355"></a><span id="l33.1355">     return FALSE;</span>
<a href="#l33.1356"></a><span id="l33.1356"> </span>
<a href="#l33.1357"></a><span id="l33.1357">   BOOL bResult = TRUE;</span>
<a href="#l33.1358"></a><span id="l33.1358" class="difflineminus">-    switch( PROP_TYPE( pVal-&gt;ulPropTag)) {</span>
<a href="#l33.1359"></a><span id="l33.1359" class="difflineplus">+    switch(PROP_TYPE(pVal-&gt;ulPropTag)) {</span>
<a href="#l33.1360"></a><span id="l33.1360">     case PT_BINARY:</span>
<a href="#l33.1361"></a><span id="l33.1361">       cbEntryId = pVal-&gt;Value.bin.cb;</span>
<a href="#l33.1362"></a><span id="l33.1362" class="difflineminus">-      MAPIAllocateBuffer( cbEntryId, (LPVOID *) &amp;lpEntryId);</span>
<a href="#l33.1363"></a><span id="l33.1363" class="difflineminus">-      memcpy( lpEntryId, pVal-&gt;Value.bin.lpb, cbEntryId);</span>
<a href="#l33.1364"></a><span id="l33.1364" class="difflineplus">+      MAPIAllocateBuffer(cbEntryId, (LPVOID *) &amp;lpEntryId);</span>
<a href="#l33.1365"></a><span id="l33.1365" class="difflineplus">+      memcpy(lpEntryId, pVal-&gt;Value.bin.lpb, cbEntryId);</span>
<a href="#l33.1366"></a><span id="l33.1366">     break;</span>
<a href="#l33.1367"></a><span id="l33.1367"> </span>
<a href="#l33.1368"></a><span id="l33.1368">     default:</span>
<a href="#l33.1369"></a><span id="l33.1369" class="difflineminus">-      MAPI_TRACE0( &quot;EntryId not in BINARY prop value\n&quot;);</span>
<a href="#l33.1370"></a><span id="l33.1370" class="difflineplus">+      MAPI_TRACE0(&quot;EntryId not in BINARY prop value\n&quot;);</span>
<a href="#l33.1371"></a><span id="l33.1371">       bResult = FALSE;</span>
<a href="#l33.1372"></a><span id="l33.1372">         break;</span>
<a href="#l33.1373"></a><span id="l33.1373">     }</span>
<a href="#l33.1374"></a><span id="l33.1374"> </span>
<a href="#l33.1375"></a><span id="l33.1375">   if (pVal &amp;&amp; delVal)</span>
<a href="#l33.1376"></a><span id="l33.1376" class="difflineminus">-    MAPIFreeBuffer( pVal);</span>
<a href="#l33.1377"></a><span id="l33.1377" class="difflineplus">+    MAPIFreeBuffer(pVal);</span>
<a href="#l33.1378"></a><span id="l33.1378"> </span>
<a href="#l33.1379"></a><span id="l33.1379">   return bResult;</span>
<a href="#l33.1380"></a><span id="l33.1380"> }</span>
<a href="#l33.1381"></a><span id="l33.1381"> </span>
<a href="#l33.1382"></a><span id="l33.1382" class="difflineminus">-BOOL CMapiApi::GetStringFromProp( LPSPropValue pVal, nsCString&amp; val, BOOL delVal)</span>
<a href="#l33.1383"></a><span id="l33.1383" class="difflineplus">+BOOL CMapiApi::GetStringFromProp(LPSPropValue pVal, nsCString&amp; val, BOOL delVal)</span>
<a href="#l33.1384"></a><span id="l33.1384"> {</span>
<a href="#l33.1385"></a><span id="l33.1385">   BOOL bResult = TRUE;</span>
<a href="#l33.1386"></a><span id="l33.1386" class="difflineminus">-  if ( pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_STRING8))</span>
<a href="#l33.1387"></a><span id="l33.1387" class="difflineplus">+  if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_STRING8))</span>
<a href="#l33.1388"></a><span id="l33.1388">     val = pVal-&gt;Value.lpszA;</span>
<a href="#l33.1389"></a><span id="l33.1389" class="difflineminus">-  else if ( pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_UNICODE))</span>
<a href="#l33.1390"></a><span id="l33.1390" class="difflineplus">+  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_UNICODE))</span>
<a href="#l33.1391"></a><span id="l33.1391">     LossyCopyUTF16toASCII(nsDependentString(pVal-&gt;Value.lpszW), val);</span>
<a href="#l33.1392"></a><span id="l33.1392" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_NULL))</span>
<a href="#l33.1393"></a><span id="l33.1393" class="difflineplus">+  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_NULL))</span>
<a href="#l33.1394"></a><span id="l33.1394">     val.Truncate();</span>
<a href="#l33.1395"></a><span id="l33.1395" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l33.1396"></a><span id="l33.1396" class="difflineplus">+  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l33.1397"></a><span id="l33.1397">     val.Truncate();</span>
<a href="#l33.1398"></a><span id="l33.1398">     bResult = FALSE;</span>
<a href="#l33.1399"></a><span id="l33.1399">   }</span>
<a href="#l33.1400"></a><span id="l33.1400">   else {</span>
<a href="#l33.1401"></a><span id="l33.1401">     if (pVal) {</span>
<a href="#l33.1402"></a><span id="l33.1402" class="difflineminus">-      MAPI_TRACE1( &quot;GetStringFromProp: invalid value, expecting string - %d\n&quot;, (int) PROP_TYPE( pVal-&gt;ulPropTag));</span>
<a href="#l33.1403"></a><span id="l33.1403" class="difflineplus">+      MAPI_TRACE1(&quot;GetStringFromProp: invalid value, expecting string - %d\n&quot;, (int) PROP_TYPE(pVal-&gt;ulPropTag));</span>
<a href="#l33.1404"></a><span id="l33.1404">     }</span>
<a href="#l33.1405"></a><span id="l33.1405">     else {</span>
<a href="#l33.1406"></a><span id="l33.1406" class="difflineminus">-      MAPI_TRACE0( &quot;GetStringFromProp: invalid value, expecting string, got null pointer\n&quot;);</span>
<a href="#l33.1407"></a><span id="l33.1407" class="difflineplus">+      MAPI_TRACE0(&quot;GetStringFromProp: invalid value, expecting string, got null pointer\n&quot;);</span>
<a href="#l33.1408"></a><span id="l33.1408">     }</span>
<a href="#l33.1409"></a><span id="l33.1409">     val.Truncate();</span>
<a href="#l33.1410"></a><span id="l33.1410">     bResult = FALSE;</span>
<a href="#l33.1411"></a><span id="l33.1411">   }</span>
<a href="#l33.1412"></a><span id="l33.1412">   if (pVal &amp;&amp; delVal)</span>
<a href="#l33.1413"></a><span id="l33.1413" class="difflineminus">-    MAPIFreeBuffer( pVal);</span>
<a href="#l33.1414"></a><span id="l33.1414" class="difflineplus">+    MAPIFreeBuffer(pVal);</span>
<a href="#l33.1415"></a><span id="l33.1415"> </span>
<a href="#l33.1416"></a><span id="l33.1416" class="difflineminus">-  return( bResult);</span>
<a href="#l33.1417"></a><span id="l33.1417" class="difflineplus">+  return bResult;</span>
<a href="#l33.1418"></a><span id="l33.1418"> }</span>
<a href="#l33.1419"></a><span id="l33.1419"> </span>
<a href="#l33.1420"></a><span id="l33.1420" class="difflineminus">-BOOL CMapiApi::GetStringFromProp( LPSPropValue pVal, nsString&amp; val, BOOL delVal)</span>
<a href="#l33.1421"></a><span id="l33.1421" class="difflineplus">+BOOL CMapiApi::GetStringFromProp(LPSPropValue pVal, nsString&amp; val, BOOL delVal)</span>
<a href="#l33.1422"></a><span id="l33.1422"> {</span>
<a href="#l33.1423"></a><span id="l33.1423">   BOOL bResult = TRUE;</span>
<a href="#l33.1424"></a><span id="l33.1424" class="difflineminus">-  if ( pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_STRING8)) {</span>
<a href="#l33.1425"></a><span id="l33.1425" class="difflineminus">-    CStrToUnicode( (const char *)pVal-&gt;Value.lpszA, val);</span>
<a href="#l33.1426"></a><span id="l33.1426" class="difflineplus">+  if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_STRING8)) {</span>
<a href="#l33.1427"></a><span id="l33.1427" class="difflineplus">+    CStrToUnicode((const char *)pVal-&gt;Value.lpszA, val);</span>
<a href="#l33.1428"></a><span id="l33.1428">   }</span>
<a href="#l33.1429"></a><span id="l33.1429" class="difflineminus">-  else if ( pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_UNICODE)) {</span>
<a href="#l33.1430"></a><span id="l33.1430" class="difflineplus">+  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_UNICODE)) {</span>
<a href="#l33.1431"></a><span id="l33.1431">     val = (PRUnichar *) pVal-&gt;Value.lpszW;</span>
<a href="#l33.1432"></a><span id="l33.1432">   }</span>
<a href="#l33.1433"></a><span id="l33.1433" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l33.1434"></a><span id="l33.1434" class="difflineplus">+  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l33.1435"></a><span id="l33.1435">     val.Truncate();</span>
<a href="#l33.1436"></a><span id="l33.1436">   }</span>
<a href="#l33.1437"></a><span id="l33.1437" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l33.1438"></a><span id="l33.1438" class="difflineplus">+  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l33.1439"></a><span id="l33.1439">     val.Truncate();</span>
<a href="#l33.1440"></a><span id="l33.1440">     bResult = FALSE;</span>
<a href="#l33.1441"></a><span id="l33.1441">   }</span>
<a href="#l33.1442"></a><span id="l33.1442">   else {</span>
<a href="#l33.1443"></a><span id="l33.1443">     if (pVal) {</span>
<a href="#l33.1444"></a><span id="l33.1444" class="difflineminus">-      MAPI_TRACE1( &quot;GetStringFromProp: invalid value, expecting string - %d\n&quot;, (int) PROP_TYPE( pVal-&gt;ulPropTag));</span>
<a href="#l33.1445"></a><span id="l33.1445" class="difflineplus">+      MAPI_TRACE1(&quot;GetStringFromProp: invalid value, expecting string - %d\n&quot;, (int) PROP_TYPE(pVal-&gt;ulPropTag));</span>
<a href="#l33.1446"></a><span id="l33.1446">     }</span>
<a href="#l33.1447"></a><span id="l33.1447">     else {</span>
<a href="#l33.1448"></a><span id="l33.1448" class="difflineminus">-      MAPI_TRACE0( &quot;GetStringFromProp: invalid value, expecting string, got null pointer\n&quot;);</span>
<a href="#l33.1449"></a><span id="l33.1449" class="difflineplus">+      MAPI_TRACE0(&quot;GetStringFromProp: invalid value, expecting string, got null pointer\n&quot;);</span>
<a href="#l33.1450"></a><span id="l33.1450">     }</span>
<a href="#l33.1451"></a><span id="l33.1451">     val.Truncate();</span>
<a href="#l33.1452"></a><span id="l33.1452">     bResult = FALSE;</span>
<a href="#l33.1453"></a><span id="l33.1453">   }</span>
<a href="#l33.1454"></a><span id="l33.1454">   if (pVal &amp;&amp; delVal)</span>
<a href="#l33.1455"></a><span id="l33.1455" class="difflineminus">-    MAPIFreeBuffer( pVal);</span>
<a href="#l33.1456"></a><span id="l33.1456" class="difflineplus">+    MAPIFreeBuffer(pVal);</span>
<a href="#l33.1457"></a><span id="l33.1457"> </span>
<a href="#l33.1458"></a><span id="l33.1458" class="difflineminus">-  return( bResult);</span>
<a href="#l33.1459"></a><span id="l33.1459" class="difflineplus">+  return bResult;</span>
<a href="#l33.1460"></a><span id="l33.1460"> }</span>
<a href="#l33.1461"></a><span id="l33.1461"> </span>
<a href="#l33.1462"></a><span id="l33.1462"> </span>
<a href="#l33.1463"></a><span id="l33.1463" class="difflineminus">-LONG CMapiApi::GetLongFromProp( LPSPropValue pVal, BOOL delVal)</span>
<a href="#l33.1464"></a><span id="l33.1464" class="difflineplus">+LONG CMapiApi::GetLongFromProp(LPSPropValue pVal, BOOL delVal)</span>
<a href="#l33.1465"></a><span id="l33.1465"> {</span>
<a href="#l33.1466"></a><span id="l33.1466">   LONG val = 0;</span>
<a href="#l33.1467"></a><span id="l33.1467" class="difflineminus">-  if ( pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_LONG)) {</span>
<a href="#l33.1468"></a><span id="l33.1468" class="difflineplus">+  if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_LONG)) {</span>
<a href="#l33.1469"></a><span id="l33.1469">     val = pVal-&gt;Value.l;</span>
<a href="#l33.1470"></a><span id="l33.1470">   }</span>
<a href="#l33.1471"></a><span id="l33.1471" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l33.1472"></a><span id="l33.1472" class="difflineplus">+  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l33.1473"></a><span id="l33.1473">     val = 0;</span>
<a href="#l33.1474"></a><span id="l33.1474">   }</span>
<a href="#l33.1475"></a><span id="l33.1475" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l33.1476"></a><span id="l33.1476" class="difflineplus">+  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l33.1477"></a><span id="l33.1477">     val = 0;</span>
<a href="#l33.1478"></a><span id="l33.1478" class="difflineminus">-    MAPI_TRACE0( &quot;GetLongFromProp: Error retrieving property\n&quot;);</span>
<a href="#l33.1479"></a><span id="l33.1479" class="difflineplus">+    MAPI_TRACE0(&quot;GetLongFromProp: Error retrieving property\n&quot;);</span>
<a href="#l33.1480"></a><span id="l33.1480">   }</span>
<a href="#l33.1481"></a><span id="l33.1481">   else {</span>
<a href="#l33.1482"></a><span id="l33.1482" class="difflineminus">-    MAPI_TRACE0( &quot;GetLongFromProp: invalid value, expecting long\n&quot;);</span>
<a href="#l33.1483"></a><span id="l33.1483" class="difflineplus">+    MAPI_TRACE0(&quot;GetLongFromProp: invalid value, expecting long\n&quot;);</span>
<a href="#l33.1484"></a><span id="l33.1484">   }</span>
<a href="#l33.1485"></a><span id="l33.1485">   if (pVal &amp;&amp; delVal)</span>
<a href="#l33.1486"></a><span id="l33.1486" class="difflineminus">-    MAPIFreeBuffer( pVal);</span>
<a href="#l33.1487"></a><span id="l33.1487" class="difflineplus">+    MAPIFreeBuffer(pVal);</span>
<a href="#l33.1488"></a><span id="l33.1488"> </span>
<a href="#l33.1489"></a><span id="l33.1489" class="difflineminus">-  return( val);</span>
<a href="#l33.1490"></a><span id="l33.1490" class="difflineplus">+  return val;</span>
<a href="#l33.1491"></a><span id="l33.1491"> }</span>
<a href="#l33.1492"></a><span id="l33.1492"> </span>
<a href="#l33.1493"></a><span id="l33.1493"> </span>
<a href="#l33.1494"></a><span id="l33.1494" class="difflineminus">-void CMapiApi::ReportUIDProp( const char *pTag, LPSPropValue pVal)</span>
<a href="#l33.1495"></a><span id="l33.1495" class="difflineplus">+void CMapiApi::ReportUIDProp(const char *pTag, LPSPropValue pVal)</span>
<a href="#l33.1496"></a><span id="l33.1496"> {</span>
<a href="#l33.1497"></a><span id="l33.1497" class="difflineminus">-  if ( pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_BINARY)) {</span>
<a href="#l33.1498"></a><span id="l33.1498" class="difflineplus">+  if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_BINARY)) {</span>
<a href="#l33.1499"></a><span id="l33.1499">     if (pVal-&gt;Value.bin.cb != 16) {</span>
<a href="#l33.1500"></a><span id="l33.1500" class="difflineminus">-      MAPI_TRACE1( &quot;%s - INVALID, expecting 16 bytes of binary data for UID\n&quot;, pTag);</span>
<a href="#l33.1501"></a><span id="l33.1501" class="difflineplus">+      MAPI_TRACE1(&quot;%s - INVALID, expecting 16 bytes of binary data for UID\n&quot;, pTag);</span>
<a href="#l33.1502"></a><span id="l33.1502">     }</span>
<a href="#l33.1503"></a><span id="l33.1503">     else {</span>
<a href="#l33.1504"></a><span id="l33.1504">       nsIID  uid;</span>
<a href="#l33.1505"></a><span id="l33.1505" class="difflineminus">-      memcpy( &amp;uid, pVal-&gt;Value.bin.lpb, 16);</span>
<a href="#l33.1506"></a><span id="l33.1506" class="difflineplus">+      memcpy(&amp;uid, pVal-&gt;Value.bin.lpb, 16);</span>
<a href="#l33.1507"></a><span id="l33.1507">       char *  pStr = uid.ToString();</span>
<a href="#l33.1508"></a><span id="l33.1508">       if (pStr) {</span>
<a href="#l33.1509"></a><span id="l33.1509" class="difflineminus">-        MAPI_TRACE2( &quot;%s %s\n&quot;, pTag, (const char *)pStr);</span>
<a href="#l33.1510"></a><span id="l33.1510" class="difflineminus">-        NS_Free( pStr);</span>
<a href="#l33.1511"></a><span id="l33.1511" class="difflineplus">+        MAPI_TRACE2(&quot;%s %s\n&quot;, pTag, (const char *)pStr);</span>
<a href="#l33.1512"></a><span id="l33.1512" class="difflineplus">+        NS_Free(pStr);</span>
<a href="#l33.1513"></a><span id="l33.1513">       }</span>
<a href="#l33.1514"></a><span id="l33.1514">     }</span>
<a href="#l33.1515"></a><span id="l33.1515">   }</span>
<a href="#l33.1516"></a><span id="l33.1516" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l33.1517"></a><span id="l33.1517" class="difflineminus">-    MAPI_TRACE1( &quot;%s {NULL}\n&quot;, pTag);</span>
<a href="#l33.1518"></a><span id="l33.1518" class="difflineplus">+  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l33.1519"></a><span id="l33.1519" class="difflineplus">+    MAPI_TRACE1(&quot;%s {NULL}\n&quot;, pTag);</span>
<a href="#l33.1520"></a><span id="l33.1520">   }</span>
<a href="#l33.1521"></a><span id="l33.1521" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l33.1522"></a><span id="l33.1522" class="difflineminus">-    MAPI_TRACE1( &quot;%s {Error retrieving property}\n&quot;, pTag);</span>
<a href="#l33.1523"></a><span id="l33.1523" class="difflineplus">+  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l33.1524"></a><span id="l33.1524" class="difflineplus">+    MAPI_TRACE1(&quot;%s {Error retrieving property}\n&quot;, pTag);</span>
<a href="#l33.1525"></a><span id="l33.1525">   }</span>
<a href="#l33.1526"></a><span id="l33.1526">   else {</span>
<a href="#l33.1527"></a><span id="l33.1527" class="difflineminus">-    MAPI_TRACE1( &quot;%s invalid value, expecting binary\n&quot;, pTag);</span>
<a href="#l33.1528"></a><span id="l33.1528" class="difflineplus">+    MAPI_TRACE1(&quot;%s invalid value, expecting binary\n&quot;, pTag);</span>
<a href="#l33.1529"></a><span id="l33.1529">   }</span>
<a href="#l33.1530"></a><span id="l33.1530">   if (pVal)</span>
<a href="#l33.1531"></a><span id="l33.1531" class="difflineminus">-    MAPIFreeBuffer( pVal);</span>
<a href="#l33.1532"></a><span id="l33.1532" class="difflineplus">+    MAPIFreeBuffer(pVal);</span>
<a href="#l33.1533"></a><span id="l33.1533"> }</span>
<a href="#l33.1534"></a><span id="l33.1534"> </span>
<a href="#l33.1535"></a><span id="l33.1535" class="difflineminus">-void CMapiApi::ReportLongProp( const char *pTag, LPSPropValue pVal)</span>
<a href="#l33.1536"></a><span id="l33.1536" class="difflineplus">+void CMapiApi::ReportLongProp(const char *pTag, LPSPropValue pVal)</span>
<a href="#l33.1537"></a><span id="l33.1537"> {</span>
<a href="#l33.1538"></a><span id="l33.1538" class="difflineminus">-  if ( pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_LONG)) {</span>
<a href="#l33.1539"></a><span id="l33.1539" class="difflineplus">+  if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_LONG)) {</span>
<a href="#l33.1540"></a><span id="l33.1540">     nsCString  num;</span>
<a href="#l33.1541"></a><span id="l33.1541">     nsCString  num2;</span>
<a href="#l33.1542"></a><span id="l33.1542"> </span>
<a href="#l33.1543"></a><span id="l33.1543" class="difflineminus">-    num.AppendInt( (PRInt32) pVal-&gt;Value.l);</span>
<a href="#l33.1544"></a><span id="l33.1544" class="difflineminus">-    num2.AppendInt( (PRInt32) pVal-&gt;Value.l, 16);</span>
<a href="#l33.1545"></a><span id="l33.1545" class="difflineminus">-    MAPI_TRACE3( &quot;%s %s, 0x%s\n&quot;, pTag, num, num2);</span>
<a href="#l33.1546"></a><span id="l33.1546" class="difflineplus">+    num.AppendInt((PRInt32) pVal-&gt;Value.l);</span>
<a href="#l33.1547"></a><span id="l33.1547" class="difflineplus">+    num2.AppendInt((PRInt32) pVal-&gt;Value.l, 16);</span>
<a href="#l33.1548"></a><span id="l33.1548" class="difflineplus">+    MAPI_TRACE3(&quot;%s %s, 0x%s\n&quot;, pTag, num, num2);</span>
<a href="#l33.1549"></a><span id="l33.1549">   }</span>
<a href="#l33.1550"></a><span id="l33.1550" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l33.1551"></a><span id="l33.1551" class="difflineminus">-    MAPI_TRACE1( &quot;%s {NULL}\n&quot;, pTag);</span>
<a href="#l33.1552"></a><span id="l33.1552" class="difflineplus">+  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l33.1553"></a><span id="l33.1553" class="difflineplus">+    MAPI_TRACE1(&quot;%s {NULL}\n&quot;, pTag);</span>
<a href="#l33.1554"></a><span id="l33.1554">   }</span>
<a href="#l33.1555"></a><span id="l33.1555" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l33.1556"></a><span id="l33.1556" class="difflineminus">-    MAPI_TRACE1( &quot;%s {Error retrieving property}\n&quot;, pTag);</span>
<a href="#l33.1557"></a><span id="l33.1557" class="difflineplus">+  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l33.1558"></a><span id="l33.1558" class="difflineplus">+    MAPI_TRACE1(&quot;%s {Error retrieving property}\n&quot;, pTag);</span>
<a href="#l33.1559"></a><span id="l33.1559">   }</span>
<a href="#l33.1560"></a><span id="l33.1560" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l33.1561"></a><span id="l33.1561" class="difflineminus">-    MAPI_TRACE1( &quot;%s {Error retrieving property}\n&quot;, pTag);</span>
<a href="#l33.1562"></a><span id="l33.1562" class="difflineplus">+  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l33.1563"></a><span id="l33.1563" class="difflineplus">+    MAPI_TRACE1(&quot;%s {Error retrieving property}\n&quot;, pTag);</span>
<a href="#l33.1564"></a><span id="l33.1564">   }</span>
<a href="#l33.1565"></a><span id="l33.1565">   else {</span>
<a href="#l33.1566"></a><span id="l33.1566" class="difflineminus">-    MAPI_TRACE1( &quot;%s invalid value, expecting long\n&quot;, pTag);</span>
<a href="#l33.1567"></a><span id="l33.1567" class="difflineplus">+    MAPI_TRACE1(&quot;%s invalid value, expecting long\n&quot;, pTag);</span>
<a href="#l33.1568"></a><span id="l33.1568">   }</span>
<a href="#l33.1569"></a><span id="l33.1569">   if (pVal)</span>
<a href="#l33.1570"></a><span id="l33.1570" class="difflineminus">-    MAPIFreeBuffer( pVal);</span>
<a href="#l33.1571"></a><span id="l33.1571" class="difflineplus">+    MAPIFreeBuffer(pVal);</span>
<a href="#l33.1572"></a><span id="l33.1572"> }</span>
<a href="#l33.1573"></a><span id="l33.1573"> </span>
<a href="#l33.1574"></a><span id="l33.1574" class="difflineminus">-void CMapiApi::ReportStringProp( const char *pTag, LPSPropValue pVal)</span>
<a href="#l33.1575"></a><span id="l33.1575" class="difflineplus">+void CMapiApi::ReportStringProp(const char *pTag, LPSPropValue pVal)</span>
<a href="#l33.1576"></a><span id="l33.1576"> {</span>
<a href="#l33.1577"></a><span id="l33.1577" class="difflineminus">-  if ( pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_TSTRING)) {</span>
<a href="#l33.1578"></a><span id="l33.1578" class="difflineplus">+  if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_TSTRING)) {</span>
<a href="#l33.1579"></a><span id="l33.1579">     nsCString val((LPCTSTR) (pVal-&gt;Value.LPSZ));</span>
<a href="#l33.1580"></a><span id="l33.1580">     MAPI_TRACE2(&quot;%s %s\n&quot;, pTag, val.get());</span>
<a href="#l33.1581"></a><span id="l33.1581">   }</span>
<a href="#l33.1582"></a><span id="l33.1582" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l33.1583"></a><span id="l33.1583" class="difflineminus">-    MAPI_TRACE1( &quot;%s {NULL}\n&quot;, pTag);</span>
<a href="#l33.1584"></a><span id="l33.1584" class="difflineplus">+  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l33.1585"></a><span id="l33.1585" class="difflineplus">+    MAPI_TRACE1(&quot;%s {NULL}\n&quot;, pTag);</span>
<a href="#l33.1586"></a><span id="l33.1586">   }</span>
<a href="#l33.1587"></a><span id="l33.1587" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE( pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l33.1588"></a><span id="l33.1588" class="difflineminus">-    MAPI_TRACE1( &quot;%s {Error retrieving property}\n&quot;, pTag);</span>
<a href="#l33.1589"></a><span id="l33.1589" class="difflineplus">+  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l33.1590"></a><span id="l33.1590" class="difflineplus">+    MAPI_TRACE1(&quot;%s {Error retrieving property}\n&quot;, pTag);</span>
<a href="#l33.1591"></a><span id="l33.1591">   }</span>
<a href="#l33.1592"></a><span id="l33.1592">   else {</span>
<a href="#l33.1593"></a><span id="l33.1593" class="difflineminus">-    MAPI_TRACE1( &quot;%s invalid value, expecting string\n&quot;, pTag);</span>
<a href="#l33.1594"></a><span id="l33.1594" class="difflineplus">+    MAPI_TRACE1(&quot;%s invalid value, expecting string\n&quot;, pTag);</span>
<a href="#l33.1595"></a><span id="l33.1595">   }</span>
<a href="#l33.1596"></a><span id="l33.1596">   if (pVal)</span>
<a href="#l33.1597"></a><span id="l33.1597" class="difflineminus">-    MAPIFreeBuffer( pVal);</span>
<a href="#l33.1598"></a><span id="l33.1598" class="difflineplus">+    MAPIFreeBuffer(pVal);</span>
<a href="#l33.1599"></a><span id="l33.1599"> }</span>
<a href="#l33.1600"></a><span id="l33.1600"> </span>
<a href="#l33.1601"></a><span id="l33.1601" class="difflineminus">-void CMapiApi::GetPropTagName( ULONG tag, nsCString&amp; s)</span>
<a href="#l33.1602"></a><span id="l33.1602" class="difflineplus">+void CMapiApi::GetPropTagName(ULONG tag, nsCString&amp; s)</span>
<a href="#l33.1603"></a><span id="l33.1603"> {</span>
<a href="#l33.1604"></a><span id="l33.1604">   char numStr[256];</span>
<a href="#l33.1605"></a><span id="l33.1605" class="difflineminus">-  PR_snprintf( numStr, 256, &quot;0x%lx, %ld&quot;, tag, tag);</span>
<a href="#l33.1606"></a><span id="l33.1606" class="difflineplus">+  PR_snprintf(numStr, 256, &quot;0x%lx, %ld&quot;, tag, tag);</span>
<a href="#l33.1607"></a><span id="l33.1607">   s = numStr;</span>
<a href="#l33.1608"></a><span id="l33.1608" class="difflineminus">-  switch( tag) {</span>
<a href="#l33.1609"></a><span id="l33.1609" class="difflineplus">+  switch(tag) {</span>
<a href="#l33.1610"></a><span id="l33.1610"> #include &quot;mapitagstrs.cpp&quot;</span>
<a href="#l33.1611"></a><span id="l33.1611">   }</span>
<a href="#l33.1612"></a><span id="l33.1612">   s += &quot;, data: &quot;;</span>
<a href="#l33.1613"></a><span id="l33.1613" class="difflineminus">-  switch( PROP_TYPE( tag)) {</span>
<a href="#l33.1614"></a><span id="l33.1614" class="difflineplus">+  switch(PROP_TYPE(tag)) {</span>
<a href="#l33.1615"></a><span id="l33.1615">     case PT_UNSPECIFIED: s += &quot;PT_UNSPECIFIED&quot;; break;</span>
<a href="#l33.1616"></a><span id="l33.1616">     case PT_NULL: s += &quot;PT_NULL&quot;; break;</span>
<a href="#l33.1617"></a><span id="l33.1617">     case PT_I2: s += &quot;PT_I2&quot;; break;</span>
<a href="#l33.1618"></a><span id="l33.1618">     case PT_LONG: s += &quot;PT_LONG&quot;; break;</span>
<a href="#l33.1619"></a><span id="l33.1619">     case PT_R4: s += &quot;PT_R4&quot;; break;</span>
<a href="#l33.1620"></a><span id="l33.1620">     case PT_DOUBLE: s += &quot;PT_DOUBLE&quot;; break;</span>
<a href="#l33.1621"></a><span id="l33.1621">     case PT_CURRENCY: s += &quot;PT_CURRENCY&quot;; break;</span>
<a href="#l33.1622"></a><span id="l33.1622">     case PT_APPTIME: s += &quot;PT_APPTIME&quot;; break;</span>
<a href="#l33.1623"></a><span id="l33.1623" class="difflineat">@@ -1517,51 +1509,51 @@ void CMapiApi::GetPropTagName( ULONG tag</span>
<a href="#l33.1624"></a><span id="l33.1624">     case PT_MV_UNICODE: s += &quot;PT_MV_UNICODE&quot;; break;</span>
<a href="#l33.1625"></a><span id="l33.1625">     case PT_MV_CLSID: s += &quot;PT_MV_CLSID&quot;; break;</span>
<a href="#l33.1626"></a><span id="l33.1626">     case PT_MV_I8: s += &quot;PT_MV_I8&quot;; break;</span>
<a href="#l33.1627"></a><span id="l33.1627">     default:</span>
<a href="#l33.1628"></a><span id="l33.1628">       s += &quot;Unknown&quot;;</span>
<a href="#l33.1629"></a><span id="l33.1629">   }</span>
<a href="#l33.1630"></a><span id="l33.1630"> }</span>
<a href="#l33.1631"></a><span id="l33.1631"> </span>
<a href="#l33.1632"></a><span id="l33.1632" class="difflineminus">-void CMapiApi::ListPropertyValue( LPSPropValue pVal, nsCString&amp; s)</span>
<a href="#l33.1633"></a><span id="l33.1633" class="difflineplus">+void CMapiApi::ListPropertyValue(LPSPropValue pVal, nsCString&amp; s)</span>
<a href="#l33.1634"></a><span id="l33.1634"> {</span>
<a href="#l33.1635"></a><span id="l33.1635">   nsCString    strVal;</span>
<a href="#l33.1636"></a><span id="l33.1636">   char      nBuff[64];</span>
<a href="#l33.1637"></a><span id="l33.1637"> </span>
<a href="#l33.1638"></a><span id="l33.1638">   s += &quot;value: &quot;;</span>
<a href="#l33.1639"></a><span id="l33.1639" class="difflineminus">-  switch (PROP_TYPE( pVal-&gt;ulPropTag)) {</span>
<a href="#l33.1640"></a><span id="l33.1640" class="difflineplus">+  switch (PROP_TYPE(pVal-&gt;ulPropTag)) {</span>
<a href="#l33.1641"></a><span id="l33.1641">     case PT_STRING8:</span>
<a href="#l33.1642"></a><span id="l33.1642" class="difflineminus">-      GetStringFromProp( pVal, strVal, FALSE);</span>
<a href="#l33.1643"></a><span id="l33.1643" class="difflineplus">+      GetStringFromProp(pVal, strVal, FALSE);</span>
<a href="#l33.1644"></a><span id="l33.1644">       if (strVal.Length() &gt; 60) {</span>
<a href="#l33.1645"></a><span id="l33.1645">         strVal.SetLength(60);</span>
<a href="#l33.1646"></a><span id="l33.1646">         strVal += &quot;...&quot;;</span>
<a href="#l33.1647"></a><span id="l33.1647">       }</span>
<a href="#l33.1648"></a><span id="l33.1648">       MsgReplaceSubstring(strVal, &quot;\r&quot;, &quot;\\r&quot;);</span>
<a href="#l33.1649"></a><span id="l33.1649">       MsgReplaceSubstring(strVal, &quot;\n&quot;, &quot;\\n&quot;);</span>
<a href="#l33.1650"></a><span id="l33.1650">       s += strVal;</span>
<a href="#l33.1651"></a><span id="l33.1651">     break;</span>
<a href="#l33.1652"></a><span id="l33.1652">     case PT_LONG:</span>
<a href="#l33.1653"></a><span id="l33.1653" class="difflineminus">-      s.AppendInt( (PRInt32) pVal-&gt;Value.l);</span>
<a href="#l33.1654"></a><span id="l33.1654" class="difflineplus">+      s.AppendInt((PRInt32) pVal-&gt;Value.l);</span>
<a href="#l33.1655"></a><span id="l33.1655">       s += &quot;, 0x&quot;;</span>
<a href="#l33.1656"></a><span id="l33.1656" class="difflineminus">-      s.AppendInt( (PRInt32) pVal-&gt;Value.l, 16);</span>
<a href="#l33.1657"></a><span id="l33.1657" class="difflineplus">+      s.AppendInt((PRInt32) pVal-&gt;Value.l, 16);</span>
<a href="#l33.1658"></a><span id="l33.1658">       s += nBuff;</span>
<a href="#l33.1659"></a><span id="l33.1659">     break;</span>
<a href="#l33.1660"></a><span id="l33.1660">     case PT_BOOLEAN:</span>
<a href="#l33.1661"></a><span id="l33.1661">       if (pVal-&gt;Value.b)</span>
<a href="#l33.1662"></a><span id="l33.1662">         s += &quot;True&quot;;</span>
<a href="#l33.1663"></a><span id="l33.1663">       else</span>
<a href="#l33.1664"></a><span id="l33.1664">         s += &quot;False&quot;;</span>
<a href="#l33.1665"></a><span id="l33.1665">     break;</span>
<a href="#l33.1666"></a><span id="l33.1666">     case PT_NULL:</span>
<a href="#l33.1667"></a><span id="l33.1667">       s += &quot;--NULL--&quot;;</span>
<a href="#l33.1668"></a><span id="l33.1668">     break;</span>
<a href="#l33.1669"></a><span id="l33.1669">     case PT_SYSTIME: {</span>
<a href="#l33.1670"></a><span id="l33.1670">       /*</span>
<a href="#l33.1671"></a><span id="l33.1671" class="difflineminus">-      COleDateTime  tm( pVal-&gt;Value.ft);</span>
<a href="#l33.1672"></a><span id="l33.1672" class="difflineplus">+      COleDateTime  tm(pVal-&gt;Value.ft);</span>
<a href="#l33.1673"></a><span id="l33.1673">       s += tm.Format();</span>
<a href="#l33.1674"></a><span id="l33.1674">       */</span>
<a href="#l33.1675"></a><span id="l33.1675">       s += &quot;-- Figure out how to format time in mozilla, PT_SYSTIME --&quot;;</span>
<a href="#l33.1676"></a><span id="l33.1676">     }</span>
<a href="#l33.1677"></a><span id="l33.1677">     break;</span>
<a href="#l33.1678"></a><span id="l33.1678">     default:</span>
<a href="#l33.1679"></a><span id="l33.1679">      s += &quot;?&quot;;</span>
<a href="#l33.1680"></a><span id="l33.1680">   }</span>
<a href="#l33.1681"></a><span id="l33.1681" class="difflineat">@@ -1576,57 +1568,57 @@ CMapiFolderList::CMapiFolderList()</span>
<a href="#l33.1682"></a><span id="l33.1682"> {</span>
<a href="#l33.1683"></a><span id="l33.1683"> }</span>
<a href="#l33.1684"></a><span id="l33.1684"> </span>
<a href="#l33.1685"></a><span id="l33.1685"> CMapiFolderList::~CMapiFolderList()</span>
<a href="#l33.1686"></a><span id="l33.1686"> {</span>
<a href="#l33.1687"></a><span id="l33.1687">   ClearAll();</span>
<a href="#l33.1688"></a><span id="l33.1688"> }</span>
<a href="#l33.1689"></a><span id="l33.1689"> </span>
<a href="#l33.1690"></a><span id="l33.1690" class="difflineminus">-void CMapiFolderList::AddItem( CMapiFolder *pFolder)</span>
<a href="#l33.1691"></a><span id="l33.1691" class="difflineplus">+void CMapiFolderList::AddItem(CMapiFolder *pFolder)</span>
<a href="#l33.1692"></a><span id="l33.1692"> {</span>
<a href="#l33.1693"></a><span id="l33.1693" class="difflineminus">-  EnsureUniqueName( pFolder);</span>
<a href="#l33.1694"></a><span id="l33.1694" class="difflineminus">-  GenerateFilePath( pFolder);</span>
<a href="#l33.1695"></a><span id="l33.1695" class="difflineminus">-  m_array.AppendElement( pFolder);</span>
<a href="#l33.1696"></a><span id="l33.1696" class="difflineplus">+  EnsureUniqueName(pFolder);</span>
<a href="#l33.1697"></a><span id="l33.1697" class="difflineplus">+  GenerateFilePath(pFolder);</span>
<a href="#l33.1698"></a><span id="l33.1698" class="difflineplus">+  m_array.AppendElement(pFolder);</span>
<a href="#l33.1699"></a><span id="l33.1699"> }</span>
<a href="#l33.1700"></a><span id="l33.1700"> </span>
<a href="#l33.1701"></a><span id="l33.1701" class="difflineminus">-void CMapiFolderList::ChangeName( nsString&amp; name)</span>
<a href="#l33.1702"></a><span id="l33.1702" class="difflineplus">+void CMapiFolderList::ChangeName(nsString&amp; name)</span>
<a href="#l33.1703"></a><span id="l33.1703"> {</span>
<a href="#l33.1704"></a><span id="l33.1704">   if (name.IsEmpty()) {</span>
<a href="#l33.1705"></a><span id="l33.1705">     name.AssignLiteral(&quot;1&quot;);</span>
<a href="#l33.1706"></a><span id="l33.1706">     return;</span>
<a href="#l33.1707"></a><span id="l33.1707">   }</span>
<a href="#l33.1708"></a><span id="l33.1708">   PRUnichar lastC = name.Last();</span>
<a href="#l33.1709"></a><span id="l33.1709">   if ((lastC &gt;= '0') &amp;&amp; (lastC &lt;= '9')) {</span>
<a href="#l33.1710"></a><span id="l33.1710">     lastC++;</span>
<a href="#l33.1711"></a><span id="l33.1711">     if (lastC &gt; '9') {</span>
<a href="#l33.1712"></a><span id="l33.1712">       lastC = '1';</span>
<a href="#l33.1713"></a><span id="l33.1713" class="difflineminus">-      name.SetCharAt( lastC, name.Length() - 1);</span>
<a href="#l33.1714"></a><span id="l33.1714" class="difflineplus">+      name.SetCharAt(lastC, name.Length() - 1);</span>
<a href="#l33.1715"></a><span id="l33.1715">       name.AppendLiteral(&quot;0&quot;);</span>
<a href="#l33.1716"></a><span id="l33.1716">     }</span>
<a href="#l33.1717"></a><span id="l33.1717">     else {</span>
<a href="#l33.1718"></a><span id="l33.1718" class="difflineminus">-      name.SetCharAt( lastC, name.Length() - 1);</span>
<a href="#l33.1719"></a><span id="l33.1719" class="difflineplus">+      name.SetCharAt(lastC, name.Length() - 1);</span>
<a href="#l33.1720"></a><span id="l33.1720">     }</span>
<a href="#l33.1721"></a><span id="l33.1721">   }</span>
<a href="#l33.1722"></a><span id="l33.1722">   else {</span>
<a href="#l33.1723"></a><span id="l33.1723">     name.AppendLiteral(&quot; 2&quot;);</span>
<a href="#l33.1724"></a><span id="l33.1724">   }</span>
<a href="#l33.1725"></a><span id="l33.1725"> }</span>
<a href="#l33.1726"></a><span id="l33.1726"> </span>
<a href="#l33.1727"></a><span id="l33.1727" class="difflineminus">-void CMapiFolderList::EnsureUniqueName( CMapiFolder *pFolder)</span>
<a href="#l33.1728"></a><span id="l33.1728" class="difflineplus">+void CMapiFolderList::EnsureUniqueName(CMapiFolder *pFolder)</span>
<a href="#l33.1729"></a><span id="l33.1729"> {</span>
<a href="#l33.1730"></a><span id="l33.1730">   // For everybody in the array before me with the SAME</span>
<a href="#l33.1731"></a><span id="l33.1731">   // depth, my name must be unique</span>
<a href="#l33.1732"></a><span id="l33.1732">   CMapiFolder *  pCurrent;</span>
<a href="#l33.1733"></a><span id="l33.1733">   int        i;</span>
<a href="#l33.1734"></a><span id="l33.1734">   BOOL      done;</span>
<a href="#l33.1735"></a><span id="l33.1735">   nsString    name;</span>
<a href="#l33.1736"></a><span id="l33.1736">   nsString    cName;</span>
<a href="#l33.1737"></a><span id="l33.1737"> </span>
<a href="#l33.1738"></a><span id="l33.1738" class="difflineminus">-  pFolder-&gt;GetDisplayName( name);</span>
<a href="#l33.1739"></a><span id="l33.1739" class="difflineplus">+  pFolder-&gt;GetDisplayName(name);</span>
<a href="#l33.1740"></a><span id="l33.1740">   do {</span>
<a href="#l33.1741"></a><span id="l33.1741">     done = TRUE;</span>
<a href="#l33.1742"></a><span id="l33.1742">     i = m_array.Count() - 1;</span>
<a href="#l33.1743"></a><span id="l33.1743">     while (i &gt;= 0) {</span>
<a href="#l33.1744"></a><span id="l33.1744">       pCurrent = (CMapiFolder *)GetAt(i);</span>
<a href="#l33.1745"></a><span id="l33.1745">       if (pCurrent-&gt;GetDepth() == pFolder-&gt;GetDepth()) {</span>
<a href="#l33.1746"></a><span id="l33.1746">         pCurrent-&gt;GetDisplayName(cName);</span>
<a href="#l33.1747"></a><span id="l33.1747">         if (cName.Equals(name, nsCaseInsensitiveStringComparator())) {</span>
<a href="#l33.1748"></a><span id="l33.1748" class="difflineat">@@ -1638,219 +1630,219 @@ void CMapiFolderList::EnsureUniqueName( </span>
<a href="#l33.1749"></a><span id="l33.1749">       }</span>
<a href="#l33.1750"></a><span id="l33.1750">       else if (pCurrent-&gt;GetDepth() &lt; pFolder-&gt;GetDepth())</span>
<a href="#l33.1751"></a><span id="l33.1751">         break;</span>
<a href="#l33.1752"></a><span id="l33.1752">       i--;</span>
<a href="#l33.1753"></a><span id="l33.1753">     }</span>
<a href="#l33.1754"></a><span id="l33.1754">   } while (!done);</span>
<a href="#l33.1755"></a><span id="l33.1755"> }</span>
<a href="#l33.1756"></a><span id="l33.1756"> </span>
<a href="#l33.1757"></a><span id="l33.1757" class="difflineminus">-void CMapiFolderList::GenerateFilePath( CMapiFolder *pFolder)</span>
<a href="#l33.1758"></a><span id="l33.1758" class="difflineplus">+void CMapiFolderList::GenerateFilePath(CMapiFolder *pFolder)</span>
<a href="#l33.1759"></a><span id="l33.1759"> {</span>
<a href="#l33.1760"></a><span id="l33.1760">   // A file path, includes all of my parent's path, plus mine</span>
<a href="#l33.1761"></a><span id="l33.1761">   nsString    name;</span>
<a href="#l33.1762"></a><span id="l33.1762">   nsString    path;</span>
<a href="#l33.1763"></a><span id="l33.1763">   if (!pFolder-&gt;GetDepth()) {</span>
<a href="#l33.1764"></a><span id="l33.1764" class="difflineminus">-    pFolder-&gt;GetDisplayName( name);</span>
<a href="#l33.1765"></a><span id="l33.1765" class="difflineplus">+    pFolder-&gt;GetDisplayName(name);</span>
<a href="#l33.1766"></a><span id="l33.1766">     pFolder-&gt;SetFilePath(name.get());</span>
<a href="#l33.1767"></a><span id="l33.1767">     return;</span>
<a href="#l33.1768"></a><span id="l33.1768">   }</span>
<a href="#l33.1769"></a><span id="l33.1769"> </span>
<a href="#l33.1770"></a><span id="l33.1770">   CMapiFolder *  pCurrent;</span>
<a href="#l33.1771"></a><span id="l33.1771">   int        i = m_array.Count() - 1;</span>
<a href="#l33.1772"></a><span id="l33.1772">   while (i &gt;= 0) {</span>
<a href="#l33.1773"></a><span id="l33.1773" class="difflineminus">-    pCurrent = (CMapiFolder *) GetAt( i);</span>
<a href="#l33.1774"></a><span id="l33.1774" class="difflineplus">+    pCurrent = (CMapiFolder *) GetAt(i);</span>
<a href="#l33.1775"></a><span id="l33.1775">     if (pCurrent-&gt;GetDepth() == (pFolder-&gt;GetDepth() - 1)) {</span>
<a href="#l33.1776"></a><span id="l33.1776" class="difflineminus">-      pCurrent-&gt;GetFilePath( path);</span>
<a href="#l33.1777"></a><span id="l33.1777" class="difflineplus">+      pCurrent-&gt;GetFilePath(path);</span>
<a href="#l33.1778"></a><span id="l33.1778">       path.AppendLiteral(&quot;.sbd\\&quot;);</span>
<a href="#l33.1779"></a><span id="l33.1779" class="difflineminus">-      pFolder-&gt;GetDisplayName( name);</span>
<a href="#l33.1780"></a><span id="l33.1780" class="difflineplus">+      pFolder-&gt;GetDisplayName(name);</span>
<a href="#l33.1781"></a><span id="l33.1781">       path += name;</span>
<a href="#l33.1782"></a><span id="l33.1782">       pFolder-&gt;SetFilePath(path.get());</span>
<a href="#l33.1783"></a><span id="l33.1783">       return;</span>
<a href="#l33.1784"></a><span id="l33.1784">     }</span>
<a href="#l33.1785"></a><span id="l33.1785">     i--;</span>
<a href="#l33.1786"></a><span id="l33.1786">   }</span>
<a href="#l33.1787"></a><span id="l33.1787" class="difflineminus">-  pFolder-&gt;GetDisplayName( name);</span>
<a href="#l33.1788"></a><span id="l33.1788" class="difflineplus">+  pFolder-&gt;GetDisplayName(name);</span>
<a href="#l33.1789"></a><span id="l33.1789">   pFolder-&gt;SetFilePath(name.get());</span>
<a href="#l33.1790"></a><span id="l33.1790"> }</span>
<a href="#l33.1791"></a><span id="l33.1791"> </span>
<a href="#l33.1792"></a><span id="l33.1792" class="difflineminus">-void CMapiFolderList::ClearAll( void)</span>
<a href="#l33.1793"></a><span id="l33.1793" class="difflineplus">+void CMapiFolderList::ClearAll(void)</span>
<a href="#l33.1794"></a><span id="l33.1794"> {</span>
<a href="#l33.1795"></a><span id="l33.1795">   CMapiFolder *pFolder;</span>
<a href="#l33.1796"></a><span id="l33.1796">   for (int i = 0; i &lt; m_array.Count(); i++) {</span>
<a href="#l33.1797"></a><span id="l33.1797" class="difflineminus">-    pFolder = (CMapiFolder *)GetAt( i);</span>
<a href="#l33.1798"></a><span id="l33.1798" class="difflineplus">+    pFolder = (CMapiFolder *)GetAt(i);</span>
<a href="#l33.1799"></a><span id="l33.1799">     delete pFolder;</span>
<a href="#l33.1800"></a><span id="l33.1800">   }</span>
<a href="#l33.1801"></a><span id="l33.1801">   m_array.Clear();</span>
<a href="#l33.1802"></a><span id="l33.1802"> }</span>
<a href="#l33.1803"></a><span id="l33.1803"> </span>
<a href="#l33.1804"></a><span id="l33.1804" class="difflineminus">-void CMapiFolderList::DumpList( void)</span>
<a href="#l33.1805"></a><span id="l33.1805" class="difflineplus">+void CMapiFolderList::DumpList(void)</span>
<a href="#l33.1806"></a><span id="l33.1806"> {</span>
<a href="#l33.1807"></a><span id="l33.1807">   CMapiFolder *pFolder;</span>
<a href="#l33.1808"></a><span id="l33.1808">   nsString  str;</span>
<a href="#l33.1809"></a><span id="l33.1809">   int      depth;</span>
<a href="#l33.1810"></a><span id="l33.1810">   char    prefix[256];</span>
<a href="#l33.1811"></a><span id="l33.1811"> </span>
<a href="#l33.1812"></a><span id="l33.1812" class="difflineminus">-  MAPI_TRACE0( &quot;Folder List ---------------------------------\n&quot;);</span>
<a href="#l33.1813"></a><span id="l33.1813" class="difflineplus">+  MAPI_TRACE0(&quot;Folder List ---------------------------------\n&quot;);</span>
<a href="#l33.1814"></a><span id="l33.1814">   for (int i = 0; i &lt; m_array.Count(); i++) {</span>
<a href="#l33.1815"></a><span id="l33.1815" class="difflineminus">-    pFolder = (CMapiFolder *)GetAt( i);</span>
<a href="#l33.1816"></a><span id="l33.1816" class="difflineplus">+    pFolder = (CMapiFolder *)GetAt(i);</span>
<a href="#l33.1817"></a><span id="l33.1817">     depth = pFolder-&gt;GetDepth();</span>
<a href="#l33.1818"></a><span id="l33.1818" class="difflineminus">-    pFolder-&gt;GetDisplayName( str);</span>
<a href="#l33.1819"></a><span id="l33.1819" class="difflineplus">+    pFolder-&gt;GetDisplayName(str);</span>
<a href="#l33.1820"></a><span id="l33.1820">     depth *= 2;</span>
<a href="#l33.1821"></a><span id="l33.1821">     if (depth &gt; 255)</span>
<a href="#l33.1822"></a><span id="l33.1822">       depth = 255;</span>
<a href="#l33.1823"></a><span id="l33.1823" class="difflineminus">-    memset( prefix, ' ', depth);</span>
<a href="#l33.1824"></a><span id="l33.1824" class="difflineplus">+    memset(prefix, ' ', depth);</span>
<a href="#l33.1825"></a><span id="l33.1825">     prefix[depth] = 0;</span>
<a href="#l33.1826"></a><span id="l33.1826"> #ifdef MAPI_DEBUG</span>
<a href="#l33.1827"></a><span id="l33.1827">         char *ansiStr = ToNewCString(str);</span>
<a href="#l33.1828"></a><span id="l33.1828" class="difflineminus">-    MAPI_TRACE2( &quot;%s%s: &quot;, prefix, ansiStr);</span>
<a href="#l33.1829"></a><span id="l33.1829" class="difflineplus">+    MAPI_TRACE2(&quot;%s%s: &quot;, prefix, ansiStr);</span>
<a href="#l33.1830"></a><span id="l33.1830">     NS_Free(ansiStr);</span>
<a href="#l33.1831"></a><span id="l33.1831"> #endif</span>
<a href="#l33.1832"></a><span id="l33.1832" class="difflineminus">-    pFolder-&gt;GetFilePath( str);</span>
<a href="#l33.1833"></a><span id="l33.1833" class="difflineplus">+    pFolder-&gt;GetFilePath(str);</span>
<a href="#l33.1834"></a><span id="l33.1834"> #ifdef MAPI_DEBUG</span>
<a href="#l33.1835"></a><span id="l33.1835">         ansiStr = ToNewCString(str);</span>
<a href="#l33.1836"></a><span id="l33.1836" class="difflineminus">-    MAPI_TRACE2( &quot;depth=%d, filePath=%s\n&quot;, pFolder-&gt;GetDepth(), ansiStr);</span>
<a href="#l33.1837"></a><span id="l33.1837" class="difflineplus">+    MAPI_TRACE2(&quot;depth=%d, filePath=%s\n&quot;, pFolder-&gt;GetDepth(), ansiStr);</span>
<a href="#l33.1838"></a><span id="l33.1838">     NS_Free(ansiStr);</span>
<a href="#l33.1839"></a><span id="l33.1839"> #endif</span>
<a href="#l33.1840"></a><span id="l33.1840">   }</span>
<a href="#l33.1841"></a><span id="l33.1841" class="difflineminus">-  MAPI_TRACE0( &quot;---------------------------------------------\n&quot;);</span>
<a href="#l33.1842"></a><span id="l33.1842" class="difflineplus">+  MAPI_TRACE0(&quot;---------------------------------------------\n&quot;);</span>
<a href="#l33.1843"></a><span id="l33.1843"> }</span>
<a href="#l33.1844"></a><span id="l33.1844"> </span>
<a href="#l33.1845"></a><span id="l33.1845"> </span>
<a href="#l33.1846"></a><span id="l33.1846"> CMapiFolder::CMapiFolder()</span>
<a href="#l33.1847"></a><span id="l33.1847"> {</span>
<a href="#l33.1848"></a><span id="l33.1848">   m_objectType = MAPI_FOLDER;</span>
<a href="#l33.1849"></a><span id="l33.1849">   m_cbEid = 0;</span>
<a href="#l33.1850"></a><span id="l33.1850">   m_lpEid = NULL;</span>
<a href="#l33.1851"></a><span id="l33.1851">   m_depth = 0;</span>
<a href="#l33.1852"></a><span id="l33.1852">   m_doImport = TRUE;</span>
<a href="#l33.1853"></a><span id="l33.1853"> }</span>
<a href="#l33.1854"></a><span id="l33.1854"> </span>
<a href="#l33.1855"></a><span id="l33.1855" class="difflineminus">-CMapiFolder::CMapiFolder( const PRUnichar *pDisplayName, ULONG cbEid, LPENTRYID lpEid, int depth, LONG oType)</span>
<a href="#l33.1856"></a><span id="l33.1856" class="difflineplus">+CMapiFolder::CMapiFolder(const PRUnichar *pDisplayName, ULONG cbEid, LPENTRYID lpEid, int depth, LONG oType)</span>
<a href="#l33.1857"></a><span id="l33.1857"> {</span>
<a href="#l33.1858"></a><span id="l33.1858">   m_cbEid = 0;</span>
<a href="#l33.1859"></a><span id="l33.1859">   m_lpEid = NULL;</span>
<a href="#l33.1860"></a><span id="l33.1860" class="difflineminus">-  SetDisplayName( pDisplayName);</span>
<a href="#l33.1861"></a><span id="l33.1861" class="difflineminus">-  SetEntryID( cbEid, lpEid);</span>
<a href="#l33.1862"></a><span id="l33.1862" class="difflineminus">-  SetDepth( depth);</span>
<a href="#l33.1863"></a><span id="l33.1863" class="difflineminus">-  SetObjectType( oType);</span>
<a href="#l33.1864"></a><span id="l33.1864" class="difflineminus">-  SetDoImport( TRUE);</span>
<a href="#l33.1865"></a><span id="l33.1865" class="difflineplus">+  SetDisplayName(pDisplayName);</span>
<a href="#l33.1866"></a><span id="l33.1866" class="difflineplus">+  SetEntryID(cbEid, lpEid);</span>
<a href="#l33.1867"></a><span id="l33.1867" class="difflineplus">+  SetDepth(depth);</span>
<a href="#l33.1868"></a><span id="l33.1868" class="difflineplus">+  SetObjectType(oType);</span>
<a href="#l33.1869"></a><span id="l33.1869" class="difflineplus">+  SetDoImport(TRUE);</span>
<a href="#l33.1870"></a><span id="l33.1870"> }</span>
<a href="#l33.1871"></a><span id="l33.1871"> </span>
<a href="#l33.1872"></a><span id="l33.1872" class="difflineminus">-CMapiFolder::CMapiFolder( const CMapiFolder *pCopyFrom)</span>
<a href="#l33.1873"></a><span id="l33.1873" class="difflineplus">+CMapiFolder::CMapiFolder(const CMapiFolder *pCopyFrom)</span>
<a href="#l33.1874"></a><span id="l33.1874"> {</span>
<a href="#l33.1875"></a><span id="l33.1875">   m_lpEid = NULL;</span>
<a href="#l33.1876"></a><span id="l33.1876">   m_cbEid = 0;</span>
<a href="#l33.1877"></a><span id="l33.1877" class="difflineminus">-  SetDoImport( pCopyFrom-&gt;GetDoImport());</span>
<a href="#l33.1878"></a><span id="l33.1878" class="difflineplus">+  SetDoImport(pCopyFrom-&gt;GetDoImport());</span>
<a href="#l33.1879"></a><span id="l33.1879">   SetDisplayName(pCopyFrom-&gt;m_displayName.get());</span>
<a href="#l33.1880"></a><span id="l33.1880" class="difflineminus">-  SetObjectType( pCopyFrom-&gt;GetObjectType());</span>
<a href="#l33.1881"></a><span id="l33.1881" class="difflineminus">-  SetEntryID( pCopyFrom-&gt;GetCBEntryID(), pCopyFrom-&gt;GetEntryID());</span>
<a href="#l33.1882"></a><span id="l33.1882" class="difflineminus">-  SetDepth( pCopyFrom-&gt;GetDepth());</span>
<a href="#l33.1883"></a><span id="l33.1883" class="difflineplus">+  SetObjectType(pCopyFrom-&gt;GetObjectType());</span>
<a href="#l33.1884"></a><span id="l33.1884" class="difflineplus">+  SetEntryID(pCopyFrom-&gt;GetCBEntryID(), pCopyFrom-&gt;GetEntryID());</span>
<a href="#l33.1885"></a><span id="l33.1885" class="difflineplus">+  SetDepth(pCopyFrom-&gt;GetDepth());</span>
<a href="#l33.1886"></a><span id="l33.1886">   SetFilePath(pCopyFrom-&gt;m_mailFilePath.get());</span>
<a href="#l33.1887"></a><span id="l33.1887"> }</span>
<a href="#l33.1888"></a><span id="l33.1888"> </span>
<a href="#l33.1889"></a><span id="l33.1889"> CMapiFolder::~CMapiFolder()</span>
<a href="#l33.1890"></a><span id="l33.1890"> {</span>
<a href="#l33.1891"></a><span id="l33.1891">   if (m_lpEid)</span>
<a href="#l33.1892"></a><span id="l33.1892">     delete m_lpEid;</span>
<a href="#l33.1893"></a><span id="l33.1893"> }</span>
<a href="#l33.1894"></a><span id="l33.1894"> </span>
<a href="#l33.1895"></a><span id="l33.1895" class="difflineminus">-void CMapiFolder::SetEntryID( ULONG cbEid, LPENTRYID lpEid)</span>
<a href="#l33.1896"></a><span id="l33.1896" class="difflineplus">+void CMapiFolder::SetEntryID(ULONG cbEid, LPENTRYID lpEid)</span>
<a href="#l33.1897"></a><span id="l33.1897"> {</span>
<a href="#l33.1898"></a><span id="l33.1898">   if (m_lpEid)</span>
<a href="#l33.1899"></a><span id="l33.1899">     delete m_lpEid;</span>
<a href="#l33.1900"></a><span id="l33.1900">   m_lpEid = NULL;</span>
<a href="#l33.1901"></a><span id="l33.1901">   m_cbEid = cbEid;</span>
<a href="#l33.1902"></a><span id="l33.1902">   if (cbEid) {</span>
<a href="#l33.1903"></a><span id="l33.1903">     m_lpEid = new BYTE[cbEid];</span>
<a href="#l33.1904"></a><span id="l33.1904" class="difflineminus">-    memcpy( m_lpEid, lpEid, cbEid);</span>
<a href="#l33.1905"></a><span id="l33.1905" class="difflineplus">+    memcpy(m_lpEid, lpEid, cbEid);</span>
<a href="#l33.1906"></a><span id="l33.1906">   }</span>
<a href="#l33.1907"></a><span id="l33.1907"> }</span>
<a href="#l33.1908"></a><span id="l33.1908"> </span>
<a href="#l33.1909"></a><span id="l33.1909"> // ---------------------------------------------------------------------</span>
<a href="#l33.1910"></a><span id="l33.1910"> // Message store stuff</span>
<a href="#l33.1911"></a><span id="l33.1911"> // ---------------------------------------------------------------------</span>
<a href="#l33.1912"></a><span id="l33.1912"> </span>
<a href="#l33.1913"></a><span id="l33.1913"> </span>
<a href="#l33.1914"></a><span id="l33.1914" class="difflineminus">-CMsgStore::CMsgStore( ULONG cbEid, LPENTRYID lpEid)</span>
<a href="#l33.1915"></a><span id="l33.1915" class="difflineplus">+CMsgStore::CMsgStore(ULONG cbEid, LPENTRYID lpEid)</span>
<a href="#l33.1916"></a><span id="l33.1916"> {</span>
<a href="#l33.1917"></a><span id="l33.1917">   m_lpEid = NULL;</span>
<a href="#l33.1918"></a><span id="l33.1918">   m_lpMdb = NULL;</span>
<a href="#l33.1919"></a><span id="l33.1919" class="difflineminus">-  SetEntryID( cbEid, lpEid);</span>
<a href="#l33.1920"></a><span id="l33.1920" class="difflineplus">+  SetEntryID(cbEid, lpEid);</span>
<a href="#l33.1921"></a><span id="l33.1921"> }</span>
<a href="#l33.1922"></a><span id="l33.1922"> </span>
<a href="#l33.1923"></a><span id="l33.1923"> CMsgStore::~CMsgStore()</span>
<a href="#l33.1924"></a><span id="l33.1924"> {</span>
<a href="#l33.1925"></a><span id="l33.1925">   if (m_lpEid)</span>
<a href="#l33.1926"></a><span id="l33.1926">     delete m_lpEid;</span>
<a href="#l33.1927"></a><span id="l33.1927"> </span>
<a href="#l33.1928"></a><span id="l33.1928">   if (m_lpMdb) {</span>
<a href="#l33.1929"></a><span id="l33.1929">     ULONG flags = LOGOFF_NO_WAIT;</span>
<a href="#l33.1930"></a><span id="l33.1930" class="difflineminus">-    HRESULT hr = m_lpMdb-&gt;StoreLogoff( &amp;flags);</span>
<a href="#l33.1931"></a><span id="l33.1931" class="difflineplus">+    HRESULT hr = m_lpMdb-&gt;StoreLogoff(&amp;flags);</span>
<a href="#l33.1932"></a><span id="l33.1932">     m_lpMdb-&gt;Release();</span>
<a href="#l33.1933"></a><span id="l33.1933">     m_lpMdb = NULL;</span>
<a href="#l33.1934"></a><span id="l33.1934">   }</span>
<a href="#l33.1935"></a><span id="l33.1935"> }</span>
<a href="#l33.1936"></a><span id="l33.1936"> </span>
<a href="#l33.1937"></a><span id="l33.1937" class="difflineminus">-void CMsgStore::SetEntryID( ULONG cbEid, LPENTRYID lpEid)</span>
<a href="#l33.1938"></a><span id="l33.1938" class="difflineplus">+void CMsgStore::SetEntryID(ULONG cbEid, LPENTRYID lpEid)</span>
<a href="#l33.1939"></a><span id="l33.1939"> {</span>
<a href="#l33.1940"></a><span id="l33.1940">   HRESULT    hr;</span>
<a href="#l33.1941"></a><span id="l33.1941"> </span>
<a href="#l33.1942"></a><span id="l33.1942">   if (m_lpEid)</span>
<a href="#l33.1943"></a><span id="l33.1943">     delete m_lpEid;</span>
<a href="#l33.1944"></a><span id="l33.1944"> </span>
<a href="#l33.1945"></a><span id="l33.1945">   m_lpEid = NULL;</span>
<a href="#l33.1946"></a><span id="l33.1946">   if (cbEid) {</span>
<a href="#l33.1947"></a><span id="l33.1947">     m_lpEid = new BYTE[cbEid];</span>
<a href="#l33.1948"></a><span id="l33.1948" class="difflineminus">-    memcpy( m_lpEid, lpEid, cbEid);</span>
<a href="#l33.1949"></a><span id="l33.1949" class="difflineplus">+    memcpy(m_lpEid, lpEid, cbEid);</span>
<a href="#l33.1950"></a><span id="l33.1950">   }</span>
<a href="#l33.1951"></a><span id="l33.1951">   m_cbEid = cbEid;</span>
<a href="#l33.1952"></a><span id="l33.1952"> </span>
<a href="#l33.1953"></a><span id="l33.1953">   if (m_lpMdb) {</span>
<a href="#l33.1954"></a><span id="l33.1954">     ULONG flags = LOGOFF_NO_WAIT;</span>
<a href="#l33.1955"></a><span id="l33.1955" class="difflineminus">-    hr = m_lpMdb-&gt;StoreLogoff( &amp;flags);</span>
<a href="#l33.1956"></a><span id="l33.1956" class="difflineplus">+    hr = m_lpMdb-&gt;StoreLogoff(&amp;flags);</span>
<a href="#l33.1957"></a><span id="l33.1957">     m_lpMdb-&gt;Release();</span>
<a href="#l33.1958"></a><span id="l33.1958">     m_lpMdb = NULL;</span>
<a href="#l33.1959"></a><span id="l33.1959">   }</span>
<a href="#l33.1960"></a><span id="l33.1960"> }</span>
<a href="#l33.1961"></a><span id="l33.1961"> </span>
<a href="#l33.1962"></a><span id="l33.1962" class="difflineminus">-BOOL CMsgStore::Open( LPMAPISESSION pSession, LPMDB *ppMdb)</span>
<a href="#l33.1963"></a><span id="l33.1963" class="difflineplus">+BOOL CMsgStore::Open(LPMAPISESSION pSession, LPMDB *ppMdb)</span>
<a href="#l33.1964"></a><span id="l33.1964"> {</span>
<a href="#l33.1965"></a><span id="l33.1965" class="difflineminus">-  if ( m_lpMdb) {</span>
<a href="#l33.1966"></a><span id="l33.1966" class="difflineplus">+  if (m_lpMdb) {</span>
<a href="#l33.1967"></a><span id="l33.1967">     if (ppMdb)</span>
<a href="#l33.1968"></a><span id="l33.1968">       *ppMdb = m_lpMdb;</span>
<a href="#l33.1969"></a><span id="l33.1969" class="difflineminus">-    return( TRUE);</span>
<a href="#l33.1970"></a><span id="l33.1970" class="difflineplus">+    return TRUE;</span>
<a href="#l33.1971"></a><span id="l33.1971">   }</span>
<a href="#l33.1972"></a><span id="l33.1972"> </span>
<a href="#l33.1973"></a><span id="l33.1973">   BOOL bResult = TRUE;</span>
<a href="#l33.1974"></a><span id="l33.1974" class="difflineminus">-  HRESULT hr = pSession-&gt;OpenMsgStore( NULL, m_cbEid, (LPENTRYID)m_lpEid, NULL, MDB_NO_MAIL, &amp;m_lpMdb);    // MDB pointer</span>
<a href="#l33.1975"></a><span id="l33.1975" class="difflineminus">-  if (HR_FAILED( hr)) {</span>
<a href="#l33.1976"></a><span id="l33.1976" class="difflineplus">+  HRESULT hr = pSession-&gt;OpenMsgStore(NULL, m_cbEid, (LPENTRYID)m_lpEid, NULL, MDB_NO_MAIL, &amp;m_lpMdb);    // MDB pointer</span>
<a href="#l33.1977"></a><span id="l33.1977" class="difflineplus">+  if (HR_FAILED(hr)) {</span>
<a href="#l33.1978"></a><span id="l33.1978">     m_lpMdb = NULL;</span>
<a href="#l33.1979"></a><span id="l33.1979" class="difflineminus">-    MAPI_TRACE2( &quot;OpenMsgStore failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.1980"></a><span id="l33.1980" class="difflineplus">+    MAPI_TRACE2(&quot;OpenMsgStore failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.1981"></a><span id="l33.1981">     bResult = FALSE;</span>
<a href="#l33.1982"></a><span id="l33.1982">   }</span>
<a href="#l33.1983"></a><span id="l33.1983"> </span>
<a href="#l33.1984"></a><span id="l33.1984">   if (ppMdb)</span>
<a href="#l33.1985"></a><span id="l33.1985">     *ppMdb = m_lpMdb;</span>
<a href="#l33.1986"></a><span id="l33.1986" class="difflineminus">-  return( bResult);</span>
<a href="#l33.1987"></a><span id="l33.1987" class="difflineplus">+  return bResult;</span>
<a href="#l33.1988"></a><span id="l33.1988"> }</span>
<a href="#l33.1989"></a><span id="l33.1989"> </span>
<a href="#l33.1990"></a><span id="l33.1990"> </span>
<a href="#l33.1991"></a><span id="l33.1991"> </span>
<a href="#l33.1992"></a><span id="l33.1992"> // ------------------------------------------------------------</span>
<a href="#l33.1993"></a><span id="l33.1993"> // Contents Iterator</span>
<a href="#l33.1994"></a><span id="l33.1994"> // -----------------------------------------------------------</span>
<a href="#l33.1995"></a><span id="l33.1995"> </span>
<a href="#l33.1996"></a><span id="l33.1996"> </span>
<a href="#l33.1997"></a><span id="l33.1997" class="difflineminus">-CMapiFolderContents::CMapiFolderContents( LPMDB lpMdb, ULONG cbEid, LPENTRYID lpEid)</span>
<a href="#l33.1998"></a><span id="l33.1998" class="difflineplus">+CMapiFolderContents::CMapiFolderContents(LPMDB lpMdb, ULONG cbEid, LPENTRYID lpEid)</span>
<a href="#l33.1999"></a><span id="l33.1999"> {</span>
<a href="#l33.2000"></a><span id="l33.2000">   m_lpMdb = lpMdb;</span>
<a href="#l33.2001"></a><span id="l33.2001">   m_fCbEid = cbEid;</span>
<a href="#l33.2002"></a><span id="l33.2002">   m_fLpEid = new BYTE[cbEid];</span>
<a href="#l33.2003"></a><span id="l33.2003" class="difflineminus">-  memcpy( m_fLpEid, lpEid, cbEid);</span>
<a href="#l33.2004"></a><span id="l33.2004" class="difflineplus">+  memcpy(m_fLpEid, lpEid, cbEid);</span>
<a href="#l33.2005"></a><span id="l33.2005">   m_count = 0;</span>
<a href="#l33.2006"></a><span id="l33.2006">   m_iterCount = 0;</span>
<a href="#l33.2007"></a><span id="l33.2007">   m_failure = FALSE;</span>
<a href="#l33.2008"></a><span id="l33.2008">   m_lastError = 0;</span>
<a href="#l33.2009"></a><span id="l33.2009">   m_lpFolder = NULL;</span>
<a href="#l33.2010"></a><span id="l33.2010">   m_lpTable = NULL;</span>
<a href="#l33.2011"></a><span id="l33.2011">   m_lastLpEid = NULL;</span>
<a href="#l33.2012"></a><span id="l33.2012">   m_lastCbEid = 0;</span>
<a href="#l33.2013"></a><span id="l33.2013" class="difflineat">@@ -1863,118 +1855,118 @@ CMapiFolderContents::~CMapiFolderContent</span>
<a href="#l33.2014"></a><span id="l33.2014">   delete m_fLpEid;</span>
<a href="#l33.2015"></a><span id="l33.2015">   if (m_lpTable)</span>
<a href="#l33.2016"></a><span id="l33.2016">     m_lpTable-&gt;Release();</span>
<a href="#l33.2017"></a><span id="l33.2017">   if (m_lpFolder)</span>
<a href="#l33.2018"></a><span id="l33.2018">     m_lpFolder-&gt;Release();</span>
<a href="#l33.2019"></a><span id="l33.2019"> }</span>
<a href="#l33.2020"></a><span id="l33.2020"> </span>
<a href="#l33.2021"></a><span id="l33.2021"> </span>
<a href="#l33.2022"></a><span id="l33.2022" class="difflineminus">-BOOL CMapiFolderContents::SetUpIter( void)</span>
<a href="#l33.2023"></a><span id="l33.2023" class="difflineplus">+BOOL CMapiFolderContents::SetUpIter(void)</span>
<a href="#l33.2024"></a><span id="l33.2024"> {</span>
<a href="#l33.2025"></a><span id="l33.2025">   // First, open up the MAPIFOLDER object</span>
<a href="#l33.2026"></a><span id="l33.2026">   ULONG    ulObjType;</span>
<a href="#l33.2027"></a><span id="l33.2027">   HRESULT    hr;</span>
<a href="#l33.2028"></a><span id="l33.2028" class="difflineminus">-  hr = m_lpMdb-&gt;OpenEntry( m_fCbEid, (LPENTRYID) m_fLpEid, NULL, 0, &amp;ulObjType, (LPUNKNOWN *) &amp;m_lpFolder);</span>
<a href="#l33.2029"></a><span id="l33.2029" class="difflineplus">+  hr = m_lpMdb-&gt;OpenEntry(m_fCbEid, (LPENTRYID) m_fLpEid, NULL, 0, &amp;ulObjType, (LPUNKNOWN *) &amp;m_lpFolder);</span>
<a href="#l33.2030"></a><span id="l33.2030"> </span>
<a href="#l33.2031"></a><span id="l33.2031">   if (FAILED(hr) || !m_lpFolder) {</span>
<a href="#l33.2032"></a><span id="l33.2032">     m_lpFolder = NULL;</span>
<a href="#l33.2033"></a><span id="l33.2033">     m_lastError = hr;</span>
<a href="#l33.2034"></a><span id="l33.2034" class="difflineminus">-    MAPI_TRACE2( &quot;CMapiFolderContents OpenEntry failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.2035"></a><span id="l33.2035" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.2036"></a><span id="l33.2036" class="difflineplus">+    MAPI_TRACE2(&quot;CMapiFolderContents OpenEntry failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.2037"></a><span id="l33.2037" class="difflineplus">+    return FALSE;</span>
<a href="#l33.2038"></a><span id="l33.2038">   }</span>
<a href="#l33.2039"></a><span id="l33.2039"> </span>
<a href="#l33.2040"></a><span id="l33.2040">   if (ulObjType != MAPI_FOLDER) {</span>
<a href="#l33.2041"></a><span id="l33.2041">     m_lastError = -1;</span>
<a href="#l33.2042"></a><span id="l33.2042" class="difflineminus">-    MAPI_TRACE0( &quot;CMapiFolderContents - bad object type, not a folder.\n&quot;);</span>
<a href="#l33.2043"></a><span id="l33.2043" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.2044"></a><span id="l33.2044" class="difflineplus">+    MAPI_TRACE0(&quot;CMapiFolderContents - bad object type, not a folder.\n&quot;);</span>
<a href="#l33.2045"></a><span id="l33.2045" class="difflineplus">+    return FALSE;</span>
<a href="#l33.2046"></a><span id="l33.2046">   }</span>
<a href="#l33.2047"></a><span id="l33.2047"> </span>
<a href="#l33.2048"></a><span id="l33.2048"> </span>
<a href="#l33.2049"></a><span id="l33.2049" class="difflineminus">-  hr = m_lpFolder-&gt;GetContentsTable( 0, &amp;m_lpTable);</span>
<a href="#l33.2050"></a><span id="l33.2050" class="difflineplus">+  hr = m_lpFolder-&gt;GetContentsTable(0, &amp;m_lpTable);</span>
<a href="#l33.2051"></a><span id="l33.2051">   if (FAILED(hr) || !m_lpTable) {</span>
<a href="#l33.2052"></a><span id="l33.2052">     m_lastError = hr;</span>
<a href="#l33.2053"></a><span id="l33.2053">     m_lpTable = NULL;</span>
<a href="#l33.2054"></a><span id="l33.2054" class="difflineminus">-    MAPI_TRACE2( &quot;CMapiFolderContents - GetContentsTable failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.2055"></a><span id="l33.2055" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.2056"></a><span id="l33.2056" class="difflineplus">+    MAPI_TRACE2(&quot;CMapiFolderContents - GetContentsTable failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.2057"></a><span id="l33.2057" class="difflineplus">+    return FALSE;</span>
<a href="#l33.2058"></a><span id="l33.2058">   }</span>
<a href="#l33.2059"></a><span id="l33.2059"> </span>
<a href="#l33.2060"></a><span id="l33.2060" class="difflineminus">-  hr = m_lpTable-&gt;GetRowCount( 0, &amp;m_count);</span>
<a href="#l33.2061"></a><span id="l33.2061" class="difflineplus">+  hr = m_lpTable-&gt;GetRowCount(0, &amp;m_count);</span>
<a href="#l33.2062"></a><span id="l33.2062">   if (FAILED(hr)) {</span>
<a href="#l33.2063"></a><span id="l33.2063">     m_lastError = hr;</span>
<a href="#l33.2064"></a><span id="l33.2064" class="difflineminus">-    MAPI_TRACE0( &quot;CMapiFolderContents - GetRowCount failed\n&quot;);</span>
<a href="#l33.2065"></a><span id="l33.2065" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.2066"></a><span id="l33.2066" class="difflineplus">+    MAPI_TRACE0(&quot;CMapiFolderContents - GetRowCount failed\n&quot;);</span>
<a href="#l33.2067"></a><span id="l33.2067" class="difflineplus">+    return FALSE;</span>
<a href="#l33.2068"></a><span id="l33.2068">   }</span>
<a href="#l33.2069"></a><span id="l33.2069"> </span>
<a href="#l33.2070"></a><span id="l33.2070" class="difflineminus">-  hr = m_lpTable-&gt;SetColumns( (LPSPropTagArray)&amp;ptaEid, 0);</span>
<a href="#l33.2071"></a><span id="l33.2071" class="difflineplus">+  hr = m_lpTable-&gt;SetColumns((LPSPropTagArray)&amp;ptaEid, 0);</span>
<a href="#l33.2072"></a><span id="l33.2072">   if (FAILED(hr)) {</span>
<a href="#l33.2073"></a><span id="l33.2073">     m_lastError = hr;</span>
<a href="#l33.2074"></a><span id="l33.2074" class="difflineminus">-    MAPI_TRACE2( &quot;CMapiFolderContents - SetColumns failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.2075"></a><span id="l33.2075" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.2076"></a><span id="l33.2076" class="difflineplus">+    MAPI_TRACE2(&quot;CMapiFolderContents - SetColumns failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.2077"></a><span id="l33.2077" class="difflineplus">+    return FALSE;</span>
<a href="#l33.2078"></a><span id="l33.2078">   }</span>
<a href="#l33.2079"></a><span id="l33.2079"> </span>
<a href="#l33.2080"></a><span id="l33.2080" class="difflineminus">-  hr = m_lpTable-&gt;SeekRow( BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l33.2081"></a><span id="l33.2081" class="difflineplus">+  hr = m_lpTable-&gt;SeekRow(BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l33.2082"></a><span id="l33.2082">   if (FAILED(hr)) {</span>
<a href="#l33.2083"></a><span id="l33.2083">     m_lastError = hr;</span>
<a href="#l33.2084"></a><span id="l33.2084" class="difflineminus">-    MAPI_TRACE2( &quot;CMapiFolderContents - SeekRow failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.2085"></a><span id="l33.2085" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.2086"></a><span id="l33.2086" class="difflineplus">+    MAPI_TRACE2(&quot;CMapiFolderContents - SeekRow failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.2087"></a><span id="l33.2087" class="difflineplus">+    return FALSE;</span>
<a href="#l33.2088"></a><span id="l33.2088">   }</span>
<a href="#l33.2089"></a><span id="l33.2089"> </span>
<a href="#l33.2090"></a><span id="l33.2090" class="difflineminus">-  return( TRUE);</span>
<a href="#l33.2091"></a><span id="l33.2091" class="difflineplus">+  return TRUE;</span>
<a href="#l33.2092"></a><span id="l33.2092"> }</span>
<a href="#l33.2093"></a><span id="l33.2093"> </span>
<a href="#l33.2094"></a><span id="l33.2094"> </span>
<a href="#l33.2095"></a><span id="l33.2095" class="difflineminus">-BOOL CMapiFolderContents::GetNext( ULONG *pcbEid, LPENTRYID *ppEid, ULONG *poType, BOOL *pDone)</span>
<a href="#l33.2096"></a><span id="l33.2096" class="difflineplus">+BOOL CMapiFolderContents::GetNext(ULONG *pcbEid, LPENTRYID *ppEid, ULONG *poType, BOOL *pDone)</span>
<a href="#l33.2097"></a><span id="l33.2097"> {</span>
<a href="#l33.2098"></a><span id="l33.2098">   *pDone = FALSE;</span>
<a href="#l33.2099"></a><span id="l33.2099">   if (m_failure)</span>
<a href="#l33.2100"></a><span id="l33.2100" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.2101"></a><span id="l33.2101" class="difflineplus">+    return FALSE;</span>
<a href="#l33.2102"></a><span id="l33.2102">   if (!m_lpFolder) {</span>
<a href="#l33.2103"></a><span id="l33.2103">     if (!SetUpIter()) {</span>
<a href="#l33.2104"></a><span id="l33.2104">       m_failure = TRUE;</span>
<a href="#l33.2105"></a><span id="l33.2105" class="difflineminus">-      return( FALSE);</span>
<a href="#l33.2106"></a><span id="l33.2106" class="difflineplus">+      return FALSE;</span>
<a href="#l33.2107"></a><span id="l33.2107">     }</span>
<a href="#l33.2108"></a><span id="l33.2108">     if (!m_count) {</span>
<a href="#l33.2109"></a><span id="l33.2109">       *pDone = TRUE;</span>
<a href="#l33.2110"></a><span id="l33.2110" class="difflineminus">-      return( TRUE);</span>
<a href="#l33.2111"></a><span id="l33.2111" class="difflineplus">+      return TRUE;</span>
<a href="#l33.2112"></a><span id="l33.2112">     }</span>
<a href="#l33.2113"></a><span id="l33.2113">   }</span>
<a href="#l33.2114"></a><span id="l33.2114"> </span>
<a href="#l33.2115"></a><span id="l33.2115">   int      cNumRows = 0;</span>
<a href="#l33.2116"></a><span id="l33.2116">   LPSRowSet  lpRow = NULL;</span>
<a href="#l33.2117"></a><span id="l33.2117" class="difflineminus">-  HRESULT    hr = m_lpTable-&gt;QueryRows( 1, 0, &amp;lpRow);</span>
<a href="#l33.2118"></a><span id="l33.2118" class="difflineplus">+  HRESULT    hr = m_lpTable-&gt;QueryRows(1, 0, &amp;lpRow);</span>
<a href="#l33.2119"></a><span id="l33.2119"> </span>
<a href="#l33.2120"></a><span id="l33.2120" class="difflineminus">-  if(HR_FAILED( hr)) {</span>
<a href="#l33.2121"></a><span id="l33.2121" class="difflineplus">+  if(HR_FAILED(hr)) {</span>
<a href="#l33.2122"></a><span id="l33.2122">     m_lastError = hr;</span>
<a href="#l33.2123"></a><span id="l33.2123">     m_failure = TRUE;</span>
<a href="#l33.2124"></a><span id="l33.2124" class="difflineminus">-    MAPI_TRACE2( &quot;CMapiFolderContents - QueryRows failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.2125"></a><span id="l33.2125" class="difflineminus">-    return( FALSE);</span>
<a href="#l33.2126"></a><span id="l33.2126" class="difflineplus">+    MAPI_TRACE2(&quot;CMapiFolderContents - QueryRows failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l33.2127"></a><span id="l33.2127" class="difflineplus">+    return FALSE;</span>
<a href="#l33.2128"></a><span id="l33.2128">   }</span>
<a href="#l33.2129"></a><span id="l33.2129"> </span>
<a href="#l33.2130"></a><span id="l33.2130">   if(lpRow) {</span>
<a href="#l33.2131"></a><span id="l33.2131">     cNumRows = lpRow-&gt;cRows;</span>
<a href="#l33.2132"></a><span id="l33.2132">     if (cNumRows) {</span>
<a href="#l33.2133"></a><span id="l33.2133">             LPENTRYID  lpEID = (LPENTRYID) lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l33.2134"></a><span id="l33.2134">             ULONG    cbEID = lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l33.2135"></a><span id="l33.2135">       ULONG    oType = lpRow-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.ul;</span>
<a href="#l33.2136"></a><span id="l33.2136"> </span>
<a href="#l33.2137"></a><span id="l33.2137">       if (m_lastCbEid != cbEID) {</span>
<a href="#l33.2138"></a><span id="l33.2138">         if (m_lastLpEid)</span>
<a href="#l33.2139"></a><span id="l33.2139">           delete m_lastLpEid;</span>
<a href="#l33.2140"></a><span id="l33.2140">         m_lastLpEid = new BYTE[cbEID];</span>
<a href="#l33.2141"></a><span id="l33.2141">         m_lastCbEid = cbEID;</span>
<a href="#l33.2142"></a><span id="l33.2142">       }</span>
<a href="#l33.2143"></a><span id="l33.2143" class="difflineminus">-      memcpy( m_lastLpEid, lpEID, cbEID);</span>
<a href="#l33.2144"></a><span id="l33.2144" class="difflineplus">+      memcpy(m_lastLpEid, lpEID, cbEID);</span>
<a href="#l33.2145"></a><span id="l33.2145"> </span>
<a href="#l33.2146"></a><span id="l33.2146">       *ppEid = (LPENTRYID) m_lastLpEid;</span>
<a href="#l33.2147"></a><span id="l33.2147">       *pcbEid = cbEID;</span>
<a href="#l33.2148"></a><span id="l33.2148">       *poType = oType;</span>
<a href="#l33.2149"></a><span id="l33.2149">     }</span>
<a href="#l33.2150"></a><span id="l33.2150">     else</span>
<a href="#l33.2151"></a><span id="l33.2151">       *pDone = TRUE;</span>
<a href="#l33.2152"></a><span id="l33.2152" class="difflineminus">-    CMapiApi::FreeProws( lpRow);</span>
<a href="#l33.2153"></a><span id="l33.2153" class="difflineplus">+    CMapiApi::FreeProws(lpRow);</span>
<a href="#l33.2154"></a><span id="l33.2154">     }</span>
<a href="#l33.2155"></a><span id="l33.2155">   else</span>
<a href="#l33.2156"></a><span id="l33.2156">     *pDone = TRUE;</span>
<a href="#l33.2157"></a><span id="l33.2157"> </span>
<a href="#l33.2158"></a><span id="l33.2158" class="difflineminus">-  return( TRUE);</span>
<a href="#l33.2159"></a><span id="l33.2159" class="difflineplus">+  return TRUE;</span>
<a href="#l33.2160"></a><span id="l33.2160"> }</span>
<a href="#l33.2161"></a><span id="l33.2161"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiApi.h</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiApi.h</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -80,59 +80,59 @@</span>
<a href="#l34.4"></a><span id="l34.4"> #endif</span>
<a href="#l34.5"></a><span id="l34.5"> </span>
<a href="#l34.6"></a><span id="l34.6"> class CMapiFolderList;</span>
<a href="#l34.7"></a><span id="l34.7"> class CMsgStore;</span>
<a href="#l34.8"></a><span id="l34.8"> class CMapiFolder;</span>
<a href="#l34.9"></a><span id="l34.9"> </span>
<a href="#l34.10"></a><span id="l34.10"> class CMapiContentIter {</span>
<a href="#l34.11"></a><span id="l34.11"> public:</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  virtual BOOL HandleContentItem( ULONG oType, ULONG cb, LPENTRYID pEntry) = 0;</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+  virtual BOOL HandleContentItem(ULONG oType, ULONG cb, LPENTRYID pEntry) = 0;</span>
<a href="#l34.14"></a><span id="l34.14"> };</span>
<a href="#l34.15"></a><span id="l34.15"> </span>
<a href="#l34.16"></a><span id="l34.16"> class CMapiHierarchyIter {</span>
<a href="#l34.17"></a><span id="l34.17"> public:</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineminus">-  virtual BOOL HandleHierarchyItem( ULONG oType, ULONG cb, LPENTRYID pEntry) = 0;</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+  virtual BOOL HandleHierarchyItem(ULONG oType, ULONG cb, LPENTRYID pEntry) = 0;</span>
<a href="#l34.20"></a><span id="l34.20"> };</span>
<a href="#l34.21"></a><span id="l34.21"> </span>
<a href="#l34.22"></a><span id="l34.22"> class CMapiApi {</span>
<a href="#l34.23"></a><span id="l34.23"> public:</span>
<a href="#l34.24"></a><span id="l34.24">   CMapiApi();</span>
<a href="#l34.25"></a><span id="l34.25">   ~CMapiApi();</span>
<a href="#l34.26"></a><span id="l34.26"> </span>
<a href="#l34.27"></a><span id="l34.27" class="difflineminus">-  static BOOL    LoadMapi( void);</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineminus">-  static BOOL    LoadMapiEntryPoints( void);</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineminus">-  static void    UnloadMapi( void);</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineplus">+  static BOOL    LoadMapi(void);</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+  static BOOL    LoadMapiEntryPoints(void);</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+  static void    UnloadMapi(void);</span>
<a href="#l34.33"></a><span id="l34.33"> </span>
<a href="#l34.34"></a><span id="l34.34">   static HINSTANCE  m_hMapi32;</span>
<a href="#l34.35"></a><span id="l34.35"> </span>
<a href="#l34.36"></a><span id="l34.36" class="difflineminus">-  static void    MAPIUninitialize( void);</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineminus">-  static HRESULT  MAPIInitialize( LPVOID lpInit);</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineminus">-  static SCODE  MAPIAllocateBuffer( ULONG cbSize, LPVOID FAR * lppBuffer);</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineminus">-  static ULONG  MAPIFreeBuffer( LPVOID lpBuff);</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineminus">-  static HRESULT  MAPILogonEx( ULONG ulUIParam, LPTSTR lpszProfileName, LPTSTR lpszPassword, FLAGS flFlags, LPMAPISESSION FAR * lppSession);</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineminus">-  static HRESULT  OpenStreamOnFile( LPALLOCATEBUFFER lpAllocateBuffer, LPFREEBUFFER lpFreeBuffer, ULONG ulFlags, LPTSTR lpszFileName, LPTSTR lpszPrefix, LPSTREAM FAR * lppStream);</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineminus">-  static void    FreeProws( LPSRowSet prows);</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineplus">+  static void    MAPIUninitialize(void);</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineplus">+  static HRESULT  MAPIInitialize(LPVOID lpInit);</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineplus">+  static SCODE  MAPIAllocateBuffer(ULONG cbSize, LPVOID FAR * lppBuffer);</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineplus">+  static ULONG  MAPIFreeBuffer(LPVOID lpBuff);</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineplus">+  static HRESULT  MAPILogonEx(ULONG ulUIParam, LPTSTR lpszProfileName, LPTSTR lpszPassword, FLAGS flFlags, LPMAPISESSION FAR * lppSession);</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineplus">+  static HRESULT  OpenStreamOnFile(LPALLOCATEBUFFER lpAllocateBuffer, LPFREEBUFFER lpFreeBuffer, ULONG ulFlags, LPTSTR lpszFileName, LPTSTR lpszPrefix, LPSTREAM FAR * lppStream);</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineplus">+  static void    FreeProws(LPSRowSet prows);</span>
<a href="#l34.50"></a><span id="l34.50"> </span>
<a href="#l34.51"></a><span id="l34.51"> </span>
<a href="#l34.52"></a><span id="l34.52" class="difflineminus">-  BOOL  Initialize( void);</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineminus">-  BOOL  LogOn( void);</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineplus">+  BOOL  Initialize(void);</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineplus">+  BOOL  LogOn(void);</span>
<a href="#l34.56"></a><span id="l34.56"> </span>
<a href="#l34.57"></a><span id="l34.57" class="difflineminus">-  void  AddMessageStore( CMsgStore *pStore);</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineminus">-  void  SetCurrentMsgStore( LPMDB lpMdb) { m_lpMdb = lpMdb;}</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineplus">+  void  AddMessageStore(CMsgStore *pStore);</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineplus">+  void  SetCurrentMsgStore(LPMDB lpMdb) { m_lpMdb = lpMdb;}</span>
<a href="#l34.61"></a><span id="l34.61"> </span>
<a href="#l34.62"></a><span id="l34.62">   // Open any given entry from the current Message Store</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineminus">-  BOOL  OpenEntry( ULONG cbEntry, LPENTRYID pEntryId, LPUNKNOWN *ppOpen);</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineminus">-  static BOOL OpenMdbEntry( LPMDB lpMdb, ULONG cbEntry, LPENTRYID pEntryId, LPUNKNOWN *ppOpen);</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineplus">+  BOOL  OpenEntry(ULONG cbEntry, LPENTRYID pEntryId, LPUNKNOWN *ppOpen);</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineplus">+  static BOOL OpenMdbEntry(LPMDB lpMdb, ULONG cbEntry, LPENTRYID pEntryId, LPUNKNOWN *ppOpen);</span>
<a href="#l34.67"></a><span id="l34.67"> </span>
<a href="#l34.68"></a><span id="l34.68">   // Fill in the folders list with the hierarchy from the given</span>
<a href="#l34.69"></a><span id="l34.69">   // message store.</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineminus">-  BOOL  GetStoreFolders( ULONG cbEid, LPENTRYID lpEid, CMapiFolderList&amp; folders, int startDepth);</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineminus">-  BOOL  GetStoreAddressFolders( ULONG cbEid, LPENTRYID lpEid, CMapiFolderList&amp; folders);</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineminus">-  BOOL  OpenStore( ULONG cbEid, LPENTRYID lpEid, LPMDB *ppMdb);</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineplus">+  BOOL  GetStoreFolders(ULONG cbEid, LPENTRYID lpEid, CMapiFolderList&amp; folders, int startDepth);</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineplus">+  BOOL  GetStoreAddressFolders(ULONG cbEid, LPENTRYID lpEid, CMapiFolderList&amp; folders);</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineplus">+  BOOL  OpenStore(ULONG cbEid, LPENTRYID lpEid, LPMDB *ppMdb);</span>
<a href="#l34.76"></a><span id="l34.76"> </span>
<a href="#l34.77"></a><span id="l34.77">   // Iteration</span>
<a href="#l34.78"></a><span id="l34.78">   BOOL  IterateStores(CMapiFolderList&amp; list);</span>
<a href="#l34.79"></a><span id="l34.79">   BOOL  IterateContents(CMapiContentIter *pIter, LPMAPIFOLDER pFolder, ULONG flags = 0);</span>
<a href="#l34.80"></a><span id="l34.80">   BOOL  IterateHierarchy(CMapiHierarchyIter *pIter, LPMAPIFOLDER pFolder, ULONG flags = 0);</span>
<a href="#l34.81"></a><span id="l34.81"> </span>
<a href="#l34.82"></a><span id="l34.82">   // Properties</span>
<a href="#l34.83"></a><span id="l34.83">   static LPSPropValue  GetMapiProperty(LPMAPIPROP pProp, ULONG tag);</span>
<a href="#l34.84"></a><span id="l34.84" class="difflineat">@@ -147,37 +147,37 @@ public:</span>
<a href="#l34.85"></a><span id="l34.85">   static BOOL      IsLargeProperty(LPSPropValue pVal);</span>
<a href="#l34.86"></a><span id="l34.86">   static ULONG    GetEmailPropertyTag(LPMAPIPROP lpProp, LONG nameID);</span>
<a href="#l34.87"></a><span id="l34.87"> </span>
<a href="#l34.88"></a><span id="l34.88">   static BOOL GetRTFPropertyDecodedAsUTF16(LPMAPIPROP pProp, nsString&amp; val,</span>
<a href="#l34.89"></a><span id="l34.89">                                            unsigned long&amp; nativeBodyType,</span>
<a href="#l34.90"></a><span id="l34.90">                                            unsigned long codepage = 0);</span>
<a href="#l34.91"></a><span id="l34.91"> </span>
<a href="#l34.92"></a><span id="l34.92">   // Debugging &amp; reporting stuff</span>
<a href="#l34.93"></a><span id="l34.93" class="difflineminus">-  static void      ListProperties( LPMAPIPROP lpProp, BOOL getValues = TRUE);</span>
<a href="#l34.94"></a><span id="l34.94" class="difflineminus">-  static void      ListPropertyValue( LPSPropValue pVal, nsCString&amp; s);</span>
<a href="#l34.95"></a><span id="l34.95" class="difflineplus">+  static void      ListProperties(LPMAPIPROP lpProp, BOOL getValues = TRUE);</span>
<a href="#l34.96"></a><span id="l34.96" class="difflineplus">+  static void      ListPropertyValue(LPSPropValue pVal, nsCString&amp; s);</span>
<a href="#l34.97"></a><span id="l34.97"> </span>
<a href="#l34.98"></a><span id="l34.98"> protected:</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineminus">-  BOOL      HandleHierarchyItem( ULONG oType, ULONG cb, LPENTRYID pEntry);</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineminus">-  BOOL      HandleContentsItem( ULONG oType, ULONG cb, LPENTRYID pEntry);</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineminus">-  void      GetStoreInfo( CMapiFolder *pFolder, long *pSzContents);</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineplus">+  BOOL      HandleHierarchyItem(ULONG oType, ULONG cb, LPENTRYID pEntry);</span>
<a href="#l34.103"></a><span id="l34.103" class="difflineplus">+  BOOL      HandleContentsItem(ULONG oType, ULONG cb, LPENTRYID pEntry);</span>
<a href="#l34.104"></a><span id="l34.104" class="difflineplus">+  void      GetStoreInfo(CMapiFolder *pFolder, long *pSzContents);</span>
<a href="#l34.105"></a><span id="l34.105"> </span>
<a href="#l34.106"></a><span id="l34.106">   // array of available message stores, cached so that</span>
<a href="#l34.107"></a><span id="l34.107">   // message stores are only opened once, preventing multiple</span>
<a href="#l34.108"></a><span id="l34.108">   // logon's by the user if the store requires a logon.</span>
<a href="#l34.109"></a><span id="l34.109" class="difflineminus">-  CMsgStore *    FindMessageStore( ULONG cbEid, LPENTRYID lpEid);</span>
<a href="#l34.110"></a><span id="l34.110" class="difflineminus">-  void      ClearMessageStores( void);</span>
<a href="#l34.111"></a><span id="l34.111" class="difflineplus">+  CMsgStore *    FindMessageStore(ULONG cbEid, LPENTRYID lpEid);</span>
<a href="#l34.112"></a><span id="l34.112" class="difflineplus">+  void      ClearMessageStores(void);</span>
<a href="#l34.113"></a><span id="l34.113"> </span>
<a href="#l34.114"></a><span id="l34.114" class="difflineminus">-  static void      CStrToUnicode( const char *pStr, nsString&amp; result);</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineplus">+  static void      CStrToUnicode(const char *pStr, nsString&amp; result);</span>
<a href="#l34.116"></a><span id="l34.116"> </span>
<a href="#l34.117"></a><span id="l34.117">   // Debugging &amp; reporting stuff</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineminus">-  static void      GetPropTagName( ULONG tag, nsCString&amp; s);</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineminus">-  static void      ReportStringProp( const char *pTag, LPSPropValue pVal);</span>
<a href="#l34.120"></a><span id="l34.120" class="difflineminus">-  static void      ReportUIDProp( const char *pTag, LPSPropValue pVal);</span>
<a href="#l34.121"></a><span id="l34.121" class="difflineminus">-  static void      ReportLongProp( const char *pTag, LPSPropValue pVal);</span>
<a href="#l34.122"></a><span id="l34.122" class="difflineplus">+  static void      GetPropTagName(ULONG tag, nsCString&amp; s);</span>
<a href="#l34.123"></a><span id="l34.123" class="difflineplus">+  static void      ReportStringProp(const char *pTag, LPSPropValue pVal);</span>
<a href="#l34.124"></a><span id="l34.124" class="difflineplus">+  static void      ReportUIDProp(const char *pTag, LPSPropValue pVal);</span>
<a href="#l34.125"></a><span id="l34.125" class="difflineplus">+  static void      ReportLongProp(const char *pTag, LPSPropValue pVal);</span>
<a href="#l34.126"></a><span id="l34.126"> </span>
<a href="#l34.127"></a><span id="l34.127"> </span>
<a href="#l34.128"></a><span id="l34.128"> private:</span>
<a href="#l34.129"></a><span id="l34.129">   static int        m_clients;</span>
<a href="#l34.130"></a><span id="l34.130">   static BOOL        m_initialized;</span>
<a href="#l34.131"></a><span id="l34.131">   static nsVoidArray *  m_pStores;</span>
<a href="#l34.132"></a><span id="l34.132">   static LPMAPISESSION  m_lpSession;</span>
<a href="#l34.133"></a><span id="l34.133">   static LPMDB      m_lpMdb;</span>
<a href="#l34.134"></a><span id="l34.134" class="difflineat">@@ -186,37 +186,37 @@ private:</span>
<a href="#l34.135"></a><span id="l34.135">   static int        m_uniBuffLen;</span>
<a href="#l34.136"></a><span id="l34.136"> </span>
<a href="#l34.137"></a><span id="l34.137">   static BOOL      GetLargeProperty(LPMAPIPROP pProp, ULONG tag, void** result);</span>
<a href="#l34.138"></a><span id="l34.138"> };</span>
<a href="#l34.139"></a><span id="l34.139"> </span>
<a href="#l34.140"></a><span id="l34.140"> class CMapiFolder {</span>
<a href="#l34.141"></a><span id="l34.141"> public:</span>
<a href="#l34.142"></a><span id="l34.142">   CMapiFolder();</span>
<a href="#l34.143"></a><span id="l34.143" class="difflineminus">-  CMapiFolder( const CMapiFolder *pCopyFrom);</span>
<a href="#l34.144"></a><span id="l34.144" class="difflineminus">-  CMapiFolder( const PRUnichar *pDisplayName, ULONG cbEid, LPENTRYID lpEid, int depth, LONG oType = MAPI_FOLDER);</span>
<a href="#l34.145"></a><span id="l34.145" class="difflineplus">+  CMapiFolder(const CMapiFolder *pCopyFrom);</span>
<a href="#l34.146"></a><span id="l34.146" class="difflineplus">+  CMapiFolder(const PRUnichar *pDisplayName, ULONG cbEid, LPENTRYID lpEid, int depth, LONG oType = MAPI_FOLDER);</span>
<a href="#l34.147"></a><span id="l34.147">   ~CMapiFolder();</span>
<a href="#l34.148"></a><span id="l34.148"> </span>
<a href="#l34.149"></a><span id="l34.149" class="difflineminus">-  void  SetDoImport( BOOL doIt) { m_doImport = doIt;}</span>
<a href="#l34.150"></a><span id="l34.150" class="difflineminus">-  void  SetObjectType( long oType) { m_objectType = oType;}</span>
<a href="#l34.151"></a><span id="l34.151" class="difflineminus">-  void  SetDisplayName( const PRUnichar *pDisplayName) { m_displayName = pDisplayName;}</span>
<a href="#l34.152"></a><span id="l34.152" class="difflineminus">-  void  SetEntryID( ULONG cbEid, LPENTRYID lpEid);</span>
<a href="#l34.153"></a><span id="l34.153" class="difflineminus">-  void  SetDepth( int depth) { m_depth = depth;}</span>
<a href="#l34.154"></a><span id="l34.154" class="difflineminus">-  void  SetFilePath( const PRUnichar *pFilePath) { m_mailFilePath = pFilePath;}</span>
<a href="#l34.155"></a><span id="l34.155" class="difflineplus">+  void  SetDoImport(BOOL doIt) { m_doImport = doIt;}</span>
<a href="#l34.156"></a><span id="l34.156" class="difflineplus">+  void  SetObjectType(long oType) { m_objectType = oType;}</span>
<a href="#l34.157"></a><span id="l34.157" class="difflineplus">+  void  SetDisplayName(const PRUnichar *pDisplayName) { m_displayName = pDisplayName;}</span>
<a href="#l34.158"></a><span id="l34.158" class="difflineplus">+  void  SetEntryID(ULONG cbEid, LPENTRYID lpEid);</span>
<a href="#l34.159"></a><span id="l34.159" class="difflineplus">+  void  SetDepth(int depth) { m_depth = depth;}</span>
<a href="#l34.160"></a><span id="l34.160" class="difflineplus">+  void  SetFilePath(const PRUnichar *pFilePath) { m_mailFilePath = pFilePath;}</span>
<a href="#l34.161"></a><span id="l34.161"> </span>
<a href="#l34.162"></a><span id="l34.162" class="difflineminus">-  BOOL  GetDoImport( void) const { return( m_doImport);}</span>
<a href="#l34.163"></a><span id="l34.163" class="difflineminus">-  LONG  GetObjectType( void) const { return( m_objectType);}</span>
<a href="#l34.164"></a><span id="l34.164" class="difflineminus">-  void  GetDisplayName( nsString&amp; name) const { name = m_displayName;}</span>
<a href="#l34.165"></a><span id="l34.165" class="difflineminus">-  void  GetFilePath( nsString&amp; path) const { path = m_mailFilePath;}</span>
<a href="#l34.166"></a><span id="l34.166" class="difflineminus">-  BOOL  IsStore( void) const { return( m_objectType == MAPI_STORE);}</span>
<a href="#l34.167"></a><span id="l34.167" class="difflineminus">-  BOOL  IsFolder( void) const { return( m_objectType == MAPI_FOLDER);}</span>
<a href="#l34.168"></a><span id="l34.168" class="difflineminus">-  int    GetDepth( void) const { return( m_depth);}</span>
<a href="#l34.169"></a><span id="l34.169" class="difflineplus">+  BOOL  GetDoImport(void) const { return m_doImport;}</span>
<a href="#l34.170"></a><span id="l34.170" class="difflineplus">+  LONG  GetObjectType(void) const { return m_objectType;}</span>
<a href="#l34.171"></a><span id="l34.171" class="difflineplus">+  void  GetDisplayName(nsString&amp; name) const { name = m_displayName;}</span>
<a href="#l34.172"></a><span id="l34.172" class="difflineplus">+  void  GetFilePath(nsString&amp; path) const { path = m_mailFilePath;}</span>
<a href="#l34.173"></a><span id="l34.173" class="difflineplus">+  BOOL  IsStore(void) const { return m_objectType == MAPI_STORE;}</span>
<a href="#l34.174"></a><span id="l34.174" class="difflineplus">+  BOOL  IsFolder(void) const { return m_objectType == MAPI_FOLDER;}</span>
<a href="#l34.175"></a><span id="l34.175" class="difflineplus">+  int    GetDepth(void) const { return m_depth;}</span>
<a href="#l34.176"></a><span id="l34.176"> </span>
<a href="#l34.177"></a><span id="l34.177" class="difflineminus">-  LPENTRYID  GetEntryID( ULONG *pCb = NULL) const { if (pCb) *pCb = m_cbEid; return( (LPENTRYID) m_lpEid);}</span>
<a href="#l34.178"></a><span id="l34.178" class="difflineminus">-  ULONG    GetCBEntryID( void) const { return( m_cbEid);}</span>
<a href="#l34.179"></a><span id="l34.179" class="difflineplus">+  LPENTRYID  GetEntryID(ULONG *pCb = NULL) const { if (pCb) *pCb = m_cbEid; return (LPENTRYID) m_lpEid;}</span>
<a href="#l34.180"></a><span id="l34.180" class="difflineplus">+  ULONG    GetCBEntryID(void) const { return m_cbEid;}</span>
<a href="#l34.181"></a><span id="l34.181"> </span>
<a href="#l34.182"></a><span id="l34.182"> private:</span>
<a href="#l34.183"></a><span id="l34.183">   LONG    m_objectType;</span>
<a href="#l34.184"></a><span id="l34.184">   ULONG    m_cbEid;</span>
<a href="#l34.185"></a><span id="l34.185">   BYTE *    m_lpEid;</span>
<a href="#l34.186"></a><span id="l34.186">   nsString  m_displayName;</span>
<a href="#l34.187"></a><span id="l34.187">   int      m_depth;</span>
<a href="#l34.188"></a><span id="l34.188">   nsString  m_mailFilePath;</span>
<a href="#l34.189"></a><span id="l34.189" class="difflineat">@@ -224,65 +224,65 @@ private:</span>
<a href="#l34.190"></a><span id="l34.190"> </span>
<a href="#l34.191"></a><span id="l34.191"> };</span>
<a href="#l34.192"></a><span id="l34.192"> </span>
<a href="#l34.193"></a><span id="l34.193"> class CMapiFolderList {</span>
<a href="#l34.194"></a><span id="l34.194"> public:</span>
<a href="#l34.195"></a><span id="l34.195">   CMapiFolderList();</span>
<a href="#l34.196"></a><span id="l34.196">   ~CMapiFolderList();</span>
<a href="#l34.197"></a><span id="l34.197"> </span>
<a href="#l34.198"></a><span id="l34.198" class="difflineminus">-  void      AddItem( CMapiFolder *pFolder);</span>
<a href="#l34.199"></a><span id="l34.199" class="difflineminus">-  CMapiFolder *  GetItem( int index) { if ((index &gt;= 0) &amp;&amp; (index &lt; m_array.Count())) return( (CMapiFolder *)GetAt( index)); else return( NULL);}</span>
<a href="#l34.200"></a><span id="l34.200" class="difflineminus">-  void      ClearAll( void);</span>
<a href="#l34.201"></a><span id="l34.201" class="difflineplus">+  void      AddItem(CMapiFolder *pFolder);</span>
<a href="#l34.202"></a><span id="l34.202" class="difflineplus">+  CMapiFolder *  GetItem(int index) { if ((index &gt;= 0) &amp;&amp; (index &lt; m_array.Count())) return (CMapiFolder *)GetAt(index); else return NULL;}</span>
<a href="#l34.203"></a><span id="l34.203" class="difflineplus">+  void      ClearAll(void);</span>
<a href="#l34.204"></a><span id="l34.204"> </span>
<a href="#l34.205"></a><span id="l34.205">   // Debugging and reporting</span>
<a href="#l34.206"></a><span id="l34.206" class="difflineminus">-  void      DumpList( void);</span>
<a href="#l34.207"></a><span id="l34.207" class="difflineplus">+  void      DumpList(void);</span>
<a href="#l34.208"></a><span id="l34.208"> </span>
<a href="#l34.209"></a><span id="l34.209" class="difflineminus">-  void *      GetAt( int index) { return( m_array.ElementAt( index));}</span>
<a href="#l34.210"></a><span id="l34.210" class="difflineminus">-  int        GetSize( void) { return( m_array.Count());}</span>
<a href="#l34.211"></a><span id="l34.211" class="difflineplus">+  void *      GetAt(int index) { return m_array.ElementAt(index);}</span>
<a href="#l34.212"></a><span id="l34.212" class="difflineplus">+  int        GetSize(void) { return m_array.Count();}</span>
<a href="#l34.213"></a><span id="l34.213"> </span>
<a href="#l34.214"></a><span id="l34.214"> protected:</span>
<a href="#l34.215"></a><span id="l34.215" class="difflineminus">-  void  EnsureUniqueName( CMapiFolder *pFolder);</span>
<a href="#l34.216"></a><span id="l34.216" class="difflineminus">-  void  GenerateFilePath( CMapiFolder *pFolder);</span>
<a href="#l34.217"></a><span id="l34.217" class="difflineminus">-  void  ChangeName( nsString&amp; name);</span>
<a href="#l34.218"></a><span id="l34.218" class="difflineplus">+  void  EnsureUniqueName(CMapiFolder *pFolder);</span>
<a href="#l34.219"></a><span id="l34.219" class="difflineplus">+  void  GenerateFilePath(CMapiFolder *pFolder);</span>
<a href="#l34.220"></a><span id="l34.220" class="difflineplus">+  void  ChangeName(nsString&amp; name);</span>
<a href="#l34.221"></a><span id="l34.221"> </span>
<a href="#l34.222"></a><span id="l34.222"> private:</span>
<a href="#l34.223"></a><span id="l34.223">   nsVoidArray    m_array;</span>
<a href="#l34.224"></a><span id="l34.224"> };</span>
<a href="#l34.225"></a><span id="l34.225"> </span>
<a href="#l34.226"></a><span id="l34.226"> </span>
<a href="#l34.227"></a><span id="l34.227"> class CMsgStore {</span>
<a href="#l34.228"></a><span id="l34.228"> public:</span>
<a href="#l34.229"></a><span id="l34.229" class="difflineminus">-  CMsgStore( ULONG cbEid = 0, LPENTRYID lpEid = NULL);</span>
<a href="#l34.230"></a><span id="l34.230" class="difflineplus">+  CMsgStore(ULONG cbEid = 0, LPENTRYID lpEid = NULL);</span>
<a href="#l34.231"></a><span id="l34.231">   ~CMsgStore();</span>
<a href="#l34.232"></a><span id="l34.232"> </span>
<a href="#l34.233"></a><span id="l34.233" class="difflineminus">-  void    SetEntryID( ULONG cbEid, LPENTRYID lpEid);</span>
<a href="#l34.234"></a><span id="l34.234" class="difflineminus">-  BOOL    Open( LPMAPISESSION pSession, LPMDB *ppMdb);</span>
<a href="#l34.235"></a><span id="l34.235" class="difflineplus">+  void    SetEntryID(ULONG cbEid, LPENTRYID lpEid);</span>
<a href="#l34.236"></a><span id="l34.236" class="difflineplus">+  BOOL    Open(LPMAPISESSION pSession, LPMDB *ppMdb);</span>
<a href="#l34.237"></a><span id="l34.237"> </span>
<a href="#l34.238"></a><span id="l34.238" class="difflineminus">-  ULONG    GetCBEntryID( void) { return( m_cbEid);}</span>
<a href="#l34.239"></a><span id="l34.239" class="difflineminus">-  LPENTRYID  GetLPEntryID( void) { return( (LPENTRYID) m_lpEid);}</span>
<a href="#l34.240"></a><span id="l34.240" class="difflineplus">+  ULONG    GetCBEntryID(void) { return m_cbEid;}</span>
<a href="#l34.241"></a><span id="l34.241" class="difflineplus">+  LPENTRYID  GetLPEntryID(void) { return (LPENTRYID) m_lpEid;}</span>
<a href="#l34.242"></a><span id="l34.242"> </span>
<a href="#l34.243"></a><span id="l34.243"> private:</span>
<a href="#l34.244"></a><span id="l34.244">   ULONG    m_cbEid;</span>
<a href="#l34.245"></a><span id="l34.245">   BYTE *    m_lpEid;</span>
<a href="#l34.246"></a><span id="l34.246">   LPMDB    m_lpMdb;</span>
<a href="#l34.247"></a><span id="l34.247"> };</span>
<a href="#l34.248"></a><span id="l34.248"> </span>
<a href="#l34.249"></a><span id="l34.249"> </span>
<a href="#l34.250"></a><span id="l34.250"> class CMapiFolderContents {</span>
<a href="#l34.251"></a><span id="l34.251"> public:</span>
<a href="#l34.252"></a><span id="l34.252" class="difflineminus">-  CMapiFolderContents( LPMDB lpMdb, ULONG cbEID, LPENTRYID lpEid);</span>
<a href="#l34.253"></a><span id="l34.253" class="difflineplus">+  CMapiFolderContents(LPMDB lpMdb, ULONG cbEID, LPENTRYID lpEid);</span>
<a href="#l34.254"></a><span id="l34.254">   ~CMapiFolderContents();</span>
<a href="#l34.255"></a><span id="l34.255"> </span>
<a href="#l34.256"></a><span id="l34.256" class="difflineminus">-  BOOL  GetNext( ULONG *pcbEid, LPENTRYID *ppEid, ULONG *poType, BOOL *pDone);</span>
<a href="#l34.257"></a><span id="l34.257" class="difflineplus">+  BOOL  GetNext(ULONG *pcbEid, LPENTRYID *ppEid, ULONG *poType, BOOL *pDone);</span>
<a href="#l34.258"></a><span id="l34.258"> </span>
<a href="#l34.259"></a><span id="l34.259" class="difflineminus">-  ULONG  GetCount( void) { return( m_count);}</span>
<a href="#l34.260"></a><span id="l34.260" class="difflineplus">+  ULONG  GetCount(void) { return m_count;}</span>
<a href="#l34.261"></a><span id="l34.261"> </span>
<a href="#l34.262"></a><span id="l34.262"> protected:</span>
<a href="#l34.263"></a><span id="l34.263" class="difflineminus">-  BOOL SetUpIter( void);</span>
<a href="#l34.264"></a><span id="l34.264" class="difflineplus">+  BOOL SetUpIter(void);</span>
<a href="#l34.265"></a><span id="l34.265"> </span>
<a href="#l34.266"></a><span id="l34.266"> private:</span>
<a href="#l34.267"></a><span id="l34.267">   HRESULT      m_lastError;</span>
<a href="#l34.268"></a><span id="l34.268">   BOOL      m_failure;</span>
<a href="#l34.269"></a><span id="l34.269">   LPMDB      m_lpMdb;</span>
<a href="#l34.270"></a><span id="l34.270">   LPMAPIFOLDER  m_lpFolder;</span>
<a href="#l34.271"></a><span id="l34.271">   LPMAPITABLE    m_lpTable;</span>
<a href="#l34.272"></a><span id="l34.272">   ULONG      m_fCbEid;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiDbgLog.h</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiDbgLog.h</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -42,31 +42,31 @@</span>
<a href="#l35.4"></a><span id="l35.4"> #ifdef NS_DEBUG</span>
<a href="#l35.5"></a><span id="l35.5"> #define MAPI_DEBUG  1</span>
<a href="#l35.6"></a><span id="l35.6"> #endif</span>
<a href="#l35.7"></a><span id="l35.7"> */</span>
<a href="#l35.8"></a><span id="l35.8"> </span>
<a href="#l35.9"></a><span id="l35.9"> #ifdef MAPI_DEBUG</span>
<a href="#l35.10"></a><span id="l35.10"> #include &lt;stdio.h&gt;</span>
<a href="#l35.11"></a><span id="l35.11"> </span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-#define MAPI_DUMP_STRING( x)    printf( &quot;%s&quot;, (const char *)x)</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-#define MAPI_TRACE0( x)        printf( x)</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineminus">-#define MAPI_TRACE1( x, y)      printf( x, y)</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineminus">-#define MAPI_TRACE2( x, y, z)    printf( x, y, z)</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineminus">-#define MAPI_TRACE3( x, y, z, a)  printf( x, y, z, a)</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineminus">-#define MAPI_TRACE4( x, y, z, a, b) printf( x, y, z, a, b)</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineplus">+#define MAPI_DUMP_STRING(x)    printf(&quot;%s&quot;, (const char *)x)</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineplus">+#define MAPI_TRACE0(x)        printf(x)</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineplus">+#define MAPI_TRACE1(x, y)      printf(x, y)</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineplus">+#define MAPI_TRACE2(x, y, z)    printf(x, y, z)</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineplus">+#define MAPI_TRACE3(x, y, z, a)  printf(x, y, z, a)</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineplus">+#define MAPI_TRACE4(x, y, z, a, b) printf(x, y, z, a, b)</span>
<a href="#l35.24"></a><span id="l35.24"> </span>
<a href="#l35.25"></a><span id="l35.25"> </span>
<a href="#l35.26"></a><span id="l35.26"> #else</span>
<a href="#l35.27"></a><span id="l35.27"> </span>
<a href="#l35.28"></a><span id="l35.28" class="difflineminus">-#define MAPI_DUMP_STRING( x)</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineminus">-#define  MAPI_TRACE0( x)</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineminus">-#define  MAPI_TRACE1( x, y)</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-#define  MAPI_TRACE2( x, y, z)</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineminus">-#define MAPI_TRACE3( x, y, z, a)</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineminus">-#define MAPI_TRACE4( x, y, z, a, b)</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+#define MAPI_DUMP_STRING(x)</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineplus">+#define  MAPI_TRACE0(x)</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+#define  MAPI_TRACE1(x, y)</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineplus">+#define  MAPI_TRACE2(x, y, z)</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineplus">+#define MAPI_TRACE3(x, y, z, a)</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineplus">+#define MAPI_TRACE4(x, y, z, a, b)</span>
<a href="#l35.40"></a><span id="l35.40"> </span>
<a href="#l35.41"></a><span id="l35.41"> #endif</span>
<a href="#l35.42"></a><span id="l35.42"> </span>
<a href="#l35.43"></a><span id="l35.43"> </span>
<a href="#l35.44"></a><span id="l35.44"> </span>
<a href="#l35.45"></a><span id="l35.45"> #endif /* MapiDbgLog_h___ */</span>
<a href="#l35.46"></a><span id="l35.46"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiMessage.cpp</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiMessage.cpp</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -80,17 +80,17 @@ static const char * sFromDate = &quot;Mon Jan</span>
<a href="#l36.4"></a><span id="l36.4"> static const char * sDaysOfWeek[7] = {</span>
<a href="#l36.5"></a><span id="l36.5">   &quot;Sun&quot;, &quot;Mon&quot;, &quot;Tue&quot;, &quot;Wed&quot;, &quot;Thu&quot;, &quot;Fri&quot;, &quot;Sat&quot;</span>
<a href="#l36.6"></a><span id="l36.6"> };</span>
<a href="#l36.7"></a><span id="l36.7"> </span>
<a href="#l36.8"></a><span id="l36.8"> static const char *sMonths[12] = {</span>
<a href="#l36.9"></a><span id="l36.9">   &quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;, &quot;May&quot;, &quot;Jun&quot;, &quot;Jul&quot;, &quot;Aug&quot;, &quot;Sep&quot;, &quot;Oct&quot;, &quot;Nov&quot;, &quot;Dec&quot;</span>
<a href="#l36.10"></a><span id="l36.10"> };</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-CMapiMessage::CMapiMessage( LPMESSAGE lpMsg)</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+CMapiMessage::CMapiMessage(LPMESSAGE lpMsg)</span>
<a href="#l36.14"></a><span id="l36.14">   : m_lpMsg(lpMsg), m_dldStateHeadersOnly(false), m_msgFlags(0)</span>
<a href="#l36.15"></a><span id="l36.15"> {</span>
<a href="#l36.16"></a><span id="l36.16">   nsresult rv;</span>
<a href="#l36.17"></a><span id="l36.17">   m_pIOService = do_GetService(NS_IOSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l36.18"></a><span id="l36.18">   if (NS_FAILED(rv))</span>
<a href="#l36.19"></a><span id="l36.19">     return;</span>
<a href="#l36.20"></a><span id="l36.20"> </span>
<a href="#l36.21"></a><span id="l36.21">   FetchHeaders();</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineat">@@ -204,17 +204,17 @@ bool CMapiMessage::EnsureDate()</span>
<a href="#l36.23"></a><span id="l36.23">     str += &quot; +0000&quot;;</span>
<a href="#l36.24"></a><span id="l36.24">     m_headers.SetValue(CMapiMessageHeaders::hdrDate, str.get());</span>
<a href="#l36.25"></a><span id="l36.25">     return true;</span>
<a href="#l36.26"></a><span id="l36.26">   }</span>
<a href="#l36.27"></a><span id="l36.27"> </span>
<a href="#l36.28"></a><span id="l36.28">   return false;</span>
<a href="#l36.29"></a><span id="l36.29"> }</span>
<a href="#l36.30"></a><span id="l36.30"> </span>
<a href="#l36.31"></a><span id="l36.31" class="difflineminus">-void CMapiMessage::BuildFromLine( void)</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineplus">+void CMapiMessage::BuildFromLine(void)</span>
<a href="#l36.33"></a><span id="l36.33"> {</span>
<a href="#l36.34"></a><span id="l36.34">   m_fromLine = sFromLine;</span>
<a href="#l36.35"></a><span id="l36.35">   LPSPropValue pVal = CMapiApi::GetMapiProperty(m_lpMsg, PR_CREATION_TIME);</span>
<a href="#l36.36"></a><span id="l36.36">   if (pVal) {</span>
<a href="#l36.37"></a><span id="l36.37">     SYSTEMTIME st;</span>
<a href="#l36.38"></a><span id="l36.38">     ::FileTimeToSystemTime(&amp;(pVal-&gt;Value.ft), &amp;st);</span>
<a href="#l36.39"></a><span id="l36.39">     CMapiApi::MAPIFreeBuffer(pVal);</span>
<a href="#l36.40"></a><span id="l36.40">     FormatDateTime(st, m_fromLine, FALSE);</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineat">@@ -263,17 +263,17 @@ void CMapiMessage::GetDownloadState()</span>
<a href="#l36.42"></a><span id="l36.42"> }</span>
<a href="#l36.43"></a><span id="l36.43"> </span>
<a href="#l36.44"></a><span id="l36.44"> // Headers - fetch will get PR_TRANSPORT_MESSAGE_HEADERS</span>
<a href="#l36.45"></a><span id="l36.45"> // or if they do not exist will build a header from</span>
<a href="#l36.46"></a><span id="l36.46"> //  PR_DISPLAY_TO, _CC, _BCC</span>
<a href="#l36.47"></a><span id="l36.47"> //  PR_SUBJECT</span>
<a href="#l36.48"></a><span id="l36.48"> //  PR_MESSAGE_RECIPIENTS</span>
<a href="#l36.49"></a><span id="l36.49"> // and PR_CREATION_TIME if needed?</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineminus">-bool CMapiMessage::FetchHeaders( void)</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+bool CMapiMessage::FetchHeaders(void)</span>
<a href="#l36.52"></a><span id="l36.52"> {</span>
<a href="#l36.53"></a><span id="l36.53">   ULONG tag = PR_TRANSPORT_MESSAGE_HEADERS_A;</span>
<a href="#l36.54"></a><span id="l36.54">   LPSPropValue pVal = CMapiApi::GetMapiProperty(m_lpMsg, tag);</span>
<a href="#l36.55"></a><span id="l36.55">   if (!pVal)</span>
<a href="#l36.56"></a><span id="l36.56">     pVal = CMapiApi::GetMapiProperty(m_lpMsg, tag = PR_TRANSPORT_MESSAGE_HEADERS_W);</span>
<a href="#l36.57"></a><span id="l36.57">   if (pVal) {</span>
<a href="#l36.58"></a><span id="l36.58">     if (CMapiApi::IsLargeProperty(pVal)) {</span>
<a href="#l36.59"></a><span id="l36.59">       nsCString headers;</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineat">@@ -298,17 +298,17 @@ bool CMapiMessage::FetchHeaders( void)</span>
<a href="#l36.61"></a><span id="l36.61">     EnsureHeader(CMapiMessageHeaders::hdrFrom, PR_SENDER_EMAIL_ADDRESS_W);</span>
<a href="#l36.62"></a><span id="l36.62">   EnsureHeader(CMapiMessageHeaders::hdrSubject, PR_SUBJECT_W);</span>
<a href="#l36.63"></a><span id="l36.63">   EnsureHeader(CMapiMessageHeaders::hdrTo, PR_DISPLAY_TO_W);</span>
<a href="#l36.64"></a><span id="l36.64">   EnsureHeader(CMapiMessageHeaders::hdrCc, PR_DISPLAY_CC_W);</span>
<a href="#l36.65"></a><span id="l36.65">   EnsureHeader(CMapiMessageHeaders::hdrBcc, PR_DISPLAY_BCC_W);</span>
<a href="#l36.66"></a><span id="l36.66"> </span>
<a href="#l36.67"></a><span id="l36.67">   ProcessContentType();</span>
<a href="#l36.68"></a><span id="l36.68"> </span>
<a href="#l36.69"></a><span id="l36.69" class="difflineminus">-  return( !m_headers.IsEmpty());</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineplus">+  return !m_headers.IsEmpty();</span>
<a href="#l36.71"></a><span id="l36.71"> }</span>
<a href="#l36.72"></a><span id="l36.72"> </span>
<a href="#l36.73"></a><span id="l36.73"> // Mime-Version: 1.0</span>
<a href="#l36.74"></a><span id="l36.74"> // Content-Type: text/plain; charset=&quot;US-ASCII&quot;</span>
<a href="#l36.75"></a><span id="l36.75"> // Content-Type: multipart/mixed; boundary=&quot;=====================_874475278==_&quot;</span>
<a href="#l36.76"></a><span id="l36.76"> </span>
<a href="#l36.77"></a><span id="l36.77"> void CMapiMessage::ProcessContentType()</span>
<a href="#l36.78"></a><span id="l36.78"> {</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineat">@@ -638,22 +638,22 @@ bool CMapiMessage::CheckBodyInCharsetRan</span>
<a href="#l36.80"></a><span id="l36.80">       break;</span>
<a href="#l36.81"></a><span id="l36.81"> </span>
<a href="#l36.82"></a><span id="l36.82">     currentSrcPtr += srcLength;</span>
<a href="#l36.83"></a><span id="l36.83">     consumedLen = currentSrcPtr - txt; // src length used so far</span>
<a href="#l36.84"></a><span id="l36.84">   }</span>
<a href="#l36.85"></a><span id="l36.85">   return true;</span>
<a href="#l36.86"></a><span id="l36.86"> }</span>
<a href="#l36.87"></a><span id="l36.87"> </span>
<a href="#l36.88"></a><span id="l36.88" class="difflineminus">-bool CaseInsensitiveComp (wchar_t elem1, wchar_t elem2 )</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineplus">+bool CaseInsensitiveComp (wchar_t elem1, wchar_t elem2)</span>
<a href="#l36.90"></a><span id="l36.90"> {</span>
<a href="#l36.91"></a><span id="l36.91">   return _wcsnicmp(&amp;elem1, &amp;elem2, 1) == 0;</span>
<a href="#l36.92"></a><span id="l36.92"> }</span>
<a href="#l36.93"></a><span id="l36.93"> </span>
<a href="#l36.94"></a><span id="l36.94" class="difflineminus">-void ExtractMetaCharset( const wchar_t* body, int bodySz, /*out*/nsCString&amp; charset)</span>
<a href="#l36.95"></a><span id="l36.95" class="difflineplus">+void ExtractMetaCharset(const wchar_t* body, int bodySz, /*out*/nsCString&amp; charset)</span>
<a href="#l36.96"></a><span id="l36.96"> {</span>
<a href="#l36.97"></a><span id="l36.97">   charset.Truncate();</span>
<a href="#l36.98"></a><span id="l36.98">   const wchar_t* body_end = body+bodySz;</span>
<a href="#l36.99"></a><span id="l36.99">   const wchar_t str_eohd[] = L&quot;/head&quot;;</span>
<a href="#l36.100"></a><span id="l36.100">   const wchar_t *str_eohd_end = str_eohd+sizeof(str_eohd)/sizeof(str_eohd[0])-1;</span>
<a href="#l36.101"></a><span id="l36.101">   const wchar_t* eohd_pos = std::search(body, body_end, str_eohd, str_eohd_end,</span>
<a href="#l36.102"></a><span id="l36.102">                                         CaseInsensitiveComp);</span>
<a href="#l36.103"></a><span id="l36.103">   if (eohd_pos == body_end) // No header!</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineat">@@ -676,46 +676,46 @@ void ExtractMetaCharset( const wchar_t* </span>
<a href="#l36.105"></a><span id="l36.105">   // &lt;META content=&quot;text/html; charset=utf-8 &quot; http-equiv=Content-Type&gt;</span>
<a href="#l36.106"></a><span id="l36.106">   const wchar_t term[] = L&quot;;\&quot; &quot;, *term_end= term+sizeof(term)/sizeof(term[0])-1;</span>
<a href="#l36.107"></a><span id="l36.107">   const wchar_t* chset_end = std::find_first_of(chset_pos, eohd_pos, term,</span>
<a href="#l36.108"></a><span id="l36.108">                                                 term_end);</span>
<a href="#l36.109"></a><span id="l36.109">   if (chset_end != eohd_pos)</span>
<a href="#l36.110"></a><span id="l36.110">     LossyCopyUTF16toASCII(Substring(chset_pos, chset_end), charset);</span>
<a href="#l36.111"></a><span id="l36.111"> }</span>
<a href="#l36.112"></a><span id="l36.112"> </span>
<a href="#l36.113"></a><span id="l36.113" class="difflineminus">-bool CMapiMessage::FetchBody( void)</span>
<a href="#l36.114"></a><span id="l36.114" class="difflineplus">+bool CMapiMessage::FetchBody(void)</span>
<a href="#l36.115"></a><span id="l36.115"> {</span>
<a href="#l36.116"></a><span id="l36.116">   m_bodyIsHtml = false;</span>
<a href="#l36.117"></a><span id="l36.117">   m_body.Truncate();</span>
<a href="#l36.118"></a><span id="l36.118"> </span>
<a href="#l36.119"></a><span id="l36.119">   // Get the Outlook codepage info; if unsuccessful then it defaults to 0 (CP_ACP) -&gt; system default</span>
<a href="#l36.120"></a><span id="l36.120">   // Maybe we can use this info later?</span>
<a href="#l36.121"></a><span id="l36.121">   unsigned int codepage=0;</span>
<a href="#l36.122"></a><span id="l36.122" class="difflineminus">-  LPSPropValue pVal = CMapiApi::GetMapiProperty( m_lpMsg, PR_INTERNET_CPID);</span>
<a href="#l36.123"></a><span id="l36.123" class="difflineplus">+  LPSPropValue pVal = CMapiApi::GetMapiProperty(m_lpMsg, PR_INTERNET_CPID);</span>
<a href="#l36.124"></a><span id="l36.124">   if (pVal) {</span>
<a href="#l36.125"></a><span id="l36.125" class="difflineminus">-    if (PROP_TYPE( pVal-&gt;ulPropTag) == PT_LONG)</span>
<a href="#l36.126"></a><span id="l36.126" class="difflineplus">+    if (PROP_TYPE(pVal-&gt;ulPropTag) == PT_LONG)</span>
<a href="#l36.127"></a><span id="l36.127">       codepage = pVal-&gt;Value.l;</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineminus">-    CMapiApi::MAPIFreeBuffer( pVal);</span>
<a href="#l36.129"></a><span id="l36.129" class="difflineplus">+    CMapiApi::MAPIFreeBuffer(pVal);</span>
<a href="#l36.130"></a><span id="l36.130">   }</span>
<a href="#l36.131"></a><span id="l36.131"> </span>
<a href="#l36.132"></a><span id="l36.132">   unsigned long nativeBodyType = 0;</span>
<a href="#l36.133"></a><span id="l36.133">   if (CMapiApi::GetRTFPropertyDecodedAsUTF16(m_lpMsg, m_body, nativeBodyType,</span>
<a href="#l36.134"></a><span id="l36.134">                                              codepage)) {</span>
<a href="#l36.135"></a><span id="l36.135">     m_bodyIsHtml = nativeBodyType == MAPI_NATIVE_BODY_TYPE_HTML;</span>
<a href="#l36.136"></a><span id="l36.136">   }</span>
<a href="#l36.137"></a><span id="l36.137">   else { // Cannot get RTF version</span>
<a href="#l36.138"></a><span id="l36.138">     // Is it html?</span>
<a href="#l36.139"></a><span id="l36.139">     pVal = CMapiApi::GetMapiProperty(m_lpMsg, PR_BODY_HTML_W);</span>
<a href="#l36.140"></a><span id="l36.140">     if (pVal) {</span>
<a href="#l36.141"></a><span id="l36.141">       if (CMapiApi::IsLargeProperty(pVal))</span>
<a href="#l36.142"></a><span id="l36.142">         CMapiApi::GetLargeStringProperty(m_lpMsg, PR_BODY_HTML_W, m_body);</span>
<a href="#l36.143"></a><span id="l36.143">       else if ((PROP_TYPE(pVal-&gt;ulPropTag) == PT_UNICODE) &amp;&amp;</span>
<a href="#l36.144"></a><span id="l36.144">                (pVal-&gt;Value.lpszW) &amp;&amp; (*(pVal-&gt;Value.lpszW)))</span>
<a href="#l36.145"></a><span id="l36.145">         m_body.Assign(pVal-&gt;Value.lpszW);</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineminus">-      CMapiApi::MAPIFreeBuffer( pVal);</span>
<a href="#l36.147"></a><span id="l36.147" class="difflineplus">+      CMapiApi::MAPIFreeBuffer(pVal);</span>
<a href="#l36.148"></a><span id="l36.148">     }</span>
<a href="#l36.149"></a><span id="l36.149"> </span>
<a href="#l36.150"></a><span id="l36.150">     // Kind-hearted Outlook will give us html even for a plain text message.</span>
<a href="#l36.151"></a><span id="l36.151">     // But it will include a comment saying it did the conversion.</span>
<a href="#l36.152"></a><span id="l36.152">     // We'll use this as a hack to really use the plain text part.</span>
<a href="#l36.153"></a><span id="l36.153">     //</span>
<a href="#l36.154"></a><span id="l36.154">     // Sadly there are cases where this string is returned despite the fact</span>
<a href="#l36.155"></a><span id="l36.155">     // that the message is indeed HTML.</span>
<a href="#l36.156"></a><span id="l36.156" class="difflineat">@@ -809,61 +809,61 @@ static const SizedSPropTagArray(ieidAtta</span>
<a href="#l36.157"></a><span id="l36.157">   {</span>
<a href="#l36.158"></a><span id="l36.158">     PR_ATTACH_NUM</span>
<a href="#l36.159"></a><span id="l36.159">   }</span>
<a href="#l36.160"></a><span id="l36.160"> };</span>
<a href="#l36.161"></a><span id="l36.161"> </span>
<a href="#l36.162"></a><span id="l36.162"> bool CMapiMessage::IterateAttachTable(LPMAPITABLE lpTable)</span>
<a href="#l36.163"></a><span id="l36.163"> {</span>
<a href="#l36.164"></a><span id="l36.164">   ULONG rowCount;</span>
<a href="#l36.165"></a><span id="l36.165" class="difflineminus">-  HRESULT hr = lpTable-&gt;GetRowCount( 0, &amp;rowCount);</span>
<a href="#l36.166"></a><span id="l36.166" class="difflineplus">+  HRESULT hr = lpTable-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l36.167"></a><span id="l36.167">   if (!rowCount) {</span>
<a href="#l36.168"></a><span id="l36.168">     return true;</span>
<a href="#l36.169"></a><span id="l36.169">   }</span>
<a href="#l36.170"></a><span id="l36.170"> </span>
<a href="#l36.171"></a><span id="l36.171" class="difflineminus">-  hr = lpTable-&gt;SetColumns( (LPSPropTagArray)&amp;ptaEid, 0);</span>
<a href="#l36.172"></a><span id="l36.172" class="difflineplus">+  hr = lpTable-&gt;SetColumns((LPSPropTagArray)&amp;ptaEid, 0);</span>
<a href="#l36.173"></a><span id="l36.173">   if (FAILED(hr)) {</span>
<a href="#l36.174"></a><span id="l36.174" class="difflineminus">-    MAPI_TRACE2( &quot;SetColumns for attachment table failed: 0x%lx, %d\r\n&quot;, (long)hr, (int)hr);</span>
<a href="#l36.175"></a><span id="l36.175" class="difflineplus">+    MAPI_TRACE2(&quot;SetColumns for attachment table failed: 0x%lx, %d\r\n&quot;, (long)hr, (int)hr);</span>
<a href="#l36.176"></a><span id="l36.176">     return false;</span>
<a href="#l36.177"></a><span id="l36.177">   }</span>
<a href="#l36.178"></a><span id="l36.178"> </span>
<a href="#l36.179"></a><span id="l36.179" class="difflineminus">-  hr = lpTable-&gt;SeekRow( BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l36.180"></a><span id="l36.180" class="difflineplus">+  hr = lpTable-&gt;SeekRow(BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l36.181"></a><span id="l36.181">   if (FAILED(hr)) {</span>
<a href="#l36.182"></a><span id="l36.182" class="difflineminus">-    MAPI_TRACE2( &quot;SeekRow for attachment table failed: 0x%lx, %d\r\n&quot;, (long)hr, (int)hr);</span>
<a href="#l36.183"></a><span id="l36.183" class="difflineplus">+    MAPI_TRACE2(&quot;SeekRow for attachment table failed: 0x%lx, %d\r\n&quot;, (long)hr, (int)hr);</span>
<a href="#l36.184"></a><span id="l36.184">     return false;</span>
<a href="#l36.185"></a><span id="l36.185">   }</span>
<a href="#l36.186"></a><span id="l36.186"> </span>
<a href="#l36.187"></a><span id="l36.187">   int cNumRows = 0;</span>
<a href="#l36.188"></a><span id="l36.188">   LPSRowSet lpRow;</span>
<a href="#l36.189"></a><span id="l36.189">   bool bResult = true;</span>
<a href="#l36.190"></a><span id="l36.190">   do {</span>
<a href="#l36.191"></a><span id="l36.191"> </span>
<a href="#l36.192"></a><span id="l36.192">     lpRow = NULL;</span>
<a href="#l36.193"></a><span id="l36.193" class="difflineminus">-    hr = lpTable-&gt;QueryRows( 1, 0, &amp;lpRow);</span>
<a href="#l36.194"></a><span id="l36.194" class="difflineplus">+    hr = lpTable-&gt;QueryRows(1, 0, &amp;lpRow);</span>
<a href="#l36.195"></a><span id="l36.195"> </span>
<a href="#l36.196"></a><span id="l36.196">     if(HR_FAILED(hr)) {</span>
<a href="#l36.197"></a><span id="l36.197" class="difflineminus">-      MAPI_TRACE2( &quot;QueryRows for attachment table failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l36.198"></a><span id="l36.198" class="difflineplus">+      MAPI_TRACE2(&quot;QueryRows for attachment table failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l36.199"></a><span id="l36.199">       bResult = false;</span>
<a href="#l36.200"></a><span id="l36.200">       break;</span>
<a href="#l36.201"></a><span id="l36.201">     }</span>
<a href="#l36.202"></a><span id="l36.202"> </span>
<a href="#l36.203"></a><span id="l36.203">     if (lpRow) {</span>
<a href="#l36.204"></a><span id="l36.204">       cNumRows = lpRow-&gt;cRows;</span>
<a href="#l36.205"></a><span id="l36.205"> </span>
<a href="#l36.206"></a><span id="l36.206">       if (cNumRows) {</span>
<a href="#l36.207"></a><span id="l36.207">         DWORD aNum = lpRow-&gt;aRow[0].lpProps[ieidPR_ATTACH_NUM].Value.ul;</span>
<a href="#l36.208"></a><span id="l36.208">         AddAttachment(aNum);</span>
<a href="#l36.209"></a><span id="l36.209" class="difflineminus">-        MAPI_TRACE1( &quot;\t\t****Attachment found - #%d\r\n&quot;, (int)aNum);</span>
<a href="#l36.210"></a><span id="l36.210" class="difflineplus">+        MAPI_TRACE1(&quot;\t\t****Attachment found - #%d\r\n&quot;, (int)aNum);</span>
<a href="#l36.211"></a><span id="l36.211">       }</span>
<a href="#l36.212"></a><span id="l36.212" class="difflineminus">-      CMapiApi::FreeProws( lpRow);</span>
<a href="#l36.213"></a><span id="l36.213" class="difflineplus">+      CMapiApi::FreeProws(lpRow);</span>
<a href="#l36.214"></a><span id="l36.214">     }</span>
<a href="#l36.215"></a><span id="l36.215"> </span>
<a href="#l36.216"></a><span id="l36.216" class="difflineminus">-  } while ( SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRow);</span>
<a href="#l36.217"></a><span id="l36.217" class="difflineplus">+  } while (SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRow);</span>
<a href="#l36.218"></a><span id="l36.218"> </span>
<a href="#l36.219"></a><span id="l36.219" class="difflineminus">-  return( bResult);</span>
<a href="#l36.220"></a><span id="l36.220" class="difflineplus">+  return bResult;</span>
<a href="#l36.221"></a><span id="l36.221"> }</span>
<a href="#l36.222"></a><span id="l36.222"> </span>
<a href="#l36.223"></a><span id="l36.223"> bool CMapiMessage::GetTmpFile(/*out*/ nsILocalFile **aResult)</span>
<a href="#l36.224"></a><span id="l36.224"> {</span>
<a href="#l36.225"></a><span id="l36.225">   nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l36.226"></a><span id="l36.226">   nsresult rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l36.227"></a><span id="l36.227">     &quot;mapiattach.tmp&quot;,</span>
<a href="#l36.228"></a><span id="l36.228">     getter_AddRefs(tmpFile));</span>
<a href="#l36.229"></a><span id="l36.229" class="difflineat">@@ -912,44 +912,44 @@ bool CMapiMessage::CopyBinAttachToFile(L</span>
<a href="#l36.230"></a><span id="l36.230">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l36.231"></a><span id="l36.231"> </span>
<a href="#l36.232"></a><span id="l36.232">   rv = _tmp_file-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l36.233"></a><span id="l36.233">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l36.234"></a><span id="l36.234"> </span>
<a href="#l36.235"></a><span id="l36.235">   nsCString tmpPath;</span>
<a href="#l36.236"></a><span id="l36.236">   _tmp_file-&gt;GetNativePath(tmpPath);</span>
<a href="#l36.237"></a><span id="l36.237">   LPSTREAM lpStreamFile;</span>
<a href="#l36.238"></a><span id="l36.238" class="difflineminus">-  HRESULT hr = CMapiApi::OpenStreamOnFile( gpMapiAllocateBuffer, gpMapiFreeBuffer, STGM_READWRITE | STGM_CREATE,</span>
<a href="#l36.239"></a><span id="l36.239" class="difflineplus">+  HRESULT hr = CMapiApi::OpenStreamOnFile(gpMapiAllocateBuffer, gpMapiFreeBuffer, STGM_READWRITE | STGM_CREATE,</span>
<a href="#l36.240"></a><span id="l36.240">     const_cast&lt;char*&gt;(tmpPath.get()), NULL, &amp;lpStreamFile);</span>
<a href="#l36.241"></a><span id="l36.241">   if (HR_FAILED(hr)) {</span>
<a href="#l36.242"></a><span id="l36.242">     MAPI_TRACE1(&quot;~~ERROR~~ OpenStreamOnFile failed - temp path: %s\r\n&quot;,</span>
<a href="#l36.243"></a><span id="l36.243">                 tmpPath.get());</span>
<a href="#l36.244"></a><span id="l36.244">     return false;</span>
<a href="#l36.245"></a><span id="l36.245">   }</span>
<a href="#l36.246"></a><span id="l36.246"> </span>
<a href="#l36.247"></a><span id="l36.247">   bool bResult = true;</span>
<a href="#l36.248"></a><span id="l36.248">   LPSTREAM lpAttachStream;</span>
<a href="#l36.249"></a><span id="l36.249" class="difflineminus">-  hr = lpAttach-&gt;OpenProperty( PR_ATTACH_DATA_BIN, &amp;IID_IStream, 0, 0, (LPUNKNOWN *)&amp;lpAttachStream);</span>
<a href="#l36.250"></a><span id="l36.250" class="difflineplus">+  hr = lpAttach-&gt;OpenProperty(PR_ATTACH_DATA_BIN, &amp;IID_IStream, 0, 0, (LPUNKNOWN *)&amp;lpAttachStream);</span>
<a href="#l36.251"></a><span id="l36.251"> </span>
<a href="#l36.252"></a><span id="l36.252" class="difflineminus">-  if (HR_FAILED( hr)) {</span>
<a href="#l36.253"></a><span id="l36.253" class="difflineminus">-    MAPI_TRACE0( &quot;~~ERROR~~ OpenProperty failed for PR_ATTACH_DATA_BIN.\r\n&quot;);</span>
<a href="#l36.254"></a><span id="l36.254" class="difflineplus">+  if (HR_FAILED(hr)) {</span>
<a href="#l36.255"></a><span id="l36.255" class="difflineplus">+    MAPI_TRACE0(&quot;~~ERROR~~ OpenProperty failed for PR_ATTACH_DATA_BIN.\r\n&quot;);</span>
<a href="#l36.256"></a><span id="l36.256">     lpAttachStream = NULL;</span>
<a href="#l36.257"></a><span id="l36.257">     bResult = false;</span>
<a href="#l36.258"></a><span id="l36.258">   }</span>
<a href="#l36.259"></a><span id="l36.259">   else {</span>
<a href="#l36.260"></a><span id="l36.260">     STATSTG st;</span>
<a href="#l36.261"></a><span id="l36.261" class="difflineminus">-    hr = lpAttachStream-&gt;Stat( &amp;st, STATFLAG_NONAME);</span>
<a href="#l36.262"></a><span id="l36.262" class="difflineminus">-    if (HR_FAILED( hr)) {</span>
<a href="#l36.263"></a><span id="l36.263" class="difflineminus">-      MAPI_TRACE0( &quot;~~ERROR~~ Stat failed for attachment stream\r\n&quot;);</span>
<a href="#l36.264"></a><span id="l36.264" class="difflineplus">+    hr = lpAttachStream-&gt;Stat(&amp;st, STATFLAG_NONAME);</span>
<a href="#l36.265"></a><span id="l36.265" class="difflineplus">+    if (HR_FAILED(hr)) {</span>
<a href="#l36.266"></a><span id="l36.266" class="difflineplus">+      MAPI_TRACE0(&quot;~~ERROR~~ Stat failed for attachment stream\r\n&quot;);</span>
<a href="#l36.267"></a><span id="l36.267">       bResult = false;</span>
<a href="#l36.268"></a><span id="l36.268">     }</span>
<a href="#l36.269"></a><span id="l36.269">     else {</span>
<a href="#l36.270"></a><span id="l36.270" class="difflineminus">-      hr = lpAttachStream-&gt;CopyTo( lpStreamFile, st.cbSize, NULL, NULL);</span>
<a href="#l36.271"></a><span id="l36.271" class="difflineminus">-      if (HR_FAILED( hr)) {</span>
<a href="#l36.272"></a><span id="l36.272" class="difflineminus">-        MAPI_TRACE0( &quot;~~ERROR~~ Attach Stream CopyTo temp file failed.\r\n&quot;);</span>
<a href="#l36.273"></a><span id="l36.273" class="difflineplus">+      hr = lpAttachStream-&gt;CopyTo(lpStreamFile, st.cbSize, NULL, NULL);</span>
<a href="#l36.274"></a><span id="l36.274" class="difflineplus">+      if (HR_FAILED(hr)) {</span>
<a href="#l36.275"></a><span id="l36.275" class="difflineplus">+        MAPI_TRACE0(&quot;~~ERROR~~ Attach Stream CopyTo temp file failed.\r\n&quot;);</span>
<a href="#l36.276"></a><span id="l36.276">         bResult = false;</span>
<a href="#l36.277"></a><span id="l36.277">       }</span>
<a href="#l36.278"></a><span id="l36.278">     }</span>
<a href="#l36.279"></a><span id="l36.279">   }</span>
<a href="#l36.280"></a><span id="l36.280"> </span>
<a href="#l36.281"></a><span id="l36.281">   if (lpAttachStream)</span>
<a href="#l36.282"></a><span id="l36.282">     lpAttachStream-&gt;Release();</span>
<a href="#l36.283"></a><span id="l36.283">   lpStreamFile-&gt;Release();</span>
<a href="#l36.284"></a><span id="l36.284" class="difflineat">@@ -983,20 +983,20 @@ bool CMapiMessage::AddAttachment(DWORD a</span>
<a href="#l36.285"></a><span id="l36.285">   attach_data *data = new attach_data;</span>
<a href="#l36.286"></a><span id="l36.286">   ULONG aMethod;</span>
<a href="#l36.287"></a><span id="l36.287">   if (data) {</span>
<a href="#l36.288"></a><span id="l36.288">     bResult = true;</span>
<a href="#l36.289"></a><span id="l36.289"> </span>
<a href="#l36.290"></a><span id="l36.290">     // 1. Get the file that contains the attachment data</span>
<a href="#l36.291"></a><span id="l36.291">     LPSPropValue pVal = CMapiApi::GetMapiProperty(lpAttach, PR_ATTACH_METHOD);</span>
<a href="#l36.292"></a><span id="l36.292">     if (pVal) {</span>
<a href="#l36.293"></a><span id="l36.293" class="difflineminus">-      aMethod = CMapiApi::GetLongFromProp( pVal);</span>
<a href="#l36.294"></a><span id="l36.294" class="difflineplus">+      aMethod = CMapiApi::GetLongFromProp(pVal);</span>
<a href="#l36.295"></a><span id="l36.295">       switch (aMethod) {</span>
<a href="#l36.296"></a><span id="l36.296">       case ATTACH_BY_VALUE:</span>
<a href="#l36.297"></a><span id="l36.297" class="difflineminus">-        MAPI_TRACE1( &quot;\t\t** Attachment #%d by value.\r\n&quot;, aNum);</span>
<a href="#l36.298"></a><span id="l36.298" class="difflineplus">+        MAPI_TRACE1(&quot;\t\t** Attachment #%d by value.\r\n&quot;, aNum);</span>
<a href="#l36.299"></a><span id="l36.299">         bResult = CopyBinAttachToFile(lpAttach, getter_AddRefs(data-&gt;tmp_file));</span>
<a href="#l36.300"></a><span id="l36.300">         data-&gt;delete_file = true;</span>
<a href="#l36.301"></a><span id="l36.301">         break;</span>
<a href="#l36.302"></a><span id="l36.302">       case ATTACH_BY_REFERENCE:</span>
<a href="#l36.303"></a><span id="l36.303">       case ATTACH_BY_REF_RESOLVE:</span>
<a href="#l36.304"></a><span id="l36.304">       case ATTACH_BY_REF_ONLY:</span>
<a href="#l36.305"></a><span id="l36.305">         pVal = CMapiApi::GetMapiProperty(lpAttach, PR_ATTACH_PATHNAME_W);</span>
<a href="#l36.306"></a><span id="l36.306">         if (pVal) {</span>
<a href="#l36.307"></a><span id="l36.307" class="difflineat">@@ -1147,17 +1147,17 @@ bool CMapiMessage::AddAttachment(DWORD a</span>
<a href="#l36.308"></a><span id="l36.308">         m_stdattachments.push_back(data);</span>
<a href="#l36.309"></a><span id="l36.309">     }</span>
<a href="#l36.310"></a><span id="l36.310">     else {</span>
<a href="#l36.311"></a><span id="l36.311">       delete data;</span>
<a href="#l36.312"></a><span id="l36.312">     }</span>
<a href="#l36.313"></a><span id="l36.313">   }</span>
<a href="#l36.314"></a><span id="l36.314"> </span>
<a href="#l36.315"></a><span id="l36.315">   lpAttach-&gt;Release();</span>
<a href="#l36.316"></a><span id="l36.316" class="difflineminus">-  return( bResult);</span>
<a href="#l36.317"></a><span id="l36.317" class="difflineplus">+  return bResult;</span>
<a href="#l36.318"></a><span id="l36.318"> }</span>
<a href="#l36.319"></a><span id="l36.319"> </span>
<a href="#l36.320"></a><span id="l36.320"> void CMapiMessage::ClearAttachment(attach_data* data)</span>
<a href="#l36.321"></a><span id="l36.321"> {</span>
<a href="#l36.322"></a><span id="l36.322">   if (data-&gt;delete_file &amp;&amp; data-&gt;tmp_file)</span>
<a href="#l36.323"></a><span id="l36.323">     data-&gt;tmp_file-&gt;Remove(false);</span>
<a href="#l36.324"></a><span id="l36.324"> </span>
<a href="#l36.325"></a><span id="l36.325">   if (data-&gt;type)</span>
<a href="#l36.326"></a><span id="l36.326" class="difflineat">@@ -1184,28 +1184,28 @@ void CMapiMessage::ClearAttachments()</span>
<a href="#l36.327"></a><span id="l36.327"> // since the decision if an attachment is embedded or not is made</span>
<a href="#l36.328"></a><span id="l36.328"> // based on the body type and contents</span>
<a href="#l36.329"></a><span id="l36.329"> void CMapiMessage::ProcessAttachments()</span>
<a href="#l36.330"></a><span id="l36.330"> {</span>
<a href="#l36.331"></a><span id="l36.331">   LPSPropValue pVal = CMapiApi::GetMapiProperty(m_lpMsg, PR_HASATTACH);</span>
<a href="#l36.332"></a><span id="l36.332">   bool hasAttach = true;</span>
<a href="#l36.333"></a><span id="l36.333"> </span>
<a href="#l36.334"></a><span id="l36.334">   if (pVal) {</span>
<a href="#l36.335"></a><span id="l36.335" class="difflineminus">-    if (PROP_TYPE( pVal-&gt;ulPropTag) == PT_BOOLEAN)</span>
<a href="#l36.336"></a><span id="l36.336" class="difflineplus">+    if (PROP_TYPE(pVal-&gt;ulPropTag) == PT_BOOLEAN)</span>
<a href="#l36.337"></a><span id="l36.337">       hasAttach = (pVal-&gt;Value.b != 0);</span>
<a href="#l36.338"></a><span id="l36.338" class="difflineminus">-    CMapiApi::MAPIFreeBuffer( pVal);</span>
<a href="#l36.339"></a><span id="l36.339" class="difflineplus">+    CMapiApi::MAPIFreeBuffer(pVal);</span>
<a href="#l36.340"></a><span id="l36.340">   }</span>
<a href="#l36.341"></a><span id="l36.341"> </span>
<a href="#l36.342"></a><span id="l36.342">   if (!hasAttach)</span>
<a href="#l36.343"></a><span id="l36.343">     return;</span>
<a href="#l36.344"></a><span id="l36.344"> </span>
<a href="#l36.345"></a><span id="l36.345">   // Get the attachment table?</span>
<a href="#l36.346"></a><span id="l36.346">   LPMAPITABLE pTable = NULL;</span>
<a href="#l36.347"></a><span id="l36.347" class="difflineminus">-  HRESULT hr = m_lpMsg-&gt;GetAttachmentTable( 0, &amp;pTable);</span>
<a href="#l36.348"></a><span id="l36.348" class="difflineminus">-  if (FAILED( hr) || !pTable)</span>
<a href="#l36.349"></a><span id="l36.349" class="difflineplus">+  HRESULT hr = m_lpMsg-&gt;GetAttachmentTable(0, &amp;pTable);</span>
<a href="#l36.350"></a><span id="l36.350" class="difflineplus">+  if (FAILED(hr) || !pTable)</span>
<a href="#l36.351"></a><span id="l36.351">     return;</span>
<a href="#l36.352"></a><span id="l36.352">   IterateAttachTable(pTable);</span>
<a href="#l36.353"></a><span id="l36.353">   pTable-&gt;Release();</span>
<a href="#l36.354"></a><span id="l36.354"> }</span>
<a href="#l36.355"></a><span id="l36.355"> </span>
<a href="#l36.356"></a><span id="l36.356"> nsresult CMapiMessage::GetAttachments(nsIArray **aArray)</span>
<a href="#l36.357"></a><span id="l36.357"> {</span>
<a href="#l36.358"></a><span id="l36.358">   nsresult rv;</span>
<a href="#l36.359"></a><span id="l36.359" class="difflineat">@@ -1226,17 +1226,17 @@ nsresult CMapiMessage::GetAttachments(ns</span>
<a href="#l36.360"></a><span id="l36.360">   }</span>
<a href="#l36.361"></a><span id="l36.361">   return rv;</span>
<a href="#l36.362"></a><span id="l36.362"> }</span>
<a href="#l36.363"></a><span id="l36.363"> </span>
<a href="#l36.364"></a><span id="l36.364"> bool CMapiMessage::GetEmbeddedAttachmentInfo(unsigned int i, nsIURI **uri,</span>
<a href="#l36.365"></a><span id="l36.365">                                              const char **cid,</span>
<a href="#l36.366"></a><span id="l36.366">                                              const char **name) const</span>
<a href="#l36.367"></a><span id="l36.367"> {</span>
<a href="#l36.368"></a><span id="l36.368" class="difflineminus">-  if ((i &lt; 0) || ( i &gt;= m_embattachments.size()))</span>
<a href="#l36.369"></a><span id="l36.369" class="difflineplus">+  if ((i &lt; 0) || (i &gt;= m_embattachments.size()))</span>
<a href="#l36.370"></a><span id="l36.370">     return false;</span>
<a href="#l36.371"></a><span id="l36.371">   attach_data* data = m_embattachments[i];</span>
<a href="#l36.372"></a><span id="l36.372">   if (!data)</span>
<a href="#l36.373"></a><span id="l36.373">     return false;</span>
<a href="#l36.374"></a><span id="l36.374">   *uri = data-&gt;orig_url;</span>
<a href="#l36.375"></a><span id="l36.375">   *cid = data-&gt;cid;</span>
<a href="#l36.376"></a><span id="l36.376">   *name = data-&gt;real_name;</span>
<a href="#l36.377"></a><span id="l36.377">   return true;</span>
<a href="#l36.378"></a><span id="l36.378" class="difflineat">@@ -1475,27 +1475,27 @@ int CMapiMessageHeaders::SetValue(Specia</span>
<a href="#l36.379"></a><span id="l36.379"> }</span>
<a href="#l36.380"></a><span id="l36.380"> </span>
<a href="#l36.381"></a><span id="l36.381"> void CMapiMessageHeaders::write_to_stream::operator () (const CHeaderField* f)</span>
<a href="#l36.382"></a><span id="l36.382"> {</span>
<a href="#l36.383"></a><span id="l36.383">   if (!f || NS_FAILED(m_rv))</span>
<a href="#l36.384"></a><span id="l36.384">     return;</span>
<a href="#l36.385"></a><span id="l36.385"> </span>
<a href="#l36.386"></a><span id="l36.386">   PRUint32 written;</span>
<a href="#l36.387"></a><span id="l36.387" class="difflineminus">-  m_rv = m_pDst-&gt;Write( f-&gt;fname(), strlen(f-&gt;fname()), &amp;written);</span>
<a href="#l36.388"></a><span id="l36.388" class="difflineplus">+  m_rv = m_pDst-&gt;Write(f-&gt;fname(), strlen(f-&gt;fname()), &amp;written);</span>
<a href="#l36.389"></a><span id="l36.389">   NS_ENSURE_SUCCESS(m_rv,);</span>
<a href="#l36.390"></a><span id="l36.390">   if (f-&gt;fbody()) {</span>
<a href="#l36.391"></a><span id="l36.391">     m_rv = m_pDst-&gt;Write(f-&gt;fbody(), strlen(f-&gt;fbody()), &amp;written);</span>
<a href="#l36.392"></a><span id="l36.392">     NS_ENSURE_SUCCESS(m_rv,);</span>
<a href="#l36.393"></a><span id="l36.393">   }</span>
<a href="#l36.394"></a><span id="l36.394" class="difflineminus">-  m_rv = m_pDst-&gt;Write( &quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l36.395"></a><span id="l36.395" class="difflineplus">+  m_rv = m_pDst-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l36.396"></a><span id="l36.396"> }</span>
<a href="#l36.397"></a><span id="l36.397"> </span>
<a href="#l36.398"></a><span id="l36.398"> nsresult CMapiMessageHeaders::ToStream(nsIOutputStream *pDst) const</span>
<a href="#l36.399"></a><span id="l36.399"> {</span>
<a href="#l36.400"></a><span id="l36.400">   nsresult rv = std::for_each(m_headerFields.begin(), m_headerFields.end(),</span>
<a href="#l36.401"></a><span id="l36.401">                               write_to_stream(pDst));</span>
<a href="#l36.402"></a><span id="l36.402">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l36.403"></a><span id="l36.403">     PRUint32 written;</span>
<a href="#l36.404"></a><span id="l36.404" class="difflineminus">-    rv = pDst-&gt;Write( &quot;\x0D\x0A&quot;, 2, &amp;written); // Separator line</span>
<a href="#l36.405"></a><span id="l36.405" class="difflineplus">+    rv = pDst-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written); // Separator line</span>
<a href="#l36.406"></a><span id="l36.406">   }</span>
<a href="#l36.407"></a><span id="l36.407">   return rv;</span>
<a href="#l36.408"></a><span id="l36.408"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiMessage.h</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiMessage.h</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -41,31 +41,31 @@</span>
<a href="#l37.4"></a><span id="l37.4"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l37.5"></a><span id="l37.5"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l37.6"></a><span id="l37.6"> #include &quot;MapiApi.h&quot;</span>
<a href="#l37.7"></a><span id="l37.7"> #include &quot;nsIMsgSend.h&quot;</span>
<a href="#l37.8"></a><span id="l37.8"> </span>
<a href="#l37.9"></a><span id="l37.9"> #include &lt;vector&gt;</span>
<a href="#l37.10"></a><span id="l37.10"> </span>
<a href="#l37.11"></a><span id="l37.11"> #ifndef PR_LAST_VERB_EXECUTED</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-#define PR_LAST_VERB_EXECUTED PROP_TAG( PT_LONG, 0x1081)</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+#define PR_LAST_VERB_EXECUTED PROP_TAG(PT_LONG, 0x1081)</span>
<a href="#l37.14"></a><span id="l37.14"> #endif</span>
<a href="#l37.15"></a><span id="l37.15"> </span>
<a href="#l37.16"></a><span id="l37.16"> #define EXCHIVERB_REPLYTOSENDER (102)</span>
<a href="#l37.17"></a><span id="l37.17"> #define EXCHIVERB_REPLYTOALL    (103)</span>
<a href="#l37.18"></a><span id="l37.18"> #define EXCHIVERB_FORWARD       (104)</span>
<a href="#l37.19"></a><span id="l37.19"> </span>
<a href="#l37.20"></a><span id="l37.20"> #ifndef PR_ATTACH_CONTENT_ID</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineminus">-#define PR_ATTACH_CONTENT_ID PROP_TAG( PT_TSTRING,	0x3712)</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineplus">+#define PR_ATTACH_CONTENT_ID PROP_TAG(PT_TSTRING,	0x3712)</span>
<a href="#l37.23"></a><span id="l37.23"> #endif</span>
<a href="#l37.24"></a><span id="l37.24"> #ifndef PR_ATTACH_CONTENT_ID_W</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineminus">-#define PR_ATTACH_CONTENT_ID_W PROP_TAG( PT_UNICODE,	0x3712)</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineplus">+#define PR_ATTACH_CONTENT_ID_W PROP_TAG(PT_UNICODE,	0x3712)</span>
<a href="#l37.27"></a><span id="l37.27"> #endif</span>
<a href="#l37.28"></a><span id="l37.28"> #ifndef PR_ATTACH_CONTENT_ID_A</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineminus">-#define PR_ATTACH_CONTENT_ID_A PROP_TAG( PT_STRING8,	0x3712)</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineplus">+#define PR_ATTACH_CONTENT_ID_A PROP_TAG(PT_STRING8,	0x3712)</span>
<a href="#l37.31"></a><span id="l37.31"> #endif</span>
<a href="#l37.32"></a><span id="l37.32"> </span>
<a href="#l37.33"></a><span id="l37.33"> #ifndef PR_ATTACH_FLAGS</span>
<a href="#l37.34"></a><span id="l37.34"> #define PR_ATTACH_FLAGS PROP_TAG(PT_LONG,	0x3714)</span>
<a href="#l37.35"></a><span id="l37.35"> #endif</span>
<a href="#l37.36"></a><span id="l37.36"> </span>
<a href="#l37.37"></a><span id="l37.37"> #ifndef ATT_INVISIBLE_IN_HTML</span>
<a href="#l37.38"></a><span id="l37.38"> #define ATT_INVISIBLE_IN_HTML (0x1)</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineat">@@ -175,60 +175,60 @@ private:</span>
<a href="#l37.40"></a><span id="l37.40">   inline CHeaderField* Find(const char* name) { return const_cast&lt;CHeaderField*&gt;(CFind(name)); }</span>
<a href="#l37.41"></a><span id="l37.41"> </span>
<a href="#l37.42"></a><span id="l37.42"> }; // class CMapiMessageHeaders</span>
<a href="#l37.43"></a><span id="l37.43"> </span>
<a href="#l37.44"></a><span id="l37.44"> //////////////////////////////////////////////////////</span>
<a href="#l37.45"></a><span id="l37.45"> </span>
<a href="#l37.46"></a><span id="l37.46"> class CMapiMessage {</span>
<a href="#l37.47"></a><span id="l37.47"> public:</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineminus">-  CMapiMessage( LPMESSAGE  lpMsg);</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineplus">+  CMapiMessage(LPMESSAGE  lpMsg);</span>
<a href="#l37.50"></a><span id="l37.50">   ~CMapiMessage();</span>
<a href="#l37.51"></a><span id="l37.51"> </span>
<a href="#l37.52"></a><span id="l37.52">   // Attachments</span>
<a href="#l37.53"></a><span id="l37.53">   // Ordinary (not embedded) attachments.</span>
<a href="#l37.54"></a><span id="l37.54">   nsresult GetAttachments(nsIArray **aArray);</span>
<a href="#l37.55"></a><span id="l37.55">   // Embedded attachments</span>
<a href="#l37.56"></a><span id="l37.56">   size_t EmbeddedAttachmentsCount() const { return m_embattachments.size(); }</span>
<a href="#l37.57"></a><span id="l37.57">   bool GetEmbeddedAttachmentInfo(unsigned int i, nsIURI **uri, const char **cid,</span>
<a href="#l37.58"></a><span id="l37.58">                                  const char **name) const;</span>
<a href="#l37.59"></a><span id="l37.59">   // We don't check MSGFLAG_HASATTACH, since it returns true even if there are</span>
<a href="#l37.60"></a><span id="l37.60">   // only embedded attachmentsin the message. TB only counts the ordinary</span>
<a href="#l37.61"></a><span id="l37.61">   // attachments when shows the message status, so here we check only for the</span>
<a href="#l37.62"></a><span id="l37.62">   // ordinary attachments.</span>
<a href="#l37.63"></a><span id="l37.63">   inline bool HasAttach() const { return !m_stdattachments.empty(); }</span>
<a href="#l37.64"></a><span id="l37.64"> </span>
<a href="#l37.65"></a><span id="l37.65">   // Retrieve info for message</span>
<a href="#l37.66"></a><span id="l37.66" class="difflineminus">-  inline bool BodyIsHtml( void) const { return( m_bodyIsHtml);}</span>
<a href="#l37.67"></a><span id="l37.67" class="difflineplus">+  inline bool BodyIsHtml(void) const { return m_bodyIsHtml;}</span>
<a href="#l37.68"></a><span id="l37.68">   const char *GetFromLine(int&amp; len) const {</span>
<a href="#l37.69"></a><span id="l37.69">     if (m_fromLine.IsEmpty())</span>
<a href="#l37.70"></a><span id="l37.70">       return NULL; </span>
<a href="#l37.71"></a><span id="l37.71">     else {</span>
<a href="#l37.72"></a><span id="l37.72">       len = m_fromLine.Length();</span>
<a href="#l37.73"></a><span id="l37.73" class="difflineminus">-      return( m_fromLine.get());}</span>
<a href="#l37.74"></a><span id="l37.74" class="difflineplus">+      return m_fromLine.get();}</span>
<a href="#l37.75"></a><span id="l37.75">   }</span>
<a href="#l37.76"></a><span id="l37.76">   inline CMapiMessageHeaders *GetHeaders() { return &amp;m_headers; }</span>
<a href="#l37.77"></a><span id="l37.77" class="difflineminus">-  inline const wchar_t *GetBody( void) const { return( m_body.get()); }</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineminus">-  inline size_t GetBodyLen( void) const { return( m_body.Length()); }</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineplus">+  inline const wchar_t *GetBody(void) const { return m_body.get(); }</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineplus">+  inline size_t GetBodyLen(void) const { return m_body.Length(); }</span>
<a href="#l37.81"></a><span id="l37.81">   void GetBody(nsCString&amp; dest) const;</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineminus">-  inline const char *GetBodyCharset( void) const { return( m_mimeCharset.get());}</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineplus">+  inline const char *GetBodyCharset(void) const { return m_mimeCharset.get();}</span>
<a href="#l37.84"></a><span id="l37.84">   inline bool IsRead() const { return m_msgFlags &amp; MSGFLAG_READ; }</span>
<a href="#l37.85"></a><span id="l37.85">   inline bool IsReplied() const {</span>
<a href="#l37.86"></a><span id="l37.86">     return (m_msgLastVerb == EXCHIVERB_REPLYTOSENDER) ||</span>
<a href="#l37.87"></a><span id="l37.87">            (m_msgLastVerb == EXCHIVERB_REPLYTOALL); }</span>
<a href="#l37.88"></a><span id="l37.88">   inline bool IsForvarded() const {</span>
<a href="#l37.89"></a><span id="l37.89">     return m_msgLastVerb == EXCHIVERB_FORWARD; }</span>
<a href="#l37.90"></a><span id="l37.90"> </span>
<a href="#l37.91"></a><span id="l37.91" class="difflineminus">-  bool    HasContentHeader( void) const {</span>
<a href="#l37.92"></a><span id="l37.92" class="difflineminus">-    return( !m_mimeContentType.IsEmpty());}</span>
<a href="#l37.93"></a><span id="l37.93" class="difflineminus">-  bool    HasMimeVersion( void) const {</span>
<a href="#l37.94"></a><span id="l37.94" class="difflineplus">+  bool    HasContentHeader(void) const {</span>
<a href="#l37.95"></a><span id="l37.95" class="difflineplus">+    return !m_mimeContentType.IsEmpty();}</span>
<a href="#l37.96"></a><span id="l37.96" class="difflineplus">+  bool    HasMimeVersion(void) const {</span>
<a href="#l37.97"></a><span id="l37.97">     return m_headers.Value(CMapiMessageHeaders::hdrMimeVersion); }</span>
<a href="#l37.98"></a><span id="l37.98" class="difflineminus">-  const char *GetMimeContent( void) const { return( m_mimeContentType.get());}</span>
<a href="#l37.99"></a><span id="l37.99" class="difflineminus">-  PRInt32     GetMimeContentLen( void) const { return( m_mimeContentType.Length());}</span>
<a href="#l37.100"></a><span id="l37.100" class="difflineminus">-  const char *GetMimeBoundary( void) const { return( m_mimeBoundary.get());}</span>
<a href="#l37.101"></a><span id="l37.101" class="difflineplus">+  const char *GetMimeContent(void) const { return m_mimeContentType.get();}</span>
<a href="#l37.102"></a><span id="l37.102" class="difflineplus">+  PRInt32     GetMimeContentLen(void) const { return m_mimeContentType.Length();}</span>
<a href="#l37.103"></a><span id="l37.103" class="difflineplus">+  const char *GetMimeBoundary(void) const { return m_mimeBoundary.get();}</span>
<a href="#l37.104"></a><span id="l37.104"> </span>
<a href="#l37.105"></a><span id="l37.105">    // The only required part of a message is its header</span>
<a href="#l37.106"></a><span id="l37.106">   inline bool ValidState() const { return !m_headers.IsEmpty(); }</span>
<a href="#l37.107"></a><span id="l37.107">   inline bool FullMessageDownloaded() const { return !m_dldStateHeadersOnly; }</span>
<a href="#l37.108"></a><span id="l37.108"> </span>
<a href="#l37.109"></a><span id="l37.109"> private:</span>
<a href="#l37.110"></a><span id="l37.110">   struct attach_data {</span>
<a href="#l37.111"></a><span id="l37.111">     nsCOMPtr&lt;nsIURI&gt; orig_url;</span>
<a href="#l37.112"></a><span id="l37.112" class="difflineat">@@ -266,38 +266,38 @@ private:</span>
<a href="#l37.113"></a><span id="l37.113">   void    GetDownloadState();</span>
<a href="#l37.114"></a><span id="l37.114"> </span>
<a href="#l37.115"></a><span id="l37.115">   // Headers - fetch will get PR_TRANSPORT_MESSAGE_HEADERS</span>
<a href="#l37.116"></a><span id="l37.116">   // or if they do not exist will build a header from</span>
<a href="#l37.117"></a><span id="l37.117">   //  PR_DISPLAY_TO, _CC, _BCC</span>
<a href="#l37.118"></a><span id="l37.118">   //  PR_SUBJECT</span>
<a href="#l37.119"></a><span id="l37.119">   //  PR_MESSAGE_RECIPIENTS</span>
<a href="#l37.120"></a><span id="l37.120">   // and PR_CREATION_TIME if needed?</span>
<a href="#l37.121"></a><span id="l37.121" class="difflineminus">-  bool    FetchHeaders( void);</span>
<a href="#l37.122"></a><span id="l37.122" class="difflineminus">-  bool    FetchBody( void);</span>
<a href="#l37.123"></a><span id="l37.123" class="difflineminus">-  void    FetchFlags( void);</span>
<a href="#l37.124"></a><span id="l37.124" class="difflineplus">+  bool    FetchHeaders(void);</span>
<a href="#l37.125"></a><span id="l37.125" class="difflineplus">+  bool    FetchBody(void);</span>
<a href="#l37.126"></a><span id="l37.126" class="difflineplus">+  void    FetchFlags(void);</span>
<a href="#l37.127"></a><span id="l37.127"> </span>
<a href="#l37.128"></a><span id="l37.128">   static bool GetTmpFile(/*out*/ nsILocalFile **aResult);</span>
<a href="#l37.129"></a><span id="l37.129">   static bool CopyMsgAttachToFile(LPATTACH lpAttach, /*out*/ nsILocalFile **tmp_file);</span>
<a href="#l37.130"></a><span id="l37.130" class="difflineminus">-  static bool CopyBinAttachToFile( LPATTACH lpAttach, nsILocalFile **tmp_file);</span>
<a href="#l37.131"></a><span id="l37.131" class="difflineplus">+  static bool CopyBinAttachToFile(LPATTACH lpAttach, nsILocalFile **tmp_file);</span>
<a href="#l37.132"></a><span id="l37.132"> </span>
<a href="#l37.133"></a><span id="l37.133">   static void ClearAttachment(attach_data* data);</span>
<a href="#l37.134"></a><span id="l37.134">   void    ClearAttachments();</span>
<a href="#l37.135"></a><span id="l37.135">   bool    AddAttachment(DWORD aNum);</span>
<a href="#l37.136"></a><span id="l37.136">   bool    IterateAttachTable(LPMAPITABLE tbl);</span>
<a href="#l37.137"></a><span id="l37.137">   bool    GetURL(nsIFile *aFile, nsIURI **url);</span>
<a href="#l37.138"></a><span id="l37.138">   void    ProcessAttachments();</span>
<a href="#l37.139"></a><span id="l37.139"> </span>
<a href="#l37.140"></a><span id="l37.140">   bool    EnsureHeader(CMapiMessageHeaders::SpecialHeader special, ULONG mapiTag);</span>
<a href="#l37.141"></a><span id="l37.141">   bool    EnsureDate();</span>
<a href="#l37.142"></a><span id="l37.142"> </span>
<a href="#l37.143"></a><span id="l37.143">   void    ProcessContentType();</span>
<a href="#l37.144"></a><span id="l37.144">   bool    CheckBodyInCharsetRange(const char* charset);</span>
<a href="#l37.145"></a><span id="l37.145">   void    FormatDateTime(SYSTEMTIME&amp; tm, nsCString&amp; s, bool includeTZ = true);</span>
<a href="#l37.146"></a><span id="l37.146" class="difflineminus">-  void    BuildFromLine( void);</span>
<a href="#l37.147"></a><span id="l37.147" class="difflineplus">+  void    BuildFromLine(void);</span>
<a href="#l37.148"></a><span id="l37.148"> </span>
<a href="#l37.149"></a><span id="l37.149" class="difflineminus">-  inline static bool IsSpace( char c) {</span>
<a href="#l37.150"></a><span id="l37.150" class="difflineplus">+  inline static bool IsSpace(char c) {</span>
<a href="#l37.151"></a><span id="l37.151">     return c == ' ' || c == '\r' || c == '\n' || c == '\b' || c == '\t';}</span>
<a href="#l37.152"></a><span id="l37.152" class="difflineminus">-  inline static bool IsSpace( wchar_t c) { </span>
<a href="#l37.153"></a><span id="l37.153" class="difflineplus">+  inline static bool IsSpace(wchar_t c) { </span>
<a href="#l37.154"></a><span id="l37.154">     return ((c &amp; 0xFF) == c) &amp;&amp; IsSpace(static_cast&lt;char&gt;(c)); } // Avoid false detections</span>
<a href="#l37.155"></a><span id="l37.155"> };</span>
<a href="#l37.156"></a><span id="l37.156"> </span>
<a href="#l37.157"></a><span id="l37.157"> #endif /* MapiMessage_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiMimeTypes.cpp</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiMimeTypes.cpp</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -37,59 +37,59 @@</span>
<a href="#l38.4"></a><span id="l38.4"> </span>
<a href="#l38.5"></a><span id="l38.5"> #include &quot;nscore.h&quot;</span>
<a href="#l38.6"></a><span id="l38.6"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l38.7"></a><span id="l38.7"> #include &quot;MapiMimeTypes.h&quot;</span>
<a href="#l38.8"></a><span id="l38.8"> </span>
<a href="#l38.9"></a><span id="l38.9"> PRUint8 CMimeTypes::m_mimeBuffer[kMaxMimeTypeSize];</span>
<a href="#l38.10"></a><span id="l38.10"> </span>
<a href="#l38.11"></a><span id="l38.11"> </span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-BOOL CMimeTypes::GetKey( HKEY root, LPCTSTR pName, PHKEY pKey)</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+BOOL CMimeTypes::GetKey(HKEY root, LPCTSTR pName, PHKEY pKey)</span>
<a href="#l38.14"></a><span id="l38.14"> {</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-  LONG result = RegOpenKeyEx( root, pName, 0, KEY_QUERY_VALUE | KEY_ENUMERATE_SUB_KEYS, pKey);</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineminus">-  return (result == ERROR_SUCCESS);</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineplus">+  LONG result = RegOpenKeyEx(root, pName, 0, KEY_QUERY_VALUE | KEY_ENUMERATE_SUB_KEYS, pKey);</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineplus">+  return result == ERROR_SUCCESS;</span>
<a href="#l38.19"></a><span id="l38.19"> }</span>
<a href="#l38.20"></a><span id="l38.20"> </span>
<a href="#l38.21"></a><span id="l38.21" class="difflineminus">-BOOL CMimeTypes::GetValueBytes( HKEY rootKey, LPCTSTR pValName, LPBYTE *ppBytes)</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineplus">+BOOL CMimeTypes::GetValueBytes(HKEY rootKey, LPCTSTR pValName, LPBYTE *ppBytes)</span>
<a href="#l38.23"></a><span id="l38.23"> {</span>
<a href="#l38.24"></a><span id="l38.24">   LONG  err;</span>
<a href="#l38.25"></a><span id="l38.25">   DWORD  bufSz;</span>
<a href="#l38.26"></a><span id="l38.26"> </span>
<a href="#l38.27"></a><span id="l38.27">   *ppBytes = NULL;</span>
<a href="#l38.28"></a><span id="l38.28">   // Get the installed directory</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineminus">-  err = RegQueryValueEx( rootKey, pValName, NULL, NULL, NULL, &amp;bufSz);</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineplus">+  err = RegQueryValueEx(rootKey, pValName, NULL, NULL, NULL, &amp;bufSz);</span>
<a href="#l38.31"></a><span id="l38.31">   if (err == ERROR_SUCCESS) {</span>
<a href="#l38.32"></a><span id="l38.32">     *ppBytes = new BYTE[bufSz];</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineminus">-    err = RegQueryValueEx( rootKey, pValName, NULL, NULL, *ppBytes, &amp;bufSz);</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+    err = RegQueryValueEx(rootKey, pValName, NULL, NULL, *ppBytes, &amp;bufSz);</span>
<a href="#l38.35"></a><span id="l38.35">     if (err == ERROR_SUCCESS) {</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineminus">-      return( TRUE);</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineplus">+      return TRUE;</span>
<a href="#l38.38"></a><span id="l38.38">     }</span>
<a href="#l38.39"></a><span id="l38.39">     delete *ppBytes;</span>
<a href="#l38.40"></a><span id="l38.40">     *ppBytes = NULL;</span>
<a href="#l38.41"></a><span id="l38.41">   }</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineminus">-  return( FALSE);</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineplus">+  return FALSE;</span>
<a href="#l38.44"></a><span id="l38.44"> }</span>
<a href="#l38.45"></a><span id="l38.45"> </span>
<a href="#l38.46"></a><span id="l38.46" class="difflineminus">-void CMimeTypes::ReleaseValueBytes( LPBYTE pBytes)</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineplus">+void CMimeTypes::ReleaseValueBytes(LPBYTE pBytes)</span>
<a href="#l38.48"></a><span id="l38.48"> {</span>
<a href="#l38.49"></a><span id="l38.49">   if (pBytes)</span>
<a href="#l38.50"></a><span id="l38.50">     delete pBytes;</span>
<a href="#l38.51"></a><span id="l38.51"> }</span>
<a href="#l38.52"></a><span id="l38.52"> </span>
<a href="#l38.53"></a><span id="l38.53" class="difflineminus">-BOOL CMimeTypes::GetMimeTypeFromReg( const nsCString&amp; ext, LPBYTE *ppBytes)</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineplus">+BOOL CMimeTypes::GetMimeTypeFromReg(const nsCString&amp; ext, LPBYTE *ppBytes)</span>
<a href="#l38.55"></a><span id="l38.55"> {</span>
<a href="#l38.56"></a><span id="l38.56">   HKEY  extensionKey;</span>
<a href="#l38.57"></a><span id="l38.57">   BOOL  result = FALSE;</span>
<a href="#l38.58"></a><span id="l38.58">   *ppBytes = NULL;</span>
<a href="#l38.59"></a><span id="l38.59" class="difflineminus">-  if (GetKey( HKEY_CLASSES_ROOT, ext.get(), &amp;extensionKey)) {</span>
<a href="#l38.60"></a><span id="l38.60" class="difflineminus">-    result = GetValueBytes( extensionKey, &quot;Content Type&quot;, ppBytes);</span>
<a href="#l38.61"></a><span id="l38.61" class="difflineminus">-    RegCloseKey( extensionKey);</span>
<a href="#l38.62"></a><span id="l38.62" class="difflineplus">+  if (GetKey(HKEY_CLASSES_ROOT, ext.get(), &amp;extensionKey)) {</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineplus">+    result = GetValueBytes(extensionKey, &quot;Content Type&quot;, ppBytes);</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineplus">+    RegCloseKey(extensionKey);</span>
<a href="#l38.65"></a><span id="l38.65">   }</span>
<a href="#l38.66"></a><span id="l38.66"> </span>
<a href="#l38.67"></a><span id="l38.67" class="difflineminus">-  return( result);</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineplus">+  return result;</span>
<a href="#l38.69"></a><span id="l38.69"> }</span>
<a href="#l38.70"></a><span id="l38.70"> </span>
<a href="#l38.71"></a><span id="l38.71"> PRUint8 * CMimeTypes::GetMimeType(const nsString&amp; theExt)</span>
<a href="#l38.72"></a><span id="l38.72"> {</span>
<a href="#l38.73"></a><span id="l38.73">   nsCString ext;</span>
<a href="#l38.74"></a><span id="l38.74">   LossyCopyUTF16toASCII(theExt, ext);</span>
<a href="#l38.75"></a><span id="l38.75">   return GetMimeType(ext);</span>
<a href="#l38.76"></a><span id="l38.76"> }</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineat">@@ -104,25 +104,25 @@ PRUint8 * CMimeTypes::GetMimeType(const </span>
<a href="#l38.78"></a><span id="l38.78">     }</span>
<a href="#l38.79"></a><span id="l38.79">   }</span>
<a href="#l38.80"></a><span id="l38.80"> </span>
<a href="#l38.81"></a><span id="l38.81"> </span>
<a href="#l38.82"></a><span id="l38.82">   BOOL  result = FALSE;</span>
<a href="#l38.83"></a><span id="l38.83">   int    len;</span>
<a href="#l38.84"></a><span id="l38.84"> </span>
<a href="#l38.85"></a><span id="l38.85">   if (!ext.Length())</span>
<a href="#l38.86"></a><span id="l38.86" class="difflineminus">-    return( NULL);</span>
<a href="#l38.87"></a><span id="l38.87" class="difflineplus">+    return NULL;</span>
<a href="#l38.88"></a><span id="l38.88">   LPBYTE  pByte;</span>
<a href="#l38.89"></a><span id="l38.89" class="difflineminus">-  if (GetMimeTypeFromReg( ext, &amp;pByte)) {</span>
<a href="#l38.90"></a><span id="l38.90" class="difflineminus">-    len = strlen( (const char *) pByte);</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineplus">+  if (GetMimeTypeFromReg(ext, &amp;pByte)) {</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineplus">+    len = strlen((const char *) pByte);</span>
<a href="#l38.93"></a><span id="l38.93">     if (len &amp;&amp; (len &lt; kMaxMimeTypeSize)) {</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineminus">-      memcpy( m_mimeBuffer, pByte, len);</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineplus">+      memcpy(m_mimeBuffer, pByte, len);</span>
<a href="#l38.96"></a><span id="l38.96">       m_mimeBuffer[len] = 0;</span>
<a href="#l38.97"></a><span id="l38.97">       result = TRUE;</span>
<a href="#l38.98"></a><span id="l38.98">     }</span>
<a href="#l38.99"></a><span id="l38.99" class="difflineminus">-    ReleaseValueBytes( pByte);</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineplus">+    ReleaseValueBytes(pByte);</span>
<a href="#l38.101"></a><span id="l38.101">   }</span>
<a href="#l38.102"></a><span id="l38.102"> </span>
<a href="#l38.103"></a><span id="l38.103">   if (result)</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineminus">-    return( m_mimeBuffer);</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineplus">+    return m_mimeBuffer;</span>
<a href="#l38.106"></a><span id="l38.106"> </span>
<a href="#l38.107"></a><span id="l38.107" class="difflineminus">-  return( NULL);</span>
<a href="#l38.108"></a><span id="l38.108" class="difflineplus">+  return NULL;</span>
<a href="#l38.109"></a><span id="l38.109"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiMimeTypes.h</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiMimeTypes.h</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -45,19 +45,19 @@</span>
<a href="#l39.4"></a><span id="l39.4"> class CMimeTypes {</span>
<a href="#l39.5"></a><span id="l39.5"> public:</span>
<a href="#l39.6"></a><span id="l39.6"> </span>
<a href="#l39.7"></a><span id="l39.7"> static PRUint8 *  GetMimeType(const nsCString&amp; theExt);</span>
<a href="#l39.8"></a><span id="l39.8"> static PRUint8 *  GetMimeType(const nsString&amp; theExt);</span>
<a href="#l39.9"></a><span id="l39.9"> </span>
<a href="#l39.10"></a><span id="l39.10"> protected:</span>
<a href="#l39.11"></a><span id="l39.11">   // Registry stuff</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-static BOOL  GetKey( HKEY root, LPCTSTR pName, PHKEY pKey);</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-static BOOL  GetValueBytes( HKEY rootKey, LPCTSTR pValName, LPBYTE *ppBytes);</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineminus">-static void  ReleaseValueBytes( LPBYTE pBytes);</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineminus">-static BOOL  GetMimeTypeFromReg( const nsCString&amp; ext, LPBYTE *ppBytes);</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineplus">+static BOOL  GetKey(HKEY root, LPCTSTR pName, PHKEY pKey);</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineplus">+static BOOL  GetValueBytes(HKEY rootKey, LPCTSTR pValName, LPBYTE *ppBytes);</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineplus">+static void  ReleaseValueBytes(LPBYTE pBytes);</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineplus">+static BOOL  GetMimeTypeFromReg(const nsCString&amp; ext, LPBYTE *ppBytes);</span>
<a href="#l39.20"></a><span id="l39.20"> </span>
<a href="#l39.21"></a><span id="l39.21"> </span>
<a href="#l39.22"></a><span id="l39.22"> static PRUint8          m_mimeBuffer[kMaxMimeTypeSize];</span>
<a href="#l39.23"></a><span id="l39.23"> };</span>
<a href="#l39.24"></a><span id="l39.24"> </span>
<a href="#l39.25"></a><span id="l39.25"> #endif /* MapiMimeTypes_h__ */</span>
<a href="#l39.26"></a><span id="l39.26"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookCompose.cpp</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookCompose.cpp</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -69,18 +69,18 @@</span>
<a href="#l40.4"></a><span id="l40.4"> #include &quot;nsOutlookEditor.h&quot;</span>
<a href="#l40.5"></a><span id="l40.5"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l40.6"></a><span id="l40.6"> </span>
<a href="#l40.7"></a><span id="l40.7"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l40.8"></a><span id="l40.8"> #include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l40.9"></a><span id="l40.9"> </span>
<a href="#l40.10"></a><span id="l40.10"> #include &lt;algorithm&gt;</span>
<a href="#l40.11"></a><span id="l40.11"> </span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-static NS_DEFINE_CID( kMsgSendCID, NS_MSGSEND_CID);</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-static NS_DEFINE_CID( kMsgCompFieldsCID, NS_MSGCOMPFIELDS_CID);</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+static NS_DEFINE_CID(kMsgSendCID, NS_MSGSEND_CID);</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineplus">+static NS_DEFINE_CID(kMsgCompFieldsCID, NS_MSGCOMPFIELDS_CID);</span>
<a href="#l40.16"></a><span id="l40.16"> </span>
<a href="#l40.17"></a><span id="l40.17"> // We need to do some calculations to set these numbers to something reasonable!</span>
<a href="#l40.18"></a><span id="l40.18"> // Unless of course, CreateAndSendMessage will NEVER EVER leave us in the lurch</span>
<a href="#l40.19"></a><span id="l40.19"> #define kHungCount 100000</span>
<a href="#l40.20"></a><span id="l40.20"> #define kHungAbortCount 1000</span>
<a href="#l40.21"></a><span id="l40.21"> </span>
<a href="#l40.22"></a><span id="l40.22"> #ifdef IMPORT_DEBUG</span>
<a href="#l40.23"></a><span id="l40.23"> static const char *p_test_headers =</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineat">@@ -146,17 +146,17 @@ private:</span>
<a href="#l40.25"></a><span id="l40.25"> class OutlookSendListener : public nsIMsgSendListener</span>
<a href="#l40.26"></a><span id="l40.26"> {</span>
<a href="#l40.27"></a><span id="l40.27"> public:</span>
<a href="#l40.28"></a><span id="l40.28">   OutlookSendListener() {</span>
<a href="#l40.29"></a><span id="l40.29">     m_done = false;</span>
<a href="#l40.30"></a><span id="l40.30">     m_location = nsnull;</span>
<a href="#l40.31"></a><span id="l40.31">   }</span>
<a href="#l40.32"></a><span id="l40.32"> </span>
<a href="#l40.33"></a><span id="l40.33" class="difflineminus">-  virtual ~OutlookSendListener() { NS_IF_RELEASE( m_location); }</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineplus">+  virtual ~OutlookSendListener() { NS_IF_RELEASE(m_location); }</span>
<a href="#l40.35"></a><span id="l40.35"> </span>
<a href="#l40.36"></a><span id="l40.36">   // nsISupports interface</span>
<a href="#l40.37"></a><span id="l40.37">   NS_DECL_ISUPPORTS</span>
<a href="#l40.38"></a><span id="l40.38"> </span>
<a href="#l40.39"></a><span id="l40.39">   /* void OnStartSending (in string aMsgID, in PRUint32 aMsgSize); */</span>
<a href="#l40.40"></a><span id="l40.40">   NS_IMETHOD OnStartSending(const char *aMsgID, PRUint32 aMsgSize) {return NS_OK;}</span>
<a href="#l40.41"></a><span id="l40.41"> </span>
<a href="#l40.42"></a><span id="l40.42">   /* void OnProgress (in string aMsgID, in PRUint32 aProgress, in PRUint32 aProgressMax); */</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineat">@@ -174,27 +174,27 @@ public:</span>
<a href="#l40.44"></a><span id="l40.44">   }</span>
<a href="#l40.45"></a><span id="l40.45"> </span>
<a href="#l40.46"></a><span id="l40.46">    /* void OnSendNotPerformed */</span>
<a href="#l40.47"></a><span id="l40.47">    NS_IMETHOD OnSendNotPerformed(const char *aMsgID, nsresult aStatus) {return NS_OK;}</span>
<a href="#l40.48"></a><span id="l40.48"> </span>
<a href="#l40.49"></a><span id="l40.49">   /* void OnGetDraftFolderURI (); */</span>
<a href="#l40.50"></a><span id="l40.50">   NS_IMETHOD OnGetDraftFolderURI(const char *aFolderURI) {return NS_OK;}</span>
<a href="#l40.51"></a><span id="l40.51"> </span>
<a href="#l40.52"></a><span id="l40.52" class="difflineminus">-  static nsresult CreateSendListener( nsIMsgSendListener **ppListener);</span>
<a href="#l40.53"></a><span id="l40.53" class="difflineminus">-  void Reset() { m_done = false; NS_IF_RELEASE( m_location);}</span>
<a href="#l40.54"></a><span id="l40.54" class="difflineplus">+  static nsresult CreateSendListener(nsIMsgSendListener **ppListener);</span>
<a href="#l40.55"></a><span id="l40.55" class="difflineplus">+  void Reset() { m_done = false; NS_IF_RELEASE(m_location);}</span>
<a href="#l40.56"></a><span id="l40.56"> </span>
<a href="#l40.57"></a><span id="l40.57"> public:</span>
<a href="#l40.58"></a><span id="l40.58">   bool m_done;</span>
<a href="#l40.59"></a><span id="l40.59">   nsIFile * m_location;</span>
<a href="#l40.60"></a><span id="l40.60"> };</span>
<a href="#l40.61"></a><span id="l40.61"> </span>
<a href="#l40.62"></a><span id="l40.62"> NS_IMPL_THREADSAFE_ISUPPORTS1(OutlookSendListener, nsIMsgSendListener)</span>
<a href="#l40.63"></a><span id="l40.63"> </span>
<a href="#l40.64"></a><span id="l40.64" class="difflineminus">-nsresult OutlookSendListener::CreateSendListener( nsIMsgSendListener **ppListener)</span>
<a href="#l40.65"></a><span id="l40.65" class="difflineplus">+nsresult OutlookSendListener::CreateSendListener(nsIMsgSendListener **ppListener)</span>
<a href="#l40.66"></a><span id="l40.66"> {</span>
<a href="#l40.67"></a><span id="l40.67">   NS_PRECONDITION(ppListener != nsnull, &quot;null ptr&quot;);</span>
<a href="#l40.68"></a><span id="l40.68">   NS_ENSURE_ARG_POINTER(ppListener);</span>
<a href="#l40.69"></a><span id="l40.69"> </span>
<a href="#l40.70"></a><span id="l40.70">   *ppListener = new OutlookSendListener();</span>
<a href="#l40.71"></a><span id="l40.71">   if (! *ppListener)</span>
<a href="#l40.72"></a><span id="l40.72">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l40.73"></a><span id="l40.73"> </span>
<a href="#l40.74"></a><span id="l40.74" class="difflineat">@@ -235,17 +235,17 @@ nsOutlookCompose::~nsOutlookCompose()</span>
<a href="#l40.75"></a><span id="l40.75">     if (NS_FAILED(rv))</span>
<a href="#l40.76"></a><span id="l40.76">       return;</span>
<a href="#l40.77"></a><span id="l40.77">   }</span>
<a href="#l40.78"></a><span id="l40.78">   delete[] m_optimizationBuffer;</span>
<a href="#l40.79"></a><span id="l40.79"> }</span>
<a href="#l40.80"></a><span id="l40.80"> </span>
<a href="#l40.81"></a><span id="l40.81"> nsIMsgIdentity * nsOutlookCompose::m_pIdentity = nsnull;</span>
<a href="#l40.82"></a><span id="l40.82"> </span>
<a href="#l40.83"></a><span id="l40.83" class="difflineminus">-nsresult nsOutlookCompose::CreateIdentity( void)</span>
<a href="#l40.84"></a><span id="l40.84" class="difflineplus">+nsresult nsOutlookCompose::CreateIdentity(void)</span>
<a href="#l40.85"></a><span id="l40.85"> {</span>
<a href="#l40.86"></a><span id="l40.86">   if (m_pIdentity)</span>
<a href="#l40.87"></a><span id="l40.87">     return NS_OK;</span>
<a href="#l40.88"></a><span id="l40.88"> </span>
<a href="#l40.89"></a><span id="l40.89">   nsresult rv;</span>
<a href="#l40.90"></a><span id="l40.90">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr =</span>
<a href="#l40.91"></a><span id="l40.91">     do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l40.92"></a><span id="l40.92">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.93"></a><span id="l40.93" class="difflineat">@@ -260,44 +260,44 @@ nsresult nsOutlookCompose::CreateIdentit</span>
<a href="#l40.94"></a><span id="l40.94">   return rv;</span>
<a href="#l40.95"></a><span id="l40.95"> }</span>
<a href="#l40.96"></a><span id="l40.96"> </span>
<a href="#l40.97"></a><span id="l40.97"> void nsOutlookCompose::ReleaseIdentity()</span>
<a href="#l40.98"></a><span id="l40.98"> {</span>
<a href="#l40.99"></a><span id="l40.99">   NS_IF_RELEASE(m_pIdentity);</span>
<a href="#l40.100"></a><span id="l40.100"> }</span>
<a href="#l40.101"></a><span id="l40.101"> </span>
<a href="#l40.102"></a><span id="l40.102" class="difflineminus">-nsresult nsOutlookCompose::CreateComponents( void)</span>
<a href="#l40.103"></a><span id="l40.103" class="difflineplus">+nsresult nsOutlookCompose::CreateComponents(void)</span>
<a href="#l40.104"></a><span id="l40.104"> {</span>
<a href="#l40.105"></a><span id="l40.105">   nsresult rv = NS_OK;</span>
<a href="#l40.106"></a><span id="l40.106"> </span>
<a href="#l40.107"></a><span id="l40.107">   NS_IF_RELEASE(m_pMsgFields);</span>
<a href="#l40.108"></a><span id="l40.108" class="difflineminus">-  if (!m_pListener &amp;&amp; NS_SUCCEEDED( rv))</span>
<a href="#l40.109"></a><span id="l40.109" class="difflineminus">-    rv = OutlookSendListener::CreateSendListener( &amp;m_pListener);</span>
<a href="#l40.110"></a><span id="l40.110" class="difflineplus">+  if (!m_pListener &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l40.111"></a><span id="l40.111" class="difflineplus">+    rv = OutlookSendListener::CreateSendListener(&amp;m_pListener);</span>
<a href="#l40.112"></a><span id="l40.112"> </span>
<a href="#l40.113"></a><span id="l40.113">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l40.114"></a><span id="l40.114" class="difflineminus">-      rv = CallCreateInstance( kMsgCompFieldsCID, &amp;m_pMsgFields);</span>
<a href="#l40.115"></a><span id="l40.115" class="difflineplus">+      rv = CallCreateInstance(kMsgCompFieldsCID, &amp;m_pMsgFields);</span>
<a href="#l40.116"></a><span id="l40.116">     if (NS_SUCCEEDED(rv) &amp;&amp; m_pMsgFields) {</span>
<a href="#l40.117"></a><span id="l40.117" class="difflineminus">-      // IMPORT_LOG0( &quot;nsOutlookCompose - CreateComponents succeeded\n&quot;);</span>
<a href="#l40.118"></a><span id="l40.118" class="difflineminus">-      m_pMsgFields-&gt;SetForcePlainText( false);</span>
<a href="#l40.119"></a><span id="l40.119" class="difflineplus">+      // IMPORT_LOG0(&quot;nsOutlookCompose - CreateComponents succeeded\n&quot;);</span>
<a href="#l40.120"></a><span id="l40.120" class="difflineplus">+      m_pMsgFields-&gt;SetForcePlainText(false);</span>
<a href="#l40.121"></a><span id="l40.121">       return NS_OK;</span>
<a href="#l40.122"></a><span id="l40.122">     }</span>
<a href="#l40.123"></a><span id="l40.123">   }</span>
<a href="#l40.124"></a><span id="l40.124"> </span>
<a href="#l40.125"></a><span id="l40.125">   return NS_ERROR_FAILURE;</span>
<a href="#l40.126"></a><span id="l40.126"> }</span>
<a href="#l40.127"></a><span id="l40.127"> </span>
<a href="#l40.128"></a><span id="l40.128"> nsresult nsOutlookCompose::ComposeTheMessage(nsMsgDeliverMode mode, CMapiMessage &amp;msg, nsIFile **pMsg)</span>
<a href="#l40.129"></a><span id="l40.129"> {</span>
<a href="#l40.130"></a><span id="l40.130">   nsresult rv = CreateComponents();</span>
<a href="#l40.131"></a><span id="l40.131">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.132"></a><span id="l40.132">   rv = CreateIdentity();</span>
<a href="#l40.133"></a><span id="l40.133">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.134"></a><span id="l40.134"> </span>
<a href="#l40.135"></a><span id="l40.135" class="difflineminus">-  // IMPORT_LOG0( &quot;Outlook Compose created necessary components\n&quot;);</span>
<a href="#l40.136"></a><span id="l40.136" class="difflineplus">+  // IMPORT_LOG0(&quot;Outlook Compose created necessary components\n&quot;);</span>
<a href="#l40.137"></a><span id="l40.137"> </span>
<a href="#l40.138"></a><span id="l40.138">   CMapiMessageHeaders* headers = msg.GetHeaders();</span>
<a href="#l40.139"></a><span id="l40.139"> </span>
<a href="#l40.140"></a><span id="l40.140">   nsString unival;</span>
<a href="#l40.141"></a><span id="l40.141">   headers-&gt;UnfoldValue(CMapiMessageHeaders::hdrFrom, unival, msg.GetBodyCharset());</span>
<a href="#l40.142"></a><span id="l40.142">   m_pMsgFields-&gt;SetFrom(unival);</span>
<a href="#l40.143"></a><span id="l40.143">   headers-&gt;UnfoldValue(CMapiMessageHeaders::hdrTo, unival, msg.GetBodyCharset());</span>
<a href="#l40.144"></a><span id="l40.144">   m_pMsgFields-&gt;SetTo(unival);</span>
<a href="#l40.145"></a><span id="l40.145" class="difflineat">@@ -360,17 +360,17 @@ nsresult nsOutlookCompose::ComposeTheMes</span>
<a href="#l40.146"></a><span id="l40.146">                         bodyA.Length(),               // body length</span>
<a href="#l40.147"></a><span id="l40.147">                         mode == nsIMsgSend::nsMsgSaveAsDraft,</span>
<a href="#l40.148"></a><span id="l40.148">                         pAttach,                      // local attachments</span>
<a href="#l40.149"></a><span id="l40.149">                         embeddedObjects,</span>
<a href="#l40.150"></a><span id="l40.150">                         m_pListener);                 // listener</span>
<a href="#l40.151"></a><span id="l40.151"> </span>
<a href="#l40.152"></a><span id="l40.152">   OutlookSendListener *pListen = (OutlookSendListener *)m_pListener;</span>
<a href="#l40.153"></a><span id="l40.153">   if (NS_FAILED(rv)) {</span>
<a href="#l40.154"></a><span id="l40.154" class="difflineminus">-    IMPORT_LOG1( &quot;*** Error, CreateAndSendMessage FAILED: 0x%lx\n&quot;, rv);</span>
<a href="#l40.155"></a><span id="l40.155" class="difflineplus">+    IMPORT_LOG1(&quot;*** Error, CreateAndSendMessage FAILED: 0x%lx\n&quot;, rv);</span>
<a href="#l40.156"></a><span id="l40.156">   }</span>
<a href="#l40.157"></a><span id="l40.157">   else {</span>
<a href="#l40.158"></a><span id="l40.158">     // wait for the listener to get done!</span>
<a href="#l40.159"></a><span id="l40.159">     PRInt32 abortCnt = 0;</span>
<a href="#l40.160"></a><span id="l40.160">     PRInt32 cnt = 0;</span>
<a href="#l40.161"></a><span id="l40.161">     PRInt32 sleepCnt = 1;</span>
<a href="#l40.162"></a><span id="l40.162">     while (!pListen-&gt;m_done &amp;&amp; (abortCnt &lt; kHungAbortCount)) {</span>
<a href="#l40.163"></a><span id="l40.163">       PR_Sleep(sleepCnt);</span>
<a href="#l40.164"></a><span id="l40.164" class="difflineat">@@ -378,55 +378,53 @@ nsresult nsOutlookCompose::ComposeTheMes</span>
<a href="#l40.165"></a><span id="l40.165">       if (cnt &gt; kHungCount) {</span>
<a href="#l40.166"></a><span id="l40.166">         abortCnt++;</span>
<a href="#l40.167"></a><span id="l40.167">         sleepCnt *= 2;</span>
<a href="#l40.168"></a><span id="l40.168">         cnt = 0;</span>
<a href="#l40.169"></a><span id="l40.169">       }</span>
<a href="#l40.170"></a><span id="l40.170">     }</span>
<a href="#l40.171"></a><span id="l40.171"> </span>
<a href="#l40.172"></a><span id="l40.172">     if (abortCnt &gt;= kHungAbortCount) {</span>
<a href="#l40.173"></a><span id="l40.173" class="difflineminus">-      IMPORT_LOG0( &quot;**** Create and send message hung\n&quot;);</span>
<a href="#l40.174"></a><span id="l40.174" class="difflineminus">-//      IMPORT_LOG1( &quot;Headers: %s\n&quot;, m_Headers.get());</span>
<a href="#l40.175"></a><span id="l40.175" class="difflineminus">-//      IMPORT_LOG1( &quot;Body: %s\n&quot;, m_Body.get());</span>
<a href="#l40.176"></a><span id="l40.176" class="difflineplus">+      IMPORT_LOG0(&quot;**** Create and send message hung\n&quot;);</span>
<a href="#l40.177"></a><span id="l40.177">       rv = NS_ERROR_FAILURE;</span>
<a href="#l40.178"></a><span id="l40.178">     }</span>
<a href="#l40.179"></a><span id="l40.179">   }</span>
<a href="#l40.180"></a><span id="l40.180"> </span>
<a href="#l40.181"></a><span id="l40.181">   if (pListen-&gt;m_location) {</span>
<a href="#l40.182"></a><span id="l40.182">     pListen-&gt;m_location-&gt;Clone(pMsg);</span>
<a href="#l40.183"></a><span id="l40.183">     rv = NS_OK;</span>
<a href="#l40.184"></a><span id="l40.184">   }</span>
<a href="#l40.185"></a><span id="l40.185">   else {</span>
<a href="#l40.186"></a><span id="l40.186">     rv = NS_ERROR_FAILURE;</span>
<a href="#l40.187"></a><span id="l40.187" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error, Outlook compose unsuccessful\n&quot;);</span>
<a href="#l40.188"></a><span id="l40.188" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error, Outlook compose unsuccessful\n&quot;);</span>
<a href="#l40.189"></a><span id="l40.189">   }</span>
<a href="#l40.190"></a><span id="l40.190"> </span>
<a href="#l40.191"></a><span id="l40.191">   pListen-&gt;Reset();</span>
<a href="#l40.192"></a><span id="l40.192">   return rv;</span>
<a href="#l40.193"></a><span id="l40.193"> }</span>
<a href="#l40.194"></a><span id="l40.194"> </span>
<a href="#l40.195"></a><span id="l40.195"> nsresult nsOutlookCompose::CopyComposedMessage(nsIFile *pSrc,</span>
<a href="#l40.196"></a><span id="l40.196">                                                nsIOutputStream *pDst,</span>
<a href="#l40.197"></a><span id="l40.197">                                                CMapiMessage&amp; origMsg)</span>
<a href="#l40.198"></a><span id="l40.198"> {</span>
<a href="#l40.199"></a><span id="l40.199">   // I'm unsure if we really need the convertCRs feature here.</span>
<a href="#l40.200"></a><span id="l40.200">   // The headers in the file are generated by TB, the body was generated by rtf reader that always used CRLF,</span>
<a href="#l40.201"></a><span id="l40.201">   // and the attachments were processed by TB either... However, I let it stay as it was in the original code.</span>
<a href="#l40.202"></a><span id="l40.202">   CCompositionFile f(pSrc, m_optimizationBuffer, m_optimizationBufferSize, true);</span>
<a href="#l40.203"></a><span id="l40.203">   if (!f) {</span>
<a href="#l40.204"></a><span id="l40.204" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error, unexpected zero file size for composed message\n&quot;);</span>
<a href="#l40.205"></a><span id="l40.205" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error, unexpected zero file size for composed message\n&quot;);</span>
<a href="#l40.206"></a><span id="l40.206">     return NS_ERROR_FAILURE;</span>
<a href="#l40.207"></a><span id="l40.207">   }</span>
<a href="#l40.208"></a><span id="l40.208"> </span>
<a href="#l40.209"></a><span id="l40.209">   // The &quot;From ...&quot; separates the messages. Without it, TB cannot see the messages in the mailbox file.</span>
<a href="#l40.210"></a><span id="l40.210">   // Thus, the lines that look like &quot;From ...&quot; in the message must be escaped (see EscapeFromSpaceLine())</span>
<a href="#l40.211"></a><span id="l40.211">   int fromLineLen;</span>
<a href="#l40.212"></a><span id="l40.212">   const char* fromLine = origMsg.GetFromLine(fromLineLen);</span>
<a href="#l40.213"></a><span id="l40.213">   PRUint32 written;</span>
<a href="#l40.214"></a><span id="l40.214" class="difflineminus">-  nsresult rv = pDst-&gt;Write( fromLine, fromLineLen, &amp;written);</span>
<a href="#l40.215"></a><span id="l40.215" class="difflineplus">+  nsresult rv = pDst-&gt;Write(fromLine, fromLineLen, &amp;written);</span>
<a href="#l40.216"></a><span id="l40.216"> </span>
<a href="#l40.217"></a><span id="l40.217">   // Bug 219269</span>
<a href="#l40.218"></a><span id="l40.218">   // Write out the x-mozilla-status headers.</span>
<a href="#l40.219"></a><span id="l40.219">   char statusLine[50];</span>
<a href="#l40.220"></a><span id="l40.220">   PRUint32 msgFlags = 0;</span>
<a href="#l40.221"></a><span id="l40.221">   if (origMsg.IsRead())</span>
<a href="#l40.222"></a><span id="l40.222">     msgFlags |= nsMsgMessageFlags::Read;</span>
<a href="#l40.223"></a><span id="l40.223">   if (!origMsg.FullMessageDownloaded())</span>
<a href="#l40.224"></a><span id="l40.224" class="difflineat">@@ -475,35 +473,35 @@ nsresult nsOutlookCompose::CopyComposedM</span>
<a href="#l40.225"></a><span id="l40.225">   // was composed in nsMsgSend::ProcessMultipartRelated() - the Content-Ids of</span>
<a href="#l40.226"></a><span id="l40.226">   // attachments were replaced with new ones.</span>
<a href="#l40.227"></a><span id="l40.227">   nsCString line;</span>
<a href="#l40.228"></a><span id="l40.228">   while (NS_SUCCEEDED(f.ToString(line, MSG_LINEBREAK))) {</span>
<a href="#l40.229"></a><span id="l40.229">     EscapeFromSpaceLine(pDst, const_cast&lt;char*&gt;(line.get()), line.get()+line.Length());</span>
<a href="#l40.230"></a><span id="l40.230">   }</span>
<a href="#l40.231"></a><span id="l40.231"> </span>
<a href="#l40.232"></a><span id="l40.232">   if (f.LastChar() != nsCRT::LF) {</span>
<a href="#l40.233"></a><span id="l40.233" class="difflineminus">-    rv = pDst-&gt;Write( MSG_LINEBREAK, 2, &amp;written);</span>
<a href="#l40.234"></a><span id="l40.234" class="difflineplus">+    rv = pDst-&gt;Write(MSG_LINEBREAK, 2, &amp;written);</span>
<a href="#l40.235"></a><span id="l40.235">     if (written != 2)</span>
<a href="#l40.236"></a><span id="l40.236">       rv = NS_ERROR_FAILURE;</span>
<a href="#l40.237"></a><span id="l40.237">   }</span>
<a href="#l40.238"></a><span id="l40.238"> </span>
<a href="#l40.239"></a><span id="l40.239">   return rv;</span>
<a href="#l40.240"></a><span id="l40.240"> }</span>
<a href="#l40.241"></a><span id="l40.241"> </span>
<a href="#l40.242"></a><span id="l40.242"> nsresult nsOutlookCompose::ProcessMessage(nsMsgDeliverMode mode,</span>
<a href="#l40.243"></a><span id="l40.243">                                           CMapiMessage &amp;msg,</span>
<a href="#l40.244"></a><span id="l40.244">                                           nsIOutputStream *pDst)</span>
<a href="#l40.245"></a><span id="l40.245"> {</span>
<a href="#l40.246"></a><span id="l40.246">   nsCOMPtr&lt;nsIFile&gt; compositionFile;</span>
<a href="#l40.247"></a><span id="l40.247">   nsresult rv = ComposeTheMessage(mode, msg, getter_AddRefs(compositionFile));</span>
<a href="#l40.248"></a><span id="l40.248">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.249"></a><span id="l40.249">   rv = CopyComposedMessage(compositionFile, pDst, msg);</span>
<a href="#l40.250"></a><span id="l40.250">   compositionFile-&gt;Remove(false);</span>
<a href="#l40.251"></a><span id="l40.251" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l40.252"></a><span id="l40.252" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error copying composed message to destination mailbox\n&quot;);</span>
<a href="#l40.253"></a><span id="l40.253" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l40.254"></a><span id="l40.254" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error copying composed message to destination mailbox\n&quot;);</span>
<a href="#l40.255"></a><span id="l40.255">   }</span>
<a href="#l40.256"></a><span id="l40.256">   return rv;</span>
<a href="#l40.257"></a><span id="l40.257"> }</span>
<a href="#l40.258"></a><span id="l40.258"> </span>
<a href="#l40.259"></a><span id="l40.259"> void nsOutlookCompose::UpdateHeader(CMapiMessageHeaders&amp; oldHeaders,</span>
<a href="#l40.260"></a><span id="l40.260">                                     const CMapiMessageHeaders&amp; newHeaders,</span>
<a href="#l40.261"></a><span id="l40.261">                                     CMapiMessageHeaders::SpecialHeader header,</span>
<a href="#l40.262"></a><span id="l40.262">                                     bool addIfAbsent)</span>
<a href="#l40.263"></a><span id="l40.263" class="difflineat">@@ -678,43 +676,43 @@ CCompositionFile::CCompositionFile(nsIFi</span>
<a href="#l40.264"></a><span id="l40.264">     m_fifoBufferSize(fifoBufferSize),</span>
<a href="#l40.265"></a><span id="l40.265">     m_fifoBufferReadPos(static_cast&lt;char*&gt;(fifoBuffer)),</span>
<a href="#l40.266"></a><span id="l40.266">     m_fifoBufferWrittenPos(static_cast&lt;char*&gt;(fifoBuffer)),</span>
<a href="#l40.267"></a><span id="l40.267">     m_convertCRs(convertCRs),</span>
<a href="#l40.268"></a><span id="l40.268">     m_lastChar(0)</span>
<a href="#l40.269"></a><span id="l40.269"> {</span>
<a href="#l40.270"></a><span id="l40.270">   m_pFile-&gt;GetFileSize(&amp;m_fileSize);</span>
<a href="#l40.271"></a><span id="l40.271">   if (!m_fileSize) {</span>
<a href="#l40.272"></a><span id="l40.272" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error, unexpected zero file size for composed message\n&quot;);</span>
<a href="#l40.273"></a><span id="l40.273" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error, unexpected zero file size for composed message\n&quot;);</span>
<a href="#l40.274"></a><span id="l40.274">     return;</span>
<a href="#l40.275"></a><span id="l40.275">   }</span>
<a href="#l40.276"></a><span id="l40.276"> </span>
<a href="#l40.277"></a><span id="l40.277">   nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(m_pInputStream), m_pFile);</span>
<a href="#l40.278"></a><span id="l40.278">   if (NS_FAILED(rv)) {</span>
<a href="#l40.279"></a><span id="l40.279" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error, unable to open composed message file\n&quot;);</span>
<a href="#l40.280"></a><span id="l40.280" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error, unable to open composed message file\n&quot;);</span>
<a href="#l40.281"></a><span id="l40.281">     return;</span>
<a href="#l40.282"></a><span id="l40.282">   }</span>
<a href="#l40.283"></a><span id="l40.283"> }</span>
<a href="#l40.284"></a><span id="l40.284"> </span>
<a href="#l40.285"></a><span id="l40.285"> nsresult CCompositionFile::EnsureHasDataInBuffer()</span>
<a href="#l40.286"></a><span id="l40.286"> {</span>
<a href="#l40.287"></a><span id="l40.287">   if (m_fifoBufferReadPos &lt; m_fifoBufferWrittenPos)</span>
<a href="#l40.288"></a><span id="l40.288">     return NS_OK;</span>
<a href="#l40.289"></a><span id="l40.289">   // Populate the buffer with new data!</span>
<a href="#l40.290"></a><span id="l40.290">   PRUint32 count = m_fifoBufferSize;</span>
<a href="#l40.291"></a><span id="l40.291">   if ((m_fileReadPos + count) &gt; m_fileSize)</span>
<a href="#l40.292"></a><span id="l40.292">     count = m_fileSize - m_fileReadPos;</span>
<a href="#l40.293"></a><span id="l40.293">   if (!count)</span>
<a href="#l40.294"></a><span id="l40.294">     return NS_ERROR_FAILURE; // Isn't there a &quot;No more data&quot; error?</span>
<a href="#l40.295"></a><span id="l40.295"> </span>
<a href="#l40.296"></a><span id="l40.296">   PRUint32 bytesRead = 0;</span>
<a href="#l40.297"></a><span id="l40.297" class="difflineminus">-  nsresult rv = m_pInputStream-&gt;Read( m_fifoBuffer, count, &amp;bytesRead);</span>
<a href="#l40.298"></a><span id="l40.298" class="difflineplus">+  nsresult rv = m_pInputStream-&gt;Read(m_fifoBuffer, count, &amp;bytesRead);</span>
<a href="#l40.299"></a><span id="l40.299">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.300"></a><span id="l40.300">   if (!bytesRead || (bytesRead &gt; count))</span>
<a href="#l40.301"></a><span id="l40.301" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l40.302"></a><span id="l40.302" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l40.303"></a><span id="l40.303">   m_fifoBufferWrittenPos = m_fifoBuffer+bytesRead;</span>
<a href="#l40.304"></a><span id="l40.304">   m_fifoBufferReadPos = m_fifoBuffer;</span>
<a href="#l40.305"></a><span id="l40.305">   m_fileReadPos += bytesRead;</span>
<a href="#l40.306"></a><span id="l40.306"> </span>
<a href="#l40.307"></a><span id="l40.307">   return NS_OK;</span>
<a href="#l40.308"></a><span id="l40.308"> }</span>
<a href="#l40.309"></a><span id="l40.309"> </span>
<a href="#l40.310"></a><span id="l40.310"> class CTermGuard {</span>
<a href="#l40.311"></a><span id="l40.311" class="difflineat">@@ -735,17 +733,17 @@ public:</span>
<a href="#l40.312"></a><span id="l40.312">   {</span>
<a href="#l40.313"></a><span id="l40.313">     if (!m_termSize) // no guard</span>
<a href="#l40.314"></a><span id="l40.314">       return false;</span>
<a href="#l40.315"></a><span id="l40.315">     if (m_matchPos &gt;= m_termSize) // check past success!</span>
<a href="#l40.316"></a><span id="l40.316">       m_matchPos = 0;</span>
<a href="#l40.317"></a><span id="l40.317">     if (m_term[m_matchPos] != c) // Reset sequence</span>
<a href="#l40.318"></a><span id="l40.318">       m_matchPos = 0;</span>
<a href="#l40.319"></a><span id="l40.319">     if (m_term[m_matchPos] == c) { // Sequence continues</span>
<a href="#l40.320"></a><span id="l40.320" class="difflineminus">-      return (++m_matchPos == m_termSize); // If equal then sequence complete!</span>
<a href="#l40.321"></a><span id="l40.321" class="difflineplus">+      return ++m_matchPos == m_termSize; // If equal then sequence complete!</span>
<a href="#l40.322"></a><span id="l40.322">     }</span>
<a href="#l40.323"></a><span id="l40.323">     // Sequence broken</span>
<a href="#l40.324"></a><span id="l40.324">     return false;</span>
<a href="#l40.325"></a><span id="l40.325">   }</span>
<a href="#l40.326"></a><span id="l40.326"> private:</span>
<a href="#l40.327"></a><span id="l40.327">   const char* m_term;</span>
<a href="#l40.328"></a><span id="l40.328">   int m_termSize;</span>
<a href="#l40.329"></a><span id="l40.329">   int m_matchPos;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookCompose.h</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookCompose.h</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -64,23 +64,23 @@ class nsOutlookCompose {</span>
<a href="#l41.4"></a><span id="l41.4"> public:</span>
<a href="#l41.5"></a><span id="l41.5">   nsOutlookCompose();</span>
<a href="#l41.6"></a><span id="l41.6">   ~nsOutlookCompose();</span>
<a href="#l41.7"></a><span id="l41.7"> </span>
<a href="#l41.8"></a><span id="l41.8">   nsresult ProcessMessage(nsMsgDeliverMode mode, CMapiMessage &amp;msg, nsIOutputStream *pDst);</span>
<a href="#l41.9"></a><span id="l41.9">   static nsresult CreateIdentity(void);</span>
<a href="#l41.10"></a><span id="l41.10">   static void ReleaseIdentity(void);</span>
<a href="#l41.11"></a><span id="l41.11"> private:</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-  nsresult  CreateComponents( void);</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+  nsresult  CreateComponents(void);</span>
<a href="#l41.14"></a><span id="l41.14"> </span>
<a href="#l41.15"></a><span id="l41.15">   void      UpdateHeader(CMapiMessageHeaders&amp; oldHeaders, const CMapiMessageHeaders&amp; newHeaders, CMapiMessageHeaders::SpecialHeader header, bool addIfAbsent = true);</span>
<a href="#l41.16"></a><span id="l41.16">   void      UpdateHeaders(CMapiMessageHeaders&amp; oldHeaders, const CMapiMessageHeaders&amp; newHeaders);</span>
<a href="#l41.17"></a><span id="l41.17"> </span>
<a href="#l41.18"></a><span id="l41.18">   nsresult  ComposeTheMessage(nsMsgDeliverMode mode, CMapiMessage &amp;msg, nsIFile **pMsg);</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineminus">-  nsresult  CopyComposedMessage( nsIFile *pSrc, nsIOutputStream *pDst, CMapiMessage&amp; origMsg);</span>
<a href="#l41.20"></a><span id="l41.20" class="difflineplus">+  nsresult  CopyComposedMessage(nsIFile *pSrc, nsIOutputStream *pDst, CMapiMessage&amp; origMsg);</span>
<a href="#l41.21"></a><span id="l41.21"> </span>
<a href="#l41.22"></a><span id="l41.22">   // Bug 593907</span>
<a href="#l41.23"></a><span id="l41.23">   void HackBody(const wchar_t* orig, size_t origLen, nsString&amp; hack);</span>
<a href="#l41.24"></a><span id="l41.24">   void UnhackBody(nsCString&amp; body);</span>
<a href="#l41.25"></a><span id="l41.25">   bool GenerateHackSequence(const wchar_t* body, size_t origLen);</span>
<a href="#l41.26"></a><span id="l41.26">   // End Bug 593907</span>
<a href="#l41.27"></a><span id="l41.27"> </span>
<a href="#l41.28"></a><span id="l41.28"> private:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookImport.cpp</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookImport.cpp</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -101,20 +101,20 @@ public:</span>
<a href="#l42.4"></a><span id="l42.4">                 PRUnichar **pErrorLog, PRUnichar **pSuccessLog, bool *fatalError);</span>
<a href="#l42.5"></a><span id="l42.5"> </span>
<a href="#l42.6"></a><span id="l42.6">   /* unsigned long GetImportProgress (); */</span>
<a href="#l42.7"></a><span id="l42.7">   NS_IMETHOD GetImportProgress(PRUint32 *_retval);</span>
<a href="#l42.8"></a><span id="l42.8"> </span>
<a href="#l42.9"></a><span id="l42.9">   NS_IMETHOD TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval);</span>
<a href="#l42.10"></a><span id="l42.10"> </span>
<a href="#l42.11"></a><span id="l42.11"> public:</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-  static void  ReportSuccess( nsString&amp; name, PRInt32 count, nsString *pStream);</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineminus">-  static void ReportError( PRInt32 errorNum, nsString&amp; name, nsString *pStream);</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineminus">-  static void  AddLinebreak( nsString *pStream);</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineminus">-  static void  SetLogs( nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess);</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineplus">+  static void  ReportSuccess(nsString&amp; name, PRInt32 count, nsString *pStream);</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineplus">+  static void ReportError(PRInt32 errorNum, nsString&amp; name, nsString *pStream);</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineplus">+  static void  AddLinebreak(nsString *pStream);</span>
<a href="#l42.19"></a><span id="l42.19" class="difflineplus">+  static void  SetLogs(nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess);</span>
<a href="#l42.20"></a><span id="l42.20"> </span>
<a href="#l42.21"></a><span id="l42.21"> private:</span>
<a href="#l42.22"></a><span id="l42.22">   nsOutlookMail  m_mail;</span>
<a href="#l42.23"></a><span id="l42.23">   PRUint32    m_bytesDone;</span>
<a href="#l42.24"></a><span id="l42.24"> };</span>
<a href="#l42.25"></a><span id="l42.25"> </span>
<a href="#l42.26"></a><span id="l42.26"> </span>
<a href="#l42.27"></a><span id="l42.27"> class ImportOutlookAddressImpl : public nsIImportAddressBooks</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineat">@@ -125,47 +125,47 @@ public:</span>
<a href="#l42.29"></a><span id="l42.29"> </span>
<a href="#l42.30"></a><span id="l42.30">   static nsresult Create(nsIImportAddressBooks** aImport);</span>
<a href="#l42.31"></a><span id="l42.31"> </span>
<a href="#l42.32"></a><span id="l42.32">   // nsISupports interface</span>
<a href="#l42.33"></a><span id="l42.33">   NS_DECL_ISUPPORTS</span>
<a href="#l42.34"></a><span id="l42.34"> </span>
<a href="#l42.35"></a><span id="l42.35">   // nsIImportAddressBooks interface</span>
<a href="#l42.36"></a><span id="l42.36"> </span>
<a href="#l42.37"></a><span id="l42.37" class="difflineminus">-  NS_IMETHOD GetSupportsMultiple(bool *_retval) { *_retval = true; return( NS_OK);}</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineplus">+  NS_IMETHOD GetSupportsMultiple(bool *_retval) { *_retval = true; return NS_OK;}</span>
<a href="#l42.39"></a><span id="l42.39"> </span>
<a href="#l42.40"></a><span id="l42.40">   NS_IMETHOD GetAutoFind(PRUnichar **description, bool *_retval);</span>
<a href="#l42.41"></a><span id="l42.41"> </span>
<a href="#l42.42"></a><span id="l42.42" class="difflineminus">-  NS_IMETHOD GetNeedsFieldMap(nsIFile *location, bool *_retval) { *_retval = false; return( NS_OK);}</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineplus">+  NS_IMETHOD GetNeedsFieldMap(nsIFile *location, bool *_retval) { *_retval = false; return NS_OK;}</span>
<a href="#l42.44"></a><span id="l42.44"> </span>
<a href="#l42.45"></a><span id="l42.45">   NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found, bool *userVerify)</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineminus">-    { return( NS_ERROR_FAILURE);}</span>
<a href="#l42.47"></a><span id="l42.47" class="difflineplus">+    { return NS_ERROR_FAILURE;}</span>
<a href="#l42.48"></a><span id="l42.48"> </span>
<a href="#l42.49"></a><span id="l42.49">   NS_IMETHOD FindAddressBooks(nsIFile *location, nsISupportsArray **_retval);</span>
<a href="#l42.50"></a><span id="l42.50"> </span>
<a href="#l42.51"></a><span id="l42.51">   NS_IMETHOD InitFieldMap(nsIImportFieldMap *fieldMap)</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineminus">-    { return( NS_ERROR_FAILURE); }</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineplus">+    { return NS_ERROR_FAILURE; }</span>
<a href="#l42.54"></a><span id="l42.54"> </span>
<a href="#l42.55"></a><span id="l42.55">   NS_IMETHOD ImportAddressBook(nsIImportABDescriptor *source,</span>
<a href="#l42.56"></a><span id="l42.56">                                nsIAddrDatabase *destination,</span>
<a href="#l42.57"></a><span id="l42.57">                                nsIImportFieldMap *fieldMap,</span>
<a href="#l42.58"></a><span id="l42.58">                                nsISupports *aSupportService,</span>
<a href="#l42.59"></a><span id="l42.59">                                PRUnichar **errorLog,</span>
<a href="#l42.60"></a><span id="l42.60">                                PRUnichar **successLog,</span>
<a href="#l42.61"></a><span id="l42.61">                                bool *fatalError);</span>
<a href="#l42.62"></a><span id="l42.62"> </span>
<a href="#l42.63"></a><span id="l42.63">   NS_IMETHOD GetImportProgress(PRUint32 *_retval);</span>
<a href="#l42.64"></a><span id="l42.64"> </span>
<a href="#l42.65"></a><span id="l42.65" class="difflineminus">-  NS_IMETHOD GetSampleData( PRInt32 index, bool *pFound, PRUnichar **pStr)</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineminus">-    { return( NS_ERROR_FAILURE);}</span>
<a href="#l42.67"></a><span id="l42.67" class="difflineplus">+  NS_IMETHOD GetSampleData(PRInt32 index, bool *pFound, PRUnichar **pStr)</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineplus">+    { return NS_ERROR_FAILURE;}</span>
<a href="#l42.69"></a><span id="l42.69"> </span>
<a href="#l42.70"></a><span id="l42.70" class="difflineminus">-  NS_IMETHOD SetSampleLocation( nsIFile *) { return( NS_OK); }</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineplus">+  NS_IMETHOD SetSampleLocation(nsIFile *) { return NS_OK; }</span>
<a href="#l42.72"></a><span id="l42.72"> </span>
<a href="#l42.73"></a><span id="l42.73"> private:</span>
<a href="#l42.74"></a><span id="l42.74" class="difflineminus">-  void  ReportSuccess( nsString&amp; name, nsString *pStream);</span>
<a href="#l42.75"></a><span id="l42.75" class="difflineplus">+  void  ReportSuccess(nsString&amp; name, nsString *pStream);</span>
<a href="#l42.76"></a><span id="l42.76"> </span>
<a href="#l42.77"></a><span id="l42.77"> private:</span>
<a href="#l42.78"></a><span id="l42.78">   PRUint32    m_msgCount;</span>
<a href="#l42.79"></a><span id="l42.79">   PRUint32    m_msgTotal;</span>
<a href="#l42.80"></a><span id="l42.80">   nsOutlookMail  m_address;</span>
<a href="#l42.81"></a><span id="l42.81"> };</span>
<a href="#l42.82"></a><span id="l42.82"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l42.83"></a><span id="l42.83"> </span>
<a href="#l42.84"></a><span id="l42.84" class="difflineat">@@ -174,138 +174,138 @@ private:</span>
<a href="#l42.85"></a><span id="l42.85"> </span>
<a href="#l42.86"></a><span id="l42.86"> </span>
<a href="#l42.87"></a><span id="l42.87"> nsOutlookImport::nsOutlookImport()</span>
<a href="#l42.88"></a><span id="l42.88"> {</span>
<a href="#l42.89"></a><span id="l42.89">   // Init logging module.</span>
<a href="#l42.90"></a><span id="l42.90">   if (!OUTLOOKLOGMODULE)</span>
<a href="#l42.91"></a><span id="l42.91">     OUTLOOKLOGMODULE = PR_NewLogModule(&quot;IMPORT&quot;);</span>
<a href="#l42.92"></a><span id="l42.92"> </span>
<a href="#l42.93"></a><span id="l42.93" class="difflineminus">-  IMPORT_LOG0( &quot;nsOutlookImport Module Created\n&quot;);</span>
<a href="#l42.94"></a><span id="l42.94" class="difflineplus">+  IMPORT_LOG0(&quot;nsOutlookImport Module Created\n&quot;);</span>
<a href="#l42.95"></a><span id="l42.95"> </span>
<a href="#l42.96"></a><span id="l42.96">   nsOutlookStringBundle::GetStringBundle();</span>
<a href="#l42.97"></a><span id="l42.97"> }</span>
<a href="#l42.98"></a><span id="l42.98"> </span>
<a href="#l42.99"></a><span id="l42.99"> </span>
<a href="#l42.100"></a><span id="l42.100"> nsOutlookImport::~nsOutlookImport()</span>
<a href="#l42.101"></a><span id="l42.101"> {</span>
<a href="#l42.102"></a><span id="l42.102" class="difflineminus">-  IMPORT_LOG0( &quot;nsOutlookImport Module Deleted\n&quot;);</span>
<a href="#l42.103"></a><span id="l42.103" class="difflineplus">+  IMPORT_LOG0(&quot;nsOutlookImport Module Deleted\n&quot;);</span>
<a href="#l42.104"></a><span id="l42.104"> }</span>
<a href="#l42.105"></a><span id="l42.105"> </span>
<a href="#l42.106"></a><span id="l42.106"> NS_IMPL_ISUPPORTS1(nsOutlookImport, nsIImportModule)</span>
<a href="#l42.107"></a><span id="l42.107"> </span>
<a href="#l42.108"></a><span id="l42.108" class="difflineminus">-NS_IMETHODIMP nsOutlookImport::GetName( PRUnichar **name)</span>
<a href="#l42.109"></a><span id="l42.109" class="difflineplus">+NS_IMETHODIMP nsOutlookImport::GetName(PRUnichar **name)</span>
<a href="#l42.110"></a><span id="l42.110"> {</span>
<a href="#l42.111"></a><span id="l42.111">   NS_PRECONDITION(name != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.112"></a><span id="l42.112">   if (! name)</span>
<a href="#l42.113"></a><span id="l42.113">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l42.114"></a><span id="l42.114"> </span>
<a href="#l42.115"></a><span id="l42.115" class="difflineminus">-  *name = nsOutlookStringBundle::GetStringByID( OUTLOOKIMPORT_NAME);</span>
<a href="#l42.116"></a><span id="l42.116" class="difflineplus">+  *name = nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_NAME);</span>
<a href="#l42.117"></a><span id="l42.117">   return NS_OK;</span>
<a href="#l42.118"></a><span id="l42.118"> }</span>
<a href="#l42.119"></a><span id="l42.119"> </span>
<a href="#l42.120"></a><span id="l42.120" class="difflineminus">-NS_IMETHODIMP nsOutlookImport::GetDescription( PRUnichar **name)</span>
<a href="#l42.121"></a><span id="l42.121" class="difflineplus">+NS_IMETHODIMP nsOutlookImport::GetDescription(PRUnichar **name)</span>
<a href="#l42.122"></a><span id="l42.122"> {</span>
<a href="#l42.123"></a><span id="l42.123" class="difflineminus">-    NS_PRECONDITION(name != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.124"></a><span id="l42.124" class="difflineminus">-    if (! name)</span>
<a href="#l42.125"></a><span id="l42.125" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l42.126"></a><span id="l42.126" class="difflineplus">+  NS_PRECONDITION(name != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.127"></a><span id="l42.127" class="difflineplus">+  if (!name)</span>
<a href="#l42.128"></a><span id="l42.128" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l42.129"></a><span id="l42.129"> </span>
<a href="#l42.130"></a><span id="l42.130" class="difflineminus">-  *name = nsOutlookStringBundle::GetStringByID( OUTLOOKIMPORT_DESCRIPTION);</span>
<a href="#l42.131"></a><span id="l42.131" class="difflineplus">+  *name = nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_DESCRIPTION);</span>
<a href="#l42.132"></a><span id="l42.132"> </span>
<a href="#l42.133"></a><span id="l42.133" class="difflineminus">-    return NS_OK;</span>
<a href="#l42.134"></a><span id="l42.134" class="difflineplus">+  return NS_OK;</span>
<a href="#l42.135"></a><span id="l42.135"> }</span>
<a href="#l42.136"></a><span id="l42.136"> </span>
<a href="#l42.137"></a><span id="l42.137" class="difflineminus">-NS_IMETHODIMP nsOutlookImport::GetSupports( char **supports)</span>
<a href="#l42.138"></a><span id="l42.138" class="difflineplus">+NS_IMETHODIMP nsOutlookImport::GetSupports(char **supports)</span>
<a href="#l42.139"></a><span id="l42.139"> {</span>
<a href="#l42.140"></a><span id="l42.140">   NS_PRECONDITION(supports != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.141"></a><span id="l42.141">   if (! supports)</span>
<a href="#l42.142"></a><span id="l42.142">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l42.143"></a><span id="l42.143"> </span>
<a href="#l42.144"></a><span id="l42.144" class="difflineminus">-  *supports = strdup( kOutlookSupportsString);</span>
<a href="#l42.145"></a><span id="l42.145" class="difflineminus">-  return( NS_OK);</span>
<a href="#l42.146"></a><span id="l42.146" class="difflineplus">+  *supports = strdup(kOutlookSupportsString);</span>
<a href="#l42.147"></a><span id="l42.147" class="difflineplus">+  return NS_OK;</span>
<a href="#l42.148"></a><span id="l42.148"> }</span>
<a href="#l42.149"></a><span id="l42.149"> </span>
<a href="#l42.150"></a><span id="l42.150" class="difflineminus">-NS_IMETHODIMP nsOutlookImport::GetSupportsUpgrade( bool *pUpgrade)</span>
<a href="#l42.151"></a><span id="l42.151" class="difflineplus">+NS_IMETHODIMP nsOutlookImport::GetSupportsUpgrade(bool *pUpgrade)</span>
<a href="#l42.152"></a><span id="l42.152"> {</span>
<a href="#l42.153"></a><span id="l42.153">   NS_PRECONDITION(pUpgrade != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.154"></a><span id="l42.154">   if (! pUpgrade)</span>
<a href="#l42.155"></a><span id="l42.155">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l42.156"></a><span id="l42.156"> </span>
<a href="#l42.157"></a><span id="l42.157">   *pUpgrade = true;</span>
<a href="#l42.158"></a><span id="l42.158" class="difflineminus">-  return( NS_OK);</span>
<a href="#l42.159"></a><span id="l42.159" class="difflineplus">+  return NS_OK;</span>
<a href="#l42.160"></a><span id="l42.160"> }</span>
<a href="#l42.161"></a><span id="l42.161"> </span>
<a href="#l42.162"></a><span id="l42.162" class="difflineminus">-NS_IMETHODIMP nsOutlookImport::GetImportInterface( const char *pImportType, nsISupports **ppInterface)</span>
<a href="#l42.163"></a><span id="l42.163" class="difflineplus">+NS_IMETHODIMP nsOutlookImport::GetImportInterface(const char *pImportType, nsISupports **ppInterface)</span>
<a href="#l42.164"></a><span id="l42.164"> {</span>
<a href="#l42.165"></a><span id="l42.165">   NS_PRECONDITION(pImportType != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.166"></a><span id="l42.166">   if (! pImportType)</span>
<a href="#l42.167"></a><span id="l42.167">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l42.168"></a><span id="l42.168">   NS_PRECONDITION(ppInterface != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.169"></a><span id="l42.169">   if (! ppInterface)</span>
<a href="#l42.170"></a><span id="l42.170">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l42.171"></a><span id="l42.171"> </span>
<a href="#l42.172"></a><span id="l42.172">   *ppInterface = nsnull;</span>
<a href="#l42.173"></a><span id="l42.173">   nsresult  rv;</span>
<a href="#l42.174"></a><span id="l42.174" class="difflineminus">-  if (!strcmp( pImportType, &quot;mail&quot;)) {</span>
<a href="#l42.175"></a><span id="l42.175" class="difflineplus">+  if (!strcmp(pImportType, &quot;mail&quot;)) {</span>
<a href="#l42.176"></a><span id="l42.176">     // create the nsIImportMail interface and return it!</span>
<a href="#l42.177"></a><span id="l42.177">     nsIImportMail *  pMail = nsnull;</span>
<a href="#l42.178"></a><span id="l42.178">     nsIImportGeneric *pGeneric = nsnull;</span>
<a href="#l42.179"></a><span id="l42.179" class="difflineminus">-    rv = ImportOutlookMailImpl::Create( &amp;pMail);</span>
<a href="#l42.180"></a><span id="l42.180" class="difflineminus">-    if (NS_SUCCEEDED( rv)) {</span>
<a href="#l42.181"></a><span id="l42.181" class="difflineplus">+    rv = ImportOutlookMailImpl::Create(&amp;pMail);</span>
<a href="#l42.182"></a><span id="l42.182" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l42.183"></a><span id="l42.183">       nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l42.184"></a><span id="l42.184" class="difflineminus">-      if (NS_SUCCEEDED( rv)) {</span>
<a href="#l42.185"></a><span id="l42.185" class="difflineminus">-        rv = impSvc-&gt;CreateNewGenericMail( &amp;pGeneric);</span>
<a href="#l42.186"></a><span id="l42.186" class="difflineminus">-        if (NS_SUCCEEDED( rv)) {</span>
<a href="#l42.187"></a><span id="l42.187" class="difflineminus">-          pGeneric-&gt;SetData( &quot;mailInterface&quot;, pMail);</span>
<a href="#l42.188"></a><span id="l42.188" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l42.189"></a><span id="l42.189" class="difflineplus">+        rv = impSvc-&gt;CreateNewGenericMail(&amp;pGeneric);</span>
<a href="#l42.190"></a><span id="l42.190" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l42.191"></a><span id="l42.191" class="difflineplus">+          pGeneric-&gt;SetData(&quot;mailInterface&quot;, pMail);</span>
<a href="#l42.192"></a><span id="l42.192">           nsString name;</span>
<a href="#l42.193"></a><span id="l42.193" class="difflineminus">-          nsOutlookStringBundle::GetStringByID( OUTLOOKIMPORT_NAME, name);</span>
<a href="#l42.194"></a><span id="l42.194" class="difflineplus">+          nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_NAME, name);</span>
<a href="#l42.195"></a><span id="l42.195">           nsCOMPtr&lt;nsISupportsString&gt; nameString (do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv));</span>
<a href="#l42.196"></a><span id="l42.196">           if (NS_SUCCEEDED(rv)) {</span>
<a href="#l42.197"></a><span id="l42.197">             nameString-&gt;SetData(name);</span>
<a href="#l42.198"></a><span id="l42.198" class="difflineminus">-            pGeneric-&gt;SetData( &quot;name&quot;, nameString);</span>
<a href="#l42.199"></a><span id="l42.199" class="difflineminus">-            rv = pGeneric-&gt;QueryInterface( kISupportsIID, (void **)ppInterface);</span>
<a href="#l42.200"></a><span id="l42.200" class="difflineplus">+            pGeneric-&gt;SetData(&quot;name&quot;, nameString);</span>
<a href="#l42.201"></a><span id="l42.201" class="difflineplus">+            rv = pGeneric-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l42.202"></a><span id="l42.202">           }</span>
<a href="#l42.203"></a><span id="l42.203">         }</span>
<a href="#l42.204"></a><span id="l42.204">       }</span>
<a href="#l42.205"></a><span id="l42.205">     }</span>
<a href="#l42.206"></a><span id="l42.206" class="difflineminus">-    NS_IF_RELEASE( pMail);</span>
<a href="#l42.207"></a><span id="l42.207" class="difflineminus">-    NS_IF_RELEASE( pGeneric);</span>
<a href="#l42.208"></a><span id="l42.208" class="difflineminus">-    return( rv);</span>
<a href="#l42.209"></a><span id="l42.209" class="difflineplus">+    NS_IF_RELEASE(pMail);</span>
<a href="#l42.210"></a><span id="l42.210" class="difflineplus">+    NS_IF_RELEASE(pGeneric);</span>
<a href="#l42.211"></a><span id="l42.211" class="difflineplus">+    return rv;</span>
<a href="#l42.212"></a><span id="l42.212">   }</span>
<a href="#l42.213"></a><span id="l42.213"> </span>
<a href="#l42.214"></a><span id="l42.214" class="difflineminus">-  if (!strcmp( pImportType, &quot;addressbook&quot;)) {</span>
<a href="#l42.215"></a><span id="l42.215" class="difflineplus">+  if (!strcmp(pImportType, &quot;addressbook&quot;)) {</span>
<a href="#l42.216"></a><span id="l42.216">     // create the nsIImportAddressBook interface and return it!</span>
<a href="#l42.217"></a><span id="l42.217">     nsIImportAddressBooks *  pAddress = nsnull;</span>
<a href="#l42.218"></a><span id="l42.218">     nsIImportGeneric *    pGeneric = nsnull;</span>
<a href="#l42.219"></a><span id="l42.219" class="difflineminus">-    rv = ImportOutlookAddressImpl::Create( &amp;pAddress);</span>
<a href="#l42.220"></a><span id="l42.220" class="difflineminus">-    if (NS_SUCCEEDED( rv)) {</span>
<a href="#l42.221"></a><span id="l42.221" class="difflineplus">+    rv = ImportOutlookAddressImpl::Create(&amp;pAddress);</span>
<a href="#l42.222"></a><span id="l42.222" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l42.223"></a><span id="l42.223">       nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l42.224"></a><span id="l42.224" class="difflineminus">-      if (NS_SUCCEEDED( rv)) {</span>
<a href="#l42.225"></a><span id="l42.225" class="difflineminus">-        rv = impSvc-&gt;CreateNewGenericAddressBooks( &amp;pGeneric);</span>
<a href="#l42.226"></a><span id="l42.226" class="difflineminus">-        if (NS_SUCCEEDED( rv)) {</span>
<a href="#l42.227"></a><span id="l42.227" class="difflineminus">-          pGeneric-&gt;SetData( &quot;addressInterface&quot;, pAddress);</span>
<a href="#l42.228"></a><span id="l42.228" class="difflineminus">-          rv = pGeneric-&gt;QueryInterface( kISupportsIID, (void **)ppInterface);</span>
<a href="#l42.229"></a><span id="l42.229" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l42.230"></a><span id="l42.230" class="difflineplus">+        rv = impSvc-&gt;CreateNewGenericAddressBooks(&amp;pGeneric);</span>
<a href="#l42.231"></a><span id="l42.231" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l42.232"></a><span id="l42.232" class="difflineplus">+          pGeneric-&gt;SetData(&quot;addressInterface&quot;, pAddress);</span>
<a href="#l42.233"></a><span id="l42.233" class="difflineplus">+          rv = pGeneric-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l42.234"></a><span id="l42.234">         }</span>
<a href="#l42.235"></a><span id="l42.235">       }</span>
<a href="#l42.236"></a><span id="l42.236">     }</span>
<a href="#l42.237"></a><span id="l42.237" class="difflineminus">-    NS_IF_RELEASE( pAddress);</span>
<a href="#l42.238"></a><span id="l42.238" class="difflineminus">-    NS_IF_RELEASE( pGeneric);</span>
<a href="#l42.239"></a><span id="l42.239" class="difflineminus">-    return( rv);</span>
<a href="#l42.240"></a><span id="l42.240" class="difflineplus">+    NS_IF_RELEASE(pAddress);</span>
<a href="#l42.241"></a><span id="l42.241" class="difflineplus">+    NS_IF_RELEASE(pGeneric);</span>
<a href="#l42.242"></a><span id="l42.242" class="difflineplus">+    return rv;</span>
<a href="#l42.243"></a><span id="l42.243">   }</span>
<a href="#l42.244"></a><span id="l42.244"> </span>
<a href="#l42.245"></a><span id="l42.245" class="difflineminus">-  if (!strcmp( pImportType, &quot;settings&quot;)) {</span>
<a href="#l42.246"></a><span id="l42.246" class="difflineplus">+  if (!strcmp(pImportType, &quot;settings&quot;)) {</span>
<a href="#l42.247"></a><span id="l42.247">     nsIImportSettings *pSettings = nsnull;</span>
<a href="#l42.248"></a><span id="l42.248" class="difflineminus">-    rv = nsOutlookSettings::Create( &amp;pSettings);</span>
<a href="#l42.249"></a><span id="l42.249" class="difflineminus">-    if (NS_SUCCEEDED( rv))</span>
<a href="#l42.250"></a><span id="l42.250" class="difflineminus">-      pSettings-&gt;QueryInterface( kISupportsIID, (void **)ppInterface);</span>
<a href="#l42.251"></a><span id="l42.251" class="difflineminus">-    NS_IF_RELEASE( pSettings);</span>
<a href="#l42.252"></a><span id="l42.252" class="difflineminus">-    return( rv);</span>
<a href="#l42.253"></a><span id="l42.253" class="difflineplus">+    rv = nsOutlookSettings::Create(&amp;pSettings);</span>
<a href="#l42.254"></a><span id="l42.254" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l42.255"></a><span id="l42.255" class="difflineplus">+      pSettings-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l42.256"></a><span id="l42.256" class="difflineplus">+    NS_IF_RELEASE(pSettings);</span>
<a href="#l42.257"></a><span id="l42.257" class="difflineplus">+    return rv;</span>
<a href="#l42.258"></a><span id="l42.258">   }</span>
<a href="#l42.259"></a><span id="l42.259"> </span>
<a href="#l42.260"></a><span id="l42.260" class="difflineminus">-  return( NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l42.261"></a><span id="l42.261" class="difflineplus">+  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l42.262"></a><span id="l42.262"> }</span>
<a href="#l42.263"></a><span id="l42.263"> </span>
<a href="#l42.264"></a><span id="l42.264"> /////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l42.265"></a><span id="l42.265"> nsresult ImportOutlookMailImpl::Create(nsIImportMail** aImport)</span>
<a href="#l42.266"></a><span id="l42.266"> {</span>
<a href="#l42.267"></a><span id="l42.267">   NS_PRECONDITION(aImport != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.268"></a><span id="l42.268">   if (! aImport)</span>
<a href="#l42.269"></a><span id="l42.269">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l42.270"></a><span id="l42.270" class="difflineat">@@ -325,170 +325,170 @@ ImportOutlookMailImpl::ImportOutlookMail</span>
<a href="#l42.271"></a><span id="l42.271"> </span>
<a href="#l42.272"></a><span id="l42.272"> ImportOutlookMailImpl::~ImportOutlookMailImpl()</span>
<a href="#l42.273"></a><span id="l42.273"> {</span>
<a href="#l42.274"></a><span id="l42.274">   nsOutlookCompose::ReleaseIdentity();</span>
<a href="#l42.275"></a><span id="l42.275"> }</span>
<a href="#l42.276"></a><span id="l42.276"> </span>
<a href="#l42.277"></a><span id="l42.277"> NS_IMPL_THREADSAFE_ISUPPORTS1(ImportOutlookMailImpl, nsIImportMail)</span>
<a href="#l42.278"></a><span id="l42.278"> </span>
<a href="#l42.279"></a><span id="l42.279" class="difflineminus">-NS_IMETHODIMP ImportOutlookMailImpl::GetDefaultLocation( nsIFile **ppLoc, bool *found, bool *userVerify)</span>
<a href="#l42.280"></a><span id="l42.280" class="difflineplus">+NS_IMETHODIMP ImportOutlookMailImpl::GetDefaultLocation(nsIFile **ppLoc, bool *found, bool *userVerify)</span>
<a href="#l42.281"></a><span id="l42.281"> {</span>
<a href="#l42.282"></a><span id="l42.282">   NS_PRECONDITION(ppLoc != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.283"></a><span id="l42.283">   NS_PRECONDITION(found != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.284"></a><span id="l42.284">   NS_PRECONDITION(userVerify != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.285"></a><span id="l42.285">   if (!ppLoc || !found || !userVerify)</span>
<a href="#l42.286"></a><span id="l42.286">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l42.287"></a><span id="l42.287"> </span>
<a href="#l42.288"></a><span id="l42.288">   *found = false;</span>
<a href="#l42.289"></a><span id="l42.289">   *ppLoc = nsnull;</span>
<a href="#l42.290"></a><span id="l42.290">   *userVerify = false;</span>
<a href="#l42.291"></a><span id="l42.291">   // We need to verify here that we can get the mail, if true then</span>
<a href="#l42.292"></a><span id="l42.292">   // return a dummy location, otherwise return no location</span>
<a href="#l42.293"></a><span id="l42.293">   CMapiApi  mapi;</span>
<a href="#l42.294"></a><span id="l42.294">   if (!mapi.Initialize())</span>
<a href="#l42.295"></a><span id="l42.295" class="difflineminus">-    return( NS_OK);</span>
<a href="#l42.296"></a><span id="l42.296" class="difflineplus">+    return NS_OK;</span>
<a href="#l42.297"></a><span id="l42.297">   if (!mapi.LogOn())</span>
<a href="#l42.298"></a><span id="l42.298" class="difflineminus">-    return( NS_OK);</span>
<a href="#l42.299"></a><span id="l42.299" class="difflineplus">+    return NS_OK;</span>
<a href="#l42.300"></a><span id="l42.300"> </span>
<a href="#l42.301"></a><span id="l42.301">   CMapiFolderList  store;</span>
<a href="#l42.302"></a><span id="l42.302" class="difflineminus">-  if (!mapi.IterateStores( store))</span>
<a href="#l42.303"></a><span id="l42.303" class="difflineminus">-    return( NS_OK);</span>
<a href="#l42.304"></a><span id="l42.304" class="difflineplus">+  if (!mapi.IterateStores(store))</span>
<a href="#l42.305"></a><span id="l42.305" class="difflineplus">+    return NS_OK;</span>
<a href="#l42.306"></a><span id="l42.306"> </span>
<a href="#l42.307"></a><span id="l42.307">   if (store.GetSize() == 0)</span>
<a href="#l42.308"></a><span id="l42.308" class="difflineminus">-    return( NS_OK);</span>
<a href="#l42.309"></a><span id="l42.309" class="difflineplus">+    return NS_OK;</span>
<a href="#l42.310"></a><span id="l42.310"> </span>
<a href="#l42.311"></a><span id="l42.311"> </span>
<a href="#l42.312"></a><span id="l42.312">   nsresult  rv;</span>
<a href="#l42.313"></a><span id="l42.313">   nsCOMPtr &lt;nsILocalFile&gt; resultFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l42.314"></a><span id="l42.314">   if (NS_FAILED(rv))</span>
<a href="#l42.315"></a><span id="l42.315" class="difflineminus">-    return(rv);</span>
<a href="#l42.316"></a><span id="l42.316" class="difflineplus">+    return rv;</span>
<a href="#l42.317"></a><span id="l42.317"> </span>
<a href="#l42.318"></a><span id="l42.318">   *found = true;</span>
<a href="#l42.319"></a><span id="l42.319">   NS_IF_ADDREF(*ppLoc = resultFile);</span>
<a href="#l42.320"></a><span id="l42.320">   *userVerify = false;</span>
<a href="#l42.321"></a><span id="l42.321"> </span>
<a href="#l42.322"></a><span id="l42.322" class="difflineminus">-  return( NS_OK);</span>
<a href="#l42.323"></a><span id="l42.323" class="difflineplus">+  return NS_OK;</span>
<a href="#l42.324"></a><span id="l42.324"> }</span>
<a href="#l42.325"></a><span id="l42.325"> </span>
<a href="#l42.326"></a><span id="l42.326"> </span>
<a href="#l42.327"></a><span id="l42.327" class="difflineminus">-NS_IMETHODIMP ImportOutlookMailImpl::FindMailboxes( nsIFile *pLoc, nsISupportsArray **ppArray)</span>
<a href="#l42.328"></a><span id="l42.328" class="difflineplus">+NS_IMETHODIMP ImportOutlookMailImpl::FindMailboxes(nsIFile *pLoc, nsISupportsArray **ppArray)</span>
<a href="#l42.329"></a><span id="l42.329"> {</span>
<a href="#l42.330"></a><span id="l42.330">   NS_PRECONDITION(pLoc != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.331"></a><span id="l42.331">   NS_PRECONDITION(ppArray != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.332"></a><span id="l42.332">   if (!pLoc || !ppArray)</span>
<a href="#l42.333"></a><span id="l42.333">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l42.334"></a><span id="l42.334" class="difflineminus">-  return( m_mail.GetMailFolders( ppArray));</span>
<a href="#l42.335"></a><span id="l42.335" class="difflineplus">+  return m_mail.GetMailFolders(ppArray);</span>
<a href="#l42.336"></a><span id="l42.336"> }</span>
<a href="#l42.337"></a><span id="l42.337"> </span>
<a href="#l42.338"></a><span id="l42.338" class="difflineminus">-void ImportOutlookMailImpl::AddLinebreak( nsString *pStream)</span>
<a href="#l42.339"></a><span id="l42.339" class="difflineplus">+void ImportOutlookMailImpl::AddLinebreak(nsString *pStream)</span>
<a href="#l42.340"></a><span id="l42.340"> {</span>
<a href="#l42.341"></a><span id="l42.341">   if (pStream)</span>
<a href="#l42.342"></a><span id="l42.342" class="difflineminus">-    pStream-&gt;Append( PRUnichar('\n'));</span>
<a href="#l42.343"></a><span id="l42.343" class="difflineplus">+    pStream-&gt;Append(PRUnichar('\n'));</span>
<a href="#l42.344"></a><span id="l42.344"> }</span>
<a href="#l42.345"></a><span id="l42.345"> </span>
<a href="#l42.346"></a><span id="l42.346" class="difflineminus">-void ImportOutlookMailImpl::ReportSuccess( nsString&amp; name, PRInt32 count, nsString *pStream)</span>
<a href="#l42.347"></a><span id="l42.347" class="difflineplus">+void ImportOutlookMailImpl::ReportSuccess(nsString&amp; name, PRInt32 count, nsString *pStream)</span>
<a href="#l42.348"></a><span id="l42.348"> {</span>
<a href="#l42.349"></a><span id="l42.349">   if (!pStream)</span>
<a href="#l42.350"></a><span id="l42.350">     return;</span>
<a href="#l42.351"></a><span id="l42.351">   // load the success string</span>
<a href="#l42.352"></a><span id="l42.352" class="difflineminus">-  PRUnichar *pFmt = nsOutlookStringBundle::GetStringByID( OUTLOOKIMPORT_MAILBOX_SUCCESS);</span>
<a href="#l42.353"></a><span id="l42.353" class="difflineminus">-  PRUnichar *pText = nsTextFormatter::smprintf( pFmt, name.get(), count);</span>
<a href="#l42.354"></a><span id="l42.354" class="difflineminus">-  pStream-&gt;Append( pText);</span>
<a href="#l42.355"></a><span id="l42.355" class="difflineminus">-  nsTextFormatter::smprintf_free( pText);</span>
<a href="#l42.356"></a><span id="l42.356" class="difflineminus">-  nsOutlookStringBundle::FreeString( pFmt);</span>
<a href="#l42.357"></a><span id="l42.357" class="difflineminus">-  AddLinebreak( pStream);</span>
<a href="#l42.358"></a><span id="l42.358" class="difflineplus">+  PRUnichar *pFmt = nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_MAILBOX_SUCCESS);</span>
<a href="#l42.359"></a><span id="l42.359" class="difflineplus">+  PRUnichar *pText = nsTextFormatter::smprintf(pFmt, name.get(), count);</span>
<a href="#l42.360"></a><span id="l42.360" class="difflineplus">+  pStream-&gt;Append(pText);</span>
<a href="#l42.361"></a><span id="l42.361" class="difflineplus">+  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l42.362"></a><span id="l42.362" class="difflineplus">+  nsOutlookStringBundle::FreeString(pFmt);</span>
<a href="#l42.363"></a><span id="l42.363" class="difflineplus">+  AddLinebreak(pStream);</span>
<a href="#l42.364"></a><span id="l42.364"> }</span>
<a href="#l42.365"></a><span id="l42.365"> </span>
<a href="#l42.366"></a><span id="l42.366" class="difflineminus">-void ImportOutlookMailImpl::ReportError( PRInt32 errorNum, nsString&amp; name, nsString *pStream)</span>
<a href="#l42.367"></a><span id="l42.367" class="difflineplus">+void ImportOutlookMailImpl::ReportError(PRInt32 errorNum, nsString&amp; name, nsString *pStream)</span>
<a href="#l42.368"></a><span id="l42.368"> {</span>
<a href="#l42.369"></a><span id="l42.369">   if (!pStream)</span>
<a href="#l42.370"></a><span id="l42.370">     return;</span>
<a href="#l42.371"></a><span id="l42.371">   // load the error string</span>
<a href="#l42.372"></a><span id="l42.372">   PRUnichar *pFmt = nsOutlookStringBundle::GetStringByID(errorNum);</span>
<a href="#l42.373"></a><span id="l42.373" class="difflineminus">-  PRUnichar *pText = nsTextFormatter::smprintf( pFmt, name.get());</span>
<a href="#l42.374"></a><span id="l42.374" class="difflineminus">-  pStream-&gt;Append( pText);</span>
<a href="#l42.375"></a><span id="l42.375" class="difflineminus">-  nsTextFormatter::smprintf_free( pText);</span>
<a href="#l42.376"></a><span id="l42.376" class="difflineminus">-  nsOutlookStringBundle::FreeString( pFmt);</span>
<a href="#l42.377"></a><span id="l42.377" class="difflineminus">-  AddLinebreak( pStream);</span>
<a href="#l42.378"></a><span id="l42.378" class="difflineplus">+  PRUnichar *pText = nsTextFormatter::smprintf(pFmt, name.get());</span>
<a href="#l42.379"></a><span id="l42.379" class="difflineplus">+  pStream-&gt;Append(pText);</span>
<a href="#l42.380"></a><span id="l42.380" class="difflineplus">+  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l42.381"></a><span id="l42.381" class="difflineplus">+  nsOutlookStringBundle::FreeString(pFmt);</span>
<a href="#l42.382"></a><span id="l42.382" class="difflineplus">+  AddLinebreak(pStream);</span>
<a href="#l42.383"></a><span id="l42.383"> }</span>
<a href="#l42.384"></a><span id="l42.384"> </span>
<a href="#l42.385"></a><span id="l42.385"> </span>
<a href="#l42.386"></a><span id="l42.386" class="difflineminus">-void ImportOutlookMailImpl::SetLogs( nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess)</span>
<a href="#l42.387"></a><span id="l42.387" class="difflineplus">+void ImportOutlookMailImpl::SetLogs(nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess)</span>
<a href="#l42.388"></a><span id="l42.388"> {</span>
<a href="#l42.389"></a><span id="l42.389">   if (pError)</span>
<a href="#l42.390"></a><span id="l42.390">     *pError = ToNewUnicode(error);</span>
<a href="#l42.391"></a><span id="l42.391">   if (pSuccess)</span>
<a href="#l42.392"></a><span id="l42.392">     *pSuccess = ToNewUnicode(success);</span>
<a href="#l42.393"></a><span id="l42.393"> }</span>
<a href="#l42.394"></a><span id="l42.394"> </span>
<a href="#l42.395"></a><span id="l42.395" class="difflineminus">-NS_IMETHODIMP ImportOutlookMailImpl::ImportMailbox(  nsIImportMailboxDescriptor *pSource,</span>
<a href="#l42.396"></a><span id="l42.396" class="difflineplus">+NS_IMETHODIMP ImportOutlookMailImpl::ImportMailbox( nsIImportMailboxDescriptor *pSource,</span>
<a href="#l42.397"></a><span id="l42.397">                         nsIFile *pDestination,</span>
<a href="#l42.398"></a><span id="l42.398">                         PRUnichar **pErrorLog,</span>
<a href="#l42.399"></a><span id="l42.399">                         PRUnichar **pSuccessLog,</span>
<a href="#l42.400"></a><span id="l42.400">                         bool *fatalError)</span>
<a href="#l42.401"></a><span id="l42.401"> {</span>
<a href="#l42.402"></a><span id="l42.402">   NS_PRECONDITION(pSource != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.403"></a><span id="l42.403">   NS_PRECONDITION(pDestination != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.404"></a><span id="l42.404">   NS_PRECONDITION(fatalError != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.405"></a><span id="l42.405"> </span>
<a href="#l42.406"></a><span id="l42.406">   nsString  success;</span>
<a href="#l42.407"></a><span id="l42.407">   nsString  error;</span>
<a href="#l42.408"></a><span id="l42.408">   if (!pSource || !pDestination || !fatalError) {</span>
<a href="#l42.409"></a><span id="l42.409" class="difflineminus">-    nsOutlookStringBundle::GetStringByID( OUTLOOKIMPORT_MAILBOX_BADPARAM, error);</span>
<a href="#l42.410"></a><span id="l42.410" class="difflineplus">+    nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_MAILBOX_BADPARAM, error);</span>
<a href="#l42.411"></a><span id="l42.411">     if (fatalError)</span>
<a href="#l42.412"></a><span id="l42.412">       *fatalError = true;</span>
<a href="#l42.413"></a><span id="l42.413" class="difflineminus">-    SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l42.414"></a><span id="l42.414" class="difflineplus">+    SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l42.415"></a><span id="l42.415">       return NS_ERROR_NULL_POINTER;</span>
<a href="#l42.416"></a><span id="l42.416">   }</span>
<a href="#l42.417"></a><span id="l42.417"> </span>
<a href="#l42.418"></a><span id="l42.418">     bool      abort = false;</span>
<a href="#l42.419"></a><span id="l42.419">     nsString  name;</span>
<a href="#l42.420"></a><span id="l42.420">     PRUnichar *  pName;</span>
<a href="#l42.421"></a><span id="l42.421" class="difflineminus">-    if (NS_SUCCEEDED( pSource-&gt;GetDisplayName( &amp;pName))) {</span>
<a href="#l42.422"></a><span id="l42.422" class="difflineplus">+    if (NS_SUCCEEDED(pSource-&gt;GetDisplayName(&amp;pName))) {</span>
<a href="#l42.423"></a><span id="l42.423">       name = pName;</span>
<a href="#l42.424"></a><span id="l42.424" class="difflineminus">-      NS_Free( pName);</span>
<a href="#l42.425"></a><span id="l42.425" class="difflineplus">+      NS_Free(pName);</span>
<a href="#l42.426"></a><span id="l42.426">     }</span>
<a href="#l42.427"></a><span id="l42.427"> </span>
<a href="#l42.428"></a><span id="l42.428">   PRUint32 mailSize = 0;</span>
<a href="#l42.429"></a><span id="l42.429" class="difflineminus">-  pSource-&gt;GetSize( &amp;mailSize);</span>
<a href="#l42.430"></a><span id="l42.430" class="difflineplus">+  pSource-&gt;GetSize(&amp;mailSize);</span>
<a href="#l42.431"></a><span id="l42.431">   if (mailSize == 0) {</span>
<a href="#l42.432"></a><span id="l42.432" class="difflineminus">-    ReportSuccess( name, 0, &amp;success);</span>
<a href="#l42.433"></a><span id="l42.433" class="difflineminus">-    SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l42.434"></a><span id="l42.434" class="difflineminus">-    return( NS_OK);</span>
<a href="#l42.435"></a><span id="l42.435" class="difflineplus">+    ReportSuccess(name, 0, &amp;success);</span>
<a href="#l42.436"></a><span id="l42.436" class="difflineplus">+    SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l42.437"></a><span id="l42.437" class="difflineplus">+    return NS_OK;</span>
<a href="#l42.438"></a><span id="l42.438">   }</span>
<a href="#l42.439"></a><span id="l42.439"> </span>
<a href="#l42.440"></a><span id="l42.440">   PRUint32 index = 0;</span>
<a href="#l42.441"></a><span id="l42.441" class="difflineminus">-  pSource-&gt;GetIdentifier( &amp;index);</span>
<a href="#l42.442"></a><span id="l42.442" class="difflineplus">+  pSource-&gt;GetIdentifier(&amp;index);</span>
<a href="#l42.443"></a><span id="l42.443">   PRInt32  msgCount = 0;</span>
<a href="#l42.444"></a><span id="l42.444">   nsresult rv = NS_OK;</span>
<a href="#l42.445"></a><span id="l42.445"> </span>
<a href="#l42.446"></a><span id="l42.446">   m_bytesDone = 0;</span>
<a href="#l42.447"></a><span id="l42.447"> </span>
<a href="#l42.448"></a><span id="l42.448" class="difflineminus">-  rv = m_mail.ImportMailbox( &amp;m_bytesDone, &amp;abort, (PRInt32)index, name.get(), pDestination, &amp;msgCount);</span>
<a href="#l42.449"></a><span id="l42.449" class="difflineplus">+  rv = m_mail.ImportMailbox(&amp;m_bytesDone, &amp;abort, (PRInt32)index, name.get(), pDestination, &amp;msgCount);</span>
<a href="#l42.450"></a><span id="l42.450"> </span>
<a href="#l42.451"></a><span id="l42.451" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l42.452"></a><span id="l42.452" class="difflineminus">-    ReportSuccess( name, msgCount, &amp;success);</span>
<a href="#l42.453"></a><span id="l42.453" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l42.454"></a><span id="l42.454" class="difflineplus">+    ReportSuccess(name, msgCount, &amp;success);</span>
<a href="#l42.455"></a><span id="l42.455">   else</span>
<a href="#l42.456"></a><span id="l42.456" class="difflineminus">-    ReportError( OUTLOOKIMPORT_MAILBOX_CONVERTERROR, name, &amp;error);</span>
<a href="#l42.457"></a><span id="l42.457" class="difflineplus">+    ReportError(OUTLOOKIMPORT_MAILBOX_CONVERTERROR, name, &amp;error);</span>
<a href="#l42.458"></a><span id="l42.458"> </span>
<a href="#l42.459"></a><span id="l42.459" class="difflineminus">-  SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l42.460"></a><span id="l42.460" class="difflineplus">+  SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l42.461"></a><span id="l42.461"> </span>
<a href="#l42.462"></a><span id="l42.462" class="difflineminus">-    return( rv);</span>
<a href="#l42.463"></a><span id="l42.463" class="difflineplus">+    return rv;</span>
<a href="#l42.464"></a><span id="l42.464"> }</span>
<a href="#l42.465"></a><span id="l42.465"> </span>
<a href="#l42.466"></a><span id="l42.466"> </span>
<a href="#l42.467"></a><span id="l42.467" class="difflineminus">-NS_IMETHODIMP ImportOutlookMailImpl::GetImportProgress( PRUint32 *pDoneSoFar)</span>
<a href="#l42.468"></a><span id="l42.468" class="difflineplus">+NS_IMETHODIMP ImportOutlookMailImpl::GetImportProgress(PRUint32 *pDoneSoFar)</span>
<a href="#l42.469"></a><span id="l42.469"> {</span>
<a href="#l42.470"></a><span id="l42.470">   NS_PRECONDITION(pDoneSoFar != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.471"></a><span id="l42.471">   if (! pDoneSoFar)</span>
<a href="#l42.472"></a><span id="l42.472">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l42.473"></a><span id="l42.473"> </span>
<a href="#l42.474"></a><span id="l42.474">   *pDoneSoFar = m_bytesDone;</span>
<a href="#l42.475"></a><span id="l42.475" class="difflineminus">-  return( NS_OK);</span>
<a href="#l42.476"></a><span id="l42.476" class="difflineplus">+  return NS_OK;</span>
<a href="#l42.477"></a><span id="l42.477"> }</span>
<a href="#l42.478"></a><span id="l42.478"> </span>
<a href="#l42.479"></a><span id="l42.479"> NS_IMETHODIMP ImportOutlookMailImpl::TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval)</span>
<a href="#l42.480"></a><span id="l42.480"> {</span>
<a href="#l42.481"></a><span id="l42.481">   if (aFolderName.LowerCaseEqualsLiteral(&quot;deleted items&quot;))</span>
<a href="#l42.482"></a><span id="l42.482">     _retval = NS_LITERAL_STRING(kDestTrashFolderName);</span>
<a href="#l42.483"></a><span id="l42.483">   else if (aFolderName.LowerCaseEqualsLiteral(&quot;sent items&quot;))</span>
<a href="#l42.484"></a><span id="l42.484">     _retval = NS_LITERAL_STRING(kDestSentFolderName);</span>
<a href="#l42.485"></a><span id="l42.485" class="difflineat">@@ -529,28 +529,28 @@ NS_IMETHODIMP ImportOutlookAddressImpl::</span>
<a href="#l42.486"></a><span id="l42.486"> {</span>
<a href="#l42.487"></a><span id="l42.487">   NS_PRECONDITION(description != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.488"></a><span id="l42.488">   NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.489"></a><span id="l42.489">   if (! description || !_retval)</span>
<a href="#l42.490"></a><span id="l42.490">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l42.491"></a><span id="l42.491"> </span>
<a href="#l42.492"></a><span id="l42.492">   *_retval = true;</span>
<a href="#l42.493"></a><span id="l42.493">   nsString str;</span>
<a href="#l42.494"></a><span id="l42.494" class="difflineminus">-  nsOutlookStringBundle::GetStringByID( OUTLOOKIMPORT_ADDRNAME, str);</span>
<a href="#l42.495"></a><span id="l42.495" class="difflineplus">+  nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_ADDRNAME, str);</span>
<a href="#l42.496"></a><span id="l42.496">   *description = ToNewUnicode(str);</span>
<a href="#l42.497"></a><span id="l42.497" class="difflineminus">-  return( NS_OK);</span>
<a href="#l42.498"></a><span id="l42.498" class="difflineplus">+  return NS_OK;</span>
<a href="#l42.499"></a><span id="l42.499"> }</span>
<a href="#l42.500"></a><span id="l42.500"> </span>
<a href="#l42.501"></a><span id="l42.501"> NS_IMETHODIMP ImportOutlookAddressImpl::FindAddressBooks(nsIFile *location, nsISupportsArray **_retval)</span>
<a href="#l42.502"></a><span id="l42.502"> {</span>
<a href="#l42.503"></a><span id="l42.503">   NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.504"></a><span id="l42.504">   if (!_retval)</span>
<a href="#l42.505"></a><span id="l42.505">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l42.506"></a><span id="l42.506"> </span>
<a href="#l42.507"></a><span id="l42.507" class="difflineminus">-  return( m_address.GetAddressBooks( _retval));</span>
<a href="#l42.508"></a><span id="l42.508" class="difflineplus">+  return m_address.GetAddressBooks(_retval);</span>
<a href="#l42.509"></a><span id="l42.509"> }</span>
<a href="#l42.510"></a><span id="l42.510"> </span>
<a href="#l42.511"></a><span id="l42.511"> NS_IMETHODIMP ImportOutlookAddressImpl::ImportAddressBook(nsIImportABDescriptor *source,</span>
<a href="#l42.512"></a><span id="l42.512">                                                           nsIAddrDatabase *destination,</span>
<a href="#l42.513"></a><span id="l42.513">                                                           nsIImportFieldMap *fieldMap,</span>
<a href="#l42.514"></a><span id="l42.514">                                                           nsISupports *aSupportService,</span>
<a href="#l42.515"></a><span id="l42.515">                                                           PRUnichar **pErrorLog,</span>
<a href="#l42.516"></a><span id="l42.516">                                                           PRUnichar **pSuccessLog,</span>
<a href="#l42.517"></a><span id="l42.517" class="difflineat">@@ -560,43 +560,43 @@ NS_IMETHODIMP ImportOutlookAddressImpl::</span>
<a href="#l42.518"></a><span id="l42.518">   m_msgTotal = 0;</span>
<a href="#l42.519"></a><span id="l42.519">     NS_PRECONDITION(source != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.520"></a><span id="l42.520">     NS_PRECONDITION(destination != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.521"></a><span id="l42.521">   NS_PRECONDITION(fatalError != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.522"></a><span id="l42.522"> </span>
<a href="#l42.523"></a><span id="l42.523">   nsString  success;</span>
<a href="#l42.524"></a><span id="l42.524">   nsString  error;</span>
<a href="#l42.525"></a><span id="l42.525">     if (!source || !destination || !fatalError) {</span>
<a href="#l42.526"></a><span id="l42.526" class="difflineminus">-    IMPORT_LOG0( &quot;*** Bad param passed to outlook address import\n&quot;);</span>
<a href="#l42.527"></a><span id="l42.527" class="difflineminus">-    nsOutlookStringBundle::GetStringByID( OUTLOOKIMPORT_ADDRESS_BADPARAM, error);</span>
<a href="#l42.528"></a><span id="l42.528" class="difflineplus">+    IMPORT_LOG0(&quot;*** Bad param passed to outlook address import\n&quot;);</span>
<a href="#l42.529"></a><span id="l42.529" class="difflineplus">+    nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_ADDRESS_BADPARAM, error);</span>
<a href="#l42.530"></a><span id="l42.530">     if (fatalError)</span>
<a href="#l42.531"></a><span id="l42.531">       *fatalError = true;</span>
<a href="#l42.532"></a><span id="l42.532" class="difflineminus">-    ImportOutlookMailImpl::SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l42.533"></a><span id="l42.533" class="difflineplus">+    ImportOutlookMailImpl::SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l42.534"></a><span id="l42.534">       return NS_ERROR_NULL_POINTER;</span>
<a href="#l42.535"></a><span id="l42.535">   }</span>
<a href="#l42.536"></a><span id="l42.536"> </span>
<a href="#l42.537"></a><span id="l42.537">     nsString name;</span>
<a href="#l42.538"></a><span id="l42.538">     source-&gt;GetPreferredName(name);</span>
<a href="#l42.539"></a><span id="l42.539"> </span>
<a href="#l42.540"></a><span id="l42.540">   PRUint32  id;</span>
<a href="#l42.541"></a><span id="l42.541" class="difflineminus">-  if (NS_FAILED( source-&gt;GetIdentifier( &amp;id))) {</span>
<a href="#l42.542"></a><span id="l42.542" class="difflineminus">-    ImportOutlookMailImpl::ReportError( OUTLOOKIMPORT_ADDRESS_BADSOURCEFILE, name, &amp;error);</span>
<a href="#l42.543"></a><span id="l42.543" class="difflineminus">-    ImportOutlookMailImpl::SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l42.544"></a><span id="l42.544" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l42.545"></a><span id="l42.545" class="difflineplus">+  if (NS_FAILED(source-&gt;GetIdentifier(&amp;id))) {</span>
<a href="#l42.546"></a><span id="l42.546" class="difflineplus">+    ImportOutlookMailImpl::ReportError(OUTLOOKIMPORT_ADDRESS_BADSOURCEFILE, name, &amp;error);</span>
<a href="#l42.547"></a><span id="l42.547" class="difflineplus">+    ImportOutlookMailImpl::SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l42.548"></a><span id="l42.548" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l42.549"></a><span id="l42.549">   }</span>
<a href="#l42.550"></a><span id="l42.550"> </span>
<a href="#l42.551"></a><span id="l42.551">   nsresult rv = NS_OK;</span>
<a href="#l42.552"></a><span id="l42.552" class="difflineminus">-  rv = m_address.ImportAddresses( &amp;m_msgCount, &amp;m_msgTotal, name.get(), id, destination, error);</span>
<a href="#l42.553"></a><span id="l42.553" class="difflineminus">-  if (NS_SUCCEEDED( rv) &amp;&amp; error.IsEmpty())</span>
<a href="#l42.554"></a><span id="l42.554" class="difflineminus">-    ReportSuccess( name, &amp;success);</span>
<a href="#l42.555"></a><span id="l42.555" class="difflineplus">+  rv = m_address.ImportAddresses(&amp;m_msgCount, &amp;m_msgTotal, name.get(), id, destination, error);</span>
<a href="#l42.556"></a><span id="l42.556" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; error.IsEmpty())</span>
<a href="#l42.557"></a><span id="l42.557" class="difflineplus">+    ReportSuccess(name, &amp;success);</span>
<a href="#l42.558"></a><span id="l42.558">   else</span>
<a href="#l42.559"></a><span id="l42.559" class="difflineminus">-    ImportOutlookMailImpl::ReportError( OUTLOOKIMPORT_ADDRESS_CONVERTERROR, name, &amp;error);</span>
<a href="#l42.560"></a><span id="l42.560" class="difflineplus">+    ImportOutlookMailImpl::ReportError(OUTLOOKIMPORT_ADDRESS_CONVERTERROR, name, &amp;error);</span>
<a href="#l42.561"></a><span id="l42.561"> </span>
<a href="#l42.562"></a><span id="l42.562" class="difflineminus">-  ImportOutlookMailImpl::SetLogs( success, error, pErrorLog, pSuccessLog);</span>
<a href="#l42.563"></a><span id="l42.563" class="difflineminus">-  IMPORT_LOG0( &quot;*** Returning from outlook address import\n&quot;);</span>
<a href="#l42.564"></a><span id="l42.564" class="difflineplus">+  ImportOutlookMailImpl::SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l42.565"></a><span id="l42.565" class="difflineplus">+  IMPORT_LOG0(&quot;*** Returning from outlook address import\n&quot;);</span>
<a href="#l42.566"></a><span id="l42.566">   return destination-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l42.567"></a><span id="l42.567"> }</span>
<a href="#l42.568"></a><span id="l42.568"> </span>
<a href="#l42.569"></a><span id="l42.569"> </span>
<a href="#l42.570"></a><span id="l42.570"> NS_IMETHODIMP ImportOutlookAddressImpl::GetImportProgress(PRUint32 *_retval)</span>
<a href="#l42.571"></a><span id="l42.571"> {</span>
<a href="#l42.572"></a><span id="l42.572">   NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l42.573"></a><span id="l42.573">   if (!_retval)</span>
<a href="#l42.574"></a><span id="l42.574" class="difflineat">@@ -610,23 +610,23 @@ NS_IMETHODIMP ImportOutlookAddressImpl::</span>
<a href="#l42.575"></a><span id="l42.575">   else</span>
<a href="#l42.576"></a><span id="l42.576">     result = 0;</span>
<a href="#l42.577"></a><span id="l42.577"> </span>
<a href="#l42.578"></a><span id="l42.578">   if (result &gt; 100)</span>
<a href="#l42.579"></a><span id="l42.579">     result = 100;</span>
<a href="#l42.580"></a><span id="l42.580"> </span>
<a href="#l42.581"></a><span id="l42.581">   *_retval = result;</span>
<a href="#l42.582"></a><span id="l42.582"> </span>
<a href="#l42.583"></a><span id="l42.583" class="difflineminus">-  return( NS_OK);</span>
<a href="#l42.584"></a><span id="l42.584" class="difflineplus">+  return NS_OK;</span>
<a href="#l42.585"></a><span id="l42.585"> }</span>
<a href="#l42.586"></a><span id="l42.586"> </span>
<a href="#l42.587"></a><span id="l42.587" class="difflineminus">-void ImportOutlookAddressImpl::ReportSuccess( nsString&amp; name, nsString *pStream)</span>
<a href="#l42.588"></a><span id="l42.588" class="difflineplus">+void ImportOutlookAddressImpl::ReportSuccess(nsString&amp; name, nsString *pStream)</span>
<a href="#l42.589"></a><span id="l42.589"> {</span>
<a href="#l42.590"></a><span id="l42.590">   if (!pStream)</span>
<a href="#l42.591"></a><span id="l42.591">     return;</span>
<a href="#l42.592"></a><span id="l42.592">   // load the success string</span>
<a href="#l42.593"></a><span id="l42.593">   PRUnichar *pFmt = nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_ADDRESS_SUCCESS);</span>
<a href="#l42.594"></a><span id="l42.594" class="difflineminus">-  PRUnichar *pText = nsTextFormatter::smprintf( pFmt, name.get());</span>
<a href="#l42.595"></a><span id="l42.595" class="difflineminus">-  pStream-&gt;Append( pText);</span>
<a href="#l42.596"></a><span id="l42.596" class="difflineminus">-  nsTextFormatter::smprintf_free( pText);</span>
<a href="#l42.597"></a><span id="l42.597" class="difflineminus">-  nsOutlookStringBundle::FreeString( pFmt);</span>
<a href="#l42.598"></a><span id="l42.598" class="difflineminus">-  ImportOutlookMailImpl::AddLinebreak( pStream);</span>
<a href="#l42.599"></a><span id="l42.599" class="difflineplus">+  PRUnichar *pText = nsTextFormatter::smprintf(pFmt, name.get());</span>
<a href="#l42.600"></a><span id="l42.600" class="difflineplus">+  pStream-&gt;Append(pText);</span>
<a href="#l42.601"></a><span id="l42.601" class="difflineplus">+  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l42.602"></a><span id="l42.602" class="difflineplus">+  nsOutlookStringBundle::FreeString(pFmt);</span>
<a href="#l42.603"></a><span id="l42.603" class="difflineplus">+  ImportOutlookMailImpl::AddLinebreak(pStream);</span>
<a href="#l42.604"></a><span id="l42.604"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookMail.cpp</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookMail.cpp</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -133,221 +133,221 @@ nsOutlookMail::nsOutlookMail()</span>
<a href="#l43.4"></a><span id="l43.4">   m_lpMdb = NULL;</span>
<a href="#l43.5"></a><span id="l43.5"> }</span>
<a href="#l43.6"></a><span id="l43.6"> </span>
<a href="#l43.7"></a><span id="l43.7"> nsOutlookMail::~nsOutlookMail()</span>
<a href="#l43.8"></a><span id="l43.8"> {</span>
<a href="#l43.9"></a><span id="l43.9"> //  EmptyAttachments();</span>
<a href="#l43.10"></a><span id="l43.10"> }</span>
<a href="#l43.11"></a><span id="l43.11"> </span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-nsresult nsOutlookMail::GetMailFolders( nsISupportsArray **pArray)</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+nsresult nsOutlookMail::GetMailFolders(nsISupportsArray **pArray)</span>
<a href="#l43.14"></a><span id="l43.14"> {</span>
<a href="#l43.15"></a><span id="l43.15">   if (!m_haveMapi) {</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineminus">-    IMPORT_LOG0( &quot;GetMailFolders called before Mapi is initialized\n&quot;);</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+    IMPORT_LOG0(&quot;GetMailFolders called before Mapi is initialized\n&quot;);</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l43.20"></a><span id="l43.20">   }</span>
<a href="#l43.21"></a><span id="l43.21"> </span>
<a href="#l43.22"></a><span id="l43.22" class="difflineminus">-  nsresult rv = NS_NewISupportsArray( pArray);</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l43.24"></a><span id="l43.24" class="difflineminus">-    IMPORT_LOG0( &quot;FAILED to allocate the nsISupportsArray for the mail folder list\n&quot;);</span>
<a href="#l43.25"></a><span id="l43.25" class="difflineminus">-    return( rv);</span>
<a href="#l43.26"></a><span id="l43.26" class="difflineplus">+  nsresult rv = NS_NewISupportsArray(pArray);</span>
<a href="#l43.27"></a><span id="l43.27" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l43.28"></a><span id="l43.28" class="difflineplus">+    IMPORT_LOG0(&quot;FAILED to allocate the nsISupportsArray for the mail folder list\n&quot;);</span>
<a href="#l43.29"></a><span id="l43.29" class="difflineplus">+    return rv;</span>
<a href="#l43.30"></a><span id="l43.30">   }</span>
<a href="#l43.31"></a><span id="l43.31"> </span>
<a href="#l43.32"></a><span id="l43.32">   nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l43.34"></a><span id="l43.34" class="difflineminus">-    return( rv);</span>
<a href="#l43.35"></a><span id="l43.35" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineplus">+    return rv;</span>
<a href="#l43.37"></a><span id="l43.37"> </span>
<a href="#l43.38"></a><span id="l43.38">   m_gotFolders = true;</span>
<a href="#l43.39"></a><span id="l43.39"> </span>
<a href="#l43.40"></a><span id="l43.40">   m_folderList.ClearAll();</span>
<a href="#l43.41"></a><span id="l43.41"> </span>
<a href="#l43.42"></a><span id="l43.42">   m_mapi.Initialize();</span>
<a href="#l43.43"></a><span id="l43.43">   m_mapi.LogOn();</span>
<a href="#l43.44"></a><span id="l43.44"> </span>
<a href="#l43.45"></a><span id="l43.45">   if (m_storeList.GetSize() == 0)</span>
<a href="#l43.46"></a><span id="l43.46" class="difflineminus">-    m_mapi.IterateStores( m_storeList);</span>
<a href="#l43.47"></a><span id="l43.47" class="difflineplus">+    m_mapi.IterateStores(m_storeList);</span>
<a href="#l43.48"></a><span id="l43.48"> </span>
<a href="#l43.49"></a><span id="l43.49">   int i = 0;</span>
<a href="#l43.50"></a><span id="l43.50">   CMapiFolder *pFolder;</span>
<a href="#l43.51"></a><span id="l43.51">   if (m_storeList.GetSize() &gt; 1) {</span>
<a href="#l43.52"></a><span id="l43.52" class="difflineminus">-    while ((pFolder = m_storeList.GetItem( i))) {</span>
<a href="#l43.53"></a><span id="l43.53" class="difflineminus">-      CMapiFolder *pItem = new CMapiFolder( pFolder);</span>
<a href="#l43.54"></a><span id="l43.54" class="difflineminus">-      pItem-&gt;SetDepth( 1);</span>
<a href="#l43.55"></a><span id="l43.55" class="difflineminus">-      m_folderList.AddItem( pItem);</span>
<a href="#l43.56"></a><span id="l43.56" class="difflineminus">-      if (!m_mapi.GetStoreFolders( pItem-&gt;GetCBEntryID(), pItem-&gt;GetEntryID(), m_folderList, 2)) {</span>
<a href="#l43.57"></a><span id="l43.57" class="difflineminus">-        IMPORT_LOG1( &quot;GetStoreFolders for index %d failed.\n&quot;, i);</span>
<a href="#l43.58"></a><span id="l43.58" class="difflineplus">+    while ((pFolder = m_storeList.GetItem(i))) {</span>
<a href="#l43.59"></a><span id="l43.59" class="difflineplus">+      CMapiFolder *pItem = new CMapiFolder(pFolder);</span>
<a href="#l43.60"></a><span id="l43.60" class="difflineplus">+      pItem-&gt;SetDepth(1);</span>
<a href="#l43.61"></a><span id="l43.61" class="difflineplus">+      m_folderList.AddItem(pItem);</span>
<a href="#l43.62"></a><span id="l43.62" class="difflineplus">+      if (!m_mapi.GetStoreFolders(pItem-&gt;GetCBEntryID(), pItem-&gt;GetEntryID(), m_folderList, 2)) {</span>
<a href="#l43.63"></a><span id="l43.63" class="difflineplus">+        IMPORT_LOG1(&quot;GetStoreFolders for index %d failed.\n&quot;, i);</span>
<a href="#l43.64"></a><span id="l43.64">       }</span>
<a href="#l43.65"></a><span id="l43.65">       i++;</span>
<a href="#l43.66"></a><span id="l43.66">     }</span>
<a href="#l43.67"></a><span id="l43.67">   }</span>
<a href="#l43.68"></a><span id="l43.68">   else {</span>
<a href="#l43.69"></a><span id="l43.69" class="difflineminus">-    if ((pFolder = m_storeList.GetItem( i))) {</span>
<a href="#l43.70"></a><span id="l43.70" class="difflineminus">-      if (!m_mapi.GetStoreFolders( pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID(), m_folderList, 1)) {</span>
<a href="#l43.71"></a><span id="l43.71" class="difflineminus">-        IMPORT_LOG1( &quot;GetStoreFolders for index %d failed.\n&quot;, i);</span>
<a href="#l43.72"></a><span id="l43.72" class="difflineplus">+    if ((pFolder = m_storeList.GetItem(i))) {</span>
<a href="#l43.73"></a><span id="l43.73" class="difflineplus">+      if (!m_mapi.GetStoreFolders(pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID(), m_folderList, 1)) {</span>
<a href="#l43.74"></a><span id="l43.74" class="difflineplus">+        IMPORT_LOG1(&quot;GetStoreFolders for index %d failed.\n&quot;, i);</span>
<a href="#l43.75"></a><span id="l43.75">       }</span>
<a href="#l43.76"></a><span id="l43.76">     }</span>
<a href="#l43.77"></a><span id="l43.77">   }</span>
<a href="#l43.78"></a><span id="l43.78"> </span>
<a href="#l43.79"></a><span id="l43.79">   // Create the mailbox descriptors for the list of folders</span>
<a href="#l43.80"></a><span id="l43.80">   nsIImportMailboxDescriptor *  pID;</span>
<a href="#l43.81"></a><span id="l43.81">   nsISupports *          pInterface;</span>
<a href="#l43.82"></a><span id="l43.82">   nsString            name;</span>
<a href="#l43.83"></a><span id="l43.83">   nsString            uniName;</span>
<a href="#l43.84"></a><span id="l43.84"> </span>
<a href="#l43.85"></a><span id="l43.85">   for (i = 0; i &lt; m_folderList.GetSize(); i++) {</span>
<a href="#l43.86"></a><span id="l43.86" class="difflineminus">-    pFolder = m_folderList.GetItem( i);</span>
<a href="#l43.87"></a><span id="l43.87" class="difflineminus">-    rv = impSvc-&gt;CreateNewMailboxDescriptor( &amp;pID);</span>
<a href="#l43.88"></a><span id="l43.88" class="difflineminus">-    if (NS_SUCCEEDED( rv)) {</span>
<a href="#l43.89"></a><span id="l43.89" class="difflineminus">-      pID-&gt;SetDepth( pFolder-&gt;GetDepth());</span>
<a href="#l43.90"></a><span id="l43.90" class="difflineminus">-      pID-&gt;SetIdentifier( i);</span>
<a href="#l43.91"></a><span id="l43.91" class="difflineplus">+    pFolder = m_folderList.GetItem(i);</span>
<a href="#l43.92"></a><span id="l43.92" class="difflineplus">+    rv = impSvc-&gt;CreateNewMailboxDescriptor(&amp;pID);</span>
<a href="#l43.93"></a><span id="l43.93" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l43.94"></a><span id="l43.94" class="difflineplus">+      pID-&gt;SetDepth(pFolder-&gt;GetDepth());</span>
<a href="#l43.95"></a><span id="l43.95" class="difflineplus">+      pID-&gt;SetIdentifier(i);</span>
<a href="#l43.96"></a><span id="l43.96"> </span>
<a href="#l43.97"></a><span id="l43.97" class="difflineminus">-      pFolder-&gt;GetDisplayName( name);</span>
<a href="#l43.98"></a><span id="l43.98" class="difflineplus">+      pFolder-&gt;GetDisplayName(name);</span>
<a href="#l43.99"></a><span id="l43.99">       pID-&gt;SetDisplayName(name.get());</span>
<a href="#l43.100"></a><span id="l43.100"> </span>
<a href="#l43.101"></a><span id="l43.101" class="difflineminus">-      pID-&gt;SetSize( 1000);</span>
<a href="#l43.102"></a><span id="l43.102" class="difflineminus">-      rv = pID-&gt;QueryInterface( kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l43.103"></a><span id="l43.103" class="difflineminus">-      (*pArray)-&gt;AppendElement( pInterface);</span>
<a href="#l43.104"></a><span id="l43.104" class="difflineplus">+      pID-&gt;SetSize(1000);</span>
<a href="#l43.105"></a><span id="l43.105" class="difflineplus">+      rv = pID-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l43.106"></a><span id="l43.106" class="difflineplus">+      (*pArray)-&gt;AppendElement(pInterface);</span>
<a href="#l43.107"></a><span id="l43.107">       pInterface-&gt;Release();</span>
<a href="#l43.108"></a><span id="l43.108">       pID-&gt;Release();</span>
<a href="#l43.109"></a><span id="l43.109">     }</span>
<a href="#l43.110"></a><span id="l43.110">   }</span>
<a href="#l43.111"></a><span id="l43.111"> </span>
<a href="#l43.112"></a><span id="l43.112" class="difflineminus">-  return( NS_OK);</span>
<a href="#l43.113"></a><span id="l43.113" class="difflineplus">+  return NS_OK;</span>
<a href="#l43.114"></a><span id="l43.114"> }</span>
<a href="#l43.115"></a><span id="l43.115"> </span>
<a href="#l43.116"></a><span id="l43.116" class="difflineminus">-bool nsOutlookMail::IsAddressBookNameUnique( nsString&amp; name, nsString&amp; list)</span>
<a href="#l43.117"></a><span id="l43.117" class="difflineplus">+bool nsOutlookMail::IsAddressBookNameUnique(nsString&amp; name, nsString&amp; list)</span>
<a href="#l43.118"></a><span id="l43.118"> {</span>
<a href="#l43.119"></a><span id="l43.119">   nsString    usedName;</span>
<a href="#l43.120"></a><span id="l43.120">   usedName.AppendLiteral(&quot;[&quot;);</span>
<a href="#l43.121"></a><span id="l43.121" class="difflineminus">-  usedName.Append( name);</span>
<a href="#l43.122"></a><span id="l43.122" class="difflineplus">+  usedName.Append(name);</span>
<a href="#l43.123"></a><span id="l43.123">   usedName.AppendLiteral(&quot;],&quot;);</span>
<a href="#l43.124"></a><span id="l43.124"> </span>
<a href="#l43.125"></a><span id="l43.125" class="difflineminus">-  return( list.Find( usedName) == -1);</span>
<a href="#l43.126"></a><span id="l43.126" class="difflineplus">+  return list.Find(usedName) == -1;</span>
<a href="#l43.127"></a><span id="l43.127"> }</span>
<a href="#l43.128"></a><span id="l43.128"> </span>
<a href="#l43.129"></a><span id="l43.129" class="difflineminus">-void nsOutlookMail::MakeAddressBookNameUnique( nsString&amp; name, nsString&amp; list)</span>
<a href="#l43.130"></a><span id="l43.130" class="difflineplus">+void nsOutlookMail::MakeAddressBookNameUnique(nsString&amp; name, nsString&amp; list)</span>
<a href="#l43.131"></a><span id="l43.131"> {</span>
<a href="#l43.132"></a><span id="l43.132">   nsString    newName;</span>
<a href="#l43.133"></a><span id="l43.133">   int        idx = 1;</span>
<a href="#l43.134"></a><span id="l43.134"> </span>
<a href="#l43.135"></a><span id="l43.135">   newName = name;</span>
<a href="#l43.136"></a><span id="l43.136" class="difflineminus">-  while (!IsAddressBookNameUnique( newName, list)) {</span>
<a href="#l43.137"></a><span id="l43.137" class="difflineplus">+  while (!IsAddressBookNameUnique(newName, list)) {</span>
<a href="#l43.138"></a><span id="l43.138">     newName = name;</span>
<a href="#l43.139"></a><span id="l43.139">     newName.Append(PRUnichar(' '));</span>
<a href="#l43.140"></a><span id="l43.140" class="difflineminus">-    newName.AppendInt( (PRInt32) idx);</span>
<a href="#l43.141"></a><span id="l43.141" class="difflineplus">+    newName.AppendInt((PRInt32) idx);</span>
<a href="#l43.142"></a><span id="l43.142">     idx++;</span>
<a href="#l43.143"></a><span id="l43.143">   }</span>
<a href="#l43.144"></a><span id="l43.144"> </span>
<a href="#l43.145"></a><span id="l43.145">   name = newName;</span>
<a href="#l43.146"></a><span id="l43.146">   list.AppendLiteral(&quot;[&quot;);</span>
<a href="#l43.147"></a><span id="l43.147" class="difflineminus">-  list.Append( name);</span>
<a href="#l43.148"></a><span id="l43.148" class="difflineplus">+  list.Append(name);</span>
<a href="#l43.149"></a><span id="l43.149">   list.AppendLiteral(&quot;],&quot;);</span>
<a href="#l43.150"></a><span id="l43.150"> }</span>
<a href="#l43.151"></a><span id="l43.151"> </span>
<a href="#l43.152"></a><span id="l43.152" class="difflineminus">-nsresult nsOutlookMail::GetAddressBooks( nsISupportsArray **pArray)</span>
<a href="#l43.153"></a><span id="l43.153" class="difflineplus">+nsresult nsOutlookMail::GetAddressBooks(nsISupportsArray **pArray)</span>
<a href="#l43.154"></a><span id="l43.154"> {</span>
<a href="#l43.155"></a><span id="l43.155">   if (!m_haveMapi) {</span>
<a href="#l43.156"></a><span id="l43.156" class="difflineminus">-    IMPORT_LOG0( &quot;GetAddressBooks called before Mapi is initialized\n&quot;);</span>
<a href="#l43.157"></a><span id="l43.157" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l43.158"></a><span id="l43.158" class="difflineplus">+    IMPORT_LOG0(&quot;GetAddressBooks called before Mapi is initialized\n&quot;);</span>
<a href="#l43.159"></a><span id="l43.159" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l43.160"></a><span id="l43.160">   }</span>
<a href="#l43.161"></a><span id="l43.161"> </span>
<a href="#l43.162"></a><span id="l43.162" class="difflineminus">-  nsresult rv = NS_NewISupportsArray( pArray);</span>
<a href="#l43.163"></a><span id="l43.163" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l43.164"></a><span id="l43.164" class="difflineminus">-    IMPORT_LOG0( &quot;FAILED to allocate the nsISupportsArray for the address book list\n&quot;);</span>
<a href="#l43.165"></a><span id="l43.165" class="difflineminus">-    return( rv);</span>
<a href="#l43.166"></a><span id="l43.166" class="difflineplus">+  nsresult rv = NS_NewISupportsArray(pArray);</span>
<a href="#l43.167"></a><span id="l43.167" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l43.168"></a><span id="l43.168" class="difflineplus">+    IMPORT_LOG0(&quot;FAILED to allocate the nsISupportsArray for the address book list\n&quot;);</span>
<a href="#l43.169"></a><span id="l43.169" class="difflineplus">+    return rv;</span>
<a href="#l43.170"></a><span id="l43.170">   }</span>
<a href="#l43.171"></a><span id="l43.171"> </span>
<a href="#l43.172"></a><span id="l43.172">   nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l43.173"></a><span id="l43.173" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l43.174"></a><span id="l43.174" class="difflineminus">-    return( rv);</span>
<a href="#l43.175"></a><span id="l43.175" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l43.176"></a><span id="l43.176" class="difflineplus">+    return rv;</span>
<a href="#l43.177"></a><span id="l43.177"> </span>
<a href="#l43.178"></a><span id="l43.178">   m_gotAddresses = true;</span>
<a href="#l43.179"></a><span id="l43.179"> </span>
<a href="#l43.180"></a><span id="l43.180">   m_addressList.ClearAll();</span>
<a href="#l43.181"></a><span id="l43.181">   m_mapi.Initialize();</span>
<a href="#l43.182"></a><span id="l43.182">   m_mapi.LogOn();</span>
<a href="#l43.183"></a><span id="l43.183">   if (m_storeList.GetSize() == 0)</span>
<a href="#l43.184"></a><span id="l43.184" class="difflineminus">-    m_mapi.IterateStores( m_storeList);</span>
<a href="#l43.185"></a><span id="l43.185" class="difflineplus">+    m_mapi.IterateStores(m_storeList);</span>
<a href="#l43.186"></a><span id="l43.186"> </span>
<a href="#l43.187"></a><span id="l43.187">   int i = 0;</span>
<a href="#l43.188"></a><span id="l43.188">   CMapiFolder *pFolder;</span>
<a href="#l43.189"></a><span id="l43.189">   if (m_storeList.GetSize() &gt; 1) {</span>
<a href="#l43.190"></a><span id="l43.190" class="difflineminus">-    while ((pFolder = m_storeList.GetItem( i))) {</span>
<a href="#l43.191"></a><span id="l43.191" class="difflineminus">-      CMapiFolder *pItem = new CMapiFolder( pFolder);</span>
<a href="#l43.192"></a><span id="l43.192" class="difflineminus">-      pItem-&gt;SetDepth( 1);</span>
<a href="#l43.193"></a><span id="l43.193" class="difflineminus">-      m_addressList.AddItem( pItem);</span>
<a href="#l43.194"></a><span id="l43.194" class="difflineminus">-      if (!m_mapi.GetStoreAddressFolders( pItem-&gt;GetCBEntryID(), pItem-&gt;GetEntryID(), m_addressList)) {</span>
<a href="#l43.195"></a><span id="l43.195" class="difflineminus">-        IMPORT_LOG1( &quot;GetStoreAddressFolders for index %d failed.\n&quot;, i);</span>
<a href="#l43.196"></a><span id="l43.196" class="difflineplus">+    while ((pFolder = m_storeList.GetItem(i))) {</span>
<a href="#l43.197"></a><span id="l43.197" class="difflineplus">+      CMapiFolder *pItem = new CMapiFolder(pFolder);</span>
<a href="#l43.198"></a><span id="l43.198" class="difflineplus">+      pItem-&gt;SetDepth(1);</span>
<a href="#l43.199"></a><span id="l43.199" class="difflineplus">+      m_addressList.AddItem(pItem);</span>
<a href="#l43.200"></a><span id="l43.200" class="difflineplus">+      if (!m_mapi.GetStoreAddressFolders(pItem-&gt;GetCBEntryID(), pItem-&gt;GetEntryID(), m_addressList)) {</span>
<a href="#l43.201"></a><span id="l43.201" class="difflineplus">+        IMPORT_LOG1(&quot;GetStoreAddressFolders for index %d failed.\n&quot;, i);</span>
<a href="#l43.202"></a><span id="l43.202">       }</span>
<a href="#l43.203"></a><span id="l43.203">       i++;</span>
<a href="#l43.204"></a><span id="l43.204">     }</span>
<a href="#l43.205"></a><span id="l43.205">   }</span>
<a href="#l43.206"></a><span id="l43.206">   else {</span>
<a href="#l43.207"></a><span id="l43.207" class="difflineminus">-    if ((pFolder = m_storeList.GetItem( i))) {</span>
<a href="#l43.208"></a><span id="l43.208" class="difflineminus">-      if (!m_mapi.GetStoreAddressFolders( pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID(), m_addressList)) {</span>
<a href="#l43.209"></a><span id="l43.209" class="difflineminus">-        IMPORT_LOG1( &quot;GetStoreFolders for index %d failed.\n&quot;, i);</span>
<a href="#l43.210"></a><span id="l43.210" class="difflineplus">+    if ((pFolder = m_storeList.GetItem(i))) {</span>
<a href="#l43.211"></a><span id="l43.211" class="difflineplus">+      if (!m_mapi.GetStoreAddressFolders(pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID(), m_addressList)) {</span>
<a href="#l43.212"></a><span id="l43.212" class="difflineplus">+        IMPORT_LOG1(&quot;GetStoreFolders for index %d failed.\n&quot;, i);</span>
<a href="#l43.213"></a><span id="l43.213">       }</span>
<a href="#l43.214"></a><span id="l43.214">     }</span>
<a href="#l43.215"></a><span id="l43.215">   }</span>
<a href="#l43.216"></a><span id="l43.216"> </span>
<a href="#l43.217"></a><span id="l43.217">   // Create the mailbox descriptors for the list of folders</span>
<a href="#l43.218"></a><span id="l43.218">   nsIImportABDescriptor *      pID;</span>
<a href="#l43.219"></a><span id="l43.219">   nsISupports *          pInterface;</span>
<a href="#l43.220"></a><span id="l43.220">   nsString            name;</span>
<a href="#l43.221"></a><span id="l43.221">   nsString            list;</span>
<a href="#l43.222"></a><span id="l43.222"> </span>
<a href="#l43.223"></a><span id="l43.223">   for (i = 0; i &lt; m_addressList.GetSize(); i++) {</span>
<a href="#l43.224"></a><span id="l43.224" class="difflineminus">-    pFolder = m_addressList.GetItem( i);</span>
<a href="#l43.225"></a><span id="l43.225" class="difflineplus">+    pFolder = m_addressList.GetItem(i);</span>
<a href="#l43.226"></a><span id="l43.226">     if (!pFolder-&gt;IsStore()) {</span>
<a href="#l43.227"></a><span id="l43.227" class="difflineminus">-      rv = impSvc-&gt;CreateNewABDescriptor( &amp;pID);</span>
<a href="#l43.228"></a><span id="l43.228" class="difflineminus">-      if (NS_SUCCEEDED( rv)) {</span>
<a href="#l43.229"></a><span id="l43.229" class="difflineminus">-        pID-&gt;SetIdentifier( i);</span>
<a href="#l43.230"></a><span id="l43.230" class="difflineminus">-        pFolder-&gt;GetDisplayName( name);</span>
<a href="#l43.231"></a><span id="l43.231" class="difflineminus">-        MakeAddressBookNameUnique( name, list);</span>
<a href="#l43.232"></a><span id="l43.232" class="difflineplus">+      rv = impSvc-&gt;CreateNewABDescriptor(&amp;pID);</span>
<a href="#l43.233"></a><span id="l43.233" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l43.234"></a><span id="l43.234" class="difflineplus">+        pID-&gt;SetIdentifier(i);</span>
<a href="#l43.235"></a><span id="l43.235" class="difflineplus">+        pFolder-&gt;GetDisplayName(name);</span>
<a href="#l43.236"></a><span id="l43.236" class="difflineplus">+        MakeAddressBookNameUnique(name, list);</span>
<a href="#l43.237"></a><span id="l43.237">         pID-&gt;SetPreferredName(name);</span>
<a href="#l43.238"></a><span id="l43.238" class="difflineminus">-        pID-&gt;SetSize( 100);</span>
<a href="#l43.239"></a><span id="l43.239" class="difflineminus">-        rv = pID-&gt;QueryInterface( kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l43.240"></a><span id="l43.240" class="difflineminus">-        (*pArray)-&gt;AppendElement( pInterface);</span>
<a href="#l43.241"></a><span id="l43.241" class="difflineplus">+        pID-&gt;SetSize(100);</span>
<a href="#l43.242"></a><span id="l43.242" class="difflineplus">+        rv = pID-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l43.243"></a><span id="l43.243" class="difflineplus">+        (*pArray)-&gt;AppendElement(pInterface);</span>
<a href="#l43.244"></a><span id="l43.244">         pInterface-&gt;Release();</span>
<a href="#l43.245"></a><span id="l43.245">         pID-&gt;Release();</span>
<a href="#l43.246"></a><span id="l43.246">       }</span>
<a href="#l43.247"></a><span id="l43.247">     }</span>
<a href="#l43.248"></a><span id="l43.248">   }</span>
<a href="#l43.249"></a><span id="l43.249"> </span>
<a href="#l43.250"></a><span id="l43.250" class="difflineminus">-  return( NS_OK);</span>
<a href="#l43.251"></a><span id="l43.251" class="difflineplus">+  return NS_OK;</span>
<a href="#l43.252"></a><span id="l43.252"> }</span>
<a href="#l43.253"></a><span id="l43.253"> </span>
<a href="#l43.254"></a><span id="l43.254" class="difflineminus">-void nsOutlookMail::OpenMessageStore( CMapiFolder *pNextFolder)</span>
<a href="#l43.255"></a><span id="l43.255" class="difflineplus">+void nsOutlookMail::OpenMessageStore(CMapiFolder *pNextFolder)</span>
<a href="#l43.256"></a><span id="l43.256"> {</span>
<a href="#l43.257"></a><span id="l43.257">   // Open the store specified</span>
<a href="#l43.258"></a><span id="l43.258">   if (pNextFolder-&gt;IsStore()) {</span>
<a href="#l43.259"></a><span id="l43.259" class="difflineminus">-    if (!m_mapi.OpenStore( pNextFolder-&gt;GetCBEntryID(), pNextFolder-&gt;GetEntryID(), &amp;m_lpMdb)) {</span>
<a href="#l43.260"></a><span id="l43.260" class="difflineplus">+    if (!m_mapi.OpenStore(pNextFolder-&gt;GetCBEntryID(), pNextFolder-&gt;GetEntryID(), &amp;m_lpMdb)) {</span>
<a href="#l43.261"></a><span id="l43.261">       m_lpMdb = NULL;</span>
<a href="#l43.262"></a><span id="l43.262" class="difflineminus">-      IMPORT_LOG0( &quot;CMapiApi::OpenStore failed\n&quot;);</span>
<a href="#l43.263"></a><span id="l43.263" class="difflineplus">+      IMPORT_LOG0(&quot;CMapiApi::OpenStore failed\n&quot;);</span>
<a href="#l43.264"></a><span id="l43.264">     }</span>
<a href="#l43.265"></a><span id="l43.265"> </span>
<a href="#l43.266"></a><span id="l43.266">     return;</span>
<a href="#l43.267"></a><span id="l43.267">   }</span>
<a href="#l43.268"></a><span id="l43.268"> </span>
<a href="#l43.269"></a><span id="l43.269">   // Check to see if we should open the one and only store</span>
<a href="#l43.270"></a><span id="l43.270">   if (!m_lpMdb) {</span>
<a href="#l43.271"></a><span id="l43.271">     if (m_storeList.GetSize() == 1) {</span>
<a href="#l43.272"></a><span id="l43.272" class="difflineminus">-      CMapiFolder * pFolder = m_storeList.GetItem( 0);</span>
<a href="#l43.273"></a><span id="l43.273" class="difflineplus">+      CMapiFolder * pFolder = m_storeList.GetItem(0);</span>
<a href="#l43.274"></a><span id="l43.274">       if (pFolder) {</span>
<a href="#l43.275"></a><span id="l43.275" class="difflineminus">-        if (!m_mapi.OpenStore( pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID(), &amp;m_lpMdb)) {</span>
<a href="#l43.276"></a><span id="l43.276" class="difflineplus">+        if (!m_mapi.OpenStore(pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID(), &amp;m_lpMdb)) {</span>
<a href="#l43.277"></a><span id="l43.277">           m_lpMdb = NULL;</span>
<a href="#l43.278"></a><span id="l43.278" class="difflineminus">-          IMPORT_LOG0( &quot;CMapiApi::OpenStore failed\n&quot;);</span>
<a href="#l43.279"></a><span id="l43.279" class="difflineplus">+          IMPORT_LOG0(&quot;CMapiApi::OpenStore failed\n&quot;);</span>
<a href="#l43.280"></a><span id="l43.280">         }</span>
<a href="#l43.281"></a><span id="l43.281">       }</span>
<a href="#l43.282"></a><span id="l43.282">       else {</span>
<a href="#l43.283"></a><span id="l43.283" class="difflineminus">-        IMPORT_LOG0( &quot;Error retrieving the one &amp; only message store\n&quot;);</span>
<a href="#l43.284"></a><span id="l43.284" class="difflineplus">+        IMPORT_LOG0(&quot;Error retrieving the one &amp; only message store\n&quot;);</span>
<a href="#l43.285"></a><span id="l43.285">       }</span>
<a href="#l43.286"></a><span id="l43.286">     }</span>
<a href="#l43.287"></a><span id="l43.287">     else {</span>
<a href="#l43.288"></a><span id="l43.288" class="difflineminus">-      IMPORT_LOG0( &quot;*** Error importing a folder without a valid message store\n&quot;);</span>
<a href="#l43.289"></a><span id="l43.289" class="difflineplus">+      IMPORT_LOG0(&quot;*** Error importing a folder without a valid message store\n&quot;);</span>
<a href="#l43.290"></a><span id="l43.290">     }</span>
<a href="#l43.291"></a><span id="l43.291">   }</span>
<a href="#l43.292"></a><span id="l43.292"> }</span>
<a href="#l43.293"></a><span id="l43.293"> </span>
<a href="#l43.294"></a><span id="l43.294"> // Roles and responsibilities:</span>
<a href="#l43.295"></a><span id="l43.295"> // nsOutlookMail</span>
<a href="#l43.296"></a><span id="l43.296"> //   - Connect to Outlook</span>
<a href="#l43.297"></a><span id="l43.297"> //   - Enumerate the mailboxes</span>
<a href="#l43.298"></a><span id="l43.298" class="difflineat">@@ -361,102 +361,101 @@ void nsOutlookMail::OpenMessageStore( CM</span>
<a href="#l43.299"></a><span id="l43.299"> //   - Perform the composition of the RC822 document from the data gathered by CMapiMessage</span>
<a href="#l43.300"></a><span id="l43.300"> //   - Save the composed message to the TB mailbox</span>
<a href="#l43.301"></a><span id="l43.301"> //   - Ensure the proper cleanup</span>
<a href="#l43.302"></a><span id="l43.302"> //</span>
<a href="#l43.303"></a><span id="l43.303"> // CMapiMessage</span>
<a href="#l43.304"></a><span id="l43.304"> //   - Encapsulate the MAPI message interface</span>
<a href="#l43.305"></a><span id="l43.305"> //   - Gather the information required to (re)compose the message</span>
<a href="#l43.306"></a><span id="l43.306"> </span>
<a href="#l43.307"></a><span id="l43.307" class="difflineminus">-nsresult nsOutlookMail::ImportMailbox( PRUint32 *pDoneSoFar, bool *pAbort, PRInt32 index, const PRUnichar *pName, nsIFile *pDest, PRInt32 *pMsgCount)</span>
<a href="#l43.308"></a><span id="l43.308" class="difflineplus">+nsresult nsOutlookMail::ImportMailbox(PRUint32 *pDoneSoFar, bool *pAbort, PRInt32 index, const PRUnichar *pName, nsIFile *pDest, PRInt32 *pMsgCount)</span>
<a href="#l43.309"></a><span id="l43.309"> {</span>
<a href="#l43.310"></a><span id="l43.310">   if ((index &lt; 0) || (index &gt;= m_folderList.GetSize())) {</span>
<a href="#l43.311"></a><span id="l43.311" class="difflineminus">-    IMPORT_LOG0( &quot;*** Bad mailbox identifier, unable to import\n&quot;);</span>
<a href="#l43.312"></a><span id="l43.312" class="difflineplus">+    IMPORT_LOG0(&quot;*** Bad mailbox identifier, unable to import\n&quot;);</span>
<a href="#l43.313"></a><span id="l43.313">     *pAbort = true;</span>
<a href="#l43.314"></a><span id="l43.314" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l43.315"></a><span id="l43.315" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l43.316"></a><span id="l43.316">   }</span>
<a href="#l43.317"></a><span id="l43.317"> </span>
<a href="#l43.318"></a><span id="l43.318">   PRInt32    dummyMsgCount = 0;</span>
<a href="#l43.319"></a><span id="l43.319">   if (pMsgCount)</span>
<a href="#l43.320"></a><span id="l43.320">     *pMsgCount = 0;</span>
<a href="#l43.321"></a><span id="l43.321">   else</span>
<a href="#l43.322"></a><span id="l43.322">     pMsgCount = &amp;dummyMsgCount;</span>
<a href="#l43.323"></a><span id="l43.323"> </span>
<a href="#l43.324"></a><span id="l43.324" class="difflineminus">-  CMapiFolder *pFolder = m_folderList.GetItem( index);</span>
<a href="#l43.325"></a><span id="l43.325" class="difflineminus">-  OpenMessageStore( pFolder);</span>
<a href="#l43.326"></a><span id="l43.326" class="difflineplus">+  CMapiFolder *pFolder = m_folderList.GetItem(index);</span>
<a href="#l43.327"></a><span id="l43.327" class="difflineplus">+  OpenMessageStore(pFolder);</span>
<a href="#l43.328"></a><span id="l43.328">   if (!m_lpMdb) {</span>
<a href="#l43.329"></a><span id="l43.329" class="difflineminus">-    IMPORT_LOG1( &quot;*** Unable to obtain mapi message store for mailbox: %S\n&quot;, pName);</span>
<a href="#l43.330"></a><span id="l43.330" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l43.331"></a><span id="l43.331" class="difflineplus">+    IMPORT_LOG1(&quot;*** Unable to obtain mapi message store for mailbox: %S\n&quot;, pName);</span>
<a href="#l43.332"></a><span id="l43.332" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l43.333"></a><span id="l43.333">   }</span>
<a href="#l43.334"></a><span id="l43.334"> </span>
<a href="#l43.335"></a><span id="l43.335">   if (pFolder-&gt;IsStore())</span>
<a href="#l43.336"></a><span id="l43.336" class="difflineminus">-    return( NS_OK);</span>
<a href="#l43.337"></a><span id="l43.337" class="difflineplus">+    return NS_OK;</span>
<a href="#l43.338"></a><span id="l43.338"> </span>
<a href="#l43.339"></a><span id="l43.339">   nsresult  rv;</span>
<a href="#l43.340"></a><span id="l43.340"> </span>
<a href="#l43.341"></a><span id="l43.341">   // now what?</span>
<a href="#l43.342"></a><span id="l43.342" class="difflineminus">-  CMapiFolderContents    contents( m_lpMdb, pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID());</span>
<a href="#l43.343"></a><span id="l43.343" class="difflineplus">+  CMapiFolderContents    contents(m_lpMdb, pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID());</span>
<a href="#l43.344"></a><span id="l43.344"> </span>
<a href="#l43.345"></a><span id="l43.345">   BOOL    done = FALSE;</span>
<a href="#l43.346"></a><span id="l43.346">   ULONG    cbEid;</span>
<a href="#l43.347"></a><span id="l43.347">   LPENTRYID  lpEid;</span>
<a href="#l43.348"></a><span id="l43.348">   ULONG    oType;</span>
<a href="#l43.349"></a><span id="l43.349">   LPMESSAGE  lpMsg = nsnull;</span>
<a href="#l43.350"></a><span id="l43.350">   ULONG    totalCount;</span>
<a href="#l43.351"></a><span id="l43.351">   PRFloat64  doneCalc;</span>
<a href="#l43.352"></a><span id="l43.352"> </span>
<a href="#l43.353"></a><span id="l43.353">   nsCOMPtr&lt;nsIOutputStream&gt; destOutputStream;</span>
<a href="#l43.354"></a><span id="l43.354">   rv = MsgNewBufferedFileOutputStream(getter_AddRefs(destOutputStream), pDest, -1, 0600);</span>
<a href="#l43.355"></a><span id="l43.355">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l43.356"></a><span id="l43.356"> </span>
<a href="#l43.357"></a><span id="l43.357">   while (!done) {</span>
<a href="#l43.358"></a><span id="l43.358" class="difflineminus">-    if (!contents.GetNext( &amp;cbEid, &amp;lpEid, &amp;oType, &amp;done)) {</span>
<a href="#l43.359"></a><span id="l43.359" class="difflineminus">-      IMPORT_LOG1( &quot;*** Error iterating mailbox: %S\n&quot;, pName);</span>
<a href="#l43.360"></a><span id="l43.360" class="difflineminus">-      return( NS_ERROR_FAILURE);</span>
<a href="#l43.361"></a><span id="l43.361" class="difflineplus">+    if (!contents.GetNext(&amp;cbEid, &amp;lpEid, &amp;oType, &amp;done)) {</span>
<a href="#l43.362"></a><span id="l43.362" class="difflineplus">+      IMPORT_LOG1(&quot;*** Error iterating mailbox: %S\n&quot;, pName);</span>
<a href="#l43.363"></a><span id="l43.363" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l43.364"></a><span id="l43.364">     }</span>
<a href="#l43.365"></a><span id="l43.365"> </span>
<a href="#l43.366"></a><span id="l43.366">     totalCount = contents.GetCount();</span>
<a href="#l43.367"></a><span id="l43.367">     doneCalc = *pMsgCount;</span>
<a href="#l43.368"></a><span id="l43.368">     doneCalc /= totalCount;</span>
<a href="#l43.369"></a><span id="l43.369">     doneCalc *= 1000;</span>
<a href="#l43.370"></a><span id="l43.370">     if (pDoneSoFar) {</span>
<a href="#l43.371"></a><span id="l43.371">       *pDoneSoFar = (PRUint32) doneCalc;</span>
<a href="#l43.372"></a><span id="l43.372">       if (*pDoneSoFar &gt; 1000)</span>
<a href="#l43.373"></a><span id="l43.373">         *pDoneSoFar = 1000;</span>
<a href="#l43.374"></a><span id="l43.374">     }</span>
<a href="#l43.375"></a><span id="l43.375"> </span>
<a href="#l43.376"></a><span id="l43.376">     if (!done &amp;&amp; (oType == MAPI_MESSAGE)) {</span>
<a href="#l43.377"></a><span id="l43.377" class="difflineminus">-      if (!m_mapi.OpenMdbEntry( m_lpMdb, cbEid, lpEid, (LPUNKNOWN *) &amp;lpMsg)) {</span>
<a href="#l43.378"></a><span id="l43.378" class="difflineminus">-        IMPORT_LOG1( &quot;*** Error opening messages in mailbox: %S\n&quot;, pName);</span>
<a href="#l43.379"></a><span id="l43.379" class="difflineminus">-        return( NS_ERROR_FAILURE);</span>
<a href="#l43.380"></a><span id="l43.380" class="difflineplus">+      if (!m_mapi.OpenMdbEntry(m_lpMdb, cbEid, lpEid, (LPUNKNOWN *) &amp;lpMsg)) {</span>
<a href="#l43.381"></a><span id="l43.381" class="difflineplus">+        IMPORT_LOG1(&quot;*** Error opening messages in mailbox: %S\n&quot;, pName);</span>
<a href="#l43.382"></a><span id="l43.382" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l43.383"></a><span id="l43.383">       }</span>
<a href="#l43.384"></a><span id="l43.384"> </span>
<a href="#l43.385"></a><span id="l43.385">       // See if it's a drafts folder. Outlook doesn't allow drafts</span>
<a href="#l43.386"></a><span id="l43.386">       // folder to be configured so it's ok to hard code it here.</span>
<a href="#l43.387"></a><span id="l43.387">       nsAutoString folderName(pName);</span>
<a href="#l43.388"></a><span id="l43.388">       nsMsgDeliverMode mode = nsIMsgSend::nsMsgDeliverNow;</span>
<a href="#l43.389"></a><span id="l43.389">       mode = nsIMsgSend::nsMsgSaveAsDraft;</span>
<a href="#l43.390"></a><span id="l43.390" class="difflineminus">-      if ( folderName.LowerCaseEqualsLiteral(&quot;drafts&quot;) )</span>
<a href="#l43.391"></a><span id="l43.391" class="difflineplus">+      if (folderName.LowerCaseEqualsLiteral(&quot;drafts&quot;))</span>
<a href="#l43.392"></a><span id="l43.392">         mode = nsIMsgSend::nsMsgSaveAsDraft;</span>
<a href="#l43.393"></a><span id="l43.393"> </span>
<a href="#l43.394"></a><span id="l43.394">       rv = ImportMessage(lpMsg, destOutputStream, mode);</span>
<a href="#l43.395"></a><span id="l43.395" class="difflineminus">-      if (NS_SUCCEEDED( rv)) // No errors &amp; really imported</span>
<a href="#l43.396"></a><span id="l43.396" class="difflineplus">+      if (NS_SUCCEEDED(rv)) // No errors &amp; really imported</span>
<a href="#l43.397"></a><span id="l43.397">         (*pMsgCount)++;</span>
<a href="#l43.398"></a><span id="l43.398" class="difflineminus">-      else {</span>
<a href="#l43.399"></a><span id="l43.399" class="difflineminus">-        IMPORT_LOG1( &quot;*** Error reading message from mailbox: %S\n&quot;, pName);</span>
<a href="#l43.400"></a><span id="l43.400" class="difflineminus">-      }</span>
<a href="#l43.401"></a><span id="l43.401" class="difflineplus">+      else</span>
<a href="#l43.402"></a><span id="l43.402" class="difflineplus">+        IMPORT_LOG1(&quot;*** Error reading message from mailbox: %S\n&quot;, pName);</span>
<a href="#l43.403"></a><span id="l43.403">     }</span>
<a href="#l43.404"></a><span id="l43.404">   }</span>
<a href="#l43.405"></a><span id="l43.405"> </span>
<a href="#l43.406"></a><span id="l43.406" class="difflineminus">-  return( NS_OK);</span>
<a href="#l43.407"></a><span id="l43.407" class="difflineplus">+  return NS_OK;</span>
<a href="#l43.408"></a><span id="l43.408"> }</span>
<a href="#l43.409"></a><span id="l43.409"> </span>
<a href="#l43.410"></a><span id="l43.410" class="difflineminus">-nsresult nsOutlookMail::ImportMessage( LPMESSAGE lpMsg, nsIOutputStream *pDest, nsMsgDeliverMode mode)</span>
<a href="#l43.411"></a><span id="l43.411" class="difflineplus">+nsresult nsOutlookMail::ImportMessage(LPMESSAGE lpMsg, nsIOutputStream *pDest, nsMsgDeliverMode mode)</span>
<a href="#l43.412"></a><span id="l43.412"> {</span>
<a href="#l43.413"></a><span id="l43.413" class="difflineminus">-  CMapiMessage  msg( lpMsg);</span>
<a href="#l43.414"></a><span id="l43.414" class="difflineplus">+  CMapiMessage  msg(lpMsg);</span>
<a href="#l43.415"></a><span id="l43.415">   // If we wanted to skip messages that were downloaded in header only mode, we</span>
<a href="#l43.416"></a><span id="l43.416">   // would return NS_ERROR_FAILURE if !msg.FullMessageDownloaded. However, we</span>
<a href="#l43.417"></a><span id="l43.417">   // don't do this because it may cause seemingly wrong import results.</span>
<a href="#l43.418"></a><span id="l43.418">   // A user will get less mails in his imported folder than were in the original folder,</span>
<a href="#l43.419"></a><span id="l43.419">   // and this may make user feel like TB import is bad.</span>
<a href="#l43.420"></a><span id="l43.420">   // In reality, the skipped messages are those that have not been downloaded yet, because</span>
<a href="#l43.421"></a><span id="l43.421">   // they were downloaded in the &quot;headers-only&quot; mode. This is different from the case when</span>
<a href="#l43.422"></a><span id="l43.422">   // the message is downloaded completely, but consists only of headers - in this case</span>
<a href="#l43.423"></a><span id="l43.423" class="difflineat">@@ -469,147 +468,145 @@ nsresult nsOutlookMail::ImportMessage( L</span>
<a href="#l43.424"></a><span id="l43.424">   // one composer for several messages, the Send Proxy object that is shared between those messages</span>
<a href="#l43.425"></a><span id="l43.425">   // isn't reset properly (at least in the current implementation), which leads to crash.</span>
<a href="#l43.426"></a><span id="l43.426">   // If there's a proper way to reinitialize the Send Proxy object,</span>
<a href="#l43.427"></a><span id="l43.427">   // then we could slightly optimize the send process.</span>
<a href="#l43.428"></a><span id="l43.428">   nsOutlookCompose compose;</span>
<a href="#l43.429"></a><span id="l43.429">   nsresult rv = compose.ProcessMessage(mode, msg, pDest);</span>
<a href="#l43.430"></a><span id="l43.430"> </span>
<a href="#l43.431"></a><span id="l43.431">   // Just for YUCKS, let's try an extra endline</span>
<a href="#l43.432"></a><span id="l43.432" class="difflineminus">-  WriteData( pDest, &quot;\x0D\x0A&quot;, 2);</span>
<a href="#l43.433"></a><span id="l43.433" class="difflineplus">+  WriteData(pDest, &quot;\x0D\x0A&quot;, 2);</span>
<a href="#l43.434"></a><span id="l43.434"> </span>
<a href="#l43.435"></a><span id="l43.435">   return rv;</span>
<a href="#l43.436"></a><span id="l43.436"> }</span>
<a href="#l43.437"></a><span id="l43.437"> </span>
<a href="#l43.438"></a><span id="l43.438" class="difflineminus">-BOOL nsOutlookMail::WriteData( nsIOutputStream *pDest, const char *pData, PRInt32 len)</span>
<a href="#l43.439"></a><span id="l43.439" class="difflineplus">+BOOL nsOutlookMail::WriteData(nsIOutputStream *pDest, const char *pData, PRInt32 len)</span>
<a href="#l43.440"></a><span id="l43.440"> {</span>
<a href="#l43.441"></a><span id="l43.441">   PRUint32    written;</span>
<a href="#l43.442"></a><span id="l43.442" class="difflineminus">-  nsresult rv = pDest-&gt;Write( pData, len, &amp;written);</span>
<a href="#l43.443"></a><span id="l43.443" class="difflineminus">-  if (NS_FAILED( rv) || (written != len))</span>
<a href="#l43.444"></a><span id="l43.444" class="difflineminus">-    return( FALSE);</span>
<a href="#l43.445"></a><span id="l43.445" class="difflineminus">-  return( TRUE);</span>
<a href="#l43.446"></a><span id="l43.446" class="difflineplus">+  nsresult rv = pDest-&gt;Write(pData, len, &amp;written);</span>
<a href="#l43.447"></a><span id="l43.447" class="difflineplus">+  return NS_SUCCEEDED(rv) &amp;&amp; written == len;</span>
<a href="#l43.448"></a><span id="l43.448"> }</span>
<a href="#l43.449"></a><span id="l43.449"> </span>
<a href="#l43.450"></a><span id="l43.450" class="difflineminus">-nsresult nsOutlookMail::ImportAddresses( PRUint32 *pCount, PRUint32 *pTotal, const PRUnichar *pName, PRUint32 id, nsIAddrDatabase *pDb, nsString&amp; errors)</span>
<a href="#l43.451"></a><span id="l43.451" class="difflineplus">+nsresult nsOutlookMail::ImportAddresses(PRUint32 *pCount, PRUint32 *pTotal, const PRUnichar *pName, PRUint32 id, nsIAddrDatabase *pDb, nsString&amp; errors)</span>
<a href="#l43.452"></a><span id="l43.452"> {</span>
<a href="#l43.453"></a><span id="l43.453">   if (id &gt;= (PRUint32)(m_addressList.GetSize())) {</span>
<a href="#l43.454"></a><span id="l43.454" class="difflineminus">-    IMPORT_LOG0( &quot;*** Bad address identifier, unable to import\n&quot;);</span>
<a href="#l43.455"></a><span id="l43.455" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l43.456"></a><span id="l43.456" class="difflineplus">+    IMPORT_LOG0(&quot;*** Bad address identifier, unable to import\n&quot;);</span>
<a href="#l43.457"></a><span id="l43.457" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l43.458"></a><span id="l43.458">   }</span>
<a href="#l43.459"></a><span id="l43.459"> </span>
<a href="#l43.460"></a><span id="l43.460">   PRUint32  dummyCount = 0;</span>
<a href="#l43.461"></a><span id="l43.461">   if (pCount)</span>
<a href="#l43.462"></a><span id="l43.462">     *pCount = 0;</span>
<a href="#l43.463"></a><span id="l43.463">   else</span>
<a href="#l43.464"></a><span id="l43.464">     pCount = &amp;dummyCount;</span>
<a href="#l43.465"></a><span id="l43.465"> </span>
<a href="#l43.466"></a><span id="l43.466">   CMapiFolder *pFolder;</span>
<a href="#l43.467"></a><span id="l43.467">   if (id &gt; 0) {</span>
<a href="#l43.468"></a><span id="l43.468">     PRInt32 idx = (PRInt32) id;</span>
<a href="#l43.469"></a><span id="l43.469">     idx--;</span>
<a href="#l43.470"></a><span id="l43.470">     while (idx &gt;= 0) {</span>
<a href="#l43.471"></a><span id="l43.471" class="difflineminus">-      pFolder = m_addressList.GetItem( idx);</span>
<a href="#l43.472"></a><span id="l43.472" class="difflineplus">+      pFolder = m_addressList.GetItem(idx);</span>
<a href="#l43.473"></a><span id="l43.473">       if (pFolder-&gt;IsStore()) {</span>
<a href="#l43.474"></a><span id="l43.474" class="difflineminus">-        OpenMessageStore( pFolder);</span>
<a href="#l43.475"></a><span id="l43.475" class="difflineplus">+        OpenMessageStore(pFolder);</span>
<a href="#l43.476"></a><span id="l43.476">         break;</span>
<a href="#l43.477"></a><span id="l43.477">       }</span>
<a href="#l43.478"></a><span id="l43.478">       idx--;</span>
<a href="#l43.479"></a><span id="l43.479">     }</span>
<a href="#l43.480"></a><span id="l43.480">   }</span>
<a href="#l43.481"></a><span id="l43.481"> </span>
<a href="#l43.482"></a><span id="l43.482" class="difflineminus">-  pFolder = m_addressList.GetItem( id);</span>
<a href="#l43.483"></a><span id="l43.483" class="difflineminus">-  OpenMessageStore( pFolder);</span>
<a href="#l43.484"></a><span id="l43.484" class="difflineplus">+  pFolder = m_addressList.GetItem(id);</span>
<a href="#l43.485"></a><span id="l43.485" class="difflineplus">+  OpenMessageStore(pFolder);</span>
<a href="#l43.486"></a><span id="l43.486">   if (!m_lpMdb) {</span>
<a href="#l43.487"></a><span id="l43.487" class="difflineminus">-    IMPORT_LOG1( &quot;*** Unable to obtain mapi message store for address book: %S\n&quot;, pName);</span>
<a href="#l43.488"></a><span id="l43.488" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l43.489"></a><span id="l43.489" class="difflineplus">+    IMPORT_LOG1(&quot;*** Unable to obtain mapi message store for address book: %S\n&quot;, pName);</span>
<a href="#l43.490"></a><span id="l43.490" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l43.491"></a><span id="l43.491">   }</span>
<a href="#l43.492"></a><span id="l43.492"> </span>
<a href="#l43.493"></a><span id="l43.493">   if (pFolder-&gt;IsStore())</span>
<a href="#l43.494"></a><span id="l43.494" class="difflineminus">-    return( NS_OK);</span>
<a href="#l43.495"></a><span id="l43.495" class="difflineplus">+    return NS_OK;</span>
<a href="#l43.496"></a><span id="l43.496"> </span>
<a href="#l43.497"></a><span id="l43.497">   nsresult  rv;</span>
<a href="#l43.498"></a><span id="l43.498"> </span>
<a href="#l43.499"></a><span id="l43.499">   nsCOMPtr&lt;nsIImportFieldMap&gt;    pFieldMap;</span>
<a href="#l43.500"></a><span id="l43.500"> </span>
<a href="#l43.501"></a><span id="l43.501">   nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l43.502"></a><span id="l43.502" class="difflineminus">-  if (NS_SUCCEEDED( rv)) {</span>
<a href="#l43.503"></a><span id="l43.503" class="difflineminus">-    rv = impSvc-&gt;CreateNewFieldMap( getter_AddRefs( pFieldMap));</span>
<a href="#l43.504"></a><span id="l43.504" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l43.505"></a><span id="l43.505" class="difflineplus">+    rv = impSvc-&gt;CreateNewFieldMap(getter_AddRefs(pFieldMap));</span>
<a href="#l43.506"></a><span id="l43.506">   }</span>
<a href="#l43.507"></a><span id="l43.507"> </span>
<a href="#l43.508"></a><span id="l43.508" class="difflineminus">-  CMapiFolderContents    contents( m_lpMdb, pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID());</span>
<a href="#l43.509"></a><span id="l43.509" class="difflineplus">+  CMapiFolderContents    contents(m_lpMdb, pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID());</span>
<a href="#l43.510"></a><span id="l43.510"> </span>
<a href="#l43.511"></a><span id="l43.511">   BOOL      done = FALSE;</span>
<a href="#l43.512"></a><span id="l43.512">   ULONG      cbEid;</span>
<a href="#l43.513"></a><span id="l43.513">   LPENTRYID    lpEid;</span>
<a href="#l43.514"></a><span id="l43.514">   ULONG      oType;</span>
<a href="#l43.515"></a><span id="l43.515">   LPMESSAGE    lpMsg;</span>
<a href="#l43.516"></a><span id="l43.516">   nsCString    type;</span>
<a href="#l43.517"></a><span id="l43.517">   LPSPropValue  pVal;</span>
<a href="#l43.518"></a><span id="l43.518">   nsString    subject;</span>
<a href="#l43.519"></a><span id="l43.519"> </span>
<a href="#l43.520"></a><span id="l43.520">   while (!done) {</span>
<a href="#l43.521"></a><span id="l43.521">     (*pCount)++;</span>
<a href="#l43.522"></a><span id="l43.522"> </span>
<a href="#l43.523"></a><span id="l43.523" class="difflineminus">-    if (!contents.GetNext( &amp;cbEid, &amp;lpEid, &amp;oType, &amp;done)) {</span>
<a href="#l43.524"></a><span id="l43.524" class="difflineminus">-      IMPORT_LOG1( &quot;*** Error iterating address book: %S\n&quot;, pName);</span>
<a href="#l43.525"></a><span id="l43.525" class="difflineminus">-      return( NS_ERROR_FAILURE);</span>
<a href="#l43.526"></a><span id="l43.526" class="difflineplus">+    if (!contents.GetNext(&amp;cbEid, &amp;lpEid, &amp;oType, &amp;done)) {</span>
<a href="#l43.527"></a><span id="l43.527" class="difflineplus">+      IMPORT_LOG1(&quot;*** Error iterating address book: %S\n&quot;, pName);</span>
<a href="#l43.528"></a><span id="l43.528" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l43.529"></a><span id="l43.529">     }</span>
<a href="#l43.530"></a><span id="l43.530"> </span>
<a href="#l43.531"></a><span id="l43.531">     if (pTotal &amp;&amp; (*pTotal == 0))</span>
<a href="#l43.532"></a><span id="l43.532">       *pTotal = contents.GetCount();</span>
<a href="#l43.533"></a><span id="l43.533"> </span>
<a href="#l43.534"></a><span id="l43.534">     if (!done &amp;&amp; (oType == MAPI_MESSAGE)) {</span>
<a href="#l43.535"></a><span id="l43.535" class="difflineminus">-      if (!m_mapi.OpenMdbEntry( m_lpMdb, cbEid, lpEid, (LPUNKNOWN *) &amp;lpMsg)) {</span>
<a href="#l43.536"></a><span id="l43.536" class="difflineminus">-        IMPORT_LOG1( &quot;*** Error opening messages in mailbox: %S\n&quot;, pName);</span>
<a href="#l43.537"></a><span id="l43.537" class="difflineminus">-        return( NS_ERROR_FAILURE);</span>
<a href="#l43.538"></a><span id="l43.538" class="difflineplus">+      if (!m_mapi.OpenMdbEntry(m_lpMdb, cbEid, lpEid, (LPUNKNOWN *) &amp;lpMsg)) {</span>
<a href="#l43.539"></a><span id="l43.539" class="difflineplus">+        IMPORT_LOG1(&quot;*** Error opening messages in mailbox: %S\n&quot;, pName);</span>
<a href="#l43.540"></a><span id="l43.540" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l43.541"></a><span id="l43.541">       }</span>
<a href="#l43.542"></a><span id="l43.542"> </span>
<a href="#l43.543"></a><span id="l43.543">       // Get the PR_MESSAGE_CLASS attribute,</span>
<a href="#l43.544"></a><span id="l43.544">       // ensure that it is IPM.Contact</span>
<a href="#l43.545"></a><span id="l43.545" class="difflineminus">-      pVal = m_mapi.GetMapiProperty( lpMsg, PR_MESSAGE_CLASS);</span>
<a href="#l43.546"></a><span id="l43.546" class="difflineplus">+      pVal = m_mapi.GetMapiProperty(lpMsg, PR_MESSAGE_CLASS);</span>
<a href="#l43.547"></a><span id="l43.547">       if (pVal) {</span>
<a href="#l43.548"></a><span id="l43.548">         type.Truncate();</span>
<a href="#l43.549"></a><span id="l43.549" class="difflineminus">-        m_mapi.GetStringFromProp( pVal, type);</span>
<a href="#l43.550"></a><span id="l43.550" class="difflineplus">+        m_mapi.GetStringFromProp(pVal, type);</span>
<a href="#l43.551"></a><span id="l43.551">         if (type.EqualsLiteral(&quot;IPM.Contact&quot;)) {</span>
<a href="#l43.552"></a><span id="l43.552">           // This is a contact, add it to the address book!</span>
<a href="#l43.553"></a><span id="l43.553">           subject.Truncate();</span>
<a href="#l43.554"></a><span id="l43.554" class="difflineminus">-          pVal = m_mapi.GetMapiProperty( lpMsg, PR_SUBJECT);</span>
<a href="#l43.555"></a><span id="l43.555" class="difflineplus">+          pVal = m_mapi.GetMapiProperty(lpMsg, PR_SUBJECT);</span>
<a href="#l43.556"></a><span id="l43.556">           if (pVal)</span>
<a href="#l43.557"></a><span id="l43.557" class="difflineminus">-            m_mapi.GetStringFromProp( pVal, subject);</span>
<a href="#l43.558"></a><span id="l43.558" class="difflineplus">+            m_mapi.GetStringFromProp(pVal, subject);</span>
<a href="#l43.559"></a><span id="l43.559"> </span>
<a href="#l43.560"></a><span id="l43.560">           nsIMdbRow* newRow = nsnull;</span>
<a href="#l43.561"></a><span id="l43.561" class="difflineminus">-          pDb-&gt;GetNewRow( &amp;newRow);</span>
<a href="#l43.562"></a><span id="l43.562" class="difflineplus">+          pDb-&gt;GetNewRow(&amp;newRow);</span>
<a href="#l43.563"></a><span id="l43.563">           // FIXME: Check with Candice about releasing the newRow if it</span>
<a href="#l43.564"></a><span id="l43.564">           // isn't added to the database.  Candice's code in nsAddressBook</span>
<a href="#l43.565"></a><span id="l43.565">           // never releases it but that doesn't seem right to me!</span>
<a href="#l43.566"></a><span id="l43.566">           if (newRow) {</span>
<a href="#l43.567"></a><span id="l43.567" class="difflineminus">-            if (BuildCard( subject.get(), pDb, newRow, lpMsg, pFieldMap)) {</span>
<a href="#l43.568"></a><span id="l43.568" class="difflineminus">-              pDb-&gt;AddCardRowToDB( newRow);</span>
<a href="#l43.569"></a><span id="l43.569" class="difflineplus">+            if (BuildCard(subject.get(), pDb, newRow, lpMsg, pFieldMap)) {</span>
<a href="#l43.570"></a><span id="l43.570" class="difflineplus">+              pDb-&gt;AddCardRowToDB(newRow);</span>
<a href="#l43.571"></a><span id="l43.571">             }</span>
<a href="#l43.572"></a><span id="l43.572">           }</span>
<a href="#l43.573"></a><span id="l43.573">         }</span>
<a href="#l43.574"></a><span id="l43.574">         else if (type.EqualsLiteral(&quot;IPM.DistList&quot;))</span>
<a href="#l43.575"></a><span id="l43.575">         {</span>
<a href="#l43.576"></a><span id="l43.576">           // This is a list/group, add it to the address book!</span>
<a href="#l43.577"></a><span id="l43.577">           subject.Truncate();</span>
<a href="#l43.578"></a><span id="l43.578" class="difflineminus">-          pVal = m_mapi.GetMapiProperty( lpMsg, PR_SUBJECT);</span>
<a href="#l43.579"></a><span id="l43.579" class="difflineplus">+          pVal = m_mapi.GetMapiProperty(lpMsg, PR_SUBJECT);</span>
<a href="#l43.580"></a><span id="l43.580">           if (pVal)</span>
<a href="#l43.581"></a><span id="l43.581" class="difflineminus">-            m_mapi.GetStringFromProp( pVal, subject);</span>
<a href="#l43.582"></a><span id="l43.582" class="difflineplus">+            m_mapi.GetStringFromProp(pVal, subject);</span>
<a href="#l43.583"></a><span id="l43.583">           CreateList(subject.get(), pDb, lpMsg, pFieldMap);</span>
<a href="#l43.584"></a><span id="l43.584">         }</span>
<a href="#l43.585"></a><span id="l43.585">       }</span>
<a href="#l43.586"></a><span id="l43.586"> </span>
<a href="#l43.587"></a><span id="l43.587">       lpMsg-&gt;Release();</span>
<a href="#l43.588"></a><span id="l43.588">     }</span>
<a href="#l43.589"></a><span id="l43.589">   }</span>
<a href="#l43.590"></a><span id="l43.590"> </span>
<a href="#l43.591"></a><span id="l43.591">   rv = pDb-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l43.592"></a><span id="l43.592">   return rv;</span>
<a href="#l43.593"></a><span id="l43.593"> }</span>
<a href="#l43.594"></a><span id="l43.594" class="difflineminus">-nsresult nsOutlookMail::CreateList( const PRUnichar * pName,</span>
<a href="#l43.595"></a><span id="l43.595" class="difflineplus">+nsresult nsOutlookMail::CreateList(const PRUnichar * pName,</span>
<a href="#l43.596"></a><span id="l43.596">                                    nsIAddrDatabase *pDb,</span>
<a href="#l43.597"></a><span id="l43.597">                                    LPMAPIPROP pUserList,</span>
<a href="#l43.598"></a><span id="l43.598">                                    nsIImportFieldMap *pFieldMap)</span>
<a href="#l43.599"></a><span id="l43.599"> {</span>
<a href="#l43.600"></a><span id="l43.600">   // If no name provided then we're done.</span>
<a href="#l43.601"></a><span id="l43.601">   if (!pName || !(*pName))</span>
<a href="#l43.602"></a><span id="l43.602">     return NS_OK;</span>
<a href="#l43.603"></a><span id="l43.603"> </span>
<a href="#l43.604"></a><span id="l43.604" class="difflineat">@@ -662,49 +659,45 @@ nsresult nsOutlookMail::CreateList( cons</span>
<a href="#l43.605"></a><span id="l43.605">   for (idx = 0; idx &lt; sa-&gt;cValues; idx++)</span>
<a href="#l43.606"></a><span id="l43.606">   {</span>
<a href="#l43.607"></a><span id="l43.607">     lpEid= (LPENTRYID) sa-&gt;lpbin[idx].lpb;</span>
<a href="#l43.608"></a><span id="l43.608">     cbEid = sa-&gt;lpbin[idx].cb;</span>
<a href="#l43.609"></a><span id="l43.609"> </span>
<a href="#l43.610"></a><span id="l43.610">     if (!m_mapi.OpenEntry(cbEid, lpEid, (LPUNKNOWN *) &amp;lpMsg))</span>
<a href="#l43.611"></a><span id="l43.611">     {</span>
<a href="#l43.612"></a><span id="l43.612"> </span>
<a href="#l43.613"></a><span id="l43.613" class="difflineminus">-      IMPORT_LOG1( &quot;*** Error opening messages in mailbox: %S\n&quot;, pName);</span>
<a href="#l43.614"></a><span id="l43.614" class="difflineplus">+      IMPORT_LOG1(&quot;*** Error opening messages in mailbox: %S\n&quot;, pName);</span>
<a href="#l43.615"></a><span id="l43.615">       m_mapi.MAPIFreeBuffer(value);</span>
<a href="#l43.616"></a><span id="l43.616" class="difflineminus">-      return( NS_ERROR_FAILURE);</span>
<a href="#l43.617"></a><span id="l43.617" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l43.618"></a><span id="l43.618">     }</span>
<a href="#l43.619"></a><span id="l43.619">     // This is a contact, add it to the address book!</span>
<a href="#l43.620"></a><span id="l43.620">     subject.Truncate();</span>
<a href="#l43.621"></a><span id="l43.621" class="difflineminus">-    pVal = m_mapi.GetMapiProperty( lpMsg, PR_SUBJECT);</span>
<a href="#l43.622"></a><span id="l43.622" class="difflineplus">+    pVal = m_mapi.GetMapiProperty(lpMsg, PR_SUBJECT);</span>
<a href="#l43.623"></a><span id="l43.623">     if (pVal)</span>
<a href="#l43.624"></a><span id="l43.624" class="difflineminus">-      m_mapi.GetStringFromProp( pVal, subject);</span>
<a href="#l43.625"></a><span id="l43.625" class="difflineplus">+      m_mapi.GetStringFromProp(pVal, subject);</span>
<a href="#l43.626"></a><span id="l43.626"> </span>
<a href="#l43.627"></a><span id="l43.627">     nsCOMPtr &lt;nsIMdbRow&gt; newRow;</span>
<a href="#l43.628"></a><span id="l43.628">     nsCOMPtr &lt;nsIMdbRow&gt; oldRow;</span>
<a href="#l43.629"></a><span id="l43.629" class="difflineminus">-    pDb-&gt;GetNewRow( getter_AddRefs(newRow));</span>
<a href="#l43.630"></a><span id="l43.630" class="difflineplus">+    pDb-&gt;GetNewRow(getter_AddRefs(newRow));</span>
<a href="#l43.631"></a><span id="l43.631">     if (newRow) {</span>
<a href="#l43.632"></a><span id="l43.632" class="difflineminus">-      if (BuildCard( subject.get(), pDb, newRow, lpMsg, pFieldMap))</span>
<a href="#l43.633"></a><span id="l43.633" class="difflineplus">+      if (BuildCard(subject.get(), pDb, newRow, lpMsg, pFieldMap))</span>
<a href="#l43.634"></a><span id="l43.634">       {</span>
<a href="#l43.635"></a><span id="l43.635">         nsCOMPtr &lt;nsIAbCard&gt; userCard;</span>
<a href="#l43.636"></a><span id="l43.636">         nsCOMPtr &lt;nsIAbCard&gt; newCard;</span>
<a href="#l43.637"></a><span id="l43.637">         userCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l43.638"></a><span id="l43.638">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l43.639"></a><span id="l43.639">         pDb-&gt;InitCardFromRow(userCard,newRow);</span>
<a href="#l43.640"></a><span id="l43.640"> </span>
<a href="#l43.641"></a><span id="l43.641">         //add card to db</span>
<a href="#l43.642"></a><span id="l43.642">         bool bl=false;</span>
<a href="#l43.643"></a><span id="l43.643">         pDb-&gt;FindRowByCard(userCard,getter_AddRefs(oldRow));</span>
<a href="#l43.644"></a><span id="l43.644">         if (oldRow)</span>
<a href="#l43.645"></a><span id="l43.645" class="difflineminus">-        {</span>
<a href="#l43.646"></a><span id="l43.646">           newRow = oldRow;</span>
<a href="#l43.647"></a><span id="l43.647" class="difflineminus">-        }</span>
<a href="#l43.648"></a><span id="l43.648">         else</span>
<a href="#l43.649"></a><span id="l43.649" class="difflineminus">-        {</span>
<a href="#l43.650"></a><span id="l43.650" class="difflineminus">-          pDb-&gt;AddCardRowToDB( newRow);</span>
<a href="#l43.651"></a><span id="l43.651" class="difflineminus">-        }</span>
<a href="#l43.652"></a><span id="l43.652" class="difflineplus">+          pDb-&gt;AddCardRowToDB(newRow);</span>
<a href="#l43.653"></a><span id="l43.653"> </span>
<a href="#l43.654"></a><span id="l43.654">         //add card list</span>
<a href="#l43.655"></a><span id="l43.655">         pDb-&gt;AddListCardColumnsToRow(userCard,</span>
<a href="#l43.656"></a><span id="l43.656">                                      newListRow,idx+1, getter_AddRefs(newCard),</span>
<a href="#l43.657"></a><span id="l43.657">                                      true, nsnull, nsnull);</span>
<a href="#l43.658"></a><span id="l43.658">       }</span>
<a href="#l43.659"></a><span id="l43.659">     }</span>
<a href="#l43.660"></a><span id="l43.660">   }</span>
<a href="#l43.661"></a><span id="l43.661" class="difflineat">@@ -713,166 +706,166 @@ nsresult nsOutlookMail::CreateList( cons</span>
<a href="#l43.662"></a><span id="l43.662">   rv = pDb-&gt;AddCardRowToDB(newListRow);</span>
<a href="#l43.663"></a><span id="l43.663">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l43.664"></a><span id="l43.664"> </span>
<a href="#l43.665"></a><span id="l43.665">   rv = pDb-&gt;SetListAddressTotal(newListRow, total);</span>
<a href="#l43.666"></a><span id="l43.666">   rv = pDb-&gt;AddListDirNode(newListRow);</span>
<a href="#l43.667"></a><span id="l43.667">   return rv;</span>
<a href="#l43.668"></a><span id="l43.668"> }</span>
<a href="#l43.669"></a><span id="l43.669"> </span>
<a href="#l43.670"></a><span id="l43.670" class="difflineminus">-void nsOutlookMail::SanitizeValue( nsString&amp; val)</span>
<a href="#l43.671"></a><span id="l43.671" class="difflineplus">+void nsOutlookMail::SanitizeValue(nsString&amp; val)</span>
<a href="#l43.672"></a><span id="l43.672"> {</span>
<a href="#l43.673"></a><span id="l43.673">   MsgReplaceSubstring(val, NS_LITERAL_STRING(&quot;\r\n&quot;), NS_LITERAL_STRING(&quot;, &quot;));</span>
<a href="#l43.674"></a><span id="l43.674">   MsgReplaceChar(val, &quot;\r\n&quot;, ',');</span>
<a href="#l43.675"></a><span id="l43.675"> }</span>
<a href="#l43.676"></a><span id="l43.676"> </span>
<a href="#l43.677"></a><span id="l43.677" class="difflineminus">-void nsOutlookMail::SplitString( nsString&amp; val1, nsString&amp; val2)</span>
<a href="#l43.678"></a><span id="l43.678" class="difflineplus">+void nsOutlookMail::SplitString(nsString&amp; val1, nsString&amp; val2)</span>
<a href="#l43.679"></a><span id="l43.679"> {</span>
<a href="#l43.680"></a><span id="l43.680">   // Find the last line if there is more than one!</span>
<a href="#l43.681"></a><span id="l43.681" class="difflineminus">-  PRInt32 idx = val1.RFind( &quot;\x0D\x0A&quot;);</span>
<a href="#l43.682"></a><span id="l43.682" class="difflineplus">+  PRInt32 idx = val1.RFind(&quot;\x0D\x0A&quot;);</span>
<a href="#l43.683"></a><span id="l43.683">   PRInt32  cnt = 2;</span>
<a href="#l43.684"></a><span id="l43.684">   if (idx == -1) {</span>
<a href="#l43.685"></a><span id="l43.685">     cnt = 1;</span>
<a href="#l43.686"></a><span id="l43.686" class="difflineminus">-    idx = val1.RFindChar( 13);</span>
<a href="#l43.687"></a><span id="l43.687" class="difflineplus">+    idx = val1.RFindChar(13);</span>
<a href="#l43.688"></a><span id="l43.688">   }</span>
<a href="#l43.689"></a><span id="l43.689">   if (idx == -1)</span>
<a href="#l43.690"></a><span id="l43.690" class="difflineminus">-    idx= val1.RFindChar( 10);</span>
<a href="#l43.691"></a><span id="l43.691" class="difflineplus">+    idx= val1.RFindChar(10);</span>
<a href="#l43.692"></a><span id="l43.692">   if (idx != -1) {</span>
<a href="#l43.693"></a><span id="l43.693">     val2 = Substring(val1, idx + cnt);</span>
<a href="#l43.694"></a><span id="l43.694">     val1.SetLength(idx);</span>
<a href="#l43.695"></a><span id="l43.695" class="difflineminus">-    SanitizeValue( val1);</span>
<a href="#l43.696"></a><span id="l43.696" class="difflineplus">+    SanitizeValue(val1);</span>
<a href="#l43.697"></a><span id="l43.697">   }</span>
<a href="#l43.698"></a><span id="l43.698"> }</span>
<a href="#l43.699"></a><span id="l43.699"> </span>
<a href="#l43.700"></a><span id="l43.700" class="difflineminus">-bool nsOutlookMail::BuildCard( const PRUnichar *pName, nsIAddrDatabase *pDb, nsIMdbRow *newRow, LPMAPIPROP pUser, nsIImportFieldMap *pFieldMap)</span>
<a href="#l43.701"></a><span id="l43.701" class="difflineplus">+bool nsOutlookMail::BuildCard(const PRUnichar *pName, nsIAddrDatabase *pDb, nsIMdbRow *newRow, LPMAPIPROP pUser, nsIImportFieldMap *pFieldMap)</span>
<a href="#l43.702"></a><span id="l43.702"> {</span>
<a href="#l43.703"></a><span id="l43.703"> </span>
<a href="#l43.704"></a><span id="l43.704">   nsString    lastName;</span>
<a href="#l43.705"></a><span id="l43.705">   nsString    firstName;</span>
<a href="#l43.706"></a><span id="l43.706">   nsString    eMail;</span>
<a href="#l43.707"></a><span id="l43.707">   nsString    nickName;</span>
<a href="#l43.708"></a><span id="l43.708">   nsString    middleName;</span>
<a href="#l43.709"></a><span id="l43.709">   nsString    secondEMail;</span>
<a href="#l43.710"></a><span id="l43.710">   ULONG       emailTag;</span>
<a href="#l43.711"></a><span id="l43.711"> </span>
<a href="#l43.712"></a><span id="l43.712" class="difflineminus">-  LPSPropValue  pProp = m_mapi.GetMapiProperty( pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l43.713"></a><span id="l43.713" class="difflineplus">+  LPSPropValue  pProp = m_mapi.GetMapiProperty(pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l43.714"></a><span id="l43.714">   if (!pProp) {</span>
<a href="#l43.715"></a><span id="l43.715">     emailTag = m_mapi.GetEmailPropertyTag(pUser, OUTLOOK_EMAIL1_MAPI_ID1);</span>
<a href="#l43.716"></a><span id="l43.716">     if (emailTag) {</span>
<a href="#l43.717"></a><span id="l43.717" class="difflineminus">-      pProp = m_mapi.GetMapiProperty( pUser, emailTag);</span>
<a href="#l43.718"></a><span id="l43.718" class="difflineplus">+      pProp = m_mapi.GetMapiProperty(pUser, emailTag);</span>
<a href="#l43.719"></a><span id="l43.719">     }</span>
<a href="#l43.720"></a><span id="l43.720">   }</span>
<a href="#l43.721"></a><span id="l43.721">   if (pProp) {</span>
<a href="#l43.722"></a><span id="l43.722" class="difflineminus">-    m_mapi.GetStringFromProp( pProp, eMail);</span>
<a href="#l43.723"></a><span id="l43.723" class="difflineminus">-    SanitizeValue( eMail);</span>
<a href="#l43.724"></a><span id="l43.724" class="difflineplus">+    m_mapi.GetStringFromProp(pProp, eMail);</span>
<a href="#l43.725"></a><span id="l43.725" class="difflineplus">+    SanitizeValue(eMail);</span>
<a href="#l43.726"></a><span id="l43.726">   }</span>
<a href="#l43.727"></a><span id="l43.727"> </span>
<a href="#l43.728"></a><span id="l43.728">   // for secondary email</span>
<a href="#l43.729"></a><span id="l43.729">   emailTag = m_mapi.GetEmailPropertyTag(pUser, OUTLOOK_EMAIL2_MAPI_ID1);</span>
<a href="#l43.730"></a><span id="l43.730">   if (emailTag) {</span>
<a href="#l43.731"></a><span id="l43.731" class="difflineminus">-    pProp = m_mapi.GetMapiProperty( pUser, emailTag);</span>
<a href="#l43.732"></a><span id="l43.732" class="difflineplus">+    pProp = m_mapi.GetMapiProperty(pUser, emailTag);</span>
<a href="#l43.733"></a><span id="l43.733">     if (pProp) {</span>
<a href="#l43.734"></a><span id="l43.734" class="difflineminus">-      m_mapi.GetStringFromProp( pProp, secondEMail);</span>
<a href="#l43.735"></a><span id="l43.735" class="difflineminus">-      SanitizeValue( secondEMail);</span>
<a href="#l43.736"></a><span id="l43.736" class="difflineplus">+      m_mapi.GetStringFromProp(pProp, secondEMail);</span>
<a href="#l43.737"></a><span id="l43.737" class="difflineplus">+      SanitizeValue(secondEMail);</span>
<a href="#l43.738"></a><span id="l43.738">     }</span>
<a href="#l43.739"></a><span id="l43.739">   }</span>
<a href="#l43.740"></a><span id="l43.740"> </span>
<a href="#l43.741"></a><span id="l43.741" class="difflineminus">-  pProp = m_mapi.GetMapiProperty( pUser, PR_GIVEN_NAME);</span>
<a href="#l43.742"></a><span id="l43.742" class="difflineplus">+  pProp = m_mapi.GetMapiProperty(pUser, PR_GIVEN_NAME);</span>
<a href="#l43.743"></a><span id="l43.743">   if (pProp) {</span>
<a href="#l43.744"></a><span id="l43.744" class="difflineminus">-    m_mapi.GetStringFromProp( pProp, firstName);</span>
<a href="#l43.745"></a><span id="l43.745" class="difflineminus">-    SanitizeValue( firstName);</span>
<a href="#l43.746"></a><span id="l43.746" class="difflineplus">+    m_mapi.GetStringFromProp(pProp, firstName);</span>
<a href="#l43.747"></a><span id="l43.747" class="difflineplus">+    SanitizeValue(firstName);</span>
<a href="#l43.748"></a><span id="l43.748">   }</span>
<a href="#l43.749"></a><span id="l43.749" class="difflineminus">-  pProp = m_mapi.GetMapiProperty( pUser, PR_SURNAME);</span>
<a href="#l43.750"></a><span id="l43.750" class="difflineplus">+  pProp = m_mapi.GetMapiProperty(pUser, PR_SURNAME);</span>
<a href="#l43.751"></a><span id="l43.751">   if (pProp) {</span>
<a href="#l43.752"></a><span id="l43.752" class="difflineminus">-    m_mapi.GetStringFromProp( pProp, lastName);</span>
<a href="#l43.753"></a><span id="l43.753" class="difflineminus">-    SanitizeValue( lastName);</span>
<a href="#l43.754"></a><span id="l43.754" class="difflineplus">+    m_mapi.GetStringFromProp(pProp, lastName);</span>
<a href="#l43.755"></a><span id="l43.755" class="difflineplus">+    SanitizeValue(lastName);</span>
<a href="#l43.756"></a><span id="l43.756">   }</span>
<a href="#l43.757"></a><span id="l43.757" class="difflineminus">-  pProp = m_mapi.GetMapiProperty( pUser, PR_MIDDLE_NAME);</span>
<a href="#l43.758"></a><span id="l43.758" class="difflineplus">+  pProp = m_mapi.GetMapiProperty(pUser, PR_MIDDLE_NAME);</span>
<a href="#l43.759"></a><span id="l43.759">   if (pProp) {</span>
<a href="#l43.760"></a><span id="l43.760" class="difflineminus">-    m_mapi.GetStringFromProp( pProp, middleName);</span>
<a href="#l43.761"></a><span id="l43.761" class="difflineminus">-    SanitizeValue( middleName);</span>
<a href="#l43.762"></a><span id="l43.762" class="difflineplus">+    m_mapi.GetStringFromProp(pProp, middleName);</span>
<a href="#l43.763"></a><span id="l43.763" class="difflineplus">+    SanitizeValue(middleName);</span>
<a href="#l43.764"></a><span id="l43.764">   }</span>
<a href="#l43.765"></a><span id="l43.765" class="difflineminus">-  pProp = m_mapi.GetMapiProperty( pUser, PR_NICKNAME);</span>
<a href="#l43.766"></a><span id="l43.766" class="difflineplus">+  pProp = m_mapi.GetMapiProperty(pUser, PR_NICKNAME);</span>
<a href="#l43.767"></a><span id="l43.767">   if (pProp) {</span>
<a href="#l43.768"></a><span id="l43.768" class="difflineminus">-    m_mapi.GetStringFromProp( pProp, nickName);</span>
<a href="#l43.769"></a><span id="l43.769" class="difflineminus">-    SanitizeValue( nickName);</span>
<a href="#l43.770"></a><span id="l43.770" class="difflineplus">+    m_mapi.GetStringFromProp(pProp, nickName);</span>
<a href="#l43.771"></a><span id="l43.771" class="difflineplus">+    SanitizeValue(nickName);</span>
<a href="#l43.772"></a><span id="l43.772">   }</span>
<a href="#l43.773"></a><span id="l43.773">   if (firstName.IsEmpty() &amp;&amp; lastName.IsEmpty()) {</span>
<a href="#l43.774"></a><span id="l43.774">     firstName = pName;</span>
<a href="#l43.775"></a><span id="l43.775">   }</span>
<a href="#l43.776"></a><span id="l43.776"> </span>
<a href="#l43.777"></a><span id="l43.777">   nsString  displayName;</span>
<a href="#l43.778"></a><span id="l43.778" class="difflineminus">-  pProp = m_mapi.GetMapiProperty( pUser, PR_DISPLAY_NAME);</span>
<a href="#l43.779"></a><span id="l43.779" class="difflineplus">+  pProp = m_mapi.GetMapiProperty(pUser, PR_DISPLAY_NAME);</span>
<a href="#l43.780"></a><span id="l43.780">   if (pProp) {</span>
<a href="#l43.781"></a><span id="l43.781" class="difflineminus">-    m_mapi.GetStringFromProp( pProp, displayName);</span>
<a href="#l43.782"></a><span id="l43.782" class="difflineminus">-    SanitizeValue( displayName);</span>
<a href="#l43.783"></a><span id="l43.783" class="difflineplus">+    m_mapi.GetStringFromProp(pProp, displayName);</span>
<a href="#l43.784"></a><span id="l43.784" class="difflineplus">+    SanitizeValue(displayName);</span>
<a href="#l43.785"></a><span id="l43.785">   }</span>
<a href="#l43.786"></a><span id="l43.786">   if (displayName.IsEmpty()) {</span>
<a href="#l43.787"></a><span id="l43.787">     if (firstName.IsEmpty())</span>
<a href="#l43.788"></a><span id="l43.788">       displayName = pName;</span>
<a href="#l43.789"></a><span id="l43.789">     else {</span>
<a href="#l43.790"></a><span id="l43.790">       displayName = firstName;</span>
<a href="#l43.791"></a><span id="l43.791">       if (!middleName.IsEmpty()) {</span>
<a href="#l43.792"></a><span id="l43.792" class="difflineminus">-        displayName.Append( PRUnichar(' '));</span>
<a href="#l43.793"></a><span id="l43.793" class="difflineminus">-        displayName.Append( middleName);</span>
<a href="#l43.794"></a><span id="l43.794" class="difflineplus">+        displayName.Append(PRUnichar(' '));</span>
<a href="#l43.795"></a><span id="l43.795" class="difflineplus">+        displayName.Append(middleName);</span>
<a href="#l43.796"></a><span id="l43.796">       }</span>
<a href="#l43.797"></a><span id="l43.797">       if (!lastName.IsEmpty()) {</span>
<a href="#l43.798"></a><span id="l43.798" class="difflineminus">-        displayName.Append( PRUnichar(' '));</span>
<a href="#l43.799"></a><span id="l43.799" class="difflineminus">-        displayName.Append( lastName);</span>
<a href="#l43.800"></a><span id="l43.800" class="difflineplus">+        displayName.Append(PRUnichar(' '));</span>
<a href="#l43.801"></a><span id="l43.801" class="difflineplus">+        displayName.Append(lastName);</span>
<a href="#l43.802"></a><span id="l43.802">       }</span>
<a href="#l43.803"></a><span id="l43.803">     }</span>
<a href="#l43.804"></a><span id="l43.804">   }</span>
<a href="#l43.805"></a><span id="l43.805"> </span>
<a href="#l43.806"></a><span id="l43.806">   // We now have the required fields</span>
<a href="#l43.807"></a><span id="l43.807">   // write them out followed by any optional fields!</span>
<a href="#l43.808"></a><span id="l43.808">   if (!displayName.IsEmpty()) {</span>
<a href="#l43.809"></a><span id="l43.809" class="difflineminus">-    pDb-&gt;AddDisplayName( newRow, NS_ConvertUTF16toUTF8(displayName).get());</span>
<a href="#l43.810"></a><span id="l43.810" class="difflineplus">+    pDb-&gt;AddDisplayName(newRow, NS_ConvertUTF16toUTF8(displayName).get());</span>
<a href="#l43.811"></a><span id="l43.811">   }</span>
<a href="#l43.812"></a><span id="l43.812">   if (!firstName.IsEmpty()) {</span>
<a href="#l43.813"></a><span id="l43.813" class="difflineminus">-    pDb-&gt;AddFirstName( newRow, NS_ConvertUTF16toUTF8(firstName).get());</span>
<a href="#l43.814"></a><span id="l43.814" class="difflineplus">+    pDb-&gt;AddFirstName(newRow, NS_ConvertUTF16toUTF8(firstName).get());</span>
<a href="#l43.815"></a><span id="l43.815">   }</span>
<a href="#l43.816"></a><span id="l43.816">   if (!lastName.IsEmpty()) {</span>
<a href="#l43.817"></a><span id="l43.817" class="difflineminus">-    pDb-&gt;AddLastName( newRow, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l43.818"></a><span id="l43.818" class="difflineplus">+    pDb-&gt;AddLastName(newRow, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l43.819"></a><span id="l43.819">   }</span>
<a href="#l43.820"></a><span id="l43.820">   if (!nickName.IsEmpty()) {</span>
<a href="#l43.821"></a><span id="l43.821" class="difflineminus">-    pDb-&gt;AddNickName( newRow, NS_ConvertUTF16toUTF8(nickName).get());</span>
<a href="#l43.822"></a><span id="l43.822" class="difflineplus">+    pDb-&gt;AddNickName(newRow, NS_ConvertUTF16toUTF8(nickName).get());</span>
<a href="#l43.823"></a><span id="l43.823">   }</span>
<a href="#l43.824"></a><span id="l43.824">   if (!eMail.IsEmpty()) {</span>
<a href="#l43.825"></a><span id="l43.825" class="difflineminus">-    pDb-&gt;AddPrimaryEmail( newRow, NS_ConvertUTF16toUTF8(eMail).get());</span>
<a href="#l43.826"></a><span id="l43.826" class="difflineplus">+    pDb-&gt;AddPrimaryEmail(newRow, NS_ConvertUTF16toUTF8(eMail).get());</span>
<a href="#l43.827"></a><span id="l43.827">   }</span>
<a href="#l43.828"></a><span id="l43.828">   if (!secondEMail.IsEmpty()) {</span>
<a href="#l43.829"></a><span id="l43.829" class="difflineminus">-    pDb-&gt;Add2ndEmail( newRow, NS_ConvertUTF16toUTF8(secondEMail).get());</span>
<a href="#l43.830"></a><span id="l43.830" class="difflineplus">+    pDb-&gt;Add2ndEmail(newRow, NS_ConvertUTF16toUTF8(secondEMail).get());</span>
<a href="#l43.831"></a><span id="l43.831">   }</span>
<a href="#l43.832"></a><span id="l43.832"> </span>
<a href="#l43.833"></a><span id="l43.833">   // Do all of the extra fields!</span>
<a href="#l43.834"></a><span id="l43.834"> </span>
<a href="#l43.835"></a><span id="l43.835">   nsString  value;</span>
<a href="#l43.836"></a><span id="l43.836">   nsString  line2;</span>
<a href="#l43.837"></a><span id="l43.837"> </span>
<a href="#l43.838"></a><span id="l43.838">   if (pFieldMap) {</span>
<a href="#l43.839"></a><span id="l43.839" class="difflineminus">-    int max = sizeof( gMapiFields) / sizeof( MAPIFields);</span>
<a href="#l43.840"></a><span id="l43.840" class="difflineplus">+    int max = sizeof(gMapiFields) / sizeof(MAPIFields);</span>
<a href="#l43.841"></a><span id="l43.841">     for (int i = 0; i &lt; max; i++) {</span>
<a href="#l43.842"></a><span id="l43.842" class="difflineminus">-      pProp = m_mapi.GetMapiProperty( pUser, gMapiFields[i].mapiTag);</span>
<a href="#l43.843"></a><span id="l43.843" class="difflineplus">+      pProp = m_mapi.GetMapiProperty(pUser, gMapiFields[i].mapiTag);</span>
<a href="#l43.844"></a><span id="l43.844">       if (pProp) {</span>
<a href="#l43.845"></a><span id="l43.845" class="difflineminus">-        m_mapi.GetStringFromProp( pProp, value);</span>
<a href="#l43.846"></a><span id="l43.846" class="difflineplus">+        m_mapi.GetStringFromProp(pProp, value);</span>
<a href="#l43.847"></a><span id="l43.847">         if (!value.IsEmpty()) {</span>
<a href="#l43.848"></a><span id="l43.848">           if (gMapiFields[i].multiLine == kNoMultiLine) {</span>
<a href="#l43.849"></a><span id="l43.849" class="difflineminus">-            SanitizeValue( value);</span>
<a href="#l43.850"></a><span id="l43.850" class="difflineminus">-            pFieldMap-&gt;SetFieldValue( pDb, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l43.851"></a><span id="l43.851" class="difflineplus">+            SanitizeValue(value);</span>
<a href="#l43.852"></a><span id="l43.852" class="difflineplus">+            pFieldMap-&gt;SetFieldValue(pDb, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l43.853"></a><span id="l43.853">           }</span>
<a href="#l43.854"></a><span id="l43.854">           else if (gMapiFields[i].multiLine == kIsMultiLine) {</span>
<a href="#l43.855"></a><span id="l43.855" class="difflineminus">-            pFieldMap-&gt;SetFieldValue( pDb, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l43.856"></a><span id="l43.856" class="difflineplus">+            pFieldMap-&gt;SetFieldValue(pDb, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l43.857"></a><span id="l43.857">           }</span>
<a href="#l43.858"></a><span id="l43.858">           else {</span>
<a href="#l43.859"></a><span id="l43.859">             line2.Truncate();</span>
<a href="#l43.860"></a><span id="l43.860" class="difflineminus">-            SplitString( value, line2);</span>
<a href="#l43.861"></a><span id="l43.861" class="difflineplus">+            SplitString(value, line2);</span>
<a href="#l43.862"></a><span id="l43.862">             if (!value.IsEmpty())</span>
<a href="#l43.863"></a><span id="l43.863" class="difflineminus">-              pFieldMap-&gt;SetFieldValue( pDb, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l43.864"></a><span id="l43.864" class="difflineplus">+              pFieldMap-&gt;SetFieldValue(pDb, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l43.865"></a><span id="l43.865">             if (!line2.IsEmpty())</span>
<a href="#l43.866"></a><span id="l43.866" class="difflineminus">-              pFieldMap-&gt;SetFieldValue( pDb, newRow, gMapiFields[i].multiLine, line2.get());</span>
<a href="#l43.867"></a><span id="l43.867" class="difflineplus">+              pFieldMap-&gt;SetFieldValue(pDb, newRow, gMapiFields[i].multiLine, line2.get());</span>
<a href="#l43.868"></a><span id="l43.868">           }</span>
<a href="#l43.869"></a><span id="l43.869">         }</span>
<a href="#l43.870"></a><span id="l43.870">       }</span>
<a href="#l43.871"></a><span id="l43.871">     }</span>
<a href="#l43.872"></a><span id="l43.872">   }</span>
<a href="#l43.873"></a><span id="l43.873"> </span>
<a href="#l43.874"></a><span id="l43.874" class="difflineminus">-  return( true);</span>
<a href="#l43.875"></a><span id="l43.875" class="difflineplus">+  return true;</span>
<a href="#l43.876"></a><span id="l43.876"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookMail.h</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookMail.h</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -50,31 +50,31 @@</span>
<a href="#l44.4"></a><span id="l44.4"> class nsIAddrDatabase;</span>
<a href="#l44.5"></a><span id="l44.5"> class nsIImportFieldMap;</span>
<a href="#l44.6"></a><span id="l44.6"> </span>
<a href="#l44.7"></a><span id="l44.7"> class nsOutlookMail {</span>
<a href="#l44.8"></a><span id="l44.8"> public:</span>
<a href="#l44.9"></a><span id="l44.9">   nsOutlookMail();</span>
<a href="#l44.10"></a><span id="l44.10">   ~nsOutlookMail();</span>
<a href="#l44.11"></a><span id="l44.11">   </span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-  nsresult GetMailFolders( nsISupportsArray **pArray);</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineminus">-  nsresult GetAddressBooks( nsISupportsArray **pArray);</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineminus">-  nsresult ImportMailbox( PRUint32 *pDoneSoFar, bool *pAbort, PRInt32 index, const PRUnichar *pName, nsIFile *pDest, PRInt32 *pMsgCount);</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineminus">-  static nsresult ImportMessage( LPMESSAGE lpMsg, nsIOutputStream *destOutputStream, nsMsgDeliverMode mode);</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineminus">-  nsresult ImportAddresses( PRUint32 *pCount, PRUint32 *pTotal, const PRUnichar *pName, PRUint32 id, nsIAddrDatabase *pDb, nsString&amp; errors);</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+  nsresult GetMailFolders(nsISupportsArray **pArray);</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineplus">+  nsresult GetAddressBooks(nsISupportsArray **pArray);</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineplus">+  nsresult ImportMailbox(PRUint32 *pDoneSoFar, bool *pAbort, PRInt32 index, const PRUnichar *pName, nsIFile *pDest, PRInt32 *pMsgCount);</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineplus">+  static nsresult ImportMessage(LPMESSAGE lpMsg, nsIOutputStream *destOutputStream, nsMsgDeliverMode mode);</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineplus">+  nsresult ImportAddresses(PRUint32 *pCount, PRUint32 *pTotal, const PRUnichar *pName, PRUint32 id, nsIAddrDatabase *pDb, nsString&amp; errors);</span>
<a href="#l44.22"></a><span id="l44.22"> private:</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineminus">-  void  OpenMessageStore( CMapiFolder *pNextFolder);</span>
<a href="#l44.24"></a><span id="l44.24" class="difflineminus">-  static BOOL  WriteData( nsIOutputStream *pDest, const char *pData, PRInt32 len);</span>
<a href="#l44.25"></a><span id="l44.25" class="difflineplus">+  void  OpenMessageStore(CMapiFolder *pNextFolder);</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineplus">+  static BOOL  WriteData(nsIOutputStream *pDest, const char *pData, PRInt32 len);</span>
<a href="#l44.27"></a><span id="l44.27">   </span>
<a href="#l44.28"></a><span id="l44.28" class="difflineminus">-  bool      IsAddressBookNameUnique( nsString&amp; name, nsString&amp; list);</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineminus">-  void      MakeAddressBookNameUnique( nsString&amp; name, nsString&amp; list);</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineminus">-  void      SanitizeValue( nsString&amp; val);</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineminus">-  void      SplitString( nsString&amp; val1, nsString&amp; val2);</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineminus">-  bool      BuildCard( const PRUnichar *pName, nsIAddrDatabase *pDb, nsIMdbRow *newRow, LPMAPIPROP pUser, nsIImportFieldMap *pFieldMap);</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineminus">-  nsresult  CreateList( const PRUnichar * pName, nsIAddrDatabase *pDb, LPMAPIPROP pUserList, nsIImportFieldMap *pFieldMap);</span>
<a href="#l44.34"></a><span id="l44.34" class="difflineplus">+  bool      IsAddressBookNameUnique(nsString&amp; name, nsString&amp; list);</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineplus">+  void      MakeAddressBookNameUnique(nsString&amp; name, nsString&amp; list);</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineplus">+  void      SanitizeValue(nsString&amp; val);</span>
<a href="#l44.37"></a><span id="l44.37" class="difflineplus">+  void      SplitString(nsString&amp; val1, nsString&amp; val2);</span>
<a href="#l44.38"></a><span id="l44.38" class="difflineplus">+  bool      BuildCard(const PRUnichar *pName, nsIAddrDatabase *pDb, nsIMdbRow *newRow, LPMAPIPROP pUser, nsIImportFieldMap *pFieldMap);</span>
<a href="#l44.39"></a><span id="l44.39" class="difflineplus">+  nsresult  CreateList(const PRUnichar * pName, nsIAddrDatabase *pDb, LPMAPIPROP pUserList, nsIImportFieldMap *pFieldMap);</span>
<a href="#l44.40"></a><span id="l44.40">   </span>
<a href="#l44.41"></a><span id="l44.41"> private:</span>
<a href="#l44.42"></a><span id="l44.42">   bool              m_gotFolders;</span>
<a href="#l44.43"></a><span id="l44.43">   bool              m_gotAddresses;</span>
<a href="#l44.44"></a><span id="l44.44">   bool              m_haveMapi;</span>
<a href="#l44.45"></a><span id="l44.45">   CMapiApi          m_mapi;</span>
<a href="#l44.46"></a><span id="l44.46">   CMapiFolderList   m_folderList;</span>
<a href="#l44.47"></a><span id="l44.47">   CMapiFolderList   m_addressList;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookRegUtil.cpp</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookRegUtil.cpp</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -33,33 +33,33 @@</span>
<a href="#l45.4"></a><span id="l45.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l45.5"></a><span id="l45.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l45.6"></a><span id="l45.6">  *</span>
<a href="#l45.7"></a><span id="l45.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l45.8"></a><span id="l45.8"> #include &quot;nsOutlookRegUtil.h&quot;</span>
<a href="#l45.9"></a><span id="l45.9"> </span>
<a href="#l45.10"></a><span id="l45.10"> #include &quot;OutlookDebugLog.h&quot;</span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-BYTE * nsOutlookRegUtil::GetValueBytes( HKEY hKey, const char *pValueName)</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+BYTE * nsOutlookRegUtil::GetValueBytes(HKEY hKey, const char *pValueName)</span>
<a href="#l45.14"></a><span id="l45.14"> {</span>
<a href="#l45.15"></a><span id="l45.15">   LONG  err;</span>
<a href="#l45.16"></a><span id="l45.16">   DWORD  bufSz;</span>
<a href="#l45.17"></a><span id="l45.17">   LPBYTE  pBytes = NULL;</span>
<a href="#l45.18"></a><span id="l45.18"> </span>
<a href="#l45.19"></a><span id="l45.19" class="difflineminus">-  err = ::RegQueryValueEx( hKey, pValueName, NULL, NULL, NULL, &amp;bufSz); </span>
<a href="#l45.20"></a><span id="l45.20" class="difflineplus">+  err = ::RegQueryValueEx(hKey, pValueName, NULL, NULL, NULL, &amp;bufSz); </span>
<a href="#l45.21"></a><span id="l45.21">   if (err == ERROR_SUCCESS) {</span>
<a href="#l45.22"></a><span id="l45.22">     pBytes = new BYTE[bufSz];</span>
<a href="#l45.23"></a><span id="l45.23" class="difflineminus">-    err = ::RegQueryValueEx( hKey, pValueName, NULL, NULL, pBytes, &amp;bufSz);</span>
<a href="#l45.24"></a><span id="l45.24" class="difflineplus">+    err = ::RegQueryValueEx(hKey, pValueName, NULL, NULL, pBytes, &amp;bufSz);</span>
<a href="#l45.25"></a><span id="l45.25">     if (err != ERROR_SUCCESS) {</span>
<a href="#l45.26"></a><span id="l45.26">       delete [] pBytes;</span>
<a href="#l45.27"></a><span id="l45.27">       pBytes = NULL;</span>
<a href="#l45.28"></a><span id="l45.28">     }</span>
<a href="#l45.29"></a><span id="l45.29">   }</span>
<a href="#l45.30"></a><span id="l45.30"> </span>
<a href="#l45.31"></a><span id="l45.31" class="difflineminus">-  return( pBytes);</span>
<a href="#l45.32"></a><span id="l45.32" class="difflineplus">+  return pBytes;</span>
<a href="#l45.33"></a><span id="l45.33"> }</span>
<a href="#l45.34"></a><span id="l45.34"> </span>
<a href="#l45.35"></a><span id="l45.35" class="difflineminus">-void nsOutlookRegUtil::FreeValueBytes( BYTE *pBytes)</span>
<a href="#l45.36"></a><span id="l45.36" class="difflineplus">+void nsOutlookRegUtil::FreeValueBytes(BYTE *pBytes)</span>
<a href="#l45.37"></a><span id="l45.37"> {</span>
<a href="#l45.38"></a><span id="l45.38">   if (pBytes)</span>
<a href="#l45.39"></a><span id="l45.39">     delete [] pBytes;</span>
<a href="#l45.40"></a><span id="l45.40"> }</span>
<a href="#l45.41"></a><span id="l45.41"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookRegUtil.h</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookRegUtil.h</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -38,15 +38,15 @@</span>
<a href="#l46.4"></a><span id="l46.4"> #ifndef nsOutlookRegUtil_h___</span>
<a href="#l46.5"></a><span id="l46.5"> #define nsOutlookRegUtil_h___</span>
<a href="#l46.6"></a><span id="l46.6"> </span>
<a href="#l46.7"></a><span id="l46.7"> #include &lt;windows.h&gt;</span>
<a href="#l46.8"></a><span id="l46.8"> </span>
<a href="#l46.9"></a><span id="l46.9"> class nsOutlookRegUtil</span>
<a href="#l46.10"></a><span id="l46.10"> {</span>
<a href="#l46.11"></a><span id="l46.11"> public:</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-  static BYTE *  GetValueBytes( HKEY hKey, const char *pValueName);</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineminus">-  static void    FreeValueBytes( BYTE *pBytes);</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineplus">+  static BYTE *  GetValueBytes(HKEY hKey, const char *pValueName);</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineplus">+  static void    FreeValueBytes(BYTE *pBytes);</span>
<a href="#l46.16"></a><span id="l46.16"> };</span>
<a href="#l46.17"></a><span id="l46.17"> </span>
<a href="#l46.18"></a><span id="l46.18"> </span>
<a href="#l46.19"></a><span id="l46.19"> </span>
<a href="#l46.20"></a><span id="l46.20"> #endif /* nsOutlookRegUtil_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookSettings.cpp</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookSettings.cpp</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -60,27 +60,27 @@</span>
<a href="#l47.4"></a><span id="l47.4"> #include &quot;nsISmtpServer.h&quot;</span>
<a href="#l47.5"></a><span id="l47.5"> #include &quot;nsOutlookStringBundle.h&quot;</span>
<a href="#l47.6"></a><span id="l47.6"> #include &quot;OutlookDebugLog.h&quot;</span>
<a href="#l47.7"></a><span id="l47.7"> #include &quot;nsIPop3IncomingServer.h&quot;</span>
<a href="#l47.8"></a><span id="l47.8"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l47.9"></a><span id="l47.9"> </span>
<a href="#l47.10"></a><span id="l47.10"> class OutlookSettings {</span>
<a href="#l47.11"></a><span id="l47.11"> public:</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-  static HKEY FindAccountsKey( void);</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+  static HKEY FindAccountsKey(void);</span>
<a href="#l47.14"></a><span id="l47.14"> </span>
<a href="#l47.15"></a><span id="l47.15" class="difflineminus">-  static bool DoImport( nsIMsgAccount **ppAccount);</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineplus">+  static bool DoImport(nsIMsgAccount **ppAccount);</span>
<a href="#l47.17"></a><span id="l47.17"> </span>
<a href="#l47.18"></a><span id="l47.18" class="difflineminus">-  static bool DoIMAPServer( nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount);</span>
<a href="#l47.19"></a><span id="l47.19" class="difflineminus">-  static bool DoPOP3Server( nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount);</span>
<a href="#l47.20"></a><span id="l47.20" class="difflineplus">+  static bool DoIMAPServer(nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount);</span>
<a href="#l47.21"></a><span id="l47.21" class="difflineplus">+  static bool DoPOP3Server(nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount);</span>
<a href="#l47.22"></a><span id="l47.22"> </span>
<a href="#l47.23"></a><span id="l47.23" class="difflineminus">-  static void SetIdentities( nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, HKEY hKey);</span>
<a href="#l47.24"></a><span id="l47.24" class="difflineminus">-  static bool IdentityMatches( nsIMsgIdentity *pIdent, const char *pName, const char *pServer, const char *pEmail, const char *pReply, const char *pUserName);</span>
<a href="#l47.25"></a><span id="l47.25" class="difflineplus">+  static void SetIdentities(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, HKEY hKey);</span>
<a href="#l47.26"></a><span id="l47.26" class="difflineplus">+  static bool IdentityMatches(nsIMsgIdentity *pIdent, const char *pName, const char *pServer, const char *pEmail, const char *pReply, const char *pUserName);</span>
<a href="#l47.27"></a><span id="l47.27"> </span>
<a href="#l47.28"></a><span id="l47.28" class="difflineminus">-  static void SetSmtpServer( nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, char *pServer, const nsCString&amp; pUser);</span>
<a href="#l47.29"></a><span id="l47.29" class="difflineplus">+  static void SetSmtpServer(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, char *pServer, const nsCString&amp; pUser);</span>
<a href="#l47.30"></a><span id="l47.30">   static nsresult GetAccountName(HKEY hKey, char *defaultName, nsString &amp;acctName);</span>
<a href="#l47.31"></a><span id="l47.31"> };</span>
<a href="#l47.32"></a><span id="l47.32"> </span>
<a href="#l47.33"></a><span id="l47.33"> </span>
<a href="#l47.34"></a><span id="l47.34"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l47.35"></a><span id="l47.35"> nsresult nsOutlookSettings::Create(nsIImportSettings** aImport)</span>
<a href="#l47.36"></a><span id="l47.36"> {</span>
<a href="#l47.37"></a><span id="l47.37">     NS_PRECONDITION(aImport != nsnull, &quot;null ptr&quot;);</span>
<a href="#l47.38"></a><span id="l47.38" class="difflineat">@@ -105,100 +105,100 @@ nsOutlookSettings::~nsOutlookSettings()</span>
<a href="#l47.39"></a><span id="l47.39"> </span>
<a href="#l47.40"></a><span id="l47.40"> NS_IMPL_ISUPPORTS1(nsOutlookSettings, nsIImportSettings)</span>
<a href="#l47.41"></a><span id="l47.41"> </span>
<a href="#l47.42"></a><span id="l47.42"> NS_IMETHODIMP nsOutlookSettings::AutoLocate(PRUnichar **description, nsIFile **location, bool *_retval)</span>
<a href="#l47.43"></a><span id="l47.43"> {</span>
<a href="#l47.44"></a><span id="l47.44">     NS_PRECONDITION(description != nsnull, &quot;null ptr&quot;);</span>
<a href="#l47.45"></a><span id="l47.45">     NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l47.46"></a><span id="l47.46">   if (!description || !_retval)</span>
<a href="#l47.47"></a><span id="l47.47" class="difflineminus">-    return( NS_ERROR_NULL_POINTER);</span>
<a href="#l47.48"></a><span id="l47.48" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l47.49"></a><span id="l47.49"> </span>
<a href="#l47.50"></a><span id="l47.50" class="difflineminus">-  *description = nsOutlookStringBundle::GetStringByID( OUTLOOKIMPORT_NAME);</span>
<a href="#l47.51"></a><span id="l47.51" class="difflineplus">+  *description = nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_NAME);</span>
<a href="#l47.52"></a><span id="l47.52">   *_retval = false;</span>
<a href="#l47.53"></a><span id="l47.53"> </span>
<a href="#l47.54"></a><span id="l47.54">   if (location)</span>
<a href="#l47.55"></a><span id="l47.55">     *location = nsnull;</span>
<a href="#l47.56"></a><span id="l47.56"> </span>
<a href="#l47.57"></a><span id="l47.57">   // look for the registry key for the accounts</span>
<a href="#l47.58"></a><span id="l47.58">   HKEY key = OutlookSettings::FindAccountsKey();</span>
<a href="#l47.59"></a><span id="l47.59">   if (key != nsnull) {</span>
<a href="#l47.60"></a><span id="l47.60">     *_retval = true;</span>
<a href="#l47.61"></a><span id="l47.61" class="difflineminus">-    ::RegCloseKey( key);</span>
<a href="#l47.62"></a><span id="l47.62" class="difflineplus">+    ::RegCloseKey(key);</span>
<a href="#l47.63"></a><span id="l47.63">   }</span>
<a href="#l47.64"></a><span id="l47.64"> </span>
<a href="#l47.65"></a><span id="l47.65" class="difflineminus">-  return( NS_OK);</span>
<a href="#l47.66"></a><span id="l47.66" class="difflineplus">+  return NS_OK;</span>
<a href="#l47.67"></a><span id="l47.67"> }</span>
<a href="#l47.68"></a><span id="l47.68"> </span>
<a href="#l47.69"></a><span id="l47.69"> NS_IMETHODIMP nsOutlookSettings::SetLocation(nsIFile *location)</span>
<a href="#l47.70"></a><span id="l47.70"> {</span>
<a href="#l47.71"></a><span id="l47.71" class="difflineminus">-  return( NS_OK);</span>
<a href="#l47.72"></a><span id="l47.72" class="difflineplus">+  return NS_OK;</span>
<a href="#l47.73"></a><span id="l47.73"> }</span>
<a href="#l47.74"></a><span id="l47.74"> </span>
<a href="#l47.75"></a><span id="l47.75"> NS_IMETHODIMP nsOutlookSettings::Import(nsIMsgAccount **localMailAccount, bool *_retval)</span>
<a href="#l47.76"></a><span id="l47.76"> {</span>
<a href="#l47.77"></a><span id="l47.77" class="difflineminus">-  NS_PRECONDITION( _retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l47.78"></a><span id="l47.78" class="difflineplus">+  NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l47.79"></a><span id="l47.79"> </span>
<a href="#l47.80"></a><span id="l47.80" class="difflineminus">-  if (OutlookSettings::DoImport( localMailAccount)) {</span>
<a href="#l47.81"></a><span id="l47.81" class="difflineplus">+  if (OutlookSettings::DoImport(localMailAccount)) {</span>
<a href="#l47.82"></a><span id="l47.82">     *_retval = true;</span>
<a href="#l47.83"></a><span id="l47.83" class="difflineminus">-    IMPORT_LOG0( &quot;Settings import appears successful\n&quot;);</span>
<a href="#l47.84"></a><span id="l47.84" class="difflineplus">+    IMPORT_LOG0(&quot;Settings import appears successful\n&quot;);</span>
<a href="#l47.85"></a><span id="l47.85">   }</span>
<a href="#l47.86"></a><span id="l47.86">   else {</span>
<a href="#l47.87"></a><span id="l47.87">     *_retval = false;</span>
<a href="#l47.88"></a><span id="l47.88" class="difflineminus">-    IMPORT_LOG0( &quot;Settings import returned FALSE\n&quot;);</span>
<a href="#l47.89"></a><span id="l47.89" class="difflineplus">+    IMPORT_LOG0(&quot;Settings import returned FALSE\n&quot;);</span>
<a href="#l47.90"></a><span id="l47.90">   }</span>
<a href="#l47.91"></a><span id="l47.91"> </span>
<a href="#l47.92"></a><span id="l47.92" class="difflineminus">-  return( NS_OK);</span>
<a href="#l47.93"></a><span id="l47.93" class="difflineplus">+  return NS_OK;</span>
<a href="#l47.94"></a><span id="l47.94"> }</span>
<a href="#l47.95"></a><span id="l47.95"> </span>
<a href="#l47.96"></a><span id="l47.96"> </span>
<a href="#l47.97"></a><span id="l47.97" class="difflineminus">-HKEY OutlookSettings::FindAccountsKey( void)</span>
<a href="#l47.98"></a><span id="l47.98" class="difflineplus">+HKEY OutlookSettings::FindAccountsKey(void)</span>
<a href="#l47.99"></a><span id="l47.99"> {</span>
<a href="#l47.100"></a><span id="l47.100">   HKEY  sKey;</span>
<a href="#l47.101"></a><span id="l47.101" class="difflineminus">-  if (::RegOpenKeyEx( HKEY_CURRENT_USER, &quot;Software\\Microsoft\\Office\\Outlook\\OMI Account Manager\\Accounts&quot;, 0, KEY_QUERY_VALUE | KEY_ENUMERATE_SUB_KEYS, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l47.102"></a><span id="l47.102" class="difflineminus">-    return( sKey);</span>
<a href="#l47.103"></a><span id="l47.103" class="difflineplus">+  if (::RegOpenKeyEx(HKEY_CURRENT_USER, &quot;Software\\Microsoft\\Office\\Outlook\\OMI Account Manager\\Accounts&quot;, 0, KEY_QUERY_VALUE | KEY_ENUMERATE_SUB_KEYS, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l47.104"></a><span id="l47.104" class="difflineplus">+    return sKey;</span>
<a href="#l47.105"></a><span id="l47.105">   }</span>
<a href="#l47.106"></a><span id="l47.106" class="difflineminus">-  if (::RegOpenKeyEx( HKEY_CURRENT_USER, &quot;Software\\Microsoft\\Office\\8.0\\Outlook\\OMI Account Manager\\Accounts&quot;, 0, KEY_QUERY_VALUE | KEY_ENUMERATE_SUB_KEYS, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l47.107"></a><span id="l47.107" class="difflineminus">-    return( sKey);</span>
<a href="#l47.108"></a><span id="l47.108" class="difflineplus">+  if (::RegOpenKeyEx(HKEY_CURRENT_USER, &quot;Software\\Microsoft\\Office\\8.0\\Outlook\\OMI Account Manager\\Accounts&quot;, 0, KEY_QUERY_VALUE | KEY_ENUMERATE_SUB_KEYS, &amp;sKey) == ERROR_SUCCESS) {</span>
<a href="#l47.109"></a><span id="l47.109" class="difflineplus">+    return sKey;</span>
<a href="#l47.110"></a><span id="l47.110">   }</span>
<a href="#l47.111"></a><span id="l47.111"> </span>
<a href="#l47.112"></a><span id="l47.112" class="difflineminus">-  return( nsnull);</span>
<a href="#l47.113"></a><span id="l47.113" class="difflineplus">+  return nsnull;</span>
<a href="#l47.114"></a><span id="l47.114"> }</span>
<a href="#l47.115"></a><span id="l47.115"> </span>
<a href="#l47.116"></a><span id="l47.116" class="difflineminus">-bool OutlookSettings::DoImport( nsIMsgAccount **ppAccount)</span>
<a href="#l47.117"></a><span id="l47.117" class="difflineplus">+bool OutlookSettings::DoImport(nsIMsgAccount **ppAccount)</span>
<a href="#l47.118"></a><span id="l47.118"> {</span>
<a href="#l47.119"></a><span id="l47.119">   HKEY  hKey = FindAccountsKey();</span>
<a href="#l47.120"></a><span id="l47.120">   if (hKey == nsnull) {</span>
<a href="#l47.121"></a><span id="l47.121" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error finding Outlook registry account keys\n&quot;);</span>
<a href="#l47.122"></a><span id="l47.122" class="difflineminus">-    return( false);</span>
<a href="#l47.123"></a><span id="l47.123" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error finding Outlook registry account keys\n&quot;);</span>
<a href="#l47.124"></a><span id="l47.124" class="difflineplus">+    return false;</span>
<a href="#l47.125"></a><span id="l47.125">   }</span>
<a href="#l47.126"></a><span id="l47.126"> </span>
<a href="#l47.127"></a><span id="l47.127">   nsresult  rv;</span>
<a href="#l47.128"></a><span id="l47.128"> </span>
<a href="#l47.129"></a><span id="l47.129">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr =</span>
<a href="#l47.130"></a><span id="l47.130">            do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l47.131"></a><span id="l47.131">     if (NS_FAILED(rv)) {</span>
<a href="#l47.132"></a><span id="l47.132" class="difflineminus">-    IMPORT_LOG0( &quot;*** Failed to create a account manager!\n&quot;);</span>
<a href="#l47.133"></a><span id="l47.133" class="difflineminus">-    return( false);</span>
<a href="#l47.134"></a><span id="l47.134" class="difflineplus">+    IMPORT_LOG0(&quot;*** Failed to create a account manager!\n&quot;);</span>
<a href="#l47.135"></a><span id="l47.135" class="difflineplus">+    return false;</span>
<a href="#l47.136"></a><span id="l47.136">   }</span>
<a href="#l47.137"></a><span id="l47.137"> </span>
<a href="#l47.138"></a><span id="l47.138">   HKEY    subKey = NULL;</span>
<a href="#l47.139"></a><span id="l47.139">   nsCString  defMailName;</span>
<a href="#l47.140"></a><span id="l47.140"> </span>
<a href="#l47.141"></a><span id="l47.141" class="difflineminus">-  if (::RegOpenKeyEx( HKEY_CURRENT_USER, &quot;Software\\Microsoft\\Office\\Outlook\\OMI Account Manager&quot;, 0, KEY_QUERY_VALUE, &amp;subKey) != ERROR_SUCCESS)</span>
<a href="#l47.142"></a><span id="l47.142" class="difflineminus">-    if (::RegOpenKeyEx( HKEY_CURRENT_USER, &quot;Software\\Microsoft\\Office\\8.0\\Outlook\\OMI Account Manager&quot;, 0, KEY_QUERY_VALUE, &amp;subKey) != ERROR_SUCCESS)</span>
<a href="#l47.143"></a><span id="l47.143" class="difflineplus">+  if (::RegOpenKeyEx(HKEY_CURRENT_USER, &quot;Software\\Microsoft\\Office\\Outlook\\OMI Account Manager&quot;, 0, KEY_QUERY_VALUE, &amp;subKey) != ERROR_SUCCESS)</span>
<a href="#l47.144"></a><span id="l47.144" class="difflineplus">+    if (::RegOpenKeyEx(HKEY_CURRENT_USER, &quot;Software\\Microsoft\\Office\\8.0\\Outlook\\OMI Account Manager&quot;, 0, KEY_QUERY_VALUE, &amp;subKey) != ERROR_SUCCESS)</span>
<a href="#l47.145"></a><span id="l47.145">       subKey = NULL;</span>
<a href="#l47.146"></a><span id="l47.146"> </span>
<a href="#l47.147"></a><span id="l47.147">   if (subKey != NULL) {</span>
<a href="#l47.148"></a><span id="l47.148">     // First let's get the default mail account key name</span>
<a href="#l47.149"></a><span id="l47.149" class="difflineminus">-    BYTE *  pBytes = nsOutlookRegUtil::GetValueBytes( subKey, &quot;Default Mail Account&quot;);</span>
<a href="#l47.150"></a><span id="l47.150" class="difflineminus">-    ::RegCloseKey( subKey);</span>
<a href="#l47.151"></a><span id="l47.151" class="difflineplus">+    BYTE *  pBytes = nsOutlookRegUtil::GetValueBytes(subKey, &quot;Default Mail Account&quot;);</span>
<a href="#l47.152"></a><span id="l47.152" class="difflineplus">+    ::RegCloseKey(subKey);</span>
<a href="#l47.153"></a><span id="l47.153">     if (pBytes) {</span>
<a href="#l47.154"></a><span id="l47.154">       defMailName = (const char *)pBytes;</span>
<a href="#l47.155"></a><span id="l47.155" class="difflineminus">-      nsOutlookRegUtil::FreeValueBytes( pBytes);</span>
<a href="#l47.156"></a><span id="l47.156" class="difflineplus">+      nsOutlookRegUtil::FreeValueBytes(pBytes);</span>
<a href="#l47.157"></a><span id="l47.157">     }</span>
<a href="#l47.158"></a><span id="l47.158">   }</span>
<a href="#l47.159"></a><span id="l47.159"> </span>
<a href="#l47.160"></a><span id="l47.160">   // Iterate the accounts looking for POP3 &amp; IMAP accounts...</span>
<a href="#l47.161"></a><span id="l47.161">   // Ignore LDAP &amp; NNTP for now!</span>
<a href="#l47.162"></a><span id="l47.162">   DWORD    index = 0;</span>
<a href="#l47.163"></a><span id="l47.163">   DWORD    numChars;</span>
<a href="#l47.164"></a><span id="l47.164">   TCHAR    keyName[256];</span>
<a href="#l47.165"></a><span id="l47.165" class="difflineat">@@ -206,163 +206,163 @@ bool OutlookSettings::DoImport( nsIMsgAc</span>
<a href="#l47.166"></a><span id="l47.166">   LONG    result = ERROR_SUCCESS;</span>
<a href="#l47.167"></a><span id="l47.167">   BYTE *    pBytes;</span>
<a href="#l47.168"></a><span id="l47.168">   int      popCount = 0;</span>
<a href="#l47.169"></a><span id="l47.169">   int      accounts = 0;</span>
<a href="#l47.170"></a><span id="l47.170">   nsCString  keyComp;</span>
<a href="#l47.171"></a><span id="l47.171"> </span>
<a href="#l47.172"></a><span id="l47.172">   while (result == ERROR_SUCCESS) {</span>
<a href="#l47.173"></a><span id="l47.173">     numChars = 256;</span>
<a href="#l47.174"></a><span id="l47.174" class="difflineminus">-    result = ::RegEnumKeyEx( hKey, index, keyName, &amp;numChars, NULL, NULL, NULL, &amp;modTime);</span>
<a href="#l47.175"></a><span id="l47.175" class="difflineplus">+    result = ::RegEnumKeyEx(hKey, index, keyName, &amp;numChars, NULL, NULL, NULL, &amp;modTime);</span>
<a href="#l47.176"></a><span id="l47.176">     index++;</span>
<a href="#l47.177"></a><span id="l47.177">     if (result == ERROR_SUCCESS) {</span>
<a href="#l47.178"></a><span id="l47.178" class="difflineminus">-      if (::RegOpenKeyEx( hKey, keyName, 0, KEY_QUERY_VALUE, &amp;subKey) == ERROR_SUCCESS) {</span>
<a href="#l47.179"></a><span id="l47.179" class="difflineplus">+      if (::RegOpenKeyEx(hKey, keyName, 0, KEY_QUERY_VALUE, &amp;subKey) == ERROR_SUCCESS) {</span>
<a href="#l47.180"></a><span id="l47.180">         // Get the values for this account.</span>
<a href="#l47.181"></a><span id="l47.181" class="difflineminus">-        IMPORT_LOG1( &quot;Opened Outlook account: %s\n&quot;, (char *)keyName);</span>
<a href="#l47.182"></a><span id="l47.182" class="difflineplus">+        IMPORT_LOG1(&quot;Opened Outlook account: %s\n&quot;, (char *)keyName);</span>
<a href="#l47.183"></a><span id="l47.183"> </span>
<a href="#l47.184"></a><span id="l47.184">         nsIMsgAccount  *anAccount = nsnull;</span>
<a href="#l47.185"></a><span id="l47.185" class="difflineminus">-        pBytes = nsOutlookRegUtil::GetValueBytes( subKey, &quot;IMAP Server&quot;);</span>
<a href="#l47.186"></a><span id="l47.186" class="difflineplus">+        pBytes = nsOutlookRegUtil::GetValueBytes(subKey, &quot;IMAP Server&quot;);</span>
<a href="#l47.187"></a><span id="l47.187">         if (pBytes) {</span>
<a href="#l47.188"></a><span id="l47.188" class="difflineminus">-          if (DoIMAPServer( accMgr, subKey, (char *)pBytes, &amp;anAccount))</span>
<a href="#l47.189"></a><span id="l47.189" class="difflineplus">+          if (DoIMAPServer(accMgr, subKey, (char *)pBytes, &amp;anAccount))</span>
<a href="#l47.190"></a><span id="l47.190">             accounts++;</span>
<a href="#l47.191"></a><span id="l47.191" class="difflineminus">-          nsOutlookRegUtil::FreeValueBytes( pBytes);</span>
<a href="#l47.192"></a><span id="l47.192" class="difflineplus">+          nsOutlookRegUtil::FreeValueBytes(pBytes);</span>
<a href="#l47.193"></a><span id="l47.193">         }</span>
<a href="#l47.194"></a><span id="l47.194"> </span>
<a href="#l47.195"></a><span id="l47.195" class="difflineminus">-        pBytes = nsOutlookRegUtil::GetValueBytes( subKey, &quot;POP3 Server&quot;);</span>
<a href="#l47.196"></a><span id="l47.196" class="difflineplus">+        pBytes = nsOutlookRegUtil::GetValueBytes(subKey, &quot;POP3 Server&quot;);</span>
<a href="#l47.197"></a><span id="l47.197">         if (pBytes) {</span>
<a href="#l47.198"></a><span id="l47.198">           if (popCount == 0) {</span>
<a href="#l47.199"></a><span id="l47.199" class="difflineminus">-            if (DoPOP3Server( accMgr, subKey, (char *)pBytes, &amp;anAccount)) {</span>
<a href="#l47.200"></a><span id="l47.200" class="difflineplus">+            if (DoPOP3Server(accMgr, subKey, (char *)pBytes, &amp;anAccount)) {</span>
<a href="#l47.201"></a><span id="l47.201">               popCount++;</span>
<a href="#l47.202"></a><span id="l47.202">               accounts++;</span>
<a href="#l47.203"></a><span id="l47.203">               if (ppAccount &amp;&amp; anAccount) {</span>
<a href="#l47.204"></a><span id="l47.204">                 *ppAccount = anAccount;</span>
<a href="#l47.205"></a><span id="l47.205" class="difflineminus">-                NS_ADDREF( anAccount);</span>
<a href="#l47.206"></a><span id="l47.206" class="difflineplus">+                NS_ADDREF(anAccount);</span>
<a href="#l47.207"></a><span id="l47.207">               }</span>
<a href="#l47.208"></a><span id="l47.208">             }</span>
<a href="#l47.209"></a><span id="l47.209">           }</span>
<a href="#l47.210"></a><span id="l47.210">           else {</span>
<a href="#l47.211"></a><span id="l47.211" class="difflineminus">-            if (DoPOP3Server( accMgr, subKey, (char *)pBytes, &amp;anAccount)) {</span>
<a href="#l47.212"></a><span id="l47.212" class="difflineplus">+            if (DoPOP3Server(accMgr, subKey, (char *)pBytes, &amp;anAccount)) {</span>
<a href="#l47.213"></a><span id="l47.213">               popCount++;</span>
<a href="#l47.214"></a><span id="l47.214">               accounts++;</span>
<a href="#l47.215"></a><span id="l47.215">               // If we created a mail account, get rid of it since</span>
<a href="#l47.216"></a><span id="l47.216">               // we have 2 POP accounts!</span>
<a href="#l47.217"></a><span id="l47.217">               if (ppAccount &amp;&amp; *ppAccount) {</span>
<a href="#l47.218"></a><span id="l47.218" class="difflineminus">-                NS_RELEASE( *ppAccount);</span>
<a href="#l47.219"></a><span id="l47.219" class="difflineplus">+                NS_RELEASE(*ppAccount);</span>
<a href="#l47.220"></a><span id="l47.220">                 *ppAccount = nsnull;</span>
<a href="#l47.221"></a><span id="l47.221">               }</span>
<a href="#l47.222"></a><span id="l47.222">             }</span>
<a href="#l47.223"></a><span id="l47.223">           }</span>
<a href="#l47.224"></a><span id="l47.224" class="difflineminus">-          nsOutlookRegUtil::FreeValueBytes( pBytes);</span>
<a href="#l47.225"></a><span id="l47.225" class="difflineplus">+          nsOutlookRegUtil::FreeValueBytes(pBytes);</span>
<a href="#l47.226"></a><span id="l47.226">         }</span>
<a href="#l47.227"></a><span id="l47.227"> </span>
<a href="#l47.228"></a><span id="l47.228">         if (anAccount) {</span>
<a href="#l47.229"></a><span id="l47.229">           // Is this the default account?</span>
<a href="#l47.230"></a><span id="l47.230">           keyComp = keyName;</span>
<a href="#l47.231"></a><span id="l47.231" class="difflineminus">-          if (keyComp.Equals( defMailName)) {</span>
<a href="#l47.232"></a><span id="l47.232" class="difflineminus">-            accMgr-&gt;SetDefaultAccount( anAccount);</span>
<a href="#l47.233"></a><span id="l47.233" class="difflineplus">+          if (keyComp.Equals(defMailName)) {</span>
<a href="#l47.234"></a><span id="l47.234" class="difflineplus">+            accMgr-&gt;SetDefaultAccount(anAccount);</span>
<a href="#l47.235"></a><span id="l47.235">           }</span>
<a href="#l47.236"></a><span id="l47.236" class="difflineminus">-          NS_RELEASE( anAccount);</span>
<a href="#l47.237"></a><span id="l47.237" class="difflineplus">+          NS_RELEASE(anAccount);</span>
<a href="#l47.238"></a><span id="l47.238">         }</span>
<a href="#l47.239"></a><span id="l47.239"> </span>
<a href="#l47.240"></a><span id="l47.240" class="difflineminus">-        ::RegCloseKey( subKey);</span>
<a href="#l47.241"></a><span id="l47.241" class="difflineplus">+        ::RegCloseKey(subKey);</span>
<a href="#l47.242"></a><span id="l47.242">       }</span>
<a href="#l47.243"></a><span id="l47.243">     }</span>
<a href="#l47.244"></a><span id="l47.244">   }</span>
<a href="#l47.245"></a><span id="l47.245"> </span>
<a href="#l47.246"></a><span id="l47.246">   // Now save the new acct info to pref file.</span>
<a href="#l47.247"></a><span id="l47.247">   rv = accMgr-&gt;SaveAccountInfo();</span>
<a href="#l47.248"></a><span id="l47.248">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Can't save account info to pref file&quot;);</span>
<a href="#l47.249"></a><span id="l47.249"> </span>
<a href="#l47.250"></a><span id="l47.250" class="difflineminus">-  return( accounts != 0);</span>
<a href="#l47.251"></a><span id="l47.251" class="difflineplus">+  return accounts != 0;</span>
<a href="#l47.252"></a><span id="l47.252"> }</span>
<a href="#l47.253"></a><span id="l47.253"> </span>
<a href="#l47.254"></a><span id="l47.254"> nsresult OutlookSettings::GetAccountName(HKEY hKey, char *defaultName, nsString &amp;acctName)</span>
<a href="#l47.255"></a><span id="l47.255"> {</span>
<a href="#l47.256"></a><span id="l47.256" class="difflineminus">-  BYTE *pAccName = nsOutlookRegUtil::GetValueBytes( hKey, &quot;Account Name&quot;);</span>
<a href="#l47.257"></a><span id="l47.257" class="difflineplus">+  BYTE *pAccName = nsOutlookRegUtil::GetValueBytes(hKey, &quot;Account Name&quot;);</span>
<a href="#l47.258"></a><span id="l47.258">   nsresult rv = NS_OK;</span>
<a href="#l47.259"></a><span id="l47.259">   if (pAccName) {</span>
<a href="#l47.260"></a><span id="l47.260">      rv = nsMsgI18NConvertToUnicode(nsMsgI18NFileSystemCharset(),</span>
<a href="#l47.261"></a><span id="l47.261">                                     nsDependentCString(defaultName), acctName);</span>
<a href="#l47.262"></a><span id="l47.262" class="difflineminus">-    nsOutlookRegUtil::FreeValueBytes( pAccName);</span>
<a href="#l47.263"></a><span id="l47.263" class="difflineplus">+    nsOutlookRegUtil::FreeValueBytes(pAccName);</span>
<a href="#l47.264"></a><span id="l47.264">   }</span>
<a href="#l47.265"></a><span id="l47.265">   else</span>
<a href="#l47.266"></a><span id="l47.266">     acctName.AssignASCII(defaultName);</span>
<a href="#l47.267"></a><span id="l47.267">   return rv;</span>
<a href="#l47.268"></a><span id="l47.268"> }</span>
<a href="#l47.269"></a><span id="l47.269"> </span>
<a href="#l47.270"></a><span id="l47.270" class="difflineminus">-bool OutlookSettings::DoIMAPServer( nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount)</span>
<a href="#l47.271"></a><span id="l47.271" class="difflineplus">+bool OutlookSettings::DoIMAPServer(nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount)</span>
<a href="#l47.272"></a><span id="l47.272"> {</span>
<a href="#l47.273"></a><span id="l47.273">   if (ppAccount)</span>
<a href="#l47.274"></a><span id="l47.274">     *ppAccount = nsnull;</span>
<a href="#l47.275"></a><span id="l47.275"> </span>
<a href="#l47.276"></a><span id="l47.276">   BYTE *pBytes;</span>
<a href="#l47.277"></a><span id="l47.277" class="difflineminus">-  pBytes = nsOutlookRegUtil::GetValueBytes( hKey, &quot;IMAP User Name&quot;);</span>
<a href="#l47.278"></a><span id="l47.278" class="difflineplus">+  pBytes = nsOutlookRegUtil::GetValueBytes(hKey, &quot;IMAP User Name&quot;);</span>
<a href="#l47.279"></a><span id="l47.279">   if (!pBytes)</span>
<a href="#l47.280"></a><span id="l47.280" class="difflineminus">-    return( false);</span>
<a href="#l47.281"></a><span id="l47.281" class="difflineplus">+    return false;</span>
<a href="#l47.282"></a><span id="l47.282"> </span>
<a href="#l47.283"></a><span id="l47.283">   bool    result = false;</span>
<a href="#l47.284"></a><span id="l47.284"> </span>
<a href="#l47.285"></a><span id="l47.285">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l47.286"></a><span id="l47.286">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l47.287"></a><span id="l47.287" class="difflineminus">-  nsresult rv = pMgr-&gt;FindServer( nsDependentCString((const char *)pBytes), nsDependentCString(pServerName), NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs( in));</span>
<a href="#l47.288"></a><span id="l47.288" class="difflineminus">-  if (NS_FAILED( rv) || (in == nsnull)) {</span>
<a href="#l47.289"></a><span id="l47.289" class="difflineplus">+  nsresult rv = pMgr-&gt;FindServer(nsDependentCString((const char *)pBytes), nsDependentCString(pServerName), NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l47.290"></a><span id="l47.290" class="difflineplus">+  if (NS_FAILED(rv) || (in == nsnull)) {</span>
<a href="#l47.291"></a><span id="l47.291">     // Create the incoming server and an account for it?</span>
<a href="#l47.292"></a><span id="l47.292" class="difflineminus">-    rv = pMgr-&gt;CreateIncomingServer( nsDependentCString((const char *)pBytes), nsDependentCString(pServerName), NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs( in));</span>
<a href="#l47.293"></a><span id="l47.293" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; in) {</span>
<a href="#l47.294"></a><span id="l47.294" class="difflineplus">+    rv = pMgr-&gt;CreateIncomingServer(nsDependentCString((const char *)pBytes), nsDependentCString(pServerName), NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l47.295"></a><span id="l47.295" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l47.296"></a><span id="l47.296">       rv = in-&gt;SetType(NS_LITERAL_CSTRING(&quot;imap&quot;));</span>
<a href="#l47.297"></a><span id="l47.297">       // TODO SSL, auth method</span>
<a href="#l47.298"></a><span id="l47.298"> </span>
<a href="#l47.299"></a><span id="l47.299" class="difflineminus">-      IMPORT_LOG2( &quot;Created IMAP server named: %s, userName: %s\n&quot;, pServerName, (char *)pBytes);</span>
<a href="#l47.300"></a><span id="l47.300" class="difflineplus">+      IMPORT_LOG2(&quot;Created IMAP server named: %s, userName: %s\n&quot;, pServerName, (char *)pBytes);</span>
<a href="#l47.301"></a><span id="l47.301"> </span>
<a href="#l47.302"></a><span id="l47.302">       nsString prettyName;</span>
<a href="#l47.303"></a><span id="l47.303">       if (NS_SUCCEEDED(GetAccountName(hKey, pServerName, prettyName)))</span>
<a href="#l47.304"></a><span id="l47.304" class="difflineminus">-        rv = in-&gt;SetPrettyName( prettyName);</span>
<a href="#l47.305"></a><span id="l47.305" class="difflineplus">+        rv = in-&gt;SetPrettyName(prettyName);</span>
<a href="#l47.306"></a><span id="l47.306">       // We have a server, create an account.</span>
<a href="#l47.307"></a><span id="l47.307">       nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l47.308"></a><span id="l47.308" class="difflineminus">-      rv = pMgr-&gt;CreateAccount( getter_AddRefs( account));</span>
<a href="#l47.309"></a><span id="l47.309" class="difflineminus">-      if (NS_SUCCEEDED( rv) &amp;&amp; account) {</span>
<a href="#l47.310"></a><span id="l47.310" class="difflineminus">-        rv = account-&gt;SetIncomingServer( in);</span>
<a href="#l47.311"></a><span id="l47.311" class="difflineplus">+      rv = pMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l47.312"></a><span id="l47.312" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l47.313"></a><span id="l47.313" class="difflineplus">+        rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l47.314"></a><span id="l47.314"> </span>
<a href="#l47.315"></a><span id="l47.315" class="difflineminus">-        IMPORT_LOG0( &quot;Created an account and set the IMAP server as the incoming server\n&quot;);</span>
<a href="#l47.316"></a><span id="l47.316" class="difflineplus">+        IMPORT_LOG0(&quot;Created an account and set the IMAP server as the incoming server\n&quot;);</span>
<a href="#l47.317"></a><span id="l47.317"> </span>
<a href="#l47.318"></a><span id="l47.318">         // Fiddle with the identities</span>
<a href="#l47.319"></a><span id="l47.319" class="difflineminus">-        SetIdentities( pMgr, account, hKey);</span>
<a href="#l47.320"></a><span id="l47.320" class="difflineplus">+        SetIdentities(pMgr, account, hKey);</span>
<a href="#l47.321"></a><span id="l47.321">         result = true;</span>
<a href="#l47.322"></a><span id="l47.322">         if (ppAccount)</span>
<a href="#l47.323"></a><span id="l47.323" class="difflineminus">-          account-&gt;QueryInterface( NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l47.324"></a><span id="l47.324" class="difflineplus">+          account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l47.325"></a><span id="l47.325">       }</span>
<a href="#l47.326"></a><span id="l47.326">     }</span>
<a href="#l47.327"></a><span id="l47.327">   }</span>
<a href="#l47.328"></a><span id="l47.328">   else</span>
<a href="#l47.329"></a><span id="l47.329">     result = true;</span>
<a href="#l47.330"></a><span id="l47.330"> </span>
<a href="#l47.331"></a><span id="l47.331" class="difflineminus">-  nsOutlookRegUtil::FreeValueBytes( pBytes);</span>
<a href="#l47.332"></a><span id="l47.332" class="difflineplus">+  nsOutlookRegUtil::FreeValueBytes(pBytes);</span>
<a href="#l47.333"></a><span id="l47.333"> </span>
<a href="#l47.334"></a><span id="l47.334" class="difflineminus">-  return( result);</span>
<a href="#l47.335"></a><span id="l47.335" class="difflineplus">+  return result;</span>
<a href="#l47.336"></a><span id="l47.336"> }</span>
<a href="#l47.337"></a><span id="l47.337"> </span>
<a href="#l47.338"></a><span id="l47.338" class="difflineminus">-bool OutlookSettings::DoPOP3Server( nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount)</span>
<a href="#l47.339"></a><span id="l47.339" class="difflineplus">+bool OutlookSettings::DoPOP3Server(nsIMsgAccountManager *pMgr, HKEY hKey, char *pServerName, nsIMsgAccount **ppAccount)</span>
<a href="#l47.340"></a><span id="l47.340"> {</span>
<a href="#l47.341"></a><span id="l47.341">   if (ppAccount)</span>
<a href="#l47.342"></a><span id="l47.342">     *ppAccount = nsnull;</span>
<a href="#l47.343"></a><span id="l47.343"> </span>
<a href="#l47.344"></a><span id="l47.344">   BYTE *pBytes;</span>
<a href="#l47.345"></a><span id="l47.345" class="difflineminus">-  pBytes = nsOutlookRegUtil::GetValueBytes( hKey, &quot;POP3 User Name&quot;);</span>
<a href="#l47.346"></a><span id="l47.346" class="difflineplus">+  pBytes = nsOutlookRegUtil::GetValueBytes(hKey, &quot;POP3 User Name&quot;);</span>
<a href="#l47.347"></a><span id="l47.347">   if (!pBytes)</span>
<a href="#l47.348"></a><span id="l47.348" class="difflineminus">-    return( false);</span>
<a href="#l47.349"></a><span id="l47.349" class="difflineplus">+    return false;</span>
<a href="#l47.350"></a><span id="l47.350"> </span>
<a href="#l47.351"></a><span id="l47.351">   bool result = false;</span>
<a href="#l47.352"></a><span id="l47.352"> </span>
<a href="#l47.353"></a><span id="l47.353">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l47.354"></a><span id="l47.354">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l47.355"></a><span id="l47.355" class="difflineminus">-  nsresult rv = pMgr-&gt;FindServer( nsDependentCString((const char *)pBytes), nsDependentCString(pServerName), NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs( in));</span>
<a href="#l47.356"></a><span id="l47.356" class="difflineminus">-  if (NS_FAILED( rv) || (in == nsnull)) {</span>
<a href="#l47.357"></a><span id="l47.357" class="difflineplus">+  nsresult rv = pMgr-&gt;FindServer(nsDependentCString((const char *)pBytes), nsDependentCString(pServerName), NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l47.358"></a><span id="l47.358" class="difflineplus">+  if (NS_FAILED(rv) || (in == nsnull)) {</span>
<a href="#l47.359"></a><span id="l47.359">     // Create the incoming server and an account for it?</span>
<a href="#l47.360"></a><span id="l47.360" class="difflineminus">-    rv = pMgr-&gt;CreateIncomingServer(nsDependentCString((const char *)pBytes), nsDependentCString(pServerName), NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs( in));</span>
<a href="#l47.361"></a><span id="l47.361" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; in) {</span>
<a href="#l47.362"></a><span id="l47.362" class="difflineplus">+    rv = pMgr-&gt;CreateIncomingServer(nsDependentCString((const char *)pBytes), nsDependentCString(pServerName), NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l47.363"></a><span id="l47.363" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l47.364"></a><span id="l47.364">       rv = in-&gt;SetType(NS_LITERAL_CSTRING(&quot;pop3&quot;));</span>
<a href="#l47.365"></a><span id="l47.365"> </span>
<a href="#l47.366"></a><span id="l47.366">       // TODO SSL, auth method</span>
<a href="#l47.367"></a><span id="l47.367"> </span>
<a href="#l47.368"></a><span id="l47.368">         nsCOMPtr&lt;nsIPop3IncomingServer&gt; pop3Server = do_QueryInterface(in);</span>
<a href="#l47.369"></a><span id="l47.369">         if (pop3Server) {</span>
<a href="#l47.370"></a><span id="l47.370">             // set local folders as the Inbox to use for this POP3 server</span>
<a href="#l47.371"></a><span id="l47.371">             nsCOMPtr&lt;nsIMsgIncomingServer&gt; localFoldersServer;</span>
<a href="#l47.372"></a><span id="l47.372" class="difflineat">@@ -370,17 +370,17 @@ bool OutlookSettings::DoPOP3Server( nsIM</span>
<a href="#l47.373"></a><span id="l47.373"> </span>
<a href="#l47.374"></a><span id="l47.374">             if (!localFoldersServer)</span>
<a href="#l47.375"></a><span id="l47.375">             {</span>
<a href="#l47.376"></a><span id="l47.376">                 // XXX: We may need to move this local folder creation code to the generic nsImportSettings code</span>
<a href="#l47.377"></a><span id="l47.377">                 // if the other import modules end up needing to do this too.</span>
<a href="#l47.378"></a><span id="l47.378">                 // if Local Folders does not exist already, create it</span>
<a href="#l47.379"></a><span id="l47.379">                 rv = pMgr-&gt;CreateLocalMailAccount();</span>
<a href="#l47.380"></a><span id="l47.380">                 if (NS_FAILED(rv)) {</span>
<a href="#l47.381"></a><span id="l47.381" class="difflineminus">-                    IMPORT_LOG0( &quot;*** Failed to create Local Folders!\n&quot;);</span>
<a href="#l47.382"></a><span id="l47.382" class="difflineplus">+                    IMPORT_LOG0(&quot;*** Failed to create Local Folders!\n&quot;);</span>
<a href="#l47.383"></a><span id="l47.383">                     return false;</span>
<a href="#l47.384"></a><span id="l47.384">                 }</span>
<a href="#l47.385"></a><span id="l47.385">                 pMgr-&gt;GetLocalFoldersServer(getter_AddRefs(localFoldersServer));</span>
<a href="#l47.386"></a><span id="l47.386">             }</span>
<a href="#l47.387"></a><span id="l47.387"> </span>
<a href="#l47.388"></a><span id="l47.388">             // now get the account for this server</span>
<a href="#l47.389"></a><span id="l47.389">             nsCOMPtr&lt;nsIMsgAccount&gt; localFoldersAccount;</span>
<a href="#l47.390"></a><span id="l47.390">             pMgr-&gt;FindAccountForServer(localFoldersServer, getter_AddRefs(localFoldersAccount));</span>
<a href="#l47.391"></a><span id="l47.391" class="difflineat">@@ -388,58 +388,58 @@ bool OutlookSettings::DoPOP3Server( nsIM</span>
<a href="#l47.392"></a><span id="l47.392">             {</span>
<a href="#l47.393"></a><span id="l47.393">               nsCString localFoldersAcctKey;</span>
<a href="#l47.394"></a><span id="l47.394">               localFoldersAccount-&gt;GetKey(localFoldersAcctKey);</span>
<a href="#l47.395"></a><span id="l47.395">               pop3Server-&gt;SetDeferredToAccount(localFoldersAcctKey);</span>
<a href="#l47.396"></a><span id="l47.396">               pop3Server-&gt;SetDeferGetNewMail(true);</span>
<a href="#l47.397"></a><span id="l47.397">             }</span>
<a href="#l47.398"></a><span id="l47.398">         }</span>
<a href="#l47.399"></a><span id="l47.399"> </span>
<a href="#l47.400"></a><span id="l47.400" class="difflineminus">-        IMPORT_LOG2( &quot;Created POP3 server named: %s, userName: %s\n&quot;, pServerName, (char *)pBytes);</span>
<a href="#l47.401"></a><span id="l47.401" class="difflineplus">+        IMPORT_LOG2(&quot;Created POP3 server named: %s, userName: %s\n&quot;, pServerName, (char *)pBytes);</span>
<a href="#l47.402"></a><span id="l47.402"> </span>
<a href="#l47.403"></a><span id="l47.403">         nsString prettyName;</span>
<a href="#l47.404"></a><span id="l47.404">         if (NS_SUCCEEDED(GetAccountName(hKey, pServerName, prettyName)))</span>
<a href="#l47.405"></a><span id="l47.405" class="difflineminus">-          rv = in-&gt;SetPrettyName( prettyName);</span>
<a href="#l47.406"></a><span id="l47.406" class="difflineplus">+          rv = in-&gt;SetPrettyName(prettyName);</span>
<a href="#l47.407"></a><span id="l47.407">       // We have a server, create an account.</span>
<a href="#l47.408"></a><span id="l47.408">       nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l47.409"></a><span id="l47.409" class="difflineminus">-      rv = pMgr-&gt;CreateAccount( getter_AddRefs( account));</span>
<a href="#l47.410"></a><span id="l47.410" class="difflineminus">-      if (NS_SUCCEEDED( rv) &amp;&amp; account) {</span>
<a href="#l47.411"></a><span id="l47.411" class="difflineminus">-        rv = account-&gt;SetIncomingServer( in);</span>
<a href="#l47.412"></a><span id="l47.412" class="difflineplus">+      rv = pMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l47.413"></a><span id="l47.413" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l47.414"></a><span id="l47.414" class="difflineplus">+        rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l47.415"></a><span id="l47.415"> </span>
<a href="#l47.416"></a><span id="l47.416" class="difflineminus">-      IMPORT_LOG0( &quot;Created a new account and set the incoming server to the POP3 server.\n&quot;);</span>
<a href="#l47.417"></a><span id="l47.417" class="difflineplus">+      IMPORT_LOG0(&quot;Created a new account and set the incoming server to the POP3 server.\n&quot;);</span>
<a href="#l47.418"></a><span id="l47.418"> </span>
<a href="#l47.419"></a><span id="l47.419">         nsCOMPtr&lt;nsIPop3IncomingServer&gt; pop3Server = do_QueryInterface(in, &amp;rv);</span>
<a href="#l47.420"></a><span id="l47.420">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l47.421"></a><span id="l47.421" class="difflineminus">-        BYTE *pLeaveOnServer = nsOutlookRegUtil::GetValueBytes( hKey, &quot;Leave Mail On Server&quot;);</span>
<a href="#l47.422"></a><span id="l47.422" class="difflineplus">+        BYTE *pLeaveOnServer = nsOutlookRegUtil::GetValueBytes(hKey, &quot;Leave Mail On Server&quot;);</span>
<a href="#l47.423"></a><span id="l47.423">         if (pLeaveOnServer)</span>
<a href="#l47.424"></a><span id="l47.424">         {</span>
<a href="#l47.425"></a><span id="l47.425">           pop3Server-&gt;SetLeaveMessagesOnServer(*pLeaveOnServer == 1 ? true : false);</span>
<a href="#l47.426"></a><span id="l47.426">           nsOutlookRegUtil::FreeValueBytes(pLeaveOnServer);</span>
<a href="#l47.427"></a><span id="l47.427">         }</span>
<a href="#l47.428"></a><span id="l47.428"> </span>
<a href="#l47.429"></a><span id="l47.429">         // Fiddle with the identities</span>
<a href="#l47.430"></a><span id="l47.430" class="difflineminus">-        SetIdentities( pMgr, account, hKey);</span>
<a href="#l47.431"></a><span id="l47.431" class="difflineplus">+        SetIdentities(pMgr, account, hKey);</span>
<a href="#l47.432"></a><span id="l47.432">         result = true;</span>
<a href="#l47.433"></a><span id="l47.433">         if (ppAccount)</span>
<a href="#l47.434"></a><span id="l47.434" class="difflineminus">-          account-&gt;QueryInterface( NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l47.435"></a><span id="l47.435" class="difflineplus">+          account-&gt;QueryInterface(NS_GET_IID(nsIMsgAccount), (void **)ppAccount);</span>
<a href="#l47.436"></a><span id="l47.436">       }</span>
<a href="#l47.437"></a><span id="l47.437">     }</span>
<a href="#l47.438"></a><span id="l47.438">   }</span>
<a href="#l47.439"></a><span id="l47.439">   else</span>
<a href="#l47.440"></a><span id="l47.440">     result = true;</span>
<a href="#l47.441"></a><span id="l47.441"> </span>
<a href="#l47.442"></a><span id="l47.442" class="difflineminus">-  nsOutlookRegUtil::FreeValueBytes( pBytes);</span>
<a href="#l47.443"></a><span id="l47.443" class="difflineplus">+  nsOutlookRegUtil::FreeValueBytes(pBytes);</span>
<a href="#l47.444"></a><span id="l47.444"> </span>
<a href="#l47.445"></a><span id="l47.445" class="difflineminus">-  return( result);</span>
<a href="#l47.446"></a><span id="l47.446" class="difflineplus">+  return result;</span>
<a href="#l47.447"></a><span id="l47.447"> }</span>
<a href="#l47.448"></a><span id="l47.448"> </span>
<a href="#l47.449"></a><span id="l47.449" class="difflineminus">-bool OutlookSettings::IdentityMatches( nsIMsgIdentity *pIdent, const char *pName, const char *pServer, const char *pEmail, const char *pReply, const char *pUserName)</span>
<a href="#l47.450"></a><span id="l47.450" class="difflineplus">+bool OutlookSettings::IdentityMatches(nsIMsgIdentity *pIdent, const char *pName, const char *pServer, const char *pEmail, const char *pReply, const char *pUserName)</span>
<a href="#l47.451"></a><span id="l47.451"> {</span>
<a href="#l47.452"></a><span id="l47.452">   if (!pIdent)</span>
<a href="#l47.453"></a><span id="l47.453" class="difflineminus">-    return( false);</span>
<a href="#l47.454"></a><span id="l47.454" class="difflineplus">+    return false;</span>
<a href="#l47.455"></a><span id="l47.455"> </span>
<a href="#l47.456"></a><span id="l47.456">   char *  pIName = nsnull;</span>
<a href="#l47.457"></a><span id="l47.457">   nsCString pIEmail;</span>
<a href="#l47.458"></a><span id="l47.458">   nsCString pIReply;</span>
<a href="#l47.459"></a><span id="l47.459"> </span>
<a href="#l47.460"></a><span id="l47.460">   bool    result = true;</span>
<a href="#l47.461"></a><span id="l47.461"> </span>
<a href="#l47.462"></a><span id="l47.462">   // The test here is:</span>
<a href="#l47.463"></a><span id="l47.463" class="difflineat">@@ -455,37 +455,37 @@ bool OutlookSettings::IdentityMatches( n</span>
<a href="#l47.464"></a><span id="l47.464"> </span>
<a href="#l47.465"></a><span id="l47.465"> </span>
<a href="#l47.466"></a><span id="l47.466">   // for now, if it's the same server and reply to and email then it matches</span>
<a href="#l47.467"></a><span id="l47.467">   if (pReply &amp;&amp; !pIReply.Equals(pReply, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l47.468"></a><span id="l47.468">     result = false;</span>
<a href="#l47.469"></a><span id="l47.469">   if (pEmail &amp;&amp; !pIEmail.Equals(pEmail, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l47.470"></a><span id="l47.470">     result = false;</span>
<a href="#l47.471"></a><span id="l47.471"> </span>
<a href="#l47.472"></a><span id="l47.472" class="difflineminus">-  return( result);</span>
<a href="#l47.473"></a><span id="l47.473" class="difflineplus">+  return result;</span>
<a href="#l47.474"></a><span id="l47.474"> }</span>
<a href="#l47.475"></a><span id="l47.475"> </span>
<a href="#l47.476"></a><span id="l47.476" class="difflineminus">-void OutlookSettings::SetIdentities( nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, HKEY hKey)</span>
<a href="#l47.477"></a><span id="l47.477" class="difflineplus">+void OutlookSettings::SetIdentities(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, HKEY hKey)</span>
<a href="#l47.478"></a><span id="l47.478"> {</span>
<a href="#l47.479"></a><span id="l47.479">   // Get the relevant information for an identity</span>
<a href="#l47.480"></a><span id="l47.480" class="difflineminus">-  char *pName = (char *)nsOutlookRegUtil::GetValueBytes( hKey, &quot;SMTP Display Name&quot;);</span>
<a href="#l47.481"></a><span id="l47.481" class="difflineminus">-  char *pServer = (char *)nsOutlookRegUtil::GetValueBytes( hKey, &quot;SMTP Server&quot;);</span>
<a href="#l47.482"></a><span id="l47.482" class="difflineminus">-  char *pEmail = (char *)nsOutlookRegUtil::GetValueBytes( hKey, &quot;SMTP Email Address&quot;);</span>
<a href="#l47.483"></a><span id="l47.483" class="difflineminus">-  char *pReply = (char *)nsOutlookRegUtil::GetValueBytes( hKey, &quot;SMTP Reply To Email Address&quot;);</span>
<a href="#l47.484"></a><span id="l47.484" class="difflineplus">+  char *pName = (char *)nsOutlookRegUtil::GetValueBytes(hKey, &quot;SMTP Display Name&quot;);</span>
<a href="#l47.485"></a><span id="l47.485" class="difflineplus">+  char *pServer = (char *)nsOutlookRegUtil::GetValueBytes(hKey, &quot;SMTP Server&quot;);</span>
<a href="#l47.486"></a><span id="l47.486" class="difflineplus">+  char *pEmail = (char *)nsOutlookRegUtil::GetValueBytes(hKey, &quot;SMTP Email Address&quot;);</span>
<a href="#l47.487"></a><span id="l47.487" class="difflineplus">+  char *pReply = (char *)nsOutlookRegUtil::GetValueBytes(hKey, &quot;SMTP Reply To Email Address&quot;);</span>
<a href="#l47.488"></a><span id="l47.488">   nsCString userName;</span>
<a href="#l47.489"></a><span id="l47.489" class="difflineminus">-  userName.Adopt((char *)nsOutlookRegUtil::GetValueBytes( hKey, &quot;SMTP User Name&quot;));</span>
<a href="#l47.490"></a><span id="l47.490" class="difflineminus">-  char *pOrgName = (char *)nsOutlookRegUtil::GetValueBytes( hKey, &quot;SMTP Organization Name&quot;);</span>
<a href="#l47.491"></a><span id="l47.491" class="difflineplus">+  userName.Adopt((char *)nsOutlookRegUtil::GetValueBytes(hKey, &quot;SMTP User Name&quot;));</span>
<a href="#l47.492"></a><span id="l47.492" class="difflineplus">+  char *pOrgName = (char *)nsOutlookRegUtil::GetValueBytes(hKey, &quot;SMTP Organization Name&quot;);</span>
<a href="#l47.493"></a><span id="l47.493"> </span>
<a href="#l47.494"></a><span id="l47.494">   nsresult rv;</span>
<a href="#l47.495"></a><span id="l47.495"> </span>
<a href="#l47.496"></a><span id="l47.496">   if (pEmail &amp;&amp; pName &amp;&amp; pServer) {</span>
<a href="#l47.497"></a><span id="l47.497">     // The default identity, nor any other identities matched,</span>
<a href="#l47.498"></a><span id="l47.498">     // create a new one and add it to the account.</span>
<a href="#l47.499"></a><span id="l47.499">     nsCOMPtr&lt;nsIMsgIdentity&gt;  id;</span>
<a href="#l47.500"></a><span id="l47.500" class="difflineminus">-    rv = pMgr-&gt;CreateIdentity( getter_AddRefs( id));</span>
<a href="#l47.501"></a><span id="l47.501" class="difflineplus">+    rv = pMgr-&gt;CreateIdentity(getter_AddRefs(id));</span>
<a href="#l47.502"></a><span id="l47.502">     if (id) {</span>
<a href="#l47.503"></a><span id="l47.503">       nsAutoString name, organization;</span>
<a href="#l47.504"></a><span id="l47.504">       rv = nsMsgI18NConvertToUnicode(nsMsgI18NFileSystemCharset(),</span>
<a href="#l47.505"></a><span id="l47.505">         nsDependentCString(pName), name);</span>
<a href="#l47.506"></a><span id="l47.506">       if (NS_SUCCEEDED(rv))</span>
<a href="#l47.507"></a><span id="l47.507">       {</span>
<a href="#l47.508"></a><span id="l47.508">         id-&gt;SetFullName(name);</span>
<a href="#l47.509"></a><span id="l47.509">         id-&gt;SetIdentityName(name);</span>
<a href="#l47.510"></a><span id="l47.510" class="difflineat">@@ -496,56 +496,56 @@ void OutlookSettings::SetIdentities( nsI</span>
<a href="#l47.511"></a><span id="l47.511">           nsDependentCString(pOrgName), organization);</span>
<a href="#l47.512"></a><span id="l47.512">         if (NS_SUCCEEDED(rv))</span>
<a href="#l47.513"></a><span id="l47.513">           id-&gt;SetOrganization(organization);</span>
<a href="#l47.514"></a><span id="l47.514">       }</span>
<a href="#l47.515"></a><span id="l47.515"> </span>
<a href="#l47.516"></a><span id="l47.516">       id-&gt;SetEmail(nsDependentCString(pEmail));</span>
<a href="#l47.517"></a><span id="l47.517">       if (pReply)</span>
<a href="#l47.518"></a><span id="l47.518">         id-&gt;SetReplyTo(nsDependentCString(pReply));</span>
<a href="#l47.519"></a><span id="l47.519" class="difflineminus">-      pAcc-&gt;AddIdentity( id);</span>
<a href="#l47.520"></a><span id="l47.520" class="difflineplus">+      pAcc-&gt;AddIdentity(id);</span>
<a href="#l47.521"></a><span id="l47.521"> </span>
<a href="#l47.522"></a><span id="l47.522" class="difflineminus">-      IMPORT_LOG0( &quot;Created identity and added to the account\n&quot;);</span>
<a href="#l47.523"></a><span id="l47.523" class="difflineminus">-      IMPORT_LOG1( &quot;\tname: %s\n&quot;, pName);</span>
<a href="#l47.524"></a><span id="l47.524" class="difflineminus">-      IMPORT_LOG1( &quot;\temail: %s\n&quot;, pEmail);</span>
<a href="#l47.525"></a><span id="l47.525" class="difflineplus">+      IMPORT_LOG0(&quot;Created identity and added to the account\n&quot;);</span>
<a href="#l47.526"></a><span id="l47.526" class="difflineplus">+      IMPORT_LOG1(&quot;\tname: %s\n&quot;, pName);</span>
<a href="#l47.527"></a><span id="l47.527" class="difflineplus">+      IMPORT_LOG1(&quot;\temail: %s\n&quot;, pEmail);</span>
<a href="#l47.528"></a><span id="l47.528">     }</span>
<a href="#l47.529"></a><span id="l47.529">   }</span>
<a href="#l47.530"></a><span id="l47.530"> </span>
<a href="#l47.531"></a><span id="l47.531">   if (userName.IsEmpty()) {</span>
<a href="#l47.532"></a><span id="l47.532">     nsCOMPtr &lt;nsIMsgIncomingServer&gt;  incomingServer;</span>
<a href="#l47.533"></a><span id="l47.533" class="difflineminus">-    rv = pAcc-&gt;GetIncomingServer(getter_AddRefs( incomingServer));</span>
<a href="#l47.534"></a><span id="l47.534" class="difflineplus">+    rv = pAcc-&gt;GetIncomingServer(getter_AddRefs(incomingServer));</span>
<a href="#l47.535"></a><span id="l47.535">     if (NS_SUCCEEDED(rv) &amp;&amp; incomingServer)</span>
<a href="#l47.536"></a><span id="l47.536">       rv = incomingServer-&gt;GetUsername(userName);</span>
<a href="#l47.537"></a><span id="l47.537">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Unable to get UserName from incomingServer&quot;);</span>
<a href="#l47.538"></a><span id="l47.538">   }</span>
<a href="#l47.539"></a><span id="l47.539"> </span>
<a href="#l47.540"></a><span id="l47.540" class="difflineminus">-  SetSmtpServer( pMgr, pAcc, pServer, userName);</span>
<a href="#l47.541"></a><span id="l47.541" class="difflineplus">+  SetSmtpServer(pMgr, pAcc, pServer, userName);</span>
<a href="#l47.542"></a><span id="l47.542"> </span>
<a href="#l47.543"></a><span id="l47.543" class="difflineminus">-  nsOutlookRegUtil::FreeValueBytes( (BYTE *)pName);</span>
<a href="#l47.544"></a><span id="l47.544" class="difflineminus">-  nsOutlookRegUtil::FreeValueBytes( (BYTE *)pServer);</span>
<a href="#l47.545"></a><span id="l47.545" class="difflineminus">-  nsOutlookRegUtil::FreeValueBytes( (BYTE *)pEmail);</span>
<a href="#l47.546"></a><span id="l47.546" class="difflineminus">-  nsOutlookRegUtil::FreeValueBytes( (BYTE *)pReply);</span>
<a href="#l47.547"></a><span id="l47.547" class="difflineplus">+  nsOutlookRegUtil::FreeValueBytes((BYTE *)pName);</span>
<a href="#l47.548"></a><span id="l47.548" class="difflineplus">+  nsOutlookRegUtil::FreeValueBytes((BYTE *)pServer);</span>
<a href="#l47.549"></a><span id="l47.549" class="difflineplus">+  nsOutlookRegUtil::FreeValueBytes((BYTE *)pEmail);</span>
<a href="#l47.550"></a><span id="l47.550" class="difflineplus">+  nsOutlookRegUtil::FreeValueBytes((BYTE *)pReply);</span>
<a href="#l47.551"></a><span id="l47.551"> }</span>
<a href="#l47.552"></a><span id="l47.552"> </span>
<a href="#l47.553"></a><span id="l47.553"> void OutlookSettings::SetSmtpServer(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc, char *pServer,</span>
<a href="#l47.554"></a><span id="l47.554">                                     const nsCString&amp; user)</span>
<a href="#l47.555"></a><span id="l47.555"> {</span>
<a href="#l47.556"></a><span id="l47.556">   nsresult rv;</span>
<a href="#l47.557"></a><span id="l47.557">   nsCOMPtr&lt;nsISmtpService&gt; smtpService(do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l47.558"></a><span id="l47.558">   if (NS_SUCCEEDED(rv) &amp;&amp; smtpService) {</span>
<a href="#l47.559"></a><span id="l47.559">     nsCOMPtr&lt;nsISmtpServer&gt; foundServer;</span>
<a href="#l47.560"></a><span id="l47.560" class="difflineminus">-    rv = smtpService-&gt;FindServer( user.get(), pServer, getter_AddRefs( foundServer));</span>
<a href="#l47.561"></a><span id="l47.561" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; foundServer) {</span>
<a href="#l47.562"></a><span id="l47.562" class="difflineminus">-      IMPORT_LOG1( &quot;SMTP server already exists: %s\n&quot;, pServer);</span>
<a href="#l47.563"></a><span id="l47.563" class="difflineplus">+    rv = smtpService-&gt;FindServer(user.get(), pServer, getter_AddRefs(foundServer));</span>
<a href="#l47.564"></a><span id="l47.564" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; foundServer) {</span>
<a href="#l47.565"></a><span id="l47.565" class="difflineplus">+      IMPORT_LOG1(&quot;SMTP server already exists: %s\n&quot;, pServer);</span>
<a href="#l47.566"></a><span id="l47.566">       return;</span>
<a href="#l47.567"></a><span id="l47.567">     }</span>
<a href="#l47.568"></a><span id="l47.568">     nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l47.569"></a><span id="l47.569" class="difflineminus">-    rv = smtpService-&gt;CreateSmtpServer( getter_AddRefs( smtpServer));</span>
<a href="#l47.570"></a><span id="l47.570" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; smtpServer) {</span>
<a href="#l47.571"></a><span id="l47.571" class="difflineplus">+    rv = smtpService-&gt;CreateSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l47.572"></a><span id="l47.572" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; smtpServer) {</span>
<a href="#l47.573"></a><span id="l47.573">       smtpServer-&gt;SetHostname(nsDependentCString(pServer));</span>
<a href="#l47.574"></a><span id="l47.574">       if (!user.IsEmpty())</span>
<a href="#l47.575"></a><span id="l47.575">         smtpServer-&gt;SetUsername(user);</span>
<a href="#l47.576"></a><span id="l47.576">       // TODO SSL, auth method</span>
<a href="#l47.577"></a><span id="l47.577" class="difflineminus">-      IMPORT_LOG1( &quot;Ceated new SMTP server: %s\n&quot;, pServer);</span>
<a href="#l47.578"></a><span id="l47.578" class="difflineplus">+      IMPORT_LOG1(&quot;Ceated new SMTP server: %s\n&quot;, pServer);</span>
<a href="#l47.579"></a><span id="l47.579">     }</span>
<a href="#l47.580"></a><span id="l47.580">   }</span>
<a href="#l47.581"></a><span id="l47.581"> }</span>
<a href="#l47.582"></a><span id="l47.582"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookStringBundle.cpp</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookStringBundle.cpp</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -43,61 +43,61 @@</span>
<a href="#l48.4"></a><span id="l48.4"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l48.5"></a><span id="l48.5"> #include &quot;nsIURI.h&quot;</span>
<a href="#l48.6"></a><span id="l48.6"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l48.7"></a><span id="l48.7"> </span>
<a href="#l48.8"></a><span id="l48.8"> #define OUTLOOK_MSGS_URL       &quot;chrome://messenger/locale/outlookImportMsgs.properties&quot;</span>
<a href="#l48.9"></a><span id="l48.9"> </span>
<a href="#l48.10"></a><span id="l48.10"> nsIStringBundle *  nsOutlookStringBundle::m_pBundle = nsnull;</span>
<a href="#l48.11"></a><span id="l48.11"> </span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-nsIStringBundle *nsOutlookStringBundle::GetStringBundle( void)</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+nsIStringBundle *nsOutlookStringBundle::GetStringBundle(void)</span>
<a href="#l48.14"></a><span id="l48.14"> {</span>
<a href="#l48.15"></a><span id="l48.15">   if (m_pBundle)</span>
<a href="#l48.16"></a><span id="l48.16">     return m_pBundle;</span>
<a href="#l48.17"></a><span id="l48.17"> </span>
<a href="#l48.18"></a><span id="l48.18">   char*        propertyURL = OUTLOOK_MSGS_URL;</span>
<a href="#l48.19"></a><span id="l48.19">   nsIStringBundle*  sBundle = nsnull;</span>
<a href="#l48.20"></a><span id="l48.20"> </span>
<a href="#l48.21"></a><span id="l48.21">   nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l48.22"></a><span id="l48.22">     mozilla::services::GetStringBundleService();</span>
<a href="#l48.23"></a><span id="l48.23">   if (sBundleService) {</span>
<a href="#l48.24"></a><span id="l48.24">     sBundleService-&gt;CreateBundle(propertyURL, &amp;sBundle);</span>
<a href="#l48.25"></a><span id="l48.25">   }</span>
<a href="#l48.26"></a><span id="l48.26"> </span>
<a href="#l48.27"></a><span id="l48.27">   m_pBundle = sBundle;</span>
<a href="#l48.28"></a><span id="l48.28"> </span>
<a href="#l48.29"></a><span id="l48.29" class="difflineminus">-  return( sBundle);</span>
<a href="#l48.30"></a><span id="l48.30" class="difflineplus">+  return sBundle;</span>
<a href="#l48.31"></a><span id="l48.31"> }</span>
<a href="#l48.32"></a><span id="l48.32"> </span>
<a href="#l48.33"></a><span id="l48.33" class="difflineminus">-void nsOutlookStringBundle::GetStringByID( PRInt32 stringID, nsString&amp; result)</span>
<a href="#l48.34"></a><span id="l48.34" class="difflineplus">+void nsOutlookStringBundle::GetStringByID(PRInt32 stringID, nsString&amp; result)</span>
<a href="#l48.35"></a><span id="l48.35"> {</span>
<a href="#l48.36"></a><span id="l48.36">   PRUnichar *ptrv = GetStringByID(stringID);</span>
<a href="#l48.37"></a><span id="l48.37">   result = ptrv;</span>
<a href="#l48.38"></a><span id="l48.38" class="difflineminus">-  FreeString( ptrv);</span>
<a href="#l48.39"></a><span id="l48.39" class="difflineplus">+  FreeString(ptrv);</span>
<a href="#l48.40"></a><span id="l48.40"> }</span>
<a href="#l48.41"></a><span id="l48.41"> </span>
<a href="#l48.42"></a><span id="l48.42"> PRUnichar *nsOutlookStringBundle::GetStringByID(PRInt32 stringID)</span>
<a href="#l48.43"></a><span id="l48.43"> {</span>
<a href="#l48.44"></a><span id="l48.44">   if (m_pBundle)</span>
<a href="#l48.45"></a><span id="l48.45">     m_pBundle = GetStringBundle();</span>
<a href="#l48.46"></a><span id="l48.46"> </span>
<a href="#l48.47"></a><span id="l48.47">   if (m_pBundle) {</span>
<a href="#l48.48"></a><span id="l48.48">     PRUnichar *ptrv = nsnull;</span>
<a href="#l48.49"></a><span id="l48.49">     nsresult rv = m_pBundle-&gt;GetStringFromID(stringID, &amp;ptrv);</span>
<a href="#l48.50"></a><span id="l48.50"> </span>
<a href="#l48.51"></a><span id="l48.51" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; ptrv)</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; ptrv)</span>
<a href="#l48.53"></a><span id="l48.53">       return ptrv;</span>
<a href="#l48.54"></a><span id="l48.54">   }</span>
<a href="#l48.55"></a><span id="l48.55"> </span>
<a href="#l48.56"></a><span id="l48.56">   nsString resultString;</span>
<a href="#l48.57"></a><span id="l48.57">   resultString.AppendLiteral(&quot;[StringID &quot;);</span>
<a href="#l48.58"></a><span id="l48.58">   resultString.AppendInt(stringID);</span>
<a href="#l48.59"></a><span id="l48.59">   resultString.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l48.60"></a><span id="l48.60"> </span>
<a href="#l48.61"></a><span id="l48.61">   return ToNewUnicode(resultString);</span>
<a href="#l48.62"></a><span id="l48.62"> }</span>
<a href="#l48.63"></a><span id="l48.63"> </span>
<a href="#l48.64"></a><span id="l48.64" class="difflineminus">-void nsOutlookStringBundle::Cleanup( void)</span>
<a href="#l48.65"></a><span id="l48.65" class="difflineplus">+void nsOutlookStringBundle::Cleanup(void)</span>
<a href="#l48.66"></a><span id="l48.66"> {</span>
<a href="#l48.67"></a><span id="l48.67">   if (m_pBundle)</span>
<a href="#l48.68"></a><span id="l48.68">     m_pBundle-&gt;Release();</span>
<a href="#l48.69"></a><span id="l48.69">   m_pBundle = nsnull;</span>
<a href="#l48.70"></a><span id="l48.70"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookStringBundle.h</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookStringBundle.h</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -41,19 +41,19 @@</span>
<a href="#l49.4"></a><span id="l49.4"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l49.5"></a><span id="l49.5"> </span>
<a href="#l49.6"></a><span id="l49.6"> class nsIStringBundle;</span>
<a href="#l49.7"></a><span id="l49.7"> </span>
<a href="#l49.8"></a><span id="l49.8"> class nsOutlookStringBundle {</span>
<a href="#l49.9"></a><span id="l49.9"> public:</span>
<a href="#l49.10"></a><span id="l49.10">   static PRUnichar     * GetStringByID(PRInt32 stringID);</span>
<a href="#l49.11"></a><span id="l49.11">   static void GetStringByID(PRInt32 stringID, nsString&amp; result);</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-  static nsIStringBundle * GetStringBundle( void); // don't release</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineminus">-  static void FreeString( PRUnichar *pStr) { NS_Free( pStr);}</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineminus">-  static void Cleanup( void);</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineplus">+  static nsIStringBundle * GetStringBundle(void); // don't release</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineplus">+  static void FreeString(PRUnichar *pStr) { NS_Free(pStr);}</span>
<a href="#l49.17"></a><span id="l49.17" class="difflineplus">+  static void Cleanup(void);</span>
<a href="#l49.18"></a><span id="l49.18"> private:</span>
<a href="#l49.19"></a><span id="l49.19">   static nsIStringBundle * m_pBundle;</span>
<a href="#l49.20"></a><span id="l49.20"> };</span>
<a href="#l49.21"></a><span id="l49.21"> </span>
<a href="#l49.22"></a><span id="l49.22"> </span>
<a href="#l49.23"></a><span id="l49.23"> </span>
<a href="#l49.24"></a><span id="l49.24"> #define OUTLOOKIMPORT_NAME                     2000</span>
<a href="#l49.25"></a><span id="l49.25"> #define OUTLOOKIMPORT_DESCRIPTION              2010</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mailnews/import/src/ImportCharSet.h</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mailnews/import/src/ImportCharSet.h</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -78,130 +78,130 @@ public:</span>
<a href="#l50.4"></a><span id="l50.4">     cWhiteSpaceChar = 4,</span>
<a href="#l50.5"></a><span id="l50.5">     cDigitChar = 8,</span>
<a href="#l50.6"></a><span id="l50.6">     c822SpecialChar = 16</span>
<a href="#l50.7"></a><span id="l50.7">   };</span>
<a href="#l50.8"></a><span id="l50.8"> </span>
<a href="#l50.9"></a><span id="l50.9">   static char      m_upperCaseMap[256];</span>
<a href="#l50.10"></a><span id="l50.10">   static char      m_Ascii[256];</span>
<a href="#l50.11"></a><span id="l50.11"> </span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-  inline static bool IsUSAscii( PRUint8 ch) { return( ((ch &amp; (PRUint8)0x80) == 0));}</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineminus">-  inline static bool Is822CtlChar( PRUint8 ch) { return( (ch &lt; 32));}</span>
<a href="#l50.14"></a><span id="l50.14" class="difflineminus">-  inline static bool Is822SpecialChar( PRUint8 ch) { return( (m_Ascii[ch] &amp; c822SpecialChar) == c822SpecialChar);}</span>
<a href="#l50.15"></a><span id="l50.15" class="difflineminus">-  inline static bool IsWhiteSpace( PRUint8 ch) { return( (m_Ascii[ch] &amp; cWhiteSpaceChar) == cWhiteSpaceChar); }</span>
<a href="#l50.16"></a><span id="l50.16" class="difflineminus">-  inline static bool IsAlphaNum( PRUint8 ch) { return( (m_Ascii[ch] &amp; cAlphaNumChar) == cAlphaNumChar); }</span>
<a href="#l50.17"></a><span id="l50.17" class="difflineminus">-  inline static bool IsDigit( PRUint8 ch) { return( (m_Ascii[ch] &amp; cDigitChar) == cDigitChar); }</span>
<a href="#l50.18"></a><span id="l50.18" class="difflineplus">+  inline static bool IsUSAscii(PRUint8 ch) { return (((ch &amp; (PRUint8)0x80) == 0));}</span>
<a href="#l50.19"></a><span id="l50.19" class="difflineplus">+  inline static bool Is822CtlChar(PRUint8 ch) { return (ch &lt; 32);}</span>
<a href="#l50.20"></a><span id="l50.20" class="difflineplus">+  inline static bool Is822SpecialChar(PRUint8 ch) { return ((m_Ascii[ch] &amp; c822SpecialChar) == c822SpecialChar);}</span>
<a href="#l50.21"></a><span id="l50.21" class="difflineplus">+  inline static bool IsWhiteSpace(PRUint8 ch) { return ((m_Ascii[ch] &amp; cWhiteSpaceChar) == cWhiteSpaceChar); }</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineplus">+  inline static bool IsAlphaNum(PRUint8 ch) { return ((m_Ascii[ch] &amp; cAlphaNumChar) == cAlphaNumChar); }</span>
<a href="#l50.23"></a><span id="l50.23" class="difflineplus">+  inline static bool IsDigit(PRUint8 ch) { return ((m_Ascii[ch] &amp; cDigitChar) == cDigitChar); }</span>
<a href="#l50.24"></a><span id="l50.24"> </span>
<a href="#l50.25"></a><span id="l50.25" class="difflineminus">-  inline static PRUint8 ToLower( PRUint8 ch) { if ((m_Ascii[ch] &amp; cAlphaChar) == cAlphaChar) { return( cLowerAChar + (m_upperCaseMap[ch] - cUpperAChar)); } else return( ch); }</span>
<a href="#l50.26"></a><span id="l50.26" class="difflineplus">+  inline static PRUint8 ToLower(PRUint8 ch) { if ((m_Ascii[ch] &amp; cAlphaChar) == cAlphaChar) { return cLowerAChar + (m_upperCaseMap[ch] - cUpperAChar); } else return ch; }</span>
<a href="#l50.27"></a><span id="l50.27"> </span>
<a href="#l50.28"></a><span id="l50.28" class="difflineminus">-  inline static long AsciiToLong( const PRUint8 * pChar, PRUint32 len) {</span>
<a href="#l50.29"></a><span id="l50.29" class="difflineplus">+  inline static long AsciiToLong(const PRUint8 * pChar, PRUint32 len) {</span>
<a href="#l50.30"></a><span id="l50.30">     long num = 0;</span>
<a href="#l50.31"></a><span id="l50.31">     while (len) {</span>
<a href="#l50.32"></a><span id="l50.32">       if ((m_Ascii[*pChar] &amp; cDigitChar) == 0)</span>
<a href="#l50.33"></a><span id="l50.33" class="difflineminus">-        return( num);</span>
<a href="#l50.34"></a><span id="l50.34" class="difflineplus">+        return num;</span>
<a href="#l50.35"></a><span id="l50.35">       num *= 10;</span>
<a href="#l50.36"></a><span id="l50.36">       num += (*pChar - cZeroChar);</span>
<a href="#l50.37"></a><span id="l50.37">       len--;</span>
<a href="#l50.38"></a><span id="l50.38">       pChar++;</span>
<a href="#l50.39"></a><span id="l50.39">     }</span>
<a href="#l50.40"></a><span id="l50.40" class="difflineminus">-    return( num);</span>
<a href="#l50.41"></a><span id="l50.41" class="difflineplus">+    return num;</span>
<a href="#l50.42"></a><span id="l50.42">   }</span>
<a href="#l50.43"></a><span id="l50.43"> </span>
<a href="#l50.44"></a><span id="l50.44" class="difflineminus">-  inline static void ByteToHex( PRUint8 byte, PRUint8 * pHex) {</span>
<a href="#l50.45"></a><span id="l50.45" class="difflineplus">+  inline static void ByteToHex(PRUint8 byte, PRUint8 * pHex) {</span>
<a href="#l50.46"></a><span id="l50.46">     PRUint8 val = byte;</span>
<a href="#l50.47"></a><span id="l50.47">     val /= 16;</span>
<a href="#l50.48"></a><span id="l50.48">     if (val &lt; 10)</span>
<a href="#l50.49"></a><span id="l50.49">       *pHex = '0' + val;</span>
<a href="#l50.50"></a><span id="l50.50">     else</span>
<a href="#l50.51"></a><span id="l50.51">       *pHex = 'A' + (val - 10);</span>
<a href="#l50.52"></a><span id="l50.52">     pHex++;</span>
<a href="#l50.53"></a><span id="l50.53">     val = byte;</span>
<a href="#l50.54"></a><span id="l50.54">     val &amp;= 0x0F;</span>
<a href="#l50.55"></a><span id="l50.55">     if (val &lt; 10)</span>
<a href="#l50.56"></a><span id="l50.56">       *pHex = '0' + val;</span>
<a href="#l50.57"></a><span id="l50.57">     else</span>
<a href="#l50.58"></a><span id="l50.58">       *pHex = 'A' + (val - 10);</span>
<a href="#l50.59"></a><span id="l50.59">   }</span>
<a href="#l50.60"></a><span id="l50.60"> </span>
<a href="#l50.61"></a><span id="l50.61" class="difflineminus">-  inline static void  LongToHexBytes( PRUint32 type, PRUint8 * pStr) {</span>
<a href="#l50.62"></a><span id="l50.62" class="difflineminus">-    ByteToHex( (PRUint8) (type &gt;&gt; 24), pStr);</span>
<a href="#l50.63"></a><span id="l50.63" class="difflineplus">+  inline static void  LongToHexBytes(PRUint32 type, PRUint8 * pStr) {</span>
<a href="#l50.64"></a><span id="l50.64" class="difflineplus">+    ByteToHex((PRUint8) (type &gt;&gt; 24), pStr);</span>
<a href="#l50.65"></a><span id="l50.65">     pStr += 2;</span>
<a href="#l50.66"></a><span id="l50.66" class="difflineminus">-    ByteToHex( (PRUint8) ((type &gt;&gt; 16) &amp; 0x0FF), pStr);</span>
<a href="#l50.67"></a><span id="l50.67" class="difflineplus">+    ByteToHex((PRUint8) ((type &gt;&gt; 16) &amp; 0x0FF), pStr);</span>
<a href="#l50.68"></a><span id="l50.68">     pStr += 2;</span>
<a href="#l50.69"></a><span id="l50.69" class="difflineminus">-    ByteToHex( (PRUint8) ((type &gt;&gt; 8) &amp; 0x0FF), pStr);</span>
<a href="#l50.70"></a><span id="l50.70" class="difflineplus">+    ByteToHex((PRUint8) ((type &gt;&gt; 8) &amp; 0x0FF), pStr);</span>
<a href="#l50.71"></a><span id="l50.71">     pStr += 2;</span>
<a href="#l50.72"></a><span id="l50.72" class="difflineminus">-    ByteToHex( (PRUint8) (type &amp; 0x0FF), pStr);</span>
<a href="#l50.73"></a><span id="l50.73" class="difflineplus">+    ByteToHex((PRUint8) (type &amp; 0x0FF), pStr);</span>
<a href="#l50.74"></a><span id="l50.74">   }</span>
<a href="#l50.75"></a><span id="l50.75"> </span>
<a href="#l50.76"></a><span id="l50.76" class="difflineminus">-  inline static void SkipWhiteSpace( const PRUint8 * &amp; pChar, PRUint32 &amp; pos, PRUint32 max) {</span>
<a href="#l50.77"></a><span id="l50.77" class="difflineminus">-    while ((pos &lt; max) &amp;&amp; (IsWhiteSpace( *pChar))) {</span>
<a href="#l50.78"></a><span id="l50.78" class="difflineplus">+  inline static void SkipWhiteSpace(const PRUint8 * &amp; pChar, PRUint32 &amp; pos, PRUint32 max) {</span>
<a href="#l50.79"></a><span id="l50.79" class="difflineplus">+    while ((pos &lt; max) &amp;&amp; (IsWhiteSpace(*pChar))) {</span>
<a href="#l50.80"></a><span id="l50.80">       pos++; pChar++;</span>
<a href="#l50.81"></a><span id="l50.81">     }</span>
<a href="#l50.82"></a><span id="l50.82">   }</span>
<a href="#l50.83"></a><span id="l50.83"> </span>
<a href="#l50.84"></a><span id="l50.84" class="difflineminus">-  inline static void SkipSpaceTab( const PRUint8 * &amp; pChar, PRUint32&amp; pos, PRUint32 max) {</span>
<a href="#l50.85"></a><span id="l50.85" class="difflineplus">+  inline static void SkipSpaceTab(const PRUint8 * &amp; pChar, PRUint32&amp; pos, PRUint32 max) {</span>
<a href="#l50.86"></a><span id="l50.86">     while ((pos &lt; max) &amp;&amp; ((*pChar == (PRUint8)cSpaceChar) || (*pChar == (PRUint8)cTabChar))) {</span>
<a href="#l50.87"></a><span id="l50.87">       pos++; pChar++;</span>
<a href="#l50.88"></a><span id="l50.88">     }</span>
<a href="#l50.89"></a><span id="l50.89">   }</span>
<a href="#l50.90"></a><span id="l50.90"> </span>
<a href="#l50.91"></a><span id="l50.91" class="difflineminus">-  inline static void SkipTilSpaceTab( const PRUint8 * &amp; pChar, PRUint32&amp; pos, PRUint32 max) {</span>
<a href="#l50.92"></a><span id="l50.92" class="difflineplus">+  inline static void SkipTilSpaceTab(const PRUint8 * &amp; pChar, PRUint32&amp; pos, PRUint32 max) {</span>
<a href="#l50.93"></a><span id="l50.93">     while ((pos &lt; max) &amp;&amp; (*pChar != (PRUint8)cSpaceChar) &amp;&amp; (*pChar != (PRUint8)cTabChar)) {</span>
<a href="#l50.94"></a><span id="l50.94">       pos++;</span>
<a href="#l50.95"></a><span id="l50.95">       pChar++;</span>
<a href="#l50.96"></a><span id="l50.96">     }</span>
<a href="#l50.97"></a><span id="l50.97">   }</span>
<a href="#l50.98"></a><span id="l50.98"> </span>
<a href="#l50.99"></a><span id="l50.99" class="difflineminus">-  inline static bool StrNICmp( const PRUint8 * pChar, const PRUint8 * pSrc, PRUint32 len) {</span>
<a href="#l50.100"></a><span id="l50.100" class="difflineplus">+  inline static bool StrNICmp(const PRUint8 * pChar, const PRUint8 * pSrc, PRUint32 len) {</span>
<a href="#l50.101"></a><span id="l50.101">     while (len &amp;&amp; (m_upperCaseMap[*pChar] == m_upperCaseMap[*pSrc])) {</span>
<a href="#l50.102"></a><span id="l50.102">       pChar++; pSrc++; len--;</span>
<a href="#l50.103"></a><span id="l50.103">     }</span>
<a href="#l50.104"></a><span id="l50.104" class="difflineminus">-    return( len == 0);</span>
<a href="#l50.105"></a><span id="l50.105" class="difflineplus">+    return len == 0;</span>
<a href="#l50.106"></a><span id="l50.106">   }</span>
<a href="#l50.107"></a><span id="l50.107"> </span>
<a href="#l50.108"></a><span id="l50.108" class="difflineminus">-  inline static bool StrNCmp( const PRUint8 * pChar, const PRUint8 *pSrc, PRUint32 len) {</span>
<a href="#l50.109"></a><span id="l50.109" class="difflineplus">+  inline static bool StrNCmp(const PRUint8 * pChar, const PRUint8 *pSrc, PRUint32 len) {</span>
<a href="#l50.110"></a><span id="l50.110">     while (len &amp;&amp; (*pChar == *pSrc)) {</span>
<a href="#l50.111"></a><span id="l50.111">       pChar++; pSrc++; len--;</span>
<a href="#l50.112"></a><span id="l50.112">     }</span>
<a href="#l50.113"></a><span id="l50.113" class="difflineminus">-    return( len == 0);</span>
<a href="#l50.114"></a><span id="l50.114" class="difflineplus">+    return len == 0;</span>
<a href="#l50.115"></a><span id="l50.115">   }</span>
<a href="#l50.116"></a><span id="l50.116"> </span>
<a href="#l50.117"></a><span id="l50.117" class="difflineminus">-  inline static int FindChar( const PRUint8 * pChar, PRUint8 ch, PRUint32 max) {</span>
<a href="#l50.118"></a><span id="l50.118" class="difflineplus">+  inline static int FindChar(const PRUint8 * pChar, PRUint8 ch, PRUint32 max) {</span>
<a href="#l50.119"></a><span id="l50.119">     PRUint32    pos = 0;</span>
<a href="#l50.120"></a><span id="l50.120">     while ((pos &lt; max) &amp;&amp; (*pChar != ch)) {</span>
<a href="#l50.121"></a><span id="l50.121">       pos++; pChar++;</span>
<a href="#l50.122"></a><span id="l50.122">     }</span>
<a href="#l50.123"></a><span id="l50.123">     if (pos &lt; max)</span>
<a href="#l50.124"></a><span id="l50.124" class="difflineminus">-      return( (int) pos);</span>
<a href="#l50.125"></a><span id="l50.125" class="difflineplus">+      return (int) pos;</span>
<a href="#l50.126"></a><span id="l50.126">     else</span>
<a href="#l50.127"></a><span id="l50.127" class="difflineminus">-      return( -1);</span>
<a href="#l50.128"></a><span id="l50.128" class="difflineplus">+      return -1;</span>
<a href="#l50.129"></a><span id="l50.129">   }</span>
<a href="#l50.130"></a><span id="l50.130"> </span>
<a href="#l50.131"></a><span id="l50.131" class="difflineminus">-  inline static bool NextChar( const PRUint8 * &amp; pChar, PRUint8 ch, PRUint32&amp; pos, PRUint32 max) {</span>
<a href="#l50.132"></a><span id="l50.132" class="difflineplus">+  inline static bool NextChar(const PRUint8 * &amp; pChar, PRUint8 ch, PRUint32&amp; pos, PRUint32 max) {</span>
<a href="#l50.133"></a><span id="l50.133">     if ((pos &lt; max) &amp;&amp; (*pChar == ch)) {</span>
<a href="#l50.134"></a><span id="l50.134">       pos++;</span>
<a href="#l50.135"></a><span id="l50.135">       pChar++;</span>
<a href="#l50.136"></a><span id="l50.136" class="difflineminus">-      return( true);</span>
<a href="#l50.137"></a><span id="l50.137" class="difflineplus">+      return true;</span>
<a href="#l50.138"></a><span id="l50.138">     }</span>
<a href="#l50.139"></a><span id="l50.139" class="difflineminus">-    return( false);</span>
<a href="#l50.140"></a><span id="l50.140" class="difflineplus">+    return false;</span>
<a href="#l50.141"></a><span id="l50.141">   }</span>
<a href="#l50.142"></a><span id="l50.142"> </span>
<a href="#l50.143"></a><span id="l50.143" class="difflineminus">-  inline static PRInt32 strcmp( const char * pS1, const char * pS2) {</span>
<a href="#l50.144"></a><span id="l50.144" class="difflineplus">+  inline static PRInt32 strcmp(const char * pS1, const char * pS2) {</span>
<a href="#l50.145"></a><span id="l50.145">     while (*pS1 &amp;&amp; *pS2 &amp;&amp; (*pS1 == *pS2)) {</span>
<a href="#l50.146"></a><span id="l50.146">       pS1++;</span>
<a href="#l50.147"></a><span id="l50.147">       pS2++;</span>
<a href="#l50.148"></a><span id="l50.148">     }</span>
<a href="#l50.149"></a><span id="l50.149" class="difflineminus">-    return( *pS1 - *pS2);</span>
<a href="#l50.150"></a><span id="l50.150" class="difflineplus">+    return *pS1 - *pS2;</span>
<a href="#l50.151"></a><span id="l50.151">   }</span>
<a href="#l50.152"></a><span id="l50.152"> </span>
<a href="#l50.153"></a><span id="l50.153" class="difflineminus">-  inline static PRInt32 stricmp( const char * pS1, const char * pS2) {</span>
<a href="#l50.154"></a><span id="l50.154" class="difflineplus">+  inline static PRInt32 stricmp(const char * pS1, const char * pS2) {</span>
<a href="#l50.155"></a><span id="l50.155">     while (*pS1 &amp;&amp; *pS2 &amp;&amp; (m_upperCaseMap[PRUint8(*pS1)] == m_upperCaseMap[PRUint8(*pS2)])) {</span>
<a href="#l50.156"></a><span id="l50.156">       pS1++;</span>
<a href="#l50.157"></a><span id="l50.157">       pS2++;</span>
<a href="#l50.158"></a><span id="l50.158">     }</span>
<a href="#l50.159"></a><span id="l50.159" class="difflineminus">-    return( m_upperCaseMap[PRUint8(*pS1)] - m_upperCaseMap[PRUint8(*pS2)]);</span>
<a href="#l50.160"></a><span id="l50.160" class="difflineplus">+    return m_upperCaseMap[PRUint8(*pS1)] - m_upperCaseMap[PRUint8(*pS2)];</span>
<a href="#l50.161"></a><span id="l50.161">   }</span>
<a href="#l50.162"></a><span id="l50.162"> </span>
<a href="#l50.163"></a><span id="l50.163"> };</span>
<a href="#l50.164"></a><span id="l50.164"> </span>
<a href="#l50.165"></a><span id="l50.165"> </span>
<a href="#l50.166"></a><span id="l50.166"> #endif /* ImportCharSet_h__ */</span>
<a href="#l50.167"></a><span id="l50.167"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mailnews/import/src/ImportOutFile.cpp</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mailnews/import/src/ImportOutFile.cpp</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -62,271 +62,270 @@ ImportOutFile::ImportOutFile()</span>
<a href="#l51.4"></a><span id="l51.4">   m_pos = 0;</span>
<a href="#l51.5"></a><span id="l51.5">   m_pBuf = nsnull;</span>
<a href="#l51.6"></a><span id="l51.6">   m_bufSz = 0;</span>
<a href="#l51.7"></a><span id="l51.7">   m_pTrans = nsnull;</span>
<a href="#l51.8"></a><span id="l51.8">   m_pTransOut = nsnull;</span>
<a href="#l51.9"></a><span id="l51.9">   m_pTransBuf = nsnull;</span>
<a href="#l51.10"></a><span id="l51.10"> }</span>
<a href="#l51.11"></a><span id="l51.11"> </span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-ImportOutFile::ImportOutFile( nsIFile *pFile, PRUint8 * pBuf, PRUint32 sz)</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+ImportOutFile::ImportOutFile(nsIFile *pFile, PRUint8 * pBuf, PRUint32 sz)</span>
<a href="#l51.14"></a><span id="l51.14"> {</span>
<a href="#l51.15"></a><span id="l51.15">   m_pTransBuf = nsnull;</span>
<a href="#l51.16"></a><span id="l51.16">   m_pTransOut = nsnull;</span>
<a href="#l51.17"></a><span id="l51.17">   m_pTrans = nsnull;</span>
<a href="#l51.18"></a><span id="l51.18">   m_ownsFileAndBuffer = false;</span>
<a href="#l51.19"></a><span id="l51.19" class="difflineminus">-  InitOutFile( pFile, pBuf, sz);</span>
<a href="#l51.20"></a><span id="l51.20" class="difflineplus">+  InitOutFile(pFile, pBuf, sz);</span>
<a href="#l51.21"></a><span id="l51.21"> }</span>
<a href="#l51.22"></a><span id="l51.22"> </span>
<a href="#l51.23"></a><span id="l51.23"> ImportOutFile::~ImportOutFile()</span>
<a href="#l51.24"></a><span id="l51.24"> {</span>
<a href="#l51.25"></a><span id="l51.25">   if (m_ownsFileAndBuffer)</span>
<a href="#l51.26"></a><span id="l51.26">   {</span>
<a href="#l51.27"></a><span id="l51.27">     Flush();</span>
<a href="#l51.28"></a><span id="l51.28">     delete [] m_pBuf;</span>
<a href="#l51.29"></a><span id="l51.29">   }</span>
<a href="#l51.30"></a><span id="l51.30"> </span>
<a href="#l51.31"></a><span id="l51.31">   delete m_pTrans;</span>
<a href="#l51.32"></a><span id="l51.32">   delete m_pTransOut;</span>
<a href="#l51.33"></a><span id="l51.33">   delete m_pTransBuf;</span>
<a href="#l51.34"></a><span id="l51.34"> }</span>
<a href="#l51.35"></a><span id="l51.35"> </span>
<a href="#l51.36"></a><span id="l51.36" class="difflineminus">-bool ImportOutFile::Set8bitTranslator( nsImportTranslator *pTrans)</span>
<a href="#l51.37"></a><span id="l51.37" class="difflineplus">+bool ImportOutFile::Set8bitTranslator(nsImportTranslator *pTrans)</span>
<a href="#l51.38"></a><span id="l51.38"> {</span>
<a href="#l51.39"></a><span id="l51.39">   if (!Flush())</span>
<a href="#l51.40"></a><span id="l51.40" class="difflineminus">-    return( false);</span>
<a href="#l51.41"></a><span id="l51.41" class="difflineplus">+    return false;</span>
<a href="#l51.42"></a><span id="l51.42"> </span>
<a href="#l51.43"></a><span id="l51.43">   m_engaged = false;</span>
<a href="#l51.44"></a><span id="l51.44">   m_pTrans = pTrans;</span>
<a href="#l51.45"></a><span id="l51.45">   m_supports8to7 = pTrans-&gt;Supports8bitEncoding();</span>
<a href="#l51.46"></a><span id="l51.46"> </span>
<a href="#l51.47"></a><span id="l51.47"> </span>
<a href="#l51.48"></a><span id="l51.48" class="difflineminus">-  return( true);</span>
<a href="#l51.49"></a><span id="l51.49" class="difflineplus">+  return true;</span>
<a href="#l51.50"></a><span id="l51.50"> }</span>
<a href="#l51.51"></a><span id="l51.51"> </span>
<a href="#l51.52"></a><span id="l51.52" class="difflineminus">-bool ImportOutFile::End8bitTranslation( bool *pEngaged, nsCString&amp; useCharset, nsCString&amp; encoding)</span>
<a href="#l51.53"></a><span id="l51.53" class="difflineplus">+bool ImportOutFile::End8bitTranslation(bool *pEngaged, nsCString&amp; useCharset, nsCString&amp; encoding)</span>
<a href="#l51.54"></a><span id="l51.54"> {</span>
<a href="#l51.55"></a><span id="l51.55">   if (!m_pTrans)</span>
<a href="#l51.56"></a><span id="l51.56" class="difflineminus">-    return( false);</span>
<a href="#l51.57"></a><span id="l51.57" class="difflineplus">+    return false;</span>
<a href="#l51.58"></a><span id="l51.58"> </span>
<a href="#l51.59"></a><span id="l51.59"> </span>
<a href="#l51.60"></a><span id="l51.60">   bool bResult = Flush();</span>
<a href="#l51.61"></a><span id="l51.61">   if (m_supports8to7 &amp;&amp; m_pTransOut) {</span>
<a href="#l51.62"></a><span id="l51.62">     if (bResult)</span>
<a href="#l51.63"></a><span id="l51.63" class="difflineminus">-      bResult = m_pTrans-&gt;FinishConvertToFile( m_pTransOut);</span>
<a href="#l51.64"></a><span id="l51.64" class="difflineplus">+      bResult = m_pTrans-&gt;FinishConvertToFile(m_pTransOut);</span>
<a href="#l51.65"></a><span id="l51.65">     if (bResult)</span>
<a href="#l51.66"></a><span id="l51.66">       bResult = Flush();</span>
<a href="#l51.67"></a><span id="l51.67">   }</span>
<a href="#l51.68"></a><span id="l51.68"> </span>
<a href="#l51.69"></a><span id="l51.69">   if (m_supports8to7) {</span>
<a href="#l51.70"></a><span id="l51.70" class="difflineminus">-    m_pTrans-&gt;GetCharset( useCharset);</span>
<a href="#l51.71"></a><span id="l51.71" class="difflineminus">-    m_pTrans-&gt;GetEncoding( encoding);</span>
<a href="#l51.72"></a><span id="l51.72" class="difflineplus">+    m_pTrans-&gt;GetCharset(useCharset);</span>
<a href="#l51.73"></a><span id="l51.73" class="difflineplus">+    m_pTrans-&gt;GetEncoding(encoding);</span>
<a href="#l51.74"></a><span id="l51.74">   }</span>
<a href="#l51.75"></a><span id="l51.75">   else</span>
<a href="#l51.76"></a><span id="l51.76">     useCharset.Truncate();</span>
<a href="#l51.77"></a><span id="l51.77">   *pEngaged = m_engaged;</span>
<a href="#l51.78"></a><span id="l51.78">   delete m_pTrans;</span>
<a href="#l51.79"></a><span id="l51.79">   m_pTrans = nsnull;</span>
<a href="#l51.80"></a><span id="l51.80">   delete m_pTransOut;</span>
<a href="#l51.81"></a><span id="l51.81">   m_pTransOut = nsnull;</span>
<a href="#l51.82"></a><span id="l51.82">   delete m_pTransBuf;</span>
<a href="#l51.83"></a><span id="l51.83">   m_pTransBuf = nsnull;</span>
<a href="#l51.84"></a><span id="l51.84"> </span>
<a href="#l51.85"></a><span id="l51.85" class="difflineminus">-  return( bResult);</span>
<a href="#l51.86"></a><span id="l51.86" class="difflineplus">+  return bResult;</span>
<a href="#l51.87"></a><span id="l51.87"> }</span>
<a href="#l51.88"></a><span id="l51.88"> </span>
<a href="#l51.89"></a><span id="l51.89" class="difflineminus">-bool ImportOutFile::InitOutFile( nsIFile *pFile, PRUint32 bufSz)</span>
<a href="#l51.90"></a><span id="l51.90" class="difflineplus">+bool ImportOutFile::InitOutFile(nsIFile *pFile, PRUint32 bufSz)</span>
<a href="#l51.91"></a><span id="l51.91"> {</span>
<a href="#l51.92"></a><span id="l51.92">   if (!bufSz)</span>
<a href="#l51.93"></a><span id="l51.93">     bufSz = 32 * 1024;</span>
<a href="#l51.94"></a><span id="l51.94" class="difflineminus">-  if (!m_pBuf) {</span>
<a href="#l51.95"></a><span id="l51.95" class="difflineplus">+  if (!m_pBuf)</span>
<a href="#l51.96"></a><span id="l51.96">     m_pBuf = new PRUint8[ bufSz];</span>
<a href="#l51.97"></a><span id="l51.97" class="difflineminus">-  }</span>
<a href="#l51.98"></a><span id="l51.98"> </span>
<a href="#l51.99"></a><span id="l51.99" class="difflineminus">-  // m_fH = UFile::CreateFile( oFile, kMacNoCreator, kMacTextFile);</span>
<a href="#l51.100"></a><span id="l51.100" class="difflineminus">-        if (!m_outputStream)</span>
<a href="#l51.101"></a><span id="l51.101" class="difflineminus">-        {</span>
<a href="#l51.102"></a><span id="l51.102" class="difflineminus">-          nsresult rv = MsgNewBufferedFileOutputStream(getter_AddRefs(m_outputStream),</span>
<a href="#l51.103"></a><span id="l51.103" class="difflineminus">-                                   pFile,</span>
<a href="#l51.104"></a><span id="l51.104" class="difflineminus">-                                   PR_CREATE_FILE | PR_WRONLY | PR_TRUNCATE,</span>
<a href="#l51.105"></a><span id="l51.105" class="difflineminus">-                                   0644);</span>
<a href="#l51.106"></a><span id="l51.106" class="difflineplus">+  if (!m_outputStream)</span>
<a href="#l51.107"></a><span id="l51.107" class="difflineplus">+  {</span>
<a href="#l51.108"></a><span id="l51.108" class="difflineplus">+    nsresult rv;</span>
<a href="#l51.109"></a><span id="l51.109" class="difflineplus">+    rv = MsgNewBufferedFileOutputStream(getter_AddRefs(m_outputStream),</span>
<a href="#l51.110"></a><span id="l51.110" class="difflineplus">+                                        pFile,</span>
<a href="#l51.111"></a><span id="l51.111" class="difflineplus">+                                        PR_CREATE_FILE | PR_WRONLY | PR_TRUNCATE,</span>
<a href="#l51.112"></a><span id="l51.112" class="difflineplus">+                                        0644);</span>
<a href="#l51.113"></a><span id="l51.113"> </span>
<a href="#l51.114"></a><span id="l51.114" class="difflineminus">-    if (NS_FAILED( rv))</span>
<a href="#l51.115"></a><span id="l51.115" class="difflineminus">-                {</span>
<a href="#l51.116"></a><span id="l51.116" class="difflineminus">-      IMPORT_LOG0( &quot;Couldn't create outfile\n&quot;);</span>
<a href="#l51.117"></a><span id="l51.117" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l51.118"></a><span id="l51.118" class="difflineplus">+    {</span>
<a href="#l51.119"></a><span id="l51.119" class="difflineplus">+      IMPORT_LOG0(&quot;Couldn't create outfile\n&quot;);</span>
<a href="#l51.120"></a><span id="l51.120">       delete [] m_pBuf;</span>
<a href="#l51.121"></a><span id="l51.121">       m_pBuf = nsnull;</span>
<a href="#l51.122"></a><span id="l51.122" class="difflineminus">-      return( false);</span>
<a href="#l51.123"></a><span id="l51.123" class="difflineplus">+      return false;</span>
<a href="#l51.124"></a><span id="l51.124">     }</span>
<a href="#l51.125"></a><span id="l51.125">   }</span>
<a href="#l51.126"></a><span id="l51.126">   m_pFile = pFile;</span>
<a href="#l51.127"></a><span id="l51.127">   m_ownsFileAndBuffer = true;</span>
<a href="#l51.128"></a><span id="l51.128">   m_pos = 0;</span>
<a href="#l51.129"></a><span id="l51.129">   m_bufSz = bufSz;</span>
<a href="#l51.130"></a><span id="l51.130" class="difflineminus">-  return( true);</span>
<a href="#l51.131"></a><span id="l51.131" class="difflineplus">+  return true;</span>
<a href="#l51.132"></a><span id="l51.132"> }</span>
<a href="#l51.133"></a><span id="l51.133"> </span>
<a href="#l51.134"></a><span id="l51.134" class="difflineminus">-void ImportOutFile::InitOutFile( nsIFile *pFile, PRUint8 * pBuf, PRUint32 sz)</span>
<a href="#l51.135"></a><span id="l51.135" class="difflineplus">+void ImportOutFile::InitOutFile(nsIFile *pFile, PRUint8 * pBuf, PRUint32 sz)</span>
<a href="#l51.136"></a><span id="l51.136"> {</span>
<a href="#l51.137"></a><span id="l51.137">   m_ownsFileAndBuffer = false;</span>
<a href="#l51.138"></a><span id="l51.138">   m_pFile = pFile;</span>
<a href="#l51.139"></a><span id="l51.139">   m_pBuf = pBuf;</span>
<a href="#l51.140"></a><span id="l51.140">   m_bufSz = sz;</span>
<a href="#l51.141"></a><span id="l51.141">   m_pos = 0;</span>
<a href="#l51.142"></a><span id="l51.142"> }</span>
<a href="#l51.143"></a><span id="l51.143"> </span>
<a href="#l51.144"></a><span id="l51.144"> </span>
<a href="#l51.145"></a><span id="l51.145"> </span>
<a href="#l51.146"></a><span id="l51.146" class="difflineminus">-bool ImportOutFile::Flush( void)</span>
<a href="#l51.147"></a><span id="l51.147" class="difflineplus">+bool ImportOutFile::Flush(void)</span>
<a href="#l51.148"></a><span id="l51.148"> {</span>
<a href="#l51.149"></a><span id="l51.149">   if (!m_pos)</span>
<a href="#l51.150"></a><span id="l51.150" class="difflineminus">-    return( true);</span>
<a href="#l51.151"></a><span id="l51.151" class="difflineplus">+    return true;</span>
<a href="#l51.152"></a><span id="l51.152"> </span>
<a href="#l51.153"></a><span id="l51.153">   PRUint32  transLen;</span>
<a href="#l51.154"></a><span id="l51.154">   bool      duddleyDoWrite = false;</span>
<a href="#l51.155"></a><span id="l51.155"> </span>
<a href="#l51.156"></a><span id="l51.156">   // handle translations if appropriate</span>
<a href="#l51.157"></a><span id="l51.157">   if (m_pTrans) {</span>
<a href="#l51.158"></a><span id="l51.158">     if (m_engaged &amp;&amp; m_supports8to7) {</span>
<a href="#l51.159"></a><span id="l51.159">       // Markers can get confused by this crap!!!</span>
<a href="#l51.160"></a><span id="l51.160">       // TLR: FIXME: Need to update the markers based on</span>
<a href="#l51.161"></a><span id="l51.161">       // the difference between the translated len and untranslated len</span>
<a href="#l51.162"></a><span id="l51.162"> </span>
<a href="#l51.163"></a><span id="l51.163" class="difflineminus">-      if (!m_pTrans-&gt;ConvertToFile(  m_pBuf, m_pos, m_pTransOut, &amp;transLen))</span>
<a href="#l51.164"></a><span id="l51.164" class="difflineminus">-        return( false);</span>
<a href="#l51.165"></a><span id="l51.165" class="difflineplus">+      if (!m_pTrans-&gt;ConvertToFile( m_pBuf, m_pos, m_pTransOut, &amp;transLen))</span>
<a href="#l51.166"></a><span id="l51.166" class="difflineplus">+        return false;</span>
<a href="#l51.167"></a><span id="l51.167">       if (!m_pTransOut-&gt;Flush())</span>
<a href="#l51.168"></a><span id="l51.168" class="difflineminus">-        return( false);</span>
<a href="#l51.169"></a><span id="l51.169" class="difflineplus">+        return false;</span>
<a href="#l51.170"></a><span id="l51.170">       // now update our buffer...</span>
<a href="#l51.171"></a><span id="l51.171">       if (transLen &lt; m_pos) {</span>
<a href="#l51.172"></a><span id="l51.172" class="difflineminus">-        memcpy( m_pBuf, m_pBuf + transLen, m_pos - transLen);</span>
<a href="#l51.173"></a><span id="l51.173" class="difflineplus">+        memcpy(m_pBuf, m_pBuf + transLen, m_pos - transLen);</span>
<a href="#l51.174"></a><span id="l51.174">       }</span>
<a href="#l51.175"></a><span id="l51.175">       m_pos -= transLen;</span>
<a href="#l51.176"></a><span id="l51.176">     }</span>
<a href="#l51.177"></a><span id="l51.177">     else if (m_engaged) {</span>
<a href="#l51.178"></a><span id="l51.178">       // does not actually support translation!</span>
<a href="#l51.179"></a><span id="l51.179">       duddleyDoWrite = true;</span>
<a href="#l51.180"></a><span id="l51.180">     }</span>
<a href="#l51.181"></a><span id="l51.181">     else {</span>
<a href="#l51.182"></a><span id="l51.182">       // should we engage?</span>
<a href="#l51.183"></a><span id="l51.183">       PRUint8 *  pChar = m_pBuf;</span>
<a href="#l51.184"></a><span id="l51.184">       PRUint32  len = m_pos;</span>
<a href="#l51.185"></a><span id="l51.185">       while (len) {</span>
<a href="#l51.186"></a><span id="l51.186" class="difflineminus">-        if (!ImportCharSet::IsUSAscii( *pChar))</span>
<a href="#l51.187"></a><span id="l51.187" class="difflineplus">+        if (!ImportCharSet::IsUSAscii(*pChar))</span>
<a href="#l51.188"></a><span id="l51.188">           break;</span>
<a href="#l51.189"></a><span id="l51.189">         pChar++;</span>
<a href="#l51.190"></a><span id="l51.190">         len--;</span>
<a href="#l51.191"></a><span id="l51.191">       }</span>
<a href="#l51.192"></a><span id="l51.192">       if (len) {</span>
<a href="#l51.193"></a><span id="l51.193">         m_engaged = true;</span>
<a href="#l51.194"></a><span id="l51.194">         if (m_supports8to7) {</span>
<a href="#l51.195"></a><span id="l51.195">           // allocate our translation output buffer and file...</span>
<a href="#l51.196"></a><span id="l51.196">           m_pTransBuf = new PRUint8[m_bufSz];</span>
<a href="#l51.197"></a><span id="l51.197" class="difflineminus">-          m_pTransOut = new ImportOutFile( m_pFile, m_pTransBuf, m_bufSz);</span>
<a href="#l51.198"></a><span id="l51.198" class="difflineminus">-          return( Flush());</span>
<a href="#l51.199"></a><span id="l51.199" class="difflineplus">+          m_pTransOut = new ImportOutFile(m_pFile, m_pTransBuf, m_bufSz);</span>
<a href="#l51.200"></a><span id="l51.200" class="difflineplus">+          return Flush();</span>
<a href="#l51.201"></a><span id="l51.201">         }</span>
<a href="#l51.202"></a><span id="l51.202">         else</span>
<a href="#l51.203"></a><span id="l51.203">           duddleyDoWrite = true;</span>
<a href="#l51.204"></a><span id="l51.204">       }</span>
<a href="#l51.205"></a><span id="l51.205">       else {</span>
<a href="#l51.206"></a><span id="l51.206">         duddleyDoWrite = true;</span>
<a href="#l51.207"></a><span id="l51.207">       }</span>
<a href="#l51.208"></a><span id="l51.208">     }</span>
<a href="#l51.209"></a><span id="l51.209">   }</span>
<a href="#l51.210"></a><span id="l51.210">   else</span>
<a href="#l51.211"></a><span id="l51.211">     duddleyDoWrite = true;</span>
<a href="#l51.212"></a><span id="l51.212"> </span>
<a href="#l51.213"></a><span id="l51.213">   if (duddleyDoWrite) {</span>
<a href="#l51.214"></a><span id="l51.214">     PRUint32 written = 0;</span>
<a href="#l51.215"></a><span id="l51.215" class="difflineminus">-    nsresult rv = m_outputStream-&gt;Write( (const char *)m_pBuf, (PRInt32)m_pos, &amp;written);</span>
<a href="#l51.216"></a><span id="l51.216" class="difflineminus">-    if (NS_FAILED( rv) || ((PRUint32)written != m_pos))</span>
<a href="#l51.217"></a><span id="l51.217" class="difflineminus">-      return( false);</span>
<a href="#l51.218"></a><span id="l51.218" class="difflineplus">+    nsresult rv = m_outputStream-&gt;Write((const char *)m_pBuf, (PRInt32)m_pos, &amp;written);</span>
<a href="#l51.219"></a><span id="l51.219" class="difflineplus">+    if (NS_FAILED(rv) || ((PRUint32)written != m_pos))</span>
<a href="#l51.220"></a><span id="l51.220" class="difflineplus">+      return false;</span>
<a href="#l51.221"></a><span id="l51.221">     m_pos = 0;</span>
<a href="#l51.222"></a><span id="l51.222">   }</span>
<a href="#l51.223"></a><span id="l51.223"> </span>
<a href="#l51.224"></a><span id="l51.224" class="difflineminus">-  return( true);</span>
<a href="#l51.225"></a><span id="l51.225" class="difflineplus">+  return true;</span>
<a href="#l51.226"></a><span id="l51.226"> }</span>
<a href="#l51.227"></a><span id="l51.227"> </span>
<a href="#l51.228"></a><span id="l51.228" class="difflineminus">-bool ImportOutFile::WriteU8NullTerm( const PRUint8 * pSrc, bool includeNull)</span>
<a href="#l51.229"></a><span id="l51.229" class="difflineplus">+bool ImportOutFile::WriteU8NullTerm(const PRUint8 * pSrc, bool includeNull)</span>
<a href="#l51.230"></a><span id="l51.230"> {</span>
<a href="#l51.231"></a><span id="l51.231">   while (*pSrc) {</span>
<a href="#l51.232"></a><span id="l51.232">     if (m_pos &gt;= m_bufSz) {</span>
<a href="#l51.233"></a><span id="l51.233">       if (!Flush())</span>
<a href="#l51.234"></a><span id="l51.234" class="difflineminus">-        return( false);</span>
<a href="#l51.235"></a><span id="l51.235" class="difflineplus">+        return false;</span>
<a href="#l51.236"></a><span id="l51.236">     }</span>
<a href="#l51.237"></a><span id="l51.237">     *(m_pBuf + m_pos) = *pSrc;</span>
<a href="#l51.238"></a><span id="l51.238">     m_pos++;</span>
<a href="#l51.239"></a><span id="l51.239">     pSrc++;</span>
<a href="#l51.240"></a><span id="l51.240">   }</span>
<a href="#l51.241"></a><span id="l51.241">   if (includeNull) {</span>
<a href="#l51.242"></a><span id="l51.242">     if (m_pos &gt;= m_bufSz) {</span>
<a href="#l51.243"></a><span id="l51.243">       if (!Flush())</span>
<a href="#l51.244"></a><span id="l51.244" class="difflineminus">-        return( false);</span>
<a href="#l51.245"></a><span id="l51.245" class="difflineplus">+        return false;</span>
<a href="#l51.246"></a><span id="l51.246">     }</span>
<a href="#l51.247"></a><span id="l51.247">     *(m_pBuf + m_pos) = 0;</span>
<a href="#l51.248"></a><span id="l51.248">     m_pos++;</span>
<a href="#l51.249"></a><span id="l51.249">   }</span>
<a href="#l51.250"></a><span id="l51.250"> </span>
<a href="#l51.251"></a><span id="l51.251" class="difflineminus">-  return( true);</span>
<a href="#l51.252"></a><span id="l51.252" class="difflineplus">+  return true;</span>
<a href="#l51.253"></a><span id="l51.253"> }</span>
<a href="#l51.254"></a><span id="l51.254"> </span>
<a href="#l51.255"></a><span id="l51.255" class="difflineminus">-bool ImportOutFile::SetMarker( int markerID)</span>
<a href="#l51.256"></a><span id="l51.256" class="difflineplus">+bool ImportOutFile::SetMarker(int markerID)</span>
<a href="#l51.257"></a><span id="l51.257"> {</span>
<a href="#l51.258"></a><span id="l51.258">   if (!Flush()) {</span>
<a href="#l51.259"></a><span id="l51.259" class="difflineminus">-    return( false);</span>
<a href="#l51.260"></a><span id="l51.260" class="difflineplus">+    return false;</span>
<a href="#l51.261"></a><span id="l51.261">   }</span>
<a href="#l51.262"></a><span id="l51.262"> </span>
<a href="#l51.263"></a><span id="l51.263">   if (markerID &lt; kMaxMarkers) {</span>
<a href="#l51.264"></a><span id="l51.264">     PRInt64 pos = 0;</span>
<a href="#l51.265"></a><span id="l51.265">     if (m_outputStream)</span>
<a href="#l51.266"></a><span id="l51.266">                 {</span>
<a href="#l51.267"></a><span id="l51.267">                   // do we need to flush for the seek to give us the right pos?</span>
<a href="#l51.268"></a><span id="l51.268">                   m_outputStream-&gt;Flush();</span>
<a href="#l51.269"></a><span id="l51.269">                   nsresult rv;</span>
<a href="#l51.270"></a><span id="l51.270">                   nsCOMPtr &lt;nsISeekableStream&gt; seekStream = do_QueryInterface(m_outputStream, &amp;rv);</span>
<a href="#l51.271"></a><span id="l51.271">                   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l51.272"></a><span id="l51.272" class="difflineminus">-      rv = seekStream-&gt;Tell( &amp;pos);</span>
<a href="#l51.273"></a><span id="l51.273" class="difflineminus">-      if (NS_FAILED( rv)) {</span>
<a href="#l51.274"></a><span id="l51.274" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error, Tell failed on output stream\n&quot;);</span>
<a href="#l51.275"></a><span id="l51.275" class="difflineminus">-        return( false);</span>
<a href="#l51.276"></a><span id="l51.276" class="difflineplus">+      rv = seekStream-&gt;Tell(&amp;pos);</span>
<a href="#l51.277"></a><span id="l51.277" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l51.278"></a><span id="l51.278" class="difflineplus">+        IMPORT_LOG0(&quot;*** Error, Tell failed on output stream\n&quot;);</span>
<a href="#l51.279"></a><span id="l51.279" class="difflineplus">+        return false;</span>
<a href="#l51.280"></a><span id="l51.280">       }</span>
<a href="#l51.281"></a><span id="l51.281">     }</span>
<a href="#l51.282"></a><span id="l51.282">     m_markers[markerID] = (PRUint32)pos + m_pos;</span>
<a href="#l51.283"></a><span id="l51.283">   }</span>
<a href="#l51.284"></a><span id="l51.284"> </span>
<a href="#l51.285"></a><span id="l51.285" class="difflineminus">-  return( true);</span>
<a href="#l51.286"></a><span id="l51.286" class="difflineplus">+  return true;</span>
<a href="#l51.287"></a><span id="l51.287"> }</span>
<a href="#l51.288"></a><span id="l51.288"> </span>
<a href="#l51.289"></a><span id="l51.289" class="difflineminus">-void ImportOutFile::ClearMarker( int markerID)</span>
<a href="#l51.290"></a><span id="l51.290" class="difflineplus">+void ImportOutFile::ClearMarker(int markerID)</span>
<a href="#l51.291"></a><span id="l51.291"> {</span>
<a href="#l51.292"></a><span id="l51.292">   if (markerID &lt; kMaxMarkers)</span>
<a href="#l51.293"></a><span id="l51.293">     m_markers[markerID] = 0;</span>
<a href="#l51.294"></a><span id="l51.294"> }</span>
<a href="#l51.295"></a><span id="l51.295"> </span>
<a href="#l51.296"></a><span id="l51.296" class="difflineminus">-bool ImportOutFile::WriteStrAtMarker( int markerID, const char *pStr)</span>
<a href="#l51.297"></a><span id="l51.297" class="difflineplus">+bool ImportOutFile::WriteStrAtMarker(int markerID, const char *pStr)</span>
<a href="#l51.298"></a><span id="l51.298"> {</span>
<a href="#l51.299"></a><span id="l51.299">   if (markerID &gt;= kMaxMarkers)</span>
<a href="#l51.300"></a><span id="l51.300" class="difflineminus">-    return( false);</span>
<a href="#l51.301"></a><span id="l51.301" class="difflineplus">+    return false;</span>
<a href="#l51.302"></a><span id="l51.302"> </span>
<a href="#l51.303"></a><span id="l51.303">   if (!Flush())</span>
<a href="#l51.304"></a><span id="l51.304" class="difflineminus">-    return( false);</span>
<a href="#l51.305"></a><span id="l51.305" class="difflineplus">+    return false;</span>
<a href="#l51.306"></a><span id="l51.306">   PRInt64    pos;</span>
<a href="#l51.307"></a><span id="l51.307">         m_outputStream-&gt;Flush();</span>
<a href="#l51.308"></a><span id="l51.308">         nsresult rv;</span>
<a href="#l51.309"></a><span id="l51.309">         nsCOMPtr &lt;nsISeekableStream&gt; seekStream = do_QueryInterface(m_outputStream, &amp;rv);</span>
<a href="#l51.310"></a><span id="l51.310">         NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l51.311"></a><span id="l51.311" class="difflineminus">-  rv = seekStream-&gt;Tell( &amp;pos);</span>
<a href="#l51.312"></a><span id="l51.312" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l51.313"></a><span id="l51.313" class="difflineminus">-    return( false);</span>
<a href="#l51.314"></a><span id="l51.314" class="difflineplus">+  rv = seekStream-&gt;Tell(&amp;pos);</span>
<a href="#l51.315"></a><span id="l51.315" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l51.316"></a><span id="l51.316" class="difflineplus">+    return false;</span>
<a href="#l51.317"></a><span id="l51.317">   rv = seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, (PRInt32) m_markers[markerID]);</span>
<a href="#l51.318"></a><span id="l51.318" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l51.319"></a><span id="l51.319" class="difflineminus">-    return( false);</span>
<a href="#l51.320"></a><span id="l51.320" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l51.321"></a><span id="l51.321" class="difflineplus">+    return false;</span>
<a href="#l51.322"></a><span id="l51.322">   PRUint32 written;</span>
<a href="#l51.323"></a><span id="l51.323" class="difflineminus">-  rv = m_outputStream-&gt;Write( pStr, strlen( pStr), &amp;written);</span>
<a href="#l51.324"></a><span id="l51.324" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l51.325"></a><span id="l51.325" class="difflineminus">-    return( false);</span>
<a href="#l51.326"></a><span id="l51.326" class="difflineplus">+  rv = m_outputStream-&gt;Write(pStr, strlen(pStr), &amp;written);</span>
<a href="#l51.327"></a><span id="l51.327" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l51.328"></a><span id="l51.328" class="difflineplus">+    return false;</span>
<a href="#l51.329"></a><span id="l51.329"> </span>
<a href="#l51.330"></a><span id="l51.330">   rv = seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, pos);</span>
<a href="#l51.331"></a><span id="l51.331" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l51.332"></a><span id="l51.332" class="difflineminus">-    return( false);</span>
<a href="#l51.333"></a><span id="l51.333" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l51.334"></a><span id="l51.334" class="difflineplus">+    return false;</span>
<a href="#l51.335"></a><span id="l51.335"> </span>
<a href="#l51.336"></a><span id="l51.336" class="difflineminus">-  return( true);</span>
<a href="#l51.337"></a><span id="l51.337" class="difflineplus">+  return true;</span>
<a href="#l51.338"></a><span id="l51.338"> }</span>
<a href="#l51.339"></a><span id="l51.339"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mailnews/import/src/ImportOutFile.h</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mailnews/import/src/ImportOutFile.h</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -43,39 +43,39 @@</span>
<a href="#l52.4"></a><span id="l52.4"> </span>
<a href="#l52.5"></a><span id="l52.5"> #define kMaxMarkers    10</span>
<a href="#l52.6"></a><span id="l52.6"> </span>
<a href="#l52.7"></a><span id="l52.7"> class ImportOutFile;</span>
<a href="#l52.8"></a><span id="l52.8"> </span>
<a href="#l52.9"></a><span id="l52.9"> class ImportOutFile {</span>
<a href="#l52.10"></a><span id="l52.10"> public:</span>
<a href="#l52.11"></a><span id="l52.11">   ImportOutFile();</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-  ImportOutFile( nsIFile *pFile, PRUint8 * pBuf, PRUint32 sz);</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+  ImportOutFile(nsIFile *pFile, PRUint8 * pBuf, PRUint32 sz);</span>
<a href="#l52.14"></a><span id="l52.14">   ~ImportOutFile();</span>
<a href="#l52.15"></a><span id="l52.15"> </span>
<a href="#l52.16"></a><span id="l52.16" class="difflineminus">-  bool    InitOutFile( nsIFile *pFile, PRUint32 bufSz = 4096);</span>
<a href="#l52.17"></a><span id="l52.17" class="difflineminus">-  void  InitOutFile( nsIFile *pFile, PRUint8 * pBuf, PRUint32 sz);</span>
<a href="#l52.18"></a><span id="l52.18" class="difflineminus">-  inline bool    WriteData( const PRUint8 * pSrc, PRUint32 len);</span>
<a href="#l52.19"></a><span id="l52.19" class="difflineminus">-  inline bool    WriteByte( PRUint8 byte);</span>
<a href="#l52.20"></a><span id="l52.20" class="difflineminus">-  bool    WriteStr( const char *pStr) {return( WriteU8NullTerm( (const PRUint8 *) pStr, false)); }</span>
<a href="#l52.21"></a><span id="l52.21" class="difflineminus">-  bool    WriteU8NullTerm( const PRUint8 * pSrc, bool includeNull);</span>
<a href="#l52.22"></a><span id="l52.22" class="difflineminus">-  bool    WriteEol( void) { return( WriteStr( &quot;\x0D\x0A&quot;)); }</span>
<a href="#l52.23"></a><span id="l52.23" class="difflineminus">-  bool    Done( void) {return( Flush());}</span>
<a href="#l52.24"></a><span id="l52.24" class="difflineplus">+  bool    InitOutFile(nsIFile *pFile, PRUint32 bufSz = 4096);</span>
<a href="#l52.25"></a><span id="l52.25" class="difflineplus">+  void  InitOutFile(nsIFile *pFile, PRUint8 * pBuf, PRUint32 sz);</span>
<a href="#l52.26"></a><span id="l52.26" class="difflineplus">+  inline bool    WriteData(const PRUint8 * pSrc, PRUint32 len);</span>
<a href="#l52.27"></a><span id="l52.27" class="difflineplus">+  inline bool    WriteByte(PRUint8 byte);</span>
<a href="#l52.28"></a><span id="l52.28" class="difflineplus">+  bool    WriteStr(const char *pStr) {return WriteU8NullTerm((const PRUint8 *) pStr, false); }</span>
<a href="#l52.29"></a><span id="l52.29" class="difflineplus">+  bool    WriteU8NullTerm(const PRUint8 * pSrc, bool includeNull);</span>
<a href="#l52.30"></a><span id="l52.30" class="difflineplus">+  bool    WriteEol(void) { return WriteStr(&quot;\x0D\x0A&quot;); }</span>
<a href="#l52.31"></a><span id="l52.31" class="difflineplus">+  bool    Done(void) {return Flush();}</span>
<a href="#l52.32"></a><span id="l52.32"> </span>
<a href="#l52.33"></a><span id="l52.33">   // Marker support</span>
<a href="#l52.34"></a><span id="l52.34" class="difflineminus">-  bool    SetMarker( int markerID);</span>
<a href="#l52.35"></a><span id="l52.35" class="difflineminus">-  void  ClearMarker( int markerID);</span>
<a href="#l52.36"></a><span id="l52.36" class="difflineminus">-  bool    WriteStrAtMarker( int markerID, const char *pStr);</span>
<a href="#l52.37"></a><span id="l52.37" class="difflineplus">+  bool    SetMarker(int markerID);</span>
<a href="#l52.38"></a><span id="l52.38" class="difflineplus">+  void  ClearMarker(int markerID);</span>
<a href="#l52.39"></a><span id="l52.39" class="difflineplus">+  bool    WriteStrAtMarker(int markerID, const char *pStr);</span>
<a href="#l52.40"></a><span id="l52.40"> </span>
<a href="#l52.41"></a><span id="l52.41">   // 8-bit to 7-bit translation</span>
<a href="#l52.42"></a><span id="l52.42" class="difflineminus">-  bool    Set8bitTranslator( nsImportTranslator *pTrans);</span>
<a href="#l52.43"></a><span id="l52.43" class="difflineminus">-  bool    End8bitTranslation( bool *pEngaged, nsCString&amp; useCharset, nsCString&amp; encoding);</span>
<a href="#l52.44"></a><span id="l52.44" class="difflineplus">+  bool    Set8bitTranslator(nsImportTranslator *pTrans);</span>
<a href="#l52.45"></a><span id="l52.45" class="difflineplus">+  bool    End8bitTranslation(bool *pEngaged, nsCString&amp; useCharset, nsCString&amp; encoding);</span>
<a href="#l52.46"></a><span id="l52.46"> </span>
<a href="#l52.47"></a><span id="l52.47"> protected:</span>
<a href="#l52.48"></a><span id="l52.48" class="difflineminus">-  bool    Flush( void);</span>
<a href="#l52.49"></a><span id="l52.49" class="difflineplus">+  bool    Flush(void);</span>
<a href="#l52.50"></a><span id="l52.50"> </span>
<a href="#l52.51"></a><span id="l52.51"> protected:</span>
<a href="#l52.52"></a><span id="l52.52">   nsCOMPtr &lt;nsIFile&gt;      m_pFile;</span>
<a href="#l52.53"></a><span id="l52.53">         nsCOMPtr &lt;nsIOutputStream&gt; m_outputStream;</span>
<a href="#l52.54"></a><span id="l52.54">   PRUint8 *    m_pBuf;</span>
<a href="#l52.55"></a><span id="l52.55">   PRUint32    m_bufSz;</span>
<a href="#l52.56"></a><span id="l52.56">   PRUint32    m_pos;</span>
<a href="#l52.57"></a><span id="l52.57">   bool        m_ownsFileAndBuffer;</span>
<a href="#l52.58"></a><span id="l52.58" class="difflineat">@@ -86,41 +86,41 @@ protected:</span>
<a href="#l52.59"></a><span id="l52.59">   // 8 bit to 7 bit translations</span>
<a href="#l52.60"></a><span id="l52.60">   nsImportTranslator  *  m_pTrans;</span>
<a href="#l52.61"></a><span id="l52.61">   bool            m_engaged;</span>
<a href="#l52.62"></a><span id="l52.62">   bool            m_supports8to7;</span>
<a href="#l52.63"></a><span id="l52.63">   ImportOutFile *      m_pTransOut;</span>
<a href="#l52.64"></a><span id="l52.64">   PRUint8 *        m_pTransBuf;</span>
<a href="#l52.65"></a><span id="l52.65"> };</span>
<a href="#l52.66"></a><span id="l52.66"> </span>
<a href="#l52.67"></a><span id="l52.67" class="difflineminus">-inline bool    ImportOutFile::WriteData( const PRUint8 * pSrc, PRUint32 len) {</span>
<a href="#l52.68"></a><span id="l52.68" class="difflineplus">+inline bool    ImportOutFile::WriteData(const PRUint8 * pSrc, PRUint32 len) {</span>
<a href="#l52.69"></a><span id="l52.69">   while ((len + m_pos) &gt; m_bufSz) {</span>
<a href="#l52.70"></a><span id="l52.70">     if ((m_bufSz - m_pos)) {</span>
<a href="#l52.71"></a><span id="l52.71" class="difflineminus">-      memcpy( m_pBuf + m_pos, pSrc, m_bufSz - m_pos);</span>
<a href="#l52.72"></a><span id="l52.72" class="difflineplus">+      memcpy(m_pBuf + m_pos, pSrc, m_bufSz - m_pos);</span>
<a href="#l52.73"></a><span id="l52.73">       len -= (m_bufSz - m_pos);</span>
<a href="#l52.74"></a><span id="l52.74">       pSrc += (m_bufSz - m_pos);</span>
<a href="#l52.75"></a><span id="l52.75">       m_pos = m_bufSz;</span>
<a href="#l52.76"></a><span id="l52.76">     }</span>
<a href="#l52.77"></a><span id="l52.77">     if (!Flush())</span>
<a href="#l52.78"></a><span id="l52.78" class="difflineminus">-      return( false);</span>
<a href="#l52.79"></a><span id="l52.79" class="difflineplus">+      return false;</span>
<a href="#l52.80"></a><span id="l52.80">   }</span>
<a href="#l52.81"></a><span id="l52.81"> </span>
<a href="#l52.82"></a><span id="l52.82">   if (len) {</span>
<a href="#l52.83"></a><span id="l52.83" class="difflineminus">-    memcpy( m_pBuf + m_pos, pSrc, len);</span>
<a href="#l52.84"></a><span id="l52.84" class="difflineplus">+    memcpy(m_pBuf + m_pos, pSrc, len);</span>
<a href="#l52.85"></a><span id="l52.85">     m_pos += len;</span>
<a href="#l52.86"></a><span id="l52.86">   }</span>
<a href="#l52.87"></a><span id="l52.87"> </span>
<a href="#l52.88"></a><span id="l52.88" class="difflineminus">-  return( true);</span>
<a href="#l52.89"></a><span id="l52.89" class="difflineplus">+  return true;</span>
<a href="#l52.90"></a><span id="l52.90"> }</span>
<a href="#l52.91"></a><span id="l52.91"> </span>
<a href="#l52.92"></a><span id="l52.92" class="difflineminus">-inline bool    ImportOutFile::WriteByte( PRUint8 byte) {</span>
<a href="#l52.93"></a><span id="l52.93" class="difflineplus">+inline bool    ImportOutFile::WriteByte(PRUint8 byte) {</span>
<a href="#l52.94"></a><span id="l52.94">   if (m_pos == m_bufSz) {</span>
<a href="#l52.95"></a><span id="l52.95">     if (!Flush())</span>
<a href="#l52.96"></a><span id="l52.96" class="difflineminus">-      return( false);</span>
<a href="#l52.97"></a><span id="l52.97" class="difflineplus">+      return false;</span>
<a href="#l52.98"></a><span id="l52.98">   }</span>
<a href="#l52.99"></a><span id="l52.99">   *(m_pBuf + m_pos) = byte;</span>
<a href="#l52.100"></a><span id="l52.100">   m_pos++;</span>
<a href="#l52.101"></a><span id="l52.101" class="difflineminus">-  return( true);</span>
<a href="#l52.102"></a><span id="l52.102" class="difflineplus">+  return true;</span>
<a href="#l52.103"></a><span id="l52.103"> }</span>
<a href="#l52.104"></a><span id="l52.104"> </span>
<a href="#l52.105"></a><span id="l52.105"> #endif /* ImportOutFile_h__ */</span>
<a href="#l52.106"></a><span id="l52.106"> </span>
<a href="#l52.107"></a><span id="l52.107"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mailnews/import/src/ImportTranslate.cpp</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mailnews/import/src/ImportTranslate.cpp</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -35,103 +35,103 @@</span>
<a href="#l53.4"></a><span id="l53.4">  *</span>
<a href="#l53.5"></a><span id="l53.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l53.6"></a><span id="l53.6"> </span>
<a href="#l53.7"></a><span id="l53.7"> #include &quot;ImportTranslate.h&quot;</span>
<a href="#l53.8"></a><span id="l53.8"> </span>
<a href="#l53.9"></a><span id="l53.9"> int ImportTranslate::m_useTranslator = -1;</span>
<a href="#l53.10"></a><span id="l53.10"> </span>
<a href="#l53.11"></a><span id="l53.11"> </span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-bool ImportTranslate::ConvertString( const nsCString&amp; inStr, nsCString&amp; outStr, bool mimeHeader)</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+bool ImportTranslate::ConvertString(const nsCString&amp; inStr, nsCString&amp; outStr, bool mimeHeader)</span>
<a href="#l53.14"></a><span id="l53.14"> {</span>
<a href="#l53.15"></a><span id="l53.15">   if (inStr.IsEmpty()) {</span>
<a href="#l53.16"></a><span id="l53.16">     outStr = inStr;</span>
<a href="#l53.17"></a><span id="l53.17" class="difflineminus">-    return( true);</span>
<a href="#l53.18"></a><span id="l53.18" class="difflineplus">+    return true;</span>
<a href="#l53.19"></a><span id="l53.19">   }</span>
<a href="#l53.20"></a><span id="l53.20"> </span>
<a href="#l53.21"></a><span id="l53.21">   nsImportTranslator *pTrans = GetTranslator();</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineminus">-  // int      maxLen = (int) pTrans-&gt;GetMaxBufferSize( inStr.Length());</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineplus">+  // int      maxLen = (int) pTrans-&gt;GetMaxBufferSize(inStr.Length());</span>
<a href="#l53.24"></a><span id="l53.24">   // int      hLen = 0;</span>
<a href="#l53.25"></a><span id="l53.25">   nsCString  set;</span>
<a href="#l53.26"></a><span id="l53.26">   nsCString  lang;</span>
<a href="#l53.27"></a><span id="l53.27"> </span>
<a href="#l53.28"></a><span id="l53.28">   if (mimeHeader) {</span>
<a href="#l53.29"></a><span id="l53.29">     // add the charset and language</span>
<a href="#l53.30"></a><span id="l53.30" class="difflineminus">-    pTrans-&gt;GetCharset( set);</span>
<a href="#l53.31"></a><span id="l53.31" class="difflineminus">-    pTrans-&gt;GetLanguage( lang);</span>
<a href="#l53.32"></a><span id="l53.32" class="difflineplus">+    pTrans-&gt;GetCharset(set);</span>
<a href="#l53.33"></a><span id="l53.33" class="difflineplus">+    pTrans-&gt;GetLanguage(lang);</span>
<a href="#l53.34"></a><span id="l53.34">   }</span>
<a href="#l53.35"></a><span id="l53.35"> </span>
<a href="#l53.36"></a><span id="l53.36">   // Unfortunatly, we didn't implement ConvertBuffer for all translators,</span>
<a href="#l53.37"></a><span id="l53.37">   // just ConvertToFile.  This means that this data will not always</span>
<a href="#l53.38"></a><span id="l53.38">   // be converted to the charset of pTrans.  In that case...</span>
<a href="#l53.39"></a><span id="l53.39">   // We don't always have the data in the same charset as the current</span>
<a href="#l53.40"></a><span id="l53.40">   // translator...</span>
<a href="#l53.41"></a><span id="l53.41">   // It is safer to leave the charset and language field blank</span>
<a href="#l53.42"></a><span id="l53.42">   set.Truncate();</span>
<a href="#l53.43"></a><span id="l53.43">   lang.Truncate();</span>
<a href="#l53.44"></a><span id="l53.44"> </span>
<a href="#l53.45"></a><span id="l53.45">   PRUint8 *  pBuf;</span>
<a href="#l53.46"></a><span id="l53.46">   /*</span>
<a href="#l53.47"></a><span id="l53.47" class="difflineminus">-  pBuf = (P_U8) outStr.GetBuffer( maxLen);</span>
<a href="#l53.48"></a><span id="l53.48" class="difflineplus">+  pBuf = (P_U8) outStr.GetBuffer(maxLen);</span>
<a href="#l53.49"></a><span id="l53.49">   if (!pBuf) {</span>
<a href="#l53.50"></a><span id="l53.50">     delete pTrans;</span>
<a href="#l53.51"></a><span id="l53.51" class="difflineminus">-    return( FALSE);</span>
<a href="#l53.52"></a><span id="l53.52" class="difflineplus">+    return FALSE;</span>
<a href="#l53.53"></a><span id="l53.53">   }</span>
<a href="#l53.54"></a><span id="l53.54" class="difflineminus">-  pTrans-&gt;ConvertBuffer( (PC_U8)(PC_S8)inStr, inStr.GetLength(), pBuf);</span>
<a href="#l53.55"></a><span id="l53.55" class="difflineplus">+  pTrans-&gt;ConvertBuffer((PC_U8)(PC_S8)inStr, inStr.GetLength(), pBuf);</span>
<a href="#l53.56"></a><span id="l53.56">   outStr.ReleaseBuffer();</span>
<a href="#l53.57"></a><span id="l53.57">   */</span>
<a href="#l53.58"></a><span id="l53.58">   outStr = inStr;</span>
<a href="#l53.59"></a><span id="l53.59">   delete pTrans;</span>
<a href="#l53.60"></a><span id="l53.60"> </span>
<a href="#l53.61"></a><span id="l53.61"> </span>
<a href="#l53.62"></a><span id="l53.62">   // Now I need to run the string through the mime-header special char</span>
<a href="#l53.63"></a><span id="l53.63">   // encoder.</span>
<a href="#l53.64"></a><span id="l53.64"> </span>
<a href="#l53.65"></a><span id="l53.65">   pTrans = new CMHTranslator;</span>
<a href="#l53.66"></a><span id="l53.66" class="difflineminus">-  pBuf = new PRUint8[pTrans-&gt;GetMaxBufferSize( outStr.Length())];</span>
<a href="#l53.67"></a><span id="l53.67" class="difflineminus">-  pTrans-&gt;ConvertBuffer( (const PRUint8 *)(outStr.get()), outStr.Length(), pBuf);</span>
<a href="#l53.68"></a><span id="l53.68" class="difflineplus">+  pBuf = new PRUint8[pTrans-&gt;GetMaxBufferSize(outStr.Length())];</span>
<a href="#l53.69"></a><span id="l53.69" class="difflineplus">+  pTrans-&gt;ConvertBuffer((const PRUint8 *)(outStr.get()), outStr.Length(), pBuf);</span>
<a href="#l53.70"></a><span id="l53.70">   delete pTrans;</span>
<a href="#l53.71"></a><span id="l53.71">   outStr.Truncate();</span>
<a href="#l53.72"></a><span id="l53.72">   if (mimeHeader) {</span>
<a href="#l53.73"></a><span id="l53.73">     outStr = set;</span>
<a href="#l53.74"></a><span id="l53.74">     outStr += &quot;'&quot;;</span>
<a href="#l53.75"></a><span id="l53.75">     outStr += lang;</span>
<a href="#l53.76"></a><span id="l53.76">     outStr += &quot;'&quot;;</span>
<a href="#l53.77"></a><span id="l53.77">   }</span>
<a href="#l53.78"></a><span id="l53.78">   outStr += (const char *)pBuf;</span>
<a href="#l53.79"></a><span id="l53.79">   delete [] pBuf;</span>
<a href="#l53.80"></a><span id="l53.80"> </span>
<a href="#l53.81"></a><span id="l53.81" class="difflineminus">-  return( true);</span>
<a href="#l53.82"></a><span id="l53.82" class="difflineplus">+  return true;</span>
<a href="#l53.83"></a><span id="l53.83"> }</span>
<a href="#l53.84"></a><span id="l53.84"> </span>
<a href="#l53.85"></a><span id="l53.85"> </span>
<a href="#l53.86"></a><span id="l53.86" class="difflineminus">-nsImportTranslator *ImportTranslate::GetTranslator( void)</span>
<a href="#l53.87"></a><span id="l53.87" class="difflineplus">+nsImportTranslator *ImportTranslate::GetTranslator(void)</span>
<a href="#l53.88"></a><span id="l53.88"> {</span>
<a href="#l53.89"></a><span id="l53.89">   if (m_useTranslator == -1) {</span>
<a href="#l53.90"></a><span id="l53.90">     // get the translator to use...</span>
<a href="#l53.91"></a><span id="l53.91">     // CString    trans;</span>
<a href="#l53.92"></a><span id="l53.92" class="difflineminus">-    // trans.LoadString( IDS_LANGUAGE_TRANSLATION);</span>
<a href="#l53.93"></a><span id="l53.93" class="difflineplus">+    // trans.LoadString(IDS_LANGUAGE_TRANSLATION);</span>
<a href="#l53.94"></a><span id="l53.94">     m_useTranslator = 0;</span>
<a href="#l53.95"></a><span id="l53.95" class="difflineminus">-    // if (!trans.CompareNoCase( &quot;iso-2022-jp&quot;))</span>
<a href="#l53.96"></a><span id="l53.96" class="difflineplus">+    // if (!trans.CompareNoCase(&quot;iso-2022-jp&quot;))</span>
<a href="#l53.97"></a><span id="l53.97">     //  gWizData.m_useTranslator = 1;</span>
<a href="#l53.98"></a><span id="l53.98">   }</span>
<a href="#l53.99"></a><span id="l53.99"> </span>
<a href="#l53.100"></a><span id="l53.100" class="difflineminus">-  switch( m_useTranslator) {</span>
<a href="#l53.101"></a><span id="l53.101" class="difflineplus">+  switch(m_useTranslator) {</span>
<a href="#l53.102"></a><span id="l53.102">   case 0:</span>
<a href="#l53.103"></a><span id="l53.103" class="difflineminus">-    return( new nsImportTranslator);</span>
<a href="#l53.104"></a><span id="l53.104" class="difflineplus">+    return new nsImportTranslator;</span>
<a href="#l53.105"></a><span id="l53.105">   //case 1:</span>
<a href="#l53.106"></a><span id="l53.106" class="difflineminus">-  //  return( new CSJis2JisTranslator);</span>
<a href="#l53.107"></a><span id="l53.107" class="difflineplus">+  //  return new CSJis2JisTranslator;</span>
<a href="#l53.108"></a><span id="l53.108">   default:</span>
<a href="#l53.109"></a><span id="l53.109" class="difflineminus">-    return( new nsImportTranslator);</span>
<a href="#l53.110"></a><span id="l53.110" class="difflineplus">+    return new nsImportTranslator;</span>
<a href="#l53.111"></a><span id="l53.111">   }</span>
<a href="#l53.112"></a><span id="l53.112"> }</span>
<a href="#l53.113"></a><span id="l53.113"> </span>
<a href="#l53.114"></a><span id="l53.114" class="difflineminus">-nsImportTranslator *ImportTranslate::GetMatchingTranslator( const char *pCharSet)</span>
<a href="#l53.115"></a><span id="l53.115" class="difflineplus">+nsImportTranslator *ImportTranslate::GetMatchingTranslator(const char *pCharSet)</span>
<a href="#l53.116"></a><span id="l53.116"> {</span>
<a href="#l53.117"></a><span id="l53.117"> /*</span>
<a href="#l53.118"></a><span id="l53.118">   CString    jp = &quot;iso-2022-jp&quot;;</span>
<a href="#l53.119"></a><span id="l53.119" class="difflineminus">-  if (!jp.CompareNoCase( pCharSet))</span>
<a href="#l53.120"></a><span id="l53.120" class="difflineminus">-    return( new CSJis2JisTranslator);</span>
<a href="#l53.121"></a><span id="l53.121" class="difflineplus">+  if (!jp.CompareNoCase(pCharSet))</span>
<a href="#l53.122"></a><span id="l53.122" class="difflineplus">+    return new CSJis2JisTranslator;</span>
<a href="#l53.123"></a><span id="l53.123"> */</span>
<a href="#l53.124"></a><span id="l53.124"> </span>
<a href="#l53.125"></a><span id="l53.125" class="difflineminus">-  return( nsnull);</span>
<a href="#l53.126"></a><span id="l53.126" class="difflineplus">+  return nsnull;</span>
<a href="#l53.127"></a><span id="l53.127"> }</span>
<a href="#l53.128"></a><span id="l53.128"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mailnews/import/src/ImportTranslate.h</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mailnews/import/src/ImportTranslate.h</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -38,18 +38,18 @@</span>
<a href="#l54.4"></a><span id="l54.4"> #ifndef ImportTranslate_h___</span>
<a href="#l54.5"></a><span id="l54.5"> #define ImportTranslate_h___</span>
<a href="#l54.6"></a><span id="l54.6"> </span>
<a href="#l54.7"></a><span id="l54.7"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l54.8"></a><span id="l54.8"> #include &quot;nsImportTranslator.h&quot;</span>
<a href="#l54.9"></a><span id="l54.9"> </span>
<a href="#l54.10"></a><span id="l54.10"> class ImportTranslate {</span>
<a href="#l54.11"></a><span id="l54.11"> public:</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-  static bool ConvertString( const nsCString&amp; inStr, nsCString&amp; outStr, bool mimeHeader);</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineminus">-  static nsImportTranslator *GetTranslator( void);</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineminus">-  static nsImportTranslator *GetMatchingTranslator( const char *pCharSet);</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineplus">+  static bool ConvertString(const nsCString&amp; inStr, nsCString&amp; outStr, bool mimeHeader);</span>
<a href="#l54.16"></a><span id="l54.16" class="difflineplus">+  static nsImportTranslator *GetTranslator(void);</span>
<a href="#l54.17"></a><span id="l54.17" class="difflineplus">+  static nsImportTranslator *GetMatchingTranslator(const char *pCharSet);</span>
<a href="#l54.18"></a><span id="l54.18"> </span>
<a href="#l54.19"></a><span id="l54.19"> protected:</span>
<a href="#l54.20"></a><span id="l54.20">   static int m_useTranslator;</span>
<a href="#l54.21"></a><span id="l54.21"> };</span>
<a href="#l54.22"></a><span id="l54.22"> </span>
<a href="#l54.23"></a><span id="l54.23"> </span>
<a href="#l54.24"></a><span id="l54.24"> #endif  /* ImportTranslate_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mailnews/import/src/nsImportABDescriptor.cpp</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mailnews/import/src/nsImportABDescriptor.cpp</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -38,28 +38,28 @@</span>
<a href="#l55.4"></a><span id="l55.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l55.5"></a><span id="l55.5"> </span>
<a href="#l55.6"></a><span id="l55.6"> </span>
<a href="#l55.7"></a><span id="l55.7"> #include &quot;nscore.h&quot;</span>
<a href="#l55.8"></a><span id="l55.8"> #include &quot;nsImportABDescriptor.h&quot;</span>
<a href="#l55.9"></a><span id="l55.9"> </span>
<a href="#l55.10"></a><span id="l55.10"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l55.11"></a><span id="l55.11"> </span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-NS_METHOD nsImportABDescriptor::Create( nsISupports *aOuter, REFNSIID aIID, void **aResult)</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+NS_METHOD nsImportABDescriptor::Create(nsISupports *aOuter, REFNSIID aIID, void **aResult)</span>
<a href="#l55.14"></a><span id="l55.14"> {</span>
<a href="#l55.15"></a><span id="l55.15">   if (aOuter)</span>
<a href="#l55.16"></a><span id="l55.16">     return NS_ERROR_NO_AGGREGATION;</span>
<a href="#l55.17"></a><span id="l55.17"> </span>
<a href="#l55.18"></a><span id="l55.18">   nsImportABDescriptor *it = new nsImportABDescriptor();</span>
<a href="#l55.19"></a><span id="l55.19">   if (it == nsnull)</span>
<a href="#l55.20"></a><span id="l55.20">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l55.21"></a><span id="l55.21"> </span>
<a href="#l55.22"></a><span id="l55.22" class="difflineminus">-  NS_ADDREF( it);</span>
<a href="#l55.23"></a><span id="l55.23" class="difflineminus">-  nsresult rv = it-&gt;QueryInterface( aIID, aResult);</span>
<a href="#l55.24"></a><span id="l55.24" class="difflineminus">-  NS_RELEASE( it);</span>
<a href="#l55.25"></a><span id="l55.25" class="difflineplus">+  NS_ADDREF(it);</span>
<a href="#l55.26"></a><span id="l55.26" class="difflineplus">+  nsresult rv = it-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l55.27"></a><span id="l55.27" class="difflineplus">+  NS_RELEASE(it);</span>
<a href="#l55.28"></a><span id="l55.28">   return rv;</span>
<a href="#l55.29"></a><span id="l55.29"> }</span>
<a href="#l55.30"></a><span id="l55.30"> </span>
<a href="#l55.31"></a><span id="l55.31"> NS_IMPL_THREADSAFE_ISUPPORTS1(nsImportABDescriptor, nsIImportABDescriptor)</span>
<a href="#l55.32"></a><span id="l55.32"> </span>
<a href="#l55.33"></a><span id="l55.33"> nsImportABDescriptor::nsImportABDescriptor()</span>
<a href="#l55.34"></a><span id="l55.34">   : mId(0), mRef(0), mSize(0), mImport(true)</span>
<a href="#l55.35"></a><span id="l55.35"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mailnews/import/src/nsImportABDescriptor.h</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mailnews/import/src/nsImportABDescriptor.h</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -115,17 +115,17 @@ public:</span>
<a href="#l56.4"></a><span id="l56.4">   NS_IMETHOD SetImport(bool doImport) {</span>
<a href="#l56.5"></a><span id="l56.5">     mImport = doImport;</span>
<a href="#l56.6"></a><span id="l56.6">     return NS_OK;</span>
<a href="#l56.7"></a><span id="l56.7">   }</span>
<a href="#l56.8"></a><span id="l56.8"> </span>
<a href="#l56.9"></a><span id="l56.9">   nsImportABDescriptor();</span>
<a href="#l56.10"></a><span id="l56.10">   virtual ~nsImportABDescriptor() {}</span>
<a href="#l56.11"></a><span id="l56.11"> </span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-  static NS_METHOD Create( nsISupports *aOuter, REFNSIID aIID, void **aResult);</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+  static NS_METHOD Create(nsISupports *aOuter, REFNSIID aIID, void **aResult);</span>
<a href="#l56.14"></a><span id="l56.14"> </span>
<a href="#l56.15"></a><span id="l56.15"> private:</span>
<a href="#l56.16"></a><span id="l56.16">   PRUint32 mId; // used by creator of the structure</span>
<a href="#l56.17"></a><span id="l56.17">   PRUint32 mRef; // depth in the hierarchy</span>
<a href="#l56.18"></a><span id="l56.18">   nsString mDisplayName; // name of this mailbox</span>
<a href="#l56.19"></a><span id="l56.19">   nsCOMPtr&lt;nsIFile&gt; mFile; // source file (if applicable)</span>
<a href="#l56.20"></a><span id="l56.20">   PRUint32 mSize; // size</span>
<a href="#l56.21"></a><span id="l56.21">   bool mImport; // import it or not?</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mailnews/import/src/nsImportAddressBooks.cpp</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mailnews/import/src/nsImportAddressBooks.cpp</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -58,17 +58,17 @@</span>
<a href="#l57.4"></a><span id="l57.4"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l57.5"></a><span id="l57.5"> #include &quot;msgCore.h&quot;</span>
<a href="#l57.6"></a><span id="l57.6"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l57.7"></a><span id="l57.7"> #include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l57.8"></a><span id="l57.8"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l57.9"></a><span id="l57.9"> #include &quot;nsISupportsArray.h&quot;</span>
<a href="#l57.10"></a><span id="l57.10"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l57.11"></a><span id="l57.11"> </span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-static void ImportAddressThread( void *stuff);</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+static void ImportAddressThread(void *stuff);</span>
<a href="#l57.14"></a><span id="l57.14"> </span>
<a href="#l57.15"></a><span id="l57.15"> class AddressThreadData;</span>
<a href="#l57.16"></a><span id="l57.16"> </span>
<a href="#l57.17"></a><span id="l57.17"> class nsImportGenericAddressBooks : public nsIImportGeneric</span>
<a href="#l57.18"></a><span id="l57.18"> {</span>
<a href="#l57.19"></a><span id="l57.19"> public:</span>
<a href="#l57.20"></a><span id="l57.20"> </span>
<a href="#l57.21"></a><span id="l57.21">   nsImportGenericAddressBooks();</span>
<a href="#l57.22"></a><span id="l57.22" class="difflineat">@@ -76,35 +76,35 @@ public:</span>
<a href="#l57.23"></a><span id="l57.23"> </span>
<a href="#l57.24"></a><span id="l57.24">   NS_DECL_ISUPPORTS</span>
<a href="#l57.25"></a><span id="l57.25"> </span>
<a href="#l57.26"></a><span id="l57.26">   /* nsISupports GetData (in string dataId); */</span>
<a href="#l57.27"></a><span id="l57.27">   NS_IMETHOD GetData(const char *dataId, nsISupports **_retval);</span>
<a href="#l57.28"></a><span id="l57.28"> </span>
<a href="#l57.29"></a><span id="l57.29">   NS_IMETHOD SetData(const char *dataId, nsISupports *pData);</span>
<a href="#l57.30"></a><span id="l57.30"> </span>
<a href="#l57.31"></a><span id="l57.31" class="difflineminus">-  NS_IMETHOD GetStatus( const char *statusKind, PRInt32 *_retval);</span>
<a href="#l57.32"></a><span id="l57.32" class="difflineplus">+  NS_IMETHOD GetStatus(const char *statusKind, PRInt32 *_retval);</span>
<a href="#l57.33"></a><span id="l57.33"> </span>
<a href="#l57.34"></a><span id="l57.34">   NS_IMETHOD WantsProgress(bool *_retval);</span>
<a href="#l57.35"></a><span id="l57.35"> </span>
<a href="#l57.36"></a><span id="l57.36">   NS_IMETHOD BeginImport(nsISupportsString *successLog, nsISupportsString *errorLog, bool *_retval) ;</span>
<a href="#l57.37"></a><span id="l57.37"> </span>
<a href="#l57.38"></a><span id="l57.38">   NS_IMETHOD ContinueImport(bool *_retval);</span>
<a href="#l57.39"></a><span id="l57.39"> </span>
<a href="#l57.40"></a><span id="l57.40">   NS_IMETHOD GetProgress(PRInt32 *_retval);</span>
<a href="#l57.41"></a><span id="l57.41"> </span>
<a href="#l57.42"></a><span id="l57.42">   NS_IMETHOD CancelImport(void);</span>
<a href="#l57.43"></a><span id="l57.43"> </span>
<a href="#l57.44"></a><span id="l57.44"> private:</span>
<a href="#l57.45"></a><span id="l57.45" class="difflineminus">-  void  GetDefaultLocation( void);</span>
<a href="#l57.46"></a><span id="l57.46" class="difflineminus">-  void  GetDefaultBooks( void);</span>
<a href="#l57.47"></a><span id="l57.47" class="difflineminus">-  void  GetDefaultFieldMap( void);</span>
<a href="#l57.48"></a><span id="l57.48" class="difflineplus">+  void  GetDefaultLocation(void);</span>
<a href="#l57.49"></a><span id="l57.49" class="difflineplus">+  void  GetDefaultBooks(void);</span>
<a href="#l57.50"></a><span id="l57.50" class="difflineplus">+  void  GetDefaultFieldMap(void);</span>
<a href="#l57.51"></a><span id="l57.51"> </span>
<a href="#l57.52"></a><span id="l57.52"> public:</span>
<a href="#l57.53"></a><span id="l57.53" class="difflineminus">-  static void  SetLogs( nsString&amp; success, nsString&amp; error, nsISupportsString *pSuccess, nsISupportsString *pError);</span>
<a href="#l57.54"></a><span id="l57.54" class="difflineplus">+  static void  SetLogs(nsString&amp; success, nsString&amp; error, nsISupportsString *pSuccess, nsISupportsString *pError);</span>
<a href="#l57.55"></a><span id="l57.55">   static void ReportError(const PRUnichar *pName, nsString *pStream,</span>
<a href="#l57.56"></a><span id="l57.56">                           nsIStringBundle *aBundle);</span>
<a href="#l57.57"></a><span id="l57.57"> </span>
<a href="#l57.58"></a><span id="l57.58"> private:</span>
<a href="#l57.59"></a><span id="l57.59">   nsIImportAddressBooks *    m_pInterface;</span>
<a href="#l57.60"></a><span id="l57.60">   nsISupportsArray *m_pBooks;</span>
<a href="#l57.61"></a><span id="l57.61">   nsCOMArray&lt;nsIAddrDatabase&gt; m_DBs;</span>
<a href="#l57.62"></a><span id="l57.62">   nsCOMPtr &lt;nsIFile&gt;              m_pLocation;</span>
<a href="#l57.63"></a><span id="l57.63" class="difflineat">@@ -152,21 +152,21 @@ nsresult NS_NewGenericAddressBooks(nsIIm</span>
<a href="#l57.64"></a><span id="l57.64">     if (! aImportGeneric)</span>
<a href="#l57.65"></a><span id="l57.65">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l57.66"></a><span id="l57.66"> </span>
<a href="#l57.67"></a><span id="l57.67">   nsImportGenericAddressBooks *pGen = new nsImportGenericAddressBooks();</span>
<a href="#l57.68"></a><span id="l57.68"> </span>
<a href="#l57.69"></a><span id="l57.69">   if (pGen == nsnull)</span>
<a href="#l57.70"></a><span id="l57.70">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l57.71"></a><span id="l57.71"> </span>
<a href="#l57.72"></a><span id="l57.72" class="difflineminus">-  NS_ADDREF( pGen);</span>
<a href="#l57.73"></a><span id="l57.73" class="difflineminus">-  nsresult rv = pGen-&gt;QueryInterface( NS_GET_IID(nsIImportGeneric), (void **)aImportGeneric);</span>
<a href="#l57.74"></a><span id="l57.74" class="difflineminus">-  NS_RELEASE( pGen);</span>
<a href="#l57.75"></a><span id="l57.75" class="difflineplus">+  NS_ADDREF(pGen);</span>
<a href="#l57.76"></a><span id="l57.76" class="difflineplus">+  nsresult rv = pGen-&gt;QueryInterface(NS_GET_IID(nsIImportGeneric), (void **)aImportGeneric);</span>
<a href="#l57.77"></a><span id="l57.77" class="difflineplus">+  NS_RELEASE(pGen);</span>
<a href="#l57.78"></a><span id="l57.78"> </span>
<a href="#l57.79"></a><span id="l57.79" class="difflineminus">-    return( rv);</span>
<a href="#l57.80"></a><span id="l57.80" class="difflineplus">+    return rv;</span>
<a href="#l57.81"></a><span id="l57.81"> }</span>
<a href="#l57.82"></a><span id="l57.82"> </span>
<a href="#l57.83"></a><span id="l57.83"> nsImportGenericAddressBooks::nsImportGenericAddressBooks()</span>
<a href="#l57.84"></a><span id="l57.84"> {</span>
<a href="#l57.85"></a><span id="l57.85">   m_pInterface = nsnull;</span>
<a href="#l57.86"></a><span id="l57.86">   m_pBooks = nsnull;</span>
<a href="#l57.87"></a><span id="l57.87">   m_pSuccessLog = nsnull;</span>
<a href="#l57.88"></a><span id="l57.88">   m_pErrorLog = nsnull;</span>
<a href="#l57.89"></a><span id="l57.89" class="difflineat">@@ -184,283 +184,283 @@ nsImportGenericAddressBooks::nsImportGen</span>
<a href="#l57.90"></a><span id="l57.90"> </span>
<a href="#l57.91"></a><span id="l57.91">   nsImportStringBundle::GetStringBundle(IMPORT_MSGS_URL, getter_AddRefs(m_stringBundle));</span>
<a href="#l57.92"></a><span id="l57.92"> }</span>
<a href="#l57.93"></a><span id="l57.93"> </span>
<a href="#l57.94"></a><span id="l57.94"> </span>
<a href="#l57.95"></a><span id="l57.95"> nsImportGenericAddressBooks::~nsImportGenericAddressBooks()</span>
<a href="#l57.96"></a><span id="l57.96"> {</span>
<a href="#l57.97"></a><span id="l57.97">   if (m_pDestinationUri)</span>
<a href="#l57.98"></a><span id="l57.98" class="difflineminus">-    NS_Free( m_pDestinationUri);</span>
<a href="#l57.99"></a><span id="l57.99" class="difflineplus">+    NS_Free(m_pDestinationUri);</span>
<a href="#l57.100"></a><span id="l57.100"> </span>
<a href="#l57.101"></a><span id="l57.101">   if (m_description)</span>
<a href="#l57.102"></a><span id="l57.102" class="difflineminus">-    NS_Free( m_description);</span>
<a href="#l57.103"></a><span id="l57.103" class="difflineplus">+    NS_Free(m_description);</span>
<a href="#l57.104"></a><span id="l57.104"> </span>
<a href="#l57.105"></a><span id="l57.105" class="difflineminus">-  NS_IF_RELEASE( m_pFieldMap);</span>
<a href="#l57.106"></a><span id="l57.106" class="difflineminus">-  NS_IF_RELEASE( m_pInterface);</span>
<a href="#l57.107"></a><span id="l57.107" class="difflineminus">-  NS_IF_RELEASE( m_pBooks);</span>
<a href="#l57.108"></a><span id="l57.108" class="difflineminus">-  NS_IF_RELEASE( m_pSuccessLog);</span>
<a href="#l57.109"></a><span id="l57.109" class="difflineminus">-  NS_IF_RELEASE( m_pErrorLog);</span>
<a href="#l57.110"></a><span id="l57.110" class="difflineplus">+  NS_IF_RELEASE(m_pFieldMap);</span>
<a href="#l57.111"></a><span id="l57.111" class="difflineplus">+  NS_IF_RELEASE(m_pInterface);</span>
<a href="#l57.112"></a><span id="l57.112" class="difflineplus">+  NS_IF_RELEASE(m_pBooks);</span>
<a href="#l57.113"></a><span id="l57.113" class="difflineplus">+  NS_IF_RELEASE(m_pSuccessLog);</span>
<a href="#l57.114"></a><span id="l57.114" class="difflineplus">+  NS_IF_RELEASE(m_pErrorLog);</span>
<a href="#l57.115"></a><span id="l57.115"> }</span>
<a href="#l57.116"></a><span id="l57.116"> </span>
<a href="#l57.117"></a><span id="l57.117"> </span>
<a href="#l57.118"></a><span id="l57.118"> </span>
<a href="#l57.119"></a><span id="l57.119"> NS_IMPL_THREADSAFE_ISUPPORTS1(nsImportGenericAddressBooks, nsIImportGeneric)</span>
<a href="#l57.120"></a><span id="l57.120"> </span>
<a href="#l57.121"></a><span id="l57.121"> </span>
<a href="#l57.122"></a><span id="l57.122"> NS_IMETHODIMP nsImportGenericAddressBooks::GetData(const char *dataId, nsISupports **_retval)</span>
<a href="#l57.123"></a><span id="l57.123"> {</span>
<a href="#l57.124"></a><span id="l57.124">   NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l57.125"></a><span id="l57.125">   if (!_retval)</span>
<a href="#l57.126"></a><span id="l57.126">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l57.127"></a><span id="l57.127"> </span>
<a href="#l57.128"></a><span id="l57.128">   nsresult rv;</span>
<a href="#l57.129"></a><span id="l57.129">   *_retval = nsnull;</span>
<a href="#l57.130"></a><span id="l57.130" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;addressInterface&quot;)) {</span>
<a href="#l57.131"></a><span id="l57.131" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;addressInterface&quot;)) {</span>
<a href="#l57.132"></a><span id="l57.132">     *_retval = m_pInterface;</span>
<a href="#l57.133"></a><span id="l57.133" class="difflineminus">-    NS_IF_ADDREF( m_pInterface);</span>
<a href="#l57.134"></a><span id="l57.134" class="difflineplus">+    NS_IF_ADDREF(m_pInterface);</span>
<a href="#l57.135"></a><span id="l57.135">   }</span>
<a href="#l57.136"></a><span id="l57.136"> </span>
<a href="#l57.137"></a><span id="l57.137" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;addressLocation&quot;)) {</span>
<a href="#l57.138"></a><span id="l57.138" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;addressLocation&quot;)) {</span>
<a href="#l57.139"></a><span id="l57.139">     if (!m_pLocation)</span>
<a href="#l57.140"></a><span id="l57.140">       GetDefaultLocation();</span>
<a href="#l57.141"></a><span id="l57.141">     NS_IF_ADDREF(*_retval = m_pLocation);</span>
<a href="#l57.142"></a><span id="l57.142">   }</span>
<a href="#l57.143"></a><span id="l57.143"> </span>
<a href="#l57.144"></a><span id="l57.144" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;addressBooks&quot;)) {</span>
<a href="#l57.145"></a><span id="l57.145" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;addressBooks&quot;)) {</span>
<a href="#l57.146"></a><span id="l57.146">     if (!m_pLocation)</span>
<a href="#l57.147"></a><span id="l57.147">       GetDefaultLocation();</span>
<a href="#l57.148"></a><span id="l57.148">     if (!m_pBooks)</span>
<a href="#l57.149"></a><span id="l57.149">       GetDefaultBooks();</span>
<a href="#l57.150"></a><span id="l57.150">     *_retval = m_pBooks;</span>
<a href="#l57.151"></a><span id="l57.151" class="difflineminus">-    NS_IF_ADDREF( m_pBooks);</span>
<a href="#l57.152"></a><span id="l57.152" class="difflineplus">+    NS_IF_ADDREF(m_pBooks);</span>
<a href="#l57.153"></a><span id="l57.153">   }</span>
<a href="#l57.154"></a><span id="l57.154"> </span>
<a href="#l57.155"></a><span id="l57.155" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;addressDestination&quot;)) {</span>
<a href="#l57.156"></a><span id="l57.156" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;addressDestination&quot;)) {</span>
<a href="#l57.157"></a><span id="l57.157">     if (m_pDestinationUri) {</span>
<a href="#l57.158"></a><span id="l57.158">             nsCOMPtr&lt;nsISupportsCString&gt; abString = do_CreateInstance(NS_SUPPORTS_CSTRING_CONTRACTID, &amp;rv);</span>
<a href="#l57.159"></a><span id="l57.159">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l57.160"></a><span id="l57.160">             abString-&gt;SetData(nsDependentCString(m_pDestinationUri));</span>
<a href="#l57.161"></a><span id="l57.161" class="difflineminus">-            NS_IF_ADDREF( *_retval = abString);</span>
<a href="#l57.162"></a><span id="l57.162" class="difflineplus">+            NS_IF_ADDREF(*_retval = abString);</span>
<a href="#l57.163"></a><span id="l57.163">     }</span>
<a href="#l57.164"></a><span id="l57.164">   }</span>
<a href="#l57.165"></a><span id="l57.165"> </span>
<a href="#l57.166"></a><span id="l57.166" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;fieldMap&quot;)) {</span>
<a href="#l57.167"></a><span id="l57.167" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;fieldMap&quot;)) {</span>
<a href="#l57.168"></a><span id="l57.168">     if (m_pFieldMap) {</span>
<a href="#l57.169"></a><span id="l57.169">       *_retval = m_pFieldMap;</span>
<a href="#l57.170"></a><span id="l57.170">       m_pFieldMap-&gt;AddRef();</span>
<a href="#l57.171"></a><span id="l57.171">     }</span>
<a href="#l57.172"></a><span id="l57.172">     else {</span>
<a href="#l57.173"></a><span id="l57.173">       if (m_pInterface &amp;&amp; m_pLocation) {</span>
<a href="#l57.174"></a><span id="l57.174">         bool needsIt = false;</span>
<a href="#l57.175"></a><span id="l57.175" class="difflineminus">-        m_pInterface-&gt;GetNeedsFieldMap( m_pLocation, &amp;needsIt);</span>
<a href="#l57.176"></a><span id="l57.176" class="difflineplus">+        m_pInterface-&gt;GetNeedsFieldMap(m_pLocation, &amp;needsIt);</span>
<a href="#l57.177"></a><span id="l57.177">         if (needsIt) {</span>
<a href="#l57.178"></a><span id="l57.178">           GetDefaultFieldMap();</span>
<a href="#l57.179"></a><span id="l57.179">           if (m_pFieldMap) {</span>
<a href="#l57.180"></a><span id="l57.180">             *_retval = m_pFieldMap;</span>
<a href="#l57.181"></a><span id="l57.181">             m_pFieldMap-&gt;AddRef();</span>
<a href="#l57.182"></a><span id="l57.182">           }</span>
<a href="#l57.183"></a><span id="l57.183">         }</span>
<a href="#l57.184"></a><span id="l57.184">       }</span>
<a href="#l57.185"></a><span id="l57.185">     }</span>
<a href="#l57.186"></a><span id="l57.186">   }</span>
<a href="#l57.187"></a><span id="l57.187"> </span>
<a href="#l57.188"></a><span id="l57.188" class="difflineminus">-  if (!PL_strncasecmp( dataId, &quot;sampleData-&quot;, 11)) {</span>
<a href="#l57.189"></a><span id="l57.189" class="difflineplus">+  if (!PL_strncasecmp(dataId, &quot;sampleData-&quot;, 11)) {</span>
<a href="#l57.190"></a><span id="l57.190">     // extra the record number</span>
<a href="#l57.191"></a><span id="l57.191">     const char *pNum = dataId + 11;</span>
<a href="#l57.192"></a><span id="l57.192">     PRInt32  rNum = 0;</span>
<a href="#l57.193"></a><span id="l57.193">     while (*pNum) {</span>
<a href="#l57.194"></a><span id="l57.194">       rNum *= 10;</span>
<a href="#l57.195"></a><span id="l57.195">       rNum += (*pNum - '0');</span>
<a href="#l57.196"></a><span id="l57.196">       pNum++;</span>
<a href="#l57.197"></a><span id="l57.197">     }</span>
<a href="#l57.198"></a><span id="l57.198" class="difflineminus">-    IMPORT_LOG1( &quot;Requesting sample data #: %ld\n&quot;, (long)rNum);</span>
<a href="#l57.199"></a><span id="l57.199" class="difflineplus">+    IMPORT_LOG1(&quot;Requesting sample data #: %ld\n&quot;, (long)rNum);</span>
<a href="#l57.200"></a><span id="l57.200">     if (m_pInterface) {</span>
<a href="#l57.201"></a><span id="l57.201" class="difflineminus">-      nsCOMPtr&lt;nsISupportsString&gt;  data = do_CreateInstance( NS_SUPPORTS_STRING_CONTRACTID, &amp;rv);</span>
<a href="#l57.202"></a><span id="l57.202" class="difflineminus">-      if (NS_FAILED( rv))</span>
<a href="#l57.203"></a><span id="l57.203" class="difflineminus">-        return( rv);</span>
<a href="#l57.204"></a><span id="l57.204" class="difflineplus">+      nsCOMPtr&lt;nsISupportsString&gt;  data = do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv);</span>
<a href="#l57.205"></a><span id="l57.205" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l57.206"></a><span id="l57.206" class="difflineplus">+        return rv;</span>
<a href="#l57.207"></a><span id="l57.207">       PRUnichar *  pData = nsnull;</span>
<a href="#l57.208"></a><span id="l57.208">       bool      found = false;</span>
<a href="#l57.209"></a><span id="l57.209" class="difflineminus">-      rv = m_pInterface-&gt;GetSampleData( rNum, &amp;found, &amp;pData);</span>
<a href="#l57.210"></a><span id="l57.210" class="difflineminus">-      if (NS_FAILED( rv))</span>
<a href="#l57.211"></a><span id="l57.211" class="difflineminus">-        return( rv);</span>
<a href="#l57.212"></a><span id="l57.212" class="difflineplus">+      rv = m_pInterface-&gt;GetSampleData(rNum, &amp;found, &amp;pData);</span>
<a href="#l57.213"></a><span id="l57.213" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l57.214"></a><span id="l57.214" class="difflineplus">+        return rv;</span>
<a href="#l57.215"></a><span id="l57.215">       if (found) {</span>
<a href="#l57.216"></a><span id="l57.216">         data-&gt;SetData(nsDependentString(pData));</span>
<a href="#l57.217"></a><span id="l57.217">         *_retval = data;</span>
<a href="#l57.218"></a><span id="l57.218" class="difflineminus">-        NS_ADDREF( *_retval);</span>
<a href="#l57.219"></a><span id="l57.219" class="difflineplus">+        NS_ADDREF(*_retval);</span>
<a href="#l57.220"></a><span id="l57.220">       }</span>
<a href="#l57.221"></a><span id="l57.221" class="difflineminus">-      NS_Free( pData);</span>
<a href="#l57.222"></a><span id="l57.222" class="difflineplus">+      NS_Free(pData);</span>
<a href="#l57.223"></a><span id="l57.223">     }</span>
<a href="#l57.224"></a><span id="l57.224">   }</span>
<a href="#l57.225"></a><span id="l57.225"> </span>
<a href="#l57.226"></a><span id="l57.226" class="difflineminus">-  return( NS_OK);</span>
<a href="#l57.227"></a><span id="l57.227" class="difflineplus">+  return NS_OK;</span>
<a href="#l57.228"></a><span id="l57.228"> }</span>
<a href="#l57.229"></a><span id="l57.229"> </span>
<a href="#l57.230"></a><span id="l57.230"> </span>
<a href="#l57.231"></a><span id="l57.231" class="difflineminus">-NS_IMETHODIMP nsImportGenericAddressBooks::SetData( const char *dataId, nsISupports *item)</span>
<a href="#l57.232"></a><span id="l57.232" class="difflineplus">+NS_IMETHODIMP nsImportGenericAddressBooks::SetData(const char *dataId, nsISupports *item)</span>
<a href="#l57.233"></a><span id="l57.233"> {</span>
<a href="#l57.234"></a><span id="l57.234">   NS_PRECONDITION(dataId != nsnull, &quot;null ptr&quot;);</span>
<a href="#l57.235"></a><span id="l57.235" class="difflineminus">-    if (!dataId)</span>
<a href="#l57.236"></a><span id="l57.236" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l57.237"></a><span id="l57.237" class="difflineplus">+  if (!dataId)</span>
<a href="#l57.238"></a><span id="l57.238" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l57.239"></a><span id="l57.239"> </span>
<a href="#l57.240"></a><span id="l57.240" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;addressInterface&quot;)) {</span>
<a href="#l57.241"></a><span id="l57.241" class="difflineminus">-    NS_IF_RELEASE( m_pInterface);</span>
<a href="#l57.242"></a><span id="l57.242" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;addressInterface&quot;)) {</span>
<a href="#l57.243"></a><span id="l57.243" class="difflineplus">+    NS_IF_RELEASE(m_pInterface);</span>
<a href="#l57.244"></a><span id="l57.244">     if (item)</span>
<a href="#l57.245"></a><span id="l57.245" class="difflineminus">-      item-&gt;QueryInterface( NS_GET_IID(nsIImportAddressBooks), (void **) &amp;m_pInterface);</span>
<a href="#l57.246"></a><span id="l57.246" class="difflineplus">+      item-&gt;QueryInterface(NS_GET_IID(nsIImportAddressBooks), (void **) &amp;m_pInterface);</span>
<a href="#l57.247"></a><span id="l57.247">   }</span>
<a href="#l57.248"></a><span id="l57.248" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;addressBooks&quot;)) {</span>
<a href="#l57.249"></a><span id="l57.249" class="difflineminus">-    NS_IF_RELEASE( m_pBooks);</span>
<a href="#l57.250"></a><span id="l57.250" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;addressBooks&quot;)) {</span>
<a href="#l57.251"></a><span id="l57.251" class="difflineplus">+    NS_IF_RELEASE(m_pBooks);</span>
<a href="#l57.252"></a><span id="l57.252">     if (item)</span>
<a href="#l57.253"></a><span id="l57.253" class="difflineminus">-      item-&gt;QueryInterface( NS_GET_IID(nsISupportsArray), (void **) &amp;m_pBooks);</span>
<a href="#l57.254"></a><span id="l57.254" class="difflineplus">+      item-&gt;QueryInterface(NS_GET_IID(nsISupportsArray), (void **) &amp;m_pBooks);</span>
<a href="#l57.255"></a><span id="l57.255">   }</span>
<a href="#l57.256"></a><span id="l57.256"> </span>
<a href="#l57.257"></a><span id="l57.257" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;addressLocation&quot;)) {</span>
<a href="#l57.258"></a><span id="l57.258" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;addressLocation&quot;)) {</span>
<a href="#l57.259"></a><span id="l57.259">     m_pLocation = nsnull;</span>
<a href="#l57.260"></a><span id="l57.260"> </span>
<a href="#l57.261"></a><span id="l57.261">     if (item) {</span>
<a href="#l57.262"></a><span id="l57.262">       nsresult rv;</span>
<a href="#l57.263"></a><span id="l57.263">       m_pLocation = do_QueryInterface(item, &amp;rv);</span>
<a href="#l57.264"></a><span id="l57.264">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l57.265"></a><span id="l57.265">     }</span>
<a href="#l57.266"></a><span id="l57.266"> </span>
<a href="#l57.267"></a><span id="l57.267">     if (m_pInterface)</span>
<a href="#l57.268"></a><span id="l57.268">       m_pInterface-&gt;SetSampleLocation(m_pLocation);</span>
<a href="#l57.269"></a><span id="l57.269" class="difflineminus">-    }</span>
<a href="#l57.270"></a><span id="l57.270" class="difflineplus">+  }</span>
<a href="#l57.271"></a><span id="l57.271"> </span>
<a href="#l57.272"></a><span id="l57.272" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;addressDestination&quot;)) {</span>
<a href="#l57.273"></a><span id="l57.273" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;addressDestination&quot;)) {</span>
<a href="#l57.274"></a><span id="l57.274">     if (item) {</span>
<a href="#l57.275"></a><span id="l57.275">       nsCOMPtr&lt;nsISupportsCString&gt; abString;</span>
<a href="#l57.276"></a><span id="l57.276" class="difflineminus">-      item-&gt;QueryInterface( NS_GET_IID(nsISupportsCString), getter_AddRefs( abString));</span>
<a href="#l57.277"></a><span id="l57.277" class="difflineplus">+      item-&gt;QueryInterface(NS_GET_IID(nsISupportsCString), getter_AddRefs(abString));</span>
<a href="#l57.278"></a><span id="l57.278">       if (abString) {</span>
<a href="#l57.279"></a><span id="l57.279">         if (m_pDestinationUri)</span>
<a href="#l57.280"></a><span id="l57.280" class="difflineminus">-          NS_Free( m_pDestinationUri);</span>
<a href="#l57.281"></a><span id="l57.281" class="difflineplus">+          NS_Free(m_pDestinationUri);</span>
<a href="#l57.282"></a><span id="l57.282">         m_pDestinationUri = nsnull;</span>
<a href="#l57.283"></a><span id="l57.283">                 nsCAutoString tempUri;</span>
<a href="#l57.284"></a><span id="l57.284">                 abString-&gt;GetData(tempUri);</span>
<a href="#l57.285"></a><span id="l57.285">                 m_pDestinationUri = ToNewCString(tempUri);</span>
<a href="#l57.286"></a><span id="l57.286">       }</span>
<a href="#l57.287"></a><span id="l57.287">     }</span>
<a href="#l57.288"></a><span id="l57.288">   }</span>
<a href="#l57.289"></a><span id="l57.289"> </span>
<a href="#l57.290"></a><span id="l57.290" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;fieldMap&quot;)) {</span>
<a href="#l57.291"></a><span id="l57.291" class="difflineminus">-    NS_IF_RELEASE( m_pFieldMap);</span>
<a href="#l57.292"></a><span id="l57.292" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;fieldMap&quot;)) {</span>
<a href="#l57.293"></a><span id="l57.293" class="difflineplus">+    NS_IF_RELEASE(m_pFieldMap);</span>
<a href="#l57.294"></a><span id="l57.294">     if (item)</span>
<a href="#l57.295"></a><span id="l57.295" class="difflineminus">-      item-&gt;QueryInterface( NS_GET_IID(nsIImportFieldMap), (void **) &amp;m_pFieldMap);</span>
<a href="#l57.296"></a><span id="l57.296" class="difflineplus">+      item-&gt;QueryInterface(NS_GET_IID(nsIImportFieldMap), (void **) &amp;m_pFieldMap);</span>
<a href="#l57.297"></a><span id="l57.297">   }</span>
<a href="#l57.298"></a><span id="l57.298"> </span>
<a href="#l57.299"></a><span id="l57.299" class="difflineminus">-  return( NS_OK);</span>
<a href="#l57.300"></a><span id="l57.300" class="difflineplus">+  return NS_OK;</span>
<a href="#l57.301"></a><span id="l57.301"> }</span>
<a href="#l57.302"></a><span id="l57.302"> </span>
<a href="#l57.303"></a><span id="l57.303" class="difflineminus">-NS_IMETHODIMP nsImportGenericAddressBooks::GetStatus( const char *statusKind, PRInt32 *_retval)</span>
<a href="#l57.304"></a><span id="l57.304" class="difflineplus">+NS_IMETHODIMP nsImportGenericAddressBooks::GetStatus(const char *statusKind, PRInt32 *_retval)</span>
<a href="#l57.305"></a><span id="l57.305"> {</span>
<a href="#l57.306"></a><span id="l57.306">   NS_PRECONDITION(statusKind != nsnull, &quot;null ptr&quot;);</span>
<a href="#l57.307"></a><span id="l57.307">   NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l57.308"></a><span id="l57.308">   if (!statusKind || !_retval)</span>
<a href="#l57.309"></a><span id="l57.309" class="difflineminus">-    return( NS_ERROR_NULL_POINTER);</span>
<a href="#l57.310"></a><span id="l57.310" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l57.311"></a><span id="l57.311"> </span>
<a href="#l57.312"></a><span id="l57.312">   *_retval = 0;</span>
<a href="#l57.313"></a><span id="l57.313"> </span>
<a href="#l57.314"></a><span id="l57.314" class="difflineminus">-  if (!PL_strcasecmp( statusKind, &quot;isInstalled&quot;)) {</span>
<a href="#l57.315"></a><span id="l57.315" class="difflineplus">+  if (!PL_strcasecmp(statusKind, &quot;isInstalled&quot;)) {</span>
<a href="#l57.316"></a><span id="l57.316">     GetDefaultLocation();</span>
<a href="#l57.317"></a><span id="l57.317">     *_retval = (PRInt32) m_found;</span>
<a href="#l57.318"></a><span id="l57.318">   }</span>
<a href="#l57.319"></a><span id="l57.319"> </span>
<a href="#l57.320"></a><span id="l57.320" class="difflineminus">-  if (!PL_strcasecmp( statusKind, &quot;canUserSetLocation&quot;)) {</span>
<a href="#l57.321"></a><span id="l57.321" class="difflineplus">+  if (!PL_strcasecmp(statusKind, &quot;canUserSetLocation&quot;)) {</span>
<a href="#l57.322"></a><span id="l57.322">     GetDefaultLocation();</span>
<a href="#l57.323"></a><span id="l57.323">     *_retval = (PRInt32) m_userVerify;</span>
<a href="#l57.324"></a><span id="l57.324">   }</span>
<a href="#l57.325"></a><span id="l57.325"> </span>
<a href="#l57.326"></a><span id="l57.326" class="difflineminus">-  if (!PL_strcasecmp( statusKind, &quot;autoFind&quot;)) {</span>
<a href="#l57.327"></a><span id="l57.327" class="difflineplus">+  if (!PL_strcasecmp(statusKind, &quot;autoFind&quot;)) {</span>
<a href="#l57.328"></a><span id="l57.328">     GetDefaultLocation();</span>
<a href="#l57.329"></a><span id="l57.329">     *_retval = (PRInt32) m_autoFind;</span>
<a href="#l57.330"></a><span id="l57.330">   }</span>
<a href="#l57.331"></a><span id="l57.331"> </span>
<a href="#l57.332"></a><span id="l57.332" class="difflineminus">-  if (!PL_strcasecmp( statusKind, &quot;supportsMultiple&quot;)) {</span>
<a href="#l57.333"></a><span id="l57.333" class="difflineplus">+  if (!PL_strcasecmp(statusKind, &quot;supportsMultiple&quot;)) {</span>
<a href="#l57.334"></a><span id="l57.334">     bool      multi = false;</span>
<a href="#l57.335"></a><span id="l57.335">     if (m_pInterface)</span>
<a href="#l57.336"></a><span id="l57.336" class="difflineminus">-      m_pInterface-&gt;GetSupportsMultiple( &amp;multi);</span>
<a href="#l57.337"></a><span id="l57.337" class="difflineplus">+      m_pInterface-&gt;GetSupportsMultiple(&amp;multi);</span>
<a href="#l57.338"></a><span id="l57.338">     *_retval = (PRInt32) multi;</span>
<a href="#l57.339"></a><span id="l57.339">   }</span>
<a href="#l57.340"></a><span id="l57.340"> </span>
<a href="#l57.341"></a><span id="l57.341" class="difflineminus">-  if (!PL_strcasecmp( statusKind, &quot;needsFieldMap&quot;)) {</span>
<a href="#l57.342"></a><span id="l57.342" class="difflineplus">+  if (!PL_strcasecmp(statusKind, &quot;needsFieldMap&quot;)) {</span>
<a href="#l57.343"></a><span id="l57.343">     bool      needs = false;</span>
<a href="#l57.344"></a><span id="l57.344">     if (m_pInterface &amp;&amp; m_pLocation)</span>
<a href="#l57.345"></a><span id="l57.345" class="difflineminus">-      m_pInterface-&gt;GetNeedsFieldMap( m_pLocation, &amp;needs);</span>
<a href="#l57.346"></a><span id="l57.346" class="difflineplus">+      m_pInterface-&gt;GetNeedsFieldMap(m_pLocation, &amp;needs);</span>
<a href="#l57.347"></a><span id="l57.347">     *_retval = (PRInt32) needs;</span>
<a href="#l57.348"></a><span id="l57.348">   }</span>
<a href="#l57.349"></a><span id="l57.349"> </span>
<a href="#l57.350"></a><span id="l57.350" class="difflineminus">-  return( NS_OK);</span>
<a href="#l57.351"></a><span id="l57.351" class="difflineplus">+  return NS_OK;</span>
<a href="#l57.352"></a><span id="l57.352"> }</span>
<a href="#l57.353"></a><span id="l57.353"> </span>
<a href="#l57.354"></a><span id="l57.354" class="difflineminus">-void nsImportGenericAddressBooks::GetDefaultLocation( void)</span>
<a href="#l57.355"></a><span id="l57.355" class="difflineplus">+void nsImportGenericAddressBooks::GetDefaultLocation(void)</span>
<a href="#l57.356"></a><span id="l57.356"> {</span>
<a href="#l57.357"></a><span id="l57.357">   if (!m_pInterface)</span>
<a href="#l57.358"></a><span id="l57.358">     return;</span>
<a href="#l57.359"></a><span id="l57.359"> </span>
<a href="#l57.360"></a><span id="l57.360">   if ((m_pLocation &amp;&amp; m_gotLocation) || m_autoFind)</span>
<a href="#l57.361"></a><span id="l57.361">     return;</span>
<a href="#l57.362"></a><span id="l57.362"> </span>
<a href="#l57.363"></a><span id="l57.363">   if (m_description)</span>
<a href="#l57.364"></a><span id="l57.364" class="difflineminus">-    NS_Free( m_description);</span>
<a href="#l57.365"></a><span id="l57.365" class="difflineplus">+    NS_Free(m_description);</span>
<a href="#l57.366"></a><span id="l57.366">   m_description = nsnull;</span>
<a href="#l57.367"></a><span id="l57.367" class="difflineminus">-  m_pInterface-&gt;GetAutoFind( &amp;m_description, &amp;m_autoFind);</span>
<a href="#l57.368"></a><span id="l57.368" class="difflineplus">+  m_pInterface-&gt;GetAutoFind(&amp;m_description, &amp;m_autoFind);</span>
<a href="#l57.369"></a><span id="l57.369">   m_gotLocation = true;</span>
<a href="#l57.370"></a><span id="l57.370">   if (m_autoFind) {</span>
<a href="#l57.371"></a><span id="l57.371">     m_found = true;</span>
<a href="#l57.372"></a><span id="l57.372">     m_userVerify = false;</span>
<a href="#l57.373"></a><span id="l57.373">     return;</span>
<a href="#l57.374"></a><span id="l57.374">   }</span>
<a href="#l57.375"></a><span id="l57.375"> </span>
<a href="#l57.376"></a><span id="l57.376">   nsCOMPtr &lt;nsIFile&gt; pLoc;</span>
<a href="#l57.377"></a><span id="l57.377" class="difflineminus">-  m_pInterface-&gt;GetDefaultLocation( getter_AddRefs(pLoc), &amp;m_found, &amp;m_userVerify);</span>
<a href="#l57.378"></a><span id="l57.378" class="difflineplus">+  m_pInterface-&gt;GetDefaultLocation(getter_AddRefs(pLoc), &amp;m_found, &amp;m_userVerify);</span>
<a href="#l57.379"></a><span id="l57.379">   if (!m_pLocation)</span>
<a href="#l57.380"></a><span id="l57.380">     m_pLocation = pLoc;</span>
<a href="#l57.381"></a><span id="l57.381"> }</span>
<a href="#l57.382"></a><span id="l57.382"> </span>
<a href="#l57.383"></a><span id="l57.383" class="difflineminus">-void nsImportGenericAddressBooks::GetDefaultBooks( void)</span>
<a href="#l57.384"></a><span id="l57.384" class="difflineplus">+void nsImportGenericAddressBooks::GetDefaultBooks(void)</span>
<a href="#l57.385"></a><span id="l57.385"> {</span>
<a href="#l57.386"></a><span id="l57.386">   if (!m_pInterface || m_pBooks)</span>
<a href="#l57.387"></a><span id="l57.387">     return;</span>
<a href="#l57.388"></a><span id="l57.388"> </span>
<a href="#l57.389"></a><span id="l57.389">   if (!m_pLocation &amp;&amp; !m_autoFind)</span>
<a href="#l57.390"></a><span id="l57.390">     return;</span>
<a href="#l57.391"></a><span id="l57.391"> </span>
<a href="#l57.392"></a><span id="l57.392" class="difflineminus">-  nsresult rv = m_pInterface-&gt;FindAddressBooks( m_pLocation, &amp;m_pBooks);</span>
<a href="#l57.393"></a><span id="l57.393" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l57.394"></a><span id="l57.394" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error: FindAddressBooks failed\n&quot;);</span>
<a href="#l57.395"></a><span id="l57.395" class="difflineplus">+  nsresult rv = m_pInterface-&gt;FindAddressBooks(m_pLocation, &amp;m_pBooks);</span>
<a href="#l57.396"></a><span id="l57.396" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l57.397"></a><span id="l57.397" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error: FindAddressBooks failed\n&quot;);</span>
<a href="#l57.398"></a><span id="l57.398">   }</span>
<a href="#l57.399"></a><span id="l57.399"> }</span>
<a href="#l57.400"></a><span id="l57.400"> </span>
<a href="#l57.401"></a><span id="l57.401" class="difflineminus">-void nsImportGenericAddressBooks::GetDefaultFieldMap( void)</span>
<a href="#l57.402"></a><span id="l57.402" class="difflineplus">+void nsImportGenericAddressBooks::GetDefaultFieldMap(void)</span>
<a href="#l57.403"></a><span id="l57.403"> {</span>
<a href="#l57.404"></a><span id="l57.404">   if (!m_pInterface || !m_pLocation)</span>
<a href="#l57.405"></a><span id="l57.405">     return;</span>
<a href="#l57.406"></a><span id="l57.406"> </span>
<a href="#l57.407"></a><span id="l57.407" class="difflineminus">-  NS_IF_RELEASE( m_pFieldMap);</span>
<a href="#l57.408"></a><span id="l57.408" class="difflineplus">+  NS_IF_RELEASE(m_pFieldMap);</span>
<a href="#l57.409"></a><span id="l57.409"> </span>
<a href="#l57.410"></a><span id="l57.410">   nsresult  rv;</span>
<a href="#l57.411"></a><span id="l57.411">   nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l57.412"></a><span id="l57.412">   if (NS_FAILED(rv)) {</span>
<a href="#l57.413"></a><span id="l57.413" class="difflineminus">-    IMPORT_LOG0( &quot;*** Unable to get nsIImportService.\n&quot;);</span>
<a href="#l57.414"></a><span id="l57.414" class="difflineplus">+    IMPORT_LOG0(&quot;*** Unable to get nsIImportService.\n&quot;);</span>
<a href="#l57.415"></a><span id="l57.415">     return;</span>
<a href="#l57.416"></a><span id="l57.416">   }</span>
<a href="#l57.417"></a><span id="l57.417"> </span>
<a href="#l57.418"></a><span id="l57.418" class="difflineminus">-  rv = impSvc-&gt;CreateNewFieldMap( &amp;m_pFieldMap);</span>
<a href="#l57.419"></a><span id="l57.419" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l57.420"></a><span id="l57.420" class="difflineplus">+  rv = impSvc-&gt;CreateNewFieldMap(&amp;m_pFieldMap);</span>
<a href="#l57.421"></a><span id="l57.421" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l57.422"></a><span id="l57.422">     return;</span>
<a href="#l57.423"></a><span id="l57.423"> </span>
<a href="#l57.424"></a><span id="l57.424">   PRInt32  sz = 0;</span>
<a href="#l57.425"></a><span id="l57.425" class="difflineminus">-  rv = m_pFieldMap-&gt;GetNumMozFields( &amp;sz);</span>
<a href="#l57.426"></a><span id="l57.426" class="difflineminus">-  if (NS_SUCCEEDED( rv))</span>
<a href="#l57.427"></a><span id="l57.427" class="difflineminus">-    rv = m_pFieldMap-&gt;DefaultFieldMap( sz);</span>
<a href="#l57.428"></a><span id="l57.428" class="difflineminus">-    if (NS_SUCCEEDED( rv))</span>
<a href="#l57.429"></a><span id="l57.429" class="difflineplus">+  rv = m_pFieldMap-&gt;GetNumMozFields(&amp;sz);</span>
<a href="#l57.430"></a><span id="l57.430" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l57.431"></a><span id="l57.431" class="difflineplus">+    rv = m_pFieldMap-&gt;DefaultFieldMap(sz);</span>
<a href="#l57.432"></a><span id="l57.432" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l57.433"></a><span id="l57.433">       rv = m_pInterface-&gt;InitFieldMap(m_pFieldMap);</span>
<a href="#l57.434"></a><span id="l57.434" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l57.435"></a><span id="l57.435" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error: Unable to initialize field map\n&quot;);</span>
<a href="#l57.436"></a><span id="l57.436" class="difflineminus">-    NS_IF_RELEASE( m_pFieldMap);</span>
<a href="#l57.437"></a><span id="l57.437" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l57.438"></a><span id="l57.438" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error: Unable to initialize field map\n&quot;);</span>
<a href="#l57.439"></a><span id="l57.439" class="difflineplus">+    NS_IF_RELEASE(m_pFieldMap);</span>
<a href="#l57.440"></a><span id="l57.440">   }</span>
<a href="#l57.441"></a><span id="l57.441"> }</span>
<a href="#l57.442"></a><span id="l57.442"> </span>
<a href="#l57.443"></a><span id="l57.443"> </span>
<a href="#l57.444"></a><span id="l57.444"> NS_IMETHODIMP nsImportGenericAddressBooks::WantsProgress(bool *_retval)</span>
<a href="#l57.445"></a><span id="l57.445"> {</span>
<a href="#l57.446"></a><span id="l57.446">   NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l57.447"></a><span id="l57.447">     if (!_retval)</span>
<a href="#l57.448"></a><span id="l57.448" class="difflineat">@@ -469,47 +469,47 @@ NS_IMETHODIMP nsImportGenericAddressBook</span>
<a href="#l57.449"></a><span id="l57.449">   GetDefaultLocation();</span>
<a href="#l57.450"></a><span id="l57.450">   GetDefaultBooks();</span>
<a href="#l57.451"></a><span id="l57.451"> </span>
<a href="#l57.452"></a><span id="l57.452">   PRUint32    totalSize = 0;</span>
<a href="#l57.453"></a><span id="l57.453">   bool        result = false;</span>
<a href="#l57.454"></a><span id="l57.454"> </span>
<a href="#l57.455"></a><span id="l57.455">   if (m_pBooks) {</span>
<a href="#l57.456"></a><span id="l57.456">     PRUint32    count = 0;</span>
<a href="#l57.457"></a><span id="l57.457" class="difflineminus">-    nsresult     rv = m_pBooks-&gt;Count( &amp;count);</span>
<a href="#l57.458"></a><span id="l57.458" class="difflineplus">+    nsresult     rv = m_pBooks-&gt;Count(&amp;count);</span>
<a href="#l57.459"></a><span id="l57.459">     PRUint32    i;</span>
<a href="#l57.460"></a><span id="l57.460">     bool        import;</span>
<a href="#l57.461"></a><span id="l57.461">     PRUint32    size;</span>
<a href="#l57.462"></a><span id="l57.462"> </span>
<a href="#l57.463"></a><span id="l57.463">     for (i = 0; i &lt; count; i++) {</span>
<a href="#l57.464"></a><span id="l57.464">       nsCOMPtr&lt;nsIImportABDescriptor&gt; book =</span>
<a href="#l57.465"></a><span id="l57.465">         do_QueryElementAt(m_pBooks, i);</span>
<a href="#l57.466"></a><span id="l57.466">       if (book) {</span>
<a href="#l57.467"></a><span id="l57.467">         import = false;</span>
<a href="#l57.468"></a><span id="l57.468">         size = 0;</span>
<a href="#l57.469"></a><span id="l57.469" class="difflineminus">-        rv = book-&gt;GetImport( &amp;import);</span>
<a href="#l57.470"></a><span id="l57.470" class="difflineplus">+        rv = book-&gt;GetImport(&amp;import);</span>
<a href="#l57.471"></a><span id="l57.471">         if (import) {</span>
<a href="#l57.472"></a><span id="l57.472" class="difflineminus">-          rv = book-&gt;GetSize( &amp;size);</span>
<a href="#l57.473"></a><span id="l57.473" class="difflineplus">+          rv = book-&gt;GetSize(&amp;size);</span>
<a href="#l57.474"></a><span id="l57.474">           result = true;</span>
<a href="#l57.475"></a><span id="l57.475">         }</span>
<a href="#l57.476"></a><span id="l57.476">         totalSize += size;</span>
<a href="#l57.477"></a><span id="l57.477">       }</span>
<a href="#l57.478"></a><span id="l57.478">     }</span>
<a href="#l57.479"></a><span id="l57.479"> </span>
<a href="#l57.480"></a><span id="l57.480">     m_totalSize = totalSize;</span>
<a href="#l57.481"></a><span id="l57.481">   }</span>
<a href="#l57.482"></a><span id="l57.482"> </span>
<a href="#l57.483"></a><span id="l57.483">   m_doImport = result;</span>
<a href="#l57.484"></a><span id="l57.484"> </span>
<a href="#l57.485"></a><span id="l57.485">   *_retval = result;</span>
<a href="#l57.486"></a><span id="l57.486"> </span>
<a href="#l57.487"></a><span id="l57.487" class="difflineminus">-  return( NS_OK);</span>
<a href="#l57.488"></a><span id="l57.488" class="difflineplus">+  return NS_OK;</span>
<a href="#l57.489"></a><span id="l57.489"> }</span>
<a href="#l57.490"></a><span id="l57.490"> </span>
<a href="#l57.491"></a><span id="l57.491" class="difflineminus">-void nsImportGenericAddressBooks::SetLogs( nsString&amp; success, nsString&amp; error, nsISupportsString *pSuccess, nsISupportsString *pError)</span>
<a href="#l57.492"></a><span id="l57.492" class="difflineplus">+void nsImportGenericAddressBooks::SetLogs(nsString&amp; success, nsString&amp; error, nsISupportsString *pSuccess, nsISupportsString *pError)</span>
<a href="#l57.493"></a><span id="l57.493"> {</span>
<a href="#l57.494"></a><span id="l57.494">   nsAutoString str;</span>
<a href="#l57.495"></a><span id="l57.495">   if (pSuccess) {</span>
<a href="#l57.496"></a><span id="l57.496">     pSuccess-&gt;GetData(str);</span>
<a href="#l57.497"></a><span id="l57.497">         str.Append(success);</span>
<a href="#l57.498"></a><span id="l57.498">         pSuccess-&gt;SetData(success);</span>
<a href="#l57.499"></a><span id="l57.499">   }</span>
<a href="#l57.500"></a><span id="l57.500">   if (pError) {</span>
<a href="#l57.501"></a><span id="l57.501" class="difflineat">@@ -547,17 +547,17 @@ already_AddRefed&lt;nsIAddrDatabase&gt; GetAdd</span>
<a href="#l57.502"></a><span id="l57.502">                                                  bool makeNew)</span>
<a href="#l57.503"></a><span id="l57.503"> {</span>
<a href="#l57.504"></a><span id="l57.504">   if (!makeNew) {</span>
<a href="#l57.505"></a><span id="l57.505">     // FIXME: How do I get the list of address books and look for a</span>
<a href="#l57.506"></a><span id="l57.506">     // specific name.  Major bogosity!</span>
<a href="#l57.507"></a><span id="l57.507">     // For now, assume we didn't find anything with that name</span>
<a href="#l57.508"></a><span id="l57.508">   }</span>
<a href="#l57.509"></a><span id="l57.509"> </span>
<a href="#l57.510"></a><span id="l57.510" class="difflineminus">-  IMPORT_LOG0( &quot;In GetAddressBook\n&quot;);</span>
<a href="#l57.511"></a><span id="l57.511" class="difflineplus">+  IMPORT_LOG0(&quot;In GetAddressBook\n&quot;);</span>
<a href="#l57.512"></a><span id="l57.512"> </span>
<a href="#l57.513"></a><span id="l57.513">   nsresult rv;</span>
<a href="#l57.514"></a><span id="l57.514">   nsIAddrDatabase *pDatabase = nsnull;</span>
<a href="#l57.515"></a><span id="l57.515">   nsCOMPtr&lt;nsILocalFile&gt; dbPath;</span>
<a href="#l57.516"></a><span id="l57.516">   nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l57.517"></a><span id="l57.517">   if (NS_SUCCEEDED(rv))</span>
<a href="#l57.518"></a><span id="l57.518">   {</span>
<a href="#l57.519"></a><span id="l57.519">     /* Get the profile directory */</span>
<a href="#l57.520"></a><span id="l57.520" class="difflineat">@@ -568,33 +568,33 @@ already_AddRefed&lt;nsIAddrDatabase&gt; GetAdd</span>
<a href="#l57.521"></a><span id="l57.521">       // name is, as long as it's unique</span>
<a href="#l57.522"></a><span id="l57.522">       rv = dbPath-&gt;Append(NS_LITERAL_STRING(&quot;impab.mab&quot;));</span>
<a href="#l57.523"></a><span id="l57.523">       if (NS_SUCCEEDED(rv))</span>
<a href="#l57.524"></a><span id="l57.524">       {</span>
<a href="#l57.525"></a><span id="l57.525">         rv = dbPath-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0600);</span>
<a href="#l57.526"></a><span id="l57.526"> </span>
<a href="#l57.527"></a><span id="l57.527">         if (NS_SUCCEEDED(rv))</span>
<a href="#l57.528"></a><span id="l57.528">         {</span>
<a href="#l57.529"></a><span id="l57.529" class="difflineminus">-          IMPORT_LOG0( &quot;Getting the address database factory\n&quot;);</span>
<a href="#l57.530"></a><span id="l57.530" class="difflineplus">+          IMPORT_LOG0(&quot;Getting the address database factory\n&quot;);</span>
<a href="#l57.531"></a><span id="l57.531"> </span>
<a href="#l57.532"></a><span id="l57.532">           nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory =</span>
<a href="#l57.533"></a><span id="l57.533">             do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l57.534"></a><span id="l57.534">           if (NS_FAILED(rv))</span>
<a href="#l57.535"></a><span id="l57.535">             return nsnull;</span>
<a href="#l57.536"></a><span id="l57.536"> </span>
<a href="#l57.537"></a><span id="l57.537" class="difflineminus">-          IMPORT_LOG0( &quot;Opening the new address book\n&quot;);</span>
<a href="#l57.538"></a><span id="l57.538" class="difflineplus">+          IMPORT_LOG0(&quot;Opening the new address book\n&quot;);</span>
<a href="#l57.539"></a><span id="l57.539">           rv = addrDBFactory-&gt;Open(dbPath, true, true,</span>
<a href="#l57.540"></a><span id="l57.540">                                    &amp;pDatabase);</span>
<a href="#l57.541"></a><span id="l57.541">         }</span>
<a href="#l57.542"></a><span id="l57.542">       }</span>
<a href="#l57.543"></a><span id="l57.543">     }</span>
<a href="#l57.544"></a><span id="l57.544">   }</span>
<a href="#l57.545"></a><span id="l57.545">   if (NS_FAILED(rv))</span>
<a href="#l57.546"></a><span id="l57.546">   {</span>
<a href="#l57.547"></a><span id="l57.547" class="difflineminus">-    IMPORT_LOG0( &quot;Failed to get the user profile directory from the address book session\n&quot;);</span>
<a href="#l57.548"></a><span id="l57.548" class="difflineplus">+    IMPORT_LOG0(&quot;Failed to get the user profile directory from the address book session\n&quot;);</span>
<a href="#l57.549"></a><span id="l57.549">   }</span>
<a href="#l57.550"></a><span id="l57.550"> </span>
<a href="#l57.551"></a><span id="l57.551">   if (pDatabase &amp;&amp; dbPath)</span>
<a href="#l57.552"></a><span id="l57.552">   {</span>
<a href="#l57.553"></a><span id="l57.553">     // We made a database, add it to the UI?!?!?!?!?!?!</span>
<a href="#l57.554"></a><span id="l57.554">     // This is major bogosity again!  Why doesn't the address book</span>
<a href="#l57.555"></a><span id="l57.555">     // just handle this properly for me?  Uggggg...</span>
<a href="#l57.556"></a><span id="l57.556"> </span>
<a href="#l57.557"></a><span id="l57.557" class="difflineat">@@ -602,30 +602,30 @@ already_AddRefed&lt;nsIAddrDatabase&gt; GetAdd</span>
<a href="#l57.558"></a><span id="l57.558">     abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(kAllDirectoryRoot),</span>
<a href="#l57.559"></a><span id="l57.559">                             getter_AddRefs(parentDir));</span>
<a href="#l57.560"></a><span id="l57.560">     if (parentDir)</span>
<a href="#l57.561"></a><span id="l57.561">     {</span>
<a href="#l57.562"></a><span id="l57.562">       nsCAutoString URI(&quot;moz-abmdbdirectory://&quot;);</span>
<a href="#l57.563"></a><span id="l57.563">       nsCAutoString leafName;</span>
<a href="#l57.564"></a><span id="l57.564">       rv = dbPath-&gt;GetNativeLeafName(leafName);</span>
<a href="#l57.565"></a><span id="l57.565">       if (NS_FAILED(rv))</span>
<a href="#l57.566"></a><span id="l57.566" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error: Unable to get name of database file\n&quot;);</span>
<a href="#l57.567"></a><span id="l57.567" class="difflineplus">+        IMPORT_LOG0(&quot;*** Error: Unable to get name of database file\n&quot;);</span>
<a href="#l57.568"></a><span id="l57.568">       else</span>
<a href="#l57.569"></a><span id="l57.569">       {</span>
<a href="#l57.570"></a><span id="l57.570">         URI.Append(leafName);</span>
<a href="#l57.571"></a><span id="l57.571">         rv = parentDir-&gt;CreateDirectoryByURI(nsDependentString(name), URI);</span>
<a href="#l57.572"></a><span id="l57.572">         if (NS_FAILED(rv))</span>
<a href="#l57.573"></a><span id="l57.573" class="difflineminus">-          IMPORT_LOG0( &quot;*** Error: Unable to create address book directory\n&quot;);</span>
<a href="#l57.574"></a><span id="l57.574" class="difflineplus">+          IMPORT_LOG0(&quot;*** Error: Unable to create address book directory\n&quot;);</span>
<a href="#l57.575"></a><span id="l57.575">       }</span>
<a href="#l57.576"></a><span id="l57.576">     }</span>
<a href="#l57.577"></a><span id="l57.577"> </span>
<a href="#l57.578"></a><span id="l57.578">     if (NS_SUCCEEDED(rv))</span>
<a href="#l57.579"></a><span id="l57.579" class="difflineminus">-      IMPORT_LOG0( &quot;Added new address book to the UI\n&quot;);</span>
<a href="#l57.580"></a><span id="l57.580" class="difflineplus">+      IMPORT_LOG0(&quot;Added new address book to the UI\n&quot;);</span>
<a href="#l57.581"></a><span id="l57.581">     else</span>
<a href="#l57.582"></a><span id="l57.582" class="difflineminus">-      IMPORT_LOG0( &quot;*** Error: An error occurred while adding the address book to the UI\n&quot;);</span>
<a href="#l57.583"></a><span id="l57.583" class="difflineplus">+      IMPORT_LOG0(&quot;*** Error: An error occurred while adding the address book to the UI\n&quot;);</span>
<a href="#l57.584"></a><span id="l57.584">   }</span>
<a href="#l57.585"></a><span id="l57.585"> </span>
<a href="#l57.586"></a><span id="l57.586">   return pDatabase;</span>
<a href="#l57.587"></a><span id="l57.587"> }</span>
<a href="#l57.588"></a><span id="l57.588"> </span>
<a href="#l57.589"></a><span id="l57.589"> NS_IMETHODIMP nsImportGenericAddressBooks::BeginImport(nsISupportsString *successLog, nsISupportsString *errorLog, bool *_retval)</span>
<a href="#l57.590"></a><span id="l57.590"> {</span>
<a href="#l57.591"></a><span id="l57.591">   NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l57.592"></a><span id="l57.592" class="difflineat">@@ -634,63 +634,63 @@ NS_IMETHODIMP nsImportGenericAddressBook</span>
<a href="#l57.593"></a><span id="l57.593"> </span>
<a href="#l57.594"></a><span id="l57.594">   nsString  success;</span>
<a href="#l57.595"></a><span id="l57.595">   nsString  error;</span>
<a href="#l57.596"></a><span id="l57.596"> </span>
<a href="#l57.597"></a><span id="l57.597">   if (!m_doImport) {</span>
<a href="#l57.598"></a><span id="l57.598">     *_retval = true;</span>
<a href="#l57.599"></a><span id="l57.599">     nsImportStringBundle::GetStringByID(IMPORT_NO_ADDRBOOKS, m_stringBundle,</span>
<a href="#l57.600"></a><span id="l57.600">                                         success);</span>
<a href="#l57.601"></a><span id="l57.601" class="difflineminus">-    SetLogs( success, error, successLog, errorLog);</span>
<a href="#l57.602"></a><span id="l57.602" class="difflineminus">-    return( NS_OK);</span>
<a href="#l57.603"></a><span id="l57.603" class="difflineplus">+    SetLogs(success, error, successLog, errorLog);</span>
<a href="#l57.604"></a><span id="l57.604" class="difflineplus">+    return NS_OK;</span>
<a href="#l57.605"></a><span id="l57.605">   }</span>
<a href="#l57.606"></a><span id="l57.606"> </span>
<a href="#l57.607"></a><span id="l57.607">   if (!m_pInterface || !m_pBooks) {</span>
<a href="#l57.608"></a><span id="l57.608">     nsImportStringBundle::GetStringByID(IMPORT_ERROR_AB_NOTINITIALIZED,</span>
<a href="#l57.609"></a><span id="l57.609">                                         m_stringBundle, error);</span>
<a href="#l57.610"></a><span id="l57.610" class="difflineminus">-    SetLogs( success, error, successLog, errorLog);</span>
<a href="#l57.611"></a><span id="l57.611" class="difflineplus">+    SetLogs(success, error, successLog, errorLog);</span>
<a href="#l57.612"></a><span id="l57.612">     *_retval = false;</span>
<a href="#l57.613"></a><span id="l57.613" class="difflineminus">-    return( NS_OK);</span>
<a href="#l57.614"></a><span id="l57.614" class="difflineplus">+    return NS_OK;</span>
<a href="#l57.615"></a><span id="l57.615">   }</span>
<a href="#l57.616"></a><span id="l57.616"> </span>
<a href="#l57.617"></a><span id="l57.617">   bool needsFieldMap = false;</span>
<a href="#l57.618"></a><span id="l57.618"> </span>
<a href="#l57.619"></a><span id="l57.619">   if (NS_FAILED(m_pInterface-&gt;GetNeedsFieldMap(m_pLocation, &amp;needsFieldMap)) ||</span>
<a href="#l57.620"></a><span id="l57.620">       (needsFieldMap &amp;&amp; !m_pFieldMap)) {</span>
<a href="#l57.621"></a><span id="l57.621">     nsImportStringBundle::GetStringByID(IMPORT_ERROR_AB_NOTINITIALIZED,</span>
<a href="#l57.622"></a><span id="l57.622">                                         m_stringBundle, error);</span>
<a href="#l57.623"></a><span id="l57.623">     SetLogs(success, error, successLog, errorLog);</span>
<a href="#l57.624"></a><span id="l57.624">     *_retval = false;</span>
<a href="#l57.625"></a><span id="l57.625">     return NS_OK;</span>
<a href="#l57.626"></a><span id="l57.626">   }</span>
<a href="#l57.627"></a><span id="l57.627"> </span>
<a href="#l57.628"></a><span id="l57.628" class="difflineminus">-  NS_IF_RELEASE( m_pSuccessLog);</span>
<a href="#l57.629"></a><span id="l57.629" class="difflineminus">-  NS_IF_RELEASE( m_pErrorLog);</span>
<a href="#l57.630"></a><span id="l57.630" class="difflineplus">+  NS_IF_RELEASE(m_pSuccessLog);</span>
<a href="#l57.631"></a><span id="l57.631" class="difflineplus">+  NS_IF_RELEASE(m_pErrorLog);</span>
<a href="#l57.632"></a><span id="l57.632">   m_pSuccessLog = successLog;</span>
<a href="#l57.633"></a><span id="l57.633">   m_pErrorLog = errorLog;</span>
<a href="#l57.634"></a><span id="l57.634" class="difflineminus">-  NS_IF_ADDREF( m_pSuccessLog);</span>
<a href="#l57.635"></a><span id="l57.635" class="difflineminus">-  NS_IF_ADDREF( m_pErrorLog);</span>
<a href="#l57.636"></a><span id="l57.636" class="difflineplus">+  NS_IF_ADDREF(m_pSuccessLog);</span>
<a href="#l57.637"></a><span id="l57.637" class="difflineplus">+  NS_IF_ADDREF(m_pErrorLog);</span>
<a href="#l57.638"></a><span id="l57.638"> </span>
<a href="#l57.639"></a><span id="l57.639"> </span>
<a href="#l57.640"></a><span id="l57.640">   // create the info need to drive address book import. We're</span>
<a href="#l57.641"></a><span id="l57.641">   // not going to create a new thread for this since address books</span>
<a href="#l57.642"></a><span id="l57.642">   // don't tend to be large, and import is rare.</span>
<a href="#l57.643"></a><span id="l57.643">   m_pThreadData = new AddressThreadData();</span>
<a href="#l57.644"></a><span id="l57.644">   m_pThreadData-&gt;books = m_pBooks;</span>
<a href="#l57.645"></a><span id="l57.645" class="difflineminus">-  NS_ADDREF( m_pBooks);</span>
<a href="#l57.646"></a><span id="l57.646" class="difflineplus">+  NS_ADDREF(m_pBooks);</span>
<a href="#l57.647"></a><span id="l57.647">   m_pThreadData-&gt;addressImport = m_pInterface;</span>
<a href="#l57.648"></a><span id="l57.648" class="difflineminus">-  NS_ADDREF( m_pInterface);</span>
<a href="#l57.649"></a><span id="l57.649" class="difflineplus">+  NS_ADDREF(m_pInterface);</span>
<a href="#l57.650"></a><span id="l57.650">   m_pThreadData-&gt;fieldMap = m_pFieldMap;</span>
<a href="#l57.651"></a><span id="l57.651" class="difflineminus">-  NS_IF_ADDREF( m_pFieldMap);</span>
<a href="#l57.652"></a><span id="l57.652" class="difflineplus">+  NS_IF_ADDREF(m_pFieldMap);</span>
<a href="#l57.653"></a><span id="l57.653">   m_pThreadData-&gt;errorLog = m_pErrorLog;</span>
<a href="#l57.654"></a><span id="l57.654" class="difflineminus">-  NS_IF_ADDREF( m_pErrorLog);</span>
<a href="#l57.655"></a><span id="l57.655" class="difflineplus">+  NS_IF_ADDREF(m_pErrorLog);</span>
<a href="#l57.656"></a><span id="l57.656">   m_pThreadData-&gt;successLog = m_pSuccessLog;</span>
<a href="#l57.657"></a><span id="l57.657" class="difflineminus">-  NS_IF_ADDREF( m_pSuccessLog);</span>
<a href="#l57.658"></a><span id="l57.658" class="difflineplus">+  NS_IF_ADDREF(m_pSuccessLog);</span>
<a href="#l57.659"></a><span id="l57.659">   if (m_pDestinationUri)</span>
<a href="#l57.660"></a><span id="l57.660" class="difflineminus">-    m_pThreadData-&gt;pDestinationUri = strdup( m_pDestinationUri);</span>
<a href="#l57.661"></a><span id="l57.661" class="difflineplus">+    m_pThreadData-&gt;pDestinationUri = strdup(m_pDestinationUri);</span>
<a href="#l57.662"></a><span id="l57.662"> </span>
<a href="#l57.663"></a><span id="l57.663">   PRUint32 count = 0;</span>
<a href="#l57.664"></a><span id="l57.664">   m_pBooks-&gt;Count(&amp;count);</span>
<a href="#l57.665"></a><span id="l57.665">   // Create/obtain any address books that we need here, so that we don't need</span>
<a href="#l57.666"></a><span id="l57.666">   // to do so inside the import thread which would just proxy the create</span>
<a href="#l57.667"></a><span id="l57.667">   // operations back to the main thread anyway.</span>
<a href="#l57.668"></a><span id="l57.668">   nsCOMPtr&lt;nsIAddrDatabase&gt; db = GetAddressBookFromUri(m_pDestinationUri);</span>
<a href="#l57.669"></a><span id="l57.669">   for (PRUint32 i = 0; i &lt; count; ++i)</span>
<a href="#l57.670"></a><span id="l57.670" class="difflineat">@@ -714,51 +714,51 @@ NS_IMETHODIMP nsImportGenericAddressBook</span>
<a href="#l57.671"></a><span id="l57.671">   nsresult rv;</span>
<a href="#l57.672"></a><span id="l57.672">   m_pThreadData-&gt;ldifService = do_GetService(NS_ABLDIFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l57.673"></a><span id="l57.673"> </span>
<a href="#l57.674"></a><span id="l57.674">   ImportAddressThread(m_pThreadData);</span>
<a href="#l57.675"></a><span id="l57.675">   delete m_pThreadData;</span>
<a href="#l57.676"></a><span id="l57.676">   m_pThreadData = nsnull;</span>
<a href="#l57.677"></a><span id="l57.677">   *_retval = true;</span>
<a href="#l57.678"></a><span id="l57.678"> </span>
<a href="#l57.679"></a><span id="l57.679" class="difflineminus">-  return( NS_OK);</span>
<a href="#l57.680"></a><span id="l57.680" class="difflineplus">+  return NS_OK;</span>
<a href="#l57.681"></a><span id="l57.681"> }</span>
<a href="#l57.682"></a><span id="l57.682"> </span>
<a href="#l57.683"></a><span id="l57.683"> NS_IMETHODIMP nsImportGenericAddressBooks::ContinueImport(bool *_retval)</span>
<a href="#l57.684"></a><span id="l57.684"> {</span>
<a href="#l57.685"></a><span id="l57.685">     NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l57.686"></a><span id="l57.686">     if (!_retval)</span>
<a href="#l57.687"></a><span id="l57.687">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l57.688"></a><span id="l57.688"> </span>
<a href="#l57.689"></a><span id="l57.689">   *_retval = true;</span>
<a href="#l57.690"></a><span id="l57.690">   if (m_pThreadData) {</span>
<a href="#l57.691"></a><span id="l57.691">     if (m_pThreadData-&gt;fatalError)</span>
<a href="#l57.692"></a><span id="l57.692">       *_retval = false;</span>
<a href="#l57.693"></a><span id="l57.693">   }</span>
<a href="#l57.694"></a><span id="l57.694"> </span>
<a href="#l57.695"></a><span id="l57.695" class="difflineminus">-  return( NS_OK);</span>
<a href="#l57.696"></a><span id="l57.696" class="difflineplus">+  return NS_OK;</span>
<a href="#l57.697"></a><span id="l57.697"> }</span>
<a href="#l57.698"></a><span id="l57.698"> </span>
<a href="#l57.699"></a><span id="l57.699"> </span>
<a href="#l57.700"></a><span id="l57.700"> NS_IMETHODIMP nsImportGenericAddressBooks::GetProgress(PRInt32 *_retval)</span>
<a href="#l57.701"></a><span id="l57.701"> {</span>
<a href="#l57.702"></a><span id="l57.702">   // This returns the progress from the the currently</span>
<a href="#l57.703"></a><span id="l57.703">   // running import mail or import address book thread.</span>
<a href="#l57.704"></a><span id="l57.704">     NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l57.705"></a><span id="l57.705">     if (!_retval)</span>
<a href="#l57.706"></a><span id="l57.706">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l57.707"></a><span id="l57.707"> </span>
<a href="#l57.708"></a><span id="l57.708">   if (!m_pThreadData || !(m_pThreadData-&gt;threadAlive)) {</span>
<a href="#l57.709"></a><span id="l57.709">     *_retval = 100;</span>
<a href="#l57.710"></a><span id="l57.710" class="difflineminus">-    return( NS_OK);</span>
<a href="#l57.711"></a><span id="l57.711" class="difflineplus">+    return NS_OK;</span>
<a href="#l57.712"></a><span id="l57.712">   }</span>
<a href="#l57.713"></a><span id="l57.713"> </span>
<a href="#l57.714"></a><span id="l57.714">   PRUint32 sz = 0;</span>
<a href="#l57.715"></a><span id="l57.715">   if (m_pThreadData-&gt;currentSize &amp;&amp; m_pInterface) {</span>
<a href="#l57.716"></a><span id="l57.716" class="difflineminus">-    if (NS_FAILED( m_pInterface-&gt;GetImportProgress( &amp;sz)))</span>
<a href="#l57.717"></a><span id="l57.717" class="difflineplus">+    if (NS_FAILED(m_pInterface-&gt;GetImportProgress(&amp;sz)))</span>
<a href="#l57.718"></a><span id="l57.718">       sz = 0;</span>
<a href="#l57.719"></a><span id="l57.719">   }</span>
<a href="#l57.720"></a><span id="l57.720"> </span>
<a href="#l57.721"></a><span id="l57.721">   if (m_totalSize)</span>
<a href="#l57.722"></a><span id="l57.722">     *_retval = ((m_pThreadData-&gt;currentTotal + sz) * 100) / m_totalSize;</span>
<a href="#l57.723"></a><span id="l57.723">   else</span>
<a href="#l57.724"></a><span id="l57.724">     *_retval = 0;</span>
<a href="#l57.725"></a><span id="l57.725"> </span>
<a href="#l57.726"></a><span id="l57.726" class="difflineat">@@ -766,28 +766,28 @@ NS_IMETHODIMP nsImportGenericAddressBook</span>
<a href="#l57.727"></a><span id="l57.727">   if (*_retval &lt; 5)</span>
<a href="#l57.728"></a><span id="l57.728">     *_retval = 5;</span>
<a href="#l57.729"></a><span id="l57.729"> </span>
<a href="#l57.730"></a><span id="l57.730">   // as long as the thread is alive don't return completely</span>
<a href="#l57.731"></a><span id="l57.731">   // done.</span>
<a href="#l57.732"></a><span id="l57.732">   if (*_retval &gt; 99)</span>
<a href="#l57.733"></a><span id="l57.733">     *_retval = 99;</span>
<a href="#l57.734"></a><span id="l57.734"> </span>
<a href="#l57.735"></a><span id="l57.735" class="difflineminus">-  return( NS_OK);</span>
<a href="#l57.736"></a><span id="l57.736" class="difflineplus">+  return NS_OK;</span>
<a href="#l57.737"></a><span id="l57.737"> }</span>
<a href="#l57.738"></a><span id="l57.738"> </span>
<a href="#l57.739"></a><span id="l57.739"> </span>
<a href="#l57.740"></a><span id="l57.740"> NS_IMETHODIMP nsImportGenericAddressBooks::CancelImport(void)</span>
<a href="#l57.741"></a><span id="l57.741"> {</span>
<a href="#l57.742"></a><span id="l57.742">   if (m_pThreadData) {</span>
<a href="#l57.743"></a><span id="l57.743">     m_pThreadData-&gt;abort = true;</span>
<a href="#l57.744"></a><span id="l57.744">     m_pThreadData = nsnull;</span>
<a href="#l57.745"></a><span id="l57.745">   }</span>
<a href="#l57.746"></a><span id="l57.746"> </span>
<a href="#l57.747"></a><span id="l57.747" class="difflineminus">-  return( NS_OK);</span>
<a href="#l57.748"></a><span id="l57.748" class="difflineplus">+  return NS_OK;</span>
<a href="#l57.749"></a><span id="l57.749"> }</span>
<a href="#l57.750"></a><span id="l57.750"> </span>
<a href="#l57.751"></a><span id="l57.751"> </span>
<a href="#l57.752"></a><span id="l57.752"> AddressThreadData::AddressThreadData()</span>
<a href="#l57.753"></a><span id="l57.753"> {</span>
<a href="#l57.754"></a><span id="l57.754">   fatalError = false;</span>
<a href="#l57.755"></a><span id="l57.755">   driverAlive = true;</span>
<a href="#l57.756"></a><span id="l57.756">   threadAlive = true;</span>
<a href="#l57.757"></a><span id="l57.757" class="difflineat">@@ -819,47 +819,47 @@ AddressThreadData::~AddressThreadData()</span>
<a href="#l57.758"></a><span id="l57.758"> </span>
<a href="#l57.759"></a><span id="l57.759"> void nsImportGenericAddressBooks::ReportError(const PRUnichar *pName,</span>
<a href="#l57.760"></a><span id="l57.760">                                               nsString *pStream,</span>
<a href="#l57.761"></a><span id="l57.761">                                               nsIStringBundle* aBundle)</span>
<a href="#l57.762"></a><span id="l57.762"> {</span>
<a href="#l57.763"></a><span id="l57.763">   if (!pStream)</span>
<a href="#l57.764"></a><span id="l57.764">     return;</span>
<a href="#l57.765"></a><span id="l57.765">   // load the error string</span>
<a href="#l57.766"></a><span id="l57.766" class="difflineminus">-  PRUnichar *pFmt = nsImportStringBundle::GetStringByID( IMPORT_ERROR_GETABOOK, aBundle);</span>
<a href="#l57.767"></a><span id="l57.767" class="difflineminus">-  PRUnichar *pText = nsTextFormatter::smprintf( pFmt, pName);</span>
<a href="#l57.768"></a><span id="l57.768" class="difflineminus">-  pStream-&gt;Append( pText);</span>
<a href="#l57.769"></a><span id="l57.769" class="difflineminus">-  nsTextFormatter::smprintf_free( pText);</span>
<a href="#l57.770"></a><span id="l57.770" class="difflineplus">+  PRUnichar *pFmt = nsImportStringBundle::GetStringByID(IMPORT_ERROR_GETABOOK, aBundle);</span>
<a href="#l57.771"></a><span id="l57.771" class="difflineplus">+  PRUnichar *pText = nsTextFormatter::smprintf(pFmt, pName);</span>
<a href="#l57.772"></a><span id="l57.772" class="difflineplus">+  pStream-&gt;Append(pText);</span>
<a href="#l57.773"></a><span id="l57.773" class="difflineplus">+  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l57.774"></a><span id="l57.774">   NS_Free(pFmt);</span>
<a href="#l57.775"></a><span id="l57.775">   pStream-&gt;AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l57.776"></a><span id="l57.776"> }</span>
<a href="#l57.777"></a><span id="l57.777"> </span>
<a href="#l57.778"></a><span id="l57.778" class="difflineminus">-static void ImportAddressThread( void *stuff)</span>
<a href="#l57.779"></a><span id="l57.779" class="difflineplus">+static void ImportAddressThread(void *stuff)</span>
<a href="#l57.780"></a><span id="l57.780"> {</span>
<a href="#l57.781"></a><span id="l57.781" class="difflineminus">-  IMPORT_LOG0( &quot;In Begin ImportAddressThread\n&quot;);</span>
<a href="#l57.782"></a><span id="l57.782" class="difflineplus">+  IMPORT_LOG0(&quot;In Begin ImportAddressThread\n&quot;);</span>
<a href="#l57.783"></a><span id="l57.783"> </span>
<a href="#l57.784"></a><span id="l57.784">   AddressThreadData *pData = (AddressThreadData *)stuff;</span>
<a href="#l57.785"></a><span id="l57.785">   PRUint32  count = 0;</span>
<a href="#l57.786"></a><span id="l57.786" class="difflineminus">-  nsresult   rv = pData-&gt;books-&gt;Count( &amp;count);</span>
<a href="#l57.787"></a><span id="l57.787" class="difflineplus">+  nsresult   rv = pData-&gt;books-&gt;Count(&amp;count);</span>
<a href="#l57.788"></a><span id="l57.788">   PRUint32          i;</span>
<a href="#l57.789"></a><span id="l57.789">   bool              import;</span>
<a href="#l57.790"></a><span id="l57.790">   PRUint32          size;</span>
<a href="#l57.791"></a><span id="l57.791"> </span>
<a href="#l57.792"></a><span id="l57.792">   nsString          success;</span>
<a href="#l57.793"></a><span id="l57.793">   nsString          error;</span>
<a href="#l57.794"></a><span id="l57.794"> </span>
<a href="#l57.795"></a><span id="l57.795">   for (i = 0; (i &lt; count) &amp;&amp; !(pData-&gt;abort); i++) {</span>
<a href="#l57.796"></a><span id="l57.796">     nsCOMPtr&lt;nsIImportABDescriptor&gt; book =</span>
<a href="#l57.797"></a><span id="l57.797">       do_QueryElementAt(pData-&gt;books, i);</span>
<a href="#l57.798"></a><span id="l57.798">     if (book) {</span>
<a href="#l57.799"></a><span id="l57.799">       import = false;</span>
<a href="#l57.800"></a><span id="l57.800">       size = 0;</span>
<a href="#l57.801"></a><span id="l57.801" class="difflineminus">-      rv = book-&gt;GetImport( &amp;import);</span>
<a href="#l57.802"></a><span id="l57.802" class="difflineplus">+      rv = book-&gt;GetImport(&amp;import);</span>
<a href="#l57.803"></a><span id="l57.803">       if (import)</span>
<a href="#l57.804"></a><span id="l57.804" class="difflineminus">-        rv = book-&gt;GetSize( &amp;size);</span>
<a href="#l57.805"></a><span id="l57.805" class="difflineplus">+        rv = book-&gt;GetSize(&amp;size);</span>
<a href="#l57.806"></a><span id="l57.806"> </span>
<a href="#l57.807"></a><span id="l57.807">       if (size &amp;&amp; import) {</span>
<a href="#l57.808"></a><span id="l57.808">         nsString name;</span>
<a href="#l57.809"></a><span id="l57.809">         book-&gt;GetPreferredName(name);</span>
<a href="#l57.810"></a><span id="l57.810"> </span>
<a href="#l57.811"></a><span id="l57.811">         nsCOMPtr&lt;nsIAddrDatabase&gt; db = pData-&gt;dBs-&gt;ObjectAt(i);</span>
<a href="#l57.812"></a><span id="l57.812"> </span>
<a href="#l57.813"></a><span id="l57.813">         bool fatalError = false;</span>
<a href="#l57.814"></a><span id="l57.814" class="difflineat">@@ -868,40 +868,40 @@ static void ImportAddressThread( void *s</span>
<a href="#l57.815"></a><span id="l57.815">           PRUnichar *pSuccess = nsnull;</span>
<a href="#l57.816"></a><span id="l57.816">           PRUnichar *pError = nsnull;</span>
<a href="#l57.817"></a><span id="l57.817"> </span>
<a href="#l57.818"></a><span id="l57.818">           /*</span>
<a href="#l57.819"></a><span id="l57.819">           if (pData-&gt;fieldMap) {</span>
<a href="#l57.820"></a><span id="l57.820">             PRInt32    sz = 0;</span>
<a href="#l57.821"></a><span id="l57.821">             PRInt32    mapIndex;</span>
<a href="#l57.822"></a><span id="l57.822">             bool      active;</span>
<a href="#l57.823"></a><span id="l57.823" class="difflineminus">-            pData-&gt;fieldMap-&gt;GetMapSize( &amp;sz);</span>
<a href="#l57.824"></a><span id="l57.824" class="difflineminus">-            IMPORT_LOG1( &quot;**** Field Map Size: %d\n&quot;, (int) sz);</span>
<a href="#l57.825"></a><span id="l57.825" class="difflineplus">+            pData-&gt;fieldMap-&gt;GetMapSize(&amp;sz);</span>
<a href="#l57.826"></a><span id="l57.826" class="difflineplus">+            IMPORT_LOG1(&quot;**** Field Map Size: %d\n&quot;, (int) sz);</span>
<a href="#l57.827"></a><span id="l57.827">             for (PRInt32 i = 0; i &lt; sz; i++) {</span>
<a href="#l57.828"></a><span id="l57.828" class="difflineminus">-              pData-&gt;fieldMap-&gt;GetFieldMap( i, &amp;mapIndex);</span>
<a href="#l57.829"></a><span id="l57.829" class="difflineminus">-              pData-&gt;fieldMap-&gt;GetFieldActive( i, &amp;active);</span>
<a href="#l57.830"></a><span id="l57.830" class="difflineminus">-              IMPORT_LOG3( &quot;Field map #%d: index=%d, active=%d\n&quot;, (int) i, (int) mapIndex, (int) active);</span>
<a href="#l57.831"></a><span id="l57.831" class="difflineplus">+              pData-&gt;fieldMap-&gt;GetFieldMap(i, &amp;mapIndex);</span>
<a href="#l57.832"></a><span id="l57.832" class="difflineplus">+              pData-&gt;fieldMap-&gt;GetFieldActive(i, &amp;active);</span>
<a href="#l57.833"></a><span id="l57.833" class="difflineplus">+              IMPORT_LOG3(&quot;Field map #%d: index=%d, active=%d\n&quot;, (int) i, (int) mapIndex, (int) active);</span>
<a href="#l57.834"></a><span id="l57.834">             }</span>
<a href="#l57.835"></a><span id="l57.835">           }</span>
<a href="#l57.836"></a><span id="l57.836">           */</span>
<a href="#l57.837"></a><span id="l57.837"> </span>
<a href="#l57.838"></a><span id="l57.838">           rv = pData-&gt;addressImport-&gt;ImportAddressBook(book,</span>
<a href="#l57.839"></a><span id="l57.839">                                                        db,</span>
<a href="#l57.840"></a><span id="l57.840">                                                        pData-&gt;fieldMap,</span>
<a href="#l57.841"></a><span id="l57.841">                                                        pData-&gt;ldifService,</span>
<a href="#l57.842"></a><span id="l57.842">                                                        &amp;pError,</span>
<a href="#l57.843"></a><span id="l57.843">                                                        &amp;pSuccess,</span>
<a href="#l57.844"></a><span id="l57.844">                                                        &amp;fatalError);</span>
<a href="#l57.845"></a><span id="l57.845">           if (pSuccess) {</span>
<a href="#l57.846"></a><span id="l57.846" class="difflineminus">-            success.Append( pSuccess);</span>
<a href="#l57.847"></a><span id="l57.847" class="difflineminus">-            NS_Free( pSuccess);</span>
<a href="#l57.848"></a><span id="l57.848" class="difflineplus">+            success.Append(pSuccess);</span>
<a href="#l57.849"></a><span id="l57.849" class="difflineplus">+            NS_Free(pSuccess);</span>
<a href="#l57.850"></a><span id="l57.850">           }</span>
<a href="#l57.851"></a><span id="l57.851">           if (pError) {</span>
<a href="#l57.852"></a><span id="l57.852" class="difflineminus">-            error.Append( pError);</span>
<a href="#l57.853"></a><span id="l57.853" class="difflineminus">-            NS_Free( pError);</span>
<a href="#l57.854"></a><span id="l57.854" class="difflineplus">+            error.Append(pError);</span>
<a href="#l57.855"></a><span id="l57.855" class="difflineplus">+            NS_Free(pError);</span>
<a href="#l57.856"></a><span id="l57.856">           }</span>
<a href="#l57.857"></a><span id="l57.857">         }</span>
<a href="#l57.858"></a><span id="l57.858">         else {</span>
<a href="#l57.859"></a><span id="l57.859">           nsImportGenericAddressBooks::ReportError(name.get(), &amp;error, pData-&gt;stringBundle);</span>
<a href="#l57.860"></a><span id="l57.860">         }</span>
<a href="#l57.861"></a><span id="l57.861"> </span>
<a href="#l57.862"></a><span id="l57.862">         pData-&gt;currentSize = 0;</span>
<a href="#l57.863"></a><span id="l57.863">         pData-&gt;currentTotal += size;</span>
<a href="#l57.864"></a><span id="l57.864" class="difflineat">@@ -913,17 +913,17 @@ static void ImportAddressThread( void *s</span>
<a href="#l57.865"></a><span id="l57.865">           pData-&gt;fatalError = true;</span>
<a href="#l57.866"></a><span id="l57.866">           break;</span>
<a href="#l57.867"></a><span id="l57.867">         }</span>
<a href="#l57.868"></a><span id="l57.868">       }</span>
<a href="#l57.869"></a><span id="l57.869">     }</span>
<a href="#l57.870"></a><span id="l57.870">   }</span>
<a href="#l57.871"></a><span id="l57.871"> </span>
<a href="#l57.872"></a><span id="l57.872"> </span>
<a href="#l57.873"></a><span id="l57.873" class="difflineminus">-  nsImportGenericAddressBooks::SetLogs( success, error, pData-&gt;successLog, pData-&gt;errorLog);</span>
<a href="#l57.874"></a><span id="l57.874" class="difflineplus">+  nsImportGenericAddressBooks::SetLogs(success, error, pData-&gt;successLog, pData-&gt;errorLog);</span>
<a href="#l57.875"></a><span id="l57.875"> </span>
<a href="#l57.876"></a><span id="l57.876">   if (pData-&gt;abort || pData-&gt;fatalError) {</span>
<a href="#l57.877"></a><span id="l57.877">     // FIXME: do what is necessary to get rid of what has been imported so far.</span>
<a href="#l57.878"></a><span id="l57.878">     // Nothing if we went into an existing address book!  Otherwise, delete</span>
<a href="#l57.879"></a><span id="l57.879">     // the ones we created?</span>
<a href="#l57.880"></a><span id="l57.880">   }</span>
<a href="#l57.881"></a><span id="l57.881"> </span>
<a href="#l57.882"></a><span id="l57.882"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mailnews/import/src/nsImportEncodeScan.cpp</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mailnews/import/src/nsImportEncodeScan.cpp</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -43,364 +43,364 @@</span>
<a href="#l58.4"></a><span id="l58.4"> #define  kBeginDataFork      1</span>
<a href="#l58.5"></a><span id="l58.5"> #define  kBeginResourceFork    2</span>
<a href="#l58.6"></a><span id="l58.6"> #define  kAddEntries        3</span>
<a href="#l58.7"></a><span id="l58.7"> #define  kScanningDataFork    4</span>
<a href="#l58.8"></a><span id="l58.8"> #define  kScanningRsrcFork    5</span>
<a href="#l58.9"></a><span id="l58.9"> #define  kDoneWithFile      6</span>
<a href="#l58.10"></a><span id="l58.10"> </span>
<a href="#l58.11"></a><span id="l58.11"> PRUint32  gAppleSingleHeader[6] = {0x00051600, 0x00020000, 0, 0, 0, 0};</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-#define kAppleSingleHeaderSize  (6 * sizeof( PRUint32))</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineplus">+#define kAppleSingleHeaderSize  (6 * sizeof(PRUint32))</span>
<a href="#l58.14"></a><span id="l58.14"> </span>
<a href="#l58.15"></a><span id="l58.15"> #ifdef _MAC_IMPORT_CODE</span>
<a href="#l58.16"></a><span id="l58.16"> #include &quot;MoreFilesExtras.h&quot;</span>
<a href="#l58.17"></a><span id="l58.17"> #include &quot;MoreDesktopMgr.h&quot;</span>
<a href="#l58.18"></a><span id="l58.18"> </span>
<a href="#l58.19"></a><span id="l58.19"> CInfoPBRec  gCatInfoPB;</span>
<a href="#l58.20"></a><span id="l58.20"> U32      g2000Secs = 0;</span>
<a href="#l58.21"></a><span id="l58.21"> long    gGMTDelta = 0;</span>
<a href="#l58.22"></a><span id="l58.22"> </span>
<a href="#l58.23"></a><span id="l58.23" class="difflineminus">-long GetGmtDelta( void);</span>
<a href="#l58.24"></a><span id="l58.24" class="difflineminus">-U32 Get2000Secs( void);</span>
<a href="#l58.25"></a><span id="l58.25" class="difflineplus">+long GetGmtDelta(void);</span>
<a href="#l58.26"></a><span id="l58.26" class="difflineplus">+U32 Get2000Secs(void);</span>
<a href="#l58.27"></a><span id="l58.27"> </span>
<a href="#l58.28"></a><span id="l58.28"> </span>
<a href="#l58.29"></a><span id="l58.29" class="difflineminus">-long GetGmtDelta( void)</span>
<a href="#l58.30"></a><span id="l58.30" class="difflineplus">+long GetGmtDelta(void)</span>
<a href="#l58.31"></a><span id="l58.31"> {</span>
<a href="#l58.32"></a><span id="l58.32">   MachineLocation myLocation;</span>
<a href="#l58.33"></a><span id="l58.33" class="difflineminus">-  ReadLocation( &amp;myLocation);</span>
<a href="#l58.34"></a><span id="l58.34" class="difflineminus">-  long  myDelta = BitAnd( myLocation.u.gmtDelta, 0x00FFFFFF);</span>
<a href="#l58.35"></a><span id="l58.35" class="difflineminus">-  if (BitTst( &amp;myDelta, 23))</span>
<a href="#l58.36"></a><span id="l58.36" class="difflineminus">-    myDelta = BitOr( myDelta, 0xFF000000);</span>
<a href="#l58.37"></a><span id="l58.37" class="difflineminus">-  return( myDelta);</span>
<a href="#l58.38"></a><span id="l58.38" class="difflineplus">+  ReadLocation(&amp;myLocation);</span>
<a href="#l58.39"></a><span id="l58.39" class="difflineplus">+  long  myDelta = BitAnd(myLocation.u.gmtDelta, 0x00FFFFFF);</span>
<a href="#l58.40"></a><span id="l58.40" class="difflineplus">+  if (BitTst(&amp;myDelta, 23))</span>
<a href="#l58.41"></a><span id="l58.41" class="difflineplus">+    myDelta = BitOr(myDelta, 0xFF000000);</span>
<a href="#l58.42"></a><span id="l58.42" class="difflineplus">+  return myDelta;</span>
<a href="#l58.43"></a><span id="l58.43"> }</span>
<a href="#l58.44"></a><span id="l58.44"> </span>
<a href="#l58.45"></a><span id="l58.45" class="difflineminus">-U32 Get2000Secs( void)</span>
<a href="#l58.46"></a><span id="l58.46" class="difflineplus">+U32 Get2000Secs(void)</span>
<a href="#l58.47"></a><span id="l58.47"> {</span>
<a href="#l58.48"></a><span id="l58.48">   DateTimeRec  dr;</span>
<a href="#l58.49"></a><span id="l58.49">   dr.year = 2000;</span>
<a href="#l58.50"></a><span id="l58.50">   dr.month = 1;</span>
<a href="#l58.51"></a><span id="l58.51">   dr.day = 1;</span>
<a href="#l58.52"></a><span id="l58.52">   dr.hour = 0;</span>
<a href="#l58.53"></a><span id="l58.53">   dr.minute = 0;</span>
<a href="#l58.54"></a><span id="l58.54">   dr.second = 0;</span>
<a href="#l58.55"></a><span id="l58.55">   dr.dayOfWeek = 0;</span>
<a href="#l58.56"></a><span id="l58.56">   U32  result;</span>
<a href="#l58.57"></a><span id="l58.57" class="difflineminus">-  DateToSeconds( &amp;dr, &amp;result);</span>
<a href="#l58.58"></a><span id="l58.58" class="difflineminus">-  return( result);</span>
<a href="#l58.59"></a><span id="l58.59" class="difflineplus">+  DateToSeconds(&amp;dr, &amp;result);</span>
<a href="#l58.60"></a><span id="l58.60" class="difflineplus">+  return result;</span>
<a href="#l58.61"></a><span id="l58.61"> }</span>
<a href="#l58.62"></a><span id="l58.62"> #endif</span>
<a href="#l58.63"></a><span id="l58.63"> </span>
<a href="#l58.64"></a><span id="l58.64"> nsImportEncodeScan::nsImportEncodeScan()</span>
<a href="#l58.65"></a><span id="l58.65"> {</span>
<a href="#l58.66"></a><span id="l58.66">   m_isAppleSingle = false;</span>
<a href="#l58.67"></a><span id="l58.67">   m_encodeScanState = 0;</span>
<a href="#l58.68"></a><span id="l58.68">   m_resourceForkSize = 0;</span>
<a href="#l58.69"></a><span id="l58.69">   m_dataForkSize = 0;</span>
<a href="#l58.70"></a><span id="l58.70"> }</span>
<a href="#l58.71"></a><span id="l58.71"> </span>
<a href="#l58.72"></a><span id="l58.72"> nsImportEncodeScan::~nsImportEncodeScan()</span>
<a href="#l58.73"></a><span id="l58.73"> {</span>
<a href="#l58.74"></a><span id="l58.74"> }</span>
<a href="#l58.75"></a><span id="l58.75"> </span>
<a href="#l58.76"></a><span id="l58.76" class="difflineminus">-bool nsImportEncodeScan::InitEncodeScan( bool appleSingleEncode, nsIFile *fileLoc, const char *pName, PRUint8 * pBuf, PRUint32 sz)</span>
<a href="#l58.77"></a><span id="l58.77" class="difflineplus">+bool nsImportEncodeScan::InitEncodeScan(bool appleSingleEncode, nsIFile *fileLoc, const char *pName, PRUint8 * pBuf, PRUint32 sz)</span>
<a href="#l58.78"></a><span id="l58.78"> {</span>
<a href="#l58.79"></a><span id="l58.79">   CleanUpEncodeScan();</span>
<a href="#l58.80"></a><span id="l58.80">   m_isAppleSingle = appleSingleEncode;</span>
<a href="#l58.81"></a><span id="l58.81">   m_encodeScanState = kBeginAppleSingle;</span>
<a href="#l58.82"></a><span id="l58.82">   m_pInputFile = do_QueryInterface(fileLoc);</span>
<a href="#l58.83"></a><span id="l58.83">   m_useFileName = pName;</span>
<a href="#l58.84"></a><span id="l58.84">   m_pBuf = pBuf;</span>
<a href="#l58.85"></a><span id="l58.85">   m_bufSz = sz;</span>
<a href="#l58.86"></a><span id="l58.86">   if (!m_isAppleSingle)</span>
<a href="#l58.87"></a><span id="l58.87">         {</span>
<a href="#l58.88"></a><span id="l58.88">     if (!m_inputStream)</span>
<a href="#l58.89"></a><span id="l58.89">                 {</span>
<a href="#l58.90"></a><span id="l58.90">                   nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(m_inputStream), m_pInputFile);</span>
<a href="#l58.91"></a><span id="l58.91">                   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l58.92"></a><span id="l58.92">     }</span>
<a href="#l58.93"></a><span id="l58.93"> </span>
<a href="#l58.94"></a><span id="l58.94" class="difflineminus">-    InitScan( m_inputStream, pBuf, sz);</span>
<a href="#l58.95"></a><span id="l58.95" class="difflineplus">+    InitScan(m_inputStream, pBuf, sz);</span>
<a href="#l58.96"></a><span id="l58.96">   }</span>
<a href="#l58.97"></a><span id="l58.97">   else {</span>
<a href="#l58.98"></a><span id="l58.98">   #ifdef _MAC_IMPORT_CODE</span>
<a href="#l58.99"></a><span id="l58.99">     // Fill in the file sizes</span>
<a href="#l58.100"></a><span id="l58.100" class="difflineminus">-    m_resourceForkSize = fileLoc.GetMacFileSize( UFileLocation::eResourceFork);</span>
<a href="#l58.101"></a><span id="l58.101" class="difflineminus">-    m_dataForkSize = fileLoc.GetMacFileSize( UFileLocation::eDataFork);</span>
<a href="#l58.102"></a><span id="l58.102" class="difflineplus">+    m_resourceForkSize = fileLoc.GetMacFileSize(UFileLocation::eResourceFork);</span>
<a href="#l58.103"></a><span id="l58.103" class="difflineplus">+    m_dataForkSize = fileLoc.GetMacFileSize(UFileLocation::eDataFork);</span>
<a href="#l58.104"></a><span id="l58.104">   #endif</span>
<a href="#l58.105"></a><span id="l58.105">   }</span>
<a href="#l58.106"></a><span id="l58.106"> </span>
<a href="#l58.107"></a><span id="l58.107" class="difflineminus">-  return( true);</span>
<a href="#l58.108"></a><span id="l58.108" class="difflineplus">+  return true;</span>
<a href="#l58.109"></a><span id="l58.109"> }</span>
<a href="#l58.110"></a><span id="l58.110"> </span>
<a href="#l58.111"></a><span id="l58.111" class="difflineminus">-void nsImportEncodeScan::CleanUpEncodeScan( void)</span>
<a href="#l58.112"></a><span id="l58.112" class="difflineplus">+void nsImportEncodeScan::CleanUpEncodeScan(void)</span>
<a href="#l58.113"></a><span id="l58.113"> {</span>
<a href="#l58.114"></a><span id="l58.114">   m_pInputStream-&gt;Close();</span>
<a href="#l58.115"></a><span id="l58.115">   m_pInputStream = nsnull;</span>
<a href="#l58.116"></a><span id="l58.116">   m_pInputFile = nsnull;</span>
<a href="#l58.117"></a><span id="l58.117"> }</span>
<a href="#l58.118"></a><span id="l58.118"> </span>
<a href="#l58.119"></a><span id="l58.119"> </span>
<a href="#l58.120"></a><span id="l58.120"> // 26 + 12 per entry</span>
<a href="#l58.121"></a><span id="l58.121"> </span>
<a href="#l58.122"></a><span id="l58.122" class="difflineminus">-void nsImportEncodeScan::FillInEntries( int numEntries)</span>
<a href="#l58.123"></a><span id="l58.123" class="difflineplus">+void nsImportEncodeScan::FillInEntries(int numEntries)</span>
<a href="#l58.124"></a><span id="l58.124"> {</span>
<a href="#l58.125"></a><span id="l58.125"> #ifdef _MAC_IMPORT_CODE</span>
<a href="#l58.126"></a><span id="l58.126">   int    len = m_useFileName.GetLength();</span>
<a href="#l58.127"></a><span id="l58.127">   if (len &lt; 32)</span>
<a href="#l58.128"></a><span id="l58.128">     len = 32;</span>
<a href="#l58.129"></a><span id="l58.129">   long  entry[3];</span>
<a href="#l58.130"></a><span id="l58.130">   long  fileOffset = 26 + (12 * numEntries);</span>
<a href="#l58.131"></a><span id="l58.131">   entry[0] = 3;</span>
<a href="#l58.132"></a><span id="l58.132">   entry[1] = fileOffset;</span>
<a href="#l58.133"></a><span id="l58.133">   entry[2] = m_useFileName.GetLength();</span>
<a href="#l58.134"></a><span id="l58.134">   fileOffset += len;</span>
<a href="#l58.135"></a><span id="l58.135" class="difflineminus">-  MemCpy( m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l58.136"></a><span id="l58.136" class="difflineplus">+  MemCpy(m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l58.137"></a><span id="l58.137">   m_bytesInBuf += 12;</span>
<a href="#l58.138"></a><span id="l58.138"> </span>
<a href="#l58.139"></a><span id="l58.139"> </span>
<a href="#l58.140"></a><span id="l58.140">   Str255  comment;</span>
<a href="#l58.141"></a><span id="l58.141">   comment[0] = 0;</span>
<a href="#l58.142"></a><span id="l58.142" class="difflineminus">-  OSErr err = FSpDTGetComment( m_inputFileLoc, comment);</span>
<a href="#l58.143"></a><span id="l58.143" class="difflineplus">+  OSErr err = FSpDTGetComment(m_inputFileLoc, comment);</span>
<a href="#l58.144"></a><span id="l58.144">   if (comment[0] &gt; 200)</span>
<a href="#l58.145"></a><span id="l58.145">     comment[0] = 200;</span>
<a href="#l58.146"></a><span id="l58.146">   entry[0] = 4;</span>
<a href="#l58.147"></a><span id="l58.147">   entry[1] = fileOffset;</span>
<a href="#l58.148"></a><span id="l58.148">   entry[2] = comment[0];</span>
<a href="#l58.149"></a><span id="l58.149">   fileOffset += 200;</span>
<a href="#l58.150"></a><span id="l58.150" class="difflineminus">-  MemCpy( m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l58.151"></a><span id="l58.151" class="difflineplus">+  MemCpy(m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l58.152"></a><span id="l58.152">   m_bytesInBuf += 12;</span>
<a href="#l58.153"></a><span id="l58.153"> </span>
<a href="#l58.154"></a><span id="l58.154"> </span>
<a href="#l58.155"></a><span id="l58.155">   entry[0] = 8;</span>
<a href="#l58.156"></a><span id="l58.156">   entry[1] = fileOffset;</span>
<a href="#l58.157"></a><span id="l58.157">   entry[2] = 16;</span>
<a href="#l58.158"></a><span id="l58.158">   fileOffset += 16;</span>
<a href="#l58.159"></a><span id="l58.159" class="difflineminus">-  MemCpy( m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l58.160"></a><span id="l58.160" class="difflineplus">+  MemCpy(m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l58.161"></a><span id="l58.161">   m_bytesInBuf += 12;</span>
<a href="#l58.162"></a><span id="l58.162"> </span>
<a href="#l58.163"></a><span id="l58.163">   entry[0] = 9;</span>
<a href="#l58.164"></a><span id="l58.164">   entry[1] = fileOffset;</span>
<a href="#l58.165"></a><span id="l58.165">   entry[2] = 32;</span>
<a href="#l58.166"></a><span id="l58.166">   fileOffset += 32;</span>
<a href="#l58.167"></a><span id="l58.167" class="difflineminus">-  MemCpy( m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l58.168"></a><span id="l58.168" class="difflineplus">+  MemCpy(m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l58.169"></a><span id="l58.169">   m_bytesInBuf += 12;</span>
<a href="#l58.170"></a><span id="l58.170"> </span>
<a href="#l58.171"></a><span id="l58.171"> </span>
<a href="#l58.172"></a><span id="l58.172">   entry[0] = 10;</span>
<a href="#l58.173"></a><span id="l58.173">   entry[1] = fileOffset;</span>
<a href="#l58.174"></a><span id="l58.174">   entry[2] = 4;</span>
<a href="#l58.175"></a><span id="l58.175">   fileOffset += 4;</span>
<a href="#l58.176"></a><span id="l58.176" class="difflineminus">-  MemCpy( m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l58.177"></a><span id="l58.177" class="difflineplus">+  MemCpy(m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l58.178"></a><span id="l58.178">   m_bytesInBuf += 12;</span>
<a href="#l58.179"></a><span id="l58.179"> </span>
<a href="#l58.180"></a><span id="l58.180">   if (m_resourceForkSize) {</span>
<a href="#l58.181"></a><span id="l58.181">     entry[0] = 2;</span>
<a href="#l58.182"></a><span id="l58.182">     entry[1] = fileOffset;</span>
<a href="#l58.183"></a><span id="l58.183">     entry[2] = m_resourceForkSize;</span>
<a href="#l58.184"></a><span id="l58.184">     fileOffset += m_resourceForkSize;</span>
<a href="#l58.185"></a><span id="l58.185" class="difflineminus">-    MemCpy( m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l58.186"></a><span id="l58.186" class="difflineplus">+    MemCpy(m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l58.187"></a><span id="l58.187">     m_bytesInBuf += 12;</span>
<a href="#l58.188"></a><span id="l58.188">   }</span>
<a href="#l58.189"></a><span id="l58.189"> </span>
<a href="#l58.190"></a><span id="l58.190">   if (m_dataForkSize) {</span>
<a href="#l58.191"></a><span id="l58.191">     entry[0] = 1;</span>
<a href="#l58.192"></a><span id="l58.192">     entry[1] = fileOffset;</span>
<a href="#l58.193"></a><span id="l58.193">     entry[2] = m_dataForkSize;</span>
<a href="#l58.194"></a><span id="l58.194">     fileOffset += m_dataForkSize;</span>
<a href="#l58.195"></a><span id="l58.195" class="difflineminus">-    MemCpy( m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l58.196"></a><span id="l58.196" class="difflineplus">+    MemCpy(m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l58.197"></a><span id="l58.197">     m_bytesInBuf += 12;</span>
<a href="#l58.198"></a><span id="l58.198">   }</span>
<a href="#l58.199"></a><span id="l58.199"> </span>
<a href="#l58.200"></a><span id="l58.200"> #endif</span>
<a href="#l58.201"></a><span id="l58.201"> }</span>
<a href="#l58.202"></a><span id="l58.202"> </span>
<a href="#l58.203"></a><span id="l58.203" class="difflineminus">-bool nsImportEncodeScan::AddEntries( void)</span>
<a href="#l58.204"></a><span id="l58.204" class="difflineplus">+bool nsImportEncodeScan::AddEntries(void)</span>
<a href="#l58.205"></a><span id="l58.205"> {</span>
<a href="#l58.206"></a><span id="l58.206"> #ifdef _MAC_IMPORT_CODE</span>
<a href="#l58.207"></a><span id="l58.207">   if (!g2000Secs) {</span>
<a href="#l58.208"></a><span id="l58.208">     g2000Secs = Get2000Secs();</span>
<a href="#l58.209"></a><span id="l58.209">     gGMTDelta = GetGmtDelta();</span>
<a href="#l58.210"></a><span id="l58.210">   }</span>
<a href="#l58.211"></a><span id="l58.211" class="difflineminus">-  MemCpy( m_pBuf + m_bytesInBuf, (PC_S8) m_useFileName, m_useFileName.GetLength());</span>
<a href="#l58.212"></a><span id="l58.212" class="difflineplus">+  MemCpy(m_pBuf + m_bytesInBuf, (PC_S8) m_useFileName, m_useFileName.GetLength());</span>
<a href="#l58.213"></a><span id="l58.213">   m_bytesInBuf += m_useFileName.GetLength();</span>
<a href="#l58.214"></a><span id="l58.214">   if (m_useFileName.GetLength() &lt; 32) {</span>
<a href="#l58.215"></a><span id="l58.215">     int len = m_useFileName.GetLength();</span>
<a href="#l58.216"></a><span id="l58.216">     while (len &lt; 32) {</span>
<a href="#l58.217"></a><span id="l58.217">       *((P_S8)m_pBuf + m_bytesInBuf) = 0;</span>
<a href="#l58.218"></a><span id="l58.218">       m_bytesInBuf++;</span>
<a href="#l58.219"></a><span id="l58.219">       len++;</span>
<a href="#l58.220"></a><span id="l58.220">     }</span>
<a href="#l58.221"></a><span id="l58.221">   }</span>
<a href="#l58.222"></a><span id="l58.222"> </span>
<a href="#l58.223"></a><span id="l58.223">   Str255  comment;</span>
<a href="#l58.224"></a><span id="l58.224">   comment[0] = 0;</span>
<a href="#l58.225"></a><span id="l58.225" class="difflineminus">-  OSErr err = FSpDTGetComment( m_inputFileLoc, comment);</span>
<a href="#l58.226"></a><span id="l58.226" class="difflineplus">+  OSErr err = FSpDTGetComment(m_inputFileLoc, comment);</span>
<a href="#l58.227"></a><span id="l58.227">   comment[0] = 200;</span>
<a href="#l58.228"></a><span id="l58.228" class="difflineminus">-  MemCpy( m_pBuf + m_bytesInBuf, &amp;(comment[1]), comment[0]);</span>
<a href="#l58.229"></a><span id="l58.229" class="difflineplus">+  MemCpy(m_pBuf + m_bytesInBuf, &amp;(comment[1]), comment[0]);</span>
<a href="#l58.230"></a><span id="l58.230">   m_bytesInBuf += comment[0];</span>
<a href="#l58.231"></a><span id="l58.231"> </span>
<a href="#l58.232"></a><span id="l58.232">   long  dates[4];</span>
<a href="#l58.233"></a><span id="l58.233">   dates[0] = gCatInfoPB.hFileInfo.ioFlCrDat;</span>
<a href="#l58.234"></a><span id="l58.234">   dates[1] = gCatInfoPB.hFileInfo.ioFlMdDat;</span>
<a href="#l58.235"></a><span id="l58.235">   dates[2] = gCatInfoPB.hFileInfo.ioFlBkDat;</span>
<a href="#l58.236"></a><span id="l58.236">   dates[3] = 0x80000000;</span>
<a href="#l58.237"></a><span id="l58.237">   for (short i = 0; i &lt; 3; i++) {</span>
<a href="#l58.238"></a><span id="l58.238">     dates[i] -= g2000Secs;</span>
<a href="#l58.239"></a><span id="l58.239">     dates[i] += gGMTDelta;</span>
<a href="#l58.240"></a><span id="l58.240">   }</span>
<a href="#l58.241"></a><span id="l58.241" class="difflineminus">-  MemCpy( m_pBuf + m_bytesInBuf, dates, 16);</span>
<a href="#l58.242"></a><span id="l58.242" class="difflineplus">+  MemCpy(m_pBuf + m_bytesInBuf, dates, 16);</span>
<a href="#l58.243"></a><span id="l58.243">   m_bytesInBuf += 16;</span>
<a href="#l58.244"></a><span id="l58.244"> </span>
<a href="#l58.245"></a><span id="l58.245"> </span>
<a href="#l58.246"></a><span id="l58.246">   FInfo  fInfo = gCatInfoPB.hFileInfo.ioFlFndrInfo;</span>
<a href="#l58.247"></a><span id="l58.247">   FXInfo  fxInfo = gCatInfoPB.hFileInfo.ioFlXFndrInfo;</span>
<a href="#l58.248"></a><span id="l58.248">   fInfo.fdFlags = 0;</span>
<a href="#l58.249"></a><span id="l58.249">   fInfo.fdLocation.h = 0;</span>
<a href="#l58.250"></a><span id="l58.250">   fInfo.fdLocation.v = 0;</span>
<a href="#l58.251"></a><span id="l58.251">   fInfo.fdFldr = 0;</span>
<a href="#l58.252"></a><span id="l58.252" class="difflineminus">-  MemSet( &amp;fxInfo, 0, sizeof( fxInfo));</span>
<a href="#l58.253"></a><span id="l58.253" class="difflineminus">-  MemCpy( m_pBuf + m_bytesInBuf, &amp;fInfo, 16);</span>
<a href="#l58.254"></a><span id="l58.254" class="difflineplus">+  MemSet(&amp;fxInfo, 0, sizeof(fxInfo));</span>
<a href="#l58.255"></a><span id="l58.255" class="difflineplus">+  MemCpy(m_pBuf + m_bytesInBuf, &amp;fInfo, 16);</span>
<a href="#l58.256"></a><span id="l58.256">   m_bytesInBuf += 16;</span>
<a href="#l58.257"></a><span id="l58.257" class="difflineminus">-  MemCpy( m_pBuf + m_bytesInBuf, &amp;fxInfo, 16);</span>
<a href="#l58.258"></a><span id="l58.258" class="difflineplus">+  MemCpy(m_pBuf + m_bytesInBuf, &amp;fxInfo, 16);</span>
<a href="#l58.259"></a><span id="l58.259">   m_bytesInBuf += 16;</span>
<a href="#l58.260"></a><span id="l58.260"> </span>
<a href="#l58.261"></a><span id="l58.261"> </span>
<a href="#l58.262"></a><span id="l58.262">   dates[0] = 0;</span>
<a href="#l58.263"></a><span id="l58.263">   if ((gCatInfoPB.hFileInfo.ioFlAttrib &amp; 1) != 0)</span>
<a href="#l58.264"></a><span id="l58.264">     dates[0] |= 1;</span>
<a href="#l58.265"></a><span id="l58.265" class="difflineminus">-  MemCpy( m_pBuf + m_bytesInBuf, dates, 4);</span>
<a href="#l58.266"></a><span id="l58.266" class="difflineplus">+  MemCpy(m_pBuf + m_bytesInBuf, dates, 4);</span>
<a href="#l58.267"></a><span id="l58.267">   m_bytesInBuf += 4;</span>
<a href="#l58.268"></a><span id="l58.268"> </span>
<a href="#l58.269"></a><span id="l58.269"> </span>
<a href="#l58.270"></a><span id="l58.270"> #endif</span>
<a href="#l58.271"></a><span id="l58.271" class="difflineminus">-  return( true);</span>
<a href="#l58.272"></a><span id="l58.272" class="difflineplus">+  return true;</span>
<a href="#l58.273"></a><span id="l58.273"> }</span>
<a href="#l58.274"></a><span id="l58.274"> </span>
<a href="#l58.275"></a><span id="l58.275" class="difflineminus">-bool nsImportEncodeScan::Scan( bool *pDone)</span>
<a href="#l58.276"></a><span id="l58.276" class="difflineplus">+bool nsImportEncodeScan::Scan(bool *pDone)</span>
<a href="#l58.277"></a><span id="l58.277"> {</span>
<a href="#l58.278"></a><span id="l58.278">   nsresult  rv;</span>
<a href="#l58.279"></a><span id="l58.279"> </span>
<a href="#l58.280"></a><span id="l58.280">   *pDone = false;</span>
<a href="#l58.281"></a><span id="l58.281">   if (m_isAppleSingle) {</span>
<a href="#l58.282"></a><span id="l58.282">     // Stuff the buffer with things needed to encode the file...</span>
<a href="#l58.283"></a><span id="l58.283">     // then just allow UScanFile to handle each fork, but be careful</span>
<a href="#l58.284"></a><span id="l58.284">     // when handling eof.</span>
<a href="#l58.285"></a><span id="l58.285" class="difflineminus">-    switch( m_encodeScanState) {</span>
<a href="#l58.286"></a><span id="l58.286" class="difflineplus">+    switch(m_encodeScanState) {</span>
<a href="#l58.287"></a><span id="l58.287">       case kBeginAppleSingle: {</span>
<a href="#l58.288"></a><span id="l58.288"> #ifdef _MAC_IMPORT_CODE</span>
<a href="#l58.289"></a><span id="l58.289" class="difflineminus">-        OSErr err = GetCatInfoNoName( m_inputFileLoc.GetVRefNum(), m_inputFileLoc.GetParID(), m_inputFileLoc.GetFileNamePtr(), &amp;gCatInfoPB);</span>
<a href="#l58.290"></a><span id="l58.290" class="difflineplus">+        OSErr err = GetCatInfoNoName(m_inputFileLoc.GetVRefNum(), m_inputFileLoc.GetParID(), m_inputFileLoc.GetFileNamePtr(), &amp;gCatInfoPB);</span>
<a href="#l58.291"></a><span id="l58.291">         if (err != noErr)</span>
<a href="#l58.292"></a><span id="l58.292" class="difflineminus">-          return( FALSE);</span>
<a href="#l58.293"></a><span id="l58.293" class="difflineplus">+          return FALSE;</span>
<a href="#l58.294"></a><span id="l58.294"> #endif</span>
<a href="#l58.295"></a><span id="l58.295">         m_eof = false;</span>
<a href="#l58.296"></a><span id="l58.296">         m_pos = 0;</span>
<a href="#l58.297"></a><span id="l58.297" class="difflineminus">-        memcpy( m_pBuf, gAppleSingleHeader, kAppleSingleHeaderSize);</span>
<a href="#l58.298"></a><span id="l58.298" class="difflineplus">+        memcpy(m_pBuf, gAppleSingleHeader, kAppleSingleHeaderSize);</span>
<a href="#l58.299"></a><span id="l58.299">         m_bytesInBuf = kAppleSingleHeaderSize;</span>
<a href="#l58.300"></a><span id="l58.300">         int numEntries = 5;</span>
<a href="#l58.301"></a><span id="l58.301">         if (m_dataForkSize)</span>
<a href="#l58.302"></a><span id="l58.302">           numEntries++;</span>
<a href="#l58.303"></a><span id="l58.303">         if (m_resourceForkSize)</span>
<a href="#l58.304"></a><span id="l58.304">           numEntries++;</span>
<a href="#l58.305"></a><span id="l58.305" class="difflineminus">-        memcpy( m_pBuf + m_bytesInBuf, &amp;numEntries, sizeof( numEntries));</span>
<a href="#l58.306"></a><span id="l58.306" class="difflineminus">-        m_bytesInBuf += sizeof( numEntries);</span>
<a href="#l58.307"></a><span id="l58.307" class="difflineminus">-        FillInEntries( numEntries);</span>
<a href="#l58.308"></a><span id="l58.308" class="difflineplus">+        memcpy(m_pBuf + m_bytesInBuf, &amp;numEntries, sizeof(numEntries));</span>
<a href="#l58.309"></a><span id="l58.309" class="difflineplus">+        m_bytesInBuf += sizeof(numEntries);</span>
<a href="#l58.310"></a><span id="l58.310" class="difflineplus">+        FillInEntries(numEntries);</span>
<a href="#l58.311"></a><span id="l58.311">         m_encodeScanState = kAddEntries;</span>
<a href="#l58.312"></a><span id="l58.312" class="difflineminus">-        return( ScanBuffer( pDone));</span>
<a href="#l58.313"></a><span id="l58.313" class="difflineplus">+        return ScanBuffer(pDone);</span>
<a href="#l58.314"></a><span id="l58.314">       }</span>
<a href="#l58.315"></a><span id="l58.315">       break;</span>
<a href="#l58.316"></a><span id="l58.316"> </span>
<a href="#l58.317"></a><span id="l58.317">       case kBeginDataFork: {</span>
<a href="#l58.318"></a><span id="l58.318">         if (!m_dataForkSize) {</span>
<a href="#l58.319"></a><span id="l58.319">           m_encodeScanState = kDoneWithFile;</span>
<a href="#l58.320"></a><span id="l58.320" class="difflineminus">-          return( true);</span>
<a href="#l58.321"></a><span id="l58.321" class="difflineplus">+          return true;</span>
<a href="#l58.322"></a><span id="l58.322">         }</span>
<a href="#l58.323"></a><span id="l58.323">         // Initialize the scan of the data fork...</span>
<a href="#l58.324"></a><span id="l58.324">         if (!m_inputStream)</span>
<a href="#l58.325"></a><span id="l58.325">                                 {</span>
<a href="#l58.326"></a><span id="l58.326">                                   rv = NS_NewLocalFileInputStream(getter_AddRefs(m_inputStream), m_pInputFile);</span>
<a href="#l58.327"></a><span id="l58.327">                                   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l58.328"></a><span id="l58.328">                                 }</span>
<a href="#l58.329"></a><span id="l58.329">         m_encodeScanState = kScanningDataFork;</span>
<a href="#l58.330"></a><span id="l58.330" class="difflineminus">-        return( true);</span>
<a href="#l58.331"></a><span id="l58.331" class="difflineplus">+        return true;</span>
<a href="#l58.332"></a><span id="l58.332">       }</span>
<a href="#l58.333"></a><span id="l58.333">       break;</span>
<a href="#l58.334"></a><span id="l58.334"> </span>
<a href="#l58.335"></a><span id="l58.335">       case kScanningDataFork: {</span>
<a href="#l58.336"></a><span id="l58.336">         bool result = FillBufferFromFile();</span>
<a href="#l58.337"></a><span id="l58.337">         if (!result)</span>
<a href="#l58.338"></a><span id="l58.338" class="difflineminus">-          return( false);</span>
<a href="#l58.339"></a><span id="l58.339" class="difflineplus">+          return false;</span>
<a href="#l58.340"></a><span id="l58.340">         if (m_eof) {</span>
<a href="#l58.341"></a><span id="l58.341">           m_eof = false;</span>
<a href="#l58.342"></a><span id="l58.342" class="difflineminus">-          result = ScanBuffer( pDone);</span>
<a href="#l58.343"></a><span id="l58.343" class="difflineplus">+          result = ScanBuffer(pDone);</span>
<a href="#l58.344"></a><span id="l58.344">           if (!result)</span>
<a href="#l58.345"></a><span id="l58.345" class="difflineminus">-            return( false);</span>
<a href="#l58.346"></a><span id="l58.346" class="difflineplus">+            return false;</span>
<a href="#l58.347"></a><span id="l58.347">           m_inputStream-&gt;Close();</span>
<a href="#l58.348"></a><span id="l58.348">                                         m_inputStream = nsnull;</span>
<a href="#l58.349"></a><span id="l58.349">           m_encodeScanState = kDoneWithFile;</span>
<a href="#l58.350"></a><span id="l58.350" class="difflineminus">-          return( true);</span>
<a href="#l58.351"></a><span id="l58.351" class="difflineplus">+          return true;</span>
<a href="#l58.352"></a><span id="l58.352">         }</span>
<a href="#l58.353"></a><span id="l58.353">         else</span>
<a href="#l58.354"></a><span id="l58.354" class="difflineminus">-          return( ScanBuffer( pDone));</span>
<a href="#l58.355"></a><span id="l58.355" class="difflineplus">+          return ScanBuffer(pDone);</span>
<a href="#l58.356"></a><span id="l58.356">       }</span>
<a href="#l58.357"></a><span id="l58.357">       break;</span>
<a href="#l58.358"></a><span id="l58.358"> </span>
<a href="#l58.359"></a><span id="l58.359">       case kScanningRsrcFork: {</span>
<a href="#l58.360"></a><span id="l58.360">         bool result = FillBufferFromFile();</span>
<a href="#l58.361"></a><span id="l58.361">         if (!result)</span>
<a href="#l58.362"></a><span id="l58.362" class="difflineminus">-          return( false);</span>
<a href="#l58.363"></a><span id="l58.363" class="difflineplus">+          return false;</span>
<a href="#l58.364"></a><span id="l58.364">         if (m_eof) {</span>
<a href="#l58.365"></a><span id="l58.365">           m_eof = false;</span>
<a href="#l58.366"></a><span id="l58.366" class="difflineminus">-          result = ScanBuffer( pDone);</span>
<a href="#l58.367"></a><span id="l58.367" class="difflineplus">+          result = ScanBuffer(pDone);</span>
<a href="#l58.368"></a><span id="l58.368">           if (!result)</span>
<a href="#l58.369"></a><span id="l58.369" class="difflineminus">-            return( false);</span>
<a href="#l58.370"></a><span id="l58.370" class="difflineplus">+            return false;</span>
<a href="#l58.371"></a><span id="l58.371">           m_inputStream-&gt;Close();</span>
<a href="#l58.372"></a><span id="l58.372">                                         m_inputStream = nsnull;</span>
<a href="#l58.373"></a><span id="l58.373">           m_encodeScanState = kBeginDataFork;</span>
<a href="#l58.374"></a><span id="l58.374" class="difflineminus">-          return( true);</span>
<a href="#l58.375"></a><span id="l58.375" class="difflineplus">+          return true;</span>
<a href="#l58.376"></a><span id="l58.376">         }</span>
<a href="#l58.377"></a><span id="l58.377">         else</span>
<a href="#l58.378"></a><span id="l58.378" class="difflineminus">-          return( ScanBuffer( pDone));</span>
<a href="#l58.379"></a><span id="l58.379" class="difflineplus">+          return ScanBuffer(pDone);</span>
<a href="#l58.380"></a><span id="l58.380">       }</span>
<a href="#l58.381"></a><span id="l58.381">       break;</span>
<a href="#l58.382"></a><span id="l58.382"> </span>
<a href="#l58.383"></a><span id="l58.383">       case kBeginResourceFork: {</span>
<a href="#l58.384"></a><span id="l58.384">         if (!m_resourceForkSize) {</span>
<a href="#l58.385"></a><span id="l58.385">           m_encodeScanState = kBeginDataFork;</span>
<a href="#l58.386"></a><span id="l58.386" class="difflineminus">-          return( true);</span>
<a href="#l58.387"></a><span id="l58.387" class="difflineplus">+          return true;</span>
<a href="#l58.388"></a><span id="l58.388">         }</span>
<a href="#l58.389"></a><span id="l58.389">         /*</span>
<a href="#l58.390"></a><span id="l58.390">         // FIXME: Open the resource fork on the Mac!!!</span>
<a href="#l58.391"></a><span id="l58.391" class="difflineminus">-        m_fH = UFile::OpenRsrcFileRead( m_inputFileLoc);</span>
<a href="#l58.392"></a><span id="l58.392" class="difflineplus">+        m_fH = UFile::OpenRsrcFileRead(m_inputFileLoc);</span>
<a href="#l58.393"></a><span id="l58.393">         if (m_fH == TR_FILE_ERROR)</span>
<a href="#l58.394"></a><span id="l58.394" class="difflineminus">-          return( FALSE);</span>
<a href="#l58.395"></a><span id="l58.395" class="difflineplus">+          return FALSE;</span>
<a href="#l58.396"></a><span id="l58.396">         */</span>
<a href="#l58.397"></a><span id="l58.397">         m_encodeScanState = kScanningRsrcFork;</span>
<a href="#l58.398"></a><span id="l58.398" class="difflineminus">-        return( true);</span>
<a href="#l58.399"></a><span id="l58.399" class="difflineplus">+        return true;</span>
<a href="#l58.400"></a><span id="l58.400">       }</span>
<a href="#l58.401"></a><span id="l58.401">       break;</span>
<a href="#l58.402"></a><span id="l58.402"> </span>
<a href="#l58.403"></a><span id="l58.403">       case kAddEntries: {</span>
<a href="#l58.404"></a><span id="l58.404">         ShiftBuffer();</span>
<a href="#l58.405"></a><span id="l58.405">         if (!AddEntries())</span>
<a href="#l58.406"></a><span id="l58.406" class="difflineminus">-          return( false);</span>
<a href="#l58.407"></a><span id="l58.407" class="difflineplus">+          return false;</span>
<a href="#l58.408"></a><span id="l58.408">         m_encodeScanState = kBeginResourceFork;</span>
<a href="#l58.409"></a><span id="l58.409" class="difflineminus">-        return( ScanBuffer( pDone));</span>
<a href="#l58.410"></a><span id="l58.410" class="difflineplus">+        return ScanBuffer(pDone);</span>
<a href="#l58.411"></a><span id="l58.411">       }</span>
<a href="#l58.412"></a><span id="l58.412">       break;</span>
<a href="#l58.413"></a><span id="l58.413"> </span>
<a href="#l58.414"></a><span id="l58.414">       case kDoneWithFile: {</span>
<a href="#l58.415"></a><span id="l58.415">         ShiftBuffer();</span>
<a href="#l58.416"></a><span id="l58.416">         m_eof = true;</span>
<a href="#l58.417"></a><span id="l58.417" class="difflineminus">-        if (!ScanBuffer( pDone))</span>
<a href="#l58.418"></a><span id="l58.418" class="difflineminus">-          return( false);</span>
<a href="#l58.419"></a><span id="l58.419" class="difflineplus">+        if (!ScanBuffer(pDone))</span>
<a href="#l58.420"></a><span id="l58.420" class="difflineplus">+          return false;</span>
<a href="#l58.421"></a><span id="l58.421">         *pDone = true;</span>
<a href="#l58.422"></a><span id="l58.422" class="difflineminus">-        return( true);</span>
<a href="#l58.423"></a><span id="l58.423" class="difflineplus">+        return true;</span>
<a href="#l58.424"></a><span id="l58.424">       }</span>
<a href="#l58.425"></a><span id="l58.425">       break;</span>
<a href="#l58.426"></a><span id="l58.426">     }</span>
<a href="#l58.427"></a><span id="l58.427"> </span>
<a href="#l58.428"></a><span id="l58.428">   }</span>
<a href="#l58.429"></a><span id="l58.429">   else</span>
<a href="#l58.430"></a><span id="l58.430" class="difflineminus">-    return( nsImportScanFile::Scan( pDone));</span>
<a href="#l58.431"></a><span id="l58.431" class="difflineplus">+    return nsImportScanFile::Scan(pDone);</span>
<a href="#l58.432"></a><span id="l58.432"> </span>
<a href="#l58.433"></a><span id="l58.433" class="difflineminus">-  return( false);</span>
<a href="#l58.434"></a><span id="l58.434" class="difflineplus">+  return false;</span>
<a href="#l58.435"></a><span id="l58.435"> }</span>
<a href="#l58.436"></a><span id="l58.436"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mailnews/import/src/nsImportEncodeScan.h</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mailnews/import/src/nsImportEncodeScan.h</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -42,24 +42,24 @@</span>
<a href="#l59.4"></a><span id="l59.4"> #include &quot;nsImportScanFile.h&quot;</span>
<a href="#l59.5"></a><span id="l59.5"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l59.6"></a><span id="l59.6"> </span>
<a href="#l59.7"></a><span id="l59.7"> class nsImportEncodeScan : public nsImportScanFile {</span>
<a href="#l59.8"></a><span id="l59.8"> public:</span>
<a href="#l59.9"></a><span id="l59.9">   nsImportEncodeScan();</span>
<a href="#l59.10"></a><span id="l59.10">   ~nsImportEncodeScan();</span>
<a href="#l59.11"></a><span id="l59.11"> </span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-  bool    InitEncodeScan( bool appleSingleEncode, nsIFile *pFile, const char *pName, PRUint8 * pBuf, PRUint32 sz);</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineminus">-  void  CleanUpEncodeScan( void);</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineplus">+  bool    InitEncodeScan(bool appleSingleEncode, nsIFile *pFile, const char *pName, PRUint8 * pBuf, PRUint32 sz);</span>
<a href="#l59.15"></a><span id="l59.15" class="difflineplus">+  void  CleanUpEncodeScan(void);</span>
<a href="#l59.16"></a><span id="l59.16"> </span>
<a href="#l59.17"></a><span id="l59.17" class="difflineminus">-  virtual bool    Scan( bool *pDone);</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineplus">+  virtual bool    Scan(bool *pDone);</span>
<a href="#l59.19"></a><span id="l59.19"> </span>
<a href="#l59.20"></a><span id="l59.20"> protected:</span>
<a href="#l59.21"></a><span id="l59.21" class="difflineminus">-  void   FillInEntries( int numEntries);</span>
<a href="#l59.22"></a><span id="l59.22" class="difflineminus">-  bool     AddEntries( void);</span>
<a href="#l59.23"></a><span id="l59.23" class="difflineplus">+  void   FillInEntries(int numEntries);</span>
<a href="#l59.24"></a><span id="l59.24" class="difflineplus">+  bool     AddEntries(void);</span>
<a href="#l59.25"></a><span id="l59.25"> </span>
<a href="#l59.26"></a><span id="l59.26"> protected:</span>
<a href="#l59.27"></a><span id="l59.27">   bool        m_isAppleSingle;</span>
<a href="#l59.28"></a><span id="l59.28">   nsCOMPtr&lt;nsILocalFile&gt;   m_pInputFile;</span>
<a href="#l59.29"></a><span id="l59.29">         nsCOMPtr&lt;nsIInputStream&gt; m_inputStream;</span>
<a href="#l59.30"></a><span id="l59.30">   int      m_encodeScanState;</span>
<a href="#l59.31"></a><span id="l59.31">   long      m_resourceForkSize;</span>
<a href="#l59.32"></a><span id="l59.32">   long      m_dataForkSize;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mailnews/import/src/nsImportFieldMap.cpp</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mailnews/import/src/nsImportFieldMap.cpp</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -52,19 +52,19 @@ NS_METHOD nsImportFieldMap::Create(nsISt</span>
<a href="#l60.4"></a><span id="l60.4"> {</span>
<a href="#l60.5"></a><span id="l60.5">   if (aOuter)</span>
<a href="#l60.6"></a><span id="l60.6">     return NS_ERROR_NO_AGGREGATION;</span>
<a href="#l60.7"></a><span id="l60.7"> </span>
<a href="#l60.8"></a><span id="l60.8">   nsImportFieldMap *it = new nsImportFieldMap(aBundle);</span>
<a href="#l60.9"></a><span id="l60.9">   if (it == nsnull)</span>
<a href="#l60.10"></a><span id="l60.10">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l60.11"></a><span id="l60.11"> </span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-  NS_ADDREF( it);</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineminus">-  nsresult rv = it-&gt;QueryInterface( aIID, aResult);</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineminus">-  NS_RELEASE( it);</span>
<a href="#l60.15"></a><span id="l60.15" class="difflineplus">+  NS_ADDREF(it);</span>
<a href="#l60.16"></a><span id="l60.16" class="difflineplus">+  nsresult rv = it-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l60.17"></a><span id="l60.17" class="difflineplus">+  NS_RELEASE(it);</span>
<a href="#l60.18"></a><span id="l60.18">   return rv;</span>
<a href="#l60.19"></a><span id="l60.19"> }</span>
<a href="#l60.20"></a><span id="l60.20"> </span>
<a href="#l60.21"></a><span id="l60.21"> NS_IMPL_THREADSAFE_ISUPPORTS1(nsImportFieldMap, nsIImportFieldMap)</span>
<a href="#l60.22"></a><span id="l60.22"> </span>
<a href="#l60.23"></a><span id="l60.23"> NS_IMPL_GETSET(nsImportFieldMap, SkipFirstRecord, bool, m_skipFirstRecord)</span>
<a href="#l60.24"></a><span id="l60.24"> </span>
<a href="#l60.25"></a><span id="l60.25"> nsImportFieldMap::nsImportFieldMap(nsIStringBundle *aBundle)</span>
<a href="#l60.26"></a><span id="l60.26" class="difflineat">@@ -80,257 +80,257 @@ nsImportFieldMap::nsImportFieldMap(nsISt</span>
<a href="#l60.27"></a><span id="l60.27"> </span>
<a href="#l60.28"></a><span id="l60.28">   nsString *pStr;</span>
<a href="#l60.29"></a><span id="l60.29">   for (PRInt32 i = IMPORT_FIELD_DESC_START; i &lt;= IMPORT_FIELD_DESC_END; i++, m_mozFieldCount++) {</span>
<a href="#l60.30"></a><span id="l60.30">     pStr = new nsString();</span>
<a href="#l60.31"></a><span id="l60.31">     if (pBundle) {</span>
<a href="#l60.32"></a><span id="l60.32">       nsImportStringBundle::GetStringByID(i, pBundle, *pStr);</span>
<a href="#l60.33"></a><span id="l60.33">     }</span>
<a href="#l60.34"></a><span id="l60.34">     else</span>
<a href="#l60.35"></a><span id="l60.35" class="difflineminus">-      pStr-&gt;AppendInt( i);</span>
<a href="#l60.36"></a><span id="l60.36" class="difflineminus">-    m_descriptions.AppendElement( (void *)pStr);</span>
<a href="#l60.37"></a><span id="l60.37" class="difflineplus">+      pStr-&gt;AppendInt(i);</span>
<a href="#l60.38"></a><span id="l60.38" class="difflineplus">+    m_descriptions.AppendElement((void *)pStr);</span>
<a href="#l60.39"></a><span id="l60.39">   }</span>
<a href="#l60.40"></a><span id="l60.40"> }</span>
<a href="#l60.41"></a><span id="l60.41"> </span>
<a href="#l60.42"></a><span id="l60.42"> nsImportFieldMap::~nsImportFieldMap()</span>
<a href="#l60.43"></a><span id="l60.43"> {</span>
<a href="#l60.44"></a><span id="l60.44">   if (m_pFields)</span>
<a href="#l60.45"></a><span id="l60.45">     delete [] m_pFields;</span>
<a href="#l60.46"></a><span id="l60.46">   if (m_pActive)</span>
<a href="#l60.47"></a><span id="l60.47">     delete [] m_pActive;</span>
<a href="#l60.48"></a><span id="l60.48"> </span>
<a href="#l60.49"></a><span id="l60.49">   nsString *  pStr;</span>
<a href="#l60.50"></a><span id="l60.50">   for (PRInt32 i = 0; i &lt; m_mozFieldCount; i++) {</span>
<a href="#l60.51"></a><span id="l60.51" class="difflineminus">-    pStr = (nsString *) m_descriptions.ElementAt( i);</span>
<a href="#l60.52"></a><span id="l60.52" class="difflineplus">+    pStr = (nsString *) m_descriptions.ElementAt(i);</span>
<a href="#l60.53"></a><span id="l60.53">     delete pStr;</span>
<a href="#l60.54"></a><span id="l60.54">   }</span>
<a href="#l60.55"></a><span id="l60.55">   m_descriptions.Clear();</span>
<a href="#l60.56"></a><span id="l60.56"> }</span>
<a href="#l60.57"></a><span id="l60.57"> </span>
<a href="#l60.58"></a><span id="l60.58"> </span>
<a href="#l60.59"></a><span id="l60.59"> NS_IMETHODIMP nsImportFieldMap::GetNumMozFields(PRInt32 *aNumFields)</span>
<a href="#l60.60"></a><span id="l60.60"> {</span>
<a href="#l60.61"></a><span id="l60.61">     NS_PRECONDITION(aNumFields != nsnull, &quot;null ptr&quot;);</span>
<a href="#l60.62"></a><span id="l60.62">   if (!aNumFields)</span>
<a href="#l60.63"></a><span id="l60.63">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l60.64"></a><span id="l60.64"> </span>
<a href="#l60.65"></a><span id="l60.65">   *aNumFields = m_mozFieldCount;</span>
<a href="#l60.66"></a><span id="l60.66" class="difflineminus">-  return( NS_OK);</span>
<a href="#l60.67"></a><span id="l60.67" class="difflineplus">+  return NS_OK;</span>
<a href="#l60.68"></a><span id="l60.68"> }</span>
<a href="#l60.69"></a><span id="l60.69"> </span>
<a href="#l60.70"></a><span id="l60.70"> NS_IMETHODIMP nsImportFieldMap::GetMapSize(PRInt32 *aNumFields)</span>
<a href="#l60.71"></a><span id="l60.71"> {</span>
<a href="#l60.72"></a><span id="l60.72">     NS_PRECONDITION(aNumFields != nsnull, &quot;null ptr&quot;);</span>
<a href="#l60.73"></a><span id="l60.73">   if (!aNumFields)</span>
<a href="#l60.74"></a><span id="l60.74">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l60.75"></a><span id="l60.75"> </span>
<a href="#l60.76"></a><span id="l60.76">   *aNumFields = m_numFields;</span>
<a href="#l60.77"></a><span id="l60.77" class="difflineminus">-  return( NS_OK);</span>
<a href="#l60.78"></a><span id="l60.78" class="difflineplus">+  return NS_OK;</span>
<a href="#l60.79"></a><span id="l60.79"> }</span>
<a href="#l60.80"></a><span id="l60.80"> </span>
<a href="#l60.81"></a><span id="l60.81"> NS_IMETHODIMP nsImportFieldMap::GetFieldDescription(PRInt32 index, PRUnichar **_retval)</span>
<a href="#l60.82"></a><span id="l60.82"> {</span>
<a href="#l60.83"></a><span id="l60.83">     NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l60.84"></a><span id="l60.84">   if (!_retval)</span>
<a href="#l60.85"></a><span id="l60.85">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l60.86"></a><span id="l60.86"> </span>
<a href="#l60.87"></a><span id="l60.87">   *_retval = nsnull;</span>
<a href="#l60.88"></a><span id="l60.88">   if ((index &lt; 0) || (index &gt;= m_descriptions.Count()))</span>
<a href="#l60.89"></a><span id="l60.89" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l60.90"></a><span id="l60.90" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l60.91"></a><span id="l60.91"> </span>
<a href="#l60.92"></a><span id="l60.92">   *_retval = ToNewUnicode(*((nsString *)m_descriptions.ElementAt(index)));</span>
<a href="#l60.93"></a><span id="l60.93" class="difflineminus">-  return( NS_OK);</span>
<a href="#l60.94"></a><span id="l60.94" class="difflineplus">+  return NS_OK;</span>
<a href="#l60.95"></a><span id="l60.95"> }</span>
<a href="#l60.96"></a><span id="l60.96"> </span>
<a href="#l60.97"></a><span id="l60.97"> NS_IMETHODIMP nsImportFieldMap::SetFieldMapSize(PRInt32 size)</span>
<a href="#l60.98"></a><span id="l60.98"> {</span>
<a href="#l60.99"></a><span id="l60.99" class="difflineminus">-  nsresult rv = Allocate( size);</span>
<a href="#l60.100"></a><span id="l60.100" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l60.101"></a><span id="l60.101" class="difflineminus">-    return( rv);</span>
<a href="#l60.102"></a><span id="l60.102" class="difflineplus">+  nsresult rv = Allocate(size);</span>
<a href="#l60.103"></a><span id="l60.103" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l60.104"></a><span id="l60.104" class="difflineplus">+    return rv;</span>
<a href="#l60.105"></a><span id="l60.105"> </span>
<a href="#l60.106"></a><span id="l60.106">   m_numFields = size;</span>
<a href="#l60.107"></a><span id="l60.107"> </span>
<a href="#l60.108"></a><span id="l60.108" class="difflineminus">-  return( NS_OK);</span>
<a href="#l60.109"></a><span id="l60.109" class="difflineplus">+  return NS_OK;</span>
<a href="#l60.110"></a><span id="l60.110"> }</span>
<a href="#l60.111"></a><span id="l60.111"> </span>
<a href="#l60.112"></a><span id="l60.112"> </span>
<a href="#l60.113"></a><span id="l60.113"> NS_IMETHODIMP nsImportFieldMap::DefaultFieldMap(PRInt32 size)</span>
<a href="#l60.114"></a><span id="l60.114"> {</span>
<a href="#l60.115"></a><span id="l60.115" class="difflineminus">-  nsresult rv = SetFieldMapSize( size);</span>
<a href="#l60.116"></a><span id="l60.116" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l60.117"></a><span id="l60.117" class="difflineminus">-    return( rv);</span>
<a href="#l60.118"></a><span id="l60.118" class="difflineplus">+  nsresult rv = SetFieldMapSize(size);</span>
<a href="#l60.119"></a><span id="l60.119" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l60.120"></a><span id="l60.120" class="difflineplus">+    return rv;</span>
<a href="#l60.121"></a><span id="l60.121">   for (PRInt32 i = 0; i &lt; size; i++) {</span>
<a href="#l60.122"></a><span id="l60.122">     m_pFields[i] = i;</span>
<a href="#l60.123"></a><span id="l60.123">     m_pActive[i] = true;</span>
<a href="#l60.124"></a><span id="l60.124">   }</span>
<a href="#l60.125"></a><span id="l60.125"> </span>
<a href="#l60.126"></a><span id="l60.126" class="difflineminus">-  return( NS_OK);</span>
<a href="#l60.127"></a><span id="l60.127" class="difflineplus">+  return NS_OK;</span>
<a href="#l60.128"></a><span id="l60.128"> }</span>
<a href="#l60.129"></a><span id="l60.129"> </span>
<a href="#l60.130"></a><span id="l60.130"> NS_IMETHODIMP nsImportFieldMap::GetFieldMap(PRInt32 index, PRInt32 *_retval)</span>
<a href="#l60.131"></a><span id="l60.131"> {</span>
<a href="#l60.132"></a><span id="l60.132">     NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l60.133"></a><span id="l60.133">   if (!_retval)</span>
<a href="#l60.134"></a><span id="l60.134">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l60.135"></a><span id="l60.135"> </span>
<a href="#l60.136"></a><span id="l60.136"> </span>
<a href="#l60.137"></a><span id="l60.137">   if ((index &lt; 0) || (index &gt;= m_numFields))</span>
<a href="#l60.138"></a><span id="l60.138" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l60.139"></a><span id="l60.139" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l60.140"></a><span id="l60.140"> </span>
<a href="#l60.141"></a><span id="l60.141">   *_retval = m_pFields[index];</span>
<a href="#l60.142"></a><span id="l60.142" class="difflineminus">-  return( NS_OK);</span>
<a href="#l60.143"></a><span id="l60.143" class="difflineplus">+  return NS_OK;</span>
<a href="#l60.144"></a><span id="l60.144"> }</span>
<a href="#l60.145"></a><span id="l60.145"> </span>
<a href="#l60.146"></a><span id="l60.146"> NS_IMETHODIMP nsImportFieldMap::SetFieldMap(PRInt32 index, PRInt32 fieldNum)</span>
<a href="#l60.147"></a><span id="l60.147"> {</span>
<a href="#l60.148"></a><span id="l60.148">   if (index == -1) {</span>
<a href="#l60.149"></a><span id="l60.149" class="difflineminus">-    nsresult rv = Allocate( m_numFields + 1);</span>
<a href="#l60.150"></a><span id="l60.150" class="difflineminus">-    if (NS_FAILED( rv))</span>
<a href="#l60.151"></a><span id="l60.151" class="difflineminus">-      return( rv);</span>
<a href="#l60.152"></a><span id="l60.152" class="difflineplus">+    nsresult rv = Allocate(m_numFields + 1);</span>
<a href="#l60.153"></a><span id="l60.153" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l60.154"></a><span id="l60.154" class="difflineplus">+      return rv;</span>
<a href="#l60.155"></a><span id="l60.155">     index = m_numFields;</span>
<a href="#l60.156"></a><span id="l60.156">     m_numFields++;</span>
<a href="#l60.157"></a><span id="l60.157">   }</span>
<a href="#l60.158"></a><span id="l60.158">   else {</span>
<a href="#l60.159"></a><span id="l60.159">     if ((index &lt; 0) || (index &gt;= m_numFields))</span>
<a href="#l60.160"></a><span id="l60.160" class="difflineminus">-      return( NS_ERROR_FAILURE);</span>
<a href="#l60.161"></a><span id="l60.161" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l60.162"></a><span id="l60.162">   }</span>
<a href="#l60.163"></a><span id="l60.163"> </span>
<a href="#l60.164"></a><span id="l60.164">   if ((fieldNum != -1) &amp;&amp; ((fieldNum &lt; 0) || (fieldNum &gt;= m_mozFieldCount)))</span>
<a href="#l60.165"></a><span id="l60.165" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l60.166"></a><span id="l60.166" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l60.167"></a><span id="l60.167"> </span>
<a href="#l60.168"></a><span id="l60.168">   m_pFields[index] = fieldNum;</span>
<a href="#l60.169"></a><span id="l60.169" class="difflineminus">-  return( NS_OK);</span>
<a href="#l60.170"></a><span id="l60.170" class="difflineplus">+  return NS_OK;</span>
<a href="#l60.171"></a><span id="l60.171"> }</span>
<a href="#l60.172"></a><span id="l60.172"> </span>
<a href="#l60.173"></a><span id="l60.173"> NS_IMETHODIMP nsImportFieldMap::SetFieldMapByDescription(PRInt32 index, const PRUnichar *fieldDesc)</span>
<a href="#l60.174"></a><span id="l60.174"> {</span>
<a href="#l60.175"></a><span id="l60.175">     NS_PRECONDITION(fieldDesc != nsnull, &quot;null ptr&quot;);</span>
<a href="#l60.176"></a><span id="l60.176">   if (!fieldDesc)</span>
<a href="#l60.177"></a><span id="l60.177">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l60.178"></a><span id="l60.178"> </span>
<a href="#l60.179"></a><span id="l60.179" class="difflineminus">-  PRInt32 i = FindFieldNum( fieldDesc);</span>
<a href="#l60.180"></a><span id="l60.180" class="difflineplus">+  PRInt32 i = FindFieldNum(fieldDesc);</span>
<a href="#l60.181"></a><span id="l60.181">   if (i == -1)</span>
<a href="#l60.182"></a><span id="l60.182" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l60.183"></a><span id="l60.183" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l60.184"></a><span id="l60.184"> </span>
<a href="#l60.185"></a><span id="l60.185" class="difflineminus">-  return( SetFieldMap( index, i));</span>
<a href="#l60.186"></a><span id="l60.186" class="difflineplus">+  return SetFieldMap(index, i);</span>
<a href="#l60.187"></a><span id="l60.187"> }</span>
<a href="#l60.188"></a><span id="l60.188"> </span>
<a href="#l60.189"></a><span id="l60.189"> </span>
<a href="#l60.190"></a><span id="l60.190"> NS_IMETHODIMP nsImportFieldMap::GetFieldActive(PRInt32 index, bool *active)</span>
<a href="#l60.191"></a><span id="l60.191"> {</span>
<a href="#l60.192"></a><span id="l60.192">     NS_PRECONDITION(active != nsnull, &quot;null ptr&quot;);</span>
<a href="#l60.193"></a><span id="l60.193">   if (!active)</span>
<a href="#l60.194"></a><span id="l60.194">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l60.195"></a><span id="l60.195">   if ((index &lt; 0) || (index &gt;= m_numFields))</span>
<a href="#l60.196"></a><span id="l60.196" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l60.197"></a><span id="l60.197" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l60.198"></a><span id="l60.198"> </span>
<a href="#l60.199"></a><span id="l60.199">   *active = m_pActive[index];</span>
<a href="#l60.200"></a><span id="l60.200" class="difflineminus">-  return( NS_OK);</span>
<a href="#l60.201"></a><span id="l60.201" class="difflineplus">+  return NS_OK;</span>
<a href="#l60.202"></a><span id="l60.202"> }</span>
<a href="#l60.203"></a><span id="l60.203"> </span>
<a href="#l60.204"></a><span id="l60.204"> NS_IMETHODIMP nsImportFieldMap::SetFieldActive(PRInt32 index, bool active)</span>
<a href="#l60.205"></a><span id="l60.205"> {</span>
<a href="#l60.206"></a><span id="l60.206">   if ((index &lt; 0) || (index &gt;= m_numFields))</span>
<a href="#l60.207"></a><span id="l60.207" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l60.208"></a><span id="l60.208" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l60.209"></a><span id="l60.209"> </span>
<a href="#l60.210"></a><span id="l60.210">   m_pActive[index] = active;</span>
<a href="#l60.211"></a><span id="l60.211" class="difflineminus">-  return( NS_OK);</span>
<a href="#l60.212"></a><span id="l60.212" class="difflineplus">+  return NS_OK;</span>
<a href="#l60.213"></a><span id="l60.213"> }</span>
<a href="#l60.214"></a><span id="l60.214"> </span>
<a href="#l60.215"></a><span id="l60.215"> </span>
<a href="#l60.216"></a><span id="l60.216"> NS_IMETHODIMP nsImportFieldMap::SetFieldValue(nsIAddrDatabase *database, nsIMdbRow *row, PRInt32 fieldNum, const PRUnichar *value)</span>
<a href="#l60.217"></a><span id="l60.217"> {</span>
<a href="#l60.218"></a><span id="l60.218">   NS_PRECONDITION(database != nsnull, &quot;null ptr&quot;);</span>
<a href="#l60.219"></a><span id="l60.219">   NS_PRECONDITION(row != nsnull, &quot;null ptr&quot;);</span>
<a href="#l60.220"></a><span id="l60.220">   NS_PRECONDITION(value != nsnull, &quot;null ptr&quot;);</span>
<a href="#l60.221"></a><span id="l60.221">   if (!database || !row || !value)</span>
<a href="#l60.222"></a><span id="l60.222">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l60.223"></a><span id="l60.223"> </span>
<a href="#l60.224"></a><span id="l60.224">   // Allow the special value for a null field</span>
<a href="#l60.225"></a><span id="l60.225">   if (fieldNum == -1)</span>
<a href="#l60.226"></a><span id="l60.226" class="difflineminus">-    return( NS_OK);</span>
<a href="#l60.227"></a><span id="l60.227" class="difflineplus">+    return NS_OK;</span>
<a href="#l60.228"></a><span id="l60.228"> </span>
<a href="#l60.229"></a><span id="l60.229">   if ((fieldNum &lt; 0) || (fieldNum &gt;= m_mozFieldCount))</span>
<a href="#l60.230"></a><span id="l60.230" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l60.231"></a><span id="l60.231" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l60.232"></a><span id="l60.232"> </span>
<a href="#l60.233"></a><span id="l60.233">   // UGGG!!!!! lot's of typing here!</span>
<a href="#l60.234"></a><span id="l60.234">   nsresult rv;</span>
<a href="#l60.235"></a><span id="l60.235"> </span>
<a href="#l60.236"></a><span id="l60.236">   nsString str(value);</span>
<a href="#l60.237"></a><span id="l60.237">   char *pVal = ToNewUTF8String(str);</span>
<a href="#l60.238"></a><span id="l60.238"> </span>
<a href="#l60.239"></a><span id="l60.239" class="difflineminus">-  switch( fieldNum) {</span>
<a href="#l60.240"></a><span id="l60.240" class="difflineplus">+  switch(fieldNum) {</span>
<a href="#l60.241"></a><span id="l60.241">   case 0:</span>
<a href="#l60.242"></a><span id="l60.242" class="difflineminus">-    rv = database-&gt;AddFirstName( row, pVal);</span>
<a href="#l60.243"></a><span id="l60.243" class="difflineplus">+    rv = database-&gt;AddFirstName(row, pVal);</span>
<a href="#l60.244"></a><span id="l60.244">     break;</span>
<a href="#l60.245"></a><span id="l60.245">   case 1:</span>
<a href="#l60.246"></a><span id="l60.246" class="difflineminus">-    rv = database-&gt;AddLastName( row, pVal);</span>
<a href="#l60.247"></a><span id="l60.247" class="difflineplus">+    rv = database-&gt;AddLastName(row, pVal);</span>
<a href="#l60.248"></a><span id="l60.248">     break;</span>
<a href="#l60.249"></a><span id="l60.249">   case 2:</span>
<a href="#l60.250"></a><span id="l60.250" class="difflineminus">-    rv = database-&gt;AddDisplayName( row, pVal);</span>
<a href="#l60.251"></a><span id="l60.251" class="difflineplus">+    rv = database-&gt;AddDisplayName(row, pVal);</span>
<a href="#l60.252"></a><span id="l60.252">     break;</span>
<a href="#l60.253"></a><span id="l60.253">   case 3:</span>
<a href="#l60.254"></a><span id="l60.254" class="difflineminus">-    rv = database-&gt;AddNickName( row, pVal);</span>
<a href="#l60.255"></a><span id="l60.255" class="difflineplus">+    rv = database-&gt;AddNickName(row, pVal);</span>
<a href="#l60.256"></a><span id="l60.256">     break;</span>
<a href="#l60.257"></a><span id="l60.257">   case 4:</span>
<a href="#l60.258"></a><span id="l60.258" class="difflineminus">-    rv = database-&gt;AddPrimaryEmail( row, pVal);</span>
<a href="#l60.259"></a><span id="l60.259" class="difflineplus">+    rv = database-&gt;AddPrimaryEmail(row, pVal);</span>
<a href="#l60.260"></a><span id="l60.260">     break;</span>
<a href="#l60.261"></a><span id="l60.261">   case 5:</span>
<a href="#l60.262"></a><span id="l60.262" class="difflineminus">-    rv = database-&gt;Add2ndEmail( row, pVal);</span>
<a href="#l60.263"></a><span id="l60.263" class="difflineplus">+    rv = database-&gt;Add2ndEmail(row, pVal);</span>
<a href="#l60.264"></a><span id="l60.264">     break;</span>
<a href="#l60.265"></a><span id="l60.265">   case 6:</span>
<a href="#l60.266"></a><span id="l60.266" class="difflineminus">-    rv = database-&gt;AddWorkPhone( row, pVal);</span>
<a href="#l60.267"></a><span id="l60.267" class="difflineplus">+    rv = database-&gt;AddWorkPhone(row, pVal);</span>
<a href="#l60.268"></a><span id="l60.268">     break;</span>
<a href="#l60.269"></a><span id="l60.269">   case 7:</span>
<a href="#l60.270"></a><span id="l60.270" class="difflineminus">-    rv = database-&gt;AddHomePhone( row, pVal);</span>
<a href="#l60.271"></a><span id="l60.271" class="difflineplus">+    rv = database-&gt;AddHomePhone(row, pVal);</span>
<a href="#l60.272"></a><span id="l60.272">     break;</span>
<a href="#l60.273"></a><span id="l60.273">   case 8:</span>
<a href="#l60.274"></a><span id="l60.274" class="difflineminus">-    rv = database-&gt;AddFaxNumber( row, pVal);</span>
<a href="#l60.275"></a><span id="l60.275" class="difflineplus">+    rv = database-&gt;AddFaxNumber(row, pVal);</span>
<a href="#l60.276"></a><span id="l60.276">     break;</span>
<a href="#l60.277"></a><span id="l60.277">   case 9:</span>
<a href="#l60.278"></a><span id="l60.278" class="difflineminus">-    rv = database-&gt;AddPagerNumber( row, pVal);</span>
<a href="#l60.279"></a><span id="l60.279" class="difflineplus">+    rv = database-&gt;AddPagerNumber(row, pVal);</span>
<a href="#l60.280"></a><span id="l60.280">     break;</span>
<a href="#l60.281"></a><span id="l60.281">   case 10:</span>
<a href="#l60.282"></a><span id="l60.282" class="difflineminus">-    rv = database-&gt;AddCellularNumber( row, pVal);</span>
<a href="#l60.283"></a><span id="l60.283" class="difflineplus">+    rv = database-&gt;AddCellularNumber(row, pVal);</span>
<a href="#l60.284"></a><span id="l60.284">     break;</span>
<a href="#l60.285"></a><span id="l60.285">   case 11:</span>
<a href="#l60.286"></a><span id="l60.286" class="difflineminus">-    rv = database-&gt;AddHomeAddress( row, pVal);</span>
<a href="#l60.287"></a><span id="l60.287" class="difflineplus">+    rv = database-&gt;AddHomeAddress(row, pVal);</span>
<a href="#l60.288"></a><span id="l60.288">     break;</span>
<a href="#l60.289"></a><span id="l60.289">   case 12:</span>
<a href="#l60.290"></a><span id="l60.290" class="difflineminus">-    rv = database-&gt;AddHomeAddress2( row, pVal);</span>
<a href="#l60.291"></a><span id="l60.291" class="difflineplus">+    rv = database-&gt;AddHomeAddress2(row, pVal);</span>
<a href="#l60.292"></a><span id="l60.292">     break;</span>
<a href="#l60.293"></a><span id="l60.293">   case 13:</span>
<a href="#l60.294"></a><span id="l60.294" class="difflineminus">-    rv = database-&gt;AddHomeCity( row, pVal);</span>
<a href="#l60.295"></a><span id="l60.295" class="difflineplus">+    rv = database-&gt;AddHomeCity(row, pVal);</span>
<a href="#l60.296"></a><span id="l60.296">     break;</span>
<a href="#l60.297"></a><span id="l60.297">   case 14:</span>
<a href="#l60.298"></a><span id="l60.298" class="difflineminus">-    rv = database-&gt;AddHomeState( row, pVal);</span>
<a href="#l60.299"></a><span id="l60.299" class="difflineplus">+    rv = database-&gt;AddHomeState(row, pVal);</span>
<a href="#l60.300"></a><span id="l60.300">     break;</span>
<a href="#l60.301"></a><span id="l60.301">   case 15:</span>
<a href="#l60.302"></a><span id="l60.302" class="difflineminus">-    rv = database-&gt;AddHomeZipCode( row, pVal);</span>
<a href="#l60.303"></a><span id="l60.303" class="difflineplus">+    rv = database-&gt;AddHomeZipCode(row, pVal);</span>
<a href="#l60.304"></a><span id="l60.304">     break;</span>
<a href="#l60.305"></a><span id="l60.305">   case 16:</span>
<a href="#l60.306"></a><span id="l60.306" class="difflineminus">-    rv = database-&gt;AddHomeCountry( row, pVal);</span>
<a href="#l60.307"></a><span id="l60.307" class="difflineplus">+    rv = database-&gt;AddHomeCountry(row, pVal);</span>
<a href="#l60.308"></a><span id="l60.308">     break;</span>
<a href="#l60.309"></a><span id="l60.309">   case 17:</span>
<a href="#l60.310"></a><span id="l60.310" class="difflineminus">-    rv = database-&gt;AddWorkAddress( row, pVal);</span>
<a href="#l60.311"></a><span id="l60.311" class="difflineplus">+    rv = database-&gt;AddWorkAddress(row, pVal);</span>
<a href="#l60.312"></a><span id="l60.312">     break;</span>
<a href="#l60.313"></a><span id="l60.313">   case 18:</span>
<a href="#l60.314"></a><span id="l60.314" class="difflineminus">-    rv = database-&gt;AddWorkAddress2( row, pVal);</span>
<a href="#l60.315"></a><span id="l60.315" class="difflineplus">+    rv = database-&gt;AddWorkAddress2(row, pVal);</span>
<a href="#l60.316"></a><span id="l60.316">     break;</span>
<a href="#l60.317"></a><span id="l60.317">   case 19:</span>
<a href="#l60.318"></a><span id="l60.318" class="difflineminus">-    rv = database-&gt;AddWorkCity( row, pVal);</span>
<a href="#l60.319"></a><span id="l60.319" class="difflineplus">+    rv = database-&gt;AddWorkCity(row, pVal);</span>
<a href="#l60.320"></a><span id="l60.320">     break;</span>
<a href="#l60.321"></a><span id="l60.321">   case 20:</span>
<a href="#l60.322"></a><span id="l60.322" class="difflineminus">-    rv = database-&gt;AddWorkState( row, pVal);</span>
<a href="#l60.323"></a><span id="l60.323" class="difflineplus">+    rv = database-&gt;AddWorkState(row, pVal);</span>
<a href="#l60.324"></a><span id="l60.324">     break;</span>
<a href="#l60.325"></a><span id="l60.325">   case 21:</span>
<a href="#l60.326"></a><span id="l60.326" class="difflineminus">-    rv = database-&gt;AddWorkZipCode( row, pVal);</span>
<a href="#l60.327"></a><span id="l60.327" class="difflineplus">+    rv = database-&gt;AddWorkZipCode(row, pVal);</span>
<a href="#l60.328"></a><span id="l60.328">     break;</span>
<a href="#l60.329"></a><span id="l60.329">   case 22:</span>
<a href="#l60.330"></a><span id="l60.330" class="difflineminus">-    rv = database-&gt;AddWorkCountry( row, pVal);</span>
<a href="#l60.331"></a><span id="l60.331" class="difflineplus">+    rv = database-&gt;AddWorkCountry(row, pVal);</span>
<a href="#l60.332"></a><span id="l60.332">     break;</span>
<a href="#l60.333"></a><span id="l60.333">   case 23:</span>
<a href="#l60.334"></a><span id="l60.334">     rv = database-&gt;AddJobTitle(row, pVal);</span>
<a href="#l60.335"></a><span id="l60.335">     break;</span>
<a href="#l60.336"></a><span id="l60.336">   case 24:</span>
<a href="#l60.337"></a><span id="l60.337">     rv = database-&gt;AddDepartment(row, pVal);</span>
<a href="#l60.338"></a><span id="l60.338">     break;</span>
<a href="#l60.339"></a><span id="l60.339">   case 25:</span>
<a href="#l60.340"></a><span id="l60.340" class="difflineat">@@ -372,47 +372,47 @@ NS_IMETHODIMP nsImportFieldMap::SetField</span>
<a href="#l60.341"></a><span id="l60.341">   default:</span>
<a href="#l60.342"></a><span id="l60.342">     /* Get the field description, and add it as an anonymous attr? */</span>
<a href="#l60.343"></a><span id="l60.343">     /* OR WHAT???? */</span>
<a href="#l60.344"></a><span id="l60.344">     {</span>
<a href="#l60.345"></a><span id="l60.345">       rv = NS_ERROR_FAILURE;</span>
<a href="#l60.346"></a><span id="l60.346">     }</span>
<a href="#l60.347"></a><span id="l60.347">   }</span>
<a href="#l60.348"></a><span id="l60.348"> </span>
<a href="#l60.349"></a><span id="l60.349" class="difflineminus">-  NS_Free( pVal);</span>
<a href="#l60.350"></a><span id="l60.350" class="difflineplus">+  NS_Free(pVal);</span>
<a href="#l60.351"></a><span id="l60.351"> </span>
<a href="#l60.352"></a><span id="l60.352" class="difflineminus">-  return( rv);</span>
<a href="#l60.353"></a><span id="l60.353" class="difflineplus">+  return rv;</span>
<a href="#l60.354"></a><span id="l60.354"> }</span>
<a href="#l60.355"></a><span id="l60.355"> </span>
<a href="#l60.356"></a><span id="l60.356"> </span>
<a href="#l60.357"></a><span id="l60.357"> NS_IMETHODIMP nsImportFieldMap::SetFieldValueByDescription(nsIAddrDatabase *database, nsIMdbRow *row, const PRUnichar *fieldDesc, const PRUnichar *value)</span>
<a href="#l60.358"></a><span id="l60.358"> {</span>
<a href="#l60.359"></a><span id="l60.359">     NS_PRECONDITION(fieldDesc != nsnull, &quot;null ptr&quot;);</span>
<a href="#l60.360"></a><span id="l60.360">   if (!fieldDesc)</span>
<a href="#l60.361"></a><span id="l60.361">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l60.362"></a><span id="l60.362" class="difflineminus">-  PRInt32 i = FindFieldNum( fieldDesc);</span>
<a href="#l60.363"></a><span id="l60.363" class="difflineplus">+  PRInt32 i = FindFieldNum(fieldDesc);</span>
<a href="#l60.364"></a><span id="l60.364">   if (i == -1)</span>
<a href="#l60.365"></a><span id="l60.365" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l60.366"></a><span id="l60.366" class="difflineminus">-  return( SetFieldValue( database, row, i, value));</span>
<a href="#l60.367"></a><span id="l60.367" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l60.368"></a><span id="l60.368" class="difflineplus">+  return SetFieldValue(database, row, i, value);</span>
<a href="#l60.369"></a><span id="l60.369"> }</span>
<a href="#l60.370"></a><span id="l60.370"> </span>
<a href="#l60.371"></a><span id="l60.371"> </span>
<a href="#l60.372"></a><span id="l60.372"> NS_IMETHODIMP nsImportFieldMap::GetFieldValue(nsIAbCard *card, PRInt32 fieldNum, PRUnichar **_retval)</span>
<a href="#l60.373"></a><span id="l60.373"> {</span>
<a href="#l60.374"></a><span id="l60.374">   if (!_retval || !card)</span>
<a href="#l60.375"></a><span id="l60.375">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l60.376"></a><span id="l60.376"> </span>
<a href="#l60.377"></a><span id="l60.377">   if (fieldNum == -1) {</span>
<a href="#l60.378"></a><span id="l60.378">     PRUnichar c = 0;</span>
<a href="#l60.379"></a><span id="l60.379">     *_retval = NS_strdup(&amp;c);</span>
<a href="#l60.380"></a><span id="l60.380">     return NS_OK;</span>
<a href="#l60.381"></a><span id="l60.381">   }</span>
<a href="#l60.382"></a><span id="l60.382"> </span>
<a href="#l60.383"></a><span id="l60.383">   if ((fieldNum &lt; 0) || (fieldNum &gt;= m_mozFieldCount))</span>
<a href="#l60.384"></a><span id="l60.384" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l60.385"></a><span id="l60.385" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l60.386"></a><span id="l60.386"> </span>
<a href="#l60.387"></a><span id="l60.387">   // ARRGGG!!! Lots of typing again</span>
<a href="#l60.388"></a><span id="l60.388">   // get the field from the card</span>
<a href="#l60.389"></a><span id="l60.389">   nsresult rv;</span>
<a href="#l60.390"></a><span id="l60.390">   nsAutoString value;</span>
<a href="#l60.391"></a><span id="l60.391"> </span>
<a href="#l60.392"></a><span id="l60.392">   switch (fieldNum) {</span>
<a href="#l60.393"></a><span id="l60.393">   case 0:</span>
<a href="#l60.394"></a><span id="l60.394" class="difflineat">@@ -541,24 +541,24 @@ NS_IMETHODIMP nsImportFieldMap::GetField</span>
<a href="#l60.395"></a><span id="l60.395">   return rv;</span>
<a href="#l60.396"></a><span id="l60.396"> }</span>
<a href="#l60.397"></a><span id="l60.397"> </span>
<a href="#l60.398"></a><span id="l60.398"> NS_IMETHODIMP nsImportFieldMap::GetFieldValueByDescription(nsIAbCard *card, const PRUnichar *fieldDesc, PRUnichar **_retval)</span>
<a href="#l60.399"></a><span id="l60.399"> {</span>
<a href="#l60.400"></a><span id="l60.400">     NS_PRECONDITION(fieldDesc != nsnull, &quot;null ptr&quot;);</span>
<a href="#l60.401"></a><span id="l60.401">   if (!fieldDesc)</span>
<a href="#l60.402"></a><span id="l60.402">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l60.403"></a><span id="l60.403" class="difflineminus">-  PRInt32 i = FindFieldNum( fieldDesc);</span>
<a href="#l60.404"></a><span id="l60.404" class="difflineplus">+  PRInt32 i = FindFieldNum(fieldDesc);</span>
<a href="#l60.405"></a><span id="l60.405">   if (i == -1)</span>
<a href="#l60.406"></a><span id="l60.406">     return NS_ERROR_FAILURE;</span>
<a href="#l60.407"></a><span id="l60.407" class="difflineminus">-  return GetFieldValue( card, i, _retval);</span>
<a href="#l60.408"></a><span id="l60.408" class="difflineplus">+  return GetFieldValue(card, i, _retval);</span>
<a href="#l60.409"></a><span id="l60.409"> }</span>
<a href="#l60.410"></a><span id="l60.410"> </span>
<a href="#l60.411"></a><span id="l60.411"> </span>
<a href="#l60.412"></a><span id="l60.412" class="difflineminus">-nsresult nsImportFieldMap::Allocate( PRInt32 newSize)</span>
<a href="#l60.413"></a><span id="l60.413" class="difflineplus">+nsresult nsImportFieldMap::Allocate(PRInt32 newSize)</span>
<a href="#l60.414"></a><span id="l60.414"> {</span>
<a href="#l60.415"></a><span id="l60.415">   if (newSize &lt;= m_allocated)</span>
<a href="#l60.416"></a><span id="l60.416">     return NS_OK;</span>
<a href="#l60.417"></a><span id="l60.417"> </span>
<a href="#l60.418"></a><span id="l60.418">   PRInt32 sz = m_allocated;</span>
<a href="#l60.419"></a><span id="l60.419">   while (sz &lt; newSize)</span>
<a href="#l60.420"></a><span id="l60.420">     sz += 30;</span>
<a href="#l60.421"></a><span id="l60.421"> </span>
<a href="#l60.422"></a><span id="l60.422" class="difflineat">@@ -585,19 +585,19 @@ nsresult nsImportFieldMap::Allocate( PRI</span>
<a href="#l60.423"></a><span id="l60.423">     delete [] m_pActive;</span>
<a href="#l60.424"></a><span id="l60.424">   }</span>
<a href="#l60.425"></a><span id="l60.425">   m_allocated = sz;</span>
<a href="#l60.426"></a><span id="l60.426">   m_pFields = pData;</span>
<a href="#l60.427"></a><span id="l60.427">   m_pActive = pActive;</span>
<a href="#l60.428"></a><span id="l60.428">   return NS_OK;</span>
<a href="#l60.429"></a><span id="l60.429"> }</span>
<a href="#l60.430"></a><span id="l60.430"> </span>
<a href="#l60.431"></a><span id="l60.431" class="difflineminus">-PRInt32 nsImportFieldMap::FindFieldNum( const PRUnichar *pDesc)</span>
<a href="#l60.432"></a><span id="l60.432" class="difflineplus">+PRInt32 nsImportFieldMap::FindFieldNum(const PRUnichar *pDesc)</span>
<a href="#l60.433"></a><span id="l60.433"> {</span>
<a href="#l60.434"></a><span id="l60.434">   nsString *pStr;</span>
<a href="#l60.435"></a><span id="l60.435">   for (PRInt32 i = 0; i &lt; m_mozFieldCount; i++) {</span>
<a href="#l60.436"></a><span id="l60.436" class="difflineminus">-    pStr = (nsString *)m_descriptions.ElementAt( i);</span>
<a href="#l60.437"></a><span id="l60.437" class="difflineplus">+    pStr = (nsString *)m_descriptions.ElementAt(i);</span>
<a href="#l60.438"></a><span id="l60.438">     if (!pStr-&gt;Equals(pDesc))</span>
<a href="#l60.439"></a><span id="l60.439">       return i;</span>
<a href="#l60.440"></a><span id="l60.440">   }</span>
<a href="#l60.441"></a><span id="l60.441"> </span>
<a href="#l60.442"></a><span id="l60.442">   return -1;</span>
<a href="#l60.443"></a><span id="l60.443"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mailnews/import/src/nsImportFieldMap.h</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mailnews/import/src/nsImportFieldMap.h</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -56,18 +56,18 @@ public:</span>
<a href="#l61.4"></a><span id="l61.4">   NS_DECL_NSIIMPORTFIELDMAP</span>
<a href="#l61.5"></a><span id="l61.5"> </span>
<a href="#l61.6"></a><span id="l61.6">   nsImportFieldMap(nsIStringBundle *aBundle);</span>
<a href="#l61.7"></a><span id="l61.7">   virtual ~nsImportFieldMap();</span>
<a href="#l61.8"></a><span id="l61.8"> </span>
<a href="#l61.9"></a><span id="l61.9">    static NS_METHOD Create(nsIStringBundle *aBundle, nsISupports *aOuter, REFNSIID aIID, void **aResult);</span>
<a href="#l61.10"></a><span id="l61.10"> </span>
<a href="#l61.11"></a><span id="l61.11"> private:</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">-  nsresult  Allocate( PRInt32 newSize);</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineminus">-  PRInt32    FindFieldNum( const PRUnichar *pDesc);</span>
<a href="#l61.14"></a><span id="l61.14" class="difflineplus">+  nsresult  Allocate(PRInt32 newSize);</span>
<a href="#l61.15"></a><span id="l61.15" class="difflineplus">+  PRInt32    FindFieldNum(const PRUnichar *pDesc);</span>
<a href="#l61.16"></a><span id="l61.16"> </span>
<a href="#l61.17"></a><span id="l61.17"> </span>
<a href="#l61.18"></a><span id="l61.18"> private:</span>
<a href="#l61.19"></a><span id="l61.19">   PRInt32    m_numFields;</span>
<a href="#l61.20"></a><span id="l61.20">   PRInt32  *  m_pFields;</span>
<a href="#l61.21"></a><span id="l61.21">   bool *  m_pActive;</span>
<a href="#l61.22"></a><span id="l61.22">   PRInt32    m_allocated;</span>
<a href="#l61.23"></a><span id="l61.23">   nsVoidArray  m_descriptions;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/mailnews/import/src/nsImportMail.cpp</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/mailnews/import/src/nsImportMail.cpp</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -74,17 +74,17 @@</span>
<a href="#l62.4"></a><span id="l62.4"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l62.5"></a><span id="l62.5"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l62.6"></a><span id="l62.6"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l62.7"></a><span id="l62.7"> </span>
<a href="#l62.8"></a><span id="l62.8"> #define IMPORT_MSGS_URL       &quot;chrome://messenger/locale/importMsgs.properties&quot;</span>
<a href="#l62.9"></a><span id="l62.9"> </span>
<a href="#l62.10"></a><span id="l62.10"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l62.11"></a><span id="l62.11"> </span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-static void ImportMailThread( void *stuff);</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+static void ImportMailThread(void *stuff);</span>
<a href="#l62.14"></a><span id="l62.14"> </span>
<a href="#l62.15"></a><span id="l62.15"> class ImportThreadData;</span>
<a href="#l62.16"></a><span id="l62.16"> </span>
<a href="#l62.17"></a><span id="l62.17"> class nsImportGenericMail : public nsIImportGeneric</span>
<a href="#l62.18"></a><span id="l62.18"> {</span>
<a href="#l62.19"></a><span id="l62.19"> public:</span>
<a href="#l62.20"></a><span id="l62.20"> </span>
<a href="#l62.21"></a><span id="l62.21">   nsImportGenericMail();</span>
<a href="#l62.22"></a><span id="l62.22" class="difflineat">@@ -92,38 +92,38 @@ public:</span>
<a href="#l62.23"></a><span id="l62.23"> </span>
<a href="#l62.24"></a><span id="l62.24">   NS_DECL_ISUPPORTS</span>
<a href="#l62.25"></a><span id="l62.25"> </span>
<a href="#l62.26"></a><span id="l62.26">   /* nsISupports GetData (in string dataId); */</span>
<a href="#l62.27"></a><span id="l62.27">   NS_IMETHOD GetData(const char *dataId, nsISupports **_retval);</span>
<a href="#l62.28"></a><span id="l62.28"> </span>
<a href="#l62.29"></a><span id="l62.29">   NS_IMETHOD SetData(const char *dataId, nsISupports *pData);</span>
<a href="#l62.30"></a><span id="l62.30"> </span>
<a href="#l62.31"></a><span id="l62.31" class="difflineminus">-  NS_IMETHOD GetStatus( const char *statusKind, PRInt32 *_retval);</span>
<a href="#l62.32"></a><span id="l62.32" class="difflineplus">+  NS_IMETHOD GetStatus(const char *statusKind, PRInt32 *_retval);</span>
<a href="#l62.33"></a><span id="l62.33"> </span>
<a href="#l62.34"></a><span id="l62.34">   NS_IMETHOD WantsProgress(bool *_retval);</span>
<a href="#l62.35"></a><span id="l62.35"> </span>
<a href="#l62.36"></a><span id="l62.36">   NS_IMETHODIMP BeginImport(nsISupportsString *successLog, nsISupportsString *errorLog, bool *_retval) ;</span>
<a href="#l62.37"></a><span id="l62.37"> </span>
<a href="#l62.38"></a><span id="l62.38">   NS_IMETHOD ContinueImport(bool *_retval);</span>
<a href="#l62.39"></a><span id="l62.39"> </span>
<a href="#l62.40"></a><span id="l62.40">   NS_IMETHOD GetProgress(PRInt32 *_retval);</span>
<a href="#l62.41"></a><span id="l62.41"> </span>
<a href="#l62.42"></a><span id="l62.42">   NS_IMETHOD CancelImport(void);</span>
<a href="#l62.43"></a><span id="l62.43"> </span>
<a href="#l62.44"></a><span id="l62.44"> private:</span>
<a href="#l62.45"></a><span id="l62.45" class="difflineminus">-  bool    CreateFolder( nsIMsgFolder **ppFolder);</span>
<a href="#l62.46"></a><span id="l62.46" class="difflineminus">-  void  GetDefaultMailboxes( void);</span>
<a href="#l62.47"></a><span id="l62.47" class="difflineminus">-  void  GetDefaultLocation( void);</span>
<a href="#l62.48"></a><span id="l62.48" class="difflineminus">-  void  GetDefaultDestination( void);</span>
<a href="#l62.49"></a><span id="l62.49" class="difflineminus">-  void  GetMailboxName( PRUint32 index, nsISupportsString *pStr);</span>
<a href="#l62.50"></a><span id="l62.50" class="difflineplus">+  bool    CreateFolder(nsIMsgFolder **ppFolder);</span>
<a href="#l62.51"></a><span id="l62.51" class="difflineplus">+  void  GetDefaultMailboxes(void);</span>
<a href="#l62.52"></a><span id="l62.52" class="difflineplus">+  void  GetDefaultLocation(void);</span>
<a href="#l62.53"></a><span id="l62.53" class="difflineplus">+  void  GetDefaultDestination(void);</span>
<a href="#l62.54"></a><span id="l62.54" class="difflineplus">+  void  GetMailboxName(PRUint32 index, nsISupportsString *pStr);</span>
<a href="#l62.55"></a><span id="l62.55"> </span>
<a href="#l62.56"></a><span id="l62.56"> public:</span>
<a href="#l62.57"></a><span id="l62.57" class="difflineminus">-  static void  SetLogs( nsString&amp; success, nsString&amp; error, nsISupportsString *pSuccess, nsISupportsString *pError);</span>
<a href="#l62.58"></a><span id="l62.58" class="difflineminus">-  static void ReportError( PRInt32 id, const PRUnichar *pName, nsString *pStream, nsIStringBundle* aBundle);</span>
<a href="#l62.59"></a><span id="l62.59" class="difflineplus">+  static void  SetLogs(nsString&amp; success, nsString&amp; error, nsISupportsString *pSuccess, nsISupportsString *pError);</span>
<a href="#l62.60"></a><span id="l62.60" class="difflineplus">+  static void ReportError(PRInt32 id, const PRUnichar *pName, nsString *pStream, nsIStringBundle* aBundle);</span>
<a href="#l62.61"></a><span id="l62.61"> </span>
<a href="#l62.62"></a><span id="l62.62"> private:</span>
<a href="#l62.63"></a><span id="l62.63">   nsString      m_pName;  // module name that created this interface</span>
<a href="#l62.64"></a><span id="l62.64">   nsIMsgFolder *    m_pDestFolder;</span>
<a href="#l62.65"></a><span id="l62.65">   bool          m_deleteDestFolder;</span>
<a href="#l62.66"></a><span id="l62.66">   bool          m_createdFolder;</span>
<a href="#l62.67"></a><span id="l62.67">   nsCOMPtr &lt;nsIFile&gt; m_pSrcLocation;</span>
<a href="#l62.68"></a><span id="l62.68">   bool          m_gotLocation;</span>
<a href="#l62.69"></a><span id="l62.69" class="difflineat">@@ -186,21 +186,21 @@ nsresult NS_NewGenericMail(nsIImportGene</span>
<a href="#l62.70"></a><span id="l62.70">     if (! aImportGeneric)</span>
<a href="#l62.71"></a><span id="l62.71">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l62.72"></a><span id="l62.72"> </span>
<a href="#l62.73"></a><span id="l62.73">   nsImportGenericMail *pGen = new nsImportGenericMail();</span>
<a href="#l62.74"></a><span id="l62.74"> </span>
<a href="#l62.75"></a><span id="l62.75">   if (pGen == nsnull)</span>
<a href="#l62.76"></a><span id="l62.76">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l62.77"></a><span id="l62.77"> </span>
<a href="#l62.78"></a><span id="l62.78" class="difflineminus">-  NS_ADDREF( pGen);</span>
<a href="#l62.79"></a><span id="l62.79" class="difflineminus">-  nsresult rv = pGen-&gt;QueryInterface( NS_GET_IID(nsIImportGeneric), (void **)aImportGeneric);</span>
<a href="#l62.80"></a><span id="l62.80" class="difflineminus">-  NS_RELEASE( pGen);</span>
<a href="#l62.81"></a><span id="l62.81" class="difflineplus">+  NS_ADDREF(pGen);</span>
<a href="#l62.82"></a><span id="l62.82" class="difflineplus">+  nsresult rv = pGen-&gt;QueryInterface(NS_GET_IID(nsIImportGeneric), (void **)aImportGeneric);</span>
<a href="#l62.83"></a><span id="l62.83" class="difflineplus">+  NS_RELEASE(pGen);</span>
<a href="#l62.84"></a><span id="l62.84"> </span>
<a href="#l62.85"></a><span id="l62.85" class="difflineminus">-    return( rv);</span>
<a href="#l62.86"></a><span id="l62.86" class="difflineplus">+    return rv;</span>
<a href="#l62.87"></a><span id="l62.87"> }</span>
<a href="#l62.88"></a><span id="l62.88"> </span>
<a href="#l62.89"></a><span id="l62.89"> nsImportGenericMail::nsImportGenericMail()</span>
<a href="#l62.90"></a><span id="l62.90"> {</span>
<a href="#l62.91"></a><span id="l62.91">   m_found = false;</span>
<a href="#l62.92"></a><span id="l62.92">   m_userVerify = false;</span>
<a href="#l62.93"></a><span id="l62.93">   m_gotLocation = false;</span>
<a href="#l62.94"></a><span id="l62.94">   m_pInterface = nsnull;</span>
<a href="#l62.95"></a><span id="l62.95" class="difflineat">@@ -228,195 +228,195 @@ nsImportGenericMail::nsImportGenericMail</span>
<a href="#l62.96"></a><span id="l62.96"> </span>
<a href="#l62.97"></a><span id="l62.97"> nsImportGenericMail::~nsImportGenericMail()</span>
<a href="#l62.98"></a><span id="l62.98"> {</span>
<a href="#l62.99"></a><span id="l62.99">   if (m_pThreadData) {</span>
<a href="#l62.100"></a><span id="l62.100">     m_pThreadData-&gt;DriverAbort();</span>
<a href="#l62.101"></a><span id="l62.101">     m_pThreadData = nsnull;</span>
<a href="#l62.102"></a><span id="l62.102">   }</span>
<a href="#l62.103"></a><span id="l62.103"> </span>
<a href="#l62.104"></a><span id="l62.104" class="difflineminus">-  NS_IF_RELEASE( m_pDestFolder);</span>
<a href="#l62.105"></a><span id="l62.105" class="difflineminus">-  NS_IF_RELEASE( m_pInterface);</span>
<a href="#l62.106"></a><span id="l62.106" class="difflineminus">-  NS_IF_RELEASE( m_pMailboxes);</span>
<a href="#l62.107"></a><span id="l62.107" class="difflineminus">-  NS_IF_RELEASE( m_pSuccessLog);</span>
<a href="#l62.108"></a><span id="l62.108" class="difflineminus">-  NS_IF_RELEASE( m_pErrorLog);</span>
<a href="#l62.109"></a><span id="l62.109" class="difflineplus">+  NS_IF_RELEASE(m_pDestFolder);</span>
<a href="#l62.110"></a><span id="l62.110" class="difflineplus">+  NS_IF_RELEASE(m_pInterface);</span>
<a href="#l62.111"></a><span id="l62.111" class="difflineplus">+  NS_IF_RELEASE(m_pMailboxes);</span>
<a href="#l62.112"></a><span id="l62.112" class="difflineplus">+  NS_IF_RELEASE(m_pSuccessLog);</span>
<a href="#l62.113"></a><span id="l62.113" class="difflineplus">+  NS_IF_RELEASE(m_pErrorLog);</span>
<a href="#l62.114"></a><span id="l62.114"> }</span>
<a href="#l62.115"></a><span id="l62.115"> </span>
<a href="#l62.116"></a><span id="l62.116"> </span>
<a href="#l62.117"></a><span id="l62.117"> </span>
<a href="#l62.118"></a><span id="l62.118"> NS_IMPL_THREADSAFE_ISUPPORTS1(nsImportGenericMail, nsIImportGeneric)</span>
<a href="#l62.119"></a><span id="l62.119"> </span>
<a href="#l62.120"></a><span id="l62.120"> </span>
<a href="#l62.121"></a><span id="l62.121"> NS_IMETHODIMP nsImportGenericMail::GetData(const char *dataId, nsISupports **_retval)</span>
<a href="#l62.122"></a><span id="l62.122"> {</span>
<a href="#l62.123"></a><span id="l62.123">   nsresult rv = NS_OK;</span>
<a href="#l62.124"></a><span id="l62.124"> </span>
<a href="#l62.125"></a><span id="l62.125">   NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l62.126"></a><span id="l62.126">   if (!_retval)</span>
<a href="#l62.127"></a><span id="l62.127">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l62.128"></a><span id="l62.128"> </span>
<a href="#l62.129"></a><span id="l62.129">   *_retval = nsnull;</span>
<a href="#l62.130"></a><span id="l62.130" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;mailInterface&quot;)) {</span>
<a href="#l62.131"></a><span id="l62.131" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;mailInterface&quot;)) {</span>
<a href="#l62.132"></a><span id="l62.132">     *_retval = m_pInterface;</span>
<a href="#l62.133"></a><span id="l62.133" class="difflineminus">-    NS_IF_ADDREF( m_pInterface);</span>
<a href="#l62.134"></a><span id="l62.134" class="difflineplus">+    NS_IF_ADDREF(m_pInterface);</span>
<a href="#l62.135"></a><span id="l62.135">   }</span>
<a href="#l62.136"></a><span id="l62.136"> </span>
<a href="#l62.137"></a><span id="l62.137" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;mailBoxes&quot;)) {</span>
<a href="#l62.138"></a><span id="l62.138" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;mailBoxes&quot;)) {</span>
<a href="#l62.139"></a><span id="l62.139">     if (!m_pMailboxes)</span>
<a href="#l62.140"></a><span id="l62.140">       GetDefaultMailboxes();</span>
<a href="#l62.141"></a><span id="l62.141">     *_retval = m_pMailboxes;</span>
<a href="#l62.142"></a><span id="l62.142" class="difflineminus">-    NS_IF_ADDREF( m_pMailboxes);</span>
<a href="#l62.143"></a><span id="l62.143" class="difflineplus">+    NS_IF_ADDREF(m_pMailboxes);</span>
<a href="#l62.144"></a><span id="l62.144">   }</span>
<a href="#l62.145"></a><span id="l62.145"> </span>
<a href="#l62.146"></a><span id="l62.146" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;mailLocation&quot;)) {</span>
<a href="#l62.147"></a><span id="l62.147" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;mailLocation&quot;)) {</span>
<a href="#l62.148"></a><span id="l62.148">     if (!m_pSrcLocation)</span>
<a href="#l62.149"></a><span id="l62.149">       GetDefaultLocation();</span>
<a href="#l62.150"></a><span id="l62.150">     NS_IF_ADDREF(*_retval = m_pSrcLocation);</span>
<a href="#l62.151"></a><span id="l62.151">   }</span>
<a href="#l62.152"></a><span id="l62.152"> </span>
<a href="#l62.153"></a><span id="l62.153" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;mailDestination&quot;)) {</span>
<a href="#l62.154"></a><span id="l62.154" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;mailDestination&quot;)) {</span>
<a href="#l62.155"></a><span id="l62.155">     if (!m_pDestFolder)</span>
<a href="#l62.156"></a><span id="l62.156">       GetDefaultDestination();</span>
<a href="#l62.157"></a><span id="l62.157">     NS_IF_ADDREF(*_retval = m_pDestFolder);</span>
<a href="#l62.158"></a><span id="l62.158">   }</span>
<a href="#l62.159"></a><span id="l62.159"> </span>
<a href="#l62.160"></a><span id="l62.160" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;migration&quot;)) {</span>
<a href="#l62.161"></a><span id="l62.161" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;migration&quot;)) {</span>
<a href="#l62.162"></a><span id="l62.162">         nsCOMPtr&lt;nsISupportsPRBool&gt; migrationString = do_CreateInstance(NS_SUPPORTS_PRBOOL_CONTRACTID, &amp;rv);</span>
<a href="#l62.163"></a><span id="l62.163">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l62.164"></a><span id="l62.164">         migrationString-&gt;SetData(m_performingMigration);</span>
<a href="#l62.165"></a><span id="l62.165" class="difflineminus">-        NS_IF_ADDREF( *_retval = migrationString);</span>
<a href="#l62.166"></a><span id="l62.166" class="difflineplus">+        NS_IF_ADDREF(*_retval = migrationString);</span>
<a href="#l62.167"></a><span id="l62.167">   }</span>
<a href="#l62.168"></a><span id="l62.168"> </span>
<a href="#l62.169"></a><span id="l62.169" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;currentMailbox&quot;)) {</span>
<a href="#l62.170"></a><span id="l62.170" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;currentMailbox&quot;)) {</span>
<a href="#l62.171"></a><span id="l62.171">     // create an nsISupportsString, get the current mailbox</span>
<a href="#l62.172"></a><span id="l62.172">     // name being imported and put it in the string</span>
<a href="#l62.173"></a><span id="l62.173" class="difflineminus">-    nsCOMPtr&lt;nsISupportsString&gt;  data = do_CreateInstance( NS_SUPPORTS_STRING_CONTRACTID, &amp;rv);</span>
<a href="#l62.174"></a><span id="l62.174" class="difflineminus">-    if (NS_FAILED( rv))</span>
<a href="#l62.175"></a><span id="l62.175" class="difflineminus">-      return( rv);</span>
<a href="#l62.176"></a><span id="l62.176" class="difflineplus">+    nsCOMPtr&lt;nsISupportsString&gt;  data = do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv);</span>
<a href="#l62.177"></a><span id="l62.177" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l62.178"></a><span id="l62.178" class="difflineplus">+      return rv;</span>
<a href="#l62.179"></a><span id="l62.179">     if (m_pThreadData) {</span>
<a href="#l62.180"></a><span id="l62.180" class="difflineminus">-      GetMailboxName( m_pThreadData-&gt;currentMailbox, data);</span>
<a href="#l62.181"></a><span id="l62.181" class="difflineplus">+      GetMailboxName(m_pThreadData-&gt;currentMailbox, data);</span>
<a href="#l62.182"></a><span id="l62.182">     }</span>
<a href="#l62.183"></a><span id="l62.183">     NS_ADDREF(*_retval = data);</span>
<a href="#l62.184"></a><span id="l62.184">   }</span>
<a href="#l62.185"></a><span id="l62.185"> </span>
<a href="#l62.186"></a><span id="l62.186" class="difflineminus">-  return( rv);</span>
<a href="#l62.187"></a><span id="l62.187" class="difflineplus">+  return rv;</span>
<a href="#l62.188"></a><span id="l62.188"> }</span>
<a href="#l62.189"></a><span id="l62.189"> </span>
<a href="#l62.190"></a><span id="l62.190" class="difflineminus">-NS_IMETHODIMP nsImportGenericMail::SetData( const char *dataId, nsISupports *item)</span>
<a href="#l62.191"></a><span id="l62.191" class="difflineplus">+NS_IMETHODIMP nsImportGenericMail::SetData(const char *dataId, nsISupports *item)</span>
<a href="#l62.192"></a><span id="l62.192"> {</span>
<a href="#l62.193"></a><span id="l62.193">   nsresult rv = NS_OK;</span>
<a href="#l62.194"></a><span id="l62.194">   NS_PRECONDITION(dataId != nsnull, &quot;null ptr&quot;);</span>
<a href="#l62.195"></a><span id="l62.195">   if (!dataId)</span>
<a href="#l62.196"></a><span id="l62.196">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l62.197"></a><span id="l62.197"> </span>
<a href="#l62.198"></a><span id="l62.198" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;mailInterface&quot;)) {</span>
<a href="#l62.199"></a><span id="l62.199" class="difflineminus">-    NS_IF_RELEASE( m_pInterface);</span>
<a href="#l62.200"></a><span id="l62.200" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;mailInterface&quot;)) {</span>
<a href="#l62.201"></a><span id="l62.201" class="difflineplus">+    NS_IF_RELEASE(m_pInterface);</span>
<a href="#l62.202"></a><span id="l62.202">     if (item)</span>
<a href="#l62.203"></a><span id="l62.203" class="difflineminus">-      item-&gt;QueryInterface( NS_GET_IID(nsIImportMail), (void **) &amp;m_pInterface);</span>
<a href="#l62.204"></a><span id="l62.204" class="difflineplus">+      item-&gt;QueryInterface(NS_GET_IID(nsIImportMail), (void **) &amp;m_pInterface);</span>
<a href="#l62.205"></a><span id="l62.205">   }</span>
<a href="#l62.206"></a><span id="l62.206" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;mailBoxes&quot;)) {</span>
<a href="#l62.207"></a><span id="l62.207" class="difflineminus">-    NS_IF_RELEASE( m_pMailboxes);</span>
<a href="#l62.208"></a><span id="l62.208" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;mailBoxes&quot;)) {</span>
<a href="#l62.209"></a><span id="l62.209" class="difflineplus">+    NS_IF_RELEASE(m_pMailboxes);</span>
<a href="#l62.210"></a><span id="l62.210">     if (item)</span>
<a href="#l62.211"></a><span id="l62.211" class="difflineminus">-      item-&gt;QueryInterface( NS_GET_IID(nsISupportsArray), (void **) &amp;m_pMailboxes);</span>
<a href="#l62.212"></a><span id="l62.212" class="difflineplus">+      item-&gt;QueryInterface(NS_GET_IID(nsISupportsArray), (void **) &amp;m_pMailboxes);</span>
<a href="#l62.213"></a><span id="l62.213">   }</span>
<a href="#l62.214"></a><span id="l62.214"> </span>
<a href="#l62.215"></a><span id="l62.215" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;mailLocation&quot;)) {</span>
<a href="#l62.216"></a><span id="l62.216" class="difflineminus">-    NS_IF_RELEASE( m_pMailboxes);</span>
<a href="#l62.217"></a><span id="l62.217" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;mailLocation&quot;)) {</span>
<a href="#l62.218"></a><span id="l62.218" class="difflineplus">+    NS_IF_RELEASE(m_pMailboxes);</span>
<a href="#l62.219"></a><span id="l62.219">     m_pSrcLocation = nsnull;</span>
<a href="#l62.220"></a><span id="l62.220">     if (item) {</span>
<a href="#l62.221"></a><span id="l62.221">       nsresult rv;</span>
<a href="#l62.222"></a><span id="l62.222">       nsCOMPtr &lt;nsILocalFile&gt; location = do_QueryInterface(item, &amp;rv);</span>
<a href="#l62.223"></a><span id="l62.223">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l62.224"></a><span id="l62.224">       m_pSrcLocation = location;</span>
<a href="#l62.225"></a><span id="l62.225">     }</span>
<a href="#l62.226"></a><span id="l62.226">   }</span>
<a href="#l62.227"></a><span id="l62.227"> </span>
<a href="#l62.228"></a><span id="l62.228" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;mailDestination&quot;)) {</span>
<a href="#l62.229"></a><span id="l62.229" class="difflineminus">-    NS_IF_RELEASE( m_pDestFolder);</span>
<a href="#l62.230"></a><span id="l62.230" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;mailDestination&quot;)) {</span>
<a href="#l62.231"></a><span id="l62.231" class="difflineplus">+    NS_IF_RELEASE(m_pDestFolder);</span>
<a href="#l62.232"></a><span id="l62.232">     if (item)</span>
<a href="#l62.233"></a><span id="l62.233" class="difflineminus">-      item-&gt;QueryInterface( NS_GET_IID(nsIMsgFolder), (void **) &amp;m_pDestFolder);</span>
<a href="#l62.234"></a><span id="l62.234" class="difflineplus">+      item-&gt;QueryInterface(NS_GET_IID(nsIMsgFolder), (void **) &amp;m_pDestFolder);</span>
<a href="#l62.235"></a><span id="l62.235">     m_deleteDestFolder = false;</span>
<a href="#l62.236"></a><span id="l62.236">   }</span>
<a href="#l62.237"></a><span id="l62.237"> </span>
<a href="#l62.238"></a><span id="l62.238" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;name&quot;)) {</span>
<a href="#l62.239"></a><span id="l62.239" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;name&quot;)) {</span>
<a href="#l62.240"></a><span id="l62.240">     nsCOMPtr&lt;nsISupportsString&gt; nameString;</span>
<a href="#l62.241"></a><span id="l62.241">     if (item) {</span>
<a href="#l62.242"></a><span id="l62.242" class="difflineminus">-      item-&gt;QueryInterface( NS_GET_IID(nsISupportsString), getter_AddRefs(nameString));</span>
<a href="#l62.243"></a><span id="l62.243" class="difflineplus">+      item-&gt;QueryInterface(NS_GET_IID(nsISupportsString), getter_AddRefs(nameString));</span>
<a href="#l62.244"></a><span id="l62.244">       rv = nameString-&gt;GetData(m_pName);</span>
<a href="#l62.245"></a><span id="l62.245">     }</span>
<a href="#l62.246"></a><span id="l62.246">   }</span>
<a href="#l62.247"></a><span id="l62.247"> </span>
<a href="#l62.248"></a><span id="l62.248" class="difflineminus">-  if (!PL_strcasecmp( dataId, &quot;migration&quot;)) {</span>
<a href="#l62.249"></a><span id="l62.249" class="difflineplus">+  if (!PL_strcasecmp(dataId, &quot;migration&quot;)) {</span>
<a href="#l62.250"></a><span id="l62.250">     nsCOMPtr&lt;nsISupportsPRBool&gt; migrationString;</span>
<a href="#l62.251"></a><span id="l62.251">     if (item) {</span>
<a href="#l62.252"></a><span id="l62.252" class="difflineminus">-      item-&gt;QueryInterface( NS_GET_IID(nsISupportsPRBool), getter_AddRefs(migrationString));</span>
<a href="#l62.253"></a><span id="l62.253" class="difflineplus">+      item-&gt;QueryInterface(NS_GET_IID(nsISupportsPRBool), getter_AddRefs(migrationString));</span>
<a href="#l62.254"></a><span id="l62.254">       rv = migrationString-&gt;GetData(&amp;m_performingMigration);</span>
<a href="#l62.255"></a><span id="l62.255">     }</span>
<a href="#l62.256"></a><span id="l62.256">   }</span>
<a href="#l62.257"></a><span id="l62.257">   return rv;</span>
<a href="#l62.258"></a><span id="l62.258"> }</span>
<a href="#l62.259"></a><span id="l62.259"> </span>
<a href="#l62.260"></a><span id="l62.260" class="difflineminus">-NS_IMETHODIMP nsImportGenericMail::GetStatus( const char *statusKind, PRInt32 *_retval)</span>
<a href="#l62.261"></a><span id="l62.261" class="difflineplus">+NS_IMETHODIMP nsImportGenericMail::GetStatus(const char *statusKind, PRInt32 *_retval)</span>
<a href="#l62.262"></a><span id="l62.262"> {</span>
<a href="#l62.263"></a><span id="l62.263">   NS_PRECONDITION(statusKind != nsnull, &quot;null ptr&quot;);</span>
<a href="#l62.264"></a><span id="l62.264">   NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l62.265"></a><span id="l62.265">   if (!statusKind || !_retval)</span>
<a href="#l62.266"></a><span id="l62.266" class="difflineminus">-    return( NS_ERROR_NULL_POINTER);</span>
<a href="#l62.267"></a><span id="l62.267" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l62.268"></a><span id="l62.268"> </span>
<a href="#l62.269"></a><span id="l62.269">   *_retval = 0;</span>
<a href="#l62.270"></a><span id="l62.270"> </span>
<a href="#l62.271"></a><span id="l62.271" class="difflineminus">-  if (!PL_strcasecmp( statusKind, &quot;isInstalled&quot;)) {</span>
<a href="#l62.272"></a><span id="l62.272" class="difflineplus">+  if (!PL_strcasecmp(statusKind, &quot;isInstalled&quot;)) {</span>
<a href="#l62.273"></a><span id="l62.273">     GetDefaultLocation();</span>
<a href="#l62.274"></a><span id="l62.274">     *_retval = (PRInt32) m_found;</span>
<a href="#l62.275"></a><span id="l62.275">   }</span>
<a href="#l62.276"></a><span id="l62.276"> </span>
<a href="#l62.277"></a><span id="l62.277" class="difflineminus">-  if (!PL_strcasecmp( statusKind, &quot;canUserSetLocation&quot;)) {</span>
<a href="#l62.278"></a><span id="l62.278" class="difflineplus">+  if (!PL_strcasecmp(statusKind, &quot;canUserSetLocation&quot;)) {</span>
<a href="#l62.279"></a><span id="l62.279">     GetDefaultLocation();</span>
<a href="#l62.280"></a><span id="l62.280">     *_retval = (PRInt32) m_userVerify;</span>
<a href="#l62.281"></a><span id="l62.281">   }</span>
<a href="#l62.282"></a><span id="l62.282"> </span>
<a href="#l62.283"></a><span id="l62.283" class="difflineminus">-  return( NS_OK);</span>
<a href="#l62.284"></a><span id="l62.284" class="difflineplus">+  return NS_OK;</span>
<a href="#l62.285"></a><span id="l62.285"> }</span>
<a href="#l62.286"></a><span id="l62.286"> </span>
<a href="#l62.287"></a><span id="l62.287"> </span>
<a href="#l62.288"></a><span id="l62.288" class="difflineminus">-void nsImportGenericMail::GetDefaultLocation( void)</span>
<a href="#l62.289"></a><span id="l62.289" class="difflineplus">+void nsImportGenericMail::GetDefaultLocation(void)</span>
<a href="#l62.290"></a><span id="l62.290"> {</span>
<a href="#l62.291"></a><span id="l62.291">   if (!m_pInterface)</span>
<a href="#l62.292"></a><span id="l62.292">     return;</span>
<a href="#l62.293"></a><span id="l62.293"> </span>
<a href="#l62.294"></a><span id="l62.294">   if (m_pSrcLocation &amp;&amp; m_gotLocation)</span>
<a href="#l62.295"></a><span id="l62.295">     return;</span>
<a href="#l62.296"></a><span id="l62.296"> </span>
<a href="#l62.297"></a><span id="l62.297">   m_gotLocation = true;</span>
<a href="#l62.298"></a><span id="l62.298"> </span>
<a href="#l62.299"></a><span id="l62.299">   nsCOMPtr &lt;nsIFile&gt; pLoc;</span>
<a href="#l62.300"></a><span id="l62.300" class="difflineminus">-  m_pInterface-&gt;GetDefaultLocation( getter_AddRefs(pLoc), &amp;m_found, &amp;m_userVerify);</span>
<a href="#l62.301"></a><span id="l62.301" class="difflineplus">+  m_pInterface-&gt;GetDefaultLocation(getter_AddRefs(pLoc), &amp;m_found, &amp;m_userVerify);</span>
<a href="#l62.302"></a><span id="l62.302">   if (!m_pSrcLocation)</span>
<a href="#l62.303"></a><span id="l62.303">     m_pSrcLocation = pLoc;</span>
<a href="#l62.304"></a><span id="l62.304"> }</span>
<a href="#l62.305"></a><span id="l62.305"> </span>
<a href="#l62.306"></a><span id="l62.306" class="difflineminus">-void nsImportGenericMail::GetDefaultMailboxes( void)</span>
<a href="#l62.307"></a><span id="l62.307" class="difflineplus">+void nsImportGenericMail::GetDefaultMailboxes(void)</span>
<a href="#l62.308"></a><span id="l62.308"> {</span>
<a href="#l62.309"></a><span id="l62.309">   if (!m_pInterface || m_pMailboxes || !m_pSrcLocation)</span>
<a href="#l62.310"></a><span id="l62.310">     return;</span>
<a href="#l62.311"></a><span id="l62.311"> </span>
<a href="#l62.312"></a><span id="l62.312" class="difflineminus">-  m_pInterface-&gt;FindMailboxes( m_pSrcLocation, &amp;m_pMailboxes);</span>
<a href="#l62.313"></a><span id="l62.313" class="difflineplus">+  m_pInterface-&gt;FindMailboxes(m_pSrcLocation, &amp;m_pMailboxes);</span>
<a href="#l62.314"></a><span id="l62.314"> }</span>
<a href="#l62.315"></a><span id="l62.315"> </span>
<a href="#l62.316"></a><span id="l62.316" class="difflineminus">-void nsImportGenericMail::GetDefaultDestination( void)</span>
<a href="#l62.317"></a><span id="l62.317" class="difflineplus">+void nsImportGenericMail::GetDefaultDestination(void)</span>
<a href="#l62.318"></a><span id="l62.318"> {</span>
<a href="#l62.319"></a><span id="l62.319">   if (m_pDestFolder)</span>
<a href="#l62.320"></a><span id="l62.320">     return;</span>
<a href="#l62.321"></a><span id="l62.321">   if (!m_pInterface)</span>
<a href="#l62.322"></a><span id="l62.322">     return;</span>
<a href="#l62.323"></a><span id="l62.323"> </span>
<a href="#l62.324"></a><span id="l62.324">   nsIMsgFolder *  rootFolder;</span>
<a href="#l62.325"></a><span id="l62.325">   m_deleteDestFolder = false;</span>
<a href="#l62.326"></a><span id="l62.326">   m_createdFolder = false;</span>
<a href="#l62.327"></a><span id="l62.327" class="difflineminus">-  if (CreateFolder( &amp;rootFolder)) {</span>
<a href="#l62.328"></a><span id="l62.328" class="difflineplus">+  if (CreateFolder(&amp;rootFolder)) {</span>
<a href="#l62.329"></a><span id="l62.329">     m_pDestFolder = rootFolder;</span>
<a href="#l62.330"></a><span id="l62.330">     m_deleteDestFolder = true;</span>
<a href="#l62.331"></a><span id="l62.331">     m_createdFolder = true;</span>
<a href="#l62.332"></a><span id="l62.332">     return;</span>
<a href="#l62.333"></a><span id="l62.333">   }</span>
<a href="#l62.334"></a><span id="l62.334">   IMPORT_LOG0(&quot;*** GetDefaultDestination: Failed to create a default import destination folder.&quot;);</span>
<a href="#l62.335"></a><span id="l62.335"> }</span>
<a href="#l62.336"></a><span id="l62.336"> </span>
<a href="#l62.337"></a><span id="l62.337" class="difflineat">@@ -445,44 +445,44 @@ NS_IMETHODIMP nsImportGenericMail::Wants</span>
<a href="#l62.338"></a><span id="l62.338"> </span>
<a href="#l62.339"></a><span id="l62.339">   if (m_pMailboxes) {</span>
<a href="#l62.340"></a><span id="l62.340">     PRUint32    i;</span>
<a href="#l62.341"></a><span id="l62.341">     bool        import;</span>
<a href="#l62.342"></a><span id="l62.342">     PRUint32    count = 0;</span>
<a href="#l62.343"></a><span id="l62.343">     nsresult    rv;</span>
<a href="#l62.344"></a><span id="l62.344">     PRUint32    size;</span>
<a href="#l62.345"></a><span id="l62.345"> </span>
<a href="#l62.346"></a><span id="l62.346" class="difflineminus">-    rv = m_pMailboxes-&gt;Count( &amp;count);</span>
<a href="#l62.347"></a><span id="l62.347" class="difflineplus">+    rv = m_pMailboxes-&gt;Count(&amp;count);</span>
<a href="#l62.348"></a><span id="l62.348"> </span>
<a href="#l62.349"></a><span id="l62.349">     for (i = 0; i &lt; count; i++) {</span>
<a href="#l62.350"></a><span id="l62.350">       nsCOMPtr&lt;nsIImportMailboxDescriptor&gt; box =</span>
<a href="#l62.351"></a><span id="l62.351">         do_QueryElementAt(m_pMailboxes, i);</span>
<a href="#l62.352"></a><span id="l62.352">       if (box) {</span>
<a href="#l62.353"></a><span id="l62.353">         import = false;</span>
<a href="#l62.354"></a><span id="l62.354">         size = 0;</span>
<a href="#l62.355"></a><span id="l62.355" class="difflineminus">-        rv = box-&gt;GetImport( &amp;import);</span>
<a href="#l62.356"></a><span id="l62.356" class="difflineplus">+        rv = box-&gt;GetImport(&amp;import);</span>
<a href="#l62.357"></a><span id="l62.357">         if (import) {</span>
<a href="#l62.358"></a><span id="l62.358" class="difflineminus">-          rv = box-&gt;GetSize( &amp;size);</span>
<a href="#l62.359"></a><span id="l62.359" class="difflineplus">+          rv = box-&gt;GetSize(&amp;size);</span>
<a href="#l62.360"></a><span id="l62.360">           result = true;</span>
<a href="#l62.361"></a><span id="l62.361">         }</span>
<a href="#l62.362"></a><span id="l62.362">         totalSize += size;</span>
<a href="#l62.363"></a><span id="l62.363">       }</span>
<a href="#l62.364"></a><span id="l62.364">     }</span>
<a href="#l62.365"></a><span id="l62.365"> </span>
<a href="#l62.366"></a><span id="l62.366">     m_totalSize = totalSize;</span>
<a href="#l62.367"></a><span id="l62.367">   }</span>
<a href="#l62.368"></a><span id="l62.368"> </span>
<a href="#l62.369"></a><span id="l62.369">   m_doImport = result;</span>
<a href="#l62.370"></a><span id="l62.370"> </span>
<a href="#l62.371"></a><span id="l62.371">   *_retval = result;</span>
<a href="#l62.372"></a><span id="l62.372"> </span>
<a href="#l62.373"></a><span id="l62.373" class="difflineminus">-  return( NS_OK);</span>
<a href="#l62.374"></a><span id="l62.374" class="difflineplus">+  return NS_OK;</span>
<a href="#l62.375"></a><span id="l62.375"> }</span>
<a href="#l62.376"></a><span id="l62.376"> </span>
<a href="#l62.377"></a><span id="l62.377" class="difflineminus">-void nsImportGenericMail::GetMailboxName( PRUint32 index, nsISupportsString *pStr)</span>
<a href="#l62.378"></a><span id="l62.378" class="difflineplus">+void nsImportGenericMail::GetMailboxName(PRUint32 index, nsISupportsString *pStr)</span>
<a href="#l62.379"></a><span id="l62.379"> {</span>
<a href="#l62.380"></a><span id="l62.380">   if (m_pMailboxes) {</span>
<a href="#l62.381"></a><span id="l62.381">     nsCOMPtr&lt;nsIImportMailboxDescriptor&gt; box(do_QueryElementAt(m_pMailboxes, index));</span>
<a href="#l62.382"></a><span id="l62.382">     if (box) {</span>
<a href="#l62.383"></a><span id="l62.383">       nsAutoString name;</span>
<a href="#l62.384"></a><span id="l62.384">       box-&gt;GetDisplayName(getter_Copies(name));</span>
<a href="#l62.385"></a><span id="l62.385">       if (!name.IsEmpty()) {</span>
<a href="#l62.386"></a><span id="l62.386">         pStr-&gt;SetData(name);</span>
<a href="#l62.387"></a><span id="l62.387" class="difflineat">@@ -498,125 +498,125 @@ NS_IMETHODIMP nsImportGenericMail::Begin</span>
<a href="#l62.388"></a><span id="l62.388">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l62.389"></a><span id="l62.389"> </span>
<a href="#l62.390"></a><span id="l62.390">   nsString  success;</span>
<a href="#l62.391"></a><span id="l62.391">   nsString  error;</span>
<a href="#l62.392"></a><span id="l62.392"> </span>
<a href="#l62.393"></a><span id="l62.393">   if (!m_doImport) {</span>
<a href="#l62.394"></a><span id="l62.394">     nsImportStringBundle::GetStringByID(IMPORT_NO_MAILBOXES,</span>
<a href="#l62.395"></a><span id="l62.395">                                         m_stringBundle, success);</span>
<a href="#l62.396"></a><span id="l62.396" class="difflineminus">-    SetLogs( success, error, successLog, errorLog);</span>
<a href="#l62.397"></a><span id="l62.397" class="difflineplus">+    SetLogs(success, error, successLog, errorLog);</span>
<a href="#l62.398"></a><span id="l62.398">     *_retval = true;</span>
<a href="#l62.399"></a><span id="l62.399" class="difflineminus">-    return( NS_OK);</span>
<a href="#l62.400"></a><span id="l62.400" class="difflineplus">+    return NS_OK;</span>
<a href="#l62.401"></a><span id="l62.401">   }</span>
<a href="#l62.402"></a><span id="l62.402"> </span>
<a href="#l62.403"></a><span id="l62.403">   if (!m_pInterface || !m_pMailboxes) {</span>
<a href="#l62.404"></a><span id="l62.404" class="difflineminus">-    IMPORT_LOG0( &quot;*** BeginImport: Either the interface or source mailbox is not set properly.&quot;);</span>
<a href="#l62.405"></a><span id="l62.405" class="difflineplus">+    IMPORT_LOG0(&quot;*** BeginImport: Either the interface or source mailbox is not set properly.&quot;);</span>
<a href="#l62.406"></a><span id="l62.406">     nsImportStringBundle::GetStringByID(IMPORT_ERROR_MB_NOTINITIALIZED,</span>
<a href="#l62.407"></a><span id="l62.407">                                         m_stringBundle, error);</span>
<a href="#l62.408"></a><span id="l62.408" class="difflineminus">-    SetLogs( success, error, successLog, errorLog);</span>
<a href="#l62.409"></a><span id="l62.409" class="difflineplus">+    SetLogs(success, error, successLog, errorLog);</span>
<a href="#l62.410"></a><span id="l62.410">     *_retval = false;</span>
<a href="#l62.411"></a><span id="l62.411" class="difflineminus">-    return( NS_OK);</span>
<a href="#l62.412"></a><span id="l62.412" class="difflineplus">+    return NS_OK;</span>
<a href="#l62.413"></a><span id="l62.413">   }</span>
<a href="#l62.414"></a><span id="l62.414"> </span>
<a href="#l62.415"></a><span id="l62.415">   if (!m_pDestFolder) {</span>
<a href="#l62.416"></a><span id="l62.416" class="difflineminus">-    IMPORT_LOG0( &quot;*** BeginImport: The destination mailbox is not set properly.&quot;);</span>
<a href="#l62.417"></a><span id="l62.417" class="difflineplus">+    IMPORT_LOG0(&quot;*** BeginImport: The destination mailbox is not set properly.&quot;);</span>
<a href="#l62.418"></a><span id="l62.418">     nsImportStringBundle::GetStringByID(IMPORT_ERROR_MB_NODESTFOLDER,</span>
<a href="#l62.419"></a><span id="l62.419">                                         m_stringBundle, error);</span>
<a href="#l62.420"></a><span id="l62.420" class="difflineminus">-    SetLogs( success, error, successLog, errorLog);</span>
<a href="#l62.421"></a><span id="l62.421" class="difflineplus">+    SetLogs(success, error, successLog, errorLog);</span>
<a href="#l62.422"></a><span id="l62.422">     *_retval = false;</span>
<a href="#l62.423"></a><span id="l62.423" class="difflineminus">-    return( NS_OK);</span>
<a href="#l62.424"></a><span id="l62.424" class="difflineplus">+    return NS_OK;</span>
<a href="#l62.425"></a><span id="l62.425">   }</span>
<a href="#l62.426"></a><span id="l62.426"> </span>
<a href="#l62.427"></a><span id="l62.427">   if (m_pThreadData) {</span>
<a href="#l62.428"></a><span id="l62.428">     m_pThreadData-&gt;DriverAbort();</span>
<a href="#l62.429"></a><span id="l62.429">     m_pThreadData = nsnull;</span>
<a href="#l62.430"></a><span id="l62.430">   }</span>
<a href="#l62.431"></a><span id="l62.431"> </span>
<a href="#l62.432"></a><span id="l62.432" class="difflineminus">-  NS_IF_RELEASE( m_pSuccessLog);</span>
<a href="#l62.433"></a><span id="l62.433" class="difflineminus">-  NS_IF_RELEASE( m_pErrorLog);</span>
<a href="#l62.434"></a><span id="l62.434" class="difflineplus">+  NS_IF_RELEASE(m_pSuccessLog);</span>
<a href="#l62.435"></a><span id="l62.435" class="difflineplus">+  NS_IF_RELEASE(m_pErrorLog);</span>
<a href="#l62.436"></a><span id="l62.436">   m_pSuccessLog = successLog;</span>
<a href="#l62.437"></a><span id="l62.437">   m_pErrorLog = errorLog;</span>
<a href="#l62.438"></a><span id="l62.438" class="difflineminus">-  NS_IF_ADDREF( m_pSuccessLog);</span>
<a href="#l62.439"></a><span id="l62.439" class="difflineminus">-  NS_IF_ADDREF( m_pErrorLog);</span>
<a href="#l62.440"></a><span id="l62.440" class="difflineplus">+  NS_IF_ADDREF(m_pSuccessLog);</span>
<a href="#l62.441"></a><span id="l62.441" class="difflineplus">+  NS_IF_ADDREF(m_pErrorLog);</span>
<a href="#l62.442"></a><span id="l62.442"> </span>
<a href="#l62.443"></a><span id="l62.443"> </span>
<a href="#l62.444"></a><span id="l62.444">   // kick off the thread to do the import!!!!</span>
<a href="#l62.445"></a><span id="l62.445">   m_pThreadData = new ImportThreadData();</span>
<a href="#l62.446"></a><span id="l62.446">   m_pThreadData-&gt;boxes = m_pMailboxes;</span>
<a href="#l62.447"></a><span id="l62.447" class="difflineminus">-  NS_ADDREF( m_pMailboxes);</span>
<a href="#l62.448"></a><span id="l62.448" class="difflineplus">+  NS_ADDREF(m_pMailboxes);</span>
<a href="#l62.449"></a><span id="l62.449">   m_pThreadData-&gt;mailImport = m_pInterface;</span>
<a href="#l62.450"></a><span id="l62.450" class="difflineminus">-  NS_ADDREF( m_pInterface);</span>
<a href="#l62.451"></a><span id="l62.451" class="difflineplus">+  NS_ADDREF(m_pInterface);</span>
<a href="#l62.452"></a><span id="l62.452">   m_pThreadData-&gt;errorLog = m_pErrorLog;</span>
<a href="#l62.453"></a><span id="l62.453" class="difflineminus">-  NS_IF_ADDREF( m_pErrorLog);</span>
<a href="#l62.454"></a><span id="l62.454" class="difflineplus">+  NS_IF_ADDREF(m_pErrorLog);</span>
<a href="#l62.455"></a><span id="l62.455">   m_pThreadData-&gt;successLog = m_pSuccessLog;</span>
<a href="#l62.456"></a><span id="l62.456" class="difflineminus">-  NS_IF_ADDREF( m_pSuccessLog);</span>
<a href="#l62.457"></a><span id="l62.457" class="difflineplus">+  NS_IF_ADDREF(m_pSuccessLog);</span>
<a href="#l62.458"></a><span id="l62.458"> </span>
<a href="#l62.459"></a><span id="l62.459">   m_pThreadData-&gt;ownsDestRoot = m_deleteDestFolder;</span>
<a href="#l62.460"></a><span id="l62.460">   m_pThreadData-&gt;destRoot = m_pDestFolder;</span>
<a href="#l62.461"></a><span id="l62.461">     m_pThreadData-&gt;performingMigration = m_performingMigration;</span>
<a href="#l62.462"></a><span id="l62.462" class="difflineminus">-  NS_IF_ADDREF( m_pDestFolder);</span>
<a href="#l62.463"></a><span id="l62.463" class="difflineplus">+  NS_IF_ADDREF(m_pDestFolder);</span>
<a href="#l62.464"></a><span id="l62.464"> </span>
<a href="#l62.465"></a><span id="l62.465">   NS_IF_ADDREF(m_pThreadData-&gt;stringBundle = m_stringBundle);</span>
<a href="#l62.466"></a><span id="l62.466"> </span>
<a href="#l62.467"></a><span id="l62.467" class="difflineminus">-  PRThread *pThread = PR_CreateThread( PR_USER_THREAD, &amp;ImportMailThread, m_pThreadData,</span>
<a href="#l62.468"></a><span id="l62.468" class="difflineplus">+  PRThread *pThread = PR_CreateThread(PR_USER_THREAD, &amp;ImportMailThread, m_pThreadData,</span>
<a href="#l62.469"></a><span id="l62.469">                   PR_PRIORITY_NORMAL,</span>
<a href="#l62.470"></a><span id="l62.470">                   PR_LOCAL_THREAD,</span>
<a href="#l62.471"></a><span id="l62.471">                   PR_UNJOINABLE_THREAD,</span>
<a href="#l62.472"></a><span id="l62.472">                   0);</span>
<a href="#l62.473"></a><span id="l62.473">   if (!pThread) {</span>
<a href="#l62.474"></a><span id="l62.474">     m_pThreadData-&gt;ThreadDelete();</span>
<a href="#l62.475"></a><span id="l62.475">     m_pThreadData-&gt;abort = true;</span>
<a href="#l62.476"></a><span id="l62.476">     m_pThreadData-&gt;DriverAbort();</span>
<a href="#l62.477"></a><span id="l62.477">     m_pThreadData = nsnull;</span>
<a href="#l62.478"></a><span id="l62.478">     *_retval = false;</span>
<a href="#l62.479"></a><span id="l62.479">     nsImportStringBundle::GetStringByID(IMPORT_ERROR_MB_NOTHREAD,</span>
<a href="#l62.480"></a><span id="l62.480">                                         m_stringBundle, error);</span>
<a href="#l62.481"></a><span id="l62.481" class="difflineminus">-    SetLogs( success, error, successLog, errorLog);</span>
<a href="#l62.482"></a><span id="l62.482" class="difflineplus">+    SetLogs(success, error, successLog, errorLog);</span>
<a href="#l62.483"></a><span id="l62.483">   }</span>
<a href="#l62.484"></a><span id="l62.484">   else</span>
<a href="#l62.485"></a><span id="l62.485">     *_retval = true;</span>
<a href="#l62.486"></a><span id="l62.486"> </span>
<a href="#l62.487"></a><span id="l62.487" class="difflineminus">-  return( NS_OK);</span>
<a href="#l62.488"></a><span id="l62.488" class="difflineplus">+  return NS_OK;</span>
<a href="#l62.489"></a><span id="l62.489"> </span>
<a href="#l62.490"></a><span id="l62.490"> }</span>
<a href="#l62.491"></a><span id="l62.491"> </span>
<a href="#l62.492"></a><span id="l62.492"> </span>
<a href="#l62.493"></a><span id="l62.493"> NS_IMETHODIMP nsImportGenericMail::ContinueImport(bool *_retval)</span>
<a href="#l62.494"></a><span id="l62.494"> {</span>
<a href="#l62.495"></a><span id="l62.495">     NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l62.496"></a><span id="l62.496">     if (!_retval)</span>
<a href="#l62.497"></a><span id="l62.497">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l62.498"></a><span id="l62.498"> </span>
<a href="#l62.499"></a><span id="l62.499">   *_retval = true;</span>
<a href="#l62.500"></a><span id="l62.500">   if (m_pThreadData) {</span>
<a href="#l62.501"></a><span id="l62.501">     if (m_pThreadData-&gt;fatalError)</span>
<a href="#l62.502"></a><span id="l62.502">       *_retval = false;</span>
<a href="#l62.503"></a><span id="l62.503">   }</span>
<a href="#l62.504"></a><span id="l62.504"> </span>
<a href="#l62.505"></a><span id="l62.505" class="difflineminus">-  return( NS_OK);</span>
<a href="#l62.506"></a><span id="l62.506" class="difflineplus">+  return NS_OK;</span>
<a href="#l62.507"></a><span id="l62.507"> }</span>
<a href="#l62.508"></a><span id="l62.508"> </span>
<a href="#l62.509"></a><span id="l62.509"> </span>
<a href="#l62.510"></a><span id="l62.510"> NS_IMETHODIMP nsImportGenericMail::GetProgress(PRInt32 *_retval)</span>
<a href="#l62.511"></a><span id="l62.511"> {</span>
<a href="#l62.512"></a><span id="l62.512">   // This returns the progress from the the currently</span>
<a href="#l62.513"></a><span id="l62.513">   // running import mail or import address book thread.</span>
<a href="#l62.514"></a><span id="l62.514">     NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l62.515"></a><span id="l62.515">     if (!_retval)</span>
<a href="#l62.516"></a><span id="l62.516">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l62.517"></a><span id="l62.517"> </span>
<a href="#l62.518"></a><span id="l62.518">   if (!m_pThreadData || !(m_pThreadData-&gt;threadAlive)) {</span>
<a href="#l62.519"></a><span id="l62.519">     *_retval = 100;</span>
<a href="#l62.520"></a><span id="l62.520" class="difflineminus">-    return( NS_OK);</span>
<a href="#l62.521"></a><span id="l62.521" class="difflineplus">+    return NS_OK;</span>
<a href="#l62.522"></a><span id="l62.522">   }</span>
<a href="#l62.523"></a><span id="l62.523"> </span>
<a href="#l62.524"></a><span id="l62.524">   PRUint32 sz = 0;</span>
<a href="#l62.525"></a><span id="l62.525">   if (m_pThreadData-&gt;currentSize &amp;&amp; m_pInterface) {</span>
<a href="#l62.526"></a><span id="l62.526" class="difflineminus">-    if (NS_FAILED( m_pInterface-&gt;GetImportProgress( &amp;sz)))</span>
<a href="#l62.527"></a><span id="l62.527" class="difflineplus">+    if (NS_FAILED(m_pInterface-&gt;GetImportProgress(&amp;sz)))</span>
<a href="#l62.528"></a><span id="l62.528">       sz = 0;</span>
<a href="#l62.529"></a><span id="l62.529">   }</span>
<a href="#l62.530"></a><span id="l62.530"> </span>
<a href="#l62.531"></a><span id="l62.531"> </span>
<a href="#l62.532"></a><span id="l62.532">   // *_retval = (PRInt32) (((PRUint32)(m_pThreadData-&gt;currentTotal + sz) * (PRUint32)100) / m_totalSize);</span>
<a href="#l62.533"></a><span id="l62.533"> </span>
<a href="#l62.534"></a><span id="l62.534">   if (m_totalSize) {</span>
<a href="#l62.535"></a><span id="l62.535">     PRFloat64  perc;</span>
<a href="#l62.536"></a><span id="l62.536" class="difflineat">@@ -630,29 +630,29 @@ NS_IMETHODIMP nsImportGenericMail::GetPr</span>
<a href="#l62.537"></a><span id="l62.537">   }</span>
<a href="#l62.538"></a><span id="l62.538">   else</span>
<a href="#l62.539"></a><span id="l62.539">     *_retval = 0;</span>
<a href="#l62.540"></a><span id="l62.540"> </span>
<a href="#l62.541"></a><span id="l62.541">   // never return 100% while the thread is still alive</span>
<a href="#l62.542"></a><span id="l62.542">   if (*_retval &gt; 99)</span>
<a href="#l62.543"></a><span id="l62.543">     *_retval = 99;</span>
<a href="#l62.544"></a><span id="l62.544"> </span>
<a href="#l62.545"></a><span id="l62.545" class="difflineminus">-  return( NS_OK);</span>
<a href="#l62.546"></a><span id="l62.546" class="difflineplus">+  return NS_OK;</span>
<a href="#l62.547"></a><span id="l62.547"> }</span>
<a href="#l62.548"></a><span id="l62.548"> </span>
<a href="#l62.549"></a><span id="l62.549"> void nsImportGenericMail::ReportError(PRInt32 id, const PRUnichar *pName, nsString *pStream, nsIStringBundle *aBundle)</span>
<a href="#l62.550"></a><span id="l62.550"> {</span>
<a href="#l62.551"></a><span id="l62.551">   if (!pStream)</span>
<a href="#l62.552"></a><span id="l62.552">     return;</span>
<a href="#l62.553"></a><span id="l62.553"> </span>
<a href="#l62.554"></a><span id="l62.554">   // load the error string</span>
<a href="#l62.555"></a><span id="l62.555">   PRUnichar *pFmt = nsImportStringBundle::GetStringByID(id, aBundle);</span>
<a href="#l62.556"></a><span id="l62.556" class="difflineminus">-  PRUnichar *pText = nsTextFormatter::smprintf( pFmt, pName);</span>
<a href="#l62.557"></a><span id="l62.557" class="difflineminus">-  pStream-&gt;Append( pText);</span>
<a href="#l62.558"></a><span id="l62.558" class="difflineminus">-  nsTextFormatter::smprintf_free( pText);</span>
<a href="#l62.559"></a><span id="l62.559" class="difflineplus">+  PRUnichar *pText = nsTextFormatter::smprintf(pFmt, pName);</span>
<a href="#l62.560"></a><span id="l62.560" class="difflineplus">+  pStream-&gt;Append(pText);</span>
<a href="#l62.561"></a><span id="l62.561" class="difflineplus">+  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l62.562"></a><span id="l62.562">   NS_Free(pFmt);</span>
<a href="#l62.563"></a><span id="l62.563">   pStream-&gt;Append(NS_ConvertASCIItoUTF16(MSG_LINEBREAK));</span>
<a href="#l62.564"></a><span id="l62.564"> }</span>
<a href="#l62.565"></a><span id="l62.565"> </span>
<a href="#l62.566"></a><span id="l62.566"> </span>
<a href="#l62.567"></a><span id="l62.567"> void nsImportGenericMail::SetLogs(nsString&amp; success, nsString&amp; error, nsISupportsString *pSuccess, nsISupportsString *pError)</span>
<a href="#l62.568"></a><span id="l62.568"> {</span>
<a href="#l62.569"></a><span id="l62.569">     nsAutoString str;</span>
<a href="#l62.570"></a><span id="l62.570" class="difflineat">@@ -671,17 +671,17 @@ void nsImportGenericMail::SetLogs(nsStri</span>
<a href="#l62.571"></a><span id="l62.571"> NS_IMETHODIMP nsImportGenericMail::CancelImport(void)</span>
<a href="#l62.572"></a><span id="l62.572"> {</span>
<a href="#l62.573"></a><span id="l62.573">   if (m_pThreadData) {</span>
<a href="#l62.574"></a><span id="l62.574">     m_pThreadData-&gt;abort = true;</span>
<a href="#l62.575"></a><span id="l62.575">     m_pThreadData-&gt;DriverAbort();</span>
<a href="#l62.576"></a><span id="l62.576">     m_pThreadData = nsnull;</span>
<a href="#l62.577"></a><span id="l62.577">   }</span>
<a href="#l62.578"></a><span id="l62.578"> </span>
<a href="#l62.579"></a><span id="l62.579" class="difflineminus">-  return( NS_OK);</span>
<a href="#l62.580"></a><span id="l62.580" class="difflineplus">+  return NS_OK;</span>
<a href="#l62.581"></a><span id="l62.581"> }</span>
<a href="#l62.582"></a><span id="l62.582"> </span>
<a href="#l62.583"></a><span id="l62.583"> </span>
<a href="#l62.584"></a><span id="l62.584"> ImportThreadData::ImportThreadData()</span>
<a href="#l62.585"></a><span id="l62.585"> {</span>
<a href="#l62.586"></a><span id="l62.586">   fatalError = false;</span>
<a href="#l62.587"></a><span id="l62.587">   driverAlive = true;</span>
<a href="#l62.588"></a><span id="l62.588">   threadAlive = true;</span>
<a href="#l62.589"></a><span id="l62.589" class="difflineat">@@ -694,25 +694,25 @@ ImportThreadData::ImportThreadData()</span>
<a href="#l62.590"></a><span id="l62.590">   mailImport = nsnull;</span>
<a href="#l62.591"></a><span id="l62.591">   successLog = nsnull;</span>
<a href="#l62.592"></a><span id="l62.592">   errorLog = nsnull;</span>
<a href="#l62.593"></a><span id="l62.593">   stringBundle = nsnull;</span>
<a href="#l62.594"></a><span id="l62.594"> }</span>
<a href="#l62.595"></a><span id="l62.595"> </span>
<a href="#l62.596"></a><span id="l62.596"> ImportThreadData::~ImportThreadData()</span>
<a href="#l62.597"></a><span id="l62.597"> {</span>
<a href="#l62.598"></a><span id="l62.598" class="difflineminus">-  NS_IF_RELEASE( destRoot);</span>
<a href="#l62.599"></a><span id="l62.599" class="difflineminus">-  NS_IF_RELEASE( boxes);</span>
<a href="#l62.600"></a><span id="l62.600" class="difflineminus">-  NS_IF_RELEASE( mailImport);</span>
<a href="#l62.601"></a><span id="l62.601" class="difflineminus">-  NS_IF_RELEASE( errorLog);</span>
<a href="#l62.602"></a><span id="l62.602" class="difflineminus">-  NS_IF_RELEASE( successLog);</span>
<a href="#l62.603"></a><span id="l62.603" class="difflineminus">-  NS_IF_RELEASE( stringBundle);</span>
<a href="#l62.604"></a><span id="l62.604" class="difflineplus">+  NS_IF_RELEASE(destRoot);</span>
<a href="#l62.605"></a><span id="l62.605" class="difflineplus">+  NS_IF_RELEASE(boxes);</span>
<a href="#l62.606"></a><span id="l62.606" class="difflineplus">+  NS_IF_RELEASE(mailImport);</span>
<a href="#l62.607"></a><span id="l62.607" class="difflineplus">+  NS_IF_RELEASE(errorLog);</span>
<a href="#l62.608"></a><span id="l62.608" class="difflineplus">+  NS_IF_RELEASE(successLog);</span>
<a href="#l62.609"></a><span id="l62.609" class="difflineplus">+  NS_IF_RELEASE(stringBundle);</span>
<a href="#l62.610"></a><span id="l62.610"> }</span>
<a href="#l62.611"></a><span id="l62.611"> </span>
<a href="#l62.612"></a><span id="l62.612" class="difflineminus">-void ImportThreadData::DriverDelete( void)</span>
<a href="#l62.613"></a><span id="l62.613" class="difflineplus">+void ImportThreadData::DriverDelete(void)</span>
<a href="#l62.614"></a><span id="l62.614"> {</span>
<a href="#l62.615"></a><span id="l62.615">   driverAlive = false;</span>
<a href="#l62.616"></a><span id="l62.616">   if (!driverAlive &amp;&amp; !threadAlive)</span>
<a href="#l62.617"></a><span id="l62.617">     delete this;</span>
<a href="#l62.618"></a><span id="l62.618"> }</span>
<a href="#l62.619"></a><span id="l62.619"> </span>
<a href="#l62.620"></a><span id="l62.620"> void ImportThreadData::ThreadDelete()</span>
<a href="#l62.621"></a><span id="l62.621"> {</span>
<a href="#l62.622"></a><span id="l62.622" class="difflineat">@@ -734,38 +734,38 @@ void ImportThreadData::DriverAbort()</span>
<a href="#l62.623"></a><span id="l62.623">   else</span>
<a href="#l62.624"></a><span id="l62.624">     abort = true;</span>
<a href="#l62.625"></a><span id="l62.625">   DriverDelete();</span>
<a href="#l62.626"></a><span id="l62.626"> }</span>
<a href="#l62.627"></a><span id="l62.627"> </span>
<a href="#l62.628"></a><span id="l62.628"> </span>
<a href="#l62.629"></a><span id="l62.629"> </span>
<a href="#l62.630"></a><span id="l62.630"> static void</span>
<a href="#l62.631"></a><span id="l62.631" class="difflineminus">-ImportMailThread( void *stuff)</span>
<a href="#l62.632"></a><span id="l62.632" class="difflineplus">+ImportMailThread(void *stuff)</span>
<a href="#l62.633"></a><span id="l62.633"> {</span>
<a href="#l62.634"></a><span id="l62.634">   ImportThreadData *pData = (ImportThreadData *)stuff;</span>
<a href="#l62.635"></a><span id="l62.635"> </span>
<a href="#l62.636"></a><span id="l62.636">   IMPORT_LOG0(&quot;ImportMailThread: Starting...&quot;);</span>
<a href="#l62.637"></a><span id="l62.637"> </span>
<a href="#l62.638"></a><span id="l62.638">   nsresult rv = NS_OK;</span>
<a href="#l62.639"></a><span id="l62.639"> </span>
<a href="#l62.640"></a><span id="l62.640" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt;    destRoot( pData-&gt;destRoot);</span>
<a href="#l62.641"></a><span id="l62.641" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt;    destRoot(pData-&gt;destRoot);</span>
<a href="#l62.642"></a><span id="l62.642"> </span>
<a href="#l62.643"></a><span id="l62.643">   PRUint32  count = 0;</span>
<a href="#l62.644"></a><span id="l62.644" class="difflineminus">-  rv = pData-&gt;boxes-&gt;Count( &amp;count);</span>
<a href="#l62.645"></a><span id="l62.645" class="difflineplus">+  rv = pData-&gt;boxes-&gt;Count(&amp;count);</span>
<a href="#l62.646"></a><span id="l62.646"> </span>
<a href="#l62.647"></a><span id="l62.647">   PRUint32    i;</span>
<a href="#l62.648"></a><span id="l62.648">   bool        import;</span>
<a href="#l62.649"></a><span id="l62.649">   PRUint32    size;</span>
<a href="#l62.650"></a><span id="l62.650">   PRUint32    depth = 1;</span>
<a href="#l62.651"></a><span id="l62.651">   PRUint32    newDepth;</span>
<a href="#l62.652"></a><span id="l62.652">   nsString    lastName;</span>
<a href="#l62.653"></a><span id="l62.653">   PRUnichar *    pName;</span>
<a href="#l62.654"></a><span id="l62.654"> </span>
<a href="#l62.655"></a><span id="l62.655" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt;    curFolder( destRoot);</span>
<a href="#l62.656"></a><span id="l62.656" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt;    curFolder(destRoot);</span>
<a href="#l62.657"></a><span id="l62.657"> </span>
<a href="#l62.658"></a><span id="l62.658">   nsCOMPtr&lt;nsIMsgFolder&gt;          newFolder;</span>
<a href="#l62.659"></a><span id="l62.659">   nsCOMPtr&lt;nsILocalFile&gt;          outBox;</span>
<a href="#l62.660"></a><span id="l62.660">   nsCOMPtr&lt;nsIMsgFolder&gt;          subFolder;</span>
<a href="#l62.661"></a><span id="l62.661">   nsCOMPtr&lt;nsISimpleEnumerator&gt;   enumerator;</span>
<a href="#l62.662"></a><span id="l62.662"> </span>
<a href="#l62.663"></a><span id="l62.663">   bool              exists;</span>
<a href="#l62.664"></a><span id="l62.664"> </span>
<a href="#l62.665"></a><span id="l62.665" class="difflineat">@@ -783,65 +783,65 @@ ImportMailThread( void *stuff)</span>
<a href="#l62.666"></a><span id="l62.666">   for (i = 0; (i &lt; count) &amp;&amp; !(pData-&gt;abort); i++) {</span>
<a href="#l62.667"></a><span id="l62.667">     nsCOMPtr&lt;nsIImportMailboxDescriptor&gt; box =</span>
<a href="#l62.668"></a><span id="l62.668">       do_QueryElementAt(pData-&gt;boxes, i);</span>
<a href="#l62.669"></a><span id="l62.669">     if (box) {</span>
<a href="#l62.670"></a><span id="l62.670">       pData-&gt;currentMailbox = i;</span>
<a href="#l62.671"></a><span id="l62.671"> </span>
<a href="#l62.672"></a><span id="l62.672">       import = false;</span>
<a href="#l62.673"></a><span id="l62.673">       size = 0;</span>
<a href="#l62.674"></a><span id="l62.674" class="difflineminus">-      rv = box-&gt;GetImport( &amp;import);</span>
<a href="#l62.675"></a><span id="l62.675" class="difflineplus">+      rv = box-&gt;GetImport(&amp;import);</span>
<a href="#l62.676"></a><span id="l62.676">       if (import)</span>
<a href="#l62.677"></a><span id="l62.677" class="difflineminus">-        rv = box-&gt;GetSize( &amp;size);</span>
<a href="#l62.678"></a><span id="l62.678" class="difflineminus">-      rv = box-&gt;GetDepth( &amp;newDepth);</span>
<a href="#l62.679"></a><span id="l62.679" class="difflineplus">+        rv = box-&gt;GetSize(&amp;size);</span>
<a href="#l62.680"></a><span id="l62.680" class="difflineplus">+      rv = box-&gt;GetDepth(&amp;newDepth);</span>
<a href="#l62.681"></a><span id="l62.681">       if (newDepth &gt; depth) {</span>
<a href="#l62.682"></a><span id="l62.682">           // OK, we are going to add a subfolder under the last/previous folder we processed, so</span>
<a href="#l62.683"></a><span id="l62.683">           // find this folder (stored in 'lastName') who is going to be the new parent folder.</span>
<a href="#l62.684"></a><span id="l62.684">         IMPORT_LOG1(&quot;ImportMailThread: Processing child folder '%s'.&quot;, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l62.685"></a><span id="l62.685">         rv = ProxyGetChildNamed(curFolder, lastName, getter_AddRefs(subFolder));</span>
<a href="#l62.686"></a><span id="l62.686" class="difflineminus">-        if (NS_FAILED( rv)) {</span>
<a href="#l62.687"></a><span id="l62.687" class="difflineplus">+        if (NS_FAILED(rv)) {</span>
<a href="#l62.688"></a><span id="l62.688">           IMPORT_LOG1(&quot;*** ImportMailThread: Failed to get the interface for child folder '%s'.&quot;, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l62.689"></a><span id="l62.689">           nsImportGenericMail::ReportError(IMPORT_ERROR_MB_FINDCHILD,</span>
<a href="#l62.690"></a><span id="l62.690">                                            lastName.get(),</span>
<a href="#l62.691"></a><span id="l62.691">                                            &amp;error, pData-&gt;stringBundle);</span>
<a href="#l62.692"></a><span id="l62.692">           pData-&gt;fatalError = true;</span>
<a href="#l62.693"></a><span id="l62.693">           break;</span>
<a href="#l62.694"></a><span id="l62.694">         }</span>
<a href="#l62.695"></a><span id="l62.695">         curFolder = subFolder;</span>
<a href="#l62.696"></a><span id="l62.696">         // Make sure this new parent folder obj has the correct subfolder list so far.</span>
<a href="#l62.697"></a><span id="l62.697">         rv = ProxyGetSubFolders(curFolder, getter_AddRefs(enumerator));</span>
<a href="#l62.698"></a><span id="l62.698">       }</span>
<a href="#l62.699"></a><span id="l62.699">       else if (newDepth &lt; depth) {</span>
<a href="#l62.700"></a><span id="l62.700">         rv = NS_OK;</span>
<a href="#l62.701"></a><span id="l62.701" class="difflineminus">-        while ((newDepth &lt; depth) &amp;&amp; NS_SUCCEEDED( rv)) {</span>
<a href="#l62.702"></a><span id="l62.702" class="difflineplus">+        while ((newDepth &lt; depth) &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l62.703"></a><span id="l62.703">           rv = curFolder-&gt;GetParent(getter_AddRefs(curFolder));</span>
<a href="#l62.704"></a><span id="l62.704" class="difflineminus">-          if (NS_FAILED( rv)) {</span>
<a href="#l62.705"></a><span id="l62.705" class="difflineplus">+          if (NS_FAILED(rv)) {</span>
<a href="#l62.706"></a><span id="l62.706">             IMPORT_LOG1(&quot;*** ImportMailThread: Failed to get the interface for parent folder '%s'.&quot;, lastName.get());</span>
<a href="#l62.707"></a><span id="l62.707">             nsImportGenericMail::ReportError(IMPORT_ERROR_MB_FINDCHILD,</span>
<a href="#l62.708"></a><span id="l62.708">                                              lastName.get(), &amp;error,</span>
<a href="#l62.709"></a><span id="l62.709">                                              pData-&gt;stringBundle);</span>
<a href="#l62.710"></a><span id="l62.710">             pData-&gt;fatalError = true;</span>
<a href="#l62.711"></a><span id="l62.711">             break;</span>
<a href="#l62.712"></a><span id="l62.712">           }</span>
<a href="#l62.713"></a><span id="l62.713">           depth--;</span>
<a href="#l62.714"></a><span id="l62.714">         }</span>
<a href="#l62.715"></a><span id="l62.715" class="difflineminus">-        if (NS_FAILED( rv)) {</span>
<a href="#l62.716"></a><span id="l62.716" class="difflineplus">+        if (NS_FAILED(rv)) {</span>
<a href="#l62.717"></a><span id="l62.717">           IMPORT_LOG1(&quot;*** ImportMailThread: Failed to get the proxy interface for parent folder '%s'.&quot;, lastName.get());</span>
<a href="#l62.718"></a><span id="l62.718">           nsImportStringBundle::GetStringByID(IMPORT_ERROR_MB_NOPROXY,</span>
<a href="#l62.719"></a><span id="l62.719">                                               pData-&gt;stringBundle, error);</span>
<a href="#l62.720"></a><span id="l62.720">           pData-&gt;fatalError = true;</span>
<a href="#l62.721"></a><span id="l62.721">           break;</span>
<a href="#l62.722"></a><span id="l62.722">         }</span>
<a href="#l62.723"></a><span id="l62.723">       }</span>
<a href="#l62.724"></a><span id="l62.724">       depth = newDepth;</span>
<a href="#l62.725"></a><span id="l62.725">       pName = nsnull;</span>
<a href="#l62.726"></a><span id="l62.726" class="difflineminus">-      box-&gt;GetDisplayName( &amp;pName);</span>
<a href="#l62.727"></a><span id="l62.727" class="difflineplus">+      box-&gt;GetDisplayName(&amp;pName);</span>
<a href="#l62.728"></a><span id="l62.728">       if (pName) {</span>
<a href="#l62.729"></a><span id="l62.729">         lastName = pName;</span>
<a href="#l62.730"></a><span id="l62.730" class="difflineminus">-        NS_Free( pName);</span>
<a href="#l62.731"></a><span id="l62.731" class="difflineplus">+        NS_Free(pName);</span>
<a href="#l62.732"></a><span id="l62.732">       }</span>
<a href="#l62.733"></a><span id="l62.733">       else</span>
<a href="#l62.734"></a><span id="l62.734">         lastName.AssignLiteral(&quot;Unknown!&quot;);</span>
<a href="#l62.735"></a><span id="l62.735"> </span>
<a href="#l62.736"></a><span id="l62.736">       // translate the folder name if we are doing migration, but</span>
<a href="#l62.737"></a><span id="l62.737">       // only for special folders which are at the root level</span>
<a href="#l62.738"></a><span id="l62.738">       if (pData-&gt;performingMigration &amp;&amp; depth == 1)</span>
<a href="#l62.739"></a><span id="l62.739">         pData-&gt;mailImport-&gt;TranslateFolderName(lastName, lastName);</span>
<a href="#l62.740"></a><span id="l62.740" class="difflineat">@@ -864,86 +864,86 @@ ImportMailThread( void *stuff)</span>
<a href="#l62.741"></a><span id="l62.741">       ProxyCreateSubfolder(curFolder, lastName); // this may fail if the folder already exists..that's ok</span>
<a href="#l62.742"></a><span id="l62.742"> </span>
<a href="#l62.743"></a><span id="l62.743">       rv = ProxyGetChildNamed(curFolder, lastName, getter_AddRefs(newFolder));</span>
<a href="#l62.744"></a><span id="l62.744">       if (NS_SUCCEEDED(rv))</span>
<a href="#l62.745"></a><span id="l62.745">         newFolder-&gt;GetFilePath(getter_AddRefs(outBox));</span>
<a href="#l62.746"></a><span id="l62.746">       else</span>
<a href="#l62.747"></a><span id="l62.747">         IMPORT_LOG1(&quot;*** ImportMailThread: Failed to locate subfolder '%s' after it's been created.&quot;, lastName.get());</span>
<a href="#l62.748"></a><span id="l62.748"> </span>
<a href="#l62.749"></a><span id="l62.749" class="difflineminus">-      if (NS_FAILED( rv)) {</span>
<a href="#l62.750"></a><span id="l62.750" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l62.751"></a><span id="l62.751">         nsImportGenericMail::ReportError(IMPORT_ERROR_MB_CREATE, lastName.get(),</span>
<a href="#l62.752"></a><span id="l62.752">                                          &amp;error, pData-&gt;stringBundle);</span>
<a href="#l62.753"></a><span id="l62.753">       }</span>
<a href="#l62.754"></a><span id="l62.754"> </span>
<a href="#l62.755"></a><span id="l62.755" class="difflineminus">-      if (size &amp;&amp; import &amp;&amp; newFolder &amp;&amp; outBox &amp;&amp; NS_SUCCEEDED( rv)) {</span>
<a href="#l62.756"></a><span id="l62.756" class="difflineplus">+      if (size &amp;&amp; import &amp;&amp; newFolder &amp;&amp; outBox &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l62.757"></a><span id="l62.757">         bool fatalError = false;</span>
<a href="#l62.758"></a><span id="l62.758">         pData-&gt;currentSize = size;</span>
<a href="#l62.759"></a><span id="l62.759">         PRUnichar *pSuccess = nsnull;</span>
<a href="#l62.760"></a><span id="l62.760">         PRUnichar *pError = nsnull;</span>
<a href="#l62.761"></a><span id="l62.761" class="difflineminus">-        rv = pData-&gt;mailImport-&gt;ImportMailbox( box, outBox, &amp;pError, &amp;pSuccess, &amp;fatalError);</span>
<a href="#l62.762"></a><span id="l62.762" class="difflineplus">+        rv = pData-&gt;mailImport-&gt;ImportMailbox(box, outBox, &amp;pError, &amp;pSuccess, &amp;fatalError);</span>
<a href="#l62.763"></a><span id="l62.763">         if (pError) {</span>
<a href="#l62.764"></a><span id="l62.764" class="difflineminus">-          error.Append( pError);</span>
<a href="#l62.765"></a><span id="l62.765" class="difflineminus">-          NS_Free( pError);</span>
<a href="#l62.766"></a><span id="l62.766" class="difflineplus">+          error.Append(pError);</span>
<a href="#l62.767"></a><span id="l62.767" class="difflineplus">+          NS_Free(pError);</span>
<a href="#l62.768"></a><span id="l62.768">         }</span>
<a href="#l62.769"></a><span id="l62.769">         if (pSuccess) {</span>
<a href="#l62.770"></a><span id="l62.770" class="difflineminus">-          success.Append( pSuccess);</span>
<a href="#l62.771"></a><span id="l62.771" class="difflineminus">-          NS_Free( pSuccess);</span>
<a href="#l62.772"></a><span id="l62.772" class="difflineplus">+          success.Append(pSuccess);</span>
<a href="#l62.773"></a><span id="l62.773" class="difflineplus">+          NS_Free(pSuccess);</span>
<a href="#l62.774"></a><span id="l62.774">         }</span>
<a href="#l62.775"></a><span id="l62.775"> </span>
<a href="#l62.776"></a><span id="l62.776">         pData-&gt;currentSize = 0;</span>
<a href="#l62.777"></a><span id="l62.777">         pData-&gt;currentTotal += size;</span>
<a href="#l62.778"></a><span id="l62.778">         </span>
<a href="#l62.779"></a><span id="l62.779">         // commit to the db synchronously, but using a proxy since it doesn't like being used</span>
<a href="#l62.780"></a><span id="l62.780">         // elsewhere than from the main thread.</span>
<a href="#l62.781"></a><span id="l62.781">         // OK, we've copied the actual folder/file over if the folder size is not 0</span>
<a href="#l62.782"></a><span id="l62.782">         // (ie, the msg summary is no longer valid) so close the msg database so that</span>
<a href="#l62.783"></a><span id="l62.783">         // when the folder is reopened the folder db can be reconstructed (which</span>
<a href="#l62.784"></a><span id="l62.784">         // validates msg summary and forces folder to be reparsed).</span>
<a href="#l62.785"></a><span id="l62.785">         rv = ProxyForceDBClosed(newFolder);</span>
<a href="#l62.786"></a><span id="l62.786">         fatalError = NS_FAILED(rv);</span>
<a href="#l62.787"></a><span id="l62.787"> </span>
<a href="#l62.788"></a><span id="l62.788">         if (fatalError) {</span>
<a href="#l62.789"></a><span id="l62.789" class="difflineminus">-          IMPORT_LOG1( &quot;*** ImportMailThread: ImportMailbox returned fatalError, mailbox #%d\n&quot;, (int) i);</span>
<a href="#l62.790"></a><span id="l62.790" class="difflineplus">+          IMPORT_LOG1(&quot;*** ImportMailThread: ImportMailbox returned fatalError, mailbox #%d\n&quot;, (int) i);</span>
<a href="#l62.791"></a><span id="l62.791">           pData-&gt;fatalError = true;</span>
<a href="#l62.792"></a><span id="l62.792">           break;</span>
<a href="#l62.793"></a><span id="l62.793">         }</span>
<a href="#l62.794"></a><span id="l62.794">       }</span>
<a href="#l62.795"></a><span id="l62.795">     }</span>
<a href="#l62.796"></a><span id="l62.796">   }</span>
<a href="#l62.797"></a><span id="l62.797"> </span>
<a href="#l62.798"></a><span id="l62.798">   // Now save the new acct info to pref file.</span>
<a href="#l62.799"></a><span id="l62.799">   nsCOMPtr &lt;nsIMsgAccountManager&gt; accMgr = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l62.800"></a><span id="l62.800">         if (NS_SUCCEEDED(rv) &amp;&amp; accMgr) {</span>
<a href="#l62.801"></a><span id="l62.801">     rv = accMgr-&gt;SaveAccountInfo();</span>
<a href="#l62.802"></a><span id="l62.802">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Can't save account info to pref file&quot;);</span>
<a href="#l62.803"></a><span id="l62.803">   }</span>
<a href="#l62.804"></a><span id="l62.804"> </span>
<a href="#l62.805"></a><span id="l62.805" class="difflineminus">-  nsImportGenericMail::SetLogs( success, error, pData-&gt;successLog, pData-&gt;errorLog);</span>
<a href="#l62.806"></a><span id="l62.806" class="difflineplus">+  nsImportGenericMail::SetLogs(success, error, pData-&gt;successLog, pData-&gt;errorLog);</span>
<a href="#l62.807"></a><span id="l62.807"> </span>
<a href="#l62.808"></a><span id="l62.808">   if (pData-&gt;abort || pData-&gt;fatalError) {</span>
<a href="#l62.809"></a><span id="l62.809" class="difflineminus">-    IMPORT_LOG0( &quot;*** ImportMailThread: Abort or fatalError flag was set\n&quot;);</span>
<a href="#l62.810"></a><span id="l62.810" class="difflineplus">+    IMPORT_LOG0(&quot;*** ImportMailThread: Abort or fatalError flag was set\n&quot;);</span>
<a href="#l62.811"></a><span id="l62.811">     if (pData-&gt;ownsDestRoot) {</span>
<a href="#l62.812"></a><span id="l62.812" class="difflineminus">-      IMPORT_LOG0( &quot;Calling destRoot-&gt;RecursiveDelete\n&quot;);</span>
<a href="#l62.813"></a><span id="l62.813" class="difflineminus">-      destRoot-&gt;RecursiveDelete( true, nsnull);</span>
<a href="#l62.814"></a><span id="l62.814" class="difflineplus">+      IMPORT_LOG0(&quot;Calling destRoot-&gt;RecursiveDelete\n&quot;);</span>
<a href="#l62.815"></a><span id="l62.815" class="difflineplus">+      destRoot-&gt;RecursiveDelete(true, nsnull);</span>
<a href="#l62.816"></a><span id="l62.816">     }</span>
<a href="#l62.817"></a><span id="l62.817">     else {</span>
<a href="#l62.818"></a><span id="l62.818">       // FIXME: just delete the stuff we created?</span>
<a href="#l62.819"></a><span id="l62.819">     }</span>
<a href="#l62.820"></a><span id="l62.820">   }</span>
<a href="#l62.821"></a><span id="l62.821"> </span>
<a href="#l62.822"></a><span id="l62.822" class="difflineminus">-  IMPORT_LOG1( &quot;Import mailbox thread done: %d\n&quot;, (int) pData-&gt;currentTotal);</span>
<a href="#l62.823"></a><span id="l62.823" class="difflineplus">+  IMPORT_LOG1(&quot;Import mailbox thread done: %d\n&quot;, (int) pData-&gt;currentTotal);</span>
<a href="#l62.824"></a><span id="l62.824"> </span>
<a href="#l62.825"></a><span id="l62.825">   pData-&gt;ThreadDelete();</span>
<a href="#l62.826"></a><span id="l62.826"> </span>
<a href="#l62.827"></a><span id="l62.827"> }</span>
<a href="#l62.828"></a><span id="l62.828"> </span>
<a href="#l62.829"></a><span id="l62.829"> // Creates a folder in Local Folders with the module name + mail</span>
<a href="#l62.830"></a><span id="l62.830"> // for e.g: Outlook Mail</span>
<a href="#l62.831"></a><span id="l62.831" class="difflineminus">-bool nsImportGenericMail::CreateFolder( nsIMsgFolder **ppFolder)</span>
<a href="#l62.832"></a><span id="l62.832" class="difflineplus">+bool nsImportGenericMail::CreateFolder(nsIMsgFolder **ppFolder)</span>
<a href="#l62.833"></a><span id="l62.833"> {</span>
<a href="#l62.834"></a><span id="l62.834">   nsresult rv;</span>
<a href="#l62.835"></a><span id="l62.835">   *ppFolder = nsnull;</span>
<a href="#l62.836"></a><span id="l62.836"> </span>
<a href="#l62.837"></a><span id="l62.837">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l62.838"></a><span id="l62.838">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l62.839"></a><span id="l62.839">     mozilla::services::GetStringBundleService();</span>
<a href="#l62.840"></a><span id="l62.840">   if (!bundleService)</span>
<a href="#l62.841"></a><span id="l62.841" class="difflineat">@@ -958,33 +958,33 @@ bool nsImportGenericMail::CreateFolder( </span>
<a href="#l62.842"></a><span id="l62.842">                                       moduleName, 1,</span>
<a href="#l62.843"></a><span id="l62.843">                                       getter_Copies(folderName));</span>
<a href="#l62.844"></a><span id="l62.844">   }</span>
<a href="#l62.845"></a><span id="l62.845">   else {</span>
<a href="#l62.846"></a><span id="l62.846">     rv = bundle-&gt;GetStringFromName(NS_LITERAL_STRING(&quot;DefaultFolderName&quot;).get(),</span>
<a href="#l62.847"></a><span id="l62.847">                                    getter_Copies(folderName));</span>
<a href="#l62.848"></a><span id="l62.848">   }</span>
<a href="#l62.849"></a><span id="l62.849">   if (NS_FAILED(rv)) {</span>
<a href="#l62.850"></a><span id="l62.850" class="difflineminus">-      IMPORT_LOG0( &quot;*** Failed to get Folder Name!\n&quot;);</span>
<a href="#l62.851"></a><span id="l62.851" class="difflineplus">+      IMPORT_LOG0(&quot;*** Failed to get Folder Name!\n&quot;);</span>
<a href="#l62.852"></a><span id="l62.852">       return false;</span>
<a href="#l62.853"></a><span id="l62.853">   }</span>
<a href="#l62.854"></a><span id="l62.854">   nsCOMPtr &lt;nsIMsgAccountManager&gt; accMgr = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l62.855"></a><span id="l62.855">   if (NS_FAILED(rv)) {</span>
<a href="#l62.856"></a><span id="l62.856" class="difflineminus">-    IMPORT_LOG0( &quot;*** Failed to create account manager!\n&quot;);</span>
<a href="#l62.857"></a><span id="l62.857" class="difflineplus">+    IMPORT_LOG0(&quot;*** Failed to create account manager!\n&quot;);</span>
<a href="#l62.858"></a><span id="l62.858">     return false;</span>
<a href="#l62.859"></a><span id="l62.859">   }</span>
<a href="#l62.860"></a><span id="l62.860"> </span>
<a href="#l62.861"></a><span id="l62.861">   nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l62.862"></a><span id="l62.862">   rv = accMgr-&gt;GetLocalFoldersServer(getter_AddRefs(server));</span>
<a href="#l62.863"></a><span id="l62.863">   // if Local Folders does not exist already, create it</span>
<a href="#l62.864"></a><span id="l62.864">   if (NS_FAILED(rv) || !server)</span>
<a href="#l62.865"></a><span id="l62.865">   {</span>
<a href="#l62.866"></a><span id="l62.866">     rv = accMgr-&gt;CreateLocalMailAccount();</span>
<a href="#l62.867"></a><span id="l62.867">     if (NS_FAILED(rv)) {</span>
<a href="#l62.868"></a><span id="l62.868" class="difflineminus">-      IMPORT_LOG0( &quot;*** Failed to create Local Folders!\n&quot;);</span>
<a href="#l62.869"></a><span id="l62.869" class="difflineplus">+      IMPORT_LOG0(&quot;*** Failed to create Local Folders!\n&quot;);</span>
<a href="#l62.870"></a><span id="l62.870">       return false;</span>
<a href="#l62.871"></a><span id="l62.871">     }</span>
<a href="#l62.872"></a><span id="l62.872"> </span>
<a href="#l62.873"></a><span id="l62.873">     rv = accMgr-&gt;GetLocalFoldersServer(getter_AddRefs(server));</span>
<a href="#l62.874"></a><span id="l62.874">   }</span>
<a href="#l62.875"></a><span id="l62.875"> </span>
<a href="#l62.876"></a><span id="l62.876">   if (NS_SUCCEEDED(rv) &amp;&amp; server) {</span>
<a href="#l62.877"></a><span id="l62.877">     nsCOMPtr &lt;nsIMsgFolder&gt; localRootFolder;</span>
<a href="#l62.878"></a><span id="l62.878" class="difflineat">@@ -999,21 +999,21 @@ bool nsImportGenericMail::CreateFolder( </span>
<a href="#l62.879"></a><span id="l62.879">         bool exists = false;</span>
<a href="#l62.880"></a><span id="l62.880">         rv = localRootFolder-&gt;ContainsChildNamed(folderName, &amp;exists);</span>
<a href="#l62.881"></a><span id="l62.881">         if (exists) {</span>
<a href="#l62.882"></a><span id="l62.882">           nsString name;</span>
<a href="#l62.883"></a><span id="l62.883">           localRootFolder-&gt;GenerateUniqueSubfolderName(folderName, nsnull, name);</span>
<a href="#l62.884"></a><span id="l62.884">           if (!name.IsEmpty())</span>
<a href="#l62.885"></a><span id="l62.885">             folderName.Assign(name);</span>
<a href="#l62.886"></a><span id="l62.886">           else {</span>
<a href="#l62.887"></a><span id="l62.887" class="difflineminus">-            IMPORT_LOG0( &quot;*** Failed to find a unique folder name!\n&quot;);</span>
<a href="#l62.888"></a><span id="l62.888" class="difflineplus">+            IMPORT_LOG0(&quot;*** Failed to find a unique folder name!\n&quot;);</span>
<a href="#l62.889"></a><span id="l62.889">             return false;</span>
<a href="#l62.890"></a><span id="l62.890">           }</span>
<a href="#l62.891"></a><span id="l62.891">         }</span>
<a href="#l62.892"></a><span id="l62.892" class="difflineminus">-        IMPORT_LOG1( &quot;Creating folder for importing mail: '%s'\n&quot;, NS_ConvertUTF16toUTF8(folderName).get());</span>
<a href="#l62.893"></a><span id="l62.893" class="difflineplus">+        IMPORT_LOG1(&quot;Creating folder for importing mail: '%s'\n&quot;, NS_ConvertUTF16toUTF8(folderName).get());</span>
<a href="#l62.894"></a><span id="l62.894"> </span>
<a href="#l62.895"></a><span id="l62.895">         // Bug 564162 identifies a dataloss design flaw.</span>
<a href="#l62.896"></a><span id="l62.896">         // A working Thunderbird client can have mail in Local Folders and a</span>
<a href="#l62.897"></a><span id="l62.897">         // subsequent import 'Everything' will trigger a migration which</span>
<a href="#l62.898"></a><span id="l62.898">         // overwrites existing mailboxes with the imported mailboxes.</span>
<a href="#l62.899"></a><span id="l62.899">         rv = localRootFolder-&gt;CreateSubfolder(folderName, nsnull);</span>
<a href="#l62.900"></a><span id="l62.900">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l62.901"></a><span id="l62.901">           rv = localRootFolder-&gt;GetChildNamed(folderName, ppFolder);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mailnews/import/src/nsImportMailboxDescriptor.cpp</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mailnews/import/src/nsImportMailboxDescriptor.cpp</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -40,28 +40,28 @@</span>
<a href="#l63.4"></a><span id="l63.4"> #include &quot;nscore.h&quot;</span>
<a href="#l63.5"></a><span id="l63.5"> #include &quot;nsImportMailboxDescriptor.h&quot;</span>
<a href="#l63.6"></a><span id="l63.6"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l63.7"></a><span id="l63.7"> </span>
<a href="#l63.8"></a><span id="l63.8"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l63.9"></a><span id="l63.9"> </span>
<a href="#l63.10"></a><span id="l63.10"> </span>
<a href="#l63.11"></a><span id="l63.11"> </span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-NS_METHOD nsImportMailboxDescriptor::Create( nsISupports *aOuter, REFNSIID aIID, void **aResult)</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+NS_METHOD nsImportMailboxDescriptor::Create(nsISupports *aOuter, REFNSIID aIID, void **aResult)</span>
<a href="#l63.14"></a><span id="l63.14"> {</span>
<a href="#l63.15"></a><span id="l63.15">   if (aOuter)</span>
<a href="#l63.16"></a><span id="l63.16">     return NS_ERROR_NO_AGGREGATION;</span>
<a href="#l63.17"></a><span id="l63.17"> </span>
<a href="#l63.18"></a><span id="l63.18">   nsImportMailboxDescriptor *it = new nsImportMailboxDescriptor();</span>
<a href="#l63.19"></a><span id="l63.19">   if (it == nsnull)</span>
<a href="#l63.20"></a><span id="l63.20">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l63.21"></a><span id="l63.21"> </span>
<a href="#l63.22"></a><span id="l63.22" class="difflineminus">-  NS_ADDREF( it);</span>
<a href="#l63.23"></a><span id="l63.23" class="difflineminus">-  nsresult rv = it-&gt;QueryInterface( aIID, aResult);</span>
<a href="#l63.24"></a><span id="l63.24" class="difflineminus">-  NS_RELEASE( it);</span>
<a href="#l63.25"></a><span id="l63.25" class="difflineplus">+  NS_ADDREF(it);</span>
<a href="#l63.26"></a><span id="l63.26" class="difflineplus">+  nsresult rv = it-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l63.27"></a><span id="l63.27" class="difflineplus">+  NS_RELEASE(it);</span>
<a href="#l63.28"></a><span id="l63.28">   return rv;</span>
<a href="#l63.29"></a><span id="l63.29"> }</span>
<a href="#l63.30"></a><span id="l63.30"> </span>
<a href="#l63.31"></a><span id="l63.31"> NS_IMPL_THREADSAFE_ISUPPORTS1(nsImportMailboxDescriptor, nsIImportMailboxDescriptor)</span>
<a href="#l63.32"></a><span id="l63.32"> </span>
<a href="#l63.33"></a><span id="l63.33"> nsImportMailboxDescriptor::nsImportMailboxDescriptor()</span>
<a href="#l63.34"></a><span id="l63.34"> {</span>
<a href="#l63.35"></a><span id="l63.35">   m_import = true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mailnews/import/src/nsImportMailboxDescriptor.h</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mailnews/import/src/nsImportMailboxDescriptor.h</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -47,44 +47,44 @@</span>
<a href="#l64.4"></a><span id="l64.4"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l64.5"></a><span id="l64.5"> </span>
<a href="#l64.6"></a><span id="l64.6"> </span>
<a href="#l64.7"></a><span id="l64.7"> class nsImportMailboxDescriptor : public nsIImportMailboxDescriptor</span>
<a href="#l64.8"></a><span id="l64.8"> {</span>
<a href="#l64.9"></a><span id="l64.9"> public:</span>
<a href="#l64.10"></a><span id="l64.10">   NS_DECL_ISUPPORTS</span>
<a href="#l64.11"></a><span id="l64.11"> </span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-  NS_IMETHOD  GetIdentifier( PRUint32 *pIdentifier) { *pIdentifier = m_id; return( NS_OK);}</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineminus">-  NS_IMETHOD  SetIdentifier( PRUint32 ident) { m_id = ident; return( NS_OK);}</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineplus">+  NS_IMETHOD  GetIdentifier(PRUint32 *pIdentifier) { *pIdentifier = m_id; return NS_OK;}</span>
<a href="#l64.15"></a><span id="l64.15" class="difflineplus">+  NS_IMETHOD  SetIdentifier(PRUint32 ident) { m_id = ident; return NS_OK;}</span>
<a href="#l64.16"></a><span id="l64.16"> </span>
<a href="#l64.17"></a><span id="l64.17">   /* attribute unsigned long depth; */</span>
<a href="#l64.18"></a><span id="l64.18" class="difflineminus">-  NS_IMETHOD  GetDepth( PRUint32 *pDepth) { *pDepth = m_depth; return( NS_OK);}</span>
<a href="#l64.19"></a><span id="l64.19" class="difflineminus">-  NS_IMETHOD  SetDepth( PRUint32 theDepth) { m_depth = theDepth; return( NS_OK);}</span>
<a href="#l64.20"></a><span id="l64.20" class="difflineplus">+  NS_IMETHOD  GetDepth(PRUint32 *pDepth) { *pDepth = m_depth; return NS_OK;}</span>
<a href="#l64.21"></a><span id="l64.21" class="difflineplus">+  NS_IMETHOD  SetDepth(PRUint32 theDepth) { m_depth = theDepth; return NS_OK;}</span>
<a href="#l64.22"></a><span id="l64.22"> </span>
<a href="#l64.23"></a><span id="l64.23">   /* attribute unsigned long size; */</span>
<a href="#l64.24"></a><span id="l64.24" class="difflineminus">-  NS_IMETHOD  GetSize( PRUint32 *pSize) { *pSize = m_size; return( NS_OK);}</span>
<a href="#l64.25"></a><span id="l64.25" class="difflineminus">-  NS_IMETHOD  SetSize( PRUint32 theSize) { m_size = theSize; return( NS_OK);}</span>
<a href="#l64.26"></a><span id="l64.26" class="difflineplus">+  NS_IMETHOD  GetSize(PRUint32 *pSize) { *pSize = m_size; return NS_OK;}</span>
<a href="#l64.27"></a><span id="l64.27" class="difflineplus">+  NS_IMETHOD  SetSize(PRUint32 theSize) { m_size = theSize; return NS_OK;}</span>
<a href="#l64.28"></a><span id="l64.28"> </span>
<a href="#l64.29"></a><span id="l64.29">   /* attribute wstring displayName; */</span>
<a href="#l64.30"></a><span id="l64.30" class="difflineminus">-  NS_IMETHOD  GetDisplayName( PRUnichar **pName) { *pName = ToNewUnicode(m_displayName); return( NS_OK);}</span>
<a href="#l64.31"></a><span id="l64.31" class="difflineminus">-  NS_IMETHOD  SetDisplayName( const PRUnichar * pName) { m_displayName = pName; return( NS_OK);}</span>
<a href="#l64.32"></a><span id="l64.32" class="difflineplus">+  NS_IMETHOD  GetDisplayName(PRUnichar **pName) { *pName = ToNewUnicode(m_displayName); return NS_OK;}</span>
<a href="#l64.33"></a><span id="l64.33" class="difflineplus">+  NS_IMETHOD  SetDisplayName(const PRUnichar * pName) { m_displayName = pName; return NS_OK;}</span>
<a href="#l64.34"></a><span id="l64.34"> </span>
<a href="#l64.35"></a><span id="l64.35">   /* attribute boolean import; */</span>
<a href="#l64.36"></a><span id="l64.36" class="difflineminus">-  NS_IMETHOD  GetImport( bool *pImport) { *pImport = m_import; return( NS_OK);}</span>
<a href="#l64.37"></a><span id="l64.37" class="difflineminus">-  NS_IMETHOD  SetImport( bool doImport) { m_import = doImport; return( NS_OK);}</span>
<a href="#l64.38"></a><span id="l64.38" class="difflineplus">+  NS_IMETHOD  GetImport(bool *pImport) { *pImport = m_import; return NS_OK;}</span>
<a href="#l64.39"></a><span id="l64.39" class="difflineplus">+  NS_IMETHOD  SetImport(bool doImport) { m_import = doImport; return NS_OK;}</span>
<a href="#l64.40"></a><span id="l64.40"> </span>
<a href="#l64.41"></a><span id="l64.41">   /* readonly attribute nsILocalFile file; */</span>
<a href="#l64.42"></a><span id="l64.42" class="difflineminus">-  NS_IMETHOD GetFile(nsILocalFile * *aFile) { if (m_pFile) { NS_ADDREF(*aFile = m_pFile); return( NS_OK);} else return( NS_ERROR_FAILURE); }</span>
<a href="#l64.43"></a><span id="l64.43" class="difflineplus">+  NS_IMETHOD GetFile(nsILocalFile * *aFile) { if (m_pFile) { NS_ADDREF(*aFile = m_pFile); return NS_OK;} else return NS_ERROR_FAILURE; }</span>
<a href="#l64.44"></a><span id="l64.44"> </span>
<a href="#l64.45"></a><span id="l64.45"> </span>
<a href="#l64.46"></a><span id="l64.46"> </span>
<a href="#l64.47"></a><span id="l64.47">   nsImportMailboxDescriptor();</span>
<a href="#l64.48"></a><span id="l64.48">   virtual ~nsImportMailboxDescriptor() {}</span>
<a href="#l64.49"></a><span id="l64.49"> </span>
<a href="#l64.50"></a><span id="l64.50" class="difflineminus">-   static NS_METHOD Create( nsISupports *aOuter, REFNSIID aIID, void **aResult);</span>
<a href="#l64.51"></a><span id="l64.51" class="difflineplus">+   static NS_METHOD Create(nsISupports *aOuter, REFNSIID aIID, void **aResult);</span>
<a href="#l64.52"></a><span id="l64.52"> </span>
<a href="#l64.53"></a><span id="l64.53"> private:</span>
<a href="#l64.54"></a><span id="l64.54">   PRUint32    m_id;      // used by creator of the structure</span>
<a href="#l64.55"></a><span id="l64.55">   PRUint32    m_depth;    // depth in the hierarchy</span>
<a href="#l64.56"></a><span id="l64.56">   nsString    m_displayName;// name of this mailbox</span>
<a href="#l64.57"></a><span id="l64.57">   nsCOMPtr &lt;nsILocalFile&gt; m_pFile;  // source file (if applicable)</span>
<a href="#l64.58"></a><span id="l64.58">   PRUint32    m_size;</span>
<a href="#l64.59"></a><span id="l64.59">   bool        m_import;    // import it or not?</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/mailnews/import/src/nsImportMimeEncode.cpp</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/mailnews/import/src/nsImportMimeEncode.cpp</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -57,145 +57,145 @@ nsImportMimeEncode::nsImportMimeEncode()</span>
<a href="#l65.4"></a><span id="l65.4">   m_pInputBuf = nsnull;</span>
<a href="#l65.5"></a><span id="l65.5"> }</span>
<a href="#l65.6"></a><span id="l65.6"> </span>
<a href="#l65.7"></a><span id="l65.7"> nsImportMimeEncode::~nsImportMimeEncode()</span>
<a href="#l65.8"></a><span id="l65.8"> {</span>
<a href="#l65.9"></a><span id="l65.9">   delete [] m_pInputBuf;</span>
<a href="#l65.10"></a><span id="l65.10"> }</span>
<a href="#l65.11"></a><span id="l65.11"> </span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-void nsImportMimeEncode::EncodeFile( nsIFile *pInFile, ImportOutFile *pOut, const char *pFileName, const char *pMimeType)</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineplus">+void nsImportMimeEncode::EncodeFile(nsIFile *pInFile, ImportOutFile *pOut, const char *pFileName, const char *pMimeType)</span>
<a href="#l65.14"></a><span id="l65.14"> {</span>
<a href="#l65.15"></a><span id="l65.15">   m_fileName = pFileName;</span>
<a href="#l65.16"></a><span id="l65.16">   m_mimeType = pMimeType;</span>
<a href="#l65.17"></a><span id="l65.17"> </span>
<a href="#l65.18"></a><span id="l65.18">   m_pMimeFile = pInFile;</span>
<a href="#l65.19"></a><span id="l65.19"> </span>
<a href="#l65.20"></a><span id="l65.20">   m_pOut = pOut;</span>
<a href="#l65.21"></a><span id="l65.21">   m_state = kStartState;</span>
<a href="#l65.22"></a><span id="l65.22"> }</span>
<a href="#l65.23"></a><span id="l65.23"> </span>
<a href="#l65.24"></a><span id="l65.24" class="difflineminus">-void nsImportMimeEncode::CleanUp( void)</span>
<a href="#l65.25"></a><span id="l65.25" class="difflineplus">+void nsImportMimeEncode::CleanUp(void)</span>
<a href="#l65.26"></a><span id="l65.26"> {</span>
<a href="#l65.27"></a><span id="l65.27">   CleanUpEncodeScan();</span>
<a href="#l65.28"></a><span id="l65.28"> }</span>
<a href="#l65.29"></a><span id="l65.29"> </span>
<a href="#l65.30"></a><span id="l65.30" class="difflineminus">-bool nsImportMimeEncode::SetUpEncode( void)</span>
<a href="#l65.31"></a><span id="l65.31" class="difflineplus">+bool nsImportMimeEncode::SetUpEncode(void)</span>
<a href="#l65.32"></a><span id="l65.32"> {</span>
<a href="#l65.33"></a><span id="l65.33">   nsCString    errStr;</span>
<a href="#l65.34"></a><span id="l65.34">   if (!m_pInputBuf) {</span>
<a href="#l65.35"></a><span id="l65.35">     m_pInputBuf = new PRUint8[kEncodeBufferSz];</span>
<a href="#l65.36"></a><span id="l65.36">   }</span>
<a href="#l65.37"></a><span id="l65.37"> </span>
<a href="#l65.38"></a><span id="l65.38">   m_appleSingle = false;</span>
<a href="#l65.39"></a><span id="l65.39"> </span>
<a href="#l65.40"></a><span id="l65.40"> #ifdef _MAC_IMPORT_CODE</span>
<a href="#l65.41"></a><span id="l65.41">   // First let's see just what kind of beast we have?</span>
<a href="#l65.42"></a><span id="l65.42">   // For files with only a data fork and a known mime type</span>
<a href="#l65.43"></a><span id="l65.43">   // proceed with normal mime encoding just as on the PC.</span>
<a href="#l65.44"></a><span id="l65.44">   // For unknown mime types and files with both forks,</span>
<a href="#l65.45"></a><span id="l65.45">   // encode as AppleSingle format.</span>
<a href="#l65.46"></a><span id="l65.46" class="difflineminus">-  if (m_filePath.GetMacFileSize( UFileLocation::eResourceFork) || !pMimeType) {</span>
<a href="#l65.47"></a><span id="l65.47" class="difflineplus">+  if (m_filePath.GetMacFileSize(UFileLocation::eResourceFork) || !pMimeType) {</span>
<a href="#l65.48"></a><span id="l65.48">     m_appleSingle = TRUE;</span>
<a href="#l65.49"></a><span id="l65.49">     m_mimeType = &quot;application/applefile&quot;;</span>
<a href="#l65.50"></a><span id="l65.50">   }</span>
<a href="#l65.51"></a><span id="l65.51"> #endif</span>
<a href="#l65.52"></a><span id="l65.52"> </span>
<a href="#l65.53"></a><span id="l65.53" class="difflineminus">-  if (!InitEncodeScan( m_appleSingle, m_pMimeFile, m_fileName.get(), m_pInputBuf, kEncodeBufferSz)) {</span>
<a href="#l65.54"></a><span id="l65.54" class="difflineminus">-    return( false);</span>
<a href="#l65.55"></a><span id="l65.55" class="difflineplus">+  if (!InitEncodeScan(m_appleSingle, m_pMimeFile, m_fileName.get(), m_pInputBuf, kEncodeBufferSz)) {</span>
<a href="#l65.56"></a><span id="l65.56" class="difflineplus">+    return false;</span>
<a href="#l65.57"></a><span id="l65.57">   }</span>
<a href="#l65.58"></a><span id="l65.58"> </span>
<a href="#l65.59"></a><span id="l65.59">   m_state = kEncodeState;</span>
<a href="#l65.60"></a><span id="l65.60">   m_lineLen = 0;</span>
<a href="#l65.61"></a><span id="l65.61"> </span>
<a href="#l65.62"></a><span id="l65.62">   // Write out the boundary header</span>
<a href="#l65.63"></a><span id="l65.63">   bool bResult = true;</span>
<a href="#l65.64"></a><span id="l65.64" class="difflineminus">-  bResult = m_pOut-&gt;WriteStr( &quot;Content-type: &quot;);</span>
<a href="#l65.65"></a><span id="l65.65" class="difflineplus">+  bResult = m_pOut-&gt;WriteStr(&quot;Content-type: &quot;);</span>
<a href="#l65.66"></a><span id="l65.66">   if (bResult)</span>
<a href="#l65.67"></a><span id="l65.67" class="difflineminus">-    bResult = m_pOut-&gt;WriteStr( m_mimeType.get());</span>
<a href="#l65.68"></a><span id="l65.68" class="difflineplus">+    bResult = m_pOut-&gt;WriteStr(m_mimeType.get());</span>
<a href="#l65.69"></a><span id="l65.69"> </span>
<a href="#l65.70"></a><span id="l65.70"> #ifdef _MAC_IMPORT_CODE</span>
<a href="#l65.71"></a><span id="l65.71">   // include the type an creator here</span>
<a href="#l65.72"></a><span id="l65.72">   if (bResult)</span>
<a href="#l65.73"></a><span id="l65.73" class="difflineminus">-    bResult = m_pOut-&gt;WriteStr( &quot;; x-mac-type=\&quot;&quot;);</span>
<a href="#l65.74"></a><span id="l65.74" class="difflineplus">+    bResult = m_pOut-&gt;WriteStr(&quot;; x-mac-type=\&quot;&quot;);</span>
<a href="#l65.75"></a><span id="l65.75">   U8  hex[8];</span>
<a href="#l65.76"></a><span id="l65.76" class="difflineminus">-  LongToHexBytes( m_filePath.GetFileType(), hex);</span>
<a href="#l65.77"></a><span id="l65.77" class="difflineplus">+  LongToHexBytes(m_filePath.GetFileType(), hex);</span>
<a href="#l65.78"></a><span id="l65.78">   if (bResult)</span>
<a href="#l65.79"></a><span id="l65.79" class="difflineminus">-    bResult = m_pOut-&gt;WriteData( hex, 8);</span>
<a href="#l65.80"></a><span id="l65.80" class="difflineminus">-  LongToHexBytes( m_filePath.GetFileCreator(), hex);</span>
<a href="#l65.81"></a><span id="l65.81" class="difflineplus">+    bResult = m_pOut-&gt;WriteData(hex, 8);</span>
<a href="#l65.82"></a><span id="l65.82" class="difflineplus">+  LongToHexBytes(m_filePath.GetFileCreator(), hex);</span>
<a href="#l65.83"></a><span id="l65.83">   if (bResult)</span>
<a href="#l65.84"></a><span id="l65.84" class="difflineminus">-    bResult = m_pOut-&gt;WriteStr( &quot;\&quot;; x-mac-creator=\&quot;&quot;);</span>
<a href="#l65.85"></a><span id="l65.85" class="difflineplus">+    bResult = m_pOut-&gt;WriteStr(&quot;\&quot;; x-mac-creator=\&quot;&quot;);</span>
<a href="#l65.86"></a><span id="l65.86">   if (bResult)</span>
<a href="#l65.87"></a><span id="l65.87" class="difflineminus">-    bResult = m_pOut-&gt;WriteData( hex, 8);</span>
<a href="#l65.88"></a><span id="l65.88" class="difflineplus">+    bResult = m_pOut-&gt;WriteData(hex, 8);</span>
<a href="#l65.89"></a><span id="l65.89">   if (bResult)</span>
<a href="#l65.90"></a><span id="l65.90" class="difflineminus">-    bResult = m_pOut-&gt;WriteStr( &quot;\&quot;&quot;);</span>
<a href="#l65.91"></a><span id="l65.91" class="difflineplus">+    bResult = m_pOut-&gt;WriteStr(&quot;\&quot;&quot;);</span>
<a href="#l65.92"></a><span id="l65.92"> #endif</span>
<a href="#l65.93"></a><span id="l65.93"> </span>
<a href="#l65.94"></a><span id="l65.94">   /*</span>
<a href="#l65.95"></a><span id="l65.95">   if (bResult)</span>
<a href="#l65.96"></a><span id="l65.96" class="difflineminus">-    bResult = m_pOut-&gt;WriteStr( gMimeTypeFileName);</span>
<a href="#l65.97"></a><span id="l65.97" class="difflineplus">+    bResult = m_pOut-&gt;WriteStr(gMimeTypeFileName);</span>
<a href="#l65.98"></a><span id="l65.98">   */</span>
<a href="#l65.99"></a><span id="l65.99">   if (bResult)</span>
<a href="#l65.100"></a><span id="l65.100" class="difflineminus">-    bResult = m_pOut-&gt;WriteStr( &quot;;\x0D\x0A&quot;);</span>
<a href="#l65.101"></a><span id="l65.101" class="difflineplus">+    bResult = m_pOut-&gt;WriteStr(&quot;;\x0D\x0A&quot;);</span>
<a href="#l65.102"></a><span id="l65.102"> </span>
<a href="#l65.103"></a><span id="l65.103">   nsCString    fName;</span>
<a href="#l65.104"></a><span id="l65.104" class="difflineminus">-  bool        trans = TranslateFileName( m_fileName, fName);</span>
<a href="#l65.105"></a><span id="l65.105" class="difflineplus">+  bool        trans = TranslateFileName(m_fileName, fName);</span>
<a href="#l65.106"></a><span id="l65.106">   if (bResult)</span>
<a href="#l65.107"></a><span id="l65.107" class="difflineminus">-    bResult = WriteFileName( fName, trans, &quot;name&quot;);</span>
<a href="#l65.108"></a><span id="l65.108" class="difflineplus">+    bResult = WriteFileName(fName, trans, &quot;name&quot;);</span>
<a href="#l65.109"></a><span id="l65.109">   if (bResult)</span>
<a href="#l65.110"></a><span id="l65.110" class="difflineminus">-    bResult = m_pOut-&gt;WriteStr( &quot;Content-transfer-encoding: base64&quot;);</span>
<a href="#l65.111"></a><span id="l65.111" class="difflineplus">+    bResult = m_pOut-&gt;WriteStr(&quot;Content-transfer-encoding: base64&quot;);</span>
<a href="#l65.112"></a><span id="l65.112">   if (bResult)</span>
<a href="#l65.113"></a><span id="l65.113">     bResult = m_pOut-&gt;WriteEol();</span>
<a href="#l65.114"></a><span id="l65.114">   if (bResult)</span>
<a href="#l65.115"></a><span id="l65.115" class="difflineminus">-    bResult = m_pOut-&gt;WriteStr( &quot;Content-Disposition: attachment;\x0D\x0A&quot;);</span>
<a href="#l65.116"></a><span id="l65.116" class="difflineplus">+    bResult = m_pOut-&gt;WriteStr(&quot;Content-Disposition: attachment;\x0D\x0A&quot;);</span>
<a href="#l65.117"></a><span id="l65.117">   if (bResult)</span>
<a href="#l65.118"></a><span id="l65.118" class="difflineminus">-    bResult = WriteFileName( fName, trans, &quot;filename&quot;);</span>
<a href="#l65.119"></a><span id="l65.119" class="difflineplus">+    bResult = WriteFileName(fName, trans, &quot;filename&quot;);</span>
<a href="#l65.120"></a><span id="l65.120">   if (bResult)</span>
<a href="#l65.121"></a><span id="l65.121">     bResult = m_pOut-&gt;WriteEol();</span>
<a href="#l65.122"></a><span id="l65.122"> </span>
<a href="#l65.123"></a><span id="l65.123">   if (!bResult) {</span>
<a href="#l65.124"></a><span id="l65.124">     CleanUp();</span>
<a href="#l65.125"></a><span id="l65.125">   }</span>
<a href="#l65.126"></a><span id="l65.126"> </span>
<a href="#l65.127"></a><span id="l65.127" class="difflineminus">-  return( bResult);</span>
<a href="#l65.128"></a><span id="l65.128" class="difflineplus">+  return bResult;</span>
<a href="#l65.129"></a><span id="l65.129"> }</span>
<a href="#l65.130"></a><span id="l65.130"> </span>
<a href="#l65.131"></a><span id="l65.131" class="difflineminus">-bool nsImportMimeEncode::DoWork( bool *pDone)</span>
<a href="#l65.132"></a><span id="l65.132" class="difflineplus">+bool nsImportMimeEncode::DoWork(bool *pDone)</span>
<a href="#l65.133"></a><span id="l65.133"> {</span>
<a href="#l65.134"></a><span id="l65.134">   *pDone = false;</span>
<a href="#l65.135"></a><span id="l65.135" class="difflineminus">-  switch( m_state) {</span>
<a href="#l65.136"></a><span id="l65.136" class="difflineplus">+  switch(m_state) {</span>
<a href="#l65.137"></a><span id="l65.137">   case kNoState:</span>
<a href="#l65.138"></a><span id="l65.138" class="difflineminus">-    return( false);</span>
<a href="#l65.139"></a><span id="l65.139" class="difflineplus">+    return false;</span>
<a href="#l65.140"></a><span id="l65.140">     break;</span>
<a href="#l65.141"></a><span id="l65.141">   case kStartState:</span>
<a href="#l65.142"></a><span id="l65.142" class="difflineminus">-    return( SetUpEncode());</span>
<a href="#l65.143"></a><span id="l65.143" class="difflineplus">+    return SetUpEncode();</span>
<a href="#l65.144"></a><span id="l65.144">     break;</span>
<a href="#l65.145"></a><span id="l65.145">   case kEncodeState:</span>
<a href="#l65.146"></a><span id="l65.146" class="difflineminus">-    if (!Scan( pDone)) {</span>
<a href="#l65.147"></a><span id="l65.147" class="difflineplus">+    if (!Scan(pDone)) {</span>
<a href="#l65.148"></a><span id="l65.148">       CleanUp();</span>
<a href="#l65.149"></a><span id="l65.149" class="difflineminus">-      return( false);</span>
<a href="#l65.150"></a><span id="l65.150" class="difflineplus">+      return false;</span>
<a href="#l65.151"></a><span id="l65.151">     }</span>
<a href="#l65.152"></a><span id="l65.152">     if (*pDone) {</span>
<a href="#l65.153"></a><span id="l65.153">       *pDone = false;</span>
<a href="#l65.154"></a><span id="l65.154">       m_state = kDoneState;</span>
<a href="#l65.155"></a><span id="l65.155">     }</span>
<a href="#l65.156"></a><span id="l65.156">     break;</span>
<a href="#l65.157"></a><span id="l65.157">   case kDoneState:</span>
<a href="#l65.158"></a><span id="l65.158">     CleanUp();</span>
<a href="#l65.159"></a><span id="l65.159">     m_state = kNoState;</span>
<a href="#l65.160"></a><span id="l65.160">     *pDone = true;</span>
<a href="#l65.161"></a><span id="l65.161">     break;</span>
<a href="#l65.162"></a><span id="l65.162">   }</span>
<a href="#l65.163"></a><span id="l65.163"> </span>
<a href="#l65.164"></a><span id="l65.164" class="difflineminus">-  return( true);</span>
<a href="#l65.165"></a><span id="l65.165" class="difflineplus">+  return true;</span>
<a href="#l65.166"></a><span id="l65.166"> }</span>
<a href="#l65.167"></a><span id="l65.167"> </span>
<a href="#l65.168"></a><span id="l65.168"> static PRUint8 gBase64[] = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;</span>
<a href="#l65.169"></a><span id="l65.169"> </span>
<a href="#l65.170"></a><span id="l65.170" class="difflineminus">-bool nsImportMimeEncode::ScanBuffer( bool *pDone)</span>
<a href="#l65.171"></a><span id="l65.171" class="difflineplus">+bool nsImportMimeEncode::ScanBuffer(bool *pDone)</span>
<a href="#l65.172"></a><span id="l65.172"> {</span>
<a href="#l65.173"></a><span id="l65.173"> </span>
<a href="#l65.174"></a><span id="l65.174">   PRUint32  pos = m_pos;</span>
<a href="#l65.175"></a><span id="l65.175">   PRUint32  start = pos;</span>
<a href="#l65.176"></a><span id="l65.176">   PRUint8 *  pChar = m_pBuf + pos;</span>
<a href="#l65.177"></a><span id="l65.177">   PRUint32  max = m_bytesInBuf;</span>
<a href="#l65.178"></a><span id="l65.178">   PRUint8    byte[4];</span>
<a href="#l65.179"></a><span id="l65.179">   PRUint32  lineLen = m_lineLen;</span>
<a href="#l65.180"></a><span id="l65.180" class="difflineat">@@ -203,24 +203,24 @@ bool nsImportMimeEncode::ScanBuffer( boo</span>
<a href="#l65.181"></a><span id="l65.181">   while ((pos + 2) &lt; max) {</span>
<a href="#l65.182"></a><span id="l65.182">     // Encode 3 bytes</span>
<a href="#l65.183"></a><span id="l65.183">     byte[0] = gBase64[*pChar &gt;&gt; 2];</span>
<a href="#l65.184"></a><span id="l65.184">     byte[1] = gBase64[(((*pChar) &amp; 0x3)&lt;&lt; 4) | (((*(pChar + 1)) &amp; 0xF0) &gt;&gt; 4)];</span>
<a href="#l65.185"></a><span id="l65.185">     pChar++;</span>
<a href="#l65.186"></a><span id="l65.186">     byte[2] = gBase64[(((*pChar) &amp; 0xF) &lt;&lt; 2) | (((*(pChar + 1)) &amp; 0xC0) &gt;&gt;6)];</span>
<a href="#l65.187"></a><span id="l65.187">     pChar++;</span>
<a href="#l65.188"></a><span id="l65.188">     byte[3] = gBase64[(*pChar) &amp; 0x3F];</span>
<a href="#l65.189"></a><span id="l65.189" class="difflineminus">-    if (!m_pOut-&gt;WriteData( byte, 4))</span>
<a href="#l65.190"></a><span id="l65.190" class="difflineminus">-      return( false);</span>
<a href="#l65.191"></a><span id="l65.191" class="difflineplus">+    if (!m_pOut-&gt;WriteData(byte, 4))</span>
<a href="#l65.192"></a><span id="l65.192" class="difflineplus">+      return false;</span>
<a href="#l65.193"></a><span id="l65.193">     pos += 3;</span>
<a href="#l65.194"></a><span id="l65.194">     pChar++;</span>
<a href="#l65.195"></a><span id="l65.195">     lineLen += 4;</span>
<a href="#l65.196"></a><span id="l65.196">     if (lineLen &gt; 71) {</span>
<a href="#l65.197"></a><span id="l65.197">       if (!m_pOut-&gt;WriteEol())</span>
<a href="#l65.198"></a><span id="l65.198" class="difflineminus">-        return( false);</span>
<a href="#l65.199"></a><span id="l65.199" class="difflineplus">+        return false;</span>
<a href="#l65.200"></a><span id="l65.200">       lineLen = 0;</span>
<a href="#l65.201"></a><span id="l65.201">     }</span>
<a href="#l65.202"></a><span id="l65.202">   }</span>
<a href="#l65.203"></a><span id="l65.203"> </span>
<a href="#l65.204"></a><span id="l65.204">   if ((pos &lt; max) &amp;&amp; m_eof) {</span>
<a href="#l65.205"></a><span id="l65.205">     // Get the last few bytes!</span>
<a href="#l65.206"></a><span id="l65.206">     byte[0] = gBase64[*pChar &gt;&gt; 2];</span>
<a href="#l65.207"></a><span id="l65.207">     pos++;</span>
<a href="#l65.208"></a><span id="l65.208" class="difflineat">@@ -241,144 +241,144 @@ bool nsImportMimeEncode::ScanBuffer( boo</span>
<a href="#l65.209"></a><span id="l65.209">       }</span>
<a href="#l65.210"></a><span id="l65.210">     }</span>
<a href="#l65.211"></a><span id="l65.211">     else {</span>
<a href="#l65.212"></a><span id="l65.212">       byte[1] = gBase64[(((*pChar) &amp; 0x3)&lt;&lt; 4)];</span>
<a href="#l65.213"></a><span id="l65.213">       byte[2] = '=';</span>
<a href="#l65.214"></a><span id="l65.214">       byte[3] = '=';</span>
<a href="#l65.215"></a><span id="l65.215">     }</span>
<a href="#l65.216"></a><span id="l65.216"> </span>
<a href="#l65.217"></a><span id="l65.217" class="difflineminus">-    if (!m_pOut-&gt;WriteData( byte, 4))</span>
<a href="#l65.218"></a><span id="l65.218" class="difflineminus">-      return( false);</span>
<a href="#l65.219"></a><span id="l65.219" class="difflineplus">+    if (!m_pOut-&gt;WriteData(byte, 4))</span>
<a href="#l65.220"></a><span id="l65.220" class="difflineplus">+      return false;</span>
<a href="#l65.221"></a><span id="l65.221">     if (!m_pOut-&gt;WriteEol())</span>
<a href="#l65.222"></a><span id="l65.222" class="difflineminus">-      return( false);</span>
<a href="#l65.223"></a><span id="l65.223" class="difflineplus">+      return false;</span>
<a href="#l65.224"></a><span id="l65.224">   }</span>
<a href="#l65.225"></a><span id="l65.225">   else if (m_eof) {</span>
<a href="#l65.226"></a><span id="l65.226">     /*</span>
<a href="#l65.227"></a><span id="l65.227">     byte[0] = '=';</span>
<a href="#l65.228"></a><span id="l65.228" class="difflineminus">-    if (!m_pOut-&gt;WriteData( byte, 1))</span>
<a href="#l65.229"></a><span id="l65.229" class="difflineminus">-      return( FALSE);</span>
<a href="#l65.230"></a><span id="l65.230" class="difflineplus">+    if (!m_pOut-&gt;WriteData(byte, 1))</span>
<a href="#l65.231"></a><span id="l65.231" class="difflineplus">+      return FALSE;</span>
<a href="#l65.232"></a><span id="l65.232">     */</span>
<a href="#l65.233"></a><span id="l65.233">     if (!m_pOut-&gt;WriteEol())</span>
<a href="#l65.234"></a><span id="l65.234" class="difflineminus">-      return( false);</span>
<a href="#l65.235"></a><span id="l65.235" class="difflineplus">+      return false;</span>
<a href="#l65.236"></a><span id="l65.236">   }</span>
<a href="#l65.237"></a><span id="l65.237"> </span>
<a href="#l65.238"></a><span id="l65.238">   m_lineLen = (int) lineLen;</span>
<a href="#l65.239"></a><span id="l65.239">   m_pos = pos;</span>
<a href="#l65.240"></a><span id="l65.240">   m_bytesProcessed += (pos - start);</span>
<a href="#l65.241"></a><span id="l65.241" class="difflineminus">-  return( true);</span>
<a href="#l65.242"></a><span id="l65.242" class="difflineplus">+  return true;</span>
<a href="#l65.243"></a><span id="l65.243"> }</span>
<a href="#l65.244"></a><span id="l65.244"> </span>
<a href="#l65.245"></a><span id="l65.245" class="difflineminus">-bool nsImportMimeEncode::TranslateFileName( nsCString&amp; inFile, nsCString&amp; outFile)</span>
<a href="#l65.246"></a><span id="l65.246" class="difflineplus">+bool nsImportMimeEncode::TranslateFileName(nsCString&amp; inFile, nsCString&amp; outFile)</span>
<a href="#l65.247"></a><span id="l65.247"> {</span>
<a href="#l65.248"></a><span id="l65.248">   const PRUint8 * pIn = (const PRUint8 *) inFile.get();</span>
<a href="#l65.249"></a><span id="l65.249">   int    len = inFile.Length();</span>
<a href="#l65.250"></a><span id="l65.250"> </span>
<a href="#l65.251"></a><span id="l65.251">   while (len) {</span>
<a href="#l65.252"></a><span id="l65.252" class="difflineminus">-    if (!ImportCharSet::IsUSAscii( *pIn))</span>
<a href="#l65.253"></a><span id="l65.253" class="difflineplus">+    if (!ImportCharSet::IsUSAscii(*pIn))</span>
<a href="#l65.254"></a><span id="l65.254">       break;</span>
<a href="#l65.255"></a><span id="l65.255">     len--;</span>
<a href="#l65.256"></a><span id="l65.256">     pIn++;</span>
<a href="#l65.257"></a><span id="l65.257">   }</span>
<a href="#l65.258"></a><span id="l65.258">   if (len) {</span>
<a href="#l65.259"></a><span id="l65.259">     // non US ascii!</span>
<a href="#l65.260"></a><span id="l65.260">     // assume this string needs translating...</span>
<a href="#l65.261"></a><span id="l65.261" class="difflineminus">-    if (!ImportTranslate::ConvertString( inFile, outFile, true)) {</span>
<a href="#l65.262"></a><span id="l65.262" class="difflineplus">+    if (!ImportTranslate::ConvertString(inFile, outFile, true)) {</span>
<a href="#l65.263"></a><span id="l65.263">       outFile = inFile;</span>
<a href="#l65.264"></a><span id="l65.264" class="difflineminus">-      return( false);</span>
<a href="#l65.265"></a><span id="l65.265" class="difflineplus">+      return false;</span>
<a href="#l65.266"></a><span id="l65.266">     }</span>
<a href="#l65.267"></a><span id="l65.267">     else {</span>
<a href="#l65.268"></a><span id="l65.268" class="difflineminus">-      return( true);</span>
<a href="#l65.269"></a><span id="l65.269" class="difflineplus">+      return true;</span>
<a href="#l65.270"></a><span id="l65.270">     }</span>
<a href="#l65.271"></a><span id="l65.271">   }</span>
<a href="#l65.272"></a><span id="l65.272">   else {</span>
<a href="#l65.273"></a><span id="l65.273">     outFile = inFile;</span>
<a href="#l65.274"></a><span id="l65.274" class="difflineminus">-    return( false);</span>
<a href="#l65.275"></a><span id="l65.275" class="difflineplus">+    return false;</span>
<a href="#l65.276"></a><span id="l65.276">   }</span>
<a href="#l65.277"></a><span id="l65.277"> }</span>
<a href="#l65.278"></a><span id="l65.278"> </span>
<a href="#l65.279"></a><span id="l65.279" class="difflineminus">-bool nsImportMimeEncode::WriteFileName( nsCString&amp; fName, bool wasTrans, const char *pTag)</span>
<a href="#l65.280"></a><span id="l65.280" class="difflineplus">+bool nsImportMimeEncode::WriteFileName(nsCString&amp; fName, bool wasTrans, const char *pTag)</span>
<a href="#l65.281"></a><span id="l65.281"> {</span>
<a href="#l65.282"></a><span id="l65.282">   int      tagNum = 0;</span>
<a href="#l65.283"></a><span id="l65.283">   int      idx = 0;</span>
<a href="#l65.284"></a><span id="l65.284">   bool      result = true;</span>
<a href="#l65.285"></a><span id="l65.285">   int      len;</span>
<a href="#l65.286"></a><span id="l65.286">   nsCString  numStr;</span>
<a href="#l65.287"></a><span id="l65.287"> </span>
<a href="#l65.288"></a><span id="l65.288" class="difflineminus">-  while ((((fName.Length() - idx) + strlen( pTag)) &gt; 70) &amp;&amp; result) {</span>
<a href="#l65.289"></a><span id="l65.289" class="difflineminus">-    len = 68 - strlen( pTag) - 5;</span>
<a href="#l65.290"></a><span id="l65.290" class="difflineplus">+  while ((((fName.Length() - idx) + strlen(pTag)) &gt; 70) &amp;&amp; result) {</span>
<a href="#l65.291"></a><span id="l65.291" class="difflineplus">+    len = 68 - strlen(pTag) - 5;</span>
<a href="#l65.292"></a><span id="l65.292">     if (wasTrans) {</span>
<a href="#l65.293"></a><span id="l65.293" class="difflineminus">-      if (fName.CharAt( idx + len - 1) == '%')</span>
<a href="#l65.294"></a><span id="l65.294" class="difflineplus">+      if (fName.CharAt(idx + len - 1) == '%')</span>
<a href="#l65.295"></a><span id="l65.295">         len--;</span>
<a href="#l65.296"></a><span id="l65.296" class="difflineminus">-      else if (fName.CharAt( idx + len - 2) == '%')</span>
<a href="#l65.297"></a><span id="l65.297" class="difflineplus">+      else if (fName.CharAt(idx + len - 2) == '%')</span>
<a href="#l65.298"></a><span id="l65.298">         len -= 2;</span>
<a href="#l65.299"></a><span id="l65.299">     }</span>
<a href="#l65.300"></a><span id="l65.300"> </span>
<a href="#l65.301"></a><span id="l65.301">     if (result)</span>
<a href="#l65.302"></a><span id="l65.302" class="difflineminus">-      result = m_pOut-&gt;WriteStr( &quot;\x09&quot;);</span>
<a href="#l65.303"></a><span id="l65.303" class="difflineplus">+      result = m_pOut-&gt;WriteStr(&quot;\x09&quot;);</span>
<a href="#l65.304"></a><span id="l65.304">     if (result)</span>
<a href="#l65.305"></a><span id="l65.305" class="difflineminus">-      result = m_pOut-&gt;WriteStr( pTag);</span>
<a href="#l65.306"></a><span id="l65.306" class="difflineplus">+      result = m_pOut-&gt;WriteStr(pTag);</span>
<a href="#l65.307"></a><span id="l65.307">     numStr = &quot;*&quot;;</span>
<a href="#l65.308"></a><span id="l65.308" class="difflineminus">-    numStr.AppendInt( tagNum);</span>
<a href="#l65.309"></a><span id="l65.309" class="difflineplus">+    numStr.AppendInt(tagNum);</span>
<a href="#l65.310"></a><span id="l65.310">     if (result)</span>
<a href="#l65.311"></a><span id="l65.311" class="difflineminus">-      result = m_pOut-&gt;WriteStr( numStr.get());</span>
<a href="#l65.312"></a><span id="l65.312" class="difflineplus">+      result = m_pOut-&gt;WriteStr(numStr.get());</span>
<a href="#l65.313"></a><span id="l65.313">     if (wasTrans &amp;&amp; result)</span>
<a href="#l65.314"></a><span id="l65.314" class="difflineminus">-      result = m_pOut-&gt;WriteStr( &quot;*=&quot;);</span>
<a href="#l65.315"></a><span id="l65.315" class="difflineplus">+      result = m_pOut-&gt;WriteStr(&quot;*=&quot;);</span>
<a href="#l65.316"></a><span id="l65.316">     else if (result)</span>
<a href="#l65.317"></a><span id="l65.317" class="difflineminus">-      result = m_pOut-&gt;WriteStr( &quot;=\&quot;&quot;);</span>
<a href="#l65.318"></a><span id="l65.318" class="difflineplus">+      result = m_pOut-&gt;WriteStr(&quot;=\&quot;&quot;);</span>
<a href="#l65.319"></a><span id="l65.319">     if (result)</span>
<a href="#l65.320"></a><span id="l65.320" class="difflineminus">-      result = m_pOut-&gt;WriteData( ((const PRUint8 *)fName.get()) + idx, len);</span>
<a href="#l65.321"></a><span id="l65.321" class="difflineplus">+      result = m_pOut-&gt;WriteData(((const PRUint8 *)fName.get()) + idx, len);</span>
<a href="#l65.322"></a><span id="l65.322">     if (wasTrans &amp;&amp; result)</span>
<a href="#l65.323"></a><span id="l65.323" class="difflineminus">-      result = m_pOut-&gt;WriteStr( &quot;\x0D\x0A&quot;);</span>
<a href="#l65.324"></a><span id="l65.324" class="difflineplus">+      result = m_pOut-&gt;WriteStr(&quot;\x0D\x0A&quot;);</span>
<a href="#l65.325"></a><span id="l65.325">     else if (result)</span>
<a href="#l65.326"></a><span id="l65.326" class="difflineminus">-      result = m_pOut-&gt;WriteStr( &quot;\&quot;\x0D\x0A&quot;);</span>
<a href="#l65.327"></a><span id="l65.327" class="difflineplus">+      result = m_pOut-&gt;WriteStr(&quot;\&quot;\x0D\x0A&quot;);</span>
<a href="#l65.328"></a><span id="l65.328">     idx += len;</span>
<a href="#l65.329"></a><span id="l65.329">     tagNum++;</span>
<a href="#l65.330"></a><span id="l65.330">   }</span>
<a href="#l65.331"></a><span id="l65.331"> </span>
<a href="#l65.332"></a><span id="l65.332">   if (idx) {</span>
<a href="#l65.333"></a><span id="l65.333">     if ((fName.Length() - idx) &gt; 0) {</span>
<a href="#l65.334"></a><span id="l65.334">       if (result)</span>
<a href="#l65.335"></a><span id="l65.335" class="difflineminus">-        result = m_pOut-&gt;WriteStr( &quot;\x09&quot;);</span>
<a href="#l65.336"></a><span id="l65.336" class="difflineplus">+        result = m_pOut-&gt;WriteStr(&quot;\x09&quot;);</span>
<a href="#l65.337"></a><span id="l65.337">       if (result)</span>
<a href="#l65.338"></a><span id="l65.338" class="difflineminus">-        result = m_pOut-&gt;WriteStr( pTag);</span>
<a href="#l65.339"></a><span id="l65.339" class="difflineplus">+        result = m_pOut-&gt;WriteStr(pTag);</span>
<a href="#l65.340"></a><span id="l65.340">       numStr = &quot;*&quot;;</span>
<a href="#l65.341"></a><span id="l65.341" class="difflineminus">-      numStr.AppendInt( tagNum);</span>
<a href="#l65.342"></a><span id="l65.342" class="difflineplus">+      numStr.AppendInt(tagNum);</span>
<a href="#l65.343"></a><span id="l65.343">       if (result)</span>
<a href="#l65.344"></a><span id="l65.344" class="difflineminus">-        result = m_pOut-&gt;WriteStr( numStr.get());</span>
<a href="#l65.345"></a><span id="l65.345" class="difflineplus">+        result = m_pOut-&gt;WriteStr(numStr.get());</span>
<a href="#l65.346"></a><span id="l65.346">       if (wasTrans &amp;&amp; result)</span>
<a href="#l65.347"></a><span id="l65.347" class="difflineminus">-        result = m_pOut-&gt;WriteStr( &quot;*=&quot;);</span>
<a href="#l65.348"></a><span id="l65.348" class="difflineplus">+        result = m_pOut-&gt;WriteStr(&quot;*=&quot;);</span>
<a href="#l65.349"></a><span id="l65.349">       else if (result)</span>
<a href="#l65.350"></a><span id="l65.350" class="difflineminus">-        result = m_pOut-&gt;WriteStr( &quot;=\&quot;&quot;);</span>
<a href="#l65.351"></a><span id="l65.351" class="difflineplus">+        result = m_pOut-&gt;WriteStr(&quot;=\&quot;&quot;);</span>
<a href="#l65.352"></a><span id="l65.352">       if (result)</span>
<a href="#l65.353"></a><span id="l65.353" class="difflineminus">-        result = m_pOut-&gt;WriteData( ((const PRUint8 *)fName.get()) + idx, fName.Length() - idx);</span>
<a href="#l65.354"></a><span id="l65.354" class="difflineplus">+        result = m_pOut-&gt;WriteData(((const PRUint8 *)fName.get()) + idx, fName.Length() - idx);</span>
<a href="#l65.355"></a><span id="l65.355">       if (wasTrans &amp;&amp; result)</span>
<a href="#l65.356"></a><span id="l65.356" class="difflineminus">-        result = m_pOut-&gt;WriteStr( &quot;\x0D\x0A&quot;);</span>
<a href="#l65.357"></a><span id="l65.357" class="difflineplus">+        result = m_pOut-&gt;WriteStr(&quot;\x0D\x0A&quot;);</span>
<a href="#l65.358"></a><span id="l65.358">       else if (result)</span>
<a href="#l65.359"></a><span id="l65.359" class="difflineminus">-        result = m_pOut-&gt;WriteStr( &quot;\&quot;\x0D\x0A&quot;);</span>
<a href="#l65.360"></a><span id="l65.360" class="difflineplus">+        result = m_pOut-&gt;WriteStr(&quot;\&quot;\x0D\x0A&quot;);</span>
<a href="#l65.361"></a><span id="l65.361">     }</span>
<a href="#l65.362"></a><span id="l65.362">   }</span>
<a href="#l65.363"></a><span id="l65.363">   else {</span>
<a href="#l65.364"></a><span id="l65.364">     if (result)</span>
<a href="#l65.365"></a><span id="l65.365" class="difflineminus">-      result = m_pOut-&gt;WriteStr( &quot;\x09&quot;);</span>
<a href="#l65.366"></a><span id="l65.366" class="difflineplus">+      result = m_pOut-&gt;WriteStr(&quot;\x09&quot;);</span>
<a href="#l65.367"></a><span id="l65.367">     if (result)</span>
<a href="#l65.368"></a><span id="l65.368" class="difflineminus">-      result = m_pOut-&gt;WriteStr( pTag);</span>
<a href="#l65.369"></a><span id="l65.369" class="difflineplus">+      result = m_pOut-&gt;WriteStr(pTag);</span>
<a href="#l65.370"></a><span id="l65.370">     if (wasTrans &amp;&amp; result)</span>
<a href="#l65.371"></a><span id="l65.371" class="difflineminus">-      result = m_pOut-&gt;WriteStr( &quot;*=&quot;);</span>
<a href="#l65.372"></a><span id="l65.372" class="difflineplus">+      result = m_pOut-&gt;WriteStr(&quot;*=&quot;);</span>
<a href="#l65.373"></a><span id="l65.373">     else if (result)</span>
<a href="#l65.374"></a><span id="l65.374" class="difflineminus">-      result = m_pOut-&gt;WriteStr( &quot;=\&quot;&quot;);</span>
<a href="#l65.375"></a><span id="l65.375" class="difflineplus">+      result = m_pOut-&gt;WriteStr(&quot;=\&quot;&quot;);</span>
<a href="#l65.376"></a><span id="l65.376">     if (result)</span>
<a href="#l65.377"></a><span id="l65.377" class="difflineminus">-      result = m_pOut-&gt;WriteStr( fName.get());</span>
<a href="#l65.378"></a><span id="l65.378" class="difflineplus">+      result = m_pOut-&gt;WriteStr(fName.get());</span>
<a href="#l65.379"></a><span id="l65.379">     if (wasTrans &amp;&amp; result)</span>
<a href="#l65.380"></a><span id="l65.380" class="difflineminus">-      result = m_pOut-&gt;WriteStr( &quot;\x0D\x0A&quot;);</span>
<a href="#l65.381"></a><span id="l65.381" class="difflineplus">+      result = m_pOut-&gt;WriteStr(&quot;\x0D\x0A&quot;);</span>
<a href="#l65.382"></a><span id="l65.382">     else if (result)</span>
<a href="#l65.383"></a><span id="l65.383" class="difflineminus">-      result = m_pOut-&gt;WriteStr( &quot;\&quot;\x0D\x0A&quot;);</span>
<a href="#l65.384"></a><span id="l65.384" class="difflineplus">+      result = m_pOut-&gt;WriteStr(&quot;\&quot;\x0D\x0A&quot;);</span>
<a href="#l65.385"></a><span id="l65.385">   }</span>
<a href="#l65.386"></a><span id="l65.386"> </span>
<a href="#l65.387"></a><span id="l65.387" class="difflineminus">-  return( result);</span>
<a href="#l65.388"></a><span id="l65.388" class="difflineplus">+  return result;</span>
<a href="#l65.389"></a><span id="l65.389"> </span>
<a href="#l65.390"></a><span id="l65.390"> }</span>
<a href="#l65.391"></a><span id="l65.391"> </span>
<a href="#l65.392"></a><span id="l65.392"> </span>
<a href="#l65.393"></a><span id="l65.393"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l65.394"></a><span id="l65.394"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l65.395"></a><span id="l65.395"> nsIImportMimeEncodeImpl::nsIImportMimeEncodeImpl()</span>
<a href="#l65.396"></a><span id="l65.396"> {</span>
<a href="#l65.397"></a><span id="l65.397" class="difflineat">@@ -393,54 +393,52 @@ nsIImportMimeEncodeImpl::~nsIImportMimeE</span>
<a href="#l65.398"></a><span id="l65.398">   if (m_pEncode)</span>
<a href="#l65.399"></a><span id="l65.399">     delete m_pEncode;</span>
<a href="#l65.400"></a><span id="l65.400"> }</span>
<a href="#l65.401"></a><span id="l65.401"> </span>
<a href="#l65.402"></a><span id="l65.402"> NS_IMPL_ISUPPORTS1(nsIImportMimeEncodeImpl, nsIImportMimeEncode)</span>
<a href="#l65.403"></a><span id="l65.403"> </span>
<a href="#l65.404"></a><span id="l65.404"> NS_METHOD nsIImportMimeEncodeImpl::EncodeFile(nsIFile *inFile, nsIFile *outFile, const char *fileName, const char *mimeType)</span>
<a href="#l65.405"></a><span id="l65.405"> {</span>
<a href="#l65.406"></a><span id="l65.406" class="difflineminus">-  return( Initialize( inFile, outFile, fileName, mimeType));</span>
<a href="#l65.407"></a><span id="l65.407" class="difflineplus">+  return Initialize(inFile, outFile, fileName, mimeType);</span>
<a href="#l65.408"></a><span id="l65.408"> }</span>
<a href="#l65.409"></a><span id="l65.409"> </span>
<a href="#l65.410"></a><span id="l65.410"> NS_METHOD nsIImportMimeEncodeImpl::DoWork(bool *done, bool *_retval)</span>
<a href="#l65.411"></a><span id="l65.411"> {</span>
<a href="#l65.412"></a><span id="l65.412">   if (done &amp;&amp; _retval &amp;&amp; m_pEncode) {</span>
<a href="#l65.413"></a><span id="l65.413" class="difflineminus">-    *_retval = m_pEncode-&gt;DoWork( done);</span>
<a href="#l65.414"></a><span id="l65.414" class="difflineminus">-    return( NS_OK);</span>
<a href="#l65.415"></a><span id="l65.415" class="difflineplus">+    *_retval = m_pEncode-&gt;DoWork(done);</span>
<a href="#l65.416"></a><span id="l65.416" class="difflineplus">+    return NS_OK;</span>
<a href="#l65.417"></a><span id="l65.417">   }</span>
<a href="#l65.418"></a><span id="l65.418" class="difflineminus">-  else</span>
<a href="#l65.419"></a><span id="l65.419" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l65.420"></a><span id="l65.420" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l65.421"></a><span id="l65.421"> }</span>
<a href="#l65.422"></a><span id="l65.422"> </span>
<a href="#l65.423"></a><span id="l65.423"> NS_METHOD nsIImportMimeEncodeImpl::NumBytesProcessed(PRInt32 *_retval)</span>
<a href="#l65.424"></a><span id="l65.424"> {</span>
<a href="#l65.425"></a><span id="l65.425">   if (m_pEncode &amp;&amp; _retval)</span>
<a href="#l65.426"></a><span id="l65.426">     *_retval = m_pEncode-&gt;NumBytesProcessed();</span>
<a href="#l65.427"></a><span id="l65.427" class="difflineminus">-  return( NS_OK);</span>
<a href="#l65.428"></a><span id="l65.428" class="difflineplus">+  return NS_OK;</span>
<a href="#l65.429"></a><span id="l65.429"> }</span>
<a href="#l65.430"></a><span id="l65.430"> </span>
<a href="#l65.431"></a><span id="l65.431"> NS_METHOD nsIImportMimeEncodeImpl::DoEncoding(bool *_retval)</span>
<a href="#l65.432"></a><span id="l65.432"> {</span>
<a href="#l65.433"></a><span id="l65.433">   if (_retval &amp;&amp; m_pEncode) {</span>
<a href="#l65.434"></a><span id="l65.434">     bool    done = false;</span>
<a href="#l65.435"></a><span id="l65.435" class="difflineminus">-    while (m_pEncode-&gt;DoWork( &amp;done) &amp;&amp; !done);</span>
<a href="#l65.436"></a><span id="l65.436" class="difflineplus">+    while (m_pEncode-&gt;DoWork(&amp;done) &amp;&amp; !done);</span>
<a href="#l65.437"></a><span id="l65.437">     *_retval = done;</span>
<a href="#l65.438"></a><span id="l65.438" class="difflineminus">-    return( NS_OK);</span>
<a href="#l65.439"></a><span id="l65.439" class="difflineplus">+    return NS_OK;</span>
<a href="#l65.440"></a><span id="l65.440">   }</span>
<a href="#l65.441"></a><span id="l65.441" class="difflineminus">-  else</span>
<a href="#l65.442"></a><span id="l65.442" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l65.443"></a><span id="l65.443" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l65.444"></a><span id="l65.444"> }</span>
<a href="#l65.445"></a><span id="l65.445"> </span>
<a href="#l65.446"></a><span id="l65.446"> NS_METHOD nsIImportMimeEncodeImpl::Initialize(nsIFile *inFile, nsIFile *outFile, const char *fileName, const char *mimeType)</span>
<a href="#l65.447"></a><span id="l65.447"> {</span>
<a href="#l65.448"></a><span id="l65.448">   delete m_pEncode;</span>
<a href="#l65.449"></a><span id="l65.449">   delete m_pOut;</span>
<a href="#l65.450"></a><span id="l65.450"> </span>
<a href="#l65.451"></a><span id="l65.451">   m_pOut = new ImportOutFile();</span>
<a href="#l65.452"></a><span id="l65.452" class="difflineminus">-  m_pOut-&gt;InitOutFile( outFile);</span>
<a href="#l65.453"></a><span id="l65.453" class="difflineplus">+  m_pOut-&gt;InitOutFile(outFile);</span>
<a href="#l65.454"></a><span id="l65.454"> </span>
<a href="#l65.455"></a><span id="l65.455">   m_pEncode = new nsImportMimeEncode();</span>
<a href="#l65.456"></a><span id="l65.456" class="difflineminus">-  m_pEncode-&gt;EncodeFile( inFile, m_pOut, fileName, mimeType);</span>
<a href="#l65.457"></a><span id="l65.457" class="difflineplus">+  m_pEncode-&gt;EncodeFile(inFile, m_pOut, fileName, mimeType);</span>
<a href="#l65.458"></a><span id="l65.458"> </span>
<a href="#l65.459"></a><span id="l65.459" class="difflineminus">-  return( NS_OK);</span>
<a href="#l65.460"></a><span id="l65.460" class="difflineplus">+  return NS_OK;</span>
<a href="#l65.461"></a><span id="l65.461"> }</span>
<a href="#l65.462"></a><span id="l65.462"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/mailnews/import/src/nsImportMimeEncode.h</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/mailnews/import/src/nsImportMimeEncode.h</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -48,30 +48,30 @@</span>
<a href="#l66.4"></a><span id="l66.4"> // Content-Transfer-Encoding: base64</span>
<a href="#l66.5"></a><span id="l66.5"> // Content-Disposition: attachment; filename=&quot;blah.xyz&quot;</span>
<a href="#l66.6"></a><span id="l66.6"> </span>
<a href="#l66.7"></a><span id="l66.7"> class nsImportMimeEncode : public nsImportEncodeScan {</span>
<a href="#l66.8"></a><span id="l66.8"> public:</span>
<a href="#l66.9"></a><span id="l66.9"> 	nsImportMimeEncode();</span>
<a href="#l66.10"></a><span id="l66.10"> 	~nsImportMimeEncode();</span>
<a href="#l66.11"></a><span id="l66.11"> 	</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-	void	EncodeFile( nsIFile *pInFile, ImportOutFile *pOut, const char *pFileName, const char *pMimeType);</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+	void	EncodeFile(nsIFile *pInFile, ImportOutFile *pOut, const char *pFileName, const char *pMimeType);</span>
<a href="#l66.14"></a><span id="l66.14"> </span>
<a href="#l66.15"></a><span id="l66.15" class="difflineminus">-	bool	DoWork( bool *pDone);</span>
<a href="#l66.16"></a><span id="l66.16" class="difflineplus">+	bool	DoWork(bool *pDone);</span>
<a href="#l66.17"></a><span id="l66.17"> 	</span>
<a href="#l66.18"></a><span id="l66.18" class="difflineminus">-	long	NumBytesProcessed( void) { long val = m_bytesProcessed; m_bytesProcessed = 0; return( val);}</span>
<a href="#l66.19"></a><span id="l66.19" class="difflineplus">+	long	NumBytesProcessed(void) { long val = m_bytesProcessed; m_bytesProcessed = 0; return val;}</span>
<a href="#l66.20"></a><span id="l66.20"> </span>
<a href="#l66.21"></a><span id="l66.21"> protected:</span>
<a href="#l66.22"></a><span id="l66.22" class="difflineminus">-	void	CleanUp( void);</span>
<a href="#l66.23"></a><span id="l66.23" class="difflineminus">-	bool	SetUpEncode( void);</span>
<a href="#l66.24"></a><span id="l66.24" class="difflineminus">-	bool	WriteFileName( nsCString&amp; fName, bool wasTrans, const char *pTag);</span>
<a href="#l66.25"></a><span id="l66.25" class="difflineminus">-	bool	TranslateFileName( nsCString&amp; inFile, nsCString&amp; outFile);</span>
<a href="#l66.26"></a><span id="l66.26" class="difflineplus">+	void	CleanUp(void);</span>
<a href="#l66.27"></a><span id="l66.27" class="difflineplus">+	bool	SetUpEncode(void);</span>
<a href="#l66.28"></a><span id="l66.28" class="difflineplus">+	bool	WriteFileName(nsCString&amp; fName, bool wasTrans, const char *pTag);</span>
<a href="#l66.29"></a><span id="l66.29" class="difflineplus">+	bool	TranslateFileName(nsCString&amp; inFile, nsCString&amp; outFile);</span>
<a href="#l66.30"></a><span id="l66.30"> </span>
<a href="#l66.31"></a><span id="l66.31"> </span>
<a href="#l66.32"></a><span id="l66.32" class="difflineminus">-	virtual bool	ScanBuffer( bool *pDone);</span>
<a href="#l66.33"></a><span id="l66.33" class="difflineplus">+	virtual bool	ScanBuffer(bool *pDone);</span>
<a href="#l66.34"></a><span id="l66.34"> </span>
<a href="#l66.35"></a><span id="l66.35"> </span>
<a href="#l66.36"></a><span id="l66.36"> protected:</span>
<a href="#l66.37"></a><span id="l66.37"> 	nsCString             m_fileName;</span>
<a href="#l66.38"></a><span id="l66.38"> 	nsCOMPtr &lt;nsIFile&gt;    m_pMimeFile;</span>
<a href="#l66.39"></a><span id="l66.39"> 	ImportOutFile *		m_pOut;</span>
<a href="#l66.40"></a><span id="l66.40"> 	nsCString			m_mimeType;</span>
<a href="#l66.41"></a><span id="l66.41"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mailnews/import/src/nsImportScanFile.cpp</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mailnews/import/src/nsImportScanFile.cpp</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -48,35 +48,35 @@ nsImportScanFile::nsImportScanFile()</span>
<a href="#l67.4"></a><span id="l67.4"> }</span>
<a href="#l67.5"></a><span id="l67.5"> </span>
<a href="#l67.6"></a><span id="l67.6"> nsImportScanFile::~nsImportScanFile()</span>
<a href="#l67.7"></a><span id="l67.7"> {</span>
<a href="#l67.8"></a><span id="l67.8">   if (m_allocated)</span>
<a href="#l67.9"></a><span id="l67.9">     CleanUpScan();</span>
<a href="#l67.10"></a><span id="l67.10"> }</span>
<a href="#l67.11"></a><span id="l67.11"> </span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-void nsImportScanFile::InitScan( nsIInputStream *pInputStream, PRUint8 * pBuf, PRUint32 sz)</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+void nsImportScanFile::InitScan(nsIInputStream *pInputStream, PRUint8 * pBuf, PRUint32 sz)</span>
<a href="#l67.14"></a><span id="l67.14"> {</span>
<a href="#l67.15"></a><span id="l67.15">   m_pInputStream = pInputStream;</span>
<a href="#l67.16"></a><span id="l67.16">   m_pBuf = pBuf;</span>
<a href="#l67.17"></a><span id="l67.17">   m_bufSz = sz;</span>
<a href="#l67.18"></a><span id="l67.18">   m_bytesInBuf = 0;</span>
<a href="#l67.19"></a><span id="l67.19">   m_pos = 0;</span>
<a href="#l67.20"></a><span id="l67.20"> }</span>
<a href="#l67.21"></a><span id="l67.21"> </span>
<a href="#l67.22"></a><span id="l67.22" class="difflineminus">-void nsImportScanFile::CleanUpScan( void)</span>
<a href="#l67.23"></a><span id="l67.23" class="difflineplus">+void nsImportScanFile::CleanUpScan(void)</span>
<a href="#l67.24"></a><span id="l67.24"> {</span>
<a href="#l67.25"></a><span id="l67.25">   m_pInputStream = nsnull;</span>
<a href="#l67.26"></a><span id="l67.26">   if (m_allocated) {</span>
<a href="#l67.27"></a><span id="l67.27">     delete [] m_pBuf;</span>
<a href="#l67.28"></a><span id="l67.28">     m_pBuf = NULL;</span>
<a href="#l67.29"></a><span id="l67.29">   }</span>
<a href="#l67.30"></a><span id="l67.30"> }</span>
<a href="#l67.31"></a><span id="l67.31"> </span>
<a href="#l67.32"></a><span id="l67.32" class="difflineminus">-void nsImportScanFile::ShiftBuffer( void)</span>
<a href="#l67.33"></a><span id="l67.33" class="difflineplus">+void nsImportScanFile::ShiftBuffer(void)</span>
<a href="#l67.34"></a><span id="l67.34"> {</span>
<a href="#l67.35"></a><span id="l67.35">   PRUint8 *  pTop;</span>
<a href="#l67.36"></a><span id="l67.36">   PRUint8 *  pCurrent;</span>
<a href="#l67.37"></a><span id="l67.37"> </span>
<a href="#l67.38"></a><span id="l67.38">   if (m_pos &lt; m_bytesInBuf) {</span>
<a href="#l67.39"></a><span id="l67.39">     pTop = m_pBuf;</span>
<a href="#l67.40"></a><span id="l67.40">     pCurrent = pTop + m_pos;</span>
<a href="#l67.41"></a><span id="l67.41">     PRUint32    cnt = m_bytesInBuf - m_pos;</span>
<a href="#l67.42"></a><span id="l67.42" class="difflineat">@@ -86,72 +86,72 @@ void nsImportScanFile::ShiftBuffer( void</span>
<a href="#l67.43"></a><span id="l67.43">       cnt--;</span>
<a href="#l67.44"></a><span id="l67.44">     }</span>
<a href="#l67.45"></a><span id="l67.45">   }</span>
<a href="#l67.46"></a><span id="l67.46"> </span>
<a href="#l67.47"></a><span id="l67.47">   m_bytesInBuf -= m_pos;</span>
<a href="#l67.48"></a><span id="l67.48">   m_pos = 0;</span>
<a href="#l67.49"></a><span id="l67.49"> }</span>
<a href="#l67.50"></a><span id="l67.50"> </span>
<a href="#l67.51"></a><span id="l67.51" class="difflineminus">-bool nsImportScanFile::FillBufferFromFile( void)</span>
<a href="#l67.52"></a><span id="l67.52" class="difflineplus">+bool nsImportScanFile::FillBufferFromFile(void)</span>
<a href="#l67.53"></a><span id="l67.53"> {</span>
<a href="#l67.54"></a><span id="l67.54">   PRUint32 available;</span>
<a href="#l67.55"></a><span id="l67.55" class="difflineminus">-  nsresult rv = m_pInputStream-&gt;Available( &amp;available);</span>
<a href="#l67.56"></a><span id="l67.56" class="difflineplus">+  nsresult rv = m_pInputStream-&gt;Available(&amp;available);</span>
<a href="#l67.57"></a><span id="l67.57">   if (NS_FAILED(rv))</span>
<a href="#l67.58"></a><span id="l67.58" class="difflineminus">-    return( false);</span>
<a href="#l67.59"></a><span id="l67.59" class="difflineplus">+    return false;</span>
<a href="#l67.60"></a><span id="l67.60"> </span>
<a href="#l67.61"></a><span id="l67.61">   // Fill up a buffer and scan it</span>
<a href="#l67.62"></a><span id="l67.62">   ShiftBuffer();</span>
<a href="#l67.63"></a><span id="l67.63"> </span>
<a href="#l67.64"></a><span id="l67.64">   // Read in some more bytes</span>
<a href="#l67.65"></a><span id="l67.65">   PRUint32  cnt = m_bufSz - m_bytesInBuf;</span>
<a href="#l67.66"></a><span id="l67.66">   // To distinguish from disk errors</span>
<a href="#l67.67"></a><span id="l67.67">   // Check first for end of file?</span>
<a href="#l67.68"></a><span id="l67.68">   // Set a done flag if true...</span>
<a href="#l67.69"></a><span id="l67.69">   PRUint32 read;</span>
<a href="#l67.70"></a><span id="l67.70">   char *pBuf = (char *)m_pBuf;</span>
<a href="#l67.71"></a><span id="l67.71">   pBuf += m_bytesInBuf;</span>
<a href="#l67.72"></a><span id="l67.72">   rv = m_pInputStream-&gt;Read(pBuf, (PRInt32) cnt, &amp;read);</span>
<a href="#l67.73"></a><span id="l67.73"> </span>
<a href="#l67.74"></a><span id="l67.74" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l67.75"></a><span id="l67.75" class="difflineminus">-    return( false);</span>
<a href="#l67.76"></a><span id="l67.76" class="difflineminus">-  rv = m_pInputStream-&gt;Available( &amp;available);</span>
<a href="#l67.77"></a><span id="l67.77" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l67.78"></a><span id="l67.78" class="difflineplus">+    return false;</span>
<a href="#l67.79"></a><span id="l67.79" class="difflineplus">+  rv = m_pInputStream-&gt;Available(&amp;available);</span>
<a href="#l67.80"></a><span id="l67.80">   if (NS_FAILED(rv))</span>
<a href="#l67.81"></a><span id="l67.81">           m_eof = true;</span>
<a href="#l67.82"></a><span id="l67.82"> </span>
<a href="#l67.83"></a><span id="l67.83">   m_bytesInBuf += cnt;</span>
<a href="#l67.84"></a><span id="l67.84" class="difflineminus">-  return( true);</span>
<a href="#l67.85"></a><span id="l67.85" class="difflineplus">+  return true;</span>
<a href="#l67.86"></a><span id="l67.86"> }</span>
<a href="#l67.87"></a><span id="l67.87"> </span>
<a href="#l67.88"></a><span id="l67.88" class="difflineminus">-bool nsImportScanFile::Scan( bool *pDone)</span>
<a href="#l67.89"></a><span id="l67.89" class="difflineplus">+bool nsImportScanFile::Scan(bool *pDone)</span>
<a href="#l67.90"></a><span id="l67.90"> {</span>
<a href="#l67.91"></a><span id="l67.91">   PRUint32 available;</span>
<a href="#l67.92"></a><span id="l67.92" class="difflineminus">-  nsresult rv = m_pInputStream-&gt;Available( &amp;available);</span>
<a href="#l67.93"></a><span id="l67.93" class="difflineplus">+  nsresult rv = m_pInputStream-&gt;Available(&amp;available);</span>
<a href="#l67.94"></a><span id="l67.94">   if (NS_FAILED(rv))</span>
<a href="#l67.95"></a><span id="l67.95">         {</span>
<a href="#l67.96"></a><span id="l67.96">     if (m_pos &lt; m_bytesInBuf)</span>
<a href="#l67.97"></a><span id="l67.97" class="difflineminus">-      ScanBuffer( pDone);</span>
<a href="#l67.98"></a><span id="l67.98" class="difflineplus">+      ScanBuffer(pDone);</span>
<a href="#l67.99"></a><span id="l67.99">     *pDone = true;</span>
<a href="#l67.100"></a><span id="l67.100" class="difflineminus">-    return( true);</span>
<a href="#l67.101"></a><span id="l67.101" class="difflineplus">+    return true;</span>
<a href="#l67.102"></a><span id="l67.102">   }</span>
<a href="#l67.103"></a><span id="l67.103"> </span>
<a href="#l67.104"></a><span id="l67.104">   // Fill up a buffer and scan it</span>
<a href="#l67.105"></a><span id="l67.105">   if (!FillBufferFromFile())</span>
<a href="#l67.106"></a><span id="l67.106" class="difflineminus">-    return( false);</span>
<a href="#l67.107"></a><span id="l67.107" class="difflineplus">+    return false;</span>
<a href="#l67.108"></a><span id="l67.108"> </span>
<a href="#l67.109"></a><span id="l67.109" class="difflineminus">-  return( ScanBuffer( pDone));</span>
<a href="#l67.110"></a><span id="l67.110" class="difflineplus">+  return ScanBuffer(pDone);</span>
<a href="#l67.111"></a><span id="l67.111"> }</span>
<a href="#l67.112"></a><span id="l67.112"> </span>
<a href="#l67.113"></a><span id="l67.113" class="difflineminus">-bool nsImportScanFile::ScanBuffer( bool *)</span>
<a href="#l67.114"></a><span id="l67.114" class="difflineplus">+bool nsImportScanFile::ScanBuffer(bool *)</span>
<a href="#l67.115"></a><span id="l67.115"> {</span>
<a href="#l67.116"></a><span id="l67.116" class="difflineminus">-  return( true);</span>
<a href="#l67.117"></a><span id="l67.117" class="difflineplus">+  return true;</span>
<a href="#l67.118"></a><span id="l67.118"> }</span>
<a href="#l67.119"></a><span id="l67.119"> </span>
<a href="#l67.120"></a><span id="l67.120"> </span>
<a href="#l67.121"></a><span id="l67.121" class="difflineminus">-bool nsImportScanFileLines::ScanBuffer( bool *pDone)</span>
<a href="#l67.122"></a><span id="l67.122" class="difflineplus">+bool nsImportScanFileLines::ScanBuffer(bool *pDone)</span>
<a href="#l67.123"></a><span id="l67.123"> {</span>
<a href="#l67.124"></a><span id="l67.124">   // m_pos, m_bytesInBuf, m_eof, m_pBuf are relevant</span>
<a href="#l67.125"></a><span id="l67.125"> </span>
<a href="#l67.126"></a><span id="l67.126">   PRUint32    pos = m_pos;</span>
<a href="#l67.127"></a><span id="l67.127">   PRUint32    max = m_bytesInBuf;</span>
<a href="#l67.128"></a><span id="l67.128">   PRUint8 *    pChar = m_pBuf + pos;</span>
<a href="#l67.129"></a><span id="l67.129">   PRUint32    startPos;</span>
<a href="#l67.130"></a><span id="l67.130"> </span>
<a href="#l67.131"></a><span id="l67.131" class="difflineat">@@ -188,17 +188,17 @@ bool nsImportScanFileLines::ScanBuffer( </span>
<a href="#l67.132"></a><span id="l67.132">     if ((pos == max) &amp;&amp; !m_eof) {</span>
<a href="#l67.133"></a><span id="l67.133">       if (!m_pos) { // line too big for our buffer</span>
<a href="#l67.134"></a><span id="l67.134">         m_pos = pos;</span>
<a href="#l67.135"></a><span id="l67.135">         m_needEol = true;</span>
<a href="#l67.136"></a><span id="l67.136">       }</span>
<a href="#l67.137"></a><span id="l67.137">       break;</span>
<a href="#l67.138"></a><span id="l67.138">     }</span>
<a href="#l67.139"></a><span id="l67.139"> </span>
<a href="#l67.140"></a><span id="l67.140" class="difflineminus">-    if (!ProcessLine( m_pBuf + startPos, pos - startPos, pDone)) {</span>
<a href="#l67.141"></a><span id="l67.141" class="difflineminus">-      return( false);</span>
<a href="#l67.142"></a><span id="l67.142" class="difflineplus">+    if (!ProcessLine(m_pBuf + startPos, pos - startPos, pDone)) {</span>
<a href="#l67.143"></a><span id="l67.143" class="difflineplus">+      return false;</span>
<a href="#l67.144"></a><span id="l67.144">     }</span>
<a href="#l67.145"></a><span id="l67.145">     m_pos = pos;</span>
<a href="#l67.146"></a><span id="l67.146">   }</span>
<a href="#l67.147"></a><span id="l67.147"> </span>
<a href="#l67.148"></a><span id="l67.148" class="difflineminus">-  return( true);</span>
<a href="#l67.149"></a><span id="l67.149" class="difflineplus">+  return true;</span>
<a href="#l67.150"></a><span id="l67.150"> }</span>
<a href="#l67.151"></a><span id="l67.151"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/mailnews/import/src/nsImportScanFile.h</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/mailnews/import/src/nsImportScanFile.h</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -40,46 +40,46 @@</span>
<a href="#l68.4"></a><span id="l68.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l68.5"></a><span id="l68.5"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l68.6"></a><span id="l68.6"> </span>
<a href="#l68.7"></a><span id="l68.7"> class nsImportScanFile {</span>
<a href="#l68.8"></a><span id="l68.8"> public:</span>
<a href="#l68.9"></a><span id="l68.9">   nsImportScanFile();</span>
<a href="#l68.10"></a><span id="l68.10">   virtual ~nsImportScanFile();</span>
<a href="#l68.11"></a><span id="l68.11"> </span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-  void  InitScan( nsIInputStream *pInputStream, PRUint8 * pBuf, PRUint32 sz);</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+  void  InitScan(nsIInputStream *pInputStream, PRUint8 * pBuf, PRUint32 sz);</span>
<a href="#l68.14"></a><span id="l68.14"> </span>
<a href="#l68.15"></a><span id="l68.15" class="difflineminus">-  void  CleanUpScan( void);</span>
<a href="#l68.16"></a><span id="l68.16" class="difflineplus">+  void  CleanUpScan(void);</span>
<a href="#l68.17"></a><span id="l68.17"> </span>
<a href="#l68.18"></a><span id="l68.18" class="difflineminus">-  virtual  bool    Scan( bool *pDone);</span>
<a href="#l68.19"></a><span id="l68.19" class="difflineplus">+  virtual  bool    Scan(bool *pDone);</span>
<a href="#l68.20"></a><span id="l68.20"> </span>
<a href="#l68.21"></a><span id="l68.21"> protected:</span>
<a href="#l68.22"></a><span id="l68.22" class="difflineminus">-  void      ShiftBuffer( void);</span>
<a href="#l68.23"></a><span id="l68.23" class="difflineminus">-  bool        FillBufferFromFile( void);</span>
<a href="#l68.24"></a><span id="l68.24" class="difflineminus">-  virtual bool    ScanBuffer( bool *pDone);</span>
<a href="#l68.25"></a><span id="l68.25" class="difflineplus">+  void      ShiftBuffer(void);</span>
<a href="#l68.26"></a><span id="l68.26" class="difflineplus">+  bool        FillBufferFromFile(void);</span>
<a href="#l68.27"></a><span id="l68.27" class="difflineplus">+  virtual bool    ScanBuffer(bool *pDone);</span>
<a href="#l68.28"></a><span id="l68.28"> </span>
<a href="#l68.29"></a><span id="l68.29"> protected:</span>
<a href="#l68.30"></a><span id="l68.30">   nsCOMPtr &lt;nsIInputStream&gt; m_pInputStream;</span>
<a href="#l68.31"></a><span id="l68.31">   PRUint8 *    m_pBuf;</span>
<a href="#l68.32"></a><span id="l68.32">   PRUint32    m_bufSz;</span>
<a href="#l68.33"></a><span id="l68.33">   PRUint32    m_bytesInBuf;</span>
<a href="#l68.34"></a><span id="l68.34">   PRUint32    m_pos;</span>
<a href="#l68.35"></a><span id="l68.35">   bool        m_eof;</span>
<a href="#l68.36"></a><span id="l68.36">   bool        m_allocated;</span>
<a href="#l68.37"></a><span id="l68.37"> };</span>
<a href="#l68.38"></a><span id="l68.38"> </span>
<a href="#l68.39"></a><span id="l68.39"> class nsImportScanFileLines : public nsImportScanFile {</span>
<a href="#l68.40"></a><span id="l68.40"> public:</span>
<a href="#l68.41"></a><span id="l68.41">   nsImportScanFileLines() {m_needEol = false;}</span>
<a href="#l68.42"></a><span id="l68.42"> </span>
<a href="#l68.43"></a><span id="l68.43" class="difflineminus">-  void  ResetLineScan( void) { m_needEol = false;}</span>
<a href="#l68.44"></a><span id="l68.44" class="difflineplus">+  void  ResetLineScan(void) { m_needEol = false;}</span>
<a href="#l68.45"></a><span id="l68.45"> </span>
<a href="#l68.46"></a><span id="l68.46" class="difflineminus">-  virtual bool ProcessLine( PRUint8 * /* pLine */, PRUint32 /* len */, bool * /* pDone */ ) {return( true);}</span>
<a href="#l68.47"></a><span id="l68.47" class="difflineplus">+  virtual bool ProcessLine(PRUint8 * /* pLine */, PRUint32 /* len */, bool * /* pDone */) {return true;}</span>
<a href="#l68.48"></a><span id="l68.48"> </span>
<a href="#l68.49"></a><span id="l68.49"> protected:</span>
<a href="#l68.50"></a><span id="l68.50" class="difflineminus">-  virtual bool    ScanBuffer( bool *pDone);</span>
<a href="#l68.51"></a><span id="l68.51" class="difflineplus">+  virtual bool    ScanBuffer(bool *pDone);</span>
<a href="#l68.52"></a><span id="l68.52"> </span>
<a href="#l68.53"></a><span id="l68.53">   bool    m_needEol;</span>
<a href="#l68.54"></a><span id="l68.54"> </span>
<a href="#l68.55"></a><span id="l68.55"> };</span>
<a href="#l68.56"></a><span id="l68.56"> </span>
<a href="#l68.57"></a><span id="l68.57"> </span>
<a href="#l68.58"></a><span id="l68.58"> #endif /* nsImportScanFile_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/mailnews/import/src/nsImportService.cpp</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/mailnews/import/src/nsImportService.cpp</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -77,22 +77,22 @@ PRLogModuleInfo *IMPORTLOGMODULE = nsnul</span>
<a href="#l69.4"></a><span id="l69.4"> </span>
<a href="#l69.5"></a><span id="l69.5"> static nsIImportService *  gImportService = nsnull;</span>
<a href="#l69.6"></a><span id="l69.6"> static const char *  kWhitespace = &quot;\b\t\r\n &quot;;</span>
<a href="#l69.7"></a><span id="l69.7"> </span>
<a href="#l69.8"></a><span id="l69.8"> </span>
<a href="#l69.9"></a><span id="l69.9"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l69.10"></a><span id="l69.10"> </span>
<a href="#l69.11"></a><span id="l69.11"> </span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-nsImportService::nsImportService() : m_pModules( nsnull)</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineplus">+nsImportService::nsImportService() : m_pModules(nsnull)</span>
<a href="#l69.14"></a><span id="l69.14"> {</span>
<a href="#l69.15"></a><span id="l69.15">   // Init logging module.</span>
<a href="#l69.16"></a><span id="l69.16">   if (!IMPORTLOGMODULE)</span>
<a href="#l69.17"></a><span id="l69.17">     IMPORTLOGMODULE = PR_NewLogModule(&quot;IMPORT&quot;);</span>
<a href="#l69.18"></a><span id="l69.18" class="difflineminus">-  IMPORT_LOG0( &quot;* nsImport Service Created\n&quot;);</span>
<a href="#l69.19"></a><span id="l69.19" class="difflineplus">+  IMPORT_LOG0(&quot;* nsImport Service Created\n&quot;);</span>
<a href="#l69.20"></a><span id="l69.20"> </span>
<a href="#l69.21"></a><span id="l69.21">   m_didDiscovery = false;</span>
<a href="#l69.22"></a><span id="l69.22">   m_pDecoder = nsnull;</span>
<a href="#l69.23"></a><span id="l69.23">   m_pEncoder = nsnull;</span>
<a href="#l69.24"></a><span id="l69.24"> </span>
<a href="#l69.25"></a><span id="l69.25">   nsresult rv = nsImportStringBundle::GetStringBundle(IMPORT_MSGS_URL, getter_AddRefs(m_stringBundle));</span>
<a href="#l69.26"></a><span id="l69.26">   if (NS_FAILED(rv))</span>
<a href="#l69.27"></a><span id="l69.27">     IMPORT_LOG0(&quot;Failed to get string bundle for Importing Mail&quot;);</span>
<a href="#l69.28"></a><span id="l69.28" class="difflineat">@@ -104,36 +104,36 @@ nsImportService::~nsImportService()</span>
<a href="#l69.29"></a><span id="l69.29">   NS_IF_RELEASE(m_pDecoder);</span>
<a href="#l69.30"></a><span id="l69.30">   NS_IF_RELEASE(m_pEncoder);</span>
<a href="#l69.31"></a><span id="l69.31"> </span>
<a href="#l69.32"></a><span id="l69.32">   gImportService = nsnull;</span>
<a href="#l69.33"></a><span id="l69.33"> </span>
<a href="#l69.34"></a><span id="l69.34">     if (m_pModules != nsnull)</span>
<a href="#l69.35"></a><span id="l69.35">         delete m_pModules;</span>
<a href="#l69.36"></a><span id="l69.36"> </span>
<a href="#l69.37"></a><span id="l69.37" class="difflineminus">-  IMPORT_LOG0( &quot;* nsImport Service Deleted\n&quot;);</span>
<a href="#l69.38"></a><span id="l69.38" class="difflineplus">+  IMPORT_LOG0(&quot;* nsImport Service Deleted\n&quot;);</span>
<a href="#l69.39"></a><span id="l69.39"> }</span>
<a href="#l69.40"></a><span id="l69.40"> </span>
<a href="#l69.41"></a><span id="l69.41"> </span>
<a href="#l69.42"></a><span id="l69.42"> </span>
<a href="#l69.43"></a><span id="l69.43"> NS_IMPL_THREADSAFE_ISUPPORTS1(nsImportService, nsIImportService)</span>
<a href="#l69.44"></a><span id="l69.44"> </span>
<a href="#l69.45"></a><span id="l69.45"> </span>
<a href="#l69.46"></a><span id="l69.46" class="difflineminus">-NS_IMETHODIMP nsImportService::DiscoverModules( void)</span>
<a href="#l69.47"></a><span id="l69.47" class="difflineplus">+NS_IMETHODIMP nsImportService::DiscoverModules(void)</span>
<a href="#l69.48"></a><span id="l69.48"> {</span>
<a href="#l69.49"></a><span id="l69.49">   m_didDiscovery = false;</span>
<a href="#l69.50"></a><span id="l69.50" class="difflineminus">-  return( DoDiscover());</span>
<a href="#l69.51"></a><span id="l69.51" class="difflineplus">+  return DoDiscover();</span>
<a href="#l69.52"></a><span id="l69.52"> }</span>
<a href="#l69.53"></a><span id="l69.53"> </span>
<a href="#l69.54"></a><span id="l69.54" class="difflineminus">-NS_IMETHODIMP nsImportService::CreateNewFieldMap( nsIImportFieldMap **_retval)</span>
<a href="#l69.55"></a><span id="l69.55" class="difflineplus">+NS_IMETHODIMP nsImportService::CreateNewFieldMap(nsIImportFieldMap **_retval)</span>
<a href="#l69.56"></a><span id="l69.56"> {</span>
<a href="#l69.57"></a><span id="l69.57">   return nsImportFieldMap::Create(m_stringBundle, nsnull, NS_GET_IID(nsIImportFieldMap), (void**)_retval);</span>
<a href="#l69.58"></a><span id="l69.58"> }</span>
<a href="#l69.59"></a><span id="l69.59"> </span>
<a href="#l69.60"></a><span id="l69.60" class="difflineminus">-NS_IMETHODIMP nsImportService::CreateNewMailboxDescriptor( nsIImportMailboxDescriptor **_retval)</span>
<a href="#l69.61"></a><span id="l69.61" class="difflineplus">+NS_IMETHODIMP nsImportService::CreateNewMailboxDescriptor(nsIImportMailboxDescriptor **_retval)</span>
<a href="#l69.62"></a><span id="l69.62"> {</span>
<a href="#l69.63"></a><span id="l69.63">   return nsImportMailboxDescriptor::Create(nsnull, NS_GET_IID(nsIImportMailboxDescriptor), (void**)_retval);</span>
<a href="#l69.64"></a><span id="l69.64"> }</span>
<a href="#l69.65"></a><span id="l69.65"> </span>
<a href="#l69.66"></a><span id="l69.66"> NS_IMETHODIMP nsImportService::CreateNewABDescriptor(nsIImportABDescriptor **_retval)</span>
<a href="#l69.67"></a><span id="l69.67"> {</span>
<a href="#l69.68"></a><span id="l69.68">   return nsImportABDescriptor::Create(nsnull, NS_GET_IID(nsIImportABDescriptor), (void**)_retval);</span>
<a href="#l69.69"></a><span id="l69.69"> }</span>
<a href="#l69.70"></a><span id="l69.70" class="difflineat">@@ -141,185 +141,187 @@ NS_IMETHODIMP nsImportService::CreateNew</span>
<a href="#l69.71"></a><span id="l69.71"> extern nsresult NS_NewGenericMail(nsIImportGeneric** aImportGeneric);</span>
<a href="#l69.72"></a><span id="l69.72"> </span>
<a href="#l69.73"></a><span id="l69.73"> NS_IMETHODIMP nsImportService::CreateNewGenericMail(nsIImportGeneric **_retval)</span>
<a href="#l69.74"></a><span id="l69.74"> {</span>
<a href="#l69.75"></a><span id="l69.75">     NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l69.76"></a><span id="l69.76">     if (! _retval)</span>
<a href="#l69.77"></a><span id="l69.77">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l69.78"></a><span id="l69.78"> </span>
<a href="#l69.79"></a><span id="l69.79" class="difflineminus">-  return( NS_NewGenericMail( _retval));</span>
<a href="#l69.80"></a><span id="l69.80" class="difflineplus">+  return NS_NewGenericMail(_retval);</span>
<a href="#l69.81"></a><span id="l69.81"> }</span>
<a href="#l69.82"></a><span id="l69.82"> </span>
<a href="#l69.83"></a><span id="l69.83"> extern nsresult NS_NewGenericAddressBooks(nsIImportGeneric** aImportGeneric);</span>
<a href="#l69.84"></a><span id="l69.84"> </span>
<a href="#l69.85"></a><span id="l69.85"> NS_IMETHODIMP nsImportService::CreateNewGenericAddressBooks(nsIImportGeneric **_retval)</span>
<a href="#l69.86"></a><span id="l69.86"> {</span>
<a href="#l69.87"></a><span id="l69.87">     NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l69.88"></a><span id="l69.88">     if (! _retval)</span>
<a href="#l69.89"></a><span id="l69.89">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l69.90"></a><span id="l69.90"> </span>
<a href="#l69.91"></a><span id="l69.91" class="difflineminus">-  return( NS_NewGenericAddressBooks( _retval));</span>
<a href="#l69.92"></a><span id="l69.92" class="difflineplus">+  return NS_NewGenericAddressBooks(_retval);</span>
<a href="#l69.93"></a><span id="l69.93"> }</span>
<a href="#l69.94"></a><span id="l69.94"> </span>
<a href="#l69.95"></a><span id="l69.95"> </span>
<a href="#l69.96"></a><span id="l69.96" class="difflineminus">-NS_IMETHODIMP nsImportService::GetModuleCount( const char *filter, PRInt32 *_retval)</span>
<a href="#l69.97"></a><span id="l69.97" class="difflineplus">+NS_IMETHODIMP nsImportService::GetModuleCount(const char *filter, PRInt32 *_retval)</span>
<a href="#l69.98"></a><span id="l69.98"> {</span>
<a href="#l69.99"></a><span id="l69.99">     NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l69.100"></a><span id="l69.100">     if (! _retval)</span>
<a href="#l69.101"></a><span id="l69.101">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l69.102"></a><span id="l69.102"> </span>
<a href="#l69.103"></a><span id="l69.103">   DoDiscover();</span>
<a href="#l69.104"></a><span id="l69.104"> </span>
<a href="#l69.105"></a><span id="l69.105">   if (m_pModules != nsnull) {</span>
<a href="#l69.106"></a><span id="l69.106">     ImportModuleDesc *  pDesc;</span>
<a href="#l69.107"></a><span id="l69.107">     PRInt32  count = 0;</span>
<a href="#l69.108"></a><span id="l69.108">     for (PRInt32 i = 0; i &lt; m_pModules-&gt;GetCount(); i++) {</span>
<a href="#l69.109"></a><span id="l69.109" class="difflineminus">-      pDesc = m_pModules-&gt;GetModuleDesc( i);</span>
<a href="#l69.110"></a><span id="l69.110" class="difflineminus">-      if (pDesc-&gt;SupportsThings( filter))</span>
<a href="#l69.111"></a><span id="l69.111" class="difflineplus">+      pDesc = m_pModules-&gt;GetModuleDesc(i);</span>
<a href="#l69.112"></a><span id="l69.112" class="difflineplus">+      if (pDesc-&gt;SupportsThings(filter))</span>
<a href="#l69.113"></a><span id="l69.113">         count++;</span>
<a href="#l69.114"></a><span id="l69.114">     }</span>
<a href="#l69.115"></a><span id="l69.115">     *_retval = count;</span>
<a href="#l69.116"></a><span id="l69.116">   }</span>
<a href="#l69.117"></a><span id="l69.117">   else</span>
<a href="#l69.118"></a><span id="l69.118">     *_retval = 0;</span>
<a href="#l69.119"></a><span id="l69.119"> </span>
<a href="#l69.120"></a><span id="l69.120" class="difflineminus">-  return( NS_OK);</span>
<a href="#l69.121"></a><span id="l69.121" class="difflineplus">+  return NS_OK;</span>
<a href="#l69.122"></a><span id="l69.122"> }</span>
<a href="#l69.123"></a><span id="l69.123"> </span>
<a href="#l69.124"></a><span id="l69.124" class="difflineminus">-NS_IMETHODIMP nsImportService::GetModuleWithCID( const nsCID&amp; cid, nsIImportModule **ppModule)</span>
<a href="#l69.125"></a><span id="l69.125" class="difflineplus">+NS_IMETHODIMP nsImportService::GetModuleWithCID(const nsCID&amp; cid, nsIImportModule **ppModule)</span>
<a href="#l69.126"></a><span id="l69.126"> {</span>
<a href="#l69.127"></a><span id="l69.127" class="difflineminus">-    NS_PRECONDITION(ppModule != nsnull, &quot;null ptr&quot;);</span>
<a href="#l69.128"></a><span id="l69.128" class="difflineminus">-    if (! ppModule)</span>
<a href="#l69.129"></a><span id="l69.129" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l69.130"></a><span id="l69.130" class="difflineplus">+  NS_PRECONDITION(ppModule != nsnull, &quot;null ptr&quot;);</span>
<a href="#l69.131"></a><span id="l69.131" class="difflineplus">+  if (!ppModule)</span>
<a href="#l69.132"></a><span id="l69.132" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l69.133"></a><span id="l69.133"> </span>
<a href="#l69.134"></a><span id="l69.134">   *ppModule = nsnull;</span>
<a href="#l69.135"></a><span id="l69.135">   nsresult rv = DoDiscover();</span>
<a href="#l69.136"></a><span id="l69.136" class="difflineminus">-  if (NS_FAILED( rv)) return( rv);</span>
<a href="#l69.137"></a><span id="l69.137" class="difflineminus">-  if (m_pModules == nsnull) return( NS_ERROR_FAILURE);</span>
<a href="#l69.138"></a><span id="l69.138" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l69.139"></a><span id="l69.139" class="difflineplus">+    return rv;</span>
<a href="#l69.140"></a><span id="l69.140" class="difflineplus">+  if (m_pModules == nsnull)</span>
<a href="#l69.141"></a><span id="l69.141" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l69.142"></a><span id="l69.142">   PRInt32  cnt = m_pModules-&gt;GetCount();</span>
<a href="#l69.143"></a><span id="l69.143">   ImportModuleDesc *pDesc;</span>
<a href="#l69.144"></a><span id="l69.144">   for (PRInt32 i = 0; i &lt; cnt; i++) {</span>
<a href="#l69.145"></a><span id="l69.145" class="difflineminus">-    pDesc = m_pModules-&gt;GetModuleDesc( i);</span>
<a href="#l69.146"></a><span id="l69.146" class="difflineminus">-    if (!pDesc) return( NS_ERROR_FAILURE);</span>
<a href="#l69.147"></a><span id="l69.147" class="difflineminus">-    if (pDesc-&gt;GetCID().Equals( cid)) {</span>
<a href="#l69.148"></a><span id="l69.148" class="difflineplus">+    pDesc = m_pModules-&gt;GetModuleDesc(i);</span>
<a href="#l69.149"></a><span id="l69.149" class="difflineplus">+    if (!pDesc)</span>
<a href="#l69.150"></a><span id="l69.150" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l69.151"></a><span id="l69.151" class="difflineplus">+    if (pDesc-&gt;GetCID().Equals(cid)) {</span>
<a href="#l69.152"></a><span id="l69.152">       *ppModule = pDesc-&gt;GetModule();</span>
<a href="#l69.153"></a><span id="l69.153"> </span>
<a href="#l69.154"></a><span id="l69.154" class="difflineminus">-      IMPORT_LOG0( &quot;* nsImportService::GetSpecificModule - attempted to load module\n&quot;);</span>
<a href="#l69.155"></a><span id="l69.155" class="difflineplus">+      IMPORT_LOG0(&quot;* nsImportService::GetSpecificModule - attempted to load module\n&quot;);</span>
<a href="#l69.156"></a><span id="l69.156"> </span>
<a href="#l69.157"></a><span id="l69.157">       if (*ppModule == nsnull)</span>
<a href="#l69.158"></a><span id="l69.158" class="difflineminus">-        return( NS_ERROR_FAILURE);</span>
<a href="#l69.159"></a><span id="l69.159" class="difflineminus">-      else</span>
<a href="#l69.160"></a><span id="l69.160" class="difflineminus">-        return( NS_OK);</span>
<a href="#l69.161"></a><span id="l69.161" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l69.162"></a><span id="l69.162" class="difflineplus">+      return NS_OK;</span>
<a href="#l69.163"></a><span id="l69.163">     }</span>
<a href="#l69.164"></a><span id="l69.164">   }</span>
<a href="#l69.165"></a><span id="l69.165"> </span>
<a href="#l69.166"></a><span id="l69.166" class="difflineminus">-  IMPORT_LOG0( &quot;* nsImportService::GetSpecificModule - module not found\n&quot;);</span>
<a href="#l69.167"></a><span id="l69.167" class="difflineplus">+  IMPORT_LOG0(&quot;* nsImportService::GetSpecificModule - module not found\n&quot;);</span>
<a href="#l69.168"></a><span id="l69.168"> </span>
<a href="#l69.169"></a><span id="l69.169" class="difflineminus">-  return( NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l69.170"></a><span id="l69.170" class="difflineplus">+  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l69.171"></a><span id="l69.171"> }</span>
<a href="#l69.172"></a><span id="l69.172"> </span>
<a href="#l69.173"></a><span id="l69.173" class="difflineminus">-NS_IMETHODIMP nsImportService::GetModuleInfo( const char *filter, PRInt32 index, PRUnichar **name, PRUnichar **moduleDescription)</span>
<a href="#l69.174"></a><span id="l69.174" class="difflineplus">+NS_IMETHODIMP nsImportService::GetModuleInfo(const char *filter, PRInt32 index, PRUnichar **name, PRUnichar **moduleDescription)</span>
<a href="#l69.175"></a><span id="l69.175"> {</span>
<a href="#l69.176"></a><span id="l69.176">     NS_PRECONDITION(name != nsnull, &quot;null ptr&quot;);</span>
<a href="#l69.177"></a><span id="l69.177">     NS_PRECONDITION(moduleDescription != nsnull, &quot;null ptr&quot;);</span>
<a href="#l69.178"></a><span id="l69.178">     if (!name || !moduleDescription)</span>
<a href="#l69.179"></a><span id="l69.179">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l69.180"></a><span id="l69.180"> </span>
<a href="#l69.181"></a><span id="l69.181">   *name = nsnull;</span>
<a href="#l69.182"></a><span id="l69.182">   *moduleDescription = nsnull;</span>
<a href="#l69.183"></a><span id="l69.183"> </span>
<a href="#l69.184"></a><span id="l69.184">     DoDiscover();</span>
<a href="#l69.185"></a><span id="l69.185">     if (!m_pModules)</span>
<a href="#l69.186"></a><span id="l69.186" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l69.187"></a><span id="l69.187" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l69.188"></a><span id="l69.188"> </span>
<a href="#l69.189"></a><span id="l69.189">   if ((index &lt; 0) || (index &gt;= m_pModules-&gt;GetCount()))</span>
<a href="#l69.190"></a><span id="l69.190" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l69.191"></a><span id="l69.191" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l69.192"></a><span id="l69.192"> </span>
<a href="#l69.193"></a><span id="l69.193">   ImportModuleDesc *  pDesc;</span>
<a href="#l69.194"></a><span id="l69.194">   PRInt32  count = 0;</span>
<a href="#l69.195"></a><span id="l69.195">   for (PRInt32 i = 0; i &lt; m_pModules-&gt;GetCount(); i++) {</span>
<a href="#l69.196"></a><span id="l69.196" class="difflineminus">-    pDesc = m_pModules-&gt;GetModuleDesc( i);</span>
<a href="#l69.197"></a><span id="l69.197" class="difflineminus">-    if (pDesc-&gt;SupportsThings( filter)) {</span>
<a href="#l69.198"></a><span id="l69.198" class="difflineplus">+    pDesc = m_pModules-&gt;GetModuleDesc(i);</span>
<a href="#l69.199"></a><span id="l69.199" class="difflineplus">+    if (pDesc-&gt;SupportsThings(filter)) {</span>
<a href="#l69.200"></a><span id="l69.200">       if (count == index) {</span>
<a href="#l69.201"></a><span id="l69.201" class="difflineminus">-        *name = NS_strdup( pDesc-&gt;GetName());</span>
<a href="#l69.202"></a><span id="l69.202" class="difflineminus">-        *moduleDescription = NS_strdup( pDesc-&gt;GetDescription());</span>
<a href="#l69.203"></a><span id="l69.203" class="difflineminus">-        return( NS_OK);</span>
<a href="#l69.204"></a><span id="l69.204" class="difflineplus">+        *name = NS_strdup(pDesc-&gt;GetName());</span>
<a href="#l69.205"></a><span id="l69.205" class="difflineplus">+        *moduleDescription = NS_strdup(pDesc-&gt;GetDescription());</span>
<a href="#l69.206"></a><span id="l69.206" class="difflineplus">+        return NS_OK;</span>
<a href="#l69.207"></a><span id="l69.207">       }</span>
<a href="#l69.208"></a><span id="l69.208">       else</span>
<a href="#l69.209"></a><span id="l69.209">         count++;</span>
<a href="#l69.210"></a><span id="l69.210">     }</span>
<a href="#l69.211"></a><span id="l69.211">   }</span>
<a href="#l69.212"></a><span id="l69.212"> </span>
<a href="#l69.213"></a><span id="l69.213" class="difflineminus">-  return( NS_ERROR_FAILURE);</span>
<a href="#l69.214"></a><span id="l69.214" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l69.215"></a><span id="l69.215"> }</span>
<a href="#l69.216"></a><span id="l69.216"> </span>
<a href="#l69.217"></a><span id="l69.217"> NS_IMETHODIMP nsImportService::GetModuleName(const char *filter, PRInt32 index, PRUnichar **_retval)</span>
<a href="#l69.218"></a><span id="l69.218"> {</span>
<a href="#l69.219"></a><span id="l69.219">     NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l69.220"></a><span id="l69.220">     if (!_retval)</span>
<a href="#l69.221"></a><span id="l69.221">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l69.222"></a><span id="l69.222"> </span>
<a href="#l69.223"></a><span id="l69.223">   *_retval = nsnull;</span>
<a href="#l69.224"></a><span id="l69.224"> </span>
<a href="#l69.225"></a><span id="l69.225">     DoDiscover();</span>
<a href="#l69.226"></a><span id="l69.226">     if (!m_pModules)</span>
<a href="#l69.227"></a><span id="l69.227" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l69.228"></a><span id="l69.228" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l69.229"></a><span id="l69.229"> </span>
<a href="#l69.230"></a><span id="l69.230">   if ((index &lt; 0) || (index &gt;= m_pModules-&gt;GetCount()))</span>
<a href="#l69.231"></a><span id="l69.231" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l69.232"></a><span id="l69.232" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l69.233"></a><span id="l69.233"> </span>
<a href="#l69.234"></a><span id="l69.234">   ImportModuleDesc *  pDesc;</span>
<a href="#l69.235"></a><span id="l69.235">   PRInt32  count = 0;</span>
<a href="#l69.236"></a><span id="l69.236">   for (PRInt32 i = 0; i &lt; m_pModules-&gt;GetCount(); i++) {</span>
<a href="#l69.237"></a><span id="l69.237" class="difflineminus">-    pDesc = m_pModules-&gt;GetModuleDesc( i);</span>
<a href="#l69.238"></a><span id="l69.238" class="difflineminus">-    if (pDesc-&gt;SupportsThings( filter)) {</span>
<a href="#l69.239"></a><span id="l69.239" class="difflineplus">+    pDesc = m_pModules-&gt;GetModuleDesc(i);</span>
<a href="#l69.240"></a><span id="l69.240" class="difflineplus">+    if (pDesc-&gt;SupportsThings(filter)) {</span>
<a href="#l69.241"></a><span id="l69.241">       if (count == index) {</span>
<a href="#l69.242"></a><span id="l69.242" class="difflineminus">-        *_retval = NS_strdup( pDesc-&gt;GetName());</span>
<a href="#l69.243"></a><span id="l69.243" class="difflineminus">-        return( NS_OK);</span>
<a href="#l69.244"></a><span id="l69.244" class="difflineplus">+        *_retval = NS_strdup(pDesc-&gt;GetName());</span>
<a href="#l69.245"></a><span id="l69.245" class="difflineplus">+        return NS_OK;</span>
<a href="#l69.246"></a><span id="l69.246">       }</span>
<a href="#l69.247"></a><span id="l69.247">       else</span>
<a href="#l69.248"></a><span id="l69.248">         count++;</span>
<a href="#l69.249"></a><span id="l69.249">     }</span>
<a href="#l69.250"></a><span id="l69.250">   }</span>
<a href="#l69.251"></a><span id="l69.251"> </span>
<a href="#l69.252"></a><span id="l69.252" class="difflineminus">-  return( NS_ERROR_FAILURE);</span>
<a href="#l69.253"></a><span id="l69.253" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l69.254"></a><span id="l69.254"> }</span>
<a href="#l69.255"></a><span id="l69.255"> </span>
<a href="#l69.256"></a><span id="l69.256"> </span>
<a href="#l69.257"></a><span id="l69.257"> NS_IMETHODIMP nsImportService::GetModuleDescription(const char *filter, PRInt32 index, PRUnichar **_retval)</span>
<a href="#l69.258"></a><span id="l69.258"> {</span>
<a href="#l69.259"></a><span id="l69.259">     NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l69.260"></a><span id="l69.260">     if (!_retval)</span>
<a href="#l69.261"></a><span id="l69.261">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l69.262"></a><span id="l69.262"> </span>
<a href="#l69.263"></a><span id="l69.263">   *_retval = nsnull;</span>
<a href="#l69.264"></a><span id="l69.264"> </span>
<a href="#l69.265"></a><span id="l69.265">     DoDiscover();</span>
<a href="#l69.266"></a><span id="l69.266">     if (!m_pModules)</span>
<a href="#l69.267"></a><span id="l69.267" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l69.268"></a><span id="l69.268" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l69.269"></a><span id="l69.269"> </span>
<a href="#l69.270"></a><span id="l69.270">   if ((index &lt; 0) || (index &gt;= m_pModules-&gt;GetCount()))</span>
<a href="#l69.271"></a><span id="l69.271" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l69.272"></a><span id="l69.272" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l69.273"></a><span id="l69.273"> </span>
<a href="#l69.274"></a><span id="l69.274">   ImportModuleDesc *  pDesc;</span>
<a href="#l69.275"></a><span id="l69.275">   PRInt32  count = 0;</span>
<a href="#l69.276"></a><span id="l69.276">   for (PRInt32 i = 0; i &lt; m_pModules-&gt;GetCount(); i++) {</span>
<a href="#l69.277"></a><span id="l69.277" class="difflineminus">-    pDesc = m_pModules-&gt;GetModuleDesc( i);</span>
<a href="#l69.278"></a><span id="l69.278" class="difflineminus">-    if (pDesc-&gt;SupportsThings( filter)) {</span>
<a href="#l69.279"></a><span id="l69.279" class="difflineplus">+    pDesc = m_pModules-&gt;GetModuleDesc(i);</span>
<a href="#l69.280"></a><span id="l69.280" class="difflineplus">+    if (pDesc-&gt;SupportsThings(filter)) {</span>
<a href="#l69.281"></a><span id="l69.281">       if (count == index) {</span>
<a href="#l69.282"></a><span id="l69.282" class="difflineminus">-        *_retval = NS_strdup( pDesc-&gt;GetDescription());</span>
<a href="#l69.283"></a><span id="l69.283" class="difflineminus">-        return( NS_OK);</span>
<a href="#l69.284"></a><span id="l69.284" class="difflineplus">+        *_retval = NS_strdup(pDesc-&gt;GetDescription());</span>
<a href="#l69.285"></a><span id="l69.285" class="difflineplus">+        return NS_OK;</span>
<a href="#l69.286"></a><span id="l69.286">       }</span>
<a href="#l69.287"></a><span id="l69.287">       else</span>
<a href="#l69.288"></a><span id="l69.288">         count++;</span>
<a href="#l69.289"></a><span id="l69.289">     }</span>
<a href="#l69.290"></a><span id="l69.290">   }</span>
<a href="#l69.291"></a><span id="l69.291"> </span>
<a href="#l69.292"></a><span id="l69.292" class="difflineminus">-  return( NS_ERROR_FAILURE);</span>
<a href="#l69.293"></a><span id="l69.293" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l69.294"></a><span id="l69.294"> }</span>
<a href="#l69.295"></a><span id="l69.295"> </span>
<a href="#l69.296"></a><span id="l69.296"> class nsProxySendRunnable : public nsRunnable</span>
<a href="#l69.297"></a><span id="l69.297"> {</span>
<a href="#l69.298"></a><span id="l69.298"> public:</span>
<a href="#l69.299"></a><span id="l69.299">   nsProxySendRunnable(nsIMsgIdentity *aIdentity,</span>
<a href="#l69.300"></a><span id="l69.300">                        nsIMsgCompFields *aMsgFields,</span>
<a href="#l69.301"></a><span id="l69.301">                        const char *attachment1_type,</span>
<a href="#l69.302"></a><span id="l69.302" class="difflineat">@@ -394,225 +396,225 @@ nsImportService::CreateRFC822Message(nsI</span>
<a href="#l69.303"></a><span id="l69.303">                               aIsDraft,</span>
<a href="#l69.304"></a><span id="l69.304">                               aLoadedAttachments,</span>
<a href="#l69.305"></a><span id="l69.305">                               aEmbeddedAttachments,</span>
<a href="#l69.306"></a><span id="l69.306">                               aListener);</span>
<a href="#l69.307"></a><span id="l69.307">     // invoke the callback</span>
<a href="#l69.308"></a><span id="l69.308">     return NS_DispatchToMainThread(runnable);</span>
<a href="#l69.309"></a><span id="l69.309"> }</span>
<a href="#l69.310"></a><span id="l69.310"> </span>
<a href="#l69.311"></a><span id="l69.311" class="difflineminus">-NS_IMETHODIMP nsImportService::GetModule( const char *filter, PRInt32 index, nsIImportModule **_retval)</span>
<a href="#l69.312"></a><span id="l69.312" class="difflineplus">+NS_IMETHODIMP nsImportService::GetModule(const char *filter, PRInt32 index, nsIImportModule **_retval)</span>
<a href="#l69.313"></a><span id="l69.313"> {</span>
<a href="#l69.314"></a><span id="l69.314">     NS_PRECONDITION(_retval != nsnull, &quot;null ptr&quot;);</span>
<a href="#l69.315"></a><span id="l69.315">     if (!_retval)</span>
<a href="#l69.316"></a><span id="l69.316">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l69.317"></a><span id="l69.317">   *_retval = nsnull;</span>
<a href="#l69.318"></a><span id="l69.318"> </span>
<a href="#l69.319"></a><span id="l69.319">     DoDiscover();</span>
<a href="#l69.320"></a><span id="l69.320">     if (!m_pModules)</span>
<a href="#l69.321"></a><span id="l69.321" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l69.322"></a><span id="l69.322" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l69.323"></a><span id="l69.323"> </span>
<a href="#l69.324"></a><span id="l69.324">   if ((index &lt; 0) || (index &gt;= m_pModules-&gt;GetCount()))</span>
<a href="#l69.325"></a><span id="l69.325" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l69.326"></a><span id="l69.326" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l69.327"></a><span id="l69.327"> </span>
<a href="#l69.328"></a><span id="l69.328">   ImportModuleDesc *  pDesc;</span>
<a href="#l69.329"></a><span id="l69.329">   PRInt32  count = 0;</span>
<a href="#l69.330"></a><span id="l69.330">   for (PRInt32 i = 0; i &lt; m_pModules-&gt;GetCount(); i++) {</span>
<a href="#l69.331"></a><span id="l69.331" class="difflineminus">-    pDesc = m_pModules-&gt;GetModuleDesc( i);</span>
<a href="#l69.332"></a><span id="l69.332" class="difflineminus">-    if (pDesc-&gt;SupportsThings( filter)) {</span>
<a href="#l69.333"></a><span id="l69.333" class="difflineplus">+    pDesc = m_pModules-&gt;GetModuleDesc(i);</span>
<a href="#l69.334"></a><span id="l69.334" class="difflineplus">+    if (pDesc-&gt;SupportsThings(filter)) {</span>
<a href="#l69.335"></a><span id="l69.335">       if (count == index) {</span>
<a href="#l69.336"></a><span id="l69.336">         *_retval = pDesc-&gt;GetModule();</span>
<a href="#l69.337"></a><span id="l69.337">         break;</span>
<a href="#l69.338"></a><span id="l69.338">       }</span>
<a href="#l69.339"></a><span id="l69.339">       else</span>
<a href="#l69.340"></a><span id="l69.340">         count++;</span>
<a href="#l69.341"></a><span id="l69.341">     }</span>
<a href="#l69.342"></a><span id="l69.342">   }</span>
<a href="#l69.343"></a><span id="l69.343">   if (! (*_retval))</span>
<a href="#l69.344"></a><span id="l69.344" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l69.345"></a><span id="l69.345" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l69.346"></a><span id="l69.346"> </span>
<a href="#l69.347"></a><span id="l69.347" class="difflineminus">-  return( NS_OK);</span>
<a href="#l69.348"></a><span id="l69.348" class="difflineplus">+  return NS_OK;</span>
<a href="#l69.349"></a><span id="l69.349"> }</span>
<a href="#l69.350"></a><span id="l69.350"> </span>
<a href="#l69.351"></a><span id="l69.351"> </span>
<a href="#l69.352"></a><span id="l69.352" class="difflineminus">-nsresult nsImportService::DoDiscover( void)</span>
<a href="#l69.353"></a><span id="l69.353" class="difflineplus">+nsresult nsImportService::DoDiscover(void)</span>
<a href="#l69.354"></a><span id="l69.354"> {</span>
<a href="#l69.355"></a><span id="l69.355">   if (m_didDiscovery)</span>
<a href="#l69.356"></a><span id="l69.356" class="difflineminus">-    return( NS_OK);</span>
<a href="#l69.357"></a><span id="l69.357" class="difflineplus">+    return NS_OK;</span>
<a href="#l69.358"></a><span id="l69.358"> </span>
<a href="#l69.359"></a><span id="l69.359">   if (m_pModules != nsnull)</span>
<a href="#l69.360"></a><span id="l69.360">     m_pModules-&gt;ClearList();</span>
<a href="#l69.361"></a><span id="l69.361"> </span>
<a href="#l69.362"></a><span id="l69.362">   nsresult rv;</span>
<a href="#l69.363"></a><span id="l69.363"> </span>
<a href="#l69.364"></a><span id="l69.364" class="difflineminus">-  nsCOMPtr&lt;nsICategoryManager&gt; catMan = do_GetService( NS_CATEGORYMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l69.365"></a><span id="l69.365" class="difflineplus">+  nsCOMPtr&lt;nsICategoryManager&gt; catMan = do_GetService(NS_CATEGORYMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l69.366"></a><span id="l69.366">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.367"></a><span id="l69.367"> </span>
<a href="#l69.368"></a><span id="l69.368">   nsCOMPtr&lt;nsISimpleEnumerator&gt; e;</span>
<a href="#l69.369"></a><span id="l69.369" class="difflineminus">-  rv = catMan-&gt;EnumerateCategory( &quot;mailnewsimport&quot;, getter_AddRefs( e));</span>
<a href="#l69.370"></a><span id="l69.370" class="difflineplus">+  rv = catMan-&gt;EnumerateCategory(&quot;mailnewsimport&quot;, getter_AddRefs(e));</span>
<a href="#l69.371"></a><span id="l69.371">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.372"></a><span id="l69.372">   nsCOMPtr&lt;nsISupportsCString&gt; contractid;</span>
<a href="#l69.373"></a><span id="l69.373" class="difflineminus">-  rv = e-&gt;GetNext( getter_AddRefs( contractid));</span>
<a href="#l69.374"></a><span id="l69.374" class="difflineminus">-  while (NS_SUCCEEDED( rv) &amp;&amp; contractid)</span>
<a href="#l69.375"></a><span id="l69.375" class="difflineplus">+  rv = e-&gt;GetNext(getter_AddRefs(contractid));</span>
<a href="#l69.376"></a><span id="l69.376" class="difflineplus">+  while (NS_SUCCEEDED(rv) &amp;&amp; contractid)</span>
<a href="#l69.377"></a><span id="l69.377">   {</span>
<a href="#l69.378"></a><span id="l69.378">     nsCString contractIdStr;</span>
<a href="#l69.379"></a><span id="l69.379" class="difflineminus">-    contractid-&gt;ToString( getter_Copies( contractIdStr));</span>
<a href="#l69.380"></a><span id="l69.380" class="difflineplus">+    contractid-&gt;ToString(getter_Copies(contractIdStr));</span>
<a href="#l69.381"></a><span id="l69.381">     nsCString supportsStr;</span>
<a href="#l69.382"></a><span id="l69.382" class="difflineminus">-    rv = catMan-&gt;GetCategoryEntry( &quot;mailnewsimport&quot;, contractIdStr.get(), getter_Copies( supportsStr));</span>
<a href="#l69.383"></a><span id="l69.383" class="difflineminus">-    if (NS_SUCCEEDED( rv))</span>
<a href="#l69.384"></a><span id="l69.384" class="difflineminus">-      LoadModuleInfo( contractIdStr.get(), supportsStr.get());</span>
<a href="#l69.385"></a><span id="l69.385" class="difflineminus">-    rv = e-&gt;GetNext( getter_AddRefs( contractid));</span>
<a href="#l69.386"></a><span id="l69.386" class="difflineplus">+    rv = catMan-&gt;GetCategoryEntry(&quot;mailnewsimport&quot;, contractIdStr.get(), getter_Copies(supportsStr));</span>
<a href="#l69.387"></a><span id="l69.387" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l69.388"></a><span id="l69.388" class="difflineplus">+      LoadModuleInfo(contractIdStr.get(), supportsStr.get());</span>
<a href="#l69.389"></a><span id="l69.389" class="difflineplus">+    rv = e-&gt;GetNext(getter_AddRefs(contractid));</span>
<a href="#l69.390"></a><span id="l69.390">   }</span>
<a href="#l69.391"></a><span id="l69.391"> </span>
<a href="#l69.392"></a><span id="l69.392">   m_didDiscovery = true;</span>
<a href="#l69.393"></a><span id="l69.393"> </span>
<a href="#l69.394"></a><span id="l69.394">   return NS_OK;</span>
<a href="#l69.395"></a><span id="l69.395"> }</span>
<a href="#l69.396"></a><span id="l69.396"> </span>
<a href="#l69.397"></a><span id="l69.397" class="difflineminus">-nsresult nsImportService::LoadModuleInfo( const char *pClsId, const char *pSupports)</span>
<a href="#l69.398"></a><span id="l69.398" class="difflineplus">+nsresult nsImportService::LoadModuleInfo(const char *pClsId, const char *pSupports)</span>
<a href="#l69.399"></a><span id="l69.399"> {</span>
<a href="#l69.400"></a><span id="l69.400">   if (!pClsId || !pSupports)</span>
<a href="#l69.401"></a><span id="l69.401" class="difflineminus">-    return( NS_OK);</span>
<a href="#l69.402"></a><span id="l69.402" class="difflineplus">+    return NS_OK;</span>
<a href="#l69.403"></a><span id="l69.403"> </span>
<a href="#l69.404"></a><span id="l69.404">   if (m_pModules == nsnull)</span>
<a href="#l69.405"></a><span id="l69.405">     m_pModules = new nsImportModuleList();</span>
<a href="#l69.406"></a><span id="l69.406"> </span>
<a href="#l69.407"></a><span id="l69.407">   // load the component and get all of the info we need from it....</span>
<a href="#l69.408"></a><span id="l69.408">   // then call AddModule</span>
<a href="#l69.409"></a><span id="l69.409">   nsresult  rv;</span>
<a href="#l69.410"></a><span id="l69.410"> </span>
<a href="#l69.411"></a><span id="l69.411">   nsCID        clsId;</span>
<a href="#l69.412"></a><span id="l69.412" class="difflineminus">-  clsId.Parse( pClsId);</span>
<a href="#l69.413"></a><span id="l69.413" class="difflineplus">+  clsId.Parse(pClsId);</span>
<a href="#l69.414"></a><span id="l69.414">   nsIImportModule *  module;</span>
<a href="#l69.415"></a><span id="l69.415" class="difflineminus">-  rv = CallCreateInstance( clsId, &amp;module);</span>
<a href="#l69.416"></a><span id="l69.416" class="difflineplus">+  rv = CallCreateInstance(clsId, &amp;module);</span>
<a href="#l69.417"></a><span id="l69.417">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l69.418"></a><span id="l69.418"> </span>
<a href="#l69.419"></a><span id="l69.419">   nsString  theTitle;</span>
<a href="#l69.420"></a><span id="l69.420">   nsString  theDescription;</span>
<a href="#l69.421"></a><span id="l69.421">   rv = module-&gt;GetName(getter_Copies(theTitle));</span>
<a href="#l69.422"></a><span id="l69.422" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l69.423"></a><span id="l69.423" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l69.424"></a><span id="l69.424">     theTitle.AssignLiteral(&quot;Unknown&quot;);</span>
<a href="#l69.425"></a><span id="l69.425"> </span>
<a href="#l69.426"></a><span id="l69.426">   rv = module-&gt;GetDescription(getter_Copies(theDescription));</span>
<a href="#l69.427"></a><span id="l69.427" class="difflineminus">-  if (NS_FAILED( rv))</span>
<a href="#l69.428"></a><span id="l69.428" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l69.429"></a><span id="l69.429">     theDescription.AssignLiteral(&quot;Unknown description&quot;);</span>
<a href="#l69.430"></a><span id="l69.430"> </span>
<a href="#l69.431"></a><span id="l69.431">   // call the module to get the info we need</span>
<a href="#l69.432"></a><span id="l69.432" class="difflineminus">-  m_pModules-&gt;AddModule( clsId, pSupports, theTitle.get(), theDescription.get());</span>
<a href="#l69.433"></a><span id="l69.433" class="difflineplus">+  m_pModules-&gt;AddModule(clsId, pSupports, theTitle.get(), theDescription.get());</span>
<a href="#l69.434"></a><span id="l69.434"> </span>
<a href="#l69.435"></a><span id="l69.435">   module-&gt;Release();</span>
<a href="#l69.436"></a><span id="l69.436"> </span>
<a href="#l69.437"></a><span id="l69.437">   return NS_OK;</span>
<a href="#l69.438"></a><span id="l69.438"> }</span>
<a href="#l69.439"></a><span id="l69.439"> </span>
<a href="#l69.440"></a><span id="l69.440"> </span>
<a href="#l69.441"></a><span id="l69.441" class="difflineminus">-nsIImportModule *ImportModuleDesc::GetModule( bool keepLoaded)</span>
<a href="#l69.442"></a><span id="l69.442" class="difflineplus">+nsIImportModule *ImportModuleDesc::GetModule(bool keepLoaded)</span>
<a href="#l69.443"></a><span id="l69.443"> {</span>
<a href="#l69.444"></a><span id="l69.444">   if (m_pModule)</span>
<a href="#l69.445"></a><span id="l69.445">   {</span>
<a href="#l69.446"></a><span id="l69.446">     m_pModule-&gt;AddRef();</span>
<a href="#l69.447"></a><span id="l69.447" class="difflineminus">-    return( m_pModule);</span>
<a href="#l69.448"></a><span id="l69.448" class="difflineplus">+    return m_pModule;</span>
<a href="#l69.449"></a><span id="l69.449">   }</span>
<a href="#l69.450"></a><span id="l69.450"> </span>
<a href="#l69.451"></a><span id="l69.451">   nsresult  rv;</span>
<a href="#l69.452"></a><span id="l69.452" class="difflineminus">-  rv = CallCreateInstance( m_cid, &amp;m_pModule);</span>
<a href="#l69.453"></a><span id="l69.453" class="difflineplus">+  rv = CallCreateInstance(m_cid, &amp;m_pModule);</span>
<a href="#l69.454"></a><span id="l69.454">   if (NS_FAILED(rv))</span>
<a href="#l69.455"></a><span id="l69.455">   {</span>
<a href="#l69.456"></a><span id="l69.456">     m_pModule = nsnull;</span>
<a href="#l69.457"></a><span id="l69.457">     return nsnull;</span>
<a href="#l69.458"></a><span id="l69.458">   }</span>
<a href="#l69.459"></a><span id="l69.459"> </span>
<a href="#l69.460"></a><span id="l69.460">   if (keepLoaded)</span>
<a href="#l69.461"></a><span id="l69.461">   {</span>
<a href="#l69.462"></a><span id="l69.462">     m_pModule-&gt;AddRef();</span>
<a href="#l69.463"></a><span id="l69.463" class="difflineminus">-    return( m_pModule);</span>
<a href="#l69.464"></a><span id="l69.464" class="difflineplus">+    return m_pModule;</span>
<a href="#l69.465"></a><span id="l69.465">   }</span>
<a href="#l69.466"></a><span id="l69.466">   else</span>
<a href="#l69.467"></a><span id="l69.467">   {</span>
<a href="#l69.468"></a><span id="l69.468">     nsIImportModule *pModule = m_pModule;</span>
<a href="#l69.469"></a><span id="l69.469">     m_pModule = nsnull;</span>
<a href="#l69.470"></a><span id="l69.470" class="difflineminus">-    return( pModule);</span>
<a href="#l69.471"></a><span id="l69.471" class="difflineplus">+    return pModule;</span>
<a href="#l69.472"></a><span id="l69.472">   }</span>
<a href="#l69.473"></a><span id="l69.473"> }</span>
<a href="#l69.474"></a><span id="l69.474"> </span>
<a href="#l69.475"></a><span id="l69.475" class="difflineminus">-void ImportModuleDesc::ReleaseModule( void)</span>
<a href="#l69.476"></a><span id="l69.476" class="difflineplus">+void ImportModuleDesc::ReleaseModule(void)</span>
<a href="#l69.477"></a><span id="l69.477"> {</span>
<a href="#l69.478"></a><span id="l69.478">   if (m_pModule)</span>
<a href="#l69.479"></a><span id="l69.479">   {</span>
<a href="#l69.480"></a><span id="l69.480">     m_pModule-&gt;Release();</span>
<a href="#l69.481"></a><span id="l69.481">     m_pModule = nsnull;</span>
<a href="#l69.482"></a><span id="l69.482">   }</span>
<a href="#l69.483"></a><span id="l69.483"> }</span>
<a href="#l69.484"></a><span id="l69.484"> </span>
<a href="#l69.485"></a><span id="l69.485" class="difflineminus">-bool ImportModuleDesc::SupportsThings( const char *pThings)</span>
<a href="#l69.486"></a><span id="l69.486" class="difflineplus">+bool ImportModuleDesc::SupportsThings(const char *pThings)</span>
<a href="#l69.487"></a><span id="l69.487"> {</span>
<a href="#l69.488"></a><span id="l69.488">   if (!pThings || !*pThings)</span>
<a href="#l69.489"></a><span id="l69.489">     return true;</span>
<a href="#l69.490"></a><span id="l69.490"> </span>
<a href="#l69.491"></a><span id="l69.491">   nsCString thing(pThings);</span>
<a href="#l69.492"></a><span id="l69.492">   nsCString item;</span>
<a href="#l69.493"></a><span id="l69.493">   PRInt32 idx;</span>
<a href="#l69.494"></a><span id="l69.494"> </span>
<a href="#l69.495"></a><span id="l69.495" class="difflineminus">-  while ((idx = thing.FindChar( ',')) != -1)</span>
<a href="#l69.496"></a><span id="l69.496" class="difflineplus">+  while ((idx = thing.FindChar(',')) != -1)</span>
<a href="#l69.497"></a><span id="l69.497">   {</span>
<a href="#l69.498"></a><span id="l69.498">     item = StringHead(thing, idx);</span>
<a href="#l69.499"></a><span id="l69.499" class="difflineminus">-    item.Trim( kWhitespace);</span>
<a href="#l69.500"></a><span id="l69.500" class="difflineplus">+    item.Trim(kWhitespace);</span>
<a href="#l69.501"></a><span id="l69.501">     ToLowerCase(item);</span>
<a href="#l69.502"></a><span id="l69.502" class="difflineminus">-    if (item.Length() &amp;&amp; (m_supports.Find( item) == -1))</span>
<a href="#l69.503"></a><span id="l69.503" class="difflineplus">+    if (item.Length() &amp;&amp; (m_supports.Find(item) == -1))</span>
<a href="#l69.504"></a><span id="l69.504">       return false;</span>
<a href="#l69.505"></a><span id="l69.505">     thing = Substring(thing, idx + 1);</span>
<a href="#l69.506"></a><span id="l69.506">   }</span>
<a href="#l69.507"></a><span id="l69.507" class="difflineminus">-  thing.Trim( kWhitespace);</span>
<a href="#l69.508"></a><span id="l69.508" class="difflineplus">+  thing.Trim(kWhitespace);</span>
<a href="#l69.509"></a><span id="l69.509">   ToLowerCase(thing);</span>
<a href="#l69.510"></a><span id="l69.510">   return thing.IsEmpty() || (m_supports.Find(thing) != -1);</span>
<a href="#l69.511"></a><span id="l69.511"> }</span>
<a href="#l69.512"></a><span id="l69.512"> </span>
<a href="#l69.513"></a><span id="l69.513" class="difflineminus">-void nsImportModuleList::ClearList( void)</span>
<a href="#l69.514"></a><span id="l69.514" class="difflineplus">+void nsImportModuleList::ClearList(void)</span>
<a href="#l69.515"></a><span id="l69.515"> {</span>
<a href="#l69.516"></a><span id="l69.516">   if (m_pList)</span>
<a href="#l69.517"></a><span id="l69.517">   {</span>
<a href="#l69.518"></a><span id="l69.518">     for (int i = 0; i &lt; m_count; i++)</span>
<a href="#l69.519"></a><span id="l69.519">     {</span>
<a href="#l69.520"></a><span id="l69.520">       delete m_pList[i];</span>
<a href="#l69.521"></a><span id="l69.521">       m_pList[i] = nsnull;</span>
<a href="#l69.522"></a><span id="l69.522">     }</span>
<a href="#l69.523"></a><span id="l69.523">     m_count = 0;</span>
<a href="#l69.524"></a><span id="l69.524">     delete [] m_pList;</span>
<a href="#l69.525"></a><span id="l69.525">     m_pList = nsnull;</span>
<a href="#l69.526"></a><span id="l69.526">     m_alloc = 0;</span>
<a href="#l69.527"></a><span id="l69.527">   }</span>
<a href="#l69.528"></a><span id="l69.528"> </span>
<a href="#l69.529"></a><span id="l69.529"> }</span>
<a href="#l69.530"></a><span id="l69.530"> </span>
<a href="#l69.531"></a><span id="l69.531" class="difflineminus">-void nsImportModuleList::AddModule( const nsCID&amp; cid, const char *pSupports, const PRUnichar *pName, const PRUnichar *pDesc)</span>
<a href="#l69.532"></a><span id="l69.532" class="difflineplus">+void nsImportModuleList::AddModule(const nsCID&amp; cid, const char *pSupports, const PRUnichar *pName, const PRUnichar *pDesc)</span>
<a href="#l69.533"></a><span id="l69.533"> {</span>
<a href="#l69.534"></a><span id="l69.534">   if (!m_pList)</span>
<a href="#l69.535"></a><span id="l69.535">   {</span>
<a href="#l69.536"></a><span id="l69.536">     m_alloc = 10;</span>
<a href="#l69.537"></a><span id="l69.537">     m_pList = new ImportModuleDesc *[m_alloc];</span>
<a href="#l69.538"></a><span id="l69.538">     m_count = 0;</span>
<a href="#l69.539"></a><span id="l69.539" class="difflineminus">-    memset( m_pList, 0, sizeof( ImportModuleDesc *) * m_alloc);</span>
<a href="#l69.540"></a><span id="l69.540" class="difflineplus">+    memset(m_pList, 0, sizeof(ImportModuleDesc *) * m_alloc);</span>
<a href="#l69.541"></a><span id="l69.541">   }</span>
<a href="#l69.542"></a><span id="l69.542"> </span>
<a href="#l69.543"></a><span id="l69.543">   if (m_count == m_alloc)</span>
<a href="#l69.544"></a><span id="l69.544">   {</span>
<a href="#l69.545"></a><span id="l69.545">     ImportModuleDesc **pList = new ImportModuleDesc *[m_alloc + 10];</span>
<a href="#l69.546"></a><span id="l69.546" class="difflineminus">-    memset( &amp;(pList[m_alloc]), 0, sizeof( ImportModuleDesc *) * 10);</span>
<a href="#l69.547"></a><span id="l69.547" class="difflineminus">-    memcpy( pList, m_pList, sizeof( ImportModuleDesc *) * m_alloc);</span>
<a href="#l69.548"></a><span id="l69.548" class="difflineplus">+    memset(&amp;(pList[m_alloc]), 0, sizeof(ImportModuleDesc *) * 10);</span>
<a href="#l69.549"></a><span id="l69.549" class="difflineplus">+    memcpy(pList, m_pList, sizeof(ImportModuleDesc *) * m_alloc);</span>
<a href="#l69.550"></a><span id="l69.550">     for(int i = 0; i &lt; m_count; i++)</span>
<a href="#l69.551"></a><span id="l69.551">       delete m_pList[i];</span>
<a href="#l69.552"></a><span id="l69.552">     delete [] m_pList;</span>
<a href="#l69.553"></a><span id="l69.553">     m_pList = pList;</span>
<a href="#l69.554"></a><span id="l69.554">     m_alloc += 10;</span>
<a href="#l69.555"></a><span id="l69.555">   }</span>
<a href="#l69.556"></a><span id="l69.556"> </span>
<a href="#l69.557"></a><span id="l69.557">   m_pList[m_count] = new ImportModuleDesc();</span>
<a href="#l69.558"></a><span id="l69.558" class="difflineminus">-  m_pList[m_count]-&gt;SetCID( cid);</span>
<a href="#l69.559"></a><span id="l69.559" class="difflineminus">-  m_pList[m_count]-&gt;SetSupports( pSupports);</span>
<a href="#l69.560"></a><span id="l69.560" class="difflineminus">-  m_pList[m_count]-&gt;SetName( pName);</span>
<a href="#l69.561"></a><span id="l69.561" class="difflineminus">-  m_pList[m_count]-&gt;SetDescription( pDesc);</span>
<a href="#l69.562"></a><span id="l69.562" class="difflineplus">+  m_pList[m_count]-&gt;SetCID(cid);</span>
<a href="#l69.563"></a><span id="l69.563" class="difflineplus">+  m_pList[m_count]-&gt;SetSupports(pSupports);</span>
<a href="#l69.564"></a><span id="l69.564" class="difflineplus">+  m_pList[m_count]-&gt;SetName(pName);</span>
<a href="#l69.565"></a><span id="l69.565" class="difflineplus">+  m_pList[m_count]-&gt;SetDescription(pDesc);</span>
<a href="#l69.566"></a><span id="l69.566"> </span>
<a href="#l69.567"></a><span id="l69.567">   m_count++;</span>
<a href="#l69.568"></a><span id="l69.568"> #ifdef IMPORT_DEBUG</span>
<a href="#l69.569"></a><span id="l69.569" class="difflineminus">-  IMPORT_LOG3( &quot;* nsImportService registered import module: %s, %s, %s\n&quot;, NS_LossyConvertUTF16toASCII(pName).get(), NS_LossyConvertUTF16toASCII(pDesc).get(), pSupports);</span>
<a href="#l69.570"></a><span id="l69.570" class="difflineplus">+  IMPORT_LOG3(&quot;* nsImportService registered import module: %s, %s, %s\n&quot;, NS_LossyConvertUTF16toASCII(pName).get(), NS_LossyConvertUTF16toASCII(pDesc).get(), pSupports);</span>
<a href="#l69.571"></a><span id="l69.571"> #endif</span>
<a href="#l69.572"></a><span id="l69.572"> }</span>
<a href="#l69.573"></a><span id="l69.573"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/mailnews/import/src/nsImportService.h</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/mailnews/import/src/nsImportService.h</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -60,69 +60,69 @@ public:</span>
<a href="#l70.4"></a><span id="l70.4">   nsImportService();</span>
<a href="#l70.5"></a><span id="l70.5">   virtual ~nsImportService();</span>
<a href="#l70.6"></a><span id="l70.6"> </span>
<a href="#l70.7"></a><span id="l70.7">   NS_DECL_ISUPPORTS</span>
<a href="#l70.8"></a><span id="l70.8"> </span>
<a href="#l70.9"></a><span id="l70.9">     NS_DECL_NSIIMPORTSERVICE</span>
<a href="#l70.10"></a><span id="l70.10"> </span>
<a href="#l70.11"></a><span id="l70.11"> private:</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-    nsresult LoadModuleInfo( const char*pClsId, const char *pSupports);</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineminus">-  nsresult DoDiscover( void);</span>
<a href="#l70.14"></a><span id="l70.14" class="difflineplus">+    nsresult LoadModuleInfo(const char*pClsId, const char *pSupports);</span>
<a href="#l70.15"></a><span id="l70.15" class="difflineplus">+  nsresult DoDiscover(void);</span>
<a href="#l70.16"></a><span id="l70.16"> </span>
<a href="#l70.17"></a><span id="l70.17"> private:</span>
<a href="#l70.18"></a><span id="l70.18">     nsImportModuleList * m_pModules;</span>
<a href="#l70.19"></a><span id="l70.19">   bool m_didDiscovery;</span>
<a href="#l70.20"></a><span id="l70.20">   nsCString m_sysCharset;</span>
<a href="#l70.21"></a><span id="l70.21">   nsIUnicodeDecoder * m_pDecoder;</span>
<a href="#l70.22"></a><span id="l70.22">   nsIUnicodeEncoder * m_pEncoder;</span>
<a href="#l70.23"></a><span id="l70.23">   nsCOMPtr&lt;nsIStringBundle&gt; m_stringBundle;</span>
<a href="#l70.24"></a><span id="l70.24"> };</span>
<a href="#l70.25"></a><span id="l70.25"> </span>
<a href="#l70.26"></a><span id="l70.26"> class ImportModuleDesc {</span>
<a href="#l70.27"></a><span id="l70.27"> public:</span>
<a href="#l70.28"></a><span id="l70.28">   ImportModuleDesc() { m_pModule = nsnull;}</span>
<a href="#l70.29"></a><span id="l70.29">   ~ImportModuleDesc() { ReleaseModule();  }</span>
<a href="#l70.30"></a><span id="l70.30"> </span>
<a href="#l70.31"></a><span id="l70.31" class="difflineminus">-  void  SetCID( const nsCID&amp; cid) { m_cid = cid;}</span>
<a href="#l70.32"></a><span id="l70.32" class="difflineminus">-  void  SetName( const PRUnichar *pName) { m_name = pName;}</span>
<a href="#l70.33"></a><span id="l70.33" class="difflineminus">-  void  SetDescription( const PRUnichar *pDesc) { m_description = pDesc;}</span>
<a href="#l70.34"></a><span id="l70.34" class="difflineminus">-  void  SetSupports( const char *pSupports) { m_supports = pSupports;}</span>
<a href="#l70.35"></a><span id="l70.35" class="difflineplus">+  void  SetCID(const nsCID&amp; cid) { m_cid = cid;}</span>
<a href="#l70.36"></a><span id="l70.36" class="difflineplus">+  void  SetName(const PRUnichar *pName) { m_name = pName;}</span>
<a href="#l70.37"></a><span id="l70.37" class="difflineplus">+  void  SetDescription(const PRUnichar *pDesc) { m_description = pDesc;}</span>
<a href="#l70.38"></a><span id="l70.38" class="difflineplus">+  void  SetSupports(const char *pSupports) { m_supports = pSupports;}</span>
<a href="#l70.39"></a><span id="l70.39"> </span>
<a href="#l70.40"></a><span id="l70.40" class="difflineminus">-  nsCID      GetCID( void) { return( m_cid);}</span>
<a href="#l70.41"></a><span id="l70.41" class="difflineminus">-  const PRUnichar *GetName( void) { return( m_name.get());}</span>
<a href="#l70.42"></a><span id="l70.42" class="difflineminus">-  const PRUnichar *GetDescription( void) { return( m_description.get());}</span>
<a href="#l70.43"></a><span id="l70.43" class="difflineminus">-  const char *  GetSupports( void) { return( m_supports.get());}</span>
<a href="#l70.44"></a><span id="l70.44" class="difflineplus">+  nsCID      GetCID(void) { return m_cid;}</span>
<a href="#l70.45"></a><span id="l70.45" class="difflineplus">+  const PRUnichar *GetName(void) { return m_name.get();}</span>
<a href="#l70.46"></a><span id="l70.46" class="difflineplus">+  const PRUnichar *GetDescription(void) { return m_description.get();}</span>
<a href="#l70.47"></a><span id="l70.47" class="difflineplus">+  const char *  GetSupports(void) { return m_supports.get();}</span>
<a href="#l70.48"></a><span id="l70.48"> </span>
<a href="#l70.49"></a><span id="l70.49" class="difflineminus">-  nsIImportModule *  GetModule( bool keepLoaded = false); // Adds ref</span>
<a href="#l70.50"></a><span id="l70.50" class="difflineminus">-  void        ReleaseModule( void);</span>
<a href="#l70.51"></a><span id="l70.51" class="difflineplus">+  nsIImportModule *  GetModule(bool keepLoaded = false); // Adds ref</span>
<a href="#l70.52"></a><span id="l70.52" class="difflineplus">+  void        ReleaseModule(void);</span>
<a href="#l70.53"></a><span id="l70.53"> </span>
<a href="#l70.54"></a><span id="l70.54" class="difflineminus">-  bool        SupportsThings( const char *pThings);</span>
<a href="#l70.55"></a><span id="l70.55" class="difflineplus">+  bool        SupportsThings(const char *pThings);</span>
<a href="#l70.56"></a><span id="l70.56"> </span>
<a href="#l70.57"></a><span id="l70.57"> private:</span>
<a href="#l70.58"></a><span id="l70.58">     nsCID m_cid;</span>
<a href="#l70.59"></a><span id="l70.59">   nsString m_name;</span>
<a href="#l70.60"></a><span id="l70.60">   nsString m_description;</span>
<a href="#l70.61"></a><span id="l70.61">   nsCString m_supports;</span>
<a href="#l70.62"></a><span id="l70.62">   nsIImportModule *m_pModule;</span>
<a href="#l70.63"></a><span id="l70.63"> };</span>
<a href="#l70.64"></a><span id="l70.64"> </span>
<a href="#l70.65"></a><span id="l70.65"> class nsImportModuleList {</span>
<a href="#l70.66"></a><span id="l70.66"> public:</span>
<a href="#l70.67"></a><span id="l70.67">   nsImportModuleList() { m_pList = nsnull; m_alloc = 0; m_count = 0;}</span>
<a href="#l70.68"></a><span id="l70.68">   ~nsImportModuleList() { ClearList(); }</span>
<a href="#l70.69"></a><span id="l70.69"> </span>
<a href="#l70.70"></a><span id="l70.70" class="difflineminus">-  void  AddModule( const nsCID&amp; cid, const char *pSupports, const PRUnichar *pName, const PRUnichar *pDesc);</span>
<a href="#l70.71"></a><span id="l70.71" class="difflineplus">+  void  AddModule(const nsCID&amp; cid, const char *pSupports, const PRUnichar *pName, const PRUnichar *pDesc);</span>
<a href="#l70.72"></a><span id="l70.72"> </span>
<a href="#l70.73"></a><span id="l70.73" class="difflineminus">-  void  ClearList( void);</span>
<a href="#l70.74"></a><span id="l70.74" class="difflineplus">+  void  ClearList(void);</span>
<a href="#l70.75"></a><span id="l70.75"> </span>
<a href="#l70.76"></a><span id="l70.76" class="difflineminus">-  PRInt32  GetCount( void) { return( m_count);}</span>
<a href="#l70.77"></a><span id="l70.77" class="difflineplus">+  PRInt32  GetCount(void) { return m_count;}</span>
<a href="#l70.78"></a><span id="l70.78"> </span>
<a href="#l70.79"></a><span id="l70.79" class="difflineminus">-  ImportModuleDesc *  GetModuleDesc( PRInt32 idx)</span>
<a href="#l70.80"></a><span id="l70.80" class="difflineminus">-    { if ((idx &lt; 0) || (idx &gt;= m_count)) return( nsnull); else return( m_pList[idx]);}</span>
<a href="#l70.81"></a><span id="l70.81" class="difflineplus">+  ImportModuleDesc *  GetModuleDesc(PRInt32 idx)</span>
<a href="#l70.82"></a><span id="l70.82" class="difflineplus">+    { if ((idx &lt; 0) || (idx &gt;= m_count)) return nsnull; else return m_pList[idx];}</span>
<a href="#l70.83"></a><span id="l70.83"> </span>
<a href="#l70.84"></a><span id="l70.84"> private:</span>
<a href="#l70.85"></a><span id="l70.85"> </span>
<a href="#l70.86"></a><span id="l70.86"> private:</span>
<a href="#l70.87"></a><span id="l70.87">     ImportModuleDesc **  m_pList;</span>
<a href="#l70.88"></a><span id="l70.88">   PRInt32        m_alloc;</span>
<a href="#l70.89"></a><span id="l70.89">   PRInt32        m_count;</span>
<a href="#l70.90"></a><span id="l70.90"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/mailnews/import/src/nsImportStringBundle.cpp</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/mailnews/import/src/nsImportStringBundle.cpp</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -69,17 +69,17 @@ PRUnichar *nsImportStringBundle::GetStri</span>
<a href="#l71.4"></a><span id="l71.4">                                                nsIStringBundle *aBundle)</span>
<a href="#l71.5"></a><span id="l71.5"> {</span>
<a href="#l71.6"></a><span id="l71.6">   if (aBundle)</span>
<a href="#l71.7"></a><span id="l71.7">   {</span>
<a href="#l71.8"></a><span id="l71.8">     PRUnichar *ptrv = nsnull;</span>
<a href="#l71.9"></a><span id="l71.9">     nsresult rv = aBundle-&gt;GetStringFromID(aStringID, &amp;ptrv);</span>
<a href="#l71.10"></a><span id="l71.10"> </span>
<a href="#l71.11"></a><span id="l71.11">     if (NS_SUCCEEDED(rv) &amp;&amp; ptrv)</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineminus">-      return(ptrv);</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineplus">+      return ptrv;</span>
<a href="#l71.14"></a><span id="l71.14">   }</span>
<a href="#l71.15"></a><span id="l71.15"> </span>
<a href="#l71.16"></a><span id="l71.16">   nsString resultString(NS_LITERAL_STRING(&quot;[StringID &quot;));</span>
<a href="#l71.17"></a><span id="l71.17">   resultString.AppendInt(aStringID);</span>
<a href="#l71.18"></a><span id="l71.18">   resultString.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l71.19"></a><span id="l71.19"> </span>
<a href="#l71.20"></a><span id="l71.20">   return ToNewUnicode(resultString);</span>
<a href="#l71.21"></a><span id="l71.21"> }</span>
<a href="#l71.22"></a><span id="l71.22" class="difflineat">@@ -96,17 +96,17 @@ PRUnichar *nsImportStringBundle::GetStri</span>
<a href="#l71.23"></a><span id="l71.23"> {</span>
<a href="#l71.24"></a><span id="l71.24">   if (aBundle)</span>
<a href="#l71.25"></a><span id="l71.25">   {</span>
<a href="#l71.26"></a><span id="l71.26">     PRUnichar *ptrv = nsnull;</span>
<a href="#l71.27"></a><span id="l71.27">     nsresult rv = aBundle-&gt;GetStringFromName(</span>
<a href="#l71.28"></a><span id="l71.28">         NS_ConvertUTF8toUTF16(aName).get(), &amp;ptrv);</span>
<a href="#l71.29"></a><span id="l71.29"> </span>
<a href="#l71.30"></a><span id="l71.30">     if (NS_SUCCEEDED(rv) &amp;&amp; ptrv)</span>
<a href="#l71.31"></a><span id="l71.31" class="difflineminus">-      return(ptrv);</span>
<a href="#l71.32"></a><span id="l71.32" class="difflineplus">+      return ptrv;</span>
<a href="#l71.33"></a><span id="l71.33">   }</span>
<a href="#l71.34"></a><span id="l71.34"> </span>
<a href="#l71.35"></a><span id="l71.35">   nsString resultString(NS_LITERAL_STRING(&quot;[StringName &quot;));</span>
<a href="#l71.36"></a><span id="l71.36">   resultString.Append(NS_ConvertUTF8toUTF16(aName).get());</span>
<a href="#l71.37"></a><span id="l71.37">   resultString.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l71.38"></a><span id="l71.38"> </span>
<a href="#l71.39"></a><span id="l71.39">   return ToNewUnicode(resultString);</span>
<a href="#l71.40"></a><span id="l71.40"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/mailnews/import/src/nsImportTranslator.cpp</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/mailnews/import/src/nsImportTranslator.cpp</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -36,260 +36,260 @@</span>
<a href="#l72.4"></a><span id="l72.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l72.5"></a><span id="l72.5"> </span>
<a href="#l72.6"></a><span id="l72.6"> #include &quot;ImportOutFile.h&quot;</span>
<a href="#l72.7"></a><span id="l72.7"> #include &quot;nsImportTranslator.h&quot;</span>
<a href="#l72.8"></a><span id="l72.8"> </span>
<a href="#l72.9"></a><span id="l72.9"> #include &quot;ImportCharSet.h&quot;</span>
<a href="#l72.10"></a><span id="l72.10"> </span>
<a href="#l72.11"></a><span id="l72.11"> </span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-bool nsImportTranslator::ConvertToFile( const PRUint8 * pIn, PRUint32 inLen, ImportOutFile *pOutFile, PRUint32 *pProcessed)</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineplus">+bool nsImportTranslator::ConvertToFile(const PRUint8 * pIn, PRUint32 inLen, ImportOutFile *pOutFile, PRUint32 *pProcessed)</span>
<a href="#l72.14"></a><span id="l72.14"> {</span>
<a href="#l72.15"></a><span id="l72.15">   if (pProcessed)</span>
<a href="#l72.16"></a><span id="l72.16">     *pProcessed = inLen;</span>
<a href="#l72.17"></a><span id="l72.17" class="difflineminus">-  return( pOutFile-&gt;WriteData( pIn, inLen));</span>
<a href="#l72.18"></a><span id="l72.18" class="difflineplus">+  return (pOutFile-&gt;WriteData(pIn, inLen));</span>
<a href="#l72.19"></a><span id="l72.19"> }</span>
<a href="#l72.20"></a><span id="l72.20"> </span>
<a href="#l72.21"></a><span id="l72.21" class="difflineminus">-void CMHTranslator::ConvertBuffer( const PRUint8 * pIn, PRUint32 inLen, PRUint8 * pOut)</span>
<a href="#l72.22"></a><span id="l72.22" class="difflineplus">+void CMHTranslator::ConvertBuffer(const PRUint8 * pIn, PRUint32 inLen, PRUint8 * pOut)</span>
<a href="#l72.23"></a><span id="l72.23"> {</span>
<a href="#l72.24"></a><span id="l72.24">   while (inLen) {</span>
<a href="#l72.25"></a><span id="l72.25" class="difflineminus">-    if (!ImportCharSet::IsUSAscii( *pIn) || ImportCharSet::Is822SpecialChar( *pIn) || ImportCharSet::Is822CtlChar( *pIn) ||</span>
<a href="#l72.26"></a><span id="l72.26" class="difflineplus">+    if (!ImportCharSet::IsUSAscii(*pIn) || ImportCharSet::Is822SpecialChar(*pIn) || ImportCharSet::Is822CtlChar(*pIn) ||</span>
<a href="#l72.27"></a><span id="l72.27">       (*pIn == ImportCharSet::cSpaceChar) || (*pIn == '*') || (*pIn == '\'') ||</span>
<a href="#l72.28"></a><span id="l72.28">       (*pIn == '%')) {</span>
<a href="#l72.29"></a><span id="l72.29">       // needs to be encode as %hex val</span>
<a href="#l72.30"></a><span id="l72.30">       *pOut = '%'; pOut++;</span>
<a href="#l72.31"></a><span id="l72.31" class="difflineminus">-      ImportCharSet::ByteToHex( *pIn, pOut);</span>
<a href="#l72.32"></a><span id="l72.32" class="difflineplus">+      ImportCharSet::ByteToHex(*pIn, pOut);</span>
<a href="#l72.33"></a><span id="l72.33">       pOut += 2;</span>
<a href="#l72.34"></a><span id="l72.34">     }</span>
<a href="#l72.35"></a><span id="l72.35">     else {</span>
<a href="#l72.36"></a><span id="l72.36">       *pOut = *pIn;</span>
<a href="#l72.37"></a><span id="l72.37">       pOut++;</span>
<a href="#l72.38"></a><span id="l72.38">     }</span>
<a href="#l72.39"></a><span id="l72.39">     pIn++; inLen--;</span>
<a href="#l72.40"></a><span id="l72.40">   }</span>
<a href="#l72.41"></a><span id="l72.41">   *pOut = 0;</span>
<a href="#l72.42"></a><span id="l72.42"> }</span>
<a href="#l72.43"></a><span id="l72.43"> </span>
<a href="#l72.44"></a><span id="l72.44" class="difflineminus">-bool CMHTranslator::ConvertToFile( const PRUint8 * pIn, PRUint32 inLen, ImportOutFile *pOutFile, PRUint32 *pProcessed)</span>
<a href="#l72.45"></a><span id="l72.45" class="difflineplus">+bool CMHTranslator::ConvertToFile(const PRUint8 * pIn, PRUint32 inLen, ImportOutFile *pOutFile, PRUint32 *pProcessed)</span>
<a href="#l72.46"></a><span id="l72.46"> {</span>
<a href="#l72.47"></a><span id="l72.47">   PRUint8    hex[2];</span>
<a href="#l72.48"></a><span id="l72.48">   while (inLen) {</span>
<a href="#l72.49"></a><span id="l72.49" class="difflineminus">-    if (!ImportCharSet::IsUSAscii( *pIn) || ImportCharSet::Is822SpecialChar( *pIn) || ImportCharSet::Is822CtlChar( *pIn) ||</span>
<a href="#l72.50"></a><span id="l72.50" class="difflineplus">+    if (!ImportCharSet::IsUSAscii(*pIn) || ImportCharSet::Is822SpecialChar(*pIn) || ImportCharSet::Is822CtlChar(*pIn) ||</span>
<a href="#l72.51"></a><span id="l72.51">       (*pIn == ImportCharSet::cSpaceChar) || (*pIn == '*') || (*pIn == '\'') ||</span>
<a href="#l72.52"></a><span id="l72.52">       (*pIn == '%')) {</span>
<a href="#l72.53"></a><span id="l72.53">       // needs to be encode as %hex val</span>
<a href="#l72.54"></a><span id="l72.54" class="difflineminus">-      if (!pOutFile-&gt;WriteByte( '%'))</span>
<a href="#l72.55"></a><span id="l72.55" class="difflineminus">-        return( false);</span>
<a href="#l72.56"></a><span id="l72.56" class="difflineminus">-      ImportCharSet::ByteToHex( *pIn, hex);</span>
<a href="#l72.57"></a><span id="l72.57" class="difflineminus">-      if (!pOutFile-&gt;WriteData( hex, 2))</span>
<a href="#l72.58"></a><span id="l72.58" class="difflineminus">-        return( false);</span>
<a href="#l72.59"></a><span id="l72.59" class="difflineplus">+      if (!pOutFile-&gt;WriteByte('%'))</span>
<a href="#l72.60"></a><span id="l72.60" class="difflineplus">+        return false;</span>
<a href="#l72.61"></a><span id="l72.61" class="difflineplus">+      ImportCharSet::ByteToHex(*pIn, hex);</span>
<a href="#l72.62"></a><span id="l72.62" class="difflineplus">+      if (!pOutFile-&gt;WriteData(hex, 2))</span>
<a href="#l72.63"></a><span id="l72.63" class="difflineplus">+        return false;</span>
<a href="#l72.64"></a><span id="l72.64">     }</span>
<a href="#l72.65"></a><span id="l72.65">     else {</span>
<a href="#l72.66"></a><span id="l72.66" class="difflineminus">-      if (!pOutFile-&gt;WriteByte( *pIn))</span>
<a href="#l72.67"></a><span id="l72.67" class="difflineminus">-        return( false);</span>
<a href="#l72.68"></a><span id="l72.68" class="difflineplus">+      if (!pOutFile-&gt;WriteByte(*pIn))</span>
<a href="#l72.69"></a><span id="l72.69" class="difflineplus">+        return false;</span>
<a href="#l72.70"></a><span id="l72.70">     }</span>
<a href="#l72.71"></a><span id="l72.71">     pIn++; inLen--;</span>
<a href="#l72.72"></a><span id="l72.72">   }</span>
<a href="#l72.73"></a><span id="l72.73"> </span>
<a href="#l72.74"></a><span id="l72.74">   if (pProcessed)</span>
<a href="#l72.75"></a><span id="l72.75">     *pProcessed = inLen;</span>
<a href="#l72.76"></a><span id="l72.76"> </span>
<a href="#l72.77"></a><span id="l72.77" class="difflineminus">-  return( true);</span>
<a href="#l72.78"></a><span id="l72.78" class="difflineplus">+  return true;</span>
<a href="#l72.79"></a><span id="l72.79"> }</span>
<a href="#l72.80"></a><span id="l72.80"> </span>
<a href="#l72.81"></a><span id="l72.81"> </span>
<a href="#l72.82"></a><span id="l72.82" class="difflineminus">-bool C2047Translator::ConvertToFileQ( const PRUint8 * pIn, PRUint32 inLen, ImportOutFile *pOutFile, PRUint32 *pProcessed)</span>
<a href="#l72.83"></a><span id="l72.83" class="difflineplus">+bool C2047Translator::ConvertToFileQ(const PRUint8 * pIn, PRUint32 inLen, ImportOutFile *pOutFile, PRUint32 *pProcessed)</span>
<a href="#l72.84"></a><span id="l72.84"> {</span>
<a href="#l72.85"></a><span id="l72.85">   if (!inLen)</span>
<a href="#l72.86"></a><span id="l72.86" class="difflineminus">-    return( true);</span>
<a href="#l72.87"></a><span id="l72.87" class="difflineplus">+    return true;</span>
<a href="#l72.88"></a><span id="l72.88"> </span>
<a href="#l72.89"></a><span id="l72.89">   int    maxLineLen = 64;</span>
<a href="#l72.90"></a><span id="l72.90">   int    curLineLen = m_startLen;</span>
<a href="#l72.91"></a><span id="l72.91">   bool    startLine = true;</span>
<a href="#l72.92"></a><span id="l72.92"> </span>
<a href="#l72.93"></a><span id="l72.93">   PRUint8  hex[2];</span>
<a href="#l72.94"></a><span id="l72.94">   while (inLen) {</span>
<a href="#l72.95"></a><span id="l72.95">     if (startLine) {</span>
<a href="#l72.96"></a><span id="l72.96" class="difflineminus">-      if (!pOutFile-&gt;WriteStr( &quot; =?&quot;))</span>
<a href="#l72.97"></a><span id="l72.97" class="difflineminus">-        return( false);</span>
<a href="#l72.98"></a><span id="l72.98" class="difflineminus">-      if (!pOutFile-&gt;WriteStr( m_charset.get()))</span>
<a href="#l72.99"></a><span id="l72.99" class="difflineminus">-        return( false);</span>
<a href="#l72.100"></a><span id="l72.100" class="difflineminus">-      if (!pOutFile-&gt;WriteStr( &quot;?q?&quot;))</span>
<a href="#l72.101"></a><span id="l72.101" class="difflineminus">-        return( false);</span>
<a href="#l72.102"></a><span id="l72.102" class="difflineplus">+      if (!pOutFile-&gt;WriteStr(&quot; =?&quot;))</span>
<a href="#l72.103"></a><span id="l72.103" class="difflineplus">+        return false;</span>
<a href="#l72.104"></a><span id="l72.104" class="difflineplus">+      if (!pOutFile-&gt;WriteStr(m_charset.get()))</span>
<a href="#l72.105"></a><span id="l72.105" class="difflineplus">+        return false;</span>
<a href="#l72.106"></a><span id="l72.106" class="difflineplus">+      if (!pOutFile-&gt;WriteStr(&quot;?q?&quot;))</span>
<a href="#l72.107"></a><span id="l72.107" class="difflineplus">+        return false;</span>
<a href="#l72.108"></a><span id="l72.108">       curLineLen += (6 + m_charset.Length());</span>
<a href="#l72.109"></a><span id="l72.109">       startLine = false;</span>
<a href="#l72.110"></a><span id="l72.110">     }</span>
<a href="#l72.111"></a><span id="l72.111"> </span>
<a href="#l72.112"></a><span id="l72.112" class="difflineminus">-    if (!ImportCharSet::IsUSAscii( *pIn) || ImportCharSet::Is822SpecialChar( *pIn) || ImportCharSet::Is822CtlChar( *pIn) ||</span>
<a href="#l72.113"></a><span id="l72.113" class="difflineplus">+    if (!ImportCharSet::IsUSAscii(*pIn) || ImportCharSet::Is822SpecialChar(*pIn) || ImportCharSet::Is822CtlChar(*pIn) ||</span>
<a href="#l72.114"></a><span id="l72.114">       (*pIn == ImportCharSet::cSpaceChar) || (*pIn == '?') || (*pIn == '=')) {</span>
<a href="#l72.115"></a><span id="l72.115">       // needs to be encode as =hex val</span>
<a href="#l72.116"></a><span id="l72.116" class="difflineminus">-      if (!pOutFile-&gt;WriteByte( '='))</span>
<a href="#l72.117"></a><span id="l72.117" class="difflineminus">-        return( false);</span>
<a href="#l72.118"></a><span id="l72.118" class="difflineminus">-      ImportCharSet::ByteToHex( *pIn, hex);</span>
<a href="#l72.119"></a><span id="l72.119" class="difflineminus">-      if (!pOutFile-&gt;WriteData( hex, 2))</span>
<a href="#l72.120"></a><span id="l72.120" class="difflineminus">-        return( false);</span>
<a href="#l72.121"></a><span id="l72.121" class="difflineplus">+      if (!pOutFile-&gt;WriteByte('='))</span>
<a href="#l72.122"></a><span id="l72.122" class="difflineplus">+        return false;</span>
<a href="#l72.123"></a><span id="l72.123" class="difflineplus">+      ImportCharSet::ByteToHex(*pIn, hex);</span>
<a href="#l72.124"></a><span id="l72.124" class="difflineplus">+      if (!pOutFile-&gt;WriteData(hex, 2))</span>
<a href="#l72.125"></a><span id="l72.125" class="difflineplus">+        return false;</span>
<a href="#l72.126"></a><span id="l72.126">       curLineLen += 3;</span>
<a href="#l72.127"></a><span id="l72.127">     }</span>
<a href="#l72.128"></a><span id="l72.128">     else {</span>
<a href="#l72.129"></a><span id="l72.129" class="difflineminus">-      if (!pOutFile-&gt;WriteByte( *pIn))</span>
<a href="#l72.130"></a><span id="l72.130" class="difflineminus">-        return( false);</span>
<a href="#l72.131"></a><span id="l72.131" class="difflineplus">+      if (!pOutFile-&gt;WriteByte(*pIn))</span>
<a href="#l72.132"></a><span id="l72.132" class="difflineplus">+        return false;</span>
<a href="#l72.133"></a><span id="l72.133">       curLineLen++;</span>
<a href="#l72.134"></a><span id="l72.134">     }</span>
<a href="#l72.135"></a><span id="l72.135">     pIn++; inLen--;</span>
<a href="#l72.136"></a><span id="l72.136">     if (curLineLen &gt; maxLineLen) {</span>
<a href="#l72.137"></a><span id="l72.137" class="difflineminus">-      if (!pOutFile-&gt;WriteStr( &quot;?=&quot;))</span>
<a href="#l72.138"></a><span id="l72.138" class="difflineminus">-        return( false);</span>
<a href="#l72.139"></a><span id="l72.139" class="difflineplus">+      if (!pOutFile-&gt;WriteStr(&quot;?=&quot;))</span>
<a href="#l72.140"></a><span id="l72.140" class="difflineplus">+        return false;</span>
<a href="#l72.141"></a><span id="l72.141">       if (inLen) {</span>
<a href="#l72.142"></a><span id="l72.142" class="difflineminus">-        if (!pOutFile-&gt;WriteStr( &quot;\x0D\x0A &quot;))</span>
<a href="#l72.143"></a><span id="l72.143" class="difflineminus">-          return( false);</span>
<a href="#l72.144"></a><span id="l72.144" class="difflineplus">+        if (!pOutFile-&gt;WriteStr(&quot;\x0D\x0A &quot;))</span>
<a href="#l72.145"></a><span id="l72.145" class="difflineplus">+          return false;</span>
<a href="#l72.146"></a><span id="l72.146">       }</span>
<a href="#l72.147"></a><span id="l72.147"> </span>
<a href="#l72.148"></a><span id="l72.148">       startLine = true;</span>
<a href="#l72.149"></a><span id="l72.149">       curLineLen = 0;</span>
<a href="#l72.150"></a><span id="l72.150">     }</span>
<a href="#l72.151"></a><span id="l72.151">   }</span>
<a href="#l72.152"></a><span id="l72.152"> </span>
<a href="#l72.153"></a><span id="l72.153">   if (!startLine) {</span>
<a href="#l72.154"></a><span id="l72.154">     // end the encoding!</span>
<a href="#l72.155"></a><span id="l72.155" class="difflineminus">-    if (!pOutFile-&gt;WriteStr( &quot;?=&quot;))</span>
<a href="#l72.156"></a><span id="l72.156" class="difflineminus">-      return( false);</span>
<a href="#l72.157"></a><span id="l72.157" class="difflineplus">+    if (!pOutFile-&gt;WriteStr(&quot;?=&quot;))</span>
<a href="#l72.158"></a><span id="l72.158" class="difflineplus">+      return false;</span>
<a href="#l72.159"></a><span id="l72.159">   }</span>
<a href="#l72.160"></a><span id="l72.160"> </span>
<a href="#l72.161"></a><span id="l72.161">   if (pProcessed)</span>
<a href="#l72.162"></a><span id="l72.162">     *pProcessed = inLen;</span>
<a href="#l72.163"></a><span id="l72.163"> </span>
<a href="#l72.164"></a><span id="l72.164" class="difflineminus">-  return( true);</span>
<a href="#l72.165"></a><span id="l72.165" class="difflineplus">+  return true;</span>
<a href="#l72.166"></a><span id="l72.166"> }</span>
<a href="#l72.167"></a><span id="l72.167"> </span>
<a href="#l72.168"></a><span id="l72.168" class="difflineminus">-bool C2047Translator::ConvertToFile( const PRUint8 * pIn, PRUint32 inLen, ImportOutFile *pOutFile, PRUint32 *pProcessed)</span>
<a href="#l72.169"></a><span id="l72.169" class="difflineplus">+bool C2047Translator::ConvertToFile(const PRUint8 * pIn, PRUint32 inLen, ImportOutFile *pOutFile, PRUint32 *pProcessed)</span>
<a href="#l72.170"></a><span id="l72.170"> {</span>
<a href="#l72.171"></a><span id="l72.171">   if (m_useQuotedPrintable)</span>
<a href="#l72.172"></a><span id="l72.172" class="difflineminus">-    return( ConvertToFileQ( pIn, inLen, pOutFile, pProcessed));</span>
<a href="#l72.173"></a><span id="l72.173" class="difflineplus">+    return ConvertToFileQ(pIn, inLen, pOutFile, pProcessed);</span>
<a href="#l72.174"></a><span id="l72.174"> </span>
<a href="#l72.175"></a><span id="l72.175">   if (!inLen)</span>
<a href="#l72.176"></a><span id="l72.176" class="difflineminus">-    return( true);</span>
<a href="#l72.177"></a><span id="l72.177" class="difflineplus">+    return true;</span>
<a href="#l72.178"></a><span id="l72.178"> </span>
<a href="#l72.179"></a><span id="l72.179">   int      maxLineLen = 64;</span>
<a href="#l72.180"></a><span id="l72.180">   int      curLineLen = m_startLen;</span>
<a href="#l72.181"></a><span id="l72.181">   bool      startLine = true;</span>
<a href="#l72.182"></a><span id="l72.182">   int      encodeMax;</span>
<a href="#l72.183"></a><span id="l72.183">   PRUint8 *  pEncoded = new PRUint8[maxLineLen * 2];</span>
<a href="#l72.184"></a><span id="l72.184"> </span>
<a href="#l72.185"></a><span id="l72.185">   while (inLen) {</span>
<a href="#l72.186"></a><span id="l72.186">     if (startLine) {</span>
<a href="#l72.187"></a><span id="l72.187" class="difflineminus">-      if (!pOutFile-&gt;WriteStr( &quot; =?&quot;)) {</span>
<a href="#l72.188"></a><span id="l72.188" class="difflineplus">+      if (!pOutFile-&gt;WriteStr(&quot; =?&quot;)) {</span>
<a href="#l72.189"></a><span id="l72.189">         delete [] pEncoded;</span>
<a href="#l72.190"></a><span id="l72.190" class="difflineminus">-        return( false);</span>
<a href="#l72.191"></a><span id="l72.191" class="difflineplus">+        return false;</span>
<a href="#l72.192"></a><span id="l72.192">       }</span>
<a href="#l72.193"></a><span id="l72.193" class="difflineminus">-      if (!pOutFile-&gt;WriteStr( m_charset.get())) {</span>
<a href="#l72.194"></a><span id="l72.194" class="difflineplus">+      if (!pOutFile-&gt;WriteStr(m_charset.get())) {</span>
<a href="#l72.195"></a><span id="l72.195">         delete [] pEncoded;</span>
<a href="#l72.196"></a><span id="l72.196" class="difflineminus">-        return( false);</span>
<a href="#l72.197"></a><span id="l72.197" class="difflineplus">+        return false;</span>
<a href="#l72.198"></a><span id="l72.198">       }</span>
<a href="#l72.199"></a><span id="l72.199" class="difflineminus">-      if (!pOutFile-&gt;WriteStr( &quot;?b?&quot;)) {</span>
<a href="#l72.200"></a><span id="l72.200" class="difflineplus">+      if (!pOutFile-&gt;WriteStr(&quot;?b?&quot;)) {</span>
<a href="#l72.201"></a><span id="l72.201">         delete [] pEncoded;</span>
<a href="#l72.202"></a><span id="l72.202" class="difflineminus">-        return( false);</span>
<a href="#l72.203"></a><span id="l72.203" class="difflineplus">+        return false;</span>
<a href="#l72.204"></a><span id="l72.204">       }</span>
<a href="#l72.205"></a><span id="l72.205">       curLineLen += (6 + m_charset.Length());</span>
<a href="#l72.206"></a><span id="l72.206">       startLine = false;</span>
<a href="#l72.207"></a><span id="l72.207">     }</span>
<a href="#l72.208"></a><span id="l72.208">     encodeMax = maxLineLen - curLineLen;</span>
<a href="#l72.209"></a><span id="l72.209">     encodeMax *= 3;</span>
<a href="#l72.210"></a><span id="l72.210">     encodeMax /= 4;</span>
<a href="#l72.211"></a><span id="l72.211">     if ((PRUint32)encodeMax &gt; inLen)</span>
<a href="#l72.212"></a><span id="l72.212">       encodeMax = (int)inLen;</span>
<a href="#l72.213"></a><span id="l72.213"> </span>
<a href="#l72.214"></a><span id="l72.214">     // encode the line, end the line</span>
<a href="#l72.215"></a><span id="l72.215">     // then continue. Update curLineLen, pIn, startLine, and inLen</span>
<a href="#l72.216"></a><span id="l72.216" class="difflineminus">-    UMimeEncode::ConvertBuffer( pIn, encodeMax, pEncoded, maxLineLen, maxLineLen, &quot;\x0D\x0A&quot;);</span>
<a href="#l72.217"></a><span id="l72.217" class="difflineplus">+    UMimeEncode::ConvertBuffer(pIn, encodeMax, pEncoded, maxLineLen, maxLineLen, &quot;\x0D\x0A&quot;);</span>
<a href="#l72.218"></a><span id="l72.218"> </span>
<a href="#l72.219"></a><span id="l72.219" class="difflineminus">-    if (!pOutFile-&gt;WriteStr( (const char *)pEncoded)) {</span>
<a href="#l72.220"></a><span id="l72.220" class="difflineplus">+    if (!pOutFile-&gt;WriteStr((const char *)pEncoded)) {</span>
<a href="#l72.221"></a><span id="l72.221">       delete [] pEncoded;</span>
<a href="#l72.222"></a><span id="l72.222" class="difflineminus">-      return( false);</span>
<a href="#l72.223"></a><span id="l72.223" class="difflineplus">+      return false;</span>
<a href="#l72.224"></a><span id="l72.224">     }</span>
<a href="#l72.225"></a><span id="l72.225"> </span>
<a href="#l72.226"></a><span id="l72.226">     pIn += encodeMax;</span>
<a href="#l72.227"></a><span id="l72.227">     inLen -= encodeMax;</span>
<a href="#l72.228"></a><span id="l72.228">     startLine = true;</span>
<a href="#l72.229"></a><span id="l72.229">     curLineLen = 0;</span>
<a href="#l72.230"></a><span id="l72.230" class="difflineminus">-    if (!pOutFile-&gt;WriteStr( &quot;?=&quot;)) {</span>
<a href="#l72.231"></a><span id="l72.231" class="difflineplus">+    if (!pOutFile-&gt;WriteStr(&quot;?=&quot;)) {</span>
<a href="#l72.232"></a><span id="l72.232">       delete [] pEncoded;</span>
<a href="#l72.233"></a><span id="l72.233" class="difflineminus">-      return( false);</span>
<a href="#l72.234"></a><span id="l72.234" class="difflineplus">+      return false;</span>
<a href="#l72.235"></a><span id="l72.235">     }</span>
<a href="#l72.236"></a><span id="l72.236">     if (inLen) {</span>
<a href="#l72.237"></a><span id="l72.237" class="difflineminus">-      if (!pOutFile-&gt;WriteStr( &quot;\x0D\x0A &quot;)) {</span>
<a href="#l72.238"></a><span id="l72.238" class="difflineplus">+      if (!pOutFile-&gt;WriteStr(&quot;\x0D\x0A &quot;)) {</span>
<a href="#l72.239"></a><span id="l72.239">         delete [] pEncoded;</span>
<a href="#l72.240"></a><span id="l72.240" class="difflineminus">-        return( false);</span>
<a href="#l72.241"></a><span id="l72.241" class="difflineplus">+        return false;</span>
<a href="#l72.242"></a><span id="l72.242">       }</span>
<a href="#l72.243"></a><span id="l72.243">     }</span>
<a href="#l72.244"></a><span id="l72.244">   }</span>
<a href="#l72.245"></a><span id="l72.245"> </span>
<a href="#l72.246"></a><span id="l72.246">   delete [] pEncoded;</span>
<a href="#l72.247"></a><span id="l72.247"> </span>
<a href="#l72.248"></a><span id="l72.248">   if (pProcessed)</span>
<a href="#l72.249"></a><span id="l72.249">     *pProcessed = inLen;</span>
<a href="#l72.250"></a><span id="l72.250"> </span>
<a href="#l72.251"></a><span id="l72.251" class="difflineminus">-  return( true);</span>
<a href="#l72.252"></a><span id="l72.252" class="difflineplus">+  return true;</span>
<a href="#l72.253"></a><span id="l72.253"> }</span>
<a href="#l72.254"></a><span id="l72.254"> </span>
<a href="#l72.255"></a><span id="l72.255"> </span>
<a href="#l72.256"></a><span id="l72.256" class="difflineminus">-PRUint32  UMimeEncode::GetBufferSize( PRUint32 inBytes)</span>
<a href="#l72.257"></a><span id="l72.257" class="difflineplus">+PRUint32  UMimeEncode::GetBufferSize(PRUint32 inBytes)</span>
<a href="#l72.258"></a><span id="l72.258"> {</span>
<a href="#l72.259"></a><span id="l72.259">   // it takes 4 base64 bytes to represent 3 regular bytes</span>
<a href="#l72.260"></a><span id="l72.260">   inBytes += 3;</span>
<a href="#l72.261"></a><span id="l72.261">   inBytes /= 3;</span>
<a href="#l72.262"></a><span id="l72.262">   inBytes *= 4;</span>
<a href="#l72.263"></a><span id="l72.263">   // This should be plenty, but just to be safe</span>
<a href="#l72.264"></a><span id="l72.264">   inBytes += 4;</span>
<a href="#l72.265"></a><span id="l72.265"> </span>
<a href="#l72.266"></a><span id="l72.266">   // now allow for end of line characters</span>
<a href="#l72.267"></a><span id="l72.267">   inBytes += ((inBytes + 39) / 40) * 4;</span>
<a href="#l72.268"></a><span id="l72.268"> </span>
<a href="#l72.269"></a><span id="l72.269" class="difflineminus">-  return( inBytes);</span>
<a href="#l72.270"></a><span id="l72.270" class="difflineplus">+  return inBytes;</span>
<a href="#l72.271"></a><span id="l72.271"> }</span>
<a href="#l72.272"></a><span id="l72.272"> </span>
<a href="#l72.273"></a><span id="l72.273"> static PRUint8 gBase64[] = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;</span>
<a href="#l72.274"></a><span id="l72.274"> </span>
<a href="#l72.275"></a><span id="l72.275" class="difflineminus">-PRUint32 UMimeEncode::ConvertBuffer( const PRUint8 * pIn, PRUint32 inLen, PRUint8 * pOut, PRUint32 maxLen, PRUint32 firstLineLen, const char * pEolStr)</span>
<a href="#l72.276"></a><span id="l72.276" class="difflineplus">+PRUint32 UMimeEncode::ConvertBuffer(const PRUint8 * pIn, PRUint32 inLen, PRUint8 * pOut, PRUint32 maxLen, PRUint32 firstLineLen, const char * pEolStr)</span>
<a href="#l72.277"></a><span id="l72.277"> {</span>
<a href="#l72.278"></a><span id="l72.278"> </span>
<a href="#l72.279"></a><span id="l72.279">   PRUint32  pos = 0;</span>
<a href="#l72.280"></a><span id="l72.280">   PRUint32  len = 0;</span>
<a href="#l72.281"></a><span id="l72.281">   PRUint32  lineLen = 0;</span>
<a href="#l72.282"></a><span id="l72.282">   PRUint32  maxLine = firstLineLen;</span>
<a href="#l72.283"></a><span id="l72.283">   int  eolLen = 0;</span>
<a href="#l72.284"></a><span id="l72.284">   if (pEolStr)</span>
<a href="#l72.285"></a><span id="l72.285" class="difflineminus">-    eolLen = strlen( pEolStr);</span>
<a href="#l72.286"></a><span id="l72.286" class="difflineplus">+    eolLen = strlen(pEolStr);</span>
<a href="#l72.287"></a><span id="l72.287"> </span>
<a href="#l72.288"></a><span id="l72.288">   while ((pos + 2) &lt; inLen) {</span>
<a href="#l72.289"></a><span id="l72.289">     // Encode 3 bytes</span>
<a href="#l72.290"></a><span id="l72.290">     *pOut = gBase64[*pIn &gt;&gt; 2];</span>
<a href="#l72.291"></a><span id="l72.291">     pOut++; len++; lineLen++;</span>
<a href="#l72.292"></a><span id="l72.292">     *pOut = gBase64[(((*pIn) &amp; 0x3)&lt;&lt; 4) | (((*(pIn + 1)) &amp; 0xF0) &gt;&gt; 4)];</span>
<a href="#l72.293"></a><span id="l72.293">     pIn++; pOut++; len++; lineLen++;</span>
<a href="#l72.294"></a><span id="l72.294">     *pOut = gBase64[(((*pIn) &amp; 0xF) &lt;&lt; 2) | (((*(pIn + 1)) &amp; 0xC0) &gt;&gt;6)];</span>
<a href="#l72.295"></a><span id="l72.295">     pIn++; pOut++; len++; lineLen++;</span>
<a href="#l72.296"></a><span id="l72.296">     *pOut = gBase64[(*pIn) &amp; 0x3F];</span>
<a href="#l72.297"></a><span id="l72.297">     pIn++; pOut++; len++; lineLen++;</span>
<a href="#l72.298"></a><span id="l72.298">     pos += 3;</span>
<a href="#l72.299"></a><span id="l72.299">     if (lineLen &gt;= maxLine) {</span>
<a href="#l72.300"></a><span id="l72.300">       lineLen = 0;</span>
<a href="#l72.301"></a><span id="l72.301">       maxLine = maxLen;</span>
<a href="#l72.302"></a><span id="l72.302">       if (pEolStr) {</span>
<a href="#l72.303"></a><span id="l72.303" class="difflineminus">-        memcpy( pOut, pEolStr, eolLen);</span>
<a href="#l72.304"></a><span id="l72.304" class="difflineplus">+        memcpy(pOut, pEolStr, eolLen);</span>
<a href="#l72.305"></a><span id="l72.305">         pOut += eolLen;</span>
<a href="#l72.306"></a><span id="l72.306">         len += eolLen;</span>
<a href="#l72.307"></a><span id="l72.307">       }</span>
<a href="#l72.308"></a><span id="l72.308">     }</span>
<a href="#l72.309"></a><span id="l72.309">   }</span>
<a href="#l72.310"></a><span id="l72.310"> </span>
<a href="#l72.311"></a><span id="l72.311">   if ((pos &lt; inLen) &amp;&amp; ((lineLen + 3) &gt; maxLine)) {</span>
<a href="#l72.312"></a><span id="l72.312">     lineLen = 0;</span>
<a href="#l72.313"></a><span id="l72.313">     maxLine = maxLen;</span>
<a href="#l72.314"></a><span id="l72.314">     if (pEolStr) {</span>
<a href="#l72.315"></a><span id="l72.315" class="difflineminus">-      memcpy( pOut, pEolStr, eolLen);</span>
<a href="#l72.316"></a><span id="l72.316" class="difflineplus">+      memcpy(pOut, pEolStr, eolLen);</span>
<a href="#l72.317"></a><span id="l72.317">       pOut += eolLen;</span>
<a href="#l72.318"></a><span id="l72.318">       len += eolLen;</span>
<a href="#l72.319"></a><span id="l72.319">     }</span>
<a href="#l72.320"></a><span id="l72.320">   }</span>
<a href="#l72.321"></a><span id="l72.321"> </span>
<a href="#l72.322"></a><span id="l72.322">   if (pos &lt; inLen) {</span>
<a href="#l72.323"></a><span id="l72.323">     // Get the last few bytes!</span>
<a href="#l72.324"></a><span id="l72.324">     *pOut = gBase64[*pIn &gt;&gt; 2];</span>
<a href="#l72.325"></a><span id="l72.325" class="difflineat">@@ -319,10 +319,10 @@ PRUint32 UMimeEncode::ConvertBuffer( con</span>
<a href="#l72.326"></a><span id="l72.326">       pOut++; len++;</span>
<a href="#l72.327"></a><span id="l72.327">       *pOut = '=';</span>
<a href="#l72.328"></a><span id="l72.328">       pOut++; len++;</span>
<a href="#l72.329"></a><span id="l72.329">     }</span>
<a href="#l72.330"></a><span id="l72.330">   }</span>
<a href="#l72.331"></a><span id="l72.331"> </span>
<a href="#l72.332"></a><span id="l72.332">   *pOut = 0;</span>
<a href="#l72.333"></a><span id="l72.333"> </span>
<a href="#l72.334"></a><span id="l72.334" class="difflineminus">-  return( len);</span>
<a href="#l72.335"></a><span id="l72.335" class="difflineplus">+  return len;</span>
<a href="#l72.336"></a><span id="l72.336"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/mailnews/import/src/nsImportTranslator.h</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/mailnews/import/src/nsImportTranslator.h</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -41,56 +41,56 @@</span>
<a href="#l73.4"></a><span id="l73.4"> #include &quot;nscore.h&quot;</span>
<a href="#l73.5"></a><span id="l73.5"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l73.6"></a><span id="l73.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l73.7"></a><span id="l73.7"> </span>
<a href="#l73.8"></a><span id="l73.8"> class ImportOutFile;</span>
<a href="#l73.9"></a><span id="l73.9"> </span>
<a href="#l73.10"></a><span id="l73.10"> class UMimeEncode {</span>
<a href="#l73.11"></a><span id="l73.11"> public:</span>
<a href="#l73.12"></a><span id="l73.12" class="difflineminus">-  static PRUint32  GetBufferSize( PRUint32 inByes);</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineminus">-  static PRUint32  ConvertBuffer( const PRUint8 * pIn, PRUint32 inLen, PRUint8 *pOut, PRUint32 maxLen = 72, PRUint32 firstLineLen = 72, const char * pEolStr = nsnull);</span>
<a href="#l73.14"></a><span id="l73.14" class="difflineplus">+  static PRUint32  GetBufferSize(PRUint32 inByes);</span>
<a href="#l73.15"></a><span id="l73.15" class="difflineplus">+  static PRUint32  ConvertBuffer(const PRUint8 * pIn, PRUint32 inLen, PRUint8 *pOut, PRUint32 maxLen = 72, PRUint32 firstLineLen = 72, const char * pEolStr = nsnull);</span>
<a href="#l73.16"></a><span id="l73.16"> };</span>
<a href="#l73.17"></a><span id="l73.17"> </span>
<a href="#l73.18"></a><span id="l73.18"> </span>
<a href="#l73.19"></a><span id="l73.19"> class nsImportTranslator {</span>
<a href="#l73.20"></a><span id="l73.20"> public:</span>
<a href="#l73.21"></a><span id="l73.21">   virtual ~nsImportTranslator() {}</span>
<a href="#l73.22"></a><span id="l73.22" class="difflineminus">-  virtual bool      Supports8bitEncoding( void) { return( false);}</span>
<a href="#l73.23"></a><span id="l73.23" class="difflineminus">-  virtual PRUint32  GetMaxBufferSize( PRUint32 inLen) { return( inLen + 1);}</span>
<a href="#l73.24"></a><span id="l73.24" class="difflineminus">-  virtual void    ConvertBuffer( const PRUint8 * pIn, PRUint32 inLen, PRUint8 * pOut) { memcpy( pOut, pIn, inLen); pOut[inLen] = 0;}</span>
<a href="#l73.25"></a><span id="l73.25" class="difflineminus">-  virtual bool      ConvertToFile( const PRUint8 * pIn, PRUint32 inLen, ImportOutFile *pOutFile, PRUint32 *pProcessed = nsnull);</span>
<a href="#l73.26"></a><span id="l73.26" class="difflineminus">-  virtual bool      FinishConvertToFile( ImportOutFile * /* pOutFile */) { return( true);}</span>
<a href="#l73.27"></a><span id="l73.27" class="difflineplus">+  virtual bool      Supports8bitEncoding(void) { return false;}</span>
<a href="#l73.28"></a><span id="l73.28" class="difflineplus">+  virtual PRUint32  GetMaxBufferSize(PRUint32 inLen) { return inLen + 1;}</span>
<a href="#l73.29"></a><span id="l73.29" class="difflineplus">+  virtual void    ConvertBuffer(const PRUint8 * pIn, PRUint32 inLen, PRUint8 * pOut) { memcpy(pOut, pIn, inLen); pOut[inLen] = 0;}</span>
<a href="#l73.30"></a><span id="l73.30" class="difflineplus">+  virtual bool      ConvertToFile(const PRUint8 * pIn, PRUint32 inLen, ImportOutFile *pOutFile, PRUint32 *pProcessed = nsnull);</span>
<a href="#l73.31"></a><span id="l73.31" class="difflineplus">+  virtual bool      FinishConvertToFile(ImportOutFile * /* pOutFile */) { return true;}</span>
<a href="#l73.32"></a><span id="l73.32"> </span>
<a href="#l73.33"></a><span id="l73.33" class="difflineminus">-  virtual void  GetCharset( nsCString&amp; charSet) { charSet = &quot;us-ascii&quot;;}</span>
<a href="#l73.34"></a><span id="l73.34" class="difflineminus">-  virtual void  GetLanguage( nsCString&amp; lang) { lang = &quot;en&quot;;}</span>
<a href="#l73.35"></a><span id="l73.35" class="difflineminus">-  virtual void  GetEncoding( nsCString&amp; encoding) { encoding.Truncate();}</span>
<a href="#l73.36"></a><span id="l73.36" class="difflineplus">+  virtual void  GetCharset(nsCString&amp; charSet) { charSet = &quot;us-ascii&quot;;}</span>
<a href="#l73.37"></a><span id="l73.37" class="difflineplus">+  virtual void  GetLanguage(nsCString&amp; lang) { lang = &quot;en&quot;;}</span>
<a href="#l73.38"></a><span id="l73.38" class="difflineplus">+  virtual void  GetEncoding(nsCString&amp; encoding) { encoding.Truncate();}</span>
<a href="#l73.39"></a><span id="l73.39"> };</span>
<a href="#l73.40"></a><span id="l73.40"> </span>
<a href="#l73.41"></a><span id="l73.41"> // Specialized encoder, not a vaild language translator, used for Mime headers.</span>
<a href="#l73.42"></a><span id="l73.42"> // rfc2231</span>
<a href="#l73.43"></a><span id="l73.43"> class CMHTranslator : public nsImportTranslator {</span>
<a href="#l73.44"></a><span id="l73.44"> public:</span>
<a href="#l73.45"></a><span id="l73.45" class="difflineminus">-  virtual PRUint32  GetMaxBufferSize( PRUint32 inLen) { return( (inLen * 3) + 1);}</span>
<a href="#l73.46"></a><span id="l73.46" class="difflineminus">-  virtual void    ConvertBuffer( const PRUint8 * pIn, PRUint32 inLen, PRUint8 * pOut);</span>
<a href="#l73.47"></a><span id="l73.47" class="difflineminus">-  virtual bool      ConvertToFile( const PRUint8 * pIn, PRUint32 inLen, ImportOutFile *pOutFile, PRUint32 *pProcessed = nsnull);</span>
<a href="#l73.48"></a><span id="l73.48" class="difflineplus">+  virtual PRUint32  GetMaxBufferSize(PRUint32 inLen) { return (inLen * 3) + 1;}</span>
<a href="#l73.49"></a><span id="l73.49" class="difflineplus">+  virtual void    ConvertBuffer(const PRUint8 * pIn, PRUint32 inLen, PRUint8 * pOut);</span>
<a href="#l73.50"></a><span id="l73.50" class="difflineplus">+  virtual bool      ConvertToFile(const PRUint8 * pIn, PRUint32 inLen, ImportOutFile *pOutFile, PRUint32 *pProcessed = nsnull);</span>
<a href="#l73.51"></a><span id="l73.51"> };</span>
<a href="#l73.52"></a><span id="l73.52"> </span>
<a href="#l73.53"></a><span id="l73.53"> // Specialized encoder, not a vaild language translator, used for mail headers</span>
<a href="#l73.54"></a><span id="l73.54"> // rfc2047</span>
<a href="#l73.55"></a><span id="l73.55"> class C2047Translator : public nsImportTranslator {</span>
<a href="#l73.56"></a><span id="l73.56"> public:</span>
<a href="#l73.57"></a><span id="l73.57">   virtual ~C2047Translator() {}</span>
<a href="#l73.58"></a><span id="l73.58"> </span>
<a href="#l73.59"></a><span id="l73.59" class="difflineminus">-  C2047Translator( const char *pCharset, PRUint32 headerLen) { m_charset = pCharset; m_startLen = headerLen; m_useQuotedPrintable = false;}</span>
<a href="#l73.60"></a><span id="l73.60" class="difflineplus">+  C2047Translator(const char *pCharset, PRUint32 headerLen) { m_charset = pCharset; m_startLen = headerLen; m_useQuotedPrintable = false;}</span>
<a href="#l73.61"></a><span id="l73.61"> </span>
<a href="#l73.62"></a><span id="l73.62" class="difflineminus">-  void  SetUseQuotedPrintable( void) { m_useQuotedPrintable = true;}</span>
<a href="#l73.63"></a><span id="l73.63" class="difflineplus">+  void  SetUseQuotedPrintable(void) { m_useQuotedPrintable = true;}</span>
<a href="#l73.64"></a><span id="l73.64"> </span>
<a href="#l73.65"></a><span id="l73.65" class="difflineminus">-  virtual bool    ConvertToFile( const PRUint8 * pIn, PRUint32 inLen, ImportOutFile *pOutFile, PRUint32 *pProcessed = nsnull);</span>
<a href="#l73.66"></a><span id="l73.66" class="difflineminus">-  bool    ConvertToFileQ( const PRUint8 * pIn, PRUint32 inLen, ImportOutFile *pOutFile, PRUint32 *pProcessed);</span>
<a href="#l73.67"></a><span id="l73.67" class="difflineplus">+  virtual bool    ConvertToFile(const PRUint8 * pIn, PRUint32 inLen, ImportOutFile *pOutFile, PRUint32 *pProcessed = nsnull);</span>
<a href="#l73.68"></a><span id="l73.68" class="difflineplus">+  bool    ConvertToFileQ(const PRUint8 * pIn, PRUint32 inLen, ImportOutFile *pOutFile, PRUint32 *pProcessed);</span>
<a href="#l73.69"></a><span id="l73.69"> </span>
<a href="#l73.70"></a><span id="l73.70"> protected:</span>
<a href="#l73.71"></a><span id="l73.71">   bool        m_useQuotedPrintable;</span>
<a href="#l73.72"></a><span id="l73.72">   nsCString    m_charset;</span>
<a href="#l73.73"></a><span id="l73.73">   PRUint32    m_startLen;</span>
<a href="#l73.74"></a><span id="l73.74"> };</span>
<a href="#l73.75"></a><span id="l73.75"> </span>
<a href="#l73.76"></a><span id="l73.76"> #endif /* nsImportTranslator_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/mailnews/import/text/src/nsTextAddress.cpp</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/mailnews/import/text/src/nsTextAddress.cpp</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -82,27 +82,27 @@ nsresult nsTextAddress::ImportAddresses(</span>
<a href="#l74.4"></a><span id="l74.4">   m_database = pDb;</span>
<a href="#l74.5"></a><span id="l74.5">   m_fieldMap = fieldMap;</span>
<a href="#l74.6"></a><span id="l74.6">   NS_ADDREF(m_fieldMap);</span>
<a href="#l74.7"></a><span id="l74.7">   NS_ADDREF(m_database);</span>
<a href="#l74.8"></a><span id="l74.8"> </span>
<a href="#l74.9"></a><span id="l74.9">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l74.10"></a><span id="l74.10">   nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), pSrc);</span>
<a href="#l74.11"></a><span id="l74.11">   if (NS_FAILED(rv)) {</span>
<a href="#l74.12"></a><span id="l74.12" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error opening address file for reading\n&quot;);</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error opening address file for reading\n&quot;);</span>
<a href="#l74.14"></a><span id="l74.14">     return rv;</span>
<a href="#l74.15"></a><span id="l74.15">   }</span>
<a href="#l74.16"></a><span id="l74.16"> </span>
<a href="#l74.17"></a><span id="l74.17">   // Here we use this to work out the size of the file, so we can update</span>
<a href="#l74.18"></a><span id="l74.18">   // an integer as we go through the file which will update a progress</span>
<a href="#l74.19"></a><span id="l74.19">   // bar if required by the caller.</span>
<a href="#l74.20"></a><span id="l74.20">   PRUint32 bytesLeft = 0;</span>
<a href="#l74.21"></a><span id="l74.21">   rv = inputStream-&gt;Available(&amp;bytesLeft);</span>
<a href="#l74.22"></a><span id="l74.22">   if (NS_FAILED(rv)) {</span>
<a href="#l74.23"></a><span id="l74.23" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error checking address file for size\n&quot;);</span>
<a href="#l74.24"></a><span id="l74.24" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error checking address file for size\n&quot;);</span>
<a href="#l74.25"></a><span id="l74.25">     inputStream-&gt;Close();</span>
<a href="#l74.26"></a><span id="l74.26">     return rv;</span>
<a href="#l74.27"></a><span id="l74.27">   }</span>
<a href="#l74.28"></a><span id="l74.28"> </span>
<a href="#l74.29"></a><span id="l74.29">   PRUint32 totalBytes = bytesLeft;</span>
<a href="#l74.30"></a><span id="l74.30">   bool skipRecord = false;</span>
<a href="#l74.31"></a><span id="l74.31"> </span>
<a href="#l74.32"></a><span id="l74.32">   rv = m_fieldMap-&gt;GetSkipFirstRecord(&amp;skipRecord);</span>
<a href="#l74.33"></a><span id="l74.33" class="difflineat">@@ -116,40 +116,40 @@ nsresult nsTextAddress::ImportAddresses(</span>
<a href="#l74.34"></a><span id="l74.34"> </span>
<a href="#l74.35"></a><span id="l74.35">   bool more = true;</span>
<a href="#l74.36"></a><span id="l74.36">   nsCString line;</span>
<a href="#l74.37"></a><span id="l74.37"> </span>
<a href="#l74.38"></a><span id="l74.38">   // Skip the first record if the user has requested it.</span>
<a href="#l74.39"></a><span id="l74.39">   if (skipRecord)</span>
<a href="#l74.40"></a><span id="l74.40">     rv = ReadRecord(lineStream, line, &amp;more);</span>
<a href="#l74.41"></a><span id="l74.41"> </span>
<a href="#l74.42"></a><span id="l74.42" class="difflineminus">-  while (!(*pAbort) &amp;&amp; more &amp;&amp; NS_SUCCEEDED( rv)) {</span>
<a href="#l74.43"></a><span id="l74.43" class="difflineplus">+  while (!(*pAbort) &amp;&amp; more &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l74.44"></a><span id="l74.44">     // Read the line in</span>
<a href="#l74.45"></a><span id="l74.45">     rv = ReadRecord(lineStream, line, &amp;more);</span>
<a href="#l74.46"></a><span id="l74.46">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l74.47"></a><span id="l74.47">       // Now proces it to add it to the database</span>
<a href="#l74.48"></a><span id="l74.48">       rv = ProcessLine(line.get(), line.Length(), errors);</span>
<a href="#l74.49"></a><span id="l74.49"> </span>
<a href="#l74.50"></a><span id="l74.50">       if (NS_FAILED(rv)) {</span>
<a href="#l74.51"></a><span id="l74.51" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error processing text record.\n&quot;);</span>
<a href="#l74.52"></a><span id="l74.52" class="difflineplus">+        IMPORT_LOG0(&quot;*** Error processing text record.\n&quot;);</span>
<a href="#l74.53"></a><span id="l74.53">       }</span>
<a href="#l74.54"></a><span id="l74.54">     }</span>
<a href="#l74.55"></a><span id="l74.55">     if (NS_SUCCEEDED(rv) &amp;&amp; pProgress) {</span>
<a href="#l74.56"></a><span id="l74.56">       // This won't be totally accurate, but its the best we can do</span>
<a href="#l74.57"></a><span id="l74.57">       // considering that lineStream won't give us how many bytes</span>
<a href="#l74.58"></a><span id="l74.58">       // are actually left.</span>
<a href="#l74.59"></a><span id="l74.59">       bytesLeft -= line.Length();</span>
<a href="#l74.60"></a><span id="l74.60">       *pProgress = totalBytes - bytesLeft;</span>
<a href="#l74.61"></a><span id="l74.61">     }</span>
<a href="#l74.62"></a><span id="l74.62">   }</span>
<a href="#l74.63"></a><span id="l74.63"> </span>
<a href="#l74.64"></a><span id="l74.64">   inputStream-&gt;Close();</span>
<a href="#l74.65"></a><span id="l74.65"> </span>
<a href="#l74.66"></a><span id="l74.66">   if (NS_FAILED(rv)) {</span>
<a href="#l74.67"></a><span id="l74.67" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error reading the address book - probably incorrect ending\n&quot;);</span>
<a href="#l74.68"></a><span id="l74.68" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error reading the address book - probably incorrect ending\n&quot;);</span>
<a href="#l74.69"></a><span id="l74.69">     return NS_ERROR_FAILURE;</span>
<a href="#l74.70"></a><span id="l74.70">   }</span>
<a href="#l74.71"></a><span id="l74.71"> </span>
<a href="#l74.72"></a><span id="l74.72">   return pDb-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l74.73"></a><span id="l74.73"> }</span>
<a href="#l74.74"></a><span id="l74.74"> </span>
<a href="#l74.75"></a><span id="l74.75"> nsresult nsTextAddress::ReadRecord(nsILineInputStream *aLineStream, nsCString &amp;aLine, bool *aMore)</span>
<a href="#l74.76"></a><span id="l74.76"> {</span>
<a href="#l74.77"></a><span id="l74.77" class="difflineat">@@ -193,26 +193,26 @@ nsresult nsTextAddress::ReadRecord(nsILi</span>
<a href="#l74.78"></a><span id="l74.78">   return rv;</span>
<a href="#l74.79"></a><span id="l74.79"> }</span>
<a href="#l74.80"></a><span id="l74.80"> </span>
<a href="#l74.81"></a><span id="l74.81"> nsresult nsTextAddress::ReadRecordNumber(nsIFile *aSrc, nsCString &amp;aLine, PRInt32 rNum)</span>
<a href="#l74.82"></a><span id="l74.82"> {</span>
<a href="#l74.83"></a><span id="l74.83">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l74.84"></a><span id="l74.84">   nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), aSrc);</span>
<a href="#l74.85"></a><span id="l74.85">   if (NS_FAILED(rv)) {</span>
<a href="#l74.86"></a><span id="l74.86" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error opening address file for reading\n&quot;);</span>
<a href="#l74.87"></a><span id="l74.87" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error opening address file for reading\n&quot;);</span>
<a href="#l74.88"></a><span id="l74.88">     return rv;</span>
<a href="#l74.89"></a><span id="l74.89">   }</span>
<a href="#l74.90"></a><span id="l74.90"> </span>
<a href="#l74.91"></a><span id="l74.91">   PRInt32 rIndex = 0;</span>
<a href="#l74.92"></a><span id="l74.92">   PRUint32 bytesLeft = 0;</span>
<a href="#l74.93"></a><span id="l74.93"> </span>
<a href="#l74.94"></a><span id="l74.94">   rv = inputStream-&gt;Available(&amp;bytesLeft);</span>
<a href="#l74.95"></a><span id="l74.95">   if (NS_FAILED(rv)) {</span>
<a href="#l74.96"></a><span id="l74.96" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error checking address file for eof\n&quot;);</span>
<a href="#l74.97"></a><span id="l74.97" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error checking address file for eof\n&quot;);</span>
<a href="#l74.98"></a><span id="l74.98">     inputStream-&gt;Close();</span>
<a href="#l74.99"></a><span id="l74.99">     return rv;</span>
<a href="#l74.100"></a><span id="l74.100">   }</span>
<a href="#l74.101"></a><span id="l74.101"> </span>
<a href="#l74.102"></a><span id="l74.102">   nsCOMPtr&lt;nsILineInputStream&gt; lineStream(do_QueryInterface(inputStream, &amp;rv));</span>
<a href="#l74.103"></a><span id="l74.103">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l74.104"></a><span id="l74.104"> </span>
<a href="#l74.105"></a><span id="l74.105">   bool more = true;</span>
<a href="#l74.106"></a><span id="l74.106" class="difflineat">@@ -229,17 +229,17 @@ nsresult nsTextAddress::ReadRecordNumber</span>
<a href="#l74.107"></a><span id="l74.107">     }</span>
<a href="#l74.108"></a><span id="l74.108"> </span>
<a href="#l74.109"></a><span id="l74.109">     rIndex++;</span>
<a href="#l74.110"></a><span id="l74.110">   }</span>
<a href="#l74.111"></a><span id="l74.111"> </span>
<a href="#l74.112"></a><span id="l74.112">   return NS_ERROR_FAILURE;</span>
<a href="#l74.113"></a><span id="l74.113"> }</span>
<a href="#l74.114"></a><span id="l74.114"> </span>
<a href="#l74.115"></a><span id="l74.115" class="difflineminus">-PRInt32 nsTextAddress::CountFields( const char *pLine, PRInt32 maxLen, char delim)</span>
<a href="#l74.116"></a><span id="l74.116" class="difflineplus">+PRInt32 nsTextAddress::CountFields(const char *pLine, PRInt32 maxLen, char delim)</span>
<a href="#l74.117"></a><span id="l74.117"> {</span>
<a href="#l74.118"></a><span id="l74.118">     const char *pChar = pLine;</span>
<a href="#l74.119"></a><span id="l74.119">     PRInt32 len = 0;</span>
<a href="#l74.120"></a><span id="l74.120">     PRInt32 count = 0;</span>
<a href="#l74.121"></a><span id="l74.121">     char tab = '\t';</span>
<a href="#l74.122"></a><span id="l74.122"> </span>
<a href="#l74.123"></a><span id="l74.123">     if (delim == tab)</span>
<a href="#l74.124"></a><span id="l74.124">         tab = 0;</span>
<a href="#l74.125"></a><span id="l74.125" class="difflineat">@@ -270,20 +270,20 @@ PRInt32 nsTextAddress::CountFields( cons</span>
<a href="#l74.126"></a><span id="l74.126">             pChar++;</span>
<a href="#l74.127"></a><span id="l74.127">         }</span>
<a href="#l74.128"></a><span id="l74.128"> </span>
<a href="#l74.129"></a><span id="l74.129">         count++;</span>
<a href="#l74.130"></a><span id="l74.130">         pChar++;</span>
<a href="#l74.131"></a><span id="l74.131">         len++;</span>
<a href="#l74.132"></a><span id="l74.132">     }</span>
<a href="#l74.133"></a><span id="l74.133"> </span>
<a href="#l74.134"></a><span id="l74.134" class="difflineminus">-    return( count);</span>
<a href="#l74.135"></a><span id="l74.135" class="difflineplus">+    return count;</span>
<a href="#l74.136"></a><span id="l74.136"> }</span>
<a href="#l74.137"></a><span id="l74.137"> </span>
<a href="#l74.138"></a><span id="l74.138" class="difflineminus">-bool nsTextAddress::GetField( const char *pLine, PRInt32 maxLen, PRInt32 index, nsCString&amp; field, char delim)</span>
<a href="#l74.139"></a><span id="l74.139" class="difflineplus">+bool nsTextAddress::GetField(const char *pLine, PRInt32 maxLen, PRInt32 index, nsCString&amp; field, char delim)</span>
<a href="#l74.140"></a><span id="l74.140"> {</span>
<a href="#l74.141"></a><span id="l74.141">     bool result = false;</span>
<a href="#l74.142"></a><span id="l74.142">     const char *pChar = pLine;</span>
<a href="#l74.143"></a><span id="l74.143">     PRInt32 len = 0;</span>
<a href="#l74.144"></a><span id="l74.144">     char tab = '\t';</span>
<a href="#l74.145"></a><span id="l74.145"> </span>
<a href="#l74.146"></a><span id="l74.146">     field.Truncate();</span>
<a href="#l74.147"></a><span id="l74.147"> </span>
<a href="#l74.148"></a><span id="l74.148" class="difflineat">@@ -324,17 +324,17 @@ bool nsTextAddress::GetField( const char</span>
<a href="#l74.149"></a><span id="l74.149">             break;</span>
<a href="#l74.150"></a><span id="l74.150"> </span>
<a href="#l74.151"></a><span id="l74.151">         index--;</span>
<a href="#l74.152"></a><span id="l74.152">         pChar++;</span>
<a href="#l74.153"></a><span id="l74.153">         len++;</span>
<a href="#l74.154"></a><span id="l74.154">     }</span>
<a href="#l74.155"></a><span id="l74.155"> </span>
<a href="#l74.156"></a><span id="l74.156">     if (len &gt;= maxLen) {</span>
<a href="#l74.157"></a><span id="l74.157" class="difflineminus">-        return( result);</span>
<a href="#l74.158"></a><span id="l74.158" class="difflineplus">+        return result;</span>
<a href="#l74.159"></a><span id="l74.159">     }</span>
<a href="#l74.160"></a><span id="l74.160"> </span>
<a href="#l74.161"></a><span id="l74.161">     result = true;</span>
<a href="#l74.162"></a><span id="l74.162"> </span>
<a href="#l74.163"></a><span id="l74.163">     while ((len &lt; maxLen) &amp;&amp; ((*pChar == ' ') || (*pChar == tab))) {</span>
<a href="#l74.164"></a><span id="l74.164">         len++;</span>
<a href="#l74.165"></a><span id="l74.165">         pChar++;</span>
<a href="#l74.166"></a><span id="l74.166">     }</span>
<a href="#l74.167"></a><span id="l74.167" class="difflineat">@@ -361,50 +361,50 @@ bool nsTextAddress::GetField( const char</span>
<a href="#l74.168"></a><span id="l74.168">         while ((len &lt; maxLen) &amp;&amp; (*pChar != delim)) {</span>
<a href="#l74.169"></a><span id="l74.169">             pChar++;</span>
<a href="#l74.170"></a><span id="l74.170">             len++;</span>
<a href="#l74.171"></a><span id="l74.171">             fLen++;</span>
<a href="#l74.172"></a><span id="l74.172">         }</span>
<a href="#l74.173"></a><span id="l74.173">     }</span>
<a href="#l74.174"></a><span id="l74.174"> </span>
<a href="#l74.175"></a><span id="l74.175">     if (!fLen) {</span>
<a href="#l74.176"></a><span id="l74.176" class="difflineminus">-        return( result);</span>
<a href="#l74.177"></a><span id="l74.177" class="difflineplus">+        return result;</span>
<a href="#l74.178"></a><span id="l74.178">     }</span>
<a href="#l74.179"></a><span id="l74.179"> </span>
<a href="#l74.180"></a><span id="l74.180" class="difflineminus">-    field.Append( pStart, fLen);</span>
<a href="#l74.181"></a><span id="l74.181" class="difflineminus">-    field.Trim( kWhitespace);</span>
<a href="#l74.182"></a><span id="l74.182" class="difflineplus">+    field.Append(pStart, fLen);</span>
<a href="#l74.183"></a><span id="l74.183" class="difflineplus">+    field.Trim(kWhitespace);</span>
<a href="#l74.184"></a><span id="l74.184"> </span>
<a href="#l74.185"></a><span id="l74.185">     if (quoted) {</span>
<a href="#l74.186"></a><span id="l74.186">       PRInt32 offset = field.Find(NS_LITERAL_CSTRING(&quot;\&quot;\&quot;&quot;));</span>
<a href="#l74.187"></a><span id="l74.187">       while (offset != -1) {</span>
<a href="#l74.188"></a><span id="l74.188">         field.Cut(offset, 1);</span>
<a href="#l74.189"></a><span id="l74.189">         offset = field.Find(NS_LITERAL_CSTRING(&quot;\&quot;\&quot;&quot;), offset + 1);</span>
<a href="#l74.190"></a><span id="l74.190">       }</span>
<a href="#l74.191"></a><span id="l74.191">     }</span>
<a href="#l74.192"></a><span id="l74.192"> </span>
<a href="#l74.193"></a><span id="l74.193" class="difflineminus">-    return( result);</span>
<a href="#l74.194"></a><span id="l74.194" class="difflineplus">+    return result;</span>
<a href="#l74.195"></a><span id="l74.195"> }</span>
<a href="#l74.196"></a><span id="l74.196"> </span>
<a href="#l74.197"></a><span id="l74.197"> nsresult nsTextAddress::DetermineDelim(nsIFile *aSrc)</span>
<a href="#l74.198"></a><span id="l74.198"> {</span>
<a href="#l74.199"></a><span id="l74.199">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l74.200"></a><span id="l74.200">   nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), aSrc);</span>
<a href="#l74.201"></a><span id="l74.201">   if (NS_FAILED(rv)) {</span>
<a href="#l74.202"></a><span id="l74.202" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error opening address file for reading\n&quot;);</span>
<a href="#l74.203"></a><span id="l74.203" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error opening address file for reading\n&quot;);</span>
<a href="#l74.204"></a><span id="l74.204">     return rv;</span>
<a href="#l74.205"></a><span id="l74.205">   }</span>
<a href="#l74.206"></a><span id="l74.206"> </span>
<a href="#l74.207"></a><span id="l74.207">   char *pLine = new char[kTextAddressBufferSz];</span>
<a href="#l74.208"></a><span id="l74.208">   if (!pLine)</span>
<a href="#l74.209"></a><span id="l74.209">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l74.210"></a><span id="l74.210"> </span>
<a href="#l74.211"></a><span id="l74.211">   PRUint32 bytesLeft = 0;</span>
<a href="#l74.212"></a><span id="l74.212">   rv = inputStream-&gt;Available(&amp;bytesLeft);</span>
<a href="#l74.213"></a><span id="l74.213">   if (NS_FAILED(rv)) {</span>
<a href="#l74.214"></a><span id="l74.214" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error checking address file for eof\n&quot;);</span>
<a href="#l74.215"></a><span id="l74.215" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error checking address file for eof\n&quot;);</span>
<a href="#l74.216"></a><span id="l74.216">     inputStream-&gt;Close();</span>
<a href="#l74.217"></a><span id="l74.217">     delete [] pLine;</span>
<a href="#l74.218"></a><span id="l74.218">     return rv;</span>
<a href="#l74.219"></a><span id="l74.219">   }</span>
<a href="#l74.220"></a><span id="l74.220"> </span>
<a href="#l74.221"></a><span id="l74.221">   PRUint32 left;</span>
<a href="#l74.222"></a><span id="l74.222">   PRInt32 lineLen = 0;</span>
<a href="#l74.223"></a><span id="l74.223">   PRInt32 lineCount = 0;</span>
<a href="#l74.224"></a><span id="l74.224" class="difflineat">@@ -443,73 +443,73 @@ nsresult nsTextAddress::DetermineDelim(n</span>
<a href="#l74.225"></a><span id="l74.225"> </span>
<a href="#l74.226"></a><span id="l74.226">   return rv;</span>
<a href="#l74.227"></a><span id="l74.227"> }</span>
<a href="#l74.228"></a><span id="l74.228"> </span>
<a href="#l74.229"></a><span id="l74.229"> /*</span>
<a href="#l74.230"></a><span id="l74.230">     This is where the real work happens!</span>
<a href="#l74.231"></a><span id="l74.231">     Go through the field map and set the data in a new database row</span>
<a href="#l74.232"></a><span id="l74.232"> */</span>
<a href="#l74.233"></a><span id="l74.233" class="difflineminus">-nsresult nsTextAddress::ProcessLine( const char *pLine, PRInt32 len, nsString&amp; errors)</span>
<a href="#l74.234"></a><span id="l74.234" class="difflineplus">+nsresult nsTextAddress::ProcessLine(const char *pLine, PRInt32 len, nsString&amp; errors)</span>
<a href="#l74.235"></a><span id="l74.235"> {</span>
<a href="#l74.236"></a><span id="l74.236">     if (!m_fieldMap) {</span>
<a href="#l74.237"></a><span id="l74.237" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error, text import needs a field map\n&quot;);</span>
<a href="#l74.238"></a><span id="l74.238" class="difflineminus">-        return( NS_ERROR_FAILURE);</span>
<a href="#l74.239"></a><span id="l74.239" class="difflineplus">+        IMPORT_LOG0(&quot;*** Error, text import needs a field map\n&quot;);</span>
<a href="#l74.240"></a><span id="l74.240" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l74.241"></a><span id="l74.241">     }</span>
<a href="#l74.242"></a><span id="l74.242"> </span>
<a href="#l74.243"></a><span id="l74.243">     nsresult rv;</span>
<a href="#l74.244"></a><span id="l74.244"> </span>
<a href="#l74.245"></a><span id="l74.245">     // Wait until we get our first non-empty field, then create a new row,</span>
<a href="#l74.246"></a><span id="l74.246">     // fill in the data, then add the row to the database.</span>
<a href="#l74.247"></a><span id="l74.247"> </span>
<a href="#l74.248"></a><span id="l74.248"> </span>
<a href="#l74.249"></a><span id="l74.249">     nsIMdbRow *    newRow = nsnull;</span>
<a href="#l74.250"></a><span id="l74.250">     nsString    uVal;</span>
<a href="#l74.251"></a><span id="l74.251">     nsCString    fieldVal;</span>
<a href="#l74.252"></a><span id="l74.252">     PRInt32        fieldNum;</span>
<a href="#l74.253"></a><span id="l74.253">     PRInt32        numFields = 0;</span>
<a href="#l74.254"></a><span id="l74.254">     bool          active;</span>
<a href="#l74.255"></a><span id="l74.255" class="difflineminus">-    rv = m_fieldMap-&gt;GetMapSize( &amp;numFields);</span>
<a href="#l74.256"></a><span id="l74.256" class="difflineminus">-    for (PRInt32 i = 0; (i &lt; numFields) &amp;&amp; NS_SUCCEEDED( rv); i++) {</span>
<a href="#l74.257"></a><span id="l74.257" class="difflineplus">+    rv = m_fieldMap-&gt;GetMapSize(&amp;numFields);</span>
<a href="#l74.258"></a><span id="l74.258" class="difflineplus">+    for (PRInt32 i = 0; (i &lt; numFields) &amp;&amp; NS_SUCCEEDED(rv); i++) {</span>
<a href="#l74.259"></a><span id="l74.259">         active = false;</span>
<a href="#l74.260"></a><span id="l74.260" class="difflineminus">-        rv = m_fieldMap-&gt;GetFieldMap( i, &amp;fieldNum);</span>
<a href="#l74.261"></a><span id="l74.261" class="difflineminus">-        if (NS_SUCCEEDED( rv))</span>
<a href="#l74.262"></a><span id="l74.262" class="difflineminus">-            rv = m_fieldMap-&gt;GetFieldActive( i, &amp;active);</span>
<a href="#l74.263"></a><span id="l74.263" class="difflineminus">-        if (NS_SUCCEEDED( rv) &amp;&amp; active) {</span>
<a href="#l74.264"></a><span id="l74.264" class="difflineminus">-            if (GetField( pLine, len, i, fieldVal, m_delim)) {</span>
<a href="#l74.265"></a><span id="l74.265" class="difflineplus">+        rv = m_fieldMap-&gt;GetFieldMap(i, &amp;fieldNum);</span>
<a href="#l74.266"></a><span id="l74.266" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l74.267"></a><span id="l74.267" class="difflineplus">+            rv = m_fieldMap-&gt;GetFieldActive(i, &amp;active);</span>
<a href="#l74.268"></a><span id="l74.268" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; active) {</span>
<a href="#l74.269"></a><span id="l74.269" class="difflineplus">+            if (GetField(pLine, len, i, fieldVal, m_delim)) {</span>
<a href="#l74.270"></a><span id="l74.270">                 if (!fieldVal.IsEmpty()) {</span>
<a href="#l74.271"></a><span id="l74.271">                     if (!newRow) {</span>
<a href="#l74.272"></a><span id="l74.272" class="difflineminus">-                        rv = m_database-&gt;GetNewRow( &amp;newRow);</span>
<a href="#l74.273"></a><span id="l74.273" class="difflineminus">-                        if (NS_FAILED( rv)) {</span>
<a href="#l74.274"></a><span id="l74.274" class="difflineminus">-                            IMPORT_LOG0( &quot;*** Error getting new address database row\n&quot;);</span>
<a href="#l74.275"></a><span id="l74.275" class="difflineplus">+                        rv = m_database-&gt;GetNewRow(&amp;newRow);</span>
<a href="#l74.276"></a><span id="l74.276" class="difflineplus">+                        if (NS_FAILED(rv)) {</span>
<a href="#l74.277"></a><span id="l74.277" class="difflineplus">+                            IMPORT_LOG0(&quot;*** Error getting new address database row\n&quot;);</span>
<a href="#l74.278"></a><span id="l74.278">                         }</span>
<a href="#l74.279"></a><span id="l74.279">                     }</span>
<a href="#l74.280"></a><span id="l74.280">                     if (newRow) {</span>
<a href="#l74.281"></a><span id="l74.281" class="difflineminus">-                        NS_CopyNativeToUnicode( fieldVal, uVal);</span>
<a href="#l74.282"></a><span id="l74.282" class="difflineminus">-                        rv = m_fieldMap-&gt;SetFieldValue( m_database, newRow, fieldNum, uVal.get());</span>
<a href="#l74.283"></a><span id="l74.283" class="difflineplus">+                        NS_CopyNativeToUnicode(fieldVal, uVal);</span>
<a href="#l74.284"></a><span id="l74.284" class="difflineplus">+                        rv = m_fieldMap-&gt;SetFieldValue(m_database, newRow, fieldNum, uVal.get());</span>
<a href="#l74.285"></a><span id="l74.285">                     }</span>
<a href="#l74.286"></a><span id="l74.286">                 }</span>
<a href="#l74.287"></a><span id="l74.287">             }</span>
<a href="#l74.288"></a><span id="l74.288">             else</span>
<a href="#l74.289"></a><span id="l74.289">                 break;</span>
<a href="#l74.290"></a><span id="l74.290"> </span>
<a href="#l74.291"></a><span id="l74.291">         }</span>
<a href="#l74.292"></a><span id="l74.292">         else {</span>
<a href="#l74.293"></a><span id="l74.293">             if (active) {</span>
<a href="#l74.294"></a><span id="l74.294" class="difflineminus">-                IMPORT_LOG1( &quot;*** Error getting field map for index %ld\n&quot;, (long) i);</span>
<a href="#l74.295"></a><span id="l74.295" class="difflineplus">+                IMPORT_LOG1(&quot;*** Error getting field map for index %ld\n&quot;, (long) i);</span>
<a href="#l74.296"></a><span id="l74.296">             }</span>
<a href="#l74.297"></a><span id="l74.297">         }</span>
<a href="#l74.298"></a><span id="l74.298"> </span>
<a href="#l74.299"></a><span id="l74.299">     }</span>
<a href="#l74.300"></a><span id="l74.300"> </span>
<a href="#l74.301"></a><span id="l74.301" class="difflineminus">-    if (NS_SUCCEEDED( rv)) {</span>
<a href="#l74.302"></a><span id="l74.302" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l74.303"></a><span id="l74.303">         if (newRow) {</span>
<a href="#l74.304"></a><span id="l74.304" class="difflineminus">-            rv = m_database-&gt;AddCardRowToDB( newRow);</span>
<a href="#l74.305"></a><span id="l74.305" class="difflineplus">+            rv = m_database-&gt;AddCardRowToDB(newRow);</span>
<a href="#l74.306"></a><span id="l74.306">             // Release newRow????</span>
<a href="#l74.307"></a><span id="l74.307">         }</span>
<a href="#l74.308"></a><span id="l74.308">     }</span>
<a href="#l74.309"></a><span id="l74.309">     else {</span>
<a href="#l74.310"></a><span id="l74.310">         // Release newRow??</span>
<a href="#l74.311"></a><span id="l74.311">     }</span>
<a href="#l74.312"></a><span id="l74.312"> </span>
<a href="#l74.313"></a><span id="l74.313" class="difflineminus">-    return( rv);</span>
<a href="#l74.314"></a><span id="l74.314" class="difflineplus">+    return rv;</span>
<a href="#l74.315"></a><span id="l74.315"> }</span>
<a href="#l74.316"></a><span id="l74.316"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/mailnews/import/text/src/nsTextAddress.h</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/mailnews/import/text/src/nsTextAddress.h</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -57,17 +57,17 @@ class nsILineInputStream;</span>
<a href="#l75.4"></a><span id="l75.4"> class nsTextAddress {</span>
<a href="#l75.5"></a><span id="l75.5"> public:</span>
<a href="#l75.6"></a><span id="l75.6">   nsTextAddress();</span>
<a href="#l75.7"></a><span id="l75.7">   virtual ~nsTextAddress();</span>
<a href="#l75.8"></a><span id="l75.8"> </span>
<a href="#l75.9"></a><span id="l75.9">   nsresult ImportAddresses(bool *pAbort, const PRUnichar *pName, nsIFile *pSrc, nsIAddrDatabase *pDb, nsIImportFieldMap *fieldMap, nsString&amp; errors, PRUint32 *pProgress);</span>
<a href="#l75.10"></a><span id="l75.10"> </span>
<a href="#l75.11"></a><span id="l75.11">   nsresult DetermineDelim(nsIFile *pSrc);</span>
<a href="#l75.12"></a><span id="l75.12" class="difflineminus">-  char GetDelim( void) { return( m_delim);}</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineplus">+  char GetDelim(void) { return m_delim;}</span>
<a href="#l75.14"></a><span id="l75.14"> </span>
<a href="#l75.15"></a><span id="l75.15">   static nsresult ReadRecordNumber(nsIFile *pSrc, nsCString &amp;aLine, PRInt32 rNum);</span>
<a href="#l75.16"></a><span id="l75.16">   static bool GetField(const char *pLine, PRInt32 maxLen, PRInt32 index, nsCString&amp; field, char delim);</span>
<a href="#l75.17"></a><span id="l75.17"> </span>
<a href="#l75.18"></a><span id="l75.18"> private:</span>
<a href="#l75.19"></a><span id="l75.19">   nsresult ProcessLine(const char *pLine, PRInt32 len, nsString&amp; errors);</span>
<a href="#l75.20"></a><span id="l75.20"> </span>
<a href="#l75.21"></a><span id="l75.21">   static PRInt32 CountFields(const char *pLine, PRInt32 maxLen, char delim);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/mailnews/import/text/src/nsTextImport.cpp</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/mailnews/import/text/src/nsTextImport.cpp</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -94,17 +94,17 @@ public:</span>
<a href="#l76.4"></a><span id="l76.4">   static nsresult Create(nsIImportAddressBooks** aImport,</span>
<a href="#l76.5"></a><span id="l76.5">                          nsIStringBundle *aStringBundle);</span>
<a href="#l76.6"></a><span id="l76.6"> </span>
<a href="#l76.7"></a><span id="l76.7">     // nsISupports interface</span>
<a href="#l76.8"></a><span id="l76.8">     NS_DECL_ISUPPORTS</span>
<a href="#l76.9"></a><span id="l76.9"> </span>
<a href="#l76.10"></a><span id="l76.10">     // nsIImportAddressBooks interface</span>
<a href="#l76.11"></a><span id="l76.11">     </span>
<a href="#l76.12"></a><span id="l76.12" class="difflineminus">-  NS_IMETHOD GetSupportsMultiple(bool *_retval) { *_retval = false; return( NS_OK);}</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineplus">+  NS_IMETHOD GetSupportsMultiple(bool *_retval) { *_retval = false; return NS_OK;}</span>
<a href="#l76.14"></a><span id="l76.14"> </span>
<a href="#l76.15"></a><span id="l76.15">   NS_IMETHOD GetAutoFind(PRUnichar **description, bool *_retval);</span>
<a href="#l76.16"></a><span id="l76.16"> </span>
<a href="#l76.17"></a><span id="l76.17">   NS_IMETHOD GetNeedsFieldMap(nsIFile *location, bool *_retval);</span>
<a href="#l76.18"></a><span id="l76.18"> </span>
<a href="#l76.19"></a><span id="l76.19">   NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found, bool *userVerify);</span>
<a href="#l76.20"></a><span id="l76.20"> </span>
<a href="#l76.21"></a><span id="l76.21">   NS_IMETHOD FindAddressBooks(nsIFile *location, nsISupportsArray **_retval);</span>
<a href="#l76.22"></a><span id="l76.22" class="difflineat">@@ -116,23 +116,23 @@ public:</span>
<a href="#l76.23"></a><span id="l76.23">                                nsIImportFieldMap *fieldMap,</span>
<a href="#l76.24"></a><span id="l76.24">                                nsISupports *aSupportService,</span>
<a href="#l76.25"></a><span id="l76.25">                                PRUnichar **errorLog,</span>
<a href="#l76.26"></a><span id="l76.26">                                PRUnichar **successLog,</span>
<a href="#l76.27"></a><span id="l76.27">                                bool *fatalError);</span>
<a href="#l76.28"></a><span id="l76.28"> </span>
<a href="#l76.29"></a><span id="l76.29">   NS_IMETHOD GetImportProgress(PRUint32 *_retval);</span>
<a href="#l76.30"></a><span id="l76.30"> </span>
<a href="#l76.31"></a><span id="l76.31" class="difflineminus">-  NS_IMETHOD GetSampleData( PRInt32 index, bool *pFound, PRUnichar **pStr);</span>
<a href="#l76.32"></a><span id="l76.32" class="difflineplus">+  NS_IMETHOD GetSampleData(PRInt32 index, bool *pFound, PRUnichar **pStr);</span>
<a href="#l76.33"></a><span id="l76.33"> </span>
<a href="#l76.34"></a><span id="l76.34" class="difflineminus">-  NS_IMETHOD SetSampleLocation( nsIFile *);</span>
<a href="#l76.35"></a><span id="l76.35" class="difflineplus">+  NS_IMETHOD SetSampleLocation(nsIFile *);</span>
<a href="#l76.36"></a><span id="l76.36"> </span>
<a href="#l76.37"></a><span id="l76.37"> private:</span>
<a href="#l76.38"></a><span id="l76.38" class="difflineminus">-  void ClearSampleFile( void);</span>
<a href="#l76.39"></a><span id="l76.39" class="difflineminus">-  void SaveFieldMap( nsIImportFieldMap *pMap);</span>
<a href="#l76.40"></a><span id="l76.40" class="difflineplus">+  void ClearSampleFile(void);</span>
<a href="#l76.41"></a><span id="l76.41" class="difflineplus">+  void SaveFieldMap(nsIImportFieldMap *pMap);</span>
<a href="#l76.42"></a><span id="l76.42"> </span>
<a href="#l76.43"></a><span id="l76.43">   static void ReportSuccess(nsString&amp; name, nsString *pStream,</span>
<a href="#l76.44"></a><span id="l76.44">                             nsIStringBundle* pBundle);</span>
<a href="#l76.45"></a><span id="l76.45">   static void SetLogs(nsString&amp; success, nsString&amp; error, PRUnichar **pError,</span>
<a href="#l76.46"></a><span id="l76.46">                       PRUnichar **pSuccess);</span>
<a href="#l76.47"></a><span id="l76.47">   static void ReportError(PRInt32 errorNum, nsString&amp; name, nsString *pStream,</span>
<a href="#l76.48"></a><span id="l76.48">                           nsIStringBundle* pBundle);</span>
<a href="#l76.49"></a><span id="l76.49">   static void SanitizeSampleData(nsCString&amp; val);</span>
<a href="#l76.50"></a><span id="l76.50" class="difflineat">@@ -149,90 +149,90 @@ private:</span>
<a href="#l76.51"></a><span id="l76.51"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l76.52"></a><span id="l76.52"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l76.53"></a><span id="l76.53"> </span>
<a href="#l76.54"></a><span id="l76.54"> nsTextImport::nsTextImport()</span>
<a href="#l76.55"></a><span id="l76.55"> {</span>
<a href="#l76.56"></a><span id="l76.56">   // Init logging module.</span>
<a href="#l76.57"></a><span id="l76.57">   if (!TEXTIMPORTLOGMODULE)</span>
<a href="#l76.58"></a><span id="l76.58">     TEXTIMPORTLOGMODULE = PR_NewLogModule(&quot;IMPORT&quot;);</span>
<a href="#l76.59"></a><span id="l76.59" class="difflineminus">-  IMPORT_LOG0( &quot;nsTextImport Module Created\n&quot;);</span>
<a href="#l76.60"></a><span id="l76.60" class="difflineplus">+  IMPORT_LOG0(&quot;nsTextImport Module Created\n&quot;);</span>
<a href="#l76.61"></a><span id="l76.61"> </span>
<a href="#l76.62"></a><span id="l76.62">   nsImportStringBundle::GetStringBundle(TEXT_MSGS_URL,</span>
<a href="#l76.63"></a><span id="l76.63">                                         getter_AddRefs(m_stringBundle));</span>
<a href="#l76.64"></a><span id="l76.64"> }</span>
<a href="#l76.65"></a><span id="l76.65"> </span>
<a href="#l76.66"></a><span id="l76.66"> nsTextImport::~nsTextImport()</span>
<a href="#l76.67"></a><span id="l76.67"> {</span>
<a href="#l76.68"></a><span id="l76.68" class="difflineminus">-  IMPORT_LOG0( &quot;nsTextImport Module Deleted\n&quot;);</span>
<a href="#l76.69"></a><span id="l76.69" class="difflineplus">+  IMPORT_LOG0(&quot;nsTextImport Module Deleted\n&quot;);</span>
<a href="#l76.70"></a><span id="l76.70"> }</span>
<a href="#l76.71"></a><span id="l76.71"> </span>
<a href="#l76.72"></a><span id="l76.72"> NS_IMPL_ISUPPORTS1(nsTextImport, nsIImportModule)</span>
<a href="#l76.73"></a><span id="l76.73"> </span>
<a href="#l76.74"></a><span id="l76.74" class="difflineminus">-NS_IMETHODIMP nsTextImport::GetName( PRUnichar **name)</span>
<a href="#l76.75"></a><span id="l76.75" class="difflineplus">+NS_IMETHODIMP nsTextImport::GetName(PRUnichar **name)</span>
<a href="#l76.76"></a><span id="l76.76"> {</span>
<a href="#l76.77"></a><span id="l76.77">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l76.78"></a><span id="l76.78">   *name = nsImportStringBundle::GetStringByID(TEXTIMPORT_NAME, m_stringBundle);</span>
<a href="#l76.79"></a><span id="l76.79">   return NS_OK;</span>
<a href="#l76.80"></a><span id="l76.80"> }</span>
<a href="#l76.81"></a><span id="l76.81"> </span>
<a href="#l76.82"></a><span id="l76.82" class="difflineminus">-NS_IMETHODIMP nsTextImport::GetDescription( PRUnichar **name)</span>
<a href="#l76.83"></a><span id="l76.83" class="difflineplus">+NS_IMETHODIMP nsTextImport::GetDescription(PRUnichar **name)</span>
<a href="#l76.84"></a><span id="l76.84"> {</span>
<a href="#l76.85"></a><span id="l76.85">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l76.86"></a><span id="l76.86">   *name = nsImportStringBundle::GetStringByID(TEXTIMPORT_DESCRIPTION,</span>
<a href="#l76.87"></a><span id="l76.87">                                               m_stringBundle);</span>
<a href="#l76.88"></a><span id="l76.88"> </span>
<a href="#l76.89"></a><span id="l76.89">   return NS_OK;</span>
<a href="#l76.90"></a><span id="l76.90"> }</span>
<a href="#l76.91"></a><span id="l76.91"> </span>
<a href="#l76.92"></a><span id="l76.92" class="difflineminus">-NS_IMETHODIMP nsTextImport::GetSupports( char **supports)</span>
<a href="#l76.93"></a><span id="l76.93" class="difflineplus">+NS_IMETHODIMP nsTextImport::GetSupports(char **supports)</span>
<a href="#l76.94"></a><span id="l76.94"> {</span>
<a href="#l76.95"></a><span id="l76.95">   NS_ENSURE_ARG_POINTER(supports);</span>
<a href="#l76.96"></a><span id="l76.96" class="difflineminus">-  *supports = strdup( kTextSupportsString);</span>
<a href="#l76.97"></a><span id="l76.97" class="difflineplus">+  *supports = strdup(kTextSupportsString);</span>
<a href="#l76.98"></a><span id="l76.98">   return NS_OK;</span>
<a href="#l76.99"></a><span id="l76.99"> }</span>
<a href="#l76.100"></a><span id="l76.100"> </span>
<a href="#l76.101"></a><span id="l76.101" class="difflineminus">-NS_IMETHODIMP nsTextImport::GetSupportsUpgrade( bool *pUpgrade)</span>
<a href="#l76.102"></a><span id="l76.102" class="difflineplus">+NS_IMETHODIMP nsTextImport::GetSupportsUpgrade(bool *pUpgrade)</span>
<a href="#l76.103"></a><span id="l76.103"> {</span>
<a href="#l76.104"></a><span id="l76.104">   NS_PRECONDITION(pUpgrade != nsnull, &quot;null ptr&quot;);</span>
<a href="#l76.105"></a><span id="l76.105">   if (! pUpgrade)</span>
<a href="#l76.106"></a><span id="l76.106">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l76.107"></a><span id="l76.107"> </span>
<a href="#l76.108"></a><span id="l76.108">   *pUpgrade = false;</span>
<a href="#l76.109"></a><span id="l76.109">   return NS_OK;</span>
<a href="#l76.110"></a><span id="l76.110"> }</span>
<a href="#l76.111"></a><span id="l76.111"> </span>
<a href="#l76.112"></a><span id="l76.112" class="difflineminus">-NS_IMETHODIMP nsTextImport::GetImportInterface( const char *pImportType, nsISupports **ppInterface)</span>
<a href="#l76.113"></a><span id="l76.113" class="difflineplus">+NS_IMETHODIMP nsTextImport::GetImportInterface(const char *pImportType, nsISupports **ppInterface)</span>
<a href="#l76.114"></a><span id="l76.114"> {</span>
<a href="#l76.115"></a><span id="l76.115">   NS_ENSURE_ARG_POINTER(pImportType);</span>
<a href="#l76.116"></a><span id="l76.116">   NS_ENSURE_ARG_POINTER(ppInterface);</span>
<a href="#l76.117"></a><span id="l76.117"> </span>
<a href="#l76.118"></a><span id="l76.118">   *ppInterface = nsnull;</span>
<a href="#l76.119"></a><span id="l76.119">   nsresult rv;</span>
<a href="#l76.120"></a><span id="l76.120"> </span>
<a href="#l76.121"></a><span id="l76.121" class="difflineminus">-  if (!strcmp( pImportType, &quot;addressbook&quot;)) {</span>
<a href="#l76.122"></a><span id="l76.122" class="difflineplus">+  if (!strcmp(pImportType, &quot;addressbook&quot;)) {</span>
<a href="#l76.123"></a><span id="l76.123">     // create the nsIImportMail interface and return it!</span>
<a href="#l76.124"></a><span id="l76.124">     nsIImportAddressBooks * pAddress = nsnull;</span>
<a href="#l76.125"></a><span id="l76.125">     nsIImportGeneric * pGeneric = nsnull;</span>
<a href="#l76.126"></a><span id="l76.126">     rv = ImportAddressImpl::Create(&amp;pAddress, m_stringBundle);</span>
<a href="#l76.127"></a><span id="l76.127" class="difflineminus">-    if (NS_SUCCEEDED( rv)) {</span>
<a href="#l76.128"></a><span id="l76.128" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l76.129"></a><span id="l76.129">       nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l76.130"></a><span id="l76.130" class="difflineminus">-      if (NS_SUCCEEDED( rv)) {</span>
<a href="#l76.131"></a><span id="l76.131" class="difflineminus">-        rv = impSvc-&gt;CreateNewGenericAddressBooks( &amp;pGeneric);</span>
<a href="#l76.132"></a><span id="l76.132" class="difflineminus">-        if (NS_SUCCEEDED( rv)) {</span>
<a href="#l76.133"></a><span id="l76.133" class="difflineminus">-          pGeneric-&gt;SetData( &quot;addressInterface&quot;, pAddress);</span>
<a href="#l76.134"></a><span id="l76.134" class="difflineminus">-          rv = pGeneric-&gt;QueryInterface( kISupportsIID, (void **)ppInterface);</span>
<a href="#l76.135"></a><span id="l76.135" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l76.136"></a><span id="l76.136" class="difflineplus">+        rv = impSvc-&gt;CreateNewGenericAddressBooks(&amp;pGeneric);</span>
<a href="#l76.137"></a><span id="l76.137" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l76.138"></a><span id="l76.138" class="difflineplus">+          pGeneric-&gt;SetData(&quot;addressInterface&quot;, pAddress);</span>
<a href="#l76.139"></a><span id="l76.139" class="difflineplus">+          rv = pGeneric-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l76.140"></a><span id="l76.140">         }</span>
<a href="#l76.141"></a><span id="l76.141">       }</span>
<a href="#l76.142"></a><span id="l76.142">     }</span>
<a href="#l76.143"></a><span id="l76.143" class="difflineminus">-    NS_IF_RELEASE( pAddress);</span>
<a href="#l76.144"></a><span id="l76.144" class="difflineminus">-    NS_IF_RELEASE( pGeneric);</span>
<a href="#l76.145"></a><span id="l76.145" class="difflineminus">-    return( rv);</span>
<a href="#l76.146"></a><span id="l76.146" class="difflineplus">+    NS_IF_RELEASE(pAddress);</span>
<a href="#l76.147"></a><span id="l76.147" class="difflineplus">+    NS_IF_RELEASE(pGeneric);</span>
<a href="#l76.148"></a><span id="l76.148" class="difflineplus">+    return rv;</span>
<a href="#l76.149"></a><span id="l76.149">   }</span>
<a href="#l76.150"></a><span id="l76.150" class="difflineminus">-  return( NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l76.151"></a><span id="l76.151" class="difflineplus">+  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l76.152"></a><span id="l76.152"> }</span>
<a href="#l76.153"></a><span id="l76.153"> </span>
<a href="#l76.154"></a><span id="l76.154"> /////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l76.155"></a><span id="l76.155"> </span>
<a href="#l76.156"></a><span id="l76.156"> </span>
<a href="#l76.157"></a><span id="l76.157"> </span>
<a href="#l76.158"></a><span id="l76.158"> nsresult ImportAddressImpl::Create(nsIImportAddressBooks** aImport,</span>
<a href="#l76.159"></a><span id="l76.159">                                    nsIStringBundle* aStringBundle)</span>
<a href="#l76.160"></a><span id="l76.160" class="difflineat">@@ -265,115 +265,115 @@ NS_IMETHODIMP ImportAddressImpl::GetAuto</span>
<a href="#l76.161"></a><span id="l76.161">   nsString str;</span>
<a href="#l76.162"></a><span id="l76.162">   *_retval = false;</span>
<a href="#l76.163"></a><span id="l76.163"> </span>
<a href="#l76.164"></a><span id="l76.164">   if (!m_notProxyBundle)</span>
<a href="#l76.165"></a><span id="l76.165">     return NS_ERROR_FAILURE;</span>
<a href="#l76.166"></a><span id="l76.166"> </span>
<a href="#l76.167"></a><span id="l76.167">   nsImportStringBundle::GetStringByID(TEXTIMPORT_ADDRESS_NAME, m_notProxyBundle, str);</span>
<a href="#l76.168"></a><span id="l76.168">   *addrDescription = ToNewUnicode(str);</span>
<a href="#l76.169"></a><span id="l76.169" class="difflineminus">-  return( NS_OK);</span>
<a href="#l76.170"></a><span id="l76.170" class="difflineplus">+  return NS_OK;</span>
<a href="#l76.171"></a><span id="l76.171"> }</span>
<a href="#l76.172"></a><span id="l76.172"> </span>
<a href="#l76.173"></a><span id="l76.173"> </span>
<a href="#l76.174"></a><span id="l76.174"> NS_IMETHODIMP ImportAddressImpl::GetDefaultLocation(nsIFile **ppLoc, bool *found, bool *userVerify)</span>
<a href="#l76.175"></a><span id="l76.175"> {</span>
<a href="#l76.176"></a><span id="l76.176">   NS_PRECONDITION(found != nsnull, &quot;null ptr&quot;);</span>
<a href="#l76.177"></a><span id="l76.177">   NS_PRECONDITION(ppLoc != nsnull, &quot;null ptr&quot;);</span>
<a href="#l76.178"></a><span id="l76.178">   NS_PRECONDITION(userVerify != nsnull, &quot;null ptr&quot;);</span>
<a href="#l76.179"></a><span id="l76.179">   if (! found || !userVerify || !ppLoc)</span>
<a href="#l76.180"></a><span id="l76.180">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l76.181"></a><span id="l76.181"> </span>
<a href="#l76.182"></a><span id="l76.182">   *ppLoc = nsnull;</span>
<a href="#l76.183"></a><span id="l76.183">   *found = false;</span>
<a href="#l76.184"></a><span id="l76.184">   *userVerify = true;</span>
<a href="#l76.185"></a><span id="l76.185" class="difflineminus">-  return( NS_OK);</span>
<a href="#l76.186"></a><span id="l76.186" class="difflineplus">+  return NS_OK;</span>
<a href="#l76.187"></a><span id="l76.187"> }</span>
<a href="#l76.188"></a><span id="l76.188"> </span>
<a href="#l76.189"></a><span id="l76.189"> </span>
<a href="#l76.190"></a><span id="l76.190"> </span>
<a href="#l76.191"></a><span id="l76.191"> NS_IMETHODIMP ImportAddressImpl::FindAddressBooks(nsIFile *pLoc, nsISupportsArray **ppArray)</span>
<a href="#l76.192"></a><span id="l76.192"> {</span>
<a href="#l76.193"></a><span id="l76.193">   NS_PRECONDITION(pLoc != nsnull, &quot;null ptr&quot;);</span>
<a href="#l76.194"></a><span id="l76.194">   NS_PRECONDITION(ppArray != nsnull, &quot;null ptr&quot;);</span>
<a href="#l76.195"></a><span id="l76.195">   if (!pLoc || !ppArray)</span>
<a href="#l76.196"></a><span id="l76.196">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l76.197"></a><span id="l76.197"> </span>
<a href="#l76.198"></a><span id="l76.198">   ClearSampleFile();</span>
<a href="#l76.199"></a><span id="l76.199"> </span>
<a href="#l76.200"></a><span id="l76.200">   *ppArray = nsnull;</span>
<a href="#l76.201"></a><span id="l76.201">   bool exists = false;</span>
<a href="#l76.202"></a><span id="l76.202" class="difflineminus">-  nsresult rv = pLoc-&gt;Exists( &amp;exists);</span>
<a href="#l76.203"></a><span id="l76.203" class="difflineminus">-  if (NS_FAILED( rv) || !exists)</span>
<a href="#l76.204"></a><span id="l76.204" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l76.205"></a><span id="l76.205" class="difflineplus">+  nsresult rv = pLoc-&gt;Exists(&amp;exists);</span>
<a href="#l76.206"></a><span id="l76.206" class="difflineplus">+  if (NS_FAILED(rv) || !exists)</span>
<a href="#l76.207"></a><span id="l76.207" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l76.208"></a><span id="l76.208"> </span>
<a href="#l76.209"></a><span id="l76.209">   bool isFile = false;</span>
<a href="#l76.210"></a><span id="l76.210" class="difflineminus">-  rv = pLoc-&gt;IsFile( &amp;isFile);</span>
<a href="#l76.211"></a><span id="l76.211" class="difflineminus">-  if (NS_FAILED( rv) || !isFile)</span>
<a href="#l76.212"></a><span id="l76.212" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l76.213"></a><span id="l76.213" class="difflineplus">+  rv = pLoc-&gt;IsFile(&amp;isFile);</span>
<a href="#l76.214"></a><span id="l76.214" class="difflineplus">+  if (NS_FAILED(rv) || !isFile)</span>
<a href="#l76.215"></a><span id="l76.215" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l76.216"></a><span id="l76.216"> </span>
<a href="#l76.217"></a><span id="l76.217">   rv = m_text.DetermineDelim(pLoc);</span>
<a href="#l76.218"></a><span id="l76.218"> </span>
<a href="#l76.219"></a><span id="l76.219" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l76.220"></a><span id="l76.220" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error determining delimitter\n&quot;);</span>
<a href="#l76.221"></a><span id="l76.221" class="difflineminus">-    return( rv);</span>
<a href="#l76.222"></a><span id="l76.222" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l76.223"></a><span id="l76.223" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error determining delimitter\n&quot;);</span>
<a href="#l76.224"></a><span id="l76.224" class="difflineplus">+    return rv;</span>
<a href="#l76.225"></a><span id="l76.225">   }</span>
<a href="#l76.226"></a><span id="l76.226">   m_haveDelim = true;</span>
<a href="#l76.227"></a><span id="l76.227">   m_delim = m_text.GetDelim();</span>
<a href="#l76.228"></a><span id="l76.228"> </span>
<a href="#l76.229"></a><span id="l76.229">   m_fileLoc = do_QueryInterface(pLoc);</span>
<a href="#l76.230"></a><span id="l76.230"> </span>
<a href="#l76.231"></a><span id="l76.231">   /* Build an address book descriptor based on the file passed in! */</span>
<a href="#l76.232"></a><span id="l76.232">   nsCOMPtr&lt;nsISupportsArray&gt; array;</span>
<a href="#l76.233"></a><span id="l76.233" class="difflineminus">-  rv = NS_NewISupportsArray( getter_AddRefs( array));</span>
<a href="#l76.234"></a><span id="l76.234" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l76.235"></a><span id="l76.235" class="difflineminus">-    IMPORT_LOG0( &quot;FAILED to allocate the nsISupportsArray\n&quot;);</span>
<a href="#l76.236"></a><span id="l76.236" class="difflineminus">-    return( rv);</span>
<a href="#l76.237"></a><span id="l76.237" class="difflineplus">+  rv = NS_NewISupportsArray(getter_AddRefs(array));</span>
<a href="#l76.238"></a><span id="l76.238" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l76.239"></a><span id="l76.239" class="difflineplus">+    IMPORT_LOG0(&quot;FAILED to allocate the nsISupportsArray\n&quot;);</span>
<a href="#l76.240"></a><span id="l76.240" class="difflineplus">+    return rv;</span>
<a href="#l76.241"></a><span id="l76.241">   }</span>
<a href="#l76.242"></a><span id="l76.242"> </span>
<a href="#l76.243"></a><span id="l76.243">   nsString name;</span>
<a href="#l76.244"></a><span id="l76.244">   m_fileLoc-&gt;GetLeafName(name);</span>
<a href="#l76.245"></a><span id="l76.245" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l76.246"></a><span id="l76.246" class="difflineminus">-    IMPORT_LOG0( &quot;*** Failed getting leaf name of file\n&quot;);</span>
<a href="#l76.247"></a><span id="l76.247" class="difflineminus">-    return( rv);</span>
<a href="#l76.248"></a><span id="l76.248" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l76.249"></a><span id="l76.249" class="difflineplus">+    IMPORT_LOG0(&quot;*** Failed getting leaf name of file\n&quot;);</span>
<a href="#l76.250"></a><span id="l76.250" class="difflineplus">+    return rv;</span>
<a href="#l76.251"></a><span id="l76.251">   }</span>
<a href="#l76.252"></a><span id="l76.252"> </span>
<a href="#l76.253"></a><span id="l76.253" class="difflineminus">-  PRInt32 idx = name.RFindChar( '.');</span>
<a href="#l76.254"></a><span id="l76.254" class="difflineplus">+  PRInt32 idx = name.RFindChar('.');</span>
<a href="#l76.255"></a><span id="l76.255">   if ((idx != -1) &amp;&amp; (idx &gt; 0) &amp;&amp; ((name.Length() - idx - 1) &lt; 5)) {</span>
<a href="#l76.256"></a><span id="l76.256">     name.SetLength(idx);</span>
<a href="#l76.257"></a><span id="l76.257">   }</span>
<a href="#l76.258"></a><span id="l76.258"> </span>
<a href="#l76.259"></a><span id="l76.259">   nsCOMPtr&lt;nsIImportABDescriptor&gt;  desc;</span>
<a href="#l76.260"></a><span id="l76.260">   nsISupports * pInterface;</span>
<a href="#l76.261"></a><span id="l76.261"> </span>
<a href="#l76.262"></a><span id="l76.262">   nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l76.263"></a><span id="l76.263" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l76.264"></a><span id="l76.264" class="difflineminus">-    IMPORT_LOG0( &quot;*** Failed to obtain the import service\n&quot;);</span>
<a href="#l76.265"></a><span id="l76.265" class="difflineminus">-    return( rv);</span>
<a href="#l76.266"></a><span id="l76.266" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l76.267"></a><span id="l76.267" class="difflineplus">+    IMPORT_LOG0(&quot;*** Failed to obtain the import service\n&quot;);</span>
<a href="#l76.268"></a><span id="l76.268" class="difflineplus">+    return rv;</span>
<a href="#l76.269"></a><span id="l76.269">   }</span>
<a href="#l76.270"></a><span id="l76.270"> </span>
<a href="#l76.271"></a><span id="l76.271" class="difflineminus">-  rv = impSvc-&gt;CreateNewABDescriptor( getter_AddRefs( desc));</span>
<a href="#l76.272"></a><span id="l76.272" class="difflineminus">-  if (NS_SUCCEEDED( rv)) {</span>
<a href="#l76.273"></a><span id="l76.273" class="difflineplus">+  rv = impSvc-&gt;CreateNewABDescriptor(getter_AddRefs(desc));</span>
<a href="#l76.274"></a><span id="l76.274" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l76.275"></a><span id="l76.275">     PRInt64 sz = 0;</span>
<a href="#l76.276"></a><span id="l76.276">     pLoc-&gt;GetFileSize(&amp;sz);</span>
<a href="#l76.277"></a><span id="l76.277">     desc-&gt;SetPreferredName(name);</span>
<a href="#l76.278"></a><span id="l76.278">     desc-&gt;SetSize((PRUint32) sz);</span>
<a href="#l76.279"></a><span id="l76.279">     desc-&gt;SetAbFile(m_fileLoc);</span>
<a href="#l76.280"></a><span id="l76.280" class="difflineminus">-    rv = desc-&gt;QueryInterface( kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l76.281"></a><span id="l76.281" class="difflineminus">-    array-&gt;AppendElement( pInterface);</span>
<a href="#l76.282"></a><span id="l76.282" class="difflineplus">+    rv = desc-&gt;QueryInterface(kISupportsIID, (void **) &amp;pInterface);</span>
<a href="#l76.283"></a><span id="l76.283" class="difflineplus">+    array-&gt;AppendElement(pInterface);</span>
<a href="#l76.284"></a><span id="l76.284">     pInterface-&gt;Release();</span>
<a href="#l76.285"></a><span id="l76.285">   }</span>
<a href="#l76.286"></a><span id="l76.286" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l76.287"></a><span id="l76.287" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error creating address book descriptor for text import\n&quot;);</span>
<a href="#l76.288"></a><span id="l76.288" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l76.289"></a><span id="l76.289" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error creating address book descriptor for text import\n&quot;);</span>
<a href="#l76.290"></a><span id="l76.290">   }</span>
<a href="#l76.291"></a><span id="l76.291">   else {</span>
<a href="#l76.292"></a><span id="l76.292" class="difflineminus">-    rv = array-&gt;QueryInterface( NS_GET_IID(nsISupportsArray), (void **) ppArray);</span>
<a href="#l76.293"></a><span id="l76.293" class="difflineplus">+    rv = array-&gt;QueryInterface(NS_GET_IID(nsISupportsArray), (void **) ppArray);</span>
<a href="#l76.294"></a><span id="l76.294">   }</span>
<a href="#l76.295"></a><span id="l76.295"> </span>
<a href="#l76.296"></a><span id="l76.296" class="difflineminus">-  return( rv);</span>
<a href="#l76.297"></a><span id="l76.297" class="difflineplus">+  return rv;</span>
<a href="#l76.298"></a><span id="l76.298"> }</span>
<a href="#l76.299"></a><span id="l76.299"> </span>
<a href="#l76.300"></a><span id="l76.300"> void ImportAddressImpl::ReportSuccess(nsString&amp; name, nsString *pStream,</span>
<a href="#l76.301"></a><span id="l76.301">                                       nsIStringBundle* pBundle)</span>
<a href="#l76.302"></a><span id="l76.302"> {</span>
<a href="#l76.303"></a><span id="l76.303">   if (!pStream)</span>
<a href="#l76.304"></a><span id="l76.304">     return;</span>
<a href="#l76.305"></a><span id="l76.305"> </span>
<a href="#l76.306"></a><span id="l76.306" class="difflineat">@@ -398,17 +398,17 @@ void ImportAddressImpl::ReportError(PRIn</span>
<a href="#l76.307"></a><span id="l76.307">   PRUnichar *pFmt = nsImportStringBundle::GetStringByID(errorNum, pBundle);</span>
<a href="#l76.308"></a><span id="l76.308">   PRUnichar *pText = nsTextFormatter::smprintf(pFmt, name.get());</span>
<a href="#l76.309"></a><span id="l76.309">   pStream-&gt;Append(pText);</span>
<a href="#l76.310"></a><span id="l76.310">   nsTextFormatter::smprintf_free(pText);</span>
<a href="#l76.311"></a><span id="l76.311">   NS_Free(pFmt);</span>
<a href="#l76.312"></a><span id="l76.312">   pStream-&gt;Append(PRUnichar('\n'));</span>
<a href="#l76.313"></a><span id="l76.313"> }</span>
<a href="#l76.314"></a><span id="l76.314"> </span>
<a href="#l76.315"></a><span id="l76.315" class="difflineminus">-void ImportAddressImpl::SetLogs( nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess)</span>
<a href="#l76.316"></a><span id="l76.316" class="difflineplus">+void ImportAddressImpl::SetLogs(nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess)</span>
<a href="#l76.317"></a><span id="l76.317"> {</span>
<a href="#l76.318"></a><span id="l76.318">   if (pError)</span>
<a href="#l76.319"></a><span id="l76.319">     *pError = ToNewUnicode(error);</span>
<a href="#l76.320"></a><span id="l76.320">   if (pSuccess)</span>
<a href="#l76.321"></a><span id="l76.321">     *pSuccess = ToNewUnicode(success);</span>
<a href="#l76.322"></a><span id="l76.322"> }</span>
<a href="#l76.323"></a><span id="l76.323"> </span>
<a href="#l76.324"></a><span id="l76.324"> </span>
<a href="#l76.325"></a><span id="l76.325" class="difflineat">@@ -424,17 +424,17 @@ ImportAddressImpl::ImportAddressBook(nsI</span>
<a href="#l76.326"></a><span id="l76.326">   NS_PRECONDITION(pSource != nsnull, &quot;null ptr&quot;);</span>
<a href="#l76.327"></a><span id="l76.327">   NS_PRECONDITION(pDestination != nsnull, &quot;null ptr&quot;);</span>
<a href="#l76.328"></a><span id="l76.328">   NS_PRECONDITION(fatalError != nsnull, &quot;null ptr&quot;);</span>
<a href="#l76.329"></a><span id="l76.329"> </span>
<a href="#l76.330"></a><span id="l76.330">   m_bytesImported = 0;</span>
<a href="#l76.331"></a><span id="l76.331"> </span>
<a href="#l76.332"></a><span id="l76.332">   nsString success, error;</span>
<a href="#l76.333"></a><span id="l76.333">   if (!pSource || !pDestination || !fatalError) {</span>
<a href="#l76.334"></a><span id="l76.334" class="difflineminus">-    IMPORT_LOG0( &quot;*** Bad param passed to text address import\n&quot;);</span>
<a href="#l76.335"></a><span id="l76.335" class="difflineplus">+    IMPORT_LOG0(&quot;*** Bad param passed to text address import\n&quot;);</span>
<a href="#l76.336"></a><span id="l76.336">     nsImportStringBundle::GetStringByID(TEXTIMPORT_ADDRESS_BADPARAM,</span>
<a href="#l76.337"></a><span id="l76.337">                                         m_notProxyBundle,</span>
<a href="#l76.338"></a><span id="l76.338">                                         error);</span>
<a href="#l76.339"></a><span id="l76.339"> </span>
<a href="#l76.340"></a><span id="l76.340">     SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l76.341"></a><span id="l76.341"> </span>
<a href="#l76.342"></a><span id="l76.342">     if (fatalError)</span>
<a href="#l76.343"></a><span id="l76.343">       *fatalError = true;</span>
<a href="#l76.344"></a><span id="l76.344" class="difflineat">@@ -444,19 +444,19 @@ ImportAddressImpl::ImportAddressBook(nsI</span>
<a href="#l76.345"></a><span id="l76.345"> </span>
<a href="#l76.346"></a><span id="l76.346">   ClearSampleFile();</span>
<a href="#l76.347"></a><span id="l76.347"> </span>
<a href="#l76.348"></a><span id="l76.348">   bool addrAbort = false;</span>
<a href="#l76.349"></a><span id="l76.349">   nsString name;</span>
<a href="#l76.350"></a><span id="l76.350">   pSource-&gt;GetPreferredName(name);</span>
<a href="#l76.351"></a><span id="l76.351"> </span>
<a href="#l76.352"></a><span id="l76.352">   PRUint32 addressSize = 0;</span>
<a href="#l76.353"></a><span id="l76.353" class="difflineminus">-  pSource-&gt;GetSize( &amp;addressSize);</span>
<a href="#l76.354"></a><span id="l76.354" class="difflineplus">+  pSource-&gt;GetSize(&amp;addressSize);</span>
<a href="#l76.355"></a><span id="l76.355">   if (addressSize == 0) {</span>
<a href="#l76.356"></a><span id="l76.356" class="difflineminus">-    IMPORT_LOG0( &quot;Address book size is 0, skipping import.\n&quot;);</span>
<a href="#l76.357"></a><span id="l76.357" class="difflineplus">+    IMPORT_LOG0(&quot;Address book size is 0, skipping import.\n&quot;);</span>
<a href="#l76.358"></a><span id="l76.358">     ReportSuccess(name, &amp;success, m_notProxyBundle);</span>
<a href="#l76.359"></a><span id="l76.359">     SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l76.360"></a><span id="l76.360">     return NS_OK;</span>
<a href="#l76.361"></a><span id="l76.361">   }</span>
<a href="#l76.362"></a><span id="l76.362"> </span>
<a href="#l76.363"></a><span id="l76.363">   nsCOMPtr&lt;nsIFile&gt; inFile;</span>
<a href="#l76.364"></a><span id="l76.364">   if (NS_FAILED(pSource-&gt;GetAbFile(getter_AddRefs(inFile)))) {</span>
<a href="#l76.365"></a><span id="l76.365">     ReportError(TEXTIMPORT_ADDRESS_BADSOURCEFILE, name, &amp;error, m_notProxyBundle);</span>
<a href="#l76.366"></a><span id="l76.366" class="difflineat">@@ -471,47 +471,47 @@ ImportAddressImpl::ImportAddressBook(nsI</span>
<a href="#l76.367"></a><span id="l76.367"> </span>
<a href="#l76.368"></a><span id="l76.368">   bool isLDIF = false;</span>
<a href="#l76.369"></a><span id="l76.369">   nsresult rv;</span>
<a href="#l76.370"></a><span id="l76.370">   nsCOMPtr&lt;nsIAbLDIFService&gt; ldifService(do_QueryInterface(aSupportService, &amp;rv));</span>
<a href="#l76.371"></a><span id="l76.371"> </span>
<a href="#l76.372"></a><span id="l76.372">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l76.373"></a><span id="l76.373">       rv = ldifService-&gt;IsLDIFFile(inFile, &amp;isLDIF);</span>
<a href="#l76.374"></a><span id="l76.374">       if (NS_FAILED(rv)) {</span>
<a href="#l76.375"></a><span id="l76.375" class="difflineminus">-        IMPORT_LOG0( &quot;*** Error reading address file\n&quot;);</span>
<a href="#l76.376"></a><span id="l76.376" class="difflineplus">+        IMPORT_LOG0(&quot;*** Error reading address file\n&quot;);</span>
<a href="#l76.377"></a><span id="l76.377">       }</span>
<a href="#l76.378"></a><span id="l76.378">     }</span>
<a href="#l76.379"></a><span id="l76.379"> </span>
<a href="#l76.380"></a><span id="l76.380" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l76.381"></a><span id="l76.381" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l76.382"></a><span id="l76.382">     ReportError(TEXTIMPORT_ADDRESS_CONVERTERROR, name, &amp;error, m_notProxyBundle);</span>
<a href="#l76.383"></a><span id="l76.383">     SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l76.384"></a><span id="l76.384" class="difflineminus">-    return( rv);</span>
<a href="#l76.385"></a><span id="l76.385" class="difflineplus">+    return rv;</span>
<a href="#l76.386"></a><span id="l76.386">   }</span>
<a href="#l76.387"></a><span id="l76.387"> </span>
<a href="#l76.388"></a><span id="l76.388">   if (isLDIF) {</span>
<a href="#l76.389"></a><span id="l76.389">     if (ldifService)</span>
<a href="#l76.390"></a><span id="l76.390">       rv = ldifService-&gt;ImportLDIFFile(pDestination, inFile, false, &amp;m_bytesImported);</span>
<a href="#l76.391"></a><span id="l76.391">     else</span>
<a href="#l76.392"></a><span id="l76.392">       return NS_ERROR_FAILURE;</span>
<a href="#l76.393"></a><span id="l76.393">   }</span>
<a href="#l76.394"></a><span id="l76.394">   else {</span>
<a href="#l76.395"></a><span id="l76.395" class="difflineminus">-    rv = m_text.ImportAddresses( &amp;addrAbort, name.get(), inFile, pDestination, fieldMap, error, &amp;m_bytesImported);</span>
<a href="#l76.396"></a><span id="l76.396" class="difflineminus">-    SaveFieldMap( fieldMap);</span>
<a href="#l76.397"></a><span id="l76.397" class="difflineplus">+    rv = m_text.ImportAddresses(&amp;addrAbort, name.get(), inFile, pDestination, fieldMap, error, &amp;m_bytesImported);</span>
<a href="#l76.398"></a><span id="l76.398" class="difflineplus">+    SaveFieldMap(fieldMap);</span>
<a href="#l76.399"></a><span id="l76.399">   }</span>
<a href="#l76.400"></a><span id="l76.400"> </span>
<a href="#l76.401"></a><span id="l76.401" class="difflineminus">-  if (NS_SUCCEEDED( rv) &amp;&amp; error.IsEmpty()) {</span>
<a href="#l76.402"></a><span id="l76.402" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; error.IsEmpty()) {</span>
<a href="#l76.403"></a><span id="l76.403">     ReportSuccess(name, &amp;success, m_notProxyBundle);</span>
<a href="#l76.404"></a><span id="l76.404">     SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l76.405"></a><span id="l76.405">   }</span>
<a href="#l76.406"></a><span id="l76.406">   else {</span>
<a href="#l76.407"></a><span id="l76.407">     ReportError(TEXTIMPORT_ADDRESS_CONVERTERROR, name, &amp;error, m_notProxyBundle);</span>
<a href="#l76.408"></a><span id="l76.408">     SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l76.409"></a><span id="l76.409">   }</span>
<a href="#l76.410"></a><span id="l76.410"> </span>
<a href="#l76.411"></a><span id="l76.411" class="difflineminus">-  IMPORT_LOG0( &quot;*** Text address import done\n&quot;);</span>
<a href="#l76.412"></a><span id="l76.412" class="difflineplus">+  IMPORT_LOG0(&quot;*** Text address import done\n&quot;);</span>
<a href="#l76.413"></a><span id="l76.413">   return rv;</span>
<a href="#l76.414"></a><span id="l76.414"> }</span>
<a href="#l76.415"></a><span id="l76.415"> </span>
<a href="#l76.416"></a><span id="l76.416"> </span>
<a href="#l76.417"></a><span id="l76.417"> NS_IMETHODIMP ImportAddressImpl::GetImportProgress(PRUint32 *_retval)</span>
<a href="#l76.418"></a><span id="l76.418"> {</span>
<a href="#l76.419"></a><span id="l76.419">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l76.420"></a><span id="l76.420">   *_retval = m_bytesImported;</span>
<a href="#l76.421"></a><span id="l76.421" class="difflineat">@@ -523,40 +523,40 @@ NS_IMETHODIMP ImportAddressImpl::GetNeed</span>
<a href="#l76.422"></a><span id="l76.422"> {</span>
<a href="#l76.423"></a><span id="l76.423">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l76.424"></a><span id="l76.424">   NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l76.425"></a><span id="l76.425"> </span>
<a href="#l76.426"></a><span id="l76.426">   *_retval = true;</span>
<a href="#l76.427"></a><span id="l76.427">   bool exists = false;</span>
<a href="#l76.428"></a><span id="l76.428">   bool isFile = false;</span>
<a href="#l76.429"></a><span id="l76.429"> </span>
<a href="#l76.430"></a><span id="l76.430" class="difflineminus">-  nsresult rv = aLocation-&gt;Exists( &amp;exists);</span>
<a href="#l76.431"></a><span id="l76.431" class="difflineminus">-  rv = aLocation-&gt;IsFile( &amp;isFile);</span>
<a href="#l76.432"></a><span id="l76.432" class="difflineplus">+  nsresult rv = aLocation-&gt;Exists(&amp;exists);</span>
<a href="#l76.433"></a><span id="l76.433" class="difflineplus">+  rv = aLocation-&gt;IsFile(&amp;isFile);</span>
<a href="#l76.434"></a><span id="l76.434"> </span>
<a href="#l76.435"></a><span id="l76.435">   if (!exists || !isFile)</span>
<a href="#l76.436"></a><span id="l76.436" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l76.437"></a><span id="l76.437" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l76.438"></a><span id="l76.438"> </span>
<a href="#l76.439"></a><span id="l76.439">   bool    isLDIF = false;</span>
<a href="#l76.440"></a><span id="l76.440">   nsCOMPtr&lt;nsIAbLDIFService&gt; ldifService = do_GetService(NS_ABLDIFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l76.441"></a><span id="l76.441"> </span>
<a href="#l76.442"></a><span id="l76.442">   if (NS_SUCCEEDED(rv))</span>
<a href="#l76.443"></a><span id="l76.443">     rv = ldifService-&gt;IsLDIFFile(aLocation, &amp;isLDIF);</span>
<a href="#l76.444"></a><span id="l76.444"> </span>
<a href="#l76.445"></a><span id="l76.445" class="difflineminus">-  if (NS_FAILED( rv)) {</span>
<a href="#l76.446"></a><span id="l76.446" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error determining if file is of type LDIF\n&quot;);</span>
<a href="#l76.447"></a><span id="l76.447" class="difflineminus">-    return( rv);</span>
<a href="#l76.448"></a><span id="l76.448" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l76.449"></a><span id="l76.449" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error determining if file is of type LDIF\n&quot;);</span>
<a href="#l76.450"></a><span id="l76.450" class="difflineplus">+    return rv;</span>
<a href="#l76.451"></a><span id="l76.451">   }</span>
<a href="#l76.452"></a><span id="l76.452"> </span>
<a href="#l76.453"></a><span id="l76.453">   if (isLDIF)</span>
<a href="#l76.454"></a><span id="l76.454">     *_retval = false;</span>
<a href="#l76.455"></a><span id="l76.455"> </span>
<a href="#l76.456"></a><span id="l76.456" class="difflineminus">-  return( NS_OK);</span>
<a href="#l76.457"></a><span id="l76.457" class="difflineplus">+  return NS_OK;</span>
<a href="#l76.458"></a><span id="l76.458"> }</span>
<a href="#l76.459"></a><span id="l76.459"> </span>
<a href="#l76.460"></a><span id="l76.460" class="difflineminus">-void ImportAddressImpl::SanitizeSampleData( nsCString&amp; val)</span>
<a href="#l76.461"></a><span id="l76.461" class="difflineplus">+void ImportAddressImpl::SanitizeSampleData(nsCString&amp; val)</span>
<a href="#l76.462"></a><span id="l76.462"> {</span>
<a href="#l76.463"></a><span id="l76.463">   // remove any line-feeds...</span>
<a href="#l76.464"></a><span id="l76.464">   PRInt32 offset = val.Find(NS_LITERAL_CSTRING(&quot;\x0D\x0A&quot;));</span>
<a href="#l76.465"></a><span id="l76.465">   while (offset != -1) {</span>
<a href="#l76.466"></a><span id="l76.466">     val.Replace(offset, 2, &quot;, &quot;);</span>
<a href="#l76.467"></a><span id="l76.467">     offset = val.Find(NS_LITERAL_CSTRING(&quot;\x0D\x0A&quot;), offset + 2);</span>
<a href="#l76.468"></a><span id="l76.468">   }</span>
<a href="#l76.469"></a><span id="l76.469">   offset = val.FindChar(13);</span>
<a href="#l76.470"></a><span id="l76.470" class="difflineat">@@ -566,26 +566,26 @@ void ImportAddressImpl::SanitizeSampleDa</span>
<a href="#l76.471"></a><span id="l76.471">   }</span>
<a href="#l76.472"></a><span id="l76.472">   offset = val.FindChar(10);</span>
<a href="#l76.473"></a><span id="l76.473">   while (offset != -1) {</span>
<a href="#l76.474"></a><span id="l76.474">     val.Replace(offset, 1, ',');</span>
<a href="#l76.475"></a><span id="l76.475">     offset = val.FindChar(10, offset + 2);</span>
<a href="#l76.476"></a><span id="l76.476">   }</span>
<a href="#l76.477"></a><span id="l76.477"> }</span>
<a href="#l76.478"></a><span id="l76.478"> </span>
<a href="#l76.479"></a><span id="l76.479" class="difflineminus">-NS_IMETHODIMP ImportAddressImpl::GetSampleData( PRInt32 index, bool *pFound, PRUnichar **pStr)</span>
<a href="#l76.480"></a><span id="l76.480" class="difflineplus">+NS_IMETHODIMP ImportAddressImpl::GetSampleData(PRInt32 index, bool *pFound, PRUnichar **pStr)</span>
<a href="#l76.481"></a><span id="l76.481"> {</span>
<a href="#l76.482"></a><span id="l76.482">   NS_PRECONDITION(pFound != nsnull, &quot;null ptr&quot;);</span>
<a href="#l76.483"></a><span id="l76.483">   NS_PRECONDITION(pStr != nsnull, &quot;null ptr&quot;);</span>
<a href="#l76.484"></a><span id="l76.484">   if (!pFound || !pStr)</span>
<a href="#l76.485"></a><span id="l76.485" class="difflineminus">-    return( NS_ERROR_NULL_POINTER);</span>
<a href="#l76.486"></a><span id="l76.486" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l76.487"></a><span id="l76.487"> </span>
<a href="#l76.488"></a><span id="l76.488">   if (!m_fileLoc) {</span>
<a href="#l76.489"></a><span id="l76.489" class="difflineminus">-    IMPORT_LOG0( &quot;*** Error, called GetSampleData before SetSampleLocation\n&quot;);</span>
<a href="#l76.490"></a><span id="l76.490" class="difflineminus">-    return( NS_ERROR_FAILURE);</span>
<a href="#l76.491"></a><span id="l76.491" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error, called GetSampleData before SetSampleLocation\n&quot;);</span>
<a href="#l76.492"></a><span id="l76.492" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l76.493"></a><span id="l76.493">   }</span>
<a href="#l76.494"></a><span id="l76.494"> </span>
<a href="#l76.495"></a><span id="l76.495">   nsresult rv;</span>
<a href="#l76.496"></a><span id="l76.496">   *pStr = nsnull;</span>
<a href="#l76.497"></a><span id="l76.497">   PRUnichar term = 0;</span>
<a href="#l76.498"></a><span id="l76.498"> </span>
<a href="#l76.499"></a><span id="l76.499">   if (!m_haveDelim) {</span>
<a href="#l76.500"></a><span id="l76.500">     rv = m_text.DetermineDelim(m_fileLoc);</span>
<a href="#l76.501"></a><span id="l76.501" class="difflineat">@@ -601,76 +601,76 @@ NS_IMETHODIMP ImportAddressImpl::GetSamp</span>
<a href="#l76.502"></a><span id="l76.502">   if (!fileExists) {</span>
<a href="#l76.503"></a><span id="l76.503">     *pFound = false;</span>
<a href="#l76.504"></a><span id="l76.504">     *pStr = NS_strdup(&amp;term);</span>
<a href="#l76.505"></a><span id="l76.505">     return NS_OK;</span>
<a href="#l76.506"></a><span id="l76.506">   }</span>
<a href="#l76.507"></a><span id="l76.507"> </span>
<a href="#l76.508"></a><span id="l76.508">   nsCString line;</span>
<a href="#l76.509"></a><span id="l76.509">   rv = nsTextAddress::ReadRecordNumber(m_fileLoc, line, index);</span>
<a href="#l76.510"></a><span id="l76.510" class="difflineminus">-  if (NS_SUCCEEDED( rv)) {</span>
<a href="#l76.511"></a><span id="l76.511" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l76.512"></a><span id="l76.512">     nsString str;</span>
<a href="#l76.513"></a><span id="l76.513">     nsCString field;</span>
<a href="#l76.514"></a><span id="l76.514">     nsString uField;</span>
<a href="#l76.515"></a><span id="l76.515">     PRInt32 fNum = 0;</span>
<a href="#l76.516"></a><span id="l76.516">     while (nsTextAddress::GetField(line.get(), line.Length(), fNum, field, m_delim)) {</span>
<a href="#l76.517"></a><span id="l76.517">       if (fNum)</span>
<a href="#l76.518"></a><span id="l76.518">         str.Append(PRUnichar('\n'));</span>
<a href="#l76.519"></a><span id="l76.519" class="difflineminus">-      SanitizeSampleData( field);</span>
<a href="#l76.520"></a><span id="l76.520" class="difflineplus">+      SanitizeSampleData(field);</span>
<a href="#l76.521"></a><span id="l76.521">       rv = nsMsgI18NConvertToUnicode(nsMsgI18NFileSystemCharset(),</span>
<a href="#l76.522"></a><span id="l76.522">                                      field, uField);</span>
<a href="#l76.523"></a><span id="l76.523"> </span>
<a href="#l76.524"></a><span id="l76.524" class="difflineminus">-      str.Append( uField);</span>
<a href="#l76.525"></a><span id="l76.525" class="difflineplus">+      str.Append(uField);</span>
<a href="#l76.526"></a><span id="l76.526">       fNum++;</span>
<a href="#l76.527"></a><span id="l76.527">       field.Truncate();</span>
<a href="#l76.528"></a><span id="l76.528">     }</span>
<a href="#l76.529"></a><span id="l76.529"> </span>
<a href="#l76.530"></a><span id="l76.530">     *pStr = ToNewUnicode(str);</span>
<a href="#l76.531"></a><span id="l76.531">     *pFound = true;</span>
<a href="#l76.532"></a><span id="l76.532"> </span>
<a href="#l76.533"></a><span id="l76.533" class="difflineminus">-    /* IMPORT_LOG1( &quot;Sample data: %S\n&quot;, str.get()); */</span>
<a href="#l76.534"></a><span id="l76.534" class="difflineplus">+    /* IMPORT_LOG1(&quot;Sample data: %S\n&quot;, str.get()); */</span>
<a href="#l76.535"></a><span id="l76.535">   }</span>
<a href="#l76.536"></a><span id="l76.536">   else {</span>
<a href="#l76.537"></a><span id="l76.537">     *pFound = false;</span>
<a href="#l76.538"></a><span id="l76.538" class="difflineminus">-    *pStr = NS_strdup( &amp;term);</span>
<a href="#l76.539"></a><span id="l76.539" class="difflineplus">+    *pStr = NS_strdup(&amp;term);</span>
<a href="#l76.540"></a><span id="l76.540">   }</span>
<a href="#l76.541"></a><span id="l76.541"> </span>
<a href="#l76.542"></a><span id="l76.542">   return NS_OK;</span>
<a href="#l76.543"></a><span id="l76.543"> }</span>
<a href="#l76.544"></a><span id="l76.544"> </span>
<a href="#l76.545"></a><span id="l76.545"> NS_IMETHODIMP ImportAddressImpl::SetSampleLocation(nsIFile *pLocation)</span>
<a href="#l76.546"></a><span id="l76.546"> {</span>
<a href="#l76.547"></a><span id="l76.547">   NS_ENSURE_ARG_POINTER(pLocation);</span>
<a href="#l76.548"></a><span id="l76.548"> </span>
<a href="#l76.549"></a><span id="l76.549">   m_fileLoc = do_QueryInterface(pLocation);</span>
<a href="#l76.550"></a><span id="l76.550">   m_haveDelim = false;</span>
<a href="#l76.551"></a><span id="l76.551">   return NS_OK;</span>
<a href="#l76.552"></a><span id="l76.552"> }</span>
<a href="#l76.553"></a><span id="l76.553"> </span>
<a href="#l76.554"></a><span id="l76.554" class="difflineminus">-void ImportAddressImpl::ClearSampleFile( void)</span>
<a href="#l76.555"></a><span id="l76.555" class="difflineplus">+void ImportAddressImpl::ClearSampleFile(void)</span>
<a href="#l76.556"></a><span id="l76.556"> {</span>
<a href="#l76.557"></a><span id="l76.557">   m_fileLoc = nsnull;</span>
<a href="#l76.558"></a><span id="l76.558">   m_haveDelim = false;</span>
<a href="#l76.559"></a><span id="l76.559"> }</span>
<a href="#l76.560"></a><span id="l76.560"> </span>
<a href="#l76.561"></a><span id="l76.561"> NS_IMETHODIMP ImportAddressImpl::InitFieldMap(nsIImportFieldMap *fieldMap)</span>
<a href="#l76.562"></a><span id="l76.562"> {</span>
<a href="#l76.563"></a><span id="l76.563">   // Let's remember the last one the user used!</span>
<a href="#l76.564"></a><span id="l76.564">   // This should be normal for someone importing multiple times, it's usually</span>
<a href="#l76.565"></a><span id="l76.565">   // from the same file format.</span>
<a href="#l76.566"></a><span id="l76.566"> </span>
<a href="#l76.567"></a><span id="l76.567">   nsresult rv;</span>
<a href="#l76.568"></a><span id="l76.568">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l76.569"></a><span id="l76.569" class="difflineminus">-  if (NS_SUCCEEDED( rv)) {</span>
<a href="#l76.570"></a><span id="l76.570" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l76.571"></a><span id="l76.571">     nsCString  prefStr;</span>
<a href="#l76.572"></a><span id="l76.572" class="difflineminus">-    rv = prefs-&gt;GetCharPref( &quot;mailnews.import.text.fieldmap&quot;, getter_Copies(prefStr));</span>
<a href="#l76.573"></a><span id="l76.573" class="difflineminus">-    if (NS_SUCCEEDED( rv)) {</span>
<a href="#l76.574"></a><span id="l76.574" class="difflineplus">+    rv = prefs-&gt;GetCharPref(&quot;mailnews.import.text.fieldmap&quot;, getter_Copies(prefStr));</span>
<a href="#l76.575"></a><span id="l76.575" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l76.576"></a><span id="l76.576">       const char *pStr = prefStr.get();</span>
<a href="#l76.577"></a><span id="l76.577">       if (pStr) {</span>
<a href="#l76.578"></a><span id="l76.578" class="difflineminus">-        fieldMap-&gt;SetFieldMapSize( 0);</span>
<a href="#l76.579"></a><span id="l76.579" class="difflineplus">+        fieldMap-&gt;SetFieldMapSize(0);</span>
<a href="#l76.580"></a><span id="l76.580">         long fNum;</span>
<a href="#l76.581"></a><span id="l76.581">         bool active;</span>
<a href="#l76.582"></a><span id="l76.582">         long fIndex = 0;</span>
<a href="#l76.583"></a><span id="l76.583">         while (*pStr) {</span>
<a href="#l76.584"></a><span id="l76.584">           while (*pStr &amp;&amp; (*pStr != '+') &amp;&amp; (*pStr != '-'))</span>
<a href="#l76.585"></a><span id="l76.585">             pStr++;</span>
<a href="#l76.586"></a><span id="l76.586">           if (*pStr == '+')</span>
<a href="#l76.587"></a><span id="l76.587">             active = true;</span>
<a href="#l76.588"></a><span id="l76.588" class="difflineat">@@ -687,81 +687,72 @@ NS_IMETHODIMP ImportAddressImpl::InitFie</span>
<a href="#l76.589"></a><span id="l76.589">             fNum *= 10;</span>
<a href="#l76.590"></a><span id="l76.590">             fNum += (*pStr - '0');</span>
<a href="#l76.591"></a><span id="l76.591">             pStr++;</span>
<a href="#l76.592"></a><span id="l76.592">           }</span>
<a href="#l76.593"></a><span id="l76.593">           while (*pStr &amp;&amp; (*pStr != ','))</span>
<a href="#l76.594"></a><span id="l76.594">             pStr++;</span>
<a href="#l76.595"></a><span id="l76.595">           if (*pStr == ',')</span>
<a href="#l76.596"></a><span id="l76.596">             pStr++;</span>
<a href="#l76.597"></a><span id="l76.597" class="difflineminus">-          fieldMap-&gt;SetFieldMap( -1, fNum);</span>
<a href="#l76.598"></a><span id="l76.598" class="difflineminus">-          fieldMap-&gt;SetFieldActive( fIndex, active);</span>
<a href="#l76.599"></a><span id="l76.599" class="difflineplus">+          fieldMap-&gt;SetFieldMap(-1, fNum);</span>
<a href="#l76.600"></a><span id="l76.600" class="difflineplus">+          fieldMap-&gt;SetFieldActive(fIndex, active);</span>
<a href="#l76.601"></a><span id="l76.601">           fIndex++;</span>
<a href="#l76.602"></a><span id="l76.602">         }</span>
<a href="#l76.603"></a><span id="l76.603">         if (!fIndex) {</span>
<a href="#l76.604"></a><span id="l76.604">           int num;</span>
<a href="#l76.605"></a><span id="l76.605" class="difflineminus">-          fieldMap-&gt;GetNumMozFields( &amp;num);</span>
<a href="#l76.606"></a><span id="l76.606" class="difflineminus">-          fieldMap-&gt;DefaultFieldMap( num);</span>
<a href="#l76.607"></a><span id="l76.607" class="difflineplus">+          fieldMap-&gt;GetNumMozFields(&amp;num);</span>
<a href="#l76.608"></a><span id="l76.608" class="difflineplus">+          fieldMap-&gt;DefaultFieldMap(num);</span>
<a href="#l76.609"></a><span id="l76.609">         }</span>
<a href="#l76.610"></a><span id="l76.610">       }</span>
<a href="#l76.611"></a><span id="l76.611">     }</span>
<a href="#l76.612"></a><span id="l76.612"> </span>
<a href="#l76.613"></a><span id="l76.613">     // Now also get the last used skip first record value.</span>
<a href="#l76.614"></a><span id="l76.614">     bool skipFirstRecord = false;</span>
<a href="#l76.615"></a><span id="l76.615">     rv = prefs-&gt;GetBoolPref(&quot;mailnews.import.text.skipfirstrecord&quot;, &amp;skipFirstRecord);</span>
<a href="#l76.616"></a><span id="l76.616">     if (NS_SUCCEEDED(rv))</span>
<a href="#l76.617"></a><span id="l76.617">       fieldMap-&gt;SetSkipFirstRecord(skipFirstRecord);</span>
<a href="#l76.618"></a><span id="l76.618">   }</span>
<a href="#l76.619"></a><span id="l76.619"> </span>
<a href="#l76.620"></a><span id="l76.620" class="difflineminus">-  return( NS_OK);</span>
<a href="#l76.621"></a><span id="l76.621" class="difflineplus">+  return NS_OK;</span>
<a href="#l76.622"></a><span id="l76.622"> }</span>
<a href="#l76.623"></a><span id="l76.623"> </span>
<a href="#l76.624"></a><span id="l76.624"> </span>
<a href="#l76.625"></a><span id="l76.625" class="difflineminus">-void ImportAddressImpl::SaveFieldMap( nsIImportFieldMap *pMap)</span>
<a href="#l76.626"></a><span id="l76.626" class="difflineplus">+void ImportAddressImpl::SaveFieldMap(nsIImportFieldMap *pMap)</span>
<a href="#l76.627"></a><span id="l76.627"> {</span>
<a href="#l76.628"></a><span id="l76.628">   if (!pMap)</span>
<a href="#l76.629"></a><span id="l76.629">     return;</span>
<a href="#l76.630"></a><span id="l76.630"> </span>
<a href="#l76.631"></a><span id="l76.631">   int size;</span>
<a href="#l76.632"></a><span id="l76.632">   int index;</span>
<a href="#l76.633"></a><span id="l76.633">   bool active;</span>
<a href="#l76.634"></a><span id="l76.634">   nsCString str;</span>
<a href="#l76.635"></a><span id="l76.635"> </span>
<a href="#l76.636"></a><span id="l76.636" class="difflineminus">-  pMap-&gt;GetMapSize( &amp;size);</span>
<a href="#l76.637"></a><span id="l76.637" class="difflineplus">+  pMap-&gt;GetMapSize(&amp;size);</span>
<a href="#l76.638"></a><span id="l76.638">   for (long i = 0; i &lt; size; i++) {</span>
<a href="#l76.639"></a><span id="l76.639">     index = i;</span>
<a href="#l76.640"></a><span id="l76.640">     active = false;</span>
<a href="#l76.641"></a><span id="l76.641" class="difflineminus">-    pMap-&gt;GetFieldMap( i, &amp;index);</span>
<a href="#l76.642"></a><span id="l76.642" class="difflineminus">-    pMap-&gt;GetFieldActive( i, &amp;active);</span>
<a href="#l76.643"></a><span id="l76.643" class="difflineplus">+    pMap-&gt;GetFieldMap(i, &amp;index);</span>
<a href="#l76.644"></a><span id="l76.644" class="difflineplus">+    pMap-&gt;GetFieldActive(i, &amp;active);</span>
<a href="#l76.645"></a><span id="l76.645">     if (active)</span>
<a href="#l76.646"></a><span id="l76.646" class="difflineminus">-      str.Append( '+');</span>
<a href="#l76.647"></a><span id="l76.647" class="difflineplus">+      str.Append('+');</span>
<a href="#l76.648"></a><span id="l76.648">     else</span>
<a href="#l76.649"></a><span id="l76.649" class="difflineminus">-      str.Append( '-');</span>
<a href="#l76.650"></a><span id="l76.650" class="difflineplus">+      str.Append('-');</span>
<a href="#l76.651"></a><span id="l76.651"> </span>
<a href="#l76.652"></a><span id="l76.652" class="difflineminus">-    str.AppendInt( index);</span>
<a href="#l76.653"></a><span id="l76.653" class="difflineminus">-    str.Append( ',');</span>
<a href="#l76.654"></a><span id="l76.654" class="difflineplus">+    str.AppendInt(index);</span>
<a href="#l76.655"></a><span id="l76.655" class="difflineplus">+    str.Append(',');</span>
<a href="#l76.656"></a><span id="l76.656">   }</span>
<a href="#l76.657"></a><span id="l76.657"> </span>
<a href="#l76.658"></a><span id="l76.658" class="difflineminus">-  bool done = false;</span>
<a href="#l76.659"></a><span id="l76.659">   nsresult rv;</span>
<a href="#l76.660"></a><span id="l76.660" class="difflineminus">-</span>
<a href="#l76.661"></a><span id="l76.661">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l76.662"></a><span id="l76.662"> </span>
<a href="#l76.663"></a><span id="l76.663" class="difflineminus">-  if (NS_SUCCEEDED( rv)) {</span>
<a href="#l76.664"></a><span id="l76.664" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l76.665"></a><span id="l76.665">     nsCString prefStr;</span>
<a href="#l76.666"></a><span id="l76.666" class="difflineminus">-    rv = prefs-&gt;GetCharPref( &quot;mailnews.import.text.fieldmap&quot;, getter_Copies(prefStr));</span>
<a href="#l76.667"></a><span id="l76.667" class="difflineminus">-    if (NS_SUCCEEDED( rv)) {</span>
<a href="#l76.668"></a><span id="l76.668" class="difflineminus">-      if (str.Equals(prefStr))</span>
<a href="#l76.669"></a><span id="l76.669" class="difflineminus">-        done = true;</span>
<a href="#l76.670"></a><span id="l76.670" class="difflineminus">-    }</span>
<a href="#l76.671"></a><span id="l76.671" class="difflineminus">-    if (!done) {</span>
<a href="#l76.672"></a><span id="l76.672" class="difflineminus">-      rv = prefs-&gt;SetCharPref( &quot;mailnews.import.text.fieldmap&quot;, str.get());</span>
<a href="#l76.673"></a><span id="l76.673" class="difflineminus">-    }</span>
<a href="#l76.674"></a><span id="l76.674" class="difflineplus">+    rv = prefs-&gt;GetCharPref(&quot;mailnews.import.text.fieldmap&quot;, getter_Copies(prefStr));</span>
<a href="#l76.675"></a><span id="l76.675" class="difflineplus">+    if (NS_FAILED(rv) || !str.Equals(prefStr))</span>
<a href="#l76.676"></a><span id="l76.676" class="difflineplus">+      rv = prefs-&gt;SetCharPref(&quot;mailnews.import.text.fieldmap&quot;, str.get());</span>
<a href="#l76.677"></a><span id="l76.677">   }</span>
<a href="#l76.678"></a><span id="l76.678"> </span>
<a href="#l76.679"></a><span id="l76.679" class="difflineminus">-    // Now also save last used skip first record value.</span>
<a href="#l76.680"></a><span id="l76.680" class="difflineminus">-    bool skipFirstRecord = false;</span>
<a href="#l76.681"></a><span id="l76.681" class="difflineminus">-    rv = pMap-&gt;GetSkipFirstRecord(&amp;skipFirstRecord);</span>
<a href="#l76.682"></a><span id="l76.682" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l76.683"></a><span id="l76.683" class="difflineminus">-    {</span>
<a href="#l76.684"></a><span id="l76.684" class="difflineminus">-      prefs-&gt;SetBoolPref(&quot;mailnews.import.text.skipfirstrecord&quot;, skipFirstRecord);</span>
<a href="#l76.685"></a><span id="l76.685" class="difflineminus">-    }</span>
<a href="#l76.686"></a><span id="l76.686" class="difflineplus">+  // Now also save last used skip first record value.</span>
<a href="#l76.687"></a><span id="l76.687" class="difflineplus">+  bool skipFirstRecord = false;</span>
<a href="#l76.688"></a><span id="l76.688" class="difflineplus">+  rv = pMap-&gt;GetSkipFirstRecord(&amp;skipFirstRecord);</span>
<a href="#l76.689"></a><span id="l76.689" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l76.690"></a><span id="l76.690" class="difflineplus">+    prefs-&gt;SetBoolPref(&quot;mailnews.import.text.skipfirstrecord&quot;, skipFirstRecord);</span>
<a href="#l76.691"></a><span id="l76.691"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/mailnews/import/vcard/src/nsVCardImport.cpp</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/mailnews/import/vcard/src/nsVCardImport.cpp</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -190,17 +190,17 @@ NS_IMETHODIMP nsVCardImport::GetImportIn</span>
<a href="#l77.4"></a><span id="l77.4">     rv = ImportVCardAddressImpl::Create(&amp;pAddress, m_stringBundle);</span>
<a href="#l77.5"></a><span id="l77.5">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l77.6"></a><span id="l77.6">       nsCOMPtr&lt;nsIImportService&gt; impSvc(</span>
<a href="#l77.7"></a><span id="l77.7">           do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l77.8"></a><span id="l77.8">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l77.9"></a><span id="l77.9">         rv = impSvc-&gt;CreateNewGenericAddressBooks(&amp;pGeneric);</span>
<a href="#l77.10"></a><span id="l77.10">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l77.11"></a><span id="l77.11">           pGeneric-&gt;SetData(&quot;addressInterface&quot;, pAddress);</span>
<a href="#l77.12"></a><span id="l77.12" class="difflineminus">-          rv = pGeneric-&gt;QueryInterface( kISupportsIID, (void **)ppInterface);</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineplus">+          rv = pGeneric-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l77.14"></a><span id="l77.14">         }</span>
<a href="#l77.15"></a><span id="l77.15">       }</span>
<a href="#l77.16"></a><span id="l77.16">     }</span>
<a href="#l77.17"></a><span id="l77.17">     NS_IF_RELEASE(pAddress);</span>
<a href="#l77.18"></a><span id="l77.18">     NS_IF_RELEASE(pGeneric);</span>
<a href="#l77.19"></a><span id="l77.19">     return rv;</span>
<a href="#l77.20"></a><span id="l77.20">   }</span>
<a href="#l77.21"></a><span id="l77.21">   return NS_ERROR_NOT_AVAILABLE;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/mailnews/import/winlivemail/nsWMImport.cpp</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/mailnews/import/winlivemail/nsWMImport.cpp</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -100,101 +100,101 @@ public:</span>
<a href="#l78.4"></a><span id="l78.4">                 PRUnichar **pErrorLog, PRUnichar **pSuccessLog, bool *fatalError);</span>
<a href="#l78.5"></a><span id="l78.5"> </span>
<a href="#l78.6"></a><span id="l78.6">   /* unsigned long GetImportProgress (); */</span>
<a href="#l78.7"></a><span id="l78.7">   NS_IMETHOD GetImportProgress(PRUint32 *_retval);</span>
<a href="#l78.8"></a><span id="l78.8"> </span>
<a href="#l78.9"></a><span id="l78.9">     NS_IMETHOD TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval);</span>
<a href="#l78.10"></a><span id="l78.10"> </span>
<a href="#l78.11"></a><span id="l78.11"> public:</span>
<a href="#l78.12"></a><span id="l78.12" class="difflineminus">-  static void ReportSuccess( nsString&amp; name, PRInt32 count, nsString *pStream);</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineminus">-  static void ReportError( PRInt32 errorNum, nsString&amp; name, nsString *pStream);</span>
<a href="#l78.14"></a><span id="l78.14" class="difflineminus">-  static void AddLinebreak( nsString *pStream);</span>
<a href="#l78.15"></a><span id="l78.15" class="difflineminus">-  static void SetLogs( nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess);</span>
<a href="#l78.16"></a><span id="l78.16" class="difflineplus">+  static void ReportSuccess(nsString&amp; name, PRInt32 count, nsString *pStream);</span>
<a href="#l78.17"></a><span id="l78.17" class="difflineplus">+  static void ReportError(PRInt32 errorNum, nsString&amp; name, nsString *pStream);</span>
<a href="#l78.18"></a><span id="l78.18" class="difflineplus">+  static void AddLinebreak(nsString *pStream);</span>
<a href="#l78.19"></a><span id="l78.19" class="difflineplus">+  static void SetLogs(nsString&amp; success, nsString&amp; error, PRUnichar **pError, PRUnichar **pSuccess);</span>
<a href="#l78.20"></a><span id="l78.20"> </span>
<a href="#l78.21"></a><span id="l78.21"> private:</span>
<a href="#l78.22"></a><span id="l78.22">   PRUint32 m_bytesDone;</span>
<a href="#l78.23"></a><span id="l78.23"> };</span>
<a href="#l78.24"></a><span id="l78.24"> </span>
<a href="#l78.25"></a><span id="l78.25"> nsWMImport::nsWMImport()</span>
<a href="#l78.26"></a><span id="l78.26"> {</span>
<a href="#l78.27"></a><span id="l78.27">   // Init logging module.</span>
<a href="#l78.28"></a><span id="l78.28">   if (!WMLOGMODULE)</span>
<a href="#l78.29"></a><span id="l78.29">     WMLOGMODULE = PR_NewLogModule(&quot;IMPORT&quot;);</span>
<a href="#l78.30"></a><span id="l78.30" class="difflineminus">-  IMPORT_LOG0( &quot;nsWMImport Module Created\n&quot;);</span>
<a href="#l78.31"></a><span id="l78.31" class="difflineplus">+  IMPORT_LOG0(&quot;nsWMImport Module Created\n&quot;);</span>
<a href="#l78.32"></a><span id="l78.32">   nsWMStringBundle::GetStringBundle();</span>
<a href="#l78.33"></a><span id="l78.33"> }</span>
<a href="#l78.34"></a><span id="l78.34"> </span>
<a href="#l78.35"></a><span id="l78.35"> nsWMImport::~nsWMImport()</span>
<a href="#l78.36"></a><span id="l78.36"> {</span>
<a href="#l78.37"></a><span id="l78.37" class="difflineminus">-  IMPORT_LOG0( &quot;nsWMImport Module Deleted\n&quot;);</span>
<a href="#l78.38"></a><span id="l78.38" class="difflineplus">+  IMPORT_LOG0(&quot;nsWMImport Module Deleted\n&quot;);</span>
<a href="#l78.39"></a><span id="l78.39"> }</span>
<a href="#l78.40"></a><span id="l78.40"> </span>
<a href="#l78.41"></a><span id="l78.41"> NS_IMPL_ISUPPORTS1(nsWMImport, nsIImportModule)</span>
<a href="#l78.42"></a><span id="l78.42"> </span>
<a href="#l78.43"></a><span id="l78.43" class="difflineminus">-NS_IMETHODIMP nsWMImport::GetName( PRUnichar **name)</span>
<a href="#l78.44"></a><span id="l78.44" class="difflineplus">+NS_IMETHODIMP nsWMImport::GetName(PRUnichar **name)</span>
<a href="#l78.45"></a><span id="l78.45"> {</span>
<a href="#l78.46"></a><span id="l78.46">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l78.47"></a><span id="l78.47">   // nsString  title = &quot;Windows Live Mail&quot;;</span>
<a href="#l78.48"></a><span id="l78.48">   // *name = ToNewUnicode(title);</span>
<a href="#l78.49"></a><span id="l78.49" class="difflineminus">-  *name = nsWMStringBundle::GetStringByID( WMIMPORT_NAME);</span>
<a href="#l78.50"></a><span id="l78.50" class="difflineplus">+  *name = nsWMStringBundle::GetStringByID(WMIMPORT_NAME);</span>
<a href="#l78.51"></a><span id="l78.51"> </span>
<a href="#l78.52"></a><span id="l78.52">     return NS_OK;</span>
<a href="#l78.53"></a><span id="l78.53"> }</span>
<a href="#l78.54"></a><span id="l78.54"> </span>
<a href="#l78.55"></a><span id="l78.55" class="difflineminus">-NS_IMETHODIMP nsWMImport::GetDescription( PRUnichar **name)</span>
<a href="#l78.56"></a><span id="l78.56" class="difflineplus">+NS_IMETHODIMP nsWMImport::GetDescription(PRUnichar **name)</span>
<a href="#l78.57"></a><span id="l78.57"> {</span>
<a href="#l78.58"></a><span id="l78.58">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l78.59"></a><span id="l78.59"> </span>
<a href="#l78.60"></a><span id="l78.60">   // nsString  desc = &quot;Windows Live Mail mail and address books&quot;;</span>
<a href="#l78.61"></a><span id="l78.61">   // *name = ToNewUnicode(desc);</span>
<a href="#l78.62"></a><span id="l78.62" class="difflineminus">-  *name = nsWMStringBundle::GetStringByID( WMIMPORT_DESCRIPTION);</span>
<a href="#l78.63"></a><span id="l78.63" class="difflineplus">+  *name = nsWMStringBundle::GetStringByID(WMIMPORT_DESCRIPTION);</span>
<a href="#l78.64"></a><span id="l78.64">   return NS_OK;</span>
<a href="#l78.65"></a><span id="l78.65"> }</span>
<a href="#l78.66"></a><span id="l78.66"> </span>
<a href="#l78.67"></a><span id="l78.67" class="difflineminus">-NS_IMETHODIMP nsWMImport::GetSupports( char **supports)</span>
<a href="#l78.68"></a><span id="l78.68" class="difflineplus">+NS_IMETHODIMP nsWMImport::GetSupports(char **supports)</span>
<a href="#l78.69"></a><span id="l78.69"> {</span>
<a href="#l78.70"></a><span id="l78.70">   NS_PRECONDITION(supports != nsnull, &quot;null ptr&quot;);</span>
<a href="#l78.71"></a><span id="l78.71">   if (! supports)</span>
<a href="#l78.72"></a><span id="l78.72">       return NS_ERROR_NULL_POINTER;</span>
<a href="#l78.73"></a><span id="l78.73"> </span>
<a href="#l78.74"></a><span id="l78.74" class="difflineminus">-  *supports = strdup( kWMSupportsString);</span>
<a href="#l78.75"></a><span id="l78.75" class="difflineminus">-  return( NS_OK);</span>
<a href="#l78.76"></a><span id="l78.76" class="difflineplus">+  *supports = strdup(kWMSupportsString);</span>
<a href="#l78.77"></a><span id="l78.77" class="difflineplus">+  return NS_OK;</span>
<a href="#l78.78"></a><span id="l78.78"> }</span>
<a href="#l78.79"></a><span id="l78.79"> </span>
<a href="#l78.80"></a><span id="l78.80" class="difflineminus">-NS_IMETHODIMP nsWMImport::GetSupportsUpgrade( bool *pUpgrade)</span>
<a href="#l78.81"></a><span id="l78.81" class="difflineplus">+NS_IMETHODIMP nsWMImport::GetSupportsUpgrade(bool *pUpgrade)</span>
<a href="#l78.82"></a><span id="l78.82"> {</span>
<a href="#l78.83"></a><span id="l78.83">   NS_PRECONDITION(pUpgrade != nsnull, &quot;null ptr&quot;);</span>
<a href="#l78.84"></a><span id="l78.84">   if (! pUpgrade)</span>
<a href="#l78.85"></a><span id="l78.85">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l78.86"></a><span id="l78.86"> </span>
<a href="#l78.87"></a><span id="l78.87">   *pUpgrade = true;</span>
<a href="#l78.88"></a><span id="l78.88" class="difflineminus">-  return( NS_OK);</span>
<a href="#l78.89"></a><span id="l78.89" class="difflineplus">+  return NS_OK;</span>
<a href="#l78.90"></a><span id="l78.90"> }</span>
<a href="#l78.91"></a><span id="l78.91"> </span>
<a href="#l78.92"></a><span id="l78.92"> NS_IMETHODIMP nsWMImport::GetImportInterface(const char *pImportType,</span>
<a href="#l78.93"></a><span id="l78.93">                                              nsISupports **ppInterface)</span>
<a href="#l78.94"></a><span id="l78.94"> {</span>
<a href="#l78.95"></a><span id="l78.95">   NS_ENSURE_ARG_POINTER(pImportType);</span>
<a href="#l78.96"></a><span id="l78.96">   NS_ENSURE_ARG_POINTER(ppInterface);</span>
<a href="#l78.97"></a><span id="l78.97"> </span>
<a href="#l78.98"></a><span id="l78.98">   *ppInterface = nsnull;</span>
<a href="#l78.99"></a><span id="l78.99">   nsresult rv;</span>
<a href="#l78.100"></a><span id="l78.100"> </span>
<a href="#l78.101"></a><span id="l78.101" class="difflineminus">-  if (!strcmp( pImportType, &quot;settings&quot;)) {</span>
<a href="#l78.102"></a><span id="l78.102" class="difflineplus">+  if (!strcmp(pImportType, &quot;settings&quot;)) {</span>
<a href="#l78.103"></a><span id="l78.103">     nsIImportSettings *pSettings = nsnull;</span>
<a href="#l78.104"></a><span id="l78.104" class="difflineminus">-    rv = nsWMSettings::Create( &amp;pSettings);</span>
<a href="#l78.105"></a><span id="l78.105" class="difflineminus">-    if (NS_SUCCEEDED( rv)) {</span>
<a href="#l78.106"></a><span id="l78.106" class="difflineminus">-      pSettings-&gt;QueryInterface( kISupportsIID, (void **)ppInterface);</span>
<a href="#l78.107"></a><span id="l78.107" class="difflineplus">+    rv = nsWMSettings::Create(&amp;pSettings);</span>
<a href="#l78.108"></a><span id="l78.108" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l78.109"></a><span id="l78.109" class="difflineplus">+      pSettings-&gt;QueryInterface(kISupportsIID, (void **)ppInterface);</span>
<a href="#l78.110"></a><span id="l78.110">     }</span>
<a href="#l78.111"></a><span id="l78.111" class="difflineminus">-    NS_IF_RELEASE( pSettings);</span>
<a href="#l78.112"></a><span id="l78.112" class="difflineminus">-    return( rv);</span>
<a href="#l78.113"></a><span id="l78.113" class="difflineplus">+    NS_IF_RELEASE(pSettings);</span>
<a href="#l78.114"></a><span id="l78.114" class="difflineplus">+    return rv;</span>
<a href="#l78.115"></a><span id="l78.115">   }</span>
<a href="#l78.116"></a><span id="l78.116"> </span>
<a href="#l78.117"></a><span id="l78.117" class="difflineminus">-  return( NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l78.118"></a><span id="l78.118" class="difflineplus">+  return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l78.119"></a><span id="l78.119"> }</span>
<a href="#l78.120"></a><span id="l78.120"> </span>
<a href="#l78.121"></a><span id="l78.121"> /////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l78.122"></a><span id="l78.122"> nsresult ImportWMMailImpl::Create(nsIImportMail** aImport)</span>
<a href="#l78.123"></a><span id="l78.123"> {</span>
<a href="#l78.124"></a><span id="l78.124">   NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l78.125"></a><span id="l78.125">   *aImport = new ImportWMMailImpl();</span>
<a href="#l78.126"></a><span id="l78.126">   NS_ENSURE_TRUE(*aImport, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l78.127"></a><span id="l78.127" class="difflineat">@@ -224,46 +224,46 @@ NS_IMETHODIMP ImportWMMailImpl::GetDefau</span>
<a href="#l78.128"></a><span id="l78.128"> }</span>
<a href="#l78.129"></a><span id="l78.129"> </span>
<a href="#l78.130"></a><span id="l78.130"> NS_IMETHODIMP ImportWMMailImpl::FindMailboxes(nsIFile *pLoc,</span>
<a href="#l78.131"></a><span id="l78.131">                                               nsISupportsArray **ppArray)</span>
<a href="#l78.132"></a><span id="l78.132"> {</span>
<a href="#l78.133"></a><span id="l78.133">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l78.134"></a><span id="l78.134"> }</span>
<a href="#l78.135"></a><span id="l78.135"> </span>
<a href="#l78.136"></a><span id="l78.136" class="difflineminus">-void ImportWMMailImpl::AddLinebreak( nsString *pStream)</span>
<a href="#l78.137"></a><span id="l78.137" class="difflineplus">+void ImportWMMailImpl::AddLinebreak(nsString *pStream)</span>
<a href="#l78.138"></a><span id="l78.138"> {</span>
<a href="#l78.139"></a><span id="l78.139">   if (pStream)</span>
<a href="#l78.140"></a><span id="l78.140" class="difflineminus">-    pStream-&gt;Append( PRUnichar('\n'));</span>
<a href="#l78.141"></a><span id="l78.141" class="difflineplus">+    pStream-&gt;Append(PRUnichar('\n'));</span>
<a href="#l78.142"></a><span id="l78.142"> }</span>
<a href="#l78.143"></a><span id="l78.143"> </span>
<a href="#l78.144"></a><span id="l78.144" class="difflineminus">-void ImportWMMailImpl::ReportSuccess( nsString&amp; name, PRInt32 count, nsString *pStream)</span>
<a href="#l78.145"></a><span id="l78.145" class="difflineplus">+void ImportWMMailImpl::ReportSuccess(nsString&amp; name, PRInt32 count, nsString *pStream)</span>
<a href="#l78.146"></a><span id="l78.146"> {</span>
<a href="#l78.147"></a><span id="l78.147">   if (!pStream)</span>
<a href="#l78.148"></a><span id="l78.148">     return;</span>
<a href="#l78.149"></a><span id="l78.149">   // load the success string</span>
<a href="#l78.150"></a><span id="l78.150" class="difflineminus">-  PRUnichar *pFmt = nsWMStringBundle::GetStringByID( WMIMPORT_MAILBOX_SUCCESS);</span>
<a href="#l78.151"></a><span id="l78.151" class="difflineminus">-  PRUnichar *pText = nsTextFormatter::smprintf( pFmt, name.get(), count);</span>
<a href="#l78.152"></a><span id="l78.152" class="difflineminus">-  pStream-&gt;Append( pText);</span>
<a href="#l78.153"></a><span id="l78.153" class="difflineminus">-  nsTextFormatter::smprintf_free( pText);</span>
<a href="#l78.154"></a><span id="l78.154" class="difflineminus">-  nsWMStringBundle::FreeString( pFmt);</span>
<a href="#l78.155"></a><span id="l78.155" class="difflineminus">-  AddLinebreak( pStream);</span>
<a href="#l78.156"></a><span id="l78.156" class="difflineplus">+  PRUnichar *pFmt = nsWMStringBundle::GetStringByID(WMIMPORT_MAILBOX_SUCCESS);</span>
<a href="#l78.157"></a><span id="l78.157" class="difflineplus">+  PRUnichar *pText = nsTextFormatter::smprintf(pFmt, name.get(), count);</span>
<a href="#l78.158"></a><span id="l78.158" class="difflineplus">+  pStream-&gt;Append(pText);</span>
<a href="#l78.159"></a><span id="l78.159" class="difflineplus">+  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l78.160"></a><span id="l78.160" class="difflineplus">+  nsWMStringBundle::FreeString(pFmt);</span>
<a href="#l78.161"></a><span id="l78.161" class="difflineplus">+  AddLinebreak(pStream);</span>
<a href="#l78.162"></a><span id="l78.162"> }</span>
<a href="#l78.163"></a><span id="l78.163"> </span>
<a href="#l78.164"></a><span id="l78.164" class="difflineminus">-void ImportWMMailImpl::ReportError( PRInt32 errorNum, nsString&amp; name, nsString *pStream)</span>
<a href="#l78.165"></a><span id="l78.165" class="difflineplus">+void ImportWMMailImpl::ReportError(PRInt32 errorNum, nsString&amp; name, nsString *pStream)</span>
<a href="#l78.166"></a><span id="l78.166"> {</span>
<a href="#l78.167"></a><span id="l78.167">   if (!pStream)</span>
<a href="#l78.168"></a><span id="l78.168">     return;</span>
<a href="#l78.169"></a><span id="l78.169">   // load the error string</span>
<a href="#l78.170"></a><span id="l78.170" class="difflineminus">-  PRUnichar *pFmt = nsWMStringBundle::GetStringByID( errorNum);</span>
<a href="#l78.171"></a><span id="l78.171" class="difflineminus">-  PRUnichar *pText = nsTextFormatter::smprintf( pFmt, name.get());</span>
<a href="#l78.172"></a><span id="l78.172" class="difflineminus">-  pStream-&gt;Append( pText);</span>
<a href="#l78.173"></a><span id="l78.173" class="difflineminus">-  nsTextFormatter::smprintf_free( pText);</span>
<a href="#l78.174"></a><span id="l78.174" class="difflineminus">-  nsWMStringBundle::FreeString( pFmt);</span>
<a href="#l78.175"></a><span id="l78.175" class="difflineminus">-  AddLinebreak( pStream);</span>
<a href="#l78.176"></a><span id="l78.176" class="difflineplus">+  PRUnichar *pFmt = nsWMStringBundle::GetStringByID(errorNum);</span>
<a href="#l78.177"></a><span id="l78.177" class="difflineplus">+  PRUnichar *pText = nsTextFormatter::smprintf(pFmt, name.get());</span>
<a href="#l78.178"></a><span id="l78.178" class="difflineplus">+  pStream-&gt;Append(pText);</span>
<a href="#l78.179"></a><span id="l78.179" class="difflineplus">+  nsTextFormatter::smprintf_free(pText);</span>
<a href="#l78.180"></a><span id="l78.180" class="difflineplus">+  nsWMStringBundle::FreeString(pFmt);</span>
<a href="#l78.181"></a><span id="l78.181" class="difflineplus">+  AddLinebreak(pStream);</span>
<a href="#l78.182"></a><span id="l78.182"> }</span>
<a href="#l78.183"></a><span id="l78.183"> </span>
<a href="#l78.184"></a><span id="l78.184"> void ImportWMMailImpl::SetLogs(nsString&amp; success, nsString&amp; error,</span>
<a href="#l78.185"></a><span id="l78.185">                                PRUnichar **pError, PRUnichar **pSuccess)</span>
<a href="#l78.186"></a><span id="l78.186"> {</span>
<a href="#l78.187"></a><span id="l78.187">   if (pError)</span>
<a href="#l78.188"></a><span id="l78.188">     *pError = ToNewUnicode(error);</span>
<a href="#l78.189"></a><span id="l78.189">   if (pSuccess)</span>
<a href="#l78.190"></a><span id="l78.190" class="difflineat">@@ -274,12 +274,12 @@ NS_IMETHODIMP ImportWMMailImpl::ImportMa</span>
<a href="#l78.191"></a><span id="l78.191">                                               nsIFile *pDestination,</span>
<a href="#l78.192"></a><span id="l78.192">                                               PRUnichar **pErrorLog,</span>
<a href="#l78.193"></a><span id="l78.193">                                               PRUnichar **pSuccessLog,</span>
<a href="#l78.194"></a><span id="l78.194">                                               bool *fatalError)</span>
<a href="#l78.195"></a><span id="l78.195"> {</span>
<a href="#l78.196"></a><span id="l78.196">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l78.197"></a><span id="l78.197"> }</span>
<a href="#l78.198"></a><span id="l78.198"> </span>
<a href="#l78.199"></a><span id="l78.199" class="difflineminus">-NS_IMETHODIMP ImportWMMailImpl::GetImportProgress( PRUint32 *pDoneSoFar)</span>
<a href="#l78.200"></a><span id="l78.200" class="difflineplus">+NS_IMETHODIMP ImportWMMailImpl::GetImportProgress(PRUint32 *pDoneSoFar)</span>
<a href="#l78.201"></a><span id="l78.201"> {</span>
<a href="#l78.202"></a><span id="l78.202">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l78.203"></a><span id="l78.203"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/mailnews/import/winlivemail/nsWMSettings.cpp</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/mailnews/import/winlivemail/nsWMSettings.cpp</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -97,17 +97,17 @@ public:</span>
<a href="#l79.4"></a><span id="l79.4">                              const nsString&amp; serverName,</span>
<a href="#l79.5"></a><span id="l79.5">                              nsIMsgAccount **ppAccount);</span>
<a href="#l79.6"></a><span id="l79.6">   static bool DoNNTPServer(nsIMsgAccountManager *pMgr,</span>
<a href="#l79.7"></a><span id="l79.7">                              nsIDOMDocument *xmlDoc,</span>
<a href="#l79.8"></a><span id="l79.8">                              const nsString&amp; serverName,</span>
<a href="#l79.9"></a><span id="l79.9">                              nsIMsgAccount **ppAccount);</span>
<a href="#l79.10"></a><span id="l79.10">   static void SetIdentities(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc,</span>
<a href="#l79.11"></a><span id="l79.11">                             nsIDOMDocument *xmlDoc, nsAutoString &amp;userName,</span>
<a href="#l79.12"></a><span id="l79.12" class="difflineminus">-                            PRInt32 authMethodIncoming, bool isNNTP );</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineplus">+                            PRInt32 authMethodIncoming, bool isNNTP);</span>
<a href="#l79.14"></a><span id="l79.14">   static void SetSmtpServer(nsIDOMDocument *xmlDoc, nsIMsgIdentity *id,</span>
<a href="#l79.15"></a><span id="l79.15">                             nsAutoString&amp; inUserName, PRInt32 authMethodIncoming);</span>
<a href="#l79.16"></a><span id="l79.16"> };</span>
<a href="#l79.17"></a><span id="l79.17"> </span>
<a href="#l79.18"></a><span id="l79.18"> static PRInt32 checkNewMailTime;// WM global setting, let's default to 30</span>
<a href="#l79.19"></a><span id="l79.19"> static bool    checkNewMail;    // WM global setting, let's default to false</span>
<a href="#l79.20"></a><span id="l79.20">                                 // This won't cause unwanted autodownloads-</span>
<a href="#l79.21"></a><span id="l79.21">                                 // user can set prefs after import</span>
<a href="#l79.22"></a><span id="l79.22" class="difflineat">@@ -367,17 +367,17 @@ bool WMSettings::DoImport(nsIMsgAccount </span>
<a href="#l79.23"></a><span id="l79.23">         accMgr-&gt;SetDefaultAccount(anAccount);</span>
<a href="#l79.24"></a><span id="l79.24">     }</span>
<a href="#l79.25"></a><span id="l79.25">   }</span>
<a href="#l79.26"></a><span id="l79.26"> </span>
<a href="#l79.27"></a><span id="l79.27">   // Now save the new acct info to pref file.</span>
<a href="#l79.28"></a><span id="l79.28">   rv = accMgr-&gt;SaveAccountInfo();</span>
<a href="#l79.29"></a><span id="l79.29">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Can't save account info to pref file&quot;);</span>
<a href="#l79.30"></a><span id="l79.30"> </span>
<a href="#l79.31"></a><span id="l79.31" class="difflineminus">-  return( accounts != 0);</span>
<a href="#l79.32"></a><span id="l79.32" class="difflineplus">+  return accounts != 0;</span>
<a href="#l79.33"></a><span id="l79.33"> }</span>
<a href="#l79.34"></a><span id="l79.34"> </span>
<a href="#l79.35"></a><span id="l79.35"> bool WMSettings::DoIMAPServer(nsIMsgAccountManager *pMgr,</span>
<a href="#l79.36"></a><span id="l79.36">                                 nsIDOMDocument *xmlDoc,</span>
<a href="#l79.37"></a><span id="l79.37">                                 const nsString&amp; serverName,</span>
<a href="#l79.38"></a><span id="l79.38">                                 nsIMsgAccount **ppAccount)</span>
<a href="#l79.39"></a><span id="l79.39"> {</span>
<a href="#l79.40"></a><span id="l79.40">   PRInt32 authMethod;   // Secure Password Authentication (SPA)</span>
<a href="#l79.41"></a><span id="l79.41" class="difflineat">@@ -711,17 +711,17 @@ bool WMSettings::DoNNTPServer(nsIMsgAcco</span>
<a href="#l79.42"></a><span id="l79.42">   }</span>
<a href="#l79.43"></a><span id="l79.43">   else</span>
<a href="#l79.44"></a><span id="l79.44">     result = true;</span>
<a href="#l79.45"></a><span id="l79.45">   return result;</span>
<a href="#l79.46"></a><span id="l79.46"> }</span>
<a href="#l79.47"></a><span id="l79.47"> </span>
<a href="#l79.48"></a><span id="l79.48"> void WMSettings::SetIdentities(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc,</span>
<a href="#l79.49"></a><span id="l79.49">                                nsIDOMDocument *xmlDoc, nsAutoString &amp;inUserName,</span>
<a href="#l79.50"></a><span id="l79.50" class="difflineminus">-                               PRInt32 authMethodIncoming, bool isNNTP )</span>
<a href="#l79.51"></a><span id="l79.51" class="difflineplus">+                               PRInt32 authMethodIncoming, bool isNNTP)</span>
<a href="#l79.52"></a><span id="l79.52"> {</span>
<a href="#l79.53"></a><span id="l79.53">   // Get the relevant information for an identity</span>
<a href="#l79.54"></a><span id="l79.54">   // BUG 470587. Don't set this: id-&gt;SetIdentityName(fullName);</span>
<a href="#l79.55"></a><span id="l79.55">   nsresult rv;</span>
<a href="#l79.56"></a><span id="l79.56">   nsAutoString value;</span>
<a href="#l79.57"></a><span id="l79.57"> </span>
<a href="#l79.58"></a><span id="l79.58">   nsCOMPtr&lt;nsIMsgIdentity&gt; id;</span>
<a href="#l79.59"></a><span id="l79.59">   rv = pMgr-&gt;CreateIdentity(getter_AddRefs(id));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/mailnews/import/winlivemail/nsWMStringBundle.cpp</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/mailnews/import/winlivemail/nsWMStringBundle.cpp</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -43,61 +43,61 @@</span>
<a href="#l80.4"></a><span id="l80.4"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l80.5"></a><span id="l80.5"> #include &quot;nsIURI.h&quot;</span>
<a href="#l80.6"></a><span id="l80.6"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l80.7"></a><span id="l80.7"> </span>
<a href="#l80.8"></a><span id="l80.8"> #define WM_MSGS_URL       &quot;chrome://messenger/locale/wmImportMsgs.properties&quot;</span>
<a href="#l80.9"></a><span id="l80.9"> </span>
<a href="#l80.10"></a><span id="l80.10"> nsIStringBundle *  nsWMStringBundle::m_pBundle = nsnull;</span>
<a href="#l80.11"></a><span id="l80.11"> </span>
<a href="#l80.12"></a><span id="l80.12" class="difflineminus">-nsIStringBundle *nsWMStringBundle::GetStringBundle( void)</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineplus">+nsIStringBundle *nsWMStringBundle::GetStringBundle(void)</span>
<a href="#l80.14"></a><span id="l80.14"> {</span>
<a href="#l80.15"></a><span id="l80.15">   if (m_pBundle)</span>
<a href="#l80.16"></a><span id="l80.16" class="difflineminus">-    return( m_pBundle);</span>
<a href="#l80.17"></a><span id="l80.17" class="difflineplus">+    return m_pBundle;</span>
<a href="#l80.18"></a><span id="l80.18"> </span>
<a href="#l80.19"></a><span id="l80.19">   char*        propertyURL = WM_MSGS_URL;</span>
<a href="#l80.20"></a><span id="l80.20">   nsIStringBundle*  sBundle = nsnull;</span>
<a href="#l80.21"></a><span id="l80.21"> </span>
<a href="#l80.22"></a><span id="l80.22">   nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l80.23"></a><span id="l80.23">     mozilla::services::GetStringBundleService();</span>
<a href="#l80.24"></a><span id="l80.24">   if (sBundleService) {</span>
<a href="#l80.25"></a><span id="l80.25">     sBundleService-&gt;CreateBundle(propertyURL, &amp;sBundle);</span>
<a href="#l80.26"></a><span id="l80.26">   }</span>
<a href="#l80.27"></a><span id="l80.27"> </span>
<a href="#l80.28"></a><span id="l80.28">   m_pBundle = sBundle;</span>
<a href="#l80.29"></a><span id="l80.29"> </span>
<a href="#l80.30"></a><span id="l80.30" class="difflineminus">-  return( sBundle);</span>
<a href="#l80.31"></a><span id="l80.31" class="difflineplus">+  return sBundle;</span>
<a href="#l80.32"></a><span id="l80.32"> }</span>
<a href="#l80.33"></a><span id="l80.33"> </span>
<a href="#l80.34"></a><span id="l80.34" class="difflineminus">-void nsWMStringBundle::GetStringByID( PRInt32 stringID, nsString&amp; result)</span>
<a href="#l80.35"></a><span id="l80.35" class="difflineplus">+void nsWMStringBundle::GetStringByID(PRInt32 stringID, nsString&amp; result)</span>
<a href="#l80.36"></a><span id="l80.36"> {</span>
<a href="#l80.37"></a><span id="l80.37">   PRUnichar *ptrv = GetStringByID(stringID);</span>
<a href="#l80.38"></a><span id="l80.38">   result = ptrv;</span>
<a href="#l80.39"></a><span id="l80.39" class="difflineminus">-  FreeString( ptrv);</span>
<a href="#l80.40"></a><span id="l80.40" class="difflineplus">+  FreeString(ptrv);</span>
<a href="#l80.41"></a><span id="l80.41"> }</span>
<a href="#l80.42"></a><span id="l80.42"> </span>
<a href="#l80.43"></a><span id="l80.43"> PRUnichar *nsWMStringBundle::GetStringByID(PRInt32 stringID)</span>
<a href="#l80.44"></a><span id="l80.44"> {</span>
<a href="#l80.45"></a><span id="l80.45">   if (!m_pBundle)</span>
<a href="#l80.46"></a><span id="l80.46">     m_pBundle = GetStringBundle();</span>
<a href="#l80.47"></a><span id="l80.47"> </span>
<a href="#l80.48"></a><span id="l80.48">   if (m_pBundle) {</span>
<a href="#l80.49"></a><span id="l80.49">     PRUnichar *ptrv = nsnull;</span>
<a href="#l80.50"></a><span id="l80.50">     nsresult rv = m_pBundle-&gt;GetStringFromID(stringID, &amp;ptrv);</span>
<a href="#l80.51"></a><span id="l80.51"> </span>
<a href="#l80.52"></a><span id="l80.52" class="difflineminus">-    if (NS_SUCCEEDED( rv) &amp;&amp; ptrv)</span>
<a href="#l80.53"></a><span id="l80.53" class="difflineminus">-      return( ptrv);</span>
<a href="#l80.54"></a><span id="l80.54" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; ptrv)</span>
<a href="#l80.55"></a><span id="l80.55" class="difflineplus">+      return ptrv;</span>
<a href="#l80.56"></a><span id="l80.56">   }</span>
<a href="#l80.57"></a><span id="l80.57"> </span>
<a href="#l80.58"></a><span id="l80.58">   nsString resultString;</span>
<a href="#l80.59"></a><span id="l80.59">   resultString.AppendLiteral(&quot;[StringID &quot;);</span>
<a href="#l80.60"></a><span id="l80.60">   resultString.AppendInt(stringID);</span>
<a href="#l80.61"></a><span id="l80.61">   resultString.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l80.62"></a><span id="l80.62"> </span>
<a href="#l80.63"></a><span id="l80.63" class="difflineminus">-  return( ToNewUnicode(resultString));</span>
<a href="#l80.64"></a><span id="l80.64" class="difflineplus">+  return ToNewUnicode(resultString);</span>
<a href="#l80.65"></a><span id="l80.65"> }</span>
<a href="#l80.66"></a><span id="l80.66"> </span>
<a href="#l80.67"></a><span id="l80.67" class="difflineminus">-void nsWMStringBundle::Cleanup( void)</span>
<a href="#l80.68"></a><span id="l80.68" class="difflineplus">+void nsWMStringBundle::Cleanup(void)</span>
<a href="#l80.69"></a><span id="l80.69"> {</span>
<a href="#l80.70"></a><span id="l80.70">   if (m_pBundle)</span>
<a href="#l80.71"></a><span id="l80.71">     m_pBundle-&gt;Release();</span>
<a href="#l80.72"></a><span id="l80.72">   m_pBundle = nsnull;</span>
<a href="#l80.73"></a><span id="l80.73"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/mailnews/import/winlivemail/nsWMStringBundle.h</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/mailnews/import/winlivemail/nsWMStringBundle.h</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -40,19 +40,19 @@</span>
<a href="#l81.4"></a><span id="l81.4"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l81.5"></a><span id="l81.5"> </span>
<a href="#l81.6"></a><span id="l81.6"> class nsIStringBundle;</span>
<a href="#l81.7"></a><span id="l81.7"> </span>
<a href="#l81.8"></a><span id="l81.8"> class nsWMStringBundle {</span>
<a href="#l81.9"></a><span id="l81.9"> public:</span>
<a href="#l81.10"></a><span id="l81.10">   static PRUnichar     *    GetStringByID(PRInt32 stringID);</span>
<a href="#l81.11"></a><span id="l81.11">   static void          GetStringByID(PRInt32 stringID, nsString&amp; result);</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineminus">-  static nsIStringBundle *  GetStringBundle( void); // don't release</span>
<a href="#l81.13"></a><span id="l81.13" class="difflineminus">-  static void          FreeString( PRUnichar *pStr) { NS_Free( pStr);}</span>
<a href="#l81.14"></a><span id="l81.14" class="difflineminus">-  static void          Cleanup( void);</span>
<a href="#l81.15"></a><span id="l81.15" class="difflineplus">+  static nsIStringBundle *  GetStringBundle(void); // don't release</span>
<a href="#l81.16"></a><span id="l81.16" class="difflineplus">+  static void          FreeString(PRUnichar *pStr) { NS_Free(pStr);}</span>
<a href="#l81.17"></a><span id="l81.17" class="difflineplus">+  static void          Cleanup(void);</span>
<a href="#l81.18"></a><span id="l81.18"> </span>
<a href="#l81.19"></a><span id="l81.19"> private:</span>
<a href="#l81.20"></a><span id="l81.20">   static nsIStringBundle *  m_pBundle;</span>
<a href="#l81.21"></a><span id="l81.21"> };</span>
<a href="#l81.22"></a><span id="l81.22"> </span>
<a href="#l81.23"></a><span id="l81.23"> </span>
<a href="#l81.24"></a><span id="l81.24"> </span>
<a href="#l81.25"></a><span id="l81.25"> #define WMIMPORT_NAME                     2000</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

