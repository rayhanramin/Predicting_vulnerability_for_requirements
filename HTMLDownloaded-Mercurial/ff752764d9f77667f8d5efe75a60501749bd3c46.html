<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26505:ff752764d9f77667f8d5efe75a60501749bd3c46</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ff752764d9f77667f8d5efe75a60501749bd3c46" />
<meta property="og:url" content="/comm-central/rev/ff752764d9f77667f8d5efe75a60501749bd3c46" />
<meta property="og:description" content="Bug 1531595 - Further improvements to FileLink; r=Fallen" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ff752764d9f77667f8d5efe75a60501749bd3c46 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ff752764d9f77667f8d5efe75a60501749bd3c46">shortlog</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ff752764d9f77667f8d5efe75a60501749bd3c46">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46">files</a> |
changeset |
<a href="/comm-central/raw-rev/ff752764d9f77667f8d5efe75a60501749bd3c46">raw</a>  | <a href="/comm-central/archive/ff752764d9f77667f8d5efe75a60501749bd3c46.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1531595">Bug 1531595</a> - Further improvements to FileLink; r=Fallen
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 03 May 2019 16:48:48 +1200</td></tr>

<tr>
 <td>changeset 26505</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ff752764d9f77667f8d5efe75a60501749bd3c46">ff752764d9f77667f8d5efe75a60501749bd3c46</a></td>
</tr>



<tr>
<td>parent 26504</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/37b96898406c2a6f2390e8f0ccbe2ebe32f755b4">37b96898406c2a6f2390e8f0ccbe2ebe32f755b4</a>
</td>
</tr>

<tr>
<td>child 26506</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4054e820674ca76020fee6b2b747700bd2cbed03">4054e820674ca76020fee6b2b747700bd2cbed03</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ff752764d9f77667f8d5efe75a60501749bd3c46">15866</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Fri, 03 May 2019 04:53:23 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4054e820674c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4054e820674ca76020fee6b2b747700bd2cbed03">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4054e820674ca76020fee6b2b747700bd2cbed03&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4054e820674ca76020fee6b2b747700bd2cbed03&newProject=comm-central&newRevision=ff752764d9f77667f8d5efe75a60501749bd3c46&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4054e820674ca76020fee6b2b747700bd2cbed03&newProject=comm-central&newRevision=ff752764d9f77667f8d5efe75a60501749bd3c46&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4054e820674ca76020fee6b2b747700bd2cbed03&newProject=comm-central&newRevision=ff752764d9f77667f8d5efe75a60501749bd3c46&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Fallen%29&revcount=50">Fallen</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1531595">1531595</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1531595">Bug 1531595</a> - Further improvements to FileLink; r=Fallen</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/calendar/lightning/content/lightning-item-iframe.js">calendar/lightning/content/lightning-item-iframe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/calendar/lightning/content/lightning-item-iframe.js">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/calendar/lightning/content/lightning-item-iframe.js">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/calendar/lightning/content/lightning-item-iframe.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/calendar/lightning/content/lightning-item-iframe.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/calendar/lightning/content/lightning-item-iframe.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/cloudFileAccounts.js">mail/components/cloudfile/cloudFileAccounts.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/cloudFileAccounts.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/cloudFileAccounts.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/cloudFileAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/cloudFileAccounts.jsm">mail/components/cloudfile/cloudFileAccounts.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/cloudFileAccounts.jsm">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/cloudFileAccounts.jsm">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/cloudFileAccounts.jsm">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/cloudFileAccounts.jsm">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/cloudFileAccounts.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.css">mail/components/cloudfile/content/selectDialog.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.css">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.css">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.css">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.css">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.js">mail/components/cloudfile/content/selectDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.js">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.js">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.xul">mail/components/cloudfile/content/selectDialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.xul">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.xul">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.xul">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.xul">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/content/selectDialog.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/jar.mn">mail/components/cloudfile/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/jar.mn">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/jar.mn">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/jar.mn">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/jar.mn">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/moz.build">mail/components/cloudfile/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/moz.build">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/moz.build">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/moz.build">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/moz.build">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/cloudfile/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/bigFileObserver.js">mail/components/compose/content/bigFileObserver.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/bigFileObserver.js">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/bigFileObserver.js">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/bigFileObserver.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/bigFileObserver.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/bigFileObserver.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/cloudAttachmentLinkManager.js">mail/components/compose/content/cloudAttachmentLinkManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/cloudAttachmentLinkManager.js">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/cloudAttachmentLinkManager.js">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/cloudAttachmentLinkManager.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/cloudAttachmentLinkManager.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/cloudAttachmentLinkManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/messengercompose.xul">mail/components/compose/content/messengercompose.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/messengercompose.xul">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/messengercompose.xul">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/messengercompose.xul">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/messengercompose.xul">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/compose/content/messengercompose.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/extensions/parent/ext-cloudFile.js">mail/components/extensions/parent/ext-cloudFile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/extensions/parent/ext-cloudFile.js">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/extensions/parent/ext-cloudFile.js">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/extensions/parent/ext-cloudFile.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/extensions/parent/ext-cloudFile.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/extensions/parent/ext-cloudFile.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">mail/components/extensions/test/xpcshell/test_ext_cloudFile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/applications.inc.xul">mail/components/preferences/applications.inc.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/applications.inc.xul">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/applications.inc.xul">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/applications.inc.xul">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/applications.inc.xul">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/applications.inc.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/applications.js">mail/components/preferences/applications.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/applications.js">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/applications.js">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/applications.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/applications.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/applications.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/test/browser/browser_applications.js">mail/components/preferences/test/browser/browser_applications.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/test/browser/browser_applications.js">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/test/browser/browser_applications.js">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/test/browser/browser_applications.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/test/browser/browser_applications.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/test/browser/browser_applications.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/test/browser/browser_cloudfile.js">mail/components/preferences/test/browser/browser_cloudfile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/test/browser/browser_cloudfile.js">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/test/browser/browser_cloudfile.js">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/test/browser/browser_cloudfile.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/test/browser/browser_cloudfile.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/components/preferences/test/browser/browser_cloudfile.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/locales/en-US/chrome/messenger/preferences/applications.dtd">mail/locales/en-US/chrome/messenger/preferences/applications.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/locales/en-US/chrome/messenger/preferences/applications.dtd">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/locales/en-US/chrome/messenger/preferences/applications.dtd">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/locales/en-US/chrome/messenger/preferences/applications.dtd">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/locales/en-US/chrome/messenger/preferences/applications.dtd">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/locales/en-US/chrome/messenger/preferences/applications.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js">mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/jar.mn">mail/themes/linux/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/jar.mn">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/jar.mn">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/jar.mn">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/jar.mn">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/mail/preferences/applications.css">mail/themes/linux/mail/preferences/applications.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/mail/preferences/applications.css">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/mail/preferences/applications.css">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/mail/preferences/applications.css">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/mail/preferences/applications.css">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/mail/preferences/applications.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/mail/preferences/auth-error.png">mail/themes/linux/mail/preferences/auth-error.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/mail/preferences/auth-error.png">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/mail/preferences/auth-error.png">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/mail/preferences/auth-error.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/mail/preferences/preferences.css">mail/themes/linux/mail/preferences/preferences.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/mail/preferences/preferences.css">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/mail/preferences/preferences.css">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/mail/preferences/preferences.css">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/mail/preferences/preferences.css">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/linux/mail/preferences/preferences.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/jar.mn">mail/themes/osx/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/jar.mn">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/jar.mn">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/jar.mn">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/jar.mn">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/mail/preferences/applications.css">mail/themes/osx/mail/preferences/applications.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/mail/preferences/applications.css">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/mail/preferences/applications.css">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/mail/preferences/applications.css">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/mail/preferences/applications.css">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/mail/preferences/applications.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/mail/preferences/auth-error.png">mail/themes/osx/mail/preferences/auth-error.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/mail/preferences/auth-error.png">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/mail/preferences/auth-error.png">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/mail/preferences/auth-error.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/mail/preferences/preferences.css">mail/themes/osx/mail/preferences/preferences.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/mail/preferences/preferences.css">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/mail/preferences/preferences.css">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/mail/preferences/preferences.css">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/mail/preferences/preferences.css">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/osx/mail/preferences/preferences.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/shared/mail/incontentprefs/aboutPreferences.css">mail/themes/shared/mail/incontentprefs/aboutPreferences.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/shared/mail/incontentprefs/aboutPreferences.css">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/shared/mail/incontentprefs/aboutPreferences.css">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/shared/mail/incontentprefs/aboutPreferences.css">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/shared/mail/incontentprefs/aboutPreferences.css">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/shared/mail/incontentprefs/aboutPreferences.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/jar.mn">mail/themes/windows/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/jar.mn">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/jar.mn">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/jar.mn">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/jar.mn">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/mail/preferences/applications.css">mail/themes/windows/mail/preferences/applications.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/mail/preferences/applications.css">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/mail/preferences/applications.css">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/mail/preferences/applications.css">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/mail/preferences/applications.css">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/mail/preferences/applications.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/mail/preferences/auth-error.png">mail/themes/windows/mail/preferences/auth-error.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/mail/preferences/auth-error.png">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/mail/preferences/auth-error.png">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/mail/preferences/auth-error.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/mail/preferences/preferences.css">mail/themes/windows/mail/preferences/preferences.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/mail/preferences/preferences.css">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/mail/preferences/preferences.css">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/mail/preferences/preferences.css">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/mail/preferences/preferences.css">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mail/themes/windows/mail/preferences/preferences.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/public/nsIMsgAttachment.idl">mailnews/compose/public/nsIMsgAttachment.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/public/nsIMsgAttachment.idl">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/public/nsIMsgAttachment.idl">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/public/nsIMsgAttachment.idl">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/public/nsIMsgAttachment.idl">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/public/nsIMsgAttachment.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachment.cpp">mailnews/compose/src/nsMsgAttachment.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachment.cpp">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachment.cpp">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachment.cpp">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachment.cpp">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachment.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachment.h">mailnews/compose/src/nsMsgAttachment.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachment.h">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachment.h">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachment.h">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachment.h">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachment.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachmentHandler.h">mailnews/compose/src/nsMsgAttachmentHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachmentHandler.h">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachmentHandler.h">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachmentHandler.h">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachmentHandler.h">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgAttachmentHandler.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/test/unit/test_messageHeaders.js">mailnews/compose/test/unit/test_messageHeaders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/test/unit/test_messageHeaders.js">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/test/unit/test_messageHeaders.js">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/test/unit/test_messageHeaders.js">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/test/unit/test_messageHeaders.js">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/compose/test/unit/test_messageHeaders.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/mime/src/mimedrft.cpp">mailnews/mime/src/mimedrft.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/mime/src/mimedrft.cpp">file</a> |
<a href="/comm-central/annotate/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/mime/src/mimedrft.cpp">annotate</a> |
<a href="/comm-central/diff/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/mime/src/mimedrft.cpp">diff</a> |
<a href="/comm-central/comparison/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/mime/src/mimedrft.cpp">comparison</a> |
<a href="/comm-central/log/ff752764d9f77667f8d5efe75a60501749bd3c46/mailnews/mime/src/mimedrft.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -29,18 +29,17 @@ var {</span>
<a href="#l1.4"></a><span id="l1.4">     checkRecurrenceRule,</span>
<a href="#l1.5"></a><span id="l1.5">     countOccurrences</span>
<a href="#l1.6"></a><span id="l1.6"> } = ChromeUtils.import(&quot;resource://calendar/modules/calRecurrenceUtils.jsm&quot;);</span>
<a href="#l1.7"></a><span id="l1.7"> var { PluralForm } = ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l1.8"></a><span id="l1.8"> var { XPCOMUtils } = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> var cloudFileAccounts;</span>
<a href="#l1.11"></a><span id="l1.11"> try {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    let temp = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    cloudFileAccounts = temp.cloudFileAccounts;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    ({ cloudFileAccounts } = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;));</span>
<a href="#l1.15"></a><span id="l1.15"> } catch (e) {</span>
<a href="#l1.16"></a><span id="l1.16">     // This will fail on Seamonkey, but that's ok since the pref for cloudfiles</span>
<a href="#l1.17"></a><span id="l1.17">     // is false, which means the UI will not be shown</span>
<a href="#l1.18"></a><span id="l1.18"> }</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> // Flag for using new item UI code (HTML/React.js).</span>
<a href="#l1.21"></a><span id="l1.21"> const gNewItemUI = Services.prefs.getBoolPref(&quot;calendar.item.useNewItemUI&quot;, false);</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23" class="difflineat">@@ -2050,19 +2049,19 @@ function loadCloudProviders() {</span>
<a href="#l1.24"></a><span id="l1.24">     let itemObjects = [];</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">     for (let cloudProvider of cloudFileAccounts.configuredAccounts) {</span>
<a href="#l1.27"></a><span id="l1.27">         // Create a serializable object to pass in a message outside the iframe</span>
<a href="#l1.28"></a><span id="l1.28">         let itemObject = {};</span>
<a href="#l1.29"></a><span id="l1.29">         itemObject.displayName = cloudFileAccounts.getDisplayName(cloudProvider);</span>
<a href="#l1.30"></a><span id="l1.30">         itemObject.label = cal.l10n.getString(&quot;calendar-event-dialog&quot;, &quot;attachViaFilelink&quot;, [itemObject.displayName]);</span>
<a href="#l1.31"></a><span id="l1.31">         itemObject.cloudProviderAccountKey = cloudProvider.accountKey;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-        if (cloudProvider.iconClass) {</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+        if (cloudProvider.iconURL) {</span>
<a href="#l1.34"></a><span id="l1.34">             itemObject.class = &quot;menuitem-iconic&quot;;</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-            itemObject.image = cloudProvider.iconClass;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+            itemObject.image = cloudProvider.iconURL;</span>
<a href="#l1.37"></a><span id="l1.37">         }</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39">         itemObjects.push(itemObject);</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41">         // Create a menu item from the serializable object</span>
<a href="#l1.42"></a><span id="l1.42">         let item = document.createXULElement(&quot;menuitem&quot;);</span>
<a href="#l1.43"></a><span id="l1.43">         item.setAttribute(&quot;label&quot;, itemObject.label);</span>
<a href="#l1.44"></a><span id="l1.44">         item.setAttribute(&quot;observes&quot;, &quot;cmd_attach_cloud&quot;);</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineat">@@ -2226,64 +2225,57 @@ function makePrettyName(aUri) {</span>
<a href="#l1.46"></a><span id="l1.46"> /**</span>
<a href="#l1.47"></a><span id="l1.47">  * Asynchronously uploads the given attachment to the cloud provider, updating</span>
<a href="#l1.48"></a><span id="l1.48">  * the passed listItem as things progress.</span>
<a href="#l1.49"></a><span id="l1.49">  *</span>
<a href="#l1.50"></a><span id="l1.50">  * @param attachment        A calIAttachment to upload</span>
<a href="#l1.51"></a><span id="l1.51">  * @param cloudProvider     The clould provider to upload to</span>
<a href="#l1.52"></a><span id="l1.52">  * @param listItem          The listitem in attachment-link listbox to update.</span>
<a href="#l1.53"></a><span id="l1.53">  */</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-function uploadCloudAttachment(attachment, cloudProvider, listItem) {</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+function uploadCloudAttachment(attachment, cloudFileAccount, listItem) {</span>
<a href="#l1.56"></a><span id="l1.56">     let file = attachment.uri.QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l1.57"></a><span id="l1.57">     listItem.attachLocalFile = file;</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-    listItem.attachCloudProvider = cloudProvider;</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-    cloudProvider.uploadFile(file, {</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-        onStartRequest: function() {</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-            listItem.setAttribute(&quot;image&quot;, &quot;chrome://global/skin/icons/loading.png&quot;);</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-        },</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-        onStopRequest: function(aRequest, aStatusCode) {</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-            if (Components.isSuccessCode(aStatusCode)) {</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-                delete gAttachMap[attachment.hashId];</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-                attachment.uri = Services.io.newURI(cloudProvider.urlForFile(file));</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-                attachment.setParameter(&quot;FILENAME&quot;, file.leafName);</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-                attachment.setParameter(&quot;PROVIDER&quot;, cloudProvider.type);</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-                listItem.setAttribute(&quot;label&quot;, file.leafName);</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-                gAttachMap[attachment.hashId] = attachment;</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-                listItem.setAttribute(&quot;image&quot;, cloudProvider.iconClass);</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-                updateAttachment();</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-            } else {</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-                cal.ERROR(&quot;[calendar-event-dialog] Uploading cloud attachment &quot; +</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-                          &quot;failed. Status code: &quot; + aStatusCode);</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-                // Uploading failed. First of all, show an error icon. Also,</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-                // delete it from the attach map now, this will make sure it is</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-                // not serialized if the user saves.</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-                listItem.setAttribute(&quot;image&quot;, &quot;chrome://messenger/skin/icons/error.png&quot;);</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-                delete gAttachMap[attachment.hashId];</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-                // Keep the item for a while so the user can see something failed.</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-                // When we have a nice notification bar, we can show more info</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-                // about the failure.</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-                setTimeout(() =&gt; {</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-                    listItem.remove();</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-                    updateAttachment();</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-                }, 5000);</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-            }</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-        }</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+    listItem.attachCloudFileAccount = cloudFileAccount;</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+    listItem.setAttribute(&quot;image&quot;, &quot;chrome://global/skin/icons/loading.png&quot;);</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+    cloudFileAccount.uploadFile(file).then(() =&gt; {</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+        delete gAttachMap[attachment.hashId];</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+        attachment.uri = Services.io.newURI(cloudFileAccount.urlForFile(file));</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+        attachment.setParameter(&quot;FILENAME&quot;, file.leafName);</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+        attachment.setParameter(&quot;PROVIDER&quot;, cloudFileAccount.type);</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+        listItem.setAttribute(&quot;label&quot;, file.leafName);</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+        gAttachMap[attachment.hashId] = attachment;</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+        listItem.setAttribute(&quot;image&quot;, cloudFileAccount.iconURL);</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+        updateAttachment();</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+    }, (statusCode) =&gt; {</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+        cal.ERROR(&quot;[calendar-event-dialog] Uploading cloud attachment &quot; +</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+                  &quot;failed. Status code: &quot; + statusCode);</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+        // Uploading failed. First of all, show an error icon. Also,</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+        // delete it from the attach map now, this will make sure it is</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+        // not serialized if the user saves.</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+        listItem.setAttribute(&quot;image&quot;, &quot;chrome://messenger/skin/icons/error.png&quot;);</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+        delete gAttachMap[attachment.hashId];</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+        // Keep the item for a while so the user can see something failed.</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+        // When we have a nice notification bar, we can show more info</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+        // about the failure.</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+        setTimeout(() =&gt; {</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+            listItem.remove();</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+            updateAttachment();</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+        }, 5000);</span>
<a href="#l1.121"></a><span id="l1.121">     });</span>
<a href="#l1.122"></a><span id="l1.122"> }</span>
<a href="#l1.123"></a><span id="l1.123"> </span>
<a href="#l1.124"></a><span id="l1.124"> /**</span>
<a href="#l1.125"></a><span id="l1.125">  * Adds the given attachment to dialog controls.</span>
<a href="#l1.126"></a><span id="l1.126">  *</span>
<a href="#l1.127"></a><span id="l1.127">  * @param attachment    The calIAttachment object to add</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">- * @param cloudProvider (optional) If set, the given cloud provider will be used.</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+ * @param cloudFileAccount (optional) If set, the given cloud file account will be used.</span>
<a href="#l1.130"></a><span id="l1.130">  */</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-function addAttachment(attachment, cloudProvider) {</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+function addAttachment(attachment, cloudFileAccount) {</span>
<a href="#l1.133"></a><span id="l1.133">     if (!attachment ||</span>
<a href="#l1.134"></a><span id="l1.134">         !attachment.hashId ||</span>
<a href="#l1.135"></a><span id="l1.135">         attachment.hashId in gAttachMap) {</span>
<a href="#l1.136"></a><span id="l1.136">         return;</span>
<a href="#l1.137"></a><span id="l1.137">     }</span>
<a href="#l1.138"></a><span id="l1.138"> </span>
<a href="#l1.139"></a><span id="l1.139">     // We currently only support uri attachments</span>
<a href="#l1.140"></a><span id="l1.140">     if (attachment.uri) {</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineat">@@ -2291,24 +2283,24 @@ function addAttachment(attachment, cloud</span>
<a href="#l1.142"></a><span id="l1.142">         let listItem = document.createXULElement(&quot;richlistitem&quot;);</span>
<a href="#l1.143"></a><span id="l1.143">         let image = document.createElement(&quot;image&quot;);</span>
<a href="#l1.144"></a><span id="l1.144">         listItem.appendChild(image);</span>
<a href="#l1.145"></a><span id="l1.145">         let label = document.createElement(&quot;label&quot;);</span>
<a href="#l1.146"></a><span id="l1.146">         label.setAttribute(&quot;value&quot;, makePrettyName(attachment.uri));</span>
<a href="#l1.147"></a><span id="l1.147">         label.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l1.148"></a><span id="l1.148">         listItem.appendChild(label);</span>
<a href="#l1.149"></a><span id="l1.149">         listItem.setAttribute(&quot;tooltiptext&quot;, attachment.uri.spec);</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineminus">-        if (cloudProvider) {</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+        if (cloudFileAccount) {</span>
<a href="#l1.152"></a><span id="l1.152">             if (attachment.uri.schemeIs(&quot;file&quot;)) {</span>
<a href="#l1.153"></a><span id="l1.153">                 // Its still a local url, needs to be uploaded</span>
<a href="#l1.154"></a><span id="l1.154">                 image.setAttribute(&quot;src&quot;, &quot;chrome://messenger/skin/icons/connecting.png&quot;);</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-                uploadCloudAttachment(attachment, cloudProvider, listItem);</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+                uploadCloudAttachment(attachment, cloudFileAccount, listItem);</span>
<a href="#l1.157"></a><span id="l1.157">             } else {</span>
<a href="#l1.158"></a><span id="l1.158">                 let leafName = attachment.getParameter(&quot;FILENAME&quot;);</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-                image.setAttribute(&quot;src&quot;, cloudProvider.iconClass);</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+                image.setAttribute(&quot;src&quot;, cloudFileAccount.iconURL);</span>
<a href="#l1.161"></a><span id="l1.161">                 if (leafName) {</span>
<a href="#l1.162"></a><span id="l1.162">                     listItem.setAttribute(&quot;label&quot;, leafName);</span>
<a href="#l1.163"></a><span id="l1.163">                 }</span>
<a href="#l1.164"></a><span id="l1.164">             }</span>
<a href="#l1.165"></a><span id="l1.165">         } else if (attachment.uri.schemeIs(&quot;file&quot;)) {</span>
<a href="#l1.166"></a><span id="l1.166">             image.setAttribute(&quot;src&quot;, &quot;moz-icon://&quot; + attachment.uri.spec);</span>
<a href="#l1.167"></a><span id="l1.167">         } else {</span>
<a href="#l1.168"></a><span id="l1.168">             let leafName = attachment.getParameter(&quot;FILENAME&quot;);</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineat">@@ -2316,17 +2308,17 @@ function addAttachment(attachment, cloud</span>
<a href="#l1.170"></a><span id="l1.170">             let cloudFileEnabled = Services.prefs.getBoolPref(&quot;mail.cloud_files.enabled&quot;, false);</span>
<a href="#l1.171"></a><span id="l1.171"> </span>
<a href="#l1.172"></a><span id="l1.172">             if (leafName) {</span>
<a href="#l1.173"></a><span id="l1.173">                 // TODO security issues?</span>
<a href="#l1.174"></a><span id="l1.174">                 listItem.setAttribute(&quot;label&quot;, leafName);</span>
<a href="#l1.175"></a><span id="l1.175">             }</span>
<a href="#l1.176"></a><span id="l1.176">             if (providerType &amp;&amp; cloudFileEnabled) {</span>
<a href="#l1.177"></a><span id="l1.177">                 let provider = cloudFileAccounts.getProviderForType(providerType);</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-                image.setAttribute(&quot;src&quot;, provider.iconClass);</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+                image.setAttribute(&quot;src&quot;, provider.iconURL);</span>
<a href="#l1.180"></a><span id="l1.180">             } else {</span>
<a href="#l1.181"></a><span id="l1.181">                 let iconSrc = attachment.uri.spec.length ? attachment.uri.spec : &quot;dummy.html&quot;;</span>
<a href="#l1.182"></a><span id="l1.182">                 if (attachment.formatType) {</span>
<a href="#l1.183"></a><span id="l1.183">                     iconSrc = &quot;goat?contentType=&quot; + attachment.formatType;</span>
<a href="#l1.184"></a><span id="l1.184">                 } else {</span>
<a href="#l1.185"></a><span id="l1.185">                     // let's try to auto-detect</span>
<a href="#l1.186"></a><span id="l1.186">                     let parts = iconSrc.substr(attachment.uri.scheme.length + 2).split(&quot;/&quot;);</span>
<a href="#l1.187"></a><span id="l1.187">                     if (parts.length) {</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineat">@@ -2356,28 +2348,23 @@ function addAttachment(attachment, cloud</span>
<a href="#l1.189"></a><span id="l1.189">  *</span>
<a href="#l1.190"></a><span id="l1.190">  * XXX This could use a dialog maybe?</span>
<a href="#l1.191"></a><span id="l1.191">  */</span>
<a href="#l1.192"></a><span id="l1.192"> function deleteAttachment() {</span>
<a href="#l1.193"></a><span id="l1.193">     let documentLink = document.getElementById(&quot;attachment-link&quot;);</span>
<a href="#l1.194"></a><span id="l1.194">     let item = documentLink.selectedItem;</span>
<a href="#l1.195"></a><span id="l1.195">     delete gAttachMap[item.attachment.hashId];</span>
<a href="#l1.196"></a><span id="l1.196"> </span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-    if (item.attachLocalFile &amp;&amp; item.attachCloudProvider) {</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+    if (item.attachLocalFile &amp;&amp; item.attachCloudFileAccount) {</span>
<a href="#l1.199"></a><span id="l1.199">         try {</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-            item.attachCloudProvider.deleteFile(item.attachLocalFile, {</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineminus">-                onStartRequest: function() {},</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-                onStopRequest: function(aRequest, aStatusCode) {</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-                    if (!Components.isSuccessCode(aStatusCode)) {</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-                        // TODO With a notification bar, we could actually show this error.</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-                        cal.ERROR(&quot;[calendar-event-dialog] Deleting cloud attachment &quot; +</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-                                  &quot;failed, file will remain on server. &quot; +</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-                                  &quot; Status code: &quot; + aStatusCode);</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-                    }</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-                }</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+            item.attachCloudFileAccount.deleteFile(item.attachLocalFile).catch((statusCode) =&gt; {</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+                // TODO With a notification bar, we could actually show this error.</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+                cal.ERROR(&quot;[calendar-event-dialog] Deleting cloud attachment &quot; +</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+                          &quot;failed, file will remain on server. &quot; +</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+                          &quot; Status code: &quot; + statusCode);</span>
<a href="#l1.215"></a><span id="l1.215">             });</span>
<a href="#l1.216"></a><span id="l1.216">         } catch (e) {</span>
<a href="#l1.217"></a><span id="l1.217">             cal.ERROR(&quot;[calendar-event-dialog] Deleting cloud attachment &quot; +</span>
<a href="#l1.218"></a><span id="l1.218">                       &quot;failed, file will remain on server. &quot; +</span>
<a href="#l1.219"></a><span id="l1.219">                       &quot;Exception: &quot; + e);</span>
<a href="#l1.220"></a><span id="l1.220">         }</span>
<a href="#l1.221"></a><span id="l1.221">     }</span>
<a href="#l1.222"></a><span id="l1.222">     item.remove();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">rename from mail/components/cloudfile/cloudFileAccounts.js</span>
<a href="#l2.2"></a><span id="l2.2">rename to mail/components/cloudfile/cloudFileAccounts.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineminus">--- a/mail/components/cloudfile/cloudFileAccounts.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineplus">+++ b/mail/components/cloudfile/cloudFileAccounts.jsm</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineat">@@ -1,25 +1,22 @@</span>
<a href="#l2.6"></a><span id="l2.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.7"></a><span id="l2.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.8"></a><span id="l2.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> this.EXPORTED_SYMBOLS = [&quot;cloudFileAccounts&quot;];</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-var CATEGORY = &quot;cloud-files&quot;;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-var PREF_ROOT = &quot;mail.cloud_files.&quot;;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-var ACCOUNT_ROOT = PREF_ROOT + &quot;accounts.&quot;;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+var ACCOUNT_ROOT = &quot;mail.cloud_files.accounts.&quot;;</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> // The following constants are used to query and insert entries</span>
<a href="#l2.18"></a><span id="l2.18"> // into the nsILoginManager.</span>
<a href="#l2.19"></a><span id="l2.19"> var PWDMGR_HOST = &quot;chrome://messenger/cloudfile&quot;;</span>
<a href="#l2.20"></a><span id="l2.20"> var PWDMGR_REALM = &quot;BigFiles Auth Token&quot;;</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-var { fixIterator } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l2.24"></a><span id="l2.24"> var {EventEmitter} = ChromeUtils.import(&quot;resource://gre/modules/EventEmitter.jsm&quot;);</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26"> var cloudFileAccounts = new class extends EventEmitter {</span>
<a href="#l2.27"></a><span id="l2.27">   get constants() {</span>
<a href="#l2.28"></a><span id="l2.28">     return {</span>
<a href="#l2.29"></a><span id="l2.29">       offlineErr: 0x80550014, // NS_MSG_ERROR_OFFLINE</span>
<a href="#l2.30"></a><span id="l2.30">       authErr: 0x8055001e, // NS_MSG_USER_NOT_AUTHENTICATED</span>
<a href="#l2.31"></a><span id="l2.31">       uploadErr: 0x8055311a, // NS_MSG_ERROR_ATTACHING_FILE</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineat">@@ -109,17 +106,16 @@ var cloudFileAccounts = new class extend</span>
<a href="#l2.33"></a><span id="l2.33">   get providers() {</span>
<a href="#l2.34"></a><span id="l2.34">     return [...this._providers.values()];</span>
<a href="#l2.35"></a><span id="l2.35">   }</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37">   getProviderForType(aType) {</span>
<a href="#l2.38"></a><span id="l2.38">     return this._providers.get(aType);</span>
<a href="#l2.39"></a><span id="l2.39">   }</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-  // aExtraPrefs are prefs specific to an account provider.</span>
<a href="#l2.42"></a><span id="l2.42">   createAccount(aType) {</span>
<a href="#l2.43"></a><span id="l2.43">     this._highestOrdinal++;</span>
<a href="#l2.44"></a><span id="l2.44">     let key = &quot;account&quot; + this._highestOrdinal;</span>
<a href="#l2.45"></a><span id="l2.45"> </span>
<a href="#l2.46"></a><span id="l2.46">     try {</span>
<a href="#l2.47"></a><span id="l2.47">       let provider = this.getProviderForType(aType);</span>
<a href="#l2.48"></a><span id="l2.48">       let account = provider.initAccount(key);</span>
<a href="#l2.49"></a><span id="l2.49"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mail/components/cloudfile/content/selectDialog.css</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,13 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+richlistitem {</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+  padding: 4px 8px;</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+}</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+richlistitem &gt; image {</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  margin-inline-end: 8px;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  width: 16px;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  height: 16px;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mail/components/cloudfile/content/selectDialog.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,18 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+/* import-globals-from ../../../../../toolkit/components/prompts/content/selectDialog.js */</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+function cloudfileDialogOnLoad() {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+    dialogOnLoad();</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+    let icons = gArgs.getProperty(&quot;icons&quot;);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+    let listItems = listBox.itemChildren;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+    for (let i = 0; i &lt; listItems.length; i++) {</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+        listItems[i].setAttribute(&quot;align&quot;, &quot;center&quot;);</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+        let image = document.createXULElement(&quot;image&quot;);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+        image.src = icons[i];</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+        listItems[i].insertBefore(image, listItems[i].firstElementChild);</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+    }</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mail/components/cloudfile/content/selectDialog.xul</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,24 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+   - file, you can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin/global.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://messenger/content/cloudfile/selectDialog.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+&lt;!DOCTYPE dialog SYSTEM &quot;chrome://global/locale/commonDialog.dtd&quot;&gt;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+&lt;dialog xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+      onload=&quot;cloudfileDialogOnLoad()&quot;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+      ondialogaccept=&quot;return dialogOK();&quot;&gt;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/cloudfile/selectDialog.js&quot; /&gt;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://global/content/selectDialog.js&quot; /&gt;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+  &lt;keyset id=&quot;dialogKeys&quot;/&gt;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+  &lt;vbox style=&quot;width: 24em;margin: 5px;&quot;&gt;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+    &lt;label id=&quot;info.txt&quot;/&gt;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+    &lt;vbox&gt;</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+      &lt;richlistbox id=&quot;list&quot; class=&quot;theme-listbox&quot; style=&quot;height: 8em;&quot;/&gt;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+    &lt;/vbox&gt;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  &lt;/vbox&gt;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+&lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/cloudfile/jar.mn</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/cloudfile/jar.mn</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,13 +1,16 @@</span>
<a href="#l6.4"></a><span id="l6.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.6"></a><span id="l6.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> messenger.jar:</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+    content/messenger/cloudfile/selectDialog.css              (content/selectDialog.css)</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+    content/messenger/cloudfile/selectDialog.js               (content/selectDialog.js)</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+    content/messenger/cloudfile/selectDialog.xul              (content/selectDialog.xul)</span>
<a href="#l6.12"></a><span id="l6.12">     content/messenger/cloudfile/Box/box.jsm                   (box/box.jsm)</span>
<a href="#l6.13"></a><span id="l6.13">     content/messenger/cloudfile/Box/management.xhtml          (box/management.xhtml)</span>
<a href="#l6.14"></a><span id="l6.14">     content/messenger/cloudfile/Box/management.js             (box/management.js)</span>
<a href="#l6.15"></a><span id="l6.15">     content/messenger/cloudfile/Hightail/hightail.jsm         (hightail/hightail.jsm)</span>
<a href="#l6.16"></a><span id="l6.16">     content/messenger/cloudfile/Hightail/management.xhtml     (hightail/management.xhtml)</span>
<a href="#l6.17"></a><span id="l6.17">     content/messenger/cloudfile/Hightail/management.js        (hightail/management.js)</span>
<a href="#l6.18"></a><span id="l6.18">     content/messenger/cloudfile/Hightail/fileExceedsLimit.xul (hightail/fileExceedsLimit.xul)</span>
<a href="#l6.19"></a><span id="l6.19">     content/messenger/cloudfile/Hightail/fileExceedsQuota.xul (hightail/fileExceedsQuota.xul)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/cloudfile/moz.build</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/cloudfile/moz.build</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l7.4"></a><span id="l7.4"> # vim: set filetype=python:</span>
<a href="#l7.5"></a><span id="l7.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.7"></a><span id="l7.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> EXTRA_JS_MODULES += [</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-    'cloudFileAccounts.js',</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+    'cloudFileAccounts.jsm',</span>
<a href="#l7.12"></a><span id="l7.12"> ]</span>
<a href="#l7.13"></a><span id="l7.13"> </span>
<a href="#l7.14"></a><span id="l7.14"> JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16"> DIRS += [</span>
<a href="#l7.17"></a><span id="l7.17">     'wetransfer',</span>
<a href="#l7.18"></a><span id="l7.18"> ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -14,17 +14,17 @@</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> /**</span>
<a href="#l8.6"></a><span id="l8.6">  * Commands for the message composition window.</span>
<a href="#l8.7"></a><span id="l8.7">  */</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> // Ensure the activity modules are loaded for this window.</span>
<a href="#l8.10"></a><span id="l8.10"> ChromeUtils.import(&quot;resource:///modules/activity/activityModules.jsm&quot;);</span>
<a href="#l8.11"></a><span id="l8.11"> var {AttachmentChecker} = ChromeUtils.import(&quot;resource:///modules/AttachmentChecker.jsm&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l8.14"></a><span id="l8.14"> var {MimeParser} = ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l8.15"></a><span id="l8.15"> var {allAccountsSorted} = ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l8.16"></a><span id="l8.16"> var {fixIterator, toArray} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l8.17"></a><span id="l8.17"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l8.18"></a><span id="l8.18"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l8.19"></a><span id="l8.19"> var {InlineSpellChecker} = ChromeUtils.import(&quot;resource://gre/modules/InlineSpellChecker.jsm&quot;);</span>
<a href="#l8.20"></a><span id="l8.20"> var {PluralForm} = ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l8.21"></a><span id="l8.21"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -1163,17 +1163,17 @@ var attachmentBucketController = {</span>
<a href="#l8.23"></a><span id="l8.23">       doCommand() {</span>
<a href="#l8.24"></a><span id="l8.24">         let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l8.25"></a><span id="l8.25">                                   .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27">         let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l8.28"></a><span id="l8.28">         for (let item of bucket.selectedItems) {</span>
<a href="#l8.29"></a><span id="l8.29">           if (item &amp;&amp; item.uploading) {</span>
<a href="#l8.30"></a><span id="l8.30">             let file = fileHandler.getFileFromURLSpec(item.attachment.url);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-            item.cloudProvider.cancelFileUpload(file);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+            item.cloudFileAccount.cancelFileUpload(file);</span>
<a href="#l8.33"></a><span id="l8.33">           }</span>
<a href="#l8.34"></a><span id="l8.34">         }</span>
<a href="#l8.35"></a><span id="l8.35">       },</span>
<a href="#l8.36"></a><span id="l8.36">     },</span>
<a href="#l8.37"></a><span id="l8.37">   },</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39">   supportsCommand(aCommand) {</span>
<a href="#l8.40"></a><span id="l8.40">     return (aCommand in this.commands);</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineat">@@ -1443,21 +1443,21 @@ function updateSendCommands(aHaveControl</span>
<a href="#l8.42"></a><span id="l8.42">     goSetCommandEnabled(&quot;cmd_sendWithCheck&quot;, defaultController.isCommandEnabled(&quot;cmd_sendWithCheck&quot;));</span>
<a href="#l8.43"></a><span id="l8.43">   }</span>
<a href="#l8.44"></a><span id="l8.44"> }</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46"> function addAttachCloudMenuItems(aParentMenu) {</span>
<a href="#l8.47"></a><span id="l8.47">   while (aParentMenu.hasChildNodes())</span>
<a href="#l8.48"></a><span id="l8.48">     aParentMenu.lastChild.remove();</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-  for (let cloudProvider of cloudFileAccounts.configuredAccounts) {</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  for (let account of cloudFileAccounts.configuredAccounts) {</span>
<a href="#l8.52"></a><span id="l8.52">     let item = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-    let iconURL = cloudProvider.iconURL;</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-    item.cloudProvider = cloudProvider;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-    item.setAttribute(&quot;label&quot;, cloudFileAccounts.getDisplayName(cloudProvider));</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+    let iconURL = account.iconURL;</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+    item.cloudFileAccount = account;</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+    item.setAttribute(&quot;label&quot;, cloudFileAccounts.getDisplayName(account));</span>
<a href="#l8.59"></a><span id="l8.59"> </span>
<a href="#l8.60"></a><span id="l8.60">     if (iconURL) {</span>
<a href="#l8.61"></a><span id="l8.61">       item.setAttribute(&quot;class&quot;, &quot;menu-iconic&quot;);</span>
<a href="#l8.62"></a><span id="l8.62">       item.setAttribute(&quot;image&quot;, iconURL);</span>
<a href="#l8.63"></a><span id="l8.63">     }</span>
<a href="#l8.64"></a><span id="l8.64">     aParentMenu.appendChild(item);</span>
<a href="#l8.65"></a><span id="l8.65">   }</span>
<a href="#l8.66"></a><span id="l8.66"> }</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineat">@@ -1468,220 +1468,197 @@ function addConvertCloudMenuItems(aParen</span>
<a href="#l8.68"></a><span id="l8.68">   while (afterNode.nextSibling)</span>
<a href="#l8.69"></a><span id="l8.69">     afterNode.nextSibling.remove();</span>
<a href="#l8.70"></a><span id="l8.70"> </span>
<a href="#l8.71"></a><span id="l8.71">   if (!attachment.sendViaCloud) {</span>
<a href="#l8.72"></a><span id="l8.72">     let item = document.getElementById(&quot;convertCloudMenuItems_popup_convertAttachment&quot;);</span>
<a href="#l8.73"></a><span id="l8.73">     item.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l8.74"></a><span id="l8.74">   }</span>
<a href="#l8.75"></a><span id="l8.75"> </span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-  for (let cloudProvider of cloudFileAccounts.configuredAccounts) {</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+  for (let account of cloudFileAccounts.configuredAccounts) {</span>
<a href="#l8.78"></a><span id="l8.78">     let item = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-    let iconURL = cloudProvider.iconURL;</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-    item.cloudProvider = cloudProvider;</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-    item.setAttribute(&quot;label&quot;, cloudFileAccounts.getDisplayName(cloudProvider));</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+    let iconURL = account.iconURL;</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+    item.cloudFileAccount = account;</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+    item.setAttribute(&quot;label&quot;, cloudFileAccounts.getDisplayName(account));</span>
<a href="#l8.85"></a><span id="l8.85">     item.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l8.86"></a><span id="l8.86">     item.setAttribute(&quot;name&quot;, aRadioGroup);</span>
<a href="#l8.87"></a><span id="l8.87"> </span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-    if (attachment.cloudProvider &amp;&amp;</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-        attachment.cloudProvider.accountKey == cloudProvider.accountKey) {</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+    if (attachment.cloudFileAccount &amp;&amp;</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+        attachment.cloudFileAccount.accountKey == account.accountKey) {</span>
<a href="#l8.92"></a><span id="l8.92">       item.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l8.93"></a><span id="l8.93">     } else if (iconURL) {</span>
<a href="#l8.94"></a><span id="l8.94">       item.setAttribute(&quot;class&quot;, &quot;menu-iconic&quot;);</span>
<a href="#l8.95"></a><span id="l8.95">       item.setAttribute(&quot;image&quot;, iconURL);</span>
<a href="#l8.96"></a><span id="l8.96">     }</span>
<a href="#l8.97"></a><span id="l8.97"> </span>
<a href="#l8.98"></a><span id="l8.98">     aParentMenu.appendChild(item);</span>
<a href="#l8.99"></a><span id="l8.99">   }</span>
<a href="#l8.100"></a><span id="l8.100"> }</span>
<a href="#l8.101"></a><span id="l8.101"> </span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-function uploadListener(aAttachment, aFile, aCloudProvider) {</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-  this.attachment = aAttachment;</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-  this.file = aFile;</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-  this.cloudProvider = aCloudProvider;</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+async function uploadCloudAttachment(attachment, file, cloudFileAccount) {</span>
<a href="#l8.108"></a><span id="l8.108">   // Notify the UI that we're starting the upload process: disable send commands</span>
<a href="#l8.109"></a><span id="l8.109">   // and show a &quot;connecting&quot; icon for the attachment.</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-  this.attachment.sendViaCloud = true;</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+  attachment.sendViaCloud = true;</span>
<a href="#l8.112"></a><span id="l8.112">   gNumUploadingAttachments++;</span>
<a href="#l8.113"></a><span id="l8.113">   updateSendCommands(true);</span>
<a href="#l8.114"></a><span id="l8.114"> </span>
<a href="#l8.115"></a><span id="l8.115">   let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-  let item = bucket.findItemForAttachment(this.attachment);</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-  if (item) {</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-    item.image = &quot;chrome://messenger/skin/icons/connecting.png&quot;;</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-    item.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+  let attachmentItem = bucket.findItemForAttachment(attachment);</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+  if (attachmentItem) {</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+    attachmentItem.image = &quot;chrome://global/skin/icons/loading.png&quot;;</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+    attachmentItem.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l8.124"></a><span id="l8.124">       getComposeBundle().getFormattedString(&quot;cloudFileUploadingTooltip&quot;, [</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-        cloudFileAccounts.getDisplayName(this.cloudProvider),</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+        cloudFileAccounts.getDisplayName(cloudFileAccount),</span>
<a href="#l8.127"></a><span id="l8.127">       ]));</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-    item.uploading = true;</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-    item.cloudProvider = this.cloudProvider;</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+    attachmentItem.uploading = true;</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+    attachmentItem.cloudFileAccount = cloudFileAccount;</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+  }</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+  let statusCode = Cr.NS_OK;</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+  try {</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+    await cloudFileAccount.uploadFile(file);</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+  } catch (ex) {</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+    statusCode = ex;</span>
<a href="#l8.139"></a><span id="l8.139">   }</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-}</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineminus">-</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-uploadListener.prototype = {</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineminus">-  onStartRequest(aRequest) {</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineminus">-    let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineminus">-    let item = bucket.findItemForAttachment(this.attachment);</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-    if (item)</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-      item.image = &quot;chrome://global/skin/icons/loading.png&quot;;</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-  },</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineminus">-    let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-    let attachmentItem = bucket.findItemForAttachment(this.attachment);</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-    if (Components.isSuccessCode(aStatusCode)) {</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-      let originalUrl = this.attachment.url;</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-      this.attachment.contentLocation = this.cloudProvider.urlForFile(this.file);</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-      this.attachment.cloudProviderKey = this.cloudProvider.accountKey;</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-      if (attachmentItem) {</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-        // Update relevant bits on the attachment list item.</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-        if (!attachmentItem.originalUrl)</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-          attachmentItem.originalUrl = originalUrl;</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-        attachmentItem.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-          getComposeBundle().getFormattedString(&quot;cloudFileUploadedTooltip&quot;, [</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-            cloudFileAccounts.getDisplayName(this.cloudProvider),</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-          ]));</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-        attachmentItem.uploading = false;</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-        // Set the icon for the attachment.</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-        let iconURL = this.cloudProvider.iconURL;</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-        if (iconURL) {</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-          attachmentItem.image = iconURL;</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-        } else {</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-          // Should we use a generic &quot;cloud&quot; icon here? Or an overlay icon?</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-          // I think the provider should provide an icon, end of story.</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineminus">-          attachmentItem.image = null;</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-        }</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+  if (Components.isSuccessCode(statusCode)) {</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+    let originalUrl = attachment.url;</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+    attachment.contentLocation = cloudFileAccount.urlForFile(file);</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+    attachment.cloudFileAccountKey = cloudFileAccount.accountKey;</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+    if (attachmentItem) {</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+      // Update relevant bits on the attachment list item.</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+      if (!attachmentItem.originalUrl) {</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+        attachmentItem.originalUrl = originalUrl;</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+      }</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+      attachmentItem.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+        getComposeBundle().getFormattedString(&quot;cloudFileUploadedTooltip&quot;, [</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+          cloudFileAccounts.getDisplayName(cloudFileAccount),</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+        ]));</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+      attachmentItem.uploading = false;</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+      // Set the icon for the attachment.</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+      let iconURL = cloudFileAccount.iconURL;</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+      if (iconURL) {</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+        attachmentItem.image = iconURL;</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+      } else {</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+        // Should we use a generic &quot;cloud&quot; icon here? Or an overlay icon?</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+        // I think the provider should provide an icon, end of story.</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+        attachmentItem.image = null;</span>
<a href="#l8.201"></a><span id="l8.201">       }</span>
<a href="#l8.202"></a><span id="l8.202"> </span>
<a href="#l8.203"></a><span id="l8.203" class="difflineminus">-      let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineminus">-      event.initEvent(&quot;attachment-uploaded&quot;, true, true);</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineminus">-      attachmentItem.dispatchEvent(new Event(&quot;attachment-uploaded&quot;,</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineminus">-        { bubbles: true, cancelable: true }));</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineminus">-    } else {</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineminus">-      let title;</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineminus">-      let msg;</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineminus">-      let displayName = cloudFileAccounts.getDisplayName(this.cloudProvider);</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineminus">-      let bundle = getComposeBundle();</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineminus">-      let displayError = true;</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineminus">-      switch (aStatusCode) {</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-      case cloudFileAccounts.constants.authErr:</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineminus">-        title = bundle.getString(&quot;errorCloudFileAuth.title&quot;);</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-        msg = bundle.getFormattedString(&quot;errorCloudFileAuth.message&quot;,</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineminus">-                                        [displayName]);</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineminus">-        break;</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-      case cloudFileAccounts.constants.uploadErr:</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-        title = bundle.getString(&quot;errorCloudFileUpload.title&quot;);</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineminus">-        msg = bundle.getFormattedString(&quot;errorCloudFileUpload.message&quot;,</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineminus">-                                        [displayName,</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineminus">-                                         this.attachment.name]);</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineminus">-        break;</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineminus">-      case cloudFileAccounts.constants.uploadWouldExceedQuota:</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineminus">-        title = bundle.getString(&quot;errorCloudFileQuota.title&quot;);</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineminus">-        msg = bundle.getFormattedString(&quot;errorCloudFileQuota.message&quot;,</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineminus">-                                        [displayName,</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineminus">-                                         this.attachment.name]);</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineminus">-        break;</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineminus">-      case cloudFileAccounts.constants.uploadExceedsFileNameLimit:</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineminus">-        title = bundle.getString(&quot;errorCloudFileNameLimit.title&quot;);</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineminus">-        msg = bundle.getFormattedString(&quot;errorCloudFileNameLimit.message&quot;,</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineminus">-                                        [displayName,</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineminus">-                                         this.attachment.name]);</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineminus">-        break;</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-      case cloudFileAccounts.constants.uploadExceedsFileLimit:</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineminus">-        title = bundle.getString(&quot;errorCloudFileLimit.title&quot;);</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-        msg = bundle.getFormattedString(&quot;errorCloudFileLimit.message&quot;,</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-                                        [displayName,</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-                                         this.attachment.name]);</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineminus">-        break;</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineminus">-      case cloudFileAccounts.constants.uploadCancelled:</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineminus">-        displayError = false;</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineminus">-        break;</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineminus">-      default:</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineminus">-        title = bundle.getString(&quot;errorCloudFileOther.title&quot;);</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineminus">-        msg = bundle.getFormattedString(&quot;errorCloudFileOther.message&quot;,</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineminus">-                                        [displayName]);</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineminus">-        break;</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+      attachmentItem.dispatchEvent(</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+        new CustomEvent(&quot;attachment-uploaded&quot;, { bubbles: true, cancelable: true })</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+      );</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+    }</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+  } else {</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+    let title;</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+    let msg;</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+    let displayName = cloudFileAccounts.getDisplayName(cloudFileAccount);</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+    let bundle = getComposeBundle();</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+    let displayError = true;</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+    switch (statusCode) {</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+    case cloudFileAccounts.constants.authErr:</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+      title = bundle.getString(&quot;errorCloudFileAuth.title&quot;);</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+      msg = bundle.getFormattedString(&quot;errorCloudFileAuth.message&quot;,</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+                                      [displayName]);</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+      break;</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+    case cloudFileAccounts.constants.uploadErr:</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineplus">+      title = bundle.getString(&quot;errorCloudFileUpload.title&quot;);</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+      msg = bundle.getFormattedString(&quot;errorCloudFileUpload.message&quot;,</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+                                      [displayName,</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+                                       attachment.name]);</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+      break;</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+    case cloudFileAccounts.constants.uploadWouldExceedQuota:</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+      title = bundle.getString(&quot;errorCloudFileQuota.title&quot;);</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+      msg = bundle.getFormattedString(&quot;errorCloudFileQuota.message&quot;,</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+                                      [displayName,</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+                                       attachment.name]);</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+      break;</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+    case cloudFileAccounts.constants.uploadExceedsFileNameLimit:</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+      title = bundle.getString(&quot;errorCloudFileNameLimit.title&quot;);</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+      msg = bundle.getFormattedString(&quot;errorCloudFileNameLimit.message&quot;,</span>
<a href="#l8.282"></a><span id="l8.282" class="difflineplus">+                                      [displayName,</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineplus">+                                       attachment.name]);</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineplus">+      break;</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineplus">+    case cloudFileAccounts.constants.uploadExceedsFileLimit:</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineplus">+      title = bundle.getString(&quot;errorCloudFileLimit.title&quot;);</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineplus">+      msg = bundle.getFormattedString(&quot;errorCloudFileLimit.message&quot;,</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+                                      [displayName,</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+                                       attachment.name]);</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+      break;</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+    case cloudFileAccounts.constants.uploadCancelled:</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineplus">+      displayError = false;</span>
<a href="#l8.293"></a><span id="l8.293" class="difflineplus">+      break;</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineplus">+    default:</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineplus">+      title = bundle.getString(&quot;errorCloudFileOther.title&quot;);</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+      msg = bundle.getFormattedString(&quot;errorCloudFileOther.message&quot;,</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineplus">+                                      [displayName]);</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+      break;</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+    }</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineplus">+    // TODO: support actions other than &quot;Upgrade&quot;</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineplus">+    if (displayError) {</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineplus">+      let url = cloudFileAccount.providerUrlForError &amp;&amp;</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+                cloudFileAccount.providerUrlForError(statusCode);</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineplus">+      let flags = Services.prompt.BUTTON_POS_0 * Services.prompt.BUTTON_TITLE_OK;</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineplus">+      if (url) {</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineplus">+        flags += Services.prompt.BUTTON_POS_1 * Services.prompt.BUTTON_TITLE_IS_STRING;</span>
<a href="#l8.308"></a><span id="l8.308">       }</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineminus">-</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineminus">-      // TODO: support actions other than &quot;Upgrade&quot;</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineminus">-      if (displayError) {</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineminus">-        let url = this.cloudProvider.providerUrlForError(aStatusCode);</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineminus">-        let flags = Services.prompt.BUTTON_POS_0 * Services.prompt.BUTTON_TITLE_OK;</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineminus">-        if (url)</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineminus">-          flags += Services.prompt.BUTTON_POS_1 * Services.prompt.BUTTON_TITLE_IS_STRING;</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineminus">-        if (Services.prompt.confirmEx(window, title, msg, flags, null,</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineminus">-                                      bundle.getString(&quot;errorCloudFileUpgrade.label&quot;),</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineminus">-                                      null, null, {})) {</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineminus">-          openLinkExternally(url);</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineminus">-        }</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineminus">-      }</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineminus">-</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineminus">-      if (attachmentItem) {</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-        // Remove the loading throbber.</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineminus">-        attachmentItem.image = null;</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineminus">-        attachmentItem.setAttribute(&quot;tooltiptext&quot;, attachmentItem.attachment.url);</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineminus">-        attachmentItem.uploading = false;</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineminus">-        attachmentItem.attachment.sendViaCloud = false;</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineminus">-        delete attachmentItem.cloudProvider;</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineminus">-</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineminus">-        let event = document.createEvent(&quot;CustomEvent&quot;);</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineminus">-        event.initEvent(&quot;attachment-upload-failed&quot;, true, true,</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineminus">-                        aStatusCode);</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineminus">-        attachmentItem.dispatchEvent(event);</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineplus">+      if (Services.prompt.confirmEx(window, title, msg, flags, null,</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineplus">+                                    bundle.getString(&quot;errorCloudFileUpgrade.label&quot;),</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineplus">+                                    null, null, {})) {</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineplus">+        openLinkExternally(url);</span>
<a href="#l8.339"></a><span id="l8.339">       }</span>
<a href="#l8.340"></a><span id="l8.340">     }</span>
<a href="#l8.341"></a><span id="l8.341"> </span>
<a href="#l8.342"></a><span id="l8.342" class="difflineminus">-    gNumUploadingAttachments--;</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineminus">-    updateSendCommands(true);</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineminus">-  },</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineminus">-</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([&quot;nsIRequestObserver&quot;,</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineminus">-                                          &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineminus">-};</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineminus">-</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineminus">-function deletionListener(aAttachment, aCloudProvider) {</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineminus">-  this.attachment = aAttachment;</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineminus">-  this.cloudProvider = aCloudProvider;</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineminus">-}</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineminus">-</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineminus">-deletionListener.prototype = {</span>
<a href="#l8.356"></a><span id="l8.356" class="difflineminus">-  onStartRequest(aRequest) {</span>
<a href="#l8.357"></a><span id="l8.357" class="difflineminus">-  },</span>
<a href="#l8.358"></a><span id="l8.358" class="difflineminus">-</span>
<a href="#l8.359"></a><span id="l8.359" class="difflineminus">-  onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineminus">-    if (!Components.isSuccessCode(aStatusCode)) {</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineminus">-      let displayName = cloudFileAccounts.getDisplayName(this.cloudProvider);</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineminus">-      Services.prompt.alert(window,</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineminus">-        getComposeBundle().getString(&quot;errorCloudFileDeletion.title&quot;),</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineminus">-        getComposeBundle().getFormattedString(&quot;errorCloudFileDeletion.message&quot;,</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineminus">-                                              [displayName,</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineminus">-                                               this.attachment.name]));</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineplus">+    if (attachmentItem) {</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineplus">+      // Remove the loading throbber.</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineplus">+      attachmentItem.image = null;</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineplus">+      attachmentItem.setAttribute(&quot;tooltiptext&quot;, attachmentItem.attachment.url);</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineplus">+      attachmentItem.uploading = false;</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineplus">+      attachmentItem.attachment.sendViaCloud = false;</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineplus">+      delete attachmentItem.cloudFileAccount;</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineplus">+</span>
<a href="#l8.375"></a><span id="l8.375" class="difflineplus">+      let event = document.createEvent(&quot;CustomEvent&quot;);</span>
<a href="#l8.376"></a><span id="l8.376" class="difflineplus">+      event.initEvent(&quot;attachment-upload-failed&quot;, true, true, statusCode);</span>
<a href="#l8.377"></a><span id="l8.377" class="difflineplus">+      attachmentItem.dispatchEvent(event);</span>
<a href="#l8.378"></a><span id="l8.378">     }</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineminus">-  },</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineminus">-</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([&quot;nsIRequestObserver&quot;,</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineminus">-                                          &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineminus">-};</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineplus">+  }</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineplus">+</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineplus">+  gNumUploadingAttachments--;</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineplus">+  updateSendCommands(true);</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineplus">+}</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineplus">+</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineplus">+async function deleteCloudAttachment(attachment, file, cloudFileAccount) {</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineplus">+  try {</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineplus">+    await cloudFileAccount.deleteFile(file);</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineplus">+  } catch (ex) {</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineplus">+    let bundle = getComposeBundle();</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineplus">+    let displayName = cloudFileAccounts.getDisplayName(cloudFileAccount);</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineplus">+    Services.prompt.alert(</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineplus">+      window,</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineplus">+      bundle.getString(&quot;errorCloudFileDeletion.title&quot;),</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineplus">+      bundle.getFormattedString(&quot;errorCloudFileDeletion.message&quot;, [displayName, attachment.name])</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineplus">+    );</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineplus">+  }</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineplus">+}</span>
<a href="#l8.403"></a><span id="l8.403"> </span>
<a href="#l8.404"></a><span id="l8.404"> /**</span>
<a href="#l8.405"></a><span id="l8.405">  * Prompt the user for a list of files to attach via a cloud provider.</span>
<a href="#l8.406"></a><span id="l8.406">  *</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineminus">- * @param aProvider the cloud provider to upload the files to</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineplus">+ * @param aAccount the cloud provider to upload the files to</span>
<a href="#l8.409"></a><span id="l8.409">  */</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineminus">-function attachToCloud(aProvider) {</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineplus">+function attachToCloud(aAccount) {</span>
<a href="#l8.412"></a><span id="l8.412">   // We need to let the user pick local file(s) to upload to the cloud and</span>
<a href="#l8.413"></a><span id="l8.413">   // gather url(s) to those files.</span>
<a href="#l8.414"></a><span id="l8.414">   var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l8.415"></a><span id="l8.415">              .createInstance(Ci.nsIFilePicker);</span>
<a href="#l8.416"></a><span id="l8.416">   fp.init(window, getComposeBundle().getFormattedString(</span>
<a href="#l8.417"></a><span id="l8.417">             &quot;chooseFileToAttachViaCloud&quot;,</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineminus">-            [cloudFileAccounts.getDisplayName(aProvider)]),</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineplus">+            [cloudFileAccounts.getDisplayName(aAccount)]),</span>
<a href="#l8.420"></a><span id="l8.420">           Ci.nsIFilePicker.modeOpenMultiple);</span>
<a href="#l8.421"></a><span id="l8.421"> </span>
<a href="#l8.422"></a><span id="l8.422">   var lastDirectory = GetLastAttachDirectory();</span>
<a href="#l8.423"></a><span id="l8.423">   if (lastDirectory)</span>
<a href="#l8.424"></a><span id="l8.424">     fp.displayDirectory = lastDirectory;</span>
<a href="#l8.425"></a><span id="l8.425"> </span>
<a href="#l8.426"></a><span id="l8.426">   fp.appendFilters(Ci.nsIFilePicker.filterAll);</span>
<a href="#l8.427"></a><span id="l8.427">   fp.open(rv =&gt; {</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineat">@@ -1689,148 +1666,132 @@ function attachToCloud(aProvider) {</span>
<a href="#l8.429"></a><span id="l8.429">       return;</span>
<a href="#l8.430"></a><span id="l8.430">     }</span>
<a href="#l8.431"></a><span id="l8.431"> </span>
<a href="#l8.432"></a><span id="l8.432">     let files = Array.from(fixIterator(fp.files, Ci.nsIFile));</span>
<a href="#l8.433"></a><span id="l8.433">     let attachments = files.map(f =&gt; FileToAttachment(f));</span>
<a href="#l8.434"></a><span id="l8.434"> </span>
<a href="#l8.435"></a><span id="l8.435">     let i = 0;</span>
<a href="#l8.436"></a><span id="l8.436">     AddAttachments(attachments, function(aItem) {</span>
<a href="#l8.437"></a><span id="l8.437" class="difflineminus">-      let listener = new uploadListener(attachments[i], files[i], aProvider);</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineminus">-      try {</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineminus">-        aProvider.uploadFile(files[i], listener);</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineminus">-      } catch (ex) {</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineminus">-        listener.onStopRequest(null, ex.result);</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineminus">-      }</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineplus">+      uploadCloudAttachment(attachments[i], files[i], aAccount);</span>
<a href="#l8.444"></a><span id="l8.444">       i++;</span>
<a href="#l8.445"></a><span id="l8.445">     });</span>
<a href="#l8.446"></a><span id="l8.446"> </span>
<a href="#l8.447"></a><span id="l8.447">     dispatchAttachmentBucketEvent(&quot;attachments-uploading&quot;, attachments);</span>
<a href="#l8.448"></a><span id="l8.448">     SetLastAttachDirectory(files[files.length - 1]);</span>
<a href="#l8.449"></a><span id="l8.449">   });</span>
<a href="#l8.450"></a><span id="l8.450"> }</span>
<a href="#l8.451"></a><span id="l8.451"> </span>
<a href="#l8.452"></a><span id="l8.452"> /**</span>
<a href="#l8.453"></a><span id="l8.453">  * Convert an array of attachments to cloud attachments.</span>
<a href="#l8.454"></a><span id="l8.454">  *</span>
<a href="#l8.455"></a><span id="l8.455">  * @param aItems an array of &lt;attachmentitem&gt;s containing the attachments in</span>
<a href="#l8.456"></a><span id="l8.456">  *        question</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineminus">- * @param aProvider the cloud provider to upload the files to</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineplus">+ * @param aAccount the cloud account to upload the files to</span>
<a href="#l8.459"></a><span id="l8.459">  */</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineminus">-function convertListItemsToCloudAttachment(aItems, aProvider) {</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineplus">+function convertListItemsToCloudAttachment(aItems, aAccount) {</span>
<a href="#l8.462"></a><span id="l8.462">   // If we want to display an offline error message, we should do it here.</span>
<a href="#l8.463"></a><span id="l8.463">   // No sense in doing the delete and upload and having them fail.</span>
<a href="#l8.464"></a><span id="l8.464">   if (Services.io.offline)</span>
<a href="#l8.465"></a><span id="l8.465">     return;</span>
<a href="#l8.466"></a><span id="l8.466"> </span>
<a href="#l8.467"></a><span id="l8.467">   let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l8.468"></a><span id="l8.468">                             .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineminus">-  let convertedAttachments = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineminus">-                               .createInstance(Ci.nsIMutableArray);</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineplus">+  let convertedAttachments = [];</span>
<a href="#l8.472"></a><span id="l8.472"> </span>
<a href="#l8.473"></a><span id="l8.473">   for (let item of aItems) {</span>
<a href="#l8.474"></a><span id="l8.474">     let url = item.attachment.url;</span>
<a href="#l8.475"></a><span id="l8.475"> </span>
<a href="#l8.476"></a><span id="l8.476">     if (item.attachment.sendViaCloud) {</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineminus">-      if (item.cloudProvider &amp;&amp; item.cloudProvider == aProvider)</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineplus">+      if (item.cloudFileAccount &amp;&amp; item.cloudFileAccount == aAccount) {</span>
<a href="#l8.479"></a><span id="l8.479">         continue;</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineplus">+      }</span>
<a href="#l8.481"></a><span id="l8.481">       url = item.originalUrl;</span>
<a href="#l8.482"></a><span id="l8.482">     }</span>
<a href="#l8.483"></a><span id="l8.483"> </span>
<a href="#l8.484"></a><span id="l8.484">     let file = fileHandler.getFileFromURLSpec(url);</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineminus">-    if (item.cloudProvider) {</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineminus">-      item.cloudProvider.deleteFile(</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineminus">-        file, new deletionListener(item.attachment, item.cloudProvider));</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineplus">+    if (item.cloudFileAccount) {</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineplus">+      deleteCloudAttachment(item.attachment, file, item.cloudFileAccount);</span>
<a href="#l8.490"></a><span id="l8.490">     }</span>
<a href="#l8.491"></a><span id="l8.491"> </span>
<a href="#l8.492"></a><span id="l8.492" class="difflineminus">-    let listener = new uploadListener(item.attachment, file, aProvider);</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineminus">-    try {</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineminus">-      aProvider.uploadFile(file, listener);</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineminus">-      convertedAttachments.appendElement(item.attachment);</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineminus">-    } catch (ex) {</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineminus">-      listener.onStopRequest(null, ex.result);</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineminus">-    }</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineplus">+    uploadCloudAttachment(item.attachment, file, aAccount);</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineplus">+    convertedAttachments.push(item.attachment);</span>
<a href="#l8.501"></a><span id="l8.501">   }</span>
<a href="#l8.502"></a><span id="l8.502"> </span>
<a href="#l8.503"></a><span id="l8.503">   if (convertedAttachments.length &gt; 0) {</span>
<a href="#l8.504"></a><span id="l8.504">     dispatchAttachmentBucketEvent(&quot;attachments-converted&quot;, convertedAttachments);</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineminus">-    Services.obs.notifyObservers(convertedAttachments,</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineminus">-                                 &quot;mail:attachmentsConverted&quot;,</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineminus">-                                 aProvider.accountKey);</span>
<a href="#l8.508"></a><span id="l8.508">   }</span>
<a href="#l8.509"></a><span id="l8.509"> }</span>
<a href="#l8.510"></a><span id="l8.510"> </span>
<a href="#l8.511"></a><span id="l8.511"> /**</span>
<a href="#l8.512"></a><span id="l8.512">  * Convert the selected attachments to cloud attachments.</span>
<a href="#l8.513"></a><span id="l8.513">  *</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineminus">- * @param aProvider the cloud provider to upload the files to</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineplus">+ * @param aAccount the cloud account to upload the files to</span>
<a href="#l8.516"></a><span id="l8.516">  */</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineminus">-function convertSelectedToCloudAttachment(aProvider) {</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineplus">+function convertSelectedToCloudAttachment(aAccount) {</span>
<a href="#l8.519"></a><span id="l8.519">   let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineminus">-  convertListItemsToCloudAttachment([...bucket.selectedItems], aProvider);</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineplus">+  convertListItemsToCloudAttachment([...bucket.selectedItems], aAccount);</span>
<a href="#l8.522"></a><span id="l8.522"> }</span>
<a href="#l8.523"></a><span id="l8.523"> </span>
<a href="#l8.524"></a><span id="l8.524"> /**</span>
<a href="#l8.525"></a><span id="l8.525">  * Convert an array of nsIMsgAttachments to cloud attachments.</span>
<a href="#l8.526"></a><span id="l8.526">  *</span>
<a href="#l8.527"></a><span id="l8.527">  * @param aAttachments an array of nsIMsgAttachments</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineminus">- * @param aProvider the cloud provider to upload the files to</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineplus">+ * @param aAccount the cloud account to upload the files to</span>
<a href="#l8.530"></a><span id="l8.530">  */</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineminus">-function convertToCloudAttachment(aAttachments, aProvider) {</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineplus">+function convertToCloudAttachment(aAttachments, aAccount) {</span>
<a href="#l8.533"></a><span id="l8.533">   let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l8.534"></a><span id="l8.534">   let items = [];</span>
<a href="#l8.535"></a><span id="l8.535">   for (let attachment of aAttachments) {</span>
<a href="#l8.536"></a><span id="l8.536">     let item = bucket.findItemForAttachment(attachment);</span>
<a href="#l8.537"></a><span id="l8.537">     if (item)</span>
<a href="#l8.538"></a><span id="l8.538">       items.push(item);</span>
<a href="#l8.539"></a><span id="l8.539">   }</span>
<a href="#l8.540"></a><span id="l8.540"> </span>
<a href="#l8.541"></a><span id="l8.541" class="difflineminus">-  convertListItemsToCloudAttachment(items, aProvider);</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineplus">+  convertListItemsToCloudAttachment(items, aAccount);</span>
<a href="#l8.543"></a><span id="l8.543"> }</span>
<a href="#l8.544"></a><span id="l8.544"> </span>
<a href="#l8.545"></a><span id="l8.545"> /**</span>
<a href="#l8.546"></a><span id="l8.546">  * Convert an array of attachments to regular (non-cloud) attachments.</span>
<a href="#l8.547"></a><span id="l8.547">  *</span>
<a href="#l8.548"></a><span id="l8.548">  * @param aItems an array of &lt;attachmentitem&gt;s containing the attachments in</span>
<a href="#l8.549"></a><span id="l8.549">  *        question</span>
<a href="#l8.550"></a><span id="l8.550">  */</span>
<a href="#l8.551"></a><span id="l8.551"> function convertListItemsToRegularAttachment(aItems) {</span>
<a href="#l8.552"></a><span id="l8.552">   let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l8.553"></a><span id="l8.553">                             .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l8.554"></a><span id="l8.554">   let convertedAttachments = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l8.555"></a><span id="l8.555">                                .createInstance(Ci.nsIMutableArray);</span>
<a href="#l8.556"></a><span id="l8.556"> </span>
<a href="#l8.557"></a><span id="l8.557">   for (let item of aItems) {</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineminus">-    if (!item.attachment.sendViaCloud || !item.cloudProvider)</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineplus">+    if (!item.attachment.sendViaCloud || !item.cloudFileAccount) {</span>
<a href="#l8.560"></a><span id="l8.560">       continue;</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineplus">+    }</span>
<a href="#l8.562"></a><span id="l8.562"> </span>
<a href="#l8.563"></a><span id="l8.563">     let file = fileHandler.getFileFromURLSpec(item.originalUrl);</span>
<a href="#l8.564"></a><span id="l8.564">     try {</span>
<a href="#l8.565"></a><span id="l8.565">       // This will fail for drafts, but we can still send the message</span>
<a href="#l8.566"></a><span id="l8.566">       // with a normal attachment.</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineminus">-      item.cloudProvider.deleteFile(</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineminus">-        file, new deletionListener(item.attachment, item.cloudProvider));</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineplus">+      deleteCloudAttachment(item.attachment, file, item.cloudFileAccount);</span>
<a href="#l8.570"></a><span id="l8.570">     } catch (ex) {</span>
<a href="#l8.571"></a><span id="l8.571">        Cu.reportError(ex);</span>
<a href="#l8.572"></a><span id="l8.572">     }</span>
<a href="#l8.573"></a><span id="l8.573"> </span>
<a href="#l8.574"></a><span id="l8.574">     item.attachment.url = item.originalUrl;</span>
<a href="#l8.575"></a><span id="l8.575">     item.setAttribute(&quot;tooltiptext&quot;, item.attachment.url);</span>
<a href="#l8.576"></a><span id="l8.576">     item.attachment.sendViaCloud = false;</span>
<a href="#l8.577"></a><span id="l8.577"> </span>
<a href="#l8.578"></a><span id="l8.578" class="difflineminus">-    delete item.cloudProvider;</span>
<a href="#l8.579"></a><span id="l8.579" class="difflineplus">+    delete item.cloudFileAccount;</span>
<a href="#l8.580"></a><span id="l8.580">     delete item.originalUrl;</span>
<a href="#l8.581"></a><span id="l8.581">     item.image = null;</span>
<a href="#l8.582"></a><span id="l8.582"> </span>
<a href="#l8.583"></a><span id="l8.583">     convertedAttachments.appendElement(item.attachment);</span>
<a href="#l8.584"></a><span id="l8.584">   }</span>
<a href="#l8.585"></a><span id="l8.585"> </span>
<a href="#l8.586"></a><span id="l8.586">   dispatchAttachmentBucketEvent(&quot;attachments-converted&quot;, convertedAttachments);</span>
<a href="#l8.587"></a><span id="l8.587" class="difflineminus">-  Services.obs.notifyObservers(convertedAttachments,</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineminus">-                               &quot;mail:attachmentsConverted&quot;);</span>
<a href="#l8.589"></a><span id="l8.589"> </span>
<a href="#l8.590"></a><span id="l8.590">   // We leave the content location in for the notifications because</span>
<a href="#l8.591"></a><span id="l8.591">   // it may be needed to identify the attachment. But clear it out now.</span>
<a href="#l8.592"></a><span id="l8.592">   for (let item of aItems)</span>
<a href="#l8.593"></a><span id="l8.593">     delete item.attachment.contentLocation;</span>
<a href="#l8.594"></a><span id="l8.594"> }</span>
<a href="#l8.595"></a><span id="l8.595"> </span>
<a href="#l8.596"></a><span id="l8.596"> /**</span>
<a href="#l8.597"></a><span id="l8.597" class="difflineat">@@ -4335,19 +4296,19 @@ function AddAttachments(aAttachments, aC</span>
<a href="#l8.598"></a><span id="l8.598">       item.setAttribute(&quot;tooltiptext&quot;, decodeURI(attachment.url));</span>
<a href="#l8.599"></a><span id="l8.599">     } catch (e) {</span>
<a href="#l8.600"></a><span id="l8.600">       item.setAttribute(&quot;tooltiptext&quot;, attachment.url);</span>
<a href="#l8.601"></a><span id="l8.601">     }</span>
<a href="#l8.602"></a><span id="l8.602">     item.addEventListener(&quot;command&quot;, OpenSelectedAttachment);</span>
<a href="#l8.603"></a><span id="l8.603"> </span>
<a href="#l8.604"></a><span id="l8.604">     if (attachment.sendViaCloud) {</span>
<a href="#l8.605"></a><span id="l8.605">       try {</span>
<a href="#l8.606"></a><span id="l8.606" class="difflineminus">-        let cloudProvider = cloudFileAccounts.getAccount(attachment.cloudProviderKey);</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineminus">-        item.cloudProvider = cloudProvider;</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineminus">-        item.image = cloudProvider.iconURL;</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineplus">+        let account = cloudFileAccounts.getAccount(attachment.cloudFileAccountKey);</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineplus">+        item.cloudFileAccount = account;</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineplus">+        item.image = account.iconURL;</span>
<a href="#l8.612"></a><span id="l8.612">         item.originalUrl = attachment.url;</span>
<a href="#l8.613"></a><span id="l8.613">       } catch (ex) {</span>
<a href="#l8.614"></a><span id="l8.614">         dump(ex);</span>
<a href="#l8.615"></a><span id="l8.615">       }</span>
<a href="#l8.616"></a><span id="l8.616">     } else {</span>
<a href="#l8.617"></a><span id="l8.617">       // For local file urls, we are better off using the full file url because</span>
<a href="#l8.618"></a><span id="l8.618">       // moz-icon will actually resolve the file url and get the right icon from</span>
<a href="#l8.619"></a><span id="l8.619">       // the file url. All other urls, we should try to extract the file name from</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineat">@@ -4585,26 +4546,26 @@ function RemoveAllAttachments() {</span>
<a href="#l8.621"></a><span id="l8.621">                              .createInstance(Ci.nsIMutableArray);</span>
<a href="#l8.622"></a><span id="l8.622"> </span>
<a href="#l8.623"></a><span id="l8.623">   while (bucket.itemCount &gt; 0) {</span>
<a href="#l8.624"></a><span id="l8.624">     let item = bucket.getItemAtIndex(bucket.itemCount - 1);</span>
<a href="#l8.625"></a><span id="l8.625">     if (item.attachment.size != -1) {</span>
<a href="#l8.626"></a><span id="l8.626">       gAttachmentsSize -= item.attachment.size;</span>
<a href="#l8.627"></a><span id="l8.627">     }</span>
<a href="#l8.628"></a><span id="l8.628"> </span>
<a href="#l8.629"></a><span id="l8.629" class="difflineminus">-    if (item.attachment.sendViaCloud &amp;&amp; item.cloudProvider) {</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineplus">+    if (item.attachment.sendViaCloud &amp;&amp; item.cloudFileAccount) {</span>
<a href="#l8.631"></a><span id="l8.631">       let originalUrl = item.originalUrl;</span>
<a href="#l8.632"></a><span id="l8.632">       if (!originalUrl)</span>
<a href="#l8.633"></a><span id="l8.633">         originalUrl = item.attachment.url;</span>
<a href="#l8.634"></a><span id="l8.634">       let file = fileHandler.getFileFromURLSpec(originalUrl);</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineminus">-      if (item.uploading)</span>
<a href="#l8.636"></a><span id="l8.636" class="difflineminus">-        item.cloudProvider.cancelFileUpload(file);</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineminus">-      else</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineminus">-        item.cloudProvider.deleteFile(file,</span>
<a href="#l8.639"></a><span id="l8.639" class="difflineminus">-          new deletionListener(item.attachment, item.cloudProvider));</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineplus">+      if (item.uploading) {</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineplus">+        item.cloudFileAccount.cancelFileUpload(file);</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineplus">+      } else {</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineplus">+        deleteCloudAttachment(item.attachment, file, item.cloudFileAccount);</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineplus">+      }</span>
<a href="#l8.645"></a><span id="l8.645">     }</span>
<a href="#l8.646"></a><span id="l8.646"> </span>
<a href="#l8.647"></a><span id="l8.647">     removedAttachments.appendElement(item.attachment);</span>
<a href="#l8.648"></a><span id="l8.648">     // Let's release the attachment object hold by the node else it won't go</span>
<a href="#l8.649"></a><span id="l8.649">     // away until the window is destroyed.</span>
<a href="#l8.650"></a><span id="l8.650">     item.attachment = null;</span>
<a href="#l8.651"></a><span id="l8.651">     item.remove();</span>
<a href="#l8.652"></a><span id="l8.652">   }</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineat">@@ -4678,26 +4639,25 @@ function RemoveSelectedAttachment() {</span>
<a href="#l8.654"></a><span id="l8.654">                              .createInstance(Ci.nsIMutableArray);</span>
<a href="#l8.655"></a><span id="l8.655"> </span>
<a href="#l8.656"></a><span id="l8.656">   for (let i = bucket.selectedCount - 1; i &gt;= 0; i--) {</span>
<a href="#l8.657"></a><span id="l8.657">     let item = bucket.getSelectedItem(i);</span>
<a href="#l8.658"></a><span id="l8.658">     if (item.attachment.size != -1) {</span>
<a href="#l8.659"></a><span id="l8.659">       gAttachmentsSize -= item.attachment.size;</span>
<a href="#l8.660"></a><span id="l8.660">     }</span>
<a href="#l8.661"></a><span id="l8.661"> </span>
<a href="#l8.662"></a><span id="l8.662" class="difflineminus">-    if (item.attachment.sendViaCloud &amp;&amp; item.cloudProvider) {</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineplus">+    if (item.attachment.sendViaCloud &amp;&amp; item.cloudFileAccount) {</span>
<a href="#l8.664"></a><span id="l8.664">       let originalUrl = item.originalUrl;</span>
<a href="#l8.665"></a><span id="l8.665">       if (!originalUrl)</span>
<a href="#l8.666"></a><span id="l8.666">         originalUrl = item.attachment.url;</span>
<a href="#l8.667"></a><span id="l8.667">       let file = fileHandler.getFileFromURLSpec(originalUrl);</span>
<a href="#l8.668"></a><span id="l8.668">       if (item.uploading)</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineminus">-        item.cloudProvider.cancelFileUpload(file);</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineplus">+        item.cloudFileAccount.cancelFileUpload(file);</span>
<a href="#l8.671"></a><span id="l8.671">       else</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineminus">-        item.cloudProvider.deleteFile(file,</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineminus">-          new deletionListener(item.attachment, item.cloudProvider));</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineplus">+        deleteCloudAttachment(item.attachment, file, item.cloudFileAccount);</span>
<a href="#l8.675"></a><span id="l8.675">     }</span>
<a href="#l8.676"></a><span id="l8.676"> </span>
<a href="#l8.677"></a><span id="l8.677">     removedAttachments.appendElement(item.attachment);</span>
<a href="#l8.678"></a><span id="l8.678">     // Let's release the attachment object held by the node else it won't go</span>
<a href="#l8.679"></a><span id="l8.679">     // away until the window is destroyed</span>
<a href="#l8.680"></a><span id="l8.680">     item.attachment = null;</span>
<a href="#l8.681"></a><span id="l8.681">     item.remove();</span>
<a href="#l8.682"></a><span id="l8.682">   }</span>
<a href="#l8.683"></a><span id="l8.683" class="difflineat">@@ -6737,19 +6697,21 @@ function getMailToolbox() {</span>
<a href="#l8.684"></a><span id="l8.684"> /**</span>
<a href="#l8.685"></a><span id="l8.685">  * Helper function to dispatch a CustomEvent to the attachmentbucket.</span>
<a href="#l8.686"></a><span id="l8.686">  *</span>
<a href="#l8.687"></a><span id="l8.687">  * @param aEventType the name of the event to fire.</span>
<a href="#l8.688"></a><span id="l8.688">  * @param aData any detail data to pass to the CustomEvent.</span>
<a href="#l8.689"></a><span id="l8.689">  */</span>
<a href="#l8.690"></a><span id="l8.690"> function dispatchAttachmentBucketEvent(aEventType, aData) {</span>
<a href="#l8.691"></a><span id="l8.691">   let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineminus">-  let event = document.createEvent(&quot;CustomEvent&quot;);</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineminus">-  event.initCustomEvent(aEventType, true, true, aData);</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineminus">-  bucket.dispatchEvent(event);</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineplus">+  bucket.dispatchEvent(new CustomEvent(aEventType, {</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineplus">+    bubbles: true,</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineplus">+    cancelable: true,</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineplus">+    detail: aData,</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineplus">+  }));</span>
<a href="#l8.700"></a><span id="l8.700"> }</span>
<a href="#l8.701"></a><span id="l8.701"> </span>
<a href="#l8.702"></a><span id="l8.702"> /** Update state of zoom type (text vs. full) menu item. */</span>
<a href="#l8.703"></a><span id="l8.703"> function UpdateFullZoomMenu() {</span>
<a href="#l8.704"></a><span id="l8.704">   let menuItem = document.getElementById(&quot;menu_fullZoomToggle&quot;);</span>
<a href="#l8.705"></a><span id="l8.705">   menuItem.setAttribute(&quot;checked&quot;, !ZoomManager.useFullZoom);</span>
<a href="#l8.706"></a><span id="l8.706"> }</span>
<a href="#l8.707"></a><span id="l8.707"> </span>
<a href="#l8.708"></a><span id="l8.708" class="difflineat">@@ -6910,17 +6872,17 @@ function onUnblockResource(aURL, aNode) </span>
<a href="#l8.709"></a><span id="l8.709">  *</span>
<a href="#l8.710"></a><span id="l8.710">  * @param {String}  aURL - (necko) URL to unblock</span>
<a href="#l8.711"></a><span id="l8.711">  * @param {Bool}    aReturnDataURL - return data: URL instead of processing image</span>
<a href="#l8.712"></a><span id="l8.712">  * @return {String} the image as data: URL.</span>
<a href="#l8.713"></a><span id="l8.713">  * @throw Error()   if reading the data failed</span>
<a href="#l8.714"></a><span id="l8.714">  */</span>
<a href="#l8.715"></a><span id="l8.715"> function loadBlockedImage(aURL, aReturnDataURL = false) {</span>
<a href="#l8.716"></a><span id="l8.716">   let filename;</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineminus">-  if (/^(file|chrome):/i.test(aURL)) {</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineplus">+  if (/^(file|chrome|moz-extension):/i.test(aURL)) {</span>
<a href="#l8.719"></a><span id="l8.719">     filename = aURL.substr(aURL.lastIndexOf(&quot;/&quot;) + 1);</span>
<a href="#l8.720"></a><span id="l8.720">   } else {</span>
<a href="#l8.721"></a><span id="l8.721">     let fnMatch = /[?&amp;;]filename=([^?&amp;]+)/.exec(aURL);</span>
<a href="#l8.722"></a><span id="l8.722">     filename = (fnMatch &amp;&amp; fnMatch[1]) || &quot;&quot;;</span>
<a href="#l8.723"></a><span id="l8.723">   }</span>
<a href="#l8.724"></a><span id="l8.724">   filename = decodeURIComponent(filename);</span>
<a href="#l8.725"></a><span id="l8.725">   let uri = Services.io.newURI(aURL);</span>
<a href="#l8.726"></a><span id="l8.726">   let contentType;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/components/compose/content/bigFileObserver.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/components/compose/content/bigFileObserver.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l9.5"></a><span id="l9.5">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> /* global MozElements */</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> /* import-globals-from MsgComposeCommands.js */</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15"> var kUploadNotificationValue = &quot;bigAttachmentUploading&quot;;</span>
<a href="#l9.16"></a><span id="l9.16"> var kPrivacyWarningNotificationValue = &quot;bigAttachmentPrivacyWarning&quot;;</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18"> var gBigFileObserver = {</span>
<a href="#l9.19"></a><span id="l9.19">   bigFiles: [],</span>
<a href="#l9.20"></a><span id="l9.20">   sessionHidden: false,</span>
<a href="#l9.21"></a><span id="l9.21">   privacyWarned: false,</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -178,36 +178,54 @@ var gBigFileObserver = {</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24">   openLearnMore() {</span>
<a href="#l9.25"></a><span id="l9.25">     let url = Services.prefs.getCharPref(&quot;mail.cloud_files.learn_more_url&quot;);</span>
<a href="#l9.26"></a><span id="l9.26">     openContentTab(url);</span>
<a href="#l9.27"></a><span id="l9.27">     return true;</span>
<a href="#l9.28"></a><span id="l9.28">   },</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30">   convertAttachments() {</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-    let cloudProvider;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+    let account;</span>
<a href="#l9.33"></a><span id="l9.33">     let accounts = cloudFileAccounts.configuredAccounts;</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35">     if (accounts.length == 1) {</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-      cloudProvider = accounts[0];</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+      account = accounts[0];</span>
<a href="#l9.38"></a><span id="l9.38">     } else if (accounts.length &gt; 1) {</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-      let selection = {};</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+      // We once used Services.prompt.select for this UI, but it doesn't support displaying an</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+      // icon for each item. The following code does the same thing with a replacement dialog.</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+      let { PromptUtils } = ChromeUtils.import(&quot;resource://gre/modules/SharedPromptUtils.jsm&quot;);</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+</span>
<a href="#l9.44"></a><span id="l9.44">       let names = accounts.map(i =&gt; cloudFileAccounts.getDisplayName(i));</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-      if (Services.prompt.select(window,</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-                                 this.formatString(&quot;bigFileChooseAccount.title&quot;),</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-                                 this.formatString(&quot;bigFileChooseAccount.text&quot;),</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-                                 names.length, names, selection))</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-        cloudProvider = accounts[selection.value];</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+      let icons = accounts.map(i =&gt; i.iconURL);</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+      let args = {</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+        promptType: &quot;select&quot;,</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+        title: this.formatString(&quot;bigFileChooseAccount.title&quot;),</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+        text: this.formatString(&quot;bigFileChooseAccount.text&quot;),</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+        list: names,</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+        icons,</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+        selected: -1,</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+        ok: false,</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+      };</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+      let propBag = PromptUtils.objectToPropBag(args);</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+      openDialog(&quot;chrome://messenger/content/cloudfile/selectDialog.xul&quot;,</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+                 &quot;_blank&quot;,</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+                 &quot;centerscreen,chrome,modal,titlebar&quot;,</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+                 propBag);</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+      PromptUtils.propBagToObject(propBag, args);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+      if (args.ok)</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+        account = accounts[args.selected];</span>
<a href="#l9.70"></a><span id="l9.70">     } else {</span>
<a href="#l9.71"></a><span id="l9.71">       openPreferencesTab(&quot;paneApplications&quot;, &quot;attachmentsOutTab&quot;);</span>
<a href="#l9.72"></a><span id="l9.72">       return true;</span>
<a href="#l9.73"></a><span id="l9.73">     }</span>
<a href="#l9.74"></a><span id="l9.74"> </span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-    if (cloudProvider)</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-      convertToCloudAttachment(this.bigFiles, cloudProvider);</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+    if (account)</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+      convertToCloudAttachment(this.bigFiles, account);</span>
<a href="#l9.79"></a><span id="l9.79"> </span>
<a href="#l9.80"></a><span id="l9.80">     return false;</span>
<a href="#l9.81"></a><span id="l9.81">   },</span>
<a href="#l9.82"></a><span id="l9.82"> </span>
<a href="#l9.83"></a><span id="l9.83">   hideNotification() {</span>
<a href="#l9.84"></a><span id="l9.84">     let never = {};</span>
<a href="#l9.85"></a><span id="l9.85">     if (Services.prompt.confirmCheck(window,</span>
<a href="#l9.86"></a><span id="l9.86">                                      this.formatString(&quot;bigFileHideNotification.title&quot;),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/components/compose/content/cloudAttachmentLinkManager.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/components/compose/content/cloudAttachmentLinkManager.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -33,19 +33,19 @@ var gCloudAttachmentLinkManager = {</span>
<a href="#l10.4"></a><span id="l10.4">   handleEvent(event) {</span>
<a href="#l10.5"></a><span id="l10.5">     let mailDoc = document.getElementById(&quot;content-frame&quot;).contentDocument;</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7">     if (event.type == &quot;attachment-uploaded&quot;) {</span>
<a href="#l10.8"></a><span id="l10.8">       if (this.cloudAttachments.length == 0)</span>
<a href="#l10.9"></a><span id="l10.9">         this._insertHeader(mailDoc);</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">       let attachment = event.target.attachment;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-      let provider = event.target.cloudProvider;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+      let account = event.target.cloudFileAccount;</span>
<a href="#l10.14"></a><span id="l10.14">       this.cloudAttachments.push(attachment);</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-      this._insertItem(mailDoc, attachment, provider);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+      this._insertItem(mailDoc, attachment, account);</span>
<a href="#l10.17"></a><span id="l10.17">     } else if (event.type == &quot;attachments-removed&quot; ||</span>
<a href="#l10.18"></a><span id="l10.18">                event.type == &quot;attachments-converted&quot;) {</span>
<a href="#l10.19"></a><span id="l10.19">       let items = [];</span>
<a href="#l10.20"></a><span id="l10.20">       let list = mailDoc.getElementById(&quot;cloudAttachmentList&quot;);</span>
<a href="#l10.21"></a><span id="l10.21">       if (list)</span>
<a href="#l10.22"></a><span id="l10.22">         items = list.getElementsByClassName(&quot;cloudAttachmentItem&quot;);</span>
<a href="#l10.23"></a><span id="l10.23"> </span>
<a href="#l10.24"></a><span id="l10.24">       for (let attachment of fixIterator(</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineat">@@ -346,30 +346,32 @@ var gCloudAttachmentLinkManager = {</span>
<a href="#l10.26"></a><span id="l10.26">     header.textContent = count.replace(&quot;#1&quot;, this.cloudAttachments.length);</span>
<a href="#l10.27"></a><span id="l10.27">   },</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29">   /**</span>
<a href="#l10.30"></a><span id="l10.30">    * Insert the information for a cloud attachment.</span>
<a href="#l10.31"></a><span id="l10.31">    *</span>
<a href="#l10.32"></a><span id="l10.32">    * @param aDocument the document to insert the item into</span>
<a href="#l10.33"></a><span id="l10.33">    * @param aAttachment the nsIMsgAttachment to insert</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-   * @param aProviderType the cloud storage provider</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+   * @param aAccount the cloud storage account</span>
<a href="#l10.36"></a><span id="l10.36">    */</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-  _insertItem(aDocument, aAttachment, aProvider) {</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+  _insertItem(aDocument, aAttachment, aAccount) {</span>
<a href="#l10.39"></a><span id="l10.39">     let list = aDocument.getElementById(&quot;cloudAttachmentList&quot;);</span>
<a href="#l10.40"></a><span id="l10.40"> </span>
<a href="#l10.41"></a><span id="l10.41">     if (!list) {</span>
<a href="#l10.42"></a><span id="l10.42">       this._insertHeader(aDocument);</span>
<a href="#l10.43"></a><span id="l10.43">       list = aDocument.getElementById(&quot;cloudAttachmentList&quot;);</span>
<a href="#l10.44"></a><span id="l10.44">     }</span>
<a href="#l10.45"></a><span id="l10.45"> </span>
<a href="#l10.46"></a><span id="l10.46">     let node = aDocument.createElement(&quot;div&quot;);</span>
<a href="#l10.47"></a><span id="l10.47">     node.className = &quot;cloudAttachmentItem&quot;;</span>
<a href="#l10.48"></a><span id="l10.48">     node.contentLocation = aAttachment.contentLocation;</span>
<a href="#l10.49"></a><span id="l10.49"> </span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+    let provider = cloudFileAccounts.getProviderForType(aAccount.type);</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+</span>
<a href="#l10.52"></a><span id="l10.52">     if (gMsgCompose.composeHTML) {</span>
<a href="#l10.53"></a><span id="l10.53">       node.style.border = &quot;1px solid #CDCDCD&quot;;</span>
<a href="#l10.54"></a><span id="l10.54">       node.style.borderRadius = &quot;5px&quot;;</span>
<a href="#l10.55"></a><span id="l10.55">       node.style.marginTop = &quot;10px&quot;;</span>
<a href="#l10.56"></a><span id="l10.56">       node.style.marginBottom = &quot;10px&quot;;</span>
<a href="#l10.57"></a><span id="l10.57">       node.style.padding = &quot;15px&quot;;</span>
<a href="#l10.58"></a><span id="l10.58"> </span>
<a href="#l10.59"></a><span id="l10.59">       let paperclip = aDocument.createElement(&quot;img&quot;);</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineat">@@ -391,59 +393,64 @@ var gCloudAttachmentLinkManager = {</span>
<a href="#l10.61"></a><span id="l10.61">       size.style.marginLeft = &quot;5px&quot;;</span>
<a href="#l10.62"></a><span id="l10.62">       size.style.fontSize = &quot;small&quot;;</span>
<a href="#l10.63"></a><span id="l10.63">       size.style.color = &quot;grey&quot;;</span>
<a href="#l10.64"></a><span id="l10.64">       node.appendChild(size);</span>
<a href="#l10.65"></a><span id="l10.65"> </span>
<a href="#l10.66"></a><span id="l10.66">       let providerIdentity = aDocument.createElement(&quot;span&quot;);</span>
<a href="#l10.67"></a><span id="l10.67">       providerIdentity.style.cssFloat = &quot;right&quot;;</span>
<a href="#l10.68"></a><span id="l10.68"> </span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-      if (aProvider.iconURL) {</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+      if (provider.iconURL) {</span>
<a href="#l10.71"></a><span id="l10.71">         let providerIcon = aDocument.createElement(&quot;img&quot;);</span>
<a href="#l10.72"></a><span id="l10.72">         providerIcon.style.marginRight = &quot;5px&quot;;</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+        providerIcon.style.maxWidth = &quot;24px&quot;;</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+        providerIcon.style.maxHeight = &quot;24px&quot;;</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+        providerIcon.style.verticalAlign = &quot;middle&quot;;</span>
<a href="#l10.76"></a><span id="l10.76">         providerIdentity.appendChild(providerIcon);</span>
<a href="#l10.77"></a><span id="l10.77"> </span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-        if (!/^chrome:\/\//i.test(aProvider.iconURL)) {</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-          providerIcon.src = aProvider.iconURL;</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+        if (!/^(chrome|moz-extension):\/\//i.test(provider.iconURL)) {</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+          providerIcon.src = provider.iconURL;</span>
<a href="#l10.82"></a><span id="l10.82">         } else {</span>
<a href="#l10.83"></a><span id="l10.83">           try {</span>
<a href="#l10.84"></a><span id="l10.84">             // Let's use the goodness from MsgComposeCommands.js since we're</span>
<a href="#l10.85"></a><span id="l10.85">             // sitting right in a compose window.</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-            providerIcon.src = window.loadBlockedImage(aProvider.iconURL, true);</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+            providerIcon.src = window.loadBlockedImage(provider.iconURL, true);</span>
<a href="#l10.88"></a><span id="l10.88">           } catch (e) {</span>
<a href="#l10.89"></a><span id="l10.89">             // Couldn't load the referenced image.</span>
<a href="#l10.90"></a><span id="l10.90">             Cu.reportError(e);</span>
<a href="#l10.91"></a><span id="l10.91">           }</span>
<a href="#l10.92"></a><span id="l10.92">         }</span>
<a href="#l10.93"></a><span id="l10.93">       }</span>
<a href="#l10.94"></a><span id="l10.94"> </span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-      if (aProvider.serviceURL) {</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-        let providerLink = this._generateLink(aDocument, aProvider.displayName,</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-                                              aProvider.serviceURL);</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+      if (provider.serviceURL) {</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+        let providerLink = this._generateLink(aDocument, provider.displayName,</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+                                              provider.serviceURL);</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+        providerLink.style.verticalAlign = &quot;middle&quot;;</span>
<a href="#l10.102"></a><span id="l10.102">         providerIdentity.appendChild(providerLink);</span>
<a href="#l10.103"></a><span id="l10.103">       } else {</span>
<a href="#l10.104"></a><span id="l10.104">         let providerName = aDocument.createElement(&quot;span&quot;);</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-        providerName.textContent = aProvider.displayName;</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+        providerName.textContent = provider.displayName;</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+        providerName.style.verticalAlign = &quot;middle&quot;;</span>
<a href="#l10.108"></a><span id="l10.108">         providerIdentity.appendChild(providerName);</span>
<a href="#l10.109"></a><span id="l10.109">       }</span>
<a href="#l10.110"></a><span id="l10.110"> </span>
<a href="#l10.111"></a><span id="l10.111">       node.appendChild(providerIdentity);</span>
<a href="#l10.112"></a><span id="l10.112"> </span>
<a href="#l10.113"></a><span id="l10.113">       let downloadUrl = this._generateLink(aDocument,</span>
<a href="#l10.114"></a><span id="l10.114">                                            aAttachment.contentLocation,</span>
<a href="#l10.115"></a><span id="l10.115">                                            aAttachment.contentLocation);</span>
<a href="#l10.116"></a><span id="l10.116">       downloadUrl.style.fontSize = &quot;small&quot;;</span>
<a href="#l10.117"></a><span id="l10.117">       downloadUrl.style.display = &quot;block&quot;;</span>
<a href="#l10.118"></a><span id="l10.118"> </span>
<a href="#l10.119"></a><span id="l10.119">       node.appendChild(downloadUrl);</span>
<a href="#l10.120"></a><span id="l10.120">     } else {</span>
<a href="#l10.121"></a><span id="l10.121">       node.textContent = getComposeBundle().getFormattedString(</span>
<a href="#l10.122"></a><span id="l10.122">         &quot;cloudAttachmentListItem&quot;,</span>
<a href="#l10.123"></a><span id="l10.123">         [aAttachment.name, gMessenger.formatFileSize(aAttachment.size),</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-         aProvider.displayName,</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+         provider.displayName,</span>
<a href="#l10.126"></a><span id="l10.126">          aAttachment.contentLocation]);</span>
<a href="#l10.127"></a><span id="l10.127">     }</span>
<a href="#l10.128"></a><span id="l10.128"> </span>
<a href="#l10.129"></a><span id="l10.129">     this._updateAttachmentCount(aDocument);</span>
<a href="#l10.130"></a><span id="l10.130">     list.appendChild(node);</span>
<a href="#l10.131"></a><span id="l10.131">   },</span>
<a href="#l10.132"></a><span id="l10.132"> </span>
<a href="#l10.133"></a><span id="l10.133">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/components/compose/content/messengercompose.xul</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/components/compose/content/messengercompose.xul</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -274,17 +274,17 @@</span>
<a href="#l11.4"></a><span id="l11.4">     &lt;command id=&quot;cmd_removeList&quot; oncommand=&quot;goDoCommand('cmd_removeList')&quot;/&gt;</span>
<a href="#l11.5"></a><span id="l11.5">     &lt;!-- cmd_ul and cmd_ol are shared with toolbar and are in composerStyleMenuItems commandset --&gt;</span>
<a href="#l11.6"></a><span id="l11.6">   &lt;/commandset&gt;</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8">   &lt;!-- File Menu --&gt;</span>
<a href="#l11.9"></a><span id="l11.9">   &lt;command id=&quot;cmd_new&quot; oncommand=&quot;goDoCommand('cmd_newMessage')&quot;/&gt;</span>
<a href="#l11.10"></a><span id="l11.10">   &lt;command id=&quot;cmd_attachFile&quot; oncommand=&quot;goDoCommand('cmd_attachFile')&quot;/&gt;</span>
<a href="#l11.11"></a><span id="l11.11">   &lt;command id=&quot;cmd_attachCloud&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-           oncommand=&quot;attachToCloud(event.target.cloudProvider);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+           oncommand=&quot;attachToCloud(event.target.cloudFileAccount);</span>
<a href="#l11.14"></a><span id="l11.14">                       event.stopPropagation();&quot;/&gt;</span>
<a href="#l11.15"></a><span id="l11.15">   &lt;command id=&quot;cmd_attachPage&quot; oncommand=&quot;goDoCommand('cmd_attachPage')&quot;/&gt;</span>
<a href="#l11.16"></a><span id="l11.16">   &lt;command id=&quot;cmd_attachVCard&quot; checked=&quot;false&quot;</span>
<a href="#l11.17"></a><span id="l11.17">            oncommand=&quot;ToggleAttachVCard(event.target)&quot;/&gt;</span>
<a href="#l11.18"></a><span id="l11.18">   &lt;command id=&quot;cmd_remindLater&quot; checked=&quot;false&quot;</span>
<a href="#l11.19"></a><span id="l11.19">            oncommand=&quot;toggleAttachmentReminder()&quot;/&gt;</span>
<a href="#l11.20"></a><span id="l11.20">   &lt;command id=&quot;cmd_close&quot; oncommand=&quot;goDoCommand('cmd_close')&quot;/&gt;</span>
<a href="#l11.21"></a><span id="l11.21">   &lt;command id=&quot;cmd_saveDefault&quot; oncommand=&quot;goDoCommand('cmd_saveDefault')&quot;/&gt;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -378,17 +378,17 @@</span>
<a href="#l11.23"></a><span id="l11.23">   &lt;command id=&quot;zoomWindow&quot; label=&quot;&amp;zoomWindow.label;&quot; oncommand=&quot;zoomWindow();&quot;/&gt;</span>
<a href="#l11.24"></a><span id="l11.24">   &lt;command id=&quot;Tasks:Mail&quot; oncommand=&quot;toMessengerWindow();&quot;/&gt;</span>
<a href="#l11.25"></a><span id="l11.25">   &lt;command id=&quot;Tasks:AddressBook&quot; oncommand=&quot;toAddressBook();&quot;/&gt;</span>
<a href="#l11.26"></a><span id="l11.26"> #endif</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28">   &lt;command id=&quot;cmd_CustomizeComposeToolbar&quot;</span>
<a href="#l11.29"></a><span id="l11.29">            oncommand=&quot;CustomizeMailToolbar('compose-toolbox', 'CustomizeComposeToolbar')&quot;/&gt;</span>
<a href="#l11.30"></a><span id="l11.30"> </span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-  &lt;command id=&quot;cmd_convertCloud&quot; oncommand=&quot;convertSelectedToCloudAttachment(event.target.cloudProvider); event.stopPropagation();&quot;/&gt;</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+  &lt;command id=&quot;cmd_convertCloud&quot; oncommand=&quot;convertSelectedToCloudAttachment(event.target.cloudFileAccount); event.stopPropagation();&quot;/&gt;</span>
<a href="#l11.33"></a><span id="l11.33">   &lt;command id=&quot;cmd_convertAttachment&quot; oncommand=&quot;goDoCommand('cmd_convertAttachment')&quot;/&gt;</span>
<a href="#l11.34"></a><span id="l11.34">   &lt;command id=&quot;cmd_cancelUpload&quot; oncommand=&quot;goDoCommand('cmd_cancelUpload')&quot;/&gt;</span>
<a href="#l11.35"></a><span id="l11.35">   &lt;command id=&quot;cmd_customizeFromAddress&quot; oncommand=&quot;MakeFromFieldEditable();&quot;</span>
<a href="#l11.36"></a><span id="l11.36">            checked=&quot;false&quot; label=&quot;&amp;customizeFromAddress.label;&quot;/&gt;</span>
<a href="#l11.37"></a><span id="l11.37"> &lt;/commandset&gt;</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39">   &lt;command id=&quot;cmd_doNotRemindForAttachments&quot; oncommand=&quot;disableAttachmentReminder();&quot;/&gt;</span>
<a href="#l11.40"></a><span id="l11.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-cloudFile.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-cloudFile.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.5"></a><span id="l12.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.6"></a><span id="l12.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> &quot;use strict&quot;;</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10"> var {ExtensionParent} = ChromeUtils.import(&quot;resource://gre/modules/ExtensionParent.jsm&quot;);</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l12.13"></a><span id="l12.13"> </span>
<a href="#l12.14"></a><span id="l12.14"> // eslint-disable-next-line mozilla/reject-importGlobalProperties</span>
<a href="#l12.15"></a><span id="l12.15"> Cu.importGlobalProperties([&quot;File&quot;, &quot;FileReader&quot;]);</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17"> async function promiseFileRead(nsifile) {</span>
<a href="#l12.18"></a><span id="l12.18">   let blob = await File.createFromNsIFile(nsifile);</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20">   return new Promise((resolve, reject) =&gt; {</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineat">@@ -47,19 +47,16 @@ class CloudFileAccount {</span>
<a href="#l12.22"></a><span id="l12.22">     return `ext-${this.extension.id}`;</span>
<a href="#l12.23"></a><span id="l12.23">   }</span>
<a href="#l12.24"></a><span id="l12.24">   get displayName() {</span>
<a href="#l12.25"></a><span id="l12.25">     return Services.prefs.getCharPref(</span>
<a href="#l12.26"></a><span id="l12.26">       `mail.cloud_files.accounts.${this.accountKey}.displayName`,</span>
<a href="#l12.27"></a><span id="l12.27">       this.extension.manifest.cloud_file.name</span>
<a href="#l12.28"></a><span id="l12.28">     );</span>
<a href="#l12.29"></a><span id="l12.29">   }</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-  get serviceURL() {</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-    return this.extension.manifest.cloud_file.service_url;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-  }</span>
<a href="#l12.33"></a><span id="l12.33">   get iconURL() {</span>
<a href="#l12.34"></a><span id="l12.34">     if (this.extension.manifest.icons) {</span>
<a href="#l12.35"></a><span id="l12.35">       let { icon } = ExtensionParent.IconDetails.getPreferredIcon(</span>
<a href="#l12.36"></a><span id="l12.36">         this.extension.manifest.icons, this.extension, 32</span>
<a href="#l12.37"></a><span id="l12.37">       );</span>
<a href="#l12.38"></a><span id="l12.38">       return this.extension.baseURI.resolve(icon);</span>
<a href="#l12.39"></a><span id="l12.39">     }</span>
<a href="#l12.40"></a><span id="l12.40">     return &quot;chrome://messenger/content/extension.svg&quot;;</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineat">@@ -82,112 +79,77 @@ class CloudFileAccount {</span>
<a href="#l12.42"></a><span id="l12.42">       this._configured = value;</span>
<a href="#l12.43"></a><span id="l12.43">       cloudFileAccounts.emit(&quot;accountConfigured&quot;, this);</span>
<a href="#l12.44"></a><span id="l12.44">     }</span>
<a href="#l12.45"></a><span id="l12.45">   }</span>
<a href="#l12.46"></a><span id="l12.46">   get createNewAccountUrl() {</span>
<a href="#l12.47"></a><span id="l12.47">     return this.extension.manifest.cloud_file.new_account_url;</span>
<a href="#l12.48"></a><span id="l12.48">   }</span>
<a href="#l12.49"></a><span id="l12.49"> </span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-  async uploadFile(file, callback) {</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+  async uploadFile(file) {</span>
<a href="#l12.52"></a><span id="l12.52">     let id = this._nextId++;</span>
<a href="#l12.53"></a><span id="l12.53">     let results;</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55">     try {</span>
<a href="#l12.56"></a><span id="l12.56">       let buffer = await promiseFileRead(file);</span>
<a href="#l12.57"></a><span id="l12.57"> </span>
<a href="#l12.58"></a><span id="l12.58">       this._fileIds.set(file.path, id);</span>
<a href="#l12.59"></a><span id="l12.59">       results = await this.extension.emit(&quot;uploadFile&quot;, this, {</span>
<a href="#l12.60"></a><span id="l12.60">         id,</span>
<a href="#l12.61"></a><span id="l12.61">         name: file.leafName,</span>
<a href="#l12.62"></a><span id="l12.62">         data: buffer,</span>
<a href="#l12.63"></a><span id="l12.63">       });</span>
<a href="#l12.64"></a><span id="l12.64">     } catch (ex) {</span>
<a href="#l12.65"></a><span id="l12.65">       if (ex.result == 0x80530014) { // NS_ERROR_DOM_ABORT_ERR</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-        callback.onStopRequest(null, cloudFileAccounts.constants.uploadCancelled);</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+        throw cloudFileAccounts.constants.uploadCancelled;</span>
<a href="#l12.68"></a><span id="l12.68">       } else {</span>
<a href="#l12.69"></a><span id="l12.69">         console.error(ex);</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-        callback.onStopRequest(null, cloudFileAccounts.constants.uploadErr);</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+        throw cloudFileAccounts.constants.uploadErr;</span>
<a href="#l12.72"></a><span id="l12.72">       }</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-      return;</span>
<a href="#l12.74"></a><span id="l12.74">     }</span>
<a href="#l12.75"></a><span id="l12.75"> </span>
<a href="#l12.76"></a><span id="l12.76">     if (results &amp;&amp; results.length &gt; 0) {</span>
<a href="#l12.77"></a><span id="l12.77">       if (results[0].aborted) {</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-        callback.onStopRequest(null, cloudFileAccounts.constants.uploadCancelled);</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-        return;</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+        throw cloudFileAccounts.constants.uploadCancelled;</span>
<a href="#l12.81"></a><span id="l12.81">       }</span>
<a href="#l12.82"></a><span id="l12.82"> </span>
<a href="#l12.83"></a><span id="l12.83">       let url = results[0].url;</span>
<a href="#l12.84"></a><span id="l12.84">       this._fileUrls.set(file.path, url);</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineminus">-      callback.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l12.86"></a><span id="l12.86">     } else {</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-      callback.onStopRequest(null, cloudFileAccounts.constants.uploadErr);</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-      throw new ExtensionUtils.ExtensionError(</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineminus">-        `Missing cloudFile.onFileUpload listener for ${this.extension.id}`</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-      );</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+      console.error(`Missing cloudFile.onFileUpload listener for ${this.extension.id}`);</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+      throw cloudFileAccounts.constants.uploadErr;</span>
<a href="#l12.93"></a><span id="l12.93">     }</span>
<a href="#l12.94"></a><span id="l12.94">   }</span>
<a href="#l12.95"></a><span id="l12.95"> </span>
<a href="#l12.96"></a><span id="l12.96">   urlForFile(file) {</span>
<a href="#l12.97"></a><span id="l12.97">     return this._fileUrls.get(file.path);</span>
<a href="#l12.98"></a><span id="l12.98">   }</span>
<a href="#l12.99"></a><span id="l12.99"> </span>
<a href="#l12.100"></a><span id="l12.100">   cancelFileUpload(file) {</span>
<a href="#l12.101"></a><span id="l12.101">     this.extension.emit(&quot;uploadAbort&quot;, this, {</span>
<a href="#l12.102"></a><span id="l12.102">       id: this._fileIds.get(file.path),</span>
<a href="#l12.103"></a><span id="l12.103">     });</span>
<a href="#l12.104"></a><span id="l12.104">   }</span>
<a href="#l12.105"></a><span id="l12.105"> </span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-  refreshUserInfo(withUI, callback) {</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-    if (Services.io.offline) {</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-    }</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-    callback.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-  }</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineminus">-  async deleteFile(file, callback) {</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+  async deleteFile(file) {</span>
<a href="#l12.115"></a><span id="l12.115">     let results;</span>
<a href="#l12.116"></a><span id="l12.116">     try {</span>
<a href="#l12.117"></a><span id="l12.117">       if (this._fileIds.has(file.path)) {</span>
<a href="#l12.118"></a><span id="l12.118">         let id = this._fileIds.get(file.path);</span>
<a href="#l12.119"></a><span id="l12.119">         results = await this.extension.emit(&quot;deleteFile&quot;, this, { id });</span>
<a href="#l12.120"></a><span id="l12.120">       }</span>
<a href="#l12.121"></a><span id="l12.121">     } catch (ex) {</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineminus">-      callback.onStopRequest(null, Cr.NS_ERROR_FAILURE);</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+      throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l12.124"></a><span id="l12.124">     }</span>
<a href="#l12.125"></a><span id="l12.125"> </span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">-    if (results &amp;&amp; results.length &gt; 0) {</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-      callback.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineminus">-    } else {</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineminus">-      callback.onStopRequest(null, Cr.NS_ERROR_FAILURE);</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineminus">-      throw new ExtensionUtils.ExtensionError(</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineminus">-        `Missing cloudFile.onFileDeleted listener for ${this.extension.id}`</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">-      );</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+    if (!results || results.length == 0) {</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+      console.error(`Missing cloudFile.onFileDeleted listener for ${this.extension.id}`);</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+      throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l12.136"></a><span id="l12.136">     }</span>
<a href="#l12.137"></a><span id="l12.137">   }</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineminus">-</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineminus">-  createNewAccount(...args) {</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineminus">-    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineminus">-  }</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineminus">-</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineminus">-  createExistingAccount(callback) {</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineminus">-    if (Services.io.offline) {</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineminus">-      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-    }</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineminus">-    // We're assuming everything is ok here.</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineminus">-    callback.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineminus">-  }</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-  providerUrlForError(error) {</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-    return &quot;&quot;;</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineminus">-  }</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineminus">-</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineminus">-  overrideUrls(count, urls) {</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-  }</span>
<a href="#l12.157"></a><span id="l12.157"> }</span>
<a href="#l12.158"></a><span id="l12.158"> </span>
<a href="#l12.159"></a><span id="l12.159"> function convertCloudFileAccount(nativeAccount) {</span>
<a href="#l12.160"></a><span id="l12.160">   return {</span>
<a href="#l12.161"></a><span id="l12.161">     id: nativeAccount.accountKey,</span>
<a href="#l12.162"></a><span id="l12.162">     name: nativeAccount.displayName,</span>
<a href="#l12.163"></a><span id="l12.163">     configured: nativeAccount.configured,</span>
<a href="#l12.164"></a><span id="l12.164">     uploadSizeLimit: nativeAccount.fileUploadSizeLimit,</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineat">@@ -213,24 +175,30 @@ this.cloudFile = class extends Extension</span>
<a href="#l12.166"></a><span id="l12.166">           if (extension.manifest.icons) {</span>
<a href="#l12.167"></a><span id="l12.167">             let { icon } = ExtensionParent.IconDetails.getPreferredIcon(</span>
<a href="#l12.168"></a><span id="l12.168">               extension.manifest.icons, extension, 32</span>
<a href="#l12.169"></a><span id="l12.169">             );</span>
<a href="#l12.170"></a><span id="l12.170">             return extension.baseURI.resolve(icon);</span>
<a href="#l12.171"></a><span id="l12.171">           }</span>
<a href="#l12.172"></a><span id="l12.172">           return &quot;chrome://messenger/content/extension.svg&quot;;</span>
<a href="#l12.173"></a><span id="l12.173">         },</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+        get serviceURL() {</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+          return extension.manifest.cloud_file.service_url;</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+        },</span>
<a href="#l12.177"></a><span id="l12.177">         initAccount(accountKey) {</span>
<a href="#l12.178"></a><span id="l12.178">           return new CloudFileAccount(accountKey, extension);</span>
<a href="#l12.179"></a><span id="l12.179">         },</span>
<a href="#l12.180"></a><span id="l12.180">       });</span>
<a href="#l12.181"></a><span id="l12.181">     }</span>
<a href="#l12.182"></a><span id="l12.182">   }</span>
<a href="#l12.183"></a><span id="l12.183"> </span>
<a href="#l12.184"></a><span id="l12.184" class="difflineminus">-  onShutdown() {</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+  onShutdown(reason) {</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+    if (reason == &quot;APP_SHUTDOWN&quot;) {</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+      return;</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+    }</span>
<a href="#l12.189"></a><span id="l12.189">     cloudFileAccounts.unregisterProvider(this.providerType);</span>
<a href="#l12.190"></a><span id="l12.190">   }</span>
<a href="#l12.191"></a><span id="l12.191"> </span>
<a href="#l12.192"></a><span id="l12.192">   getAPI(context) {</span>
<a href="#l12.193"></a><span id="l12.193">     let self = this;</span>
<a href="#l12.194"></a><span id="l12.194">     return {</span>
<a href="#l12.195"></a><span id="l12.195">       cloudFile: {</span>
<a href="#l12.196"></a><span id="l12.196">         onFileUpload: new EventManager({</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l13.4"></a><span id="l13.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.5"></a><span id="l13.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.6"></a><span id="l13.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> &quot;use strict&quot;;</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l13.12"></a><span id="l13.12"> var {ExtensionTestUtils} = ChromeUtils.import(&quot;resource://testing-common/ExtensionXPCShellUtils.jsm&quot;);</span>
<a href="#l13.13"></a><span id="l13.13"> </span>
<a href="#l13.14"></a><span id="l13.14"> ExtensionTestUtils.init(this);</span>
<a href="#l13.15"></a><span id="l13.15"> </span>
<a href="#l13.16"></a><span id="l13.16"> add_task(async () =&gt; {</span>
<a href="#l13.17"></a><span id="l13.17">   async function background() {</span>
<a href="#l13.18"></a><span id="l13.18">     function createCloudfileAccount() {</span>
<a href="#l13.19"></a><span id="l13.19">       return new Promise((resolve) =&gt; {</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineat">@@ -208,53 +208,46 @@ add_task(async () =&gt; {</span>
<a href="#l13.21"></a><span id="l13.21">   });</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23">   let testFiles = {</span>
<a href="#l13.24"></a><span id="l13.24">     &quot;cloudFile1&quot;: do_get_file(&quot;data/cloudFile1.txt&quot;),</span>
<a href="#l13.25"></a><span id="l13.25">     &quot;cloudFile2&quot;: do_get_file(&quot;data/cloudFile2.txt&quot;),</span>
<a href="#l13.26"></a><span id="l13.26">   };</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28">   extension.onMessage(&quot;createAccount&quot;, (id = &quot;ext-cloudfile@xpcshell&quot;) =&gt; {</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-    cloudFileAccounts.createAccount(id, {</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-      onStartRequest() {},</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-      onStopRequest() {},</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-    }, null);</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+    cloudFileAccounts.createAccount(id);</span>
<a href="#l13.34"></a><span id="l13.34">   });</span>
<a href="#l13.35"></a><span id="l13.35"> </span>
<a href="#l13.36"></a><span id="l13.36">   extension.onMessage(&quot;removeAccount&quot;, (id) =&gt; {</span>
<a href="#l13.37"></a><span id="l13.37">     cloudFileAccounts.removeAccount(id);</span>
<a href="#l13.38"></a><span id="l13.38">   });</span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40">   extension.onMessage(&quot;uploadFile&quot;, (accountId, filename, expected = Cr.NS_OK) =&gt; {</span>
<a href="#l13.41"></a><span id="l13.41">     let account = cloudFileAccounts.getAccount(accountId);</span>
<a href="#l13.42"></a><span id="l13.42"> </span>
<a href="#l13.43"></a><span id="l13.43">     if (typeof expected == &quot;string&quot;) {</span>
<a href="#l13.44"></a><span id="l13.44">       expected = cloudFileAccounts.constants[expected];</span>
<a href="#l13.45"></a><span id="l13.45">     }</span>
<a href="#l13.46"></a><span id="l13.46"> </span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-    account.uploadFile(testFiles[filename], {</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-      onStartRequest() {},</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-      onStopRequest(req, status) {</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-        Assert.equal(status, expected);</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-      },</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+    account.uploadFile(testFiles[filename]).then(() =&gt; {</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+      Assert.equal(Cr.NS_OK, expected);</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+    }, (status) =&gt; {</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+      Assert.equal(status, expected);</span>
<a href="#l13.56"></a><span id="l13.56">     });</span>
<a href="#l13.57"></a><span id="l13.57">   });</span>
<a href="#l13.58"></a><span id="l13.58"> </span>
<a href="#l13.59"></a><span id="l13.59">   extension.onMessage(&quot;cancelUpload&quot;, (id) =&gt; {</span>
<a href="#l13.60"></a><span id="l13.60">     let account = cloudFileAccounts.getAccount(id);</span>
<a href="#l13.61"></a><span id="l13.61">     account.cancelFileUpload(testFiles.cloudFile2);</span>
<a href="#l13.62"></a><span id="l13.62">   });</span>
<a href="#l13.63"></a><span id="l13.63"> </span>
<a href="#l13.64"></a><span id="l13.64">   extension.onMessage(&quot;deleteFile&quot;, (id) =&gt; {</span>
<a href="#l13.65"></a><span id="l13.65">     let account = cloudFileAccounts.getAccount(id);</span>
<a href="#l13.66"></a><span id="l13.66"> </span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-    account.deleteFile(testFiles.cloudFile1, {</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-      onStartRequest() {},</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-      onStopRequest() {},</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-    });</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+    account.deleteFile(testFiles.cloudFile1);</span>
<a href="#l13.72"></a><span id="l13.72">   });</span>
<a href="#l13.73"></a><span id="l13.73"> </span>
<a href="#l13.74"></a><span id="l13.74">   Assert.ok(!cloudFileAccounts.getProviderForType(&quot;ext-cloudfile@xpcshell&quot;));</span>
<a href="#l13.75"></a><span id="l13.75">   await extension.startup();</span>
<a href="#l13.76"></a><span id="l13.76">   Assert.ok(cloudFileAccounts.getProviderForType(&quot;ext-cloudfile@xpcshell&quot;));</span>
<a href="#l13.77"></a><span id="l13.77">   Assert.equal(cloudFileAccounts.accounts.length, 1);</span>
<a href="#l13.78"></a><span id="l13.78"> </span>
<a href="#l13.79"></a><span id="l13.79">   await extension.awaitFinish(&quot;cloudFile&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/components/preferences/applications.inc.xul</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/components/preferences/applications.inc.xul</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -99,39 +99,51 @@</span>
<a href="#l14.4"></a><span id="l14.4">           &lt;/vbox&gt;</span>
<a href="#l14.5"></a><span id="l14.5">         &lt;/tabpanel&gt;</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7">         &lt;tabpanel orient=&quot;vertical&quot;&gt;</span>
<a href="#l14.8"></a><span id="l14.8">           &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l14.9"></a><span id="l14.9">             &lt;hbox id=&quot;cloudFileToggleAndThreshold&quot; align=&quot;center&quot;&gt;</span>
<a href="#l14.10"></a><span id="l14.10">               &lt;checkbox id=&quot;enableThreshold&quot;</span>
<a href="#l14.11"></a><span id="l14.11">                         label=&quot;&amp;enableCloudFileAccountOffer.label;&quot;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-                        preference=&quot;mail.compose.big_attachments.notify&quot;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-                        oncommand=&quot;gCloudFileTab.updateThreshold();&quot;/&gt;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+                        preference=&quot;mail.compose.big_attachments.notify&quot;/&gt;</span>
<a href="#l14.15"></a><span id="l14.15">               &lt;textbox id=&quot;cloudFileThreshold&quot; type=&quot;number&quot; increment=&quot;1&quot;</span>
<a href="#l14.16"></a><span id="l14.16">                        maxlength=&quot;4&quot; size=&quot;2&quot;</span>
<a href="#l14.17"></a><span id="l14.17">                        preference=&quot;mail.compose.big_attachments.threshold_kb&quot;</span>
<a href="#l14.18"></a><span id="l14.18">                        onsyncfrompreference=&quot;return gCloudFileTab.readThreshold();&quot;</span>
<a href="#l14.19"></a><span id="l14.19">                        onsynctopreference=&quot;return gCloudFileTab.writeThreshold();&quot;/&gt;</span>
<a href="#l14.20"></a><span id="l14.20">               &lt;label control=&quot;cloudFileThreshold&quot;</span>
<a href="#l14.21"></a><span id="l14.21">                      value=&quot;&amp;enableCloudFileAccountOffer.mb;&quot;/&gt;</span>
<a href="#l14.22"></a><span id="l14.22">             &lt;/hbox&gt;</span>
<a href="#l14.23"></a><span id="l14.23">             &lt;hbox flex=&quot;1&quot;&gt;</span>
<a href="#l14.24"></a><span id="l14.24">               &lt;vbox id=&quot;provider-listing&quot;&gt;</span>
<a href="#l14.25"></a><span id="l14.25">                 &lt;richlistbox id=&quot;cloudFileView&quot; orient=&quot;vertical&quot; flex=&quot;1&quot;</span>
<a href="#l14.26"></a><span id="l14.26">                              seltype=&quot;single&quot;</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+                             onoverflow=&quot;gCloudFileTab.onListOverflow();&quot;</span>
<a href="#l14.28"></a><span id="l14.28">                              onselect=&quot;gCloudFileTab.onSelectionChanged(event);&quot;&gt;</span>
<a href="#l14.29"></a><span id="l14.29">                 &lt;/richlistbox&gt;</span>
<a href="#l14.30"></a><span id="l14.30">                 &lt;vbox id=&quot;addCloudFileAccountButtons&quot;&gt;</span>
<a href="#l14.31"></a><span id="l14.31">                 &lt;/vbox&gt;</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+                &lt;menulist id=&quot;addCloudFileAccount&quot;</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+                          hidden=&quot;true&quot;</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+                          label=&quot;&amp;addCloudFileAccount1.label;&quot;</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+                          accesskey=&quot;&amp;addCloudFileAccount1.accesskey;&quot;</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+                          defaultlabel=&quot;&amp;addCloudFileAccount1.label;&quot;</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+                          oncommand=&quot;gCloudFileTab.addCloudFileAccount(this.value);&quot;&gt;</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+                  &lt;menupopup id=&quot;addCloudFileAccountListItems&quot;/&gt;</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+                &lt;/menulist&gt;</span>
<a href="#l14.40"></a><span id="l14.40">                 &lt;button id=&quot;removeCloudFileAccount&quot;</span>
<a href="#l14.41"></a><span id="l14.41">                         disabled=&quot;true&quot;</span>
<a href="#l14.42"></a><span id="l14.42">                         label=&quot;&amp;removeCloudFileAccount.label;&quot;</span>
<a href="#l14.43"></a><span id="l14.43">                         accesskey=&quot;&amp;removeCloudFileAccount.accesskey;&quot;</span>
<a href="#l14.44"></a><span id="l14.44">                         oncommand=&quot;gCloudFileTab.removeCloudFileAccount();&quot;/&gt;</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+                &lt;label is=&quot;text-link&quot;</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+                       id=&quot;moreProvidersLink&quot;</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+                       href=&quot;https://addons.thunderbird.net/thunderbird/tag/filelink&quot;</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+                       value=&quot;&amp;findCloudFileProviders.label;&quot;/&gt;</span>
<a href="#l14.49"></a><span id="l14.49">               &lt;/vbox&gt;</span>
<a href="#l14.50"></a><span id="l14.50">               &lt;separator class=&quot;thin&quot; orient=&quot;vertical&quot;/&gt;</span>
<a href="#l14.51"></a><span id="l14.51">               &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l14.52"></a><span id="l14.52">                 &lt;deck id=&quot;cloudFileSettingsDeck&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l14.53"></a><span id="l14.53">                   &lt;vbox id=&quot;cloudFileDefaultPanel&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l14.54"></a><span id="l14.54">                     &lt;description&gt;&amp;addCloudFileAccount.description;&lt;/description&gt;</span>
<a href="#l14.55"></a><span id="l14.55">                   &lt;/vbox&gt;</span>
<a href="#l14.56"></a><span id="l14.56">                   &lt;vbox id=&quot;cloudFileSettingsWrapper&quot; flex=&quot;1&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/components/preferences/applications.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/components/preferences/applications.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -16,17 +16,17 @@</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5"> // For CSS. Can be one of &quot;ask&quot;, &quot;save&quot;, or &quot;feed&quot;. If absent, the icon URL</span>
<a href="#l15.6"></a><span id="l15.6"> // was set by us to a custom handler icon and CSS should not try to override it.</span>
<a href="#l15.7"></a><span id="l15.7"> var APP_ICON_ATTR_NAME = &quot;appHandlerIcon&quot;;</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> var gNodeToObjectMap = new WeakMap();</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> // CloudFile account tools used by gCloudFileTab.</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l15.14"></a><span id="l15.14"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.15"></a><span id="l15.15"> var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l15.16"></a><span id="l15.16"> var {AppConstants} = ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18"> XPCOMUtils.defineLazyServiceGetters(this, {</span>
<a href="#l15.19"></a><span id="l15.19">   gHandlerService: [&quot;@mozilla.org/uriloader/handler-service;1&quot;, &quot;nsIHandlerService&quot;],</span>
<a href="#l15.20"></a><span id="l15.20">   gMIMEService: [&quot;@mozilla.org/mime;1&quot;, &quot;nsIMIMEService&quot;],</span>
<a href="#l15.21"></a><span id="l15.21"> });</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -506,16 +506,17 @@ var gApplicationsTabController = {</span>
<a href="#l15.23"></a><span id="l15.23">   },</span>
<a href="#l15.24"></a><span id="l15.24"> };</span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26"> var gCloudFileTab = {</span>
<a href="#l15.27"></a><span id="l15.27">   _initialized: false,</span>
<a href="#l15.28"></a><span id="l15.28">   _initializationStarted: false,</span>
<a href="#l15.29"></a><span id="l15.29">   _list: null,</span>
<a href="#l15.30"></a><span id="l15.30">   _buttonContainer: null,</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+  _listContainer: null,</span>
<a href="#l15.32"></a><span id="l15.32">   _settings: null,</span>
<a href="#l15.33"></a><span id="l15.33">   _settingsDeck: null,</span>
<a href="#l15.34"></a><span id="l15.34">   _tabpanel: null,</span>
<a href="#l15.35"></a><span id="l15.35">   _settingsPanelWrap: null,</span>
<a href="#l15.36"></a><span id="l15.36">   _defaultPanel: null,</span>
<a href="#l15.37"></a><span id="l15.37">   _blacklist: new Set([&quot;YouSendIt&quot;]),</span>
<a href="#l15.38"></a><span id="l15.38"> </span>
<a href="#l15.39"></a><span id="l15.39">   get _strings() {</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineat">@@ -535,16 +536,18 @@ var gCloudFileTab = {</span>
<a href="#l15.41"></a><span id="l15.41">       return;</span>
<a href="#l15.42"></a><span id="l15.42">     }</span>
<a href="#l15.43"></a><span id="l15.43"> </span>
<a href="#l15.44"></a><span id="l15.44">     this._initializationStarted = true;</span>
<a href="#l15.45"></a><span id="l15.45">     window.removeEventListener(&quot;paneSelected&quot;, gApplicationsTabController.paneSelectionChanged);</span>
<a href="#l15.46"></a><span id="l15.46"> </span>
<a href="#l15.47"></a><span id="l15.47">     this._list = document.getElementById(&quot;cloudFileView&quot;);</span>
<a href="#l15.48"></a><span id="l15.48">     this._buttonContainer = document.getElementById(&quot;addCloudFileAccountButtons&quot;);</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+    this._addAccountButton = document.getElementById(&quot;addCloudFileAccount&quot;);</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+    this._listContainer = document.getElementById(&quot;addCloudFileAccountListItems&quot;);</span>
<a href="#l15.51"></a><span id="l15.51">     this._removeAccountButton = document.getElementById(&quot;removeCloudFileAccount&quot;);</span>
<a href="#l15.52"></a><span id="l15.52">     this._settingsDeck = document.getElementById(&quot;cloudFileSettingsDeck&quot;);</span>
<a href="#l15.53"></a><span id="l15.53">     this._defaultPanel = document.getElementById(&quot;cloudFileDefaultPanel&quot;);</span>
<a href="#l15.54"></a><span id="l15.54">     this._settingsPanelWrap = document.getElementById(&quot;cloudFileSettingsWrapper&quot;);</span>
<a href="#l15.55"></a><span id="l15.55"> </span>
<a href="#l15.56"></a><span id="l15.56">     this.updateThreshold();</span>
<a href="#l15.57"></a><span id="l15.57">     this.rebuildView();</span>
<a href="#l15.58"></a><span id="l15.58"> </span>
<a href="#l15.59"></a><span id="l15.59" class="difflineat">@@ -583,16 +586,17 @@ var gCloudFileTab = {</span>
<a href="#l15.60"></a><span id="l15.60">     // it clearer to users what's happening.</span>
<a href="#l15.61"></a><span id="l15.61">     for (let account of accounts) {</span>
<a href="#l15.62"></a><span id="l15.62">       let item = this.makeRichListItemForAccount(account);</span>
<a href="#l15.63"></a><span id="l15.63">       this._list.appendChild(item);</span>
<a href="#l15.64"></a><span id="l15.64">     }</span>
<a href="#l15.65"></a><span id="l15.65"> </span>
<a href="#l15.66"></a><span id="l15.66">     if (!this._blacklist.has(provider.type)) {</span>
<a href="#l15.67"></a><span id="l15.67">       this._buttonContainer.appendChild(this.makeButtonForProvider(provider));</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+      this._listContainer.appendChild(this.makeListItemForProvider(provider));</span>
<a href="#l15.69"></a><span id="l15.69">     }</span>
<a href="#l15.70"></a><span id="l15.70">   },</span>
<a href="#l15.71"></a><span id="l15.71"> </span>
<a href="#l15.72"></a><span id="l15.72">   _onProviderUnregistered(event, type) {</span>
<a href="#l15.73"></a><span id="l15.73">     for (let item of this._list.children) {</span>
<a href="#l15.74"></a><span id="l15.74">       // If the provider is unregistered, getAccount returns null.</span>
<a href="#l15.75"></a><span id="l15.75">       if (!cloudFileAccounts.getAccount(item.value)) {</span>
<a href="#l15.76"></a><span id="l15.76">         if (item.hasAttribute(&quot;selected&quot;)) {</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineat">@@ -606,16 +610,27 @@ var gCloudFileTab = {</span>
<a href="#l15.78"></a><span id="l15.78">       }</span>
<a href="#l15.79"></a><span id="l15.79">     }</span>
<a href="#l15.80"></a><span id="l15.80"> </span>
<a href="#l15.81"></a><span id="l15.81">     for (let button of this._buttonContainer.children) {</span>
<a href="#l15.82"></a><span id="l15.82">       if (button.getAttribute(&quot;value&quot;) == type) {</span>
<a href="#l15.83"></a><span id="l15.83">         button.remove();</span>
<a href="#l15.84"></a><span id="l15.84">       }</span>
<a href="#l15.85"></a><span id="l15.85">     }</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+    for (let item of this._listContainer.children) {</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+      if (item.getAttribute(&quot;value&quot;) == type) {</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+        item.remove();</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+      }</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+    }</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+    if (this._buttonContainer.childElementCount &lt; 1) {</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+      this._buttonContainer.hidden = false;</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+      this._addAccountButton.hidden = true;</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+    }</span>
<a href="#l15.97"></a><span id="l15.97">   },</span>
<a href="#l15.98"></a><span id="l15.98"> </span>
<a href="#l15.99"></a><span id="l15.99">   makeRichListItemForAccount(aAccount) {</span>
<a href="#l15.100"></a><span id="l15.100">     let rli = document.createElement(&quot;richlistitem&quot;);</span>
<a href="#l15.101"></a><span id="l15.101">     rli.value = aAccount.accountKey;</span>
<a href="#l15.102"></a><span id="l15.102">     rli.setAttribute(&quot;align&quot;, &quot;center&quot;);</span>
<a href="#l15.103"></a><span id="l15.103">     rli.setAttribute(&quot;class&quot;, &quot;cloudfileAccount&quot;);</span>
<a href="#l15.104"></a><span id="l15.104">     rli.setAttribute(&quot;value&quot;, aAccount.accountKey);</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineat">@@ -659,16 +674,25 @@ var gCloudFileTab = {</span>
<a href="#l15.106"></a><span id="l15.106">     button.setAttribute(</span>
<a href="#l15.107"></a><span id="l15.107">       &quot;label&quot;, this._strings.formatStringFromName(&quot;addProvider&quot;, [provider.displayName], 1)</span>
<a href="#l15.108"></a><span id="l15.108">     );</span>
<a href="#l15.109"></a><span id="l15.109">     button.setAttribute(&quot;oncommand&quot;, `gCloudFileTab.addCloudFileAccount(&quot;${provider.type}&quot;)`);</span>
<a href="#l15.110"></a><span id="l15.110">     button.style.listStyleImage = `url(&quot;${provider.iconURL}&quot;)`;</span>
<a href="#l15.111"></a><span id="l15.111">     return button;</span>
<a href="#l15.112"></a><span id="l15.112">   },</span>
<a href="#l15.113"></a><span id="l15.113"> </span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+  makeListItemForProvider(provider) {</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+    let menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+    menuitem.classList.add(&quot;menuitem-iconic&quot;);</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+    menuitem.setAttribute(&quot;value&quot;, provider.type);</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+    menuitem.setAttribute(&quot;label&quot;, provider.displayName);</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+    menuitem.setAttribute(&quot;image&quot;, provider.iconURL);</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineplus">+    return menuitem;</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineplus">+  },</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineplus">+</span>
<a href="#l15.123"></a><span id="l15.123">   // Sort the accounts by displayName.</span>
<a href="#l15.124"></a><span id="l15.124">   _sortDisplayNames(a, b) {</span>
<a href="#l15.125"></a><span id="l15.125">     let aName = a.displayName.toLowerCase();</span>
<a href="#l15.126"></a><span id="l15.126">     let bName = b.displayName.toLowerCase();</span>
<a href="#l15.127"></a><span id="l15.127">     return aName.localeCompare(bName);</span>
<a href="#l15.128"></a><span id="l15.128">   },</span>
<a href="#l15.129"></a><span id="l15.129"> </span>
<a href="#l15.130"></a><span id="l15.130">   rebuildView() {</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineat">@@ -690,16 +714,17 @@ var gCloudFileTab = {</span>
<a href="#l15.132"></a><span id="l15.132">     let providers = cloudFileAccounts.providers;</span>
<a href="#l15.133"></a><span id="l15.133">     providers.sort(this._sortDisplayNames);</span>
<a href="#l15.134"></a><span id="l15.134">     for (let provider of providers) {</span>
<a href="#l15.135"></a><span id="l15.135">       if (this._blacklist.has(provider.type)) {</span>
<a href="#l15.136"></a><span id="l15.136">         continue;</span>
<a href="#l15.137"></a><span id="l15.137">       }</span>
<a href="#l15.138"></a><span id="l15.138"> </span>
<a href="#l15.139"></a><span id="l15.139">       this._buttonContainer.appendChild(this.makeButtonForProvider(provider));</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+      this._listContainer.appendChild(this.makeListItemForProvider(provider));</span>
<a href="#l15.141"></a><span id="l15.141">     }</span>
<a href="#l15.142"></a><span id="l15.142">   },</span>
<a href="#l15.143"></a><span id="l15.143"> </span>
<a href="#l15.144"></a><span id="l15.144">   onSelectionChanged(aEvent) {</span>
<a href="#l15.145"></a><span id="l15.145">     if (!this._initialized || aEvent.target != this._list) {</span>
<a href="#l15.146"></a><span id="l15.146">       return;</span>
<a href="#l15.147"></a><span id="l15.147">     }</span>
<a href="#l15.148"></a><span id="l15.148"> </span>
<a href="#l15.149"></a><span id="l15.149" class="difflineat">@@ -737,24 +762,35 @@ var gCloudFileTab = {</span>
<a href="#l15.150"></a><span id="l15.150">     if (this._settings) {</span>
<a href="#l15.151"></a><span id="l15.151">       this._settings.remove();</span>
<a href="#l15.152"></a><span id="l15.152">     }</span>
<a href="#l15.153"></a><span id="l15.153"> </span>
<a href="#l15.154"></a><span id="l15.154">     this._settingsPanelWrap.appendChild(iframe);</span>
<a href="#l15.155"></a><span id="l15.155">     this._settings = iframe;</span>
<a href="#l15.156"></a><span id="l15.156">   },</span>
<a href="#l15.157"></a><span id="l15.157"> </span>
<a href="#l15.158"></a><span id="l15.158" class="difflineplus">+  onListOverflow() {</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineplus">+    if (this._buttonContainer.childElementCount &gt; 1) {</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineplus">+      this._buttonContainer.hidden = true;</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineplus">+      this._addAccountButton.hidden = false;</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineplus">+    }</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineplus">+  },</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineplus">+</span>
<a href="#l15.165"></a><span id="l15.165">   addCloudFileAccount(aType) {</span>
<a href="#l15.166"></a><span id="l15.166">     let account = cloudFileAccounts.createAccount(aType);</span>
<a href="#l15.167"></a><span id="l15.167">     if (!account)</span>
<a href="#l15.168"></a><span id="l15.168">       return;</span>
<a href="#l15.169"></a><span id="l15.169"> </span>
<a href="#l15.170"></a><span id="l15.170">     let rli = this.makeRichListItemForAccount(account);</span>
<a href="#l15.171"></a><span id="l15.171">     this._list.appendChild(rli);</span>
<a href="#l15.172"></a><span id="l15.172">     this._list.selectItem(rli);</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineplus">+    this._addAccountButton.removeAttribute(&quot;image&quot;);</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineplus">+    this._addAccountButton.setAttribute(</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineplus">+      &quot;label&quot;, this._addAccountButton.getAttribute(&quot;defaultlabel&quot;)</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineplus">+    );</span>
<a href="#l15.177"></a><span id="l15.177">     this._removeAccountButton.disabled = false;</span>
<a href="#l15.178"></a><span id="l15.178">   },</span>
<a href="#l15.179"></a><span id="l15.179"> </span>
<a href="#l15.180"></a><span id="l15.180">   removeCloudFileAccount() {</span>
<a href="#l15.181"></a><span id="l15.181">     // Get the selected account key</span>
<a href="#l15.182"></a><span id="l15.182">     let selection = this._list.selectedItem;</span>
<a href="#l15.183"></a><span id="l15.183">     if (!selection)</span>
<a href="#l15.184"></a><span id="l15.184">       return;</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineat">@@ -839,20 +875,22 @@ var gCloudFileTab = {</span>
<a href="#l15.186"></a><span id="l15.186">   writeThreshold() {</span>
<a href="#l15.187"></a><span id="l15.187">     let threshold = document.getElementById(&quot;cloudFileThreshold&quot;);</span>
<a href="#l15.188"></a><span id="l15.188">     let intValue = parseInt(threshold.value, 10);</span>
<a href="#l15.189"></a><span id="l15.189">     return isNaN(intValue) ? 0 : intValue * 1024;</span>
<a href="#l15.190"></a><span id="l15.190">   },</span>
<a href="#l15.191"></a><span id="l15.191"> </span>
<a href="#l15.192"></a><span id="l15.192">   updateThreshold() {</span>
<a href="#l15.193"></a><span id="l15.193">     document.getElementById(&quot;cloudFileThreshold&quot;).disabled =</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineminus">-      !document.getElementById(&quot;enableThreshold&quot;).checked;</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineplus">+      !Preferences.get(&quot;mail.compose.big_attachments.notify&quot;).value;</span>
<a href="#l15.196"></a><span id="l15.196">   },</span>
<a href="#l15.197"></a><span id="l15.197"> };</span>
<a href="#l15.198"></a><span id="l15.198"> </span>
<a href="#l15.199"></a><span id="l15.199" class="difflineplus">+Preferences.get(&quot;mail.compose.big_attachments.notify&quot;).on(&quot;change&quot;, gCloudFileTab.updateThreshold);</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineplus">+</span>
<a href="#l15.201"></a><span id="l15.201"> // -------------------</span>
<a href="#l15.202"></a><span id="l15.202"> // Prefpane Controller</span>
<a href="#l15.203"></a><span id="l15.203"> </span>
<a href="#l15.204"></a><span id="l15.204"> var gApplicationsPane = {</span>
<a href="#l15.205"></a><span id="l15.205">   // The set of types the app knows how to handle.  A hash of HandlerInfoWrapper</span>
<a href="#l15.206"></a><span id="l15.206">   // objects, indexed by type.</span>
<a href="#l15.207"></a><span id="l15.207">   _handledTypes: {},</span>
<a href="#l15.208"></a><span id="l15.208"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/components/preferences/test/browser/browser_applications.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/components/preferences/test/browser/browser_applications.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.5"></a><span id="l16.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.6"></a><span id="l16.6">  * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> add_task(async () =&gt; {</span>
<a href="#l16.9"></a><span id="l16.9">   await testCheckboxes(&quot;paneApplications&quot;, &quot;attachmentsOutTab&quot;, {</span>
<a href="#l16.10"></a><span id="l16.10">     checkboxID: &quot;enableThreshold&quot;,</span>
<a href="#l16.11"></a><span id="l16.11">     pref: &quot;mail.compose.big_attachments.notify&quot;,</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+    enabledElements: [&quot;#cloudFileThreshold&quot;],</span>
<a href="#l16.13"></a><span id="l16.13">   });</span>
<a href="#l16.14"></a><span id="l16.14"> });</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16"> add_task(async () =&gt; {</span>
<a href="#l16.17"></a><span id="l16.17">   await testRadioButtons(&quot;paneApplications&quot;, &quot;attachmentsInTab&quot;, {</span>
<a href="#l16.18"></a><span id="l16.18">     pref: &quot;browser.download.useDownloadDir&quot;,</span>
<a href="#l16.19"></a><span id="l16.19">     states: [{</span>
<a href="#l16.20"></a><span id="l16.20">       id: &quot;saveTo&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/components/preferences/test/browser/browser_cloudfile.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/components/preferences/test/browser/browser_cloudfile.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -10,44 +10,51 @@ add_task(async () =&gt; {</span>
<a href="#l17.4"></a><span id="l17.4">     confirmCount: 0,</span>
<a href="#l17.5"></a><span id="l17.5">     confirm() {</span>
<a href="#l17.6"></a><span id="l17.6">       this.confirmCount++;</span>
<a href="#l17.7"></a><span id="l17.7">       return true;</span>
<a href="#l17.8"></a><span id="l17.8">     },</span>
<a href="#l17.9"></a><span id="l17.9">     QueryInterface: ChromeUtils.generateQI([Ci.nsIPromptService]),</span>
<a href="#l17.10"></a><span id="l17.10">   };</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  let { MockRegistrar } = ChromeUtils.import(&quot;resource://testing-common/MockRegistrar.jsm&quot;, null);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  let { MockRegistrar } = ChromeUtils.import(&quot;resource://testing-common/MockRegistrar.jsm&quot;);</span>
<a href="#l17.14"></a><span id="l17.14">   let mockPromptServiceCID = MockRegistrar.register(</span>
<a href="#l17.15"></a><span id="l17.15">     &quot;@mozilla.org/embedcomp/prompt-service;1&quot;,</span>
<a href="#l17.16"></a><span id="l17.16">     mockPromptService</span>
<a href="#l17.17"></a><span id="l17.17">   );</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19">   registerCleanupFunction(() =&gt; {</span>
<a href="#l17.20"></a><span id="l17.20">     MockRegistrar.unregister(mockPromptServiceCID);</span>
<a href="#l17.21"></a><span id="l17.21">   });</span>
<a href="#l17.22"></a><span id="l17.22"> </span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-  let { cloudFileAccounts } = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;, null);</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+  let { cloudFileAccounts } = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l17.25"></a><span id="l17.25">   is(cloudFileAccounts.providers.length, 3);</span>
<a href="#l17.26"></a><span id="l17.26">   is(cloudFileAccounts.accounts.length, 0);</span>
<a href="#l17.27"></a><span id="l17.27"> </span>
<a href="#l17.28"></a><span id="l17.28">   // Load the preferences tab.</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30">   let { prefsDocument, prefsWindow } = await openNewPrefsTab(&quot;paneApplications&quot;, &quot;attachmentsOutTab&quot;);</span>
<a href="#l17.31"></a><span id="l17.31"> </span>
<a href="#l17.32"></a><span id="l17.32">   // Check everything is as it should be.</span>
<a href="#l17.33"></a><span id="l17.33"> </span>
<a href="#l17.34"></a><span id="l17.34">   let accountList = prefsDocument.getElementById(&quot;cloudFileView&quot;);</span>
<a href="#l17.35"></a><span id="l17.35">   is(accountList.itemCount, 0);</span>
<a href="#l17.36"></a><span id="l17.36"> </span>
<a href="#l17.37"></a><span id="l17.37">   let buttonList = prefsDocument.getElementById(&quot;addCloudFileAccountButtons&quot;);</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+  ok(!buttonList.hidden);</span>
<a href="#l17.39"></a><span id="l17.39">   is(buttonList.childElementCount, 2);</span>
<a href="#l17.40"></a><span id="l17.40">   is(buttonList.children[0].getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l17.41"></a><span id="l17.41">   is(buttonList.children[1].getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l17.42"></a><span id="l17.42"> </span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+  let menuButton = prefsDocument.getElementById(&quot;addCloudFileAccount&quot;);</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+  ok(menuButton.hidden);</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+  is(menuButton.itemCount, 2);</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+  is(menuButton.getItemAtIndex(0).getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+  is(menuButton.getItemAtIndex(1).getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+</span>
<a href="#l17.49"></a><span id="l17.49">   let removeButton = prefsDocument.getElementById(&quot;removeCloudFileAccount&quot;);</span>
<a href="#l17.50"></a><span id="l17.50">   ok(removeButton.disabled);</span>
<a href="#l17.51"></a><span id="l17.51"> </span>
<a href="#l17.52"></a><span id="l17.52">   let settingsDeck = prefsDocument.getElementById(&quot;cloudFileSettingsDeck&quot;);</span>
<a href="#l17.53"></a><span id="l17.53">   is(settingsDeck.selectedPanel.id, &quot;cloudFileDefaultPanel&quot;);</span>
<a href="#l17.54"></a><span id="l17.54"> </span>
<a href="#l17.55"></a><span id="l17.55">   let iframeWrapper = prefsDocument.getElementById(&quot;cloudFileSettingsWrapper&quot;);</span>
<a href="#l17.56"></a><span id="l17.56">   is(iframeWrapper.childElementCount, 0);</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineat">@@ -85,16 +92,22 @@ add_task(async () =&gt; {</span>
<a href="#l17.58"></a><span id="l17.58">   await new Promise(resolve =&gt; prefsWindow.requestAnimationFrame(resolve));</span>
<a href="#l17.59"></a><span id="l17.59"> </span>
<a href="#l17.60"></a><span id="l17.60">   is(buttonList.childElementCount, 3);</span>
<a href="#l17.61"></a><span id="l17.61">   is(buttonList.children[0].getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l17.62"></a><span id="l17.62">   is(buttonList.children[1].getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l17.63"></a><span id="l17.63">   is(buttonList.children[2].getAttribute(&quot;value&quot;), &quot;Mochitest&quot;);</span>
<a href="#l17.64"></a><span id="l17.64">   is(buttonList.children[2].style.listStyleImage, `url(&quot;${ICON_URL}&quot;)`);</span>
<a href="#l17.65"></a><span id="l17.65"> </span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+  is(menuButton.itemCount, 3);</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+  is(menuButton.getItemAtIndex(0).getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+  is(menuButton.getItemAtIndex(1).getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+  is(menuButton.getItemAtIndex(2).getAttribute(&quot;value&quot;), &quot;Mochitest&quot;);</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+  is(menuButton.getItemAtIndex(2).getAttribute(&quot;image&quot;), ICON_URL);</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+</span>
<a href="#l17.72"></a><span id="l17.72">   // Create a new account.</span>
<a href="#l17.73"></a><span id="l17.73"> </span>
<a href="#l17.74"></a><span id="l17.74">   EventUtils.synthesizeMouseAtCenter(buttonList.children[2], { clickCount: 1 }, prefsWindow);</span>
<a href="#l17.75"></a><span id="l17.75">   is(cloudFileAccounts.accounts.length, 1);</span>
<a href="#l17.76"></a><span id="l17.76">   is(cloudFileAccounts.configuredAccounts.length, 0);</span>
<a href="#l17.77"></a><span id="l17.77"> </span>
<a href="#l17.78"></a><span id="l17.78">   let account = cloudFileAccounts.accounts[0];</span>
<a href="#l17.79"></a><span id="l17.79">   let accountKey = account.accountKey;</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineat">@@ -184,16 +197,19 @@ add_task(async () =&gt; {</span>
<a href="#l17.81"></a><span id="l17.81">   is(cloudFileAccounts.providers.length, 3);</span>
<a href="#l17.82"></a><span id="l17.82">   is(cloudFileAccounts.accounts.length, 0);</span>
<a href="#l17.83"></a><span id="l17.83"> </span>
<a href="#l17.84"></a><span id="l17.84">   await new Promise(resolve =&gt; prefsWindow.requestAnimationFrame(resolve));</span>
<a href="#l17.85"></a><span id="l17.85"> </span>
<a href="#l17.86"></a><span id="l17.86">   is(buttonList.childElementCount, 2);</span>
<a href="#l17.87"></a><span id="l17.87">   is(buttonList.children[0].getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l17.88"></a><span id="l17.88">   is(buttonList.children[1].getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+  is(menuButton.itemCount, 2);</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+  is(menuButton.getItemAtIndex(0).getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+  is(menuButton.getItemAtIndex(1).getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l17.92"></a><span id="l17.92">   is(accountList.itemCount, 0);</span>
<a href="#l17.93"></a><span id="l17.93">   is(settingsDeck.selectedPanel.id, &quot;cloudFileDefaultPanel&quot;);</span>
<a href="#l17.94"></a><span id="l17.94">   is(iframeWrapper.childElementCount, 0);</span>
<a href="#l17.95"></a><span id="l17.95"> </span>
<a href="#l17.96"></a><span id="l17.96">   // Re-add the test provider.</span>
<a href="#l17.97"></a><span id="l17.97"> </span>
<a href="#l17.98"></a><span id="l17.98">   cloudFileAccounts.registerProvider(&quot;Mochitest&quot;, provider);</span>
<a href="#l17.99"></a><span id="l17.99">   is(cloudFileAccounts.providers.length, 4);</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineat">@@ -202,16 +218,21 @@ add_task(async () =&gt; {</span>
<a href="#l17.101"></a><span id="l17.101"> </span>
<a href="#l17.102"></a><span id="l17.102">   await new Promise(resolve =&gt; prefsWindow.requestAnimationFrame(resolve));</span>
<a href="#l17.103"></a><span id="l17.103"> </span>
<a href="#l17.104"></a><span id="l17.104">   is(buttonList.childElementCount, 3);</span>
<a href="#l17.105"></a><span id="l17.105">   is(buttonList.children[0].getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l17.106"></a><span id="l17.106">   is(buttonList.children[1].getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l17.107"></a><span id="l17.107">   is(buttonList.children[2].getAttribute(&quot;value&quot;), &quot;Mochitest&quot;);</span>
<a href="#l17.108"></a><span id="l17.108"> </span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+  is(menuButton.itemCount, 3);</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+  is(menuButton.getItemAtIndex(0).getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+  is(menuButton.getItemAtIndex(1).getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+  is(menuButton.getItemAtIndex(2).getAttribute(&quot;value&quot;), &quot;Mochitest&quot;);</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+</span>
<a href="#l17.114"></a><span id="l17.114">   is(accountList.itemCount, 1);</span>
<a href="#l17.115"></a><span id="l17.115">   is(accountList.selectedIndex, -1);</span>
<a href="#l17.116"></a><span id="l17.116">   ok(removeButton.disabled);</span>
<a href="#l17.117"></a><span id="l17.117"> </span>
<a href="#l17.118"></a><span id="l17.118">   accountListItem = accountList.getItemAtIndex(0);</span>
<a href="#l17.119"></a><span id="l17.119">   is(Services.prefs.getCharPref(`mail.cloud_files.accounts.${accountKey}.displayName`), &quot;Mochitest Account!&quot;);</span>
<a href="#l17.120"></a><span id="l17.120"> </span>
<a href="#l17.121"></a><span id="l17.121">   EventUtils.synthesizeMouseAtCenter(accountList.getItemAtIndex(0), { clickCount: 1 }, prefsWindow);</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineat">@@ -228,8 +249,87 @@ add_task(async () =&gt; {</span>
<a href="#l17.123"></a><span id="l17.123">   cloudFileAccounts.unregisterProvider(&quot;Mochitest&quot;, provider);</span>
<a href="#l17.124"></a><span id="l17.124">   is(cloudFileAccounts.providers.length, 3);</span>
<a href="#l17.125"></a><span id="l17.125">   is(cloudFileAccounts.accounts.length, 0);</span>
<a href="#l17.126"></a><span id="l17.126"> </span>
<a href="#l17.127"></a><span id="l17.127">   // Close the preferences tab.</span>
<a href="#l17.128"></a><span id="l17.128"> </span>
<a href="#l17.129"></a><span id="l17.129">   await closePrefsTab();</span>
<a href="#l17.130"></a><span id="l17.130"> });</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineplus">+</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+  let { cloudFileAccounts } = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineplus">+</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineplus">+  // Register our test provider.</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+  const ICON_URL = getRootDirectory(gTestPath) + &quot;files/icon.svg&quot;;</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+  const MANAGEMENT_URL = getRootDirectory(gTestPath) + &quot;files/management.html&quot;;</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+  let accountIsConfigured = false;</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+  let provider = {</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+    type: &quot;Mochitest&quot;,</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+    displayName: &quot;Mochitest&quot;,</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+    iconURL: ICON_URL,</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+    initAccount(accountKey) {</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineplus">+      return {</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+        accountKey,</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineplus">+        type: &quot;Mochitest&quot;,</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineplus">+        get displayName() {</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineplus">+          return Services.prefs.getCharPref(</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineplus">+            `mail.cloud_files.accounts.${this.accountKey}.displayName`,</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineplus">+            &quot;Mochitest Account&quot;</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineplus">+          );</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineplus">+        },</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineplus">+        iconURL: ICON_URL,</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineplus">+        configured: accountIsConfigured,</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+        managementURL: MANAGEMENT_URL,</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+      };</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+    },</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+  };</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineplus">+  cloudFileAccounts.registerProvider(&quot;Mochitest&quot;, provider);</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineplus">+  is(cloudFileAccounts.providers.length, 4);</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineplus">+  is(cloudFileAccounts.accounts.length, 0);</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineplus">+</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineplus">+  // Load the preferences tab.</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineplus">+</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineplus">+  let { prefsDocument, prefsWindow } = await openNewPrefsTab(&quot;paneApplications&quot;, &quot;attachmentsOutTab&quot;);</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineplus">+</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineplus">+  let accountList = prefsDocument.getElementById(&quot;cloudFileView&quot;);</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineplus">+  is(accountList.itemCount, 0);</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineplus">+</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineplus">+  let buttonList = prefsDocument.getElementById(&quot;addCloudFileAccountButtons&quot;);</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineplus">+  ok(!buttonList.hidden);</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineplus">+</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineplus">+  let menuButton = prefsDocument.getElementById(&quot;addCloudFileAccount&quot;);</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineplus">+  ok(menuButton.hidden);</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineplus">+</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineplus">+  // Add new accounts until the list overflows. The list of buttons should be hidden</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineplus">+  // and the button with the drop-down should appear.</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineplus">+</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineplus">+  let count = 0;</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineplus">+  do {</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineplus">+    EventUtils.synthesizeMouseAtCenter(buttonList.children[1], { clickCount: 1 }, prefsWindow);</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineplus">+    await new Promise(resolve =&gt; setTimeout(resolve));</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineplus">+    if (buttonList.hidden) {</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineplus">+      break;</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineplus">+    }</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineplus">+  } while (++count &lt; 25);</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineplus">+</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineplus">+  ok(count &lt; 24); // If count reaches 25, we have a problem.</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineplus">+  ok(!menuButton.hidden);</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineplus">+</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineplus">+  // Remove the added accounts. The list of buttons should not reappear and the</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineplus">+  // button with the drop-down should remain.</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineplus">+</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineplus">+  let removeButton = prefsDocument.getElementById(&quot;removeCloudFileAccount&quot;);</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineplus">+  do {</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineplus">+    EventUtils.synthesizeMouseAtCenter(accountList.getItemAtIndex(0), { clickCount: 1 }, prefsWindow);</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineplus">+    EventUtils.synthesizeMouseAtCenter(removeButton, { clickCount: 1 }, prefsWindow);</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineplus">+    await new Promise(resolve =&gt; setTimeout(resolve));</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineplus">+  } while (--count &gt; 0);</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineplus">+</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineplus">+  ok(buttonList.hidden);</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineplus">+  ok(!menuButton.hidden);</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineplus">+</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineplus">+  // Close the preferences tab.</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineplus">+</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineplus">+  await closePrefsTab();</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/preferences/applications.dtd</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/preferences/applications.dtd</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -25,14 +25,12 @@</span>
<a href="#l18.4"></a><span id="l18.4"> &lt;!ENTITY attachments.incoming.label   &quot;Incoming&quot;&gt;</span>
<a href="#l18.5"></a><span id="l18.5"> &lt;!ENTITY attachments.outgoing.label   &quot;Outgoing&quot;&gt;</span>
<a href="#l18.6"></a><span id="l18.6"> </span>
<a href="#l18.7"></a><span id="l18.7"> &lt;!ENTITY addCloudFileAccount1.label       &quot;Add…&quot;&gt;</span>
<a href="#l18.8"></a><span id="l18.8"> &lt;!ENTITY addCloudFileAccount1.accesskey   &quot;A&quot;&gt;</span>
<a href="#l18.9"></a><span id="l18.9"> &lt;!ENTITY addCloudFileAccount.description  &quot;Add a new Filelink storage service&quot;&gt;</span>
<a href="#l18.10"></a><span id="l18.10"> &lt;!ENTITY removeCloudFileAccount.label     &quot;Remove&quot;&gt;</span>
<a href="#l18.11"></a><span id="l18.11"> &lt;!ENTITY removeCloudFileAccount.accesskey &quot;R&quot;&gt;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-&lt;!ENTITY authRequired.description         &quot;Your authorization is required in order to see the settings for this storage service.&quot;&gt;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-&lt;!ENTITY authRequired.button.label        &quot;Authorize&quot;&gt;</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-&lt;!ENTITY authRequired.button.accesskey    &quot;U&quot;&gt;</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+&lt;!ENTITY findCloudFileProviders.label     &quot;Find more providers…&quot;&gt;</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17"> &lt;!ENTITY enableCloudFileAccountOffer.label &quot;Offer to share for files larger than&quot;&gt;</span>
<a href="#l18.18"></a><span id="l18.18"> &lt;!ENTITY enableCloudFileAccountOffer.mb &quot;MB&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -13,17 +13,17 @@ var MODULE_NAME = &quot;test-cloudfile-attach</span>
<a href="#l19.4"></a><span id="l19.4"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l19.5"></a><span id="l19.5"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l19.6"></a><span id="l19.6">                        &quot;compose-helpers&quot;,</span>
<a href="#l19.7"></a><span id="l19.7">                        &quot;cloudfile-helpers&quot;,</span>
<a href="#l19.8"></a><span id="l19.8">                        &quot;attachment-helpers&quot;];</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10"> var kAttachmentItemContextID = &quot;msgComposeAttachmentItemContext&quot;;</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15"> function setupModule(module) {</span>
<a href="#l19.16"></a><span id="l19.16">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l19.17"></a><span id="l19.17">     collector.getModule(lib).installInto(module);</span>
<a href="#l19.18"></a><span id="l19.18">   }</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20">   gMockFilePickReg.register();</span>
<a href="#l19.21"></a><span id="l19.21">   gMockCloudfileManager.register();</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -51,38 +51,39 @@ function test_upload_cancel_repeat() {</span>
<a href="#l19.23"></a><span id="l19.23">   let cw = open_compose_new_mail();</span>
<a href="#l19.24"></a><span id="l19.24"> </span>
<a href="#l19.25"></a><span id="l19.25">   // We've got a compose window open, and our mock Filelink provider</span>
<a href="#l19.26"></a><span id="l19.26">   // ready.  Let's attach a file...</span>
<a href="#l19.27"></a><span id="l19.27">   cw.window.AttachFile();</span>
<a href="#l19.28"></a><span id="l19.28"> </span>
<a href="#l19.29"></a><span id="l19.29">   // Now we override the uploadFile function of the MockCloudfileAccount</span>
<a href="#l19.30"></a><span id="l19.30">   // so that we're perpetually uploading...</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-  let listener;</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+  let promise;</span>
<a href="#l19.33"></a><span id="l19.33">   let started;</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-  provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-    listener = aListener;</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-    listener.onStartRequest(null);</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-    started = true;</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+  provider.uploadFile = function(aFile) {</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+    return new Promise((resolve, reject) =&gt; {</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+      promise = { resolve, reject };</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+      started = true;</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+    });</span>
<a href="#l19.43"></a><span id="l19.43">   };</span>
<a href="#l19.44"></a><span id="l19.44"> </span>
<a href="#l19.45"></a><span id="l19.45">   const kAttempts = 3;</span>
<a href="#l19.46"></a><span id="l19.46">   let cmd = cw.e(&quot;cmd_cancelUpload&quot;);</span>
<a href="#l19.47"></a><span id="l19.47">   let menu = cw.getMenu(&quot;#&quot; + kAttachmentItemContextID);</span>
<a href="#l19.48"></a><span id="l19.48"> </span>
<a href="#l19.49"></a><span id="l19.49">   for (let i = 0; i &lt; kAttempts; i++) {</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-    listener = null;</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+    promise = null;</span>
<a href="#l19.52"></a><span id="l19.52">     started = false;</span>
<a href="#l19.53"></a><span id="l19.53"> </span>
<a href="#l19.54"></a><span id="l19.54">     // Select the attachment, and choose to convert it to a Filelink</span>
<a href="#l19.55"></a><span id="l19.55">     let attachmentitem = select_attachments(cw, 0)[0];</span>
<a href="#l19.56"></a><span id="l19.56">     cw.window.convertSelectedToCloudAttachment(provider);</span>
<a href="#l19.57"></a><span id="l19.57">     cw.waitFor(() =&gt; started);</span>
<a href="#l19.58"></a><span id="l19.58"> </span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-    assert_can_cancel_upload(cw, provider, listener, file);</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+    assert_can_cancel_upload(cw, provider, promise, file);</span>
<a href="#l19.61"></a><span id="l19.61">   }</span>
<a href="#l19.62"></a><span id="l19.62"> </span>
<a href="#l19.63"></a><span id="l19.63">   close_compose_window(cw);</span>
<a href="#l19.64"></a><span id="l19.64"> }</span>
<a href="#l19.65"></a><span id="l19.65"> </span>
<a href="#l19.66"></a><span id="l19.66"> /**</span>
<a href="#l19.67"></a><span id="l19.67">  * Test that we can cancel a whole series of files being uploaded at once.</span>
<a href="#l19.68"></a><span id="l19.68">  */</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineat">@@ -94,26 +95,27 @@ function test_upload_multiple_and_cancel</span>
<a href="#l19.70"></a><span id="l19.70">   // Prepare the mock file picker to return our test file.</span>
<a href="#l19.71"></a><span id="l19.71">   let files = collectFiles(kFiles, __file__);</span>
<a href="#l19.72"></a><span id="l19.72">   gMockFilePicker.returnFiles = files;</span>
<a href="#l19.73"></a><span id="l19.73"> </span>
<a href="#l19.74"></a><span id="l19.74">   let provider = new MockCloudfileAccount();</span>
<a href="#l19.75"></a><span id="l19.75">   provider.init(&quot;someKey&quot;);</span>
<a href="#l19.76"></a><span id="l19.76">   let cw = open_compose_new_mail();</span>
<a href="#l19.77"></a><span id="l19.77"> </span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-  let listener;</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineminus">-  provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineminus">-    listener = aListener;</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-    listener.onStartRequest(null);</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineplus">+  let promise;</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+  provider.uploadFile = function(aFile) {</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineplus">+    return new Promise((resolve, reject) =&gt; {</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+      promise = { resolve, reject };</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+    });</span>
<a href="#l19.87"></a><span id="l19.87">   };</span>
<a href="#l19.88"></a><span id="l19.88"> </span>
<a href="#l19.89"></a><span id="l19.89">   add_cloud_attachments(cw, provider, false);</span>
<a href="#l19.90"></a><span id="l19.90"> </span>
<a href="#l19.91"></a><span id="l19.91">   for (let i = files.length - 1; i &gt;= 0; --i) {</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineminus">-    assert_can_cancel_upload(cw, provider, listener, files[i]);</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+    assert_can_cancel_upload(cw, provider, promise, files[i]);</span>
<a href="#l19.94"></a><span id="l19.94">   }</span>
<a href="#l19.95"></a><span id="l19.95"> </span>
<a href="#l19.96"></a><span id="l19.96">   close_compose_window(cw);</span>
<a href="#l19.97"></a><span id="l19.97"> }</span>
<a href="#l19.98"></a><span id="l19.98"> </span>
<a href="#l19.99"></a><span id="l19.99"> /**</span>
<a href="#l19.100"></a><span id="l19.100">  * Helper function that takes an upload in progress, and cancels it,</span>
<a href="#l19.101"></a><span id="l19.101">  * ensuring that the nsIMsgCloduFileProvider.uploadCanceled status message</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineat">@@ -121,25 +123,24 @@ function test_upload_multiple_and_cancel</span>
<a href="#l19.103"></a><span id="l19.103">  *</span>
<a href="#l19.104"></a><span id="l19.104">  * @param aController the compose window controller to use.</span>
<a href="#l19.105"></a><span id="l19.105">  * @param aProvider a MockCloudfileAccount for which the uploads have already</span>
<a href="#l19.106"></a><span id="l19.106">  *                  started.</span>
<a href="#l19.107"></a><span id="l19.107">  * @param aListener the nsIRequestObserver passed to aProvider's uploadFile</span>
<a href="#l19.108"></a><span id="l19.108">  *                  function.</span>
<a href="#l19.109"></a><span id="l19.109">  * @param aTargetFile the nsIFile to cancel the upload for.</span>
<a href="#l19.110"></a><span id="l19.110">  */</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineminus">-function assert_can_cancel_upload(aController, aProvider, aListener,</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineminus">-                                  aTargetFile) {</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineplus">+function assert_can_cancel_upload(aController, aProvider, aPromise, aTargetFile) {</span>
<a href="#l19.114"></a><span id="l19.114">   let cancelled = false;</span>
<a href="#l19.115"></a><span id="l19.115"> </span>
<a href="#l19.116"></a><span id="l19.116">   // Override the provider's cancelFileUpload function.  We can do this because</span>
<a href="#l19.117"></a><span id="l19.117">   // it's assumed that the provider is a MockCloudfileAccount.</span>
<a href="#l19.118"></a><span id="l19.118">   aProvider.cancelFileUpload = function(aFileToCancel) {</span>
<a href="#l19.119"></a><span id="l19.119">     if (aTargetFile.equals(aFileToCancel)) {</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineminus">-      aListener.onStopRequest(null, cloudFileAccounts.constants.uploadCancelled);</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineplus">+      aPromise.reject(cloudFileAccounts.constants.uploadCancelled);</span>
<a href="#l19.122"></a><span id="l19.122">       cancelled = true;</span>
<a href="#l19.123"></a><span id="l19.123">     }</span>
<a href="#l19.124"></a><span id="l19.124">   };</span>
<a href="#l19.125"></a><span id="l19.125"> </span>
<a href="#l19.126"></a><span id="l19.126">   // Retrieve the attachment bucket index for the target file...</span>
<a href="#l19.127"></a><span id="l19.127">   let index = get_attachmentitem_index_for_file(aController,</span>
<a href="#l19.128"></a><span id="l19.128">                                                 aTargetFile);</span>
<a href="#l19.129"></a><span id="l19.129"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -15,17 +15,17 @@ var MODULE_REQUIRES = [&quot;folder-display-h</span>
<a href="#l20.4"></a><span id="l20.4">                          &quot;compose-helpers&quot;,</span>
<a href="#l20.5"></a><span id="l20.5">                          &quot;cloudfile-helpers&quot;,</span>
<a href="#l20.6"></a><span id="l20.6">                          &quot;cloudfile-backend-helpers&quot;,</span>
<a href="#l20.7"></a><span id="l20.7">                          &quot;cloudfile-hightail-helpers&quot;,</span>
<a href="#l20.8"></a><span id="l20.8">                          &quot;observer-helpers&quot;,</span>
<a href="#l20.9"></a><span id="l20.9">                          &quot;prompt-helpers&quot;,];</span>
<a href="#l20.10"></a><span id="l20.10"> </span>
<a href="#l20.11"></a><span id="l20.11"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l20.14"></a><span id="l20.14"> </span>
<a href="#l20.15"></a><span id="l20.15"> var gServer, gObsManager;</span>
<a href="#l20.16"></a><span id="l20.16"> </span>
<a href="#l20.17"></a><span id="l20.17"> function setupModule(module) {</span>
<a href="#l20.18"></a><span id="l20.18">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l20.19"></a><span id="l20.19">     collector.getModule(lib).installInto(module);</span>
<a href="#l20.20"></a><span id="l20.20">   }</span>
<a href="#l20.21"></a><span id="l20.21"> </span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -63,33 +63,37 @@ function test_simple_case() {</span>
<a href="#l20.23"></a><span id="l20.23">   gServer.planForGetFileURL(&quot;testFile1&quot;, {url: kExpectedUrl});</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25">   let obs = new ObservationRecorder();</span>
<a href="#l20.26"></a><span id="l20.26">   for (let topic of kTopics) {</span>
<a href="#l20.27"></a><span id="l20.27">     obs.planFor(topic);</span>
<a href="#l20.28"></a><span id="l20.28">     Services.obs.addObserver(obs, topic);</span>
<a href="#l20.29"></a><span id="l20.29">   }</span>
<a href="#l20.30"></a><span id="l20.30"> </span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-  let requestObserver = gObsManager.create(&quot;test_simple_case - Upload 1&quot;);</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+  let uploadComplete = false;</span>
<a href="#l20.33"></a><span id="l20.33">   let file = getFile(&quot;./data/testFile1&quot;, __file__);</span>
<a href="#l20.34"></a><span id="l20.34">   let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-  provider.uploadFile(file, requestObserver);</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+  provider.uploadFile(file).then(() =&gt; {</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+    uploadComplete = true;</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+  });</span>
<a href="#l20.39"></a><span id="l20.39"> </span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-  mc.waitFor(() =&gt; requestObserver.success);</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+  mc.waitFor(() =&gt; uploadComplete);</span>
<a href="#l20.42"></a><span id="l20.42"> </span>
<a href="#l20.43"></a><span id="l20.43">   let urlForFile = provider.urlForFile(file);</span>
<a href="#l20.44"></a><span id="l20.44">   assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l20.45"></a><span id="l20.45">   assert_equals(1, obs.numSightings(kUploadFile));</span>
<a href="#l20.46"></a><span id="l20.46">   assert_equals(1, obs.numSightings(kGetFileURL));</span>
<a href="#l20.47"></a><span id="l20.47"> </span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+  uploadComplete = false;</span>
<a href="#l20.49"></a><span id="l20.49">   gServer.planForUploadFile(&quot;testFile1&quot;);</span>
<a href="#l20.50"></a><span id="l20.50">   gServer.planForGetFileURL(&quot;testFile1&quot;, {url: kExpectedUrl});</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-  requestObserver = gObsManager.create(&quot;test_simple_case - Upload 2&quot;);</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-  provider.uploadFile(file, requestObserver);</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-  mc.waitFor(() =&gt; requestObserver.success);</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+  provider.uploadFile(file).then(() =&gt; {</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+    uploadComplete = true;</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+  });</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+  mc.waitFor(() =&gt; uploadComplete);</span>
<a href="#l20.58"></a><span id="l20.58">   urlForFile = provider.urlForFile(file);</span>
<a href="#l20.59"></a><span id="l20.59">   assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l20.60"></a><span id="l20.60"> </span>
<a href="#l20.61"></a><span id="l20.61">   assert_equals(2, obs.numSightings(kUploadFile));</span>
<a href="#l20.62"></a><span id="l20.62">   assert_equals(2, obs.numSightings(kGetFileURL));</span>
<a href="#l20.63"></a><span id="l20.63"> </span>
<a href="#l20.64"></a><span id="l20.64">   for (let topic of kTopics) {</span>
<a href="#l20.65"></a><span id="l20.65">     Services.obs.removeObserver(obs, topic);</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineat">@@ -113,20 +117,22 @@ function test_chained_uploads() {</span>
<a href="#l20.67"></a><span id="l20.67">     Services.obs.addObserver(obs, topic);</span>
<a href="#l20.68"></a><span id="l20.68">   }</span>
<a href="#l20.69"></a><span id="l20.69"> </span>
<a href="#l20.70"></a><span id="l20.70">   let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l20.71"></a><span id="l20.71"> </span>
<a href="#l20.72"></a><span id="l20.72">   let files = [];</span>
<a href="#l20.73"></a><span id="l20.73"> </span>
<a href="#l20.74"></a><span id="l20.74">   let observers = kFilenames.map(function(aFilename) {</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineminus">-    let requestObserver = gObsManager.create(&quot;test_chained_uploads for filename &quot; + aFilename);</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+    let requestObserver = { success: false };</span>
<a href="#l20.77"></a><span id="l20.77">     let file = getFile(&quot;./data/&quot; + aFilename, __file__);</span>
<a href="#l20.78"></a><span id="l20.78">     files.push(file);</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-    provider.uploadFile(file, requestObserver);</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+    provider.uploadFile(file).then(() =&gt; {</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+      requestObserver.success = true;</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+    });</span>
<a href="#l20.83"></a><span id="l20.83">     return requestObserver;</span>
<a href="#l20.84"></a><span id="l20.84">   });</span>
<a href="#l20.85"></a><span id="l20.85"> </span>
<a href="#l20.86"></a><span id="l20.86">   mc.waitFor(function() {</span>
<a href="#l20.87"></a><span id="l20.87">     return observers.every(aListener =&gt; aListener.success);</span>
<a href="#l20.88"></a><span id="l20.88">   }, &quot;Timed out waiting for chained uploads to complete.&quot;, 10000);</span>
<a href="#l20.89"></a><span id="l20.89"> </span>
<a href="#l20.90"></a><span id="l20.90">   assert_equals(kFilenames.length, obs.numSightings(kUploadFile));</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineat">@@ -148,19 +154,21 @@ function test_chained_uploads() {</span>
<a href="#l20.92"></a><span id="l20.92"> </span>
<a href="#l20.93"></a><span id="l20.93"> function test_deleting_uploads() {</span>
<a href="#l20.94"></a><span id="l20.94">   const kFilename = &quot;testFile1&quot;;</span>
<a href="#l20.95"></a><span id="l20.95">   let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l20.96"></a><span id="l20.96">   // Upload a file</span>
<a href="#l20.97"></a><span id="l20.97"> </span>
<a href="#l20.98"></a><span id="l20.98">   let file = getFile(&quot;./data/&quot; + kFilename, __file__);</span>
<a href="#l20.99"></a><span id="l20.99">   gServer.planForUploadFile(kFilename);</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-  let requestObserver = gObsManager.create(&quot;test_deleting_uploads - upload 1&quot;);</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-  provider.uploadFile(file, requestObserver);</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineminus">-  mc.waitFor(() =&gt; requestObserver.success);</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+  let uploadComplete = false;</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+  provider.uploadFile(file).then(() =&gt; {</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+    uploadComplete = true;</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+  });</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+  mc.waitFor(() =&gt; uploadComplete);</span>
<a href="#l20.108"></a><span id="l20.108"> </span>
<a href="#l20.109"></a><span id="l20.109">   // Try deleting a file</span>
<a href="#l20.110"></a><span id="l20.110">   let obs = new ObservationRecorder();</span>
<a href="#l20.111"></a><span id="l20.111">   obs.planFor(kDeleteFile);</span>
<a href="#l20.112"></a><span id="l20.112">   Services.obs.addObserver(obs, kDeleteFile);</span>
<a href="#l20.113"></a><span id="l20.113"> </span>
<a href="#l20.114"></a><span id="l20.114">   gServer.planForDeleteFile(kFilename);</span>
<a href="#l20.115"></a><span id="l20.115">   let deleteObserver = gObsManager.create(&quot;test_deleting_uploads - delete 1&quot;);</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineat">@@ -246,19 +254,21 @@ function test_delete_refreshes_stale_tok</span>
<a href="#l20.117"></a><span id="l20.117">   // iff a password has been remembered for the user, so make</span>
<a href="#l20.118"></a><span id="l20.118">   // sure we remember a password...</span>
<a href="#l20.119"></a><span id="l20.119">   remember_hightail_credentials(kUserEmail, &quot;somePassword&quot;);</span>
<a href="#l20.120"></a><span id="l20.120"> </span>
<a href="#l20.121"></a><span id="l20.121">   // Get a prepared provider...</span>
<a href="#l20.122"></a><span id="l20.122">   let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l20.123"></a><span id="l20.123">   let file = getFile(&quot;./data/&quot; + kFilename, __file__);</span>
<a href="#l20.124"></a><span id="l20.124">   gServer.planForUploadFile(kFilename);</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineminus">-  let requestObserver = gObsManager.create(&quot;test_delete_refreshes_stale_token - upload 1&quot;);</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineminus">-  provider.uploadFile(file, requestObserver);</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineminus">-  mc.waitFor(() =&gt; requestObserver.success);</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+  let uploadComplete = false</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineplus">+  provider.uploadFile(file).then(() =&gt; {</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineplus">+    uploadComplete = true;</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineplus">+  });</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineplus">+  mc.waitFor(() =&gt; uploadComplete);</span>
<a href="#l20.133"></a><span id="l20.133"> </span>
<a href="#l20.134"></a><span id="l20.134">   // At this point, we should not have seen any auth attempts.</span>
<a href="#l20.135"></a><span id="l20.135">   assert_equals(gServer.auth.count, 0,</span>
<a href="#l20.136"></a><span id="l20.136">                 &quot;Should not have seen any authorization attempts yet&quot;);</span>
<a href="#l20.137"></a><span id="l20.137"> </span>
<a href="#l20.138"></a><span id="l20.138">   // Now delete the file, and get the stale auth token warning.</span>
<a href="#l20.139"></a><span id="l20.139">   gServer.planForDeleteFile(kFilename);</span>
<a href="#l20.140"></a><span id="l20.140">   // We have to pass an observer, so we'll just generate a dummy one.</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineat">@@ -279,29 +289,33 @@ function test_bug771132_fix_no_scheme() </span>
<a href="#l20.142"></a><span id="l20.142">   const kMalformedUrl = &quot;www.example.com/download/abcd1234&quot;;</span>
<a href="#l20.143"></a><span id="l20.143">   const kExpectedUrl = &quot;https://&quot; + kMalformedUrl;</span>
<a href="#l20.144"></a><span id="l20.144"> </span>
<a href="#l20.145"></a><span id="l20.145">   const kTopics = [kUploadFile, kGetFileURL];</span>
<a href="#l20.146"></a><span id="l20.146"> </span>
<a href="#l20.147"></a><span id="l20.147">   gServer.planForUploadFile(&quot;testFile1&quot;);</span>
<a href="#l20.148"></a><span id="l20.148">   gServer.planForGetFileURL(&quot;testFile1&quot;, {url: kMalformedUrl});</span>
<a href="#l20.149"></a><span id="l20.149"> </span>
<a href="#l20.150"></a><span id="l20.150" class="difflineminus">-  let requestObserver = gObsManager.create(&quot;test_simple_case - Upload 1&quot;);</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineplus">+  let uploadComplete = false;</span>
<a href="#l20.152"></a><span id="l20.152">   let file = getFile(&quot;./data/testFile1&quot;, __file__);</span>
<a href="#l20.153"></a><span id="l20.153">   let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineminus">-  provider.uploadFile(file, requestObserver);</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineplus">+  provider.uploadFile(file).then(() =&gt; {</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineplus">+    uploadComplete = true;</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineplus">+  });</span>
<a href="#l20.158"></a><span id="l20.158"> </span>
<a href="#l20.159"></a><span id="l20.159" class="difflineminus">-  mc.waitFor(() =&gt; requestObserver.success);</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineplus">+  mc.waitFor(() =&gt; uploadComplete);</span>
<a href="#l20.161"></a><span id="l20.161"> </span>
<a href="#l20.162"></a><span id="l20.162">   let urlForFile = provider.urlForFile(file);</span>
<a href="#l20.163"></a><span id="l20.163">   assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l20.164"></a><span id="l20.164"> </span>
<a href="#l20.165"></a><span id="l20.165">   // Now make sure that we don't accidentally prefix with https when there's</span>
<a href="#l20.166"></a><span id="l20.166">   // already a scheme.</span>
<a href="#l20.167"></a><span id="l20.167">   gServer.planForUploadFile(&quot;testFile1&quot;);</span>
<a href="#l20.168"></a><span id="l20.168">   gServer.planForGetFileURL(&quot;testFile1&quot;, {url: kExpectedUrl});</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineminus">-  requestObserver = gObsManager.create(&quot;test_simple_case - Upload 2&quot;);</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineminus">-  provider.uploadFile(file, requestObserver);</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineminus">-  mc.waitFor(() =&gt; requestObserver.success);</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineplus">+  uploadComplete = false;</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineplus">+  provider.uploadFile(file).then(() =&gt; {</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineplus">+    uploadComplete = true;</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineplus">+  });</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineplus">+  mc.waitFor(() =&gt; uploadComplete);</span>
<a href="#l20.177"></a><span id="l20.177"> </span>
<a href="#l20.178"></a><span id="l20.178">   urlForFile = provider.urlForFile(file);</span>
<a href="#l20.179"></a><span id="l20.179">   assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l20.180"></a><span id="l20.180"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -14,17 +14,17 @@ var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l21.4"></a><span id="l21.4"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l21.5"></a><span id="l21.5">                        &quot;compose-helpers&quot;,</span>
<a href="#l21.6"></a><span id="l21.6">                        &quot;cloudfile-helpers&quot;,</span>
<a href="#l21.7"></a><span id="l21.7">                        &quot;attachment-helpers&quot;,</span>
<a href="#l21.8"></a><span id="l21.8">                        &quot;prompt-helpers&quot;,</span>
<a href="#l21.9"></a><span id="l21.9">                        &quot;notificationbox-helpers&quot;];</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l21.14"></a><span id="l21.14"> </span>
<a href="#l21.15"></a><span id="l21.15"> var maxSize, oldInsertNotificationPref;</span>
<a href="#l21.16"></a><span id="l21.16"> </span>
<a href="#l21.17"></a><span id="l21.17"> var kOfferThreshold = &quot;mail.compose.big_attachments.threshold_kb&quot;;</span>
<a href="#l21.18"></a><span id="l21.18"> var kInsertNotificationPref = &quot;mail.compose.big_attachments.insert_notification&quot;;</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20"> var kBoxId = &quot;compose-notification-bottom&quot;;</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22" class="difflineat">@@ -228,20 +228,19 @@ function test_link_insertion_notificatio</span>
<a href="#l21.23"></a><span id="l21.23"> function test_link_insertion_goes_away_on_error() {</span>
<a href="#l21.24"></a><span id="l21.24">   gMockPromptService.register();</span>
<a href="#l21.25"></a><span id="l21.25">   gMockPromptService.returnValue = false;</span>
<a href="#l21.26"></a><span id="l21.26">   gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile1&quot;,</span>
<a href="#l21.27"></a><span id="l21.27">                                               &quot;./data/testFile2&quot;], __file__);</span>
<a href="#l21.28"></a><span id="l21.28">   let provider = new MockCloudfileAccount();</span>
<a href="#l21.29"></a><span id="l21.29">   provider.init(&quot;aKey&quot;);</span>
<a href="#l21.30"></a><span id="l21.30"> </span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-  provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-    aListener.onStartRequest(null);</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-    cwc.window.setTimeout(function() {</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-      aListener.onStopRequest(null, cloudFileAccounts.constants.uploadErr);</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+  provider.uploadFile = function(aFile) {</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+    return new Promise((resolve, reject) =&gt; {</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+      cwc.window.setTimeout(() =&gt; reject(cloudFileAccounts.constants.uploadErr));</span>
<a href="#l21.38"></a><span id="l21.38">     }, 500);</span>
<a href="#l21.39"></a><span id="l21.39">   };</span>
<a href="#l21.40"></a><span id="l21.40"> </span>
<a href="#l21.41"></a><span id="l21.41">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l21.42"></a><span id="l21.42">   add_cloud_attachments(cwc, provider, false);</span>
<a href="#l21.43"></a><span id="l21.43"> </span>
<a href="#l21.44"></a><span id="l21.44">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l21.45"></a><span id="l21.45">   wait_for_notification_to_stop(cwc, kBoxId, &quot;bigAttachmentUploading&quot;);</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineat">@@ -262,19 +261,18 @@ function test_no_offer_on_conversion() {</span>
<a href="#l21.47"></a><span id="l21.47">   // Insert some Filelinks...</span>
<a href="#l21.48"></a><span id="l21.48">   gMockFilePicker.returnFiles = collectFiles(kFiles, __file__);</span>
<a href="#l21.49"></a><span id="l21.49">   let provider = new MockCloudfileAccount();</span>
<a href="#l21.50"></a><span id="l21.50">   provider.init(&quot;someKey&quot;);</span>
<a href="#l21.51"></a><span id="l21.51"> </span>
<a href="#l21.52"></a><span id="l21.52">   // Override uploadFile to succeed instantaneously so that we don't have</span>
<a href="#l21.53"></a><span id="l21.53">   // to worry about waiting for the onStopRequest method being called</span>
<a href="#l21.54"></a><span id="l21.54">   // asynchronously.</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineminus">-  provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineminus">-    aListener.onStartRequest(null);</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineminus">-    aListener.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+  provider.uploadFile = function(aFile) {</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineplus">+    return Promise.resolve();</span>
<a href="#l21.60"></a><span id="l21.60">   };</span>
<a href="#l21.61"></a><span id="l21.61"> </span>
<a href="#l21.62"></a><span id="l21.62">   let cw = open_compose_new_mail();</span>
<a href="#l21.63"></a><span id="l21.63">   add_cloud_attachments(cw, provider, false);</span>
<a href="#l21.64"></a><span id="l21.64"> </span>
<a href="#l21.65"></a><span id="l21.65">   assert_cloudfile_notification_displayed(cw, false);</span>
<a href="#l21.66"></a><span id="l21.66">   // Now convert the file back into a normal attachment</span>
<a href="#l21.67"></a><span id="l21.67">   select_attachments(cw, 0);</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineat">@@ -305,19 +303,18 @@ function test_offer_then_upload_notifica</span>
<a href="#l21.69"></a><span id="l21.69"> </span>
<a href="#l21.70"></a><span id="l21.70">   // Create our mock provider</span>
<a href="#l21.71"></a><span id="l21.71">   let provider = new MockCloudfileAccount();</span>
<a href="#l21.72"></a><span id="l21.72">   provider.init(&quot;someKey&quot;);</span>
<a href="#l21.73"></a><span id="l21.73"> </span>
<a href="#l21.74"></a><span id="l21.74">   // Override uploadFile to succeed instantaneously so that we don't have</span>
<a href="#l21.75"></a><span id="l21.75">   // to worry about waiting for the onStopRequest method being called</span>
<a href="#l21.76"></a><span id="l21.76">   // asynchronously.</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineminus">-  provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineminus">-    aListener.onStartRequest(null);</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineminus">-    aListener.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineplus">+  provider.uploadFile = function(aFile) {</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineplus">+    return Promise.resolve();</span>
<a href="#l21.82"></a><span id="l21.82">   };</span>
<a href="#l21.83"></a><span id="l21.83"> </span>
<a href="#l21.84"></a><span id="l21.84">   let cw = open_compose_new_mail();</span>
<a href="#l21.85"></a><span id="l21.85"> </span>
<a href="#l21.86"></a><span id="l21.86">   // Attach the files, saying that each is 500 bytes large - which should</span>
<a href="#l21.87"></a><span id="l21.87">   // certainly trigger the offer.</span>
<a href="#l21.88"></a><span id="l21.88">   add_attachments(cw, fileURIs, [500, 500]);</span>
<a href="#l21.89"></a><span id="l21.89">   // Assert that the offer is displayed.</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineat">@@ -347,20 +344,17 @@ function test_privacy_warning_notificati</span>
<a href="#l21.91"></a><span id="l21.91">   gMockPromptService.register();</span>
<a href="#l21.92"></a><span id="l21.92">   gMockPromptService.returnValue = false;</span>
<a href="#l21.93"></a><span id="l21.93">   gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile1&quot;,</span>
<a href="#l21.94"></a><span id="l21.94">                                               &quot;./data/testFile2&quot;], __file__);</span>
<a href="#l21.95"></a><span id="l21.95">   let provider = new MockCloudfileAccount();</span>
<a href="#l21.96"></a><span id="l21.96">   provider.init(&quot;aKey&quot;);</span>
<a href="#l21.97"></a><span id="l21.97"> </span>
<a href="#l21.98"></a><span id="l21.98">   provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineminus">-    aListener.onStartRequest(null);</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineminus">-    cwc.window.setTimeout(function() {</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineminus">-      aListener.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineminus">-    }, 500);</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineplus">+    return new Promise(resolve =&gt; cwc.window.setTimeout(resolve, 500));</span>
<a href="#l21.104"></a><span id="l21.104">   };</span>
<a href="#l21.105"></a><span id="l21.105">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l21.106"></a><span id="l21.106">   add_cloud_attachments(cwc, provider);</span>
<a href="#l21.107"></a><span id="l21.107"> </span>
<a href="#l21.108"></a><span id="l21.108">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l21.109"></a><span id="l21.109">   wait_for_notification_to_stop(cwc, kBoxId, &quot;bigAttachmentUploading&quot;);</span>
<a href="#l21.110"></a><span id="l21.110"> </span>
<a href="#l21.111"></a><span id="l21.111">   // Assert that the warning is displayed.</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineat">@@ -387,20 +381,17 @@ function test_privacy_warning_notificati</span>
<a href="#l21.113"></a><span id="l21.113">   gMockPromptService.register();</span>
<a href="#l21.114"></a><span id="l21.114">   gMockPromptService.returnValue = false;</span>
<a href="#l21.115"></a><span id="l21.115">   gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile1&quot;,</span>
<a href="#l21.116"></a><span id="l21.116">                                               &quot;./data/testFile2&quot;], __file__);</span>
<a href="#l21.117"></a><span id="l21.117">   let provider = new MockCloudfileAccount();</span>
<a href="#l21.118"></a><span id="l21.118">   provider.init(&quot;aKey&quot;);</span>
<a href="#l21.119"></a><span id="l21.119"> </span>
<a href="#l21.120"></a><span id="l21.120">   provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineminus">-    aListener.onStartRequest(null);</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineminus">-    cwc.window.setTimeout(function() {</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineminus">-      aListener.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l21.124"></a><span id="l21.124" class="difflineminus">-    }, 500);</span>
<a href="#l21.125"></a><span id="l21.125" class="difflineplus">+    return new Promise(resolve =&gt; cwc.window.setTimeout(resolve, 500));</span>
<a href="#l21.126"></a><span id="l21.126">   };</span>
<a href="#l21.127"></a><span id="l21.127">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l21.128"></a><span id="l21.128">   add_cloud_attachments(cwc, provider, false);</span>
<a href="#l21.129"></a><span id="l21.129"> </span>
<a href="#l21.130"></a><span id="l21.130">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l21.131"></a><span id="l21.131">   wait_for_notification_to_stop(cwc, kBoxId, &quot;bigAttachmentUploading&quot;);</span>
<a href="#l21.132"></a><span id="l21.132"> </span>
<a href="#l21.133"></a><span id="l21.133">   // Assert that the warning is displayed.</span>
<a href="#l21.134"></a><span id="l21.134" class="difflineat">@@ -427,20 +418,17 @@ function test_privacy_warning_notificati</span>
<a href="#l21.135"></a><span id="l21.135">   gMockPromptService.register();</span>
<a href="#l21.136"></a><span id="l21.136">   gMockPromptService.returnValue = false;</span>
<a href="#l21.137"></a><span id="l21.137">   gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile1&quot;,</span>
<a href="#l21.138"></a><span id="l21.138">                                               &quot;./data/testFile2&quot;], __file__);</span>
<a href="#l21.139"></a><span id="l21.139">   let provider = new MockCloudfileAccount();</span>
<a href="#l21.140"></a><span id="l21.140">   provider.init(&quot;aKey&quot;);</span>
<a href="#l21.141"></a><span id="l21.141"> </span>
<a href="#l21.142"></a><span id="l21.142">   provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l21.143"></a><span id="l21.143" class="difflineminus">-    aListener.onStartRequest(null);</span>
<a href="#l21.144"></a><span id="l21.144" class="difflineminus">-    cwc.window.setTimeout(function() {</span>
<a href="#l21.145"></a><span id="l21.145" class="difflineminus">-      aListener.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l21.146"></a><span id="l21.146" class="difflineminus">-    }, 500);</span>
<a href="#l21.147"></a><span id="l21.147" class="difflineplus">+    return new Promise(resolve =&gt; cwc.window.setTimeout(resolve, 500));</span>
<a href="#l21.148"></a><span id="l21.148">   };</span>
<a href="#l21.149"></a><span id="l21.149">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l21.150"></a><span id="l21.150">   add_cloud_attachments(cwc, provider, false);</span>
<a href="#l21.151"></a><span id="l21.151"> </span>
<a href="#l21.152"></a><span id="l21.152">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l21.153"></a><span id="l21.153">   wait_for_notification_to_stop(cwc, kBoxId, &quot;bigAttachmentUploading&quot;);</span>
<a href="#l21.154"></a><span id="l21.154"> </span>
<a href="#l21.155"></a><span id="l21.155">   // Assert that the warning is displayed.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l22.4"></a><span id="l22.4"> </span>
<a href="#l22.5"></a><span id="l22.5"> &quot;use strict&quot;;</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7"> var MODULE_NAME = &quot;cloudfile-backend-helpers&quot;;</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l22.10"></a><span id="l22.10"> var MODULE_REQUIRES = [&quot;window-helpers&quot;];</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l22.14"></a><span id="l22.14"> </span>
<a href="#l22.15"></a><span id="l22.15"> var kUserAuthRequested = &quot;cloudfile:auth&quot;;</span>
<a href="#l22.16"></a><span id="l22.16"> var kUserDataRequested = &quot;cloudfile:user&quot;;</span>
<a href="#l22.17"></a><span id="l22.17"> var kUploadFile = &quot;cloudfile:uploadFile&quot;;</span>
<a href="#l22.18"></a><span id="l22.18"> var kGetFileURL = &quot;cloudfile:getFileURL&quot;;</span>
<a href="#l22.19"></a><span id="l22.19"> var kDeleteFile = &quot;cloudfile:deleteFile&quot;;</span>
<a href="#l22.20"></a><span id="l22.20"> var kLogout = &quot;cloudfile:logout&quot;;</span>
<a href="#l22.21"></a><span id="l22.21"> </span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -91,27 +91,19 @@ SimpleRequestObserver.prototype = {</span>
<a href="#l22.23"></a><span id="l22.23">  * @param aFiles the array of files to upload.</span>
<a href="#l22.24"></a><span id="l22.24">  */</span>
<a href="#l22.25"></a><span id="l22.25"> function assert_can_cancel_uploads(aController, aProvider, aFiles) {</span>
<a href="#l22.26"></a><span id="l22.26">   let fileListenerMap = [];</span>
<a href="#l22.27"></a><span id="l22.27">   wh.plan_for_observable_event(&quot;cloudfile:uploadStarted&quot;);</span>
<a href="#l22.28"></a><span id="l22.28"> </span>
<a href="#l22.29"></a><span id="l22.29">   for (let file of aFiles) {</span>
<a href="#l22.30"></a><span id="l22.30">     let mapping = {};</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-    mapping.listener = {</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-      onStartRequest(aRequest) {</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-        mapping.started = true;</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-      },</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-      onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-        if (aStatusCode == cloudFileAccounts.constants.uploadCancelled)</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-          mapping.cancelled = true;</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-      },</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineminus">-    };</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">-</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-    aProvider.uploadFile(file, mapping.listener);</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+    aProvider.uploadFile(file).catch(() =&gt; {</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+      mapping.cancelled = true;</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+    });</span>
<a href="#l22.45"></a><span id="l22.45">     fileListenerMap.push(mapping);</span>
<a href="#l22.46"></a><span id="l22.46">   }</span>
<a href="#l22.47"></a><span id="l22.47"> </span>
<a href="#l22.48"></a><span id="l22.48">   // Wait for the first file to start uploading...</span>
<a href="#l22.49"></a><span id="l22.49">   wh.wait_for_observable_event(&quot;cloudfile:uploadStarted&quot;);</span>
<a href="#l22.50"></a><span id="l22.50"> </span>
<a href="#l22.51"></a><span id="l22.51">   // Go backwards through the file list, ensuring that we can cancel the</span>
<a href="#l22.52"></a><span id="l22.52">   // last file, all the way to the first.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -5,22 +5,23 @@</span>
<a href="#l23.4"></a><span id="l23.4"> &quot;use strict&quot;;</span>
<a href="#l23.5"></a><span id="l23.5"> </span>
<a href="#l23.6"></a><span id="l23.6"> var MODULE_NAME = &quot;cloudfile-helpers&quot;;</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l23.9"></a><span id="l23.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l23.10"></a><span id="l23.10"> </span>
<a href="#l23.11"></a><span id="l23.11"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l23.14"></a><span id="l23.14"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l23.15"></a><span id="l23.15"> </span>
<a href="#l23.16"></a><span id="l23.16"> var kMockContractIDPrefix = &quot;@mozilla.org/mail/mockCloudFile;1?id=&quot;;</span>
<a href="#l23.17"></a><span id="l23.17"> </span>
<a href="#l23.18"></a><span id="l23.18"> var kDefaults = {</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+  type: &quot;default&quot;,</span>
<a href="#l23.20"></a><span id="l23.20">   iconURL: &quot;chrome://messenger/skin/icons/box-logo.png&quot;,</span>
<a href="#l23.21"></a><span id="l23.21">   accountKey: null,</span>
<a href="#l23.22"></a><span id="l23.22">   settingsURL: &quot;&quot;,</span>
<a href="#l23.23"></a><span id="l23.23">   managementURL: &quot;&quot;,</span>
<a href="#l23.24"></a><span id="l23.24">   authErr: cloudFileAccounts.constants.authErr,</span>
<a href="#l23.25"></a><span id="l23.25">   offlineErr: cloudFileAccounts.constants.offlineErr,</span>
<a href="#l23.26"></a><span id="l23.26">   uploadErr: cloudFileAccounts.constants.uploadErr,</span>
<a href="#l23.27"></a><span id="l23.27">   uploadWouldExceedQuota: cloudFileAccounts.constants.uploadWouldExceedQuota,</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineat">@@ -73,46 +74,30 @@ function MockCloudfileAccount() {</span>
<a href="#l23.29"></a><span id="l23.29">     this[someDefault] = kDefaults[someDefault];</span>
<a href="#l23.30"></a><span id="l23.30"> }</span>
<a href="#l23.31"></a><span id="l23.31"> </span>
<a href="#l23.32"></a><span id="l23.32"> MockCloudfileAccount.prototype = {</span>
<a href="#l23.33"></a><span id="l23.33">   init(aAccountKey) {</span>
<a href="#l23.34"></a><span id="l23.34">     this.accountKey = aAccountKey;</span>
<a href="#l23.35"></a><span id="l23.35">   },</span>
<a href="#l23.36"></a><span id="l23.36"> </span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-  uploadFile(aFile, aListener) {</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-    aListener.onStartRequest(null);</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-    fdh.mc.window.setTimeout(function() {</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">-      aListener.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-    }, 0);</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineplus">+  uploadFile(aFile) {</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+    return new Promise(resolve =&gt; fdh.mc.window.setTimeout(resolve));</span>
<a href="#l23.44"></a><span id="l23.44">   },</span>
<a href="#l23.45"></a><span id="l23.45"> </span>
<a href="#l23.46"></a><span id="l23.46">   urlForFile(aFile) {</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-    return &quot;http://www.example.com/&quot; + this.accountKey + &quot;/&quot; +</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-           aFile.leafName;</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-  },</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineminus">-  refreshUserInfo(aWithUI, aCallback) {</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineminus">-    aCallback.onStartRequest(null);</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineminus">-    aCallback.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+    return `http://www.example.com/${this.accountKey}/${aFile.leafName}`;</span>
<a href="#l23.55"></a><span id="l23.55">   },</span>
<a href="#l23.56"></a><span id="l23.56"> </span>
<a href="#l23.57"></a><span id="l23.57">   cancelFileUpload(aFile) {</span>
<a href="#l23.58"></a><span id="l23.58">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l23.59"></a><span id="l23.59">   },</span>
<a href="#l23.60"></a><span id="l23.60"> </span>
<a href="#l23.61"></a><span id="l23.61" class="difflineminus">-  providerUrlForError(aStatusCode) {</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineminus">-    return &quot;&quot;;</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineminus">-  },</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineminus">-</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineminus">-  deleteFile(aFile, aCallback) {</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-    aCallback.onStartRequest(null);</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineminus">-    fdh.mc.window.setTimeout(function() {</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineminus">-      aCallback.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineminus">-    }, 0);</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineplus">+  deleteFile(aFile) {</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineplus">+    return new Promise(resolve =&gt; fdh.mc.window.setTimeout(resolve));</span>
<a href="#l23.72"></a><span id="l23.72">   },</span>
<a href="#l23.73"></a><span id="l23.73"> </span>
<a href="#l23.74"></a><span id="l23.74">   get displayName() {</span>
<a href="#l23.75"></a><span id="l23.75">     return cloudFileAccounts.getDisplayName(this.accountKey);</span>
<a href="#l23.76"></a><span id="l23.76">   },</span>
<a href="#l23.77"></a><span id="l23.77"> };</span>
<a href="#l23.78"></a><span id="l23.78"> </span>
<a href="#l23.79"></a><span id="l23.79"> var gMockCloudfileManager = {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -3,17 +3,17 @@</span>
<a href="#l24.4"></a><span id="l24.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6"> &quot;use strict&quot;;</span>
<a href="#l24.7"></a><span id="l24.7"> </span>
<a href="#l24.8"></a><span id="l24.8"> var MODULE_NAME = &quot;cloudfile-hightail-helpers&quot;;</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> var {HttpServer} = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/httpd.jsm&quot;);</span>
<a href="#l24.11"></a><span id="l24.11"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l24.14"></a><span id="l24.14"> </span>
<a href="#l24.15"></a><span id="l24.15"> var kDefaultServerPort = 4444;</span>
<a href="#l24.16"></a><span id="l24.16"> var kServerRoot = &quot;http://localhost:&quot; + kDefaultServerPort;</span>
<a href="#l24.17"></a><span id="l24.17"> var kServerPath = &quot;&quot;;</span>
<a href="#l24.18"></a><span id="l24.18"> var kServerURL = kServerRoot + kServerPath;</span>
<a href="#l24.19"></a><span id="l24.19"> var kAuthPath = &quot;/dpi/v1/auth&quot;;</span>
<a href="#l24.20"></a><span id="l24.20"> var kUserInfoPath = &quot;/dpi/v2/user&quot;;</span>
<a href="#l24.21"></a><span id="l24.21"> var kFolderPath = &quot;/dpi/v1/folder/&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mail/themes/linux/jar.mn</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mail/themes/linux/jar.mn</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -91,17 +91,16 @@ classic.jar:</span>
<a href="#l25.4"></a><span id="l25.4">   skin/classic/messenger/downloads/aboutDownloads.css         (mail/downloads/aboutDownloads.css)</span>
<a href="#l25.5"></a><span id="l25.5"> % skin messenger-newsblog classic/1.0 %skin/classic/messenger-newsblog/</span>
<a href="#l25.6"></a><span id="l25.6">   skin/classic/messenger-newsblog/feed-subscriptions.css      (mail/newsblog/feed-subscriptions.css)</span>
<a href="#l25.7"></a><span id="l25.7">   skin/classic/messenger-newsblog/rss-feed.png                (mail/newsblog/rss-feed.png)</span>
<a href="#l25.8"></a><span id="l25.8">   skin/classic/messenger-newsblog/rss-feed-folder.png         (mail/newsblog/rss-feed-folder.png)</span>
<a href="#l25.9"></a><span id="l25.9">   skin/classic/messenger/preferences/alwaysAsk.png            (mail/preferences/alwaysAsk.png)</span>
<a href="#l25.10"></a><span id="l25.10">   skin/classic/messenger/preferences/preferences.css          (mail/preferences/preferences.css)</span>
<a href="#l25.11"></a><span id="l25.11">   skin/classic/messenger/preferences/applications.css         (mail/preferences/applications.css)</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  skin/classic/messenger/preferences/auth-error.png           (mail/preferences/auth-error.png)</span>
<a href="#l25.13"></a><span id="l25.13">   skin/classic/messenger/preferences/dialog.css               (mail/preferences/dialog.css)</span>
<a href="#l25.14"></a><span id="l25.14">   skin/classic/messenger/preferences/aboutPreferences.css     (mail/preferences/aboutPreferences.css)</span>
<a href="#l25.15"></a><span id="l25.15">   skin/classic/messenger/smime/smime-compose.css              (mail/smime/smime-compose.css)</span>
<a href="#l25.16"></a><span id="l25.16">   skin/classic/messenger/smime/msgHdrViewSMIMEOverlay.css     (mail/smime/msgHdrViewSMIMEOverlay.css)</span>
<a href="#l25.17"></a><span id="l25.17">   skin/classic/messenger/smime/msgReadSMIMEOverlay.css        (mail/smime/msgReadSMIMEOverlay.css)</span>
<a href="#l25.18"></a><span id="l25.18">   skin/classic/messenger/smime/msgReadSecurityInfo.css        (mail/smime/msgReadSecurityInfo.css)</span>
<a href="#l25.19"></a><span id="l25.19">   skin/classic/messenger/smime/msgCompSecurityInfo.css        (mail/smime/msgCompSecurityInfo.css)</span>
<a href="#l25.20"></a><span id="l25.20">   skin/classic/messenger/smime/certFetchingStatus.css         (mail/smime/certFetchingStatus.css)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mail/themes/linux/mail/preferences/applications.css</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mail/themes/linux/mail/preferences/applications.css</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -72,34 +72,11 @@ menuitem[appHandlerIcon=&quot;save&quot;] {</span>
<a href="#l26.4"></a><span id="l26.4"> </span>
<a href="#l26.5"></a><span id="l26.5"> .cloudfileAccount &gt; textbox {</span>
<a href="#l26.6"></a><span id="l26.6">   color: -moz-fieldtext !important;</span>
<a href="#l26.7"></a><span id="l26.7">   min-height: unset;</span>
<a href="#l26.8"></a><span id="l26.8">   margin: 0;</span>
<a href="#l26.9"></a><span id="l26.9">   padding-inline-start: 4px;</span>
<a href="#l26.10"></a><span id="l26.10"> }</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-#authMessage {</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-  text-align: center;</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-  padding: 0 80px;</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-}</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-#authImage {</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineminus">-  list-style-image: url(&quot;chrome://messenger/skin/preferences/auth-error.png&quot;);</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineminus">-  width: 200px;</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineminus">-  height: 200px;</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-}</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-</span>
<a href="#l26.23"></a><span id="l26.23"> #cloudFileToggleAndThreshold {</span>
<a href="#l26.24"></a><span id="l26.24">   margin-bottom: 15px;</span>
<a href="#l26.25"></a><span id="l26.25"> }</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineminus">-</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineminus">-#cloudFileLoadingSpinner {</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineminus">-  width: 16px;</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineminus">-  height: 16px;</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/icons/loading.png&quot;);</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-}</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-@media (min-resolution: 1.1dppx) {</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-  #cloudFileLoadingSpinner {</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-    list-style-image: url(&quot;chrome://global/skin/icons/loading@2x.png&quot;);</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-  }</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">deleted file mode 100644</span>
<a href="#l27.2"></a><span id="l27.2">index 74b850beef5e5325346812d0e454f682bc5e76d3..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l27.3"></a><span id="l27.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mail/themes/linux/mail/preferences/preferences.css</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mail/themes/linux/mail/preferences/preferences.css</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -177,18 +177,17 @@ a {</span>
<a href="#l28.4"></a><span id="l28.4"> }</span>
<a href="#l28.5"></a><span id="l28.5"> </span>
<a href="#l28.6"></a><span id="l28.6"> #provider-name h1 {</span>
<a href="#l28.7"></a><span id="l28.7">   margin: 0;</span>
<a href="#l28.8"></a><span id="l28.8">   font-size: 1.5em;</span>
<a href="#l28.9"></a><span id="l28.9">   font-weight: 600;</span>
<a href="#l28.10"></a><span id="l28.10"> }</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-/* Loading panel */</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-#cloudFileLoadingPanel, #cloudFileDefaultPanel {</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+#cloudFileDefaultPanel {</span>
<a href="#l28.15"></a><span id="l28.15">   text-align: center;</span>
<a href="#l28.16"></a><span id="l28.16">   padding-top: 150px;</span>
<a href="#l28.17"></a><span id="l28.17"> }</span>
<a href="#l28.18"></a><span id="l28.18"> </span>
<a href="#l28.19"></a><span id="l28.19"> /* Flexing */</span>
<a href="#l28.20"></a><span id="l28.20"> #provider-management {</span>
<a href="#l28.21"></a><span id="l28.21">   display: block;</span>
<a href="#l28.22"></a><span id="l28.22">   -moz-box-orient: vertical;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mail/themes/osx/jar.mn</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mail/themes/osx/jar.mn</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -112,17 +112,16 @@ classic.jar:</span>
<a href="#l29.4"></a><span id="l29.4">   skin/classic/messenger-newsblog/rss-feed@2x.png                (mail/newsblog/rss-feed@2x.png)</span>
<a href="#l29.5"></a><span id="l29.5">   skin/classic/messenger-newsblog/rss-feed-folder.png            (mail/newsblog/rss-feed-folder.png)</span>
<a href="#l29.6"></a><span id="l29.6">   skin/classic/messenger-newsblog/rss-feed-folder@2x.png         (mail/newsblog/rss-feed-folder@2x.png)</span>
<a href="#l29.7"></a><span id="l29.7">   skin/classic/messenger/preferences/alwaysAsk.png               (mail/preferences/alwaysAsk.png)</span>
<a href="#l29.8"></a><span id="l29.8">   skin/classic/messenger/preferences/application.png             (mail/preferences/application.png)</span>
<a href="#l29.9"></a><span id="l29.9">   skin/classic/messenger/preferences/saveFile.png                (mail/preferences/saveFile.png)</span>
<a href="#l29.10"></a><span id="l29.10">   skin/classic/messenger/preferences/preferences.css             (mail/preferences/preferences.css)</span>
<a href="#l29.11"></a><span id="l29.11">   skin/classic/messenger/preferences/applications.css            (mail/preferences/applications.css)</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-  skin/classic/messenger/preferences/auth-error.png              (mail/preferences/auth-error.png)</span>
<a href="#l29.13"></a><span id="l29.13">   skin/classic/messenger/preferences/dialog.css                  (mail/preferences/dialog.css)</span>
<a href="#l29.14"></a><span id="l29.14">   skin/classic/messenger/preferences/aboutPreferences.css        (mail/preferences/aboutPreferences.css)</span>
<a href="#l29.15"></a><span id="l29.15">   skin/classic/messenger/smime/smime-compose.css                 (mail/smime/smime-compose.css)</span>
<a href="#l29.16"></a><span id="l29.16">   skin/classic/messenger/smime/msgHdrViewSMIMEOverlay.css        (mail/smime/msgHdrViewSMIMEOverlay.css)</span>
<a href="#l29.17"></a><span id="l29.17">   skin/classic/messenger/smime/msgReadSMIMEOverlay.css           (mail/smime/msgReadSMIMEOverlay.css)</span>
<a href="#l29.18"></a><span id="l29.18">   skin/classic/messenger/smime/msgReadSecurityInfo.css           (mail/smime/msgReadSecurityInfo.css)</span>
<a href="#l29.19"></a><span id="l29.19">   skin/classic/messenger/smime/msgCompSecurityInfo.css           (mail/smime/msgCompSecurityInfo.css)</span>
<a href="#l29.20"></a><span id="l29.20">   skin/classic/messenger/smime/certFetchingStatus.css            (mail/smime/certFetchingStatus.css)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mail/themes/osx/mail/preferences/applications.css</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mail/themes/osx/mail/preferences/applications.css</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -64,34 +64,11 @@ menuitem[appHandlerIcon=&quot;save&quot;] {</span>
<a href="#l30.4"></a><span id="l30.4"> }</span>
<a href="#l30.5"></a><span id="l30.5"> </span>
<a href="#l30.6"></a><span id="l30.6"> .cloudfileAccount &gt; textbox {</span>
<a href="#l30.7"></a><span id="l30.7">   min-height: unset;</span>
<a href="#l30.8"></a><span id="l30.8">   margin: 0;</span>
<a href="#l30.9"></a><span id="l30.9">   padding-inline-start: 4px;</span>
<a href="#l30.10"></a><span id="l30.10"> }</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-#authMessage {</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-  text-align: center;</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-  padding: 0px 80px;</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-}</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">-#authImage {</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineminus">-  list-style-image: url(&quot;chrome://messenger/skin/preferences/auth-error.png&quot;);</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineminus">-  width: 200px;</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineminus">-  height: 200px;</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineminus">-}</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineminus">-</span>
<a href="#l30.23"></a><span id="l30.23"> #cloudFileToggleAndThreshold {</span>
<a href="#l30.24"></a><span id="l30.24">   padding-bottom: 6px;</span>
<a href="#l30.25"></a><span id="l30.25"> }</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineminus">-</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineminus">-#cloudFileLoadingSpinner {</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineminus">-  width: 16px;</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineminus">-  height: 16px;</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/icons/loading.png&quot;);</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-}</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineminus">-</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineminus">-@media (min-resolution: 2dppx) {</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineminus">-  #cloudFileLoadingSpinner {</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineminus">-    list-style-image: url(&quot;chrome://global/skin/icons/loading@2x.png&quot;);</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineminus">-  }</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1">deleted file mode 100644</span>
<a href="#l31.2"></a><span id="l31.2">index 0efd4eb4d22b5df0b2bdaac351e85399f0b042ac..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l31.3"></a><span id="l31.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mail/themes/osx/mail/preferences/preferences.css</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mail/themes/osx/mail/preferences/preferences.css</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -200,18 +200,17 @@ a {</span>
<a href="#l32.4"></a><span id="l32.4"> }</span>
<a href="#l32.5"></a><span id="l32.5"> </span>
<a href="#l32.6"></a><span id="l32.6"> #provider-name h1 {</span>
<a href="#l32.7"></a><span id="l32.7">   margin: 0;</span>
<a href="#l32.8"></a><span id="l32.8">   font-size: 1.5em;</span>
<a href="#l32.9"></a><span id="l32.9">   font-weight: 600;</span>
<a href="#l32.10"></a><span id="l32.10"> }</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-/* Loading panel */</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-#cloudFileLoadingPanel, #cloudFileDefaultPanel {</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+#cloudFileDefaultPanel {</span>
<a href="#l32.15"></a><span id="l32.15">   text-align: center;</span>
<a href="#l32.16"></a><span id="l32.16">   padding-top: 150px;</span>
<a href="#l32.17"></a><span id="l32.17"> }</span>
<a href="#l32.18"></a><span id="l32.18"> </span>
<a href="#l32.19"></a><span id="l32.19"> #provider-settings .indented {</span>
<a href="#l32.20"></a><span id="l32.20">   margin-left: 75px;</span>
<a href="#l32.21"></a><span id="l32.21"> }</span>
<a href="#l32.22"></a><span id="l32.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mail/themes/shared/mail/incontentprefs/aboutPreferences.css</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mail/themes/shared/mail/incontentprefs/aboutPreferences.css</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -384,26 +384,41 @@ description &gt; html|a {</span>
<a href="#l33.4"></a><span id="l33.4">   cursor: pointer;</span>
<a href="#l33.5"></a><span id="l33.5"> }</span>
<a href="#l33.6"></a><span id="l33.6"> </span>
<a href="#l33.7"></a><span id="l33.7"> #provider-listing {</span>
<a href="#l33.8"></a><span id="l33.8">   width: 200px;</span>
<a href="#l33.9"></a><span id="l33.9"> }</span>
<a href="#l33.10"></a><span id="l33.10"> </span>
<a href="#l33.11"></a><span id="l33.11"> #addCloudFileAccountButtons button,</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-#removeCloudFileAccount {</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+#addCloudFileAccount,</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+#removeCloudFileAccount,</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+#moreProvidersLink {</span>
<a href="#l33.16"></a><span id="l33.16">   margin: 4px 0 0;</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+  text-align: center;</span>
<a href="#l33.18"></a><span id="l33.18"> }</span>
<a href="#l33.19"></a><span id="l33.19"> </span>
<a href="#l33.20"></a><span id="l33.20"> #addCloudFileAccountButtons button .button-icon {</span>
<a href="#l33.21"></a><span id="l33.21">   width: 16px;</span>
<a href="#l33.22"></a><span id="l33.22">   height: 16px;</span>
<a href="#l33.23"></a><span id="l33.23">   margin-inline-end: 8px;</span>
<a href="#l33.24"></a><span id="l33.24"> }</span>
<a href="#l33.25"></a><span id="l33.25"> </span>
<a href="#l33.26"></a><span id="l33.26" class="difflineplus">+#addCloudFileAccountListItems {</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+  text-align: start;</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineplus">+}</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineplus">+</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineplus">+#addCloudFileAccountListItems &gt; menuitem &gt; .menu-iconic-left {</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+  display: -moz-box;</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+}</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineplus">+</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+#moreProvidersLink {</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineplus">+  padding: 4px;</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+}</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineplus">+</span>
<a href="#l33.38"></a><span id="l33.38"> #paneChat {</span>
<a href="#l33.39"></a><span id="l33.39">   padding-top: 15px;</span>
<a href="#l33.40"></a><span id="l33.40">   padding-bottom: 15px;</span>
<a href="#l33.41"></a><span id="l33.41"> }</span>
<a href="#l33.42"></a><span id="l33.42"> </span>
<a href="#l33.43"></a><span id="l33.43"> tabs {</span>
<a href="#l33.44"></a><span id="l33.44">   margin-inline-end: 4px; /* add the 4px end-margin of other elements */</span>
<a href="#l33.45"></a><span id="l33.45"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mail/themes/windows/jar.mn</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mail/themes/windows/jar.mn</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -85,17 +85,16 @@ classic.jar:</span>
<a href="#l34.4"></a><span id="l34.4">   skin/classic/messenger/cloudfile/Hightail/fileExceedsLimit.css       (mail/cloudfile/Hightail/fileExceedsLimit.css)</span>
<a href="#l34.5"></a><span id="l34.5">   skin/classic/messenger/cloudfile/Hightail/check.png                  (mail/cloudfile/Hightail/check.png)</span>
<a href="#l34.6"></a><span id="l34.6">   skin/classic/messenger/messengercompose/messengercompose.css (mail/compose/messengercompose.css)</span>
<a href="#l34.7"></a><span id="l34.7">   skin/classic/messenger/downloads/aboutDownloads.css         (mail/downloads/aboutDownloads.css)</span>
<a href="#l34.8"></a><span id="l34.8">   skin/classic/messenger/preferences/aboutPreferences.css     (mail/preferences/aboutPreferences.css)</span>
<a href="#l34.9"></a><span id="l34.9">   skin/classic/messenger/preferences/alwaysAsk.png            (mail/preferences/alwaysAsk.png)</span>
<a href="#l34.10"></a><span id="l34.10">   skin/classic/messenger/preferences/application.png          (mail/preferences/application.png)</span>
<a href="#l34.11"></a><span id="l34.11">   skin/classic/messenger/preferences/applications.css         (mail/preferences/applications.css)</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  skin/classic/messenger/preferences/auth-error.png           (mail/preferences/auth-error.png)</span>
<a href="#l34.13"></a><span id="l34.13">   skin/classic/messenger/preferences/dialog.css               (mail/preferences/dialog.css)</span>
<a href="#l34.14"></a><span id="l34.14">   skin/classic/messenger/preferences/preferences.css          (mail/preferences/preferences.css)</span>
<a href="#l34.15"></a><span id="l34.15">   skin/classic/messenger/preferences/saveFile.png             (mail/preferences/saveFile.png)</span>
<a href="#l34.16"></a><span id="l34.16">   skin/classic/messenger/smime/smime-compose.css              (mail/smime/smime-compose.css)</span>
<a href="#l34.17"></a><span id="l34.17">   skin/classic/messenger/smime/msgHdrViewSMIMEOverlay.css     (mail/smime/msgHdrViewSMIMEOverlay.css)</span>
<a href="#l34.18"></a><span id="l34.18">   skin/classic/messenger/smime/msgReadSMIMEOverlay.css        (mail/smime/msgReadSMIMEOverlay.css)</span>
<a href="#l34.19"></a><span id="l34.19">   skin/classic/messenger/smime/msgReadSecurityInfo.css        (mail/smime/msgReadSecurityInfo.css)</span>
<a href="#l34.20"></a><span id="l34.20">   skin/classic/messenger/smime/msgCompSecurityInfo.css        (mail/smime/msgCompSecurityInfo.css)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mail/themes/windows/mail/preferences/applications.css</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mail/themes/windows/mail/preferences/applications.css</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -64,34 +64,11 @@ menuitem[appHandlerIcon=&quot;save&quot;] {</span>
<a href="#l35.4"></a><span id="l35.4"> }</span>
<a href="#l35.5"></a><span id="l35.5"> </span>
<a href="#l35.6"></a><span id="l35.6"> .cloudfileAccount &gt; textbox {</span>
<a href="#l35.7"></a><span id="l35.7">   min-height: unset;</span>
<a href="#l35.8"></a><span id="l35.8">   margin: 0;</span>
<a href="#l35.9"></a><span id="l35.9">   padding-inline-start: 4px;</span>
<a href="#l35.10"></a><span id="l35.10"> }</span>
<a href="#l35.11"></a><span id="l35.11"> </span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-#authMessage {</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-  text-align: center;</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineminus">-  padding: 0 80px;</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineminus">-}</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineminus">-</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineminus">-#authImage {</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineminus">-  list-style-image: url(&quot;chrome://messenger/skin/preferences/auth-error.png&quot;);</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineminus">-  width: 150px;</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineminus">-  height: 150px;</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineminus">-}</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineminus">-</span>
<a href="#l35.23"></a><span id="l35.23"> #cloudFileToggleAndThreshold {</span>
<a href="#l35.24"></a><span id="l35.24">   padding-bottom: 6px;</span>
<a href="#l35.25"></a><span id="l35.25"> }</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineminus">-</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineminus">-#cloudFileLoadingSpinner {</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineminus">-  width: 16px;</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineminus">-  height: 16px;</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/icons/loading.png&quot;);</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-}</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineminus">-</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineminus">-@media (min-resolution: 1.1dppx) {</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineminus">-  #cloudFileLoadingSpinner {</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineminus">-    list-style-image: url(&quot;chrome://global/skin/icons/loading@2x.png&quot;);</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineminus">-  }</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1">deleted file mode 100644</span>
<a href="#l36.2"></a><span id="l36.2">index 74b850beef5e5325346812d0e454f682bc5e76d3..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l36.3"></a><span id="l36.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mail/themes/windows/mail/preferences/preferences.css</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mail/themes/windows/mail/preferences/preferences.css</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -165,18 +165,17 @@ a {</span>
<a href="#l37.4"></a><span id="l37.4"> }</span>
<a href="#l37.5"></a><span id="l37.5"> </span>
<a href="#l37.6"></a><span id="l37.6"> #provider-name h1 {</span>
<a href="#l37.7"></a><span id="l37.7">   margin: 0;</span>
<a href="#l37.8"></a><span id="l37.8">   font-size: 1.5em;</span>
<a href="#l37.9"></a><span id="l37.9">   font-weight: 600;</span>
<a href="#l37.10"></a><span id="l37.10"> }</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-/* Loading panel */</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-#cloudFileLoadingPanel, #cloudFileDefaultPanel {</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+#cloudFileDefaultPanel {</span>
<a href="#l37.15"></a><span id="l37.15">   text-align: center;</span>
<a href="#l37.16"></a><span id="l37.16">   padding-top: 120px;</span>
<a href="#l37.17"></a><span id="l37.17"> }</span>
<a href="#l37.18"></a><span id="l37.18"> </span>
<a href="#l37.19"></a><span id="l37.19"> /* Flexing */</span>
<a href="#l37.20"></a><span id="l37.20"> #provider-management {</span>
<a href="#l37.21"></a><span id="l37.21">   display: block;</span>
<a href="#l37.22"></a><span id="l37.22">   -moz-box-orient: vertical;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgAttachment.idl</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgAttachment.idl</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -43,17 +43,17 @@ interface nsIMsgAttachment : nsISupports</span>
<a href="#l38.4"></a><span id="l38.4">   /**</span>
<a href="#l38.5"></a><span id="l38.5">    * Are we storing this attachment via a cloud provider and linking to it?</span>
<a href="#l38.6"></a><span id="l38.6">    */</span>
<a href="#l38.7"></a><span id="l38.7">   attribute boolean sendViaCloud;</span>
<a href="#l38.8"></a><span id="l38.8"> </span>
<a href="#l38.9"></a><span id="l38.9">   /**</span>
<a href="#l38.10"></a><span id="l38.10">    * Cloud provider account key for this attachment, if any.</span>
<a href="#l38.11"></a><span id="l38.11">    */</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-  attribute ACString cloudProviderKey;</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+  attribute ACString cloudFileAccountKey;</span>
<a href="#l38.14"></a><span id="l38.14"> </span>
<a href="#l38.15"></a><span id="l38.15">   /**</span>
<a href="#l38.16"></a><span id="l38.16">    * This allows the compose front end code to put whatever html annotation</span>
<a href="#l38.17"></a><span id="l38.17">    * it wants for the cloud part, e.g., with expiration time, etc.</span>
<a href="#l38.18"></a><span id="l38.18">    */</span>
<a href="#l38.19"></a><span id="l38.19">   attribute AString htmlAnnotation;</span>
<a href="#l38.20"></a><span id="l38.20"> </span>
<a href="#l38.21"></a><span id="l38.21">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachment.cpp</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachment.cpp</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -95,26 +95,26 @@ NS_IMETHODIMP nsMsgAttachment::SetHtmlAn</span>
<a href="#l39.4"></a><span id="l39.4"> </span>
<a href="#l39.5"></a><span id="l39.5"> NS_IMETHODIMP nsMsgAttachment::GetHtmlAnnotation(nsAString &amp;aAnnotation)</span>
<a href="#l39.6"></a><span id="l39.6"> {</span>
<a href="#l39.7"></a><span id="l39.7">   aAnnotation = mHtmlAnnotation;</span>
<a href="#l39.8"></a><span id="l39.8">   return NS_OK;</span>
<a href="#l39.9"></a><span id="l39.9"> }</span>
<a href="#l39.10"></a><span id="l39.10"> </span>
<a href="#l39.11"></a><span id="l39.11"> NS_IMETHODIMP</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-nsMsgAttachment::SetCloudProviderKey(const nsACString &amp;aCloudProviderKey)</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+nsMsgAttachment::SetCloudFileAccountKey(const nsACString &amp;aCloudFileAccountKey)</span>
<a href="#l39.14"></a><span id="l39.14"> {</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineminus">-  mCloudProviderKey = aCloudProviderKey;</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineplus">+  mCloudFileAccountKey = aCloudFileAccountKey;</span>
<a href="#l39.17"></a><span id="l39.17">   return NS_OK;</span>
<a href="#l39.18"></a><span id="l39.18"> }</span>
<a href="#l39.19"></a><span id="l39.19"> </span>
<a href="#l39.20"></a><span id="l39.20"> NS_IMETHODIMP</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineminus">-nsMsgAttachment::GetCloudProviderKey(nsACString &amp;aCloudProviderKey)</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineplus">+nsMsgAttachment::GetCloudFileAccountKey(nsACString &amp;aCloudFileAccountKey)</span>
<a href="#l39.23"></a><span id="l39.23"> {</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineminus">-  aCloudProviderKey = mCloudProviderKey;</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineplus">+  aCloudFileAccountKey = mCloudFileAccountKey;</span>
<a href="#l39.26"></a><span id="l39.26">   return NS_OK;</span>
<a href="#l39.27"></a><span id="l39.27"> }</span>
<a href="#l39.28"></a><span id="l39.28"> </span>
<a href="#l39.29"></a><span id="l39.29"> NS_IMETHODIMP nsMsgAttachment::GetContentLocation(nsACString &amp;aContentLocation)</span>
<a href="#l39.30"></a><span id="l39.30"> {</span>
<a href="#l39.31"></a><span id="l39.31">   aContentLocation = mContentLocation;</span>
<a href="#l39.32"></a><span id="l39.32">   return NS_OK;</span>
<a href="#l39.33"></a><span id="l39.33"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachment.h</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachment.h</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -21,17 +21,17 @@ private:</span>
<a href="#l40.4"></a><span id="l40.4">   virtual ~nsMsgAttachment();</span>
<a href="#l40.5"></a><span id="l40.5">   nsresult DeleteAttachment();</span>
<a href="#l40.6"></a><span id="l40.6"> </span>
<a href="#l40.7"></a><span id="l40.7">   nsString    mName;</span>
<a href="#l40.8"></a><span id="l40.8">   nsCString   mUrl;</span>
<a href="#l40.9"></a><span id="l40.9">   nsCString   mUrlCharset;</span>
<a href="#l40.10"></a><span id="l40.10">   bool        mTemporary;</span>
<a href="#l40.11"></a><span id="l40.11">   bool        mSendViaCloud;</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-  nsCString   mCloudProviderKey;</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+  nsCString   mCloudFileAccountKey;</span>
<a href="#l40.14"></a><span id="l40.14">   nsCString   mContentLocation;</span>
<a href="#l40.15"></a><span id="l40.15">   nsCString   mContentType;</span>
<a href="#l40.16"></a><span id="l40.16">   nsCString   mContentTypeParam;</span>
<a href="#l40.17"></a><span id="l40.17">   nsCString   mCharset;</span>
<a href="#l40.18"></a><span id="l40.18">   nsCString   mMacType;</span>
<a href="#l40.19"></a><span id="l40.19">   nsCString   mMacCreator;</span>
<a href="#l40.20"></a><span id="l40.20">   nsString    mHtmlAnnotation;</span>
<a href="#l40.21"></a><span id="l40.21">   int64_t     mSize;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.h</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.h</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -154,17 +154,17 @@ public:</span>
<a href="#l41.4"></a><span id="l41.4">                                           // NOT the original file!</span>
<a href="#l41.5"></a><span id="l41.5"> </span>
<a href="#l41.6"></a><span id="l41.6">   bool                  mMHTMLPart;           // This is true if its an MHTML part, otherwise, false</span>
<a href="#l41.7"></a><span id="l41.7">   bool                  mPartUserOmissionOverride;  // This is true if the user send send the email without this part</span>
<a href="#l41.8"></a><span id="l41.8">   bool                  mMainBody;            // True if this is a main body.</span>
<a href="#l41.9"></a><span id="l41.9">    // true if this should be sent as a link to a file.</span>
<a href="#l41.10"></a><span id="l41.10">   bool                  mSendViaCloud;</span>
<a href="#l41.11"></a><span id="l41.11">   nsString              mHtmlAnnotation;</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-  nsCString             mCloudProviderKey;</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+  nsCString             mCloudFileAccountKey;</span>
<a href="#l41.14"></a><span id="l41.14">   nsCString             mCloudUrl;</span>
<a href="#l41.15"></a><span id="l41.15">   int32_t mNodeIndex; //If this is an embedded image, this is the index of the</span>
<a href="#l41.16"></a><span id="l41.16">                       // corresponding domNode in the editor's</span>
<a href="#l41.17"></a><span id="l41.17">                       //GetEmbeddedObjects. Otherwise, it will be -1.</span>
<a href="#l41.18"></a><span id="l41.18">   //</span>
<a href="#l41.19"></a><span id="l41.19">   // Vars for analyzing file data...</span>
<a href="#l41.20"></a><span id="l41.20">   //</span>
<a href="#l41.21"></a><span id="l41.21">   uint32_t              m_size;         /* Some state used while filtering it */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -1122,17 +1122,17 @@ nsMsgComposeAndSend::PreProcessPart(nsMs</span>
<a href="#l42.4"></a><span id="l42.4">     // Need to add some headers so that libmime can restore the cloud info</span>
<a href="#l42.5"></a><span id="l42.5">     // when loading a draft message.</span>
<a href="#l42.6"></a><span id="l42.6">     nsCString draftInfo(HEADER_X_MOZILLA_CLOUD_PART&quot;: cloudFile; url=&quot;);</span>
<a href="#l42.7"></a><span id="l42.7">     draftInfo.Append(ma-&gt;mCloudUrl.get());</span>
<a href="#l42.8"></a><span id="l42.8">     // don't leak user file paths or account keys to recipients.</span>
<a href="#l42.9"></a><span id="l42.9">     if (m_deliver_mode == nsMsgSaveAsDraft)</span>
<a href="#l42.10"></a><span id="l42.10">     {</span>
<a href="#l42.11"></a><span id="l42.11">       draftInfo.AppendLiteral(&quot;; provider=&quot;);</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-      draftInfo.Append(ma-&gt;mCloudProviderKey.get());</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+      draftInfo.Append(ma-&gt;mCloudFileAccountKey.get());</span>
<a href="#l42.14"></a><span id="l42.14">       draftInfo.AppendLiteral(&quot;; file=&quot;);</span>
<a href="#l42.15"></a><span id="l42.15">       draftInfo.Append(urlSpec.get());</span>
<a href="#l42.16"></a><span id="l42.16">     }</span>
<a href="#l42.17"></a><span id="l42.17">     draftInfo.AppendLiteral(&quot;; name=&quot;);</span>
<a href="#l42.18"></a><span id="l42.18">     draftInfo.Append(ma-&gt;m_realName.get());</span>
<a href="#l42.19"></a><span id="l42.19">     draftInfo.Append(CRLF);</span>
<a href="#l42.20"></a><span id="l42.20">     part-&gt;AppendOtherHeaders(draftInfo.get());</span>
<a href="#l42.21"></a><span id="l42.21">     part-&gt;SetType(&quot;application/octet-stream&quot;);</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineat">@@ -1952,23 +1952,23 @@ nsMsgComposeAndSend::AddCompFieldLocalAt</span>
<a href="#l42.23"></a><span id="l42.23">       m_attachments[newLoc]-&gt;mSendViaCloud = sendViaCloud;</span>
<a href="#l42.24"></a><span id="l42.24">       attachment-&gt;GetUrl(url);</span>
<a href="#l42.25"></a><span id="l42.25">       if (!url.IsEmpty())</span>
<a href="#l42.26"></a><span id="l42.26">       {</span>
<a href="#l42.27"></a><span id="l42.27">         bool sendViaCloud;</span>
<a href="#l42.28"></a><span id="l42.28">         attachment-&gt;GetSendViaCloud(&amp;sendViaCloud);</span>
<a href="#l42.29"></a><span id="l42.29">         if (sendViaCloud)</span>
<a href="#l42.30"></a><span id="l42.30">         {</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineminus">-          nsCString cloudProviderKey;</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+          nsCString cloudFileAccountKey;</span>
<a href="#l42.33"></a><span id="l42.33">           // We'd like to output a part for the attachment, just an html part</span>
<a href="#l42.34"></a><span id="l42.34">           // with information about how to download the attachment.</span>
<a href="#l42.35"></a><span id="l42.35">           // m_attachments[newLoc]-&gt;m_done = true;</span>
<a href="#l42.36"></a><span id="l42.36">           attachment-&gt;GetHtmlAnnotation(m_attachments[newLoc]-&gt;mHtmlAnnotation);</span>
<a href="#l42.37"></a><span id="l42.37">           m_attachments[newLoc]-&gt;m_type.AssignLiteral(&quot;text/html&quot;);</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineminus">-          attachment-&gt;GetCloudProviderKey(m_attachments[newLoc]-&gt;mCloudProviderKey);</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineplus">+          attachment-&gt;GetCloudFileAccountKey(m_attachments[newLoc]-&gt;mCloudFileAccountKey);</span>
<a href="#l42.40"></a><span id="l42.40">           attachment-&gt;GetContentLocation(m_attachments[newLoc]-&gt;mCloudUrl);</span>
<a href="#l42.41"></a><span id="l42.41">         }</span>
<a href="#l42.42"></a><span id="l42.42">         // Just look for local file:// attachments and do the right thing.</span>
<a href="#l42.43"></a><span id="l42.43">         if (nsMsgIsLocalFile(url.get()))</span>
<a href="#l42.44"></a><span id="l42.44">         {</span>
<a href="#l42.45"></a><span id="l42.45">           //</span>
<a href="#l42.46"></a><span id="l42.46">           // Now we have to setup the m_attachments entry for the file://</span>
<a href="#l42.47"></a><span id="l42.47">           // URL that is passed in...</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_messageHeaders.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_messageHeaders.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -394,17 +394,17 @@ async function testContentHeaders() {</span>
<a href="#l43.4"></a><span id="l43.4">     &quot;Content-Location&quot;: undefined,</span>
<a href="#l43.5"></a><span id="l43.5">   }, &quot;1&quot;);</span>
<a href="#l43.6"></a><span id="l43.6">   checkDraftHeaders(httpAttachmentHeaders, &quot;2&quot;);</span>
<a href="#l43.7"></a><span id="l43.7"> </span>
<a href="#l43.8"></a><span id="l43.8">   fields.characterSet = &quot;UTF-8&quot;;</span>
<a href="#l43.9"></a><span id="l43.9">   let cloudAttachment = makeAttachment({</span>
<a href="#l43.10"></a><span id="l43.10">     url: Services.io.newFileURI(do_get_file(&quot;data/test-UTF-8.txt&quot;)).spec,</span>
<a href="#l43.11"></a><span id="l43.11">     sendViaCloud: true,</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-    cloudProviderKey: &quot;akey&quot;,</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+    cloudFileAccountKey: &quot;akey&quot;,</span>
<a href="#l43.14"></a><span id="l43.14">     name: &quot;attachment.html&quot;,</span>
<a href="#l43.15"></a><span id="l43.15">     contentLocation: &quot;http://localhost.invalid/&quot;,</span>
<a href="#l43.16"></a><span id="l43.16">   });</span>
<a href="#l43.17"></a><span id="l43.17">   let cloudAttachmentHeaders = {</span>
<a href="#l43.18"></a><span id="l43.18">     &quot;Content-Type&quot;: &quot;application/octet-stream&quot;,</span>
<a href="#l43.19"></a><span id="l43.19">     &quot;X-Mozilla-Cloud-Part&quot;: &quot;cloudFile; url=http://localhost.invalid/; &quot; +</span>
<a href="#l43.20"></a><span id="l43.20">       &quot;provider=akey; &quot; +</span>
<a href="#l43.21"></a><span id="l43.21">       &quot;file=&quot; + cloudAttachment.url + &quot;; name=attachment.html&quot;,</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineat">@@ -517,17 +517,17 @@ async function testSentMessage() {</span>
<a href="#l43.23"></a><span id="l43.23">     }, identity);</span>
<a href="#l43.24"></a><span id="l43.24">     checkMessageHeaders(daemon.post, {</span>
<a href="#l43.25"></a><span id="l43.25">       &quot;Disposition-Notification-To&quot;: &quot;test@tinderbox.invalid&quot;,</span>
<a href="#l43.26"></a><span id="l43.26">       &quot;Return-Receipt-To&quot;: &quot;test@tinderbox.invalid&quot;,</span>
<a href="#l43.27"></a><span id="l43.27">     });</span>
<a href="#l43.28"></a><span id="l43.28">     let cloudAttachment = makeAttachment({</span>
<a href="#l43.29"></a><span id="l43.29">       url: Services.io.newFileURI(do_get_file(&quot;data/test-UTF-8.txt&quot;)).spec,</span>
<a href="#l43.30"></a><span id="l43.30">       sendViaCloud: true,</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineminus">-      cloudProviderKey: &quot;akey&quot;,</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineplus">+      cloudFileAccountKey: &quot;akey&quot;,</span>
<a href="#l43.33"></a><span id="l43.33">       name: &quot;attachment.html&quot;,</span>
<a href="#l43.34"></a><span id="l43.34">       contentLocation: &quot;http://localhost.invalid/&quot;,</span>
<a href="#l43.35"></a><span id="l43.35">     });</span>
<a href="#l43.36"></a><span id="l43.36">     await sendMessage({to: &quot;test@tinderbox.invalid&quot;}, identity, {},</span>
<a href="#l43.37"></a><span id="l43.37">       [cloudAttachment]);</span>
<a href="#l43.38"></a><span id="l43.38">     checkMessageHeaders(daemon.post, {</span>
<a href="#l43.39"></a><span id="l43.39">       &quot;Content-Type&quot;: &quot;application/octet-stream&quot;,</span>
<a href="#l43.40"></a><span id="l43.40">       &quot;X-Mozilla-Cloud-Part&quot;: &quot;cloudFile; url=http://localhost.invalid/; &quot; +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -199,17 +199,17 @@ nsresult CreateComposeParams(nsCOMPtr&lt;ns</span>
<a href="#l44.4"></a><span id="l44.4">             nsCString provider;</span>
<a href="#l44.5"></a><span id="l44.5">             nsCString cloudUrl;</span>
<a href="#l44.6"></a><span id="l44.6">             attachment-&gt;SetSendViaCloud(true);</span>
<a href="#l44.7"></a><span id="l44.7">             provider.Adopt(</span>
<a href="#l44.8"></a><span id="l44.8">                 MimeHeaders_get_parameter(curAttachment-&gt;m_cloudPartInfo.get(),</span>
<a href="#l44.9"></a><span id="l44.9">                                           &quot;provider&quot;, nullptr, nullptr));</span>
<a href="#l44.10"></a><span id="l44.10">             cloudUrl.Adopt(MimeHeaders_get_parameter(</span>
<a href="#l44.11"></a><span id="l44.11">                 curAttachment-&gt;m_cloudPartInfo.get(), &quot;url&quot;, nullptr, nullptr));</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-            attachment-&gt;SetCloudProviderKey(provider);</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+            attachment-&gt;SetCloudFileAccountKey(provider);</span>
<a href="#l44.14"></a><span id="l44.14">             attachment-&gt;SetContentLocation(cloudUrl);</span>
<a href="#l44.15"></a><span id="l44.15">           }</span>
<a href="#l44.16"></a><span id="l44.16">           compFields-&gt;AddAttachment(attachment);</span>
<a href="#l44.17"></a><span id="l44.17">         }</span>
<a href="#l44.18"></a><span id="l44.18">       }</span>
<a href="#l44.19"></a><span id="l44.19">       curAttachment++;</span>
<a href="#l44.20"></a><span id="l44.20">     }</span>
<a href="#l44.21"></a><span id="l44.21">   }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

