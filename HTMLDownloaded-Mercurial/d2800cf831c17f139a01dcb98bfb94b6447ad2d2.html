<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26429:d2800cf831c17f139a01dcb98bfb94b6447ad2d2</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ d2800cf831c17f139a01dcb98bfb94b6447ad2d2" />
<meta property="og:url" content="/comm-central/rev/d2800cf831c17f139a01dcb98bfb94b6447ad2d2" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/db. rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / d2800cf831c17f139a01dcb98bfb94b6447ad2d2 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/d2800cf831c17f139a01dcb98bfb94b6447ad2d2">shortlog</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/d2800cf831c17f139a01dcb98bfb94b6447ad2d2">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2">files</a> |
changeset |
<a href="/comm-central/raw-rev/d2800cf831c17f139a01dcb98bfb94b6447ad2d2">raw</a>  | <a href="/comm-central/archive/d2800cf831c17f139a01dcb98bfb94b6447ad2d2.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/db. rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 24 Apr 2019 16:33:07 +0200</td></tr>

<tr>
 <td>changeset 26429</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/d2800cf831c17f139a01dcb98bfb94b6447ad2d2">d2800cf831c17f139a01dcb98bfb94b6447ad2d2</a></td>
</tr>



<tr>
<td>parent 26428</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/58e7ebc66ab9bded01bf76bafba2288bc5ba45e4">58e7ebc66ab9bded01bf76bafba2288bc5ba45e4</a>
</td>
</tr>

<tr>
<td>child 26430</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/33f38e5bef3517802c7fc5a4c973f8c653ad1cee">33f38e5bef3517802c7fc5a4c973f8c653ad1cee</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=d2800cf831c17f139a01dcb98bfb94b6447ad2d2">15831</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 24 Apr 2019 14:40:57 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@2d54904493f8 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2d54904493f8b8e1252d720a869c741c0f11fe0b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2d54904493f8b8e1252d720a869c741c0f11fe0b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2d54904493f8b8e1252d720a869c741c0f11fe0b&newProject=comm-central&newRevision=d9de9c99bf922c2ee88afb525723eac2bf62a54e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2d54904493f8b8e1252d720a869c741c0f11fe0b&newProject=comm-central&newRevision=d9de9c99bf922c2ee88afb525723eac2bf62a54e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2d54904493f8b8e1252d720a869c741c0f11fe0b&newProject=comm-central&newRevision=d9de9c99bf922c2ee88afb525723eac2bf62a54e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/db. rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsDBFolderInfo.h">mailnews/db/msgdb/public/nsDBFolderInfo.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsDBFolderInfo.h">file</a> |
<a href="/comm-central/annotate/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsDBFolderInfo.h">annotate</a> |
<a href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsDBFolderInfo.h">diff</a> |
<a href="/comm-central/comparison/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsDBFolderInfo.h">comparison</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsDBFolderInfo.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsImapMailDatabase.h">mailnews/db/msgdb/public/nsImapMailDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsImapMailDatabase.h">file</a> |
<a href="/comm-central/annotate/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsImapMailDatabase.h">annotate</a> |
<a href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsImapMailDatabase.h">diff</a> |
<a href="/comm-central/comparison/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsImapMailDatabase.h">comparison</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsImapMailDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMailDatabase.h">mailnews/db/msgdb/public/nsMailDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMailDatabase.h">file</a> |
<a href="/comm-central/annotate/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMailDatabase.h">annotate</a> |
<a href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMailDatabase.h">diff</a> |
<a href="/comm-central/comparison/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMailDatabase.h">comparison</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMailDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgDBCID.h">mailnews/db/msgdb/public/nsMsgDBCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgDBCID.h">file</a> |
<a href="/comm-central/annotate/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgDBCID.h">annotate</a> |
<a href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgDBCID.h">diff</a> |
<a href="/comm-central/comparison/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgDBCID.h">comparison</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgDBCID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgDatabase.h">mailnews/db/msgdb/public/nsMsgDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgDatabase.h">file</a> |
<a href="/comm-central/annotate/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgDatabase.h">annotate</a> |
<a href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgDatabase.h">diff</a> |
<a href="/comm-central/comparison/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgDatabase.h">comparison</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgHdr.h">mailnews/db/msgdb/public/nsMsgHdr.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgHdr.h">file</a> |
<a href="/comm-central/annotate/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgHdr.h">annotate</a> |
<a href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgHdr.h">diff</a> |
<a href="/comm-central/comparison/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgHdr.h">comparison</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgHdr.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgThread.h">mailnews/db/msgdb/public/nsMsgThread.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgThread.h">file</a> |
<a href="/comm-central/annotate/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgThread.h">annotate</a> |
<a href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgThread.h">diff</a> |
<a href="/comm-central/comparison/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgThread.h">comparison</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsMsgThread.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsNewsDatabase.h">mailnews/db/msgdb/public/nsNewsDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsNewsDatabase.h">file</a> |
<a href="/comm-central/annotate/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsNewsDatabase.h">annotate</a> |
<a href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsNewsDatabase.h">diff</a> |
<a href="/comm-central/comparison/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsNewsDatabase.h">comparison</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/public/nsNewsDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">mailnews/db/msgdb/src/nsDBFolderInfo.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">file</a> |
<a href="/comm-central/annotate/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">annotate</a> |
<a href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">diff</a> |
<a href="/comm-central/comparison/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">comparison</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">mailnews/db/msgdb/src/nsImapMailDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">file</a> |
<a href="/comm-central/annotate/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">comparison</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMailDatabase.cpp">mailnews/db/msgdb/src/nsMailDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMailDatabase.cpp">file</a> |
<a href="/comm-central/annotate/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMailDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMailDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMailDatabase.cpp">comparison</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMailDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgHdr.cpp">mailnews/db/msgdb/src/nsMsgHdr.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgHdr.cpp">file</a> |
<a href="/comm-central/annotate/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgHdr.cpp">annotate</a> |
<a href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgHdr.cpp">diff</a> |
<a href="/comm-central/comparison/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgHdr.cpp">comparison</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgHdr.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp">mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp">file</a> |
<a href="/comm-central/annotate/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp">annotate</a> |
<a href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp">diff</a> |
<a href="/comm-central/comparison/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp">comparison</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.h">mailnews/db/msgdb/src/nsMsgOfflineImapOperation.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.h">file</a> |
<a href="/comm-central/annotate/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.h">annotate</a> |
<a href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.h">diff</a> |
<a href="/comm-central/comparison/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.h">comparison</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgThread.cpp">mailnews/db/msgdb/src/nsMsgThread.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgThread.cpp">file</a> |
<a href="/comm-central/annotate/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgThread.cpp">annotate</a> |
<a href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgThread.cpp">diff</a> |
<a href="/comm-central/comparison/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgThread.cpp">comparison</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsMsgThread.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsNewsDatabase.cpp">mailnews/db/msgdb/src/nsNewsDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsNewsDatabase.cpp">file</a> |
<a href="/comm-central/annotate/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsNewsDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsNewsDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsNewsDatabase.cpp">comparison</a> |
<a href="/comm-central/log/d2800cf831c17f139a01dcb98bfb94b6447ad2d2/mailnews/db/msgdb/src/nsNewsDatabase.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsDBFolderInfo.h</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsDBFolderInfo.h</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -14,122 +14,140 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;mdb.h&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsTArray.h&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &lt;time.h&gt;</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> class nsMsgDatabase;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-// again, this could inherit from nsISupports, but I don't see the need as of yet.</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-// I'm not sure it needs to be ref-counted (but I think it does).</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+// again, this could inherit from nsISupports, but I don't see the need as of</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+// yet. I'm not sure it needs to be ref-counted (but I think it does).</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-// I think these getters and setters really need to go through mdb and not rely on the object</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-// caching the values. If this somehow turns out to be prohibitively expensive, we can invent</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-// some sort of dirty mechanism, but I think it turns out that these values will be cached by</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-// the MSG_FolderInfo's anyway.</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-class nsDBFolderInfo : public nsIDBFolderInfo</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-{</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-public:</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+// I think these getters and setters really need to go through mdb and not rely</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+// on the object caching the values. If this somehow turns out to be</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+// prohibitively expensive, we can invent some sort of dirty mechanism, but I</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+// think it turns out that these values will be cached by the MSG_FolderInfo's</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+// anyway.</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+class nsDBFolderInfo : public nsIDBFolderInfo {</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+ public:</span>
<a href="#l1.31"></a><span id="l1.31">   friend class nsMsgDatabase;</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33">   explicit nsDBFolderInfo(nsMsgDatabase *mdb);</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35">   NS_DECL_ISUPPORTS</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-    // interface methods.</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-    NS_DECL_NSIDBFOLDERINFO</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-    // create the appropriate table and row in a new db.</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-    nsresult AddToNewMDB();</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+  // interface methods.</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+  NS_DECL_NSIDBFOLDERINFO</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+  // create the appropriate table and row in a new db.</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+  nsresult AddToNewMDB();</span>
<a href="#l1.44"></a><span id="l1.44">   // accessor methods.</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-  bool      TestFlag(int32_t flags);</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-  int16_t   GetIMAPHierarchySeparator() ;</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-  void      SetIMAPHierarchySeparator(int16_t hierarchyDelimiter) ;</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-  void      ChangeImapTotalPendingMessages(int32_t delta);</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-  void      ChangeImapUnreadPendingMessages(int32_t delta) ;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  bool TestFlag(int32_t flags);</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+  int16_t GetIMAPHierarchySeparator();</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+  void SetIMAPHierarchySeparator(int16_t hierarchyDelimiter);</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+  void ChangeImapTotalPendingMessages(int32_t delta);</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+  void ChangeImapUnreadPendingMessages(int32_t delta);</span>
<a href="#l1.56"></a><span id="l1.56"> </span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-  nsresult      InitFromExistingDB();</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+  nsresult InitFromExistingDB();</span>
<a href="#l1.59"></a><span id="l1.59">   // get and set arbitrary property, aka row cell value.</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-  nsresult SetPropertyWithToken(mdb_token aProperty, const nsAString &amp;propertyStr);</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-  nsresult SetUint32PropertyWithToken(mdb_token aProperty, uint32_t propertyValue);</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-  nsresult SetInt64PropertyWithToken(mdb_token aProperty, int64_t propertyValue);</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-  nsresult SetInt32PropertyWithToken(mdb_token aProperty, int32_t propertyValue);</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+  nsresult SetPropertyWithToken(mdb_token aProperty,</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+                                const nsAString &amp;propertyStr);</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+  nsresult SetUint32PropertyWithToken(mdb_token aProperty,</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+                                      uint32_t propertyValue);</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+  nsresult SetInt64PropertyWithToken(mdb_token aProperty,</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+                                     int64_t propertyValue);</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+  nsresult SetInt32PropertyWithToken(mdb_token aProperty,</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+                                     int32_t propertyValue);</span>
<a href="#l1.72"></a><span id="l1.72">   nsresult GetPropertyWithToken(mdb_token aProperty, nsAString &amp;propertyValue);</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-  nsresult GetUint32PropertyWithToken(mdb_token aProperty, uint32_t &amp;propertyValue, uint32_t defaultValue = 0);</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-  nsresult GetInt32PropertyWithToken(mdb_token aProperty, int32_t &amp;propertyValue, int32_t defaultValue = 0);</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+  nsresult GetUint32PropertyWithToken(mdb_token aProperty,</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+                                      uint32_t &amp;propertyValue,</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+                                      uint32_t defaultValue = 0);</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+  nsresult GetInt32PropertyWithToken(mdb_token aProperty,</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+                                     int32_t &amp;propertyValue,</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+                                     int32_t defaultValue = 0);</span>
<a href="#l1.81"></a><span id="l1.81">   nsresult GetInt64PropertyWithToken(mdb_token aProperty,</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-                                     int64_t &amp;propertyValue, int64_t defaultValue = 0);</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+                                     int64_t &amp;propertyValue,</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+                                     int64_t defaultValue = 0);</span>
<a href="#l1.85"></a><span id="l1.85"> </span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-  nsTArray&lt;nsMsgKey&gt; m_lateredKeys; // list of latered messages</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; m_lateredKeys;  // list of latered messages</span>
<a href="#l1.88"></a><span id="l1.88"> </span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-  virtual size_t SizeOfExcludingThis(mozilla::MallocSizeOf aMallocSizeOf) const</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-  {</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+  virtual size_t SizeOfExcludingThis(</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+      mozilla::MallocSizeOf aMallocSizeOf) const {</span>
<a href="#l1.93"></a><span id="l1.93">     return m_lateredKeys.ShallowSizeOfExcludingThis(aMallocSizeOf);</span>
<a href="#l1.94"></a><span id="l1.94">   }</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-  virtual size_t SizeOfIncludingThis(mozilla::MallocSizeOf aMallocSizeOf) const</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-  {</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+  virtual size_t SizeOfIncludingThis(</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+      mozilla::MallocSizeOf aMallocSizeOf) const {</span>
<a href="#l1.99"></a><span id="l1.99">     return aMallocSizeOf(this) + SizeOfExcludingThis(aMallocSizeOf);</span>
<a href="#l1.100"></a><span id="l1.100">   }</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-protected:</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+ protected:</span>
<a href="#l1.104"></a><span id="l1.104">   virtual ~nsDBFolderInfo();</span>
<a href="#l1.105"></a><span id="l1.105"> </span>
<a href="#l1.106"></a><span id="l1.106">   // initialize from appropriate table and row in existing db.</span>
<a href="#l1.107"></a><span id="l1.107">   nsresult InitMDBInfo();</span>
<a href="#l1.108"></a><span id="l1.108">   nsresult LoadMemberVariables();</span>
<a href="#l1.109"></a><span id="l1.109"> </span>
<a href="#l1.110"></a><span id="l1.110">   nsresult AdjustHighWater(nsMsgKey highWater, bool force);</span>
<a href="#l1.111"></a><span id="l1.111"> </span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-  void ReleaseExternalReferences(); // let go of any references to other objects.</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+  void</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+  ReleaseExternalReferences();  // let go of any references to other objects.</span>
<a href="#l1.115"></a><span id="l1.115"> </span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-  int64_t   m_folderSize;</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-  int64_t   m_expungedBytes; // sum of size of deleted messages in folder</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-  uint32_t  m_folderDate;</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-  nsMsgKey  m_highWaterMessageKey; // largest news article number or imap uid whose header we've seen</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+  int64_t m_folderSize;</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+  int64_t m_expungedBytes;  // sum of size of deleted messages in folder</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+  uint32_t m_folderDate;</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+  nsMsgKey m_highWaterMessageKey;  // largest news article number or imap uid</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+                                   // whose header we've seen</span>
<a href="#l1.125"></a><span id="l1.125"> </span>
<a href="#l1.126"></a><span id="l1.126" class="difflineminus">-  //  m_numUnreadMessages and m_numMessages can never be negative. 0 means 'no msgs'.</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineminus">-  int32_t   m_numUnreadMessages;</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-  int32_t   m_numMessages;    // includes expunged and ignored messages</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+  //  m_numUnreadMessages and m_numMessages can never be negative. 0 means 'no</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+  //  msgs'.</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+  int32_t m_numUnreadMessages;</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+  int32_t m_numMessages;  // includes expunged and ignored messages</span>
<a href="#l1.133"></a><span id="l1.133"> </span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-  int32_t   m_flags;  // folder specific flags. This holds things like re-use thread pane,</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-  // configured for off-line use, use default retrieval, purge article/header options</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+  int32_t m_flags;  // folder specific flags. This holds things like re-use</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+                    // thread pane,</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+  // configured for off-line use, use default retrieval, purge article/header</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+  // options</span>
<a href="#l1.140"></a><span id="l1.140"> </span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-  uint16_t    m_version;                // for upgrading...</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-  int16_t     m_IMAPHierarchySeparator; // imap path separator</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+  uint16_t m_version;                // for upgrading...</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+  int16_t m_IMAPHierarchySeparator;  // imap path separator</span>
<a href="#l1.145"></a><span id="l1.145"> </span>
<a href="#l1.146"></a><span id="l1.146">   // mail only (for now)</span>
<a href="#l1.147"></a><span id="l1.147"> </span>
<a href="#l1.148"></a><span id="l1.148">   // IMAP only</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-  int32_t     m_ImapUidValidity;</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineminus">-  int32_t     m_totalPendingMessages;</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-  int32_t     m_unreadPendingMessages;</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+  int32_t m_ImapUidValidity;</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+  int32_t m_totalPendingMessages;</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+  int32_t m_unreadPendingMessages;</span>
<a href="#l1.155"></a><span id="l1.155"> </span>
<a href="#l1.156"></a><span id="l1.156">   // news only (for now)</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-  nsMsgKey    m_expiredMark;  // Highest invalid article number in group - for expiring</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-  // the db folder info will have to know what db and row it belongs to, since it is really</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-  // just a wrapper around the singleton folder info row in the mdb.</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+  nsMsgKey</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+      m_expiredMark;  // Highest invalid article number in group - for expiring</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+  // the db folder info will have to know what db and row it belongs to, since</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+  // it is really just a wrapper around the singleton folder info row in the</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+  // mdb.</span>
<a href="#l1.165"></a><span id="l1.165">   nsMsgDatabase *m_mdb;</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-  nsIMdbTable   *m_mdbTable;  // singleton table in db</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-  nsIMdbRow     *m_mdbRow;    // singleton row in table;</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+  nsIMdbTable *m_mdbTable;  // singleton table in db</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+  nsIMdbRow *m_mdbRow;      // singleton row in table;</span>
<a href="#l1.170"></a><span id="l1.170"> </span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-  nsCString     m_charSet;</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-  bool          m_charSetOverride;</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-  bool          m_mdbTokensInitialized;</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+  nsCString m_charSet;</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+  bool m_charSetOverride;</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+  bool m_mdbTokensInitialized;</span>
<a href="#l1.177"></a><span id="l1.177"> </span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-  mdb_token     m_rowScopeToken;</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-  mdb_token     m_tableKindToken;</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-  // tokens for the pre-set columns - we cache these for speed, which may be silly</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-  mdb_token     m_mailboxNameColumnToken;</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-  mdb_token     m_numMessagesColumnToken;</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-  mdb_token     m_numUnreadMessagesColumnToken;</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-  mdb_token     m_flagsColumnToken;</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-  mdb_token     m_folderSizeColumnToken;</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-  mdb_token     m_expungedBytesColumnToken;</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-  mdb_token     m_folderDateColumnToken;</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-  mdb_token     m_highWaterMessageKeyColumnToken;</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+  mdb_token m_rowScopeToken;</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+  mdb_token m_tableKindToken;</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+  // tokens for the pre-set columns - we cache these for speed, which may be</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+  // silly</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+  mdb_token m_mailboxNameColumnToken;</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+  mdb_token m_numMessagesColumnToken;</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+  mdb_token m_numUnreadMessagesColumnToken;</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+  mdb_token m_flagsColumnToken;</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+  mdb_token m_folderSizeColumnToken;</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+  mdb_token m_expungedBytesColumnToken;</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+  mdb_token m_folderDateColumnToken;</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+  mdb_token m_highWaterMessageKeyColumnToken;</span>
<a href="#l1.201"></a><span id="l1.201"> </span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-  mdb_token     m_imapUidValidityColumnToken;</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-  mdb_token     m_totalPendingMessagesColumnToken;</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-  mdb_token     m_unreadPendingMessagesColumnToken;</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-  mdb_token     m_expiredMarkColumnToken;</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-  mdb_token     m_versionColumnToken;</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+  mdb_token m_imapUidValidityColumnToken;</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+  mdb_token m_totalPendingMessagesColumnToken;</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+  mdb_token m_unreadPendingMessagesColumnToken;</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+  mdb_token m_expiredMarkColumnToken;</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+  mdb_token m_versionColumnToken;</span>
<a href="#l1.212"></a><span id="l1.212"> };</span>
<a href="#l1.213"></a><span id="l1.213"> </span>
<a href="#l1.214"></a><span id="l1.214"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsImapMailDatabase.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsImapMailDatabase.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -3,48 +3,49 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.5"></a><span id="l2.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.6"></a><span id="l2.6"> #ifndef _nsImapMailDatabase_H_</span>
<a href="#l2.7"></a><span id="l2.7"> #define _nsImapMailDatabase_H_</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsMailDatabase.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-class nsImapMailDatabase : public nsMailDatabase</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-{</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-public:</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+class nsImapMailDatabase : public nsMailDatabase {</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ public:</span>
<a href="#l2.17"></a><span id="l2.17">   // OK, it's dumb that this should require a fileSpec, since there is no file</span>
<a href="#l2.18"></a><span id="l2.18">   // for the folder. This is mainly because we're deriving from nsMailDatabase;</span>
<a href="#l2.19"></a><span id="l2.19">   // Perhaps we shouldn't...</span>
<a href="#l2.20"></a><span id="l2.20">   nsImapMailDatabase();</span>
<a href="#l2.21"></a><span id="l2.21">   virtual ~nsImapMailDatabase();</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-  NS_IMETHOD    GetSummaryValid(bool *aResult) override;</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-  NS_IMETHOD    SetSummaryValid(bool valid = true) override;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+  NS_IMETHOD GetSummaryValid(bool *aResult) override;</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+  NS_IMETHOD SetSummaryValid(bool valid = true) override;</span>
<a href="#l2.27"></a><span id="l2.27">   virtual nsresult AdjustExpungedBytesOnDelete(nsIMsgDBHdr *msgHdr) override;</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-  NS_IMETHOD    ForceClosed() override;</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-  NS_IMETHOD    AddNewHdrToDB(nsIMsgDBHdr *newHdr, bool notify) override;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  NS_IMETHOD    SetAttributeOnPendingHdr(nsIMsgDBHdr *pendingHdr, const char *property,</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-                                         const char *propertyVal) override;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-  NS_IMETHOD    SetUint32AttributeOnPendingHdr(nsIMsgDBHdr *pendingHdr, const char *property,</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-                                               uint32_t propertyVal) override;</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-  NS_IMETHOD    SetUint64AttributeOnPendingHdr(nsIMsgDBHdr *aPendingHdr,</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-                                               const char *aProperty,</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-                                               uint64_t aPropertyVal) override;</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-  NS_IMETHOD    DeleteMessages(uint32_t aNumKeys, nsMsgKey* nsMsgKeys,</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-                               nsIDBChangeListener *instigator) override;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-  NS_IMETHOD    UpdatePendingAttributes(nsIMsgDBHdr* aNewHdr) override;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  NS_IMETHOD ForceClosed() override;</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+  NS_IMETHOD AddNewHdrToDB(nsIMsgDBHdr *newHdr, bool notify) override;</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+  NS_IMETHOD SetAttributeOnPendingHdr(nsIMsgDBHdr *pendingHdr,</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+                                      const char *property,</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+                                      const char *propertyVal) override;</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  NS_IMETHOD SetUint32AttributeOnPendingHdr(nsIMsgDBHdr *pendingHdr,</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+                                            const char *property,</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+                                            uint32_t propertyVal) override;</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+  NS_IMETHOD SetUint64AttributeOnPendingHdr(nsIMsgDBHdr *aPendingHdr,</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+                                            const char *aProperty,</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+                                            uint64_t aPropertyVal) override;</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  NS_IMETHOD DeleteMessages(uint32_t aNumKeys, nsMsgKey *nsMsgKeys,</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+                            nsIDBChangeListener *instigator) override;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+  NS_IMETHOD UpdatePendingAttributes(nsIMsgDBHdr *aNewHdr) override;</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-protected:</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+ protected:</span>
<a href="#l2.58"></a><span id="l2.58">   // IMAP does not set local file flags, override does nothing</span>
<a href="#l2.59"></a><span id="l2.59">   virtual void UpdateFolderFlag(nsIMsgDBHdr *msgHdr, bool bSet,</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-                                nsMsgMessageFlagType flag, nsIOutputStream **ppFileStream);</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+                                nsMsgMessageFlagType flag,</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+                                nsIOutputStream **ppFileStream);</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-  nsresult      GetRowForPendingHdr(nsIMsgDBHdr *pendingHdr, nsIMdbRow **row);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-  nsresult     GetAllPendingHdrsTable();</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-  mdb_token    m_pendingHdrsRowScopeToken;</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-  mdb_token    m_pendingHdrsTableKindToken;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  nsresult GetRowForPendingHdr(nsIMsgDBHdr *pendingHdr, nsIMdbRow **row);</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  nsresult GetAllPendingHdrsTable();</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+  mdb_token m_pendingHdrsRowScopeToken;</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+  mdb_token m_pendingHdrsTableKindToken;</span>
<a href="#l2.72"></a><span id="l2.72">   nsCOMPtr&lt;nsIMdbTable&gt; m_mdbAllPendingHdrsTable;</span>
<a href="#l2.73"></a><span id="l2.73"> };</span>
<a href="#l2.74"></a><span id="l2.74"> </span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-</span>
<a href="#l2.76"></a><span id="l2.76"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMailDatabase.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMailDatabase.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -13,54 +13,52 @@</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nsIDBChangeListener.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsIMsgOfflineImapOperation.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsISimpleEnumerator.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsIFile.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> // This is the subclass of nsMsgDatabase that handles local mail messages.</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-class nsMailDatabase : public nsMsgDatabase</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-{</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-public:</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+class nsMailDatabase : public nsMsgDatabase {</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+ public:</span>
<a href="#l3.17"></a><span id="l3.17">   nsMailDatabase();</span>
<a href="#l3.18"></a><span id="l3.18">   virtual ~nsMailDatabase();</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-  NS_IMETHOD  ForceClosed() override;</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-  NS_IMETHOD DeleteMessages(uint32_t aNumKeys, nsMsgKey* nsMsgKeys,</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+  NS_IMETHOD ForceClosed() override;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+  NS_IMETHOD DeleteMessages(uint32_t aNumKeys, nsMsgKey *nsMsgKeys,</span>
<a href="#l3.23"></a><span id="l3.23">                             nsIDBChangeListener *instigator) override;</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+  nsresult Open(nsMsgDBService *aDBService, nsIFile *aSummaryFile, bool create,</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+                bool upgrading) override;</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+  virtual nsMailDatabase *GetMailDB() { return this; }</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-  nsresult  Open(nsMsgDBService* aDBService, nsIFile *aSummaryFile, bool create, bool upgrading) override;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-  virtual nsMailDatabase  *GetMailDB() {return this;}</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-  virtual uint32_t  GetCurVersion() override {return kMsgDBVersion;}</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  virtual uint32_t GetCurVersion() override { return kMsgDBVersion; }</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-  NS_IMETHOD  GetOfflineOpForKey(nsMsgKey opKey, bool create,</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-                                 nsIMsgOfflineImapOperation **op) override;</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-  NS_IMETHOD  RemoveOfflineOp(nsIMsgOfflineImapOperation *op) override;</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  NS_IMETHOD GetOfflineOpForKey(nsMsgKey opKey, bool create,</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+                                nsIMsgOfflineImapOperation **op) override;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+  NS_IMETHOD RemoveOfflineOp(nsIMsgOfflineImapOperation *op) override;</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-  NS_IMETHOD  SetSummaryValid(bool valid) override;</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-  NS_IMETHOD  GetSummaryValid(bool *valid) override;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  NS_IMETHOD SetSummaryValid(bool valid) override;</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+  NS_IMETHOD GetSummaryValid(bool *valid) override;</span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-  NS_IMETHOD    EnumerateOfflineOps(nsISimpleEnumerator **enumerator) override;</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-  NS_IMETHOD    ListAllOfflineOpIds(nsTArray&lt;nsMsgKey&gt; *offlineOpIds) override;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-  NS_IMETHOD    ListAllOfflineDeletes(nsTArray&lt;nsMsgKey&gt; *offlineDeletes) override;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+  NS_IMETHOD EnumerateOfflineOps(nsISimpleEnumerator **enumerator) override;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+  NS_IMETHOD ListAllOfflineOpIds(nsTArray&lt;nsMsgKey&gt; *offlineOpIds) override;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+  NS_IMETHOD ListAllOfflineDeletes(nsTArray&lt;nsMsgKey&gt; *offlineDeletes) override;</span>
<a href="#l3.53"></a><span id="l3.53"> </span>
<a href="#l3.54"></a><span id="l3.54">   friend class nsMsgOfflineOpEnumerator;</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-protected:</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-  nsresult        GetAllOfflineOpsTable(); // get this on demand</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+ protected:</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+  nsresult GetAllOfflineOpsTable();  // get this on demand</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61">   // get the time and date of the mailbox file</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-  void            GetMailboxModProperties(int64_t *aSize, uint32_t *aDate);</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-  nsCOMPtr &lt;nsIMdbTable&gt;  m_mdbAllOfflineOpsTable;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-  mdb_token       m_offlineOpsRowScopeToken;</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-  mdb_token       m_offlineOpsTableKindToken;</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+  void GetMailboxModProperties(int64_t *aSize, uint32_t *aDate);</span>
<a href="#l3.68"></a><span id="l3.68"> </span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-  virtual void    SetReparse(bool reparse);</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+  nsCOMPtr&lt;nsIMdbTable&gt; m_mdbAllOfflineOpsTable;</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+  mdb_token m_offlineOpsRowScopeToken;</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+  mdb_token m_offlineOpsTableKindToken;</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-protected:</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  virtual void SetReparse(bool reparse);</span>
<a href="#l3.76"></a><span id="l3.76"> </span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-  bool            m_reparse;</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+ protected:</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+  bool m_reparse;</span>
<a href="#l3.80"></a><span id="l3.80"> };</span>
<a href="#l3.81"></a><span id="l3.81"> </span>
<a href="#l3.82"></a><span id="l3.82"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMsgDBCID.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMsgDBCID.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -6,58 +6,71 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #ifndef nsMsgDBCID_h__</span>
<a href="#l4.5"></a><span id="l4.5"> #define nsMsgDBCID_h__</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsISupports.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsIFactory.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsIComponentManager.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> // 03223c50-1e88-45e8-ba1a-7ce792dc3fc3</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#define NS_MSGDB_SERVICE_CID \</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-{  0x03223c50, 0x1e88, 0x45e8, \</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-    { 0xba, 0x1a, 0x7c, 0xe7, 0x92, 0xdc, 0x3f, 0xc3 } }</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+#define NS_MSGDB_SERVICE_CID                         \</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  {                                                  \</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+    0x03223c50, 0x1e88, 0x45e8, {                    \</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+      0xba, 0x1a, 0x7c, 0xe7, 0x92, 0xdc, 0x3f, 0xc3 \</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+    }                                                \</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+  }</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-#define NS_MSGDB_SERVICE_CONTRACTID \</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-  &quot;@mozilla.org/msgDatabase/msgDBService;1&quot;</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+#define NS_MSGDB_SERVICE_CONTRACTID &quot;@mozilla.org/msgDatabase/msgDBService;1&quot;</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-#define NS_MSGDB_CONTRACTID \</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-  &quot;@mozilla.org/nsMsgDatabase/msgDB-&quot;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+#define NS_MSGDB_CONTRACTID &quot;@mozilla.org/nsMsgDatabase/msgDB-&quot;</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-#define NS_MAILBOXDB_CONTRACTID \</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  NS_MSGDB_CONTRACTID&quot;mailbox&quot;</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+#define NS_MAILBOXDB_CONTRACTID NS_MSGDB_CONTRACTID &quot;mailbox&quot;</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34"> // a86c86ae-e97f-11d2-a506-0060b0fc04b7</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-#define NS_MAILDB_CID                      \</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-{ 0xa86c86ae, 0xe97f, 0x11d2,                   \</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-    { 0xa5, 0x06, 0x00, 0x60, 0xb0, 0xfc, 0x04, 0xb7 } }</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+#define NS_MAILDB_CID                                \</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  {                                                  \</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+    0xa86c86ae, 0xe97f, 0x11d2, {                    \</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+      0xa5, 0x06, 0x00, 0x60, 0xb0, 0xfc, 0x04, 0xb7 \</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+    }                                                \</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  }</span>
<a href="#l4.44"></a><span id="l4.44"> </span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-#define NS_NEWSDB_CONTRACTID \</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-  NS_MSGDB_CONTRACTID&quot;news&quot;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+#define NS_NEWSDB_CONTRACTID NS_MSGDB_CONTRACTID &quot;news&quot;</span>
<a href="#l4.48"></a><span id="l4.48"> </span>
<a href="#l4.49"></a><span id="l4.49"> // 36414aa0-e980-11d2-a506-0060b0fc04b7</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-#define NS_NEWSDB_CID                      \</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-{ 0x36414aa0, 0xe980, 0x11d2,                  \</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-    { 0xa5, 0x06, 0x00, 0x60, 0xb0, 0xfc, 0x04, 0xb7 } }</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+#define NS_NEWSDB_CID                                \</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+  {                                                  \</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+    0x36414aa0, 0xe980, 0x11d2, {                    \</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+      0xa5, 0x06, 0x00, 0x60, 0xb0, 0xfc, 0x04, 0xb7 \</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+    }                                                \</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  }</span>
<a href="#l4.59"></a><span id="l4.59"> </span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-#define NS_IMAPDB_CONTRACTID \</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-  NS_MSGDB_CONTRACTID&quot;imap&quot;</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+#define NS_IMAPDB_CONTRACTID NS_MSGDB_CONTRACTID &quot;imap&quot;</span>
<a href="#l4.63"></a><span id="l4.63"> </span>
<a href="#l4.64"></a><span id="l4.64"> // 9e4b07ee-e980-11d2-a506-0060b0fc04b7</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-#define NS_IMAPDB_CID                      \</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-{ 0x9e4b07ee, 0xe980, 0x11d2,                  \</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-    { 0xa5, 0x06, 0x00, 0x60, 0xb0, 0xfc, 0x04, 0xb7 } }</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+#define NS_IMAPDB_CID                                \</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+  {                                                  \</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+    0x9e4b07ee, 0xe980, 0x11d2, {                    \</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+      0xa5, 0x06, 0x00, 0x60, 0xb0, 0xfc, 0x04, 0xb7 \</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+    }                                                \</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+  }</span>
<a href="#l4.74"></a><span id="l4.74"> </span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-#define NS_MSG_RETENTIONSETTINGS_CID \</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-{ 0x1bd976d6, 0xdf44, 0x11d4,       \</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-  {0xa5, 0xb6, 0x00, 0x60, 0xb0, 0xfc, 0x04, 0xb7} }</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+#define NS_MSG_RETENTIONSETTINGS_CID                 \</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+  {                                                  \</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+    0x1bd976d6, 0xdf44, 0x11d4, {                    \</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+      0xa5, 0xb6, 0x00, 0x60, 0xb0, 0xfc, 0x04, 0xb7 \</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+    }                                                \</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  }</span>
<a href="#l4.84"></a><span id="l4.84"> </span>
<a href="#l4.85"></a><span id="l4.85"> #define NS_MSG_RETENTIONSETTINGS_CONTRACTID \</span>
<a href="#l4.86"></a><span id="l4.86">   &quot;@mozilla.org/msgDatabase/retentionSettings;1&quot;</span>
<a href="#l4.87"></a><span id="l4.87"> </span>
<a href="#l4.88"></a><span id="l4.88"> // 4e3dae5a-157a-11d5-a5c0-0060b0fc04b7</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-#define NS_MSG_DOWNLOADSETTINGS_CID \</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-{ 0x4e3dae5a, 0x157a, 0x11d5,       \</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-  {0xa5, 0xc0, 0x00, 0x60, 0xb0, 0xfc, 0x04, 0xb7} }</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+#define NS_MSG_DOWNLOADSETTINGS_CID                  \</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+  {                                                  \</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+    0x4e3dae5a, 0x157a, 0x11d5, {                    \</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+      0xa5, 0xc0, 0x00, 0x60, 0xb0, 0xfc, 0x04, 0xb7 \</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+    }                                                \</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+  }</span>
<a href="#l4.98"></a><span id="l4.98"> </span>
<a href="#l4.99"></a><span id="l4.99"> #define NS_MSG_DOWNLOADSETTINGS_CONTRACTID \</span>
<a href="#l4.100"></a><span id="l4.100">   &quot;@mozilla.org/msgDatabase/downloadSettings;1&quot;</span>
<a href="#l4.101"></a><span id="l4.101"> </span>
<a href="#l4.102"></a><span id="l4.102"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -36,111 +36,101 @@ class nsIMsgThread;</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> const int32_t kMsgDBVersion = 1;</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> // Hopefully we're not opening up lots of databases at the same time, however</span>
<a href="#l5.8"></a><span id="l5.8"> // this will give us a buffer before we need to start reallocating the cache</span>
<a href="#l5.9"></a><span id="l5.9"> // array.</span>
<a href="#l5.10"></a><span id="l5.10"> const uint32_t kInitialMsgDBCacheSize = 20;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-class nsMsgDBService final : public nsIMsgDBService</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-{</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-public:</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+class nsMsgDBService final : public nsIMsgDBService {</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+ public:</span>
<a href="#l5.17"></a><span id="l5.17">   NS_DECL_ISUPPORTS</span>
<a href="#l5.18"></a><span id="l5.18">   NS_DECL_NSIMSGDBSERVICE</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20">   nsMsgDBService();</span>
<a href="#l5.21"></a><span id="l5.21"> </span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-  void AddToCache(nsMsgDatabase* pMessageDB);</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+  void AddToCache(nsMsgDatabase *pMessageDB);</span>
<a href="#l5.24"></a><span id="l5.24">   void DumpCache();</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-  void EnsureCached(nsMsgDatabase* pMessageDB)</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-  {</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-    if (!m_dbCache.Contains(pMessageDB))</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-      m_dbCache.AppendElement(pMessageDB);</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+  void EnsureCached(nsMsgDatabase *pMessageDB) {</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+    if (!m_dbCache.Contains(pMessageDB)) m_dbCache.AppendElement(pMessageDB);</span>
<a href="#l5.31"></a><span id="l5.31">   }</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-  void RemoveFromCache(nsMsgDatabase* pMessageDB)</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-  {</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+  void RemoveFromCache(nsMsgDatabase *pMessageDB) {</span>
<a href="#l5.35"></a><span id="l5.35">     m_dbCache.RemoveElement(pMessageDB);</span>
<a href="#l5.36"></a><span id="l5.36">   }</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-protected:</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+ protected:</span>
<a href="#l5.40"></a><span id="l5.40">   ~nsMsgDBService();</span>
<a href="#l5.41"></a><span id="l5.41">   void HookupPendingListeners(nsIMsgDatabase *db, nsIMsgFolder *folder);</span>
<a href="#l5.42"></a><span id="l5.42">   void FinishDBOpen(nsIMsgFolder *aFolder, nsMsgDatabase *aMsgDB);</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-  nsMsgDatabase* FindInCache(nsIFile *dbName);</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+  nsMsgDatabase *FindInCache(nsIFile *dbName);</span>
<a href="#l5.45"></a><span id="l5.45"> </span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-  nsCOMArray &lt;nsIMsgFolder&gt; m_foldersPendingListeners;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-  nsCOMArray &lt;nsIDBChangeListener&gt; m_pendingListeners;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-  AutoTArray&lt;nsMsgDatabase*, kInitialMsgDBCacheSize&gt; m_dbCache;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+  nsCOMArray&lt;nsIMsgFolder&gt; m_foldersPendingListeners;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+  nsCOMArray&lt;nsIDBChangeListener&gt; m_pendingListeners;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+  AutoTArray&lt;nsMsgDatabase *, kInitialMsgDBCacheSize&gt; m_dbCache;</span>
<a href="#l5.52"></a><span id="l5.52"> };</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54"> class nsMsgDBEnumerator : public nsSimpleEnumerator {</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-public:</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-    const nsID&amp; DefaultInterface() override</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-    {</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-      return NS_GET_IID(nsIMsgDBHdr);</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-    }</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+ public:</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+  const nsID &amp;DefaultInterface() override { return NS_GET_IID(nsIMsgDBHdr); }</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+  // nsISimpleEnumerator methods:</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+  NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l5.65"></a><span id="l5.65"> </span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-    // nsISimpleEnumerator methods:</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-    NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+  // nsMsgDBEnumerator methods:</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+  typedef nsresult (*nsMsgDBEnumeratorFilter)(nsIMsgDBHdr *hdr, void *closure);</span>
<a href="#l5.70"></a><span id="l5.70"> </span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-    // nsMsgDBEnumerator methods:</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-    typedef nsresult (*nsMsgDBEnumeratorFilter)(nsIMsgDBHdr* hdr, void* closure);</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-    nsMsgDBEnumerator(nsMsgDatabase* db, nsIMdbTable *table,</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-                      nsMsgDBEnumeratorFilter filter, void* closure,</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-                      bool iterateForwards = true);</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-    void Clear();</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+  nsMsgDBEnumerator(nsMsgDatabase *db, nsIMdbTable *table,</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+                    nsMsgDBEnumeratorFilter filter, void *closure,</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+                    bool iterateForwards = true);</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+  void Clear();</span>
<a href="#l5.82"></a><span id="l5.82"> </span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-    nsresult                        GetRowCursor();</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-    virtual nsresult                PrefetchNext();</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-    RefPtr&lt;nsMsgDatabase&gt;           mDB;</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-    nsCOMPtr&lt;nsIMdbTableRowCursor&gt;  mRowCursor;</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-    mdb_pos                         mRowPos;</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBHdr&gt;           mResultHdr;</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-    bool                            mDone;</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-    bool                            mNextPrefetched;</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-    bool                            mIterateForwards;</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-    nsMsgDBEnumeratorFilter         mFilter;</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-    nsCOMPtr &lt;nsIMdbTable&gt;          mTable;</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-    void*                           mClosure;</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-    // This is used when the caller wants to limit how many headers the</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-    // enumerator looks at in any given time slice.</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-    mdb_pos                         mStopPos;</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+  nsresult GetRowCursor();</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+  virtual nsresult PrefetchNext();</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+  RefPtr&lt;nsMsgDatabase&gt; mDB;</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+  nsCOMPtr&lt;nsIMdbTableRowCursor&gt; mRowCursor;</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+  mdb_pos mRowPos;</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; mResultHdr;</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+  bool mDone;</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+  bool mNextPrefetched;</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+  bool mIterateForwards;</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+  nsMsgDBEnumeratorFilter mFilter;</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+  nsCOMPtr&lt;nsIMdbTable&gt; mTable;</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+  void *mClosure;</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+  // This is used when the caller wants to limit how many headers the</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+  // enumerator looks at in any given time slice.</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+  mdb_pos mStopPos;</span>
<a href="#l5.113"></a><span id="l5.113"> </span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-protected:</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-    ~nsMsgDBEnumerator() override;</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+ protected:</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+  ~nsMsgDBEnumerator() override;</span>
<a href="#l5.118"></a><span id="l5.118"> };</span>
<a href="#l5.119"></a><span id="l5.119"> </span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-class nsMsgFilteredDBEnumerator : public nsMsgDBEnumerator</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-{</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-public:</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-  nsMsgFilteredDBEnumerator(nsMsgDatabase* db, nsIMdbTable *table,</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-                            bool reverse, nsIArray *searchTerms);</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+class nsMsgFilteredDBEnumerator : public nsMsgDBEnumerator {</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+ public:</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+  nsMsgFilteredDBEnumerator(nsMsgDatabase *db, nsIMdbTable *table, bool reverse,</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+                            nsIArray *searchTerms);</span>
<a href="#l5.129"></a><span id="l5.129">   virtual ~nsMsgFilteredDBEnumerator();</span>
<a href="#l5.130"></a><span id="l5.130">   nsresult InitSearchSession(nsIArray *searchTerms, nsIMsgFolder *folder);</span>
<a href="#l5.131"></a><span id="l5.131"> </span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-protected:</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-  virtual nsresult               PrefetchNext() override;</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+ protected:</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+  virtual nsresult PrefetchNext() override;</span>
<a href="#l5.136"></a><span id="l5.136"> </span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-  nsCOMPtr &lt;nsIMsgSearchSession&gt; m_searchSession;</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchSession&gt; m_searchSession;</span>
<a href="#l5.140"></a><span id="l5.140"> };</span>
<a href="#l5.141"></a><span id="l5.141"> </span>
<a href="#l5.142"></a><span id="l5.142"> namespace mozilla {</span>
<a href="#l5.143"></a><span id="l5.143"> namespace mailnews {</span>
<a href="#l5.144"></a><span id="l5.144"> class MsgDBReporter;</span>
<a href="#l5.145"></a><span id="l5.145"> }</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-}</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+}  // namespace mozilla</span>
<a href="#l5.148"></a><span id="l5.148"> </span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-class nsMsgDatabase : public nsIMsgDatabase</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-{</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-public:</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+class nsMsgDatabase : public nsIMsgDatabase {</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+ public:</span>
<a href="#l5.154"></a><span id="l5.154">   friend class nsMsgDBService;</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-  friend class nsMsgPropertyEnumerator; // accesses m_mdbEnv and m_mdbStore</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+  friend class nsMsgPropertyEnumerator;  // accesses m_mdbEnv and m_mdbStore</span>
<a href="#l5.157"></a><span id="l5.157"> </span>
<a href="#l5.158"></a><span id="l5.158">   NS_DECL_ISUPPORTS</span>
<a href="#l5.159"></a><span id="l5.159">   NS_DECL_NSIDBCHANGEANNOUNCER</span>
<a href="#l5.160"></a><span id="l5.160">   NS_DECL_NSIMSGDATABASE</span>
<a href="#l5.161"></a><span id="l5.161"> </span>
<a href="#l5.162"></a><span id="l5.162">   /**</span>
<a href="#l5.163"></a><span id="l5.163">    * Opens a database folder.</span>
<a href="#l5.164"></a><span id="l5.164">    *</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineat">@@ -156,311 +146,351 @@ public:</span>
<a href="#l5.166"></a><span id="l5.166">    * @exception NS_MSG_ERROR_FOLDER_SUMMARY_MISSING</span>
<a href="#l5.167"></a><span id="l5.167">    *                        The database is present (and was opened), but the</span>
<a href="#l5.168"></a><span id="l5.168">    *                        summary file is missing.</span>
<a href="#l5.169"></a><span id="l5.169">    */</span>
<a href="#l5.170"></a><span id="l5.170">   virtual nsresult Open(nsMsgDBService *aDBService, nsIFile *aFolderName,</span>
<a href="#l5.171"></a><span id="l5.171">                         bool aCreate, bool aLeaveInvalidDB);</span>
<a href="#l5.172"></a><span id="l5.172">   virtual nsresult IsHeaderRead(nsIMsgDBHdr *hdr, bool *pRead);</span>
<a href="#l5.173"></a><span id="l5.173">   virtual nsresult MarkHdrReadInDB(nsIMsgDBHdr *msgHdr, bool bRead,</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-                               nsIDBChangeListener *instigator);</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+                                   nsIDBChangeListener *instigator);</span>
<a href="#l5.176"></a><span id="l5.176">   nsresult OpenInternal(nsMsgDBService *aDBService, nsIFile *aFolderName,</span>
<a href="#l5.177"></a><span id="l5.177">                         bool aCreate, bool aLeaveInvalidDB, bool sync);</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-  nsresult CheckForErrors(nsresult err, bool sync, nsMsgDBService *aDBService, nsIFile *summaryFile);</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+  nsresult CheckForErrors(nsresult err, bool sync, nsMsgDBService *aDBService,</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+                          nsIFile *summaryFile);</span>
<a href="#l5.181"></a><span id="l5.181">   virtual nsresult OpenMDB(nsIFile *dbfile, bool create, bool sync);</span>
<a href="#l5.182"></a><span id="l5.182">   virtual nsresult CloseMDB(bool commit);</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-  virtual nsresult CreateMsgHdr(nsIMdbRow* hdrRow, nsMsgKey key, nsIMsgDBHdr **result);</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+  virtual nsresult CreateMsgHdr(nsIMdbRow *hdrRow, nsMsgKey key,</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+                                nsIMsgDBHdr **result);</span>
<a href="#l5.186"></a><span id="l5.186">   virtual nsresult GetThreadForMsgKey(nsMsgKey msgKey, nsIMsgThread **result);</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-  virtual nsresult EnumerateMessagesWithFlag(nsISimpleEnumerator* *result, uint32_t *pFlag);</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-  nsresult         GetSearchResultsTable(const char *searchFolderUri, bool createIfMissing, nsIMdbTable **table);</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+  virtual nsresult EnumerateMessagesWithFlag(nsISimpleEnumerator **result,</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+                                             uint32_t *pFlag);</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+  nsresult GetSearchResultsTable(const char *searchFolderUri,</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+                                 bool createIfMissing, nsIMdbTable **table);</span>
<a href="#l5.193"></a><span id="l5.193"> </span>
<a href="#l5.194"></a><span id="l5.194">   // this might just be for debugging - we'll see.</span>
<a href="#l5.195"></a><span id="l5.195">   nsresult ListAllThreads(nsTArray&lt;nsMsgKey&gt; *threadIds);</span>
<a href="#l5.196"></a><span id="l5.196">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l5.197"></a><span id="l5.197">   // nsMsgDatabase methods:</span>
<a href="#l5.198"></a><span id="l5.198">   nsMsgDatabase();</span>
<a href="#l5.199"></a><span id="l5.199"> </span>
<a href="#l5.200"></a><span id="l5.200" class="difflineminus">-  nsresult GetMDBFactory(nsIMdbFactory ** aMdbFactory);</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineminus">-  nsIMdbEnv             *GetEnv() {return m_mdbEnv;}</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineminus">-  nsIMdbStore           *GetStore() {return m_mdbStore;}</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-  virtual uint32_t      GetCurVersion();</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-  nsresult              GetCollationKeyGenerator();</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-  nsIMimeConverter *    GetMimeConverter();</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+  nsresult GetMDBFactory(nsIMdbFactory **aMdbFactory);</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+  nsIMdbEnv *GetEnv() { return m_mdbEnv; }</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+  nsIMdbStore *GetStore() { return m_mdbStore; }</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+  virtual uint32_t GetCurVersion();</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+  nsresult GetCollationKeyGenerator();</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+  nsIMimeConverter *GetMimeConverter();</span>
<a href="#l5.212"></a><span id="l5.212"> </span>
<a href="#l5.213"></a><span id="l5.213" class="difflineminus">-  nsresult GetTableCreateIfMissing(const char *scope, const char *kind, nsIMdbTable **table,</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineminus">-                                   mdb_token &amp;scopeToken, mdb_token &amp;kindToken);</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineplus">+  nsresult GetTableCreateIfMissing(const char *scope, const char *kind,</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+                                   nsIMdbTable **table, mdb_token &amp;scopeToken,</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+                                   mdb_token &amp;kindToken);</span>
<a href="#l5.218"></a><span id="l5.218"> </span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-  //helper function to fill in nsStrings from hdr row cell contents.</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-  nsresult RowCellColumnTonsString(nsIMdbRow *row, mdb_token columnToken, nsAString &amp;resultStr);</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-  nsresult RowCellColumnToUInt32(nsIMdbRow *row, mdb_token columnToken, uint32_t *uint32Result, uint32_t defaultValue = 0);</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-  nsresult RowCellColumnToUInt32(nsIMdbRow *row, mdb_token columnToken, uint32_t &amp;uint32Result, uint32_t defaultValue = 0);</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineminus">-  nsresult RowCellColumnToUInt64(nsIMdbRow *row, mdb_token columnToken, uint64_t *uint64Result, uint64_t defaultValue = 0);</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineminus">-  nsresult RowCellColumnToMime2DecodedString(nsIMdbRow *row, mdb_token columnToken, nsAString &amp;resultStr);</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-  nsresult RowCellColumnToCollationKey(nsIMdbRow *row, mdb_token columnToken, uint8_t **result, uint32_t *len);</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineminus">-  nsresult RowCellColumnToConstCharPtr(nsIMdbRow *row, mdb_token columnToken, const char **ptr);</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineminus">-  nsresult RowCellColumnToAddressCollationKey(nsIMdbRow *row, mdb_token colToken, uint8_t **result, uint32_t *len);</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+  // helper function to fill in nsStrings from hdr row cell contents.</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+  nsresult RowCellColumnTonsString(nsIMdbRow *row, mdb_token columnToken,</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+                                   nsAString &amp;resultStr);</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+  nsresult RowCellColumnToUInt32(nsIMdbRow *row, mdb_token columnToken,</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineplus">+                                 uint32_t *uint32Result,</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineplus">+                                 uint32_t defaultValue = 0);</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineplus">+  nsresult RowCellColumnToUInt32(nsIMdbRow *row, mdb_token columnToken,</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+                                 uint32_t &amp;uint32Result,</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+                                 uint32_t defaultValue = 0);</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+  nsresult RowCellColumnToUInt64(nsIMdbRow *row, mdb_token columnToken,</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+                                 uint64_t *uint64Result,</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+                                 uint64_t defaultValue = 0);</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+  nsresult RowCellColumnToMime2DecodedString(nsIMdbRow *row,</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+                                             mdb_token columnToken,</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+                                             nsAString &amp;resultStr);</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+  nsresult RowCellColumnToCollationKey(nsIMdbRow *row, mdb_token columnToken,</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+                                       uint8_t **result, uint32_t *len);</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+  nsresult RowCellColumnToConstCharPtr(nsIMdbRow *row, mdb_token columnToken,</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+                                       const char **ptr);</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+  nsresult RowCellColumnToAddressCollationKey(nsIMdbRow *row,</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+                                              mdb_token colToken,</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+                                              uint8_t **result, uint32_t *len);</span>
<a href="#l5.250"></a><span id="l5.250"> </span>
<a href="#l5.251"></a><span id="l5.251">   nsresult GetEffectiveCharset(nsIMdbRow *row, nsACString &amp;resultCharset);</span>
<a href="#l5.252"></a><span id="l5.252"> </span>
<a href="#l5.253"></a><span id="l5.253">   // these methods take the property name as a string, not a token.</span>
<a href="#l5.254"></a><span id="l5.254">   // they should be used when the properties aren't accessed a lot</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineminus">-  nsresult        GetProperty(nsIMdbRow *row, const char *propertyName, char **result);</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineminus">-  nsresult        SetProperty(nsIMdbRow *row, const char *propertyName, const char *propertyVal);</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineminus">-  nsresult        GetPropertyAsNSString(nsIMdbRow *row, const char *propertyName, nsAString &amp;result);</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineminus">-  nsresult        SetPropertyFromNSString(nsIMdbRow *row, const char *propertyName, const nsAString &amp;propertyVal);</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineminus">-  nsresult        GetUint32Property(nsIMdbRow *row, const char *propertyName, uint32_t *result, uint32_t defaultValue = 0);</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineminus">-  nsresult        GetUint64Property(nsIMdbRow *row, const char *propertyName, uint64_t *result, uint64_t defaultValue = 0);</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineminus">-  nsresult        SetUint32Property(nsIMdbRow *row, const char *propertyName, uint32_t propertyVal);</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineminus">-  nsresult        SetUint64Property(nsIMdbRow *row, const char *propertyName, uint64_t propertyVal);</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineminus">-  nsresult        GetBooleanProperty(nsIMdbRow *row, const char *propertyName,</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineminus">-                                     bool *result, bool defaultValue = false);</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineminus">-  nsresult        SetBooleanProperty(nsIMdbRow *row, const char *propertyName,</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineminus">-                                    bool propertyVal);</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+  nsresult GetProperty(nsIMdbRow *row, const char *propertyName, char **result);</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineplus">+  nsresult SetProperty(nsIMdbRow *row, const char *propertyName,</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+                       const char *propertyVal);</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+  nsresult GetPropertyAsNSString(nsIMdbRow *row, const char *propertyName,</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineplus">+                                 nsAString &amp;result);</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+  nsresult SetPropertyFromNSString(nsIMdbRow *row, const char *propertyName,</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+                                   const nsAString &amp;propertyVal);</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+  nsresult GetUint32Property(nsIMdbRow *row, const char *propertyName,</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+                             uint32_t *result, uint32_t defaultValue = 0);</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+  nsresult GetUint64Property(nsIMdbRow *row, const char *propertyName,</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+                             uint64_t *result, uint64_t defaultValue = 0);</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+  nsresult SetUint32Property(nsIMdbRow *row, const char *propertyName,</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+                             uint32_t propertyVal);</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+  nsresult SetUint64Property(nsIMdbRow *row, const char *propertyName,</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+                             uint64_t propertyVal);</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+  nsresult GetBooleanProperty(nsIMdbRow *row, const char *propertyName,</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+                              bool *result, bool defaultValue = false);</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+  nsresult SetBooleanProperty(nsIMdbRow *row, const char *propertyName,</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+                              bool propertyVal);</span>
<a href="#l5.286"></a><span id="l5.286">   // helper function for once we have the token.</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineminus">-  nsresult        SetNSStringPropertyWithToken(nsIMdbRow *row, mdb_token aProperty, const nsAString &amp;propertyStr);</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+  nsresult SetNSStringPropertyWithToken(nsIMdbRow *row, mdb_token aProperty,</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+                                        const nsAString &amp;propertyStr);</span>
<a href="#l5.290"></a><span id="l5.290"> </span>
<a href="#l5.291"></a><span id="l5.291">   // helper functions to put values in cells for the passed-in row</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineminus">-  nsresult        UInt32ToRowCellColumn(nsIMdbRow *row, mdb_token columnToken, uint32_t value);</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineminus">-  nsresult        CharPtrToRowCellColumn(nsIMdbRow *row, mdb_token columnToken, const char *charPtr);</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineminus">-  nsresult        RowCellColumnToCharPtr(nsIMdbRow *row, mdb_token columnToken, char **result);</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineminus">-  nsresult        UInt64ToRowCellColumn(nsIMdbRow *row, mdb_token columnToken, uint64_t value);</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineplus">+  nsresult UInt32ToRowCellColumn(nsIMdbRow *row, mdb_token columnToken,</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineplus">+                                 uint32_t value);</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+  nsresult CharPtrToRowCellColumn(nsIMdbRow *row, mdb_token columnToken,</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+                                  const char *charPtr);</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+  nsresult RowCellColumnToCharPtr(nsIMdbRow *row, mdb_token columnToken,</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineplus">+                                  char **result);</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+  nsresult UInt64ToRowCellColumn(nsIMdbRow *row, mdb_token columnToken,</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+                                 uint64_t value);</span>
<a href="#l5.304"></a><span id="l5.304"> </span>
<a href="#l5.305"></a><span id="l5.305" class="difflineminus">-  // helper functions to copy an nsString to a yarn, int32 to yarn, and vice versa.</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineminus">-  static struct mdbYarn *nsStringToYarn(struct mdbYarn *yarn, const nsAString &amp;str);</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+  // helper functions to copy an nsString to a yarn, int32 to yarn, and vice</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineplus">+  // versa.</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+  static struct mdbYarn *nsStringToYarn(struct mdbYarn *yarn,</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+                                        const nsAString &amp;str);</span>
<a href="#l5.311"></a><span id="l5.311">   static struct mdbYarn *UInt32ToYarn(struct mdbYarn *yarn, uint32_t i);</span>
<a href="#l5.312"></a><span id="l5.312">   static struct mdbYarn *UInt64ToYarn(struct mdbYarn *yarn, uint64_t i);</span>
<a href="#l5.313"></a><span id="l5.313">   static void YarnTonsString(struct mdbYarn *yarn, nsAString &amp;str);</span>
<a href="#l5.314"></a><span id="l5.314">   static void YarnTonsCString(struct mdbYarn *yarn, nsACString &amp;str);</span>
<a href="#l5.315"></a><span id="l5.315">   static void YarnToUInt32(struct mdbYarn *yarn, uint32_t *i);</span>
<a href="#l5.316"></a><span id="l5.316">   static void YarnToUInt64(struct mdbYarn *yarn, uint64_t *i);</span>
<a href="#l5.317"></a><span id="l5.317"> </span>
<a href="#l5.318"></a><span id="l5.318"> #ifdef DEBUG</span>
<a href="#l5.319"></a><span id="l5.319">   virtual nsresult DumpContents();</span>
<a href="#l5.320"></a><span id="l5.320">   nsresult DumpThread(nsMsgKey threadId);</span>
<a href="#l5.321"></a><span id="l5.321">   nsresult DumpMsgChildren(nsIMsgDBHdr *msgHdr);</span>
<a href="#l5.322"></a><span id="l5.322"> #endif</span>
<a href="#l5.323"></a><span id="l5.323"> </span>
<a href="#l5.324"></a><span id="l5.324" class="difflineminus">-  friend class nsMsgHdr;  // use this to get access to cached tokens for hdr fields</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineminus">-  friend class nsMsgThread;  // use this to get access to cached tokens for hdr fields</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+  friend class nsMsgHdr;     // use this to get access to cached tokens for hdr</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+                             // fields</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineplus">+  friend class nsMsgThread;  // use this to get access to cached tokens for hdr</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineplus">+                             // fields</span>
<a href="#l5.330"></a><span id="l5.330">   friend class nsMsgDBEnumerator;</span>
<a href="#l5.331"></a><span id="l5.331">   friend class nsMsgDBThreadEnumerator;</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineminus">-protected:</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+ protected:</span>
<a href="#l5.335"></a><span id="l5.335">   virtual ~nsMsgDatabase();</span>
<a href="#l5.336"></a><span id="l5.336"> </span>
<a href="#l5.337"></a><span id="l5.337">   // prefs stuff - in future, we might want to cache the prefs interface</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineminus">-  nsresult        GetBoolPref(const char *prefName, bool *result);</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineminus">-  nsresult        GetIntPref(const char *prefName, int32_t *result);</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineminus">-  virtual void    GetGlobalPrefs();</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineminus">-    // retrieval methods</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineminus">-  nsIMsgThread *  GetThreadForReference(nsCString &amp;msgID, nsIMsgDBHdr **pMsgHdr);</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineminus">-  nsIMsgThread *  GetThreadForSubject(nsCString &amp;subject);</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineminus">-  nsIMsgThread *  GetThreadForMessageId(nsCString &amp;msgId);</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineminus">-  nsIMsgThread *  GetThreadForThreadId(nsMsgKey threadId);</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineminus">-  nsMsgHdr     *  GetMsgHdrForReference(nsCString &amp;reference);</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineminus">-  nsIMsgDBHdr  *  GetMsgHdrForSubject(nsCString &amp;subject);</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineplus">+  nsresult GetBoolPref(const char *prefName, bool *result);</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineplus">+  nsresult GetIntPref(const char *prefName, int32_t *result);</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+  virtual void GetGlobalPrefs();</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+  // retrieval methods</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineplus">+  nsIMsgThread *GetThreadForReference(nsCString &amp;msgID, nsIMsgDBHdr **pMsgHdr);</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+  nsIMsgThread *GetThreadForSubject(nsCString &amp;subject);</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+  nsIMsgThread *GetThreadForMessageId(nsCString &amp;msgId);</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+  nsIMsgThread *GetThreadForThreadId(nsMsgKey threadId);</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineplus">+  nsMsgHdr *GetMsgHdrForReference(nsCString &amp;reference);</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineplus">+  nsIMsgDBHdr *GetMsgHdrForSubject(nsCString &amp;subject);</span>
<a href="#l5.358"></a><span id="l5.358">   // threading interfaces</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineminus">-  virtual nsresult CreateNewThread(nsMsgKey key, const char *subject, nsMsgThread **newThread);</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineminus">-  virtual bool    ThreadBySubjectWithoutRe();</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineminus">-  virtual bool    UseStrictThreading();</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineminus">-  virtual bool    UseCorrectThreading();</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineminus">-  virtual nsresult ThreadNewHdr(nsMsgHdr* hdr, bool &amp;newThread);</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+  virtual nsresult CreateNewThread(nsMsgKey key, const char *subject,</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+                                   nsMsgThread **newThread);</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+  virtual bool ThreadBySubjectWithoutRe();</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineplus">+  virtual bool UseStrictThreading();</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineplus">+  virtual bool UseCorrectThreading();</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+  virtual nsresult ThreadNewHdr(nsMsgHdr *hdr, bool &amp;newThread);</span>
<a href="#l5.370"></a><span id="l5.370">   virtual nsresult AddNewThread(nsMsgHdr *msgHdr);</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineminus">-  virtual nsresult AddToThread(nsMsgHdr *newHdr, nsIMsgThread *thread, nsIMsgDBHdr *pMsgHdr, bool threadInThread);</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineplus">+  virtual nsresult AddToThread(nsMsgHdr *newHdr, nsIMsgThread *thread,</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineplus">+                               nsIMsgDBHdr *pMsgHdr, bool threadInThread);</span>
<a href="#l5.374"></a><span id="l5.374"> </span>
<a href="#l5.375"></a><span id="l5.375" class="difflineminus">-  static PRTime gLastUseTime; // global last use time</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineminus">-  PRTime m_lastUseTime;       // last use time for this db</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineplus">+  static PRTime gLastUseTime;  // global last use time</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+  PRTime m_lastUseTime;        // last use time for this db</span>
<a href="#l5.379"></a><span id="l5.379">   // inline to make instrumentation as cheap as possible</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineminus">-  inline void RememberLastUseTime() {gLastUseTime = m_lastUseTime = PR_Now();}</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineplus">+  inline void RememberLastUseTime() { gLastUseTime = m_lastUseTime = PR_Now(); }</span>
<a href="#l5.382"></a><span id="l5.382"> </span>
<a href="#l5.383"></a><span id="l5.383" class="difflineminus">-  bool    MatchDbName(nsIFile *dbName);  // returns TRUE if they match</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineplus">+  bool MatchDbName(nsIFile *dbName);  // returns TRUE if they match</span>
<a href="#l5.385"></a><span id="l5.385"> </span>
<a href="#l5.386"></a><span id="l5.386">   // Flag handling routines</span>
<a href="#l5.387"></a><span id="l5.387">   virtual nsresult SetKeyFlag(nsMsgKey key, bool set, nsMsgMessageFlagType flag,</span>
<a href="#l5.388"></a><span id="l5.388">                               nsIDBChangeListener *instigator = nullptr);</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineminus">-  virtual nsresult SetMsgHdrFlag(nsIMsgDBHdr *msgHdr, bool set, nsMsgMessageFlagType flag,</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineplus">+  virtual nsresult SetMsgHdrFlag(nsIMsgDBHdr *msgHdr, bool set,</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+                                 nsMsgMessageFlagType flag,</span>
<a href="#l5.392"></a><span id="l5.392">                                  nsIDBChangeListener *instigator);</span>
<a href="#l5.393"></a><span id="l5.393"> </span>
<a href="#l5.394"></a><span id="l5.394" class="difflineminus">-  virtual bool    SetHdrFlag(nsIMsgDBHdr *, bool bSet, nsMsgMessageFlagType flag);</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineminus">-  virtual bool    SetHdrReadFlag(nsIMsgDBHdr *, bool pRead);</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineminus">-  virtual uint32_t GetStatusFlags(nsIMsgDBHdr *msgHdr, nsMsgMessageFlagType origFlags);</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+  virtual bool SetHdrFlag(nsIMsgDBHdr *, bool bSet, nsMsgMessageFlagType flag);</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineplus">+  virtual bool SetHdrReadFlag(nsIMsgDBHdr *, bool pRead);</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+  virtual uint32_t GetStatusFlags(nsIMsgDBHdr *msgHdr,</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+                                  nsMsgMessageFlagType origFlags);</span>
<a href="#l5.401"></a><span id="l5.401">   // helper function which doesn't involve thread object</span>
<a href="#l5.402"></a><span id="l5.402"> </span>
<a href="#l5.403"></a><span id="l5.403">   virtual nsresult RemoveHeaderFromDB(nsMsgHdr *msgHdr);</span>
<a href="#l5.404"></a><span id="l5.404">   virtual nsresult RemoveHeaderFromThread(nsMsgHdr *msgHdr);</span>
<a href="#l5.405"></a><span id="l5.405">   virtual nsresult AdjustExpungedBytesOnDelete(nsIMsgDBHdr *msgHdr);</span>
<a href="#l5.406"></a><span id="l5.406"> </span>
<a href="#l5.407"></a><span id="l5.407" class="difflineminus">-  nsCOMPtr &lt;nsICollation&gt; m_collationKeyGenerator;</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineminus">-  nsCOMPtr &lt;nsIMimeConverter&gt; m_mimeConverter;</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineminus">-  nsCOMPtr &lt;nsIMsgRetentionSettings&gt; m_retentionSettings;</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDownloadSettings&gt; m_downloadSettings;</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+  nsCOMPtr&lt;nsICollation&gt; m_collationKeyGenerator;</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineplus">+  nsCOMPtr&lt;nsIMimeConverter&gt; m_mimeConverter;</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineplus">+  nsCOMPtr&lt;nsIMsgRetentionSettings&gt; m_retentionSettings;</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDownloadSettings&gt; m_downloadSettings;</span>
<a href="#l5.415"></a><span id="l5.415"> </span>
<a href="#l5.416"></a><span id="l5.416">   nsresult PurgeMessagesOlderThan(uint32_t daysToKeepHdrs,</span>
<a href="#l5.417"></a><span id="l5.417">                                   bool applyToFlaggedMessages,</span>
<a href="#l5.418"></a><span id="l5.418">                                   nsIMutableArray *hdrsToDelete);</span>
<a href="#l5.419"></a><span id="l5.419">   nsresult PurgeExcessMessages(uint32_t numHeadersToKeep,</span>
<a href="#l5.420"></a><span id="l5.420">                                bool applyToFlaggedMessages,</span>
<a href="#l5.421"></a><span id="l5.421">                                nsIMutableArray *hdrsToDelete);</span>
<a href="#l5.422"></a><span id="l5.422"> </span>
<a href="#l5.423"></a><span id="l5.423">   // mdb bookkeeping stuff</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineminus">-  virtual nsresult      InitExistingDB();</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineminus">-  virtual nsresult      InitNewDB();</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineminus">-  virtual nsresult      InitMDBInfo();</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineplus">+  virtual nsresult InitExistingDB();</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineplus">+  virtual nsresult InitNewDB();</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineplus">+  virtual nsresult InitMDBInfo();</span>
<a href="#l5.430"></a><span id="l5.430"> </span>
<a href="#l5.431"></a><span id="l5.431" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineminus">-  RefPtr&lt;nsDBFolderInfo&gt;  m_dbFolderInfo;</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineminus">-  nsMsgKey      m_nextPseudoMsgKey;</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineminus">-  nsIMdbEnv     *m_mdbEnv;  // to be used in all the db calls.</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineminus">-  nsIMdbStore   *m_mdbStore;</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineminus">-  nsIMdbTable   *m_mdbAllMsgHeadersTable;</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineminus">-  nsIMdbTable   *m_mdbAllThreadsTable;</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineplus">+  RefPtr&lt;nsDBFolderInfo&gt; m_dbFolderInfo;</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineplus">+  nsMsgKey m_nextPseudoMsgKey;</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineplus">+  nsIMdbEnv *m_mdbEnv;  // to be used in all the db calls.</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineplus">+  nsIMdbStore *m_mdbStore;</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineplus">+  nsIMdbTable *m_mdbAllMsgHeadersTable;</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineplus">+  nsIMdbTable *m_mdbAllThreadsTable;</span>
<a href="#l5.445"></a><span id="l5.445"> </span>
<a href="#l5.446"></a><span id="l5.446">   // Used for asynchronous db opens. If non-null, we're still opening</span>
<a href="#l5.447"></a><span id="l5.447">   // the underlying mork database. If null, the db has been completely opened.</span>
<a href="#l5.448"></a><span id="l5.448">   nsCOMPtr&lt;nsIMdbThumb&gt; m_thumb;</span>
<a href="#l5.449"></a><span id="l5.449">   // used to remember the args to Open for async open.</span>
<a href="#l5.450"></a><span id="l5.450">   bool m_create;</span>
<a href="#l5.451"></a><span id="l5.451">   bool m_leaveInvalidDB;</span>
<a href="#l5.452"></a><span id="l5.452"> </span>
<a href="#l5.453"></a><span id="l5.453">   nsCOMPtr&lt;nsIFile&gt; m_dbFile;</span>
<a href="#l5.454"></a><span id="l5.454">   nsTArray&lt;nsMsgKey&gt; m_newSet;  // new messages since last open.</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineminus">-  bool          m_mdbTokensInitialized;</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineplus">+  bool m_mdbTokensInitialized;</span>
<a href="#l5.457"></a><span id="l5.457">   nsTObserverArray&lt;nsCOMPtr&lt;nsIDBChangeListener&gt; &gt; m_ChangeListeners;</span>
<a href="#l5.458"></a><span id="l5.458" class="difflineminus">-  mdb_token     m_hdrRowScopeToken;</span>
<a href="#l5.459"></a><span id="l5.459" class="difflineminus">-  mdb_token     m_threadRowScopeToken;</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineminus">-  mdb_token     m_hdrTableKindToken;</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineminus">-  mdb_token     m_threadTableKindToken;</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineminus">-  mdb_token     m_allThreadsTableKindToken;</span>
<a href="#l5.463"></a><span id="l5.463" class="difflineminus">-  mdb_token     m_subjectColumnToken;</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineminus">-  mdb_token     m_senderColumnToken;</span>
<a href="#l5.465"></a><span id="l5.465" class="difflineminus">-  mdb_token     m_messageIdColumnToken;</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineminus">-  mdb_token     m_referencesColumnToken;</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineminus">-  mdb_token     m_recipientsColumnToken;</span>
<a href="#l5.468"></a><span id="l5.468" class="difflineminus">-  mdb_token     m_dateColumnToken;</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineminus">-  mdb_token     m_messageSizeColumnToken;</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineminus">-  mdb_token     m_flagsColumnToken;</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineminus">-  mdb_token     m_priorityColumnToken;</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineminus">-  mdb_token     m_labelColumnToken;</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineminus">-  mdb_token     m_statusOffsetColumnToken;</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineminus">-  mdb_token     m_numLinesColumnToken;</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineminus">-  mdb_token     m_ccListColumnToken;</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineminus">-  mdb_token     m_bccListColumnToken;</span>
<a href="#l5.477"></a><span id="l5.477" class="difflineminus">-  mdb_token     m_threadFlagsColumnToken;</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineminus">-  mdb_token     m_threadIdColumnToken;</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineminus">-  mdb_token     m_threadChildrenColumnToken;</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineminus">-  mdb_token     m_threadUnreadChildrenColumnToken;</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineminus">-  mdb_token     m_messageThreadIdColumnToken;</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineminus">-  mdb_token     m_threadSubjectColumnToken;</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineminus">-  mdb_token     m_messageCharSetColumnToken;</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineminus">-  mdb_token     m_threadParentColumnToken;</span>
<a href="#l5.485"></a><span id="l5.485" class="difflineminus">-  mdb_token     m_threadRootKeyColumnToken;</span>
<a href="#l5.486"></a><span id="l5.486" class="difflineminus">-  mdb_token     m_threadNewestMsgDateColumnToken;</span>
<a href="#l5.487"></a><span id="l5.487" class="difflineminus">-  mdb_token     m_offlineMsgOffsetColumnToken;</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineminus">-  mdb_token     m_offlineMessageSizeColumnToken;</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineplus">+  mdb_token m_hdrRowScopeToken;</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineplus">+  mdb_token m_threadRowScopeToken;</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineplus">+  mdb_token m_hdrTableKindToken;</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineplus">+  mdb_token m_threadTableKindToken;</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineplus">+  mdb_token m_allThreadsTableKindToken;</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineplus">+  mdb_token m_subjectColumnToken;</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineplus">+  mdb_token m_senderColumnToken;</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineplus">+  mdb_token m_messageIdColumnToken;</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineplus">+  mdb_token m_referencesColumnToken;</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineplus">+  mdb_token m_recipientsColumnToken;</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineplus">+  mdb_token m_dateColumnToken;</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineplus">+  mdb_token m_messageSizeColumnToken;</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineplus">+  mdb_token m_flagsColumnToken;</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineplus">+  mdb_token m_priorityColumnToken;</span>
<a href="#l5.503"></a><span id="l5.503" class="difflineplus">+  mdb_token m_labelColumnToken;</span>
<a href="#l5.504"></a><span id="l5.504" class="difflineplus">+  mdb_token m_statusOffsetColumnToken;</span>
<a href="#l5.505"></a><span id="l5.505" class="difflineplus">+  mdb_token m_numLinesColumnToken;</span>
<a href="#l5.506"></a><span id="l5.506" class="difflineplus">+  mdb_token m_ccListColumnToken;</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineplus">+  mdb_token m_bccListColumnToken;</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineplus">+  mdb_token m_threadFlagsColumnToken;</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineplus">+  mdb_token m_threadIdColumnToken;</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineplus">+  mdb_token m_threadChildrenColumnToken;</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineplus">+  mdb_token m_threadUnreadChildrenColumnToken;</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineplus">+  mdb_token m_messageThreadIdColumnToken;</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineplus">+  mdb_token m_threadSubjectColumnToken;</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineplus">+  mdb_token m_messageCharSetColumnToken;</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineplus">+  mdb_token m_threadParentColumnToken;</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+  mdb_token m_threadRootKeyColumnToken;</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+  mdb_token m_threadNewestMsgDateColumnToken;</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineplus">+  mdb_token m_offlineMsgOffsetColumnToken;</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineplus">+  mdb_token m_offlineMessageSizeColumnToken;</span>
<a href="#l5.520"></a><span id="l5.520"> </span>
<a href="#l5.521"></a><span id="l5.521">   // header caching stuff - MRU headers, keeps them around in memory</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineminus">-  nsresult      AddHdrToCache(nsIMsgDBHdr *hdr, nsMsgKey key);</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineminus">-  nsresult      ClearHdrCache(bool reInit);</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineminus">-  nsresult      RemoveHdrFromCache(nsIMsgDBHdr *hdr, nsMsgKey key);</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineplus">+  nsresult AddHdrToCache(nsIMsgDBHdr *hdr, nsMsgKey key);</span>
<a href="#l5.526"></a><span id="l5.526" class="difflineplus">+  nsresult ClearHdrCache(bool reInit);</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineplus">+  nsresult RemoveHdrFromCache(nsIMsgDBHdr *hdr, nsMsgKey key);</span>
<a href="#l5.528"></a><span id="l5.528">   // all headers currently instantiated, doesn't hold refs</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineminus">-  // these get added when msg hdrs get constructed, and removed when they get destroyed.</span>
<a href="#l5.530"></a><span id="l5.530" class="difflineminus">-  nsresult      GetHdrFromUseCache(nsMsgKey key, nsIMsgDBHdr* *result);</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineminus">-  nsresult      AddHdrToUseCache(nsIMsgDBHdr *hdr, nsMsgKey key);</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineminus">-  nsresult      ClearUseHdrCache();</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineminus">-  nsresult      RemoveHdrFromUseCache(nsIMsgDBHdr *hdr, nsMsgKey key);</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineplus">+  // these get added when msg hdrs get constructed, and removed when they get</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineplus">+  // destroyed.</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineplus">+  nsresult GetHdrFromUseCache(nsMsgKey key, nsIMsgDBHdr **result);</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineplus">+  nsresult AddHdrToUseCache(nsIMsgDBHdr *hdr, nsMsgKey key);</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineplus">+  nsresult ClearUseHdrCache();</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineplus">+  nsresult RemoveHdrFromUseCache(nsIMsgDBHdr *hdr, nsMsgKey key);</span>
<a href="#l5.540"></a><span id="l5.540"> </span>
<a href="#l5.541"></a><span id="l5.541">   // not-reference holding array of threads we've handed out.</span>
<a href="#l5.542"></a><span id="l5.542">   // If a db goes away, it will clean up the outstanding threads.</span>
<a href="#l5.543"></a><span id="l5.543">   // We use an nsTArray because we don't expect to ever have very many</span>
<a href="#l5.544"></a><span id="l5.544">   // of these, rarely more than 5.</span>
<a href="#l5.545"></a><span id="l5.545">   nsTArray&lt;nsMsgThread *&gt; m_threads;</span>
<a href="#l5.546"></a><span id="l5.546">   // Clear outstanding thread objects</span>
<a href="#l5.547"></a><span id="l5.547">   void ClearThreads();</span>
<a href="#l5.548"></a><span id="l5.548">   nsMsgThread *FindExistingThread(nsMsgKey threadId);</span>
<a href="#l5.549"></a><span id="l5.549"> </span>
<a href="#l5.550"></a><span id="l5.550" class="difflineminus">-  mdb_pos       FindInsertIndexInSortedTable(nsIMdbTable *table, mdb_id idToInsert);</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineplus">+  mdb_pos FindInsertIndexInSortedTable(nsIMdbTable *table, mdb_id idToInsert);</span>
<a href="#l5.552"></a><span id="l5.552"> </span>
<a href="#l5.553"></a><span id="l5.553" class="difflineminus">-  void          ClearCachedObjects(bool dbGoingAway);</span>
<a href="#l5.554"></a><span id="l5.554" class="difflineminus">-  void          ClearEnumerators();</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineplus">+  void ClearCachedObjects(bool dbGoingAway);</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineplus">+  void ClearEnumerators();</span>
<a href="#l5.557"></a><span id="l5.557">   // all instantiated headers, but doesn't hold refs.</span>
<a href="#l5.558"></a><span id="l5.558" class="difflineminus">-  PLDHashTable  *m_headersInUse;</span>
<a href="#l5.559"></a><span id="l5.559" class="difflineminus">-  static PLDHashNumber HashKey(const void* aKey);</span>
<a href="#l5.560"></a><span id="l5.560" class="difflineminus">-  static bool MatchEntry(const PLDHashEntryHdr* aEntry, const void* aKey);</span>
<a href="#l5.561"></a><span id="l5.561" class="difflineminus">-  static void MoveEntry(PLDHashTable* aTable, const PLDHashEntryHdr* aFrom, PLDHashEntryHdr* aTo);</span>
<a href="#l5.562"></a><span id="l5.562" class="difflineminus">-  static void ClearEntry(PLDHashTable* aTable, PLDHashEntryHdr* aEntry);</span>
<a href="#l5.563"></a><span id="l5.563" class="difflineplus">+  PLDHashTable *m_headersInUse;</span>
<a href="#l5.564"></a><span id="l5.564" class="difflineplus">+  static PLDHashNumber HashKey(const void *aKey);</span>
<a href="#l5.565"></a><span id="l5.565" class="difflineplus">+  static bool MatchEntry(const PLDHashEntryHdr *aEntry, const void *aKey);</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineplus">+  static void MoveEntry(PLDHashTable *aTable, const PLDHashEntryHdr *aFrom,</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineplus">+                        PLDHashEntryHdr *aTo);</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineplus">+  static void ClearEntry(PLDHashTable *aTable, PLDHashEntryHdr *aEntry);</span>
<a href="#l5.569"></a><span id="l5.569">   static PLDHashTableOps gMsgDBHashTableOps;</span>
<a href="#l5.570"></a><span id="l5.570">   struct MsgHdrHashElement : public PLDHashEntryHdr {</span>
<a href="#l5.571"></a><span id="l5.571" class="difflineminus">-    nsMsgKey       mKey;</span>
<a href="#l5.572"></a><span id="l5.572" class="difflineminus">-    nsIMsgDBHdr     *mHdr;</span>
<a href="#l5.573"></a><span id="l5.573" class="difflineplus">+    nsMsgKey mKey;</span>
<a href="#l5.574"></a><span id="l5.574" class="difflineplus">+    nsIMsgDBHdr *mHdr;</span>
<a href="#l5.575"></a><span id="l5.575">   };</span>
<a href="#l5.576"></a><span id="l5.576" class="difflineminus">-  PLDHashTable  *m_cachedHeaders;</span>
<a href="#l5.577"></a><span id="l5.577" class="difflineminus">-  bool          m_bCacheHeaders;</span>
<a href="#l5.578"></a><span id="l5.578" class="difflineminus">-  nsMsgKey  m_cachedThreadId;</span>
<a href="#l5.579"></a><span id="l5.579" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; m_cachedThread;</span>
<a href="#l5.580"></a><span id="l5.580" class="difflineplus">+  PLDHashTable *m_cachedHeaders;</span>
<a href="#l5.581"></a><span id="l5.581" class="difflineplus">+  bool m_bCacheHeaders;</span>
<a href="#l5.582"></a><span id="l5.582" class="difflineplus">+  nsMsgKey m_cachedThreadId;</span>
<a href="#l5.583"></a><span id="l5.583" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; m_cachedThread;</span>
<a href="#l5.584"></a><span id="l5.584">   nsCOMPtr&lt;nsIMdbFactory&gt; mMdbFactory;</span>
<a href="#l5.585"></a><span id="l5.585"> </span>
<a href="#l5.586"></a><span id="l5.586">   // Message reference hash table</span>
<a href="#l5.587"></a><span id="l5.587">   static PLDHashTableOps gRefHashTableOps;</span>
<a href="#l5.588"></a><span id="l5.588">   struct RefHashElement : public PLDHashEntryHdr {</span>
<a href="#l5.589"></a><span id="l5.589" class="difflineminus">-    const char     *mRef;       // Hash entry key, must come first</span>
<a href="#l5.590"></a><span id="l5.590" class="difflineminus">-    nsMsgKey        mThreadId;</span>
<a href="#l5.591"></a><span id="l5.591" class="difflineminus">-    uint32_t        mCount;</span>
<a href="#l5.592"></a><span id="l5.592" class="difflineplus">+    const char *mRef;  // Hash entry key, must come first</span>
<a href="#l5.593"></a><span id="l5.593" class="difflineplus">+    nsMsgKey mThreadId;</span>
<a href="#l5.594"></a><span id="l5.594" class="difflineplus">+    uint32_t mCount;</span>
<a href="#l5.595"></a><span id="l5.595">   };</span>
<a href="#l5.596"></a><span id="l5.596">   PLDHashTable *m_msgReferences;</span>
<a href="#l5.597"></a><span id="l5.597">   nsresult GetRefFromHash(nsCString &amp;reference, nsMsgKey *threadId);</span>
<a href="#l5.598"></a><span id="l5.598">   nsresult AddRefToHash(nsCString &amp;reference, nsMsgKey threadId);</span>
<a href="#l5.599"></a><span id="l5.599">   nsresult AddMsgRefsToHash(nsIMsgDBHdr *msgHdr);</span>
<a href="#l5.600"></a><span id="l5.600">   nsresult RemoveRefFromHash(nsCString &amp;reference);</span>
<a href="#l5.601"></a><span id="l5.601">   nsresult RemoveMsgRefsFromHash(nsIMsgDBHdr *msgHdr);</span>
<a href="#l5.602"></a><span id="l5.602">   nsresult InitRefHash();</span>
<a href="#l5.603"></a><span id="l5.603"> </span>
<a href="#l5.604"></a><span id="l5.604">   // not-reference holding array of enumerators we've handed out.</span>
<a href="#l5.605"></a><span id="l5.605">   // If a db goes away, it will clean up the outstanding enumerators.</span>
<a href="#l5.606"></a><span id="l5.606">   nsTArray&lt;nsMsgDBEnumerator *&gt; m_enumerators;</span>
<a href="#l5.607"></a><span id="l5.607"> </span>
<a href="#l5.608"></a><span id="l5.608">   // Memory reporter details</span>
<a href="#l5.609"></a><span id="l5.609" class="difflineminus">-public:</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineplus">+ public:</span>
<a href="#l5.611"></a><span id="l5.611">   static size_t HeaderHashSizeOf(PLDHashEntryHdr *hdr,</span>
<a href="#l5.612"></a><span id="l5.612">                                  mozilla::MallocSizeOf aMallocSizeOf,</span>
<a href="#l5.613"></a><span id="l5.613">                                  void *arg);</span>
<a href="#l5.614"></a><span id="l5.614">   virtual size_t SizeOfExcludingThis(mozilla::MallocSizeOf aMallocSizeOf) const;</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineminus">-  virtual size_t SizeOfIncludingThis(mozilla::MallocSizeOf aMallocSizeOf) const</span>
<a href="#l5.616"></a><span id="l5.616" class="difflineminus">-  {</span>
<a href="#l5.617"></a><span id="l5.617" class="difflineplus">+  virtual size_t SizeOfIncludingThis(</span>
<a href="#l5.618"></a><span id="l5.618" class="difflineplus">+      mozilla::MallocSizeOf aMallocSizeOf) const {</span>
<a href="#l5.619"></a><span id="l5.619">     return aMallocSizeOf(this) + SizeOfExcludingThis(aMallocSizeOf);</span>
<a href="#l5.620"></a><span id="l5.620">   }</span>
<a href="#l5.621"></a><span id="l5.621" class="difflineminus">-private:</span>
<a href="#l5.622"></a><span id="l5.622" class="difflineplus">+</span>
<a href="#l5.623"></a><span id="l5.623" class="difflineplus">+ private:</span>
<a href="#l5.624"></a><span id="l5.624">   uint32_t m_cacheSize;</span>
<a href="#l5.625"></a><span id="l5.625">   RefPtr&lt;mozilla::mailnews::MsgDBReporter&gt; mMemReporter;</span>
<a href="#l5.626"></a><span id="l5.626"> };</span>
<a href="#l5.627"></a><span id="l5.627"> </span>
<a href="#l5.628"></a><span id="l5.628" class="difflineminus">-class nsMsgRetentionSettings : public nsIMsgRetentionSettings</span>
<a href="#l5.629"></a><span id="l5.629" class="difflineminus">-{</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineminus">-public:</span>
<a href="#l5.631"></a><span id="l5.631" class="difflineplus">+class nsMsgRetentionSettings : public nsIMsgRetentionSettings {</span>
<a href="#l5.632"></a><span id="l5.632" class="difflineplus">+ public:</span>
<a href="#l5.633"></a><span id="l5.633">   nsMsgRetentionSettings();</span>
<a href="#l5.634"></a><span id="l5.634"> </span>
<a href="#l5.635"></a><span id="l5.635">   NS_DECL_ISUPPORTS</span>
<a href="#l5.636"></a><span id="l5.636">   NS_DECL_NSIMSGRETENTIONSETTINGS</span>
<a href="#l5.637"></a><span id="l5.637" class="difflineminus">-protected:</span>
<a href="#l5.638"></a><span id="l5.638" class="difflineplus">+ protected:</span>
<a href="#l5.639"></a><span id="l5.639">   virtual ~nsMsgRetentionSettings();</span>
<a href="#l5.640"></a><span id="l5.640">   nsMsgRetainByPreference m_retainByPreference;</span>
<a href="#l5.641"></a><span id="l5.641" class="difflineminus">-  uint32_t                m_daysToKeepHdrs;</span>
<a href="#l5.642"></a><span id="l5.642" class="difflineminus">-  uint32_t                m_numHeadersToKeep;</span>
<a href="#l5.643"></a><span id="l5.643" class="difflineminus">-  bool                    m_useServerDefaults;</span>
<a href="#l5.644"></a><span id="l5.644" class="difflineminus">-  bool                    m_cleanupBodiesByDays;</span>
<a href="#l5.645"></a><span id="l5.645" class="difflineminus">-  uint32_t                m_daysToKeepBodies;</span>
<a href="#l5.646"></a><span id="l5.646" class="difflineminus">-  bool                    m_applyToFlaggedMessages;</span>
<a href="#l5.647"></a><span id="l5.647" class="difflineplus">+  uint32_t m_daysToKeepHdrs;</span>
<a href="#l5.648"></a><span id="l5.648" class="difflineplus">+  uint32_t m_numHeadersToKeep;</span>
<a href="#l5.649"></a><span id="l5.649" class="difflineplus">+  bool m_useServerDefaults;</span>
<a href="#l5.650"></a><span id="l5.650" class="difflineplus">+  bool m_cleanupBodiesByDays;</span>
<a href="#l5.651"></a><span id="l5.651" class="difflineplus">+  uint32_t m_daysToKeepBodies;</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineplus">+  bool m_applyToFlaggedMessages;</span>
<a href="#l5.653"></a><span id="l5.653"> };</span>
<a href="#l5.654"></a><span id="l5.654"> </span>
<a href="#l5.655"></a><span id="l5.655" class="difflineminus">-class nsMsgDownloadSettings : public nsIMsgDownloadSettings</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineminus">-{</span>
<a href="#l5.657"></a><span id="l5.657" class="difflineminus">-public:</span>
<a href="#l5.658"></a><span id="l5.658" class="difflineplus">+class nsMsgDownloadSettings : public nsIMsgDownloadSettings {</span>
<a href="#l5.659"></a><span id="l5.659" class="difflineplus">+ public:</span>
<a href="#l5.660"></a><span id="l5.660">   nsMsgDownloadSettings();</span>
<a href="#l5.661"></a><span id="l5.661"> </span>
<a href="#l5.662"></a><span id="l5.662">   NS_DECL_ISUPPORTS</span>
<a href="#l5.663"></a><span id="l5.663">   NS_DECL_NSIMSGDOWNLOADSETTINGS</span>
<a href="#l5.664"></a><span id="l5.664" class="difflineminus">-protected:</span>
<a href="#l5.665"></a><span id="l5.665" class="difflineplus">+ protected:</span>
<a href="#l5.666"></a><span id="l5.666">   virtual ~nsMsgDownloadSettings();</span>
<a href="#l5.667"></a><span id="l5.667">   bool m_useServerDefaults;</span>
<a href="#l5.668"></a><span id="l5.668">   bool m_downloadUnreadOnly;</span>
<a href="#l5.669"></a><span id="l5.669">   bool m_downloadByDate;</span>
<a href="#l5.670"></a><span id="l5.670">   int32_t m_ageLimitOfMsgsToDownload;</span>
<a href="#l5.671"></a><span id="l5.671"> };</span>
<a href="#l5.672"></a><span id="l5.672"> </span>
<a href="#l5.673"></a><span id="l5.673"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMsgHdr.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMsgHdr.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -12,83 +12,84 @@</span>
<a href="#l6.4"></a><span id="l6.4"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l6.5"></a><span id="l6.5"> #include &quot;mdb.h&quot;</span>
<a href="#l6.6"></a><span id="l6.6"> #include &quot;nsTArray.h&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> class nsMsgDatabase;</span>
<a href="#l6.9"></a><span id="l6.9"> class nsIMsgThread;</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> class nsMsgHdr : public nsIMsgDBHdr {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-public:</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-    NS_DECL_NSIMSGDBHDR</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-    friend class nsMsgDatabase;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-    friend class nsImapMailDatabase;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-    friend class nsMsgPropertyEnumerator;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-    friend class nsMsgThread;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+ public:</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+  NS_DECL_NSIMSGDBHDR</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+  friend class nsMsgDatabase;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  friend class nsImapMailDatabase;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+  friend class nsMsgPropertyEnumerator;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+  friend class nsMsgThread;</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-    ////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-    ////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-    // nsMsgHdr methods:</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-    nsMsgHdr(nsMsgDatabase *db, nsIMdbRow *dbRow);</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+  ////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+  ////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  // nsMsgHdr methods:</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  nsMsgHdr(nsMsgDatabase *db, nsIMdbRow *dbRow);</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-    size_t SizeOfExcludingThis(mozilla::MallocSizeOf aMallocSizeOfFun) const</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-    {</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-      return m_references.ShallowSizeOfExcludingThis(aMallocSizeOfFun);</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-    }</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-    size_t SizeOfIncludingThis(mozilla::MallocSizeOf aMallocSizeOfFun) const</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-    {</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-      return aMallocSizeOfFun(this) + SizeOfExcludingThis(aMallocSizeOfFun);</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-    }</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+  size_t SizeOfExcludingThis(mozilla::MallocSizeOf aMallocSizeOfFun) const {</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+    return m_references.ShallowSizeOfExcludingThis(aMallocSizeOfFun);</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+  }</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+  size_t SizeOfIncludingThis(mozilla::MallocSizeOf aMallocSizeOfFun) const {</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+    return aMallocSizeOfFun(this) + SizeOfExcludingThis(aMallocSizeOfFun);</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+  }</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-protected:</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-    nsIMdbRow*       GetMDBRow() { return m_mdbRow; }</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-    void             ReleaseMDBRow() { NS_IF_RELEASE(m_mdbRow); }</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-    nsMsgDatabase*   GetMdb() { return m_mdb; }</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-    void             ClearCachedValues() { m_initedValues = 0; }</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+ protected:</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+  nsIMdbRow *GetMDBRow() { return m_mdbRow; }</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+  void ReleaseMDBRow() { NS_IF_RELEASE(m_mdbRow); }</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+  nsMsgDatabase *GetMdb() { return m_mdb; }</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+  void ClearCachedValues() { m_initedValues = 0; }</span>
<a href="#l6.62"></a><span id="l6.62"> </span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-    virtual nsresult GetRawFlags(uint32_t *result);</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+  virtual nsresult GetRawFlags(uint32_t *result);</span>
<a href="#l6.65"></a><span id="l6.65"> </span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-    bool             IsParentOf(nsIMsgDBHdr *possibleChild);</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-    bool             IsAncestorOf(nsIMsgDBHdr *possibleChild);</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+  bool IsParentOf(nsIMsgDBHdr *possibleChild);</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+  bool IsAncestorOf(nsIMsgDBHdr *possibleChild);</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+ private:</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+  virtual ~nsMsgHdr();</span>
<a href="#l6.73"></a><span id="l6.73"> </span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-private:</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-    virtual ~nsMsgHdr();</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+  void Init();</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+  virtual nsresult InitFlags();</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+  virtual nsresult InitCachedValues();</span>
<a href="#l6.79"></a><span id="l6.79"> </span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-    void             Init();</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-    virtual nsresult InitFlags();</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-    virtual nsresult InitCachedValues();</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+  bool IsAncestorKilled(uint32_t ancestorsToCheck);</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+  void ReparentInThread(nsIMsgThread *thread);</span>
<a href="#l6.85"></a><span id="l6.85"> </span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-    bool             IsAncestorKilled(uint32_t ancestorsToCheck);</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-    void             ReparentInThread(nsIMsgThread *thread);</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-    nsresult SetStringColumn(const char *str, mdb_token token);</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-    nsresult SetUInt32Column(uint32_t value, mdb_token token);</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-    nsresult GetUInt32Column(mdb_token token, uint32_t *pvalue, uint32_t defaultValue = 0);</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-    nsresult SetUInt64Column(uint64_t value, mdb_token token);</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-    nsresult GetUInt64Column(mdb_token token, uint64_t *pvalue, uint64_t defaultValue = 0);</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+  nsresult SetStringColumn(const char *str, mdb_token token);</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+  nsresult SetUInt32Column(uint32_t value, mdb_token token);</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+  nsresult GetUInt32Column(mdb_token token, uint32_t *pvalue,</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+                           uint32_t defaultValue = 0);</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+  nsresult SetUInt64Column(uint64_t value, mdb_token token);</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+  nsresult GetUInt64Column(mdb_token token, uint64_t *pvalue,</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+                           uint64_t defaultValue = 0);</span>
<a href="#l6.101"></a><span id="l6.101"> </span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-    // reference and threading stuff.</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-    nsresult ParseReferences(const char *references);</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-    const char* GetNextReference(const char *startNextRef, nsCString &amp;reference,</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-                                 bool acceptNonDelimitedReferences);</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+  // reference and threading stuff.</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+  nsresult ParseReferences(const char *references);</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+  const char *GetNextReference(const char *startNextRef, nsCString &amp;reference,</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+                               bool acceptNonDelimitedReferences);</span>
<a href="#l6.110"></a><span id="l6.110"> </span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-    nsMsgKey    m_threadId;</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-    nsMsgKey    m_messageKey;   // news: article number, local mail: key, imap: uid...</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-    nsMsgKey    m_threadParent; // message this is a reply to, in thread.</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-    PRTime      m_date;</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-    uint32_t    m_messageSize;  // lines for news articles, bytes for mail messages</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-    uint32_t    m_statusOffset; // offset in a local mail message of the x-mozilla-status header</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-    uint32_t    m_flags;</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-    // avoid parsing references every time we want one</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-    nsTArray&lt;nsCString&gt; m_references;</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-    nsMsgPriorityValue  m_priority;</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+  nsMsgKey m_threadId;</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+  nsMsgKey m_messageKey;  // news: article number, local mail: key, imap: uid...</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+  nsMsgKey m_threadParent;  // message this is a reply to, in thread.</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+  PRTime m_date;</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+  uint32_t m_messageSize;   // lines for news articles, bytes for mail messages</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+  uint32_t m_statusOffset;  // offset in a local mail message of the</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+                            // x-mozilla-status header</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+  uint32_t m_flags;</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+  // avoid parsing references every time we want one</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+  nsTArray&lt;nsCString&gt; m_references;</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+  nsMsgPriorityValue m_priority;</span>
<a href="#l6.132"></a><span id="l6.132"> </span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-    // nsMsgHdrs will have to know what db and row they belong to, since they are really</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-    // just a wrapper around the msg row in the mdb. This could cause problems,</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-    // though I hope not.</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-    nsMsgDatabase *m_mdb;</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-    nsIMdbRow     *m_mdbRow;</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-    uint32_t      m_initedValues;</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+  // nsMsgHdrs will have to know what db and row they belong to, since they are</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+  // really just a wrapper around the msg row in the mdb. This could cause</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+  // problems, though I hope not.</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+  nsMsgDatabase *m_mdb;</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+  nsIMdbRow *m_mdbRow;</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+  uint32_t m_initedValues;</span>
<a href="#l6.145"></a><span id="l6.145"> };</span>
<a href="#l6.146"></a><span id="l6.146"> </span>
<a href="#l6.147"></a><span id="l6.147"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMsgThread.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMsgThread.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -12,52 +12,55 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;mdb.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> class nsIMdbTable;</span>
<a href="#l7.8"></a><span id="l7.8"> class nsIMsgDBHdr;</span>
<a href="#l7.9"></a><span id="l7.9"> class nsMsgDatabase;</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> class nsMsgThread : public nsIMsgThread {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-public:</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ public:</span>
<a href="#l7.14"></a><span id="l7.14">   nsMsgThread();</span>
<a href="#l7.15"></a><span id="l7.15">   nsMsgThread(nsMsgDatabase *db, nsIMdbTable *table);</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17">   friend class nsMsgThreadEnumerator;</span>
<a href="#l7.18"></a><span id="l7.18">   friend class nsMsgDatabase;</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20">   NS_DECL_ISUPPORTS</span>
<a href="#l7.21"></a><span id="l7.21">   NS_DECL_NSIMSGTHREAD</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23">   RefPtr&lt;nsMsgDatabase&gt; m_mdbDB;</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-protected:</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+ protected:</span>
<a href="#l7.27"></a><span id="l7.27">   virtual ~nsMsgThread();</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-  void                  Init();</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-  void                  Clear();</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-  virtual nsresult      InitCachedValues();</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-  nsresult              ChangeChildCount(int32_t delta);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-  nsresult              ChangeUnreadChildCount(int32_t delta);</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-  nsresult              RemoveChild(nsMsgKey msgKey);</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-  nsresult              SetThreadRootKey(nsMsgKey threadRootKey);</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-  nsresult              GetChildHdrForKey(nsMsgKey desiredKey,</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-                                          nsIMsgDBHdr **result, int32_t *resultIndex);</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-  nsresult              RerootThread(nsIMsgDBHdr *newParentOfOldRoot, nsIMsgDBHdr *oldRoot, nsIDBChangeAnnouncer *announcer);</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-  nsresult              ReparentChildrenOf(nsMsgKey oldParent, nsMsgKey newParent, nsIDBChangeAnnouncer *announcer);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+  void Init();</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+  void Clear();</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+  virtual nsresult InitCachedValues();</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+  nsresult ChangeChildCount(int32_t delta);</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+  nsresult ChangeUnreadChildCount(int32_t delta);</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+  nsresult RemoveChild(nsMsgKey msgKey);</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+  nsresult SetThreadRootKey(nsMsgKey threadRootKey);</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+  nsresult GetChildHdrForKey(nsMsgKey desiredKey, nsIMsgDBHdr **result,</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+                             int32_t *resultIndex);</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+  nsresult RerootThread(nsIMsgDBHdr *newParentOfOldRoot, nsIMsgDBHdr *oldRoot,</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+                        nsIDBChangeAnnouncer *announcer);</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+  nsresult ReparentChildrenOf(nsMsgKey oldParent, nsMsgKey newParent,</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+                              nsIDBChangeAnnouncer *announcer);</span>
<a href="#l7.53"></a><span id="l7.53"> </span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-  nsresult              ReparentNonReferenceChildrenOf(nsIMsgDBHdr *topLevelHdr, nsMsgKey newParentKey,</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-                                                       nsIDBChangeAnnouncer *announcer);</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-  nsresult              ReparentMsgsWithInvalidParent(uint32_t numChildren, nsMsgKey threadParentKey);</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+  nsresult ReparentNonReferenceChildrenOf(nsIMsgDBHdr *topLevelHdr,</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+                                          nsMsgKey newParentKey,</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+                                          nsIDBChangeAnnouncer *announcer);</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  nsresult ReparentMsgsWithInvalidParent(uint32_t numChildren,</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+                                         nsMsgKey threadParentKey);</span>
<a href="#l7.62"></a><span id="l7.62"> </span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-  nsMsgKey              m_threadKey;</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-  uint32_t              m_numChildren;</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-  uint32_t              m_numUnreadChildren;</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-  uint32_t              m_flags;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+  nsMsgKey m_threadKey;</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+  uint32_t m_numChildren;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  uint32_t m_numUnreadChildren;</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  uint32_t m_flags;</span>
<a href="#l7.71"></a><span id="l7.71">   nsCOMPtr&lt;nsIMdbTable&gt; m_mdbTable;</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-  nsCOMPtr&lt;nsIMdbRow&gt;   m_metaRow;</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-  bool                  m_cachedValuesInitialized;</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-  nsMsgKey              m_threadRootKey;</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-  uint32_t              m_newestMsgDate;</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; m_metaRow;</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  bool m_cachedValuesInitialized;</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+  nsMsgKey m_threadRootKey;</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+  uint32_t m_newestMsgDate;</span>
<a href="#l7.80"></a><span id="l7.80"> };</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82"> #endif</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsNewsDatabase.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsNewsDatabase.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -8,48 +8,50 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> #include &quot;nsMsgDatabase.h&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsINewsDatabase.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsTArray.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> // news group database</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-class nsNewsDatabase : public nsMsgDatabase , public nsINewsDatabase</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-{</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-public:</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+class nsNewsDatabase : public nsMsgDatabase, public nsINewsDatabase {</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+ public:</span>
<a href="#l8.17"></a><span id="l8.17">   nsNewsDatabase();</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l8.20"></a><span id="l8.20">   NS_DECL_NSINEWSDATABASE</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22">   NS_IMETHOD Close(bool forceCommit) override;</span>
<a href="#l8.23"></a><span id="l8.23">   NS_IMETHOD ForceClosed() override;</span>
<a href="#l8.24"></a><span id="l8.24">   NS_IMETHOD Commit(nsMsgDBCommit commitType) override;</span>
<a href="#l8.25"></a><span id="l8.25">   virtual uint32_t GetCurVersion() override;</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27">   // methods to get and set docsets for ids.</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-  NS_IMETHOD  IsRead(nsMsgKey key, bool *pRead) override;</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-  virtual nsresult  IsHeaderRead(nsIMsgDBHdr *msgHdr, bool *pRead) override;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+  NS_IMETHOD IsRead(nsMsgKey key, bool *pRead) override;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+  virtual nsresult IsHeaderRead(nsIMsgDBHdr *msgHdr, bool *pRead) override;</span>
<a href="#l8.32"></a><span id="l8.32"> </span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-  NS_IMETHOD         GetHighWaterArticleNum(nsMsgKey *key) override;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-  NS_IMETHOD         GetLowWaterArticleNum(nsMsgKey *key) override;</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-  NS_IMETHOD         MarkAllRead(uint32_t *aNumMarked, nsMsgKey **thoseMarked) override;</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+  NS_IMETHOD GetHighWaterArticleNum(nsMsgKey *key) override;</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+  NS_IMETHOD GetLowWaterArticleNum(nsMsgKey *key) override;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+  NS_IMETHOD MarkAllRead(uint32_t *aNumMarked, nsMsgKey **thoseMarked) override;</span>
<a href="#l8.39"></a><span id="l8.39"> </span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-  virtual nsresult    ExpireUpTo(nsMsgKey expireKey);</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-  virtual nsresult    ExpireRange(nsMsgKey startRange, nsMsgKey endRange);</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+  virtual nsresult ExpireUpTo(nsMsgKey expireKey);</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+  virtual nsresult ExpireRange(nsMsgKey startRange, nsMsgKey endRange);</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+  virtual bool SetHdrReadFlag(nsIMsgDBHdr *msgHdr, bool bRead) override;</span>
<a href="#l8.46"></a><span id="l8.46"> </span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-  virtual bool        SetHdrReadFlag(nsIMsgDBHdr *msgHdr, bool bRead) override;</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-  virtual nsresult  AdjustExpungedBytesOnDelete(nsIMsgDBHdr *msgHdr) override;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-  nsresult          SyncWithReadSet();</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  virtual nsresult AdjustExpungedBytesOnDelete(nsIMsgDBHdr *msgHdr) override;</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+  nsresult SyncWithReadSet();</span>
<a href="#l8.53"></a><span id="l8.53"> </span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-  NS_IMETHOD GetDefaultViewFlags(nsMsgViewFlagsTypeValue *aDefaultViewFlags) override;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-  NS_IMETHOD GetDefaultSortType(nsMsgViewSortTypeValue *aDefaultSortType) override;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-  NS_IMETHOD GetDefaultSortOrder(nsMsgViewSortOrderValue *aDefaultSortOrder) override;</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+  NS_IMETHOD GetDefaultViewFlags(</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+      nsMsgViewFlagsTypeValue *aDefaultViewFlags) override;</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+  NS_IMETHOD GetDefaultSortType(</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+      nsMsgViewSortTypeValue *aDefaultSortType) override;</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  NS_IMETHOD GetDefaultSortOrder(</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+      nsMsgViewSortOrderValue *aDefaultSortOrder) override;</span>
<a href="#l8.63"></a><span id="l8.63"> </span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-protected:</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+ protected:</span>
<a href="#l8.66"></a><span id="l8.66">   virtual ~nsNewsDatabase();</span>
<a href="#l8.67"></a><span id="l8.67">   // this is owned by the nsNewsFolder, which lives longer than the db.</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-  nsMsgKeySet           *m_readSet;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+  nsMsgKeySet *m_readSet;</span>
<a href="#l8.70"></a><span id="l8.70"> };</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsDBFolderInfo.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsDBFolderInfo.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -17,958 +17,894 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsImapCore.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> static const char *kDBFolderInfoScope = &quot;ns:msg:db:row:scope:dbfolderinfo:all&quot;;</span>
<a href="#l9.8"></a><span id="l9.8"> static const char *kDBFolderInfoTableKind = &quot;ns:msg:db:table:kind:dbfolderinfo&quot;;</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> struct mdbOid gDBFolderInfoOID;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-static const char * kNumMessagesColumnName =&quot;numMsgs&quot;;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+static const char *kNumMessagesColumnName = &quot;numMsgs&quot;;</span>
<a href="#l9.14"></a><span id="l9.14"> // have to leave this as numNewMsgs even though it's numUnread Msgs</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-static const char * kNumUnreadMessagesColumnName = &quot;numNewMsgs&quot;;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-static const char * kFlagsColumnName = &quot;flags&quot;;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-static const char * kFolderSizeColumnName = &quot;folderSize&quot;;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-static const char * kExpungedBytesColumnName = &quot;expungedBytes&quot;;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-static const char * kFolderDateColumnName = &quot;folderDate&quot;;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-static const char * kHighWaterMessageKeyColumnName = &quot;highWaterKey&quot;;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+static const char *kNumUnreadMessagesColumnName = &quot;numNewMsgs&quot;;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+static const char *kFlagsColumnName = &quot;flags&quot;;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+static const char *kFolderSizeColumnName = &quot;folderSize&quot;;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+static const char *kExpungedBytesColumnName = &quot;expungedBytes&quot;;</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+static const char *kFolderDateColumnName = &quot;folderDate&quot;;</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+static const char *kHighWaterMessageKeyColumnName = &quot;highWaterKey&quot;;</span>
<a href="#l9.27"></a><span id="l9.27"> </span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-static const char * kImapUidValidityColumnName = &quot;UIDValidity&quot;;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-static const char * kTotalPendingMessagesColumnName = &quot;totPendingMsgs&quot;;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-static const char * kUnreadPendingMessagesColumnName = &quot;unreadPendingMsgs&quot;;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-static const char * kMailboxNameColumnName = &quot;mailboxName&quot;;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-static const char * kKnownArtsSetColumnName = &quot;knownArts&quot;;</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-static const char * kExpiredMarkColumnName = &quot;expiredMark&quot;;</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-static const char * kVersionColumnName = &quot;version&quot;;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-static const char * kCharacterSetColumnName = &quot;charSet&quot;;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-static const char * kCharacterSetOverrideColumnName = &quot;charSetOverride&quot;;</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-static const char * kLocaleColumnName = &quot;locale&quot;;</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+static const char *kImapUidValidityColumnName = &quot;UIDValidity&quot;;</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+static const char *kTotalPendingMessagesColumnName = &quot;totPendingMsgs&quot;;</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+static const char *kUnreadPendingMessagesColumnName = &quot;unreadPendingMsgs&quot;;</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+static const char *kMailboxNameColumnName = &quot;mailboxName&quot;;</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+static const char *kKnownArtsSetColumnName = &quot;knownArts&quot;;</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+static const char *kExpiredMarkColumnName = &quot;expiredMark&quot;;</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+static const char *kVersionColumnName = &quot;version&quot;;</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+static const char *kCharacterSetColumnName = &quot;charSet&quot;;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+static const char *kCharacterSetOverrideColumnName = &quot;charSetOverride&quot;;</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+static const char *kLocaleColumnName = &quot;locale&quot;;</span>
<a href="#l9.48"></a><span id="l9.48"> </span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-#define kMAILNEWS_VIEW_DEFAULT_CHARSET        &quot;mailnews.view_default_charset&quot;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-#define kMAILNEWS_DEFAULT_CHARSET_OVERRIDE    &quot;mailnews.force_charset_override&quot;</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-static nsCString* gDefaultCharacterSet = nullptr;</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-static bool       gDefaultCharacterOverride;</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+#define kMAILNEWS_VIEW_DEFAULT_CHARSET &quot;mailnews.view_default_charset&quot;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+#define kMAILNEWS_DEFAULT_CHARSET_OVERRIDE &quot;mailnews.force_charset_override&quot;</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+static nsCString *gDefaultCharacterSet = nullptr;</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+static bool gDefaultCharacterOverride;</span>
<a href="#l9.58"></a><span id="l9.58"> static RefPtr&lt;nsIObserver&gt; gFolderCharsetObserver;</span>
<a href="#l9.59"></a><span id="l9.59"> </span>
<a href="#l9.60"></a><span id="l9.60"> // observer for charset related preference notification</span>
<a href="#l9.61"></a><span id="l9.61"> class nsFolderCharsetObserver : public nsIObserver {</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-public:</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+ public:</span>
<a href="#l9.65"></a><span id="l9.65">   NS_DECL_ISUPPORTS</span>
<a href="#l9.66"></a><span id="l9.66">   NS_DECL_NSIOBSERVER</span>
<a href="#l9.67"></a><span id="l9.67"> </span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-  nsFolderCharsetObserver() { }</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-private:</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+  nsFolderCharsetObserver() {}</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+ private:</span>
<a href="#l9.73"></a><span id="l9.73">   virtual ~nsFolderCharsetObserver() {}</span>
<a href="#l9.74"></a><span id="l9.74"> };</span>
<a href="#l9.75"></a><span id="l9.75"> </span>
<a href="#l9.76"></a><span id="l9.76"> NS_IMPL_ISUPPORTS(nsFolderCharsetObserver, nsIObserver)</span>
<a href="#l9.77"></a><span id="l9.77"> </span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-NS_IMETHODIMP nsFolderCharsetObserver::Observe(nsISupports *aSubject, const char *aTopic, const char16_t *someData)</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-{</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+NS_IMETHODIMP nsFolderCharsetObserver::Observe(nsISupports *aSubject,</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+                                               const char *aTopic,</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+                                               const char16_t *someData) {</span>
<a href="#l9.83"></a><span id="l9.83">   nsresult rv;</span>
<a href="#l9.84"></a><span id="l9.84"> </span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-  nsCOMPtr&lt;nsIPrefService&gt; prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefs =</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.88"></a><span id="l9.88">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.89"></a><span id="l9.89"> </span>
<a href="#l9.90"></a><span id="l9.90">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l9.91"></a><span id="l9.91">   rv = prefs-&gt;GetBranch(nullptr, getter_AddRefs(prefBranch));</span>
<a href="#l9.92"></a><span id="l9.92">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.93"></a><span id="l9.93"> </span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-  if (!strcmp(aTopic, NS_PREFBRANCH_PREFCHANGE_TOPIC_ID))</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-  {</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+  if (!strcmp(aTopic, NS_PREFBRANCH_PREFCHANGE_TOPIC_ID)) {</span>
<a href="#l9.97"></a><span id="l9.97">     nsDependentString prefName(someData);</span>
<a href="#l9.98"></a><span id="l9.98"> </span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-    if (prefName.EqualsLiteral(kMAILNEWS_VIEW_DEFAULT_CHARSET))</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-    {</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+    if (prefName.EqualsLiteral(kMAILNEWS_VIEW_DEFAULT_CHARSET)) {</span>
<a href="#l9.102"></a><span id="l9.102">       nsCOMPtr&lt;nsIPrefLocalizedString&gt; pls;</span>
<a href="#l9.103"></a><span id="l9.103">       rv = prefBranch-&gt;GetComplexValue(kMAILNEWS_VIEW_DEFAULT_CHARSET,</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-                      NS_GET_IID(nsIPrefLocalizedString), getter_AddRefs(pls));</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-      {</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+                                       NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+                                       getter_AddRefs(pls));</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.110"></a><span id="l9.110">         nsString ucsval;</span>
<a href="#l9.111"></a><span id="l9.111">         pls-&gt;ToString(getter_Copies(ucsval));</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-        if (!ucsval.IsEmpty())</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-        {</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+        if (!ucsval.IsEmpty()) {</span>
<a href="#l9.115"></a><span id="l9.115">           if (gDefaultCharacterSet)</span>
<a href="#l9.116"></a><span id="l9.116">             CopyUTF16toUTF8(ucsval, *gDefaultCharacterSet);</span>
<a href="#l9.117"></a><span id="l9.117">         }</span>
<a href="#l9.118"></a><span id="l9.118">       }</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+    } else if (prefName.EqualsLiteral(kMAILNEWS_DEFAULT_CHARSET_OVERRIDE)) {</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+      rv = prefBranch-&gt;GetBoolPref(kMAILNEWS_DEFAULT_CHARSET_OVERRIDE,</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+                                   &amp;gDefaultCharacterOverride);</span>
<a href="#l9.122"></a><span id="l9.122">     }</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-    else if (prefName.EqualsLiteral(kMAILNEWS_DEFAULT_CHARSET_OVERRIDE))</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-    {</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-      rv = prefBranch-&gt;GetBoolPref(kMAILNEWS_DEFAULT_CHARSET_OVERRIDE, &amp;gDefaultCharacterOverride);</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineminus">-    }</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-  }</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-  else if (!strcmp(aTopic, NS_XPCOM_SHUTDOWN_OBSERVER_ID))</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-  {</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+  } else if (!strcmp(aTopic, NS_XPCOM_SHUTDOWN_OBSERVER_ID)) {</span>
<a href="#l9.131"></a><span id="l9.131">     rv = prefBranch-&gt;RemoveObserver(kMAILNEWS_VIEW_DEFAULT_CHARSET, this);</span>
<a href="#l9.132"></a><span id="l9.132">     rv = prefBranch-&gt;RemoveObserver(kMAILNEWS_DEFAULT_CHARSET_OVERRIDE, this);</span>
<a href="#l9.133"></a><span id="l9.133">     gFolderCharsetObserver = nullptr;</span>
<a href="#l9.134"></a><span id="l9.134">     delete gDefaultCharacterSet;</span>
<a href="#l9.135"></a><span id="l9.135">     gDefaultCharacterSet = nullptr;</span>
<a href="#l9.136"></a><span id="l9.136">   }</span>
<a href="#l9.137"></a><span id="l9.137">   return rv;</span>
<a href="#l9.138"></a><span id="l9.138"> }</span>
<a href="#l9.139"></a><span id="l9.139"> </span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-</span>
<a href="#l9.141"></a><span id="l9.141"> NS_IMPL_ADDREF(nsDBFolderInfo)</span>
<a href="#l9.142"></a><span id="l9.142"> NS_IMPL_RELEASE(nsDBFolderInfo)</span>
<a href="#l9.143"></a><span id="l9.143"> </span>
<a href="#l9.144"></a><span id="l9.144"> NS_IMETHODIMP</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-nsDBFolderInfo::QueryInterface(REFNSIID iid, void** result)</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-{</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineminus">-  if (! result)</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+nsDBFolderInfo::QueryInterface(REFNSIID iid, void **result) {</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+  if (!result) return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.151"></a><span id="l9.151"> </span>
<a href="#l9.152"></a><span id="l9.152">   *result = nullptr;</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-  if(iid.Equals(NS_GET_IID(nsIDBFolderInfo)) ||</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-    iid.Equals(NS_GET_IID(nsISupports)))</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-  {</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-    *result = static_cast&lt;nsIDBFolderInfo*&gt;(this);</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+  if (iid.Equals(NS_GET_IID(nsIDBFolderInfo)) ||</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineplus">+      iid.Equals(NS_GET_IID(nsISupports))) {</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+    *result = static_cast&lt;nsIDBFolderInfo *&gt;(this);</span>
<a href="#l9.160"></a><span id="l9.160">     AddRef();</span>
<a href="#l9.161"></a><span id="l9.161">     return NS_OK;</span>
<a href="#l9.162"></a><span id="l9.162">   }</span>
<a href="#l9.163"></a><span id="l9.163">   return NS_NOINTERFACE;</span>
<a href="#l9.164"></a><span id="l9.164"> }</span>
<a href="#l9.165"></a><span id="l9.165"> </span>
<a href="#l9.166"></a><span id="l9.166" class="difflineminus">-</span>
<a href="#l9.167"></a><span id="l9.167"> nsDBFolderInfo::nsDBFolderInfo(nsMsgDatabase *mdb)</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-                  : m_flags(0),</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">-                    m_expiredMark(0),</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineminus">-                    m_expiredMarkColumnToken(0)</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-{</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+    : m_flags(0), m_expiredMark(0), m_expiredMarkColumnToken(0) {</span>
<a href="#l9.173"></a><span id="l9.173">   m_mdbTable = NULL;</span>
<a href="#l9.174"></a><span id="l9.174">   m_mdbRow = NULL;</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-  m_version = 1; // for upgrading...</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineminus">-  m_IMAPHierarchySeparator = 0; // imap path separator</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+  m_version = 1;                 // for upgrading...</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineplus">+  m_IMAPHierarchySeparator = 0;  // imap path separator</span>
<a href="#l9.179"></a><span id="l9.179">   // mail only (for now)</span>
<a href="#l9.180"></a><span id="l9.180">   m_folderSize = 0;</span>
<a href="#l9.181"></a><span id="l9.181">   m_folderDate = 0;</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineminus">-  m_expungedBytes = 0; // sum of size of deleted messages in folder</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineplus">+  m_expungedBytes = 0;  // sum of size of deleted messages in folder</span>
<a href="#l9.184"></a><span id="l9.184">   m_highWaterMessageKey = 0;</span>
<a href="#l9.185"></a><span id="l9.185"> </span>
<a href="#l9.186"></a><span id="l9.186">   m_numUnreadMessages = 0;</span>
<a href="#l9.187"></a><span id="l9.187">   m_numMessages = 0;</span>
<a href="#l9.188"></a><span id="l9.188">   // IMAP only</span>
<a href="#l9.189"></a><span id="l9.189">   m_ImapUidValidity = kUidUnknown;</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-  m_totalPendingMessages =0;</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineplus">+  m_totalPendingMessages = 0;</span>
<a href="#l9.192"></a><span id="l9.192">   m_unreadPendingMessages = 0;</span>
<a href="#l9.193"></a><span id="l9.193"> </span>
<a href="#l9.194"></a><span id="l9.194">   m_mdbTokensInitialized = false;</span>
<a href="#l9.195"></a><span id="l9.195">   m_charSetOverride = false;</span>
<a href="#l9.196"></a><span id="l9.196"> </span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-  if (!gFolderCharsetObserver)</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineminus">-  {</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+  if (!gFolderCharsetObserver) {</span>
<a href="#l9.200"></a><span id="l9.200">     nsresult rv;</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">-    nsCOMPtr&lt;nsIPrefService&gt; prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineplus">+    nsCOMPtr&lt;nsIPrefService&gt; prefs =</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.204"></a><span id="l9.204">     nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineminus">-    {</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.208"></a><span id="l9.208">       rv = prefs-&gt;GetBranch(nullptr, getter_AddRefs(prefBranch));</span>
<a href="#l9.209"></a><span id="l9.209">     }</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-    {</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.213"></a><span id="l9.213">       nsCOMPtr&lt;nsIPrefLocalizedString&gt; pls;</span>
<a href="#l9.214"></a><span id="l9.214">       rv = prefBranch-&gt;GetComplexValue(kMAILNEWS_VIEW_DEFAULT_CHARSET,</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineminus">-        NS_GET_IID(nsIPrefLocalizedString), getter_AddRefs(pls));</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineminus">-      {</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineplus">+                                       NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineplus">+                                       getter_AddRefs(pls));</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.221"></a><span id="l9.221">         nsString ucsval;</span>
<a href="#l9.222"></a><span id="l9.222">         pls-&gt;ToString(getter_Copies(ucsval));</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineminus">-        if (!ucsval.IsEmpty())</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineminus">-        {</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineminus">-          if (!gDefaultCharacterSet)</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineminus">-            gDefaultCharacterSet = new nsCString;</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineplus">+        if (!ucsval.IsEmpty()) {</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineplus">+          if (!gDefaultCharacterSet) gDefaultCharacterSet = new nsCString;</span>
<a href="#l9.229"></a><span id="l9.229"> </span>
<a href="#l9.230"></a><span id="l9.230">           if (gDefaultCharacterSet)</span>
<a href="#l9.231"></a><span id="l9.231">             CopyUTF16toUTF8(ucsval, *gDefaultCharacterSet);</span>
<a href="#l9.232"></a><span id="l9.232">         }</span>
<a href="#l9.233"></a><span id="l9.233">       }</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineminus">-      rv = prefBranch-&gt;GetBoolPref(kMAILNEWS_DEFAULT_CHARSET_OVERRIDE, &amp;gDefaultCharacterOverride);</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineplus">+      rv = prefBranch-&gt;GetBoolPref(kMAILNEWS_DEFAULT_CHARSET_OVERRIDE,</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineplus">+                                   &amp;gDefaultCharacterOverride);</span>
<a href="#l9.237"></a><span id="l9.237"> </span>
<a href="#l9.238"></a><span id="l9.238">       gFolderCharsetObserver = new nsFolderCharsetObserver();</span>
<a href="#l9.239"></a><span id="l9.239">       NS_ASSERTION(gFolderCharsetObserver, &quot;failed to create observer&quot;);</span>
<a href="#l9.240"></a><span id="l9.240"> </span>
<a href="#l9.241"></a><span id="l9.241">       // register prefs callbacks</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineminus">-      if (gFolderCharsetObserver)</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineminus">-      {</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineminus">-        rv = prefBranch-&gt;AddObserver(kMAILNEWS_VIEW_DEFAULT_CHARSET, gFolderCharsetObserver, false);</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineminus">-        rv = prefBranch-&gt;AddObserver(kMAILNEWS_DEFAULT_CHARSET_OVERRIDE, gFolderCharsetObserver, false);</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineplus">+      if (gFolderCharsetObserver) {</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+        rv = prefBranch-&gt;AddObserver(kMAILNEWS_VIEW_DEFAULT_CHARSET,</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineplus">+                                     gFolderCharsetObserver, false);</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineplus">+        rv = prefBranch-&gt;AddObserver(kMAILNEWS_DEFAULT_CHARSET_OVERRIDE,</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineplus">+                                     gFolderCharsetObserver, false);</span>
<a href="#l9.251"></a><span id="l9.251"> </span>
<a href="#l9.252"></a><span id="l9.252">         // also register for shutdown</span>
<a href="#l9.253"></a><span id="l9.253">         nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineminus">-          mozilla::services::GetObserverService();</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineminus">-        if (observerService)</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineminus">-        {</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineminus">-          rv = observerService-&gt;AddObserver(gFolderCharsetObserver, NS_XPCOM_SHUTDOWN_OBSERVER_ID, false);</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineplus">+            mozilla::services::GetObserverService();</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineplus">+        if (observerService) {</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineplus">+          rv = observerService-&gt;AddObserver(</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineplus">+              gFolderCharsetObserver, NS_XPCOM_SHUTDOWN_OBSERVER_ID, false);</span>
<a href="#l9.262"></a><span id="l9.262">         }</span>
<a href="#l9.263"></a><span id="l9.263">       }</span>
<a href="#l9.264"></a><span id="l9.264">     }</span>
<a href="#l9.265"></a><span id="l9.265">   }</span>
<a href="#l9.266"></a><span id="l9.266"> </span>
<a href="#l9.267"></a><span id="l9.267">   m_mdb = mdb;</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineminus">-  if (mdb)</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineminus">-  {</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+  if (mdb) {</span>
<a href="#l9.271"></a><span id="l9.271">     nsresult err;</span>
<a href="#l9.272"></a><span id="l9.272"> </span>
<a href="#l9.273"></a><span id="l9.273" class="difflineminus">-    err = m_mdb-&gt;GetStore()-&gt;StringToToken(mdb-&gt;GetEnv(), kDBFolderInfoScope, &amp;m_rowScopeToken);</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineminus">-    {</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineminus">-      err = m_mdb-&gt;GetStore()-&gt;StringToToken(mdb-&gt;GetEnv(), kDBFolderInfoTableKind, &amp;m_tableKindToken);</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineminus">-      if (NS_SUCCEEDED(err))</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineminus">-      {</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineplus">+    err = m_mdb-&gt;GetStore()-&gt;StringToToken(mdb-&gt;GetEnv(), kDBFolderInfoScope,</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineplus">+                                           &amp;m_rowScopeToken);</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineplus">+    if (NS_SUCCEEDED(err)) {</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineplus">+      err = m_mdb-&gt;GetStore()-&gt;StringToToken(</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineplus">+          mdb-&gt;GetEnv(), kDBFolderInfoTableKind, &amp;m_tableKindToken);</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineplus">+      if (NS_SUCCEEDED(err)) {</span>
<a href="#l9.285"></a><span id="l9.285">         gDBFolderInfoOID.mOid_Scope = m_rowScopeToken;</span>
<a href="#l9.286"></a><span id="l9.286">         gDBFolderInfoOID.mOid_Id = 1;</span>
<a href="#l9.287"></a><span id="l9.287">       }</span>
<a href="#l9.288"></a><span id="l9.288">     }</span>
<a href="#l9.289"></a><span id="l9.289">     InitMDBInfo();</span>
<a href="#l9.290"></a><span id="l9.290">   }</span>
<a href="#l9.291"></a><span id="l9.291"> }</span>
<a href="#l9.292"></a><span id="l9.292"> </span>
<a href="#l9.293"></a><span id="l9.293" class="difflineminus">-nsDBFolderInfo::~nsDBFolderInfo()</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineminus">-{</span>
<a href="#l9.295"></a><span id="l9.295" class="difflineplus">+nsDBFolderInfo::~nsDBFolderInfo() {</span>
<a href="#l9.296"></a><span id="l9.296">   // nsMsgDatabase strictly owns nsDBFolderInfo, so don't ref-count db.</span>
<a href="#l9.297"></a><span id="l9.297">   ReleaseExternalReferences();</span>
<a href="#l9.298"></a><span id="l9.298"> }</span>
<a href="#l9.299"></a><span id="l9.299"> </span>
<a href="#l9.300"></a><span id="l9.300"> // Release any objects we're holding onto. This needs to be safe</span>
<a href="#l9.301"></a><span id="l9.301"> // to call multiple times.</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineminus">-void nsDBFolderInfo::ReleaseExternalReferences()</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineminus">-{</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineminus">-  if (m_mdb)</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineminus">-  {</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineminus">-    if (m_mdbTable)</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineminus">-    {</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineplus">+void nsDBFolderInfo::ReleaseExternalReferences() {</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineplus">+  if (m_mdb) {</span>
<a href="#l9.310"></a><span id="l9.310" class="difflineplus">+    if (m_mdbTable) {</span>
<a href="#l9.311"></a><span id="l9.311">       NS_RELEASE(m_mdbTable);</span>
<a href="#l9.312"></a><span id="l9.312">       m_mdbTable = nullptr;</span>
<a href="#l9.313"></a><span id="l9.313">     }</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineminus">-    if (m_mdbRow)</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineminus">-    {</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineplus">+    if (m_mdbRow) {</span>
<a href="#l9.317"></a><span id="l9.317">       NS_RELEASE(m_mdbRow);</span>
<a href="#l9.318"></a><span id="l9.318">       m_mdbRow = nullptr;</span>
<a href="#l9.319"></a><span id="l9.319">     }</span>
<a href="#l9.320"></a><span id="l9.320">     m_mdb = nullptr;</span>
<a href="#l9.321"></a><span id="l9.321">   }</span>
<a href="#l9.322"></a><span id="l9.322"> }</span>
<a href="#l9.323"></a><span id="l9.323"> </span>
<a href="#l9.324"></a><span id="l9.324"> // this routine sets up a new db to know about the dbFolderInfo stuff...</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineminus">-nsresult nsDBFolderInfo::AddToNewMDB()</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineminus">-{</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineplus">+nsresult nsDBFolderInfo::AddToNewMDB() {</span>
<a href="#l9.328"></a><span id="l9.328">   nsresult ret = NS_OK;</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineminus">-  if (m_mdb &amp;&amp; m_mdb-&gt;GetStore())</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineminus">-  {</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineplus">+  if (m_mdb &amp;&amp; m_mdb-&gt;GetStore()) {</span>
<a href="#l9.332"></a><span id="l9.332">     nsIMdbStore *store = m_mdb-&gt;GetStore();</span>
<a href="#l9.333"></a><span id="l9.333">     // create the unique table for the dbFolderInfo.</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineminus">-    nsresult err = store-&gt;NewTable(m_mdb-&gt;GetEnv(), m_rowScopeToken,</span>
<a href="#l9.335"></a><span id="l9.335" class="difflineminus">-      m_tableKindToken, true, nullptr, &amp;m_mdbTable);</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineplus">+    nsresult err =</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineplus">+        store-&gt;NewTable(m_mdb-&gt;GetEnv(), m_rowScopeToken, m_tableKindToken,</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineplus">+                        true, nullptr, &amp;m_mdbTable);</span>
<a href="#l9.339"></a><span id="l9.339"> </span>
<a href="#l9.340"></a><span id="l9.340">     // create the singleton row for the dbFolderInfo.</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineminus">-    err  = store-&gt;NewRowWithOid(m_mdb-&gt;GetEnv(),</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineminus">-      &amp;gDBFolderInfoOID, &amp;m_mdbRow);</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineplus">+    err = store-&gt;NewRowWithOid(m_mdb-&gt;GetEnv(), &amp;gDBFolderInfoOID, &amp;m_mdbRow);</span>
<a href="#l9.344"></a><span id="l9.344"> </span>
<a href="#l9.345"></a><span id="l9.345">     // add the row to the singleton table.</span>
<a href="#l9.346"></a><span id="l9.346">     if (m_mdbRow &amp;&amp; NS_SUCCEEDED(err))</span>
<a href="#l9.347"></a><span id="l9.347">       err = m_mdbTable-&gt;AddRow(m_mdb-&gt;GetEnv(), m_mdbRow);</span>
<a href="#l9.348"></a><span id="l9.348"> </span>
<a href="#l9.349"></a><span id="l9.349">     ret = err;  // what are we going to do about nsresult's?</span>
<a href="#l9.350"></a><span id="l9.350">   }</span>
<a href="#l9.351"></a><span id="l9.351">   return ret;</span>
<a href="#l9.352"></a><span id="l9.352"> }</span>
<a href="#l9.353"></a><span id="l9.353"> </span>
<a href="#l9.354"></a><span id="l9.354" class="difflineminus">-nsresult nsDBFolderInfo::InitFromExistingDB()</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineminus">-{</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineplus">+nsresult nsDBFolderInfo::InitFromExistingDB() {</span>
<a href="#l9.357"></a><span id="l9.357">   nsresult ret = NS_OK;</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineminus">-  if (m_mdb &amp;&amp; m_mdb-&gt;GetStore())</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineminus">-  {</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineplus">+  if (m_mdb &amp;&amp; m_mdb-&gt;GetStore()) {</span>
<a href="#l9.361"></a><span id="l9.361">     nsIMdbStore *store = m_mdb-&gt;GetStore();</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineminus">-    if (store)</span>
<a href="#l9.363"></a><span id="l9.363" class="difflineminus">-    {</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineplus">+    if (store) {</span>
<a href="#l9.365"></a><span id="l9.365">       mdb_pos rowPos;</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineminus">-      mdb_count outTableCount; // current number of such tables</span>
<a href="#l9.367"></a><span id="l9.367" class="difflineminus">-      mdb_bool mustBeUnique; // whether port can hold only one of these</span>
<a href="#l9.368"></a><span id="l9.368" class="difflineplus">+      mdb_count outTableCount;  // current number of such tables</span>
<a href="#l9.369"></a><span id="l9.369" class="difflineplus">+      mdb_bool mustBeUnique;    // whether port can hold only one of these</span>
<a href="#l9.370"></a><span id="l9.370">       mdb_bool hasOid;</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineminus">-      ret = store-&gt;GetTableKind(m_mdb-&gt;GetEnv(), m_rowScopeToken, m_tableKindToken, &amp;outTableCount,</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineminus">-        &amp;mustBeUnique, &amp;m_mdbTable);</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineminus">-      // NS_ASSERTION(mustBeUnique &amp;&amp; outTableCount == 1, &quot;only one global db info allowed&quot;);</span>
<a href="#l9.374"></a><span id="l9.374" class="difflineplus">+      ret = store-&gt;GetTableKind(m_mdb-&gt;GetEnv(), m_rowScopeToken,</span>
<a href="#l9.375"></a><span id="l9.375" class="difflineplus">+                                m_tableKindToken, &amp;outTableCount, &amp;mustBeUnique,</span>
<a href="#l9.376"></a><span id="l9.376" class="difflineplus">+                                &amp;m_mdbTable);</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineplus">+      // NS_ASSERTION(mustBeUnique &amp;&amp; outTableCount == 1, &quot;only one global db</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineplus">+      // info allowed&quot;);</span>
<a href="#l9.379"></a><span id="l9.379"> </span>
<a href="#l9.380"></a><span id="l9.380" class="difflineminus">-      if (m_mdbTable)</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineminus">-      {</span>
<a href="#l9.382"></a><span id="l9.382" class="difflineplus">+      if (m_mdbTable) {</span>
<a href="#l9.383"></a><span id="l9.383">         // find singleton row for global info.</span>
<a href="#l9.384"></a><span id="l9.384">         ret = m_mdbTable-&gt;HasOid(m_mdb-&gt;GetEnv(), &amp;gDBFolderInfoOID, &amp;hasOid);</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineminus">-        if (NS_SUCCEEDED(ret))</span>
<a href="#l9.386"></a><span id="l9.386" class="difflineminus">-        {</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineplus">+        if (NS_SUCCEEDED(ret)) {</span>
<a href="#l9.388"></a><span id="l9.388">           nsIMdbTableRowCursor *rowCursor;</span>
<a href="#l9.389"></a><span id="l9.389">           rowPos = -1;</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineminus">-          ret= m_mdbTable-&gt;GetTableRowCursor(m_mdb-&gt;GetEnv(), rowPos, &amp;rowCursor);</span>
<a href="#l9.391"></a><span id="l9.391" class="difflineminus">-          if (NS_SUCCEEDED(ret))</span>
<a href="#l9.392"></a><span id="l9.392" class="difflineminus">-          {</span>
<a href="#l9.393"></a><span id="l9.393" class="difflineplus">+          ret = m_mdbTable-&gt;GetTableRowCursor(m_mdb-&gt;GetEnv(), rowPos,</span>
<a href="#l9.394"></a><span id="l9.394" class="difflineplus">+                                              &amp;rowCursor);</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineplus">+          if (NS_SUCCEEDED(ret)) {</span>
<a href="#l9.396"></a><span id="l9.396">             ret = rowCursor-&gt;NextRow(m_mdb-&gt;GetEnv(), &amp;m_mdbRow, &amp;rowPos);</span>
<a href="#l9.397"></a><span id="l9.397">             NS_RELEASE(rowCursor);</span>
<a href="#l9.398"></a><span id="l9.398" class="difflineminus">-            if (!m_mdbRow)</span>
<a href="#l9.399"></a><span id="l9.399" class="difflineminus">-              ret = NS_ERROR_FAILURE;</span>
<a href="#l9.400"></a><span id="l9.400" class="difflineminus">-            if (NS_SUCCEEDED(ret))</span>
<a href="#l9.401"></a><span id="l9.401" class="difflineminus">-              LoadMemberVariables();</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineplus">+            if (!m_mdbRow) ret = NS_ERROR_FAILURE;</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineplus">+            if (NS_SUCCEEDED(ret)) LoadMemberVariables();</span>
<a href="#l9.404"></a><span id="l9.404">           }</span>
<a href="#l9.405"></a><span id="l9.405">         }</span>
<a href="#l9.406"></a><span id="l9.406" class="difflineminus">-      }</span>
<a href="#l9.407"></a><span id="l9.407" class="difflineminus">-      else</span>
<a href="#l9.408"></a><span id="l9.408" class="difflineplus">+      } else</span>
<a href="#l9.409"></a><span id="l9.409">         ret = NS_ERROR_FAILURE;</span>
<a href="#l9.410"></a><span id="l9.410">     }</span>
<a href="#l9.411"></a><span id="l9.411">   }</span>
<a href="#l9.412"></a><span id="l9.412">   return ret;</span>
<a href="#l9.413"></a><span id="l9.413"> }</span>
<a href="#l9.414"></a><span id="l9.414"> </span>
<a href="#l9.415"></a><span id="l9.415" class="difflineminus">-nsresult nsDBFolderInfo::InitMDBInfo()</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineminus">-{</span>
<a href="#l9.417"></a><span id="l9.417" class="difflineplus">+nsresult nsDBFolderInfo::InitMDBInfo() {</span>
<a href="#l9.418"></a><span id="l9.418">   nsresult ret = NS_OK;</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineminus">-  if (!m_mdbTokensInitialized &amp;&amp; m_mdb &amp;&amp; m_mdb-&gt;GetStore())</span>
<a href="#l9.420"></a><span id="l9.420" class="difflineminus">-  {</span>
<a href="#l9.421"></a><span id="l9.421" class="difflineplus">+  if (!m_mdbTokensInitialized &amp;&amp; m_mdb &amp;&amp; m_mdb-&gt;GetStore()) {</span>
<a href="#l9.422"></a><span id="l9.422">     nsIMdbStore *store = m_mdb-&gt;GetStore();</span>
<a href="#l9.423"></a><span id="l9.423">     nsIMdbEnv *env = m_mdb-&gt;GetEnv();</span>
<a href="#l9.424"></a><span id="l9.424"> </span>
<a href="#l9.425"></a><span id="l9.425" class="difflineminus">-    store-&gt;StringToToken(env,  kNumMessagesColumnName, &amp;m_numMessagesColumnToken);</span>
<a href="#l9.426"></a><span id="l9.426" class="difflineminus">-    store-&gt;StringToToken(env,  kNumUnreadMessagesColumnName, &amp;m_numUnreadMessagesColumnToken);</span>
<a href="#l9.427"></a><span id="l9.427" class="difflineminus">-    store-&gt;StringToToken(env,  kFlagsColumnName, &amp;m_flagsColumnToken);</span>
<a href="#l9.428"></a><span id="l9.428" class="difflineminus">-    store-&gt;StringToToken(env,  kFolderSizeColumnName, &amp;m_folderSizeColumnToken);</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineminus">-    store-&gt;StringToToken(env,  kExpungedBytesColumnName, &amp;m_expungedBytesColumnToken);</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineminus">-    store-&gt;StringToToken(env,  kFolderDateColumnName, &amp;m_folderDateColumnToken);</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineplus">+    store-&gt;StringToToken(env, kNumMessagesColumnName,</span>
<a href="#l9.432"></a><span id="l9.432" class="difflineplus">+                         &amp;m_numMessagesColumnToken);</span>
<a href="#l9.433"></a><span id="l9.433" class="difflineplus">+    store-&gt;StringToToken(env, kNumUnreadMessagesColumnName,</span>
<a href="#l9.434"></a><span id="l9.434" class="difflineplus">+                         &amp;m_numUnreadMessagesColumnToken);</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineplus">+    store-&gt;StringToToken(env, kFlagsColumnName, &amp;m_flagsColumnToken);</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineplus">+    store-&gt;StringToToken(env, kFolderSizeColumnName, &amp;m_folderSizeColumnToken);</span>
<a href="#l9.437"></a><span id="l9.437" class="difflineplus">+    store-&gt;StringToToken(env, kExpungedBytesColumnName,</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineplus">+                         &amp;m_expungedBytesColumnToken);</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineplus">+    store-&gt;StringToToken(env, kFolderDateColumnName, &amp;m_folderDateColumnToken);</span>
<a href="#l9.440"></a><span id="l9.440"> </span>
<a href="#l9.441"></a><span id="l9.441" class="difflineminus">-    store-&gt;StringToToken(env,  kHighWaterMessageKeyColumnName, &amp;m_highWaterMessageKeyColumnToken);</span>
<a href="#l9.442"></a><span id="l9.442" class="difflineminus">-    store-&gt;StringToToken(env,  kMailboxNameColumnName, &amp;m_mailboxNameColumnToken);</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineplus">+    store-&gt;StringToToken(env, kHighWaterMessageKeyColumnName,</span>
<a href="#l9.444"></a><span id="l9.444" class="difflineplus">+                         &amp;m_highWaterMessageKeyColumnToken);</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineplus">+    store-&gt;StringToToken(env, kMailboxNameColumnName,</span>
<a href="#l9.446"></a><span id="l9.446" class="difflineplus">+                         &amp;m_mailboxNameColumnToken);</span>
<a href="#l9.447"></a><span id="l9.447"> </span>
<a href="#l9.448"></a><span id="l9.448" class="difflineminus">-    store-&gt;StringToToken(env,  kImapUidValidityColumnName, &amp;m_imapUidValidityColumnToken);</span>
<a href="#l9.449"></a><span id="l9.449" class="difflineminus">-    store-&gt;StringToToken(env,  kTotalPendingMessagesColumnName, &amp;m_totalPendingMessagesColumnToken);</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineminus">-    store-&gt;StringToToken(env,  kUnreadPendingMessagesColumnName, &amp;m_unreadPendingMessagesColumnToken);</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineminus">-    store-&gt;StringToToken(env,  kExpiredMarkColumnName, &amp;m_expiredMarkColumnToken);</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineminus">-    store-&gt;StringToToken(env,  kVersionColumnName, &amp;m_versionColumnToken);</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineminus">-    m_mdbTokensInitialized  = true;</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineplus">+    store-&gt;StringToToken(env, kImapUidValidityColumnName,</span>
<a href="#l9.455"></a><span id="l9.455" class="difflineplus">+                         &amp;m_imapUidValidityColumnToken);</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineplus">+    store-&gt;StringToToken(env, kTotalPendingMessagesColumnName,</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineplus">+                         &amp;m_totalPendingMessagesColumnToken);</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineplus">+    store-&gt;StringToToken(env, kUnreadPendingMessagesColumnName,</span>
<a href="#l9.459"></a><span id="l9.459" class="difflineplus">+                         &amp;m_unreadPendingMessagesColumnToken);</span>
<a href="#l9.460"></a><span id="l9.460" class="difflineplus">+    store-&gt;StringToToken(env, kExpiredMarkColumnName,</span>
<a href="#l9.461"></a><span id="l9.461" class="difflineplus">+                         &amp;m_expiredMarkColumnToken);</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineplus">+    store-&gt;StringToToken(env, kVersionColumnName, &amp;m_versionColumnToken);</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineplus">+    m_mdbTokensInitialized = true;</span>
<a href="#l9.464"></a><span id="l9.464">   }</span>
<a href="#l9.465"></a><span id="l9.465"> </span>
<a href="#l9.466"></a><span id="l9.466">   return ret;</span>
<a href="#l9.467"></a><span id="l9.467"> }</span>
<a href="#l9.468"></a><span id="l9.468"> </span>
<a href="#l9.469"></a><span id="l9.469" class="difflineminus">-nsresult nsDBFolderInfo::LoadMemberVariables()</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineminus">-{</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineplus">+nsresult nsDBFolderInfo::LoadMemberVariables() {</span>
<a href="#l9.472"></a><span id="l9.472">   // it's really not an error for these properties to not exist...</span>
<a href="#l9.473"></a><span id="l9.473">   GetInt32PropertyWithToken(m_numMessagesColumnToken, m_numMessages);</span>
<a href="#l9.474"></a><span id="l9.474" class="difflineminus">-  GetInt32PropertyWithToken(m_numUnreadMessagesColumnToken, m_numUnreadMessages);</span>
<a href="#l9.475"></a><span id="l9.475" class="difflineplus">+  GetInt32PropertyWithToken(m_numUnreadMessagesColumnToken,</span>
<a href="#l9.476"></a><span id="l9.476" class="difflineplus">+                            m_numUnreadMessages);</span>
<a href="#l9.477"></a><span id="l9.477">   GetInt32PropertyWithToken(m_flagsColumnToken, m_flags);</span>
<a href="#l9.478"></a><span id="l9.478">   GetInt64PropertyWithToken(m_folderSizeColumnToken, m_folderSize);</span>
<a href="#l9.479"></a><span id="l9.479">   GetUint32PropertyWithToken(m_folderDateColumnToken, m_folderDate);</span>
<a href="#l9.480"></a><span id="l9.480" class="difflineminus">-  GetInt32PropertyWithToken(m_imapUidValidityColumnToken, m_ImapUidValidity, kUidUnknown);</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineplus">+  GetInt32PropertyWithToken(m_imapUidValidityColumnToken, m_ImapUidValidity,</span>
<a href="#l9.482"></a><span id="l9.482" class="difflineplus">+                            kUidUnknown);</span>
<a href="#l9.483"></a><span id="l9.483">   GetUint32PropertyWithToken(m_expiredMarkColumnToken, m_expiredMark);</span>
<a href="#l9.484"></a><span id="l9.484">   GetInt64PropertyWithToken(m_expungedBytesColumnToken, m_expungedBytes);</span>
<a href="#l9.485"></a><span id="l9.485" class="difflineminus">-  GetUint32PropertyWithToken(m_highWaterMessageKeyColumnToken, m_highWaterMessageKey);</span>
<a href="#l9.486"></a><span id="l9.486" class="difflineplus">+  GetUint32PropertyWithToken(m_highWaterMessageKeyColumnToken,</span>
<a href="#l9.487"></a><span id="l9.487" class="difflineplus">+                             m_highWaterMessageKey);</span>
<a href="#l9.488"></a><span id="l9.488">   int32_t version;</span>
<a href="#l9.489"></a><span id="l9.489"> </span>
<a href="#l9.490"></a><span id="l9.490">   GetInt32PropertyWithToken(m_versionColumnToken, version);</span>
<a href="#l9.491"></a><span id="l9.491" class="difflineminus">-  m_version = (uint16_t) version;</span>
<a href="#l9.492"></a><span id="l9.492" class="difflineplus">+  m_version = (uint16_t)version;</span>
<a href="#l9.493"></a><span id="l9.493">   m_charSetOverride = gDefaultCharacterOverride;</span>
<a href="#l9.494"></a><span id="l9.494">   uint32_t propertyValue;</span>
<a href="#l9.495"></a><span id="l9.495" class="difflineminus">-  nsresult rv = GetUint32Property(kCharacterSetOverrideColumnName, gDefaultCharacterOverride, &amp;propertyValue);</span>
<a href="#l9.496"></a><span id="l9.496" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l9.497"></a><span id="l9.497" class="difflineminus">-    m_charSetOverride = propertyValue;</span>
<a href="#l9.498"></a><span id="l9.498" class="difflineplus">+  nsresult rv = GetUint32Property(kCharacterSetOverrideColumnName,</span>
<a href="#l9.499"></a><span id="l9.499" class="difflineplus">+                                  gDefaultCharacterOverride, &amp;propertyValue);</span>
<a href="#l9.500"></a><span id="l9.500" class="difflineplus">+  if (NS_SUCCEEDED(rv)) m_charSetOverride = propertyValue;</span>
<a href="#l9.501"></a><span id="l9.501"> </span>
<a href="#l9.502"></a><span id="l9.502" class="difflineminus">-  m_mdb-&gt;GetProperty(m_mdbRow, kCharacterSetColumnName, getter_Copies(m_charSet));</span>
<a href="#l9.503"></a><span id="l9.503" class="difflineplus">+  m_mdb-&gt;GetProperty(m_mdbRow, kCharacterSetColumnName,</span>
<a href="#l9.504"></a><span id="l9.504" class="difflineplus">+                     getter_Copies(m_charSet));</span>
<a href="#l9.505"></a><span id="l9.505">   return NS_OK;</span>
<a href="#l9.506"></a><span id="l9.506"> }</span>
<a href="#l9.507"></a><span id="l9.507"> </span>
<a href="#l9.508"></a><span id="l9.508" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetVersion(uint32_t version)</span>
<a href="#l9.509"></a><span id="l9.509" class="difflineminus">-{</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetVersion(uint32_t version) {</span>
<a href="#l9.511"></a><span id="l9.511">   m_version = version;</span>
<a href="#l9.512"></a><span id="l9.512" class="difflineminus">-  return SetUint32PropertyWithToken(m_versionColumnToken, (uint32_t) m_version);</span>
<a href="#l9.513"></a><span id="l9.513" class="difflineplus">+  return SetUint32PropertyWithToken(m_versionColumnToken, (uint32_t)m_version);</span>
<a href="#l9.514"></a><span id="l9.514"> }</span>
<a href="#l9.515"></a><span id="l9.515"> </span>
<a href="#l9.516"></a><span id="l9.516" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetVersion(uint32_t *version)</span>
<a href="#l9.517"></a><span id="l9.517" class="difflineminus">-{</span>
<a href="#l9.518"></a><span id="l9.518" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetVersion(uint32_t *version) {</span>
<a href="#l9.519"></a><span id="l9.519">   *version = m_version;</span>
<a href="#l9.520"></a><span id="l9.520">   return NS_OK;</span>
<a href="#l9.521"></a><span id="l9.521"> }</span>
<a href="#l9.522"></a><span id="l9.522"> </span>
<a href="#l9.523"></a><span id="l9.523" class="difflineminus">-</span>
<a href="#l9.524"></a><span id="l9.524" class="difflineminus">-nsresult nsDBFolderInfo::AdjustHighWater(nsMsgKey highWater, bool force)</span>
<a href="#l9.525"></a><span id="l9.525" class="difflineminus">-{</span>
<a href="#l9.526"></a><span id="l9.526" class="difflineminus">-  if (force || m_highWaterMessageKey &lt; highWater)</span>
<a href="#l9.527"></a><span id="l9.527" class="difflineminus">-  {</span>
<a href="#l9.528"></a><span id="l9.528" class="difflineplus">+nsresult nsDBFolderInfo::AdjustHighWater(nsMsgKey highWater, bool force) {</span>
<a href="#l9.529"></a><span id="l9.529" class="difflineplus">+  if (force || m_highWaterMessageKey &lt; highWater) {</span>
<a href="#l9.530"></a><span id="l9.530">     m_highWaterMessageKey = highWater;</span>
<a href="#l9.531"></a><span id="l9.531">     SetUint32PropertyWithToken(m_highWaterMessageKeyColumnToken, highWater);</span>
<a href="#l9.532"></a><span id="l9.532">   }</span>
<a href="#l9.533"></a><span id="l9.533"> </span>
<a href="#l9.534"></a><span id="l9.534">   return NS_OK;</span>
<a href="#l9.535"></a><span id="l9.535"> }</span>
<a href="#l9.536"></a><span id="l9.536"> </span>
<a href="#l9.537"></a><span id="l9.537" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetHighWater(nsMsgKey highWater)</span>
<a href="#l9.538"></a><span id="l9.538" class="difflineminus">-{</span>
<a href="#l9.539"></a><span id="l9.539" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetHighWater(nsMsgKey highWater) {</span>
<a href="#l9.540"></a><span id="l9.540">   return AdjustHighWater(highWater, true);</span>
<a href="#l9.541"></a><span id="l9.541"> }</span>
<a href="#l9.542"></a><span id="l9.542"> </span>
<a href="#l9.543"></a><span id="l9.543" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::OnKeyAdded(nsMsgKey aNewKey)</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineminus">-{</span>
<a href="#l9.545"></a><span id="l9.545" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::OnKeyAdded(nsMsgKey aNewKey) {</span>
<a href="#l9.546"></a><span id="l9.546">   return AdjustHighWater(aNewKey, false);</span>
<a href="#l9.547"></a><span id="l9.547"> }</span>
<a href="#l9.548"></a><span id="l9.548"> </span>
<a href="#l9.549"></a><span id="l9.549"> NS_IMETHODIMP</span>
<a href="#l9.550"></a><span id="l9.550" class="difflineminus">-nsDBFolderInfo::GetFolderSize(int64_t *size)</span>
<a href="#l9.551"></a><span id="l9.551" class="difflineminus">-{</span>
<a href="#l9.552"></a><span id="l9.552" class="difflineplus">+nsDBFolderInfo::GetFolderSize(int64_t *size) {</span>
<a href="#l9.553"></a><span id="l9.553">   NS_ENSURE_ARG_POINTER(size);</span>
<a href="#l9.554"></a><span id="l9.554">   *size = m_folderSize;</span>
<a href="#l9.555"></a><span id="l9.555">   return NS_OK;</span>
<a href="#l9.556"></a><span id="l9.556"> }</span>
<a href="#l9.557"></a><span id="l9.557"> </span>
<a href="#l9.558"></a><span id="l9.558" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetFolderSize(int64_t size)</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineminus">-{</span>
<a href="#l9.560"></a><span id="l9.560" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetFolderSize(int64_t size) {</span>
<a href="#l9.561"></a><span id="l9.561">   m_folderSize = size;</span>
<a href="#l9.562"></a><span id="l9.562">   return SetInt64Property(kFolderSizeColumnName, m_folderSize);</span>
<a href="#l9.563"></a><span id="l9.563"> }</span>
<a href="#l9.564"></a><span id="l9.564"> </span>
<a href="#l9.565"></a><span id="l9.565"> NS_IMETHODIMP</span>
<a href="#l9.566"></a><span id="l9.566" class="difflineminus">-nsDBFolderInfo::GetFolderDate(uint32_t *folderDate)</span>
<a href="#l9.567"></a><span id="l9.567" class="difflineminus">-{</span>
<a href="#l9.568"></a><span id="l9.568" class="difflineplus">+nsDBFolderInfo::GetFolderDate(uint32_t *folderDate) {</span>
<a href="#l9.569"></a><span id="l9.569">   NS_ENSURE_ARG_POINTER(folderDate);</span>
<a href="#l9.570"></a><span id="l9.570">   *folderDate = m_folderDate;</span>
<a href="#l9.571"></a><span id="l9.571">   return NS_OK;</span>
<a href="#l9.572"></a><span id="l9.572"> }</span>
<a href="#l9.573"></a><span id="l9.573"> </span>
<a href="#l9.574"></a><span id="l9.574" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetFolderDate(uint32_t folderDate)</span>
<a href="#l9.575"></a><span id="l9.575" class="difflineminus">-{</span>
<a href="#l9.576"></a><span id="l9.576" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetFolderDate(uint32_t folderDate) {</span>
<a href="#l9.577"></a><span id="l9.577">   m_folderDate = folderDate;</span>
<a href="#l9.578"></a><span id="l9.578">   return SetUint32PropertyWithToken(m_folderDateColumnToken, folderDate);</span>
<a href="#l9.579"></a><span id="l9.579"> }</span>
<a href="#l9.580"></a><span id="l9.580"> </span>
<a href="#l9.581"></a><span id="l9.581" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetHighWater(nsMsgKey *result)</span>
<a href="#l9.582"></a><span id="l9.582" class="difflineminus">-{</span>
<a href="#l9.583"></a><span id="l9.583" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetHighWater(nsMsgKey *result) {</span>
<a href="#l9.584"></a><span id="l9.584">   // Sanity check highwater - if it gets too big, other code</span>
<a href="#l9.585"></a><span id="l9.585">   // can fail. Look through last 100 messages to recalculate</span>
<a href="#l9.586"></a><span id="l9.586">   // the highwater mark.</span>
<a href="#l9.587"></a><span id="l9.587">   *result = m_highWaterMessageKey;</span>
<a href="#l9.588"></a><span id="l9.588" class="difflineminus">-  if (m_highWaterMessageKey &gt; 0xFFFFFF00 &amp;&amp; m_mdb)</span>
<a href="#l9.589"></a><span id="l9.589" class="difflineminus">-  {</span>
<a href="#l9.590"></a><span id="l9.590" class="difflineminus">-    nsCOMPtr &lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l9.591"></a><span id="l9.591" class="difflineplus">+  if (m_highWaterMessageKey &gt; 0xFFFFFF00 &amp;&amp; m_mdb) {</span>
<a href="#l9.592"></a><span id="l9.592" class="difflineplus">+    nsCOMPtr&lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l9.593"></a><span id="l9.593">     nsresult rv = m_mdb-&gt;ReverseEnumerateMessages(getter_AddRefs(hdrs));</span>
<a href="#l9.594"></a><span id="l9.594" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l9.595"></a><span id="l9.595" class="difflineminus">-      return rv;</span>
<a href="#l9.596"></a><span id="l9.596" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.597"></a><span id="l9.597">     bool hasMore = false;</span>
<a href="#l9.598"></a><span id="l9.598">     nsCOMPtr&lt;nsIMsgDBHdr&gt; pHeader;</span>
<a href="#l9.599"></a><span id="l9.599">     nsMsgKey recalculatedHighWater = 1;</span>
<a href="#l9.600"></a><span id="l9.600">     int32_t i = 0;</span>
<a href="#l9.601"></a><span id="l9.601" class="difflineminus">-    while(i++ &lt; 100 &amp;&amp; NS_SUCCEEDED(rv = hdrs-&gt;HasMoreElements(&amp;hasMore))</span>
<a href="#l9.602"></a><span id="l9.602" class="difflineminus">-              &amp;&amp; hasMore)</span>
<a href="#l9.603"></a><span id="l9.603" class="difflineminus">-    {</span>
<a href="#l9.604"></a><span id="l9.604" class="difflineplus">+    while (i++ &lt; 100 &amp;&amp; NS_SUCCEEDED(rv = hdrs-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l9.605"></a><span id="l9.605" class="difflineplus">+           hasMore) {</span>
<a href="#l9.606"></a><span id="l9.606">       nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l9.607"></a><span id="l9.607" class="difflineminus">-      (void) hdrs-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l9.608"></a><span id="l9.608" class="difflineplus">+      (void)hdrs-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l9.609"></a><span id="l9.609">       pHeader = do_QueryInterface(supports);</span>
<a href="#l9.610"></a><span id="l9.610" class="difflineminus">-      if (pHeader)</span>
<a href="#l9.611"></a><span id="l9.611" class="difflineminus">-      {</span>
<a href="#l9.612"></a><span id="l9.612" class="difflineplus">+      if (pHeader) {</span>
<a href="#l9.613"></a><span id="l9.613">         nsMsgKey msgKey;</span>
<a href="#l9.614"></a><span id="l9.614">         pHeader-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.615"></a><span id="l9.615" class="difflineminus">-        if (msgKey &gt; recalculatedHighWater)</span>
<a href="#l9.616"></a><span id="l9.616" class="difflineminus">-          recalculatedHighWater = msgKey;</span>
<a href="#l9.617"></a><span id="l9.617" class="difflineplus">+        if (msgKey &gt; recalculatedHighWater) recalculatedHighWater = msgKey;</span>
<a href="#l9.618"></a><span id="l9.618">       }</span>
<a href="#l9.619"></a><span id="l9.619">     }</span>
<a href="#l9.620"></a><span id="l9.620">     NS_ASSERTION(m_highWaterMessageKey &gt;= recalculatedHighWater,</span>
<a href="#l9.621"></a><span id="l9.621">                  &quot;highwater incorrect&quot;);</span>
<a href="#l9.622"></a><span id="l9.622">     m_highWaterMessageKey = recalculatedHighWater;</span>
<a href="#l9.623"></a><span id="l9.623">   }</span>
<a href="#l9.624"></a><span id="l9.624">   *result = m_highWaterMessageKey;</span>
<a href="#l9.625"></a><span id="l9.625">   return NS_OK;</span>
<a href="#l9.626"></a><span id="l9.626"> }</span>
<a href="#l9.627"></a><span id="l9.627"> </span>
<a href="#l9.628"></a><span id="l9.628" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetExpiredMark(nsMsgKey expiredKey)</span>
<a href="#l9.629"></a><span id="l9.629" class="difflineminus">-{</span>
<a href="#l9.630"></a><span id="l9.630" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetExpiredMark(nsMsgKey expiredKey) {</span>
<a href="#l9.631"></a><span id="l9.631">   m_expiredMark = expiredKey;</span>
<a href="#l9.632"></a><span id="l9.632">   return SetUint32PropertyWithToken(m_expiredMarkColumnToken, expiredKey);</span>
<a href="#l9.633"></a><span id="l9.633"> }</span>
<a href="#l9.634"></a><span id="l9.634"> </span>
<a href="#l9.635"></a><span id="l9.635" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetExpiredMark(nsMsgKey *result)</span>
<a href="#l9.636"></a><span id="l9.636" class="difflineminus">-{</span>
<a href="#l9.637"></a><span id="l9.637" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetExpiredMark(nsMsgKey *result) {</span>
<a href="#l9.638"></a><span id="l9.638">   *result = m_expiredMark;</span>
<a href="#l9.639"></a><span id="l9.639">   return NS_OK;</span>
<a href="#l9.640"></a><span id="l9.640"> }</span>
<a href="#l9.641"></a><span id="l9.641"> </span>
<a href="#l9.642"></a><span id="l9.642"> // The size of the argument depends on the maximum size of a single message</span>
<a href="#l9.643"></a><span id="l9.643" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::ChangeExpungedBytes(int32_t delta)</span>
<a href="#l9.644"></a><span id="l9.644" class="difflineminus">-{</span>
<a href="#l9.645"></a><span id="l9.645" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::ChangeExpungedBytes(int32_t delta) {</span>
<a href="#l9.646"></a><span id="l9.646">   return SetExpungedBytes(m_expungedBytes + delta);</span>
<a href="#l9.647"></a><span id="l9.647"> }</span>
<a href="#l9.648"></a><span id="l9.648"> </span>
<a href="#l9.649"></a><span id="l9.649" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetMailboxName(const nsAString &amp;newBoxName)</span>
<a href="#l9.650"></a><span id="l9.650" class="difflineminus">-{</span>
<a href="#l9.651"></a><span id="l9.651" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetMailboxName(const nsAString &amp;newBoxName) {</span>
<a href="#l9.652"></a><span id="l9.652">   return SetPropertyWithToken(m_mailboxNameColumnToken, newBoxName);</span>
<a href="#l9.653"></a><span id="l9.653"> }</span>
<a href="#l9.654"></a><span id="l9.654"> </span>
<a href="#l9.655"></a><span id="l9.655" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetMailboxName(nsAString &amp;boxName)</span>
<a href="#l9.656"></a><span id="l9.656" class="difflineminus">-{</span>
<a href="#l9.657"></a><span id="l9.657" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetMailboxName(nsAString &amp;boxName) {</span>
<a href="#l9.658"></a><span id="l9.658">   return GetPropertyWithToken(m_mailboxNameColumnToken, boxName);</span>
<a href="#l9.659"></a><span id="l9.659"> }</span>
<a href="#l9.660"></a><span id="l9.660"> </span>
<a href="#l9.661"></a><span id="l9.661" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::ChangeNumUnreadMessages(int32_t delta)</span>
<a href="#l9.662"></a><span id="l9.662" class="difflineminus">-{</span>
<a href="#l9.663"></a><span id="l9.663" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::ChangeNumUnreadMessages(int32_t delta) {</span>
<a href="#l9.664"></a><span id="l9.664">   m_numUnreadMessages += delta;</span>
<a href="#l9.665"></a><span id="l9.665">   // m_numUnreadMessages can never be set to negative.</span>
<a href="#l9.666"></a><span id="l9.666" class="difflineminus">-  if (m_numUnreadMessages &lt; 0)</span>
<a href="#l9.667"></a><span id="l9.667" class="difflineminus">-  {</span>
<a href="#l9.668"></a><span id="l9.668" class="difflineplus">+  if (m_numUnreadMessages &lt; 0) {</span>
<a href="#l9.669"></a><span id="l9.669"> #ifdef DEBUG_bienvenu1</span>
<a href="#l9.670"></a><span id="l9.670" class="difflineminus">-     NS_ASSERTION(false, &quot;Hardcoded assertion&quot;);</span>
<a href="#l9.671"></a><span id="l9.671" class="difflineplus">+    NS_ASSERTION(false, &quot;Hardcoded assertion&quot;);</span>
<a href="#l9.672"></a><span id="l9.672"> #endif</span>
<a href="#l9.673"></a><span id="l9.673" class="difflineminus">-      m_numUnreadMessages = 0;</span>
<a href="#l9.674"></a><span id="l9.674" class="difflineplus">+    m_numUnreadMessages = 0;</span>
<a href="#l9.675"></a><span id="l9.675">   }</span>
<a href="#l9.676"></a><span id="l9.676" class="difflineminus">-  return SetUint32PropertyWithToken(m_numUnreadMessagesColumnToken, m_numUnreadMessages);</span>
<a href="#l9.677"></a><span id="l9.677" class="difflineplus">+  return SetUint32PropertyWithToken(m_numUnreadMessagesColumnToken,</span>
<a href="#l9.678"></a><span id="l9.678" class="difflineplus">+                                    m_numUnreadMessages);</span>
<a href="#l9.679"></a><span id="l9.679"> }</span>
<a href="#l9.680"></a><span id="l9.680"> </span>
<a href="#l9.681"></a><span id="l9.681" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::ChangeNumMessages(int32_t delta)</span>
<a href="#l9.682"></a><span id="l9.682" class="difflineminus">-{</span>
<a href="#l9.683"></a><span id="l9.683" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::ChangeNumMessages(int32_t delta) {</span>
<a href="#l9.684"></a><span id="l9.684">   m_numMessages += delta;</span>
<a href="#l9.685"></a><span id="l9.685">   // m_numMessages can never be set to negative.</span>
<a href="#l9.686"></a><span id="l9.686" class="difflineminus">-  if (m_numMessages &lt; 0)</span>
<a href="#l9.687"></a><span id="l9.687" class="difflineminus">-  {</span>
<a href="#l9.688"></a><span id="l9.688" class="difflineplus">+  if (m_numMessages &lt; 0) {</span>
<a href="#l9.689"></a><span id="l9.689"> #ifdef DEBUG_bienvenu</span>
<a href="#l9.690"></a><span id="l9.690">     NS_ASSERTION(false, &quot;num messages can't be &lt; 0&quot;);</span>
<a href="#l9.691"></a><span id="l9.691"> #endif</span>
<a href="#l9.692"></a><span id="l9.692">     m_numMessages = 0;</span>
<a href="#l9.693"></a><span id="l9.693">   }</span>
<a href="#l9.694"></a><span id="l9.694">   return SetUint32PropertyWithToken(m_numMessagesColumnToken, m_numMessages);</span>
<a href="#l9.695"></a><span id="l9.695"> }</span>
<a href="#l9.696"></a><span id="l9.696"> </span>
<a href="#l9.697"></a><span id="l9.697" class="difflineminus">-</span>
<a href="#l9.698"></a><span id="l9.698" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetNumUnreadMessages(int32_t *result)</span>
<a href="#l9.699"></a><span id="l9.699" class="difflineminus">-{</span>
<a href="#l9.700"></a><span id="l9.700" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetNumUnreadMessages(int32_t *result) {</span>
<a href="#l9.701"></a><span id="l9.701">   *result = m_numUnreadMessages;</span>
<a href="#l9.702"></a><span id="l9.702">   return NS_OK;</span>
<a href="#l9.703"></a><span id="l9.703"> }</span>
<a href="#l9.704"></a><span id="l9.704"> </span>
<a href="#l9.705"></a><span id="l9.705" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetNumUnreadMessages(int32_t numUnreadMessages)</span>
<a href="#l9.706"></a><span id="l9.706" class="difflineminus">-{</span>
<a href="#l9.707"></a><span id="l9.707" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetNumUnreadMessages(int32_t numUnreadMessages) {</span>
<a href="#l9.708"></a><span id="l9.708">   m_numUnreadMessages = numUnreadMessages;</span>
<a href="#l9.709"></a><span id="l9.709" class="difflineminus">-  return SetUint32PropertyWithToken(m_numUnreadMessagesColumnToken, m_numUnreadMessages);</span>
<a href="#l9.710"></a><span id="l9.710" class="difflineplus">+  return SetUint32PropertyWithToken(m_numUnreadMessagesColumnToken,</span>
<a href="#l9.711"></a><span id="l9.711" class="difflineplus">+                                    m_numUnreadMessages);</span>
<a href="#l9.712"></a><span id="l9.712"> }</span>
<a href="#l9.713"></a><span id="l9.713"> </span>
<a href="#l9.714"></a><span id="l9.714" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetNumMessages(int32_t *result)</span>
<a href="#l9.715"></a><span id="l9.715" class="difflineminus">-{</span>
<a href="#l9.716"></a><span id="l9.716" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetNumMessages(int32_t *result) {</span>
<a href="#l9.717"></a><span id="l9.717">   *result = m_numMessages;</span>
<a href="#l9.718"></a><span id="l9.718">   return NS_OK;</span>
<a href="#l9.719"></a><span id="l9.719"> }</span>
<a href="#l9.720"></a><span id="l9.720"> </span>
<a href="#l9.721"></a><span id="l9.721" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetNumMessages(int32_t numMessages)</span>
<a href="#l9.722"></a><span id="l9.722" class="difflineminus">-{</span>
<a href="#l9.723"></a><span id="l9.723" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetNumMessages(int32_t numMessages) {</span>
<a href="#l9.724"></a><span id="l9.724">   m_numMessages = numMessages;</span>
<a href="#l9.725"></a><span id="l9.725">   return SetUint32PropertyWithToken(m_numMessagesColumnToken, m_numMessages);</span>
<a href="#l9.726"></a><span id="l9.726"> }</span>
<a href="#l9.727"></a><span id="l9.727"> </span>
<a href="#l9.728"></a><span id="l9.728" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetExpungedBytes(int64_t *result)</span>
<a href="#l9.729"></a><span id="l9.729" class="difflineminus">-{</span>
<a href="#l9.730"></a><span id="l9.730" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetExpungedBytes(int64_t *result) {</span>
<a href="#l9.731"></a><span id="l9.731">   *result = m_expungedBytes;</span>
<a href="#l9.732"></a><span id="l9.732">   return NS_OK;</span>
<a href="#l9.733"></a><span id="l9.733"> }</span>
<a href="#l9.734"></a><span id="l9.734"> </span>
<a href="#l9.735"></a><span id="l9.735" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetExpungedBytes(int64_t expungedBytes)</span>
<a href="#l9.736"></a><span id="l9.736" class="difflineminus">-{</span>
<a href="#l9.737"></a><span id="l9.737" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetExpungedBytes(int64_t expungedBytes) {</span>
<a href="#l9.738"></a><span id="l9.738">   m_expungedBytes = expungedBytes;</span>
<a href="#l9.739"></a><span id="l9.739">   return SetInt64PropertyWithToken(m_expungedBytesColumnToken, m_expungedBytes);</span>
<a href="#l9.740"></a><span id="l9.740"> }</span>
<a href="#l9.741"></a><span id="l9.741"> </span>
<a href="#l9.742"></a><span id="l9.742" class="difflineminus">-</span>
<a href="#l9.743"></a><span id="l9.743" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetFlags(int32_t *result)</span>
<a href="#l9.744"></a><span id="l9.744" class="difflineminus">-{</span>
<a href="#l9.745"></a><span id="l9.745" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetFlags(int32_t *result) {</span>
<a href="#l9.746"></a><span id="l9.746">   *result = m_flags;</span>
<a href="#l9.747"></a><span id="l9.747">   return NS_OK;</span>
<a href="#l9.748"></a><span id="l9.748"> }</span>
<a href="#l9.749"></a><span id="l9.749"> </span>
<a href="#l9.750"></a><span id="l9.750" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetFlags(int32_t flags)</span>
<a href="#l9.751"></a><span id="l9.751" class="difflineminus">-{</span>
<a href="#l9.752"></a><span id="l9.752" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetFlags(int32_t flags) {</span>
<a href="#l9.753"></a><span id="l9.753">   nsresult ret = NS_OK;</span>
<a href="#l9.754"></a><span id="l9.754"> </span>
<a href="#l9.755"></a><span id="l9.755" class="difflineminus">-  if (m_flags != flags)</span>
<a href="#l9.756"></a><span id="l9.756" class="difflineminus">-  {</span>
<a href="#l9.757"></a><span id="l9.757" class="difflineminus">-    NS_ASSERTION((m_flags &amp; nsMsgFolderFlags::Inbox) == 0 || (flags &amp; nsMsgFolderFlags::Inbox) != 0, &quot;lost inbox flag&quot;);</span>
<a href="#l9.758"></a><span id="l9.758" class="difflineplus">+  if (m_flags != flags) {</span>
<a href="#l9.759"></a><span id="l9.759" class="difflineplus">+    NS_ASSERTION((m_flags &amp; nsMsgFolderFlags::Inbox) == 0 ||</span>
<a href="#l9.760"></a><span id="l9.760" class="difflineplus">+                     (flags &amp; nsMsgFolderFlags::Inbox) != 0,</span>
<a href="#l9.761"></a><span id="l9.761" class="difflineplus">+                 &quot;lost inbox flag&quot;);</span>
<a href="#l9.762"></a><span id="l9.762">     m_flags = flags;</span>
<a href="#l9.763"></a><span id="l9.763">     ret = SetInt32PropertyWithToken(m_flagsColumnToken, m_flags);</span>
<a href="#l9.764"></a><span id="l9.764">   }</span>
<a href="#l9.765"></a><span id="l9.765">   return ret;</span>
<a href="#l9.766"></a><span id="l9.766"> }</span>
<a href="#l9.767"></a><span id="l9.767"> </span>
<a href="#l9.768"></a><span id="l9.768" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::OrFlags(int32_t flags, int32_t *result)</span>
<a href="#l9.769"></a><span id="l9.769" class="difflineminus">-{</span>
<a href="#l9.770"></a><span id="l9.770" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::OrFlags(int32_t flags, int32_t *result) {</span>
<a href="#l9.771"></a><span id="l9.771">   m_flags |= flags;</span>
<a href="#l9.772"></a><span id="l9.772">   *result = m_flags;</span>
<a href="#l9.773"></a><span id="l9.773">   return SetInt32PropertyWithToken(m_flagsColumnToken, m_flags);</span>
<a href="#l9.774"></a><span id="l9.774"> }</span>
<a href="#l9.775"></a><span id="l9.775"> </span>
<a href="#l9.776"></a><span id="l9.776" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::AndFlags(int32_t flags, int32_t *result)</span>
<a href="#l9.777"></a><span id="l9.777" class="difflineminus">-{</span>
<a href="#l9.778"></a><span id="l9.778" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::AndFlags(int32_t flags, int32_t *result) {</span>
<a href="#l9.779"></a><span id="l9.779">   m_flags &amp;= flags;</span>
<a href="#l9.780"></a><span id="l9.780">   *result = m_flags;</span>
<a href="#l9.781"></a><span id="l9.781">   return SetInt32PropertyWithToken(m_flagsColumnToken, m_flags);</span>
<a href="#l9.782"></a><span id="l9.782"> }</span>
<a href="#l9.783"></a><span id="l9.783"> </span>
<a href="#l9.784"></a><span id="l9.784" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetImapUidValidity(int32_t *result)</span>
<a href="#l9.785"></a><span id="l9.785" class="difflineminus">-{</span>
<a href="#l9.786"></a><span id="l9.786" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetImapUidValidity(int32_t *result) {</span>
<a href="#l9.787"></a><span id="l9.787">   *result = m_ImapUidValidity;</span>
<a href="#l9.788"></a><span id="l9.788">   return NS_OK;</span>
<a href="#l9.789"></a><span id="l9.789"> }</span>
<a href="#l9.790"></a><span id="l9.790"> </span>
<a href="#l9.791"></a><span id="l9.791" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetImapUidValidity(int32_t uidValidity)</span>
<a href="#l9.792"></a><span id="l9.792" class="difflineminus">-{</span>
<a href="#l9.793"></a><span id="l9.793" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetImapUidValidity(int32_t uidValidity) {</span>
<a href="#l9.794"></a><span id="l9.794">   m_ImapUidValidity = uidValidity;</span>
<a href="#l9.795"></a><span id="l9.795" class="difflineminus">-  return SetUint32PropertyWithToken(m_imapUidValidityColumnToken, m_ImapUidValidity);</span>
<a href="#l9.796"></a><span id="l9.796" class="difflineplus">+  return SetUint32PropertyWithToken(m_imapUidValidityColumnToken,</span>
<a href="#l9.797"></a><span id="l9.797" class="difflineplus">+                                    m_ImapUidValidity);</span>
<a href="#l9.798"></a><span id="l9.798"> }</span>
<a href="#l9.799"></a><span id="l9.799"> </span>
<a href="#l9.800"></a><span id="l9.800" class="difflineminus">-bool nsDBFolderInfo::TestFlag(int32_t flags)</span>
<a href="#l9.801"></a><span id="l9.801" class="difflineminus">-{</span>
<a href="#l9.802"></a><span id="l9.802" class="difflineminus">-  return (m_flags &amp; flags) != 0;</span>
<a href="#l9.803"></a><span id="l9.803" class="difflineminus">-}</span>
<a href="#l9.804"></a><span id="l9.804" class="difflineplus">+bool nsDBFolderInfo::TestFlag(int32_t flags) { return (m_flags &amp; flags) != 0; }</span>
<a href="#l9.805"></a><span id="l9.805"> </span>
<a href="#l9.806"></a><span id="l9.806"> NS_IMETHODIMP</span>
<a href="#l9.807"></a><span id="l9.807" class="difflineminus">-nsDBFolderInfo::GetCharacterSet(nsACString &amp;result)</span>
<a href="#l9.808"></a><span id="l9.808" class="difflineminus">-{</span>
<a href="#l9.809"></a><span id="l9.809" class="difflineplus">+nsDBFolderInfo::GetCharacterSet(nsACString &amp;result) {</span>
<a href="#l9.810"></a><span id="l9.810">   if (!m_charSet.IsEmpty())</span>
<a href="#l9.811"></a><span id="l9.811">     result.Assign(m_charSet);</span>
<a href="#l9.812"></a><span id="l9.812">   else if (gDefaultCharacterSet)</span>
<a href="#l9.813"></a><span id="l9.813">     result.Assign(*gDefaultCharacterSet);</span>
<a href="#l9.814"></a><span id="l9.814">   else</span>
<a href="#l9.815"></a><span id="l9.815">     result.Truncate();</span>
<a href="#l9.816"></a><span id="l9.816"> </span>
<a href="#l9.817"></a><span id="l9.817">   return NS_OK;</span>
<a href="#l9.818"></a><span id="l9.818"> }</span>
<a href="#l9.819"></a><span id="l9.819"> </span>
<a href="#l9.820"></a><span id="l9.820"> NS_IMETHODIMP</span>
<a href="#l9.821"></a><span id="l9.821" class="difflineminus">-nsDBFolderInfo::GetEffectiveCharacterSet(nsACString &amp;result)</span>
<a href="#l9.822"></a><span id="l9.822" class="difflineminus">-{</span>
<a href="#l9.823"></a><span id="l9.823" class="difflineplus">+nsDBFolderInfo::GetEffectiveCharacterSet(nsACString &amp;result) {</span>
<a href="#l9.824"></a><span id="l9.824">   result.Truncate();</span>
<a href="#l9.825"></a><span id="l9.825">   if (NS_FAILED(GetCharProperty(kCharacterSetColumnName, result)) ||</span>
<a href="#l9.826"></a><span id="l9.826">       (result.IsEmpty() &amp;&amp; gDefaultCharacterSet))</span>
<a href="#l9.827"></a><span id="l9.827">     result = *gDefaultCharacterSet;</span>
<a href="#l9.828"></a><span id="l9.828"> </span>
<a href="#l9.829"></a><span id="l9.829">   return NS_OK;</span>
<a href="#l9.830"></a><span id="l9.830"> }</span>
<a href="#l9.831"></a><span id="l9.831"> </span>
<a href="#l9.832"></a><span id="l9.832" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetCharacterSet(const nsACString &amp;charSet)</span>
<a href="#l9.833"></a><span id="l9.833" class="difflineminus">-{</span>
<a href="#l9.834"></a><span id="l9.834" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetCharacterSet(const nsACString &amp;charSet) {</span>
<a href="#l9.835"></a><span id="l9.835">   m_charSet.Assign(charSet);</span>
<a href="#l9.836"></a><span id="l9.836">   return SetCharProperty(kCharacterSetColumnName, charSet);</span>
<a href="#l9.837"></a><span id="l9.837"> }</span>
<a href="#l9.838"></a><span id="l9.838"> </span>
<a href="#l9.839"></a><span id="l9.839" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetCharacterSetOverride(bool *characterSetOverride)</span>
<a href="#l9.840"></a><span id="l9.840" class="difflineminus">-{</span>
<a href="#l9.841"></a><span id="l9.841" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetCharacterSetOverride(</span>
<a href="#l9.842"></a><span id="l9.842" class="difflineplus">+    bool *characterSetOverride) {</span>
<a href="#l9.843"></a><span id="l9.843">   NS_ENSURE_ARG_POINTER(characterSetOverride);</span>
<a href="#l9.844"></a><span id="l9.844">   *characterSetOverride = m_charSetOverride;</span>
<a href="#l9.845"></a><span id="l9.845">   return NS_OK;</span>
<a href="#l9.846"></a><span id="l9.846"> }</span>
<a href="#l9.847"></a><span id="l9.847"> </span>
<a href="#l9.848"></a><span id="l9.848" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetCharacterSetOverride(bool characterSetOverride)</span>
<a href="#l9.849"></a><span id="l9.849" class="difflineminus">-{</span>
<a href="#l9.850"></a><span id="l9.850" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetCharacterSetOverride(</span>
<a href="#l9.851"></a><span id="l9.851" class="difflineplus">+    bool characterSetOverride) {</span>
<a href="#l9.852"></a><span id="l9.852">   m_charSetOverride = characterSetOverride;</span>
<a href="#l9.853"></a><span id="l9.853" class="difflineminus">-  return SetUint32Property(kCharacterSetOverrideColumnName, characterSetOverride);</span>
<a href="#l9.854"></a><span id="l9.854" class="difflineplus">+  return SetUint32Property(kCharacterSetOverrideColumnName,</span>
<a href="#l9.855"></a><span id="l9.855" class="difflineplus">+                           characterSetOverride);</span>
<a href="#l9.856"></a><span id="l9.856"> }</span>
<a href="#l9.857"></a><span id="l9.857"> </span>
<a href="#l9.858"></a><span id="l9.858"> NS_IMETHODIMP</span>
<a href="#l9.859"></a><span id="l9.859" class="difflineminus">-nsDBFolderInfo::GetLocale(nsAString &amp;result)</span>
<a href="#l9.860"></a><span id="l9.860" class="difflineminus">-{</span>
<a href="#l9.861"></a><span id="l9.861" class="difflineplus">+nsDBFolderInfo::GetLocale(nsAString &amp;result) {</span>
<a href="#l9.862"></a><span id="l9.862">   GetProperty(kLocaleColumnName, result);</span>
<a href="#l9.863"></a><span id="l9.863">   return NS_OK;</span>
<a href="#l9.864"></a><span id="l9.864"> }</span>
<a href="#l9.865"></a><span id="l9.865"> </span>
<a href="#l9.866"></a><span id="l9.866" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetLocale(const nsAString &amp;locale)</span>
<a href="#l9.867"></a><span id="l9.867" class="difflineminus">-{</span>
<a href="#l9.868"></a><span id="l9.868" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetLocale(const nsAString &amp;locale) {</span>
<a href="#l9.869"></a><span id="l9.869">   return SetProperty(kLocaleColumnName, locale);</span>
<a href="#l9.870"></a><span id="l9.870"> }</span>
<a href="#l9.871"></a><span id="l9.871"> </span>
<a href="#l9.872"></a><span id="l9.872"> NS_IMETHODIMP</span>
<a href="#l9.873"></a><span id="l9.873" class="difflineminus">-nsDBFolderInfo::GetImapTotalPendingMessages(int32_t *result)</span>
<a href="#l9.874"></a><span id="l9.874" class="difflineminus">-{</span>
<a href="#l9.875"></a><span id="l9.875" class="difflineplus">+nsDBFolderInfo::GetImapTotalPendingMessages(int32_t *result) {</span>
<a href="#l9.876"></a><span id="l9.876">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l9.877"></a><span id="l9.877">   *result = m_totalPendingMessages;</span>
<a href="#l9.878"></a><span id="l9.878">   return NS_OK;</span>
<a href="#l9.879"></a><span id="l9.879"> }</span>
<a href="#l9.880"></a><span id="l9.880"> </span>
<a href="#l9.881"></a><span id="l9.881" class="difflineminus">-void nsDBFolderInfo::ChangeImapTotalPendingMessages(int32_t delta)</span>
<a href="#l9.882"></a><span id="l9.882" class="difflineminus">-{</span>
<a href="#l9.883"></a><span id="l9.883" class="difflineminus">-  m_totalPendingMessages+=delta;</span>
<a href="#l9.884"></a><span id="l9.884" class="difflineminus">-  SetInt32PropertyWithToken(m_totalPendingMessagesColumnToken, m_totalPendingMessages);</span>
<a href="#l9.885"></a><span id="l9.885" class="difflineplus">+void nsDBFolderInfo::ChangeImapTotalPendingMessages(int32_t delta) {</span>
<a href="#l9.886"></a><span id="l9.886" class="difflineplus">+  m_totalPendingMessages += delta;</span>
<a href="#l9.887"></a><span id="l9.887" class="difflineplus">+  SetInt32PropertyWithToken(m_totalPendingMessagesColumnToken,</span>
<a href="#l9.888"></a><span id="l9.888" class="difflineplus">+                            m_totalPendingMessages);</span>
<a href="#l9.889"></a><span id="l9.889"> }</span>
<a href="#l9.890"></a><span id="l9.890"> </span>
<a href="#l9.891"></a><span id="l9.891"> NS_IMETHODIMP</span>
<a href="#l9.892"></a><span id="l9.892" class="difflineminus">-nsDBFolderInfo::GetImapUnreadPendingMessages(int32_t *result)</span>
<a href="#l9.893"></a><span id="l9.893" class="difflineminus">-{</span>
<a href="#l9.894"></a><span id="l9.894" class="difflineplus">+nsDBFolderInfo::GetImapUnreadPendingMessages(int32_t *result) {</span>
<a href="#l9.895"></a><span id="l9.895">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l9.896"></a><span id="l9.896">   *result = m_unreadPendingMessages;</span>
<a href="#l9.897"></a><span id="l9.897">   return NS_OK;</span>
<a href="#l9.898"></a><span id="l9.898"> }</span>
<a href="#l9.899"></a><span id="l9.899"> </span>
<a href="#l9.900"></a><span id="l9.900" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetImapUnreadPendingMessages(int32_t numUnreadPendingMessages)</span>
<a href="#l9.901"></a><span id="l9.901" class="difflineminus">-{</span>
<a href="#l9.902"></a><span id="l9.902" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetImapUnreadPendingMessages(</span>
<a href="#l9.903"></a><span id="l9.903" class="difflineplus">+    int32_t numUnreadPendingMessages) {</span>
<a href="#l9.904"></a><span id="l9.904">   m_unreadPendingMessages = numUnreadPendingMessages;</span>
<a href="#l9.905"></a><span id="l9.905" class="difflineminus">-  return SetUint32PropertyWithToken(m_unreadPendingMessagesColumnToken, m_unreadPendingMessages);</span>
<a href="#l9.906"></a><span id="l9.906" class="difflineplus">+  return SetUint32PropertyWithToken(m_unreadPendingMessagesColumnToken,</span>
<a href="#l9.907"></a><span id="l9.907" class="difflineplus">+                                    m_unreadPendingMessages);</span>
<a href="#l9.908"></a><span id="l9.908"> }</span>
<a href="#l9.909"></a><span id="l9.909"> </span>
<a href="#l9.910"></a><span id="l9.910" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetImapTotalPendingMessages(int32_t numTotalPendingMessages)</span>
<a href="#l9.911"></a><span id="l9.911" class="difflineminus">-{</span>
<a href="#l9.912"></a><span id="l9.912" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetImapTotalPendingMessages(</span>
<a href="#l9.913"></a><span id="l9.913" class="difflineplus">+    int32_t numTotalPendingMessages) {</span>
<a href="#l9.914"></a><span id="l9.914">   m_totalPendingMessages = numTotalPendingMessages;</span>
<a href="#l9.915"></a><span id="l9.915" class="difflineminus">-  return SetUint32PropertyWithToken(m_totalPendingMessagesColumnToken, m_totalPendingMessages);</span>
<a href="#l9.916"></a><span id="l9.916" class="difflineplus">+  return SetUint32PropertyWithToken(m_totalPendingMessagesColumnToken,</span>
<a href="#l9.917"></a><span id="l9.917" class="difflineplus">+                                    m_totalPendingMessages);</span>
<a href="#l9.918"></a><span id="l9.918"> }</span>
<a href="#l9.919"></a><span id="l9.919"> </span>
<a href="#l9.920"></a><span id="l9.920" class="difflineminus">-void nsDBFolderInfo::ChangeImapUnreadPendingMessages(int32_t delta)</span>
<a href="#l9.921"></a><span id="l9.921" class="difflineminus">-{</span>
<a href="#l9.922"></a><span id="l9.922" class="difflineminus">-  m_unreadPendingMessages+=delta;</span>
<a href="#l9.923"></a><span id="l9.923" class="difflineminus">-  SetInt32PropertyWithToken(m_unreadPendingMessagesColumnToken, m_unreadPendingMessages);</span>
<a href="#l9.924"></a><span id="l9.924" class="difflineplus">+void nsDBFolderInfo::ChangeImapUnreadPendingMessages(int32_t delta) {</span>
<a href="#l9.925"></a><span id="l9.925" class="difflineplus">+  m_unreadPendingMessages += delta;</span>
<a href="#l9.926"></a><span id="l9.926" class="difflineplus">+  SetInt32PropertyWithToken(m_unreadPendingMessagesColumnToken,</span>
<a href="#l9.927"></a><span id="l9.927" class="difflineplus">+                            m_unreadPendingMessages);</span>
<a href="#l9.928"></a><span id="l9.928"> }</span>
<a href="#l9.929"></a><span id="l9.929"> </span>
<a href="#l9.930"></a><span id="l9.930"> /* attribute nsMsgViewTypeValue viewType; */</span>
<a href="#l9.931"></a><span id="l9.931" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l9.932"></a><span id="l9.932" class="difflineminus">-{</span>
<a href="#l9.933"></a><span id="l9.933" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetViewType(nsMsgViewTypeValue *aViewType) {</span>
<a href="#l9.934"></a><span id="l9.934">   uint32_t viewTypeValue;</span>
<a href="#l9.935"></a><span id="l9.935" class="difflineminus">-  nsresult rv = GetUint32Property(&quot;viewType&quot;, nsMsgViewType::eShowAllThreads, &amp;viewTypeValue);</span>
<a href="#l9.936"></a><span id="l9.936" class="difflineplus">+  nsresult rv = GetUint32Property(&quot;viewType&quot;, nsMsgViewType::eShowAllThreads,</span>
<a href="#l9.937"></a><span id="l9.937" class="difflineplus">+                                  &amp;viewTypeValue);</span>
<a href="#l9.938"></a><span id="l9.938">   *aViewType = viewTypeValue;</span>
<a href="#l9.939"></a><span id="l9.939">   return rv;</span>
<a href="#l9.940"></a><span id="l9.940"> }</span>
<a href="#l9.941"></a><span id="l9.941" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetViewType(nsMsgViewTypeValue aViewType)</span>
<a href="#l9.942"></a><span id="l9.942" class="difflineminus">-{</span>
<a href="#l9.943"></a><span id="l9.943" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetViewType(nsMsgViewTypeValue aViewType) {</span>
<a href="#l9.944"></a><span id="l9.944">   return SetUint32Property(&quot;viewType&quot;, aViewType);</span>
<a href="#l9.945"></a><span id="l9.945"> }</span>
<a href="#l9.946"></a><span id="l9.946"> </span>
<a href="#l9.947"></a><span id="l9.947"> /* attribute nsMsgViewFlagsTypeValue viewFlags; */</span>
<a href="#l9.948"></a><span id="l9.948" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetViewFlags(nsMsgViewFlagsTypeValue *aViewFlags)</span>
<a href="#l9.949"></a><span id="l9.949" class="difflineminus">-{</span>
<a href="#l9.950"></a><span id="l9.950" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetViewFlags(</span>
<a href="#l9.951"></a><span id="l9.951" class="difflineplus">+    nsMsgViewFlagsTypeValue *aViewFlags) {</span>
<a href="#l9.952"></a><span id="l9.952">   nsMsgViewFlagsTypeValue defaultViewFlags;</span>
<a href="#l9.953"></a><span id="l9.953">   nsresult rv = m_mdb-&gt;GetDefaultViewFlags(&amp;defaultViewFlags);</span>
<a href="#l9.954"></a><span id="l9.954" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.955"></a><span id="l9.955" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.956"></a><span id="l9.956"> </span>
<a href="#l9.957"></a><span id="l9.957">   uint32_t viewFlagsValue;</span>
<a href="#l9.958"></a><span id="l9.958">   rv = GetUint32Property(&quot;viewFlags&quot;, defaultViewFlags, &amp;viewFlagsValue);</span>
<a href="#l9.959"></a><span id="l9.959">   *aViewFlags = viewFlagsValue;</span>
<a href="#l9.960"></a><span id="l9.960">   return rv;</span>
<a href="#l9.961"></a><span id="l9.961"> }</span>
<a href="#l9.962"></a><span id="l9.962" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetViewFlags(nsMsgViewFlagsTypeValue aViewFlags)</span>
<a href="#l9.963"></a><span id="l9.963" class="difflineminus">-{</span>
<a href="#l9.964"></a><span id="l9.964" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetViewFlags(nsMsgViewFlagsTypeValue aViewFlags) {</span>
<a href="#l9.965"></a><span id="l9.965">   return SetUint32Property(&quot;viewFlags&quot;, aViewFlags);</span>
<a href="#l9.966"></a><span id="l9.966"> }</span>
<a href="#l9.967"></a><span id="l9.967"> </span>
<a href="#l9.968"></a><span id="l9.968"> /* attribute nsMsgViewSortTypeValue sortType; */</span>
<a href="#l9.969"></a><span id="l9.969" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetSortType(nsMsgViewSortTypeValue *aSortType)</span>
<a href="#l9.970"></a><span id="l9.970" class="difflineminus">-{</span>
<a href="#l9.971"></a><span id="l9.971" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetSortType(nsMsgViewSortTypeValue *aSortType) {</span>
<a href="#l9.972"></a><span id="l9.972">   nsMsgViewSortTypeValue defaultSortType;</span>
<a href="#l9.973"></a><span id="l9.973">   nsresult rv = m_mdb-&gt;GetDefaultSortType(&amp;defaultSortType);</span>
<a href="#l9.974"></a><span id="l9.974" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.975"></a><span id="l9.975" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.976"></a><span id="l9.976"> </span>
<a href="#l9.977"></a><span id="l9.977">   uint32_t sortTypeValue;</span>
<a href="#l9.978"></a><span id="l9.978">   rv = GetUint32Property(&quot;sortType&quot;, defaultSortType, &amp;sortTypeValue);</span>
<a href="#l9.979"></a><span id="l9.979">   *aSortType = sortTypeValue;</span>
<a href="#l9.980"></a><span id="l9.980">   return rv;</span>
<a href="#l9.981"></a><span id="l9.981"> }</span>
<a href="#l9.982"></a><span id="l9.982" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetSortType(nsMsgViewSortTypeValue aSortType)</span>
<a href="#l9.983"></a><span id="l9.983" class="difflineminus">-{</span>
<a href="#l9.984"></a><span id="l9.984" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetSortType(nsMsgViewSortTypeValue aSortType) {</span>
<a href="#l9.985"></a><span id="l9.985">   return SetUint32Property(&quot;sortType&quot;, aSortType);</span>
<a href="#l9.986"></a><span id="l9.986"> }</span>
<a href="#l9.987"></a><span id="l9.987"> </span>
<a href="#l9.988"></a><span id="l9.988"> /* attribute nsMsgViewSortOrderValue sortOrder; */</span>
<a href="#l9.989"></a><span id="l9.989" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetSortOrder(nsMsgViewSortOrderValue *aSortOrder)</span>
<a href="#l9.990"></a><span id="l9.990" class="difflineminus">-{</span>
<a href="#l9.991"></a><span id="l9.991" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetSortOrder(</span>
<a href="#l9.992"></a><span id="l9.992" class="difflineplus">+    nsMsgViewSortOrderValue *aSortOrder) {</span>
<a href="#l9.993"></a><span id="l9.993">   nsMsgViewSortOrderValue defaultSortOrder;</span>
<a href="#l9.994"></a><span id="l9.994">   nsresult rv = m_mdb-&gt;GetDefaultSortOrder(&amp;defaultSortOrder);</span>
<a href="#l9.995"></a><span id="l9.995" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l9.996"></a><span id="l9.996" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.997"></a><span id="l9.997"> </span>
<a href="#l9.998"></a><span id="l9.998">   uint32_t sortOrderValue;</span>
<a href="#l9.999"></a><span id="l9.999">   rv = GetUint32Property(&quot;sortOrder&quot;, defaultSortOrder, &amp;sortOrderValue);</span>
<a href="#l9.1000"></a><span id="l9.1000">   *aSortOrder = sortOrderValue;</span>
<a href="#l9.1001"></a><span id="l9.1001">   return rv;</span>
<a href="#l9.1002"></a><span id="l9.1002"> }</span>
<a href="#l9.1003"></a><span id="l9.1003"> </span>
<a href="#l9.1004"></a><span id="l9.1004" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetSortOrder(nsMsgViewSortOrderValue aSortOrder)</span>
<a href="#l9.1005"></a><span id="l9.1005" class="difflineminus">-{</span>
<a href="#l9.1006"></a><span id="l9.1006" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetSortOrder(nsMsgViewSortOrderValue aSortOrder) {</span>
<a href="#l9.1007"></a><span id="l9.1007">   return SetUint32Property(&quot;sortOrder&quot;, aSortOrder);</span>
<a href="#l9.1008"></a><span id="l9.1008"> }</span>
<a href="#l9.1009"></a><span id="l9.1009"> </span>
<a href="#l9.1010"></a><span id="l9.1010" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetKnownArtsSet(const char *newsArtSet)</span>
<a href="#l9.1011"></a><span id="l9.1011" class="difflineminus">-{</span>
<a href="#l9.1012"></a><span id="l9.1012" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetKnownArtsSet(const char *newsArtSet) {</span>
<a href="#l9.1013"></a><span id="l9.1013">   return m_mdb-&gt;SetProperty(m_mdbRow, kKnownArtsSetColumnName, newsArtSet);</span>
<a href="#l9.1014"></a><span id="l9.1014"> }</span>
<a href="#l9.1015"></a><span id="l9.1015"> </span>
<a href="#l9.1016"></a><span id="l9.1016" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetKnownArtsSet(char **newsArtSet)</span>
<a href="#l9.1017"></a><span id="l9.1017" class="difflineminus">-{</span>
<a href="#l9.1018"></a><span id="l9.1018" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetKnownArtsSet(char **newsArtSet) {</span>
<a href="#l9.1019"></a><span id="l9.1019">   return m_mdb-&gt;GetProperty(m_mdbRow, kKnownArtsSetColumnName, newsArtSet);</span>
<a href="#l9.1020"></a><span id="l9.1020"> }</span>
<a href="#l9.1021"></a><span id="l9.1021"> </span>
<a href="#l9.1022"></a><span id="l9.1022"> // get arbitrary property, aka row cell value.</span>
<a href="#l9.1023"></a><span id="l9.1023" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetProperty(const char *propertyName, nsAString &amp;resultProperty)</span>
<a href="#l9.1024"></a><span id="l9.1024" class="difflineminus">-{</span>
<a href="#l9.1025"></a><span id="l9.1025" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetProperty(const char *propertyName,</span>
<a href="#l9.1026"></a><span id="l9.1026" class="difflineplus">+                                          nsAString &amp;resultProperty) {</span>
<a href="#l9.1027"></a><span id="l9.1027">   return m_mdb-&gt;GetPropertyAsNSString(m_mdbRow, propertyName, resultProperty);</span>
<a href="#l9.1028"></a><span id="l9.1028"> }</span>
<a href="#l9.1029"></a><span id="l9.1029"> </span>
<a href="#l9.1030"></a><span id="l9.1030" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetCharProperty(const char *aPropertyName,</span>
<a href="#l9.1031"></a><span id="l9.1031" class="difflineminus">-                                              const nsACString &amp;aPropertyValue)</span>
<a href="#l9.1032"></a><span id="l9.1032" class="difflineminus">-{</span>
<a href="#l9.1033"></a><span id="l9.1033" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetCharProperty(</span>
<a href="#l9.1034"></a><span id="l9.1034" class="difflineplus">+    const char *aPropertyName, const nsACString &amp;aPropertyValue) {</span>
<a href="#l9.1035"></a><span id="l9.1035">   return m_mdb-&gt;SetProperty(m_mdbRow, aPropertyName,</span>
<a href="#l9.1036"></a><span id="l9.1036">                             nsCString(aPropertyValue).get());</span>
<a href="#l9.1037"></a><span id="l9.1037"> }</span>
<a href="#l9.1038"></a><span id="l9.1038"> </span>
<a href="#l9.1039"></a><span id="l9.1039"> NS_IMETHODIMP nsDBFolderInfo::GetCharProperty(const char *propertyName,</span>
<a href="#l9.1040"></a><span id="l9.1040" class="difflineminus">-                                              nsACString &amp;resultProperty)</span>
<a href="#l9.1041"></a><span id="l9.1041" class="difflineminus">-{</span>
<a href="#l9.1042"></a><span id="l9.1042" class="difflineplus">+                                              nsACString &amp;resultProperty) {</span>
<a href="#l9.1043"></a><span id="l9.1043">   nsCString result;</span>
<a href="#l9.1044"></a><span id="l9.1044" class="difflineminus">-  nsresult rv = m_mdb-&gt;GetProperty(m_mdbRow, propertyName, getter_Copies(result));</span>
<a href="#l9.1045"></a><span id="l9.1045" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l9.1046"></a><span id="l9.1046" class="difflineminus">-    resultProperty.Assign(result);</span>
<a href="#l9.1047"></a><span id="l9.1047" class="difflineplus">+  nsresult rv =</span>
<a href="#l9.1048"></a><span id="l9.1048" class="difflineplus">+      m_mdb-&gt;GetProperty(m_mdbRow, propertyName, getter_Copies(result));</span>
<a href="#l9.1049"></a><span id="l9.1049" class="difflineplus">+  if (NS_SUCCEEDED(rv)) resultProperty.Assign(result);</span>
<a href="#l9.1050"></a><span id="l9.1050">   return rv;</span>
<a href="#l9.1051"></a><span id="l9.1051"> }</span>
<a href="#l9.1052"></a><span id="l9.1052"> </span>
<a href="#l9.1053"></a><span id="l9.1053" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetUint32Property(const char *propertyName, uint32_t propertyValue)</span>
<a href="#l9.1054"></a><span id="l9.1054" class="difflineminus">-{</span>
<a href="#l9.1055"></a><span id="l9.1055" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetUint32Property(const char *propertyName,</span>
<a href="#l9.1056"></a><span id="l9.1056" class="difflineplus">+                                                uint32_t propertyValue) {</span>
<a href="#l9.1057"></a><span id="l9.1057">   return m_mdb-&gt;SetUint32Property(m_mdbRow, propertyName, propertyValue);</span>
<a href="#l9.1058"></a><span id="l9.1058"> }</span>
<a href="#l9.1059"></a><span id="l9.1059"> </span>
<a href="#l9.1060"></a><span id="l9.1060" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetInt64Property(const char *propertyName, int64_t propertyValue)</span>
<a href="#l9.1061"></a><span id="l9.1061" class="difflineminus">-{</span>
<a href="#l9.1062"></a><span id="l9.1062" class="difflineminus">-  return m_mdb-&gt;SetUint64Property(m_mdbRow, propertyName, (uint64_t) propertyValue);</span>
<a href="#l9.1063"></a><span id="l9.1063" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetInt64Property(const char *propertyName,</span>
<a href="#l9.1064"></a><span id="l9.1064" class="difflineplus">+                                               int64_t propertyValue) {</span>
<a href="#l9.1065"></a><span id="l9.1065" class="difflineplus">+  return m_mdb-&gt;SetUint64Property(m_mdbRow, propertyName,</span>
<a href="#l9.1066"></a><span id="l9.1066" class="difflineplus">+                                  (uint64_t)propertyValue);</span>
<a href="#l9.1067"></a><span id="l9.1067"> }</span>
<a href="#l9.1068"></a><span id="l9.1068"> </span>
<a href="#l9.1069"></a><span id="l9.1069" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetProperty(const char *propertyName, const nsAString &amp;propertyStr)</span>
<a href="#l9.1070"></a><span id="l9.1070" class="difflineminus">-{</span>
<a href="#l9.1071"></a><span id="l9.1071" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetProperty(const char *propertyName,</span>
<a href="#l9.1072"></a><span id="l9.1072" class="difflineplus">+                                          const nsAString &amp;propertyStr) {</span>
<a href="#l9.1073"></a><span id="l9.1073">   return m_mdb-&gt;SetPropertyFromNSString(m_mdbRow, propertyName, propertyStr);</span>
<a href="#l9.1074"></a><span id="l9.1074"> }</span>
<a href="#l9.1075"></a><span id="l9.1075"> </span>
<a href="#l9.1076"></a><span id="l9.1076" class="difflineminus">-nsresult nsDBFolderInfo::SetPropertyWithToken(mdb_token aProperty, const nsAString &amp;propertyStr)</span>
<a href="#l9.1077"></a><span id="l9.1077" class="difflineminus">-{</span>
<a href="#l9.1078"></a><span id="l9.1078" class="difflineplus">+nsresult nsDBFolderInfo::SetPropertyWithToken(mdb_token aProperty,</span>
<a href="#l9.1079"></a><span id="l9.1079" class="difflineplus">+                                              const nsAString &amp;propertyStr) {</span>
<a href="#l9.1080"></a><span id="l9.1080">   return m_mdb-&gt;SetNSStringPropertyWithToken(m_mdbRow, aProperty, propertyStr);</span>
<a href="#l9.1081"></a><span id="l9.1081"> }</span>
<a href="#l9.1082"></a><span id="l9.1082"> </span>
<a href="#l9.1083"></a><span id="l9.1083" class="difflineminus">-nsresult nsDBFolderInfo::SetUint32PropertyWithToken(mdb_token aProperty, uint32_t propertyValue)</span>
<a href="#l9.1084"></a><span id="l9.1084" class="difflineminus">-{</span>
<a href="#l9.1085"></a><span id="l9.1085" class="difflineplus">+nsresult nsDBFolderInfo::SetUint32PropertyWithToken(mdb_token aProperty,</span>
<a href="#l9.1086"></a><span id="l9.1086" class="difflineplus">+                                                    uint32_t propertyValue) {</span>
<a href="#l9.1087"></a><span id="l9.1087">   return m_mdb-&gt;UInt32ToRowCellColumn(m_mdbRow, aProperty, propertyValue);</span>
<a href="#l9.1088"></a><span id="l9.1088"> }</span>
<a href="#l9.1089"></a><span id="l9.1089"> </span>
<a href="#l9.1090"></a><span id="l9.1090" class="difflineminus">-nsresult nsDBFolderInfo::SetInt64PropertyWithToken(mdb_token aProperty, int64_t propertyValue)</span>
<a href="#l9.1091"></a><span id="l9.1091" class="difflineminus">-{</span>
<a href="#l9.1092"></a><span id="l9.1092" class="difflineminus">-  return m_mdb-&gt;UInt64ToRowCellColumn(m_mdbRow, aProperty, (uint64_t) propertyValue);</span>
<a href="#l9.1093"></a><span id="l9.1093" class="difflineplus">+nsresult nsDBFolderInfo::SetInt64PropertyWithToken(mdb_token aProperty,</span>
<a href="#l9.1094"></a><span id="l9.1094" class="difflineplus">+                                                   int64_t propertyValue) {</span>
<a href="#l9.1095"></a><span id="l9.1095" class="difflineplus">+  return m_mdb-&gt;UInt64ToRowCellColumn(m_mdbRow, aProperty,</span>
<a href="#l9.1096"></a><span id="l9.1096" class="difflineplus">+                                      (uint64_t)propertyValue);</span>
<a href="#l9.1097"></a><span id="l9.1097"> }</span>
<a href="#l9.1098"></a><span id="l9.1098"> </span>
<a href="#l9.1099"></a><span id="l9.1099" class="difflineminus">-nsresult nsDBFolderInfo::SetInt32PropertyWithToken(mdb_token aProperty, int32_t propertyValue)</span>
<a href="#l9.1100"></a><span id="l9.1100" class="difflineminus">-{</span>
<a href="#l9.1101"></a><span id="l9.1101" class="difflineplus">+nsresult nsDBFolderInfo::SetInt32PropertyWithToken(mdb_token aProperty,</span>
<a href="#l9.1102"></a><span id="l9.1102" class="difflineplus">+                                                   int32_t propertyValue) {</span>
<a href="#l9.1103"></a><span id="l9.1103">   nsAutoString propertyStr;</span>
<a href="#l9.1104"></a><span id="l9.1104">   propertyStr.AppendInt(propertyValue, 16);</span>
<a href="#l9.1105"></a><span id="l9.1105">   return SetPropertyWithToken(aProperty, propertyStr);</span>
<a href="#l9.1106"></a><span id="l9.1106"> }</span>
<a href="#l9.1107"></a><span id="l9.1107"> </span>
<a href="#l9.1108"></a><span id="l9.1108" class="difflineminus">-nsresult nsDBFolderInfo::GetPropertyWithToken(mdb_token aProperty, nsAString &amp;resultProperty)</span>
<a href="#l9.1109"></a><span id="l9.1109" class="difflineminus">-{</span>
<a href="#l9.1110"></a><span id="l9.1110" class="difflineplus">+nsresult nsDBFolderInfo::GetPropertyWithToken(mdb_token aProperty,</span>
<a href="#l9.1111"></a><span id="l9.1111" class="difflineplus">+                                              nsAString &amp;resultProperty) {</span>
<a href="#l9.1112"></a><span id="l9.1112">   return m_mdb-&gt;RowCellColumnTonsString(m_mdbRow, aProperty, resultProperty);</span>
<a href="#l9.1113"></a><span id="l9.1113"> }</span>
<a href="#l9.1114"></a><span id="l9.1114"> </span>
<a href="#l9.1115"></a><span id="l9.1115" class="difflineminus">-nsresult nsDBFolderInfo::GetUint32PropertyWithToken(mdb_token aProperty, uint32_t &amp;propertyValue, uint32_t defaultValue)</span>
<a href="#l9.1116"></a><span id="l9.1116" class="difflineminus">-{</span>
<a href="#l9.1117"></a><span id="l9.1117" class="difflineminus">-  return m_mdb-&gt;RowCellColumnToUInt32(m_mdbRow, aProperty, propertyValue, defaultValue);</span>
<a href="#l9.1118"></a><span id="l9.1118" class="difflineplus">+nsresult nsDBFolderInfo::GetUint32PropertyWithToken(mdb_token aProperty,</span>
<a href="#l9.1119"></a><span id="l9.1119" class="difflineplus">+                                                    uint32_t &amp;propertyValue,</span>
<a href="#l9.1120"></a><span id="l9.1120" class="difflineplus">+                                                    uint32_t defaultValue) {</span>
<a href="#l9.1121"></a><span id="l9.1121" class="difflineplus">+  return m_mdb-&gt;RowCellColumnToUInt32(m_mdbRow, aProperty, propertyValue,</span>
<a href="#l9.1122"></a><span id="l9.1122" class="difflineplus">+                                      defaultValue);</span>
<a href="#l9.1123"></a><span id="l9.1123"> }</span>
<a href="#l9.1124"></a><span id="l9.1124"> </span>
<a href="#l9.1125"></a><span id="l9.1125" class="difflineminus">-nsresult nsDBFolderInfo::GetInt32PropertyWithToken(mdb_token aProperty, int32_t &amp;propertyValue, int32_t defaultValue)</span>
<a href="#l9.1126"></a><span id="l9.1126" class="difflineminus">-{</span>
<a href="#l9.1127"></a><span id="l9.1127" class="difflineminus">-  return m_mdb-&gt;RowCellColumnToUInt32(m_mdbRow, aProperty, (uint32_t &amp;) propertyValue, defaultValue);</span>
<a href="#l9.1128"></a><span id="l9.1128" class="difflineplus">+nsresult nsDBFolderInfo::GetInt32PropertyWithToken(mdb_token aProperty,</span>
<a href="#l9.1129"></a><span id="l9.1129" class="difflineplus">+                                                   int32_t &amp;propertyValue,</span>
<a href="#l9.1130"></a><span id="l9.1130" class="difflineplus">+                                                   int32_t defaultValue) {</span>
<a href="#l9.1131"></a><span id="l9.1131" class="difflineplus">+  return m_mdb-&gt;RowCellColumnToUInt32(m_mdbRow, aProperty,</span>
<a href="#l9.1132"></a><span id="l9.1132" class="difflineplus">+                                      (uint32_t &amp;)propertyValue, defaultValue);</span>
<a href="#l9.1133"></a><span id="l9.1133"> }</span>
<a href="#l9.1134"></a><span id="l9.1134"> </span>
<a href="#l9.1135"></a><span id="l9.1135" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetUint32Property(const char *propertyName, uint32_t defaultValue, uint32_t *propertyValue)</span>
<a href="#l9.1136"></a><span id="l9.1136" class="difflineminus">-{</span>
<a href="#l9.1137"></a><span id="l9.1137" class="difflineminus">-  return m_mdb-&gt;GetUint32Property(m_mdbRow, propertyName, propertyValue, defaultValue);</span>
<a href="#l9.1138"></a><span id="l9.1138" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetUint32Property(const char *propertyName,</span>
<a href="#l9.1139"></a><span id="l9.1139" class="difflineplus">+                                                uint32_t defaultValue,</span>
<a href="#l9.1140"></a><span id="l9.1140" class="difflineplus">+                                                uint32_t *propertyValue) {</span>
<a href="#l9.1141"></a><span id="l9.1141" class="difflineplus">+  return m_mdb-&gt;GetUint32Property(m_mdbRow, propertyName, propertyValue,</span>
<a href="#l9.1142"></a><span id="l9.1142" class="difflineplus">+                                  defaultValue);</span>
<a href="#l9.1143"></a><span id="l9.1143"> }</span>
<a href="#l9.1144"></a><span id="l9.1144"> </span>
<a href="#l9.1145"></a><span id="l9.1145" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetInt64Property(const char *propertyName, int64_t defaultValue, int64_t *propertyValue)</span>
<a href="#l9.1146"></a><span id="l9.1146" class="difflineminus">-{</span>
<a href="#l9.1147"></a><span id="l9.1147" class="difflineminus">-  return m_mdb-&gt;GetUint64Property(m_mdbRow, propertyName, (uint64_t *) &amp;propertyValue, defaultValue);</span>
<a href="#l9.1148"></a><span id="l9.1148" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetInt64Property(const char *propertyName,</span>
<a href="#l9.1149"></a><span id="l9.1149" class="difflineplus">+                                               int64_t defaultValue,</span>
<a href="#l9.1150"></a><span id="l9.1150" class="difflineplus">+                                               int64_t *propertyValue) {</span>
<a href="#l9.1151"></a><span id="l9.1151" class="difflineplus">+  return m_mdb-&gt;GetUint64Property(m_mdbRow, propertyName,</span>
<a href="#l9.1152"></a><span id="l9.1152" class="difflineplus">+                                  (uint64_t *)&amp;propertyValue, defaultValue);</span>
<a href="#l9.1153"></a><span id="l9.1153"> }</span>
<a href="#l9.1154"></a><span id="l9.1154"> </span>
<a href="#l9.1155"></a><span id="l9.1155"> nsresult nsDBFolderInfo::GetInt64PropertyWithToken(mdb_token aProperty,</span>
<a href="#l9.1156"></a><span id="l9.1156">                                                    int64_t &amp;propertyValue,</span>
<a href="#l9.1157"></a><span id="l9.1157" class="difflineminus">-                                                   int64_t defaultValue)</span>
<a href="#l9.1158"></a><span id="l9.1158" class="difflineminus">-{</span>
<a href="#l9.1159"></a><span id="l9.1159" class="difflineminus">-  return m_mdb-&gt;RowCellColumnToUInt64(m_mdbRow, aProperty, (uint64_t *) &amp;propertyValue, defaultValue);</span>
<a href="#l9.1160"></a><span id="l9.1160" class="difflineplus">+                                                   int64_t defaultValue) {</span>
<a href="#l9.1161"></a><span id="l9.1161" class="difflineplus">+  return m_mdb-&gt;RowCellColumnToUInt64(m_mdbRow, aProperty,</span>
<a href="#l9.1162"></a><span id="l9.1162" class="difflineplus">+                                      (uint64_t *)&amp;propertyValue, defaultValue);</span>
<a href="#l9.1163"></a><span id="l9.1163"> }</span>
<a href="#l9.1164"></a><span id="l9.1164"> </span>
<a href="#l9.1165"></a><span id="l9.1165" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetBooleanProperty(const char *propertyName, bool defaultValue, bool *propertyValue)</span>
<a href="#l9.1166"></a><span id="l9.1166" class="difflineminus">-{</span>
<a href="#l9.1167"></a><span id="l9.1167" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetBooleanProperty(const char *propertyName,</span>
<a href="#l9.1168"></a><span id="l9.1168" class="difflineplus">+                                                 bool defaultValue,</span>
<a href="#l9.1169"></a><span id="l9.1169" class="difflineplus">+                                                 bool *propertyValue) {</span>
<a href="#l9.1170"></a><span id="l9.1170">   uint32_t defaultUint32Value = (defaultValue) ? 1 : 0;</span>
<a href="#l9.1171"></a><span id="l9.1171">   uint32_t returnValue;</span>
<a href="#l9.1172"></a><span id="l9.1172" class="difflineminus">-  nsresult rv = m_mdb-&gt;GetUint32Property(m_mdbRow, propertyName, &amp;returnValue, defaultUint32Value);</span>
<a href="#l9.1173"></a><span id="l9.1173" class="difflineplus">+  nsresult rv = m_mdb-&gt;GetUint32Property(m_mdbRow, propertyName, &amp;returnValue,</span>
<a href="#l9.1174"></a><span id="l9.1174" class="difflineplus">+                                         defaultUint32Value);</span>
<a href="#l9.1175"></a><span id="l9.1175">   *propertyValue = (returnValue != 0);</span>
<a href="#l9.1176"></a><span id="l9.1176">   return rv;</span>
<a href="#l9.1177"></a><span id="l9.1177"> }</span>
<a href="#l9.1178"></a><span id="l9.1178" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetBooleanProperty(const char *propertyName, bool propertyValue)</span>
<a href="#l9.1179"></a><span id="l9.1179" class="difflineminus">-{</span>
<a href="#l9.1180"></a><span id="l9.1180" class="difflineminus">-  return m_mdb-&gt;SetUint32Property(m_mdbRow, propertyName, propertyValue ? 1 : 0);</span>
<a href="#l9.1181"></a><span id="l9.1181" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetBooleanProperty(const char *propertyName,</span>
<a href="#l9.1182"></a><span id="l9.1182" class="difflineplus">+                                                 bool propertyValue) {</span>
<a href="#l9.1183"></a><span id="l9.1183" class="difflineplus">+  return m_mdb-&gt;SetUint32Property(m_mdbRow, propertyName,</span>
<a href="#l9.1184"></a><span id="l9.1184" class="difflineplus">+                                  propertyValue ? 1 : 0);</span>
<a href="#l9.1185"></a><span id="l9.1185"> }</span>
<a href="#l9.1186"></a><span id="l9.1186"> </span>
<a href="#l9.1187"></a><span id="l9.1187" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetFolderName(nsACString &amp;folderName)</span>
<a href="#l9.1188"></a><span id="l9.1188" class="difflineminus">-{</span>
<a href="#l9.1189"></a><span id="l9.1189" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetFolderName(nsACString &amp;folderName) {</span>
<a href="#l9.1190"></a><span id="l9.1190">   return GetCharProperty(&quot;folderName&quot;, folderName);</span>
<a href="#l9.1191"></a><span id="l9.1191"> }</span>
<a href="#l9.1192"></a><span id="l9.1192"> </span>
<a href="#l9.1193"></a><span id="l9.1193" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::SetFolderName(const nsACString &amp;folderName)</span>
<a href="#l9.1194"></a><span id="l9.1194" class="difflineminus">-{</span>
<a href="#l9.1195"></a><span id="l9.1195" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::SetFolderName(const nsACString &amp;folderName) {</span>
<a href="#l9.1196"></a><span id="l9.1196">   return SetCharProperty(&quot;folderName&quot;, folderName);</span>
<a href="#l9.1197"></a><span id="l9.1197"> }</span>
<a href="#l9.1198"></a><span id="l9.1198"> </span>
<a href="#l9.1199"></a><span id="l9.1199" class="difflineminus">-class nsTransferDBFolderInfo : public nsDBFolderInfo</span>
<a href="#l9.1200"></a><span id="l9.1200" class="difflineminus">-{</span>
<a href="#l9.1201"></a><span id="l9.1201" class="difflineminus">-public:</span>
<a href="#l9.1202"></a><span id="l9.1202" class="difflineplus">+class nsTransferDBFolderInfo : public nsDBFolderInfo {</span>
<a href="#l9.1203"></a><span id="l9.1203" class="difflineplus">+ public:</span>
<a href="#l9.1204"></a><span id="l9.1204">   nsTransferDBFolderInfo();</span>
<a href="#l9.1205"></a><span id="l9.1205">   virtual ~nsTransferDBFolderInfo();</span>
<a href="#l9.1206"></a><span id="l9.1206">   // parallel arrays of properties and values</span>
<a href="#l9.1207"></a><span id="l9.1207">   nsTArray&lt;nsCString&gt; m_properties;</span>
<a href="#l9.1208"></a><span id="l9.1208">   nsTArray&lt;nsCString&gt; m_values;</span>
<a href="#l9.1209"></a><span id="l9.1209"> };</span>
<a href="#l9.1210"></a><span id="l9.1210"> </span>
<a href="#l9.1211"></a><span id="l9.1211" class="difflineminus">-nsTransferDBFolderInfo::nsTransferDBFolderInfo() : nsDBFolderInfo(nullptr)</span>
<a href="#l9.1212"></a><span id="l9.1212" class="difflineminus">-{</span>
<a href="#l9.1213"></a><span id="l9.1213" class="difflineminus">-}</span>
<a href="#l9.1214"></a><span id="l9.1214" class="difflineplus">+nsTransferDBFolderInfo::nsTransferDBFolderInfo() : nsDBFolderInfo(nullptr) {}</span>
<a href="#l9.1215"></a><span id="l9.1215"> </span>
<a href="#l9.1216"></a><span id="l9.1216" class="difflineminus">-nsTransferDBFolderInfo::~nsTransferDBFolderInfo()</span>
<a href="#l9.1217"></a><span id="l9.1217" class="difflineminus">-{</span>
<a href="#l9.1218"></a><span id="l9.1218" class="difflineminus">-}</span>
<a href="#l9.1219"></a><span id="l9.1219" class="difflineplus">+nsTransferDBFolderInfo::~nsTransferDBFolderInfo() {}</span>
<a href="#l9.1220"></a><span id="l9.1220"> </span>
<a href="#l9.1221"></a><span id="l9.1221"> /* void GetTransferInfo (out nsIDBFolderInfo transferInfo); */</span>
<a href="#l9.1222"></a><span id="l9.1222" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::GetTransferInfo(nsIDBFolderInfo **transferInfo)</span>
<a href="#l9.1223"></a><span id="l9.1223" class="difflineminus">-{</span>
<a href="#l9.1224"></a><span id="l9.1224" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::GetTransferInfo(nsIDBFolderInfo **transferInfo) {</span>
<a href="#l9.1225"></a><span id="l9.1225">   NS_ENSURE_ARG_POINTER(transferInfo);</span>
<a href="#l9.1226"></a><span id="l9.1226"> </span>
<a href="#l9.1227"></a><span id="l9.1227">   nsTransferDBFolderInfo *newInfo = new nsTransferDBFolderInfo;</span>
<a href="#l9.1228"></a><span id="l9.1228">   NS_ADDREF(*transferInfo = newInfo);</span>
<a href="#l9.1229"></a><span id="l9.1229"> </span>
<a href="#l9.1230"></a><span id="l9.1230">   mdb_count numCells;</span>
<a href="#l9.1231"></a><span id="l9.1231">   mdbYarn cellYarn;</span>
<a href="#l9.1232"></a><span id="l9.1232">   mdb_column cellColumn;</span>
<a href="#l9.1233"></a><span id="l9.1233">   char columnName[100];</span>
<a href="#l9.1234"></a><span id="l9.1234" class="difflineminus">-  mdbYarn cellName = { columnName, 0, sizeof(columnName), 0, 0, nullptr };</span>
<a href="#l9.1235"></a><span id="l9.1235" class="difflineplus">+  mdbYarn cellName = {columnName, 0, sizeof(columnName), 0, 0, nullptr};</span>
<a href="#l9.1236"></a><span id="l9.1236"> </span>
<a href="#l9.1237"></a><span id="l9.1237">   NS_ASSERTION(m_mdbRow, &quot;null row in getTransferInfo&quot;);</span>
<a href="#l9.1238"></a><span id="l9.1238">   m_mdbRow-&gt;GetCount(m_mdb-&gt;GetEnv(), &amp;numCells);</span>
<a href="#l9.1239"></a><span id="l9.1239" class="difflineminus">-  // iterate over the cells in the dbfolderinfo remembering attribute names and values.</span>
<a href="#l9.1240"></a><span id="l9.1240" class="difflineminus">-  for (mdb_count cellIndex = 0; cellIndex &lt; numCells; cellIndex++)</span>
<a href="#l9.1241"></a><span id="l9.1241" class="difflineminus">-  {</span>
<a href="#l9.1242"></a><span id="l9.1242" class="difflineminus">-    nsresult err = m_mdbRow-&gt;SeekCellYarn(m_mdb-&gt;GetEnv(), cellIndex, &amp;cellColumn, nullptr);</span>
<a href="#l9.1243"></a><span id="l9.1243" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l9.1244"></a><span id="l9.1244" class="difflineminus">-    {</span>
<a href="#l9.1245"></a><span id="l9.1245" class="difflineplus">+  // iterate over the cells in the dbfolderinfo remembering attribute names and</span>
<a href="#l9.1246"></a><span id="l9.1246" class="difflineplus">+  // values.</span>
<a href="#l9.1247"></a><span id="l9.1247" class="difflineplus">+  for (mdb_count cellIndex = 0; cellIndex &lt; numCells; cellIndex++) {</span>
<a href="#l9.1248"></a><span id="l9.1248" class="difflineplus">+    nsresult err = m_mdbRow-&gt;SeekCellYarn(m_mdb-&gt;GetEnv(), cellIndex,</span>
<a href="#l9.1249"></a><span id="l9.1249" class="difflineplus">+                                          &amp;cellColumn, nullptr);</span>
<a href="#l9.1250"></a><span id="l9.1250" class="difflineplus">+    if (NS_SUCCEEDED(err)) {</span>
<a href="#l9.1251"></a><span id="l9.1251">       err = m_mdbRow-&gt;AliasCellYarn(m_mdb-&gt;GetEnv(), cellColumn, &amp;cellYarn);</span>
<a href="#l9.1252"></a><span id="l9.1252" class="difflineminus">-      if (NS_SUCCEEDED(err))</span>
<a href="#l9.1253"></a><span id="l9.1253" class="difflineminus">-      {</span>
<a href="#l9.1254"></a><span id="l9.1254" class="difflineminus">-        m_mdb-&gt;GetStore()-&gt;TokenToString(m_mdb-&gt;GetEnv(), cellColumn, &amp;cellName);</span>
<a href="#l9.1255"></a><span id="l9.1255" class="difflineminus">-        newInfo-&gt;m_values.AppendElement(Substring((const char *)cellYarn.mYarn_Buf,</span>
<a href="#l9.1256"></a><span id="l9.1256" class="difflineminus">-                                        (const char *) cellYarn.mYarn_Buf + cellYarn.mYarn_Fill));</span>
<a href="#l9.1257"></a><span id="l9.1257" class="difflineminus">-        newInfo-&gt;m_properties.AppendElement(Substring((const char *) cellName.mYarn_Buf,</span>
<a href="#l9.1258"></a><span id="l9.1258" class="difflineminus">-                                            (const char *) cellName.mYarn_Buf + cellName.mYarn_Fill));</span>
<a href="#l9.1259"></a><span id="l9.1259" class="difflineplus">+      if (NS_SUCCEEDED(err)) {</span>
<a href="#l9.1260"></a><span id="l9.1260" class="difflineplus">+        m_mdb-&gt;GetStore()-&gt;TokenToString(m_mdb-&gt;GetEnv(), cellColumn,</span>
<a href="#l9.1261"></a><span id="l9.1261" class="difflineplus">+                                         &amp;cellName);</span>
<a href="#l9.1262"></a><span id="l9.1262" class="difflineplus">+        newInfo-&gt;m_values.AppendElement(</span>
<a href="#l9.1263"></a><span id="l9.1263" class="difflineplus">+            Substring((const char *)cellYarn.mYarn_Buf,</span>
<a href="#l9.1264"></a><span id="l9.1264" class="difflineplus">+                      (const char *)cellYarn.mYarn_Buf + cellYarn.mYarn_Fill));</span>
<a href="#l9.1265"></a><span id="l9.1265" class="difflineplus">+        newInfo-&gt;m_properties.AppendElement(</span>
<a href="#l9.1266"></a><span id="l9.1266" class="difflineplus">+            Substring((const char *)cellName.mYarn_Buf,</span>
<a href="#l9.1267"></a><span id="l9.1267" class="difflineplus">+                      (const char *)cellName.mYarn_Buf + cellName.mYarn_Fill));</span>
<a href="#l9.1268"></a><span id="l9.1268">       }</span>
<a href="#l9.1269"></a><span id="l9.1269">     }</span>
<a href="#l9.1270"></a><span id="l9.1270">   }</span>
<a href="#l9.1271"></a><span id="l9.1271"> </span>
<a href="#l9.1272"></a><span id="l9.1272">   return NS_OK;</span>
<a href="#l9.1273"></a><span id="l9.1273"> }</span>
<a href="#l9.1274"></a><span id="l9.1274"> </span>
<a href="#l9.1275"></a><span id="l9.1275" class="difflineminus">-</span>
<a href="#l9.1276"></a><span id="l9.1276"> /* void InitFromTransferInfo (in nsIDBFolderInfo transferInfo); */</span>
<a href="#l9.1277"></a><span id="l9.1277" class="difflineminus">-NS_IMETHODIMP nsDBFolderInfo::InitFromTransferInfo(nsIDBFolderInfo *aTransferInfo)</span>
<a href="#l9.1278"></a><span id="l9.1278" class="difflineminus">-{</span>
<a href="#l9.1279"></a><span id="l9.1279" class="difflineplus">+NS_IMETHODIMP nsDBFolderInfo::InitFromTransferInfo(</span>
<a href="#l9.1280"></a><span id="l9.1280" class="difflineplus">+    nsIDBFolderInfo *aTransferInfo) {</span>
<a href="#l9.1281"></a><span id="l9.1281">   NS_ENSURE_ARG(aTransferInfo);</span>
<a href="#l9.1282"></a><span id="l9.1282"> </span>
<a href="#l9.1283"></a><span id="l9.1283" class="difflineminus">-  nsTransferDBFolderInfo *transferInfo = static_cast&lt;nsTransferDBFolderInfo *&gt;(aTransferInfo);</span>
<a href="#l9.1284"></a><span id="l9.1284" class="difflineplus">+  nsTransferDBFolderInfo *transferInfo =</span>
<a href="#l9.1285"></a><span id="l9.1285" class="difflineplus">+      static_cast&lt;nsTransferDBFolderInfo *&gt;(aTransferInfo);</span>
<a href="#l9.1286"></a><span id="l9.1286"> </span>
<a href="#l9.1287"></a><span id="l9.1287">   for (uint32_t i = 0; i &lt; transferInfo-&gt;m_values.Length(); i++)</span>
<a href="#l9.1288"></a><span id="l9.1288" class="difflineminus">-    SetCharProperty(transferInfo-&gt;m_properties[i].get(), transferInfo-&gt;m_values[i]);</span>
<a href="#l9.1289"></a><span id="l9.1289" class="difflineplus">+    SetCharProperty(transferInfo-&gt;m_properties[i].get(),</span>
<a href="#l9.1290"></a><span id="l9.1290" class="difflineplus">+                    transferInfo-&gt;m_values[i]);</span>
<a href="#l9.1291"></a><span id="l9.1291"> </span>
<a href="#l9.1292"></a><span id="l9.1292">   LoadMemberVariables();</span>
<a href="#l9.1293"></a><span id="l9.1293">   return NS_OK;</span>
<a href="#l9.1294"></a><span id="l9.1294"> }</span>
<a href="#l9.1295"></a><span id="l9.1295" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsImapMailDatabase.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsImapMailDatabase.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -4,235 +4,217 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> #include &lt;sys/stat.h&gt;</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;msgCore.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsImapMailDatabase.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsDBFolderInfo.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-const char *kPendingHdrsScope = &quot;ns:msg:db:row:scope:pending:all&quot;;  // scope for all offine ops table</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+const char *kPendingHdrsScope =</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+    &quot;ns:msg:db:row:scope:pending:all&quot;;  // scope for all offine ops table</span>
<a href="#l10.15"></a><span id="l10.15"> const char *kPendingHdrsTableKind = &quot;ns:msg:db:table:kind:pending&quot;;</span>
<a href="#l10.16"></a><span id="l10.16"> struct mdbOid gAllPendingHdrsTableOID;</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-nsImapMailDatabase::nsImapMailDatabase()</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-{</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-  m_mdbAllPendingHdrsTable = nullptr;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-}</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+nsImapMailDatabase::nsImapMailDatabase() { m_mdbAllPendingHdrsTable = nullptr; }</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+nsImapMailDatabase::~nsImapMailDatabase() {}</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-nsImapMailDatabase::~nsImapMailDatabase()</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-{</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-}</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-NS_IMETHODIMP nsImapMailDatabase::GetSummaryValid(bool *aResult)</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-{</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+NS_IMETHODIMP nsImapMailDatabase::GetSummaryValid(bool *aResult) {</span>
<a href="#l10.33"></a><span id="l10.33">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-  if (m_dbFolderInfo)</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-  {</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+  if (m_dbFolderInfo) {</span>
<a href="#l10.37"></a><span id="l10.37">     uint32_t version;</span>
<a href="#l10.38"></a><span id="l10.38">     m_dbFolderInfo-&gt;GetVersion(&amp;version);</span>
<a href="#l10.39"></a><span id="l10.39">     *aResult = (GetCurVersion() == version);</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-  }</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-  else</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-      *aResult = false;</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+  } else</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+    *aResult = false;</span>
<a href="#l10.45"></a><span id="l10.45"> </span>
<a href="#l10.46"></a><span id="l10.46">   return NS_OK;</span>
<a href="#l10.47"></a><span id="l10.47"> }</span>
<a href="#l10.48"></a><span id="l10.48"> </span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-NS_IMETHODIMP nsImapMailDatabase::SetSummaryValid(bool valid)</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-{</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-  if (m_dbFolderInfo)</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-  {</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+NS_IMETHODIMP nsImapMailDatabase::SetSummaryValid(bool valid) {</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+  if (m_dbFolderInfo) {</span>
<a href="#l10.55"></a><span id="l10.55">     m_dbFolderInfo-&gt;SetVersion(valid ? GetCurVersion() : 0);</span>
<a href="#l10.56"></a><span id="l10.56">     Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l10.57"></a><span id="l10.57">   }</span>
<a href="#l10.58"></a><span id="l10.58">   return NS_OK;</span>
<a href="#l10.59"></a><span id="l10.59"> }</span>
<a href="#l10.60"></a><span id="l10.60"> </span>
<a href="#l10.61"></a><span id="l10.61"> // IMAP does not set local file flags, override does nothing</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-void nsImapMailDatabase::UpdateFolderFlag(nsIMsgDBHdr * /* msgHdr */, bool /* bSet */,</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-                                          nsMsgMessageFlagType /* flag */, nsIOutputStream ** /* ppFileStream */)</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-{</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-}</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+void nsImapMailDatabase::UpdateFolderFlag(</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+    nsIMsgDBHdr * /* msgHdr */, bool /* bSet */,</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+    nsMsgMessageFlagType /* flag */, nsIOutputStream ** /* ppFileStream */) {}</span>
<a href="#l10.69"></a><span id="l10.69"> </span>
<a href="#l10.70"></a><span id="l10.70"> // We override this to avoid our parent class (nsMailDatabase)'s</span>
<a href="#l10.71"></a><span id="l10.71"> // grabbing of the folder semaphore, and bailing on failure.</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-NS_IMETHODIMP nsImapMailDatabase::DeleteMessages(uint32_t aNumKeys, nsMsgKey* nsMsgKeys, nsIDBChangeListener *instigator)</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-{</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+NS_IMETHODIMP nsImapMailDatabase::DeleteMessages(</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+    uint32_t aNumKeys, nsMsgKey *nsMsgKeys, nsIDBChangeListener *instigator) {</span>
<a href="#l10.76"></a><span id="l10.76">   return nsMsgDatabase::DeleteMessages(aNumKeys, nsMsgKeys, instigator);</span>
<a href="#l10.77"></a><span id="l10.77"> }</span>
<a href="#l10.78"></a><span id="l10.78"> </span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-nsresult nsImapMailDatabase::AdjustExpungedBytesOnDelete(nsIMsgDBHdr *msgHdr)</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-{</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+nsresult nsImapMailDatabase::AdjustExpungedBytesOnDelete(nsIMsgDBHdr *msgHdr) {</span>
<a href="#l10.82"></a><span id="l10.82">   uint32_t msgFlags;</span>
<a href="#l10.83"></a><span id="l10.83">   msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-  if (msgFlags &amp; nsMsgMessageFlags::Offline &amp;&amp; m_dbFolderInfo)</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-  {</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+  if (msgFlags &amp; nsMsgMessageFlags::Offline &amp;&amp; m_dbFolderInfo) {</span>
<a href="#l10.87"></a><span id="l10.87">     uint32_t size = 0;</span>
<a href="#l10.88"></a><span id="l10.88">     (void)msgHdr-&gt;GetOfflineMessageSize(&amp;size);</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-    return m_dbFolderInfo-&gt;ChangeExpungedBytes (size);</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+    return m_dbFolderInfo-&gt;ChangeExpungedBytes(size);</span>
<a href="#l10.91"></a><span id="l10.91">   }</span>
<a href="#l10.92"></a><span id="l10.92">   return NS_OK;</span>
<a href="#l10.93"></a><span id="l10.93"> }</span>
<a href="#l10.94"></a><span id="l10.94"> </span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-NS_IMETHODIMP nsImapMailDatabase::ForceClosed()</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-{</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+NS_IMETHODIMP nsImapMailDatabase::ForceClosed() {</span>
<a href="#l10.98"></a><span id="l10.98">   m_mdbAllPendingHdrsTable = nullptr;</span>
<a href="#l10.99"></a><span id="l10.99">   return nsMailDatabase::ForceClosed();</span>
<a href="#l10.100"></a><span id="l10.100"> }</span>
<a href="#l10.101"></a><span id="l10.101"> </span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-nsresult nsImapMailDatabase::GetAllPendingHdrsTable()</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-{</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+nsresult nsImapMailDatabase::GetAllPendingHdrsTable() {</span>
<a href="#l10.105"></a><span id="l10.105">   nsresult rv = NS_OK;</span>
<a href="#l10.106"></a><span id="l10.106">   if (!m_mdbAllPendingHdrsTable)</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-    rv = GetTableCreateIfMissing(kPendingHdrsScope, kPendingHdrsTableKind, getter_AddRefs(m_mdbAllPendingHdrsTable),</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-                                                m_pendingHdrsRowScopeToken, m_pendingHdrsTableKindToken) ;</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+    rv = GetTableCreateIfMissing(kPendingHdrsScope, kPendingHdrsTableKind,</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+                                 getter_AddRefs(m_mdbAllPendingHdrsTable),</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+                                 m_pendingHdrsRowScopeToken,</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+                                 m_pendingHdrsTableKindToken);</span>
<a href="#l10.113"></a><span id="l10.113">   return rv;</span>
<a href="#l10.114"></a><span id="l10.114"> }</span>
<a href="#l10.115"></a><span id="l10.115"> </span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-NS_IMETHODIMP nsImapMailDatabase::AddNewHdrToDB(nsIMsgDBHdr *newHdr, bool notify)</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineminus">-{</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+NS_IMETHODIMP nsImapMailDatabase::AddNewHdrToDB(nsIMsgDBHdr *newHdr,</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+                                                bool notify) {</span>
<a href="#l10.120"></a><span id="l10.120">   nsresult rv = nsMsgDatabase::AddNewHdrToDB(newHdr, notify);</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-    rv = UpdatePendingAttributes(newHdr);</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = UpdatePendingAttributes(newHdr);</span>
<a href="#l10.124"></a><span id="l10.124">   return rv;</span>
<a href="#l10.125"></a><span id="l10.125"> }</span>
<a href="#l10.126"></a><span id="l10.126"> </span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-NS_IMETHODIMP nsImapMailDatabase::UpdatePendingAttributes(nsIMsgDBHdr* aNewHdr)</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-{</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+NS_IMETHODIMP nsImapMailDatabase::UpdatePendingAttributes(</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+    nsIMsgDBHdr *aNewHdr) {</span>
<a href="#l10.131"></a><span id="l10.131">   nsresult rv = GetAllPendingHdrsTable();</span>
<a href="#l10.132"></a><span id="l10.132">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.133"></a><span id="l10.133">   mdb_count numPendingHdrs = 0;</span>
<a href="#l10.134"></a><span id="l10.134">   m_mdbAllPendingHdrsTable-&gt;GetCount(GetEnv(), &amp;numPendingHdrs);</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineminus">-  if (numPendingHdrs &gt; 0)</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineminus">-  {</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+  if (numPendingHdrs &gt; 0) {</span>
<a href="#l10.138"></a><span id="l10.138">     mdbYarn messageIdYarn;</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-    nsCOMPtr &lt;nsIMdbRow&gt; pendingRow;</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineminus">-    mdbOid  outRowId;</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+    nsCOMPtr&lt;nsIMdbRow&gt; pendingRow;</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+    mdbOid outRowId;</span>
<a href="#l10.143"></a><span id="l10.143"> </span>
<a href="#l10.144"></a><span id="l10.144">     nsCString messageId;</span>
<a href="#l10.145"></a><span id="l10.145">     aNewHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-    messageIdYarn.mYarn_Buf = (void*)messageId.get();</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+    messageIdYarn.mYarn_Buf = (void *)messageId.get();</span>
<a href="#l10.148"></a><span id="l10.148">     messageIdYarn.mYarn_Fill = messageId.Length();</span>
<a href="#l10.149"></a><span id="l10.149">     messageIdYarn.mYarn_Form = 0;</span>
<a href="#l10.150"></a><span id="l10.150">     messageIdYarn.mYarn_Size = messageIdYarn.mYarn_Fill;</span>
<a href="#l10.151"></a><span id="l10.151"> </span>
<a href="#l10.152"></a><span id="l10.152">     m_mdbStore-&gt;FindRow(GetEnv(), m_pendingHdrsRowScopeToken,</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineminus">-              m_messageIdColumnToken, &amp;messageIdYarn, &amp;outRowId, getter_AddRefs(pendingRow));</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineminus">-    if (pendingRow)</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineminus">-    {</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+                        m_messageIdColumnToken, &amp;messageIdYarn, &amp;outRowId,</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+                        getter_AddRefs(pendingRow));</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+    if (pendingRow) {</span>
<a href="#l10.159"></a><span id="l10.159">       mdb_count numCells;</span>
<a href="#l10.160"></a><span id="l10.160">       mdbYarn cellYarn;</span>
<a href="#l10.161"></a><span id="l10.161">       mdb_column cellColumn;</span>
<a href="#l10.162"></a><span id="l10.162">       uint32_t existingFlags;</span>
<a href="#l10.163"></a><span id="l10.163"> </span>
<a href="#l10.164"></a><span id="l10.164">       pendingRow-&gt;GetCount(GetEnv(), &amp;numCells);</span>
<a href="#l10.165"></a><span id="l10.165">       aNewHdr-&gt;GetFlags(&amp;existingFlags);</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineminus">-      // iterate over the cells in the pending hdr setting properties on the aNewHdr.</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineminus">-      // we skip cell 0, which is the messageId;</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineminus">-      nsMsgHdr* msgHdr = static_cast&lt;nsMsgHdr*&gt;(aNewHdr);      // closed system, cast ok</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+      // iterate over the cells in the pending hdr setting properties on the</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+      // aNewHdr. we skip cell 0, which is the messageId;</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+      nsMsgHdr *msgHdr =</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+          static_cast&lt;nsMsgHdr *&gt;(aNewHdr);  // closed system, cast ok</span>
<a href="#l10.173"></a><span id="l10.173">       nsIMdbRow *row = msgHdr-&gt;GetMDBRow();</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineminus">-      for (mdb_count cellIndex = 1; cellIndex &lt; numCells; cellIndex++)</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineminus">-      {</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineminus">-        nsresult err = pendingRow-&gt;SeekCellYarn(GetEnv(), cellIndex, &amp;cellColumn, nullptr);</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineminus">-        if (NS_SUCCEEDED(err))</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineminus">-        {</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+      for (mdb_count cellIndex = 1; cellIndex &lt; numCells; cellIndex++) {</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+        nsresult err =</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+            pendingRow-&gt;SeekCellYarn(GetEnv(), cellIndex, &amp;cellColumn, nullptr);</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+        if (NS_SUCCEEDED(err)) {</span>
<a href="#l10.183"></a><span id="l10.183">           err = pendingRow-&gt;AliasCellYarn(GetEnv(), cellColumn, &amp;cellYarn);</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineminus">-          if (NS_SUCCEEDED(err))</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineminus">-          {</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineminus">-            if (row)</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineminus">-              row-&gt;AddColumn(GetEnv(), cellColumn, &amp;cellYarn);</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineplus">+          if (NS_SUCCEEDED(err)) {</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineplus">+            if (row) row-&gt;AddColumn(GetEnv(), cellColumn, &amp;cellYarn);</span>
<a href="#l10.190"></a><span id="l10.190">           }</span>
<a href="#l10.191"></a><span id="l10.191">         }</span>
<a href="#l10.192"></a><span id="l10.192">       }</span>
<a href="#l10.193"></a><span id="l10.193">       // We might have changed some cached values, so force a refresh.</span>
<a href="#l10.194"></a><span id="l10.194">       msgHdr-&gt;ClearCachedValues();</span>
<a href="#l10.195"></a><span id="l10.195">       uint32_t resultFlags;</span>
<a href="#l10.196"></a><span id="l10.196">       msgHdr-&gt;OrFlags(existingFlags, &amp;resultFlags);</span>
<a href="#l10.197"></a><span id="l10.197">       m_mdbAllPendingHdrsTable-&gt;CutRow(GetEnv(), pendingRow);</span>
<a href="#l10.198"></a><span id="l10.198">       pendingRow-&gt;CutAllColumns(GetEnv());</span>
<a href="#l10.199"></a><span id="l10.199">     }</span>
<a href="#l10.200"></a><span id="l10.200">   }</span>
<a href="#l10.201"></a><span id="l10.201">   return rv;</span>
<a href="#l10.202"></a><span id="l10.202"> }</span>
<a href="#l10.203"></a><span id="l10.203"> </span>
<a href="#l10.204"></a><span id="l10.204"> nsresult nsImapMailDatabase::GetRowForPendingHdr(nsIMsgDBHdr *pendingHdr,</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineminus">-                                                 nsIMdbRow **row)</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineminus">-{</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineplus">+                                                 nsIMdbRow **row) {</span>
<a href="#l10.208"></a><span id="l10.208">   nsresult rv = GetAllPendingHdrsTable();</span>
<a href="#l10.209"></a><span id="l10.209">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.210"></a><span id="l10.210"> </span>
<a href="#l10.211"></a><span id="l10.211">   mdbYarn messageIdYarn;</span>
<a href="#l10.212"></a><span id="l10.212">   nsCOMPtr&lt;nsIMdbRow&gt; pendingRow;</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineminus">-  mdbOid  outRowId;</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineplus">+  mdbOid outRowId;</span>
<a href="#l10.215"></a><span id="l10.215">   nsCString messageId;</span>
<a href="#l10.216"></a><span id="l10.216">   pendingHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineminus">-  messageIdYarn.mYarn_Buf = (void*)messageId.get();</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+  messageIdYarn.mYarn_Buf = (void *)messageId.get();</span>
<a href="#l10.219"></a><span id="l10.219">   messageIdYarn.mYarn_Fill = messageId.Length();</span>
<a href="#l10.220"></a><span id="l10.220">   messageIdYarn.mYarn_Form = 0;</span>
<a href="#l10.221"></a><span id="l10.221">   messageIdYarn.mYarn_Size = messageIdYarn.mYarn_Fill;</span>
<a href="#l10.222"></a><span id="l10.222"> </span>
<a href="#l10.223"></a><span id="l10.223">   rv = m_mdbStore-&gt;FindRow(GetEnv(), m_pendingHdrsRowScopeToken,</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineminus">-            m_messageIdColumnToken, &amp;messageIdYarn, &amp;outRowId, getter_AddRefs(pendingRow));</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineplus">+                           m_messageIdColumnToken, &amp;messageIdYarn, &amp;outRowId,</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineplus">+                           getter_AddRefs(pendingRow));</span>
<a href="#l10.227"></a><span id="l10.227"> </span>
<a href="#l10.228"></a><span id="l10.228">   if (!pendingRow)</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineminus">-    rv  = m_mdbStore-&gt;NewRow(GetEnv(), m_pendingHdrsRowScopeToken, getter_AddRefs(pendingRow));</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineplus">+    rv = m_mdbStore-&gt;NewRow(GetEnv(), m_pendingHdrsRowScopeToken,</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineplus">+                            getter_AddRefs(pendingRow));</span>
<a href="#l10.232"></a><span id="l10.232"> </span>
<a href="#l10.233"></a><span id="l10.233">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineminus">-  if (pendingRow)</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineminus">-  {</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineminus">-    // now we need to add cells to the row to remember the messageid, property and property value, and flags.</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineminus">-    // Then, when hdrs are added to the db, we'll check if they have a matching message-id, and if so,</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineminus">-    // set the property and flags</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineminus">-    // XXX we already fetched messageId from the pending hdr, could it have changed by the time we get here?</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineplus">+  if (pendingRow) {</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineplus">+    // now we need to add cells to the row to remember the messageid, property</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineplus">+    // and property value, and flags. Then, when hdrs are added to the db, we'll</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineplus">+    // check if they have a matching message-id, and if so, set the property and</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+    // flags</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineplus">+    // XXX we already fetched messageId from the pending hdr, could it have</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineplus">+    // changed by the time we get here?</span>
<a href="#l10.247"></a><span id="l10.247">     nsCString messageId;</span>
<a href="#l10.248"></a><span id="l10.248">     pendingHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineminus">-    // we're just going to ignore messages without a message-id. They should be rare. If SPAM messages often</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineminus">-    // didn't have message-id's, they'd be filtered on the server, most likely, and spammers would then</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineminus">-    // start putting in message-id's.</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineminus">-    if (!messageId.IsEmpty())</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineminus">-    {</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineminus">-       extern const char *kMessageIdColumnName;</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineminus">-       m_mdbAllPendingHdrsTable-&gt;AddRow(GetEnv(), pendingRow);</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineminus">-       // make sure this is the first cell so that when we ignore the first</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineminus">-       // cell in nsImapMailDatabase::AddNewHdrToDB, we're ignoring the right one</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineminus">-      (void) SetProperty(pendingRow, kMessageIdColumnName, messageId.get());</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineplus">+    // we're just going to ignore messages without a message-id. They should be</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineplus">+    // rare. If SPAM messages often didn't have message-id's, they'd be filtered</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineplus">+    // on the server, most likely, and spammers would then start putting in</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineplus">+    // message-id's.</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineplus">+    if (!messageId.IsEmpty()) {</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineplus">+      extern const char *kMessageIdColumnName;</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineplus">+      m_mdbAllPendingHdrsTable-&gt;AddRow(GetEnv(), pendingRow);</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineplus">+      // make sure this is the first cell so that when we ignore the first</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+      // cell in nsImapMailDatabase::AddNewHdrToDB, we're ignoring the right one</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineplus">+      (void)SetProperty(pendingRow, kMessageIdColumnName, messageId.get());</span>
<a href="#l10.269"></a><span id="l10.269">       pendingRow.forget(row);</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineminus">-    }</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineminus">-    else</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineplus">+    } else</span>
<a href="#l10.273"></a><span id="l10.273">       return NS_ERROR_FAILURE;</span>
<a href="#l10.274"></a><span id="l10.274">   }</span>
<a href="#l10.275"></a><span id="l10.275">   return rv;</span>
<a href="#l10.276"></a><span id="l10.276"> }</span>
<a href="#l10.277"></a><span id="l10.277"> </span>
<a href="#l10.278"></a><span id="l10.278" class="difflineminus">-NS_IMETHODIMP nsImapMailDatabase::SetAttributeOnPendingHdr(nsIMsgDBHdr *pendingHdr, const char *property,</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineminus">-                                  const char *propertyVal)</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineminus">-{</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+NS_IMETHODIMP nsImapMailDatabase::SetAttributeOnPendingHdr(</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+    nsIMsgDBHdr *pendingHdr, const char *property, const char *propertyVal) {</span>
<a href="#l10.283"></a><span id="l10.283">   NS_ENSURE_ARG_POINTER(pendingHdr);</span>
<a href="#l10.284"></a><span id="l10.284">   nsCOMPtr&lt;nsIMdbRow&gt; pendingRow;</span>
<a href="#l10.285"></a><span id="l10.285">   nsresult rv = GetRowForPendingHdr(pendingHdr, getter_AddRefs(pendingRow));</span>
<a href="#l10.286"></a><span id="l10.286">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.287"></a><span id="l10.287">   return SetProperty(pendingRow, property, propertyVal);</span>
<a href="#l10.288"></a><span id="l10.288"> }</span>
<a href="#l10.289"></a><span id="l10.289"> </span>
<a href="#l10.290"></a><span id="l10.290"> NS_IMETHODIMP</span>
<a href="#l10.291"></a><span id="l10.291"> nsImapMailDatabase::SetUint32AttributeOnPendingHdr(nsIMsgDBHdr *pendingHdr,</span>
<a href="#l10.292"></a><span id="l10.292">                                                    const char *property,</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineminus">-                                                   uint32_t propertyVal)</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineminus">-{</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineplus">+                                                   uint32_t propertyVal) {</span>
<a href="#l10.296"></a><span id="l10.296">   NS_ENSURE_ARG_POINTER(pendingHdr);</span>
<a href="#l10.297"></a><span id="l10.297">   nsCOMPtr&lt;nsIMdbRow&gt; pendingRow;</span>
<a href="#l10.298"></a><span id="l10.298">   nsresult rv = GetRowForPendingHdr(pendingHdr, getter_AddRefs(pendingRow));</span>
<a href="#l10.299"></a><span id="l10.299">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.300"></a><span id="l10.300">   return SetUint32Property(pendingRow, property, propertyVal);</span>
<a href="#l10.301"></a><span id="l10.301"> }</span>
<a href="#l10.302"></a><span id="l10.302"> </span>
<a href="#l10.303"></a><span id="l10.303"> NS_IMETHODIMP</span>
<a href="#l10.304"></a><span id="l10.304"> nsImapMailDatabase::SetUint64AttributeOnPendingHdr(nsIMsgDBHdr *aPendingHdr,</span>
<a href="#l10.305"></a><span id="l10.305">                                                    const char *aProperty,</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineminus">-                                                   uint64_t aPropertyVal)</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineminus">-{</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineplus">+                                                   uint64_t aPropertyVal) {</span>
<a href="#l10.309"></a><span id="l10.309">   NS_ENSURE_ARG_POINTER(aPendingHdr);</span>
<a href="#l10.310"></a><span id="l10.310">   nsCOMPtr&lt;nsIMdbRow&gt; pendingRow;</span>
<a href="#l10.311"></a><span id="l10.311">   nsresult rv = GetRowForPendingHdr(aPendingHdr, getter_AddRefs(pendingRow));</span>
<a href="#l10.312"></a><span id="l10.312">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.313"></a><span id="l10.313">   return SetUint64Property(pendingRow, aProperty, aPropertyVal);</span>
<a href="#l10.314"></a><span id="l10.314"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMailDatabase.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMailDatabase.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -13,93 +13,85 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;prprf.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsSimpleEnumerator.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10"> using namespace mozilla;</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-extern LazyLogModule IMAPOffline; // defined in nsMsgOfflineImapOperation.cpp</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+extern LazyLogModule IMAPOffline;  // defined in nsMsgOfflineImapOperation.cpp</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15"> // scope for all offine ops table</span>
<a href="#l11.16"></a><span id="l11.16"> const char *kOfflineOpsScope = &quot;ns:msg:db:row:scope:ops:all&quot;;</span>
<a href="#l11.17"></a><span id="l11.17"> const char *kOfflineOpsTableKind = &quot;ns:msg:db:table:kind:ops&quot;;</span>
<a href="#l11.18"></a><span id="l11.18"> struct mdbOid gAllOfflineOpsTableOID;</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-nsMailDatabase::nsMailDatabase() : m_reparse(false)</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-{</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+nsMailDatabase::nsMailDatabase() : m_reparse(false) {</span>
<a href="#l11.23"></a><span id="l11.23">   m_mdbAllOfflineOpsTable = nullptr;</span>
<a href="#l11.24"></a><span id="l11.24">   m_offlineOpsRowScopeToken = 0;</span>
<a href="#l11.25"></a><span id="l11.25">   m_offlineOpsTableKindToken = 0;</span>
<a href="#l11.26"></a><span id="l11.26"> }</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-nsMailDatabase::~nsMailDatabase()</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-{</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-}</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+nsMailDatabase::~nsMailDatabase() {}</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-// caller passes in upgrading==true if they want back a db even if the db is out of date.</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-// If so, they'll extract out the interesting info from the db, close it, delete it, and</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-// then try to open the db again, prior to reparsing.</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-nsresult nsMailDatabase::Open(nsMsgDBService* aDBService, nsIFile *aSummaryFile,</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-                              bool aCreate, bool aUpgrading)</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-{</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+// caller passes in upgrading==true if they want back a db even if the db is out</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+// of date. If so, they'll extract out the interesting info from the db, close</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+// it, delete it, and then try to open the db again, prior to reparsing.</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+nsresult nsMailDatabase::Open(nsMsgDBService *aDBService, nsIFile *aSummaryFile,</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+                              bool aCreate, bool aUpgrading) {</span>
<a href="#l11.44"></a><span id="l11.44"> #ifdef DEBUG</span>
<a href="#l11.45"></a><span id="l11.45">   nsString leafName;</span>
<a href="#l11.46"></a><span id="l11.46">   aSummaryFile-&gt;GetLeafName(leafName);</span>
<a href="#l11.47"></a><span id="l11.47">   if (!StringEndsWith(leafName, NS_LITERAL_STRING(SUMMARY_SUFFIX),</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-                     nsCaseInsensitiveStringComparator()))</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+                      nsCaseInsensitiveStringComparator()))</span>
<a href="#l11.50"></a><span id="l11.50">     NS_ERROR(&quot;non summary file passed into open\n&quot;);</span>
<a href="#l11.51"></a><span id="l11.51"> #endif</span>
<a href="#l11.52"></a><span id="l11.52">   return nsMsgDatabase::Open(aDBService, aSummaryFile, aCreate, aUpgrading);</span>
<a href="#l11.53"></a><span id="l11.53"> }</span>
<a href="#l11.54"></a><span id="l11.54"> </span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-NS_IMETHODIMP nsMailDatabase::ForceClosed()</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-{</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+NS_IMETHODIMP nsMailDatabase::ForceClosed() {</span>
<a href="#l11.58"></a><span id="l11.58">   m_mdbAllOfflineOpsTable = nullptr;</span>
<a href="#l11.59"></a><span id="l11.59">   return nsMsgDatabase::ForceClosed();</span>
<a href="#l11.60"></a><span id="l11.60"> }</span>
<a href="#l11.61"></a><span id="l11.61"> </span>
<a href="#l11.62"></a><span id="l11.62"> // get this on demand so that only db's that have offline ops will</span>
<a href="#l11.63"></a><span id="l11.63"> // create the table.</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-nsresult nsMailDatabase::GetAllOfflineOpsTable()</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-{</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+nsresult nsMailDatabase::GetAllOfflineOpsTable() {</span>
<a href="#l11.67"></a><span id="l11.67">   nsresult rv = NS_OK;</span>
<a href="#l11.68"></a><span id="l11.68">   if (!m_mdbAllOfflineOpsTable)</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-    rv = GetTableCreateIfMissing(kOfflineOpsScope, kOfflineOpsTableKind, getter_AddRefs(m_mdbAllOfflineOpsTable),</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-                                                m_offlineOpsRowScopeToken, m_offlineOpsTableKindToken) ;</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+    rv = GetTableCreateIfMissing(kOfflineOpsScope, kOfflineOpsTableKind,</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+                                 getter_AddRefs(m_mdbAllOfflineOpsTable),</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+                                 m_offlineOpsRowScopeToken,</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+                                 m_offlineOpsTableKindToken);</span>
<a href="#l11.75"></a><span id="l11.75">   return rv;</span>
<a href="#l11.76"></a><span id="l11.76"> }</span>
<a href="#l11.77"></a><span id="l11.77"> </span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-NS_IMETHODIMP nsMailDatabase::DeleteMessages(uint32_t aNumKeys, nsMsgKey* nsMsgKeys, nsIDBChangeListener *instigator)</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-{</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+NS_IMETHODIMP nsMailDatabase::DeleteMessages(uint32_t aNumKeys,</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+                                             nsMsgKey *nsMsgKeys,</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+                                             nsIDBChangeListener *instigator) {</span>
<a href="#l11.84"></a><span id="l11.84">   nsresult rv;</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-  if (m_folder)</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-  {</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+  if (m_folder) {</span>
<a href="#l11.88"></a><span id="l11.88">     bool isLocked;</span>
<a href="#l11.89"></a><span id="l11.89">     m_folder-&gt;GetLocked(&amp;isLocked);</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-    if (isLocked)</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-    {</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+    if (isLocked) {</span>
<a href="#l11.93"></a><span id="l11.93">       NS_ASSERTION(false, &quot;Some other operation is in progress&quot;);</span>
<a href="#l11.94"></a><span id="l11.94">       return NS_MSG_FOLDER_BUSY;</span>
<a href="#l11.95"></a><span id="l11.95">     }</span>
<a href="#l11.96"></a><span id="l11.96">   }</span>
<a href="#l11.97"></a><span id="l11.97"> </span>
<a href="#l11.98"></a><span id="l11.98">   rv = nsMsgDatabase::DeleteMessages(aNumKeys, nsMsgKeys, instigator);</span>
<a href="#l11.99"></a><span id="l11.99">   SetSummaryValid(true);</span>
<a href="#l11.100"></a><span id="l11.100">   return rv;</span>
<a href="#l11.101"></a><span id="l11.101"> }</span>
<a href="#l11.102"></a><span id="l11.102"> </span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-NS_IMETHODIMP nsMailDatabase::GetSummaryValid(bool *aResult)</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-{</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+NS_IMETHODIMP nsMailDatabase::GetSummaryValid(bool *aResult) {</span>
<a href="#l11.106"></a><span id="l11.106">   uint32_t version;</span>
<a href="#l11.107"></a><span id="l11.107">   m_dbFolderInfo-&gt;GetVersion(&amp;version);</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-  if (GetCurVersion() != version)</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-  {</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+  if (GetCurVersion() != version) {</span>
<a href="#l11.111"></a><span id="l11.111">     *aResult = false;</span>
<a href="#l11.112"></a><span id="l11.112">     return NS_OK;</span>
<a href="#l11.113"></a><span id="l11.113">   }</span>
<a href="#l11.114"></a><span id="l11.114">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l11.115"></a><span id="l11.115">   if (!m_folder) {</span>
<a href="#l11.116"></a><span id="l11.116">     // If the folder is not set, we just return without checking the validity</span>
<a href="#l11.117"></a><span id="l11.117">     // of the summary file. For now, this is an expected condition when the</span>
<a href="#l11.118"></a><span id="l11.118">     // message database is being opened from a URL in</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineat">@@ -110,315 +102,280 @@ NS_IMETHODIMP nsMailDatabase::GetSummary</span>
<a href="#l11.120"></a><span id="l11.120">     *aResult = true;</span>
<a href="#l11.121"></a><span id="l11.121">     return NS_OK;</span>
<a href="#l11.122"></a><span id="l11.122">   }</span>
<a href="#l11.123"></a><span id="l11.123">   nsresult rv = m_folder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l11.124"></a><span id="l11.124">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.125"></a><span id="l11.125">   return msgStore-&gt;IsSummaryFileValid(m_folder, this, aResult);</span>
<a href="#l11.126"></a><span id="l11.126"> }</span>
<a href="#l11.127"></a><span id="l11.127"> </span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-NS_IMETHODIMP nsMailDatabase::SetSummaryValid(bool aValid)</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-{</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+NS_IMETHODIMP nsMailDatabase::SetSummaryValid(bool aValid) {</span>
<a href="#l11.131"></a><span id="l11.131">   nsMsgDatabase::SetSummaryValid(aValid);</span>
<a href="#l11.132"></a><span id="l11.132"> </span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">-  if (!m_folder)</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+  if (!m_folder) return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.136"></a><span id="l11.136"> </span>
<a href="#l11.137"></a><span id="l11.137">   // If this is a virtual folder, there is no storage.</span>
<a href="#l11.138"></a><span id="l11.138">   bool flag;</span>
<a href="#l11.139"></a><span id="l11.139">   m_folder-&gt;GetFlag(nsMsgFolderFlags::Virtual, &amp;flag);</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">-  if (flag)</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+  if (flag) return NS_OK;</span>
<a href="#l11.143"></a><span id="l11.143"> </span>
<a href="#l11.144"></a><span id="l11.144">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l11.145"></a><span id="l11.145">   nsresult rv = m_folder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l11.146"></a><span id="l11.146">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.147"></a><span id="l11.147">   return msgStore-&gt;SetSummaryFileValid(m_folder, this, aValid);</span>
<a href="#l11.148"></a><span id="l11.148"> }</span>
<a href="#l11.149"></a><span id="l11.149"> </span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-NS_IMETHODIMP  nsMailDatabase::RemoveOfflineOp(nsIMsgOfflineImapOperation *op)</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineminus">-{</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineminus">-</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+NS_IMETHODIMP nsMailDatabase::RemoveOfflineOp(nsIMsgOfflineImapOperation *op) {</span>
<a href="#l11.154"></a><span id="l11.154">   nsresult rv = GetAllOfflineOpsTable();</span>
<a href="#l11.155"></a><span id="l11.155">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.156"></a><span id="l11.156"> </span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-  if (!op || !m_mdbAllOfflineOpsTable)</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineminus">-  nsMsgOfflineImapOperation* offlineOp = static_cast&lt;nsMsgOfflineImapOperation*&gt;(op);  // closed system, so this is ok</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-  nsIMdbRow* row = offlineOp-&gt;GetMDBRow();</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+  if (!op || !m_mdbAllOfflineOpsTable) return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+  nsMsgOfflineImapOperation *offlineOp =</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+      static_cast&lt;nsMsgOfflineImapOperation *&gt;(</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+          op);  // closed system, so this is ok</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+  nsIMdbRow *row = offlineOp-&gt;GetMDBRow();</span>
<a href="#l11.166"></a><span id="l11.166">   rv = m_mdbAllOfflineOpsTable-&gt;CutRow(GetEnv(), row);</span>
<a href="#l11.167"></a><span id="l11.167">   row-&gt;CutAllColumns(GetEnv());</span>
<a href="#l11.168"></a><span id="l11.168">   return rv;</span>
<a href="#l11.169"></a><span id="l11.169"> }</span>
<a href="#l11.170"></a><span id="l11.170"> </span>
<a href="#l11.171"></a><span id="l11.171" class="difflineminus">-NS_IMETHODIMP nsMailDatabase::GetOfflineOpForKey(nsMsgKey msgKey, bool create, nsIMsgOfflineImapOperation **offlineOp)</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineminus">-{</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+NS_IMETHODIMP nsMailDatabase::GetOfflineOpForKey(</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+    nsMsgKey msgKey, bool create, nsIMsgOfflineImapOperation **offlineOp) {</span>
<a href="#l11.175"></a><span id="l11.175">   mdb_bool hasOid;</span>
<a href="#l11.176"></a><span id="l11.176">   mdbOid rowObjectId;</span>
<a href="#l11.177"></a><span id="l11.177">   nsresult err;</span>
<a href="#l11.178"></a><span id="l11.178"> </span>
<a href="#l11.179"></a><span id="l11.179">   nsresult rv = GetAllOfflineOpsTable();</span>
<a href="#l11.180"></a><span id="l11.180">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.181"></a><span id="l11.181"> </span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">-  if (!offlineOp || !m_mdbAllOfflineOpsTable)</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+  if (!offlineOp || !m_mdbAllOfflineOpsTable) return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.185"></a><span id="l11.185"> </span>
<a href="#l11.186"></a><span id="l11.186">   *offlineOp = NULL;</span>
<a href="#l11.187"></a><span id="l11.187"> </span>
<a href="#l11.188"></a><span id="l11.188">   rowObjectId.mOid_Id = msgKey;</span>
<a href="#l11.189"></a><span id="l11.189">   rowObjectId.mOid_Scope = m_offlineOpsRowScopeToken;</span>
<a href="#l11.190"></a><span id="l11.190">   err = m_mdbAllOfflineOpsTable-&gt;HasOid(GetEnv(), &amp;rowObjectId, &amp;hasOid);</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; m_mdbStore &amp;&amp; (hasOid  || create))</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-  {</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-    nsCOMPtr &lt;nsIMdbRow&gt; offlineOpRow;</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineminus">-    err = m_mdbStore-&gt;GetRow(GetEnv(), &amp;rowObjectId, getter_AddRefs(offlineOpRow));</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; m_mdbStore &amp;&amp; (hasOid || create)) {</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+    nsCOMPtr&lt;nsIMdbRow&gt; offlineOpRow;</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+    err = m_mdbStore-&gt;GetRow(GetEnv(), &amp;rowObjectId,</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineplus">+                             getter_AddRefs(offlineOpRow));</span>
<a href="#l11.199"></a><span id="l11.199"> </span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-    if (create)</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineminus">-    {</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-      if (!offlineOpRow)</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-      {</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineminus">-        err  = m_mdbStore-&gt;NewRowWithOid(GetEnv(), &amp;rowObjectId, getter_AddRefs(offlineOpRow));</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+    if (create) {</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+      if (!offlineOpRow) {</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+        err = m_mdbStore-&gt;NewRowWithOid(GetEnv(), &amp;rowObjectId,</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+                                        getter_AddRefs(offlineOpRow));</span>
<a href="#l11.209"></a><span id="l11.209">         NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l11.210"></a><span id="l11.210">       }</span>
<a href="#l11.211"></a><span id="l11.211">       if (offlineOpRow &amp;&amp; !hasOid)</span>
<a href="#l11.212"></a><span id="l11.212">         m_mdbAllOfflineOpsTable-&gt;AddRow(GetEnv(), offlineOpRow);</span>
<a href="#l11.213"></a><span id="l11.213">     }</span>
<a href="#l11.214"></a><span id="l11.214"> </span>
<a href="#l11.215"></a><span id="l11.215" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; offlineOpRow)</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineminus">-    {</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineminus">-      NS_IF_ADDREF(*offlineOp = new nsMsgOfflineImapOperation(this, offlineOpRow));</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+    if (NS_SUCCEEDED(err) &amp;&amp; offlineOpRow) {</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+      NS_IF_ADDREF(*offlineOp =</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+                       new nsMsgOfflineImapOperation(this, offlineOpRow));</span>
<a href="#l11.221"></a><span id="l11.221">       (*offlineOp)-&gt;SetMessageKey(msgKey);</span>
<a href="#l11.222"></a><span id="l11.222">     }</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineminus">-    if (!hasOid &amp;&amp; m_dbFolderInfo)</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineminus">-    {</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+    if (!hasOid &amp;&amp; m_dbFolderInfo) {</span>
<a href="#l11.226"></a><span id="l11.226">       // set initial value for flags so we don't lose them.</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l11.229"></a><span id="l11.229">       GetMsgHdrForKey(msgKey, getter_AddRefs(msgHdr));</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-      if (msgHdr)</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineminus">-      {</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineplus">+      if (msgHdr) {</span>
<a href="#l11.233"></a><span id="l11.233">         uint32_t flags;</span>
<a href="#l11.234"></a><span id="l11.234">         msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l11.235"></a><span id="l11.235">         (*offlineOp)-&gt;SetNewFlags(flags);</span>
<a href="#l11.236"></a><span id="l11.236">       }</span>
<a href="#l11.237"></a><span id="l11.237">       int32_t newFlags;</span>
<a href="#l11.238"></a><span id="l11.238">       m_dbFolderInfo-&gt;OrFlags(nsMsgFolderFlags::OfflineEvents, &amp;newFlags);</span>
<a href="#l11.239"></a><span id="l11.239">     }</span>
<a href="#l11.240"></a><span id="l11.240">   }</span>
<a href="#l11.241"></a><span id="l11.241"> </span>
<a href="#l11.242"></a><span id="l11.242">   return err;</span>
<a href="#l11.243"></a><span id="l11.243"> }</span>
<a href="#l11.244"></a><span id="l11.244"> </span>
<a href="#l11.245"></a><span id="l11.245" class="difflineminus">-NS_IMETHODIMP nsMailDatabase::EnumerateOfflineOps(nsISimpleEnumerator **enumerator)</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineminus">-{</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+NS_IMETHODIMP nsMailDatabase::EnumerateOfflineOps(</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+    nsISimpleEnumerator **enumerator) {</span>
<a href="#l11.249"></a><span id="l11.249">   NS_ASSERTION(false, &quot;not impl yet&quot;);</span>
<a href="#l11.250"></a><span id="l11.250">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l11.251"></a><span id="l11.251"> }</span>
<a href="#l11.252"></a><span id="l11.252"> </span>
<a href="#l11.253"></a><span id="l11.253" class="difflineminus">-</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineminus">-NS_IMETHODIMP nsMailDatabase::ListAllOfflineOpIds(nsTArray&lt;nsMsgKey&gt; *offlineOpIds)</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineminus">-{</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+NS_IMETHODIMP nsMailDatabase::ListAllOfflineOpIds(</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineplus">+    nsTArray&lt;nsMsgKey&gt; *offlineOpIds) {</span>
<a href="#l11.258"></a><span id="l11.258">   NS_ENSURE_ARG(offlineOpIds);</span>
<a href="#l11.259"></a><span id="l11.259">   nsresult rv = GetAllOfflineOpsTable();</span>
<a href="#l11.260"></a><span id="l11.260">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.261"></a><span id="l11.261">   nsIMdbTableRowCursor *rowCursor;</span>
<a href="#l11.262"></a><span id="l11.262"> </span>
<a href="#l11.263"></a><span id="l11.263" class="difflineminus">-  if (m_mdbAllOfflineOpsTable)</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineminus">-  {</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineminus">-    nsresult err = m_mdbAllOfflineOpsTable-&gt;GetTableRowCursor(GetEnv(), -1, &amp;rowCursor);</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineminus">-    while (NS_SUCCEEDED(err) &amp;&amp; rowCursor)</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineminus">-    {</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+  if (m_mdbAllOfflineOpsTable) {</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineplus">+    nsresult err =</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineplus">+        m_mdbAllOfflineOpsTable-&gt;GetTableRowCursor(GetEnv(), -1, &amp;rowCursor);</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineplus">+    while (NS_SUCCEEDED(err) &amp;&amp; rowCursor) {</span>
<a href="#l11.272"></a><span id="l11.272">       mdbOid outOid;</span>
<a href="#l11.273"></a><span id="l11.273">       mdb_pos outPos;</span>
<a href="#l11.274"></a><span id="l11.274"> </span>
<a href="#l11.275"></a><span id="l11.275">       err = rowCursor-&gt;NextRowOid(GetEnv(), &amp;outOid, &amp;outPos);</span>
<a href="#l11.276"></a><span id="l11.276">       // is this right? Mork is returning a 0 id, but that should valid.</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineminus">-      if (outPos &lt; 0 || outOid.mOid_Id == (mdb_id) -1)</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineminus">-        break;</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineminus">-      if (NS_SUCCEEDED(err))</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineminus">-      {</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineplus">+      if (outPos &lt; 0 || outOid.mOid_Id == (mdb_id)-1) break;</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineplus">+      if (NS_SUCCEEDED(err)) {</span>
<a href="#l11.283"></a><span id="l11.283">         offlineOpIds-&gt;AppendElement(outOid.mOid_Id);</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineminus">-        if (MOZ_LOG_TEST(IMAPOffline, LogLevel::Info))</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineminus">-        {</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineminus">-          nsCOMPtr &lt;nsIMsgOfflineImapOperation&gt; offlineOp;</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineplus">+        if (MOZ_LOG_TEST(IMAPOffline, LogLevel::Info)) {</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineplus">+          nsCOMPtr&lt;nsIMsgOfflineImapOperation&gt; offlineOp;</span>
<a href="#l11.289"></a><span id="l11.289">           GetOfflineOpForKey(outOid.mOid_Id, false, getter_AddRefs(offlineOp));</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineminus">-          if (offlineOp)</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineminus">-          {</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineminus">-            nsMsgOfflineImapOperation *logOp = static_cast&lt;nsMsgOfflineImapOperation *&gt;(static_cast&lt;nsIMsgOfflineImapOperation *&gt;(offlineOp.get()));</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineminus">-            if (logOp)</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineminus">-              logOp-&gt;Log();</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineminus">-</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineplus">+          if (offlineOp) {</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineplus">+            nsMsgOfflineImapOperation *logOp =</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineplus">+                static_cast&lt;nsMsgOfflineImapOperation *&gt;(</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineplus">+                    static_cast&lt;nsIMsgOfflineImapOperation *&gt;(offlineOp.get()));</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineplus">+            if (logOp) logOp-&gt;Log();</span>
<a href="#l11.301"></a><span id="l11.301">           }</span>
<a href="#l11.302"></a><span id="l11.302">         }</span>
<a href="#l11.303"></a><span id="l11.303">       }</span>
<a href="#l11.304"></a><span id="l11.304">     }</span>
<a href="#l11.305"></a><span id="l11.305">     // TODO: would it cause a problem to replace this with &quot;rv = err;&quot; ?</span>
<a href="#l11.306"></a><span id="l11.306">     rv = (NS_SUCCEEDED(err)) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l11.307"></a><span id="l11.307">     rowCursor-&gt;Release();</span>
<a href="#l11.308"></a><span id="l11.308">   }</span>
<a href="#l11.309"></a><span id="l11.309"> </span>
<a href="#l11.310"></a><span id="l11.310">   offlineOpIds-&gt;Sort();</span>
<a href="#l11.311"></a><span id="l11.311">   return rv;</span>
<a href="#l11.312"></a><span id="l11.312"> }</span>
<a href="#l11.313"></a><span id="l11.313"> </span>
<a href="#l11.314"></a><span id="l11.314" class="difflineminus">-NS_IMETHODIMP nsMailDatabase::ListAllOfflineDeletes(nsTArray&lt;nsMsgKey&gt; *offlineDeletes)</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineminus">-{</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineplus">+NS_IMETHODIMP nsMailDatabase::ListAllOfflineDeletes(</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineplus">+    nsTArray&lt;nsMsgKey&gt; *offlineDeletes) {</span>
<a href="#l11.318"></a><span id="l11.318">   NS_ENSURE_ARG_POINTER(offlineDeletes);</span>
<a href="#l11.319"></a><span id="l11.319"> </span>
<a href="#l11.320"></a><span id="l11.320">   nsresult rv = GetAllOfflineOpsTable();</span>
<a href="#l11.321"></a><span id="l11.321">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.322"></a><span id="l11.322">   nsIMdbTableRowCursor *rowCursor;</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineminus">-  if (m_mdbAllOfflineOpsTable)</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineminus">-  {</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineminus">-    nsresult err = m_mdbAllOfflineOpsTable-&gt;GetTableRowCursor(GetEnv(), -1, &amp;rowCursor);</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineminus">-    while (NS_SUCCEEDED(err) &amp;&amp; rowCursor)</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineminus">-    {</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineplus">+  if (m_mdbAllOfflineOpsTable) {</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineplus">+    nsresult err =</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineplus">+        m_mdbAllOfflineOpsTable-&gt;GetTableRowCursor(GetEnv(), -1, &amp;rowCursor);</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineplus">+    while (NS_SUCCEEDED(err) &amp;&amp; rowCursor) {</span>
<a href="#l11.332"></a><span id="l11.332">       mdbOid outOid;</span>
<a href="#l11.333"></a><span id="l11.333">       mdb_pos outPos;</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineminus">-      nsIMdbRow* offlineOpRow;</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineplus">+      nsIMdbRow *offlineOpRow;</span>
<a href="#l11.336"></a><span id="l11.336"> </span>
<a href="#l11.337"></a><span id="l11.337">       err = rowCursor-&gt;NextRow(GetEnv(), &amp;offlineOpRow, &amp;outPos);</span>
<a href="#l11.338"></a><span id="l11.338">       // is this right? Mork is returning a 0 id, but that should valid.</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineminus">-      if (outPos &lt; 0 || offlineOpRow == nullptr)</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineminus">-        break;</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineminus">-      if (NS_SUCCEEDED(err))</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineminus">-      {</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineplus">+      if (outPos &lt; 0 || offlineOpRow == nullptr) break;</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineplus">+      if (NS_SUCCEEDED(err)) {</span>
<a href="#l11.345"></a><span id="l11.345">         offlineOpRow-&gt;GetOid(GetEnv(), &amp;outOid);</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineminus">-        RefPtr&lt;nsIMsgOfflineImapOperation&gt; offlineOp = new nsMsgOfflineImapOperation(this, offlineOpRow);</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineplus">+        RefPtr&lt;nsIMsgOfflineImapOperation&gt; offlineOp =</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineplus">+            new nsMsgOfflineImapOperation(this, offlineOpRow);</span>
<a href="#l11.349"></a><span id="l11.349">         imapMessageFlagsType newFlags;</span>
<a href="#l11.350"></a><span id="l11.350">         nsOfflineImapOperationType opType;</span>
<a href="#l11.351"></a><span id="l11.351"> </span>
<a href="#l11.352"></a><span id="l11.352">         offlineOp-&gt;GetOperation(&amp;opType);</span>
<a href="#l11.353"></a><span id="l11.353">         offlineOp-&gt;GetNewFlags(&amp;newFlags);</span>
<a href="#l11.354"></a><span id="l11.354">         if (opType &amp; nsIMsgOfflineImapOperation::kMsgMoved ||</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineminus">-          ((opType &amp; nsIMsgOfflineImapOperation::kFlagsChanged)</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineminus">-          &amp;&amp; (newFlags &amp; nsIMsgOfflineImapOperation::kMsgMarkedDeleted)))</span>
<a href="#l11.357"></a><span id="l11.357" class="difflineplus">+            ((opType &amp; nsIMsgOfflineImapOperation::kFlagsChanged) &amp;&amp;</span>
<a href="#l11.358"></a><span id="l11.358" class="difflineplus">+             (newFlags &amp; nsIMsgOfflineImapOperation::kMsgMarkedDeleted)))</span>
<a href="#l11.359"></a><span id="l11.359">           offlineDeletes-&gt;AppendElement(outOid.mOid_Id);</span>
<a href="#l11.360"></a><span id="l11.360"> </span>
<a href="#l11.361"></a><span id="l11.361">         offlineOpRow-&gt;Release();</span>
<a href="#l11.362"></a><span id="l11.362">       }</span>
<a href="#l11.363"></a><span id="l11.363">     }</span>
<a href="#l11.364"></a><span id="l11.364">     // TODO: would it cause a problem to replace this with &quot;rv = err;&quot; ?</span>
<a href="#l11.365"></a><span id="l11.365">     rv = (NS_SUCCEEDED(err)) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l11.366"></a><span id="l11.366">     rowCursor-&gt;Release();</span>
<a href="#l11.367"></a><span id="l11.367">   }</span>
<a href="#l11.368"></a><span id="l11.368">   return rv;</span>
<a href="#l11.369"></a><span id="l11.369"> }</span>
<a href="#l11.370"></a><span id="l11.370"> </span>
<a href="#l11.371"></a><span id="l11.371"> // This is used to remember that the db is out of sync with the mail folder</span>
<a href="#l11.372"></a><span id="l11.372"> // and needs to be regenerated.</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineminus">-void nsMailDatabase::SetReparse(bool reparse)</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineminus">-{</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineminus">-  m_reparse = reparse;</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineminus">-}</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineplus">+void nsMailDatabase::SetReparse(bool reparse) { m_reparse = reparse; }</span>
<a href="#l11.378"></a><span id="l11.378"> </span>
<a href="#l11.379"></a><span id="l11.379"> class nsMsgOfflineOpEnumerator : public nsSimpleEnumerator {</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineminus">-public:</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineminus">-  const nsID&amp; DefaultInterface() override</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineminus">-  {</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineplus">+ public:</span>
<a href="#l11.384"></a><span id="l11.384" class="difflineplus">+  const nsID &amp;DefaultInterface() override {</span>
<a href="#l11.385"></a><span id="l11.385">     return NS_GET_IID(nsIMsgOfflineImapOperation);</span>
<a href="#l11.386"></a><span id="l11.386">   }</span>
<a href="#l11.387"></a><span id="l11.387"> </span>
<a href="#l11.388"></a><span id="l11.388">   // nsISimpleEnumerator methods:</span>
<a href="#l11.389"></a><span id="l11.389">   NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l11.390"></a><span id="l11.390"> </span>
<a href="#l11.391"></a><span id="l11.391" class="difflineminus">-  explicit nsMsgOfflineOpEnumerator(nsMailDatabase* db);</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineplus">+  explicit nsMsgOfflineOpEnumerator(nsMailDatabase *db);</span>
<a href="#l11.393"></a><span id="l11.393"> </span>
<a href="#l11.394"></a><span id="l11.394" class="difflineminus">-protected:</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineplus">+ protected:</span>
<a href="#l11.396"></a><span id="l11.396">   ~nsMsgOfflineOpEnumerator() override;</span>
<a href="#l11.397"></a><span id="l11.397">   nsresult GetRowCursor();</span>
<a href="#l11.398"></a><span id="l11.398">   nsresult PrefetchNext();</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineminus">-  nsMailDatabase* mDB;</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineminus">-  nsIMdbTableRowCursor* mRowCursor;</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineminus">-  nsCOMPtr &lt;nsIMsgOfflineImapOperation&gt; mResultOp;</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineminus">-  bool  mDone;</span>
<a href="#l11.403"></a><span id="l11.403" class="difflineplus">+  nsMailDatabase *mDB;</span>
<a href="#l11.404"></a><span id="l11.404" class="difflineplus">+  nsIMdbTableRowCursor *mRowCursor;</span>
<a href="#l11.405"></a><span id="l11.405" class="difflineplus">+  nsCOMPtr&lt;nsIMsgOfflineImapOperation&gt; mResultOp;</span>
<a href="#l11.406"></a><span id="l11.406" class="difflineplus">+  bool mDone;</span>
<a href="#l11.407"></a><span id="l11.407">   bool mNextPrefetched;</span>
<a href="#l11.408"></a><span id="l11.408"> };</span>
<a href="#l11.409"></a><span id="l11.409"> </span>
<a href="#l11.410"></a><span id="l11.410" class="difflineminus">-nsMsgOfflineOpEnumerator::nsMsgOfflineOpEnumerator(nsMailDatabase* db)</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineminus">-    : mDB(db), mRowCursor(nullptr), mDone(false)</span>
<a href="#l11.412"></a><span id="l11.412" class="difflineminus">-{</span>
<a href="#l11.413"></a><span id="l11.413" class="difflineplus">+nsMsgOfflineOpEnumerator::nsMsgOfflineOpEnumerator(nsMailDatabase *db)</span>
<a href="#l11.414"></a><span id="l11.414" class="difflineplus">+    : mDB(db), mRowCursor(nullptr), mDone(false) {</span>
<a href="#l11.415"></a><span id="l11.415">   NS_ADDREF(mDB);</span>
<a href="#l11.416"></a><span id="l11.416">   mNextPrefetched = false;</span>
<a href="#l11.417"></a><span id="l11.417"> }</span>
<a href="#l11.418"></a><span id="l11.418"> </span>
<a href="#l11.419"></a><span id="l11.419" class="difflineminus">-nsMsgOfflineOpEnumerator::~nsMsgOfflineOpEnumerator()</span>
<a href="#l11.420"></a><span id="l11.420" class="difflineminus">-{</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineplus">+nsMsgOfflineOpEnumerator::~nsMsgOfflineOpEnumerator() {</span>
<a href="#l11.422"></a><span id="l11.422">   NS_IF_RELEASE(mRowCursor);</span>
<a href="#l11.423"></a><span id="l11.423">   NS_RELEASE(mDB);</span>
<a href="#l11.424"></a><span id="l11.424"> }</span>
<a href="#l11.425"></a><span id="l11.425"> </span>
<a href="#l11.426"></a><span id="l11.426" class="difflineminus">-nsresult nsMsgOfflineOpEnumerator::GetRowCursor()</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineminus">-{</span>
<a href="#l11.428"></a><span id="l11.428" class="difflineplus">+nsresult nsMsgOfflineOpEnumerator::GetRowCursor() {</span>
<a href="#l11.429"></a><span id="l11.429">   nsresult rv = NS_OK;</span>
<a href="#l11.430"></a><span id="l11.430">   mDone = false;</span>
<a href="#l11.431"></a><span id="l11.431"> </span>
<a href="#l11.432"></a><span id="l11.432" class="difflineminus">-  if (!mDB || !mDB-&gt;m_mdbAllOfflineOpsTable)</span>
<a href="#l11.433"></a><span id="l11.433" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.434"></a><span id="l11.434" class="difflineplus">+  if (!mDB || !mDB-&gt;m_mdbAllOfflineOpsTable) return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.435"></a><span id="l11.435"> </span>
<a href="#l11.436"></a><span id="l11.436" class="difflineminus">-  rv = mDB-&gt;m_mdbAllOfflineOpsTable-&gt;GetTableRowCursor(mDB-&gt;GetEnv(), -1, &amp;mRowCursor);</span>
<a href="#l11.437"></a><span id="l11.437" class="difflineplus">+  rv = mDB-&gt;m_mdbAllOfflineOpsTable-&gt;GetTableRowCursor(mDB-&gt;GetEnv(), -1,</span>
<a href="#l11.438"></a><span id="l11.438" class="difflineplus">+                                                       &amp;mRowCursor);</span>
<a href="#l11.439"></a><span id="l11.439">   return rv;</span>
<a href="#l11.440"></a><span id="l11.440"> }</span>
<a href="#l11.441"></a><span id="l11.441"> </span>
<a href="#l11.442"></a><span id="l11.442" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineOpEnumerator::GetNext(nsISupports **aItem)</span>
<a href="#l11.443"></a><span id="l11.443" class="difflineminus">-{</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineOpEnumerator::GetNext(nsISupports **aItem) {</span>
<a href="#l11.445"></a><span id="l11.445">   NS_ENSURE_ARG_POINTER(aItem);</span>
<a href="#l11.446"></a><span id="l11.446"> </span>
<a href="#l11.447"></a><span id="l11.447">   nsresult rv = NS_OK;</span>
<a href="#l11.448"></a><span id="l11.448" class="difflineminus">-  if (!mNextPrefetched)</span>
<a href="#l11.449"></a><span id="l11.449" class="difflineminus">-    rv = PrefetchNext();</span>
<a href="#l11.450"></a><span id="l11.450" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l11.451"></a><span id="l11.451" class="difflineminus">-  {</span>
<a href="#l11.452"></a><span id="l11.452" class="difflineminus">-    if (mResultOp)</span>
<a href="#l11.453"></a><span id="l11.453" class="difflineminus">-    {</span>
<a href="#l11.454"></a><span id="l11.454" class="difflineplus">+  if (!mNextPrefetched) rv = PrefetchNext();</span>
<a href="#l11.455"></a><span id="l11.455" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l11.456"></a><span id="l11.456" class="difflineplus">+    if (mResultOp) {</span>
<a href="#l11.457"></a><span id="l11.457">       NS_ADDREF(*aItem = mResultOp);</span>
<a href="#l11.458"></a><span id="l11.458">       mNextPrefetched = false;</span>
<a href="#l11.459"></a><span id="l11.459">     }</span>
<a href="#l11.460"></a><span id="l11.460">   }</span>
<a href="#l11.461"></a><span id="l11.461">   return rv;</span>
<a href="#l11.462"></a><span id="l11.462"> }</span>
<a href="#l11.463"></a><span id="l11.463"> </span>
<a href="#l11.464"></a><span id="l11.464" class="difflineminus">-nsresult nsMsgOfflineOpEnumerator::PrefetchNext()</span>
<a href="#l11.465"></a><span id="l11.465" class="difflineminus">-{</span>
<a href="#l11.466"></a><span id="l11.466" class="difflineplus">+nsresult nsMsgOfflineOpEnumerator::PrefetchNext() {</span>
<a href="#l11.467"></a><span id="l11.467">   nsresult rv = NS_OK;</span>
<a href="#l11.468"></a><span id="l11.468" class="difflineminus">-  nsIMdbRow* offlineOpRow;</span>
<a href="#l11.469"></a><span id="l11.469" class="difflineplus">+  nsIMdbRow *offlineOpRow;</span>
<a href="#l11.470"></a><span id="l11.470">   mdb_pos rowPos;</span>
<a href="#l11.471"></a><span id="l11.471"> </span>
<a href="#l11.472"></a><span id="l11.472" class="difflineminus">-  if (!mRowCursor)</span>
<a href="#l11.473"></a><span id="l11.473" class="difflineminus">-  {</span>
<a href="#l11.474"></a><span id="l11.474" class="difflineplus">+  if (!mRowCursor) {</span>
<a href="#l11.475"></a><span id="l11.475">     rv = GetRowCursor();</span>
<a href="#l11.476"></a><span id="l11.476" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l11.477"></a><span id="l11.477" class="difflineminus">-      return rv;</span>
<a href="#l11.478"></a><span id="l11.478" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l11.479"></a><span id="l11.479">   }</span>
<a href="#l11.480"></a><span id="l11.480"> </span>
<a href="#l11.481"></a><span id="l11.481">   rv = mRowCursor-&gt;NextRow(mDB-&gt;GetEnv(), &amp;offlineOpRow, &amp;rowPos);</span>
<a href="#l11.482"></a><span id="l11.482" class="difflineminus">-  if (!offlineOpRow)</span>
<a href="#l11.483"></a><span id="l11.483" class="difflineminus">-  {</span>
<a href="#l11.484"></a><span id="l11.484" class="difflineplus">+  if (!offlineOpRow) {</span>
<a href="#l11.485"></a><span id="l11.485">     mDone = true;</span>
<a href="#l11.486"></a><span id="l11.486">     return NS_ERROR_FAILURE;</span>
<a href="#l11.487"></a><span id="l11.487">   }</span>
<a href="#l11.488"></a><span id="l11.488" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l11.489"></a><span id="l11.489" class="difflineminus">-  {</span>
<a href="#l11.490"></a><span id="l11.490" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l11.491"></a><span id="l11.491">     mDone = true;</span>
<a href="#l11.492"></a><span id="l11.492">     return rv;</span>
<a href="#l11.493"></a><span id="l11.493">   }</span>
<a href="#l11.494"></a><span id="l11.494"> </span>
<a href="#l11.495"></a><span id="l11.495" class="difflineminus">-  nsIMsgOfflineImapOperation *op = new nsMsgOfflineImapOperation(mDB, offlineOpRow);</span>
<a href="#l11.496"></a><span id="l11.496" class="difflineplus">+  nsIMsgOfflineImapOperation *op =</span>
<a href="#l11.497"></a><span id="l11.497" class="difflineplus">+      new nsMsgOfflineImapOperation(mDB, offlineOpRow);</span>
<a href="#l11.498"></a><span id="l11.498">   mResultOp = op;</span>
<a href="#l11.499"></a><span id="l11.499" class="difflineminus">-  if (!op)</span>
<a href="#l11.500"></a><span id="l11.500" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.501"></a><span id="l11.501" class="difflineplus">+  if (!op) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.502"></a><span id="l11.502"> </span>
<a href="#l11.503"></a><span id="l11.503" class="difflineminus">-  if (mResultOp)</span>
<a href="#l11.504"></a><span id="l11.504" class="difflineminus">-  {</span>
<a href="#l11.505"></a><span id="l11.505" class="difflineplus">+  if (mResultOp) {</span>
<a href="#l11.506"></a><span id="l11.506">     mNextPrefetched = true;</span>
<a href="#l11.507"></a><span id="l11.507">     return NS_OK;</span>
<a href="#l11.508"></a><span id="l11.508">   }</span>
<a href="#l11.509"></a><span id="l11.509">   return NS_ERROR_FAILURE;</span>
<a href="#l11.510"></a><span id="l11.510"> }</span>
<a href="#l11.511"></a><span id="l11.511"> </span>
<a href="#l11.512"></a><span id="l11.512" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineOpEnumerator::HasMoreElements(bool *aResult)</span>
<a href="#l11.513"></a><span id="l11.513" class="difflineminus">-{</span>
<a href="#l11.514"></a><span id="l11.514" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineOpEnumerator::HasMoreElements(bool *aResult) {</span>
<a href="#l11.515"></a><span id="l11.515">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l11.516"></a><span id="l11.516"> </span>
<a href="#l11.517"></a><span id="l11.517" class="difflineminus">-  if (!mNextPrefetched)</span>
<a href="#l11.518"></a><span id="l11.518" class="difflineminus">-    PrefetchNext();</span>
<a href="#l11.519"></a><span id="l11.519" class="difflineplus">+  if (!mNextPrefetched) PrefetchNext();</span>
<a href="#l11.520"></a><span id="l11.520">   *aResult = !mDone;</span>
<a href="#l11.521"></a><span id="l11.521">   return NS_OK;</span>
<a href="#l11.522"></a><span id="l11.522"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -42,17 +42,17 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;nsIMemoryReporter.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;mozilla/mailnews/Services.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> using namespace mozilla::mailnews;</span>
<a href="#l12.9"></a><span id="l12.9"> using namespace mozilla;</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11"> #if defined(DEBUG_sspitzer_) || defined(DEBUG_seth_)</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-#define DEBUG_MSGKEYSET 1</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+#  define DEBUG_MSGKEYSET 1</span>
<a href="#l12.14"></a><span id="l12.14"> #endif</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16"> #define MSG_HASH_SIZE 512</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18"> // This will be used on discovery, since we don't know total.</span>
<a href="#l12.19"></a><span id="l12.19"> const int32_t kMaxHdrsInCache = 512;</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21"> // special keys</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -64,87 +64,78 @@ static const nsMsgKey kIdStartOfFake = 0</span>
<a href="#l12.23"></a><span id="l12.23"> static const nsMsgKey kForceReparseKey = 0xfffffff0;</span>
<a href="#l12.24"></a><span id="l12.24"> </span>
<a href="#l12.25"></a><span id="l12.25"> static LazyLogModule DBLog(&quot;MsgDB&quot;);</span>
<a href="#l12.26"></a><span id="l12.26"> </span>
<a href="#l12.27"></a><span id="l12.27"> PRTime nsMsgDatabase::gLastUseTime;</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29"> NS_IMPL_ISUPPORTS(nsMsgDBService, nsIMsgDBService)</span>
<a href="#l12.30"></a><span id="l12.30"> </span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-nsMsgDBService::nsMsgDBService()</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-{</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-}</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-nsMsgDBService::~nsMsgDBService()</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-{</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+nsMsgDBService::nsMsgDBService() {}</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+nsMsgDBService::~nsMsgDBService() {</span>
<a href="#l12.41"></a><span id="l12.41"> #ifdef DEBUG</span>
<a href="#l12.42"></a><span id="l12.42">   // If you hit this warning, it means that some code is holding onto</span>
<a href="#l12.43"></a><span id="l12.43">   // a db at shutdown.</span>
<a href="#l12.44"></a><span id="l12.44">   NS_WARNING_ASSERTION(!m_dbCache.Length(), &quot;some msg dbs left open&quot;);</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-#ifndef MOZILLA_OFFICIAL</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+#  ifndef MOZILLA_OFFICIAL</span>
<a href="#l12.47"></a><span id="l12.47">   // Only print this on local builds since it causes crashes,</span>
<a href="#l12.48"></a><span id="l12.48">   // see bug 1468691, bug 1377692 and bug 1342858.</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_dbCache.Length(); i++)</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-  {</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-    nsMsgDatabase* pMessageDB = m_dbCache.ElementAt(i);</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_dbCache.Length(); i++) {</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+    nsMsgDatabase *pMessageDB = m_dbCache.ElementAt(i);</span>
<a href="#l12.54"></a><span id="l12.54">     if (pMessageDB)</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-      printf(&quot;db left open %s\n&quot;, pMessageDB-&gt;m_dbFile-&gt;HumanReadablePath().get());</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+      printf(&quot;db left open %s\n&quot;,</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+             pMessageDB-&gt;m_dbFile-&gt;HumanReadablePath().get());</span>
<a href="#l12.58"></a><span id="l12.58">   }</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-#endif</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+#  endif</span>
<a href="#l12.61"></a><span id="l12.61"> #endif</span>
<a href="#l12.62"></a><span id="l12.62"> }</span>
<a href="#l12.63"></a><span id="l12.63"> </span>
<a href="#l12.64"></a><span id="l12.64"> NS_IMETHODIMP nsMsgDBService::OpenFolderDB(nsIMsgFolder *aFolder,</span>
<a href="#l12.65"></a><span id="l12.65">                                            bool aLeaveInvalidDB,</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-                                           nsIMsgDatabase **_retval)</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-{</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+                                           nsIMsgDatabase **_retval) {</span>
<a href="#l12.69"></a><span id="l12.69">   NS_ENSURE_ARG(aFolder);</span>
<a href="#l12.70"></a><span id="l12.70">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l12.71"></a><span id="l12.71">   nsresult rv = aFolder-&gt;GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l12.72"></a><span id="l12.72">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.73"></a><span id="l12.73"> </span>
<a href="#l12.74"></a><span id="l12.74">   nsCOMPtr&lt;nsIFile&gt; summaryFilePath;</span>
<a href="#l12.75"></a><span id="l12.75">   rv = aFolder-&gt;GetSummaryFile(getter_AddRefs(summaryFilePath));</span>
<a href="#l12.76"></a><span id="l12.76">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.77"></a><span id="l12.77"> </span>
<a href="#l12.78"></a><span id="l12.78">   nsMsgDatabase *cacheDB = FindInCache(summaryFilePath);</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-  if (cacheDB)</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-  {</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-    // this db could have ended up in the folder cache w/o an m_folder pointer via</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineminus">-    // OpenMailDBFromFile. If so, take this chance to fix the folder.</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-    if (!cacheDB-&gt;m_folder)</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-      cacheDB-&gt;m_folder = aFolder;</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+  if (cacheDB) {</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+    // this db could have ended up in the folder cache w/o an m_folder pointer</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+    // via OpenMailDBFromFile. If so, take this chance to fix the folder.</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+    if (!cacheDB-&gt;m_folder) cacheDB-&gt;m_folder = aFolder;</span>
<a href="#l12.89"></a><span id="l12.89">     cacheDB-&gt;RememberLastUseTime();</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-    *_retval = cacheDB; // FindInCache already addRefed.</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+    *_retval = cacheDB;  // FindInCache already addRefed.</span>
<a href="#l12.92"></a><span id="l12.92">     // if m_thumb is set, someone is asynchronously opening the db. But our</span>
<a href="#l12.93"></a><span id="l12.93">     // caller wants to synchronously open it, so just do it.</span>
<a href="#l12.94"></a><span id="l12.94">     if (cacheDB-&gt;m_thumb)</span>
<a href="#l12.95"></a><span id="l12.95">       return cacheDB-&gt;Open(this, summaryFilePath, false, aLeaveInvalidDB);</span>
<a href="#l12.96"></a><span id="l12.96">     return NS_OK;</span>
<a href="#l12.97"></a><span id="l12.97">   }</span>
<a href="#l12.98"></a><span id="l12.98"> </span>
<a href="#l12.99"></a><span id="l12.99">   nsCString localDatabaseType;</span>
<a href="#l12.100"></a><span id="l12.100">   incomingServer-&gt;GetLocalDatabaseType(localDatabaseType);</span>
<a href="#l12.101"></a><span id="l12.101">   nsAutoCString dbContractID(NS_MSGDB_CONTRACTID);</span>
<a href="#l12.102"></a><span id="l12.102">   dbContractID.Append(localDatabaseType.get());</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB = do_CreateInstance(dbContractID.get(), &amp;rv);</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB = do_CreateInstance(dbContractID.get(), &amp;rv);</span>
<a href="#l12.105"></a><span id="l12.105">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.106"></a><span id="l12.106"> </span>
<a href="#l12.107"></a><span id="l12.107">   // Don't try to create the database yet--let the createNewDB call do that.</span>
<a href="#l12.108"></a><span id="l12.108">   nsMsgDatabase *msgDatabase = static_cast&lt;nsMsgDatabase *&gt;(msgDB.get());</span>
<a href="#l12.109"></a><span id="l12.109">   msgDatabase-&gt;m_folder = aFolder;</span>
<a href="#l12.110"></a><span id="l12.110">   rv = msgDatabase-&gt;Open(this, summaryFilePath, false, aLeaveInvalidDB);</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-  if (NS_FAILED(rv) &amp;&amp; rv != NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-    return rv;</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+  if (NS_FAILED(rv) &amp;&amp; rv != NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE) return rv;</span>
<a href="#l12.114"></a><span id="l12.114"> </span>
<a href="#l12.115"></a><span id="l12.115">   NS_ADDREF(*_retval = msgDB);</span>
<a href="#l12.116"></a><span id="l12.116"> </span>
<a href="#l12.117"></a><span id="l12.117" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineminus">-  {</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l12.120"></a><span id="l12.120"> #ifdef DEBUG</span>
<a href="#l12.121"></a><span id="l12.121">     // Doing these checks for debug only as we don't want to report certain</span>
<a href="#l12.122"></a><span id="l12.122">     // errors in debug mode, but in release mode we wouldn't report them either</span>
<a href="#l12.123"></a><span id="l12.123"> </span>
<a href="#l12.124"></a><span id="l12.124">     // These errors are expected.</span>
<a href="#l12.125"></a><span id="l12.125">     if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING ||</span>
<a href="#l12.126"></a><span id="l12.126">         rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l12.127"></a><span id="l12.127">       return rv;</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineat">@@ -156,56 +147,52 @@ NS_IMETHODIMP nsMsgDBService::OpenFolder</span>
<a href="#l12.129"></a><span id="l12.129">   }</span>
<a href="#l12.130"></a><span id="l12.130"> </span>
<a href="#l12.131"></a><span id="l12.131">   FinishDBOpen(aFolder, msgDatabase);</span>
<a href="#l12.132"></a><span id="l12.132">   return rv;</span>
<a href="#l12.133"></a><span id="l12.133"> }</span>
<a href="#l12.134"></a><span id="l12.134"> </span>
<a href="#l12.135"></a><span id="l12.135"> NS_IMETHODIMP nsMsgDBService::AsyncOpenFolderDB(nsIMsgFolder *aFolder,</span>
<a href="#l12.136"></a><span id="l12.136">                                                 bool aLeaveInvalidDB,</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineminus">-                                                nsIMsgDatabase **_retval)</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineminus">-{</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+                                                nsIMsgDatabase **_retval) {</span>
<a href="#l12.140"></a><span id="l12.140">   NS_ENSURE_ARG(aFolder);</span>
<a href="#l12.141"></a><span id="l12.141"> </span>
<a href="#l12.142"></a><span id="l12.142" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; summaryFilePath;</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; summaryFilePath;</span>
<a href="#l12.144"></a><span id="l12.144">   nsresult rv = aFolder-&gt;GetSummaryFile(getter_AddRefs(summaryFilePath));</span>
<a href="#l12.145"></a><span id="l12.145">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.146"></a><span id="l12.146"> </span>
<a href="#l12.147"></a><span id="l12.147">   nsMsgDatabase *cacheDB = FindInCache(summaryFilePath);</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineminus">-  if (cacheDB)</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineminus">-  {</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-    // this db could have ended up in the folder cache w/o an m_folder pointer via</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-    // OpenMailDBFromFile. If so, take this chance to fix the folder.</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-    if (!cacheDB-&gt;m_folder)</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineminus">-      cacheDB-&gt;m_folder = aFolder;</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineminus">-    *_retval = cacheDB; // FindInCache already addRefed.</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+  if (cacheDB) {</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+    // this db could have ended up in the folder cache w/o an m_folder pointer</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+    // via OpenMailDBFromFile. If so, take this chance to fix the folder.</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+    if (!cacheDB-&gt;m_folder) cacheDB-&gt;m_folder = aFolder;</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+    *_retval = cacheDB;  // FindInCache already addRefed.</span>
<a href="#l12.160"></a><span id="l12.160">     // We don't care if an other consumer is thumbing the store. In that</span>
<a href="#l12.161"></a><span id="l12.161">     // case, they'll both thumb the store.</span>
<a href="#l12.162"></a><span id="l12.162">     return NS_OK;</span>
<a href="#l12.163"></a><span id="l12.163">   }</span>
<a href="#l12.164"></a><span id="l12.164"> </span>
<a href="#l12.165"></a><span id="l12.165" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l12.167"></a><span id="l12.167">   rv = aFolder-&gt;GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l12.168"></a><span id="l12.168">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.169"></a><span id="l12.169">   nsCString localDatabaseType;</span>
<a href="#l12.170"></a><span id="l12.170">   incomingServer-&gt;GetLocalDatabaseType(localDatabaseType);</span>
<a href="#l12.171"></a><span id="l12.171">   nsAutoCString dbContractID(NS_MSGDB_CONTRACTID);</span>
<a href="#l12.172"></a><span id="l12.172">   dbContractID.Append(localDatabaseType.get());</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB = do_CreateInstance(dbContractID.get(), &amp;rv);</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB = do_CreateInstance(dbContractID.get(), &amp;rv);</span>
<a href="#l12.175"></a><span id="l12.175">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.176"></a><span id="l12.176"> </span>
<a href="#l12.177"></a><span id="l12.177">   nsMsgDatabase *msgDatabase = static_cast&lt;nsMsgDatabase *&gt;(msgDB.get());</span>
<a href="#l12.178"></a><span id="l12.178">   rv = msgDatabase-&gt;OpenInternal(this, summaryFilePath, false, aLeaveInvalidDB,</span>
<a href="#l12.179"></a><span id="l12.179">                                  false /* open asynchronously */);</span>
<a href="#l12.180"></a><span id="l12.180"> </span>
<a href="#l12.181"></a><span id="l12.181">   NS_ADDREF(*_retval = msgDB);</span>
<a href="#l12.182"></a><span id="l12.182">   msgDatabase-&gt;m_folder = aFolder;</span>
<a href="#l12.183"></a><span id="l12.183"> </span>
<a href="#l12.184"></a><span id="l12.184" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineminus">-  {</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l12.187"></a><span id="l12.187"> #ifdef DEBUG</span>
<a href="#l12.188"></a><span id="l12.188">     // Doing these checks for debug only as we don't want to report certain</span>
<a href="#l12.189"></a><span id="l12.189">     // errors in debug mode, but in release mode we wouldn't report them either</span>
<a href="#l12.190"></a><span id="l12.190"> </span>
<a href="#l12.191"></a><span id="l12.191">     // These errors are expected.</span>
<a href="#l12.192"></a><span id="l12.192">     if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING ||</span>
<a href="#l12.193"></a><span id="l12.193">         rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l12.194"></a><span id="l12.194">       return rv;</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineat">@@ -215,118 +202,106 @@ NS_IMETHODIMP nsMsgDBService::AsyncOpenF</span>
<a href="#l12.196"></a><span id="l12.196"> #endif</span>
<a href="#l12.197"></a><span id="l12.197">     return rv;</span>
<a href="#l12.198"></a><span id="l12.198">   }</span>
<a href="#l12.199"></a><span id="l12.199"> </span>
<a href="#l12.200"></a><span id="l12.200">   FinishDBOpen(aFolder, msgDatabase);</span>
<a href="#l12.201"></a><span id="l12.201">   return rv;</span>
<a href="#l12.202"></a><span id="l12.202"> }</span>
<a href="#l12.203"></a><span id="l12.203"> </span>
<a href="#l12.204"></a><span id="l12.204" class="difflineminus">-NS_IMETHODIMP nsMsgDBService::OpenMore(nsIMsgDatabase *aDB,</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineminus">-                                       uint32_t aTimeHint,</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineminus">-                                       bool *_retval)</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineminus">-{</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+NS_IMETHODIMP nsMsgDBService::OpenMore(nsIMsgDatabase *aDB, uint32_t aTimeHint,</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineplus">+                                       bool *_retval) {</span>
<a href="#l12.210"></a><span id="l12.210">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l12.211"></a><span id="l12.211">   nsMsgDatabase *msgDatabase = static_cast&lt;nsMsgDatabase *&gt;(aDB);</span>
<a href="#l12.212"></a><span id="l12.212">   NS_ENSURE_TRUE(msgDatabase, NS_ERROR_INVALID_ARG);</span>
<a href="#l12.213"></a><span id="l12.213">   // Check if this db has been opened.</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineminus">-  if (!msgDatabase-&gt;m_thumb)</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineminus">-  {</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+  if (!msgDatabase-&gt;m_thumb) {</span>
<a href="#l12.217"></a><span id="l12.217">     *_retval = true;</span>
<a href="#l12.218"></a><span id="l12.218">     return NS_OK;</span>
<a href="#l12.219"></a><span id="l12.219">   }</span>
<a href="#l12.220"></a><span id="l12.220">   nsresult rv;</span>
<a href="#l12.221"></a><span id="l12.221">   *_retval = false;</span>
<a href="#l12.222"></a><span id="l12.222">   PRIntervalTime startTime = PR_IntervalNow();</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineminus">-  do</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineminus">-  {</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineminus">-    mdb_count outTotal;    // total somethings to do in operation</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineminus">-    mdb_count outCurrent;  // subportion of total completed so far</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineminus">-    mdb_bool outDone = false;      // is operation finished?</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineminus">-    mdb_bool outBroken;     // is operation irreparably dead and broken?</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineminus">-    rv = msgDatabase-&gt;m_thumb-&gt;DoMore(msgDatabase-&gt;m_mdbEnv,</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineminus">-                                       &amp;outTotal, &amp;outCurrent, &amp;outDone,</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineminus">-                                       &amp;outBroken);</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineminus">-      break;</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineminus">-    if (outDone)</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineminus">-    {</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+  do {</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineplus">+    mdb_count outTotal;        // total somethings to do in operation</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineplus">+    mdb_count outCurrent;      // subportion of total completed so far</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineplus">+    mdb_bool outDone = false;  // is operation finished?</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+    mdb_bool outBroken;        // is operation irreparably dead and broken?</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineplus">+    rv = msgDatabase-&gt;m_thumb-&gt;DoMore(msgDatabase-&gt;m_mdbEnv, &amp;outTotal,</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+                                      &amp;outCurrent, &amp;outDone, &amp;outBroken);</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+    if (outDone) {</span>
<a href="#l12.245"></a><span id="l12.245">       nsCOMPtr&lt;nsIMdbFactory&gt; mdbFactory;</span>
<a href="#l12.246"></a><span id="l12.246">       rv = msgDatabase-&gt;GetMDBFactory(getter_AddRefs(mdbFactory));</span>
<a href="#l12.247"></a><span id="l12.247">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineminus">-      rv = mdbFactory-&gt;ThumbToOpenStore(msgDatabase-&gt;m_mdbEnv, msgDatabase-&gt;m_thumb, &amp;msgDatabase-&gt;m_mdbStore);</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+      rv = mdbFactory-&gt;ThumbToOpenStore(msgDatabase-&gt;m_mdbEnv,</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+                                        msgDatabase-&gt;m_thumb,</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineplus">+                                        &amp;msgDatabase-&gt;m_mdbStore);</span>
<a href="#l12.252"></a><span id="l12.252">       msgDatabase-&gt;m_thumb = nullptr;</span>
<a href="#l12.253"></a><span id="l12.253">       nsCOMPtr&lt;nsIFile&gt; folderPath;</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineminus">-      (void) msgDatabase-&gt;m_folder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineminus">-      nsCOMPtr &lt;nsIFile&gt; summaryFile;</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineminus">-      (void) GetSummaryFileLocation(folderPath, getter_AddRefs(summaryFile));</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineplus">+      (void)msgDatabase-&gt;m_folder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+      nsCOMPtr&lt;nsIFile&gt; summaryFile;</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+      (void)GetSummaryFileLocation(folderPath, getter_AddRefs(summaryFile));</span>
<a href="#l12.260"></a><span id="l12.260"> </span>
<a href="#l12.261"></a><span id="l12.261">       if (NS_SUCCEEDED(rv))</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineminus">-        rv = (msgDatabase-&gt;m_mdbStore) ? msgDatabase-&gt;InitExistingDB() : NS_ERROR_FAILURE;</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineplus">+        rv = (msgDatabase-&gt;m_mdbStore) ? msgDatabase-&gt;InitExistingDB()</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineplus">+                                       : NS_ERROR_FAILURE;</span>
<a href="#l12.265"></a><span id="l12.265">       if (NS_SUCCEEDED(rv))</span>
<a href="#l12.266"></a><span id="l12.266">         rv = msgDatabase-&gt;CheckForErrors(rv, false, this, summaryFile);</span>
<a href="#l12.267"></a><span id="l12.267"> </span>
<a href="#l12.268"></a><span id="l12.268">       FinishDBOpen(msgDatabase-&gt;m_folder, msgDatabase);</span>
<a href="#l12.269"></a><span id="l12.269">       break;</span>
<a href="#l12.270"></a><span id="l12.270">     }</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineminus">-  }</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineminus">-  while (PR_IntervalToMilliseconds(PR_IntervalNow() - startTime) &lt;= aTimeHint);</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineplus">+  } while (PR_IntervalToMilliseconds(PR_IntervalNow() - startTime) &lt;=</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineplus">+           aTimeHint);</span>
<a href="#l12.275"></a><span id="l12.275">   *_retval = !msgDatabase-&gt;m_thumb;</span>
<a href="#l12.276"></a><span id="l12.276">   return rv;</span>
<a href="#l12.277"></a><span id="l12.277"> }</span>
<a href="#l12.278"></a><span id="l12.278"> </span>
<a href="#l12.279"></a><span id="l12.279"> /**</span>
<a href="#l12.280"></a><span id="l12.280">  * When a db is opened, we need to hook up any pending listeners for</span>
<a href="#l12.281"></a><span id="l12.281">  * that db, and notify them.</span>
<a href="#l12.282"></a><span id="l12.282">  */</span>
<a href="#l12.283"></a><span id="l12.283"> void nsMsgDBService::HookupPendingListeners(nsIMsgDatabase *db,</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineminus">-                                            nsIMsgFolder *folder)</span>
<a href="#l12.285"></a><span id="l12.285" class="difflineminus">-{</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineplus">+                                            nsIMsgFolder *folder) {</span>
<a href="#l12.287"></a><span id="l12.287">   for (int32_t listenerIndex = 0;</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineminus">-       listenerIndex &lt; m_foldersPendingListeners.Count(); listenerIndex++)</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineminus">-  {</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineminus">-  //  check if we have a pending listener on this db, and if so, add it.</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineminus">-    if (m_foldersPendingListeners[listenerIndex] == folder)</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineminus">-    {</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineplus">+       listenerIndex &lt; m_foldersPendingListeners.Count(); listenerIndex++) {</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineplus">+    //  check if we have a pending listener on this db, and if so, add it.</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineplus">+    if (m_foldersPendingListeners[listenerIndex] == folder) {</span>
<a href="#l12.296"></a><span id="l12.296">       db-&gt;AddListener(m_pendingListeners.ObjectAt(listenerIndex));</span>
<a href="#l12.297"></a><span id="l12.297">       m_pendingListeners.ObjectAt(listenerIndex)-&gt;OnEvent(db, &quot;DBOpened&quot;);</span>
<a href="#l12.298"></a><span id="l12.298">     }</span>
<a href="#l12.299"></a><span id="l12.299">   }</span>
<a href="#l12.300"></a><span id="l12.300"> }</span>
<a href="#l12.301"></a><span id="l12.301"> </span>
<a href="#l12.302"></a><span id="l12.302" class="difflineminus">-void nsMsgDBService::FinishDBOpen(nsIMsgFolder *aFolder, nsMsgDatabase *aMsgDB)</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineminus">-{</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineplus">+void nsMsgDBService::FinishDBOpen(nsIMsgFolder *aFolder,</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineplus">+                                  nsMsgDatabase *aMsgDB) {</span>
<a href="#l12.306"></a><span id="l12.306">   uint32_t folderFlags;</span>
<a href="#l12.307"></a><span id="l12.307">   aFolder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l12.308"></a><span id="l12.308"> </span>
<a href="#l12.309"></a><span id="l12.309" class="difflineminus">-  if (! (folderFlags &amp; nsMsgFolderFlags::Virtual) &amp;&amp;</span>
<a href="#l12.310"></a><span id="l12.310" class="difflineminus">-      aMsgDB-&gt;m_mdbAllMsgHeadersTable)</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineminus">-  {</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineplus">+  if (!(folderFlags &amp; nsMsgFolderFlags::Virtual) &amp;&amp;</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineplus">+      aMsgDB-&gt;m_mdbAllMsgHeadersTable) {</span>
<a href="#l12.314"></a><span id="l12.314">     mdb_count numHdrsInTable = 0;</span>
<a href="#l12.315"></a><span id="l12.315">     int32_t numMessages;</span>
<a href="#l12.316"></a><span id="l12.316">     aMsgDB-&gt;m_mdbAllMsgHeadersTable-&gt;GetCount(aMsgDB-&gt;GetEnv(),</span>
<a href="#l12.317"></a><span id="l12.317">                                               &amp;numHdrsInTable);</span>
<a href="#l12.318"></a><span id="l12.318">     aMsgDB-&gt;m_dbFolderInfo-&gt;GetNumMessages(&amp;numMessages);</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineminus">-    if (numMessages != (int32_t) numHdrsInTable)</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineminus">-      aMsgDB-&gt;SyncCounts();</span>
<a href="#l12.321"></a><span id="l12.321" class="difflineplus">+    if (numMessages != (int32_t)numHdrsInTable) aMsgDB-&gt;SyncCounts();</span>
<a href="#l12.322"></a><span id="l12.322">   }</span>
<a href="#l12.323"></a><span id="l12.323">   HookupPendingListeners(aMsgDB, aFolder);</span>
<a href="#l12.324"></a><span id="l12.324">   aMsgDB-&gt;RememberLastUseTime();</span>
<a href="#l12.325"></a><span id="l12.325"> }</span>
<a href="#l12.326"></a><span id="l12.326"> </span>
<a href="#l12.327"></a><span id="l12.327"> //----------------------------------------------------------------------</span>
<a href="#l12.328"></a><span id="l12.328"> // FindInCache - this addrefs the db it finds.</span>
<a href="#l12.329"></a><span id="l12.329"> //----------------------------------------------------------------------</span>
<a href="#l12.330"></a><span id="l12.330" class="difflineminus">-nsMsgDatabase* nsMsgDBService::FindInCache(nsIFile *dbName)</span>
<a href="#l12.331"></a><span id="l12.331" class="difflineminus">-{</span>
<a href="#l12.332"></a><span id="l12.332" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_dbCache.Length(); i++)</span>
<a href="#l12.333"></a><span id="l12.333" class="difflineminus">-  {</span>
<a href="#l12.334"></a><span id="l12.334" class="difflineminus">-    nsMsgDatabase* pMessageDB = m_dbCache[i];</span>
<a href="#l12.335"></a><span id="l12.335" class="difflineminus">-    if (pMessageDB-&gt;MatchDbName(dbName))</span>
<a href="#l12.336"></a><span id="l12.336" class="difflineminus">-    {</span>
<a href="#l12.337"></a><span id="l12.337" class="difflineplus">+nsMsgDatabase *nsMsgDBService::FindInCache(nsIFile *dbName) {</span>
<a href="#l12.338"></a><span id="l12.338" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_dbCache.Length(); i++) {</span>
<a href="#l12.339"></a><span id="l12.339" class="difflineplus">+    nsMsgDatabase *pMessageDB = m_dbCache[i];</span>
<a href="#l12.340"></a><span id="l12.340" class="difflineplus">+    if (pMessageDB-&gt;MatchDbName(dbName)) {</span>
<a href="#l12.341"></a><span id="l12.341">       if (pMessageDB-&gt;m_mdbStore)  // don't return db without store</span>
<a href="#l12.342"></a><span id="l12.342">       {</span>
<a href="#l12.343"></a><span id="l12.343">         NS_ADDREF(pMessageDB);</span>
<a href="#l12.344"></a><span id="l12.344">         return pMessageDB;</span>
<a href="#l12.345"></a><span id="l12.345">       }</span>
<a href="#l12.346"></a><span id="l12.346">     }</span>
<a href="#l12.347"></a><span id="l12.347">   }</span>
<a href="#l12.348"></a><span id="l12.348">   return nullptr;</span>
<a href="#l12.349"></a><span id="l12.349" class="difflineat">@@ -335,61 +310,54 @@ nsMsgDatabase* nsMsgDBService::FindInCac</span>
<a href="#l12.350"></a><span id="l12.350"> // This method is called when the caller is trying to create a db without</span>
<a href="#l12.351"></a><span id="l12.351"> // having a corresponding nsIMsgFolder object.  This happens in a few</span>
<a href="#l12.352"></a><span id="l12.352"> // situations, including imap folder discovery, compacting local folders,</span>
<a href="#l12.353"></a><span id="l12.353"> // and copying local folders.</span>
<a href="#l12.354"></a><span id="l12.354"> NS_IMETHODIMP nsMsgDBService::OpenMailDBFromFile(nsIFile *aFolderName,</span>
<a href="#l12.355"></a><span id="l12.355">                                                  nsIMsgFolder *aFolder,</span>
<a href="#l12.356"></a><span id="l12.356">                                                  bool aCreate,</span>
<a href="#l12.357"></a><span id="l12.357">                                                  bool aLeaveInvalidDB,</span>
<a href="#l12.358"></a><span id="l12.358" class="difflineminus">-                                                 nsIMsgDatabase** pMessageDB)</span>
<a href="#l12.359"></a><span id="l12.359" class="difflineminus">-{</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineminus">-  if (!aFolderName)</span>
<a href="#l12.361"></a><span id="l12.361" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.362"></a><span id="l12.362" class="difflineminus">-</span>
<a href="#l12.363"></a><span id="l12.363" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt;  dbPath;</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineplus">+                                                 nsIMsgDatabase **pMessageDB) {</span>
<a href="#l12.365"></a><span id="l12.365" class="difflineplus">+  if (!aFolderName) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.366"></a><span id="l12.366" class="difflineplus">+</span>
<a href="#l12.367"></a><span id="l12.367" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l12.368"></a><span id="l12.368">   nsresult rv = GetSummaryFileLocation(aFolderName, getter_AddRefs(dbPath));</span>
<a href="#l12.369"></a><span id="l12.369">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.370"></a><span id="l12.370"> </span>
<a href="#l12.371"></a><span id="l12.371">   *pMessageDB = FindInCache(dbPath);</span>
<a href="#l12.372"></a><span id="l12.372" class="difflineminus">-  if (*pMessageDB)</span>
<a href="#l12.373"></a><span id="l12.373" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.374"></a><span id="l12.374" class="difflineplus">+  if (*pMessageDB) return NS_OK;</span>
<a href="#l12.375"></a><span id="l12.375"> </span>
<a href="#l12.376"></a><span id="l12.376">   RefPtr&lt;nsMailDatabase&gt; msgDB = new nsMailDatabase;</span>
<a href="#l12.377"></a><span id="l12.377">   NS_ENSURE_TRUE(msgDB, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l12.378"></a><span id="l12.378">   rv = msgDB-&gt;Open(this, dbPath, aCreate, aLeaveInvalidDB);</span>
<a href="#l12.379"></a><span id="l12.379" class="difflineminus">-  if (rv == NS_ERROR_FILE_TARGET_DOES_NOT_EXIST)</span>
<a href="#l12.380"></a><span id="l12.380" class="difflineminus">-    return rv;</span>
<a href="#l12.381"></a><span id="l12.381" class="difflineplus">+  if (rv == NS_ERROR_FILE_TARGET_DOES_NOT_EXIST) return rv;</span>
<a href="#l12.382"></a><span id="l12.382">   NS_IF_ADDREF(*pMessageDB = msgDB);</span>
<a href="#l12.383"></a><span id="l12.383" class="difflineminus">-  if (aCreate &amp;&amp; msgDB &amp;&amp; rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l12.384"></a><span id="l12.384" class="difflineminus">-    rv = NS_OK;</span>
<a href="#l12.385"></a><span id="l12.385" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l12.386"></a><span id="l12.386" class="difflineminus">-    msgDB-&gt;m_folder = aFolder;</span>
<a href="#l12.387"></a><span id="l12.387" class="difflineplus">+  if (aCreate &amp;&amp; msgDB &amp;&amp; rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING) rv = NS_OK;</span>
<a href="#l12.388"></a><span id="l12.388" class="difflineplus">+  if (NS_SUCCEEDED(rv)) msgDB-&gt;m_folder = aFolder;</span>
<a href="#l12.389"></a><span id="l12.389">   return rv;</span>
<a href="#l12.390"></a><span id="l12.390"> }</span>
<a href="#l12.391"></a><span id="l12.391"> </span>
<a href="#l12.392"></a><span id="l12.392"> NS_IMETHODIMP nsMsgDBService::CreateNewDB(nsIMsgFolder *aFolder,</span>
<a href="#l12.393"></a><span id="l12.393" class="difflineminus">-                                          nsIMsgDatabase **_retval)</span>
<a href="#l12.394"></a><span id="l12.394" class="difflineminus">-{</span>
<a href="#l12.395"></a><span id="l12.395" class="difflineplus">+                                          nsIMsgDatabase **_retval) {</span>
<a href="#l12.396"></a><span id="l12.396">   NS_ENSURE_ARG(aFolder);</span>
<a href="#l12.397"></a><span id="l12.397"> </span>
<a href="#l12.398"></a><span id="l12.398" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l12.399"></a><span id="l12.399" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l12.400"></a><span id="l12.400">   nsresult rv = aFolder-&gt;GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l12.401"></a><span id="l12.401">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.402"></a><span id="l12.402"> </span>
<a href="#l12.403"></a><span id="l12.403">   nsCOMPtr&lt;nsIFile&gt; summaryFilePath;</span>
<a href="#l12.404"></a><span id="l12.404">   rv = aFolder-&gt;GetSummaryFile(getter_AddRefs(summaryFilePath));</span>
<a href="#l12.405"></a><span id="l12.405">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.406"></a><span id="l12.406"> </span>
<a href="#l12.407"></a><span id="l12.407">   nsCString localDatabaseType;</span>
<a href="#l12.408"></a><span id="l12.408">   incomingServer-&gt;GetLocalDatabaseType(localDatabaseType);</span>
<a href="#l12.409"></a><span id="l12.409">   nsAutoCString dbContractID(NS_MSGDB_CONTRACTID);</span>
<a href="#l12.410"></a><span id="l12.410">   dbContractID.Append(localDatabaseType.get());</span>
<a href="#l12.411"></a><span id="l12.411"> </span>
<a href="#l12.412"></a><span id="l12.412" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB = do_CreateInstance(dbContractID.get(), &amp;rv);</span>
<a href="#l12.413"></a><span id="l12.413" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB = do_CreateInstance(dbContractID.get(), &amp;rv);</span>
<a href="#l12.414"></a><span id="l12.414">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.415"></a><span id="l12.415"> </span>
<a href="#l12.416"></a><span id="l12.416">   nsMsgDatabase *msgDatabase = static_cast&lt;nsMsgDatabase *&gt;(msgDB.get());</span>
<a href="#l12.417"></a><span id="l12.417"> </span>
<a href="#l12.418"></a><span id="l12.418">   msgDatabase-&gt;m_folder = aFolder;</span>
<a href="#l12.419"></a><span id="l12.419">   rv = msgDatabase-&gt;Open(this, summaryFilePath, true, true);</span>
<a href="#l12.420"></a><span id="l12.420"> </span>
<a href="#l12.421"></a><span id="l12.421">   // We are trying to create a new database, but that implies that it did not</span>
<a href="#l12.422"></a><span id="l12.422" class="difflineat">@@ -405,1193 +373,1064 @@ NS_IMETHODIMP nsMsgDBService::CreateNewD</span>
<a href="#l12.423"></a><span id="l12.423"> </span>
<a href="#l12.424"></a><span id="l12.424">   HookupPendingListeners(msgDB, aFolder);</span>
<a href="#l12.425"></a><span id="l12.425"> </span>
<a href="#l12.426"></a><span id="l12.426">   msgDatabase-&gt;RememberLastUseTime();</span>
<a href="#l12.427"></a><span id="l12.427"> </span>
<a href="#l12.428"></a><span id="l12.428">   return NS_OK;</span>
<a href="#l12.429"></a><span id="l12.429"> }</span>
<a href="#l12.430"></a><span id="l12.430"> </span>
<a href="#l12.431"></a><span id="l12.431" class="difflineminus">-/* void registerPendingListener (in nsIMsgFolder aFolder, in nsIDBChangeListener aListener); */</span>
<a href="#l12.432"></a><span id="l12.432" class="difflineminus">-NS_IMETHODIMP nsMsgDBService::RegisterPendingListener(nsIMsgFolder *aFolder, nsIDBChangeListener *aListener)</span>
<a href="#l12.433"></a><span id="l12.433" class="difflineminus">-{</span>
<a href="#l12.434"></a><span id="l12.434" class="difflineminus">-  // need to make sure we don't hold onto these forever. Maybe a shutdown listener?</span>
<a href="#l12.435"></a><span id="l12.435" class="difflineminus">-  // if there is a db open on this folder already, we should register the listener.</span>
<a href="#l12.436"></a><span id="l12.436" class="difflineplus">+/* void registerPendingListener (in nsIMsgFolder aFolder, in nsIDBChangeListener</span>
<a href="#l12.437"></a><span id="l12.437" class="difflineplus">+ * aListener); */</span>
<a href="#l12.438"></a><span id="l12.438" class="difflineplus">+NS_IMETHODIMP nsMsgDBService::RegisterPendingListener(</span>
<a href="#l12.439"></a><span id="l12.439" class="difflineplus">+    nsIMsgFolder *aFolder, nsIDBChangeListener *aListener) {</span>
<a href="#l12.440"></a><span id="l12.440" class="difflineplus">+  // need to make sure we don't hold onto these forever. Maybe a shutdown</span>
<a href="#l12.441"></a><span id="l12.441" class="difflineplus">+  // listener? if there is a db open on this folder already, we should register</span>
<a href="#l12.442"></a><span id="l12.442" class="difflineplus">+  // the listener.</span>
<a href="#l12.443"></a><span id="l12.443">   m_foldersPendingListeners.AppendObject(aFolder);</span>
<a href="#l12.444"></a><span id="l12.444">   m_pendingListeners.AppendObject(aListener);</span>
<a href="#l12.445"></a><span id="l12.445" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; openDB;</span>
<a href="#l12.446"></a><span id="l12.446" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; openDB;</span>
<a href="#l12.447"></a><span id="l12.447">   CachedDBForFolder(aFolder, getter_AddRefs(openDB));</span>
<a href="#l12.448"></a><span id="l12.448" class="difflineminus">-  if (openDB)</span>
<a href="#l12.449"></a><span id="l12.449" class="difflineminus">-    openDB-&gt;AddListener(aListener);</span>
<a href="#l12.450"></a><span id="l12.450" class="difflineplus">+  if (openDB) openDB-&gt;AddListener(aListener);</span>
<a href="#l12.451"></a><span id="l12.451">   return NS_OK;</span>
<a href="#l12.452"></a><span id="l12.452"> }</span>
<a href="#l12.453"></a><span id="l12.453"> </span>
<a href="#l12.454"></a><span id="l12.454"> /* void unregisterPendingListener (in nsIDBChangeListener aListener); */</span>
<a href="#l12.455"></a><span id="l12.455" class="difflineminus">-NS_IMETHODIMP nsMsgDBService::UnregisterPendingListener(nsIDBChangeListener *aListener)</span>
<a href="#l12.456"></a><span id="l12.456" class="difflineminus">-{</span>
<a href="#l12.457"></a><span id="l12.457" class="difflineplus">+NS_IMETHODIMP nsMsgDBService::UnregisterPendingListener(</span>
<a href="#l12.458"></a><span id="l12.458" class="difflineplus">+    nsIDBChangeListener *aListener) {</span>
<a href="#l12.459"></a><span id="l12.459">   int32_t listenerIndex = m_pendingListeners.IndexOfObject(aListener);</span>
<a href="#l12.460"></a><span id="l12.460" class="difflineminus">-  if (listenerIndex != -1)</span>
<a href="#l12.461"></a><span id="l12.461" class="difflineminus">-  {</span>
<a href="#l12.462"></a><span id="l12.462" class="difflineplus">+  if (listenerIndex != -1) {</span>
<a href="#l12.463"></a><span id="l12.463">     nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l12.464"></a><span id="l12.464" class="difflineminus">-    CachedDBForFolder(m_foldersPendingListeners[listenerIndex], getter_AddRefs(msgDB));</span>
<a href="#l12.465"></a><span id="l12.465" class="difflineminus">-    if (msgDB)</span>
<a href="#l12.466"></a><span id="l12.466" class="difflineminus">-      msgDB-&gt;RemoveListener(aListener);</span>
<a href="#l12.467"></a><span id="l12.467" class="difflineplus">+    CachedDBForFolder(m_foldersPendingListeners[listenerIndex],</span>
<a href="#l12.468"></a><span id="l12.468" class="difflineplus">+                      getter_AddRefs(msgDB));</span>
<a href="#l12.469"></a><span id="l12.469" class="difflineplus">+    if (msgDB) msgDB-&gt;RemoveListener(aListener);</span>
<a href="#l12.470"></a><span id="l12.470">     m_foldersPendingListeners.RemoveObjectAt(listenerIndex);</span>
<a href="#l12.471"></a><span id="l12.471">     m_pendingListeners.RemoveObjectAt(listenerIndex);</span>
<a href="#l12.472"></a><span id="l12.472">     return NS_OK;</span>
<a href="#l12.473"></a><span id="l12.473">   }</span>
<a href="#l12.474"></a><span id="l12.474">   return NS_ERROR_FAILURE;</span>
<a href="#l12.475"></a><span id="l12.475"> }</span>
<a href="#l12.476"></a><span id="l12.476"> </span>
<a href="#l12.477"></a><span id="l12.477" class="difflineminus">-NS_IMETHODIMP nsMsgDBService::CachedDBForFolder(nsIMsgFolder *aFolder, nsIMsgDatabase **aRetDB)</span>
<a href="#l12.478"></a><span id="l12.478" class="difflineminus">-{</span>
<a href="#l12.479"></a><span id="l12.479" class="difflineplus">+NS_IMETHODIMP nsMsgDBService::CachedDBForFolder(nsIMsgFolder *aFolder,</span>
<a href="#l12.480"></a><span id="l12.480" class="difflineplus">+                                                nsIMsgDatabase **aRetDB) {</span>
<a href="#l12.481"></a><span id="l12.481">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l12.482"></a><span id="l12.482">   NS_ENSURE_ARG_POINTER(aRetDB);</span>
<a href="#l12.483"></a><span id="l12.483"> </span>
<a href="#l12.484"></a><span id="l12.484">   nsCOMPtr&lt;nsIFile&gt; summaryFilePath;</span>
<a href="#l12.485"></a><span id="l12.485">   nsresult rv = aFolder-&gt;GetSummaryFile(getter_AddRefs(summaryFilePath));</span>
<a href="#l12.486"></a><span id="l12.486">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.487"></a><span id="l12.487"> </span>
<a href="#l12.488"></a><span id="l12.488">   *aRetDB = FindInCache(summaryFilePath);</span>
<a href="#l12.489"></a><span id="l12.489">   return NS_OK;</span>
<a href="#l12.490"></a><span id="l12.490"> }</span>
<a href="#l12.491"></a><span id="l12.491"> </span>
<a href="#l12.492"></a><span id="l12.492" class="difflineminus">-NS_IMETHODIMP nsMsgDBService::ForceFolderDBClosed(nsIMsgFolder *aFolder)</span>
<a href="#l12.493"></a><span id="l12.493" class="difflineminus">-{</span>
<a href="#l12.494"></a><span id="l12.494" class="difflineplus">+NS_IMETHODIMP nsMsgDBService::ForceFolderDBClosed(nsIMsgFolder *aFolder) {</span>
<a href="#l12.495"></a><span id="l12.495">   nsCOMPtr&lt;nsIMsgDatabase&gt; mailDB;</span>
<a href="#l12.496"></a><span id="l12.496">   nsresult rv = CachedDBForFolder(aFolder, getter_AddRefs(mailDB));</span>
<a href="#l12.497"></a><span id="l12.497" class="difflineminus">-  if (mailDB)</span>
<a href="#l12.498"></a><span id="l12.498" class="difflineminus">-  {</span>
<a href="#l12.499"></a><span id="l12.499" class="difflineplus">+  if (mailDB) {</span>
<a href="#l12.500"></a><span id="l12.500">     mailDB-&gt;ForceClosed();</span>
<a href="#l12.501"></a><span id="l12.501">   }</span>
<a href="#l12.502"></a><span id="l12.502">   return rv;</span>
<a href="#l12.503"></a><span id="l12.503"> }</span>
<a href="#l12.504"></a><span id="l12.504"> </span>
<a href="#l12.505"></a><span id="l12.505" class="difflineminus">-NS_IMETHODIMP nsMsgDBService::GetOpenDBs(nsIArray **aOpenDBs)</span>
<a href="#l12.506"></a><span id="l12.506" class="difflineminus">-{</span>
<a href="#l12.507"></a><span id="l12.507" class="difflineplus">+NS_IMETHODIMP nsMsgDBService::GetOpenDBs(nsIArray **aOpenDBs) {</span>
<a href="#l12.508"></a><span id="l12.508">   NS_ENSURE_ARG_POINTER(aOpenDBs);</span>
<a href="#l12.509"></a><span id="l12.509">   nsresult rv;</span>
<a href="#l12.510"></a><span id="l12.510" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; openDBs(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l12.511"></a><span id="l12.511" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; openDBs(</span>
<a href="#l12.512"></a><span id="l12.512" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l12.513"></a><span id="l12.513">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.514"></a><span id="l12.514">   for (uint32_t i = 0; i &lt; m_dbCache.Length(); i++)</span>
<a href="#l12.515"></a><span id="l12.515">     openDBs-&gt;AppendElement(m_dbCache[i]);</span>
<a href="#l12.516"></a><span id="l12.516"> </span>
<a href="#l12.517"></a><span id="l12.517">   openDBs.forget(aOpenDBs);</span>
<a href="#l12.518"></a><span id="l12.518">   return NS_OK;</span>
<a href="#l12.519"></a><span id="l12.519"> }</span>
<a href="#l12.520"></a><span id="l12.520"> </span>
<a href="#l12.521"></a><span id="l12.521"> static bool gGotGlobalPrefs = false;</span>
<a href="#l12.522"></a><span id="l12.522"> static bool gThreadWithoutRe = true;</span>
<a href="#l12.523"></a><span id="l12.523"> static bool gStrictThreading = false;</span>
<a href="#l12.524"></a><span id="l12.524"> static bool gCorrectThreading = false;</span>
<a href="#l12.525"></a><span id="l12.525"> </span>
<a href="#l12.526"></a><span id="l12.526" class="difflineminus">-void nsMsgDatabase::GetGlobalPrefs()</span>
<a href="#l12.527"></a><span id="l12.527" class="difflineminus">-{</span>
<a href="#l12.528"></a><span id="l12.528" class="difflineminus">-  if (!gGotGlobalPrefs)</span>
<a href="#l12.529"></a><span id="l12.529" class="difflineminus">-  {</span>
<a href="#l12.530"></a><span id="l12.530" class="difflineplus">+void nsMsgDatabase::GetGlobalPrefs() {</span>
<a href="#l12.531"></a><span id="l12.531" class="difflineplus">+  if (!gGotGlobalPrefs) {</span>
<a href="#l12.532"></a><span id="l12.532">     GetBoolPref(&quot;mail.thread_without_re&quot;, &amp;gThreadWithoutRe);</span>
<a href="#l12.533"></a><span id="l12.533">     GetBoolPref(&quot;mail.strict_threading&quot;, &amp;gStrictThreading);</span>
<a href="#l12.534"></a><span id="l12.534">     GetBoolPref(&quot;mail.correct_threading&quot;, &amp;gCorrectThreading);</span>
<a href="#l12.535"></a><span id="l12.535">     gGotGlobalPrefs = true;</span>
<a href="#l12.536"></a><span id="l12.536">   }</span>
<a href="#l12.537"></a><span id="l12.537"> }</span>
<a href="#l12.538"></a><span id="l12.538"> </span>
<a href="#l12.539"></a><span id="l12.539" class="difflineminus">-nsresult nsMsgDatabase::AddHdrToCache(nsIMsgDBHdr *hdr, nsMsgKey key) // do we want key? We could get it from hdr</span>
<a href="#l12.540"></a><span id="l12.540" class="difflineplus">+nsresult nsMsgDatabase::AddHdrToCache(</span>
<a href="#l12.541"></a><span id="l12.541" class="difflineplus">+    nsIMsgDBHdr *hdr, nsMsgKey key)  // do we want key? We could get it from hdr</span>
<a href="#l12.542"></a><span id="l12.542"> {</span>
<a href="#l12.543"></a><span id="l12.543" class="difflineminus">-  if (m_bCacheHeaders)</span>
<a href="#l12.544"></a><span id="l12.544" class="difflineminus">-  {</span>
<a href="#l12.545"></a><span id="l12.545" class="difflineplus">+  if (m_bCacheHeaders) {</span>
<a href="#l12.546"></a><span id="l12.546">     if (!m_cachedHeaders)</span>
<a href="#l12.547"></a><span id="l12.547" class="difflineminus">-      m_cachedHeaders = new PLDHashTable(&amp;gMsgDBHashTableOps, sizeof(struct MsgHdrHashElement), m_cacheSize);</span>
<a href="#l12.548"></a><span id="l12.548" class="difflineminus">-    if (m_cachedHeaders)</span>
<a href="#l12.549"></a><span id="l12.549" class="difflineminus">-    {</span>
<a href="#l12.550"></a><span id="l12.550" class="difflineminus">-      if (key == nsMsgKey_None)</span>
<a href="#l12.551"></a><span id="l12.551" class="difflineminus">-        hdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.552"></a><span id="l12.552" class="difflineminus">-      if (m_cachedHeaders-&gt;EntryCount() &gt; m_cacheSize)</span>
<a href="#l12.553"></a><span id="l12.553" class="difflineminus">-        ClearHdrCache(true);</span>
<a href="#l12.554"></a><span id="l12.554" class="difflineminus">-      PLDHashEntryHdr *entry = m_cachedHeaders-&gt;Add((void *)(uintptr_t) key, mozilla::fallible);</span>
<a href="#l12.555"></a><span id="l12.555" class="difflineminus">-      if (!entry)</span>
<a href="#l12.556"></a><span id="l12.556" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY; // XXX out of memory</span>
<a href="#l12.557"></a><span id="l12.557" class="difflineminus">-</span>
<a href="#l12.558"></a><span id="l12.558" class="difflineminus">-      MsgHdrHashElement* element = static_cast&lt;MsgHdrHashElement*&gt;(entry);</span>
<a href="#l12.559"></a><span id="l12.559" class="difflineplus">+      m_cachedHeaders = new PLDHashTable(</span>
<a href="#l12.560"></a><span id="l12.560" class="difflineplus">+          &amp;gMsgDBHashTableOps, sizeof(struct MsgHdrHashElement), m_cacheSize);</span>
<a href="#l12.561"></a><span id="l12.561" class="difflineplus">+    if (m_cachedHeaders) {</span>
<a href="#l12.562"></a><span id="l12.562" class="difflineplus">+      if (key == nsMsgKey_None) hdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.563"></a><span id="l12.563" class="difflineplus">+      if (m_cachedHeaders-&gt;EntryCount() &gt; m_cacheSize) ClearHdrCache(true);</span>
<a href="#l12.564"></a><span id="l12.564" class="difflineplus">+      PLDHashEntryHdr *entry =</span>
<a href="#l12.565"></a><span id="l12.565" class="difflineplus">+          m_cachedHeaders-&gt;Add((void *)(uintptr_t)key, mozilla::fallible);</span>
<a href="#l12.566"></a><span id="l12.566" class="difflineplus">+      if (!entry) return NS_ERROR_OUT_OF_MEMORY;  // XXX out of memory</span>
<a href="#l12.567"></a><span id="l12.567" class="difflineplus">+</span>
<a href="#l12.568"></a><span id="l12.568" class="difflineplus">+      MsgHdrHashElement *element = static_cast&lt;MsgHdrHashElement *&gt;(entry);</span>
<a href="#l12.569"></a><span id="l12.569">       element-&gt;mHdr = hdr;</span>
<a href="#l12.570"></a><span id="l12.570">       element-&gt;mKey = key;</span>
<a href="#l12.571"></a><span id="l12.571" class="difflineminus">-      NS_ADDREF(hdr);     // make the cache hold onto the header</span>
<a href="#l12.572"></a><span id="l12.572" class="difflineplus">+      NS_ADDREF(hdr);  // make the cache hold onto the header</span>
<a href="#l12.573"></a><span id="l12.573">       return NS_OK;</span>
<a href="#l12.574"></a><span id="l12.574">     }</span>
<a href="#l12.575"></a><span id="l12.575">   }</span>
<a href="#l12.576"></a><span id="l12.576">   return NS_ERROR_FAILURE;</span>
<a href="#l12.577"></a><span id="l12.577"> }</span>
<a href="#l12.578"></a><span id="l12.578"> </span>
<a href="#l12.579"></a><span id="l12.579" class="difflineminus">-</span>
<a href="#l12.580"></a><span id="l12.580" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::SetMsgHdrCacheSize(uint32_t aSize)</span>
<a href="#l12.581"></a><span id="l12.581" class="difflineminus">-{</span>
<a href="#l12.582"></a><span id="l12.582" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::SetMsgHdrCacheSize(uint32_t aSize) {</span>
<a href="#l12.583"></a><span id="l12.583">   m_cacheSize = aSize;</span>
<a href="#l12.584"></a><span id="l12.584">   return NS_OK;</span>
<a href="#l12.585"></a><span id="l12.585"> }</span>
<a href="#l12.586"></a><span id="l12.586"> </span>
<a href="#l12.587"></a><span id="l12.587" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetMsgHdrCacheSize(uint32_t *aSize)</span>
<a href="#l12.588"></a><span id="l12.588" class="difflineminus">-{</span>
<a href="#l12.589"></a><span id="l12.589" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetMsgHdrCacheSize(uint32_t *aSize) {</span>
<a href="#l12.590"></a><span id="l12.590">   NS_ENSURE_ARG_POINTER(aSize);</span>
<a href="#l12.591"></a><span id="l12.591">   *aSize = m_cacheSize;</span>
<a href="#l12.592"></a><span id="l12.592">   return NS_OK;</span>
<a href="#l12.593"></a><span id="l12.593"> }</span>
<a href="#l12.594"></a><span id="l12.594"> </span>
<a href="#l12.595"></a><span id="l12.595" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetLastUseTime(PRTime *aTime)</span>
<a href="#l12.596"></a><span id="l12.596" class="difflineminus">-{</span>
<a href="#l12.597"></a><span id="l12.597" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetLastUseTime(PRTime *aTime) {</span>
<a href="#l12.598"></a><span id="l12.598">   NS_ENSURE_ARG_POINTER(aTime);</span>
<a href="#l12.599"></a><span id="l12.599">   *aTime = m_lastUseTime;</span>
<a href="#l12.600"></a><span id="l12.600">   return NS_OK;</span>
<a href="#l12.601"></a><span id="l12.601"> }</span>
<a href="#l12.602"></a><span id="l12.602"> </span>
<a href="#l12.603"></a><span id="l12.603" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::SetLastUseTime(PRTime aTime)</span>
<a href="#l12.604"></a><span id="l12.604" class="difflineminus">-{</span>
<a href="#l12.605"></a><span id="l12.605" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::SetLastUseTime(PRTime aTime) {</span>
<a href="#l12.606"></a><span id="l12.606">   gLastUseTime = m_lastUseTime = aTime;</span>
<a href="#l12.607"></a><span id="l12.607">   return NS_OK;</span>
<a href="#l12.608"></a><span id="l12.608"> }</span>
<a href="#l12.609"></a><span id="l12.609"> </span>
<a href="#l12.610"></a><span id="l12.610" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetDatabaseSize(int64_t *_retval)</span>
<a href="#l12.611"></a><span id="l12.611" class="difflineminus">-{</span>
<a href="#l12.612"></a><span id="l12.612" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetDatabaseSize(int64_t *_retval) {</span>
<a href="#l12.613"></a><span id="l12.613">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l12.614"></a><span id="l12.614"> </span>
<a href="#l12.615"></a><span id="l12.615">   nsresult rv;</span>
<a href="#l12.616"></a><span id="l12.616">   bool exists;</span>
<a href="#l12.617"></a><span id="l12.617">   NS_ENSURE_TRUE(m_dbFile, NS_ERROR_NULL_POINTER);</span>
<a href="#l12.618"></a><span id="l12.618">   rv = m_dbFile-&gt;Exists(&amp;exists);</span>
<a href="#l12.619"></a><span id="l12.619" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l12.620"></a><span id="l12.620" class="difflineminus">-  {</span>
<a href="#l12.621"></a><span id="l12.621" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.622"></a><span id="l12.622">     if (exists)</span>
<a href="#l12.623"></a><span id="l12.623">       rv = m_dbFile-&gt;GetFileSize(_retval);</span>
<a href="#l12.624"></a><span id="l12.624">     else</span>
<a href="#l12.625"></a><span id="l12.625">       *_retval = 0;</span>
<a href="#l12.626"></a><span id="l12.626">   }</span>
<a href="#l12.627"></a><span id="l12.627"> </span>
<a href="#l12.628"></a><span id="l12.628">   return rv;</span>
<a href="#l12.629"></a><span id="l12.629"> }</span>
<a href="#l12.630"></a><span id="l12.630"> </span>
<a href="#l12.631"></a><span id="l12.631" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::ClearCachedHdrs()</span>
<a href="#l12.632"></a><span id="l12.632" class="difflineminus">-{</span>
<a href="#l12.633"></a><span id="l12.633" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::ClearCachedHdrs() {</span>
<a href="#l12.634"></a><span id="l12.634">   ClearCachedObjects(false);</span>
<a href="#l12.635"></a><span id="l12.635"> #ifdef DEBUG_bienvenu1</span>
<a href="#l12.636"></a><span id="l12.636" class="difflineminus">-  if (mRefCnt &gt; 1)</span>
<a href="#l12.637"></a><span id="l12.637" class="difflineminus">-  {</span>
<a href="#l12.638"></a><span id="l12.638" class="difflineplus">+  if (mRefCnt &gt; 1) {</span>
<a href="#l12.639"></a><span id="l12.639">     NS_ASSERTION(false, &quot;&quot;);</span>
<a href="#l12.640"></a><span id="l12.640">     printf(&quot;someone's holding onto db - refs = %ld\n&quot;, mRefCnt);</span>
<a href="#l12.641"></a><span id="l12.641">   }</span>
<a href="#l12.642"></a><span id="l12.642"> #endif</span>
<a href="#l12.643"></a><span id="l12.643">   return NS_OK;</span>
<a href="#l12.644"></a><span id="l12.644"> }</span>
<a href="#l12.645"></a><span id="l12.645"> </span>
<a href="#l12.646"></a><span id="l12.646" class="difflineminus">-void nsMsgDatabase::ClearEnumerators()</span>
<a href="#l12.647"></a><span id="l12.647" class="difflineminus">-{</span>
<a href="#l12.648"></a><span id="l12.648" class="difflineplus">+void nsMsgDatabase::ClearEnumerators() {</span>
<a href="#l12.649"></a><span id="l12.649">   // clear out existing enumerators</span>
<a href="#l12.650"></a><span id="l12.650">   nsTArray&lt;nsMsgDBEnumerator *&gt; copyEnumerators;</span>
<a href="#l12.651"></a><span id="l12.651">   copyEnumerators.SwapElements(m_enumerators);</span>
<a href="#l12.652"></a><span id="l12.652"> </span>
<a href="#l12.653"></a><span id="l12.653">   uint32_t numEnums = copyEnumerators.Length();</span>
<a href="#l12.654"></a><span id="l12.654" class="difflineminus">-  for (uint32_t i = 0; i &lt; numEnums; i++)</span>
<a href="#l12.655"></a><span id="l12.655" class="difflineminus">-    copyEnumerators[i]-&gt;Clear();</span>
<a href="#l12.656"></a><span id="l12.656" class="difflineminus">-}</span>
<a href="#l12.657"></a><span id="l12.657" class="difflineminus">-</span>
<a href="#l12.658"></a><span id="l12.658" class="difflineminus">-nsMsgThread *nsMsgDatabase::FindExistingThread(nsMsgKey threadId)</span>
<a href="#l12.659"></a><span id="l12.659" class="difflineminus">-{</span>
<a href="#l12.660"></a><span id="l12.660" class="difflineplus">+  for (uint32_t i = 0; i &lt; numEnums; i++) copyEnumerators[i]-&gt;Clear();</span>
<a href="#l12.661"></a><span id="l12.661" class="difflineplus">+}</span>
<a href="#l12.662"></a><span id="l12.662" class="difflineplus">+</span>
<a href="#l12.663"></a><span id="l12.663" class="difflineplus">+nsMsgThread *nsMsgDatabase::FindExistingThread(nsMsgKey threadId) {</span>
<a href="#l12.664"></a><span id="l12.664">   uint32_t numThreads = m_threads.Length();</span>
<a href="#l12.665"></a><span id="l12.665">   for (uint32_t i = 0; i &lt; numThreads; i++)</span>
<a href="#l12.666"></a><span id="l12.666" class="difflineminus">-    if (m_threads[i]-&gt;m_threadKey == threadId)</span>
<a href="#l12.667"></a><span id="l12.667" class="difflineminus">-      return m_threads[i];</span>
<a href="#l12.668"></a><span id="l12.668" class="difflineplus">+    if (m_threads[i]-&gt;m_threadKey == threadId) return m_threads[i];</span>
<a href="#l12.669"></a><span id="l12.669"> </span>
<a href="#l12.670"></a><span id="l12.670">   return nullptr;</span>
<a href="#l12.671"></a><span id="l12.671"> }</span>
<a href="#l12.672"></a><span id="l12.672"> </span>
<a href="#l12.673"></a><span id="l12.673" class="difflineminus">-void nsMsgDatabase::ClearThreads()</span>
<a href="#l12.674"></a><span id="l12.674" class="difflineminus">-{</span>
<a href="#l12.675"></a><span id="l12.675" class="difflineplus">+void nsMsgDatabase::ClearThreads() {</span>
<a href="#l12.676"></a><span id="l12.676">   // clear out existing threads</span>
<a href="#l12.677"></a><span id="l12.677">   nsTArray&lt;nsMsgThread *&gt; copyThreads;</span>
<a href="#l12.678"></a><span id="l12.678">   copyThreads.SwapElements(m_threads);</span>
<a href="#l12.679"></a><span id="l12.679"> </span>
<a href="#l12.680"></a><span id="l12.680">   uint32_t numThreads = copyThreads.Length();</span>
<a href="#l12.681"></a><span id="l12.681" class="difflineminus">-  for (uint32_t i = 0; i &lt; numThreads; i++)</span>
<a href="#l12.682"></a><span id="l12.682" class="difflineminus">-    copyThreads[i]-&gt;Clear();</span>
<a href="#l12.683"></a><span id="l12.683" class="difflineminus">-}</span>
<a href="#l12.684"></a><span id="l12.684" class="difflineminus">-</span>
<a href="#l12.685"></a><span id="l12.685" class="difflineminus">-void nsMsgDatabase::ClearCachedObjects(bool dbGoingAway)</span>
<a href="#l12.686"></a><span id="l12.686" class="difflineminus">-{</span>
<a href="#l12.687"></a><span id="l12.687" class="difflineplus">+  for (uint32_t i = 0; i &lt; numThreads; i++) copyThreads[i]-&gt;Clear();</span>
<a href="#l12.688"></a><span id="l12.688" class="difflineplus">+}</span>
<a href="#l12.689"></a><span id="l12.689" class="difflineplus">+</span>
<a href="#l12.690"></a><span id="l12.690" class="difflineplus">+void nsMsgDatabase::ClearCachedObjects(bool dbGoingAway) {</span>
<a href="#l12.691"></a><span id="l12.691">   ClearHdrCache(false);</span>
<a href="#l12.692"></a><span id="l12.692"> #ifdef DEBUG_DavidBienvenu</span>
<a href="#l12.693"></a><span id="l12.693" class="difflineminus">-  if (m_headersInUse &amp;&amp; m_headersInUse-&gt;EntryCount() &gt; 0)</span>
<a href="#l12.694"></a><span id="l12.694" class="difflineminus">-  {</span>
<a href="#l12.695"></a><span id="l12.695" class="difflineplus">+  if (m_headersInUse &amp;&amp; m_headersInUse-&gt;EntryCount() &gt; 0) {</span>
<a href="#l12.696"></a><span id="l12.696">     NS_ASSERTION(false, &quot;leaking headers&quot;);</span>
<a href="#l12.697"></a><span id="l12.697">     printf(&quot;leaking %d headers in %s\n&quot;, m_headersInUse-&gt;EntryCount(),</span>
<a href="#l12.698"></a><span id="l12.698">            m_dbFile-&gt;HumanReadablePath().get());</span>
<a href="#l12.699"></a><span id="l12.699">   }</span>
<a href="#l12.700"></a><span id="l12.700"> #endif</span>
<a href="#l12.701"></a><span id="l12.701">   m_cachedThread = nullptr;</span>
<a href="#l12.702"></a><span id="l12.702">   m_cachedThreadId = nsMsgKey_None;</span>
<a href="#l12.703"></a><span id="l12.703" class="difflineminus">-  // We should only clear the use hdr cache when the db is going away, or we could</span>
<a href="#l12.704"></a><span id="l12.704" class="difflineminus">-  // end up with multiple copies of the same logical msg hdr, which will lead to</span>
<a href="#l12.705"></a><span id="l12.705" class="difflineminus">-  // ref-counting problems.</span>
<a href="#l12.706"></a><span id="l12.706" class="difflineminus">-  if (dbGoingAway)</span>
<a href="#l12.707"></a><span id="l12.707" class="difflineminus">-  {</span>
<a href="#l12.708"></a><span id="l12.708" class="difflineplus">+  // We should only clear the use hdr cache when the db is going away, or we</span>
<a href="#l12.709"></a><span id="l12.709" class="difflineplus">+  // could end up with multiple copies of the same logical msg hdr, which will</span>
<a href="#l12.710"></a><span id="l12.710" class="difflineplus">+  // lead to ref-counting problems.</span>
<a href="#l12.711"></a><span id="l12.711" class="difflineplus">+  if (dbGoingAway) {</span>
<a href="#l12.712"></a><span id="l12.712">     ClearUseHdrCache();</span>
<a href="#l12.713"></a><span id="l12.713">     ClearThreads();</span>
<a href="#l12.714"></a><span id="l12.714">   }</span>
<a href="#l12.715"></a><span id="l12.715">   m_thumb = nullptr;</span>
<a href="#l12.716"></a><span id="l12.716"> }</span>
<a href="#l12.717"></a><span id="l12.717"> </span>
<a href="#l12.718"></a><span id="l12.718" class="difflineminus">-nsresult nsMsgDatabase::ClearHdrCache(bool reInit)</span>
<a href="#l12.719"></a><span id="l12.719" class="difflineminus">-{</span>
<a href="#l12.720"></a><span id="l12.720" class="difflineminus">-  if (m_cachedHeaders)</span>
<a href="#l12.721"></a><span id="l12.721" class="difflineminus">-  {</span>
<a href="#l12.722"></a><span id="l12.722" class="difflineplus">+nsresult nsMsgDatabase::ClearHdrCache(bool reInit) {</span>
<a href="#l12.723"></a><span id="l12.723" class="difflineplus">+  if (m_cachedHeaders) {</span>
<a href="#l12.724"></a><span id="l12.724">     // save this away in case we renter this code.</span>
<a href="#l12.725"></a><span id="l12.725" class="difflineminus">-    PLDHashTable  *saveCachedHeaders = m_cachedHeaders;</span>
<a href="#l12.726"></a><span id="l12.726" class="difflineplus">+    PLDHashTable *saveCachedHeaders = m_cachedHeaders;</span>
<a href="#l12.727"></a><span id="l12.727">     m_cachedHeaders = nullptr;</span>
<a href="#l12.728"></a><span id="l12.728">     for (auto iter = saveCachedHeaders-&gt;Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l12.729"></a><span id="l12.729" class="difflineminus">-      auto element = static_cast&lt;MsgHdrHashElement*&gt;(iter.Get());</span>
<a href="#l12.730"></a><span id="l12.730" class="difflineminus">-      if (element)</span>
<a href="#l12.731"></a><span id="l12.731" class="difflineminus">-        NS_IF_RELEASE(element-&gt;mHdr);</span>
<a href="#l12.732"></a><span id="l12.732" class="difflineplus">+      auto element = static_cast&lt;MsgHdrHashElement *&gt;(iter.Get());</span>
<a href="#l12.733"></a><span id="l12.733" class="difflineplus">+      if (element) NS_IF_RELEASE(element-&gt;mHdr);</span>
<a href="#l12.734"></a><span id="l12.734">     }</span>
<a href="#l12.735"></a><span id="l12.735"> </span>
<a href="#l12.736"></a><span id="l12.736" class="difflineminus">-    if (reInit)</span>
<a href="#l12.737"></a><span id="l12.737" class="difflineminus">-    {</span>
<a href="#l12.738"></a><span id="l12.738" class="difflineplus">+    if (reInit) {</span>
<a href="#l12.739"></a><span id="l12.739">       saveCachedHeaders-&gt;ClearAndPrepareForLength(m_cacheSize);</span>
<a href="#l12.740"></a><span id="l12.740">       m_cachedHeaders = saveCachedHeaders;</span>
<a href="#l12.741"></a><span id="l12.741" class="difflineminus">-    }</span>
<a href="#l12.742"></a><span id="l12.742" class="difflineminus">-    else</span>
<a href="#l12.743"></a><span id="l12.743" class="difflineminus">-    {</span>
<a href="#l12.744"></a><span id="l12.744" class="difflineplus">+    } else {</span>
<a href="#l12.745"></a><span id="l12.745">       delete saveCachedHeaders;</span>
<a href="#l12.746"></a><span id="l12.746">     }</span>
<a href="#l12.747"></a><span id="l12.747">   }</span>
<a href="#l12.748"></a><span id="l12.748">   return NS_OK;</span>
<a href="#l12.749"></a><span id="l12.749"> }</span>
<a href="#l12.750"></a><span id="l12.750"> </span>
<a href="#l12.751"></a><span id="l12.751" class="difflineminus">-nsresult nsMsgDatabase::RemoveHdrFromCache(nsIMsgDBHdr *hdr, nsMsgKey key)</span>
<a href="#l12.752"></a><span id="l12.752" class="difflineminus">-{</span>
<a href="#l12.753"></a><span id="l12.753" class="difflineminus">-  if (m_cachedHeaders)</span>
<a href="#l12.754"></a><span id="l12.754" class="difflineminus">-  {</span>
<a href="#l12.755"></a><span id="l12.755" class="difflineminus">-    if (key == nsMsgKey_None)</span>
<a href="#l12.756"></a><span id="l12.756" class="difflineminus">-      hdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.757"></a><span id="l12.757" class="difflineplus">+nsresult nsMsgDatabase::RemoveHdrFromCache(nsIMsgDBHdr *hdr, nsMsgKey key) {</span>
<a href="#l12.758"></a><span id="l12.758" class="difflineplus">+  if (m_cachedHeaders) {</span>
<a href="#l12.759"></a><span id="l12.759" class="difflineplus">+    if (key == nsMsgKey_None) hdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.760"></a><span id="l12.760"> </span>
<a href="#l12.761"></a><span id="l12.761">     PLDHashEntryHdr *entry =</span>
<a href="#l12.762"></a><span id="l12.762" class="difflineminus">-      m_cachedHeaders-&gt;Search((const void *)(uintptr_t) key);</span>
<a href="#l12.763"></a><span id="l12.763" class="difflineminus">-    if (entry)</span>
<a href="#l12.764"></a><span id="l12.764" class="difflineminus">-    {</span>
<a href="#l12.765"></a><span id="l12.765" class="difflineminus">-      m_cachedHeaders-&gt;Remove((void *)(uintptr_t) key);</span>
<a href="#l12.766"></a><span id="l12.766" class="difflineminus">-      NS_RELEASE(hdr); // get rid of extra ref the cache was holding.</span>
<a href="#l12.767"></a><span id="l12.767" class="difflineplus">+        m_cachedHeaders-&gt;Search((const void *)(uintptr_t)key);</span>
<a href="#l12.768"></a><span id="l12.768" class="difflineplus">+    if (entry) {</span>
<a href="#l12.769"></a><span id="l12.769" class="difflineplus">+      m_cachedHeaders-&gt;Remove((void *)(uintptr_t)key);</span>
<a href="#l12.770"></a><span id="l12.770" class="difflineplus">+      NS_RELEASE(hdr);  // get rid of extra ref the cache was holding.</span>
<a href="#l12.771"></a><span id="l12.771">     }</span>
<a href="#l12.772"></a><span id="l12.772" class="difflineminus">-</span>
<a href="#l12.773"></a><span id="l12.773">   }</span>
<a href="#l12.774"></a><span id="l12.774">   return NS_OK;</span>
<a href="#l12.775"></a><span id="l12.775"> }</span>
<a href="#l12.776"></a><span id="l12.776"> </span>
<a href="#l12.777"></a><span id="l12.777" class="difflineminus">-</span>
<a href="#l12.778"></a><span id="l12.778" class="difflineminus">-nsresult nsMsgDatabase::GetHdrFromUseCache(nsMsgKey key, nsIMsgDBHdr* *result)</span>
<a href="#l12.779"></a><span id="l12.779" class="difflineminus">-{</span>
<a href="#l12.780"></a><span id="l12.780" class="difflineminus">-  if (!result)</span>
<a href="#l12.781"></a><span id="l12.781" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.782"></a><span id="l12.782" class="difflineplus">+nsresult nsMsgDatabase::GetHdrFromUseCache(nsMsgKey key, nsIMsgDBHdr **result) {</span>
<a href="#l12.783"></a><span id="l12.783" class="difflineplus">+  if (!result) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.784"></a><span id="l12.784"> </span>
<a href="#l12.785"></a><span id="l12.785">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l12.786"></a><span id="l12.786"> </span>
<a href="#l12.787"></a><span id="l12.787">   *result = nullptr;</span>
<a href="#l12.788"></a><span id="l12.788"> </span>
<a href="#l12.789"></a><span id="l12.789" class="difflineminus">-  if (m_headersInUse)</span>
<a href="#l12.790"></a><span id="l12.790" class="difflineminus">-  {</span>
<a href="#l12.791"></a><span id="l12.791" class="difflineplus">+  if (m_headersInUse) {</span>
<a href="#l12.792"></a><span id="l12.792">     PLDHashEntryHdr *entry =</span>
<a href="#l12.793"></a><span id="l12.793" class="difflineminus">-      m_headersInUse-&gt;Search((const void *)(uintptr_t) key);</span>
<a href="#l12.794"></a><span id="l12.794" class="difflineminus">-    if (entry)</span>
<a href="#l12.795"></a><span id="l12.795" class="difflineminus">-    {</span>
<a href="#l12.796"></a><span id="l12.796" class="difflineminus">-      MsgHdrHashElement* element = static_cast&lt;MsgHdrHashElement*&gt;(entry);</span>
<a href="#l12.797"></a><span id="l12.797" class="difflineplus">+        m_headersInUse-&gt;Search((const void *)(uintptr_t)key);</span>
<a href="#l12.798"></a><span id="l12.798" class="difflineplus">+    if (entry) {</span>
<a href="#l12.799"></a><span id="l12.799" class="difflineplus">+      MsgHdrHashElement *element = static_cast&lt;MsgHdrHashElement *&gt;(entry);</span>
<a href="#l12.800"></a><span id="l12.800">       *result = element-&gt;mHdr;</span>
<a href="#l12.801"></a><span id="l12.801">     }</span>
<a href="#l12.802"></a><span id="l12.802" class="difflineminus">-    if (*result)</span>
<a href="#l12.803"></a><span id="l12.803" class="difflineminus">-    {</span>
<a href="#l12.804"></a><span id="l12.804" class="difflineplus">+    if (*result) {</span>
<a href="#l12.805"></a><span id="l12.805">       NS_ADDREF(*result);</span>
<a href="#l12.806"></a><span id="l12.806">       rv = NS_OK;</span>
<a href="#l12.807"></a><span id="l12.807">     }</span>
<a href="#l12.808"></a><span id="l12.808">   }</span>
<a href="#l12.809"></a><span id="l12.809">   return rv;</span>
<a href="#l12.810"></a><span id="l12.810"> }</span>
<a href="#l12.811"></a><span id="l12.811"> </span>
<a href="#l12.812"></a><span id="l12.812" class="difflineminus">-PLDHashTableOps nsMsgDatabase::gMsgDBHashTableOps =</span>
<a href="#l12.813"></a><span id="l12.813" class="difflineminus">-{</span>
<a href="#l12.814"></a><span id="l12.814" class="difflineminus">-  HashKey,</span>
<a href="#l12.815"></a><span id="l12.815" class="difflineminus">-  MatchEntry,</span>
<a href="#l12.816"></a><span id="l12.816" class="difflineminus">-  MoveEntry,</span>
<a href="#l12.817"></a><span id="l12.817" class="difflineminus">-  ClearEntry,</span>
<a href="#l12.818"></a><span id="l12.818" class="difflineminus">-  nullptr</span>
<a href="#l12.819"></a><span id="l12.819" class="difflineminus">-};</span>
<a href="#l12.820"></a><span id="l12.820" class="difflineplus">+PLDHashTableOps nsMsgDatabase::gMsgDBHashTableOps = {</span>
<a href="#l12.821"></a><span id="l12.821" class="difflineplus">+    HashKey, MatchEntry, MoveEntry, ClearEntry, nullptr};</span>
<a href="#l12.822"></a><span id="l12.822"> </span>
<a href="#l12.823"></a><span id="l12.823"> // HashKey is supposed to maximize entropy in the low order bits, and the key</span>
<a href="#l12.824"></a><span id="l12.824"> // as is, should do that.</span>
<a href="#l12.825"></a><span id="l12.825" class="difflineminus">-PLDHashNumber</span>
<a href="#l12.826"></a><span id="l12.826" class="difflineminus">-nsMsgDatabase::HashKey(const void* aKey)</span>
<a href="#l12.827"></a><span id="l12.827" class="difflineminus">-{</span>
<a href="#l12.828"></a><span id="l12.828" class="difflineplus">+PLDHashNumber nsMsgDatabase::HashKey(const void *aKey) {</span>
<a href="#l12.829"></a><span id="l12.829">   return PLDHashNumber(NS_PTR_TO_INT32(aKey));</span>
<a href="#l12.830"></a><span id="l12.830"> }</span>
<a href="#l12.831"></a><span id="l12.831"> </span>
<a href="#l12.832"></a><span id="l12.832" class="difflineminus">-bool</span>
<a href="#l12.833"></a><span id="l12.833" class="difflineminus">-nsMsgDatabase::MatchEntry(const PLDHashEntryHdr* aEntry, const void* aKey)</span>
<a href="#l12.834"></a><span id="l12.834" class="difflineminus">-{</span>
<a href="#l12.835"></a><span id="l12.835" class="difflineminus">-  const MsgHdrHashElement* hdr = static_cast&lt;const MsgHdrHashElement*&gt;(aEntry);</span>
<a href="#l12.836"></a><span id="l12.836" class="difflineminus">-  return aKey == (const void *)(uintptr_t) hdr-&gt;mKey; // ### or get the key from the hdr...</span>
<a href="#l12.837"></a><span id="l12.837" class="difflineminus">-}</span>
<a href="#l12.838"></a><span id="l12.838" class="difflineminus">-</span>
<a href="#l12.839"></a><span id="l12.839" class="difflineminus">-void</span>
<a href="#l12.840"></a><span id="l12.840" class="difflineminus">-nsMsgDatabase::MoveEntry(PLDHashTable* aTable, const PLDHashEntryHdr* aFrom, PLDHashEntryHdr* aTo)</span>
<a href="#l12.841"></a><span id="l12.841" class="difflineminus">-{</span>
<a href="#l12.842"></a><span id="l12.842" class="difflineminus">-  new (KnownNotNull, aTo) MsgHdrHashElement(std::move(*((MsgHdrHashElement *)aFrom)));</span>
<a href="#l12.843"></a><span id="l12.843" class="difflineminus">-}</span>
<a href="#l12.844"></a><span id="l12.844" class="difflineminus">-</span>
<a href="#l12.845"></a><span id="l12.845" class="difflineminus">-void</span>
<a href="#l12.846"></a><span id="l12.846" class="difflineminus">-nsMsgDatabase::ClearEntry(PLDHashTable* aTable, PLDHashEntryHdr* aEntry)</span>
<a href="#l12.847"></a><span id="l12.847" class="difflineminus">-{</span>
<a href="#l12.848"></a><span id="l12.848" class="difflineminus">-  MsgHdrHashElement* element = static_cast&lt;MsgHdrHashElement*&gt;(aEntry);</span>
<a href="#l12.849"></a><span id="l12.849" class="difflineminus">-  element-&gt;mHdr = nullptr; // eh? Need to release this or not?</span>
<a href="#l12.850"></a><span id="l12.850" class="difflineminus">-  element-&gt;mKey = nsMsgKey_None; // eh?</span>
<a href="#l12.851"></a><span id="l12.851" class="difflineminus">-}</span>
<a href="#l12.852"></a><span id="l12.852" class="difflineminus">-</span>
<a href="#l12.853"></a><span id="l12.853" class="difflineminus">-</span>
<a href="#l12.854"></a><span id="l12.854" class="difflineminus">-nsresult nsMsgDatabase::AddHdrToUseCache(nsIMsgDBHdr *hdr, nsMsgKey key)</span>
<a href="#l12.855"></a><span id="l12.855" class="difflineminus">-{</span>
<a href="#l12.856"></a><span id="l12.856" class="difflineminus">-  if (!m_headersInUse)</span>
<a href="#l12.857"></a><span id="l12.857" class="difflineminus">-  {</span>
<a href="#l12.858"></a><span id="l12.858" class="difflineplus">+bool nsMsgDatabase::MatchEntry(const PLDHashEntryHdr *aEntry,</span>
<a href="#l12.859"></a><span id="l12.859" class="difflineplus">+                               const void *aKey) {</span>
<a href="#l12.860"></a><span id="l12.860" class="difflineplus">+  const MsgHdrHashElement *hdr = static_cast&lt;const MsgHdrHashElement *&gt;(aEntry);</span>
<a href="#l12.861"></a><span id="l12.861" class="difflineplus">+  return aKey == (const void *)(uintptr_t)</span>
<a href="#l12.862"></a><span id="l12.862" class="difflineplus">+                     hdr-&gt;mKey;  // ### or get the key from the hdr...</span>
<a href="#l12.863"></a><span id="l12.863" class="difflineplus">+}</span>
<a href="#l12.864"></a><span id="l12.864" class="difflineplus">+</span>
<a href="#l12.865"></a><span id="l12.865" class="difflineplus">+void nsMsgDatabase::MoveEntry(PLDHashTable *aTable,</span>
<a href="#l12.866"></a><span id="l12.866" class="difflineplus">+                              const PLDHashEntryHdr *aFrom,</span>
<a href="#l12.867"></a><span id="l12.867" class="difflineplus">+                              PLDHashEntryHdr *aTo) {</span>
<a href="#l12.868"></a><span id="l12.868" class="difflineplus">+  new (KnownNotNull, aTo)</span>
<a href="#l12.869"></a><span id="l12.869" class="difflineplus">+      MsgHdrHashElement(std::move(*((MsgHdrHashElement *)aFrom)));</span>
<a href="#l12.870"></a><span id="l12.870" class="difflineplus">+}</span>
<a href="#l12.871"></a><span id="l12.871" class="difflineplus">+</span>
<a href="#l12.872"></a><span id="l12.872" class="difflineplus">+void nsMsgDatabase::ClearEntry(PLDHashTable *aTable, PLDHashEntryHdr *aEntry) {</span>
<a href="#l12.873"></a><span id="l12.873" class="difflineplus">+  MsgHdrHashElement *element = static_cast&lt;MsgHdrHashElement *&gt;(aEntry);</span>
<a href="#l12.874"></a><span id="l12.874" class="difflineplus">+  element-&gt;mHdr = nullptr;        // eh? Need to release this or not?</span>
<a href="#l12.875"></a><span id="l12.875" class="difflineplus">+  element-&gt;mKey = nsMsgKey_None;  // eh?</span>
<a href="#l12.876"></a><span id="l12.876" class="difflineplus">+}</span>
<a href="#l12.877"></a><span id="l12.877" class="difflineplus">+</span>
<a href="#l12.878"></a><span id="l12.878" class="difflineplus">+nsresult nsMsgDatabase::AddHdrToUseCache(nsIMsgDBHdr *hdr, nsMsgKey key) {</span>
<a href="#l12.879"></a><span id="l12.879" class="difflineplus">+  if (!m_headersInUse) {</span>
<a href="#l12.880"></a><span id="l12.880">     mdb_count numHdrs = MSG_HASH_SIZE;</span>
<a href="#l12.881"></a><span id="l12.881">     if (m_mdbAllMsgHeadersTable)</span>
<a href="#l12.882"></a><span id="l12.882">       m_mdbAllMsgHeadersTable-&gt;GetCount(GetEnv(), &amp;numHdrs);</span>
<a href="#l12.883"></a><span id="l12.883" class="difflineminus">-    m_headersInUse = new PLDHashTable(&amp;gMsgDBHashTableOps, sizeof(struct MsgHdrHashElement), std::max((mdb_count)MSG_HASH_SIZE, numHdrs));</span>
<a href="#l12.884"></a><span id="l12.884" class="difflineplus">+    m_headersInUse =</span>
<a href="#l12.885"></a><span id="l12.885" class="difflineplus">+        new PLDHashTable(&amp;gMsgDBHashTableOps, sizeof(struct MsgHdrHashElement),</span>
<a href="#l12.886"></a><span id="l12.886" class="difflineplus">+                         std::max((mdb_count)MSG_HASH_SIZE, numHdrs));</span>
<a href="#l12.887"></a><span id="l12.887">   }</span>
<a href="#l12.888"></a><span id="l12.888" class="difflineminus">-  if (m_headersInUse)</span>
<a href="#l12.889"></a><span id="l12.889" class="difflineminus">-  {</span>
<a href="#l12.890"></a><span id="l12.890" class="difflineminus">-    if (key == nsMsgKey_None)</span>
<a href="#l12.891"></a><span id="l12.891" class="difflineminus">-      hdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.892"></a><span id="l12.892" class="difflineminus">-    PLDHashEntryHdr *entry = m_headersInUse-&gt;Add((void *)(uintptr_t) key, mozilla::fallible);</span>
<a href="#l12.893"></a><span id="l12.893" class="difflineminus">-    if (!entry)</span>
<a href="#l12.894"></a><span id="l12.894" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY; // XXX out of memory</span>
<a href="#l12.895"></a><span id="l12.895" class="difflineminus">-</span>
<a href="#l12.896"></a><span id="l12.896" class="difflineminus">-    MsgHdrHashElement* element = static_cast&lt;MsgHdrHashElement*&gt;(entry);</span>
<a href="#l12.897"></a><span id="l12.897" class="difflineplus">+  if (m_headersInUse) {</span>
<a href="#l12.898"></a><span id="l12.898" class="difflineplus">+    if (key == nsMsgKey_None) hdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.899"></a><span id="l12.899" class="difflineplus">+    PLDHashEntryHdr *entry =</span>
<a href="#l12.900"></a><span id="l12.900" class="difflineplus">+        m_headersInUse-&gt;Add((void *)(uintptr_t)key, mozilla::fallible);</span>
<a href="#l12.901"></a><span id="l12.901" class="difflineplus">+    if (!entry) return NS_ERROR_OUT_OF_MEMORY;  // XXX out of memory</span>
<a href="#l12.902"></a><span id="l12.902" class="difflineplus">+</span>
<a href="#l12.903"></a><span id="l12.903" class="difflineplus">+    MsgHdrHashElement *element = static_cast&lt;MsgHdrHashElement *&gt;(entry);</span>
<a href="#l12.904"></a><span id="l12.904">     element-&gt;mHdr = hdr;</span>
<a href="#l12.905"></a><span id="l12.905">     element-&gt;mKey = key;</span>
<a href="#l12.906"></a><span id="l12.906">     // the hash table won't add ref, we'll do it ourselves</span>
<a href="#l12.907"></a><span id="l12.907">     // stand for the addref that CreateMsgHdr normally does.</span>
<a href="#l12.908"></a><span id="l12.908">     NS_ADDREF(hdr);</span>
<a href="#l12.909"></a><span id="l12.909">     return NS_OK;</span>
<a href="#l12.910"></a><span id="l12.910">   }</span>
<a href="#l12.911"></a><span id="l12.911"> </span>
<a href="#l12.912"></a><span id="l12.912">   return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.913"></a><span id="l12.913"> }</span>
<a href="#l12.914"></a><span id="l12.914"> </span>
<a href="#l12.915"></a><span id="l12.915" class="difflineminus">-nsresult nsMsgDatabase::ClearUseHdrCache()</span>
<a href="#l12.916"></a><span id="l12.916" class="difflineminus">-{</span>
<a href="#l12.917"></a><span id="l12.917" class="difflineminus">-  if (m_headersInUse)</span>
<a href="#l12.918"></a><span id="l12.918" class="difflineminus">-  {</span>
<a href="#l12.919"></a><span id="l12.919" class="difflineplus">+nsresult nsMsgDatabase::ClearUseHdrCache() {</span>
<a href="#l12.920"></a><span id="l12.920" class="difflineplus">+  if (m_headersInUse) {</span>
<a href="#l12.921"></a><span id="l12.921">     // clear mdb row pointers of any headers still in use, because the</span>
<a href="#l12.922"></a><span id="l12.922">     // underlying db is going away.</span>
<a href="#l12.923"></a><span id="l12.923">     for (auto iter = m_headersInUse-&gt;Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l12.924"></a><span id="l12.924" class="difflineminus">-      auto element = static_cast&lt;const MsgHdrHashElement*&gt;(iter.Get());</span>
<a href="#l12.925"></a><span id="l12.925" class="difflineplus">+      auto element = static_cast&lt;const MsgHdrHashElement *&gt;(iter.Get());</span>
<a href="#l12.926"></a><span id="l12.926">       if (element &amp;&amp; element-&gt;mHdr) {</span>
<a href="#l12.927"></a><span id="l12.927" class="difflineminus">-        nsMsgHdr* msgHdr = static_cast&lt;nsMsgHdr*&gt;(element-&gt;mHdr);  // closed system, so this is ok</span>
<a href="#l12.928"></a><span id="l12.928" class="difflineminus">-        // clear out m_mdbRow member variable - the db is going away, which means that this member</span>
<a href="#l12.929"></a><span id="l12.929" class="difflineminus">-        // variable might very well point to a mork db that is gone.</span>
<a href="#l12.930"></a><span id="l12.930" class="difflineplus">+        nsMsgHdr *msgHdr = static_cast&lt;nsMsgHdr *&gt;(</span>
<a href="#l12.931"></a><span id="l12.931" class="difflineplus">+            element-&gt;mHdr);  // closed system, so this is ok</span>
<a href="#l12.932"></a><span id="l12.932" class="difflineplus">+        // clear out m_mdbRow member variable - the db is going away, which</span>
<a href="#l12.933"></a><span id="l12.933" class="difflineplus">+        // means that this member variable might very well point to a mork db</span>
<a href="#l12.934"></a><span id="l12.934" class="difflineplus">+        // that is gone.</span>
<a href="#l12.935"></a><span id="l12.935">         NS_IF_RELEASE(msgHdr-&gt;m_mdbRow);</span>
<a href="#l12.936"></a><span id="l12.936" class="difflineminus">-    //    NS_IF_RELEASE(msgHdr-&gt;m_mdb);</span>
<a href="#l12.937"></a><span id="l12.937" class="difflineplus">+        //    NS_IF_RELEASE(msgHdr-&gt;m_mdb);</span>
<a href="#l12.938"></a><span id="l12.938">       }</span>
<a href="#l12.939"></a><span id="l12.939">     }</span>
<a href="#l12.940"></a><span id="l12.940">     delete m_headersInUse;</span>
<a href="#l12.941"></a><span id="l12.941">     m_headersInUse = nullptr;</span>
<a href="#l12.942"></a><span id="l12.942">   }</span>
<a href="#l12.943"></a><span id="l12.943">   return NS_OK;</span>
<a href="#l12.944"></a><span id="l12.944"> }</span>
<a href="#l12.945"></a><span id="l12.945"> </span>
<a href="#l12.946"></a><span id="l12.946" class="difflineminus">-nsresult nsMsgDatabase::RemoveHdrFromUseCache(nsIMsgDBHdr *hdr, nsMsgKey key)</span>
<a href="#l12.947"></a><span id="l12.947" class="difflineminus">-{</span>
<a href="#l12.948"></a><span id="l12.948" class="difflineminus">-  if (m_headersInUse)</span>
<a href="#l12.949"></a><span id="l12.949" class="difflineminus">-  {</span>
<a href="#l12.950"></a><span id="l12.950" class="difflineminus">-    if (key == nsMsgKey_None)</span>
<a href="#l12.951"></a><span id="l12.951" class="difflineminus">-      hdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.952"></a><span id="l12.952" class="difflineminus">-</span>
<a href="#l12.953"></a><span id="l12.953" class="difflineminus">-    m_headersInUse-&gt;Remove((void *)(uintptr_t) key);</span>
<a href="#l12.954"></a><span id="l12.954" class="difflineplus">+nsresult nsMsgDatabase::RemoveHdrFromUseCache(nsIMsgDBHdr *hdr, nsMsgKey key) {</span>
<a href="#l12.955"></a><span id="l12.955" class="difflineplus">+  if (m_headersInUse) {</span>
<a href="#l12.956"></a><span id="l12.956" class="difflineplus">+    if (key == nsMsgKey_None) hdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.957"></a><span id="l12.957" class="difflineplus">+</span>
<a href="#l12.958"></a><span id="l12.958" class="difflineplus">+    m_headersInUse-&gt;Remove((void *)(uintptr_t)key);</span>
<a href="#l12.959"></a><span id="l12.959">   }</span>
<a href="#l12.960"></a><span id="l12.960">   return NS_OK;</span>
<a href="#l12.961"></a><span id="l12.961"> }</span>
<a href="#l12.962"></a><span id="l12.962"> </span>
<a href="#l12.963"></a><span id="l12.963" class="difflineminus">-</span>
<a href="#l12.964"></a><span id="l12.964" class="difflineminus">-nsresult</span>
<a href="#l12.965"></a><span id="l12.965" class="difflineminus">-nsMsgDatabase::CreateMsgHdr(nsIMdbRow* hdrRow, nsMsgKey key, nsIMsgDBHdr* *result)</span>
<a href="#l12.966"></a><span id="l12.966" class="difflineminus">-{</span>
<a href="#l12.967"></a><span id="l12.967" class="difflineplus">+nsresult nsMsgDatabase::CreateMsgHdr(nsIMdbRow *hdrRow, nsMsgKey key,</span>
<a href="#l12.968"></a><span id="l12.968" class="difflineplus">+                                     nsIMsgDBHdr **result) {</span>
<a href="#l12.969"></a><span id="l12.969">   NS_ENSURE_ARG_POINTER(hdrRow);</span>
<a href="#l12.970"></a><span id="l12.970">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l12.971"></a><span id="l12.971"> </span>
<a href="#l12.972"></a><span id="l12.972">   nsresult rv = GetHdrFromUseCache(key, result);</span>
<a href="#l12.973"></a><span id="l12.973" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; *result)</span>
<a href="#l12.974"></a><span id="l12.974" class="difflineminus">-  {</span>
<a href="#l12.975"></a><span id="l12.975" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; *result) {</span>
<a href="#l12.976"></a><span id="l12.976">     hdrRow-&gt;Release();</span>
<a href="#l12.977"></a><span id="l12.977">     return rv;</span>
<a href="#l12.978"></a><span id="l12.978">   }</span>
<a href="#l12.979"></a><span id="l12.979"> </span>
<a href="#l12.980"></a><span id="l12.980">   nsMsgHdr *msgHdr = new nsMsgHdr(this, hdrRow);</span>
<a href="#l12.981"></a><span id="l12.981" class="difflineminus">-  if(!msgHdr)</span>
<a href="#l12.982"></a><span id="l12.982" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.983"></a><span id="l12.983" class="difflineplus">+  if (!msgHdr) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.984"></a><span id="l12.984">   msgHdr-&gt;SetMessageKey(key);</span>
<a href="#l12.985"></a><span id="l12.985">   // don't need to addref here; GetHdrFromUseCache addrefs.</span>
<a href="#l12.986"></a><span id="l12.986">   *result = msgHdr;</span>
<a href="#l12.987"></a><span id="l12.987"> </span>
<a href="#l12.988"></a><span id="l12.988">   AddHdrToCache(msgHdr, key);</span>
<a href="#l12.989"></a><span id="l12.989"> </span>
<a href="#l12.990"></a><span id="l12.990">   return NS_OK;</span>
<a href="#l12.991"></a><span id="l12.991"> }</span>
<a href="#l12.992"></a><span id="l12.992"> </span>
<a href="#l12.993"></a><span id="l12.993" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::AddListener(nsIDBChangeListener *aListener)</span>
<a href="#l12.994"></a><span id="l12.994" class="difflineminus">-{</span>
<a href="#l12.995"></a><span id="l12.995" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::AddListener(nsIDBChangeListener *aListener) {</span>
<a href="#l12.996"></a><span id="l12.996">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l12.997"></a><span id="l12.997">   m_ChangeListeners.AppendElementUnlessExists(aListener);</span>
<a href="#l12.998"></a><span id="l12.998">   return NS_OK;</span>
<a href="#l12.999"></a><span id="l12.999"> }</span>
<a href="#l12.1000"></a><span id="l12.1000"> </span>
<a href="#l12.1001"></a><span id="l12.1001" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::RemoveListener(nsIDBChangeListener *aListener)</span>
<a href="#l12.1002"></a><span id="l12.1002" class="difflineminus">-{</span>
<a href="#l12.1003"></a><span id="l12.1003" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::RemoveListener(nsIDBChangeListener *aListener) {</span>
<a href="#l12.1004"></a><span id="l12.1004">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l12.1005"></a><span id="l12.1005">   m_ChangeListeners.RemoveElement(aListener);</span>
<a href="#l12.1006"></a><span id="l12.1006">   return NS_OK;</span>
<a href="#l12.1007"></a><span id="l12.1007"> }</span>
<a href="#l12.1008"></a><span id="l12.1008"> </span>
<a href="#l12.1009"></a><span id="l12.1009"> // XXX should we return rv for listener-&gt;propertyfunc_?</span>
<a href="#l12.1010"></a><span id="l12.1010" class="difflineminus">-#define NOTIFY_LISTENERS(propertyfunc_, params_) \</span>
<a href="#l12.1011"></a><span id="l12.1011" class="difflineminus">-  PR_BEGIN_MACRO \</span>
<a href="#l12.1012"></a><span id="l12.1012" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIDBChangeListener&gt; &gt;::ForwardIterator iter(m_ChangeListeners); \</span>
<a href="#l12.1013"></a><span id="l12.1013" class="difflineminus">-  nsCOMPtr&lt;nsIDBChangeListener&gt; listener; \</span>
<a href="#l12.1014"></a><span id="l12.1014" class="difflineminus">-  while (iter.HasMore()) { \</span>
<a href="#l12.1015"></a><span id="l12.1015" class="difflineminus">-    listener = iter.GetNext(); \</span>
<a href="#l12.1016"></a><span id="l12.1016" class="difflineminus">-    listener-&gt;propertyfunc_ params_; \</span>
<a href="#l12.1017"></a><span id="l12.1017" class="difflineminus">-  } \</span>
<a href="#l12.1018"></a><span id="l12.1018" class="difflineplus">+#define NOTIFY_LISTENERS(propertyfunc_, params_)                          \</span>
<a href="#l12.1019"></a><span id="l12.1019" class="difflineplus">+  PR_BEGIN_MACRO                                                          \</span>
<a href="#l12.1020"></a><span id="l12.1020" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIDBChangeListener&gt; &gt;::ForwardIterator iter( \</span>
<a href="#l12.1021"></a><span id="l12.1021" class="difflineplus">+      m_ChangeListeners);                                                 \</span>
<a href="#l12.1022"></a><span id="l12.1022" class="difflineplus">+  nsCOMPtr&lt;nsIDBChangeListener&gt; listener;                                 \</span>
<a href="#l12.1023"></a><span id="l12.1023" class="difflineplus">+  while (iter.HasMore()) {                                                \</span>
<a href="#l12.1024"></a><span id="l12.1024" class="difflineplus">+    listener = iter.GetNext();                                            \</span>
<a href="#l12.1025"></a><span id="l12.1025" class="difflineplus">+    listener-&gt;propertyfunc_ params_;                                      \</span>
<a href="#l12.1026"></a><span id="l12.1026" class="difflineplus">+  }                                                                       \</span>
<a href="#l12.1027"></a><span id="l12.1027">   PR_END_MACRO</span>
<a href="#l12.1028"></a><span id="l12.1028"> </span>
<a href="#l12.1029"></a><span id="l12.1029"> // change announcer methods - just broadcast to all listeners.</span>
<a href="#l12.1030"></a><span id="l12.1030" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::NotifyHdrChangeAll(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l12.1031"></a><span id="l12.1031" class="difflineminus">-                                                uint32_t aOldFlags,</span>
<a href="#l12.1032"></a><span id="l12.1032" class="difflineminus">-                                                uint32_t aNewFlags,</span>
<a href="#l12.1033"></a><span id="l12.1033" class="difflineminus">-                                                nsIDBChangeListener *aInstigator)</span>
<a href="#l12.1034"></a><span id="l12.1034" class="difflineminus">-{</span>
<a href="#l12.1035"></a><span id="l12.1035" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::NotifyHdrChangeAll(</span>
<a href="#l12.1036"></a><span id="l12.1036" class="difflineplus">+    nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags, uint32_t aNewFlags,</span>
<a href="#l12.1037"></a><span id="l12.1037" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l12.1038"></a><span id="l12.1038">   // We will only notify the change if the header exists in the database.</span>
<a href="#l12.1039"></a><span id="l12.1039">   // This allows database functions to be usable in both the case where the</span>
<a href="#l12.1040"></a><span id="l12.1040">   // header is in the db, or the header is not so no notifications should be</span>
<a href="#l12.1041"></a><span id="l12.1041">   // given.</span>
<a href="#l12.1042"></a><span id="l12.1042">   nsMsgKey key;</span>
<a href="#l12.1043"></a><span id="l12.1043">   bool inDb = false;</span>
<a href="#l12.1044"></a><span id="l12.1044" class="difflineminus">-  if (aHdrChanged)</span>
<a href="#l12.1045"></a><span id="l12.1045" class="difflineminus">-  {</span>
<a href="#l12.1046"></a><span id="l12.1046" class="difflineplus">+  if (aHdrChanged) {</span>
<a href="#l12.1047"></a><span id="l12.1047">     aHdrChanged-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.1048"></a><span id="l12.1048">     ContainsKey(key, &amp;inDb);</span>
<a href="#l12.1049"></a><span id="l12.1049">   }</span>
<a href="#l12.1050"></a><span id="l12.1050">   if (inDb)</span>
<a href="#l12.1051"></a><span id="l12.1051">     NOTIFY_LISTENERS(OnHdrFlagsChanged,</span>
<a href="#l12.1052"></a><span id="l12.1052">                      (aHdrChanged, aOldFlags, aNewFlags, aInstigator));</span>
<a href="#l12.1053"></a><span id="l12.1053">   return NS_OK;</span>
<a href="#l12.1054"></a><span id="l12.1054"> }</span>
<a href="#l12.1055"></a><span id="l12.1055"> </span>
<a href="#l12.1056"></a><span id="l12.1056" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::NotifyReadChanged(nsIDBChangeListener *aInstigator)</span>
<a href="#l12.1057"></a><span id="l12.1057" class="difflineminus">-{</span>
<a href="#l12.1058"></a><span id="l12.1058" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::NotifyReadChanged(</span>
<a href="#l12.1059"></a><span id="l12.1059" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l12.1060"></a><span id="l12.1060">   NOTIFY_LISTENERS(OnReadChanged, (aInstigator));</span>
<a href="#l12.1061"></a><span id="l12.1061">   return NS_OK;</span>
<a href="#l12.1062"></a><span id="l12.1062"> }</span>
<a href="#l12.1063"></a><span id="l12.1063"> </span>
<a href="#l12.1064"></a><span id="l12.1064" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::NotifyJunkScoreChanged(nsIDBChangeListener *aInstigator)</span>
<a href="#l12.1065"></a><span id="l12.1065" class="difflineminus">-{</span>
<a href="#l12.1066"></a><span id="l12.1066" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::NotifyJunkScoreChanged(</span>
<a href="#l12.1067"></a><span id="l12.1067" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l12.1068"></a><span id="l12.1068">   NOTIFY_LISTENERS(OnJunkScoreChanged, (aInstigator));</span>
<a href="#l12.1069"></a><span id="l12.1069">   return NS_OK;</span>
<a href="#l12.1070"></a><span id="l12.1070"> }</span>
<a href="#l12.1071"></a><span id="l12.1071"> </span>
<a href="#l12.1072"></a><span id="l12.1072" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::NotifyHdrDeletedAll(nsIMsgDBHdr *aHdrDeleted,</span>
<a href="#l12.1073"></a><span id="l12.1073" class="difflineminus">-                                                 nsMsgKey aParentKey,</span>
<a href="#l12.1074"></a><span id="l12.1074" class="difflineminus">-                                                 int32_t aFlags,</span>
<a href="#l12.1075"></a><span id="l12.1075" class="difflineminus">-                                                 nsIDBChangeListener *aInstigator)</span>
<a href="#l12.1076"></a><span id="l12.1076" class="difflineminus">-{</span>
<a href="#l12.1077"></a><span id="l12.1077" class="difflineminus">-  NOTIFY_LISTENERS(OnHdrDeleted, (aHdrDeleted, aParentKey, aFlags, aInstigator));</span>
<a href="#l12.1078"></a><span id="l12.1078" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::NotifyHdrDeletedAll(</span>
<a href="#l12.1079"></a><span id="l12.1079" class="difflineplus">+    nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey, int32_t aFlags,</span>
<a href="#l12.1080"></a><span id="l12.1080" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l12.1081"></a><span id="l12.1081" class="difflineplus">+  NOTIFY_LISTENERS(OnHdrDeleted,</span>
<a href="#l12.1082"></a><span id="l12.1082" class="difflineplus">+                   (aHdrDeleted, aParentKey, aFlags, aInstigator));</span>
<a href="#l12.1083"></a><span id="l12.1083">   return NS_OK;</span>
<a href="#l12.1084"></a><span id="l12.1084"> }</span>
<a href="#l12.1085"></a><span id="l12.1085"> </span>
<a href="#l12.1086"></a><span id="l12.1086" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::NotifyHdrAddedAll(nsIMsgDBHdr *aHdrAdded,</span>
<a href="#l12.1087"></a><span id="l12.1087" class="difflineminus">-                                               nsMsgKey aParentKey,</span>
<a href="#l12.1088"></a><span id="l12.1088" class="difflineminus">-                                               int32_t aFlags,</span>
<a href="#l12.1089"></a><span id="l12.1089" class="difflineminus">-                                               nsIDBChangeListener *aInstigator)</span>
<a href="#l12.1090"></a><span id="l12.1090" class="difflineminus">-{</span>
<a href="#l12.1091"></a><span id="l12.1091" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::NotifyHdrAddedAll(</span>
<a href="#l12.1092"></a><span id="l12.1092" class="difflineplus">+    nsIMsgDBHdr *aHdrAdded, nsMsgKey aParentKey, int32_t aFlags,</span>
<a href="#l12.1093"></a><span id="l12.1093" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l12.1094"></a><span id="l12.1094"> #ifdef DEBUG_bienvenu1</span>
<a href="#l12.1095"></a><span id="l12.1095">   printf(&quot;notifying add of %ld parent %ld\n&quot;, keyAdded, parentKey);</span>
<a href="#l12.1096"></a><span id="l12.1096"> #endif</span>
<a href="#l12.1097"></a><span id="l12.1097">   NOTIFY_LISTENERS(OnHdrAdded, (aHdrAdded, aParentKey, aFlags, aInstigator));</span>
<a href="#l12.1098"></a><span id="l12.1098">   return NS_OK;</span>
<a href="#l12.1099"></a><span id="l12.1099"> }</span>
<a href="#l12.1100"></a><span id="l12.1100"> </span>
<a href="#l12.1101"></a><span id="l12.1101" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::NotifyParentChangedAll(nsMsgKey aKeyReparented,</span>
<a href="#l12.1102"></a><span id="l12.1102" class="difflineminus">-                                                    nsMsgKey aOldParent,</span>
<a href="#l12.1103"></a><span id="l12.1103" class="difflineminus">-                                                    nsMsgKey aNewParent,</span>
<a href="#l12.1104"></a><span id="l12.1104" class="difflineminus">-                                                    nsIDBChangeListener *aInstigator)</span>
<a href="#l12.1105"></a><span id="l12.1105" class="difflineminus">-{</span>
<a href="#l12.1106"></a><span id="l12.1106" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::NotifyParentChangedAll(</span>
<a href="#l12.1107"></a><span id="l12.1107" class="difflineplus">+    nsMsgKey aKeyReparented, nsMsgKey aOldParent, nsMsgKey aNewParent,</span>
<a href="#l12.1108"></a><span id="l12.1108" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l12.1109"></a><span id="l12.1109">   NOTIFY_LISTENERS(OnParentChanged,</span>
<a href="#l12.1110"></a><span id="l12.1110">                    (aKeyReparented, aOldParent, aNewParent, aInstigator));</span>
<a href="#l12.1111"></a><span id="l12.1111">   return NS_OK;</span>
<a href="#l12.1112"></a><span id="l12.1112"> }</span>
<a href="#l12.1113"></a><span id="l12.1113"> </span>
<a href="#l12.1114"></a><span id="l12.1114" class="difflineminus">-</span>
<a href="#l12.1115"></a><span id="l12.1115" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::NotifyAnnouncerGoingAway(void)</span>
<a href="#l12.1116"></a><span id="l12.1116" class="difflineminus">-{</span>
<a href="#l12.1117"></a><span id="l12.1117" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::NotifyAnnouncerGoingAway(void) {</span>
<a href="#l12.1118"></a><span id="l12.1118">   NOTIFY_LISTENERS(OnAnnouncerGoingAway, (this));</span>
<a href="#l12.1119"></a><span id="l12.1119">   return NS_OK;</span>
<a href="#l12.1120"></a><span id="l12.1120"> }</span>
<a href="#l12.1121"></a><span id="l12.1121"> </span>
<a href="#l12.1122"></a><span id="l12.1122"> bool nsMsgDatabase::MatchDbName(nsIFile *dbFile)  // returns true if they match</span>
<a href="#l12.1123"></a><span id="l12.1123"> {</span>
<a href="#l12.1124"></a><span id="l12.1124">   NS_ENSURE_TRUE(m_dbFile, false);</span>
<a href="#l12.1125"></a><span id="l12.1125">   return dbFile-&gt;NativePath().Equals(m_dbFile-&gt;NativePath());</span>
<a href="#l12.1126"></a><span id="l12.1126"> }</span>
<a href="#l12.1127"></a><span id="l12.1127"> </span>
<a href="#l12.1128"></a><span id="l12.1128" class="difflineminus">-void nsMsgDBService::AddToCache(nsMsgDatabase* pMessageDB)</span>
<a href="#l12.1129"></a><span id="l12.1129" class="difflineminus">-{</span>
<a href="#l12.1130"></a><span id="l12.1130" class="difflineplus">+void nsMsgDBService::AddToCache(nsMsgDatabase *pMessageDB) {</span>
<a href="#l12.1131"></a><span id="l12.1131"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l12.1132"></a><span id="l12.1132">   NS_ASSERTION(m_dbCache.Length() &lt; 50, &quot;50 or more open db's&quot;);</span>
<a href="#l12.1133"></a><span id="l12.1133"> #endif</span>
<a href="#l12.1134"></a><span id="l12.1134"> #ifdef DEBUG</span>
<a href="#l12.1135"></a><span id="l12.1135" class="difflineminus">-  if (pMessageDB-&gt;m_folder)</span>
<a href="#l12.1136"></a><span id="l12.1136" class="difflineminus">-  {</span>
<a href="#l12.1137"></a><span id="l12.1137" class="difflineplus">+  if (pMessageDB-&gt;m_folder) {</span>
<a href="#l12.1138"></a><span id="l12.1138">     nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l12.1139"></a><span id="l12.1139">     CachedDBForFolder(pMessageDB-&gt;m_folder, getter_AddRefs(msgDB));</span>
<a href="#l12.1140"></a><span id="l12.1140">     NS_ASSERTION(!msgDB, &quot;shouldn't have db in cache&quot;);</span>
<a href="#l12.1141"></a><span id="l12.1141">   }</span>
<a href="#l12.1142"></a><span id="l12.1142"> #endif</span>
<a href="#l12.1143"></a><span id="l12.1143">   m_dbCache.AppendElement(pMessageDB);</span>
<a href="#l12.1144"></a><span id="l12.1144"> }</span>
<a href="#l12.1145"></a><span id="l12.1145"> </span>
<a href="#l12.1146"></a><span id="l12.1146"> /**</span>
<a href="#l12.1147"></a><span id="l12.1147">  * Log the open db's, and how many headers are in memory.</span>
<a href="#l12.1148"></a><span id="l12.1148">  */</span>
<a href="#l12.1149"></a><span id="l12.1149" class="difflineminus">-void nsMsgDBService::DumpCache()</span>
<a href="#l12.1150"></a><span id="l12.1150" class="difflineminus">-{</span>
<a href="#l12.1151"></a><span id="l12.1151" class="difflineminus">-  nsMsgDatabase* db = nullptr;</span>
<a href="#l12.1152"></a><span id="l12.1152" class="difflineplus">+void nsMsgDBService::DumpCache() {</span>
<a href="#l12.1153"></a><span id="l12.1153" class="difflineplus">+  nsMsgDatabase *db = nullptr;</span>
<a href="#l12.1154"></a><span id="l12.1154">   MOZ_LOG(DBLog, LogLevel::Info, (&quot;%zu open DBs\n&quot;, m_dbCache.Length()));</span>
<a href="#l12.1155"></a><span id="l12.1155" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_dbCache.Length(); i++)</span>
<a href="#l12.1156"></a><span id="l12.1156" class="difflineminus">-  {</span>
<a href="#l12.1157"></a><span id="l12.1157" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_dbCache.Length(); i++) {</span>
<a href="#l12.1158"></a><span id="l12.1158">     db = m_dbCache.ElementAt(i);</span>
<a href="#l12.1159"></a><span id="l12.1159" class="difflineminus">-    MOZ_LOG(DBLog, LogLevel::Info, (&quot;%s - %&quot; PRIu32 &quot; hdrs in use\n&quot;,</span>
<a href="#l12.1160"></a><span id="l12.1160" class="difflineminus">-      db-&gt;m_dbFile-&gt;HumanReadablePath().get(),</span>
<a href="#l12.1161"></a><span id="l12.1161" class="difflineminus">-      db-&gt;m_headersInUse ? db-&gt;m_headersInUse-&gt;EntryCount() : 0));</span>
<a href="#l12.1162"></a><span id="l12.1162" class="difflineplus">+    MOZ_LOG(DBLog, LogLevel::Info,</span>
<a href="#l12.1163"></a><span id="l12.1163" class="difflineplus">+            (&quot;%s - %&quot; PRIu32 &quot; hdrs in use\n&quot;,</span>
<a href="#l12.1164"></a><span id="l12.1164" class="difflineplus">+             db-&gt;m_dbFile-&gt;HumanReadablePath().get(),</span>
<a href="#l12.1165"></a><span id="l12.1165" class="difflineplus">+             db-&gt;m_headersInUse ? db-&gt;m_headersInUse-&gt;EntryCount() : 0));</span>
<a href="#l12.1166"></a><span id="l12.1166">   }</span>
<a href="#l12.1167"></a><span id="l12.1167"> }</span>
<a href="#l12.1168"></a><span id="l12.1168"> </span>
<a href="#l12.1169"></a><span id="l12.1169"> // Memory Reporting implementations</span>
<a href="#l12.1170"></a><span id="l12.1170"> </span>
<a href="#l12.1171"></a><span id="l12.1171" class="difflineminus">-size_t nsMsgDatabase::SizeOfExcludingThis(mozilla::MallocSizeOf aMallocSizeOf) const</span>
<a href="#l12.1172"></a><span id="l12.1172" class="difflineminus">-{</span>
<a href="#l12.1173"></a><span id="l12.1173" class="difflineplus">+size_t nsMsgDatabase::SizeOfExcludingThis(</span>
<a href="#l12.1174"></a><span id="l12.1174" class="difflineplus">+    mozilla::MallocSizeOf aMallocSizeOf) const {</span>
<a href="#l12.1175"></a><span id="l12.1175">   size_t totalSize = 0;</span>
<a href="#l12.1176"></a><span id="l12.1176">   if (m_dbFolderInfo)</span>
<a href="#l12.1177"></a><span id="l12.1177">     totalSize += m_dbFolderInfo-&gt;SizeOfExcludingThis(aMallocSizeOf);</span>
<a href="#l12.1178"></a><span id="l12.1178" class="difflineminus">-  if (m_mdbEnv)</span>
<a href="#l12.1179"></a><span id="l12.1179" class="difflineminus">-  {</span>
<a href="#l12.1180"></a><span id="l12.1180" class="difflineplus">+  if (m_mdbEnv) {</span>
<a href="#l12.1181"></a><span id="l12.1181">     nsIMdbHeap *morkHeap = nullptr;</span>
<a href="#l12.1182"></a><span id="l12.1182">     m_mdbEnv-&gt;GetHeap(&amp;morkHeap);</span>
<a href="#l12.1183"></a><span id="l12.1183" class="difflineminus">-    if (morkHeap)</span>
<a href="#l12.1184"></a><span id="l12.1184" class="difflineminus">-      totalSize += morkHeap-&gt;GetUsedSize();</span>
<a href="#l12.1185"></a><span id="l12.1185" class="difflineplus">+    if (morkHeap) totalSize += morkHeap-&gt;GetUsedSize();</span>
<a href="#l12.1186"></a><span id="l12.1186">   }</span>
<a href="#l12.1187"></a><span id="l12.1187">   totalSize += m_newSet.ShallowSizeOfExcludingThis(aMallocSizeOf);</span>
<a href="#l12.1188"></a><span id="l12.1188">   totalSize += m_ChangeListeners.ShallowSizeOfExcludingThis(aMallocSizeOf);</span>
<a href="#l12.1189"></a><span id="l12.1189">   totalSize += m_threads.ShallowSizeOfExcludingThis(aMallocSizeOf);</span>
<a href="#l12.1190"></a><span id="l12.1190">   // We have two tables of header objects, but every header in m_cachedHeaders</span>
<a href="#l12.1191"></a><span id="l12.1191">   // should be in m_headersInUse.</span>
<a href="#l12.1192"></a><span id="l12.1192">   // double-counting...</span>
<a href="#l12.1193"></a><span id="l12.1193">   size_t headerSize = 0;</span>
<a href="#l12.1194"></a><span id="l12.1194" class="difflineminus">-  if (m_headersInUse)</span>
<a href="#l12.1195"></a><span id="l12.1195" class="difflineminus">-  {</span>
<a href="#l12.1196"></a><span id="l12.1196" class="difflineplus">+  if (m_headersInUse) {</span>
<a href="#l12.1197"></a><span id="l12.1197">     headerSize = m_headersInUse-&gt;ShallowSizeOfIncludingThis(aMallocSizeOf);</span>
<a href="#l12.1198"></a><span id="l12.1198">     for (auto iter = m_headersInUse-&gt;Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l12.1199"></a><span id="l12.1199" class="difflineminus">-      auto entry = static_cast&lt;MsgHdrHashElement*&gt;(iter.Get());</span>
<a href="#l12.1200"></a><span id="l12.1200" class="difflineplus">+      auto entry = static_cast&lt;MsgHdrHashElement *&gt;(iter.Get());</span>
<a href="#l12.1201"></a><span id="l12.1201">       // Sigh, this is dangerous, but so long as this is a closed system, this</span>
<a href="#l12.1202"></a><span id="l12.1202">       // is safe.</span>
<a href="#l12.1203"></a><span id="l12.1203" class="difflineminus">-      headerSize += static_cast&lt;nsMsgHdr*&gt;(entry-&gt;mHdr)-&gt;SizeOfIncludingThis(aMallocSizeOf);</span>
<a href="#l12.1204"></a><span id="l12.1204" class="difflineplus">+      headerSize += static_cast&lt;nsMsgHdr *&gt;(entry-&gt;mHdr)</span>
<a href="#l12.1205"></a><span id="l12.1205" class="difflineplus">+                        -&gt;SizeOfIncludingThis(aMallocSizeOf);</span>
<a href="#l12.1206"></a><span id="l12.1206">     }</span>
<a href="#l12.1207"></a><span id="l12.1207">   }</span>
<a href="#l12.1208"></a><span id="l12.1208">   totalSize += headerSize;</span>
<a href="#l12.1209"></a><span id="l12.1209">   if (m_msgReferences)</span>
<a href="#l12.1210"></a><span id="l12.1210">     totalSize += m_msgReferences-&gt;ShallowSizeOfIncludingThis(aMallocSizeOf);</span>
<a href="#l12.1211"></a><span id="l12.1211">   return totalSize;</span>
<a href="#l12.1212"></a><span id="l12.1212"> }</span>
<a href="#l12.1213"></a><span id="l12.1213"> </span>
<a href="#l12.1214"></a><span id="l12.1214"> namespace mozilla {</span>
<a href="#l12.1215"></a><span id="l12.1215"> namespace mailnews {</span>
<a href="#l12.1216"></a><span id="l12.1216"> </span>
<a href="#l12.1217"></a><span id="l12.1217"> MOZ_DEFINE_MALLOC_SIZE_OF(GetMallocSize)</span>
<a href="#l12.1218"></a><span id="l12.1218"> </span>
<a href="#l12.1219"></a><span id="l12.1219" class="difflineminus">-class MsgDBReporter final : public nsIMemoryReporter</span>
<a href="#l12.1220"></a><span id="l12.1220" class="difflineminus">-{</span>
<a href="#l12.1221"></a><span id="l12.1221" class="difflineplus">+class MsgDBReporter final : public nsIMemoryReporter {</span>
<a href="#l12.1222"></a><span id="l12.1222">   nsMsgDatabase *mDatabase;</span>
<a href="#l12.1223"></a><span id="l12.1223" class="difflineminus">-public:</span>
<a href="#l12.1224"></a><span id="l12.1224" class="difflineplus">+</span>
<a href="#l12.1225"></a><span id="l12.1225" class="difflineplus">+ public:</span>
<a href="#l12.1226"></a><span id="l12.1226">   explicit MsgDBReporter(nsMsgDatabase *db) : mDatabase(db) {}</span>
<a href="#l12.1227"></a><span id="l12.1227"> </span>
<a href="#l12.1228"></a><span id="l12.1228">   NS_DECL_ISUPPORTS</span>
<a href="#l12.1229"></a><span id="l12.1229" class="difflineminus">-  NS_IMETHOD GetName(nsACString &amp;aName)</span>
<a href="#l12.1230"></a><span id="l12.1230" class="difflineminus">-  {</span>
<a href="#l12.1231"></a><span id="l12.1231" class="difflineplus">+  NS_IMETHOD GetName(nsACString &amp;aName) {</span>
<a href="#l12.1232"></a><span id="l12.1232">     aName.AssignLiteral(&quot;msg-database-objects&quot;);</span>
<a href="#l12.1233"></a><span id="l12.1233">     return NS_OK;</span>
<a href="#l12.1234"></a><span id="l12.1234">   }</span>
<a href="#l12.1235"></a><span id="l12.1235"> </span>
<a href="#l12.1236"></a><span id="l12.1236" class="difflineminus">-  NS_IMETHOD CollectReports(nsIHandleReportCallback* aCb,</span>
<a href="#l12.1237"></a><span id="l12.1237" class="difflineminus">-                            nsISupports* aClosure,</span>
<a href="#l12.1238"></a><span id="l12.1238" class="difflineminus">-                            bool aAnonymize) override</span>
<a href="#l12.1239"></a><span id="l12.1239" class="difflineminus">-  {</span>
<a href="#l12.1240"></a><span id="l12.1240" class="difflineplus">+  NS_IMETHOD CollectReports(nsIHandleReportCallback *aCb, nsISupports *aClosure,</span>
<a href="#l12.1241"></a><span id="l12.1241" class="difflineplus">+                            bool aAnonymize) override {</span>
<a href="#l12.1242"></a><span id="l12.1242">     nsCString path;</span>
<a href="#l12.1243"></a><span id="l12.1243">     GetPath(path, aAnonymize);</span>
<a href="#l12.1244"></a><span id="l12.1244" class="difflineminus">-    return aCb-&gt;Callback(EmptyCString(), path,</span>
<a href="#l12.1245"></a><span id="l12.1245" class="difflineminus">-                         nsIMemoryReporter::KIND_HEAP,</span>
<a href="#l12.1246"></a><span id="l12.1246" class="difflineminus">-                         nsIMemoryReporter::UNITS_BYTES,</span>
<a href="#l12.1247"></a><span id="l12.1247" class="difflineminus">-                         mDatabase-&gt;SizeOfIncludingThis(GetMallocSize),</span>
<a href="#l12.1248"></a><span id="l12.1248" class="difflineminus">-                         NS_LITERAL_CSTRING(&quot;Memory used for the folder database.&quot;),</span>
<a href="#l12.1249"></a><span id="l12.1249" class="difflineminus">-                         aClosure);</span>
<a href="#l12.1250"></a><span id="l12.1250" class="difflineplus">+    return aCb-&gt;Callback(</span>
<a href="#l12.1251"></a><span id="l12.1251" class="difflineplus">+        EmptyCString(), path, nsIMemoryReporter::KIND_HEAP,</span>
<a href="#l12.1252"></a><span id="l12.1252" class="difflineplus">+        nsIMemoryReporter::UNITS_BYTES,</span>
<a href="#l12.1253"></a><span id="l12.1253" class="difflineplus">+        mDatabase-&gt;SizeOfIncludingThis(GetMallocSize),</span>
<a href="#l12.1254"></a><span id="l12.1254" class="difflineplus">+        NS_LITERAL_CSTRING(&quot;Memory used for the folder database.&quot;), aClosure);</span>
<a href="#l12.1255"></a><span id="l12.1255">   }</span>
<a href="#l12.1256"></a><span id="l12.1256"> </span>
<a href="#l12.1257"></a><span id="l12.1257" class="difflineminus">-  void GetPath(nsACString &amp;memoryPath, bool aAnonymize)</span>
<a href="#l12.1258"></a><span id="l12.1258" class="difflineminus">-  {</span>
<a href="#l12.1259"></a><span id="l12.1259" class="difflineplus">+  void GetPath(nsACString &amp;memoryPath, bool aAnonymize) {</span>
<a href="#l12.1260"></a><span id="l12.1260">     memoryPath.AssignLiteral(&quot;explicit/maildb/database(&quot;);</span>
<a href="#l12.1261"></a><span id="l12.1261">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l12.1262"></a><span id="l12.1262">     mDatabase-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l12.1263"></a><span id="l12.1263" class="difflineminus">-    if (folder)</span>
<a href="#l12.1264"></a><span id="l12.1264" class="difflineminus">-    {</span>
<a href="#l12.1265"></a><span id="l12.1265" class="difflineplus">+    if (folder) {</span>
<a href="#l12.1266"></a><span id="l12.1266">       if (aAnonymize)</span>
<a href="#l12.1267"></a><span id="l12.1267">         memoryPath.AppendLiteral(&quot;&lt;anonymized&gt;&quot;);</span>
<a href="#l12.1268"></a><span id="l12.1268" class="difflineminus">-      else</span>
<a href="#l12.1269"></a><span id="l12.1269" class="difflineminus">-      {</span>
<a href="#l12.1270"></a><span id="l12.1270" class="difflineplus">+      else {</span>
<a href="#l12.1271"></a><span id="l12.1271">         nsAutoCString folderURL;</span>
<a href="#l12.1272"></a><span id="l12.1272">         folder-&gt;GetFolderURL(folderURL);</span>
<a href="#l12.1273"></a><span id="l12.1273">         MsgReplaceChar(folderURL, '/', '\\');</span>
<a href="#l12.1274"></a><span id="l12.1274">         memoryPath += folderURL;</span>
<a href="#l12.1275"></a><span id="l12.1275">       }</span>
<a href="#l12.1276"></a><span id="l12.1276">     } else {</span>
<a href="#l12.1277"></a><span id="l12.1277">       memoryPath.AppendLiteral(&quot;UNKNOWN-FOLDER&quot;);</span>
<a href="#l12.1278"></a><span id="l12.1278">     }</span>
<a href="#l12.1279"></a><span id="l12.1279">     memoryPath.Append(')');</span>
<a href="#l12.1280"></a><span id="l12.1280">   }</span>
<a href="#l12.1281"></a><span id="l12.1281"> </span>
<a href="#l12.1282"></a><span id="l12.1282" class="difflineminus">-private:</span>
<a href="#l12.1283"></a><span id="l12.1283" class="difflineplus">+ private:</span>
<a href="#l12.1284"></a><span id="l12.1284">   ~MsgDBReporter() {}</span>
<a href="#l12.1285"></a><span id="l12.1285"> };</span>
<a href="#l12.1286"></a><span id="l12.1286"> </span>
<a href="#l12.1287"></a><span id="l12.1287"> NS_IMPL_ISUPPORTS(MsgDBReporter, nsIMemoryReporter)</span>
<a href="#l12.1288"></a><span id="l12.1288" class="difflineminus">-}</span>
<a href="#l12.1289"></a><span id="l12.1289" class="difflineminus">-}</span>
<a href="#l12.1290"></a><span id="l12.1290" class="difflineplus">+}  // namespace mailnews</span>
<a href="#l12.1291"></a><span id="l12.1291" class="difflineplus">+}  // namespace mozilla</span>
<a href="#l12.1292"></a><span id="l12.1292"> </span>
<a href="#l12.1293"></a><span id="l12.1293"> nsMsgDatabase::nsMsgDatabase()</span>
<a href="#l12.1294"></a><span id="l12.1294" class="difflineminus">-        : m_dbFolderInfo(nullptr),</span>
<a href="#l12.1295"></a><span id="l12.1295" class="difflineminus">-        m_nextPseudoMsgKey(kFirstPseudoKey),</span>
<a href="#l12.1296"></a><span id="l12.1296" class="difflineminus">-        m_mdbEnv(nullptr), m_mdbStore(nullptr),</span>
<a href="#l12.1297"></a><span id="l12.1297" class="difflineminus">-        m_mdbAllMsgHeadersTable(nullptr), m_mdbAllThreadsTable(nullptr),</span>
<a href="#l12.1298"></a><span id="l12.1298" class="difflineminus">-        m_create(false),</span>
<a href="#l12.1299"></a><span id="l12.1299" class="difflineminus">-        m_leaveInvalidDB(false),</span>
<a href="#l12.1300"></a><span id="l12.1300" class="difflineminus">-        m_mdbTokensInitialized(false),</span>
<a href="#l12.1301"></a><span id="l12.1301" class="difflineminus">-        m_hdrRowScopeToken(0),</span>
<a href="#l12.1302"></a><span id="l12.1302" class="difflineminus">-        m_hdrTableKindToken(0),</span>
<a href="#l12.1303"></a><span id="l12.1303" class="difflineminus">-        m_threadTableKindToken(0),</span>
<a href="#l12.1304"></a><span id="l12.1304" class="difflineminus">-        m_subjectColumnToken(0),</span>
<a href="#l12.1305"></a><span id="l12.1305" class="difflineminus">-        m_senderColumnToken(0),</span>
<a href="#l12.1306"></a><span id="l12.1306" class="difflineminus">-        m_messageIdColumnToken(0),</span>
<a href="#l12.1307"></a><span id="l12.1307" class="difflineminus">-        m_referencesColumnToken(0),</span>
<a href="#l12.1308"></a><span id="l12.1308" class="difflineminus">-        m_recipientsColumnToken(0),</span>
<a href="#l12.1309"></a><span id="l12.1309" class="difflineminus">-        m_dateColumnToken(0),</span>
<a href="#l12.1310"></a><span id="l12.1310" class="difflineminus">-        m_messageSizeColumnToken(0),</span>
<a href="#l12.1311"></a><span id="l12.1311" class="difflineminus">-        m_flagsColumnToken(0),</span>
<a href="#l12.1312"></a><span id="l12.1312" class="difflineminus">-        m_priorityColumnToken(0),</span>
<a href="#l12.1313"></a><span id="l12.1313" class="difflineminus">-        m_labelColumnToken(0),</span>
<a href="#l12.1314"></a><span id="l12.1314" class="difflineminus">-        m_statusOffsetColumnToken(0),</span>
<a href="#l12.1315"></a><span id="l12.1315" class="difflineminus">-        m_numLinesColumnToken(0),</span>
<a href="#l12.1316"></a><span id="l12.1316" class="difflineminus">-        m_ccListColumnToken(0),</span>
<a href="#l12.1317"></a><span id="l12.1317" class="difflineminus">-        m_bccListColumnToken(0),</span>
<a href="#l12.1318"></a><span id="l12.1318" class="difflineminus">-        m_threadFlagsColumnToken(0),</span>
<a href="#l12.1319"></a><span id="l12.1319" class="difflineminus">-        m_threadIdColumnToken(0),</span>
<a href="#l12.1320"></a><span id="l12.1320" class="difflineminus">-        m_threadChildrenColumnToken(0),</span>
<a href="#l12.1321"></a><span id="l12.1321" class="difflineminus">-        m_threadUnreadChildrenColumnToken(0),</span>
<a href="#l12.1322"></a><span id="l12.1322" class="difflineminus">-        m_messageThreadIdColumnToken(0),</span>
<a href="#l12.1323"></a><span id="l12.1323" class="difflineminus">-        m_threadSubjectColumnToken(0),</span>
<a href="#l12.1324"></a><span id="l12.1324" class="difflineminus">-        m_messageCharSetColumnToken(0),</span>
<a href="#l12.1325"></a><span id="l12.1325" class="difflineminus">-        m_threadParentColumnToken(0),</span>
<a href="#l12.1326"></a><span id="l12.1326" class="difflineminus">-        m_threadRootKeyColumnToken(0),</span>
<a href="#l12.1327"></a><span id="l12.1327" class="difflineminus">-        m_threadNewestMsgDateColumnToken(0),</span>
<a href="#l12.1328"></a><span id="l12.1328" class="difflineminus">-        m_offlineMsgOffsetColumnToken(0),</span>
<a href="#l12.1329"></a><span id="l12.1329" class="difflineminus">-        m_offlineMessageSizeColumnToken(0),</span>
<a href="#l12.1330"></a><span id="l12.1330" class="difflineminus">-        m_headersInUse(nullptr),</span>
<a href="#l12.1331"></a><span id="l12.1331" class="difflineminus">-        m_cachedHeaders(nullptr),</span>
<a href="#l12.1332"></a><span id="l12.1332" class="difflineminus">-        m_bCacheHeaders(true),</span>
<a href="#l12.1333"></a><span id="l12.1333" class="difflineminus">-        m_cachedThreadId(nsMsgKey_None),</span>
<a href="#l12.1334"></a><span id="l12.1334" class="difflineminus">-        m_msgReferences(nullptr),</span>
<a href="#l12.1335"></a><span id="l12.1335" class="difflineminus">-        m_cacheSize(kMaxHdrsInCache)</span>
<a href="#l12.1336"></a><span id="l12.1336" class="difflineminus">-{</span>
<a href="#l12.1337"></a><span id="l12.1337" class="difflineplus">+    : m_dbFolderInfo(nullptr),</span>
<a href="#l12.1338"></a><span id="l12.1338" class="difflineplus">+      m_nextPseudoMsgKey(kFirstPseudoKey),</span>
<a href="#l12.1339"></a><span id="l12.1339" class="difflineplus">+      m_mdbEnv(nullptr),</span>
<a href="#l12.1340"></a><span id="l12.1340" class="difflineplus">+      m_mdbStore(nullptr),</span>
<a href="#l12.1341"></a><span id="l12.1341" class="difflineplus">+      m_mdbAllMsgHeadersTable(nullptr),</span>
<a href="#l12.1342"></a><span id="l12.1342" class="difflineplus">+      m_mdbAllThreadsTable(nullptr),</span>
<a href="#l12.1343"></a><span id="l12.1343" class="difflineplus">+      m_create(false),</span>
<a href="#l12.1344"></a><span id="l12.1344" class="difflineplus">+      m_leaveInvalidDB(false),</span>
<a href="#l12.1345"></a><span id="l12.1345" class="difflineplus">+      m_mdbTokensInitialized(false),</span>
<a href="#l12.1346"></a><span id="l12.1346" class="difflineplus">+      m_hdrRowScopeToken(0),</span>
<a href="#l12.1347"></a><span id="l12.1347" class="difflineplus">+      m_hdrTableKindToken(0),</span>
<a href="#l12.1348"></a><span id="l12.1348" class="difflineplus">+      m_threadTableKindToken(0),</span>
<a href="#l12.1349"></a><span id="l12.1349" class="difflineplus">+      m_subjectColumnToken(0),</span>
<a href="#l12.1350"></a><span id="l12.1350" class="difflineplus">+      m_senderColumnToken(0),</span>
<a href="#l12.1351"></a><span id="l12.1351" class="difflineplus">+      m_messageIdColumnToken(0),</span>
<a href="#l12.1352"></a><span id="l12.1352" class="difflineplus">+      m_referencesColumnToken(0),</span>
<a href="#l12.1353"></a><span id="l12.1353" class="difflineplus">+      m_recipientsColumnToken(0),</span>
<a href="#l12.1354"></a><span id="l12.1354" class="difflineplus">+      m_dateColumnToken(0),</span>
<a href="#l12.1355"></a><span id="l12.1355" class="difflineplus">+      m_messageSizeColumnToken(0),</span>
<a href="#l12.1356"></a><span id="l12.1356" class="difflineplus">+      m_flagsColumnToken(0),</span>
<a href="#l12.1357"></a><span id="l12.1357" class="difflineplus">+      m_priorityColumnToken(0),</span>
<a href="#l12.1358"></a><span id="l12.1358" class="difflineplus">+      m_labelColumnToken(0),</span>
<a href="#l12.1359"></a><span id="l12.1359" class="difflineplus">+      m_statusOffsetColumnToken(0),</span>
<a href="#l12.1360"></a><span id="l12.1360" class="difflineplus">+      m_numLinesColumnToken(0),</span>
<a href="#l12.1361"></a><span id="l12.1361" class="difflineplus">+      m_ccListColumnToken(0),</span>
<a href="#l12.1362"></a><span id="l12.1362" class="difflineplus">+      m_bccListColumnToken(0),</span>
<a href="#l12.1363"></a><span id="l12.1363" class="difflineplus">+      m_threadFlagsColumnToken(0),</span>
<a href="#l12.1364"></a><span id="l12.1364" class="difflineplus">+      m_threadIdColumnToken(0),</span>
<a href="#l12.1365"></a><span id="l12.1365" class="difflineplus">+      m_threadChildrenColumnToken(0),</span>
<a href="#l12.1366"></a><span id="l12.1366" class="difflineplus">+      m_threadUnreadChildrenColumnToken(0),</span>
<a href="#l12.1367"></a><span id="l12.1367" class="difflineplus">+      m_messageThreadIdColumnToken(0),</span>
<a href="#l12.1368"></a><span id="l12.1368" class="difflineplus">+      m_threadSubjectColumnToken(0),</span>
<a href="#l12.1369"></a><span id="l12.1369" class="difflineplus">+      m_messageCharSetColumnToken(0),</span>
<a href="#l12.1370"></a><span id="l12.1370" class="difflineplus">+      m_threadParentColumnToken(0),</span>
<a href="#l12.1371"></a><span id="l12.1371" class="difflineplus">+      m_threadRootKeyColumnToken(0),</span>
<a href="#l12.1372"></a><span id="l12.1372" class="difflineplus">+      m_threadNewestMsgDateColumnToken(0),</span>
<a href="#l12.1373"></a><span id="l12.1373" class="difflineplus">+      m_offlineMsgOffsetColumnToken(0),</span>
<a href="#l12.1374"></a><span id="l12.1374" class="difflineplus">+      m_offlineMessageSizeColumnToken(0),</span>
<a href="#l12.1375"></a><span id="l12.1375" class="difflineplus">+      m_headersInUse(nullptr),</span>
<a href="#l12.1376"></a><span id="l12.1376" class="difflineplus">+      m_cachedHeaders(nullptr),</span>
<a href="#l12.1377"></a><span id="l12.1377" class="difflineplus">+      m_bCacheHeaders(true),</span>
<a href="#l12.1378"></a><span id="l12.1378" class="difflineplus">+      m_cachedThreadId(nsMsgKey_None),</span>
<a href="#l12.1379"></a><span id="l12.1379" class="difflineplus">+      m_msgReferences(nullptr),</span>
<a href="#l12.1380"></a><span id="l12.1380" class="difflineplus">+      m_cacheSize(kMaxHdrsInCache) {</span>
<a href="#l12.1381"></a><span id="l12.1381">   mMemReporter = new mozilla::mailnews::MsgDBReporter(this);</span>
<a href="#l12.1382"></a><span id="l12.1382">   mozilla::RegisterWeakMemoryReporter(mMemReporter);</span>
<a href="#l12.1383"></a><span id="l12.1383"> }</span>
<a href="#l12.1384"></a><span id="l12.1384"> </span>
<a href="#l12.1385"></a><span id="l12.1385" class="difflineminus">-nsMsgDatabase::~nsMsgDatabase()</span>
<a href="#l12.1386"></a><span id="l12.1386" class="difflineminus">-{</span>
<a href="#l12.1387"></a><span id="l12.1387" class="difflineplus">+nsMsgDatabase::~nsMsgDatabase() {</span>
<a href="#l12.1388"></a><span id="l12.1388">   mozilla::UnregisterWeakMemoryReporter(mMemReporter);</span>
<a href="#l12.1389"></a><span id="l12.1389">   //  Close(FALSE);  // better have already been closed.</span>
<a href="#l12.1390"></a><span id="l12.1390">   ClearCachedObjects(true);</span>
<a href="#l12.1391"></a><span id="l12.1391">   ClearEnumerators();</span>
<a href="#l12.1392"></a><span id="l12.1392">   delete m_cachedHeaders;</span>
<a href="#l12.1393"></a><span id="l12.1393">   delete m_headersInUse;</span>
<a href="#l12.1394"></a><span id="l12.1394"> </span>
<a href="#l12.1395"></a><span id="l12.1395" class="difflineminus">-  if (m_msgReferences)</span>
<a href="#l12.1396"></a><span id="l12.1396" class="difflineminus">-  {</span>
<a href="#l12.1397"></a><span id="l12.1397" class="difflineplus">+  if (m_msgReferences) {</span>
<a href="#l12.1398"></a><span id="l12.1398">     delete m_msgReferences;</span>
<a href="#l12.1399"></a><span id="l12.1399">     m_msgReferences = nullptr;</span>
<a href="#l12.1400"></a><span id="l12.1400">   }</span>
<a href="#l12.1401"></a><span id="l12.1401"> </span>
<a href="#l12.1402"></a><span id="l12.1402" class="difflineminus">-  MOZ_LOG(DBLog, LogLevel::Info, (&quot;closing database    %s\n&quot;, m_dbFile-&gt;HumanReadablePath().get()));</span>
<a href="#l12.1403"></a><span id="l12.1403" class="difflineplus">+  MOZ_LOG(DBLog, LogLevel::Info,</span>
<a href="#l12.1404"></a><span id="l12.1404" class="difflineplus">+          (&quot;closing database    %s\n&quot;, m_dbFile-&gt;HumanReadablePath().get()));</span>
<a href="#l12.1405"></a><span id="l12.1405"> </span>
<a href="#l12.1406"></a><span id="l12.1406">   nsCOMPtr&lt;nsIMsgDBService&gt; serv(do_GetService(NS_MSGDB_SERVICE_CONTRACTID));</span>
<a href="#l12.1407"></a><span id="l12.1407" class="difflineminus">-  if (serv)</span>
<a href="#l12.1408"></a><span id="l12.1408" class="difflineminus">-    static_cast&lt;nsMsgDBService*&gt;(serv.get())-&gt;RemoveFromCache(this);</span>
<a href="#l12.1409"></a><span id="l12.1409" class="difflineplus">+  if (serv) static_cast&lt;nsMsgDBService *&gt;(serv.get())-&gt;RemoveFromCache(this);</span>
<a href="#l12.1410"></a><span id="l12.1410"> </span>
<a href="#l12.1411"></a><span id="l12.1411">   // if the db folder info refers to the mdb db, we must clear it because</span>
<a href="#l12.1412"></a><span id="l12.1412">   // the reference will be a dangling one soon.</span>
<a href="#l12.1413"></a><span id="l12.1413" class="difflineminus">-  if (m_dbFolderInfo)</span>
<a href="#l12.1414"></a><span id="l12.1414" class="difflineminus">-    m_dbFolderInfo-&gt;ReleaseExternalReferences();</span>
<a href="#l12.1415"></a><span id="l12.1415" class="difflineplus">+  if (m_dbFolderInfo) m_dbFolderInfo-&gt;ReleaseExternalReferences();</span>
<a href="#l12.1416"></a><span id="l12.1416">   m_dbFolderInfo = nullptr;</span>
<a href="#l12.1417"></a><span id="l12.1417"> </span>
<a href="#l12.1418"></a><span id="l12.1418" class="difflineminus">-  if (m_mdbAllMsgHeadersTable)</span>
<a href="#l12.1419"></a><span id="l12.1419" class="difflineminus">-    m_mdbAllMsgHeadersTable-&gt;Release();</span>
<a href="#l12.1420"></a><span id="l12.1420" class="difflineminus">-</span>
<a href="#l12.1421"></a><span id="l12.1421" class="difflineminus">-  if (m_mdbAllThreadsTable)</span>
<a href="#l12.1422"></a><span id="l12.1422" class="difflineminus">-    m_mdbAllThreadsTable-&gt;Release();</span>
<a href="#l12.1423"></a><span id="l12.1423" class="difflineminus">-</span>
<a href="#l12.1424"></a><span id="l12.1424" class="difflineminus">-  if (m_mdbStore)</span>
<a href="#l12.1425"></a><span id="l12.1425" class="difflineminus">-    m_mdbStore-&gt;Release();</span>
<a href="#l12.1426"></a><span id="l12.1426" class="difflineminus">-</span>
<a href="#l12.1427"></a><span id="l12.1427" class="difflineminus">-  if (m_mdbEnv)</span>
<a href="#l12.1428"></a><span id="l12.1428" class="difflineminus">-  {</span>
<a href="#l12.1429"></a><span id="l12.1429" class="difflineminus">-    m_mdbEnv-&gt;Release(); //??? is this right?</span>
<a href="#l12.1430"></a><span id="l12.1430" class="difflineplus">+  if (m_mdbAllMsgHeadersTable) m_mdbAllMsgHeadersTable-&gt;Release();</span>
<a href="#l12.1431"></a><span id="l12.1431" class="difflineplus">+</span>
<a href="#l12.1432"></a><span id="l12.1432" class="difflineplus">+  if (m_mdbAllThreadsTable) m_mdbAllThreadsTable-&gt;Release();</span>
<a href="#l12.1433"></a><span id="l12.1433" class="difflineplus">+</span>
<a href="#l12.1434"></a><span id="l12.1434" class="difflineplus">+  if (m_mdbStore) m_mdbStore-&gt;Release();</span>
<a href="#l12.1435"></a><span id="l12.1435" class="difflineplus">+</span>
<a href="#l12.1436"></a><span id="l12.1436" class="difflineplus">+  if (m_mdbEnv) {</span>
<a href="#l12.1437"></a><span id="l12.1437" class="difflineplus">+    m_mdbEnv-&gt;Release();  //??? is this right?</span>
<a href="#l12.1438"></a><span id="l12.1438">     m_mdbEnv = nullptr;</span>
<a href="#l12.1439"></a><span id="l12.1439">   }</span>
<a href="#l12.1440"></a><span id="l12.1440">   m_ChangeListeners.Clear();</span>
<a href="#l12.1441"></a><span id="l12.1441"> }</span>
<a href="#l12.1442"></a><span id="l12.1442"> </span>
<a href="#l12.1443"></a><span id="l12.1443"> NS_IMPL_ISUPPORTS(nsMsgDatabase, nsIMsgDatabase, nsIDBChangeAnnouncer)</span>
<a href="#l12.1444"></a><span id="l12.1444"> </span>
<a href="#l12.1445"></a><span id="l12.1445" class="difflineminus">-nsresult nsMsgDatabase::GetMDBFactory(nsIMdbFactory ** aMdbFactory)</span>
<a href="#l12.1446"></a><span id="l12.1446" class="difflineminus">-{</span>
<a href="#l12.1447"></a><span id="l12.1447" class="difflineminus">-  if (!mMdbFactory)</span>
<a href="#l12.1448"></a><span id="l12.1448" class="difflineminus">-  {</span>
<a href="#l12.1449"></a><span id="l12.1449" class="difflineplus">+nsresult nsMsgDatabase::GetMDBFactory(nsIMdbFactory **aMdbFactory) {</span>
<a href="#l12.1450"></a><span id="l12.1450" class="difflineplus">+  if (!mMdbFactory) {</span>
<a href="#l12.1451"></a><span id="l12.1451">     nsresult rv;</span>
<a href="#l12.1452"></a><span id="l12.1452" class="difflineminus">-    nsCOMPtr &lt;nsIMdbFactoryService&gt; mdbFactoryService = do_GetService(NS_MORK_CONTRACTID, &amp;rv);</span>
<a href="#l12.1453"></a><span id="l12.1453" class="difflineplus">+    nsCOMPtr&lt;nsIMdbFactoryService&gt; mdbFactoryService =</span>
<a href="#l12.1454"></a><span id="l12.1454" class="difflineplus">+        do_GetService(NS_MORK_CONTRACTID, &amp;rv);</span>
<a href="#l12.1455"></a><span id="l12.1455">     if (NS_SUCCEEDED(rv) &amp;&amp; mdbFactoryService) {</span>
<a href="#l12.1456"></a><span id="l12.1456">       rv = mdbFactoryService-&gt;GetMdbFactory(getter_AddRefs(mMdbFactory));</span>
<a href="#l12.1457"></a><span id="l12.1457">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.1458"></a><span id="l12.1458" class="difflineminus">-      if (!mMdbFactory)</span>
<a href="#l12.1459"></a><span id="l12.1459" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l12.1460"></a><span id="l12.1460" class="difflineplus">+      if (!mMdbFactory) return NS_ERROR_FAILURE;</span>
<a href="#l12.1461"></a><span id="l12.1461">     }</span>
<a href="#l12.1462"></a><span id="l12.1462">   }</span>
<a href="#l12.1463"></a><span id="l12.1463">   NS_ADDREF(*aMdbFactory = mMdbFactory);</span>
<a href="#l12.1464"></a><span id="l12.1464">   return NS_OK;</span>
<a href="#l12.1465"></a><span id="l12.1465"> }</span>
<a href="#l12.1466"></a><span id="l12.1466"> </span>
<a href="#l12.1467"></a><span id="l12.1467"> // aLeaveInvalidDB: true if caller wants back a db even out of date.</span>
<a href="#l12.1468"></a><span id="l12.1468"> // If so, they'll extract out the interesting info from the db, close it,</span>
<a href="#l12.1469"></a><span id="l12.1469"> // delete it, and then try to open the db again, prior to reparsing.</span>
<a href="#l12.1470"></a><span id="l12.1470"> nsresult nsMsgDatabase::Open(nsMsgDBService *aDBService, nsIFile *aFolderName,</span>
<a href="#l12.1471"></a><span id="l12.1471" class="difflineminus">-                             bool aCreate, bool aLeaveInvalidDB)</span>
<a href="#l12.1472"></a><span id="l12.1472" class="difflineminus">-{</span>
<a href="#l12.1473"></a><span id="l12.1473" class="difflineminus">-  return nsMsgDatabase::OpenInternal(aDBService, aFolderName, aCreate, aLeaveInvalidDB,</span>
<a href="#l12.1474"></a><span id="l12.1474" class="difflineplus">+                             bool aCreate, bool aLeaveInvalidDB) {</span>
<a href="#l12.1475"></a><span id="l12.1475" class="difflineplus">+  return nsMsgDatabase::OpenInternal(aDBService, aFolderName, aCreate,</span>
<a href="#l12.1476"></a><span id="l12.1476" class="difflineplus">+                                     aLeaveInvalidDB,</span>
<a href="#l12.1477"></a><span id="l12.1477">                                      true /* open synchronously */);</span>
<a href="#l12.1478"></a><span id="l12.1478"> }</span>
<a href="#l12.1479"></a><span id="l12.1479"> </span>
<a href="#l12.1480"></a><span id="l12.1480"> nsresult nsMsgDatabase::OpenInternal(nsMsgDBService *aDBService,</span>
<a href="#l12.1481"></a><span id="l12.1481">                                      nsIFile *summaryFile, bool aCreate,</span>
<a href="#l12.1482"></a><span id="l12.1482" class="difflineminus">-                                     bool aLeaveInvalidDB, bool sync)</span>
<a href="#l12.1483"></a><span id="l12.1483" class="difflineminus">-{</span>
<a href="#l12.1484"></a><span id="l12.1484" class="difflineminus">-  MOZ_LOG(DBLog, LogLevel::Info, (&quot;nsMsgDatabase::Open(%s, %s, %p, %s)\n&quot;,</span>
<a href="#l12.1485"></a><span id="l12.1485" class="difflineminus">-    summaryFile-&gt;HumanReadablePath().get(), aCreate ? &quot;TRUE&quot;:&quot;FALSE&quot;,</span>
<a href="#l12.1486"></a><span id="l12.1486" class="difflineminus">-    this, aLeaveInvalidDB ? &quot;TRUE&quot;:&quot;FALSE&quot;));</span>
<a href="#l12.1487"></a><span id="l12.1487" class="difflineplus">+                                     bool aLeaveInvalidDB, bool sync) {</span>
<a href="#l12.1488"></a><span id="l12.1488" class="difflineplus">+  MOZ_LOG(DBLog, LogLevel::Info,</span>
<a href="#l12.1489"></a><span id="l12.1489" class="difflineplus">+          (&quot;nsMsgDatabase::Open(%s, %s, %p, %s)\n&quot;,</span>
<a href="#l12.1490"></a><span id="l12.1490" class="difflineplus">+           summaryFile-&gt;HumanReadablePath().get(), aCreate ? &quot;TRUE&quot; : &quot;FALSE&quot;,</span>
<a href="#l12.1491"></a><span id="l12.1491" class="difflineplus">+           this, aLeaveInvalidDB ? &quot;TRUE&quot; : &quot;FALSE&quot;));</span>
<a href="#l12.1492"></a><span id="l12.1492"> </span>
<a href="#l12.1493"></a><span id="l12.1493">   nsresult rv = OpenMDB(summaryFile, aCreate, sync);</span>
<a href="#l12.1494"></a><span id="l12.1494">   if (NS_FAILED(rv))</span>
<a href="#l12.1495"></a><span id="l12.1495" class="difflineminus">-    MOZ_LOG(DBLog, LogLevel::Info, (&quot;error opening db %&quot; PRIx32, static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l12.1496"></a><span id="l12.1496" class="difflineminus">-</span>
<a href="#l12.1497"></a><span id="l12.1497" class="difflineminus">-  if (MOZ_LOG_TEST(DBLog, LogLevel::Debug))</span>
<a href="#l12.1498"></a><span id="l12.1498" class="difflineminus">-    aDBService-&gt;DumpCache();</span>
<a href="#l12.1499"></a><span id="l12.1499" class="difflineminus">-</span>
<a href="#l12.1500"></a><span id="l12.1500" class="difflineminus">-  if (rv == NS_ERROR_FILE_TARGET_DOES_NOT_EXIST)</span>
<a href="#l12.1501"></a><span id="l12.1501" class="difflineminus">-    return rv;</span>
<a href="#l12.1502"></a><span id="l12.1502" class="difflineplus">+    MOZ_LOG(DBLog, LogLevel::Info,</span>
<a href="#l12.1503"></a><span id="l12.1503" class="difflineplus">+            (&quot;error opening db %&quot; PRIx32, static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l12.1504"></a><span id="l12.1504" class="difflineplus">+</span>
<a href="#l12.1505"></a><span id="l12.1505" class="difflineplus">+  if (MOZ_LOG_TEST(DBLog, LogLevel::Debug)) aDBService-&gt;DumpCache();</span>
<a href="#l12.1506"></a><span id="l12.1506" class="difflineplus">+</span>
<a href="#l12.1507"></a><span id="l12.1507" class="difflineplus">+  if (rv == NS_ERROR_FILE_TARGET_DOES_NOT_EXIST) return rv;</span>
<a href="#l12.1508"></a><span id="l12.1508"> </span>
<a href="#l12.1509"></a><span id="l12.1509">   m_create = aCreate;</span>
<a href="#l12.1510"></a><span id="l12.1510">   m_leaveInvalidDB = aLeaveInvalidDB;</span>
<a href="#l12.1511"></a><span id="l12.1511" class="difflineminus">-  if (!sync &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l12.1512"></a><span id="l12.1512" class="difflineminus">-  {</span>
<a href="#l12.1513"></a><span id="l12.1513" class="difflineplus">+  if (!sync &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l12.1514"></a><span id="l12.1514">     aDBService-&gt;AddToCache(this);</span>
<a href="#l12.1515"></a><span id="l12.1515">     // remember open options for when the parsing is complete.</span>
<a href="#l12.1516"></a><span id="l12.1516">     return rv;</span>
<a href="#l12.1517"></a><span id="l12.1517">   }</span>
<a href="#l12.1518"></a><span id="l12.1518">   return CheckForErrors(rv, true, aDBService, summaryFile);</span>
<a href="#l12.1519"></a><span id="l12.1519"> }</span>
<a href="#l12.1520"></a><span id="l12.1520"> </span>
<a href="#l12.1521"></a><span id="l12.1521"> nsresult nsMsgDatabase::CheckForErrors(nsresult err, bool sync,</span>
<a href="#l12.1522"></a><span id="l12.1522">                                        nsMsgDBService *aDBService,</span>
<a href="#l12.1523"></a><span id="l12.1523" class="difflineminus">-                                       nsIFile *summaryFile)</span>
<a href="#l12.1524"></a><span id="l12.1524" class="difflineminus">-{</span>
<a href="#l12.1525"></a><span id="l12.1525" class="difflineplus">+                                       nsIFile *summaryFile) {</span>
<a href="#l12.1526"></a><span id="l12.1526">   nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l12.1527"></a><span id="l12.1527">   bool summaryFileExists;</span>
<a href="#l12.1528"></a><span id="l12.1528">   bool newFile = false;</span>
<a href="#l12.1529"></a><span id="l12.1529">   bool deleteInvalidDB = false;</span>
<a href="#l12.1530"></a><span id="l12.1530"> </span>
<a href="#l12.1531"></a><span id="l12.1531">   bool exists;</span>
<a href="#l12.1532"></a><span id="l12.1532">   int64_t fileSize;</span>
<a href="#l12.1533"></a><span id="l12.1533">   summaryFile-&gt;Exists(&amp;exists);</span>
<a href="#l12.1534"></a><span id="l12.1534">   summaryFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l12.1535"></a><span id="l12.1535">   // if the old summary doesn't exist, we're creating a new one.</span>
<a href="#l12.1536"></a><span id="l12.1536" class="difflineminus">-  if ((!exists || !fileSize) &amp;&amp; m_create)</span>
<a href="#l12.1537"></a><span id="l12.1537" class="difflineminus">-    newFile = true;</span>
<a href="#l12.1538"></a><span id="l12.1538" class="difflineplus">+  if ((!exists || !fileSize) &amp;&amp; m_create) newFile = true;</span>
<a href="#l12.1539"></a><span id="l12.1539"> </span>
<a href="#l12.1540"></a><span id="l12.1540">   summaryFileExists = exists &amp;&amp; fileSize &gt; 0;</span>
<a href="#l12.1541"></a><span id="l12.1541"> </span>
<a href="#l12.1542"></a><span id="l12.1542" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l12.1543"></a><span id="l12.1543" class="difflineminus">-  {</span>
<a href="#l12.1544"></a><span id="l12.1544" class="difflineminus">-    if (!m_dbFolderInfo)</span>
<a href="#l12.1545"></a><span id="l12.1545" class="difflineminus">-    {</span>
<a href="#l12.1546"></a><span id="l12.1546" class="difflineplus">+  if (NS_SUCCEEDED(err)) {</span>
<a href="#l12.1547"></a><span id="l12.1547" class="difflineplus">+    if (!m_dbFolderInfo) {</span>
<a href="#l12.1548"></a><span id="l12.1548">       err = NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l12.1549"></a><span id="l12.1549" class="difflineminus">-    }</span>
<a href="#l12.1550"></a><span id="l12.1550" class="difflineminus">-    else</span>
<a href="#l12.1551"></a><span id="l12.1551" class="difflineminus">-    {</span>
<a href="#l12.1552"></a><span id="l12.1552" class="difflineminus">-      if (!newFile &amp;&amp; summaryFileExists)</span>
<a href="#l12.1553"></a><span id="l12.1553" class="difflineminus">-      {</span>
<a href="#l12.1554"></a><span id="l12.1554" class="difflineplus">+    } else {</span>
<a href="#l12.1555"></a><span id="l12.1555" class="difflineplus">+      if (!newFile &amp;&amp; summaryFileExists) {</span>
<a href="#l12.1556"></a><span id="l12.1556">         bool valid = false;</span>
<a href="#l12.1557"></a><span id="l12.1557">         nsresult rv = GetSummaryValid(&amp;valid);</span>
<a href="#l12.1558"></a><span id="l12.1558">         if (NS_FAILED(rv) || !valid)</span>
<a href="#l12.1559"></a><span id="l12.1559">           err = NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l12.1560"></a><span id="l12.1560">       }</span>
<a href="#l12.1561"></a><span id="l12.1561">       // compare current version of db versus filed out version info.</span>
<a href="#l12.1562"></a><span id="l12.1562">       uint32_t version;</span>
<a href="#l12.1563"></a><span id="l12.1563">       m_dbFolderInfo-&gt;GetVersion(&amp;version);</span>
<a href="#l12.1564"></a><span id="l12.1564">       if (GetCurVersion() != version)</span>
<a href="#l12.1565"></a><span id="l12.1565">         err = NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l12.1566"></a><span id="l12.1566"> </span>
<a href="#l12.1567"></a><span id="l12.1567">       // Check if we should force a reparse because, for example, we have</span>
<a href="#l12.1568"></a><span id="l12.1568">       // reached the key limit.</span>
<a href="#l12.1569"></a><span id="l12.1569">       bool forceReparse;</span>
<a href="#l12.1570"></a><span id="l12.1570">       m_dbFolderInfo-&gt;GetBooleanProperty(&quot;forceReparse&quot;, false, &amp;forceReparse);</span>
<a href="#l12.1571"></a><span id="l12.1571" class="difflineminus">-      if (forceReparse)</span>
<a href="#l12.1572"></a><span id="l12.1572" class="difflineminus">-      {</span>
<a href="#l12.1573"></a><span id="l12.1573" class="difflineplus">+      if (forceReparse) {</span>
<a href="#l12.1574"></a><span id="l12.1574">         NS_WARNING(&quot;Forcing a reparse presumably because key limit reached&quot;);</span>
<a href="#l12.1575"></a><span id="l12.1575">         err = NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l12.1576"></a><span id="l12.1576">       }</span>
<a href="#l12.1577"></a><span id="l12.1577" class="difflineminus">-</span>
<a href="#l12.1578"></a><span id="l12.1578">     }</span>
<a href="#l12.1579"></a><span id="l12.1579" class="difflineminus">-    if (NS_FAILED(err) &amp;&amp; !m_leaveInvalidDB)</span>
<a href="#l12.1580"></a><span id="l12.1580" class="difflineminus">-      deleteInvalidDB = true;</span>
<a href="#l12.1581"></a><span id="l12.1581" class="difflineminus">-  }</span>
<a href="#l12.1582"></a><span id="l12.1582" class="difflineminus">-  else</span>
<a href="#l12.1583"></a><span id="l12.1583" class="difflineminus">-  {</span>
<a href="#l12.1584"></a><span id="l12.1584" class="difflineplus">+    if (NS_FAILED(err) &amp;&amp; !m_leaveInvalidDB) deleteInvalidDB = true;</span>
<a href="#l12.1585"></a><span id="l12.1585" class="difflineplus">+  } else {</span>
<a href="#l12.1586"></a><span id="l12.1586">     err = NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l12.1587"></a><span id="l12.1587">     deleteInvalidDB = true;</span>
<a href="#l12.1588"></a><span id="l12.1588">   }</span>
<a href="#l12.1589"></a><span id="l12.1589"> </span>
<a href="#l12.1590"></a><span id="l12.1590" class="difflineminus">-  if (deleteInvalidDB)</span>
<a href="#l12.1591"></a><span id="l12.1591" class="difflineminus">-  {</span>
<a href="#l12.1592"></a><span id="l12.1592" class="difflineplus">+  if (deleteInvalidDB) {</span>
<a href="#l12.1593"></a><span id="l12.1593">     // this will make the db folder info release its ref to the mail db...</span>
<a href="#l12.1594"></a><span id="l12.1594">     m_dbFolderInfo = nullptr;</span>
<a href="#l12.1595"></a><span id="l12.1595">     ForceClosed();</span>
<a href="#l12.1596"></a><span id="l12.1596">     if (err == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l12.1597"></a><span id="l12.1597">       summaryFile-&gt;Remove(false);</span>
<a href="#l12.1598"></a><span id="l12.1598">   }</span>
<a href="#l12.1599"></a><span id="l12.1599" class="difflineminus">-  if (NS_FAILED(err) || newFile)</span>
<a href="#l12.1600"></a><span id="l12.1600" class="difflineminus">-  {</span>
<a href="#l12.1601"></a><span id="l12.1601" class="difflineplus">+  if (NS_FAILED(err) || newFile) {</span>
<a href="#l12.1602"></a><span id="l12.1602">     // if we couldn't open file, or we have a blank one, and we're supposed</span>
<a href="#l12.1603"></a><span id="l12.1603">     // to upgrade, upgrade it.</span>
<a href="#l12.1604"></a><span id="l12.1604" class="difflineminus">-    if (newFile &amp;&amp; !m_leaveInvalidDB)  // caller is upgrading, and we have empty summary file,</span>
<a href="#l12.1605"></a><span id="l12.1605" class="difflineminus">-    {          // leave db around and open so caller can upgrade it.</span>
<a href="#l12.1606"></a><span id="l12.1606" class="difflineplus">+    if (newFile &amp;&amp; !m_leaveInvalidDB)  // caller is upgrading, and we have empty</span>
<a href="#l12.1607"></a><span id="l12.1607" class="difflineplus">+                                       // summary file,</span>
<a href="#l12.1608"></a><span id="l12.1608" class="difflineplus">+    {  // leave db around and open so caller can upgrade it.</span>
<a href="#l12.1609"></a><span id="l12.1609">       err = NS_MSG_ERROR_FOLDER_SUMMARY_MISSING;</span>
<a href="#l12.1610"></a><span id="l12.1610" class="difflineminus">-    }</span>
<a href="#l12.1611"></a><span id="l12.1611" class="difflineminus">-    else if (NS_FAILED(err) &amp;&amp; err != NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l12.1612"></a><span id="l12.1612" class="difflineminus">-    {</span>
<a href="#l12.1613"></a><span id="l12.1613" class="difflineplus">+    } else if (NS_FAILED(err) &amp;&amp;</span>
<a href="#l12.1614"></a><span id="l12.1614" class="difflineplus">+               err != NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE) {</span>
<a href="#l12.1615"></a><span id="l12.1615">       Close(false);</span>
<a href="#l12.1616"></a><span id="l12.1616">       summaryFile-&gt;Remove(false);  // blow away the db if it's corrupt.</span>
<a href="#l12.1617"></a><span id="l12.1617">     }</span>
<a href="#l12.1618"></a><span id="l12.1618">   }</span>
<a href="#l12.1619"></a><span id="l12.1619">   if (sync &amp;&amp; (NS_SUCCEEDED(err) || err == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING))</span>
<a href="#l12.1620"></a><span id="l12.1620">     aDBService-&gt;AddToCache(this);</span>
<a href="#l12.1621"></a><span id="l12.1621">   return (summaryFileExists) ? err : NS_MSG_ERROR_FOLDER_SUMMARY_MISSING;</span>
<a href="#l12.1622"></a><span id="l12.1622"> }</span>
<a href="#l12.1623"></a><span id="l12.1623"> </span>
<a href="#l12.1624"></a><span id="l12.1624"> /**</span>
<a href="#l12.1625"></a><span id="l12.1625">  * Open the MDB database synchronously or async based on sync argument.</span>
<a href="#l12.1626"></a><span id="l12.1626">  * If successful, this routine will set up the m_mdbStore and m_mdbEnv of</span>
<a href="#l12.1627"></a><span id="l12.1627">  * the database object so other database calls can work.</span>
<a href="#l12.1628"></a><span id="l12.1628">  */</span>
<a href="#l12.1629"></a><span id="l12.1629" class="difflineminus">-nsresult nsMsgDatabase::OpenMDB(nsIFile *dbFile, bool create, bool sync)</span>
<a href="#l12.1630"></a><span id="l12.1630" class="difflineminus">-{</span>
<a href="#l12.1631"></a><span id="l12.1631" class="difflineplus">+nsresult nsMsgDatabase::OpenMDB(nsIFile *dbFile, bool create, bool sync) {</span>
<a href="#l12.1632"></a><span id="l12.1632">   nsCOMPtr&lt;nsIMdbFactory&gt; mdbFactory;</span>
<a href="#l12.1633"></a><span id="l12.1633">   nsresult ret = GetMDBFactory(getter_AddRefs(mdbFactory));</span>
<a href="#l12.1634"></a><span id="l12.1634">   NS_ENSURE_SUCCESS(ret, ret);</span>
<a href="#l12.1635"></a><span id="l12.1635"> </span>
<a href="#l12.1636"></a><span id="l12.1636">   ret = mdbFactory-&gt;MakeEnv(NULL, &amp;m_mdbEnv);</span>
<a href="#l12.1637"></a><span id="l12.1637" class="difflineminus">-  if (NS_SUCCEEDED(ret))</span>
<a href="#l12.1638"></a><span id="l12.1638" class="difflineminus">-  {</span>
<a href="#l12.1639"></a><span id="l12.1639" class="difflineminus">-    nsIMdbHeap* dbHeap = nullptr;</span>
<a href="#l12.1640"></a><span id="l12.1640" class="difflineminus">-</span>
<a href="#l12.1641"></a><span id="l12.1641" class="difflineminus">-    if (m_mdbEnv)</span>
<a href="#l12.1642"></a><span id="l12.1642" class="difflineminus">-      m_mdbEnv-&gt;SetAutoClear(true);</span>
<a href="#l12.1643"></a><span id="l12.1643" class="difflineplus">+  if (NS_SUCCEEDED(ret)) {</span>
<a href="#l12.1644"></a><span id="l12.1644" class="difflineplus">+    nsIMdbHeap *dbHeap = nullptr;</span>
<a href="#l12.1645"></a><span id="l12.1645" class="difflineplus">+</span>
<a href="#l12.1646"></a><span id="l12.1646" class="difflineplus">+    if (m_mdbEnv) m_mdbEnv-&gt;SetAutoClear(true);</span>
<a href="#l12.1647"></a><span id="l12.1647">     PathString dbName = dbFile-&gt;NativePath();</span>
<a href="#l12.1648"></a><span id="l12.1648">     ret = dbFile-&gt;Clone(getter_AddRefs(m_dbFile));</span>
<a href="#l12.1649"></a><span id="l12.1649">     NS_ENSURE_SUCCESS(ret, ret);</span>
<a href="#l12.1650"></a><span id="l12.1650">     bool exists = false;</span>
<a href="#l12.1651"></a><span id="l12.1651">     ret = dbFile-&gt;Exists(&amp;exists);</span>
<a href="#l12.1652"></a><span id="l12.1652" class="difflineminus">-    if (!exists)</span>
<a href="#l12.1653"></a><span id="l12.1653" class="difflineminus">-    {</span>
<a href="#l12.1654"></a><span id="l12.1654" class="difflineplus">+    if (!exists) {</span>
<a href="#l12.1655"></a><span id="l12.1655">       ret = NS_MSG_ERROR_FOLDER_SUMMARY_MISSING;</span>
<a href="#l12.1656"></a><span id="l12.1656">     }</span>
<a href="#l12.1657"></a><span id="l12.1657">     // If m_thumb is set, we're asynchronously opening the db already.</span>
<a href="#l12.1658"></a><span id="l12.1658" class="difflineminus">-    else if (!m_thumb)</span>
<a href="#l12.1659"></a><span id="l12.1659" class="difflineminus">-    {</span>
<a href="#l12.1660"></a><span id="l12.1660" class="difflineplus">+    else if (!m_thumb) {</span>
<a href="#l12.1661"></a><span id="l12.1661">       mdbOpenPolicy inOpenPolicy;</span>
<a href="#l12.1662"></a><span id="l12.1662" class="difflineminus">-      mdb_bool  canOpen;</span>
<a href="#l12.1663"></a><span id="l12.1663" class="difflineminus">-      mdbYarn    outFormatVersion;</span>
<a href="#l12.1664"></a><span id="l12.1664" class="difflineminus">-</span>
<a href="#l12.1665"></a><span id="l12.1665" class="difflineminus">-      nsIMdbFile* oldFile = nullptr;</span>
<a href="#l12.1666"></a><span id="l12.1666" class="difflineminus">-      ret = mdbFactory-&gt;OpenOldFile(m_mdbEnv, dbHeap, dbName.get(),</span>
<a href="#l12.1667"></a><span id="l12.1667" class="difflineminus">-                                    mdbBool_kFalse, // not readonly, we want modifiable</span>
<a href="#l12.1668"></a><span id="l12.1668" class="difflineminus">-                                    &amp;oldFile);</span>
<a href="#l12.1669"></a><span id="l12.1669" class="difflineminus">-      if (oldFile)</span>
<a href="#l12.1670"></a><span id="l12.1670" class="difflineminus">-      {</span>
<a href="#l12.1671"></a><span id="l12.1671" class="difflineminus">-        if (NS_SUCCEEDED(ret))</span>
<a href="#l12.1672"></a><span id="l12.1672" class="difflineminus">-        {</span>
<a href="#l12.1673"></a><span id="l12.1673" class="difflineminus">-          ret = mdbFactory-&gt;CanOpenFilePort(m_mdbEnv, oldFile, // the file to investigate</span>
<a href="#l12.1674"></a><span id="l12.1674" class="difflineminus">-            &amp;canOpen, &amp;outFormatVersion);</span>
<a href="#l12.1675"></a><span id="l12.1675" class="difflineminus">-          if (NS_SUCCEEDED(ret) &amp;&amp; canOpen)</span>
<a href="#l12.1676"></a><span id="l12.1676" class="difflineminus">-          {</span>
<a href="#l12.1677"></a><span id="l12.1677" class="difflineplus">+      mdb_bool canOpen;</span>
<a href="#l12.1678"></a><span id="l12.1678" class="difflineplus">+      mdbYarn outFormatVersion;</span>
<a href="#l12.1679"></a><span id="l12.1679" class="difflineplus">+</span>
<a href="#l12.1680"></a><span id="l12.1680" class="difflineplus">+      nsIMdbFile *oldFile = nullptr;</span>
<a href="#l12.1681"></a><span id="l12.1681" class="difflineplus">+      ret = mdbFactory-&gt;OpenOldFile(</span>
<a href="#l12.1682"></a><span id="l12.1682" class="difflineplus">+          m_mdbEnv, dbHeap, dbName.get(),</span>
<a href="#l12.1683"></a><span id="l12.1683" class="difflineplus">+          mdbBool_kFalse,  // not readonly, we want modifiable</span>
<a href="#l12.1684"></a><span id="l12.1684" class="difflineplus">+          &amp;oldFile);</span>
<a href="#l12.1685"></a><span id="l12.1685" class="difflineplus">+      if (oldFile) {</span>
<a href="#l12.1686"></a><span id="l12.1686" class="difflineplus">+        if (NS_SUCCEEDED(ret)) {</span>
<a href="#l12.1687"></a><span id="l12.1687" class="difflineplus">+          ret = mdbFactory-&gt;CanOpenFilePort(m_mdbEnv,</span>
<a href="#l12.1688"></a><span id="l12.1688" class="difflineplus">+                                            oldFile,  // the file to investigate</span>
<a href="#l12.1689"></a><span id="l12.1689" class="difflineplus">+                                            &amp;canOpen, &amp;outFormatVersion);</span>
<a href="#l12.1690"></a><span id="l12.1690" class="difflineplus">+          if (NS_SUCCEEDED(ret) &amp;&amp; canOpen) {</span>
<a href="#l12.1691"></a><span id="l12.1691">             inOpenPolicy.mOpenPolicy_ScopePlan.mScopeStringSet_Count = 0;</span>
<a href="#l12.1692"></a><span id="l12.1692">             inOpenPolicy.mOpenPolicy_MinMemory = 0;</span>
<a href="#l12.1693"></a><span id="l12.1693">             inOpenPolicy.mOpenPolicy_MaxLazy = 0;</span>
<a href="#l12.1694"></a><span id="l12.1694"> </span>
<a href="#l12.1695"></a><span id="l12.1695" class="difflineminus">-            ret = mdbFactory-&gt;OpenFileStore(m_mdbEnv, dbHeap,</span>
<a href="#l12.1696"></a><span id="l12.1696" class="difflineminus">-              oldFile, &amp;inOpenPolicy, getter_AddRefs(m_thumb));</span>
<a href="#l12.1697"></a><span id="l12.1697" class="difflineminus">-          }</span>
<a href="#l12.1698"></a><span id="l12.1698" class="difflineminus">-          else</span>
<a href="#l12.1699"></a><span id="l12.1699" class="difflineplus">+            ret = mdbFactory-&gt;OpenFileStore(m_mdbEnv, dbHeap, oldFile,</span>
<a href="#l12.1700"></a><span id="l12.1700" class="difflineplus">+                                            &amp;inOpenPolicy,</span>
<a href="#l12.1701"></a><span id="l12.1701" class="difflineplus">+                                            getter_AddRefs(m_thumb));</span>
<a href="#l12.1702"></a><span id="l12.1702" class="difflineplus">+          } else</span>
<a href="#l12.1703"></a><span id="l12.1703">             ret = NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l12.1704"></a><span id="l12.1704">         }</span>
<a href="#l12.1705"></a><span id="l12.1705" class="difflineminus">-        NS_RELEASE(oldFile); // always release our file ref, store has own</span>
<a href="#l12.1706"></a><span id="l12.1706" class="difflineplus">+        NS_RELEASE(oldFile);  // always release our file ref, store has own</span>
<a href="#l12.1707"></a><span id="l12.1707">       }</span>
<a href="#l12.1708"></a><span id="l12.1708">     }</span>
<a href="#l12.1709"></a><span id="l12.1709" class="difflineminus">-    if (NS_SUCCEEDED(ret) &amp;&amp; m_thumb &amp;&amp; sync)</span>
<a href="#l12.1710"></a><span id="l12.1710" class="difflineminus">-    {</span>
<a href="#l12.1711"></a><span id="l12.1711" class="difflineminus">-      mdb_count outTotal;    // total somethings to do in operation</span>
<a href="#l12.1712"></a><span id="l12.1712" class="difflineminus">-      mdb_count outCurrent;  // subportion of total completed so far</span>
<a href="#l12.1713"></a><span id="l12.1713" class="difflineminus">-      mdb_bool outDone = false;      // is operation finished?</span>
<a href="#l12.1714"></a><span id="l12.1714" class="difflineminus">-      mdb_bool outBroken;     // is operation irreparably dead and broken?</span>
<a href="#l12.1715"></a><span id="l12.1715" class="difflineminus">-      do</span>
<a href="#l12.1716"></a><span id="l12.1716" class="difflineminus">-      {</span>
<a href="#l12.1717"></a><span id="l12.1717" class="difflineminus">-        ret = m_thumb-&gt;DoMore(m_mdbEnv, &amp;outTotal, &amp;outCurrent, &amp;outDone, &amp;outBroken);</span>
<a href="#l12.1718"></a><span id="l12.1718" class="difflineminus">-        if (NS_FAILED(ret))</span>
<a href="#l12.1719"></a><span id="l12.1719" class="difflineminus">-        {// mork isn't really doing NS errors yet.</span>
<a href="#l12.1720"></a><span id="l12.1720" class="difflineplus">+    if (NS_SUCCEEDED(ret) &amp;&amp; m_thumb &amp;&amp; sync) {</span>
<a href="#l12.1721"></a><span id="l12.1721" class="difflineplus">+      mdb_count outTotal;        // total somethings to do in operation</span>
<a href="#l12.1722"></a><span id="l12.1722" class="difflineplus">+      mdb_count outCurrent;      // subportion of total completed so far</span>
<a href="#l12.1723"></a><span id="l12.1723" class="difflineplus">+      mdb_bool outDone = false;  // is operation finished?</span>
<a href="#l12.1724"></a><span id="l12.1724" class="difflineplus">+      mdb_bool outBroken;        // is operation irreparably dead and broken?</span>
<a href="#l12.1725"></a><span id="l12.1725" class="difflineplus">+      do {</span>
<a href="#l12.1726"></a><span id="l12.1726" class="difflineplus">+        ret = m_thumb-&gt;DoMore(m_mdbEnv, &amp;outTotal, &amp;outCurrent, &amp;outDone,</span>
<a href="#l12.1727"></a><span id="l12.1727" class="difflineplus">+                              &amp;outBroken);</span>
<a href="#l12.1728"></a><span id="l12.1728" class="difflineplus">+        if (NS_FAILED(ret)) {  // mork isn't really doing NS errors yet.</span>
<a href="#l12.1729"></a><span id="l12.1729">           outDone = true;</span>
<a href="#l12.1730"></a><span id="l12.1730">           break;</span>
<a href="#l12.1731"></a><span id="l12.1731">         }</span>
<a href="#l12.1732"></a><span id="l12.1732" class="difflineminus">-      }</span>
<a href="#l12.1733"></a><span id="l12.1733" class="difflineminus">-      while (NS_SUCCEEDED(ret) &amp;&amp; !outBroken &amp;&amp; !outDone);</span>
<a href="#l12.1734"></a><span id="l12.1734" class="difflineplus">+      } while (NS_SUCCEEDED(ret) &amp;&amp; !outBroken &amp;&amp; !outDone);</span>
<a href="#l12.1735"></a><span id="l12.1735">       //        m_mdbEnv-&gt;ClearErrors(); // ### temporary...</span>
<a href="#l12.1736"></a><span id="l12.1736">       // only 0 is a non-error return.</span>
<a href="#l12.1737"></a><span id="l12.1737" class="difflineminus">-      if (NS_SUCCEEDED(ret) &amp;&amp; outDone)</span>
<a href="#l12.1738"></a><span id="l12.1738" class="difflineminus">-      {</span>
<a href="#l12.1739"></a><span id="l12.1739" class="difflineplus">+      if (NS_SUCCEEDED(ret) &amp;&amp; outDone) {</span>
<a href="#l12.1740"></a><span id="l12.1740">         ret = mdbFactory-&gt;ThumbToOpenStore(m_mdbEnv, m_thumb, &amp;m_mdbStore);</span>
<a href="#l12.1741"></a><span id="l12.1741">         if (NS_SUCCEEDED(ret))</span>
<a href="#l12.1742"></a><span id="l12.1742">           ret = (m_mdbStore) ? InitExistingDB() : NS_ERROR_FAILURE;</span>
<a href="#l12.1743"></a><span id="l12.1743">       }</span>
<a href="#l12.1744"></a><span id="l12.1744"> #ifdef DEBUG_bienvenu1</span>
<a href="#l12.1745"></a><span id="l12.1745">       DumpContents();</span>
<a href="#l12.1746"></a><span id="l12.1746"> #endif</span>
<a href="#l12.1747"></a><span id="l12.1747">       m_thumb = nullptr;</span>
<a href="#l12.1748"></a><span id="l12.1748" class="difflineminus">-    }</span>
<a href="#l12.1749"></a><span id="l12.1749" class="difflineminus">-    else if (create)  // ### need error code saying why open file store failed</span>
<a href="#l12.1750"></a><span id="l12.1750" class="difflineplus">+    } else if (create)  // ### need error code saying why open file store failed</span>
<a href="#l12.1751"></a><span id="l12.1751">     {</span>
<a href="#l12.1752"></a><span id="l12.1752" class="difflineminus">-      nsIMdbFile* newFile = 0;</span>
<a href="#l12.1753"></a><span id="l12.1753" class="difflineplus">+      nsIMdbFile *newFile = 0;</span>
<a href="#l12.1754"></a><span id="l12.1754">       ret = mdbFactory-&gt;CreateNewFile(m_mdbEnv, dbHeap, dbName.get(), &amp;newFile);</span>
<a href="#l12.1755"></a><span id="l12.1755" class="difflineminus">-      if (NS_FAILED(ret))</span>
<a href="#l12.1756"></a><span id="l12.1756" class="difflineminus">-        ret = NS_ERROR_FILE_TARGET_DOES_NOT_EXIST;</span>
<a href="#l12.1757"></a><span id="l12.1757" class="difflineminus">-      if ( newFile )</span>
<a href="#l12.1758"></a><span id="l12.1758" class="difflineminus">-      {</span>
<a href="#l12.1759"></a><span id="l12.1759" class="difflineminus">-        if (NS_SUCCEEDED(ret))</span>
<a href="#l12.1760"></a><span id="l12.1760" class="difflineminus">-        {</span>
<a href="#l12.1761"></a><span id="l12.1761" class="difflineplus">+      if (NS_FAILED(ret)) ret = NS_ERROR_FILE_TARGET_DOES_NOT_EXIST;</span>
<a href="#l12.1762"></a><span id="l12.1762" class="difflineplus">+      if (newFile) {</span>
<a href="#l12.1763"></a><span id="l12.1763" class="difflineplus">+        if (NS_SUCCEEDED(ret)) {</span>
<a href="#l12.1764"></a><span id="l12.1764">           mdbOpenPolicy inOpenPolicy;</span>
<a href="#l12.1765"></a><span id="l12.1765"> </span>
<a href="#l12.1766"></a><span id="l12.1766">           inOpenPolicy.mOpenPolicy_ScopePlan.mScopeStringSet_Count = 0;</span>
<a href="#l12.1767"></a><span id="l12.1767">           inOpenPolicy.mOpenPolicy_MinMemory = 0;</span>
<a href="#l12.1768"></a><span id="l12.1768">           inOpenPolicy.mOpenPolicy_MaxLazy = 0;</span>
<a href="#l12.1769"></a><span id="l12.1769"> </span>
<a href="#l12.1770"></a><span id="l12.1770" class="difflineminus">-          ret = mdbFactory-&gt;CreateNewFileStore(m_mdbEnv, dbHeap,</span>
<a href="#l12.1771"></a><span id="l12.1771" class="difflineminus">-            newFile, &amp;inOpenPolicy, &amp;m_mdbStore);</span>
<a href="#l12.1772"></a><span id="l12.1772" class="difflineplus">+          ret = mdbFactory-&gt;CreateNewFileStore(m_mdbEnv, dbHeap, newFile,</span>
<a href="#l12.1773"></a><span id="l12.1773" class="difflineplus">+                                               &amp;inOpenPolicy, &amp;m_mdbStore);</span>
<a href="#l12.1774"></a><span id="l12.1774">           if (NS_SUCCEEDED(ret))</span>
<a href="#l12.1775"></a><span id="l12.1775">             ret = (m_mdbStore) ? InitNewDB() : NS_ERROR_FAILURE;</span>
<a href="#l12.1776"></a><span id="l12.1776">         }</span>
<a href="#l12.1777"></a><span id="l12.1777" class="difflineminus">-        NS_RELEASE(newFile); // always release our file ref, store has own</span>
<a href="#l12.1778"></a><span id="l12.1778" class="difflineplus">+        NS_RELEASE(newFile);  // always release our file ref, store has own</span>
<a href="#l12.1779"></a><span id="l12.1779">       }</span>
<a href="#l12.1780"></a><span id="l12.1780">     }</span>
<a href="#l12.1781"></a><span id="l12.1781">   }</span>
<a href="#l12.1782"></a><span id="l12.1782"> </span>
<a href="#l12.1783"></a><span id="l12.1783">   return ret;</span>
<a href="#l12.1784"></a><span id="l12.1784"> }</span>
<a href="#l12.1785"></a><span id="l12.1785"> </span>
<a href="#l12.1786"></a><span id="l12.1786" class="difflineminus">-nsresult nsMsgDatabase::CloseMDB(bool commit)</span>
<a href="#l12.1787"></a><span id="l12.1787" class="difflineminus">-{</span>
<a href="#l12.1788"></a><span id="l12.1788" class="difflineminus">-  if (commit)</span>
<a href="#l12.1789"></a><span id="l12.1789" class="difflineminus">-    Commit(nsMsgDBCommitType::kSessionCommit);</span>
<a href="#l12.1790"></a><span id="l12.1790" class="difflineminus">-  return(NS_OK);</span>
<a href="#l12.1791"></a><span id="l12.1791" class="difflineminus">-}</span>
<a href="#l12.1792"></a><span id="l12.1792" class="difflineminus">-</span>
<a href="#l12.1793"></a><span id="l12.1793" class="difflineplus">+nsresult nsMsgDatabase::CloseMDB(bool commit) {</span>
<a href="#l12.1794"></a><span id="l12.1794" class="difflineplus">+  if (commit) Commit(nsMsgDBCommitType::kSessionCommit);</span>
<a href="#l12.1795"></a><span id="l12.1795" class="difflineplus">+  return (NS_OK);</span>
<a href="#l12.1796"></a><span id="l12.1796" class="difflineplus">+}</span>
<a href="#l12.1797"></a><span id="l12.1797"> </span>
<a href="#l12.1798"></a><span id="l12.1798"> // force the database to close - this'll flush out anybody holding onto</span>
<a href="#l12.1799"></a><span id="l12.1799"> // a database without having a listener!</span>
<a href="#l12.1800"></a><span id="l12.1800" class="difflineminus">-// This is evil in the com world, but there are times we need to delete the file.</span>
<a href="#l12.1801"></a><span id="l12.1801" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::ForceClosed()</span>
<a href="#l12.1802"></a><span id="l12.1802" class="difflineminus">-{</span>
<a href="#l12.1803"></a><span id="l12.1803" class="difflineminus">-  nsresult  err = NS_OK;</span>
<a href="#l12.1804"></a><span id="l12.1804" class="difflineminus">-</span>
<a href="#l12.1805"></a><span id="l12.1805" class="difflineminus">-  // make sure someone has a reference so object won't get deleted out from under us.</span>
<a href="#l12.1806"></a><span id="l12.1806" class="difflineplus">+// This is evil in the com world, but there are times we need to delete the</span>
<a href="#l12.1807"></a><span id="l12.1807" class="difflineplus">+// file.</span>
<a href="#l12.1808"></a><span id="l12.1808" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::ForceClosed() {</span>
<a href="#l12.1809"></a><span id="l12.1809" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l12.1810"></a><span id="l12.1810" class="difflineplus">+</span>
<a href="#l12.1811"></a><span id="l12.1811" class="difflineplus">+  // make sure someone has a reference so object won't get deleted out from</span>
<a href="#l12.1812"></a><span id="l12.1812" class="difflineplus">+  // under us.</span>
<a href="#l12.1813"></a><span id="l12.1813">   NS_ADDREF_THIS();</span>
<a href="#l12.1814"></a><span id="l12.1814">   NotifyAnnouncerGoingAway();</span>
<a href="#l12.1815"></a><span id="l12.1815" class="difflineminus">-  // make sure dbFolderInfo isn't holding onto mork stuff because mork db is going away</span>
<a href="#l12.1816"></a><span id="l12.1816" class="difflineminus">-  if (m_dbFolderInfo)</span>
<a href="#l12.1817"></a><span id="l12.1817" class="difflineminus">-    m_dbFolderInfo-&gt;ReleaseExternalReferences();</span>
<a href="#l12.1818"></a><span id="l12.1818" class="difflineplus">+  // make sure dbFolderInfo isn't holding onto mork stuff because mork db is</span>
<a href="#l12.1819"></a><span id="l12.1819" class="difflineplus">+  // going away</span>
<a href="#l12.1820"></a><span id="l12.1820" class="difflineplus">+  if (m_dbFolderInfo) m_dbFolderInfo-&gt;ReleaseExternalReferences();</span>
<a href="#l12.1821"></a><span id="l12.1821">   m_dbFolderInfo = nullptr;</span>
<a href="#l12.1822"></a><span id="l12.1822"> </span>
<a href="#l12.1823"></a><span id="l12.1823">   err = CloseMDB(true);  // Backup DB will try to recover info, so commit</span>
<a href="#l12.1824"></a><span id="l12.1824">   ClearCachedObjects(true);</span>
<a href="#l12.1825"></a><span id="l12.1825">   ClearEnumerators();</span>
<a href="#l12.1826"></a><span id="l12.1826" class="difflineminus">-if (m_mdbAllMsgHeadersTable)</span>
<a href="#l12.1827"></a><span id="l12.1827" class="difflineminus">-  {</span>
<a href="#l12.1828"></a><span id="l12.1828" class="difflineplus">+  if (m_mdbAllMsgHeadersTable) {</span>
<a href="#l12.1829"></a><span id="l12.1829">     m_mdbAllMsgHeadersTable-&gt;Release();</span>
<a href="#l12.1830"></a><span id="l12.1830">     m_mdbAllMsgHeadersTable = nullptr;</span>
<a href="#l12.1831"></a><span id="l12.1831">   }</span>
<a href="#l12.1832"></a><span id="l12.1832" class="difflineminus">-  if (m_mdbAllThreadsTable)</span>
<a href="#l12.1833"></a><span id="l12.1833" class="difflineminus">-  {</span>
<a href="#l12.1834"></a><span id="l12.1834" class="difflineplus">+  if (m_mdbAllThreadsTable) {</span>
<a href="#l12.1835"></a><span id="l12.1835">     m_mdbAllThreadsTable-&gt;Release();</span>
<a href="#l12.1836"></a><span id="l12.1836">     m_mdbAllThreadsTable = nullptr;</span>
<a href="#l12.1837"></a><span id="l12.1837">   }</span>
<a href="#l12.1838"></a><span id="l12.1838" class="difflineminus">-  if (m_mdbStore)</span>
<a href="#l12.1839"></a><span id="l12.1839" class="difflineminus">-  {</span>
<a href="#l12.1840"></a><span id="l12.1840" class="difflineplus">+  if (m_mdbStore) {</span>
<a href="#l12.1841"></a><span id="l12.1841">     m_mdbStore-&gt;Release();</span>
<a href="#l12.1842"></a><span id="l12.1842">     m_mdbStore = nullptr;</span>
<a href="#l12.1843"></a><span id="l12.1843">   }</span>
<a href="#l12.1844"></a><span id="l12.1844"> </span>
<a href="#l12.1845"></a><span id="l12.1845">   // better not be any listeners, because we're going away.</span>
<a href="#l12.1846"></a><span id="l12.1846" class="difflineminus">-  NS_ASSERTION(m_ChangeListeners.IsEmpty(), &quot;shouldn't have any listeners left&quot;);</span>
<a href="#l12.1847"></a><span id="l12.1847" class="difflineplus">+  NS_ASSERTION(m_ChangeListeners.IsEmpty(),</span>
<a href="#l12.1848"></a><span id="l12.1848" class="difflineplus">+               &quot;shouldn't have any listeners left&quot;);</span>
<a href="#l12.1849"></a><span id="l12.1849"> </span>
<a href="#l12.1850"></a><span id="l12.1850">   NS_RELEASE_THIS();</span>
<a href="#l12.1851"></a><span id="l12.1851">   return err;</span>
<a href="#l12.1852"></a><span id="l12.1852"> }</span>
<a href="#l12.1853"></a><span id="l12.1853"> </span>
<a href="#l12.1854"></a><span id="l12.1854" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetDBFolderInfo(nsIDBFolderInfo  **result)</span>
<a href="#l12.1855"></a><span id="l12.1855" class="difflineminus">-{</span>
<a href="#l12.1856"></a><span id="l12.1856" class="difflineminus">-  if (!m_dbFolderInfo)</span>
<a href="#l12.1857"></a><span id="l12.1857" class="difflineminus">-  {</span>
<a href="#l12.1858"></a><span id="l12.1858" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetDBFolderInfo(nsIDBFolderInfo **result) {</span>
<a href="#l12.1859"></a><span id="l12.1859" class="difflineplus">+  if (!m_dbFolderInfo) {</span>
<a href="#l12.1860"></a><span id="l12.1860">     NS_ERROR(&quot;db must be corrupt&quot;);</span>
<a href="#l12.1861"></a><span id="l12.1861">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.1862"></a><span id="l12.1862">   }</span>
<a href="#l12.1863"></a><span id="l12.1863">   NS_ADDREF(*result = m_dbFolderInfo);</span>
<a href="#l12.1864"></a><span id="l12.1864">   return NS_OK;</span>
<a href="#l12.1865"></a><span id="l12.1865"> }</span>
<a href="#l12.1866"></a><span id="l12.1866"> </span>
<a href="#l12.1867"></a><span id="l12.1867" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetFolder(nsIMsgFolder **aFolder)</span>
<a href="#l12.1868"></a><span id="l12.1868" class="difflineminus">-{</span>
<a href="#l12.1869"></a><span id="l12.1869" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetFolder(nsIMsgFolder **aFolder) {</span>
<a href="#l12.1870"></a><span id="l12.1870">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l12.1871"></a><span id="l12.1871">   NS_IF_ADDREF(*aFolder = m_folder);</span>
<a href="#l12.1872"></a><span id="l12.1872">   return NS_OK;</span>
<a href="#l12.1873"></a><span id="l12.1873"> }</span>
<a href="#l12.1874"></a><span id="l12.1874"> </span>
<a href="#l12.1875"></a><span id="l12.1875" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::Commit(nsMsgDBCommit commitType)</span>
<a href="#l12.1876"></a><span id="l12.1876" class="difflineminus">-{</span>
<a href="#l12.1877"></a><span id="l12.1877" class="difflineminus">-  nsresult  err = NS_OK;</span>
<a href="#l12.1878"></a><span id="l12.1878" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::Commit(nsMsgDBCommit commitType) {</span>
<a href="#l12.1879"></a><span id="l12.1879" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l12.1880"></a><span id="l12.1880">   nsCOMPtr&lt;nsIMdbThumb&gt; commitThumb;</span>
<a href="#l12.1881"></a><span id="l12.1881"> </span>
<a href="#l12.1882"></a><span id="l12.1882">   RememberLastUseTime();</span>
<a href="#l12.1883"></a><span id="l12.1883" class="difflineminus">-  if (commitType == nsMsgDBCommitType::kLargeCommit || commitType == nsMsgDBCommitType::kSessionCommit)</span>
<a href="#l12.1884"></a><span id="l12.1884" class="difflineminus">-  {</span>
<a href="#l12.1885"></a><span id="l12.1885" class="difflineplus">+  if (commitType == nsMsgDBCommitType::kLargeCommit ||</span>
<a href="#l12.1886"></a><span id="l12.1886" class="difflineplus">+      commitType == nsMsgDBCommitType::kSessionCommit) {</span>
<a href="#l12.1887"></a><span id="l12.1887">     mdb_percent outActualWaste = 0;</span>
<a href="#l12.1888"></a><span id="l12.1888">     mdb_bool outShould;</span>
<a href="#l12.1889"></a><span id="l12.1889">     if (m_mdbStore) {</span>
<a href="#l12.1890"></a><span id="l12.1890" class="difflineminus">-      err = m_mdbStore-&gt;ShouldCompress(GetEnv(), 30, &amp;outActualWaste, &amp;outShould);</span>
<a href="#l12.1891"></a><span id="l12.1891" class="difflineplus">+      err =</span>
<a href="#l12.1892"></a><span id="l12.1892" class="difflineplus">+          m_mdbStore-&gt;ShouldCompress(GetEnv(), 30, &amp;outActualWaste, &amp;outShould);</span>
<a href="#l12.1893"></a><span id="l12.1893">       if (NS_SUCCEEDED(err) &amp;&amp; outShould)</span>
<a href="#l12.1894"></a><span id="l12.1894">         commitType = nsMsgDBCommitType::kCompressCommit;</span>
<a href="#l12.1895"></a><span id="l12.1895">     }</span>
<a href="#l12.1896"></a><span id="l12.1896">   }</span>
<a href="#l12.1897"></a><span id="l12.1897" class="difflineminus">-  //  commitType = nsMsgDBCommitType::kCompressCommit;  // ### until incremental writing works.</span>
<a href="#l12.1898"></a><span id="l12.1898" class="difflineminus">-</span>
<a href="#l12.1899"></a><span id="l12.1899" class="difflineminus">-  if (m_mdbStore)</span>
<a href="#l12.1900"></a><span id="l12.1900" class="difflineminus">-  {</span>
<a href="#l12.1901"></a><span id="l12.1901" class="difflineminus">-    switch (commitType)</span>
<a href="#l12.1902"></a><span id="l12.1902" class="difflineminus">-    {</span>
<a href="#l12.1903"></a><span id="l12.1903" class="difflineminus">-    case nsMsgDBCommitType::kLargeCommit:</span>
<a href="#l12.1904"></a><span id="l12.1904" class="difflineminus">-      err = m_mdbStore-&gt;LargeCommit(GetEnv(), getter_AddRefs(commitThumb));</span>
<a href="#l12.1905"></a><span id="l12.1905" class="difflineminus">-      break;</span>
<a href="#l12.1906"></a><span id="l12.1906" class="difflineminus">-    case nsMsgDBCommitType::kSessionCommit:</span>
<a href="#l12.1907"></a><span id="l12.1907" class="difflineminus">-      err = m_mdbStore-&gt;SessionCommit(GetEnv(), getter_AddRefs(commitThumb));</span>
<a href="#l12.1908"></a><span id="l12.1908" class="difflineminus">-      break;</span>
<a href="#l12.1909"></a><span id="l12.1909" class="difflineminus">-    case nsMsgDBCommitType::kCompressCommit:</span>
<a href="#l12.1910"></a><span id="l12.1910" class="difflineminus">-      err = m_mdbStore-&gt;CompressCommit(GetEnv(), getter_AddRefs(commitThumb));</span>
<a href="#l12.1911"></a><span id="l12.1911" class="difflineminus">-      break;</span>
<a href="#l12.1912"></a><span id="l12.1912" class="difflineplus">+  //  commitType = nsMsgDBCommitType::kCompressCommit;  // ### until incremental</span>
<a href="#l12.1913"></a><span id="l12.1913" class="difflineplus">+  //  writing works.</span>
<a href="#l12.1914"></a><span id="l12.1914" class="difflineplus">+</span>
<a href="#l12.1915"></a><span id="l12.1915" class="difflineplus">+  if (m_mdbStore) {</span>
<a href="#l12.1916"></a><span id="l12.1916" class="difflineplus">+    switch (commitType) {</span>
<a href="#l12.1917"></a><span id="l12.1917" class="difflineplus">+      case nsMsgDBCommitType::kLargeCommit:</span>
<a href="#l12.1918"></a><span id="l12.1918" class="difflineplus">+        err = m_mdbStore-&gt;LargeCommit(GetEnv(), getter_AddRefs(commitThumb));</span>
<a href="#l12.1919"></a><span id="l12.1919" class="difflineplus">+        break;</span>
<a href="#l12.1920"></a><span id="l12.1920" class="difflineplus">+      case nsMsgDBCommitType::kSessionCommit:</span>
<a href="#l12.1921"></a><span id="l12.1921" class="difflineplus">+        err = m_mdbStore-&gt;SessionCommit(GetEnv(), getter_AddRefs(commitThumb));</span>
<a href="#l12.1922"></a><span id="l12.1922" class="difflineplus">+        break;</span>
<a href="#l12.1923"></a><span id="l12.1923" class="difflineplus">+      case nsMsgDBCommitType::kCompressCommit:</span>
<a href="#l12.1924"></a><span id="l12.1924" class="difflineplus">+        err = m_mdbStore-&gt;CompressCommit(GetEnv(), getter_AddRefs(commitThumb));</span>
<a href="#l12.1925"></a><span id="l12.1925" class="difflineplus">+        break;</span>
<a href="#l12.1926"></a><span id="l12.1926">     }</span>
<a href="#l12.1927"></a><span id="l12.1927">   }</span>
<a href="#l12.1928"></a><span id="l12.1928" class="difflineminus">-  if (commitThumb)</span>
<a href="#l12.1929"></a><span id="l12.1929" class="difflineminus">-  {</span>
<a href="#l12.1930"></a><span id="l12.1930" class="difflineminus">-    mdb_count outTotal = 0;    // total somethings to do in operation</span>
<a href="#l12.1931"></a><span id="l12.1931" class="difflineminus">-    mdb_count outCurrent = 0;  // subportion of total completed so far</span>
<a href="#l12.1932"></a><span id="l12.1932" class="difflineminus">-    mdb_bool outDone = false;      // is operation finished?</span>
<a href="#l12.1933"></a><span id="l12.1933" class="difflineminus">-    mdb_bool outBroken = false;     // is operation irreparably dead and broken?</span>
<a href="#l12.1934"></a><span id="l12.1934" class="difflineminus">-    while (!outDone &amp;&amp; !outBroken &amp;&amp; NS_SUCCEEDED(err))</span>
<a href="#l12.1935"></a><span id="l12.1935" class="difflineminus">-    {</span>
<a href="#l12.1936"></a><span id="l12.1936" class="difflineminus">-      err = commitThumb-&gt;DoMore(GetEnv(), &amp;outTotal, &amp;outCurrent, &amp;outDone, &amp;outBroken);</span>
<a href="#l12.1937"></a><span id="l12.1937" class="difflineplus">+  if (commitThumb) {</span>
<a href="#l12.1938"></a><span id="l12.1938" class="difflineplus">+    mdb_count outTotal = 0;      // total somethings to do in operation</span>
<a href="#l12.1939"></a><span id="l12.1939" class="difflineplus">+    mdb_count outCurrent = 0;    // subportion of total completed so far</span>
<a href="#l12.1940"></a><span id="l12.1940" class="difflineplus">+    mdb_bool outDone = false;    // is operation finished?</span>
<a href="#l12.1941"></a><span id="l12.1941" class="difflineplus">+    mdb_bool outBroken = false;  // is operation irreparably dead and broken?</span>
<a href="#l12.1942"></a><span id="l12.1942" class="difflineplus">+    while (!outDone &amp;&amp; !outBroken &amp;&amp; NS_SUCCEEDED(err)) {</span>
<a href="#l12.1943"></a><span id="l12.1943" class="difflineplus">+      err = commitThumb-&gt;DoMore(GetEnv(), &amp;outTotal, &amp;outCurrent, &amp;outDone,</span>
<a href="#l12.1944"></a><span id="l12.1944" class="difflineplus">+                                &amp;outBroken);</span>
<a href="#l12.1945"></a><span id="l12.1945">     }</span>
<a href="#l12.1946"></a><span id="l12.1946" class="difflineminus">-</span>
<a href="#l12.1947"></a><span id="l12.1947">   }</span>
<a href="#l12.1948"></a><span id="l12.1948" class="difflineminus">-  // ### do something with error, but clear it now because mork errors out on commits.</span>
<a href="#l12.1949"></a><span id="l12.1949" class="difflineminus">-  if (GetEnv())</span>
<a href="#l12.1950"></a><span id="l12.1950" class="difflineminus">-    GetEnv()-&gt;ClearErrors();</span>
<a href="#l12.1951"></a><span id="l12.1951" class="difflineplus">+  // ### do something with error, but clear it now because mork errors out on</span>
<a href="#l12.1952"></a><span id="l12.1952" class="difflineplus">+  // commits.</span>
<a href="#l12.1953"></a><span id="l12.1953" class="difflineplus">+  if (GetEnv()) GetEnv()-&gt;ClearErrors();</span>
<a href="#l12.1954"></a><span id="l12.1954"> </span>
<a href="#l12.1955"></a><span id="l12.1955">   nsresult rv;</span>
<a href="#l12.1956"></a><span id="l12.1956">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l12.1957"></a><span id="l12.1957" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l12.1958"></a><span id="l12.1958" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; accountManager)</span>
<a href="#l12.1959"></a><span id="l12.1959" class="difflineminus">-  {</span>
<a href="#l12.1960"></a><span id="l12.1960" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l12.1961"></a><span id="l12.1961" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; accountManager) {</span>
<a href="#l12.1962"></a><span id="l12.1962">     nsCOMPtr&lt;nsIMsgFolderCache&gt; folderCache;</span>
<a href="#l12.1963"></a><span id="l12.1963"> </span>
<a href="#l12.1964"></a><span id="l12.1964">     rv = accountManager-&gt;GetFolderCache(getter_AddRefs(folderCache));</span>
<a href="#l12.1965"></a><span id="l12.1965" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; folderCache)</span>
<a href="#l12.1966"></a><span id="l12.1966" class="difflineminus">-    {</span>
<a href="#l12.1967"></a><span id="l12.1967" class="difflineminus">-      nsCOMPtr &lt;nsIMsgFolderCacheElement&gt; cacheElement;</span>
<a href="#l12.1968"></a><span id="l12.1968" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; folderCache) {</span>
<a href="#l12.1969"></a><span id="l12.1969" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolderCacheElement&gt; cacheElement;</span>
<a href="#l12.1970"></a><span id="l12.1970">       nsCString persistentPath;</span>
<a href="#l12.1971"></a><span id="l12.1971">       NS_ENSURE_TRUE(m_dbFile, NS_ERROR_NULL_POINTER);</span>
<a href="#l12.1972"></a><span id="l12.1972">       rv = m_dbFile-&gt;GetPersistentDescriptor(persistentPath);</span>
<a href="#l12.1973"></a><span id="l12.1973">       NS_ENSURE_SUCCESS(rv, err);</span>
<a href="#l12.1974"></a><span id="l12.1974" class="difflineminus">-      rv = folderCache-&gt;GetCacheElement(persistentPath, false, getter_AddRefs(cacheElement));</span>
<a href="#l12.1975"></a><span id="l12.1975" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; cacheElement &amp;&amp; m_dbFolderInfo)</span>
<a href="#l12.1976"></a><span id="l12.1976" class="difflineminus">-      {</span>
<a href="#l12.1977"></a><span id="l12.1977" class="difflineminus">-        int32_t totalMessages, unreadMessages, pendingMessages, pendingUnreadMessages;</span>
<a href="#l12.1978"></a><span id="l12.1978" class="difflineplus">+      rv = folderCache-&gt;GetCacheElement(persistentPath, false,</span>
<a href="#l12.1979"></a><span id="l12.1979" class="difflineplus">+                                        getter_AddRefs(cacheElement));</span>
<a href="#l12.1980"></a><span id="l12.1980" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; cacheElement &amp;&amp; m_dbFolderInfo) {</span>
<a href="#l12.1981"></a><span id="l12.1981" class="difflineplus">+        int32_t totalMessages, unreadMessages, pendingMessages,</span>
<a href="#l12.1982"></a><span id="l12.1982" class="difflineplus">+            pendingUnreadMessages;</span>
<a href="#l12.1983"></a><span id="l12.1983"> </span>
<a href="#l12.1984"></a><span id="l12.1984">         m_dbFolderInfo-&gt;GetNumMessages(&amp;totalMessages);</span>
<a href="#l12.1985"></a><span id="l12.1985">         m_dbFolderInfo-&gt;GetNumUnreadMessages(&amp;unreadMessages);</span>
<a href="#l12.1986"></a><span id="l12.1986">         m_dbFolderInfo-&gt;GetImapUnreadPendingMessages(&amp;pendingUnreadMessages);</span>
<a href="#l12.1987"></a><span id="l12.1987">         m_dbFolderInfo-&gt;GetImapTotalPendingMessages(&amp;pendingMessages);</span>
<a href="#l12.1988"></a><span id="l12.1988">         cacheElement-&gt;SetInt32Property(&quot;totalMsgs&quot;, totalMessages);</span>
<a href="#l12.1989"></a><span id="l12.1989">         cacheElement-&gt;SetInt32Property(&quot;totalUnreadMsgs&quot;, unreadMessages);</span>
<a href="#l12.1990"></a><span id="l12.1990">         cacheElement-&gt;SetInt32Property(&quot;pendingMsgs&quot;, pendingMessages);</span>
<a href="#l12.1991"></a><span id="l12.1991" class="difflineminus">-        cacheElement-&gt;SetInt32Property(&quot;pendingUnreadMsgs&quot;, pendingUnreadMessages);</span>
<a href="#l12.1992"></a><span id="l12.1992" class="difflineplus">+        cacheElement-&gt;SetInt32Property(&quot;pendingUnreadMsgs&quot;,</span>
<a href="#l12.1993"></a><span id="l12.1993" class="difflineplus">+                                       pendingUnreadMessages);</span>
<a href="#l12.1994"></a><span id="l12.1994">         folderCache-&gt;Commit(false);</span>
<a href="#l12.1995"></a><span id="l12.1995">       }</span>
<a href="#l12.1996"></a><span id="l12.1996">     }</span>
<a href="#l12.1997"></a><span id="l12.1997">   }</span>
<a href="#l12.1998"></a><span id="l12.1998"> </span>
<a href="#l12.1999"></a><span id="l12.1999">   return err;</span>
<a href="#l12.2000"></a><span id="l12.2000"> }</span>
<a href="#l12.2001"></a><span id="l12.2001"> </span>
<a href="#l12.2002"></a><span id="l12.2002" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::Close(bool forceCommit /* = TRUE */)</span>
<a href="#l12.2003"></a><span id="l12.2003" class="difflineminus">-{</span>
<a href="#l12.2004"></a><span id="l12.2004" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::Close(bool forceCommit /* = TRUE */) {</span>
<a href="#l12.2005"></a><span id="l12.2005">   return CloseMDB(forceCommit);</span>
<a href="#l12.2006"></a><span id="l12.2006"> }</span>
<a href="#l12.2007"></a><span id="l12.2007"> </span>
<a href="#l12.2008"></a><span id="l12.2008" class="difflineminus">-const char *kMsgHdrsScope = &quot;ns:msg:db:row:scope:msgs:all&quot;;  // scope for all headers table</span>
<a href="#l12.2009"></a><span id="l12.2009" class="difflineplus">+const char *kMsgHdrsScope =</span>
<a href="#l12.2010"></a><span id="l12.2010" class="difflineplus">+    &quot;ns:msg:db:row:scope:msgs:all&quot;;  // scope for all headers table</span>
<a href="#l12.2011"></a><span id="l12.2011"> const char *kMsgHdrsTableKind = &quot;ns:msg:db:table:kind:msgs&quot;;</span>
<a href="#l12.2012"></a><span id="l12.2012"> const char *kThreadTableKind = &quot;ns:msg:db:table:kind:thread&quot;;</span>
<a href="#l12.2013"></a><span id="l12.2013" class="difflineminus">-const char *kThreadHdrsScope = &quot;ns:msg:db:row:scope:threads:all&quot;; // scope for all threads table</span>
<a href="#l12.2014"></a><span id="l12.2014" class="difflineminus">-const char *kAllThreadsTableKind = &quot;ns:msg:db:table:kind:allthreads&quot;; // kind for table of all threads</span>
<a href="#l12.2015"></a><span id="l12.2015" class="difflineplus">+const char *kThreadHdrsScope =</span>
<a href="#l12.2016"></a><span id="l12.2016" class="difflineplus">+    &quot;ns:msg:db:row:scope:threads:all&quot;;  // scope for all threads table</span>
<a href="#l12.2017"></a><span id="l12.2017" class="difflineplus">+const char *kAllThreadsTableKind =</span>
<a href="#l12.2018"></a><span id="l12.2018" class="difflineplus">+    &quot;ns:msg:db:table:kind:allthreads&quot;;  // kind for table of all threads</span>
<a href="#l12.2019"></a><span id="l12.2019"> const char *kSubjectColumnName = &quot;subject&quot;;</span>
<a href="#l12.2020"></a><span id="l12.2020"> const char *kSenderColumnName = &quot;sender&quot;;</span>
<a href="#l12.2021"></a><span id="l12.2021"> const char *kMessageIdColumnName = &quot;message-id&quot;;</span>
<a href="#l12.2022"></a><span id="l12.2022"> const char *kReferencesColumnName = &quot;references&quot;;</span>
<a href="#l12.2023"></a><span id="l12.2023"> const char *kRecipientsColumnName = &quot;recipients&quot;;</span>
<a href="#l12.2024"></a><span id="l12.2024"> const char *kDateColumnName = &quot;date&quot;;</span>
<a href="#l12.2025"></a><span id="l12.2025"> const char *kMessageSizeColumnName = &quot;size&quot;;</span>
<a href="#l12.2026"></a><span id="l12.2026"> const char *kFlagsColumnName = &quot;flags&quot;;</span>
<a href="#l12.2027"></a><span id="l12.2027" class="difflineat">@@ -1613,3465 +1452,3149 @@ const char *kThreadRootColumnName = &quot;thr</span>
<a href="#l12.2028"></a><span id="l12.2028"> const char *kThreadNewestMsgDateColumnName = &quot;threadNewestMsgDate&quot;;</span>
<a href="#l12.2029"></a><span id="l12.2029"> const char *kOfflineMsgOffsetColumnName = &quot;msgOffset&quot;;</span>
<a href="#l12.2030"></a><span id="l12.2030"> const char *kOfflineMsgSizeColumnName = &quot;offlineMsgSize&quot;;</span>
<a href="#l12.2031"></a><span id="l12.2031"> struct mdbOid gAllMsgHdrsTableOID;</span>
<a href="#l12.2032"></a><span id="l12.2032"> struct mdbOid gAllThreadsTableOID;</span>
<a href="#l12.2033"></a><span id="l12.2033"> const char *kFixedBadRefThreadingProp = &quot;fixedBadRefThreading&quot;;</span>
<a href="#l12.2034"></a><span id="l12.2034"> </span>
<a href="#l12.2035"></a><span id="l12.2035"> // set up empty tables, dbFolderInfo, etc.</span>
<a href="#l12.2036"></a><span id="l12.2036" class="difflineminus">-nsresult nsMsgDatabase::InitNewDB()</span>
<a href="#l12.2037"></a><span id="l12.2037" class="difflineminus">-{</span>
<a href="#l12.2038"></a><span id="l12.2038" class="difflineplus">+nsresult nsMsgDatabase::InitNewDB() {</span>
<a href="#l12.2039"></a><span id="l12.2039">   nsresult err = NS_OK;</span>
<a href="#l12.2040"></a><span id="l12.2040"> </span>
<a href="#l12.2041"></a><span id="l12.2041">   err = InitMDBInfo();</span>
<a href="#l12.2042"></a><span id="l12.2042" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l12.2043"></a><span id="l12.2043" class="difflineminus">-  {</span>
<a href="#l12.2044"></a><span id="l12.2044" class="difflineplus">+  if (NS_SUCCEEDED(err)) {</span>
<a href="#l12.2045"></a><span id="l12.2045">     nsDBFolderInfo *dbFolderInfo = new nsDBFolderInfo(this);</span>
<a href="#l12.2046"></a><span id="l12.2046" class="difflineminus">-    if (dbFolderInfo)</span>
<a href="#l12.2047"></a><span id="l12.2047" class="difflineminus">-    {</span>
<a href="#l12.2048"></a><span id="l12.2048" class="difflineplus">+    if (dbFolderInfo) {</span>
<a href="#l12.2049"></a><span id="l12.2049">       err = dbFolderInfo-&gt;AddToNewMDB();</span>
<a href="#l12.2050"></a><span id="l12.2050">       dbFolderInfo-&gt;SetVersion(GetCurVersion());</span>
<a href="#l12.2051"></a><span id="l12.2051">       dbFolderInfo-&gt;SetBooleanProperty(&quot;forceReparse&quot;, false);</span>
<a href="#l12.2052"></a><span id="l12.2052">       dbFolderInfo-&gt;SetBooleanProperty(kFixedBadRefThreadingProp, true);</span>
<a href="#l12.2053"></a><span id="l12.2053">       nsIMdbStore *store = GetStore();</span>
<a href="#l12.2054"></a><span id="l12.2054">       // create the unique table for the dbFolderInfo.</span>
<a href="#l12.2055"></a><span id="l12.2055">       struct mdbOid allMsgHdrsTableOID;</span>
<a href="#l12.2056"></a><span id="l12.2056">       struct mdbOid allThreadsTableOID;</span>
<a href="#l12.2057"></a><span id="l12.2057" class="difflineminus">-      if (!store)</span>
<a href="#l12.2058"></a><span id="l12.2058" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.2059"></a><span id="l12.2059" class="difflineplus">+      if (!store) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.2060"></a><span id="l12.2060"> </span>
<a href="#l12.2061"></a><span id="l12.2061">       allMsgHdrsTableOID.mOid_Scope = m_hdrRowScopeToken;</span>
<a href="#l12.2062"></a><span id="l12.2062">       allMsgHdrsTableOID.mOid_Id = kAllMsgHdrsTableKey;</span>
<a href="#l12.2063"></a><span id="l12.2063">       allThreadsTableOID.mOid_Scope = m_threadRowScopeToken;</span>
<a href="#l12.2064"></a><span id="l12.2064">       allThreadsTableOID.mOid_Id = kAllThreadsTableKey;</span>
<a href="#l12.2065"></a><span id="l12.2065"> </span>
<a href="#l12.2066"></a><span id="l12.2066">       // TODO: check this error value?</span>
<a href="#l12.2067"></a><span id="l12.2067" class="difflineminus">-      (void) store-&gt;NewTableWithOid(GetEnv(), &amp;allMsgHdrsTableOID, m_hdrTableKindToken,</span>
<a href="#l12.2068"></a><span id="l12.2068" class="difflineminus">-        false, nullptr, &amp;m_mdbAllMsgHeadersTable);</span>
<a href="#l12.2069"></a><span id="l12.2069" class="difflineplus">+      (void)store-&gt;NewTableWithOid(GetEnv(), &amp;allMsgHdrsTableOID,</span>
<a href="#l12.2070"></a><span id="l12.2070" class="difflineplus">+                                   m_hdrTableKindToken, false, nullptr,</span>
<a href="#l12.2071"></a><span id="l12.2071" class="difflineplus">+                                   &amp;m_mdbAllMsgHeadersTable);</span>
<a href="#l12.2072"></a><span id="l12.2072"> </span>
<a href="#l12.2073"></a><span id="l12.2073">       // error here is not fatal.</span>
<a href="#l12.2074"></a><span id="l12.2074" class="difflineminus">-      (void) store-&gt;NewTableWithOid(GetEnv(), &amp;allThreadsTableOID, m_allThreadsTableKindToken,</span>
<a href="#l12.2075"></a><span id="l12.2075" class="difflineminus">-        false, nullptr, &amp;m_mdbAllThreadsTable);</span>
<a href="#l12.2076"></a><span id="l12.2076" class="difflineplus">+      (void)store-&gt;NewTableWithOid(GetEnv(), &amp;allThreadsTableOID,</span>
<a href="#l12.2077"></a><span id="l12.2077" class="difflineplus">+                                   m_allThreadsTableKindToken, false, nullptr,</span>
<a href="#l12.2078"></a><span id="l12.2078" class="difflineplus">+                                   &amp;m_mdbAllThreadsTable);</span>
<a href="#l12.2079"></a><span id="l12.2079"> </span>
<a href="#l12.2080"></a><span id="l12.2080">       m_dbFolderInfo = dbFolderInfo;</span>
<a href="#l12.2081"></a><span id="l12.2081"> </span>
<a href="#l12.2082"></a><span id="l12.2082" class="difflineminus">-    }</span>
<a href="#l12.2083"></a><span id="l12.2083" class="difflineminus">-    else</span>
<a href="#l12.2084"></a><span id="l12.2084" class="difflineplus">+    } else</span>
<a href="#l12.2085"></a><span id="l12.2085">       err = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.2086"></a><span id="l12.2086">   }</span>
<a href="#l12.2087"></a><span id="l12.2087">   return err;</span>
<a href="#l12.2088"></a><span id="l12.2088"> }</span>
<a href="#l12.2089"></a><span id="l12.2089"> </span>
<a href="#l12.2090"></a><span id="l12.2090" class="difflineminus">-nsresult nsMsgDatabase::GetTableCreateIfMissing(const char *scope, const char *kind, nsIMdbTable **table,</span>
<a href="#l12.2091"></a><span id="l12.2091" class="difflineminus">-                                                mdb_token &amp;scopeToken, mdb_token &amp;kindToken)</span>
<a href="#l12.2092"></a><span id="l12.2092" class="difflineminus">-{</span>
<a href="#l12.2093"></a><span id="l12.2093" class="difflineplus">+nsresult nsMsgDatabase::GetTableCreateIfMissing(const char *scope,</span>
<a href="#l12.2094"></a><span id="l12.2094" class="difflineplus">+                                                const char *kind,</span>
<a href="#l12.2095"></a><span id="l12.2095" class="difflineplus">+                                                nsIMdbTable **table,</span>
<a href="#l12.2096"></a><span id="l12.2096" class="difflineplus">+                                                mdb_token &amp;scopeToken,</span>
<a href="#l12.2097"></a><span id="l12.2097" class="difflineplus">+                                                mdb_token &amp;kindToken) {</span>
<a href="#l12.2098"></a><span id="l12.2098">   struct mdbOid tableOID;</span>
<a href="#l12.2099"></a><span id="l12.2099"> </span>
<a href="#l12.2100"></a><span id="l12.2100" class="difflineminus">-  if (!m_mdbStore)</span>
<a href="#l12.2101"></a><span id="l12.2101" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l12.2102"></a><span id="l12.2102" class="difflineminus">-  (void) m_mdbStore-&gt;StringToToken(GetEnv(), scope, &amp;scopeToken);</span>
<a href="#l12.2103"></a><span id="l12.2103" class="difflineminus">-  (void) m_mdbStore-&gt;StringToToken(GetEnv(), kind, &amp;kindToken);</span>
<a href="#l12.2104"></a><span id="l12.2104" class="difflineplus">+  if (!m_mdbStore) return NS_ERROR_FAILURE;</span>
<a href="#l12.2105"></a><span id="l12.2105" class="difflineplus">+  (void)m_mdbStore-&gt;StringToToken(GetEnv(), scope, &amp;scopeToken);</span>
<a href="#l12.2106"></a><span id="l12.2106" class="difflineplus">+  (void)m_mdbStore-&gt;StringToToken(GetEnv(), kind, &amp;kindToken);</span>
<a href="#l12.2107"></a><span id="l12.2107">   tableOID.mOid_Scope = scopeToken;</span>
<a href="#l12.2108"></a><span id="l12.2108">   tableOID.mOid_Id = 1;</span>
<a href="#l12.2109"></a><span id="l12.2109"> </span>
<a href="#l12.2110"></a><span id="l12.2110">   nsresult rv = m_mdbStore-&gt;GetTable(GetEnv(), &amp;tableOID, table);</span>
<a href="#l12.2111"></a><span id="l12.2111">   NS_ENSURE_SUCCESS(rv, NS_ERROR_FAILURE);</span>
<a href="#l12.2112"></a><span id="l12.2112"> </span>
<a href="#l12.2113"></a><span id="l12.2113">   // create new all all offline ops table, if it doesn't exist.</span>
<a href="#l12.2114"></a><span id="l12.2114" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !*table)</span>
<a href="#l12.2115"></a><span id="l12.2115" class="difflineminus">-  {</span>
<a href="#l12.2116"></a><span id="l12.2116" class="difflineminus">-    rv = m_mdbStore-&gt;NewTable(GetEnv(), scopeToken,kindToken,</span>
<a href="#l12.2117"></a><span id="l12.2117" class="difflineminus">-                              false, nullptr, table);</span>
<a href="#l12.2118"></a><span id="l12.2118" class="difflineminus">-    if (NS_FAILED(rv) || !*table)</span>
<a href="#l12.2119"></a><span id="l12.2119" class="difflineminus">-      rv = NS_ERROR_FAILURE;</span>
<a href="#l12.2120"></a><span id="l12.2120" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !*table) {</span>
<a href="#l12.2121"></a><span id="l12.2121" class="difflineplus">+    rv = m_mdbStore-&gt;NewTable(GetEnv(), scopeToken, kindToken, false, nullptr,</span>
<a href="#l12.2122"></a><span id="l12.2122" class="difflineplus">+                              table);</span>
<a href="#l12.2123"></a><span id="l12.2123" class="difflineplus">+    if (NS_FAILED(rv) || !*table) rv = NS_ERROR_FAILURE;</span>
<a href="#l12.2124"></a><span id="l12.2124">   }</span>
<a href="#l12.2125"></a><span id="l12.2125">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;couldn't create offline ops table&quot;);</span>
<a href="#l12.2126"></a><span id="l12.2126">   return rv;</span>
<a href="#l12.2127"></a><span id="l12.2127"> }</span>
<a href="#l12.2128"></a><span id="l12.2128"> </span>
<a href="#l12.2129"></a><span id="l12.2129" class="difflineminus">-nsresult nsMsgDatabase::InitExistingDB()</span>
<a href="#l12.2130"></a><span id="l12.2130" class="difflineminus">-{</span>
<a href="#l12.2131"></a><span id="l12.2131" class="difflineplus">+nsresult nsMsgDatabase::InitExistingDB() {</span>
<a href="#l12.2132"></a><span id="l12.2132">   nsresult err = NS_OK;</span>
<a href="#l12.2133"></a><span id="l12.2133"> </span>
<a href="#l12.2134"></a><span id="l12.2134">   err = InitMDBInfo();</span>
<a href="#l12.2135"></a><span id="l12.2135" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l12.2136"></a><span id="l12.2136" class="difflineminus">-  {</span>
<a href="#l12.2137"></a><span id="l12.2137" class="difflineminus">-    err = GetStore()-&gt;GetTable(GetEnv(), &amp;gAllMsgHdrsTableOID, &amp;m_mdbAllMsgHeadersTable);</span>
<a href="#l12.2138"></a><span id="l12.2138" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l12.2139"></a><span id="l12.2139" class="difflineminus">-    {</span>
<a href="#l12.2140"></a><span id="l12.2140" class="difflineplus">+  if (NS_SUCCEEDED(err)) {</span>
<a href="#l12.2141"></a><span id="l12.2141" class="difflineplus">+    err = GetStore()-&gt;GetTable(GetEnv(), &amp;gAllMsgHdrsTableOID,</span>
<a href="#l12.2142"></a><span id="l12.2142" class="difflineplus">+                               &amp;m_mdbAllMsgHeadersTable);</span>
<a href="#l12.2143"></a><span id="l12.2143" class="difflineplus">+    if (NS_SUCCEEDED(err)) {</span>
<a href="#l12.2144"></a><span id="l12.2144">       m_dbFolderInfo = new nsDBFolderInfo(this);</span>
<a href="#l12.2145"></a><span id="l12.2145" class="difflineminus">-      if (m_dbFolderInfo)</span>
<a href="#l12.2146"></a><span id="l12.2146" class="difflineminus">-      {</span>
<a href="#l12.2147"></a><span id="l12.2147" class="difflineplus">+      if (m_dbFolderInfo) {</span>
<a href="#l12.2148"></a><span id="l12.2148">         err = m_dbFolderInfo-&gt;InitFromExistingDB();</span>
<a href="#l12.2149"></a><span id="l12.2149">       }</span>
<a href="#l12.2150"></a><span id="l12.2150" class="difflineminus">-    }</span>
<a href="#l12.2151"></a><span id="l12.2151" class="difflineminus">-    else</span>
<a href="#l12.2152"></a><span id="l12.2152" class="difflineplus">+    } else</span>
<a href="#l12.2153"></a><span id="l12.2153">       err = NS_ERROR_FAILURE;</span>
<a href="#l12.2154"></a><span id="l12.2154"> </span>
<a href="#l12.2155"></a><span id="l12.2155">     NS_ASSERTION(NS_SUCCEEDED(err), &quot;failed initing existing db&quot;);</span>
<a href="#l12.2156"></a><span id="l12.2156">     NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l12.2157"></a><span id="l12.2157">     // create new all msg hdrs table, if it doesn't exist.</span>
<a href="#l12.2158"></a><span id="l12.2158" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; !m_mdbAllMsgHeadersTable)</span>
<a href="#l12.2159"></a><span id="l12.2159" class="difflineminus">-    {</span>
<a href="#l12.2160"></a><span id="l12.2160" class="difflineplus">+    if (NS_SUCCEEDED(err) &amp;&amp; !m_mdbAllMsgHeadersTable) {</span>
<a href="#l12.2161"></a><span id="l12.2161">       struct mdbOid allMsgHdrsTableOID;</span>
<a href="#l12.2162"></a><span id="l12.2162">       allMsgHdrsTableOID.mOid_Scope = m_hdrRowScopeToken;</span>
<a href="#l12.2163"></a><span id="l12.2163">       allMsgHdrsTableOID.mOid_Id = kAllMsgHdrsTableKey;</span>
<a href="#l12.2164"></a><span id="l12.2164"> </span>
<a href="#l12.2165"></a><span id="l12.2165" class="difflineminus">-      nsresult mdberr = GetStore()-&gt;NewTableWithOid(GetEnv(), &amp;allMsgHdrsTableOID, m_hdrTableKindToken,</span>
<a href="#l12.2166"></a><span id="l12.2166" class="difflineminus">-        false, nullptr, &amp;m_mdbAllMsgHeadersTable);</span>
<a href="#l12.2167"></a><span id="l12.2167" class="difflineminus">-      if (NS_FAILED(mdberr) || !m_mdbAllMsgHeadersTable)</span>
<a href="#l12.2168"></a><span id="l12.2168" class="difflineminus">-        err = NS_ERROR_FAILURE;</span>
<a href="#l12.2169"></a><span id="l12.2169" class="difflineplus">+      nsresult mdberr = GetStore()-&gt;NewTableWithOid(</span>
<a href="#l12.2170"></a><span id="l12.2170" class="difflineplus">+          GetEnv(), &amp;allMsgHdrsTableOID, m_hdrTableKindToken, false, nullptr,</span>
<a href="#l12.2171"></a><span id="l12.2171" class="difflineplus">+          &amp;m_mdbAllMsgHeadersTable);</span>
<a href="#l12.2172"></a><span id="l12.2172" class="difflineplus">+      if (NS_FAILED(mdberr) || !m_mdbAllMsgHeadersTable) err = NS_ERROR_FAILURE;</span>
<a href="#l12.2173"></a><span id="l12.2173">     }</span>
<a href="#l12.2174"></a><span id="l12.2174">     struct mdbOid allThreadsTableOID;</span>
<a href="#l12.2175"></a><span id="l12.2175">     allThreadsTableOID.mOid_Scope = m_threadRowScopeToken;</span>
<a href="#l12.2176"></a><span id="l12.2176">     allThreadsTableOID.mOid_Id = kAllThreadsTableKey;</span>
<a href="#l12.2177"></a><span id="l12.2177" class="difflineminus">-    err = GetStore()-&gt;GetTable(GetEnv(), &amp;gAllThreadsTableOID, &amp;m_mdbAllThreadsTable);</span>
<a href="#l12.2178"></a><span id="l12.2178" class="difflineminus">-    if (!m_mdbAllThreadsTable)</span>
<a href="#l12.2179"></a><span id="l12.2179" class="difflineminus">-    {</span>
<a href="#l12.2180"></a><span id="l12.2180" class="difflineminus">-</span>
<a href="#l12.2181"></a><span id="l12.2181" class="difflineminus">-      nsresult mdberr = GetStore()-&gt;NewTableWithOid(GetEnv(), &amp;allThreadsTableOID, m_allThreadsTableKindToken,</span>
<a href="#l12.2182"></a><span id="l12.2182" class="difflineminus">-        false, nullptr, &amp;m_mdbAllThreadsTable);</span>
<a href="#l12.2183"></a><span id="l12.2183" class="difflineminus">-      if (NS_FAILED(mdberr) || !m_mdbAllThreadsTable)</span>
<a href="#l12.2184"></a><span id="l12.2184" class="difflineminus">-        err = NS_ERROR_FAILURE;</span>
<a href="#l12.2185"></a><span id="l12.2185" class="difflineplus">+    err = GetStore()-&gt;GetTable(GetEnv(), &amp;gAllThreadsTableOID,</span>
<a href="#l12.2186"></a><span id="l12.2186" class="difflineplus">+                               &amp;m_mdbAllThreadsTable);</span>
<a href="#l12.2187"></a><span id="l12.2187" class="difflineplus">+    if (!m_mdbAllThreadsTable) {</span>
<a href="#l12.2188"></a><span id="l12.2188" class="difflineplus">+      nsresult mdberr = GetStore()-&gt;NewTableWithOid(</span>
<a href="#l12.2189"></a><span id="l12.2189" class="difflineplus">+          GetEnv(), &amp;allThreadsTableOID, m_allThreadsTableKindToken, false,</span>
<a href="#l12.2190"></a><span id="l12.2190" class="difflineplus">+          nullptr, &amp;m_mdbAllThreadsTable);</span>
<a href="#l12.2191"></a><span id="l12.2191" class="difflineplus">+      if (NS_FAILED(mdberr) || !m_mdbAllThreadsTable) err = NS_ERROR_FAILURE;</span>
<a href="#l12.2192"></a><span id="l12.2192">     }</span>
<a href="#l12.2193"></a><span id="l12.2193">   }</span>
<a href="#l12.2194"></a><span id="l12.2194" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; m_dbFolderInfo)</span>
<a href="#l12.2195"></a><span id="l12.2195" class="difflineminus">-  {</span>
<a href="#l12.2196"></a><span id="l12.2196" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; m_dbFolderInfo) {</span>
<a href="#l12.2197"></a><span id="l12.2197">     bool fixedBadRefThreading;</span>
<a href="#l12.2198"></a><span id="l12.2198" class="difflineminus">-    m_dbFolderInfo-&gt;GetBooleanProperty(kFixedBadRefThreadingProp, false, &amp;fixedBadRefThreading);</span>
<a href="#l12.2199"></a><span id="l12.2199" class="difflineminus">-    if (!fixedBadRefThreading)</span>
<a href="#l12.2200"></a><span id="l12.2200" class="difflineminus">-    {</span>
<a href="#l12.2201"></a><span id="l12.2201" class="difflineminus">-      nsCOMPtr &lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l12.2202"></a><span id="l12.2202" class="difflineplus">+    m_dbFolderInfo-&gt;GetBooleanProperty(kFixedBadRefThreadingProp, false,</span>
<a href="#l12.2203"></a><span id="l12.2203" class="difflineplus">+                                       &amp;fixedBadRefThreading);</span>
<a href="#l12.2204"></a><span id="l12.2204" class="difflineplus">+    if (!fixedBadRefThreading) {</span>
<a href="#l12.2205"></a><span id="l12.2205" class="difflineplus">+      nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l12.2206"></a><span id="l12.2206">       err = EnumerateMessages(getter_AddRefs(enumerator));</span>
<a href="#l12.2207"></a><span id="l12.2207" class="difflineminus">-      if (NS_SUCCEEDED(err) &amp;&amp; enumerator)</span>
<a href="#l12.2208"></a><span id="l12.2208" class="difflineminus">-      {</span>
<a href="#l12.2209"></a><span id="l12.2209" class="difflineplus">+      if (NS_SUCCEEDED(err) &amp;&amp; enumerator) {</span>
<a href="#l12.2210"></a><span id="l12.2210">         bool hasMore;</span>
<a href="#l12.2211"></a><span id="l12.2211"> </span>
<a href="#l12.2212"></a><span id="l12.2212">         while (NS_SUCCEEDED(err = enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l12.2213"></a><span id="l12.2213" class="difflineminus">-               hasMore)</span>
<a href="#l12.2214"></a><span id="l12.2214" class="difflineminus">-        {</span>
<a href="#l12.2215"></a><span id="l12.2215" class="difflineminus">-          nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l12.2216"></a><span id="l12.2216" class="difflineplus">+               hasMore) {</span>
<a href="#l12.2217"></a><span id="l12.2217" class="difflineplus">+          nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l12.2218"></a><span id="l12.2218">           err = enumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l12.2219"></a><span id="l12.2219">           NS_ASSERTION(NS_SUCCEEDED(err), &quot;nsMsgDBEnumerator broken&quot;);</span>
<a href="#l12.2220"></a><span id="l12.2220" class="difflineminus">-          nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr = do_QueryInterface(supports);</span>
<a href="#l12.2221"></a><span id="l12.2221" class="difflineminus">-          if (msgHdr &amp;&amp; NS_SUCCEEDED(err))</span>
<a href="#l12.2222"></a><span id="l12.2222" class="difflineminus">-          {</span>
<a href="#l12.2223"></a><span id="l12.2223" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryInterface(supports);</span>
<a href="#l12.2224"></a><span id="l12.2224" class="difflineplus">+          if (msgHdr &amp;&amp; NS_SUCCEEDED(err)) {</span>
<a href="#l12.2225"></a><span id="l12.2225">             nsCString messageId;</span>
<a href="#l12.2226"></a><span id="l12.2226">             nsAutoCString firstReference;</span>
<a href="#l12.2227"></a><span id="l12.2227">             msgHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l12.2228"></a><span id="l12.2228">             msgHdr-&gt;GetStringReference(0, firstReference);</span>
<a href="#l12.2229"></a><span id="l12.2229" class="difflineminus">-            if (messageId.Equals(firstReference))</span>
<a href="#l12.2230"></a><span id="l12.2230" class="difflineminus">-            {</span>
<a href="#l12.2231"></a><span id="l12.2231" class="difflineplus">+            if (messageId.Equals(firstReference)) {</span>
<a href="#l12.2232"></a><span id="l12.2232">               err = NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l12.2233"></a><span id="l12.2233">               break;</span>
<a href="#l12.2234"></a><span id="l12.2234">             }</span>
<a href="#l12.2235"></a><span id="l12.2235">           }</span>
<a href="#l12.2236"></a><span id="l12.2236">         }</span>
<a href="#l12.2237"></a><span id="l12.2237">       }</span>
<a href="#l12.2238"></a><span id="l12.2238"> </span>
<a href="#l12.2239"></a><span id="l12.2239">       m_dbFolderInfo-&gt;SetBooleanProperty(kFixedBadRefThreadingProp, true);</span>
<a href="#l12.2240"></a><span id="l12.2240">     }</span>
<a href="#l12.2241"></a><span id="l12.2241" class="difflineminus">-</span>
<a href="#l12.2242"></a><span id="l12.2242">   }</span>
<a href="#l12.2243"></a><span id="l12.2243">   return err;</span>
<a href="#l12.2244"></a><span id="l12.2244"> }</span>
<a href="#l12.2245"></a><span id="l12.2245"> </span>
<a href="#l12.2246"></a><span id="l12.2246"> // initialize the various tokens and tables in our db's env</span>
<a href="#l12.2247"></a><span id="l12.2247" class="difflineminus">-nsresult nsMsgDatabase::InitMDBInfo()</span>
<a href="#l12.2248"></a><span id="l12.2248" class="difflineminus">-{</span>
<a href="#l12.2249"></a><span id="l12.2249" class="difflineplus">+nsresult nsMsgDatabase::InitMDBInfo() {</span>
<a href="#l12.2250"></a><span id="l12.2250">   nsresult err = NS_OK;</span>
<a href="#l12.2251"></a><span id="l12.2251"> </span>
<a href="#l12.2252"></a><span id="l12.2252" class="difflineminus">-  if (!m_mdbTokensInitialized &amp;&amp; GetStore())</span>
<a href="#l12.2253"></a><span id="l12.2253" class="difflineminus">-  {</span>
<a href="#l12.2254"></a><span id="l12.2254" class="difflineplus">+  if (!m_mdbTokensInitialized &amp;&amp; GetStore()) {</span>
<a href="#l12.2255"></a><span id="l12.2255">     m_mdbTokensInitialized = true;</span>
<a href="#l12.2256"></a><span id="l12.2256" class="difflineminus">-    err  = GetStore()-&gt;StringToToken(GetEnv(), kMsgHdrsScope, &amp;m_hdrRowScopeToken);</span>
<a href="#l12.2257"></a><span id="l12.2257" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l12.2258"></a><span id="l12.2258" class="difflineminus">-    {</span>
<a href="#l12.2259"></a><span id="l12.2259" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kSubjectColumnName, &amp;m_subjectColumnToken);</span>
<a href="#l12.2260"></a><span id="l12.2260" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kSenderColumnName, &amp;m_senderColumnToken);</span>
<a href="#l12.2261"></a><span id="l12.2261" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kMessageIdColumnName, &amp;m_messageIdColumnToken);</span>
<a href="#l12.2262"></a><span id="l12.2262" class="difflineminus">-      // if we just store references as a string, we won't get any savings from the</span>
<a href="#l12.2263"></a><span id="l12.2263" class="difflineminus">-      // fact there's a lot of duplication. So we may want to break them up into</span>
<a href="#l12.2264"></a><span id="l12.2264" class="difflineminus">-      // multiple columns, r1, r2, etc.</span>
<a href="#l12.2265"></a><span id="l12.2265" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kReferencesColumnName, &amp;m_referencesColumnToken);</span>
<a href="#l12.2266"></a><span id="l12.2266" class="difflineplus">+    err =</span>
<a href="#l12.2267"></a><span id="l12.2267" class="difflineplus">+        GetStore()-&gt;StringToToken(GetEnv(), kMsgHdrsScope, &amp;m_hdrRowScopeToken);</span>
<a href="#l12.2268"></a><span id="l12.2268" class="difflineplus">+    if (NS_SUCCEEDED(err)) {</span>
<a href="#l12.2269"></a><span id="l12.2269" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kSubjectColumnName,</span>
<a href="#l12.2270"></a><span id="l12.2270" class="difflineplus">+                                &amp;m_subjectColumnToken);</span>
<a href="#l12.2271"></a><span id="l12.2271" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kSenderColumnName,</span>
<a href="#l12.2272"></a><span id="l12.2272" class="difflineplus">+                                &amp;m_senderColumnToken);</span>
<a href="#l12.2273"></a><span id="l12.2273" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kMessageIdColumnName,</span>
<a href="#l12.2274"></a><span id="l12.2274" class="difflineplus">+                                &amp;m_messageIdColumnToken);</span>
<a href="#l12.2275"></a><span id="l12.2275" class="difflineplus">+      // if we just store references as a string, we won't get any savings from</span>
<a href="#l12.2276"></a><span id="l12.2276" class="difflineplus">+      // the fact there's a lot of duplication. So we may want to break them up</span>
<a href="#l12.2277"></a><span id="l12.2277" class="difflineplus">+      // into multiple columns, r1, r2, etc.</span>
<a href="#l12.2278"></a><span id="l12.2278" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kReferencesColumnName,</span>
<a href="#l12.2279"></a><span id="l12.2279" class="difflineplus">+                                &amp;m_referencesColumnToken);</span>
<a href="#l12.2280"></a><span id="l12.2280">       // similarly, recipients could be tokenized properties</span>
<a href="#l12.2281"></a><span id="l12.2281" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kRecipientsColumnName, &amp;m_recipientsColumnToken);</span>
<a href="#l12.2282"></a><span id="l12.2282" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kDateColumnName, &amp;m_dateColumnToken);</span>
<a href="#l12.2283"></a><span id="l12.2283" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kMessageSizeColumnName, &amp;m_messageSizeColumnToken);</span>
<a href="#l12.2284"></a><span id="l12.2284" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kFlagsColumnName, &amp;m_flagsColumnToken);</span>
<a href="#l12.2285"></a><span id="l12.2285" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kPriorityColumnName, &amp;m_priorityColumnToken);</span>
<a href="#l12.2286"></a><span id="l12.2286" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kLabelColumnName, &amp;m_labelColumnToken);</span>
<a href="#l12.2287"></a><span id="l12.2287" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kStatusOffsetColumnName, &amp;m_statusOffsetColumnToken);</span>
<a href="#l12.2288"></a><span id="l12.2288" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kNumLinesColumnName, &amp;m_numLinesColumnToken);</span>
<a href="#l12.2289"></a><span id="l12.2289" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kCCListColumnName, &amp;m_ccListColumnToken);</span>
<a href="#l12.2290"></a><span id="l12.2290" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kBCCListColumnName, &amp;m_bccListColumnToken);</span>
<a href="#l12.2291"></a><span id="l12.2291" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kMessageThreadIdColumnName, &amp;m_messageThreadIdColumnToken);</span>
<a href="#l12.2292"></a><span id="l12.2292" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kThreadIdColumnName, &amp;m_threadIdColumnToken);</span>
<a href="#l12.2293"></a><span id="l12.2293" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kThreadFlagsColumnName, &amp;m_threadFlagsColumnToken);</span>
<a href="#l12.2294"></a><span id="l12.2294" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kThreadNewestMsgDateColumnName, &amp;m_threadNewestMsgDateColumnToken);</span>
<a href="#l12.2295"></a><span id="l12.2295" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kThreadChildrenColumnName, &amp;m_threadChildrenColumnToken);</span>
<a href="#l12.2296"></a><span id="l12.2296" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kThreadUnreadChildrenColumnName, &amp;m_threadUnreadChildrenColumnToken);</span>
<a href="#l12.2297"></a><span id="l12.2297" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kThreadSubjectColumnName, &amp;m_threadSubjectColumnToken);</span>
<a href="#l12.2298"></a><span id="l12.2298" class="difflineminus">-      GetStore()-&gt;StringToToken(GetEnv(),  kMessageCharSetColumnName, &amp;m_messageCharSetColumnToken);</span>
<a href="#l12.2299"></a><span id="l12.2299" class="difflineminus">-      err = GetStore()-&gt;StringToToken(GetEnv(), kMsgHdrsTableKind, &amp;m_hdrTableKindToken);</span>
<a href="#l12.2300"></a><span id="l12.2300" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kRecipientsColumnName,</span>
<a href="#l12.2301"></a><span id="l12.2301" class="difflineplus">+                                &amp;m_recipientsColumnToken);</span>
<a href="#l12.2302"></a><span id="l12.2302" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kDateColumnName, &amp;m_dateColumnToken);</span>
<a href="#l12.2303"></a><span id="l12.2303" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kMessageSizeColumnName,</span>
<a href="#l12.2304"></a><span id="l12.2304" class="difflineplus">+                                &amp;m_messageSizeColumnToken);</span>
<a href="#l12.2305"></a><span id="l12.2305" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kFlagsColumnName,</span>
<a href="#l12.2306"></a><span id="l12.2306" class="difflineplus">+                                &amp;m_flagsColumnToken);</span>
<a href="#l12.2307"></a><span id="l12.2307" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kPriorityColumnName,</span>
<a href="#l12.2308"></a><span id="l12.2308" class="difflineplus">+                                &amp;m_priorityColumnToken);</span>
<a href="#l12.2309"></a><span id="l12.2309" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kLabelColumnName,</span>
<a href="#l12.2310"></a><span id="l12.2310" class="difflineplus">+                                &amp;m_labelColumnToken);</span>
<a href="#l12.2311"></a><span id="l12.2311" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kStatusOffsetColumnName,</span>
<a href="#l12.2312"></a><span id="l12.2312" class="difflineplus">+                                &amp;m_statusOffsetColumnToken);</span>
<a href="#l12.2313"></a><span id="l12.2313" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kNumLinesColumnName,</span>
<a href="#l12.2314"></a><span id="l12.2314" class="difflineplus">+                                &amp;m_numLinesColumnToken);</span>
<a href="#l12.2315"></a><span id="l12.2315" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kCCListColumnName,</span>
<a href="#l12.2316"></a><span id="l12.2316" class="difflineplus">+                                &amp;m_ccListColumnToken);</span>
<a href="#l12.2317"></a><span id="l12.2317" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kBCCListColumnName,</span>
<a href="#l12.2318"></a><span id="l12.2318" class="difflineplus">+                                &amp;m_bccListColumnToken);</span>
<a href="#l12.2319"></a><span id="l12.2319" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kMessageThreadIdColumnName,</span>
<a href="#l12.2320"></a><span id="l12.2320" class="difflineplus">+                                &amp;m_messageThreadIdColumnToken);</span>
<a href="#l12.2321"></a><span id="l12.2321" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kThreadIdColumnName,</span>
<a href="#l12.2322"></a><span id="l12.2322" class="difflineplus">+                                &amp;m_threadIdColumnToken);</span>
<a href="#l12.2323"></a><span id="l12.2323" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kThreadFlagsColumnName,</span>
<a href="#l12.2324"></a><span id="l12.2324" class="difflineplus">+                                &amp;m_threadFlagsColumnToken);</span>
<a href="#l12.2325"></a><span id="l12.2325" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kThreadNewestMsgDateColumnName,</span>
<a href="#l12.2326"></a><span id="l12.2326" class="difflineplus">+                                &amp;m_threadNewestMsgDateColumnToken);</span>
<a href="#l12.2327"></a><span id="l12.2327" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kThreadChildrenColumnName,</span>
<a href="#l12.2328"></a><span id="l12.2328" class="difflineplus">+                                &amp;m_threadChildrenColumnToken);</span>
<a href="#l12.2329"></a><span id="l12.2329" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kThreadUnreadChildrenColumnName,</span>
<a href="#l12.2330"></a><span id="l12.2330" class="difflineplus">+                                &amp;m_threadUnreadChildrenColumnToken);</span>
<a href="#l12.2331"></a><span id="l12.2331" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kThreadSubjectColumnName,</span>
<a href="#l12.2332"></a><span id="l12.2332" class="difflineplus">+                                &amp;m_threadSubjectColumnToken);</span>
<a href="#l12.2333"></a><span id="l12.2333" class="difflineplus">+      GetStore()-&gt;StringToToken(GetEnv(), kMessageCharSetColumnName,</span>
<a href="#l12.2334"></a><span id="l12.2334" class="difflineplus">+                                &amp;m_messageCharSetColumnToken);</span>
<a href="#l12.2335"></a><span id="l12.2335" class="difflineplus">+      err = GetStore()-&gt;StringToToken(GetEnv(), kMsgHdrsTableKind,</span>
<a href="#l12.2336"></a><span id="l12.2336" class="difflineplus">+                                      &amp;m_hdrTableKindToken);</span>
<a href="#l12.2337"></a><span id="l12.2337">       if (NS_SUCCEEDED(err))</span>
<a href="#l12.2338"></a><span id="l12.2338" class="difflineminus">-        err = GetStore()-&gt;StringToToken(GetEnv(), kThreadTableKind, &amp;m_threadTableKindToken);</span>
<a href="#l12.2339"></a><span id="l12.2339" class="difflineminus">-      err = GetStore()-&gt;StringToToken(GetEnv(), kAllThreadsTableKind, &amp;m_allThreadsTableKindToken);</span>
<a href="#l12.2340"></a><span id="l12.2340" class="difflineminus">-      err  = GetStore()-&gt;StringToToken(GetEnv(), kThreadHdrsScope, &amp;m_threadRowScopeToken);</span>
<a href="#l12.2341"></a><span id="l12.2341" class="difflineminus">-      err  = GetStore()-&gt;StringToToken(GetEnv(), kThreadParentColumnName, &amp;m_threadParentColumnToken);</span>
<a href="#l12.2342"></a><span id="l12.2342" class="difflineminus">-      err  = GetStore()-&gt;StringToToken(GetEnv(), kThreadRootColumnName, &amp;m_threadRootKeyColumnToken);</span>
<a href="#l12.2343"></a><span id="l12.2343" class="difflineminus">-      err = GetStore()-&gt;StringToToken(GetEnv(), kOfflineMsgOffsetColumnName, &amp;m_offlineMsgOffsetColumnToken);</span>
<a href="#l12.2344"></a><span id="l12.2344" class="difflineminus">-      err = GetStore()-&gt;StringToToken(GetEnv(), kOfflineMsgSizeColumnName, &amp;m_offlineMessageSizeColumnToken);</span>
<a href="#l12.2345"></a><span id="l12.2345" class="difflineminus">-</span>
<a href="#l12.2346"></a><span id="l12.2346" class="difflineminus">-      if (NS_SUCCEEDED(err))</span>
<a href="#l12.2347"></a><span id="l12.2347" class="difflineminus">-      {</span>
<a href="#l12.2348"></a><span id="l12.2348" class="difflineplus">+        err = GetStore()-&gt;StringToToken(GetEnv(), kThreadTableKind,</span>
<a href="#l12.2349"></a><span id="l12.2349" class="difflineplus">+                                        &amp;m_threadTableKindToken);</span>
<a href="#l12.2350"></a><span id="l12.2350" class="difflineplus">+      err = GetStore()-&gt;StringToToken(GetEnv(), kAllThreadsTableKind,</span>
<a href="#l12.2351"></a><span id="l12.2351" class="difflineplus">+                                      &amp;m_allThreadsTableKindToken);</span>
<a href="#l12.2352"></a><span id="l12.2352" class="difflineplus">+      err = GetStore()-&gt;StringToToken(GetEnv(), kThreadHdrsScope,</span>
<a href="#l12.2353"></a><span id="l12.2353" class="difflineplus">+                                      &amp;m_threadRowScopeToken);</span>
<a href="#l12.2354"></a><span id="l12.2354" class="difflineplus">+      err = GetStore()-&gt;StringToToken(GetEnv(), kThreadParentColumnName,</span>
<a href="#l12.2355"></a><span id="l12.2355" class="difflineplus">+                                      &amp;m_threadParentColumnToken);</span>
<a href="#l12.2356"></a><span id="l12.2356" class="difflineplus">+      err = GetStore()-&gt;StringToToken(GetEnv(), kThreadRootColumnName,</span>
<a href="#l12.2357"></a><span id="l12.2357" class="difflineplus">+                                      &amp;m_threadRootKeyColumnToken);</span>
<a href="#l12.2358"></a><span id="l12.2358" class="difflineplus">+      err = GetStore()-&gt;StringToToken(GetEnv(), kOfflineMsgOffsetColumnName,</span>
<a href="#l12.2359"></a><span id="l12.2359" class="difflineplus">+                                      &amp;m_offlineMsgOffsetColumnToken);</span>
<a href="#l12.2360"></a><span id="l12.2360" class="difflineplus">+      err = GetStore()-&gt;StringToToken(GetEnv(), kOfflineMsgSizeColumnName,</span>
<a href="#l12.2361"></a><span id="l12.2361" class="difflineplus">+                                      &amp;m_offlineMessageSizeColumnToken);</span>
<a href="#l12.2362"></a><span id="l12.2362" class="difflineplus">+</span>
<a href="#l12.2363"></a><span id="l12.2363" class="difflineplus">+      if (NS_SUCCEEDED(err)) {</span>
<a href="#l12.2364"></a><span id="l12.2364">         // The table of all message hdrs will have table id 1.</span>
<a href="#l12.2365"></a><span id="l12.2365">         gAllMsgHdrsTableOID.mOid_Scope = m_hdrRowScopeToken;</span>
<a href="#l12.2366"></a><span id="l12.2366">         gAllMsgHdrsTableOID.mOid_Id = kAllMsgHdrsTableKey;</span>
<a href="#l12.2367"></a><span id="l12.2367">         gAllThreadsTableOID.mOid_Scope = m_threadRowScopeToken;</span>
<a href="#l12.2368"></a><span id="l12.2368">         gAllThreadsTableOID.mOid_Id = kAllThreadsTableKey;</span>
<a href="#l12.2369"></a><span id="l12.2369" class="difflineminus">-</span>
<a href="#l12.2370"></a><span id="l12.2370">       }</span>
<a href="#l12.2371"></a><span id="l12.2371">     }</span>
<a href="#l12.2372"></a><span id="l12.2372">   }</span>
<a href="#l12.2373"></a><span id="l12.2373">   return err;</span>
<a href="#l12.2374"></a><span id="l12.2374"> }</span>
<a href="#l12.2375"></a><span id="l12.2375"> </span>
<a href="#l12.2376"></a><span id="l12.2376"> // Returns if the db contains this key</span>
<a href="#l12.2377"></a><span id="l12.2377" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::ContainsKey(nsMsgKey key, bool *containsKey)</span>
<a href="#l12.2378"></a><span id="l12.2378" class="difflineminus">-{</span>
<a href="#l12.2379"></a><span id="l12.2379" class="difflineminus">-</span>
<a href="#l12.2380"></a><span id="l12.2380" class="difflineminus">-  nsresult  err = NS_OK;</span>
<a href="#l12.2381"></a><span id="l12.2381" class="difflineminus">-  mdb_bool  hasOid;</span>
<a href="#l12.2382"></a><span id="l12.2382" class="difflineminus">-  mdbOid    rowObjectId;</span>
<a href="#l12.2383"></a><span id="l12.2383" class="difflineminus">-</span>
<a href="#l12.2384"></a><span id="l12.2384" class="difflineminus">-  if (!containsKey || !m_mdbAllMsgHeadersTable)</span>
<a href="#l12.2385"></a><span id="l12.2385" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.2386"></a><span id="l12.2386" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::ContainsKey(nsMsgKey key, bool *containsKey) {</span>
<a href="#l12.2387"></a><span id="l12.2387" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l12.2388"></a><span id="l12.2388" class="difflineplus">+  mdb_bool hasOid;</span>
<a href="#l12.2389"></a><span id="l12.2389" class="difflineplus">+  mdbOid rowObjectId;</span>
<a href="#l12.2390"></a><span id="l12.2390" class="difflineplus">+</span>
<a href="#l12.2391"></a><span id="l12.2391" class="difflineplus">+  if (!containsKey || !m_mdbAllMsgHeadersTable) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.2392"></a><span id="l12.2392">   *containsKey = false;</span>
<a href="#l12.2393"></a><span id="l12.2393"> </span>
<a href="#l12.2394"></a><span id="l12.2394">   rowObjectId.mOid_Id = key;</span>
<a href="#l12.2395"></a><span id="l12.2395">   rowObjectId.mOid_Scope = m_hdrRowScopeToken;</span>
<a href="#l12.2396"></a><span id="l12.2396">   err = m_mdbAllMsgHeadersTable-&gt;HasOid(GetEnv(), &amp;rowObjectId, &amp;hasOid);</span>
<a href="#l12.2397"></a><span id="l12.2397" class="difflineminus">-  if(NS_SUCCEEDED(err))</span>
<a href="#l12.2398"></a><span id="l12.2398" class="difflineminus">-    *containsKey = hasOid;</span>
<a href="#l12.2399"></a><span id="l12.2399" class="difflineplus">+  if (NS_SUCCEEDED(err)) *containsKey = hasOid;</span>
<a href="#l12.2400"></a><span id="l12.2400"> </span>
<a href="#l12.2401"></a><span id="l12.2401">   return err;</span>
<a href="#l12.2402"></a><span id="l12.2402"> }</span>
<a href="#l12.2403"></a><span id="l12.2403"> </span>
<a href="#l12.2404"></a><span id="l12.2404"> // get a message header for the given key. Caller must release()!</span>
<a href="#l12.2405"></a><span id="l12.2405" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetMsgHdrForKey(nsMsgKey key, nsIMsgDBHdr **pmsgHdr)</span>
<a href="#l12.2406"></a><span id="l12.2406" class="difflineminus">-{</span>
<a href="#l12.2407"></a><span id="l12.2407" class="difflineminus">-  nsresult  err = NS_OK;</span>
<a href="#l12.2408"></a><span id="l12.2408" class="difflineminus">-  mdb_bool  hasOid;</span>
<a href="#l12.2409"></a><span id="l12.2409" class="difflineminus">-  mdbOid    rowObjectId;</span>
<a href="#l12.2410"></a><span id="l12.2410" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetMsgHdrForKey(nsMsgKey key,</span>
<a href="#l12.2411"></a><span id="l12.2411" class="difflineplus">+                                             nsIMsgDBHdr **pmsgHdr) {</span>
<a href="#l12.2412"></a><span id="l12.2412" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l12.2413"></a><span id="l12.2413" class="difflineplus">+  mdb_bool hasOid;</span>
<a href="#l12.2414"></a><span id="l12.2414" class="difflineplus">+  mdbOid rowObjectId;</span>
<a href="#l12.2415"></a><span id="l12.2415"> </span>
<a href="#l12.2416"></a><span id="l12.2416">   // Because this may be called a lot, and we don't want gettimeofday() to show</span>
<a href="#l12.2417"></a><span id="l12.2417">   // up in trace logs, we just remember the most recent time any db was used,</span>
<a href="#l12.2418"></a><span id="l12.2418">   // which should be close enough for our purposes.</span>
<a href="#l12.2419"></a><span id="l12.2419">   m_lastUseTime = gLastUseTime;</span>
<a href="#l12.2420"></a><span id="l12.2420"> </span>
<a href="#l12.2421"></a><span id="l12.2421"> #ifdef DEBUG_bienvenu1</span>
<a href="#l12.2422"></a><span id="l12.2422">   NS_ASSERTION(m_folder, &quot;folder should be set&quot;);</span>
<a href="#l12.2423"></a><span id="l12.2423"> #endif</span>
<a href="#l12.2424"></a><span id="l12.2424"> </span>
<a href="#l12.2425"></a><span id="l12.2425">   if (!pmsgHdr || !m_mdbAllMsgHeadersTable || !m_mdbStore)</span>
<a href="#l12.2426"></a><span id="l12.2426">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.2427"></a><span id="l12.2427"> </span>
<a href="#l12.2428"></a><span id="l12.2428">   *pmsgHdr = NULL;</span>
<a href="#l12.2429"></a><span id="l12.2429">   err = GetHdrFromUseCache(key, pmsgHdr);</span>
<a href="#l12.2430"></a><span id="l12.2430" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; *pmsgHdr)</span>
<a href="#l12.2431"></a><span id="l12.2431" class="difflineminus">-    return err;</span>
<a href="#l12.2432"></a><span id="l12.2432" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; *pmsgHdr) return err;</span>
<a href="#l12.2433"></a><span id="l12.2433"> </span>
<a href="#l12.2434"></a><span id="l12.2434">   rowObjectId.mOid_Id = key;</span>
<a href="#l12.2435"></a><span id="l12.2435">   rowObjectId.mOid_Scope = m_hdrRowScopeToken;</span>
<a href="#l12.2436"></a><span id="l12.2436">   err = m_mdbAllMsgHeadersTable-&gt;HasOid(GetEnv(), &amp;rowObjectId, &amp;hasOid);</span>
<a href="#l12.2437"></a><span id="l12.2437" class="difflineminus">-  if (NS_SUCCEEDED(err) /* &amp;&amp; hasOid */)</span>
<a href="#l12.2438"></a><span id="l12.2438" class="difflineminus">-  {</span>
<a href="#l12.2439"></a><span id="l12.2439" class="difflineplus">+  if (NS_SUCCEEDED(err) /* &amp;&amp; hasOid */) {</span>
<a href="#l12.2440"></a><span id="l12.2440">     nsIMdbRow *hdrRow;</span>
<a href="#l12.2441"></a><span id="l12.2441">     err = m_mdbStore-&gt;GetRow(GetEnv(), &amp;rowObjectId, &amp;hdrRow);</span>
<a href="#l12.2442"></a><span id="l12.2442"> </span>
<a href="#l12.2443"></a><span id="l12.2443" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l12.2444"></a><span id="l12.2444" class="difflineminus">-    {</span>
<a href="#l12.2445"></a><span id="l12.2445" class="difflineminus">-      if (!hdrRow)</span>
<a href="#l12.2446"></a><span id="l12.2446" class="difflineminus">-      {</span>
<a href="#l12.2447"></a><span id="l12.2447" class="difflineplus">+    if (NS_SUCCEEDED(err)) {</span>
<a href="#l12.2448"></a><span id="l12.2448" class="difflineplus">+      if (!hdrRow) {</span>
<a href="#l12.2449"></a><span id="l12.2449">         err = NS_ERROR_NULL_POINTER;</span>
<a href="#l12.2450"></a><span id="l12.2450" class="difflineminus">-      }</span>
<a href="#l12.2451"></a><span id="l12.2451" class="difflineminus">-      else</span>
<a href="#l12.2452"></a><span id="l12.2452" class="difflineminus">-      {</span>
<a href="#l12.2453"></a><span id="l12.2453" class="difflineplus">+      } else {</span>
<a href="#l12.2454"></a><span id="l12.2454">         //        NS_ASSERTION(hasOid, &quot;we had oid, right?&quot;);</span>
<a href="#l12.2455"></a><span id="l12.2455" class="difflineminus">-        err = CreateMsgHdr(hdrRow,  key, pmsgHdr);</span>
<a href="#l12.2456"></a><span id="l12.2456" class="difflineplus">+        err = CreateMsgHdr(hdrRow, key, pmsgHdr);</span>
<a href="#l12.2457"></a><span id="l12.2457">       }</span>
<a href="#l12.2458"></a><span id="l12.2458">     }</span>
<a href="#l12.2459"></a><span id="l12.2459">   }</span>
<a href="#l12.2460"></a><span id="l12.2460"> </span>
<a href="#l12.2461"></a><span id="l12.2461">   return err;</span>
<a href="#l12.2462"></a><span id="l12.2462"> }</span>
<a href="#l12.2463"></a><span id="l12.2463"> </span>
<a href="#l12.2464"></a><span id="l12.2464" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::DeleteMessage(nsMsgKey key, nsIDBChangeListener *instigator, bool commit)</span>
<a href="#l12.2465"></a><span id="l12.2465" class="difflineminus">-{</span>
<a href="#l12.2466"></a><span id="l12.2466" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.2467"></a><span id="l12.2467" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::DeleteMessage(nsMsgKey key,</span>
<a href="#l12.2468"></a><span id="l12.2468" class="difflineplus">+                                           nsIDBChangeListener *instigator,</span>
<a href="#l12.2469"></a><span id="l12.2469" class="difflineplus">+                                           bool commit) {</span>
<a href="#l12.2470"></a><span id="l12.2470" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.2471"></a><span id="l12.2471"> </span>
<a href="#l12.2472"></a><span id="l12.2472">   nsresult rv = GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l12.2473"></a><span id="l12.2473" class="difflineminus">-  if (!msgHdr)</span>
<a href="#l12.2474"></a><span id="l12.2474" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l12.2475"></a><span id="l12.2475" class="difflineplus">+  if (!msgHdr) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l12.2476"></a><span id="l12.2476"> </span>
<a href="#l12.2477"></a><span id="l12.2477">   rv = DeleteHeader(msgHdr, instigator, commit, true);</span>
<a href="#l12.2478"></a><span id="l12.2478">   return rv;</span>
<a href="#l12.2479"></a><span id="l12.2479"> }</span>
<a href="#l12.2480"></a><span id="l12.2480"> </span>
<a href="#l12.2481"></a><span id="l12.2481" class="difflineminus">-</span>
<a href="#l12.2482"></a><span id="l12.2482" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::DeleteMessages(uint32_t aNumKeys, nsMsgKey* nsMsgKeys, nsIDBChangeListener *instigator)</span>
<a href="#l12.2483"></a><span id="l12.2483" class="difflineminus">-{</span>
<a href="#l12.2484"></a><span id="l12.2484" class="difflineminus">-  nsresult  err = NS_OK;</span>
<a href="#l12.2485"></a><span id="l12.2485" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::DeleteMessages(uint32_t aNumKeys,</span>
<a href="#l12.2486"></a><span id="l12.2486" class="difflineplus">+                                            nsMsgKey *nsMsgKeys,</span>
<a href="#l12.2487"></a><span id="l12.2487" class="difflineplus">+                                            nsIDBChangeListener *instigator) {</span>
<a href="#l12.2488"></a><span id="l12.2488" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l12.2489"></a><span id="l12.2489"> </span>
<a href="#l12.2490"></a><span id="l12.2490">   uint32_t kindex;</span>
<a href="#l12.2491"></a><span id="l12.2491" class="difflineminus">-  for (kindex = 0; kindex &lt; aNumKeys; kindex++)</span>
<a href="#l12.2492"></a><span id="l12.2492" class="difflineminus">-  {</span>
<a href="#l12.2493"></a><span id="l12.2493" class="difflineplus">+  for (kindex = 0; kindex &lt; aNumKeys; kindex++) {</span>
<a href="#l12.2494"></a><span id="l12.2494">     nsMsgKey key = nsMsgKeys[kindex];</span>
<a href="#l12.2495"></a><span id="l12.2495" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.2496"></a><span id="l12.2496" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.2497"></a><span id="l12.2497"> </span>
<a href="#l12.2498"></a><span id="l12.2498">     bool hasKey;</span>
<a href="#l12.2499"></a><span id="l12.2499"> </span>
<a href="#l12.2500"></a><span id="l12.2500" class="difflineminus">-    if (NS_SUCCEEDED(ContainsKey(key, &amp;hasKey)) &amp;&amp; hasKey)</span>
<a href="#l12.2501"></a><span id="l12.2501" class="difflineminus">-    {</span>
<a href="#l12.2502"></a><span id="l12.2502" class="difflineplus">+    if (NS_SUCCEEDED(ContainsKey(key, &amp;hasKey)) &amp;&amp; hasKey) {</span>
<a href="#l12.2503"></a><span id="l12.2503">       err = GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l12.2504"></a><span id="l12.2504" class="difflineminus">-      if (NS_FAILED(err))</span>
<a href="#l12.2505"></a><span id="l12.2505" class="difflineminus">-      {</span>
<a href="#l12.2506"></a><span id="l12.2506" class="difflineplus">+      if (NS_FAILED(err)) {</span>
<a href="#l12.2507"></a><span id="l12.2507">         err = NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l12.2508"></a><span id="l12.2508">         break;</span>
<a href="#l12.2509"></a><span id="l12.2509">       }</span>
<a href="#l12.2510"></a><span id="l12.2510">       if (msgHdr)</span>
<a href="#l12.2511"></a><span id="l12.2511">         err = DeleteHeader(msgHdr, instigator, kindex % 300 == 0, true);</span>
<a href="#l12.2512"></a><span id="l12.2512" class="difflineminus">-      if (NS_FAILED(err))</span>
<a href="#l12.2513"></a><span id="l12.2513" class="difflineminus">-        break;</span>
<a href="#l12.2514"></a><span id="l12.2514" class="difflineplus">+      if (NS_FAILED(err)) break;</span>
<a href="#l12.2515"></a><span id="l12.2515">     }</span>
<a href="#l12.2516"></a><span id="l12.2516">   }</span>
<a href="#l12.2517"></a><span id="l12.2517">   return err;</span>
<a href="#l12.2518"></a><span id="l12.2518"> }</span>
<a href="#l12.2519"></a><span id="l12.2519"> </span>
<a href="#l12.2520"></a><span id="l12.2520" class="difflineminus">-nsresult nsMsgDatabase::AdjustExpungedBytesOnDelete(nsIMsgDBHdr *msgHdr)</span>
<a href="#l12.2521"></a><span id="l12.2521" class="difflineminus">-{</span>
<a href="#l12.2522"></a><span id="l12.2522" class="difflineplus">+nsresult nsMsgDatabase::AdjustExpungedBytesOnDelete(nsIMsgDBHdr *msgHdr) {</span>
<a href="#l12.2523"></a><span id="l12.2523">   uint32_t size = 0;</span>
<a href="#l12.2524"></a><span id="l12.2524">   (void)msgHdr-&gt;GetMessageSize(&amp;size);</span>
<a href="#l12.2525"></a><span id="l12.2525" class="difflineminus">-  return m_dbFolderInfo-&gt;ChangeExpungedBytes (size);</span>
<a href="#l12.2526"></a><span id="l12.2526" class="difflineminus">-}</span>
<a href="#l12.2527"></a><span id="l12.2527" class="difflineminus">-</span>
<a href="#l12.2528"></a><span id="l12.2528" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::DeleteHeader(nsIMsgDBHdr *msg, nsIDBChangeListener *instigator, bool commit, bool notify)</span>
<a href="#l12.2529"></a><span id="l12.2529" class="difflineminus">-{</span>
<a href="#l12.2530"></a><span id="l12.2530" class="difflineminus">-  if (!msg)</span>
<a href="#l12.2531"></a><span id="l12.2531" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.2532"></a><span id="l12.2532" class="difflineminus">-</span>
<a href="#l12.2533"></a><span id="l12.2533" class="difflineminus">-  nsMsgHdr* msgHdr = static_cast&lt;nsMsgHdr*&gt;(msg);  // closed system, so this is ok</span>
<a href="#l12.2534"></a><span id="l12.2534" class="difflineplus">+  return m_dbFolderInfo-&gt;ChangeExpungedBytes(size);</span>
<a href="#l12.2535"></a><span id="l12.2535" class="difflineplus">+}</span>
<a href="#l12.2536"></a><span id="l12.2536" class="difflineplus">+</span>
<a href="#l12.2537"></a><span id="l12.2537" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::DeleteHeader(nsIMsgDBHdr *msg,</span>
<a href="#l12.2538"></a><span id="l12.2538" class="difflineplus">+                                          nsIDBChangeListener *instigator,</span>
<a href="#l12.2539"></a><span id="l12.2539" class="difflineplus">+                                          bool commit, bool notify) {</span>
<a href="#l12.2540"></a><span id="l12.2540" class="difflineplus">+  if (!msg) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.2541"></a><span id="l12.2541" class="difflineplus">+</span>
<a href="#l12.2542"></a><span id="l12.2542" class="difflineplus">+  nsMsgHdr *msgHdr =</span>
<a href="#l12.2543"></a><span id="l12.2543" class="difflineplus">+      static_cast&lt;nsMsgHdr *&gt;(msg);  // closed system, so this is ok</span>
<a href="#l12.2544"></a><span id="l12.2544">   nsMsgKey key;</span>
<a href="#l12.2545"></a><span id="l12.2545">   (void)msg-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.2546"></a><span id="l12.2546">   // only need to do this for mail - will this speed up news expiration?</span>
<a href="#l12.2547"></a><span id="l12.2547">   SetHdrFlag(msg, true, nsMsgMessageFlags::Expunged);  // tell mailbox (mail)</span>
<a href="#l12.2548"></a><span id="l12.2548"> </span>
<a href="#l12.2549"></a><span id="l12.2549">   bool hdrWasNew = m_newSet.BinaryIndexOf(key) != m_newSet.NoIndex;</span>
<a href="#l12.2550"></a><span id="l12.2550">   m_newSet.RemoveElement(key);</span>
<a href="#l12.2551"></a><span id="l12.2551"> </span>
<a href="#l12.2552"></a><span id="l12.2552" class="difflineminus">-  if (m_dbFolderInfo)</span>
<a href="#l12.2553"></a><span id="l12.2553" class="difflineminus">-  {</span>
<a href="#l12.2554"></a><span id="l12.2554" class="difflineplus">+  if (m_dbFolderInfo) {</span>
<a href="#l12.2555"></a><span id="l12.2555">     bool isRead;</span>
<a href="#l12.2556"></a><span id="l12.2556">     m_dbFolderInfo-&gt;ChangeNumMessages(-1);</span>
<a href="#l12.2557"></a><span id="l12.2557">     IsRead(key, &amp;isRead);</span>
<a href="#l12.2558"></a><span id="l12.2558" class="difflineminus">-    if (!isRead)</span>
<a href="#l12.2559"></a><span id="l12.2559" class="difflineminus">-      m_dbFolderInfo-&gt;ChangeNumUnreadMessages(-1);</span>
<a href="#l12.2560"></a><span id="l12.2560" class="difflineplus">+    if (!isRead) m_dbFolderInfo-&gt;ChangeNumUnreadMessages(-1);</span>
<a href="#l12.2561"></a><span id="l12.2561">     AdjustExpungedBytesOnDelete(msg);</span>
<a href="#l12.2562"></a><span id="l12.2562">   }</span>
<a href="#l12.2563"></a><span id="l12.2563"> </span>
<a href="#l12.2564"></a><span id="l12.2564">   uint32_t flags;</span>
<a href="#l12.2565"></a><span id="l12.2565">   nsMsgKey threadParent;</span>
<a href="#l12.2566"></a><span id="l12.2566"> </span>
<a href="#l12.2567"></a><span id="l12.2567" class="difflineminus">-  //Save off flags and threadparent since they will no longer exist after we remove the header from the db.</span>
<a href="#l12.2568"></a><span id="l12.2568" class="difflineminus">-  if (notify)</span>
<a href="#l12.2569"></a><span id="l12.2569" class="difflineminus">-  {</span>
<a href="#l12.2570"></a><span id="l12.2570" class="difflineplus">+  // Save off flags and threadparent since they will no longer exist after we</span>
<a href="#l12.2571"></a><span id="l12.2571" class="difflineplus">+  // remove the header from the db.</span>
<a href="#l12.2572"></a><span id="l12.2572" class="difflineplus">+  if (notify) {</span>
<a href="#l12.2573"></a><span id="l12.2573">     (void)msg-&gt;GetFlags(&amp;flags);</span>
<a href="#l12.2574"></a><span id="l12.2574">     msg-&gt;GetThreadParent(&amp;threadParent);</span>
<a href="#l12.2575"></a><span id="l12.2575">   }</span>
<a href="#l12.2576"></a><span id="l12.2576"> </span>
<a href="#l12.2577"></a><span id="l12.2577">   RemoveHeaderFromThread(msgHdr);</span>
<a href="#l12.2578"></a><span id="l12.2578" class="difflineminus">-  if (notify)</span>
<a href="#l12.2579"></a><span id="l12.2579" class="difflineminus">-  {</span>
<a href="#l12.2580"></a><span id="l12.2580" class="difflineplus">+  if (notify) {</span>
<a href="#l12.2581"></a><span id="l12.2581">     // If deleted hdr was new, restore the new flag on flags</span>
<a href="#l12.2582"></a><span id="l12.2582">     // so saved searches will know to reduce their new msg count.</span>
<a href="#l12.2583"></a><span id="l12.2583" class="difflineminus">-    if (hdrWasNew)</span>
<a href="#l12.2584"></a><span id="l12.2584" class="difflineminus">-      flags |= nsMsgMessageFlags::New;</span>
<a href="#l12.2585"></a><span id="l12.2585" class="difflineminus">-    NotifyHdrDeletedAll(msg, threadParent, flags, instigator); // tell listeners</span>
<a href="#l12.2586"></a><span id="l12.2586" class="difflineplus">+    if (hdrWasNew) flags |= nsMsgMessageFlags::New;</span>
<a href="#l12.2587"></a><span id="l12.2587" class="difflineplus">+    NotifyHdrDeletedAll(msg, threadParent, flags,</span>
<a href="#l12.2588"></a><span id="l12.2588" class="difflineplus">+                        instigator);  // tell listeners</span>
<a href="#l12.2589"></a><span id="l12.2589">   }</span>
<a href="#l12.2590"></a><span id="l12.2590" class="difflineminus">-  //  if (!onlyRemoveFromThread)  // to speed up expiration, try this. But really need to do this in RemoveHeaderFromDB</span>
<a href="#l12.2591"></a><span id="l12.2591" class="difflineplus">+  //  if (!onlyRemoveFromThread)  // to speed up expiration, try this. But</span>
<a href="#l12.2592"></a><span id="l12.2592" class="difflineplus">+  //  really need to do this in RemoveHeaderFromDB</span>
<a href="#l12.2593"></a><span id="l12.2593">   nsresult ret = RemoveHeaderFromDB(msgHdr);</span>
<a href="#l12.2594"></a><span id="l12.2594"> </span>
<a href="#l12.2595"></a><span id="l12.2595" class="difflineminus">-</span>
<a href="#l12.2596"></a><span id="l12.2596">   if (commit)</span>
<a href="#l12.2597"></a><span id="l12.2597" class="difflineminus">-    Commit(nsMsgDBCommitType::kLargeCommit);      // ### dmb is this a good time to commit?</span>
<a href="#l12.2598"></a><span id="l12.2598" class="difflineplus">+    Commit(nsMsgDBCommitType::kLargeCommit);  // ### dmb is this a good time to</span>
<a href="#l12.2599"></a><span id="l12.2599" class="difflineplus">+                                              // commit?</span>
<a href="#l12.2600"></a><span id="l12.2600">   return ret;</span>
<a href="#l12.2601"></a><span id="l12.2601"> }</span>
<a href="#l12.2602"></a><span id="l12.2602"> </span>
<a href="#l12.2603"></a><span id="l12.2603"> NS_IMETHODIMP</span>
<a href="#l12.2604"></a><span id="l12.2604" class="difflineminus">-nsMsgDatabase::UndoDelete(nsIMsgDBHdr *aMsgHdr)</span>
<a href="#l12.2605"></a><span id="l12.2605" class="difflineminus">-{</span>
<a href="#l12.2606"></a><span id="l12.2606" class="difflineminus">-  if (aMsgHdr)</span>
<a href="#l12.2607"></a><span id="l12.2607" class="difflineminus">-  {</span>
<a href="#l12.2608"></a><span id="l12.2608" class="difflineminus">-    // Force deleted flag, so SetHdrFlag won't bail out because deleted flag isn't set.</span>
<a href="#l12.2609"></a><span id="l12.2609" class="difflineplus">+nsMsgDatabase::UndoDelete(nsIMsgDBHdr *aMsgHdr) {</span>
<a href="#l12.2610"></a><span id="l12.2610" class="difflineplus">+  if (aMsgHdr) {</span>
<a href="#l12.2611"></a><span id="l12.2611" class="difflineplus">+    // Force deleted flag, so SetHdrFlag won't bail out because deleted flag</span>
<a href="#l12.2612"></a><span id="l12.2612" class="difflineplus">+    // isn't set.</span>
<a href="#l12.2613"></a><span id="l12.2613">     uint32_t result;</span>
<a href="#l12.2614"></a><span id="l12.2614">     aMsgHdr-&gt;OrFlags(nsMsgMessageFlags::Expunged, &amp;result);</span>
<a href="#l12.2615"></a><span id="l12.2615" class="difflineminus">-    SetHdrFlag(aMsgHdr, false, nsMsgMessageFlags::Expunged);  // Clear deleted flag in db.</span>
<a href="#l12.2616"></a><span id="l12.2616" class="difflineplus">+    SetHdrFlag(aMsgHdr, false,</span>
<a href="#l12.2617"></a><span id="l12.2617" class="difflineplus">+               nsMsgMessageFlags::Expunged);  // Clear deleted flag in db.</span>
<a href="#l12.2618"></a><span id="l12.2618">   }</span>
<a href="#l12.2619"></a><span id="l12.2619">   return NS_OK;</span>
<a href="#l12.2620"></a><span id="l12.2620"> }</span>
<a href="#l12.2621"></a><span id="l12.2621"> </span>
<a href="#l12.2622"></a><span id="l12.2622" class="difflineminus">-nsresult nsMsgDatabase::RemoveHeaderFromThread(nsMsgHdr *msgHdr)</span>
<a href="#l12.2623"></a><span id="l12.2623" class="difflineminus">-{</span>
<a href="#l12.2624"></a><span id="l12.2624" class="difflineminus">-  if (!msgHdr)</span>
<a href="#l12.2625"></a><span id="l12.2625" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.2626"></a><span id="l12.2626" class="difflineplus">+nsresult nsMsgDatabase::RemoveHeaderFromThread(nsMsgHdr *msgHdr) {</span>
<a href="#l12.2627"></a><span id="l12.2627" class="difflineplus">+  if (!msgHdr) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.2628"></a><span id="l12.2628">   nsresult ret = NS_OK;</span>
<a href="#l12.2629"></a><span id="l12.2629" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; thread ;</span>
<a href="#l12.2630"></a><span id="l12.2630" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l12.2631"></a><span id="l12.2631">   ret = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(thread));</span>
<a href="#l12.2632"></a><span id="l12.2632" class="difflineminus">-  if (NS_SUCCEEDED(ret) &amp;&amp; thread)</span>
<a href="#l12.2633"></a><span id="l12.2633" class="difflineminus">-  {</span>
<a href="#l12.2634"></a><span id="l12.2634" class="difflineplus">+  if (NS_SUCCEEDED(ret) &amp;&amp; thread) {</span>
<a href="#l12.2635"></a><span id="l12.2635">     ret = thread-&gt;RemoveChildHdr(msgHdr, this);</span>
<a href="#l12.2636"></a><span id="l12.2636">   }</span>
<a href="#l12.2637"></a><span id="l12.2637">   return ret;</span>
<a href="#l12.2638"></a><span id="l12.2638"> }</span>
<a href="#l12.2639"></a><span id="l12.2639"> </span>
<a href="#l12.2640"></a><span id="l12.2640" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::RemoveHeaderMdbRow(nsIMsgDBHdr *msg)</span>
<a href="#l12.2641"></a><span id="l12.2641" class="difflineminus">-{</span>
<a href="#l12.2642"></a><span id="l12.2642" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::RemoveHeaderMdbRow(nsIMsgDBHdr *msg) {</span>
<a href="#l12.2643"></a><span id="l12.2643">   NS_ENSURE_ARG_POINTER(msg);</span>
<a href="#l12.2644"></a><span id="l12.2644" class="difflineminus">-  nsMsgHdr* msgHdr = static_cast&lt;nsMsgHdr*&gt;(msg);  // closed system, so this is ok</span>
<a href="#l12.2645"></a><span id="l12.2645" class="difflineplus">+  nsMsgHdr *msgHdr =</span>
<a href="#l12.2646"></a><span id="l12.2646" class="difflineplus">+      static_cast&lt;nsMsgHdr *&gt;(msg);  // closed system, so this is ok</span>
<a href="#l12.2647"></a><span id="l12.2647">   return RemoveHeaderFromDB(msgHdr);</span>
<a href="#l12.2648"></a><span id="l12.2648"> }</span>
<a href="#l12.2649"></a><span id="l12.2649"> </span>
<a href="#l12.2650"></a><span id="l12.2650"> // This is a lower level routine which doesn't send notifications or</span>
<a href="#l12.2651"></a><span id="l12.2651"> // update folder info. One use is when a rule fires moving a header</span>
<a href="#l12.2652"></a><span id="l12.2652"> // from one db to another, to remove it from the first db.</span>
<a href="#l12.2653"></a><span id="l12.2653"> </span>
<a href="#l12.2654"></a><span id="l12.2654" class="difflineminus">-nsresult nsMsgDatabase::RemoveHeaderFromDB(nsMsgHdr *msgHdr)</span>
<a href="#l12.2655"></a><span id="l12.2655" class="difflineminus">-{</span>
<a href="#l12.2656"></a><span id="l12.2656" class="difflineminus">-  if (!msgHdr)</span>
<a href="#l12.2657"></a><span id="l12.2657" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.2658"></a><span id="l12.2658" class="difflineplus">+nsresult nsMsgDatabase::RemoveHeaderFromDB(nsMsgHdr *msgHdr) {</span>
<a href="#l12.2659"></a><span id="l12.2659" class="difflineplus">+  if (!msgHdr) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.2660"></a><span id="l12.2660">   nsresult ret = NS_OK;</span>
<a href="#l12.2661"></a><span id="l12.2661"> </span>
<a href="#l12.2662"></a><span id="l12.2662">   RemoveHdrFromCache(msgHdr, nsMsgKey_None);</span>
<a href="#l12.2663"></a><span id="l12.2663" class="difflineminus">-  if (UseCorrectThreading())</span>
<a href="#l12.2664"></a><span id="l12.2664" class="difflineminus">-    RemoveMsgRefsFromHash(msgHdr);</span>
<a href="#l12.2665"></a><span id="l12.2665" class="difflineminus">-  nsIMdbRow* row = msgHdr-&gt;GetMDBRow();</span>
<a href="#l12.2666"></a><span id="l12.2666" class="difflineminus">-  if (row)</span>
<a href="#l12.2667"></a><span id="l12.2667" class="difflineminus">-  {</span>
<a href="#l12.2668"></a><span id="l12.2668" class="difflineplus">+  if (UseCorrectThreading()) RemoveMsgRefsFromHash(msgHdr);</span>
<a href="#l12.2669"></a><span id="l12.2669" class="difflineplus">+  nsIMdbRow *row = msgHdr-&gt;GetMDBRow();</span>
<a href="#l12.2670"></a><span id="l12.2670" class="difflineplus">+  if (row) {</span>
<a href="#l12.2671"></a><span id="l12.2671">     ret = m_mdbAllMsgHeadersTable-&gt;CutRow(GetEnv(), row);</span>
<a href="#l12.2672"></a><span id="l12.2672">     row-&gt;CutAllColumns(GetEnv());</span>
<a href="#l12.2673"></a><span id="l12.2673">   }</span>
<a href="#l12.2674"></a><span id="l12.2674">   msgHdr-&gt;ClearCachedValues();</span>
<a href="#l12.2675"></a><span id="l12.2675">   return ret;</span>
<a href="#l12.2676"></a><span id="l12.2676"> }</span>
<a href="#l12.2677"></a><span id="l12.2677"> </span>
<a href="#l12.2678"></a><span id="l12.2678" class="difflineminus">-nsresult nsMsgDatabase::IsRead(nsMsgKey key, bool *pRead)</span>
<a href="#l12.2679"></a><span id="l12.2679" class="difflineminus">-{</span>
<a href="#l12.2680"></a><span id="l12.2680" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.2681"></a><span id="l12.2681" class="difflineplus">+nsresult nsMsgDatabase::IsRead(nsMsgKey key, bool *pRead) {</span>
<a href="#l12.2682"></a><span id="l12.2682" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.2683"></a><span id="l12.2683"> </span>
<a href="#l12.2684"></a><span id="l12.2684">   nsresult rv = GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l12.2685"></a><span id="l12.2685">   if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l12.2686"></a><span id="l12.2686" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND; // XXX return rv?</span>
<a href="#l12.2687"></a><span id="l12.2687" class="difflineplus">+    return NS_MSG_MESSAGE_NOT_FOUND;  // XXX return rv?</span>
<a href="#l12.2688"></a><span id="l12.2688">   rv = IsHeaderRead(msgHdr, pRead);</span>
<a href="#l12.2689"></a><span id="l12.2689">   return rv;</span>
<a href="#l12.2690"></a><span id="l12.2690"> }</span>
<a href="#l12.2691"></a><span id="l12.2691"> </span>
<a href="#l12.2692"></a><span id="l12.2692" class="difflineminus">-uint32_t nsMsgDatabase::GetStatusFlags(nsIMsgDBHdr *msgHdr, nsMsgMessageFlagType origFlags)</span>
<a href="#l12.2693"></a><span id="l12.2693" class="difflineminus">-{</span>
<a href="#l12.2694"></a><span id="l12.2694" class="difflineminus">-  uint32_t  statusFlags = origFlags;</span>
<a href="#l12.2695"></a><span id="l12.2695" class="difflineminus">-  bool    isRead = true;</span>
<a href="#l12.2696"></a><span id="l12.2696" class="difflineplus">+uint32_t nsMsgDatabase::GetStatusFlags(nsIMsgDBHdr *msgHdr,</span>
<a href="#l12.2697"></a><span id="l12.2697" class="difflineplus">+                                       nsMsgMessageFlagType origFlags) {</span>
<a href="#l12.2698"></a><span id="l12.2698" class="difflineplus">+  uint32_t statusFlags = origFlags;</span>
<a href="#l12.2699"></a><span id="l12.2699" class="difflineplus">+  bool isRead = true;</span>
<a href="#l12.2700"></a><span id="l12.2700"> </span>
<a href="#l12.2701"></a><span id="l12.2701">   nsMsgKey key;</span>
<a href="#l12.2702"></a><span id="l12.2702">   (void)msgHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.2703"></a><span id="l12.2703">   if ((!m_newSet.IsEmpty() &amp;&amp; m_newSet[m_newSet.Length() - 1] == key) ||</span>
<a href="#l12.2704"></a><span id="l12.2704">       (m_newSet.BinaryIndexOf(key) != m_newSet.NoIndex))</span>
<a href="#l12.2705"></a><span id="l12.2705">     statusFlags |= nsMsgMessageFlags::New;</span>
<a href="#l12.2706"></a><span id="l12.2706">   if (NS_SUCCEEDED(IsHeaderRead(msgHdr, &amp;isRead)) &amp;&amp; isRead)</span>
<a href="#l12.2707"></a><span id="l12.2707">     statusFlags |= nsMsgMessageFlags::Read;</span>
<a href="#l12.2708"></a><span id="l12.2708">   return statusFlags;</span>
<a href="#l12.2709"></a><span id="l12.2709"> }</span>
<a href="#l12.2710"></a><span id="l12.2710"> </span>
<a href="#l12.2711"></a><span id="l12.2711" class="difflineminus">-nsresult nsMsgDatabase::IsHeaderRead(nsIMsgDBHdr *msgHdr, bool *pRead)</span>
<a href="#l12.2712"></a><span id="l12.2712" class="difflineminus">-{</span>
<a href="#l12.2713"></a><span id="l12.2713" class="difflineminus">-  if (!msgHdr)</span>
<a href="#l12.2714"></a><span id="l12.2714" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l12.2715"></a><span id="l12.2715" class="difflineminus">-</span>
<a href="#l12.2716"></a><span id="l12.2716" class="difflineminus">-  nsMsgHdr* hdr = static_cast&lt;nsMsgHdr*&gt;(msgHdr);          // closed system, cast ok</span>
<a href="#l12.2717"></a><span id="l12.2717" class="difflineplus">+nsresult nsMsgDatabase::IsHeaderRead(nsIMsgDBHdr *msgHdr, bool *pRead) {</span>
<a href="#l12.2718"></a><span id="l12.2718" class="difflineplus">+  if (!msgHdr) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l12.2719"></a><span id="l12.2719" class="difflineplus">+</span>
<a href="#l12.2720"></a><span id="l12.2720" class="difflineplus">+  nsMsgHdr *hdr = static_cast&lt;nsMsgHdr *&gt;(msgHdr);  // closed system, cast ok</span>
<a href="#l12.2721"></a><span id="l12.2721">   // can't call GetFlags, because it will be recursive.</span>
<a href="#l12.2722"></a><span id="l12.2722">   uint32_t flags;</span>
<a href="#l12.2723"></a><span id="l12.2723">   hdr-&gt;GetRawFlags(&amp;flags);</span>
<a href="#l12.2724"></a><span id="l12.2724">   *pRead = !!(flags &amp; nsMsgMessageFlags::Read);</span>
<a href="#l12.2725"></a><span id="l12.2725">   return NS_OK;</span>
<a href="#l12.2726"></a><span id="l12.2726"> }</span>
<a href="#l12.2727"></a><span id="l12.2727"> </span>
<a href="#l12.2728"></a><span id="l12.2728" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::IsMarked(nsMsgKey key, bool *pMarked)</span>
<a href="#l12.2729"></a><span id="l12.2729" class="difflineminus">-{</span>
<a href="#l12.2730"></a><span id="l12.2730" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.2731"></a><span id="l12.2731" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::IsMarked(nsMsgKey key, bool *pMarked) {</span>
<a href="#l12.2732"></a><span id="l12.2732" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.2733"></a><span id="l12.2733"> </span>
<a href="#l12.2734"></a><span id="l12.2734">   nsresult rv = GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l12.2735"></a><span id="l12.2735" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.2736"></a><span id="l12.2736" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND; // XXX return rv?</span>
<a href="#l12.2737"></a><span id="l12.2737" class="difflineplus">+  if (NS_FAILED(rv)) return NS_MSG_MESSAGE_NOT_FOUND;  // XXX return rv?</span>
<a href="#l12.2738"></a><span id="l12.2738"> </span>
<a href="#l12.2739"></a><span id="l12.2739">   uint32_t flags;</span>
<a href="#l12.2740"></a><span id="l12.2740">   (void)msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l12.2741"></a><span id="l12.2741">   *pMarked = !!(flags &amp; nsMsgMessageFlags::Marked);</span>
<a href="#l12.2742"></a><span id="l12.2742">   return rv;</span>
<a href="#l12.2743"></a><span id="l12.2743"> }</span>
<a href="#l12.2744"></a><span id="l12.2744"> </span>
<a href="#l12.2745"></a><span id="l12.2745" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::IsIgnored(nsMsgKey key, bool *pIgnored)</span>
<a href="#l12.2746"></a><span id="l12.2746" class="difflineminus">-{</span>
<a href="#l12.2747"></a><span id="l12.2747" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::IsIgnored(nsMsgKey key, bool *pIgnored) {</span>
<a href="#l12.2748"></a><span id="l12.2748">   NS_ENSURE_ARG_POINTER(pIgnored);</span>
<a href="#l12.2749"></a><span id="l12.2749"> </span>
<a href="#l12.2750"></a><span id="l12.2750" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l12.2751"></a><span id="l12.2751" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l12.2752"></a><span id="l12.2752"> </span>
<a href="#l12.2753"></a><span id="l12.2753">   nsresult rv = GetThreadForMsgKey(key, getter_AddRefs(threadHdr));</span>
<a href="#l12.2754"></a><span id="l12.2754">   // This should be very surprising, but we leave that up to the caller</span>
<a href="#l12.2755"></a><span id="l12.2755">   // to determine for now.</span>
<a href="#l12.2756"></a><span id="l12.2756" class="difflineminus">-  if (!threadHdr)</span>
<a href="#l12.2757"></a><span id="l12.2757" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l12.2758"></a><span id="l12.2758" class="difflineplus">+  if (!threadHdr) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l12.2759"></a><span id="l12.2759"> </span>
<a href="#l12.2760"></a><span id="l12.2760">   uint32_t threadFlags;</span>
<a href="#l12.2761"></a><span id="l12.2761">   threadHdr-&gt;GetFlags(&amp;threadFlags);</span>
<a href="#l12.2762"></a><span id="l12.2762">   *pIgnored = !!(threadFlags &amp; nsMsgMessageFlags::Ignored);</span>
<a href="#l12.2763"></a><span id="l12.2763">   return rv;</span>
<a href="#l12.2764"></a><span id="l12.2764"> }</span>
<a href="#l12.2765"></a><span id="l12.2765"> </span>
<a href="#l12.2766"></a><span id="l12.2766" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::IsWatched(nsMsgKey key, bool *pWatched)</span>
<a href="#l12.2767"></a><span id="l12.2767" class="difflineminus">-{</span>
<a href="#l12.2768"></a><span id="l12.2768" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::IsWatched(nsMsgKey key, bool *pWatched) {</span>
<a href="#l12.2769"></a><span id="l12.2769">   NS_ENSURE_ARG_POINTER(pWatched);</span>
<a href="#l12.2770"></a><span id="l12.2770"> </span>
<a href="#l12.2771"></a><span id="l12.2771" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l12.2772"></a><span id="l12.2772" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l12.2773"></a><span id="l12.2773"> </span>
<a href="#l12.2774"></a><span id="l12.2774">   nsresult rv = GetThreadForMsgKey(key, getter_AddRefs(threadHdr));</span>
<a href="#l12.2775"></a><span id="l12.2775">   // This should be very surprising, but we leave that up to the caller</span>
<a href="#l12.2776"></a><span id="l12.2776">   // to determine for now.</span>
<a href="#l12.2777"></a><span id="l12.2777" class="difflineminus">-  if (!threadHdr)</span>
<a href="#l12.2778"></a><span id="l12.2778" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l12.2779"></a><span id="l12.2779" class="difflineplus">+  if (!threadHdr) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l12.2780"></a><span id="l12.2780"> </span>
<a href="#l12.2781"></a><span id="l12.2781">   uint32_t threadFlags;</span>
<a href="#l12.2782"></a><span id="l12.2782">   threadHdr-&gt;GetFlags(&amp;threadFlags);</span>
<a href="#l12.2783"></a><span id="l12.2783">   *pWatched = !!(threadFlags &amp; nsMsgMessageFlags::Watched);</span>
<a href="#l12.2784"></a><span id="l12.2784">   return rv;</span>
<a href="#l12.2785"></a><span id="l12.2785"> }</span>
<a href="#l12.2786"></a><span id="l12.2786"> </span>
<a href="#l12.2787"></a><span id="l12.2787" class="difflineminus">-nsresult nsMsgDatabase::HasAttachments(nsMsgKey key, bool *pHasThem)</span>
<a href="#l12.2788"></a><span id="l12.2788" class="difflineminus">-{</span>
<a href="#l12.2789"></a><span id="l12.2789" class="difflineplus">+nsresult nsMsgDatabase::HasAttachments(nsMsgKey key, bool *pHasThem) {</span>
<a href="#l12.2790"></a><span id="l12.2790">   NS_ENSURE_ARG_POINTER(pHasThem);</span>
<a href="#l12.2791"></a><span id="l12.2791"> </span>
<a href="#l12.2792"></a><span id="l12.2792" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.2793"></a><span id="l12.2793" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.2794"></a><span id="l12.2794"> </span>
<a href="#l12.2795"></a><span id="l12.2795">   nsresult rv = GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l12.2796"></a><span id="l12.2796" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.2797"></a><span id="l12.2797" class="difflineminus">-    return rv;</span>
<a href="#l12.2798"></a><span id="l12.2798" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.2799"></a><span id="l12.2799"> </span>
<a href="#l12.2800"></a><span id="l12.2800">   uint32_t flags;</span>
<a href="#l12.2801"></a><span id="l12.2801">   (void)msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l12.2802"></a><span id="l12.2802">   *pHasThem = !!(flags &amp; nsMsgMessageFlags::Attachment);</span>
<a href="#l12.2803"></a><span id="l12.2803">   return rv;</span>
<a href="#l12.2804"></a><span id="l12.2804"> }</span>
<a href="#l12.2805"></a><span id="l12.2805"> </span>
<a href="#l12.2806"></a><span id="l12.2806" class="difflineminus">-bool nsMsgDatabase::SetHdrReadFlag(nsIMsgDBHdr *msgHdr, bool bRead)</span>
<a href="#l12.2807"></a><span id="l12.2807" class="difflineminus">-{</span>
<a href="#l12.2808"></a><span id="l12.2808" class="difflineplus">+bool nsMsgDatabase::SetHdrReadFlag(nsIMsgDBHdr *msgHdr, bool bRead) {</span>
<a href="#l12.2809"></a><span id="l12.2809">   return SetHdrFlag(msgHdr, bRead, nsMsgMessageFlags::Read);</span>
<a href="#l12.2810"></a><span id="l12.2810"> }</span>
<a href="#l12.2811"></a><span id="l12.2811"> </span>
<a href="#l12.2812"></a><span id="l12.2812"> nsresult nsMsgDatabase::MarkHdrReadInDB(nsIMsgDBHdr *msgHdr, bool bRead,</span>
<a href="#l12.2813"></a><span id="l12.2813" class="difflineminus">-                                             nsIDBChangeListener *instigator)</span>
<a href="#l12.2814"></a><span id="l12.2814" class="difflineminus">-{</span>
<a href="#l12.2815"></a><span id="l12.2815" class="difflineplus">+                                        nsIDBChangeListener *instigator) {</span>
<a href="#l12.2816"></a><span id="l12.2816">   nsresult rv;</span>
<a href="#l12.2817"></a><span id="l12.2817">   nsMsgKey key;</span>
<a href="#l12.2818"></a><span id="l12.2818">   uint32_t oldFlags;</span>
<a href="#l12.2819"></a><span id="l12.2819" class="difflineminus">-  bool     hdrInDB;</span>
<a href="#l12.2820"></a><span id="l12.2820" class="difflineplus">+  bool hdrInDB;</span>
<a href="#l12.2821"></a><span id="l12.2821">   (void)msgHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.2822"></a><span id="l12.2822">   msgHdr-&gt;GetFlags(&amp;oldFlags);</span>
<a href="#l12.2823"></a><span id="l12.2823"> </span>
<a href="#l12.2824"></a><span id="l12.2824">   m_newSet.RemoveElement(key);</span>
<a href="#l12.2825"></a><span id="l12.2825" class="difflineminus">-  (void) ContainsKey(key, &amp;hdrInDB);</span>
<a href="#l12.2826"></a><span id="l12.2826" class="difflineminus">-  if (hdrInDB &amp;&amp; m_dbFolderInfo)</span>
<a href="#l12.2827"></a><span id="l12.2827" class="difflineminus">-  {</span>
<a href="#l12.2828"></a><span id="l12.2828" class="difflineplus">+  (void)ContainsKey(key, &amp;hdrInDB);</span>
<a href="#l12.2829"></a><span id="l12.2829" class="difflineplus">+  if (hdrInDB &amp;&amp; m_dbFolderInfo) {</span>
<a href="#l12.2830"></a><span id="l12.2830">     if (bRead)</span>
<a href="#l12.2831"></a><span id="l12.2831">       m_dbFolderInfo-&gt;ChangeNumUnreadMessages(-1);</span>
<a href="#l12.2832"></a><span id="l12.2832">     else</span>
<a href="#l12.2833"></a><span id="l12.2833">       m_dbFolderInfo-&gt;ChangeNumUnreadMessages(1);</span>
<a href="#l12.2834"></a><span id="l12.2834">   }</span>
<a href="#l12.2835"></a><span id="l12.2835"> </span>
<a href="#l12.2836"></a><span id="l12.2836" class="difflineminus">-  SetHdrReadFlag(msgHdr, bRead); // this will cause a commit, at least for local mail, so do it after we change</span>
<a href="#l12.2837"></a><span id="l12.2837" class="difflineplus">+  SetHdrReadFlag(msgHdr, bRead);  // this will cause a commit, at least for</span>
<a href="#l12.2838"></a><span id="l12.2838" class="difflineplus">+                                  // local mail, so do it after we change</span>
<a href="#l12.2839"></a><span id="l12.2839">   // the folder counts above, so they will get committed too.</span>
<a href="#l12.2840"></a><span id="l12.2840">   uint32_t flags;</span>
<a href="#l12.2841"></a><span id="l12.2841">   rv = msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l12.2842"></a><span id="l12.2842">   flags &amp;= ~nsMsgMessageFlags::New;</span>
<a href="#l12.2843"></a><span id="l12.2843">   msgHdr-&gt;SetFlags(flags);</span>
<a href="#l12.2844"></a><span id="l12.2844">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.2845"></a><span id="l12.2845"> </span>
<a href="#l12.2846"></a><span id="l12.2846" class="difflineminus">-  if (oldFlags == flags)</span>
<a href="#l12.2847"></a><span id="l12.2847" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.2848"></a><span id="l12.2848" class="difflineplus">+  if (oldFlags == flags) return NS_OK;</span>
<a href="#l12.2849"></a><span id="l12.2849"> </span>
<a href="#l12.2850"></a><span id="l12.2850">   return NotifyHdrChangeAll(msgHdr, oldFlags, flags, instigator);</span>
<a href="#l12.2851"></a><span id="l12.2851"> }</span>
<a href="#l12.2852"></a><span id="l12.2852"> </span>
<a href="#l12.2853"></a><span id="l12.2853"> NS_IMETHODIMP nsMsgDatabase::MarkRead(nsMsgKey key, bool bRead,</span>
<a href="#l12.2854"></a><span id="l12.2854" class="difflineminus">-                                      nsIDBChangeListener *instigator)</span>
<a href="#l12.2855"></a><span id="l12.2855" class="difflineminus">-{</span>
<a href="#l12.2856"></a><span id="l12.2856" class="difflineplus">+                                      nsIDBChangeListener *instigator) {</span>
<a href="#l12.2857"></a><span id="l12.2857">   nsresult rv;</span>
<a href="#l12.2858"></a><span id="l12.2858" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.2859"></a><span id="l12.2859" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.2860"></a><span id="l12.2860"> </span>
<a href="#l12.2861"></a><span id="l12.2861">   rv = GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l12.2862"></a><span id="l12.2862">   if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l12.2863"></a><span id="l12.2863" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND; // XXX return rv?</span>
<a href="#l12.2864"></a><span id="l12.2864" class="difflineplus">+    return NS_MSG_MESSAGE_NOT_FOUND;  // XXX return rv?</span>
<a href="#l12.2865"></a><span id="l12.2865"> </span>
<a href="#l12.2866"></a><span id="l12.2866">   rv = MarkHdrRead(msgHdr, bRead, instigator);</span>
<a href="#l12.2867"></a><span id="l12.2867">   return rv;</span>
<a href="#l12.2868"></a><span id="l12.2868"> }</span>
<a href="#l12.2869"></a><span id="l12.2869"> </span>
<a href="#l12.2870"></a><span id="l12.2870" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::MarkReplied(nsMsgKey key, bool bReplied,</span>
<a href="#l12.2871"></a><span id="l12.2871" class="difflineminus">-                                         nsIDBChangeListener *instigator /* = NULL */)</span>
<a href="#l12.2872"></a><span id="l12.2872" class="difflineminus">-{</span>
<a href="#l12.2873"></a><span id="l12.2873" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::MarkReplied(</span>
<a href="#l12.2874"></a><span id="l12.2874" class="difflineplus">+    nsMsgKey key, bool bReplied, nsIDBChangeListener *instigator /* = NULL */) {</span>
<a href="#l12.2875"></a><span id="l12.2875">   return SetKeyFlag(key, bReplied, nsMsgMessageFlags::Replied, instigator);</span>
<a href="#l12.2876"></a><span id="l12.2876"> }</span>
<a href="#l12.2877"></a><span id="l12.2877"> </span>
<a href="#l12.2878"></a><span id="l12.2878" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::MarkForwarded(nsMsgKey key, bool bForwarded,</span>
<a href="#l12.2879"></a><span id="l12.2879" class="difflineminus">-                                           nsIDBChangeListener *instigator /* = NULL */)</span>
<a href="#l12.2880"></a><span id="l12.2880" class="difflineminus">-{</span>
<a href="#l12.2881"></a><span id="l12.2881" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::MarkForwarded(</span>
<a href="#l12.2882"></a><span id="l12.2882" class="difflineplus">+    nsMsgKey key, bool bForwarded,</span>
<a href="#l12.2883"></a><span id="l12.2883" class="difflineplus">+    nsIDBChangeListener *instigator /* = NULL */) {</span>
<a href="#l12.2884"></a><span id="l12.2884">   return SetKeyFlag(key, bForwarded, nsMsgMessageFlags::Forwarded, instigator);</span>
<a href="#l12.2885"></a><span id="l12.2885"> }</span>
<a href="#l12.2886"></a><span id="l12.2886"> </span>
<a href="#l12.2887"></a><span id="l12.2887" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::MarkHasAttachments(nsMsgKey key, bool bHasAttachments,</span>
<a href="#l12.2888"></a><span id="l12.2888" class="difflineminus">-                                                nsIDBChangeListener *instigator)</span>
<a href="#l12.2889"></a><span id="l12.2889" class="difflineminus">-{</span>
<a href="#l12.2890"></a><span id="l12.2890" class="difflineminus">-  return SetKeyFlag(key, bHasAttachments, nsMsgMessageFlags::Attachment, instigator);</span>
<a href="#l12.2891"></a><span id="l12.2891" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::MarkHasAttachments(</span>
<a href="#l12.2892"></a><span id="l12.2892" class="difflineplus">+    nsMsgKey key, bool bHasAttachments, nsIDBChangeListener *instigator) {</span>
<a href="#l12.2893"></a><span id="l12.2893" class="difflineplus">+  return SetKeyFlag(key, bHasAttachments, nsMsgMessageFlags::Attachment,</span>
<a href="#l12.2894"></a><span id="l12.2894" class="difflineplus">+                    instigator);</span>
<a href="#l12.2895"></a><span id="l12.2895"> }</span>
<a href="#l12.2896"></a><span id="l12.2896"> </span>
<a href="#l12.2897"></a><span id="l12.2897"> NS_IMETHODIMP</span>
<a href="#l12.2898"></a><span id="l12.2898" class="difflineminus">-nsMsgDatabase::MarkThreadRead(nsIMsgThread *thread, nsIDBChangeListener *instigator,</span>
<a href="#l12.2899"></a><span id="l12.2899" class="difflineminus">-                              uint32_t *aNumMarked, nsMsgKey **aThoseMarked)</span>
<a href="#l12.2900"></a><span id="l12.2900" class="difflineminus">-{</span>
<a href="#l12.2901"></a><span id="l12.2901" class="difflineplus">+nsMsgDatabase::MarkThreadRead(nsIMsgThread *thread,</span>
<a href="#l12.2902"></a><span id="l12.2902" class="difflineplus">+                              nsIDBChangeListener *instigator,</span>
<a href="#l12.2903"></a><span id="l12.2903" class="difflineplus">+                              uint32_t *aNumMarked, nsMsgKey **aThoseMarked) {</span>
<a href="#l12.2904"></a><span id="l12.2904">   NS_ENSURE_ARG_POINTER(thread);</span>
<a href="#l12.2905"></a><span id="l12.2905">   NS_ENSURE_ARG_POINTER(aNumMarked);</span>
<a href="#l12.2906"></a><span id="l12.2906">   NS_ENSURE_ARG_POINTER(aThoseMarked);</span>
<a href="#l12.2907"></a><span id="l12.2907">   nsresult rv = NS_OK;</span>
<a href="#l12.2908"></a><span id="l12.2908"> </span>
<a href="#l12.2909"></a><span id="l12.2909">   uint32_t numChildren;</span>
<a href="#l12.2910"></a><span id="l12.2910">   nsTArray&lt;nsMsgKey&gt; thoseMarked;</span>
<a href="#l12.2911"></a><span id="l12.2911">   thread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l12.2912"></a><span id="l12.2912" class="difflineminus">-  for (uint32_t curChildIndex = 0; curChildIndex &lt; numChildren; curChildIndex++)</span>
<a href="#l12.2913"></a><span id="l12.2913" class="difflineminus">-  {</span>
<a href="#l12.2914"></a><span id="l12.2914" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; child;</span>
<a href="#l12.2915"></a><span id="l12.2915" class="difflineplus">+  for (uint32_t curChildIndex = 0; curChildIndex &lt; numChildren;</span>
<a href="#l12.2916"></a><span id="l12.2916" class="difflineplus">+       curChildIndex++) {</span>
<a href="#l12.2917"></a><span id="l12.2917" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; child;</span>
<a href="#l12.2918"></a><span id="l12.2918"> </span>
<a href="#l12.2919"></a><span id="l12.2919">     rv = thread-&gt;GetChildHdrAt(curChildIndex, getter_AddRefs(child));</span>
<a href="#l12.2920"></a><span id="l12.2920" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; child)</span>
<a href="#l12.2921"></a><span id="l12.2921" class="difflineminus">-    {</span>
<a href="#l12.2922"></a><span id="l12.2922" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; child) {</span>
<a href="#l12.2923"></a><span id="l12.2923">       bool isRead = true;</span>
<a href="#l12.2924"></a><span id="l12.2924">       IsHeaderRead(child, &amp;isRead);</span>
<a href="#l12.2925"></a><span id="l12.2925" class="difflineminus">-      if (!isRead)</span>
<a href="#l12.2926"></a><span id="l12.2926" class="difflineminus">-      {</span>
<a href="#l12.2927"></a><span id="l12.2927" class="difflineplus">+      if (!isRead) {</span>
<a href="#l12.2928"></a><span id="l12.2928">         nsMsgKey key;</span>
<a href="#l12.2929"></a><span id="l12.2929">         if (NS_SUCCEEDED(child-&gt;GetMessageKey(&amp;key)))</span>
<a href="#l12.2930"></a><span id="l12.2930">           thoseMarked.AppendElement(key);</span>
<a href="#l12.2931"></a><span id="l12.2931">         MarkHdrRead(child, true, instigator);</span>
<a href="#l12.2932"></a><span id="l12.2932">       }</span>
<a href="#l12.2933"></a><span id="l12.2933">     }</span>
<a href="#l12.2934"></a><span id="l12.2934">   }</span>
<a href="#l12.2935"></a><span id="l12.2935"> </span>
<a href="#l12.2936"></a><span id="l12.2936">   *aNumMarked = thoseMarked.Length();</span>
<a href="#l12.2937"></a><span id="l12.2937"> </span>
<a href="#l12.2938"></a><span id="l12.2938" class="difflineminus">-  if (thoseMarked.Length())</span>
<a href="#l12.2939"></a><span id="l12.2939" class="difflineminus">-  {</span>
<a href="#l12.2940"></a><span id="l12.2940" class="difflineminus">-    *aThoseMarked =</span>
<a href="#l12.2941"></a><span id="l12.2941" class="difflineminus">-      (nsMsgKey *) moz_xmemdup(&amp;thoseMarked[0],</span>
<a href="#l12.2942"></a><span id="l12.2942" class="difflineminus">-                               thoseMarked.Length() * sizeof(nsMsgKey));</span>
<a href="#l12.2943"></a><span id="l12.2943" class="difflineminus">-    if (!*aThoseMarked)</span>
<a href="#l12.2944"></a><span id="l12.2944" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.2945"></a><span id="l12.2945" class="difflineminus">-  }</span>
<a href="#l12.2946"></a><span id="l12.2946" class="difflineminus">-  else</span>
<a href="#l12.2947"></a><span id="l12.2947" class="difflineplus">+  if (thoseMarked.Length()) {</span>
<a href="#l12.2948"></a><span id="l12.2948" class="difflineplus">+    *aThoseMarked = (nsMsgKey *)moz_xmemdup(</span>
<a href="#l12.2949"></a><span id="l12.2949" class="difflineplus">+        &amp;thoseMarked[0], thoseMarked.Length() * sizeof(nsMsgKey));</span>
<a href="#l12.2950"></a><span id="l12.2950" class="difflineplus">+    if (!*aThoseMarked) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.2951"></a><span id="l12.2951" class="difflineplus">+  } else</span>
<a href="#l12.2952"></a><span id="l12.2952">     *aThoseMarked = nullptr;</span>
<a href="#l12.2953"></a><span id="l12.2953"> </span>
<a href="#l12.2954"></a><span id="l12.2954">   return rv;</span>
<a href="#l12.2955"></a><span id="l12.2955"> }</span>
<a href="#l12.2956"></a><span id="l12.2956"> </span>
<a href="#l12.2957"></a><span id="l12.2957"> NS_IMETHODIMP</span>
<a href="#l12.2958"></a><span id="l12.2958" class="difflineminus">-nsMsgDatabase::MarkThreadIgnored(nsIMsgThread *thread, nsMsgKey threadKey, bool bIgnored,</span>
<a href="#l12.2959"></a><span id="l12.2959" class="difflineminus">-                                 nsIDBChangeListener *instigator)</span>
<a href="#l12.2960"></a><span id="l12.2960" class="difflineminus">-{</span>
<a href="#l12.2961"></a><span id="l12.2961" class="difflineplus">+nsMsgDatabase::MarkThreadIgnored(nsIMsgThread *thread, nsMsgKey threadKey,</span>
<a href="#l12.2962"></a><span id="l12.2962" class="difflineplus">+                                 bool bIgnored,</span>
<a href="#l12.2963"></a><span id="l12.2963" class="difflineplus">+                                 nsIDBChangeListener *instigator) {</span>
<a href="#l12.2964"></a><span id="l12.2964">   NS_ENSURE_ARG(thread);</span>
<a href="#l12.2965"></a><span id="l12.2965">   uint32_t threadFlags;</span>
<a href="#l12.2966"></a><span id="l12.2966">   thread-&gt;GetFlags(&amp;threadFlags);</span>
<a href="#l12.2967"></a><span id="l12.2967" class="difflineminus">-  uint32_t oldThreadFlags = threadFlags; // not quite right, since we probably want msg hdr flags.</span>
<a href="#l12.2968"></a><span id="l12.2968" class="difflineminus">-  if (bIgnored)</span>
<a href="#l12.2969"></a><span id="l12.2969" class="difflineminus">-  {</span>
<a href="#l12.2970"></a><span id="l12.2970" class="difflineplus">+  uint32_t oldThreadFlags =</span>
<a href="#l12.2971"></a><span id="l12.2971" class="difflineplus">+      threadFlags;  // not quite right, since we probably want msg hdr flags.</span>
<a href="#l12.2972"></a><span id="l12.2972" class="difflineplus">+  if (bIgnored) {</span>
<a href="#l12.2973"></a><span id="l12.2973">     threadFlags |= nsMsgMessageFlags::Ignored;</span>
<a href="#l12.2974"></a><span id="l12.2974">     threadFlags &amp;= ~nsMsgMessageFlags::Watched;  // ignore is implicit un-watch</span>
<a href="#l12.2975"></a><span id="l12.2975" class="difflineminus">-  }</span>
<a href="#l12.2976"></a><span id="l12.2976" class="difflineminus">-  else</span>
<a href="#l12.2977"></a><span id="l12.2977" class="difflineplus">+  } else</span>
<a href="#l12.2978"></a><span id="l12.2978">     threadFlags &amp;= ~nsMsgMessageFlags::Ignored;</span>
<a href="#l12.2979"></a><span id="l12.2979">   thread-&gt;SetFlags(threadFlags);</span>
<a href="#l12.2980"></a><span id="l12.2980"> </span>
<a href="#l12.2981"></a><span id="l12.2981" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msg;</span>
<a href="#l12.2982"></a><span id="l12.2982" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msg;</span>
<a href="#l12.2983"></a><span id="l12.2983">   nsresult rv = GetMsgHdrForKey(threadKey, getter_AddRefs(msg));</span>
<a href="#l12.2984"></a><span id="l12.2984">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.2985"></a><span id="l12.2985">   return NotifyHdrChangeAll(msg, oldThreadFlags, threadFlags, instigator);</span>
<a href="#l12.2986"></a><span id="l12.2986"> }</span>
<a href="#l12.2987"></a><span id="l12.2987"> </span>
<a href="#l12.2988"></a><span id="l12.2988"> NS_IMETHODIMP</span>
<a href="#l12.2989"></a><span id="l12.2989"> nsMsgDatabase::MarkHeaderKilled(nsIMsgDBHdr *msg, bool bIgnored,</span>
<a href="#l12.2990"></a><span id="l12.2990" class="difflineminus">-                           nsIDBChangeListener *instigator)</span>
<a href="#l12.2991"></a><span id="l12.2991" class="difflineminus">-{</span>
<a href="#l12.2992"></a><span id="l12.2992" class="difflineplus">+                                nsIDBChangeListener *instigator) {</span>
<a href="#l12.2993"></a><span id="l12.2993">   uint32_t msgFlags;</span>
<a href="#l12.2994"></a><span id="l12.2994">   msg-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l12.2995"></a><span id="l12.2995">   uint32_t oldFlags = msgFlags;</span>
<a href="#l12.2996"></a><span id="l12.2996">   if (bIgnored)</span>
<a href="#l12.2997"></a><span id="l12.2997">     msgFlags |= nsMsgMessageFlags::Ignored;</span>
<a href="#l12.2998"></a><span id="l12.2998">   else</span>
<a href="#l12.2999"></a><span id="l12.2999">     msgFlags &amp;= ~nsMsgMessageFlags::Ignored;</span>
<a href="#l12.3000"></a><span id="l12.3000">   msg-&gt;SetFlags(msgFlags);</span>
<a href="#l12.3001"></a><span id="l12.3001"> </span>
<a href="#l12.3002"></a><span id="l12.3002">   return NotifyHdrChangeAll(msg, oldFlags, msgFlags, instigator);</span>
<a href="#l12.3003"></a><span id="l12.3003"> }</span>
<a href="#l12.3004"></a><span id="l12.3004"> </span>
<a href="#l12.3005"></a><span id="l12.3005"> NS_IMETHODIMP</span>
<a href="#l12.3006"></a><span id="l12.3006" class="difflineminus">-nsMsgDatabase::MarkThreadWatched(nsIMsgThread *thread, nsMsgKey threadKey, bool bWatched,</span>
<a href="#l12.3007"></a><span id="l12.3007" class="difflineminus">-                                 nsIDBChangeListener *instigator)</span>
<a href="#l12.3008"></a><span id="l12.3008" class="difflineminus">-{</span>
<a href="#l12.3009"></a><span id="l12.3009" class="difflineplus">+nsMsgDatabase::MarkThreadWatched(nsIMsgThread *thread, nsMsgKey threadKey,</span>
<a href="#l12.3010"></a><span id="l12.3010" class="difflineplus">+                                 bool bWatched,</span>
<a href="#l12.3011"></a><span id="l12.3011" class="difflineplus">+                                 nsIDBChangeListener *instigator) {</span>
<a href="#l12.3012"></a><span id="l12.3012">   NS_ENSURE_ARG(thread);</span>
<a href="#l12.3013"></a><span id="l12.3013">   uint32_t threadFlags;</span>
<a href="#l12.3014"></a><span id="l12.3014">   thread-&gt;GetFlags(&amp;threadFlags);</span>
<a href="#l12.3015"></a><span id="l12.3015" class="difflineminus">-  uint32_t oldThreadFlags = threadFlags; // not quite right, since we probably want msg hdr flags.</span>
<a href="#l12.3016"></a><span id="l12.3016" class="difflineminus">-  if (bWatched)</span>
<a href="#l12.3017"></a><span id="l12.3017" class="difflineminus">-  {</span>
<a href="#l12.3018"></a><span id="l12.3018" class="difflineplus">+  uint32_t oldThreadFlags =</span>
<a href="#l12.3019"></a><span id="l12.3019" class="difflineplus">+      threadFlags;  // not quite right, since we probably want msg hdr flags.</span>
<a href="#l12.3020"></a><span id="l12.3020" class="difflineplus">+  if (bWatched) {</span>
<a href="#l12.3021"></a><span id="l12.3021">     threadFlags |= nsMsgMessageFlags::Watched;</span>
<a href="#l12.3022"></a><span id="l12.3022">     threadFlags &amp;= ~nsMsgMessageFlags::Ignored;  // watch is implicit un-ignore</span>
<a href="#l12.3023"></a><span id="l12.3023" class="difflineminus">-  }</span>
<a href="#l12.3024"></a><span id="l12.3024" class="difflineminus">-  else</span>
<a href="#l12.3025"></a><span id="l12.3025" class="difflineplus">+  } else</span>
<a href="#l12.3026"></a><span id="l12.3026">     threadFlags &amp;= ~nsMsgMessageFlags::Watched;</span>
<a href="#l12.3027"></a><span id="l12.3027"> </span>
<a href="#l12.3028"></a><span id="l12.3028" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msg;</span>
<a href="#l12.3029"></a><span id="l12.3029" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msg;</span>
<a href="#l12.3030"></a><span id="l12.3030">   GetMsgHdrForKey(threadKey, getter_AddRefs(msg));</span>
<a href="#l12.3031"></a><span id="l12.3031"> </span>
<a href="#l12.3032"></a><span id="l12.3032" class="difflineminus">-  nsresult rv  = NotifyHdrChangeAll(msg, oldThreadFlags, threadFlags, instigator);</span>
<a href="#l12.3033"></a><span id="l12.3033" class="difflineplus">+  nsresult rv =</span>
<a href="#l12.3034"></a><span id="l12.3034" class="difflineplus">+      NotifyHdrChangeAll(msg, oldThreadFlags, threadFlags, instigator);</span>
<a href="#l12.3035"></a><span id="l12.3035">   thread-&gt;SetFlags(threadFlags);</span>
<a href="#l12.3036"></a><span id="l12.3036">   return rv;</span>
<a href="#l12.3037"></a><span id="l12.3037"> }</span>
<a href="#l12.3038"></a><span id="l12.3038"> </span>
<a href="#l12.3039"></a><span id="l12.3039"> NS_IMETHODIMP nsMsgDatabase::MarkMarked(nsMsgKey key, bool mark,</span>
<a href="#l12.3040"></a><span id="l12.3040" class="difflineminus">-                                        nsIDBChangeListener *instigator)</span>
<a href="#l12.3041"></a><span id="l12.3041" class="difflineminus">-{</span>
<a href="#l12.3042"></a><span id="l12.3042" class="difflineplus">+                                        nsIDBChangeListener *instigator) {</span>
<a href="#l12.3043"></a><span id="l12.3043">   return SetKeyFlag(key, mark, nsMsgMessageFlags::Marked, instigator);</span>
<a href="#l12.3044"></a><span id="l12.3044"> }</span>
<a href="#l12.3045"></a><span id="l12.3045"> </span>
<a href="#l12.3046"></a><span id="l12.3046"> NS_IMETHODIMP nsMsgDatabase::MarkOffline(nsMsgKey key, bool offline,</span>
<a href="#l12.3047"></a><span id="l12.3047" class="difflineminus">-                                         nsIDBChangeListener *instigator)</span>
<a href="#l12.3048"></a><span id="l12.3048" class="difflineminus">-{</span>
<a href="#l12.3049"></a><span id="l12.3049" class="difflineplus">+                                         nsIDBChangeListener *instigator) {</span>
<a href="#l12.3050"></a><span id="l12.3050">   return SetKeyFlag(key, offline, nsMsgMessageFlags::Offline, instigator);</span>
<a href="#l12.3051"></a><span id="l12.3051"> }</span>
<a href="#l12.3052"></a><span id="l12.3052"> </span>
<a href="#l12.3053"></a><span id="l12.3053" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::SetStringProperty(nsMsgKey aKey, const char *aProperty, const char *aValue)</span>
<a href="#l12.3054"></a><span id="l12.3054" class="difflineminus">-{</span>
<a href="#l12.3055"></a><span id="l12.3055" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.3056"></a><span id="l12.3056" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::SetStringProperty(nsMsgKey aKey,</span>
<a href="#l12.3057"></a><span id="l12.3057" class="difflineplus">+                                               const char *aProperty,</span>
<a href="#l12.3058"></a><span id="l12.3058" class="difflineplus">+                                               const char *aValue) {</span>
<a href="#l12.3059"></a><span id="l12.3059" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.3060"></a><span id="l12.3060">   nsresult rv = GetMsgHdrForKey(aKey, getter_AddRefs(msgHdr));</span>
<a href="#l12.3061"></a><span id="l12.3061">   if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l12.3062"></a><span id="l12.3062" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND; // XXX return rv?</span>
<a href="#l12.3063"></a><span id="l12.3063" class="difflineplus">+    return NS_MSG_MESSAGE_NOT_FOUND;  // XXX return rv?</span>
<a href="#l12.3064"></a><span id="l12.3064">   return SetStringPropertyByHdr(msgHdr, aProperty, aValue);</span>
<a href="#l12.3065"></a><span id="l12.3065"> }</span>
<a href="#l12.3066"></a><span id="l12.3066"> </span>
<a href="#l12.3067"></a><span id="l12.3067" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::SetStringPropertyByHdr(nsIMsgDBHdr *msgHdr, const char *aProperty, const char *aValue)</span>
<a href="#l12.3068"></a><span id="l12.3068" class="difflineminus">-{</span>
<a href="#l12.3069"></a><span id="l12.3069" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::SetStringPropertyByHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l12.3070"></a><span id="l12.3070" class="difflineplus">+                                                    const char *aProperty,</span>
<a href="#l12.3071"></a><span id="l12.3071" class="difflineplus">+                                                    const char *aValue) {</span>
<a href="#l12.3072"></a><span id="l12.3072">   // don't do notifications if message not yet added to database.</span>
<a href="#l12.3073"></a><span id="l12.3073">   // Ignore errors (consequences of failure are minor).</span>
<a href="#l12.3074"></a><span id="l12.3074">   bool notify = true;</span>
<a href="#l12.3075"></a><span id="l12.3075">   nsMsgKey key = nsMsgKey_None;</span>
<a href="#l12.3076"></a><span id="l12.3076">   msgHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.3077"></a><span id="l12.3077">   ContainsKey(key, &amp;notify);</span>
<a href="#l12.3078"></a><span id="l12.3078"> </span>
<a href="#l12.3079"></a><span id="l12.3079">   nsCString oldValue;</span>
<a href="#l12.3080"></a><span id="l12.3080">   nsresult rv = msgHdr-&gt;GetStringProperty(aProperty, getter_Copies(oldValue));</span>
<a href="#l12.3081"></a><span id="l12.3081" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.3082"></a><span id="l12.3082" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3083"></a><span id="l12.3083"> </span>
<a href="#l12.3084"></a><span id="l12.3084">   // if no change to this string property, bail out</span>
<a href="#l12.3085"></a><span id="l12.3085" class="difflineminus">-  if (oldValue.Equals(aValue))</span>
<a href="#l12.3086"></a><span id="l12.3086" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.3087"></a><span id="l12.3087" class="difflineplus">+  if (oldValue.Equals(aValue)) return NS_OK;</span>
<a href="#l12.3088"></a><span id="l12.3088"> </span>
<a href="#l12.3089"></a><span id="l12.3089">   // Precall OnHdrPropertyChanged to store prechange status</span>
<a href="#l12.3090"></a><span id="l12.3090">   nsTArray&lt;uint32_t&gt; statusArray(m_ChangeListeners.Length());</span>
<a href="#l12.3091"></a><span id="l12.3091">   uint32_t status;</span>
<a href="#l12.3092"></a><span id="l12.3092">   nsCOMPtr&lt;nsIDBChangeListener&gt; listener;</span>
<a href="#l12.3093"></a><span id="l12.3093" class="difflineminus">-  if (notify)</span>
<a href="#l12.3094"></a><span id="l12.3094" class="difflineminus">-  {</span>
<a href="#l12.3095"></a><span id="l12.3095" class="difflineminus">-    nsTObserverArray&lt;nsCOMPtr&lt;nsIDBChangeListener&gt; &gt;::ForwardIterator listeners(m_ChangeListeners);</span>
<a href="#l12.3096"></a><span id="l12.3096" class="difflineminus">-    while (listeners.HasMore())</span>
<a href="#l12.3097"></a><span id="l12.3097" class="difflineminus">-    {</span>
<a href="#l12.3098"></a><span id="l12.3098" class="difflineplus">+  if (notify) {</span>
<a href="#l12.3099"></a><span id="l12.3099" class="difflineplus">+    nsTObserverArray&lt;nsCOMPtr&lt;nsIDBChangeListener&gt; &gt;::ForwardIterator listeners(</span>
<a href="#l12.3100"></a><span id="l12.3100" class="difflineplus">+        m_ChangeListeners);</span>
<a href="#l12.3101"></a><span id="l12.3101" class="difflineplus">+    while (listeners.HasMore()) {</span>
<a href="#l12.3102"></a><span id="l12.3102">       listener = listeners.GetNext();</span>
<a href="#l12.3103"></a><span id="l12.3103">       listener-&gt;OnHdrPropertyChanged(msgHdr, true, &amp;status, nullptr);</span>
<a href="#l12.3104"></a><span id="l12.3104">       // ignore errors, but append element to keep arrays in sync</span>
<a href="#l12.3105"></a><span id="l12.3105">       statusArray.AppendElement(status);</span>
<a href="#l12.3106"></a><span id="l12.3106">     }</span>
<a href="#l12.3107"></a><span id="l12.3107">   }</span>
<a href="#l12.3108"></a><span id="l12.3108"> </span>
<a href="#l12.3109"></a><span id="l12.3109">   rv = msgHdr-&gt;SetStringProperty(aProperty, aValue);</span>
<a href="#l12.3110"></a><span id="l12.3110" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.3111"></a><span id="l12.3111" class="difflineminus">-</span>
<a href="#l12.3112"></a><span id="l12.3112" class="difflineminus">-  //Postcall OnHdrPropertyChanged to process the change</span>
<a href="#l12.3113"></a><span id="l12.3113" class="difflineminus">-  if (notify)</span>
<a href="#l12.3114"></a><span id="l12.3114" class="difflineminus">-  {</span>
<a href="#l12.3115"></a><span id="l12.3115" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3116"></a><span id="l12.3116" class="difflineplus">+</span>
<a href="#l12.3117"></a><span id="l12.3117" class="difflineplus">+  // Postcall OnHdrPropertyChanged to process the change</span>
<a href="#l12.3118"></a><span id="l12.3118" class="difflineplus">+  if (notify) {</span>
<a href="#l12.3119"></a><span id="l12.3119">     // if this is the junk score property notify, as long as we're not going</span>
<a href="#l12.3120"></a><span id="l12.3120">     // from no value to non junk</span>
<a href="#l12.3121"></a><span id="l12.3121" class="difflineminus">-    if (!strcmp(aProperty, &quot;junkscore&quot;) &amp;&amp; !(oldValue.IsEmpty() &amp;&amp; !strcmp(aValue, &quot;0&quot;)))</span>
<a href="#l12.3122"></a><span id="l12.3122" class="difflineplus">+    if (!strcmp(aProperty, &quot;junkscore&quot;) &amp;&amp;</span>
<a href="#l12.3123"></a><span id="l12.3123" class="difflineplus">+        !(oldValue.IsEmpty() &amp;&amp; !strcmp(aValue, &quot;0&quot;)))</span>
<a href="#l12.3124"></a><span id="l12.3124">       NotifyJunkScoreChanged(nullptr);</span>
<a href="#l12.3125"></a><span id="l12.3125"> </span>
<a href="#l12.3126"></a><span id="l12.3126" class="difflineminus">-    nsTObserverArray&lt;nsCOMPtr&lt;nsIDBChangeListener&gt; &gt;::ForwardIterator listeners(m_ChangeListeners);</span>
<a href="#l12.3127"></a><span id="l12.3127" class="difflineminus">-    for (uint32_t i = 0; listeners.HasMore(); i++)</span>
<a href="#l12.3128"></a><span id="l12.3128" class="difflineminus">-    {</span>
<a href="#l12.3129"></a><span id="l12.3129" class="difflineplus">+    nsTObserverArray&lt;nsCOMPtr&lt;nsIDBChangeListener&gt; &gt;::ForwardIterator listeners(</span>
<a href="#l12.3130"></a><span id="l12.3130" class="difflineplus">+        m_ChangeListeners);</span>
<a href="#l12.3131"></a><span id="l12.3131" class="difflineplus">+    for (uint32_t i = 0; listeners.HasMore(); i++) {</span>
<a href="#l12.3132"></a><span id="l12.3132">       listener = listeners.GetNext();</span>
<a href="#l12.3133"></a><span id="l12.3133">       status = statusArray[i];</span>
<a href="#l12.3134"></a><span id="l12.3134">       listener-&gt;OnHdrPropertyChanged(msgHdr, false, &amp;status, nullptr);</span>
<a href="#l12.3135"></a><span id="l12.3135">       // ignore errors</span>
<a href="#l12.3136"></a><span id="l12.3136">     }</span>
<a href="#l12.3137"></a><span id="l12.3137">   }</span>
<a href="#l12.3138"></a><span id="l12.3138"> </span>
<a href="#l12.3139"></a><span id="l12.3139">   return NS_OK;</span>
<a href="#l12.3140"></a><span id="l12.3140"> }</span>
<a href="#l12.3141"></a><span id="l12.3141"> </span>
<a href="#l12.3142"></a><span id="l12.3142"> NS_IMETHODIMP</span>
<a href="#l12.3143"></a><span id="l12.3143"> nsMsgDatabase::SetUint32PropertyByHdr(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l12.3144"></a><span id="l12.3144" class="difflineminus">-                                      const char *aProperty,</span>
<a href="#l12.3145"></a><span id="l12.3145" class="difflineminus">-                                      uint32_t aValue)</span>
<a href="#l12.3146"></a><span id="l12.3146" class="difflineminus">-{</span>
<a href="#l12.3147"></a><span id="l12.3147" class="difflineplus">+                                      const char *aProperty, uint32_t aValue) {</span>
<a href="#l12.3148"></a><span id="l12.3148">   // If no change to this property, bail out.</span>
<a href="#l12.3149"></a><span id="l12.3149">   uint32_t oldValue;</span>
<a href="#l12.3150"></a><span id="l12.3150">   nsresult rv = aMsgHdr-&gt;GetUint32Property(aProperty, &amp;oldValue);</span>
<a href="#l12.3151"></a><span id="l12.3151">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3152"></a><span id="l12.3152" class="difflineminus">-  if (oldValue == aValue)</span>
<a href="#l12.3153"></a><span id="l12.3153" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.3154"></a><span id="l12.3154" class="difflineplus">+  if (oldValue == aValue) return NS_OK;</span>
<a href="#l12.3155"></a><span id="l12.3155"> </span>
<a href="#l12.3156"></a><span id="l12.3156">   // Don't do notifications if message not yet added to database.</span>
<a href="#l12.3157"></a><span id="l12.3157">   bool notify = true;</span>
<a href="#l12.3158"></a><span id="l12.3158">   nsMsgKey key = nsMsgKey_None;</span>
<a href="#l12.3159"></a><span id="l12.3159">   aMsgHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.3160"></a><span id="l12.3160">   ContainsKey(key, &amp;notify);</span>
<a href="#l12.3161"></a><span id="l12.3161"> </span>
<a href="#l12.3162"></a><span id="l12.3162">   // Precall OnHdrPropertyChanged to store prechange status.</span>
<a href="#l12.3163"></a><span id="l12.3163">   nsTArray&lt;uint32_t&gt; statusArray(m_ChangeListeners.Length());</span>
<a href="#l12.3164"></a><span id="l12.3164">   uint32_t status;</span>
<a href="#l12.3165"></a><span id="l12.3165">   nsCOMPtr&lt;nsIDBChangeListener&gt; listener;</span>
<a href="#l12.3166"></a><span id="l12.3166" class="difflineminus">-  if (notify)</span>
<a href="#l12.3167"></a><span id="l12.3167" class="difflineminus">-  {</span>
<a href="#l12.3168"></a><span id="l12.3168" class="difflineminus">-    nsTObserverArray&lt;nsCOMPtr&lt;nsIDBChangeListener&gt; &gt;::ForwardIterator listeners(m_ChangeListeners);</span>
<a href="#l12.3169"></a><span id="l12.3169" class="difflineminus">-    while (listeners.HasMore())</span>
<a href="#l12.3170"></a><span id="l12.3170" class="difflineminus">-    {</span>
<a href="#l12.3171"></a><span id="l12.3171" class="difflineplus">+  if (notify) {</span>
<a href="#l12.3172"></a><span id="l12.3172" class="difflineplus">+    nsTObserverArray&lt;nsCOMPtr&lt;nsIDBChangeListener&gt; &gt;::ForwardIterator listeners(</span>
<a href="#l12.3173"></a><span id="l12.3173" class="difflineplus">+        m_ChangeListeners);</span>
<a href="#l12.3174"></a><span id="l12.3174" class="difflineplus">+    while (listeners.HasMore()) {</span>
<a href="#l12.3175"></a><span id="l12.3175">       listener = listeners.GetNext();</span>
<a href="#l12.3176"></a><span id="l12.3176">       listener-&gt;OnHdrPropertyChanged(aMsgHdr, true, &amp;status, nullptr);</span>
<a href="#l12.3177"></a><span id="l12.3177">       // Ignore errors, but append element to keep arrays in sync.</span>
<a href="#l12.3178"></a><span id="l12.3178">       statusArray.AppendElement(status);</span>
<a href="#l12.3179"></a><span id="l12.3179">     }</span>
<a href="#l12.3180"></a><span id="l12.3180">   }</span>
<a href="#l12.3181"></a><span id="l12.3181"> </span>
<a href="#l12.3182"></a><span id="l12.3182">   rv = aMsgHdr-&gt;SetUint32Property(aProperty, aValue);</span>
<a href="#l12.3183"></a><span id="l12.3183">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3184"></a><span id="l12.3184"> </span>
<a href="#l12.3185"></a><span id="l12.3185">   // Postcall OnHdrPropertyChanged to process the change.</span>
<a href="#l12.3186"></a><span id="l12.3186" class="difflineminus">-  if (notify)</span>
<a href="#l12.3187"></a><span id="l12.3187" class="difflineminus">-  {</span>
<a href="#l12.3188"></a><span id="l12.3188" class="difflineminus">-    nsTObserverArray&lt;nsCOMPtr&lt;nsIDBChangeListener&gt; &gt;::ForwardIterator listeners(m_ChangeListeners);</span>
<a href="#l12.3189"></a><span id="l12.3189" class="difflineminus">-    for (uint32_t i = 0; listeners.HasMore(); i++)</span>
<a href="#l12.3190"></a><span id="l12.3190" class="difflineminus">-    {</span>
<a href="#l12.3191"></a><span id="l12.3191" class="difflineplus">+  if (notify) {</span>
<a href="#l12.3192"></a><span id="l12.3192" class="difflineplus">+    nsTObserverArray&lt;nsCOMPtr&lt;nsIDBChangeListener&gt; &gt;::ForwardIterator listeners(</span>
<a href="#l12.3193"></a><span id="l12.3193" class="difflineplus">+        m_ChangeListeners);</span>
<a href="#l12.3194"></a><span id="l12.3194" class="difflineplus">+    for (uint32_t i = 0; listeners.HasMore(); i++) {</span>
<a href="#l12.3195"></a><span id="l12.3195">       listener = listeners.GetNext();</span>
<a href="#l12.3196"></a><span id="l12.3196">       status = statusArray[i];</span>
<a href="#l12.3197"></a><span id="l12.3197">       listener-&gt;OnHdrPropertyChanged(aMsgHdr, false, &amp;status, nullptr);</span>
<a href="#l12.3198"></a><span id="l12.3198">       // Ignore errors.</span>
<a href="#l12.3199"></a><span id="l12.3199">     }</span>
<a href="#l12.3200"></a><span id="l12.3200">   }</span>
<a href="#l12.3201"></a><span id="l12.3201"> </span>
<a href="#l12.3202"></a><span id="l12.3202">   return NS_OK;</span>
<a href="#l12.3203"></a><span id="l12.3203"> }</span>
<a href="#l12.3204"></a><span id="l12.3204"> </span>
<a href="#l12.3205"></a><span id="l12.3205" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::SetLabel(nsMsgKey key, nsMsgLabelValue label)</span>
<a href="#l12.3206"></a><span id="l12.3206" class="difflineminus">-{</span>
<a href="#l12.3207"></a><span id="l12.3207" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::SetLabel(nsMsgKey key, nsMsgLabelValue label) {</span>
<a href="#l12.3208"></a><span id="l12.3208">   nsresult rv;</span>
<a href="#l12.3209"></a><span id="l12.3209" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.3210"></a><span id="l12.3210" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.3211"></a><span id="l12.3211"> </span>
<a href="#l12.3212"></a><span id="l12.3212">   rv = GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l12.3213"></a><span id="l12.3213" class="difflineminus">-  if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l12.3214"></a><span id="l12.3214" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l12.3215"></a><span id="l12.3215" class="difflineplus">+  if (NS_FAILED(rv) || !msgHdr) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l12.3216"></a><span id="l12.3216">   nsMsgLabelValue oldLabel;</span>
<a href="#l12.3217"></a><span id="l12.3217">   msgHdr-&gt;GetLabel(&amp;oldLabel);</span>
<a href="#l12.3218"></a><span id="l12.3218"> </span>
<a href="#l12.3219"></a><span id="l12.3219">   msgHdr-&gt;SetLabel(label);</span>
<a href="#l12.3220"></a><span id="l12.3220">   // clear old label</span>
<a href="#l12.3221"></a><span id="l12.3221" class="difflineminus">-  if (oldLabel != label)</span>
<a href="#l12.3222"></a><span id="l12.3222" class="difflineminus">-  {</span>
<a href="#l12.3223"></a><span id="l12.3223" class="difflineminus">-    if (oldLabel != 0)</span>
<a href="#l12.3224"></a><span id="l12.3224" class="difflineminus">-      rv = SetKeyFlag(key, false, oldLabel &lt;&lt; 25, nullptr);</span>
<a href="#l12.3225"></a><span id="l12.3225" class="difflineplus">+  if (oldLabel != label) {</span>
<a href="#l12.3226"></a><span id="l12.3226" class="difflineplus">+    if (oldLabel != 0) rv = SetKeyFlag(key, false, oldLabel &lt;&lt; 25, nullptr);</span>
<a href="#l12.3227"></a><span id="l12.3227">     // set the flag in the x-mozilla-status2 line.</span>
<a href="#l12.3228"></a><span id="l12.3228">     rv = SetKeyFlag(key, true, label &lt;&lt; 25, nullptr);</span>
<a href="#l12.3229"></a><span id="l12.3229">   }</span>
<a href="#l12.3230"></a><span id="l12.3230">   return rv;</span>
<a href="#l12.3231"></a><span id="l12.3231"> }</span>
<a href="#l12.3232"></a><span id="l12.3232"> </span>
<a href="#l12.3233"></a><span id="l12.3233"> NS_IMETHODIMP nsMsgDatabase::MarkImapDeleted(nsMsgKey key, bool deleted,</span>
<a href="#l12.3234"></a><span id="l12.3234" class="difflineminus">-                                             nsIDBChangeListener *instigator)</span>
<a href="#l12.3235"></a><span id="l12.3235" class="difflineminus">-{</span>
<a href="#l12.3236"></a><span id="l12.3236" class="difflineplus">+                                             nsIDBChangeListener *instigator) {</span>
<a href="#l12.3237"></a><span id="l12.3237">   return SetKeyFlag(key, deleted, nsMsgMessageFlags::IMAPDeleted, instigator);</span>
<a href="#l12.3238"></a><span id="l12.3238"> }</span>
<a href="#l12.3239"></a><span id="l12.3239"> </span>
<a href="#l12.3240"></a><span id="l12.3240" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::MarkMDNNeeded(nsMsgKey key, bool bNeeded,</span>
<a href="#l12.3241"></a><span id="l12.3241" class="difflineminus">-                                           nsIDBChangeListener *instigator /* = NULL */)</span>
<a href="#l12.3242"></a><span id="l12.3242" class="difflineminus">-{</span>
<a href="#l12.3243"></a><span id="l12.3243" class="difflineminus">-  return SetKeyFlag(key, bNeeded, nsMsgMessageFlags::MDNReportNeeded, instigator);</span>
<a href="#l12.3244"></a><span id="l12.3244" class="difflineminus">-}</span>
<a href="#l12.3245"></a><span id="l12.3245" class="difflineminus">-</span>
<a href="#l12.3246"></a><span id="l12.3246" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::IsMDNNeeded(nsMsgKey key, bool *pNeeded)</span>
<a href="#l12.3247"></a><span id="l12.3247" class="difflineminus">-{</span>
<a href="#l12.3248"></a><span id="l12.3248" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.3249"></a><span id="l12.3249" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::MarkMDNNeeded(</span>
<a href="#l12.3250"></a><span id="l12.3250" class="difflineplus">+    nsMsgKey key, bool bNeeded, nsIDBChangeListener *instigator /* = NULL */) {</span>
<a href="#l12.3251"></a><span id="l12.3251" class="difflineplus">+  return SetKeyFlag(key, bNeeded, nsMsgMessageFlags::MDNReportNeeded,</span>
<a href="#l12.3252"></a><span id="l12.3252" class="difflineplus">+                    instigator);</span>
<a href="#l12.3253"></a><span id="l12.3253" class="difflineplus">+}</span>
<a href="#l12.3254"></a><span id="l12.3254" class="difflineplus">+</span>
<a href="#l12.3255"></a><span id="l12.3255" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::IsMDNNeeded(nsMsgKey key, bool *pNeeded) {</span>
<a href="#l12.3256"></a><span id="l12.3256" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.3257"></a><span id="l12.3257"> </span>
<a href="#l12.3258"></a><span id="l12.3258">   nsresult rv = GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l12.3259"></a><span id="l12.3259">   if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l12.3260"></a><span id="l12.3260" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND; // XXX return rv?</span>
<a href="#l12.3261"></a><span id="l12.3261" class="difflineplus">+    return NS_MSG_MESSAGE_NOT_FOUND;  // XXX return rv?</span>
<a href="#l12.3262"></a><span id="l12.3262"> </span>
<a href="#l12.3263"></a><span id="l12.3263">   uint32_t flags;</span>
<a href="#l12.3264"></a><span id="l12.3264">   (void)msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l12.3265"></a><span id="l12.3265">   *pNeeded = !!(flags &amp; nsMsgMessageFlags::MDNReportNeeded);</span>
<a href="#l12.3266"></a><span id="l12.3266">   return rv;</span>
<a href="#l12.3267"></a><span id="l12.3267"> }</span>
<a href="#l12.3268"></a><span id="l12.3268"> </span>
<a href="#l12.3269"></a><span id="l12.3269" class="difflineminus">-</span>
<a href="#l12.3270"></a><span id="l12.3270" class="difflineminus">-nsresult nsMsgDatabase::MarkMDNSent(nsMsgKey key, bool bSent,</span>
<a href="#l12.3271"></a><span id="l12.3271" class="difflineminus">-                                    nsIDBChangeListener *instigator /* = NULL */)</span>
<a href="#l12.3272"></a><span id="l12.3272" class="difflineminus">-{</span>
<a href="#l12.3273"></a><span id="l12.3273" class="difflineplus">+nsresult nsMsgDatabase::MarkMDNSent(</span>
<a href="#l12.3274"></a><span id="l12.3274" class="difflineplus">+    nsMsgKey key, bool bSent, nsIDBChangeListener *instigator /* = NULL */) {</span>
<a href="#l12.3275"></a><span id="l12.3275">   return SetKeyFlag(key, bSent, nsMsgMessageFlags::MDNReportSent, instigator);</span>
<a href="#l12.3276"></a><span id="l12.3276"> }</span>
<a href="#l12.3277"></a><span id="l12.3277"> </span>
<a href="#l12.3278"></a><span id="l12.3278" class="difflineminus">-</span>
<a href="#l12.3279"></a><span id="l12.3279" class="difflineminus">-nsresult nsMsgDatabase::IsMDNSent(nsMsgKey key, bool *pSent)</span>
<a href="#l12.3280"></a><span id="l12.3280" class="difflineminus">-{</span>
<a href="#l12.3281"></a><span id="l12.3281" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.3282"></a><span id="l12.3282" class="difflineplus">+nsresult nsMsgDatabase::IsMDNSent(nsMsgKey key, bool *pSent) {</span>
<a href="#l12.3283"></a><span id="l12.3283" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.3284"></a><span id="l12.3284"> </span>
<a href="#l12.3285"></a><span id="l12.3285">   nsresult rv = GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l12.3286"></a><span id="l12.3286">   if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l12.3287"></a><span id="l12.3287" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND; // XXX return rv?</span>
<a href="#l12.3288"></a><span id="l12.3288" class="difflineplus">+    return NS_MSG_MESSAGE_NOT_FOUND;  // XXX return rv?</span>
<a href="#l12.3289"></a><span id="l12.3289"> </span>
<a href="#l12.3290"></a><span id="l12.3290">   uint32_t flags;</span>
<a href="#l12.3291"></a><span id="l12.3291">   (void)msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l12.3292"></a><span id="l12.3292">   *pSent = !!(flags &amp; nsMsgMessageFlags::MDNReportSent);</span>
<a href="#l12.3293"></a><span id="l12.3293">   return rv;</span>
<a href="#l12.3294"></a><span id="l12.3294"> }</span>
<a href="#l12.3295"></a><span id="l12.3295"> </span>
<a href="#l12.3296"></a><span id="l12.3296" class="difflineminus">-</span>
<a href="#l12.3297"></a><span id="l12.3297" class="difflineminus">-nsresult nsMsgDatabase::SetKeyFlag(nsMsgKey key, bool set, nsMsgMessageFlagType flag,</span>
<a href="#l12.3298"></a><span id="l12.3298" class="difflineminus">-                                   nsIDBChangeListener *instigator)</span>
<a href="#l12.3299"></a><span id="l12.3299" class="difflineminus">-{</span>
<a href="#l12.3300"></a><span id="l12.3300" class="difflineplus">+nsresult nsMsgDatabase::SetKeyFlag(nsMsgKey key, bool set,</span>
<a href="#l12.3301"></a><span id="l12.3301" class="difflineplus">+                                   nsMsgMessageFlagType flag,</span>
<a href="#l12.3302"></a><span id="l12.3302" class="difflineplus">+                                   nsIDBChangeListener *instigator) {</span>
<a href="#l12.3303"></a><span id="l12.3303">   nsresult rv;</span>
<a href="#l12.3304"></a><span id="l12.3304" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.3305"></a><span id="l12.3305" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.3306"></a><span id="l12.3306"> </span>
<a href="#l12.3307"></a><span id="l12.3307">   rv = GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l12.3308"></a><span id="l12.3308">   if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l12.3309"></a><span id="l12.3309" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND; // XXX return rv?</span>
<a href="#l12.3310"></a><span id="l12.3310" class="difflineplus">+    return NS_MSG_MESSAGE_NOT_FOUND;  // XXX return rv?</span>
<a href="#l12.3311"></a><span id="l12.3311"> </span>
<a href="#l12.3312"></a><span id="l12.3312">   return SetMsgHdrFlag(msgHdr, set, flag, instigator);</span>
<a href="#l12.3313"></a><span id="l12.3313"> }</span>
<a href="#l12.3314"></a><span id="l12.3314"> </span>
<a href="#l12.3315"></a><span id="l12.3315"> nsresult nsMsgDatabase::SetMsgHdrFlag(nsIMsgDBHdr *msgHdr, bool set,</span>
<a href="#l12.3316"></a><span id="l12.3316">                                       nsMsgMessageFlagType flag,</span>
<a href="#l12.3317"></a><span id="l12.3317" class="difflineminus">-                                      nsIDBChangeListener *instigator)</span>
<a href="#l12.3318"></a><span id="l12.3318" class="difflineminus">-{</span>
<a href="#l12.3319"></a><span id="l12.3319" class="difflineplus">+                                      nsIDBChangeListener *instigator) {</span>
<a href="#l12.3320"></a><span id="l12.3320">   uint32_t oldFlags;</span>
<a href="#l12.3321"></a><span id="l12.3321">   (void)msgHdr-&gt;GetFlags(&amp;oldFlags);</span>
<a href="#l12.3322"></a><span id="l12.3322"> </span>
<a href="#l12.3323"></a><span id="l12.3323" class="difflineminus">-  if (!SetHdrFlag(msgHdr, set, flag))</span>
<a href="#l12.3324"></a><span id="l12.3324" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.3325"></a><span id="l12.3325" class="difflineplus">+  if (!SetHdrFlag(msgHdr, set, flag)) return NS_OK;</span>
<a href="#l12.3326"></a><span id="l12.3326"> </span>
<a href="#l12.3327"></a><span id="l12.3327">   uint32_t flags;</span>
<a href="#l12.3328"></a><span id="l12.3328">   (void)msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l12.3329"></a><span id="l12.3329"> </span>
<a href="#l12.3330"></a><span id="l12.3330">   return NotifyHdrChangeAll(msgHdr, oldFlags, flags, instigator);</span>
<a href="#l12.3331"></a><span id="l12.3331"> }</span>
<a href="#l12.3332"></a><span id="l12.3332"> </span>
<a href="#l12.3333"></a><span id="l12.3333"> // Helper routine - lowest level of flag setting - returns true if flags change,</span>
<a href="#l12.3334"></a><span id="l12.3334"> // false otherwise.</span>
<a href="#l12.3335"></a><span id="l12.3335" class="difflineminus">-bool nsMsgDatabase::SetHdrFlag(nsIMsgDBHdr *msgHdr, bool bSet, nsMsgMessageFlagType flag)</span>
<a href="#l12.3336"></a><span id="l12.3336" class="difflineminus">-{</span>
<a href="#l12.3337"></a><span id="l12.3337" class="difflineplus">+bool nsMsgDatabase::SetHdrFlag(nsIMsgDBHdr *msgHdr, bool bSet,</span>
<a href="#l12.3338"></a><span id="l12.3338" class="difflineplus">+                               nsMsgMessageFlagType flag) {</span>
<a href="#l12.3339"></a><span id="l12.3339">   uint32_t statusFlags;</span>
<a href="#l12.3340"></a><span id="l12.3340">   (void)msgHdr-&gt;GetFlags(&amp;statusFlags);</span>
<a href="#l12.3341"></a><span id="l12.3341">   uint32_t currentStatusFlags = GetStatusFlags(msgHdr, statusFlags);</span>
<a href="#l12.3342"></a><span id="l12.3342">   bool flagAlreadySet = (currentStatusFlags &amp; flag) != 0;</span>
<a href="#l12.3343"></a><span id="l12.3343"> </span>
<a href="#l12.3344"></a><span id="l12.3344" class="difflineminus">-  if ((flagAlreadySet &amp;&amp; !bSet) || (!flagAlreadySet &amp;&amp; bSet))</span>
<a href="#l12.3345"></a><span id="l12.3345" class="difflineminus">-  {</span>
<a href="#l12.3346"></a><span id="l12.3346" class="difflineplus">+  if ((flagAlreadySet &amp;&amp; !bSet) || (!flagAlreadySet &amp;&amp; bSet)) {</span>
<a href="#l12.3347"></a><span id="l12.3347">     uint32_t resultFlags;</span>
<a href="#l12.3348"></a><span id="l12.3348">     if (bSet)</span>
<a href="#l12.3349"></a><span id="l12.3349">       msgHdr-&gt;OrFlags(flag, &amp;resultFlags);</span>
<a href="#l12.3350"></a><span id="l12.3350">     else</span>
<a href="#l12.3351"></a><span id="l12.3351">       msgHdr-&gt;AndFlags(~flag, &amp;resultFlags);</span>
<a href="#l12.3352"></a><span id="l12.3352">     return true;</span>
<a href="#l12.3353"></a><span id="l12.3353">   }</span>
<a href="#l12.3354"></a><span id="l12.3354">   return false;</span>
<a href="#l12.3355"></a><span id="l12.3355"> }</span>
<a href="#l12.3356"></a><span id="l12.3356"> </span>
<a href="#l12.3357"></a><span id="l12.3357" class="difflineminus">-</span>
<a href="#l12.3358"></a><span id="l12.3358"> NS_IMETHODIMP nsMsgDatabase::MarkHdrRead(nsIMsgDBHdr *msgHdr, bool bRead,</span>
<a href="#l12.3359"></a><span id="l12.3359" class="difflineminus">-                                         nsIDBChangeListener *instigator)</span>
<a href="#l12.3360"></a><span id="l12.3360" class="difflineminus">-{</span>
<a href="#l12.3361"></a><span id="l12.3361" class="difflineplus">+                                         nsIDBChangeListener *instigator) {</span>
<a href="#l12.3362"></a><span id="l12.3362">   bool isReadInDB = true;</span>
<a href="#l12.3363"></a><span id="l12.3363">   nsresult rv = nsMsgDatabase::IsHeaderRead(msgHdr, &amp;isReadInDB);</span>
<a href="#l12.3364"></a><span id="l12.3364">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3365"></a><span id="l12.3365"> </span>
<a href="#l12.3366"></a><span id="l12.3366">   bool isRead = true;</span>
<a href="#l12.3367"></a><span id="l12.3367">   rv = IsHeaderRead(msgHdr, &amp;isRead);</span>
<a href="#l12.3368"></a><span id="l12.3368">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3369"></a><span id="l12.3369"> </span>
<a href="#l12.3370"></a><span id="l12.3370">   // if the flag is already correct in the db, don't change it.</span>
<a href="#l12.3371"></a><span id="l12.3371">   // Check msg flags as well as IsHeaderRead in case it's a newsgroup</span>
<a href="#l12.3372"></a><span id="l12.3372">   // and the msghdr flags are out of sync with the newsrc settings.</span>
<a href="#l12.3373"></a><span id="l12.3373">   // (we could override this method for news db's, but it's a trivial fix here.</span>
<a href="#l12.3374"></a><span id="l12.3374" class="difflineminus">-  if (bRead != isRead || isRead != isReadInDB)</span>
<a href="#l12.3375"></a><span id="l12.3375" class="difflineminus">-  {</span>
<a href="#l12.3376"></a><span id="l12.3376" class="difflineplus">+  if (bRead != isRead || isRead != isReadInDB) {</span>
<a href="#l12.3377"></a><span id="l12.3377">     nsMsgKey msgKey;</span>
<a href="#l12.3378"></a><span id="l12.3378">     msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l12.3379"></a><span id="l12.3379"> </span>
<a href="#l12.3380"></a><span id="l12.3380">     bool inDB = false;</span>
<a href="#l12.3381"></a><span id="l12.3381">     (void)ContainsKey(msgKey, &amp;inDB);</span>
<a href="#l12.3382"></a><span id="l12.3382"> </span>
<a href="#l12.3383"></a><span id="l12.3383" class="difflineminus">-    if (inDB)</span>
<a href="#l12.3384"></a><span id="l12.3384" class="difflineminus">-    {</span>
<a href="#l12.3385"></a><span id="l12.3385" class="difflineminus">-      nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l12.3386"></a><span id="l12.3386" class="difflineplus">+    if (inDB) {</span>
<a href="#l12.3387"></a><span id="l12.3387" class="difflineplus">+      nsCOMPtr&lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l12.3388"></a><span id="l12.3388">       rv = GetThreadForMsgKey(msgKey, getter_AddRefs(threadHdr));</span>
<a href="#l12.3389"></a><span id="l12.3389" class="difflineminus">-      if (threadHdr)</span>
<a href="#l12.3390"></a><span id="l12.3390" class="difflineminus">-        threadHdr-&gt;MarkChildRead(bRead);</span>
<a href="#l12.3391"></a><span id="l12.3391" class="difflineplus">+      if (threadHdr) threadHdr-&gt;MarkChildRead(bRead);</span>
<a href="#l12.3392"></a><span id="l12.3392">     }</span>
<a href="#l12.3393"></a><span id="l12.3393">     return MarkHdrReadInDB(msgHdr, bRead, instigator);</span>
<a href="#l12.3394"></a><span id="l12.3394">   }</span>
<a href="#l12.3395"></a><span id="l12.3395">   return NS_OK;</span>
<a href="#l12.3396"></a><span id="l12.3396"> }</span>
<a href="#l12.3397"></a><span id="l12.3397"> </span>
<a href="#l12.3398"></a><span id="l12.3398"> NS_IMETHODIMP nsMsgDatabase::MarkHdrReplied(nsIMsgDBHdr *msgHdr, bool bReplied,</span>
<a href="#l12.3399"></a><span id="l12.3399" class="difflineminus">-                         nsIDBChangeListener *instigator)</span>
<a href="#l12.3400"></a><span id="l12.3400" class="difflineminus">-{</span>
<a href="#l12.3401"></a><span id="l12.3401" class="difflineminus">-  return SetMsgHdrFlag(msgHdr, bReplied, nsMsgMessageFlags::Replied, instigator);</span>
<a href="#l12.3402"></a><span id="l12.3402" class="difflineminus">-}</span>
<a href="#l12.3403"></a><span id="l12.3403" class="difflineminus">-</span>
<a href="#l12.3404"></a><span id="l12.3404" class="difflineplus">+                                            nsIDBChangeListener *instigator) {</span>
<a href="#l12.3405"></a><span id="l12.3405" class="difflineplus">+  return SetMsgHdrFlag(msgHdr, bReplied, nsMsgMessageFlags::Replied,</span>
<a href="#l12.3406"></a><span id="l12.3406" class="difflineplus">+                       instigator);</span>
<a href="#l12.3407"></a><span id="l12.3407" class="difflineplus">+}</span>
<a href="#l12.3408"></a><span id="l12.3408"> </span>
<a href="#l12.3409"></a><span id="l12.3409"> NS_IMETHODIMP nsMsgDatabase::MarkHdrMarked(nsIMsgDBHdr *msgHdr, bool mark,</span>
<a href="#l12.3410"></a><span id="l12.3410" class="difflineminus">-                         nsIDBChangeListener *instigator)</span>
<a href="#l12.3411"></a><span id="l12.3411" class="difflineminus">-{</span>
<a href="#l12.3412"></a><span id="l12.3412" class="difflineplus">+                                           nsIDBChangeListener *instigator) {</span>
<a href="#l12.3413"></a><span id="l12.3413">   return SetMsgHdrFlag(msgHdr, mark, nsMsgMessageFlags::Marked, instigator);</span>
<a href="#l12.3414"></a><span id="l12.3414"> }</span>
<a href="#l12.3415"></a><span id="l12.3415"> </span>
<a href="#l12.3416"></a><span id="l12.3416"> NS_IMETHODIMP</span>
<a href="#l12.3417"></a><span id="l12.3417"> nsMsgDatabase::MarkHdrNotNew(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l12.3418"></a><span id="l12.3418" class="difflineminus">-                             nsIDBChangeListener *aInstigator)</span>
<a href="#l12.3419"></a><span id="l12.3419" class="difflineminus">-{</span>
<a href="#l12.3420"></a><span id="l12.3420" class="difflineplus">+                             nsIDBChangeListener *aInstigator) {</span>
<a href="#l12.3421"></a><span id="l12.3421">   NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l12.3422"></a><span id="l12.3422">   nsMsgKey msgKey;</span>
<a href="#l12.3423"></a><span id="l12.3423">   aMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l12.3424"></a><span id="l12.3424">   m_newSet.RemoveElement(msgKey);</span>
<a href="#l12.3425"></a><span id="l12.3425">   return SetMsgHdrFlag(aMsgHdr, false, nsMsgMessageFlags::New, aInstigator);</span>
<a href="#l12.3426"></a><span id="l12.3426"> }</span>
<a href="#l12.3427"></a><span id="l12.3427"> </span>
<a href="#l12.3428"></a><span id="l12.3428" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::MarkAllRead(uint32_t *aNumKeys, nsMsgKey **aThoseMarked)</span>
<a href="#l12.3429"></a><span id="l12.3429" class="difflineminus">-{</span>
<a href="#l12.3430"></a><span id="l12.3430" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::MarkAllRead(uint32_t *aNumKeys,</span>
<a href="#l12.3431"></a><span id="l12.3431" class="difflineplus">+                                         nsMsgKey **aThoseMarked) {</span>
<a href="#l12.3432"></a><span id="l12.3432">   NS_ENSURE_ARG_POINTER(aNumKeys);</span>
<a href="#l12.3433"></a><span id="l12.3433">   NS_ENSURE_ARG_POINTER(aThoseMarked);</span>
<a href="#l12.3434"></a><span id="l12.3434" class="difflineminus">-  nsMsgHdr  *pHeader;</span>
<a href="#l12.3435"></a><span id="l12.3435" class="difflineplus">+  nsMsgHdr *pHeader;</span>
<a href="#l12.3436"></a><span id="l12.3436"> </span>
<a href="#l12.3437"></a><span id="l12.3437">   nsCOMPtr&lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l12.3438"></a><span id="l12.3438">   nsTArray&lt;nsMsgKey&gt; thoseMarked;</span>
<a href="#l12.3439"></a><span id="l12.3439">   nsresult rv = EnumerateMessages(getter_AddRefs(hdrs));</span>
<a href="#l12.3440"></a><span id="l12.3440" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.3441"></a><span id="l12.3441" class="difflineminus">-    return rv;</span>
<a href="#l12.3442"></a><span id="l12.3442" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.3443"></a><span id="l12.3443">   bool hasMore = false;</span>
<a href="#l12.3444"></a><span id="l12.3444"> </span>
<a href="#l12.3445"></a><span id="l12.3445" class="difflineminus">-  while (NS_SUCCEEDED(rv = hdrs-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l12.3446"></a><span id="l12.3446" class="difflineminus">-  {</span>
<a href="#l12.3447"></a><span id="l12.3447" class="difflineminus">-    rv = hdrs-&gt;GetNext((nsISupports**)&amp;pHeader);</span>
<a href="#l12.3448"></a><span id="l12.3448" class="difflineplus">+  while (NS_SUCCEEDED(rv = hdrs-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l12.3449"></a><span id="l12.3449" class="difflineplus">+    rv = hdrs-&gt;GetNext((nsISupports **)&amp;pHeader);</span>
<a href="#l12.3450"></a><span id="l12.3450">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;nsMsgDBEnumerator broken&quot;);</span>
<a href="#l12.3451"></a><span id="l12.3451" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.3452"></a><span id="l12.3452" class="difflineminus">-      break;</span>
<a href="#l12.3453"></a><span id="l12.3453" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l12.3454"></a><span id="l12.3454"> </span>
<a href="#l12.3455"></a><span id="l12.3455">     bool isRead;</span>
<a href="#l12.3456"></a><span id="l12.3456">     IsHeaderRead(pHeader, &amp;isRead);</span>
<a href="#l12.3457"></a><span id="l12.3457"> </span>
<a href="#l12.3458"></a><span id="l12.3458" class="difflineminus">-    if (!isRead)</span>
<a href="#l12.3459"></a><span id="l12.3459" class="difflineminus">-    {</span>
<a href="#l12.3460"></a><span id="l12.3460" class="difflineplus">+    if (!isRead) {</span>
<a href="#l12.3461"></a><span id="l12.3461">       nsMsgKey key;</span>
<a href="#l12.3462"></a><span id="l12.3462">       (void)pHeader-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.3463"></a><span id="l12.3463">       thoseMarked.AppendElement(key);</span>
<a href="#l12.3464"></a><span id="l12.3464" class="difflineminus">-      rv = MarkHdrRead(pHeader, true, nullptr);   // ### dmb - blow off error?</span>
<a href="#l12.3465"></a><span id="l12.3465" class="difflineplus">+      rv = MarkHdrRead(pHeader, true, nullptr);  // ### dmb - blow off error?</span>
<a href="#l12.3466"></a><span id="l12.3466">     }</span>
<a href="#l12.3467"></a><span id="l12.3467">     NS_RELEASE(pHeader);</span>
<a href="#l12.3468"></a><span id="l12.3468">   }</span>
<a href="#l12.3469"></a><span id="l12.3469"> </span>
<a href="#l12.3470"></a><span id="l12.3470">   *aNumKeys = thoseMarked.Length();</span>
<a href="#l12.3471"></a><span id="l12.3471"> </span>
<a href="#l12.3472"></a><span id="l12.3472" class="difflineminus">-  if (thoseMarked.Length())</span>
<a href="#l12.3473"></a><span id="l12.3473" class="difflineminus">-  {</span>
<a href="#l12.3474"></a><span id="l12.3474" class="difflineminus">-    *aThoseMarked = (nsMsgKey *) moz_xmemdup(&amp;thoseMarked[0],</span>
<a href="#l12.3475"></a><span id="l12.3475" class="difflineminus">-                                             thoseMarked.Length() * sizeof(nsMsgKey));</span>
<a href="#l12.3476"></a><span id="l12.3476" class="difflineminus">-    if (!*aThoseMarked)</span>
<a href="#l12.3477"></a><span id="l12.3477" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.3478"></a><span id="l12.3478" class="difflineminus">-  }</span>
<a href="#l12.3479"></a><span id="l12.3479" class="difflineminus">-  else</span>
<a href="#l12.3480"></a><span id="l12.3480" class="difflineplus">+  if (thoseMarked.Length()) {</span>
<a href="#l12.3481"></a><span id="l12.3481" class="difflineplus">+    *aThoseMarked = (nsMsgKey *)moz_xmemdup(</span>
<a href="#l12.3482"></a><span id="l12.3482" class="difflineplus">+        &amp;thoseMarked[0], thoseMarked.Length() * sizeof(nsMsgKey));</span>
<a href="#l12.3483"></a><span id="l12.3483" class="difflineplus">+    if (!*aThoseMarked) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.3484"></a><span id="l12.3484" class="difflineplus">+  } else</span>
<a href="#l12.3485"></a><span id="l12.3485">     *aThoseMarked = nullptr;</span>
<a href="#l12.3486"></a><span id="l12.3486"> </span>
<a href="#l12.3487"></a><span id="l12.3487">   // force num new to 0.</span>
<a href="#l12.3488"></a><span id="l12.3488">   int32_t numUnreadMessages;</span>
<a href="#l12.3489"></a><span id="l12.3489"> </span>
<a href="#l12.3490"></a><span id="l12.3490">   rv = m_dbFolderInfo-&gt;GetNumUnreadMessages(&amp;numUnreadMessages);</span>
<a href="#l12.3491"></a><span id="l12.3491">   if (NS_SUCCEEDED(rv))</span>
<a href="#l12.3492"></a><span id="l12.3492">     m_dbFolderInfo-&gt;ChangeNumUnreadMessages(-numUnreadMessages);</span>
<a href="#l12.3493"></a><span id="l12.3493">   // caller will Commit the db, so no need to do it here.</span>
<a href="#l12.3494"></a><span id="l12.3494">   return rv;</span>
<a href="#l12.3495"></a><span id="l12.3495"> }</span>
<a href="#l12.3496"></a><span id="l12.3496"> </span>
<a href="#l12.3497"></a><span id="l12.3497" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::AddToNewList(nsMsgKey key)</span>
<a href="#l12.3498"></a><span id="l12.3498" class="difflineminus">-{</span>
<a href="#l12.3499"></a><span id="l12.3499" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::AddToNewList(nsMsgKey key) {</span>
<a href="#l12.3500"></a><span id="l12.3500">   // we add new keys in increasing order...</span>
<a href="#l12.3501"></a><span id="l12.3501">   if (m_newSet.IsEmpty() || (m_newSet[m_newSet.Length() - 1] &lt; key))</span>
<a href="#l12.3502"></a><span id="l12.3502">     m_newSet.AppendElement(key);</span>
<a href="#l12.3503"></a><span id="l12.3503">   return NS_OK;</span>
<a href="#l12.3504"></a><span id="l12.3504"> }</span>
<a href="#l12.3505"></a><span id="l12.3505"> </span>
<a href="#l12.3506"></a><span id="l12.3506" class="difflineminus">-</span>
<a href="#l12.3507"></a><span id="l12.3507" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::ClearNewList(bool notify /* = FALSE */)</span>
<a href="#l12.3508"></a><span id="l12.3508" class="difflineminus">-{</span>
<a href="#l12.3509"></a><span id="l12.3509" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::ClearNewList(bool notify /* = FALSE */) {</span>
<a href="#l12.3510"></a><span id="l12.3510">   nsresult err = NS_OK;</span>
<a href="#l12.3511"></a><span id="l12.3511">   if (notify &amp;&amp; !m_newSet.IsEmpty())  // need to update view</span>
<a href="#l12.3512"></a><span id="l12.3512">   {</span>
<a href="#l12.3513"></a><span id="l12.3513">     nsTArray&lt;nsMsgKey&gt; saveNewSet;</span>
<a href="#l12.3514"></a><span id="l12.3514">     // clear m_newSet so that the code that's listening to the key change</span>
<a href="#l12.3515"></a><span id="l12.3515">     // doesn't think we have new messages and send notifications all over</span>
<a href="#l12.3516"></a><span id="l12.3516">     // that we have new messages.</span>
<a href="#l12.3517"></a><span id="l12.3517">     saveNewSet.SwapElements(m_newSet);</span>
<a href="#l12.3518"></a><span id="l12.3518" class="difflineminus">-    for (uint32_t elementIndex = saveNewSet.Length() - 1; ; elementIndex--)</span>
<a href="#l12.3519"></a><span id="l12.3519" class="difflineminus">-    {</span>
<a href="#l12.3520"></a><span id="l12.3520" class="difflineplus">+    for (uint32_t elementIndex = saveNewSet.Length() - 1;; elementIndex--) {</span>
<a href="#l12.3521"></a><span id="l12.3521">       nsMsgKey lastNewKey = saveNewSet.ElementAt(elementIndex);</span>
<a href="#l12.3522"></a><span id="l12.3522" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.3523"></a><span id="l12.3523" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.3524"></a><span id="l12.3524">       err = GetMsgHdrForKey(lastNewKey, getter_AddRefs(msgHdr));</span>
<a href="#l12.3525"></a><span id="l12.3525" class="difflineminus">-      if (NS_SUCCEEDED(err))</span>
<a href="#l12.3526"></a><span id="l12.3526" class="difflineminus">-      {</span>
<a href="#l12.3527"></a><span id="l12.3527" class="difflineplus">+      if (NS_SUCCEEDED(err)) {</span>
<a href="#l12.3528"></a><span id="l12.3528">         uint32_t flags;</span>
<a href="#l12.3529"></a><span id="l12.3529">         (void)msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l12.3530"></a><span id="l12.3530"> </span>
<a href="#l12.3531"></a><span id="l12.3531" class="difflineminus">-        if ((flags | nsMsgMessageFlags::New) != flags)</span>
<a href="#l12.3532"></a><span id="l12.3532" class="difflineminus">-        {</span>
<a href="#l12.3533"></a><span id="l12.3533" class="difflineplus">+        if ((flags | nsMsgMessageFlags::New) != flags) {</span>
<a href="#l12.3534"></a><span id="l12.3534">           msgHdr-&gt;AndFlags(~nsMsgMessageFlags::New, &amp;flags);</span>
<a href="#l12.3535"></a><span id="l12.3535" class="difflineminus">-          NotifyHdrChangeAll(msgHdr, flags | nsMsgMessageFlags::New, flags, nullptr);</span>
<a href="#l12.3536"></a><span id="l12.3536" class="difflineplus">+          NotifyHdrChangeAll(msgHdr, flags | nsMsgMessageFlags::New, flags,</span>
<a href="#l12.3537"></a><span id="l12.3537" class="difflineplus">+                             nullptr);</span>
<a href="#l12.3538"></a><span id="l12.3538">         }</span>
<a href="#l12.3539"></a><span id="l12.3539">       }</span>
<a href="#l12.3540"></a><span id="l12.3540" class="difflineminus">-      if (elementIndex == 0)</span>
<a href="#l12.3541"></a><span id="l12.3541" class="difflineminus">-        break;</span>
<a href="#l12.3542"></a><span id="l12.3542" class="difflineplus">+      if (elementIndex == 0) break;</span>
<a href="#l12.3543"></a><span id="l12.3543">     }</span>
<a href="#l12.3544"></a><span id="l12.3544">   }</span>
<a href="#l12.3545"></a><span id="l12.3545">   return err;</span>
<a href="#l12.3546"></a><span id="l12.3546"> }</span>
<a href="#l12.3547"></a><span id="l12.3547"> </span>
<a href="#l12.3548"></a><span id="l12.3548" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::HasNew(bool *_retval)</span>
<a href="#l12.3549"></a><span id="l12.3549" class="difflineminus">-{</span>
<a href="#l12.3550"></a><span id="l12.3550" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::HasNew(bool *_retval) {</span>
<a href="#l12.3551"></a><span id="l12.3551">   if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.3552"></a><span id="l12.3552"> </span>
<a href="#l12.3553"></a><span id="l12.3553">   *_retval = (m_newSet.Length() &gt; 0);</span>
<a href="#l12.3554"></a><span id="l12.3554">   return NS_OK;</span>
<a href="#l12.3555"></a><span id="l12.3555"> }</span>
<a href="#l12.3556"></a><span id="l12.3556"> </span>
<a href="#l12.3557"></a><span id="l12.3557" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetFirstNew(nsMsgKey *result)</span>
<a href="#l12.3558"></a><span id="l12.3558" class="difflineminus">-{</span>
<a href="#l12.3559"></a><span id="l12.3559" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetFirstNew(nsMsgKey *result) {</span>
<a href="#l12.3560"></a><span id="l12.3560">   bool hasnew;</span>
<a href="#l12.3561"></a><span id="l12.3561">   nsresult rv = HasNew(&amp;hasnew);</span>
<a href="#l12.3562"></a><span id="l12.3562">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.3563"></a><span id="l12.3563">   *result = (hasnew) ? m_newSet.ElementAt(0) : nsMsgKey_None;</span>
<a href="#l12.3564"></a><span id="l12.3564">   return NS_OK;</span>
<a href="#l12.3565"></a><span id="l12.3565"> }</span>
<a href="#l12.3566"></a><span id="l12.3566"> </span>
<a href="#l12.3567"></a><span id="l12.3567" class="difflineminus">-</span>
<a href="#l12.3568"></a><span id="l12.3568"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l12.3569"></a><span id="l12.3569"> </span>
<a href="#l12.3570"></a><span id="l12.3570" class="difflineminus">-nsMsgDBEnumerator::nsMsgDBEnumerator(nsMsgDatabase* db,</span>
<a href="#l12.3571"></a><span id="l12.3571" class="difflineminus">-                                     nsIMdbTable *table,</span>
<a href="#l12.3572"></a><span id="l12.3572" class="difflineplus">+nsMsgDBEnumerator::nsMsgDBEnumerator(nsMsgDatabase *db, nsIMdbTable *table,</span>
<a href="#l12.3573"></a><span id="l12.3573">                                      nsMsgDBEnumeratorFilter filter,</span>
<a href="#l12.3574"></a><span id="l12.3574" class="difflineminus">-                                     void* closure,</span>
<a href="#l12.3575"></a><span id="l12.3575" class="difflineminus">-                                     bool iterateForwards)</span>
<a href="#l12.3576"></a><span id="l12.3576" class="difflineplus">+                                     void *closure, bool iterateForwards)</span>
<a href="#l12.3577"></a><span id="l12.3577">     : mDB(db),</span>
<a href="#l12.3578"></a><span id="l12.3578">       mDone(false),</span>
<a href="#l12.3579"></a><span id="l12.3579">       mIterateForwards(iterateForwards),</span>
<a href="#l12.3580"></a><span id="l12.3580">       mFilter(filter),</span>
<a href="#l12.3581"></a><span id="l12.3581">       mClosure(closure),</span>
<a href="#l12.3582"></a><span id="l12.3582" class="difflineminus">-      mStopPos(-1)</span>
<a href="#l12.3583"></a><span id="l12.3583" class="difflineminus">-{</span>
<a href="#l12.3584"></a><span id="l12.3584" class="difflineplus">+      mStopPos(-1) {</span>
<a href="#l12.3585"></a><span id="l12.3585">   mNextPrefetched = false;</span>
<a href="#l12.3586"></a><span id="l12.3586">   mTable = table;</span>
<a href="#l12.3587"></a><span id="l12.3587">   mRowPos = 0;</span>
<a href="#l12.3588"></a><span id="l12.3588">   mDB-&gt;m_enumerators.AppendElement(this);</span>
<a href="#l12.3589"></a><span id="l12.3589"> }</span>
<a href="#l12.3590"></a><span id="l12.3590"> </span>
<a href="#l12.3591"></a><span id="l12.3591" class="difflineminus">-nsMsgDBEnumerator::~nsMsgDBEnumerator()</span>
<a href="#l12.3592"></a><span id="l12.3592" class="difflineminus">-{</span>
<a href="#l12.3593"></a><span id="l12.3593" class="difflineminus">-  Clear();</span>
<a href="#l12.3594"></a><span id="l12.3594" class="difflineminus">-}</span>
<a href="#l12.3595"></a><span id="l12.3595" class="difflineminus">-</span>
<a href="#l12.3596"></a><span id="l12.3596" class="difflineminus">-void nsMsgDBEnumerator::Clear()</span>
<a href="#l12.3597"></a><span id="l12.3597" class="difflineminus">-{</span>
<a href="#l12.3598"></a><span id="l12.3598" class="difflineplus">+nsMsgDBEnumerator::~nsMsgDBEnumerator() { Clear(); }</span>
<a href="#l12.3599"></a><span id="l12.3599" class="difflineplus">+</span>
<a href="#l12.3600"></a><span id="l12.3600" class="difflineplus">+void nsMsgDBEnumerator::Clear() {</span>
<a href="#l12.3601"></a><span id="l12.3601">   mRowCursor = nullptr;</span>
<a href="#l12.3602"></a><span id="l12.3602">   mTable = nullptr;</span>
<a href="#l12.3603"></a><span id="l12.3603">   mResultHdr = nullptr;</span>
<a href="#l12.3604"></a><span id="l12.3604" class="difflineminus">-  if (mDB)</span>
<a href="#l12.3605"></a><span id="l12.3605" class="difflineminus">-    mDB-&gt;m_enumerators.RemoveElement(this);</span>
<a href="#l12.3606"></a><span id="l12.3606" class="difflineplus">+  if (mDB) mDB-&gt;m_enumerators.RemoveElement(this);</span>
<a href="#l12.3607"></a><span id="l12.3607">   mDB = nullptr;</span>
<a href="#l12.3608"></a><span id="l12.3608"> }</span>
<a href="#l12.3609"></a><span id="l12.3609"> </span>
<a href="#l12.3610"></a><span id="l12.3610" class="difflineminus">-nsresult nsMsgDBEnumerator::GetRowCursor()</span>
<a href="#l12.3611"></a><span id="l12.3611" class="difflineminus">-{</span>
<a href="#l12.3612"></a><span id="l12.3612" class="difflineplus">+nsresult nsMsgDBEnumerator::GetRowCursor() {</span>
<a href="#l12.3613"></a><span id="l12.3613">   mDone = false;</span>
<a href="#l12.3614"></a><span id="l12.3614"> </span>
<a href="#l12.3615"></a><span id="l12.3615" class="difflineminus">-  if (!mDB || !mTable)</span>
<a href="#l12.3616"></a><span id="l12.3616" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.3617"></a><span id="l12.3617" class="difflineminus">-</span>
<a href="#l12.3618"></a><span id="l12.3618" class="difflineminus">-  if (mIterateForwards)</span>
<a href="#l12.3619"></a><span id="l12.3619" class="difflineminus">-  {</span>
<a href="#l12.3620"></a><span id="l12.3620" class="difflineplus">+  if (!mDB || !mTable) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.3621"></a><span id="l12.3621" class="difflineplus">+</span>
<a href="#l12.3622"></a><span id="l12.3622" class="difflineplus">+  if (mIterateForwards) {</span>
<a href="#l12.3623"></a><span id="l12.3623">     mRowPos = -1;</span>
<a href="#l12.3624"></a><span id="l12.3624" class="difflineminus">-  }</span>
<a href="#l12.3625"></a><span id="l12.3625" class="difflineminus">-  else</span>
<a href="#l12.3626"></a><span id="l12.3626" class="difflineminus">-  {</span>
<a href="#l12.3627"></a><span id="l12.3627" class="difflineplus">+  } else {</span>
<a href="#l12.3628"></a><span id="l12.3628">     mdb_count numRows;</span>
<a href="#l12.3629"></a><span id="l12.3629">     mTable-&gt;GetCount(mDB-&gt;GetEnv(), &amp;numRows);</span>
<a href="#l12.3630"></a><span id="l12.3630" class="difflineminus">-    mRowPos = numRows; // startPos is 0 relative.</span>
<a href="#l12.3631"></a><span id="l12.3631" class="difflineplus">+    mRowPos = numRows;  // startPos is 0 relative.</span>
<a href="#l12.3632"></a><span id="l12.3632">   }</span>
<a href="#l12.3633"></a><span id="l12.3633" class="difflineminus">-  return mTable-&gt;GetTableRowCursor(mDB-&gt;GetEnv(), mRowPos, getter_AddRefs(mRowCursor));</span>
<a href="#l12.3634"></a><span id="l12.3634" class="difflineminus">-}</span>
<a href="#l12.3635"></a><span id="l12.3635" class="difflineminus">-</span>
<a href="#l12.3636"></a><span id="l12.3636" class="difflineminus">-NS_IMETHODIMP nsMsgDBEnumerator::GetNext(nsISupports **aItem)</span>
<a href="#l12.3637"></a><span id="l12.3637" class="difflineminus">-{</span>
<a href="#l12.3638"></a><span id="l12.3638" class="difflineminus">-  if (!aItem)</span>
<a href="#l12.3639"></a><span id="l12.3639" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.3640"></a><span id="l12.3640" class="difflineplus">+  return mTable-&gt;GetTableRowCursor(mDB-&gt;GetEnv(), mRowPos,</span>
<a href="#l12.3641"></a><span id="l12.3641" class="difflineplus">+                                   getter_AddRefs(mRowCursor));</span>
<a href="#l12.3642"></a><span id="l12.3642" class="difflineplus">+}</span>
<a href="#l12.3643"></a><span id="l12.3643" class="difflineplus">+</span>
<a href="#l12.3644"></a><span id="l12.3644" class="difflineplus">+NS_IMETHODIMP nsMsgDBEnumerator::GetNext(nsISupports **aItem) {</span>
<a href="#l12.3645"></a><span id="l12.3645" class="difflineplus">+  if (!aItem) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.3646"></a><span id="l12.3646">   nsresult rv = NS_OK;</span>
<a href="#l12.3647"></a><span id="l12.3647" class="difflineminus">-  if (!mNextPrefetched)</span>
<a href="#l12.3648"></a><span id="l12.3648" class="difflineminus">-    rv = PrefetchNext();</span>
<a href="#l12.3649"></a><span id="l12.3649" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l12.3650"></a><span id="l12.3650" class="difflineminus">-  {</span>
<a href="#l12.3651"></a><span id="l12.3651" class="difflineminus">-    if (mResultHdr)</span>
<a href="#l12.3652"></a><span id="l12.3652" class="difflineminus">-    {</span>
<a href="#l12.3653"></a><span id="l12.3653" class="difflineplus">+  if (!mNextPrefetched) rv = PrefetchNext();</span>
<a href="#l12.3654"></a><span id="l12.3654" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.3655"></a><span id="l12.3655" class="difflineplus">+    if (mResultHdr) {</span>
<a href="#l12.3656"></a><span id="l12.3656">       NS_ADDREF(*aItem = mResultHdr);</span>
<a href="#l12.3657"></a><span id="l12.3657">       mNextPrefetched = false;</span>
<a href="#l12.3658"></a><span id="l12.3658">     }</span>
<a href="#l12.3659"></a><span id="l12.3659">   }</span>
<a href="#l12.3660"></a><span id="l12.3660">   return rv;</span>
<a href="#l12.3661"></a><span id="l12.3661"> }</span>
<a href="#l12.3662"></a><span id="l12.3662"> </span>
<a href="#l12.3663"></a><span id="l12.3663" class="difflineminus">-nsresult nsMsgDBEnumerator::PrefetchNext()</span>
<a href="#l12.3664"></a><span id="l12.3664" class="difflineminus">-{</span>
<a href="#l12.3665"></a><span id="l12.3665" class="difflineplus">+nsresult nsMsgDBEnumerator::PrefetchNext() {</span>
<a href="#l12.3666"></a><span id="l12.3666">   nsresult rv = NS_OK;</span>
<a href="#l12.3667"></a><span id="l12.3667" class="difflineminus">-  nsIMdbRow* hdrRow;</span>
<a href="#l12.3668"></a><span id="l12.3668" class="difflineplus">+  nsIMdbRow *hdrRow;</span>
<a href="#l12.3669"></a><span id="l12.3669">   uint32_t flags;</span>
<a href="#l12.3670"></a><span id="l12.3670"> </span>
<a href="#l12.3671"></a><span id="l12.3671" class="difflineminus">-  if (!mRowCursor)</span>
<a href="#l12.3672"></a><span id="l12.3672" class="difflineminus">-  {</span>
<a href="#l12.3673"></a><span id="l12.3673" class="difflineplus">+  if (!mRowCursor) {</span>
<a href="#l12.3674"></a><span id="l12.3674">     rv = GetRowCursor();</span>
<a href="#l12.3675"></a><span id="l12.3675" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.3676"></a><span id="l12.3676" class="difflineminus">-      return rv;</span>
<a href="#l12.3677"></a><span id="l12.3677" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.3678"></a><span id="l12.3678">   }</span>
<a href="#l12.3679"></a><span id="l12.3679"> </span>
<a href="#l12.3680"></a><span id="l12.3680" class="difflineminus">-  do</span>
<a href="#l12.3681"></a><span id="l12.3681" class="difflineminus">-  {</span>
<a href="#l12.3682"></a><span id="l12.3682" class="difflineplus">+  do {</span>
<a href="#l12.3683"></a><span id="l12.3683">     mResultHdr = nullptr;</span>
<a href="#l12.3684"></a><span id="l12.3684">     if (mIterateForwards)</span>
<a href="#l12.3685"></a><span id="l12.3685">       rv = mRowCursor-&gt;NextRow(mDB-&gt;GetEnv(), &amp;hdrRow, &amp;mRowPos);</span>
<a href="#l12.3686"></a><span id="l12.3686">     else</span>
<a href="#l12.3687"></a><span id="l12.3687">       rv = mRowCursor-&gt;PrevRow(mDB-&gt;GetEnv(), &amp;hdrRow, &amp;mRowPos);</span>
<a href="#l12.3688"></a><span id="l12.3688" class="difflineminus">-    if (!hdrRow)</span>
<a href="#l12.3689"></a><span id="l12.3689" class="difflineminus">-    {</span>
<a href="#l12.3690"></a><span id="l12.3690" class="difflineplus">+    if (!hdrRow) {</span>
<a href="#l12.3691"></a><span id="l12.3691">       mDone = true;</span>
<a href="#l12.3692"></a><span id="l12.3692">       return NS_ERROR_FAILURE;</span>
<a href="#l12.3693"></a><span id="l12.3693">     }</span>
<a href="#l12.3694"></a><span id="l12.3694" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.3695"></a><span id="l12.3695" class="difflineminus">-    {</span>
<a href="#l12.3696"></a><span id="l12.3696" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l12.3697"></a><span id="l12.3697">       mDone = true;</span>
<a href="#l12.3698"></a><span id="l12.3698">       return rv;</span>
<a href="#l12.3699"></a><span id="l12.3699">     }</span>
<a href="#l12.3700"></a><span id="l12.3700" class="difflineminus">-    //Get key from row</span>
<a href="#l12.3701"></a><span id="l12.3701" class="difflineplus">+    // Get key from row</span>
<a href="#l12.3702"></a><span id="l12.3702">     mdbOid outOid;</span>
<a href="#l12.3703"></a><span id="l12.3703">     nsMsgKey key = nsMsgKey_None;</span>
<a href="#l12.3704"></a><span id="l12.3704">     rv = hdrRow-&gt;GetOid(mDB-&gt;GetEnv(), &amp;outOid);</span>
<a href="#l12.3705"></a><span id="l12.3705" class="difflineminus">-    if (NS_WARN_IF(NS_FAILED(rv)))</span>
<a href="#l12.3706"></a><span id="l12.3706" class="difflineminus">-      return rv;</span>
<a href="#l12.3707"></a><span id="l12.3707" class="difflineplus">+    if (NS_WARN_IF(NS_FAILED(rv))) return rv;</span>
<a href="#l12.3708"></a><span id="l12.3708">     key = outOid.mOid_Id;</span>
<a href="#l12.3709"></a><span id="l12.3709"> </span>
<a href="#l12.3710"></a><span id="l12.3710">     rv = mDB-&gt;GetHdrFromUseCache(key, getter_AddRefs(mResultHdr));</span>
<a href="#l12.3711"></a><span id="l12.3711">     if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr)</span>
<a href="#l12.3712"></a><span id="l12.3712">       hdrRow-&gt;Release();</span>
<a href="#l12.3713"></a><span id="l12.3713">     else {</span>
<a href="#l12.3714"></a><span id="l12.3714">       rv = mDB-&gt;CreateMsgHdr(hdrRow, key, getter_AddRefs(mResultHdr));</span>
<a href="#l12.3715"></a><span id="l12.3715" class="difflineminus">-      if (NS_WARN_IF(NS_FAILED(rv)))</span>
<a href="#l12.3716"></a><span id="l12.3716" class="difflineminus">-        return rv;</span>
<a href="#l12.3717"></a><span id="l12.3717" class="difflineplus">+      if (NS_WARN_IF(NS_FAILED(rv))) return rv;</span>
<a href="#l12.3718"></a><span id="l12.3718">     }</span>
<a href="#l12.3719"></a><span id="l12.3719"> </span>
<a href="#l12.3720"></a><span id="l12.3720">     if (mResultHdr)</span>
<a href="#l12.3721"></a><span id="l12.3721">       mResultHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l12.3722"></a><span id="l12.3722">     else</span>
<a href="#l12.3723"></a><span id="l12.3723">       flags = 0;</span>
<a href="#l12.3724"></a><span id="l12.3724" class="difflineminus">-  }</span>
<a href="#l12.3725"></a><span id="l12.3725" class="difflineminus">-  while (mFilter &amp;&amp; NS_FAILED(mFilter(mResultHdr, mClosure)) &amp;&amp; !(flags &amp; nsMsgMessageFlags::Expunged));</span>
<a href="#l12.3726"></a><span id="l12.3726" class="difflineminus">-</span>
<a href="#l12.3727"></a><span id="l12.3727" class="difflineminus">-  if (mResultHdr)</span>
<a href="#l12.3728"></a><span id="l12.3728" class="difflineminus">-  {</span>
<a href="#l12.3729"></a><span id="l12.3729" class="difflineplus">+  } while (mFilter &amp;&amp; NS_FAILED(mFilter(mResultHdr, mClosure)) &amp;&amp;</span>
<a href="#l12.3730"></a><span id="l12.3730" class="difflineplus">+           !(flags &amp; nsMsgMessageFlags::Expunged));</span>
<a href="#l12.3731"></a><span id="l12.3731" class="difflineplus">+</span>
<a href="#l12.3732"></a><span id="l12.3732" class="difflineplus">+  if (mResultHdr) {</span>
<a href="#l12.3733"></a><span id="l12.3733">     mNextPrefetched = true;</span>
<a href="#l12.3734"></a><span id="l12.3734">     return NS_OK;</span>
<a href="#l12.3735"></a><span id="l12.3735" class="difflineminus">-  }</span>
<a href="#l12.3736"></a><span id="l12.3736" class="difflineminus">-  else</span>
<a href="#l12.3737"></a><span id="l12.3737" class="difflineplus">+  } else</span>
<a href="#l12.3738"></a><span id="l12.3738">     mNextPrefetched = false;</span>
<a href="#l12.3739"></a><span id="l12.3739">   return NS_ERROR_FAILURE;</span>
<a href="#l12.3740"></a><span id="l12.3740"> }</span>
<a href="#l12.3741"></a><span id="l12.3741"> </span>
<a href="#l12.3742"></a><span id="l12.3742" class="difflineminus">-NS_IMETHODIMP nsMsgDBEnumerator::HasMoreElements(bool *aResult)</span>
<a href="#l12.3743"></a><span id="l12.3743" class="difflineminus">-{</span>
<a href="#l12.3744"></a><span id="l12.3744" class="difflineminus">-  if (!aResult)</span>
<a href="#l12.3745"></a><span id="l12.3745" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.3746"></a><span id="l12.3746" class="difflineminus">-</span>
<a href="#l12.3747"></a><span id="l12.3747" class="difflineminus">-  if (!mNextPrefetched &amp;&amp; (NS_FAILED(PrefetchNext())))</span>
<a href="#l12.3748"></a><span id="l12.3748" class="difflineminus">-    mDone = true;</span>
<a href="#l12.3749"></a><span id="l12.3749" class="difflineplus">+NS_IMETHODIMP nsMsgDBEnumerator::HasMoreElements(bool *aResult) {</span>
<a href="#l12.3750"></a><span id="l12.3750" class="difflineplus">+  if (!aResult) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.3751"></a><span id="l12.3751" class="difflineplus">+</span>
<a href="#l12.3752"></a><span id="l12.3752" class="difflineplus">+  if (!mNextPrefetched &amp;&amp; (NS_FAILED(PrefetchNext()))) mDone = true;</span>
<a href="#l12.3753"></a><span id="l12.3753">   *aResult = !mDone;</span>
<a href="#l12.3754"></a><span id="l12.3754">   return NS_OK;</span>
<a href="#l12.3755"></a><span id="l12.3755"> }</span>
<a href="#l12.3756"></a><span id="l12.3756"> </span>
<a href="#l12.3757"></a><span id="l12.3757" class="difflineminus">-nsMsgFilteredDBEnumerator::nsMsgFilteredDBEnumerator(nsMsgDatabase* db,</span>
<a href="#l12.3758"></a><span id="l12.3758" class="difflineplus">+nsMsgFilteredDBEnumerator::nsMsgFilteredDBEnumerator(nsMsgDatabase *db,</span>
<a href="#l12.3759"></a><span id="l12.3759">                                                      nsIMdbTable *table,</span>
<a href="#l12.3760"></a><span id="l12.3760">                                                      bool reverse,</span>
<a href="#l12.3761"></a><span id="l12.3761">                                                      nsIArray *searchTerms)</span>
<a href="#l12.3762"></a><span id="l12.3762" class="difflineminus">-   : nsMsgDBEnumerator(db, table, nullptr, nullptr, !reverse)</span>
<a href="#l12.3763"></a><span id="l12.3763" class="difflineminus">-{</span>
<a href="#l12.3764"></a><span id="l12.3764" class="difflineminus">-}</span>
<a href="#l12.3765"></a><span id="l12.3765" class="difflineminus">-</span>
<a href="#l12.3766"></a><span id="l12.3766" class="difflineminus">-nsMsgFilteredDBEnumerator::~nsMsgFilteredDBEnumerator()</span>
<a href="#l12.3767"></a><span id="l12.3767" class="difflineminus">-{</span>
<a href="#l12.3768"></a><span id="l12.3768" class="difflineminus">-}</span>
<a href="#l12.3769"></a><span id="l12.3769" class="difflineplus">+    : nsMsgDBEnumerator(db, table, nullptr, nullptr, !reverse) {}</span>
<a href="#l12.3770"></a><span id="l12.3770" class="difflineplus">+</span>
<a href="#l12.3771"></a><span id="l12.3771" class="difflineplus">+nsMsgFilteredDBEnumerator::~nsMsgFilteredDBEnumerator() {}</span>
<a href="#l12.3772"></a><span id="l12.3772"> </span>
<a href="#l12.3773"></a><span id="l12.3773"> /**</span>
<a href="#l12.3774"></a><span id="l12.3774">  * Create the search session for the enumerator,</span>
<a href="#l12.3775"></a><span id="l12.3775">  * add the scope term for &quot;folder&quot; to the search session, and add the search</span>
<a href="#l12.3776"></a><span id="l12.3776">  * terms in the array to the search session.</span>
<a href="#l12.3777"></a><span id="l12.3777">  */</span>
<a href="#l12.3778"></a><span id="l12.3778" class="difflineminus">-nsresult nsMsgFilteredDBEnumerator::InitSearchSession(nsIArray *searchTerms, nsIMsgFolder *folder)</span>
<a href="#l12.3779"></a><span id="l12.3779" class="difflineminus">-{</span>
<a href="#l12.3780"></a><span id="l12.3780" class="difflineplus">+nsresult nsMsgFilteredDBEnumerator::InitSearchSession(nsIArray *searchTerms,</span>
<a href="#l12.3781"></a><span id="l12.3781" class="difflineplus">+                                                      nsIMsgFolder *folder) {</span>
<a href="#l12.3782"></a><span id="l12.3782">   nsresult rv;</span>
<a href="#l12.3783"></a><span id="l12.3783">   m_searchSession = do_CreateInstance(NS_MSGSEARCHSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l12.3784"></a><span id="l12.3784">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3785"></a><span id="l12.3785"> </span>
<a href="#l12.3786"></a><span id="l12.3786">   m_searchSession-&gt;AddScopeTerm(nsMsgSearchScope::offlineMail, folder);</span>
<a href="#l12.3787"></a><span id="l12.3787">   // add each item in termsArray to the search session</span>
<a href="#l12.3788"></a><span id="l12.3788">   uint32_t numTerms;</span>
<a href="#l12.3789"></a><span id="l12.3789">   rv = searchTerms-&gt;GetLength(&amp;numTerms);</span>
<a href="#l12.3790"></a><span id="l12.3790">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3791"></a><span id="l12.3791" class="difflineminus">-  for (uint32_t i = 0; i &lt; numTerms; i++)</span>
<a href="#l12.3792"></a><span id="l12.3792" class="difflineminus">-  {</span>
<a href="#l12.3793"></a><span id="l12.3793" class="difflineplus">+  for (uint32_t i = 0; i &lt; numTerms; i++) {</span>
<a href="#l12.3794"></a><span id="l12.3794">     nsCOMPtr&lt;nsIMsgSearchTerm&gt; searchTerm = do_QueryElementAt(searchTerms, i);</span>
<a href="#l12.3795"></a><span id="l12.3795">     m_searchSession-&gt;AppendTerm(searchTerm);</span>
<a href="#l12.3796"></a><span id="l12.3796">   }</span>
<a href="#l12.3797"></a><span id="l12.3797">   return NS_OK;</span>
<a href="#l12.3798"></a><span id="l12.3798"> }</span>
<a href="#l12.3799"></a><span id="l12.3799"> </span>
<a href="#l12.3800"></a><span id="l12.3800" class="difflineminus">-nsresult nsMsgFilteredDBEnumerator::PrefetchNext()</span>
<a href="#l12.3801"></a><span id="l12.3801" class="difflineminus">-{</span>
<a href="#l12.3802"></a><span id="l12.3802" class="difflineplus">+nsresult nsMsgFilteredDBEnumerator::PrefetchNext() {</span>
<a href="#l12.3803"></a><span id="l12.3803">   nsresult rv;</span>
<a href="#l12.3804"></a><span id="l12.3804" class="difflineminus">-  do</span>
<a href="#l12.3805"></a><span id="l12.3805" class="difflineminus">-  {</span>
<a href="#l12.3806"></a><span id="l12.3806" class="difflineplus">+  do {</span>
<a href="#l12.3807"></a><span id="l12.3807">     rv = nsMsgDBEnumerator::PrefetchNext();</span>
<a href="#l12.3808"></a><span id="l12.3808" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr)</span>
<a href="#l12.3809"></a><span id="l12.3809" class="difflineminus">-    {</span>
<a href="#l12.3810"></a><span id="l12.3810" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr) {</span>
<a href="#l12.3811"></a><span id="l12.3811">       bool matches;</span>
<a href="#l12.3812"></a><span id="l12.3812" class="difflineminus">-      rv  = m_searchSession-&gt;MatchHdr(mResultHdr, mDB, &amp;matches);</span>
<a href="#l12.3813"></a><span id="l12.3813" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; matches)</span>
<a href="#l12.3814"></a><span id="l12.3814" class="difflineminus">-        break;</span>
<a href="#l12.3815"></a><span id="l12.3815" class="difflineplus">+      rv = m_searchSession-&gt;MatchHdr(mResultHdr, mDB, &amp;matches);</span>
<a href="#l12.3816"></a><span id="l12.3816" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; matches) break;</span>
<a href="#l12.3817"></a><span id="l12.3817">       mResultHdr = nullptr;</span>
<a href="#l12.3818"></a><span id="l12.3818" class="difflineminus">-    }</span>
<a href="#l12.3819"></a><span id="l12.3819" class="difflineminus">-    else</span>
<a href="#l12.3820"></a><span id="l12.3820" class="difflineplus">+    } else</span>
<a href="#l12.3821"></a><span id="l12.3821">       break;</span>
<a href="#l12.3822"></a><span id="l12.3822">   } while (mStopPos == -1 || mRowPos != mStopPos);</span>
<a href="#l12.3823"></a><span id="l12.3823"> </span>
<a href="#l12.3824"></a><span id="l12.3824" class="difflineminus">-  if (!mResultHdr)</span>
<a href="#l12.3825"></a><span id="l12.3825" class="difflineminus">-    mNextPrefetched = false;</span>
<a href="#l12.3826"></a><span id="l12.3826" class="difflineplus">+  if (!mResultHdr) mNextPrefetched = false;</span>
<a href="#l12.3827"></a><span id="l12.3827"> </span>
<a href="#l12.3828"></a><span id="l12.3828">   return rv;</span>
<a href="#l12.3829"></a><span id="l12.3829"> }</span>
<a href="#l12.3830"></a><span id="l12.3830"> </span>
<a href="#l12.3831"></a><span id="l12.3831" class="difflineminus">-</span>
<a href="#l12.3832"></a><span id="l12.3832"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l12.3833"></a><span id="l12.3833"> </span>
<a href="#l12.3834"></a><span id="l12.3834"> NS_IMETHODIMP</span>
<a href="#l12.3835"></a><span id="l12.3835" class="difflineminus">-nsMsgDatabase::EnumerateMessages(nsISimpleEnumerator* *result)</span>
<a href="#l12.3836"></a><span id="l12.3836" class="difflineminus">-{</span>
<a href="#l12.3837"></a><span id="l12.3837" class="difflineplus">+nsMsgDatabase::EnumerateMessages(nsISimpleEnumerator **result) {</span>
<a href="#l12.3838"></a><span id="l12.3838">   RememberLastUseTime();</span>
<a href="#l12.3839"></a><span id="l12.3839">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l12.3840"></a><span id="l12.3840">   NS_ADDREF(*result = new nsMsgDBEnumerator(this, m_mdbAllMsgHeadersTable,</span>
<a href="#l12.3841"></a><span id="l12.3841">                                             nullptr, nullptr));</span>
<a href="#l12.3842"></a><span id="l12.3842">   return NS_OK;</span>
<a href="#l12.3843"></a><span id="l12.3843"> }</span>
<a href="#l12.3844"></a><span id="l12.3844"> </span>
<a href="#l12.3845"></a><span id="l12.3845"> NS_IMETHODIMP</span>
<a href="#l12.3846"></a><span id="l12.3846" class="difflineminus">-nsMsgDatabase::ReverseEnumerateMessages(nsISimpleEnumerator* *result)</span>
<a href="#l12.3847"></a><span id="l12.3847" class="difflineminus">-{</span>
<a href="#l12.3848"></a><span id="l12.3848" class="difflineplus">+nsMsgDatabase::ReverseEnumerateMessages(nsISimpleEnumerator **result) {</span>
<a href="#l12.3849"></a><span id="l12.3849">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l12.3850"></a><span id="l12.3850">   NS_ADDREF(*result = new nsMsgDBEnumerator(this, m_mdbAllMsgHeadersTable,</span>
<a href="#l12.3851"></a><span id="l12.3851">                                             nullptr, nullptr, false));</span>
<a href="#l12.3852"></a><span id="l12.3852">   return NS_OK;</span>
<a href="#l12.3853"></a><span id="l12.3853"> }</span>
<a href="#l12.3854"></a><span id="l12.3854"> </span>
<a href="#l12.3855"></a><span id="l12.3855"> NS_IMETHODIMP</span>
<a href="#l12.3856"></a><span id="l12.3856"> nsMsgDatabase::GetFilterEnumerator(nsIArray *searchTerms, bool aReverse,</span>
<a href="#l12.3857"></a><span id="l12.3857" class="difflineminus">-                                   nsISimpleEnumerator **aResult)</span>
<a href="#l12.3858"></a><span id="l12.3858" class="difflineminus">-{</span>
<a href="#l12.3859"></a><span id="l12.3859" class="difflineplus">+                                   nsISimpleEnumerator **aResult) {</span>
<a href="#l12.3860"></a><span id="l12.3860">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l12.3861"></a><span id="l12.3861" class="difflineminus">-  RefPtr&lt;nsMsgFilteredDBEnumerator&gt; e =</span>
<a href="#l12.3862"></a><span id="l12.3862" class="difflineminus">-    new nsMsgFilteredDBEnumerator(this, m_mdbAllMsgHeadersTable, aReverse,</span>
<a href="#l12.3863"></a><span id="l12.3863" class="difflineminus">-                                  searchTerms);</span>
<a href="#l12.3864"></a><span id="l12.3864" class="difflineplus">+  RefPtr&lt;nsMsgFilteredDBEnumerator&gt; e = new nsMsgFilteredDBEnumerator(</span>
<a href="#l12.3865"></a><span id="l12.3865" class="difflineplus">+      this, m_mdbAllMsgHeadersTable, aReverse, searchTerms);</span>
<a href="#l12.3866"></a><span id="l12.3866"> </span>
<a href="#l12.3867"></a><span id="l12.3867">   NS_ENSURE_TRUE(e, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l12.3868"></a><span id="l12.3868">   nsresult rv = e-&gt;InitSearchSession(searchTerms, m_folder);</span>
<a href="#l12.3869"></a><span id="l12.3869">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.3870"></a><span id="l12.3870"> </span>
<a href="#l12.3871"></a><span id="l12.3871">   e.forget(aResult);</span>
<a href="#l12.3872"></a><span id="l12.3872">   return NS_OK;</span>
<a href="#l12.3873"></a><span id="l12.3873"> }</span>
<a href="#l12.3874"></a><span id="l12.3874"> </span>
<a href="#l12.3875"></a><span id="l12.3875"> NS_IMETHODIMP</span>
<a href="#l12.3876"></a><span id="l12.3876"> nsMsgDatabase::NextMatchingHdrs(nsISimpleEnumerator *aEnumerator,</span>
<a href="#l12.3877"></a><span id="l12.3877">                                 int32_t aNumHdrsToLookAt, int32_t aMaxResults,</span>
<a href="#l12.3878"></a><span id="l12.3878">                                 nsIMutableArray *aMatchingHdrs,</span>
<a href="#l12.3879"></a><span id="l12.3879" class="difflineminus">-                                int32_t *aNumMatches, bool *aResult)</span>
<a href="#l12.3880"></a><span id="l12.3880" class="difflineminus">-{</span>
<a href="#l12.3881"></a><span id="l12.3881" class="difflineplus">+                                int32_t *aNumMatches, bool *aResult) {</span>
<a href="#l12.3882"></a><span id="l12.3882">   NS_ENSURE_ARG_POINTER(aEnumerator);</span>
<a href="#l12.3883"></a><span id="l12.3883">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l12.3884"></a><span id="l12.3884">   nsMsgFilteredDBEnumerator *enumerator =</span>
<a href="#l12.3885"></a><span id="l12.3885" class="difflineminus">-    static_cast&lt;nsMsgFilteredDBEnumerator *&gt; (aEnumerator);</span>
<a href="#l12.3886"></a><span id="l12.3886" class="difflineplus">+      static_cast&lt;nsMsgFilteredDBEnumerator *&gt;(aEnumerator);</span>
<a href="#l12.3887"></a><span id="l12.3887"> </span>
<a href="#l12.3888"></a><span id="l12.3888">   // Force mRowPos to be initialized.</span>
<a href="#l12.3889"></a><span id="l12.3889" class="difflineminus">-  if (!enumerator-&gt;mRowCursor)</span>
<a href="#l12.3890"></a><span id="l12.3890" class="difflineminus">-    enumerator-&gt;GetRowCursor();</span>
<a href="#l12.3891"></a><span id="l12.3891" class="difflineminus">-</span>
<a href="#l12.3892"></a><span id="l12.3892" class="difflineminus">-  if (aNumHdrsToLookAt)</span>
<a href="#l12.3893"></a><span id="l12.3893" class="difflineminus">-  {</span>
<a href="#l12.3894"></a><span id="l12.3894" class="difflineminus">-    enumerator-&gt;mStopPos = enumerator-&gt;mIterateForwards ?</span>
<a href="#l12.3895"></a><span id="l12.3895" class="difflineminus">-      enumerator-&gt;mRowPos + aNumHdrsToLookAt :</span>
<a href="#l12.3896"></a><span id="l12.3896" class="difflineminus">-      enumerator-&gt;mRowPos - aNumHdrsToLookAt;</span>
<a href="#l12.3897"></a><span id="l12.3897" class="difflineminus">-    if (enumerator-&gt;mStopPos &lt; 0)</span>
<a href="#l12.3898"></a><span id="l12.3898" class="difflineminus">-      enumerator-&gt;mStopPos = 0;</span>
<a href="#l12.3899"></a><span id="l12.3899" class="difflineplus">+  if (!enumerator-&gt;mRowCursor) enumerator-&gt;GetRowCursor();</span>
<a href="#l12.3900"></a><span id="l12.3900" class="difflineplus">+</span>
<a href="#l12.3901"></a><span id="l12.3901" class="difflineplus">+  if (aNumHdrsToLookAt) {</span>
<a href="#l12.3902"></a><span id="l12.3902" class="difflineplus">+    enumerator-&gt;mStopPos = enumerator-&gt;mIterateForwards</span>
<a href="#l12.3903"></a><span id="l12.3903" class="difflineplus">+                               ? enumerator-&gt;mRowPos + aNumHdrsToLookAt</span>
<a href="#l12.3904"></a><span id="l12.3904" class="difflineplus">+                               : enumerator-&gt;mRowPos - aNumHdrsToLookAt;</span>
<a href="#l12.3905"></a><span id="l12.3905" class="difflineplus">+    if (enumerator-&gt;mStopPos &lt; 0) enumerator-&gt;mStopPos = 0;</span>
<a href="#l12.3906"></a><span id="l12.3906">   }</span>
<a href="#l12.3907"></a><span id="l12.3907">   int32_t numMatches = 0;</span>
<a href="#l12.3908"></a><span id="l12.3908">   nsresult rv;</span>
<a href="#l12.3909"></a><span id="l12.3909" class="difflineminus">-  do</span>
<a href="#l12.3910"></a><span id="l12.3910" class="difflineminus">-  {</span>
<a href="#l12.3911"></a><span id="l12.3911" class="difflineminus">-    nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l12.3912"></a><span id="l12.3912" class="difflineplus">+  do {</span>
<a href="#l12.3913"></a><span id="l12.3913" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l12.3914"></a><span id="l12.3914">     rv = enumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l12.3915"></a><span id="l12.3915" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; nextMessage = do_QueryInterface(supports);</span>
<a href="#l12.3916"></a><span id="l12.3916" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; nextMessage)</span>
<a href="#l12.3917"></a><span id="l12.3917" class="difflineminus">-    {</span>
<a href="#l12.3918"></a><span id="l12.3918" class="difflineminus">-      if (aMatchingHdrs)</span>
<a href="#l12.3919"></a><span id="l12.3919" class="difflineminus">-        aMatchingHdrs-&gt;AppendElement(nextMessage);</span>
<a href="#l12.3920"></a><span id="l12.3920" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; nextMessage = do_QueryInterface(supports);</span>
<a href="#l12.3921"></a><span id="l12.3921" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; nextMessage) {</span>
<a href="#l12.3922"></a><span id="l12.3922" class="difflineplus">+      if (aMatchingHdrs) aMatchingHdrs-&gt;AppendElement(nextMessage);</span>
<a href="#l12.3923"></a><span id="l12.3923">       ++numMatches;</span>
<a href="#l12.3924"></a><span id="l12.3924" class="difflineminus">-      if (aMaxResults &amp;&amp; numMatches == aMaxResults)</span>
<a href="#l12.3925"></a><span id="l12.3925" class="difflineminus">-        break;</span>
<a href="#l12.3926"></a><span id="l12.3926" class="difflineminus">-    }</span>
<a href="#l12.3927"></a><span id="l12.3927" class="difflineminus">-    else</span>
<a href="#l12.3928"></a><span id="l12.3928" class="difflineplus">+      if (aMaxResults &amp;&amp; numMatches == aMaxResults) break;</span>
<a href="#l12.3929"></a><span id="l12.3929" class="difflineplus">+    } else</span>
<a href="#l12.3930"></a><span id="l12.3930">       break;</span>
<a href="#l12.3931"></a><span id="l12.3931" class="difflineminus">-  }</span>
<a href="#l12.3932"></a><span id="l12.3932" class="difflineminus">-  while (true);</span>
<a href="#l12.3933"></a><span id="l12.3933" class="difflineminus">-</span>
<a href="#l12.3934"></a><span id="l12.3934" class="difflineminus">-  if (aNumMatches)</span>
<a href="#l12.3935"></a><span id="l12.3935" class="difflineminus">-    *aNumMatches = numMatches;</span>
<a href="#l12.3936"></a><span id="l12.3936" class="difflineplus">+  } while (true);</span>
<a href="#l12.3937"></a><span id="l12.3937" class="difflineplus">+</span>
<a href="#l12.3938"></a><span id="l12.3938" class="difflineplus">+  if (aNumMatches) *aNumMatches = numMatches;</span>
<a href="#l12.3939"></a><span id="l12.3939"> </span>
<a href="#l12.3940"></a><span id="l12.3940">   *aResult = !enumerator-&gt;mDone;</span>
<a href="#l12.3941"></a><span id="l12.3941">   return NS_OK;</span>
<a href="#l12.3942"></a><span id="l12.3942"> }</span>
<a href="#l12.3943"></a><span id="l12.3943"> </span>
<a href="#l12.3944"></a><span id="l12.3944"> NS_IMETHODIMP</span>
<a href="#l12.3945"></a><span id="l12.3945" class="difflineminus">-nsMsgDatabase::SyncCounts()</span>
<a href="#l12.3946"></a><span id="l12.3946" class="difflineminus">-{</span>
<a href="#l12.3947"></a><span id="l12.3947" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l12.3948"></a><span id="l12.3948" class="difflineplus">+nsMsgDatabase::SyncCounts() {</span>
<a href="#l12.3949"></a><span id="l12.3949" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l12.3950"></a><span id="l12.3950">   nsresult rv = EnumerateMessages(getter_AddRefs(hdrs));</span>
<a href="#l12.3951"></a><span id="l12.3951" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.3952"></a><span id="l12.3952" class="difflineminus">-    return rv;</span>
<a href="#l12.3953"></a><span id="l12.3953" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.3954"></a><span id="l12.3954">   bool hasMore = false;</span>
<a href="#l12.3955"></a><span id="l12.3955"> </span>
<a href="#l12.3956"></a><span id="l12.3956">   mdb_count numHdrsInTable = 0;</span>
<a href="#l12.3957"></a><span id="l12.3957">   int32_t numUnread = 0;</span>
<a href="#l12.3958"></a><span id="l12.3958">   int32_t numHdrs = 0;</span>
<a href="#l12.3959"></a><span id="l12.3959"> </span>
<a href="#l12.3960"></a><span id="l12.3960">   if (m_mdbAllMsgHeadersTable)</span>
<a href="#l12.3961"></a><span id="l12.3961">     m_mdbAllMsgHeadersTable-&gt;GetCount(GetEnv(), &amp;numHdrsInTable);</span>
<a href="#l12.3962"></a><span id="l12.3962">   else</span>
<a href="#l12.3963"></a><span id="l12.3963">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.3964"></a><span id="l12.3964"> </span>
<a href="#l12.3965"></a><span id="l12.3965" class="difflineminus">-  while (NS_SUCCEEDED(rv = hdrs-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l12.3966"></a><span id="l12.3966" class="difflineminus">-  {</span>
<a href="#l12.3967"></a><span id="l12.3967" class="difflineminus">-    nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l12.3968"></a><span id="l12.3968" class="difflineplus">+  while (NS_SUCCEEDED(rv = hdrs-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l12.3969"></a><span id="l12.3969" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l12.3970"></a><span id="l12.3970">     rv = hdrs-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l12.3971"></a><span id="l12.3971">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;nsMsgDBEnumerator broken&quot;);</span>
<a href="#l12.3972"></a><span id="l12.3972" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.3973"></a><span id="l12.3973" class="difflineminus">-      break;</span>
<a href="#l12.3974"></a><span id="l12.3974" class="difflineminus">-</span>
<a href="#l12.3975"></a><span id="l12.3975" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; pHeader = do_QueryInterface(supports);</span>
<a href="#l12.3976"></a><span id="l12.3976" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l12.3977"></a><span id="l12.3977" class="difflineplus">+</span>
<a href="#l12.3978"></a><span id="l12.3978" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; pHeader = do_QueryInterface(supports);</span>
<a href="#l12.3979"></a><span id="l12.3979"> </span>
<a href="#l12.3980"></a><span id="l12.3980">     bool isRead;</span>
<a href="#l12.3981"></a><span id="l12.3981">     IsHeaderRead(pHeader, &amp;isRead);</span>
<a href="#l12.3982"></a><span id="l12.3982" class="difflineminus">-    if (!isRead)</span>
<a href="#l12.3983"></a><span id="l12.3983" class="difflineminus">-      numUnread++;</span>
<a href="#l12.3984"></a><span id="l12.3984" class="difflineplus">+    if (!isRead) numUnread++;</span>
<a href="#l12.3985"></a><span id="l12.3985">     numHdrs++;</span>
<a href="#l12.3986"></a><span id="l12.3986">   }</span>
<a href="#l12.3987"></a><span id="l12.3987"> </span>
<a href="#l12.3988"></a><span id="l12.3988">   int32_t oldTotal, oldUnread;</span>
<a href="#l12.3989"></a><span id="l12.3989" class="difflineminus">-  (void) m_dbFolderInfo-&gt;GetNumUnreadMessages(&amp;oldUnread);</span>
<a href="#l12.3990"></a><span id="l12.3990" class="difflineminus">-  (void) m_dbFolderInfo-&gt;GetNumMessages(&amp;oldTotal);</span>
<a href="#l12.3991"></a><span id="l12.3991" class="difflineplus">+  (void)m_dbFolderInfo-&gt;GetNumUnreadMessages(&amp;oldUnread);</span>
<a href="#l12.3992"></a><span id="l12.3992" class="difflineplus">+  (void)m_dbFolderInfo-&gt;GetNumMessages(&amp;oldTotal);</span>
<a href="#l12.3993"></a><span id="l12.3993">   if (oldUnread != numUnread)</span>
<a href="#l12.3994"></a><span id="l12.3994">     m_dbFolderInfo-&gt;ChangeNumUnreadMessages(numUnread - oldUnread);</span>
<a href="#l12.3995"></a><span id="l12.3995">   if (oldTotal != numHdrs)</span>
<a href="#l12.3996"></a><span id="l12.3996">     m_dbFolderInfo-&gt;ChangeNumMessages(numHdrs - oldTotal);</span>
<a href="#l12.3997"></a><span id="l12.3997">   return NS_OK;</span>
<a href="#l12.3998"></a><span id="l12.3998"> }</span>
<a href="#l12.3999"></a><span id="l12.3999"> </span>
<a href="#l12.4000"></a><span id="l12.4000" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::ListAllKeys(nsIMsgKeyArray *aKeys)</span>
<a href="#l12.4001"></a><span id="l12.4001" class="difflineminus">-{</span>
<a href="#l12.4002"></a><span id="l12.4002" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::ListAllKeys(nsIMsgKeyArray *aKeys) {</span>
<a href="#l12.4003"></a><span id="l12.4003">   NS_ENSURE_ARG_POINTER(aKeys);</span>
<a href="#l12.4004"></a><span id="l12.4004" class="difflineminus">-  nsresult  rv = NS_OK;</span>
<a href="#l12.4005"></a><span id="l12.4005" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l12.4006"></a><span id="l12.4006">   nsCOMPtr&lt;nsIMdbTableRowCursor&gt; rowCursor;</span>
<a href="#l12.4007"></a><span id="l12.4007"> </span>
<a href="#l12.4008"></a><span id="l12.4008">   RememberLastUseTime();</span>
<a href="#l12.4009"></a><span id="l12.4009"> </span>
<a href="#l12.4010"></a><span id="l12.4010" class="difflineminus">-  if (m_mdbAllMsgHeadersTable)</span>
<a href="#l12.4011"></a><span id="l12.4011" class="difflineminus">-  {</span>
<a href="#l12.4012"></a><span id="l12.4012" class="difflineplus">+  if (m_mdbAllMsgHeadersTable) {</span>
<a href="#l12.4013"></a><span id="l12.4013">     uint32_t numMsgs = 0;</span>
<a href="#l12.4014"></a><span id="l12.4014">     m_mdbAllMsgHeadersTable-&gt;GetCount(GetEnv(), &amp;numMsgs);</span>
<a href="#l12.4015"></a><span id="l12.4015">     aKeys-&gt;SetCapacity(numMsgs);</span>
<a href="#l12.4016"></a><span id="l12.4016">     rv = m_mdbAllMsgHeadersTable-&gt;GetTableRowCursor(GetEnv(), -1,</span>
<a href="#l12.4017"></a><span id="l12.4017" class="difflineminus">-                                                     getter_AddRefs(rowCursor));</span>
<a href="#l12.4018"></a><span id="l12.4018" class="difflineminus">-    while (NS_SUCCEEDED(rv) &amp;&amp; rowCursor)</span>
<a href="#l12.4019"></a><span id="l12.4019" class="difflineminus">-    {</span>
<a href="#l12.4020"></a><span id="l12.4020" class="difflineplus">+                                                    getter_AddRefs(rowCursor));</span>
<a href="#l12.4021"></a><span id="l12.4021" class="difflineplus">+    while (NS_SUCCEEDED(rv) &amp;&amp; rowCursor) {</span>
<a href="#l12.4022"></a><span id="l12.4022">       mdbOid outOid;</span>
<a href="#l12.4023"></a><span id="l12.4023" class="difflineminus">-      mdb_pos  outPos;</span>
<a href="#l12.4024"></a><span id="l12.4024" class="difflineplus">+      mdb_pos outPos;</span>
<a href="#l12.4025"></a><span id="l12.4025"> </span>
<a href="#l12.4026"></a><span id="l12.4026">       rv = rowCursor-&gt;NextRowOid(GetEnv(), &amp;outOid, &amp;outPos);</span>
<a href="#l12.4027"></a><span id="l12.4027">       // is this right? Mork is returning a 0 id, but that should valid.</span>
<a href="#l12.4028"></a><span id="l12.4028" class="difflineminus">-      if (outPos &lt; 0 || outOid.mOid_Id == (mdb_id) -1)</span>
<a href="#l12.4029"></a><span id="l12.4029" class="difflineminus">-        break;</span>
<a href="#l12.4030"></a><span id="l12.4030" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l12.4031"></a><span id="l12.4031" class="difflineminus">-        aKeys-&gt;AppendElement(outOid.mOid_Id);</span>
<a href="#l12.4032"></a><span id="l12.4032" class="difflineplus">+      if (outPos &lt; 0 || outOid.mOid_Id == (mdb_id)-1) break;</span>
<a href="#l12.4033"></a><span id="l12.4033" class="difflineplus">+      if (NS_SUCCEEDED(rv)) aKeys-&gt;AppendElement(outOid.mOid_Id);</span>
<a href="#l12.4034"></a><span id="l12.4034">     }</span>
<a href="#l12.4035"></a><span id="l12.4035">   }</span>
<a href="#l12.4036"></a><span id="l12.4036">   return rv;</span>
<a href="#l12.4037"></a><span id="l12.4037"> }</span>
<a href="#l12.4038"></a><span id="l12.4038"> </span>
<a href="#l12.4039"></a><span id="l12.4039" class="difflineminus">-class nsMsgDBThreadEnumerator : public nsSimpleEnumerator, nsIDBChangeListener</span>
<a href="#l12.4040"></a><span id="l12.4040" class="difflineminus">-{</span>
<a href="#l12.4041"></a><span id="l12.4041" class="difflineminus">-public:</span>
<a href="#l12.4042"></a><span id="l12.4042" class="difflineminus">-    NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l12.4043"></a><span id="l12.4043" class="difflineminus">-</span>
<a href="#l12.4044"></a><span id="l12.4044" class="difflineminus">-    // nsISimpleEnumerator methods:</span>
<a href="#l12.4045"></a><span id="l12.4045" class="difflineminus">-    NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l12.4046"></a><span id="l12.4046" class="difflineminus">-</span>
<a href="#l12.4047"></a><span id="l12.4047" class="difflineminus">-    const nsID&amp; DefaultInterface() override</span>
<a href="#l12.4048"></a><span id="l12.4048" class="difflineminus">-    {</span>
<a href="#l12.4049"></a><span id="l12.4049" class="difflineminus">-      return NS_GET_IID(nsIMsgThread);</span>
<a href="#l12.4050"></a><span id="l12.4050" class="difflineminus">-    }</span>
<a href="#l12.4051"></a><span id="l12.4051" class="difflineminus">-</span>
<a href="#l12.4052"></a><span id="l12.4052" class="difflineminus">-    NS_DECL_NSIDBCHANGELISTENER</span>
<a href="#l12.4053"></a><span id="l12.4053" class="difflineminus">-</span>
<a href="#l12.4054"></a><span id="l12.4054" class="difflineminus">-    // nsMsgDBEnumerator methods:</span>
<a href="#l12.4055"></a><span id="l12.4055" class="difflineminus">-    typedef nsresult (*nsMsgDBThreadEnumeratorFilter)(nsIMsgThread* thread);</span>
<a href="#l12.4056"></a><span id="l12.4056" class="difflineminus">-</span>
<a href="#l12.4057"></a><span id="l12.4057" class="difflineminus">-    nsMsgDBThreadEnumerator(nsMsgDatabase* db, nsMsgDBThreadEnumeratorFilter filter);</span>
<a href="#l12.4058"></a><span id="l12.4058" class="difflineminus">-</span>
<a href="#l12.4059"></a><span id="l12.4059" class="difflineminus">-protected:</span>
<a href="#l12.4060"></a><span id="l12.4060" class="difflineminus">-    ~nsMsgDBThreadEnumerator() override;</span>
<a href="#l12.4061"></a><span id="l12.4061" class="difflineminus">-    nsresult          GetTableCursor(void);</span>
<a href="#l12.4062"></a><span id="l12.4062" class="difflineminus">-    nsresult          PrefetchNext();</span>
<a href="#l12.4063"></a><span id="l12.4063" class="difflineminus">-    nsMsgDatabase*    mDB;</span>
<a href="#l12.4064"></a><span id="l12.4064" class="difflineminus">-    nsCOMPtr&lt;nsIMdbPortTableCursor&gt;  mTableCursor;</span>
<a href="#l12.4065"></a><span id="l12.4065" class="difflineminus">-    RefPtr&lt;nsIMsgThread&gt; mResultThread;</span>
<a href="#l12.4066"></a><span id="l12.4066" class="difflineminus">-    bool              mDone;</span>
<a href="#l12.4067"></a><span id="l12.4067" class="difflineminus">-    bool              mNextPrefetched;</span>
<a href="#l12.4068"></a><span id="l12.4068" class="difflineminus">-    nsMsgDBThreadEnumeratorFilter     mFilter;</span>
<a href="#l12.4069"></a><span id="l12.4069" class="difflineplus">+class nsMsgDBThreadEnumerator : public nsSimpleEnumerator, nsIDBChangeListener {</span>
<a href="#l12.4070"></a><span id="l12.4070" class="difflineplus">+ public:</span>
<a href="#l12.4071"></a><span id="l12.4071" class="difflineplus">+  NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l12.4072"></a><span id="l12.4072" class="difflineplus">+</span>
<a href="#l12.4073"></a><span id="l12.4073" class="difflineplus">+  // nsISimpleEnumerator methods:</span>
<a href="#l12.4074"></a><span id="l12.4074" class="difflineplus">+  NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l12.4075"></a><span id="l12.4075" class="difflineplus">+</span>
<a href="#l12.4076"></a><span id="l12.4076" class="difflineplus">+  const nsID &amp;DefaultInterface() override { return NS_GET_IID(nsIMsgThread); }</span>
<a href="#l12.4077"></a><span id="l12.4077" class="difflineplus">+</span>
<a href="#l12.4078"></a><span id="l12.4078" class="difflineplus">+  NS_DECL_NSIDBCHANGELISTENER</span>
<a href="#l12.4079"></a><span id="l12.4079" class="difflineplus">+</span>
<a href="#l12.4080"></a><span id="l12.4080" class="difflineplus">+  // nsMsgDBEnumerator methods:</span>
<a href="#l12.4081"></a><span id="l12.4081" class="difflineplus">+  typedef nsresult (*nsMsgDBThreadEnumeratorFilter)(nsIMsgThread *thread);</span>
<a href="#l12.4082"></a><span id="l12.4082" class="difflineplus">+</span>
<a href="#l12.4083"></a><span id="l12.4083" class="difflineplus">+  nsMsgDBThreadEnumerator(nsMsgDatabase *db,</span>
<a href="#l12.4084"></a><span id="l12.4084" class="difflineplus">+                          nsMsgDBThreadEnumeratorFilter filter);</span>
<a href="#l12.4085"></a><span id="l12.4085" class="difflineplus">+</span>
<a href="#l12.4086"></a><span id="l12.4086" class="difflineplus">+ protected:</span>
<a href="#l12.4087"></a><span id="l12.4087" class="difflineplus">+  ~nsMsgDBThreadEnumerator() override;</span>
<a href="#l12.4088"></a><span id="l12.4088" class="difflineplus">+  nsresult GetTableCursor(void);</span>
<a href="#l12.4089"></a><span id="l12.4089" class="difflineplus">+  nsresult PrefetchNext();</span>
<a href="#l12.4090"></a><span id="l12.4090" class="difflineplus">+  nsMsgDatabase *mDB;</span>
<a href="#l12.4091"></a><span id="l12.4091" class="difflineplus">+  nsCOMPtr&lt;nsIMdbPortTableCursor&gt; mTableCursor;</span>
<a href="#l12.4092"></a><span id="l12.4092" class="difflineplus">+  RefPtr&lt;nsIMsgThread&gt; mResultThread;</span>
<a href="#l12.4093"></a><span id="l12.4093" class="difflineplus">+  bool mDone;</span>
<a href="#l12.4094"></a><span id="l12.4094" class="difflineplus">+  bool mNextPrefetched;</span>
<a href="#l12.4095"></a><span id="l12.4095" class="difflineplus">+  nsMsgDBThreadEnumeratorFilter mFilter;</span>
<a href="#l12.4096"></a><span id="l12.4096"> };</span>
<a href="#l12.4097"></a><span id="l12.4097"> </span>
<a href="#l12.4098"></a><span id="l12.4098" class="difflineminus">-nsMsgDBThreadEnumerator::nsMsgDBThreadEnumerator(nsMsgDatabase* db,</span>
<a href="#l12.4099"></a><span id="l12.4099" class="difflineminus">-                                     nsMsgDBThreadEnumeratorFilter filter)</span>
<a href="#l12.4100"></a><span id="l12.4100" class="difflineminus">-    : mDB(db), mTableCursor(nullptr), mResultThread(nullptr), mDone(false),</span>
<a href="#l12.4101"></a><span id="l12.4101" class="difflineminus">-      mFilter(filter)</span>
<a href="#l12.4102"></a><span id="l12.4102" class="difflineminus">-{</span>
<a href="#l12.4103"></a><span id="l12.4103" class="difflineminus">-    mDB-&gt;AddListener(this);</span>
<a href="#l12.4104"></a><span id="l12.4104" class="difflineminus">-    mNextPrefetched = false;</span>
<a href="#l12.4105"></a><span id="l12.4105" class="difflineminus">-}</span>
<a href="#l12.4106"></a><span id="l12.4106" class="difflineminus">-</span>
<a href="#l12.4107"></a><span id="l12.4107" class="difflineminus">-nsMsgDBThreadEnumerator::~nsMsgDBThreadEnumerator()</span>
<a href="#l12.4108"></a><span id="l12.4108" class="difflineminus">-{</span>
<a href="#l12.4109"></a><span id="l12.4109" class="difflineplus">+nsMsgDBThreadEnumerator::nsMsgDBThreadEnumerator(</span>
<a href="#l12.4110"></a><span id="l12.4110" class="difflineplus">+    nsMsgDatabase *db, nsMsgDBThreadEnumeratorFilter filter)</span>
<a href="#l12.4111"></a><span id="l12.4111" class="difflineplus">+    : mDB(db),</span>
<a href="#l12.4112"></a><span id="l12.4112" class="difflineplus">+      mTableCursor(nullptr),</span>
<a href="#l12.4113"></a><span id="l12.4113" class="difflineplus">+      mResultThread(nullptr),</span>
<a href="#l12.4114"></a><span id="l12.4114" class="difflineplus">+      mDone(false),</span>
<a href="#l12.4115"></a><span id="l12.4115" class="difflineplus">+      mFilter(filter) {</span>
<a href="#l12.4116"></a><span id="l12.4116" class="difflineplus">+  mDB-&gt;AddListener(this);</span>
<a href="#l12.4117"></a><span id="l12.4117" class="difflineplus">+  mNextPrefetched = false;</span>
<a href="#l12.4118"></a><span id="l12.4118" class="difflineplus">+}</span>
<a href="#l12.4119"></a><span id="l12.4119" class="difflineplus">+</span>
<a href="#l12.4120"></a><span id="l12.4120" class="difflineplus">+nsMsgDBThreadEnumerator::~nsMsgDBThreadEnumerator() {</span>
<a href="#l12.4121"></a><span id="l12.4121">   mTableCursor = nullptr;</span>
<a href="#l12.4122"></a><span id="l12.4122">   mResultThread = nullptr;</span>
<a href="#l12.4123"></a><span id="l12.4123" class="difflineminus">-  if (mDB)</span>
<a href="#l12.4124"></a><span id="l12.4124" class="difflineminus">-    mDB-&gt;RemoveListener(this);</span>
<a href="#l12.4125"></a><span id="l12.4125" class="difflineminus">-}</span>
<a href="#l12.4126"></a><span id="l12.4126" class="difflineminus">-</span>
<a href="#l12.4127"></a><span id="l12.4127" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsMsgDBThreadEnumerator, nsSimpleEnumerator, nsIDBChangeListener)</span>
<a href="#l12.4128"></a><span id="l12.4128" class="difflineminus">-</span>
<a href="#l12.4129"></a><span id="l12.4129" class="difflineminus">-</span>
<a href="#l12.4130"></a><span id="l12.4130" class="difflineminus">-/* void OnHdrFlagsChanged (in nsIMsgDBHdr aHdrChanged, in unsigned long aOldFlags, in unsigned long aNewFlags, in nsIDBChangeListener aInstigator); */</span>
<a href="#l12.4131"></a><span id="l12.4131" class="difflineminus">-NS_IMETHODIMP nsMsgDBThreadEnumerator::OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags, uint32_t aNewFlags, nsIDBChangeListener *aInstigator)</span>
<a href="#l12.4132"></a><span id="l12.4132" class="difflineminus">-{</span>
<a href="#l12.4133"></a><span id="l12.4133" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.4134"></a><span id="l12.4134" class="difflineminus">-}</span>
<a href="#l12.4135"></a><span id="l12.4135" class="difflineminus">-</span>
<a href="#l12.4136"></a><span id="l12.4136" class="difflineminus">-//void OnHdrPropertyChanged(in nsIMsgDBHdr aHdrToChange, in bool aPreChange,</span>
<a href="#l12.4137"></a><span id="l12.4137" class="difflineplus">+  if (mDB) mDB-&gt;RemoveListener(this);</span>
<a href="#l12.4138"></a><span id="l12.4138" class="difflineplus">+}</span>
<a href="#l12.4139"></a><span id="l12.4139" class="difflineplus">+</span>
<a href="#l12.4140"></a><span id="l12.4140" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED(nsMsgDBThreadEnumerator, nsSimpleEnumerator,</span>
<a href="#l12.4141"></a><span id="l12.4141" class="difflineplus">+                            nsIDBChangeListener)</span>
<a href="#l12.4142"></a><span id="l12.4142" class="difflineplus">+</span>
<a href="#l12.4143"></a><span id="l12.4143" class="difflineplus">+/* void OnHdrFlagsChanged (in nsIMsgDBHdr aHdrChanged, in unsigned long</span>
<a href="#l12.4144"></a><span id="l12.4144" class="difflineplus">+ * aOldFlags, in unsigned long aNewFlags, in nsIDBChangeListener aInstigator);</span>
<a href="#l12.4145"></a><span id="l12.4145" class="difflineplus">+ */</span>
<a href="#l12.4146"></a><span id="l12.4146" class="difflineplus">+NS_IMETHODIMP nsMsgDBThreadEnumerator::OnHdrFlagsChanged(</span>
<a href="#l12.4147"></a><span id="l12.4147" class="difflineplus">+    nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags, uint32_t aNewFlags,</span>
<a href="#l12.4148"></a><span id="l12.4148" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l12.4149"></a><span id="l12.4149" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.4150"></a><span id="l12.4150" class="difflineplus">+}</span>
<a href="#l12.4151"></a><span id="l12.4151" class="difflineplus">+</span>
<a href="#l12.4152"></a><span id="l12.4152" class="difflineplus">+// void OnHdrPropertyChanged(in nsIMsgDBHdr aHdrToChange, in bool aPreChange,</span>
<a href="#l12.4153"></a><span id="l12.4153"> // inout uint32_t aStatus, in nsIDBChangeListener aInstigator);</span>
<a href="#l12.4154"></a><span id="l12.4154"> NS_IMETHODIMP</span>
<a href="#l12.4155"></a><span id="l12.4155" class="difflineminus">-nsMsgDBThreadEnumerator::OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange, bool aPreChange, uint32_t *aStatus,</span>
<a href="#l12.4156"></a><span id="l12.4156" class="difflineminus">-                                         nsIDBChangeListener * aInstigator)</span>
<a href="#l12.4157"></a><span id="l12.4157" class="difflineminus">-{</span>
<a href="#l12.4158"></a><span id="l12.4158" class="difflineplus">+nsMsgDBThreadEnumerator::OnHdrPropertyChanged(</span>
<a href="#l12.4159"></a><span id="l12.4159" class="difflineplus">+    nsIMsgDBHdr *aHdrToChange, bool aPreChange, uint32_t *aStatus,</span>
<a href="#l12.4160"></a><span id="l12.4160" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l12.4161"></a><span id="l12.4161" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.4162"></a><span id="l12.4162" class="difflineplus">+}</span>
<a href="#l12.4163"></a><span id="l12.4163" class="difflineplus">+</span>
<a href="#l12.4164"></a><span id="l12.4164" class="difflineplus">+/* void onHdrDeleted (in nsIMsgDBHdr aHdrChanged, in nsMsgKey aParentKey, in</span>
<a href="#l12.4165"></a><span id="l12.4165" class="difflineplus">+ * long aFlags, in nsIDBChangeListener aInstigator); */</span>
<a href="#l12.4166"></a><span id="l12.4166" class="difflineplus">+NS_IMETHODIMP nsMsgDBThreadEnumerator::OnHdrDeleted(</span>
<a href="#l12.4167"></a><span id="l12.4167" class="difflineplus">+    nsIMsgDBHdr *aHdrChanged, nsMsgKey aParentKey, int32_t aFlags,</span>
<a href="#l12.4168"></a><span id="l12.4168" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l12.4169"></a><span id="l12.4169">   return NS_OK;</span>
<a href="#l12.4170"></a><span id="l12.4170"> }</span>
<a href="#l12.4171"></a><span id="l12.4171"> </span>
<a href="#l12.4172"></a><span id="l12.4172" class="difflineminus">-/* void onHdrDeleted (in nsIMsgDBHdr aHdrChanged, in nsMsgKey aParentKey, in long aFlags, in nsIDBChangeListener aInstigator); */</span>
<a href="#l12.4173"></a><span id="l12.4173" class="difflineminus">-NS_IMETHODIMP nsMsgDBThreadEnumerator::OnHdrDeleted(nsIMsgDBHdr *aHdrChanged, nsMsgKey aParentKey, int32_t aFlags, nsIDBChangeListener *aInstigator)</span>
<a href="#l12.4174"></a><span id="l12.4174" class="difflineminus">-{</span>
<a href="#l12.4175"></a><span id="l12.4175" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.4176"></a><span id="l12.4176" class="difflineminus">-}</span>
<a href="#l12.4177"></a><span id="l12.4177" class="difflineminus">-</span>
<a href="#l12.4178"></a><span id="l12.4178" class="difflineminus">-/* void onHdrAdded (in nsIMsgDBHdr aHdrChanged, in nsMsgKey aParentKey, in long aFlags, in nsIDBChangeListener aInstigator); */</span>
<a href="#l12.4179"></a><span id="l12.4179" class="difflineminus">-NS_IMETHODIMP nsMsgDBThreadEnumerator::OnHdrAdded(nsIMsgDBHdr *aHdrChanged, nsMsgKey aParentKey, int32_t aFlags, nsIDBChangeListener *aInstigator)</span>
<a href="#l12.4180"></a><span id="l12.4180" class="difflineminus">-{</span>
<a href="#l12.4181"></a><span id="l12.4181" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.4182"></a><span id="l12.4182" class="difflineminus">-}</span>
<a href="#l12.4183"></a><span id="l12.4183" class="difflineminus">-</span>
<a href="#l12.4184"></a><span id="l12.4184" class="difflineminus">-/* void onParentChanged (in nsMsgKey aKeyChanged, in nsMsgKey oldParent, in nsMsgKey newParent, in nsIDBChangeListener aInstigator); */</span>
<a href="#l12.4185"></a><span id="l12.4185" class="difflineminus">-NS_IMETHODIMP nsMsgDBThreadEnumerator::OnParentChanged(nsMsgKey aKeyChanged, nsMsgKey oldParent, nsMsgKey newParent, nsIDBChangeListener *aInstigator)</span>
<a href="#l12.4186"></a><span id="l12.4186" class="difflineminus">-{</span>
<a href="#l12.4187"></a><span id="l12.4187" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.4188"></a><span id="l12.4188" class="difflineplus">+/* void onHdrAdded (in nsIMsgDBHdr aHdrChanged, in nsMsgKey aParentKey, in long</span>
<a href="#l12.4189"></a><span id="l12.4189" class="difflineplus">+ * aFlags, in nsIDBChangeListener aInstigator); */</span>
<a href="#l12.4190"></a><span id="l12.4190" class="difflineplus">+NS_IMETHODIMP nsMsgDBThreadEnumerator::OnHdrAdded(</span>
<a href="#l12.4191"></a><span id="l12.4191" class="difflineplus">+    nsIMsgDBHdr *aHdrChanged, nsMsgKey aParentKey, int32_t aFlags,</span>
<a href="#l12.4192"></a><span id="l12.4192" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l12.4193"></a><span id="l12.4193" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.4194"></a><span id="l12.4194" class="difflineplus">+}</span>
<a href="#l12.4195"></a><span id="l12.4195" class="difflineplus">+</span>
<a href="#l12.4196"></a><span id="l12.4196" class="difflineplus">+/* void onParentChanged (in nsMsgKey aKeyChanged, in nsMsgKey oldParent, in</span>
<a href="#l12.4197"></a><span id="l12.4197" class="difflineplus">+ * nsMsgKey newParent, in nsIDBChangeListener aInstigator); */</span>
<a href="#l12.4198"></a><span id="l12.4198" class="difflineplus">+NS_IMETHODIMP nsMsgDBThreadEnumerator::OnParentChanged(</span>
<a href="#l12.4199"></a><span id="l12.4199" class="difflineplus">+    nsMsgKey aKeyChanged, nsMsgKey oldParent, nsMsgKey newParent,</span>
<a href="#l12.4200"></a><span id="l12.4200" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l12.4201"></a><span id="l12.4201" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.4202"></a><span id="l12.4202"> }</span>
<a href="#l12.4203"></a><span id="l12.4203"> </span>
<a href="#l12.4204"></a><span id="l12.4204"> /* void onAnnouncerGoingAway (in nsIDBChangeAnnouncer instigator); */</span>
<a href="#l12.4205"></a><span id="l12.4205" class="difflineminus">-NS_IMETHODIMP nsMsgDBThreadEnumerator::OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator)</span>
<a href="#l12.4206"></a><span id="l12.4206" class="difflineminus">-{</span>
<a href="#l12.4207"></a><span id="l12.4207" class="difflineplus">+NS_IMETHODIMP nsMsgDBThreadEnumerator::OnAnnouncerGoingAway(</span>
<a href="#l12.4208"></a><span id="l12.4208" class="difflineplus">+    nsIDBChangeAnnouncer *instigator) {</span>
<a href="#l12.4209"></a><span id="l12.4209">   mTableCursor = nullptr;</span>
<a href="#l12.4210"></a><span id="l12.4210">   mResultThread = nullptr;</span>
<a href="#l12.4211"></a><span id="l12.4211">   mDB-&gt;RemoveListener(this);</span>
<a href="#l12.4212"></a><span id="l12.4212">   mDB = nullptr;</span>
<a href="#l12.4213"></a><span id="l12.4213">   return NS_OK;</span>
<a href="#l12.4214"></a><span id="l12.4214"> }</span>
<a href="#l12.4215"></a><span id="l12.4215"> </span>
<a href="#l12.4216"></a><span id="l12.4216" class="difflineminus">-NS_IMETHODIMP nsMsgDBThreadEnumerator::OnEvent(nsIMsgDatabase *aDB, const char *aEvent)</span>
<a href="#l12.4217"></a><span id="l12.4217" class="difflineminus">-{</span>
<a href="#l12.4218"></a><span id="l12.4218" class="difflineplus">+NS_IMETHODIMP nsMsgDBThreadEnumerator::OnEvent(nsIMsgDatabase *aDB,</span>
<a href="#l12.4219"></a><span id="l12.4219" class="difflineplus">+                                               const char *aEvent) {</span>
<a href="#l12.4220"></a><span id="l12.4220">   return NS_OK;</span>
<a href="#l12.4221"></a><span id="l12.4221"> }</span>
<a href="#l12.4222"></a><span id="l12.4222"> </span>
<a href="#l12.4223"></a><span id="l12.4223"> /* void onReadChanged (in nsIDBChangeListener aInstigator); */</span>
<a href="#l12.4224"></a><span id="l12.4224" class="difflineminus">-NS_IMETHODIMP nsMsgDBThreadEnumerator::OnReadChanged(nsIDBChangeListener *aInstigator)</span>
<a href="#l12.4225"></a><span id="l12.4225" class="difflineminus">-{</span>
<a href="#l12.4226"></a><span id="l12.4226" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.4227"></a><span id="l12.4227" class="difflineplus">+NS_IMETHODIMP nsMsgDBThreadEnumerator::OnReadChanged(</span>
<a href="#l12.4228"></a><span id="l12.4228" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l12.4229"></a><span id="l12.4229" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.4230"></a><span id="l12.4230"> }</span>
<a href="#l12.4231"></a><span id="l12.4231"> </span>
<a href="#l12.4232"></a><span id="l12.4232"> /* void onJunkScoreChanged (in nsIDBChangeListener aInstigator); */</span>
<a href="#l12.4233"></a><span id="l12.4233" class="difflineminus">-NS_IMETHODIMP nsMsgDBThreadEnumerator::OnJunkScoreChanged(nsIDBChangeListener *aInstigator)</span>
<a href="#l12.4234"></a><span id="l12.4234" class="difflineminus">-{</span>
<a href="#l12.4235"></a><span id="l12.4235" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.4236"></a><span id="l12.4236" class="difflineminus">-}</span>
<a href="#l12.4237"></a><span id="l12.4237" class="difflineminus">-</span>
<a href="#l12.4238"></a><span id="l12.4238" class="difflineminus">-nsresult nsMsgDBThreadEnumerator::GetTableCursor(void)</span>
<a href="#l12.4239"></a><span id="l12.4239" class="difflineminus">-{</span>
<a href="#l12.4240"></a><span id="l12.4240" class="difflineplus">+NS_IMETHODIMP nsMsgDBThreadEnumerator::OnJunkScoreChanged(</span>
<a href="#l12.4241"></a><span id="l12.4241" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l12.4242"></a><span id="l12.4242" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.4243"></a><span id="l12.4243" class="difflineplus">+}</span>
<a href="#l12.4244"></a><span id="l12.4244" class="difflineplus">+</span>
<a href="#l12.4245"></a><span id="l12.4245" class="difflineplus">+nsresult nsMsgDBThreadEnumerator::GetTableCursor(void) {</span>
<a href="#l12.4246"></a><span id="l12.4246">   nsresult rv = NS_OK;</span>
<a href="#l12.4247"></a><span id="l12.4247"> </span>
<a href="#l12.4248"></a><span id="l12.4248" class="difflineminus">-  if (!mDB || !mDB-&gt;m_mdbStore)</span>
<a href="#l12.4249"></a><span id="l12.4249" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.4250"></a><span id="l12.4250" class="difflineminus">-</span>
<a href="#l12.4251"></a><span id="l12.4251" class="difflineminus">-  mDB-&gt;m_mdbStore-&gt;GetPortTableCursor(mDB-&gt;GetEnv(),   mDB-&gt;m_hdrRowScopeToken, mDB-&gt;m_threadTableKindToken,</span>
<a href="#l12.4252"></a><span id="l12.4252" class="difflineminus">-    getter_AddRefs(mTableCursor));</span>
<a href="#l12.4253"></a><span id="l12.4253" class="difflineminus">-</span>
<a href="#l12.4254"></a><span id="l12.4254" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.4255"></a><span id="l12.4255" class="difflineminus">-    return rv;</span>
<a href="#l12.4256"></a><span id="l12.4256" class="difflineplus">+  if (!mDB || !mDB-&gt;m_mdbStore) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.4257"></a><span id="l12.4257" class="difflineplus">+</span>
<a href="#l12.4258"></a><span id="l12.4258" class="difflineplus">+  mDB-&gt;m_mdbStore-&gt;GetPortTableCursor(mDB-&gt;GetEnv(), mDB-&gt;m_hdrRowScopeToken,</span>
<a href="#l12.4259"></a><span id="l12.4259" class="difflineplus">+                                      mDB-&gt;m_threadTableKindToken,</span>
<a href="#l12.4260"></a><span id="l12.4260" class="difflineplus">+                                      getter_AddRefs(mTableCursor));</span>
<a href="#l12.4261"></a><span id="l12.4261" class="difflineplus">+</span>
<a href="#l12.4262"></a><span id="l12.4262" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.4263"></a><span id="l12.4263">   return NS_OK;</span>
<a href="#l12.4264"></a><span id="l12.4264"> }</span>
<a href="#l12.4265"></a><span id="l12.4265"> </span>
<a href="#l12.4266"></a><span id="l12.4266" class="difflineminus">-NS_IMETHODIMP nsMsgDBThreadEnumerator::GetNext(nsISupports **aItem)</span>
<a href="#l12.4267"></a><span id="l12.4267" class="difflineminus">-{</span>
<a href="#l12.4268"></a><span id="l12.4268" class="difflineplus">+NS_IMETHODIMP nsMsgDBThreadEnumerator::GetNext(nsISupports **aItem) {</span>
<a href="#l12.4269"></a><span id="l12.4269">   NS_ENSURE_ARG_POINTER(aItem);</span>
<a href="#l12.4270"></a><span id="l12.4270"> </span>
<a href="#l12.4271"></a><span id="l12.4271">   *aItem = nullptr;</span>
<a href="#l12.4272"></a><span id="l12.4272">   nsresult rv = NS_OK;</span>
<a href="#l12.4273"></a><span id="l12.4273" class="difflineminus">-  if (!mNextPrefetched)</span>
<a href="#l12.4274"></a><span id="l12.4274" class="difflineminus">-    rv = PrefetchNext();</span>
<a href="#l12.4275"></a><span id="l12.4275" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l12.4276"></a><span id="l12.4276" class="difflineminus">-  {</span>
<a href="#l12.4277"></a><span id="l12.4277" class="difflineminus">-    if (mResultThread)</span>
<a href="#l12.4278"></a><span id="l12.4278" class="difflineminus">-    {</span>
<a href="#l12.4279"></a><span id="l12.4279" class="difflineplus">+  if (!mNextPrefetched) rv = PrefetchNext();</span>
<a href="#l12.4280"></a><span id="l12.4280" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.4281"></a><span id="l12.4281" class="difflineplus">+    if (mResultThread) {</span>
<a href="#l12.4282"></a><span id="l12.4282">       NS_ADDREF(*aItem = mResultThread);</span>
<a href="#l12.4283"></a><span id="l12.4283">       mNextPrefetched = false;</span>
<a href="#l12.4284"></a><span id="l12.4284">     }</span>
<a href="#l12.4285"></a><span id="l12.4285">   }</span>
<a href="#l12.4286"></a><span id="l12.4286">   return rv;</span>
<a href="#l12.4287"></a><span id="l12.4287"> }</span>
<a href="#l12.4288"></a><span id="l12.4288"> </span>
<a href="#l12.4289"></a><span id="l12.4289" class="difflineminus">-</span>
<a href="#l12.4290"></a><span id="l12.4290" class="difflineminus">-nsresult nsMsgDBThreadEnumerator::PrefetchNext()</span>
<a href="#l12.4291"></a><span id="l12.4291" class="difflineminus">-{</span>
<a href="#l12.4292"></a><span id="l12.4292" class="difflineplus">+nsresult nsMsgDBThreadEnumerator::PrefetchNext() {</span>
<a href="#l12.4293"></a><span id="l12.4293">   nsresult rv;</span>
<a href="#l12.4294"></a><span id="l12.4294">   nsCOMPtr&lt;nsIMdbTable&gt; table;</span>
<a href="#l12.4295"></a><span id="l12.4295"> </span>
<a href="#l12.4296"></a><span id="l12.4296" class="difflineminus">-  if (!mDB)</span>
<a href="#l12.4297"></a><span id="l12.4297" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.4298"></a><span id="l12.4298" class="difflineminus">-</span>
<a href="#l12.4299"></a><span id="l12.4299" class="difflineminus">-  if (!mTableCursor)</span>
<a href="#l12.4300"></a><span id="l12.4300" class="difflineminus">-  {</span>
<a href="#l12.4301"></a><span id="l12.4301" class="difflineplus">+  if (!mDB) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.4302"></a><span id="l12.4302" class="difflineplus">+</span>
<a href="#l12.4303"></a><span id="l12.4303" class="difflineplus">+  if (!mTableCursor) {</span>
<a href="#l12.4304"></a><span id="l12.4304">     rv = GetTableCursor();</span>
<a href="#l12.4305"></a><span id="l12.4305" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.4306"></a><span id="l12.4306" class="difflineminus">-      return rv;</span>
<a href="#l12.4307"></a><span id="l12.4307" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.4308"></a><span id="l12.4308">   }</span>
<a href="#l12.4309"></a><span id="l12.4309" class="difflineminus">-  while (true)</span>
<a href="#l12.4310"></a><span id="l12.4310" class="difflineminus">-  {</span>
<a href="#l12.4311"></a><span id="l12.4311" class="difflineplus">+  while (true) {</span>
<a href="#l12.4312"></a><span id="l12.4312">     mResultThread = nullptr;</span>
<a href="#l12.4313"></a><span id="l12.4313">     rv = mTableCursor-&gt;NextTable(mDB-&gt;GetEnv(), getter_AddRefs(table));</span>
<a href="#l12.4314"></a><span id="l12.4314" class="difflineminus">-    if (!table)</span>
<a href="#l12.4315"></a><span id="l12.4315" class="difflineminus">-    {</span>
<a href="#l12.4316"></a><span id="l12.4316" class="difflineplus">+    if (!table) {</span>
<a href="#l12.4317"></a><span id="l12.4317">       mDone = true;</span>
<a href="#l12.4318"></a><span id="l12.4318">       return NS_ERROR_FAILURE;</span>
<a href="#l12.4319"></a><span id="l12.4319">     }</span>
<a href="#l12.4320"></a><span id="l12.4320" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.4321"></a><span id="l12.4321" class="difflineminus">-    {</span>
<a href="#l12.4322"></a><span id="l12.4322" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l12.4323"></a><span id="l12.4323">       mDone = true;</span>
<a href="#l12.4324"></a><span id="l12.4324">       return rv;</span>
<a href="#l12.4325"></a><span id="l12.4325">     }</span>
<a href="#l12.4326"></a><span id="l12.4326"> </span>
<a href="#l12.4327"></a><span id="l12.4327">     mdbOid tableId;</span>
<a href="#l12.4328"></a><span id="l12.4328">     table-&gt;GetOid(mDB-&gt;GetEnv(), &amp;tableId);</span>
<a href="#l12.4329"></a><span id="l12.4329"> </span>
<a href="#l12.4330"></a><span id="l12.4330">     mResultThread = mDB-&gt;FindExistingThread(tableId.mOid_Id);</span>
<a href="#l12.4331"></a><span id="l12.4331" class="difflineminus">-    if (!mResultThread)</span>
<a href="#l12.4332"></a><span id="l12.4332" class="difflineminus">-      mResultThread = new nsMsgThread(mDB, table);</span>
<a href="#l12.4333"></a><span id="l12.4333" class="difflineminus">-</span>
<a href="#l12.4334"></a><span id="l12.4334" class="difflineminus">-    if (mResultThread)</span>
<a href="#l12.4335"></a><span id="l12.4335" class="difflineminus">-    {</span>
<a href="#l12.4336"></a><span id="l12.4336" class="difflineplus">+    if (!mResultThread) mResultThread = new nsMsgThread(mDB, table);</span>
<a href="#l12.4337"></a><span id="l12.4337" class="difflineplus">+</span>
<a href="#l12.4338"></a><span id="l12.4338" class="difflineplus">+    if (mResultThread) {</span>
<a href="#l12.4339"></a><span id="l12.4339">       uint32_t numChildren = 0;</span>
<a href="#l12.4340"></a><span id="l12.4340">       mResultThread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l12.4341"></a><span id="l12.4341">       // we've got empty thread; don't tell caller about it.</span>
<a href="#l12.4342"></a><span id="l12.4342" class="difflineminus">-      if (numChildren == 0)</span>
<a href="#l12.4343"></a><span id="l12.4343" class="difflineminus">-        continue;</span>
<a href="#l12.4344"></a><span id="l12.4344" class="difflineplus">+      if (numChildren == 0) continue;</span>
<a href="#l12.4345"></a><span id="l12.4345">     }</span>
<a href="#l12.4346"></a><span id="l12.4346">     if (mFilter &amp;&amp; NS_FAILED(mFilter(mResultThread)))</span>
<a href="#l12.4347"></a><span id="l12.4347">       continue;</span>
<a href="#l12.4348"></a><span id="l12.4348">     else</span>
<a href="#l12.4349"></a><span id="l12.4349">       break;</span>
<a href="#l12.4350"></a><span id="l12.4350">   }</span>
<a href="#l12.4351"></a><span id="l12.4351" class="difflineminus">-  if (mResultThread)</span>
<a href="#l12.4352"></a><span id="l12.4352" class="difflineminus">-  {</span>
<a href="#l12.4353"></a><span id="l12.4353" class="difflineplus">+  if (mResultThread) {</span>
<a href="#l12.4354"></a><span id="l12.4354">     mNextPrefetched = true;</span>
<a href="#l12.4355"></a><span id="l12.4355">     return NS_OK;</span>
<a href="#l12.4356"></a><span id="l12.4356">   }</span>
<a href="#l12.4357"></a><span id="l12.4357">   return NS_ERROR_FAILURE;</span>
<a href="#l12.4358"></a><span id="l12.4358"> }</span>
<a href="#l12.4359"></a><span id="l12.4359"> </span>
<a href="#l12.4360"></a><span id="l12.4360" class="difflineminus">-NS_IMETHODIMP nsMsgDBThreadEnumerator::HasMoreElements(bool *aResult)</span>
<a href="#l12.4361"></a><span id="l12.4361" class="difflineminus">-{</span>
<a href="#l12.4362"></a><span id="l12.4362" class="difflineplus">+NS_IMETHODIMP nsMsgDBThreadEnumerator::HasMoreElements(bool *aResult) {</span>
<a href="#l12.4363"></a><span id="l12.4363">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l12.4364"></a><span id="l12.4364"> </span>
<a href="#l12.4365"></a><span id="l12.4365" class="difflineminus">-  if (!mNextPrefetched)</span>
<a href="#l12.4366"></a><span id="l12.4366" class="difflineminus">-    PrefetchNext();</span>
<a href="#l12.4367"></a><span id="l12.4367" class="difflineplus">+  if (!mNextPrefetched) PrefetchNext();</span>
<a href="#l12.4368"></a><span id="l12.4368">   *aResult = !mDone;</span>
<a href="#l12.4369"></a><span id="l12.4369">   return NS_OK;</span>
<a href="#l12.4370"></a><span id="l12.4370"> }</span>
<a href="#l12.4371"></a><span id="l12.4371"> </span>
<a href="#l12.4372"></a><span id="l12.4372"> NS_IMETHODIMP</span>
<a href="#l12.4373"></a><span id="l12.4373" class="difflineminus">-nsMsgDatabase::EnumerateThreads(nsISimpleEnumerator* *result)</span>
<a href="#l12.4374"></a><span id="l12.4374" class="difflineminus">-{</span>
<a href="#l12.4375"></a><span id="l12.4375" class="difflineplus">+nsMsgDatabase::EnumerateThreads(nsISimpleEnumerator **result) {</span>
<a href="#l12.4376"></a><span id="l12.4376">   RememberLastUseTime();</span>
<a href="#l12.4377"></a><span id="l12.4377">   NS_ADDREF(*result = new nsMsgDBThreadEnumerator(this, nullptr));</span>
<a href="#l12.4378"></a><span id="l12.4378">   return NS_OK;</span>
<a href="#l12.4379"></a><span id="l12.4379"> }</span>
<a href="#l12.4380"></a><span id="l12.4380"> </span>
<a href="#l12.4381"></a><span id="l12.4381"> // only return headers with a particular flag set</span>
<a href="#l12.4382"></a><span id="l12.4382" class="difflineminus">-static nsresult</span>
<a href="#l12.4383"></a><span id="l12.4383" class="difflineminus">-nsMsgFlagSetFilter(nsIMsgDBHdr *msg, void *closure)</span>
<a href="#l12.4384"></a><span id="l12.4384" class="difflineminus">-{</span>
<a href="#l12.4385"></a><span id="l12.4385" class="difflineplus">+static nsresult nsMsgFlagSetFilter(nsIMsgDBHdr *msg, void *closure) {</span>
<a href="#l12.4386"></a><span id="l12.4386">   uint32_t msgFlags, desiredFlags;</span>
<a href="#l12.4387"></a><span id="l12.4387" class="difflineminus">-  desiredFlags = * (uint32_t *) closure;</span>
<a href="#l12.4388"></a><span id="l12.4388" class="difflineplus">+  desiredFlags = *(uint32_t *)closure;</span>
<a href="#l12.4389"></a><span id="l12.4389">   msg-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l12.4390"></a><span id="l12.4390">   return (msgFlags &amp; desiredFlags) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l12.4391"></a><span id="l12.4391"> }</span>
<a href="#l12.4392"></a><span id="l12.4392"> </span>
<a href="#l12.4393"></a><span id="l12.4393" class="difflineminus">-nsresult</span>
<a href="#l12.4394"></a><span id="l12.4394" class="difflineminus">-nsMsgDatabase::EnumerateMessagesWithFlag(nsISimpleEnumerator* *result, uint32_t *pFlag)</span>
<a href="#l12.4395"></a><span id="l12.4395" class="difflineminus">-{</span>
<a href="#l12.4396"></a><span id="l12.4396" class="difflineplus">+nsresult nsMsgDatabase::EnumerateMessagesWithFlag(nsISimpleEnumerator **result,</span>
<a href="#l12.4397"></a><span id="l12.4397" class="difflineplus">+                                                  uint32_t *pFlag) {</span>
<a href="#l12.4398"></a><span id="l12.4398">   RememberLastUseTime();</span>
<a href="#l12.4399"></a><span id="l12.4399" class="difflineminus">-  NS_ADDREF(*result = new nsMsgDBEnumerator(this, m_mdbAllMsgHeadersTable, nsMsgFlagSetFilter, pFlag));</span>
<a href="#l12.4400"></a><span id="l12.4400" class="difflineplus">+  NS_ADDREF(*result = new nsMsgDBEnumerator(this, m_mdbAllMsgHeadersTable,</span>
<a href="#l12.4401"></a><span id="l12.4401" class="difflineplus">+                                            nsMsgFlagSetFilter, pFlag));</span>
<a href="#l12.4402"></a><span id="l12.4402">   return NS_OK;</span>
<a href="#l12.4403"></a><span id="l12.4403"> }</span>
<a href="#l12.4404"></a><span id="l12.4404"> </span>
<a href="#l12.4405"></a><span id="l12.4405" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::CreateNewHdr(nsMsgKey key, nsIMsgDBHdr **pnewHdr)</span>
<a href="#l12.4406"></a><span id="l12.4406" class="difflineminus">-{</span>
<a href="#l12.4407"></a><span id="l12.4407" class="difflineminus">-  nsresult  err = NS_OK;</span>
<a href="#l12.4408"></a><span id="l12.4408" class="difflineminus">-  nsIMdbRow    *hdrRow = nullptr;</span>
<a href="#l12.4409"></a><span id="l12.4409" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::CreateNewHdr(nsMsgKey key, nsIMsgDBHdr **pnewHdr) {</span>
<a href="#l12.4410"></a><span id="l12.4410" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l12.4411"></a><span id="l12.4411" class="difflineplus">+  nsIMdbRow *hdrRow = nullptr;</span>
<a href="#l12.4412"></a><span id="l12.4412">   struct mdbOid allMsgHdrsTableOID;</span>
<a href="#l12.4413"></a><span id="l12.4413"> </span>
<a href="#l12.4414"></a><span id="l12.4414">   if (!pnewHdr || !m_mdbAllMsgHeadersTable || !m_mdbStore)</span>
<a href="#l12.4415"></a><span id="l12.4415">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.4416"></a><span id="l12.4416"> </span>
<a href="#l12.4417"></a><span id="l12.4417" class="difflineminus">-  if (key != nsMsgKey_None)</span>
<a href="#l12.4418"></a><span id="l12.4418" class="difflineminus">-  {</span>
<a href="#l12.4419"></a><span id="l12.4419" class="difflineminus">-  allMsgHdrsTableOID.mOid_Scope = m_hdrRowScopeToken;</span>
<a href="#l12.4420"></a><span id="l12.4420" class="difflineminus">-  allMsgHdrsTableOID.mOid_Id = key;  // presumes 0 is valid key value</span>
<a href="#l12.4421"></a><span id="l12.4421" class="difflineminus">-</span>
<a href="#l12.4422"></a><span id="l12.4422" class="difflineminus">-  err = m_mdbStore-&gt;GetRow(GetEnv(), &amp;allMsgHdrsTableOID, &amp;hdrRow);</span>
<a href="#l12.4423"></a><span id="l12.4423" class="difflineminus">-  if (!hdrRow)</span>
<a href="#l12.4424"></a><span id="l12.4424" class="difflineminus">-    err  = m_mdbStore-&gt;NewRowWithOid(GetEnv(), &amp;allMsgHdrsTableOID, &amp;hdrRow);</span>
<a href="#l12.4425"></a><span id="l12.4425" class="difflineminus">-  }</span>
<a href="#l12.4426"></a><span id="l12.4426" class="difflineminus">-  else</span>
<a href="#l12.4427"></a><span id="l12.4427" class="difflineminus">-  {</span>
<a href="#l12.4428"></a><span id="l12.4428" class="difflineplus">+  if (key != nsMsgKey_None) {</span>
<a href="#l12.4429"></a><span id="l12.4429" class="difflineplus">+    allMsgHdrsTableOID.mOid_Scope = m_hdrRowScopeToken;</span>
<a href="#l12.4430"></a><span id="l12.4430" class="difflineplus">+    allMsgHdrsTableOID.mOid_Id = key;  // presumes 0 is valid key value</span>
<a href="#l12.4431"></a><span id="l12.4431" class="difflineplus">+</span>
<a href="#l12.4432"></a><span id="l12.4432" class="difflineplus">+    err = m_mdbStore-&gt;GetRow(GetEnv(), &amp;allMsgHdrsTableOID, &amp;hdrRow);</span>
<a href="#l12.4433"></a><span id="l12.4433" class="difflineplus">+    if (!hdrRow)</span>
<a href="#l12.4434"></a><span id="l12.4434" class="difflineplus">+      err = m_mdbStore-&gt;NewRowWithOid(GetEnv(), &amp;allMsgHdrsTableOID, &amp;hdrRow);</span>
<a href="#l12.4435"></a><span id="l12.4435" class="difflineplus">+  } else {</span>
<a href="#l12.4436"></a><span id="l12.4436">     // Mork will assign an ID to the new row, generally the next available ID.</span>
<a href="#l12.4437"></a><span id="l12.4437" class="difflineminus">-    err  = m_mdbStore-&gt;NewRow(GetEnv(), m_hdrRowScopeToken, &amp;hdrRow);</span>
<a href="#l12.4438"></a><span id="l12.4438" class="difflineminus">-    if (hdrRow)</span>
<a href="#l12.4439"></a><span id="l12.4439" class="difflineminus">-    {</span>
<a href="#l12.4440"></a><span id="l12.4440" class="difflineplus">+    err = m_mdbStore-&gt;NewRow(GetEnv(), m_hdrRowScopeToken, &amp;hdrRow);</span>
<a href="#l12.4441"></a><span id="l12.4441" class="difflineplus">+    if (hdrRow) {</span>
<a href="#l12.4442"></a><span id="l12.4442">       struct mdbOid oid;</span>
<a href="#l12.4443"></a><span id="l12.4443">       hdrRow-&gt;GetOid(GetEnv(), &amp;oid);</span>
<a href="#l12.4444"></a><span id="l12.4444">       key = oid.mOid_Id;</span>
<a href="#l12.4445"></a><span id="l12.4445" class="difflineminus">-    }</span>
<a href="#l12.4446"></a><span id="l12.4446" class="difflineminus">-    else</span>
<a href="#l12.4447"></a><span id="l12.4447" class="difflineminus">-    {</span>
<a href="#l12.4448"></a><span id="l12.4448" class="difflineplus">+    } else {</span>
<a href="#l12.4449"></a><span id="l12.4449">       // We failed to create a new row. That can happen if we run out of keys,</span>
<a href="#l12.4450"></a><span id="l12.4450">       // which will force a reparse.</span>
<a href="#l12.4451"></a><span id="l12.4451">       RefPtr&lt;nsMsgKeyArray&gt; keys = new nsMsgKeyArray;</span>
<a href="#l12.4452"></a><span id="l12.4452" class="difflineminus">-      if (NS_SUCCEEDED(ListAllKeys(keys)))</span>
<a href="#l12.4453"></a><span id="l12.4453" class="difflineminus">-      {</span>
<a href="#l12.4454"></a><span id="l12.4454" class="difflineplus">+      if (NS_SUCCEEDED(ListAllKeys(keys))) {</span>
<a href="#l12.4455"></a><span id="l12.4455">         uint32_t numKeys;</span>
<a href="#l12.4456"></a><span id="l12.4456">         keys-&gt;GetLength(&amp;numKeys);</span>
<a href="#l12.4457"></a><span id="l12.4457" class="difflineminus">-        for (uint32_t i = 0; i &lt; numKeys; i++)</span>
<a href="#l12.4458"></a><span id="l12.4458" class="difflineminus">-        {</span>
<a href="#l12.4459"></a><span id="l12.4459" class="difflineminus">-          if (keys-&gt;m_keys[i] &gt;= kForceReparseKey)</span>
<a href="#l12.4460"></a><span id="l12.4460" class="difflineminus">-          {</span>
<a href="#l12.4461"></a><span id="l12.4461" class="difflineplus">+        for (uint32_t i = 0; i &lt; numKeys; i++) {</span>
<a href="#l12.4462"></a><span id="l12.4462" class="difflineplus">+          if (keys-&gt;m_keys[i] &gt;= kForceReparseKey) {</span>
<a href="#l12.4463"></a><span id="l12.4463">             // Force a reparse.</span>
<a href="#l12.4464"></a><span id="l12.4464">             if (m_dbFolderInfo)</span>
<a href="#l12.4465"></a><span id="l12.4465">               m_dbFolderInfo-&gt;SetBooleanProperty(&quot;forceReparse&quot;, true);</span>
<a href="#l12.4466"></a><span id="l12.4466">             break;</span>
<a href="#l12.4467"></a><span id="l12.4467">           }</span>
<a href="#l12.4468"></a><span id="l12.4468">         }</span>
<a href="#l12.4469"></a><span id="l12.4469">       }</span>
<a href="#l12.4470"></a><span id="l12.4470">       err = NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l12.4471"></a><span id="l12.4471">     }</span>
<a href="#l12.4472"></a><span id="l12.4472">   }</span>
<a href="#l12.4473"></a><span id="l12.4473" class="difflineminus">-  if (NS_FAILED(err))</span>
<a href="#l12.4474"></a><span id="l12.4474" class="difflineminus">-    return err;</span>
<a href="#l12.4475"></a><span id="l12.4475" class="difflineplus">+  if (NS_FAILED(err)) return err;</span>
<a href="#l12.4476"></a><span id="l12.4476">   err = CreateMsgHdr(hdrRow, key, pnewHdr);</span>
<a href="#l12.4477"></a><span id="l12.4477">   return err;</span>
<a href="#l12.4478"></a><span id="l12.4478"> }</span>
<a href="#l12.4479"></a><span id="l12.4479"> </span>
<a href="#l12.4480"></a><span id="l12.4480" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::AddNewHdrToDB(nsIMsgDBHdr *newHdr, bool notify)</span>
<a href="#l12.4481"></a><span id="l12.4481" class="difflineminus">-{</span>
<a href="#l12.4482"></a><span id="l12.4482" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::AddNewHdrToDB(nsIMsgDBHdr *newHdr, bool notify) {</span>
<a href="#l12.4483"></a><span id="l12.4483">   NS_ENSURE_ARG_POINTER(newHdr);</span>
<a href="#l12.4484"></a><span id="l12.4484" class="difflineminus">-  nsMsgHdr* hdr = static_cast&lt;nsMsgHdr*&gt;(newHdr);          // closed system, cast ok</span>
<a href="#l12.4485"></a><span id="l12.4485" class="difflineplus">+  nsMsgHdr *hdr = static_cast&lt;nsMsgHdr *&gt;(newHdr);  // closed system, cast ok</span>
<a href="#l12.4486"></a><span id="l12.4486">   bool newThread;</span>
<a href="#l12.4487"></a><span id="l12.4487">   bool hasKey = false;</span>
<a href="#l12.4488"></a><span id="l12.4488">   nsMsgKey msgKey = nsMsgKey_None;</span>
<a href="#l12.4489"></a><span id="l12.4489">   (void)hdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l12.4490"></a><span id="l12.4490">   (void)ContainsKey(msgKey, &amp;hasKey);</span>
<a href="#l12.4491"></a><span id="l12.4491" class="difflineminus">-  if (hasKey)</span>
<a href="#l12.4492"></a><span id="l12.4492" class="difflineminus">-  {</span>
<a href="#l12.4493"></a><span id="l12.4493" class="difflineplus">+  if (hasKey) {</span>
<a href="#l12.4494"></a><span id="l12.4494">     NS_ERROR(&quot;adding hdr that already exists&quot;);</span>
<a href="#l12.4495"></a><span id="l12.4495">     return NS_ERROR_FAILURE;</span>
<a href="#l12.4496"></a><span id="l12.4496">   }</span>
<a href="#l12.4497"></a><span id="l12.4497">   nsresult err = ThreadNewHdr(hdr, newThread);</span>
<a href="#l12.4498"></a><span id="l12.4498">   // we thread header before we add it to the all headers table</span>
<a href="#l12.4499"></a><span id="l12.4499">   // so that subject and reference threading will work (otherwise,</span>
<a href="#l12.4500"></a><span id="l12.4500">   // when we try to find the first header with the same subject or</span>
<a href="#l12.4501"></a><span id="l12.4501">   // reference, we get the new header!)</span>
<a href="#l12.4502"></a><span id="l12.4502" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l12.4503"></a><span id="l12.4503" class="difflineminus">-  {</span>
<a href="#l12.4504"></a><span id="l12.4504" class="difflineplus">+  if (NS_SUCCEEDED(err)) {</span>
<a href="#l12.4505"></a><span id="l12.4505">     nsMsgKey key;</span>
<a href="#l12.4506"></a><span id="l12.4506">     uint32_t flags;</span>
<a href="#l12.4507"></a><span id="l12.4507"> </span>
<a href="#l12.4508"></a><span id="l12.4508">     newHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.4509"></a><span id="l12.4509">     hdr-&gt;GetRawFlags(&amp;flags);</span>
<a href="#l12.4510"></a><span id="l12.4510">     // use raw flags instead of GetFlags, because GetFlags will</span>
<a href="#l12.4511"></a><span id="l12.4511">     // pay attention to what's in m_newSet, and this new hdr isn't</span>
<a href="#l12.4512"></a><span id="l12.4512">     // in m_newSet yet.</span>
<a href="#l12.4513"></a><span id="l12.4513" class="difflineminus">-    if (flags &amp; nsMsgMessageFlags::New)</span>
<a href="#l12.4514"></a><span id="l12.4514" class="difflineminus">-    {</span>
<a href="#l12.4515"></a><span id="l12.4515" class="difflineplus">+    if (flags &amp; nsMsgMessageFlags::New) {</span>
<a href="#l12.4516"></a><span id="l12.4516">       uint32_t newFlags;</span>
<a href="#l12.4517"></a><span id="l12.4517" class="difflineminus">-      newHdr-&gt;AndFlags(~nsMsgMessageFlags::New, &amp;newFlags);  // make sure not filed out</span>
<a href="#l12.4518"></a><span id="l12.4518" class="difflineplus">+      newHdr-&gt;AndFlags(~nsMsgMessageFlags::New,</span>
<a href="#l12.4519"></a><span id="l12.4519" class="difflineplus">+                       &amp;newFlags);  // make sure not filed out</span>
<a href="#l12.4520"></a><span id="l12.4520">       AddToNewList(key);</span>
<a href="#l12.4521"></a><span id="l12.4521">     }</span>
<a href="#l12.4522"></a><span id="l12.4522" class="difflineminus">-    if (m_dbFolderInfo)</span>
<a href="#l12.4523"></a><span id="l12.4523" class="difflineminus">-    {</span>
<a href="#l12.4524"></a><span id="l12.4524" class="difflineplus">+    if (m_dbFolderInfo) {</span>
<a href="#l12.4525"></a><span id="l12.4525">       m_dbFolderInfo-&gt;ChangeNumMessages(1);</span>
<a href="#l12.4526"></a><span id="l12.4526">       bool isRead = true;</span>
<a href="#l12.4527"></a><span id="l12.4527">       IsHeaderRead(newHdr, &amp;isRead);</span>
<a href="#l12.4528"></a><span id="l12.4528" class="difflineminus">-      if (!isRead)</span>
<a href="#l12.4529"></a><span id="l12.4529" class="difflineminus">-        m_dbFolderInfo-&gt;ChangeNumUnreadMessages(1);</span>
<a href="#l12.4530"></a><span id="l12.4530" class="difflineplus">+      if (!isRead) m_dbFolderInfo-&gt;ChangeNumUnreadMessages(1);</span>
<a href="#l12.4531"></a><span id="l12.4531">       m_dbFolderInfo-&gt;OnKeyAdded(key);</span>
<a href="#l12.4532"></a><span id="l12.4532">     }</span>
<a href="#l12.4533"></a><span id="l12.4533"> </span>
<a href="#l12.4534"></a><span id="l12.4534">     err = m_mdbAllMsgHeadersTable-&gt;AddRow(GetEnv(), hdr-&gt;GetMDBRow());</span>
<a href="#l12.4535"></a><span id="l12.4535" class="difflineminus">-    if (notify)</span>
<a href="#l12.4536"></a><span id="l12.4536" class="difflineminus">-    {</span>
<a href="#l12.4537"></a><span id="l12.4537" class="difflineplus">+    if (notify) {</span>
<a href="#l12.4538"></a><span id="l12.4538">       nsMsgKey threadParent;</span>
<a href="#l12.4539"></a><span id="l12.4539"> </span>
<a href="#l12.4540"></a><span id="l12.4540">       newHdr-&gt;GetThreadParent(&amp;threadParent);</span>
<a href="#l12.4541"></a><span id="l12.4541">       NotifyHdrAddedAll(newHdr, threadParent, flags, NULL);</span>
<a href="#l12.4542"></a><span id="l12.4542">     }</span>
<a href="#l12.4543"></a><span id="l12.4543"> </span>
<a href="#l12.4544"></a><span id="l12.4544" class="difflineminus">-    if (UseCorrectThreading())</span>
<a href="#l12.4545"></a><span id="l12.4545" class="difflineminus">-      err = AddMsgRefsToHash(newHdr);</span>
<a href="#l12.4546"></a><span id="l12.4546" class="difflineplus">+    if (UseCorrectThreading()) err = AddMsgRefsToHash(newHdr);</span>
<a href="#l12.4547"></a><span id="l12.4547">   }</span>
<a href="#l12.4548"></a><span id="l12.4548">   NS_ASSERTION(NS_SUCCEEDED(err), &quot;error creating thread&quot;);</span>
<a href="#l12.4549"></a><span id="l12.4549">   return err;</span>
<a href="#l12.4550"></a><span id="l12.4550"> }</span>
<a href="#l12.4551"></a><span id="l12.4551"> </span>
<a href="#l12.4552"></a><span id="l12.4552" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::CopyHdrFromExistingHdr(nsMsgKey key, nsIMsgDBHdr *existingHdr, bool addHdrToDB, nsIMsgDBHdr **newHdr)</span>
<a href="#l12.4553"></a><span id="l12.4553" class="difflineminus">-{</span>
<a href="#l12.4554"></a><span id="l12.4554" class="difflineminus">-  nsresult  err = NS_OK;</span>
<a href="#l12.4555"></a><span id="l12.4555" class="difflineminus">-</span>
<a href="#l12.4556"></a><span id="l12.4556" class="difflineminus">-  if (existingHdr)</span>
<a href="#l12.4557"></a><span id="l12.4557" class="difflineminus">-  {</span>
<a href="#l12.4558"></a><span id="l12.4558" class="difflineminus">-    nsMsgHdr* sourceMsgHdr = static_cast&lt;nsMsgHdr*&gt;(existingHdr);      // closed system, cast ok</span>
<a href="#l12.4559"></a><span id="l12.4559" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::CopyHdrFromExistingHdr(nsMsgKey key,</span>
<a href="#l12.4560"></a><span id="l12.4560" class="difflineplus">+                                                    nsIMsgDBHdr *existingHdr,</span>
<a href="#l12.4561"></a><span id="l12.4561" class="difflineplus">+                                                    bool addHdrToDB,</span>
<a href="#l12.4562"></a><span id="l12.4562" class="difflineplus">+                                                    nsIMsgDBHdr **newHdr) {</span>
<a href="#l12.4563"></a><span id="l12.4563" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l12.4564"></a><span id="l12.4564" class="difflineplus">+</span>
<a href="#l12.4565"></a><span id="l12.4565" class="difflineplus">+  if (existingHdr) {</span>
<a href="#l12.4566"></a><span id="l12.4566" class="difflineplus">+    nsMsgHdr *sourceMsgHdr =</span>
<a href="#l12.4567"></a><span id="l12.4567" class="difflineplus">+        static_cast&lt;nsMsgHdr *&gt;(existingHdr);  // closed system, cast ok</span>
<a href="#l12.4568"></a><span id="l12.4568">     nsMsgHdr *destMsgHdr = nullptr;</span>
<a href="#l12.4569"></a><span id="l12.4569" class="difflineminus">-    CreateNewHdr(key, (nsIMsgDBHdr **) &amp;destMsgHdr);</span>
<a href="#l12.4570"></a><span id="l12.4570" class="difflineminus">-    nsIMdbRow  *sourceRow = sourceMsgHdr-&gt;GetMDBRow();</span>
<a href="#l12.4571"></a><span id="l12.4571" class="difflineminus">-    if (!destMsgHdr || !sourceRow)</span>
<a href="#l12.4572"></a><span id="l12.4572" class="difflineminus">-      return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l12.4573"></a><span id="l12.4573" class="difflineminus">-</span>
<a href="#l12.4574"></a><span id="l12.4574" class="difflineminus">-    nsIMdbRow  *destRow = destMsgHdr-&gt;GetMDBRow();</span>
<a href="#l12.4575"></a><span id="l12.4575" class="difflineminus">-    if (!destRow)</span>
<a href="#l12.4576"></a><span id="l12.4576" class="difflineminus">-      return NS_ERROR_UNEXPECTED;</span>
<a href="#l12.4577"></a><span id="l12.4577" class="difflineplus">+    CreateNewHdr(key, (nsIMsgDBHdr **)&amp;destMsgHdr);</span>
<a href="#l12.4578"></a><span id="l12.4578" class="difflineplus">+    nsIMdbRow *sourceRow = sourceMsgHdr-&gt;GetMDBRow();</span>
<a href="#l12.4579"></a><span id="l12.4579" class="difflineplus">+    if (!destMsgHdr || !sourceRow) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l12.4580"></a><span id="l12.4580" class="difflineplus">+</span>
<a href="#l12.4581"></a><span id="l12.4581" class="difflineplus">+    nsIMdbRow *destRow = destMsgHdr-&gt;GetMDBRow();</span>
<a href="#l12.4582"></a><span id="l12.4582" class="difflineplus">+    if (!destRow) return NS_ERROR_UNEXPECTED;</span>
<a href="#l12.4583"></a><span id="l12.4583"> </span>
<a href="#l12.4584"></a><span id="l12.4584">     err = destRow-&gt;SetRow(GetEnv(), sourceRow);</span>
<a href="#l12.4585"></a><span id="l12.4585" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l12.4586"></a><span id="l12.4586" class="difflineminus">-    {</span>
<a href="#l12.4587"></a><span id="l12.4587" class="difflineplus">+    if (NS_SUCCEEDED(err)) {</span>
<a href="#l12.4588"></a><span id="l12.4588">       // we may have gotten the header from a cache - calling SetRow</span>
<a href="#l12.4589"></a><span id="l12.4589">       // basically invalidates any cached values, so invalidate them.</span>
<a href="#l12.4590"></a><span id="l12.4590">       destMsgHdr-&gt;ClearCachedValues();</span>
<a href="#l12.4591"></a><span id="l12.4591" class="difflineminus">-      if(addHdrToDB)</span>
<a href="#l12.4592"></a><span id="l12.4592" class="difflineminus">-        err = AddNewHdrToDB(destMsgHdr, true);</span>
<a href="#l12.4593"></a><span id="l12.4593" class="difflineminus">-      if (NS_SUCCEEDED(err) &amp;&amp; newHdr)</span>
<a href="#l12.4594"></a><span id="l12.4594" class="difflineminus">-        *newHdr = destMsgHdr;</span>
<a href="#l12.4595"></a><span id="l12.4595" class="difflineplus">+      if (addHdrToDB) err = AddNewHdrToDB(destMsgHdr, true);</span>
<a href="#l12.4596"></a><span id="l12.4596" class="difflineplus">+      if (NS_SUCCEEDED(err) &amp;&amp; newHdr) *newHdr = destMsgHdr;</span>
<a href="#l12.4597"></a><span id="l12.4597">     }</span>
<a href="#l12.4598"></a><span id="l12.4598">   }</span>
<a href="#l12.4599"></a><span id="l12.4599">   return err;</span>
<a href="#l12.4600"></a><span id="l12.4600"> }</span>
<a href="#l12.4601"></a><span id="l12.4601"> </span>
<a href="#l12.4602"></a><span id="l12.4602" class="difflineminus">-nsresult nsMsgDatabase::RowCellColumnTonsString(nsIMdbRow *hdrRow, mdb_token columnToken, nsAString &amp;resultStr)</span>
<a href="#l12.4603"></a><span id="l12.4603" class="difflineminus">-{</span>
<a href="#l12.4604"></a><span id="l12.4604" class="difflineplus">+nsresult nsMsgDatabase::RowCellColumnTonsString(nsIMdbRow *hdrRow,</span>
<a href="#l12.4605"></a><span id="l12.4605" class="difflineplus">+                                                mdb_token columnToken,</span>
<a href="#l12.4606"></a><span id="l12.4606" class="difflineplus">+                                                nsAString &amp;resultStr) {</span>
<a href="#l12.4607"></a><span id="l12.4607">   NS_ENSURE_ARG_POINTER(hdrRow);</span>
<a href="#l12.4608"></a><span id="l12.4608"> </span>
<a href="#l12.4609"></a><span id="l12.4609">   struct mdbYarn yarn;</span>
<a href="#l12.4610"></a><span id="l12.4610">   nsresult rv = hdrRow-&gt;AliasCellYarn(GetEnv(), columnToken, &amp;yarn);</span>
<a href="#l12.4611"></a><span id="l12.4611">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.4612"></a><span id="l12.4612">   YarnTonsString(&amp;yarn, resultStr);</span>
<a href="#l12.4613"></a><span id="l12.4613">   return NS_OK;</span>
<a href="#l12.4614"></a><span id="l12.4614"> }</span>
<a href="#l12.4615"></a><span id="l12.4615"> </span>
<a href="#l12.4616"></a><span id="l12.4616" class="difflineminus">-// as long as the row still exists, and isn't changed, the returned const char ** will be valid.</span>
<a href="#l12.4617"></a><span id="l12.4617" class="difflineminus">-// But be very careful using this data - the caller should never return it in turn to another caller.</span>
<a href="#l12.4618"></a><span id="l12.4618" class="difflineminus">-nsresult nsMsgDatabase::RowCellColumnToConstCharPtr(nsIMdbRow *hdrRow, mdb_token columnToken, const char **ptr)</span>
<a href="#l12.4619"></a><span id="l12.4619" class="difflineminus">-{</span>
<a href="#l12.4620"></a><span id="l12.4620" class="difflineplus">+// as long as the row still exists, and isn't changed, the returned const char</span>
<a href="#l12.4621"></a><span id="l12.4621" class="difflineplus">+// ** will be valid. But be very careful using this data - the caller should</span>
<a href="#l12.4622"></a><span id="l12.4622" class="difflineplus">+// never return it in turn to another caller.</span>
<a href="#l12.4623"></a><span id="l12.4623" class="difflineplus">+nsresult nsMsgDatabase::RowCellColumnToConstCharPtr(nsIMdbRow *hdrRow,</span>
<a href="#l12.4624"></a><span id="l12.4624" class="difflineplus">+                                                    mdb_token columnToken,</span>
<a href="#l12.4625"></a><span id="l12.4625" class="difflineplus">+                                                    const char **ptr) {</span>
<a href="#l12.4626"></a><span id="l12.4626">   NS_ENSURE_ARG_POINTER(hdrRow);</span>
<a href="#l12.4627"></a><span id="l12.4627"> </span>
<a href="#l12.4628"></a><span id="l12.4628">   struct mdbYarn yarn;</span>
<a href="#l12.4629"></a><span id="l12.4629">   nsresult rv = hdrRow-&gt;AliasCellYarn(GetEnv(), columnToken, &amp;yarn);</span>
<a href="#l12.4630"></a><span id="l12.4630">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.4631"></a><span id="l12.4631" class="difflineminus">-  *ptr = (const char*)yarn.mYarn_Buf;</span>
<a href="#l12.4632"></a><span id="l12.4632" class="difflineplus">+  *ptr = (const char *)yarn.mYarn_Buf;</span>
<a href="#l12.4633"></a><span id="l12.4633">   return NS_OK;</span>
<a href="#l12.4634"></a><span id="l12.4634"> }</span>
<a href="#l12.4635"></a><span id="l12.4635"> </span>
<a href="#l12.4636"></a><span id="l12.4636" class="difflineminus">-nsIMimeConverter *nsMsgDatabase::GetMimeConverter()</span>
<a href="#l12.4637"></a><span id="l12.4637" class="difflineminus">-{</span>
<a href="#l12.4638"></a><span id="l12.4638" class="difflineminus">-  if (!m_mimeConverter)</span>
<a href="#l12.4639"></a><span id="l12.4639" class="difflineminus">-  {</span>
<a href="#l12.4640"></a><span id="l12.4640" class="difflineplus">+nsIMimeConverter *nsMsgDatabase::GetMimeConverter() {</span>
<a href="#l12.4641"></a><span id="l12.4641" class="difflineplus">+  if (!m_mimeConverter) {</span>
<a href="#l12.4642"></a><span id="l12.4642">     // apply mime decode</span>
<a href="#l12.4643"></a><span id="l12.4643">     m_mimeConverter = do_GetService(NS_MIME_CONVERTER_CONTRACTID);</span>
<a href="#l12.4644"></a><span id="l12.4644">   }</span>
<a href="#l12.4645"></a><span id="l12.4645">   return m_mimeConverter;</span>
<a href="#l12.4646"></a><span id="l12.4646"> }</span>
<a href="#l12.4647"></a><span id="l12.4647"> </span>
<a href="#l12.4648"></a><span id="l12.4648" class="difflineminus">-nsresult nsMsgDatabase::GetEffectiveCharset(nsIMdbRow *row, nsACString &amp;resultCharset)</span>
<a href="#l12.4649"></a><span id="l12.4649" class="difflineminus">-{</span>
<a href="#l12.4650"></a><span id="l12.4650" class="difflineplus">+nsresult nsMsgDatabase::GetEffectiveCharset(nsIMdbRow *row,</span>
<a href="#l12.4651"></a><span id="l12.4651" class="difflineplus">+                                            nsACString &amp;resultCharset) {</span>
<a href="#l12.4652"></a><span id="l12.4652">   resultCharset.Truncate();</span>
<a href="#l12.4653"></a><span id="l12.4653">   bool characterSetOverride;</span>
<a href="#l12.4654"></a><span id="l12.4654">   m_dbFolderInfo-&gt;GetCharacterSetOverride(&amp;characterSetOverride);</span>
<a href="#l12.4655"></a><span id="l12.4655" class="difflineminus">-  nsresult rv = RowCellColumnToCharPtr(row, m_messageCharSetColumnToken, getter_Copies(resultCharset));</span>
<a href="#l12.4656"></a><span id="l12.4656" class="difflineplus">+  nsresult rv = RowCellColumnToCharPtr(row, m_messageCharSetColumnToken,</span>
<a href="#l12.4657"></a><span id="l12.4657" class="difflineplus">+                                       getter_Copies(resultCharset));</span>
<a href="#l12.4658"></a><span id="l12.4658">   if (NS_FAILED(rv) || resultCharset.IsEmpty() ||</span>
<a href="#l12.4659"></a><span id="l12.4659" class="difflineminus">-      resultCharset.EqualsLiteral(&quot;us-ascii&quot;) || characterSetOverride)</span>
<a href="#l12.4660"></a><span id="l12.4660" class="difflineminus">-  {</span>
<a href="#l12.4661"></a><span id="l12.4661" class="difflineplus">+      resultCharset.EqualsLiteral(&quot;us-ascii&quot;) || characterSetOverride) {</span>
<a href="#l12.4662"></a><span id="l12.4662">     rv = m_dbFolderInfo-&gt;GetEffectiveCharacterSet(resultCharset);</span>
<a href="#l12.4663"></a><span id="l12.4663">   }</span>
<a href="#l12.4664"></a><span id="l12.4664">   return rv;</span>
<a href="#l12.4665"></a><span id="l12.4665"> }</span>
<a href="#l12.4666"></a><span id="l12.4666"> </span>
<a href="#l12.4667"></a><span id="l12.4667" class="difflineminus">-nsresult nsMsgDatabase::RowCellColumnToMime2DecodedString(nsIMdbRow *row, mdb_token columnToken, nsAString &amp;resultStr)</span>
<a href="#l12.4668"></a><span id="l12.4668" class="difflineminus">-{</span>
<a href="#l12.4669"></a><span id="l12.4669" class="difflineplus">+nsresult nsMsgDatabase::RowCellColumnToMime2DecodedString(</span>
<a href="#l12.4670"></a><span id="l12.4670" class="difflineplus">+    nsIMdbRow *row, mdb_token columnToken, nsAString &amp;resultStr) {</span>
<a href="#l12.4671"></a><span id="l12.4671">   nsresult err = NS_OK;</span>
<a href="#l12.4672"></a><span id="l12.4672">   const char *nakedString = nullptr;</span>
<a href="#l12.4673"></a><span id="l12.4673">   err = RowCellColumnToConstCharPtr(row, columnToken, &amp;nakedString);</span>
<a href="#l12.4674"></a><span id="l12.4674" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; nakedString &amp;&amp; strlen(nakedString))</span>
<a href="#l12.4675"></a><span id="l12.4675" class="difflineminus">-  {</span>
<a href="#l12.4676"></a><span id="l12.4676" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; nakedString &amp;&amp; strlen(nakedString)) {</span>
<a href="#l12.4677"></a><span id="l12.4677">     GetMimeConverter();</span>
<a href="#l12.4678"></a><span id="l12.4678" class="difflineminus">-    if (m_mimeConverter)</span>
<a href="#l12.4679"></a><span id="l12.4679" class="difflineminus">-    {</span>
<a href="#l12.4680"></a><span id="l12.4680" class="difflineplus">+    if (m_mimeConverter) {</span>
<a href="#l12.4681"></a><span id="l12.4681">       nsAutoString decodedStr;</span>
<a href="#l12.4682"></a><span id="l12.4682">       nsCString charSet;</span>
<a href="#l12.4683"></a><span id="l12.4683">       GetEffectiveCharset(row, charSet);</span>
<a href="#l12.4684"></a><span id="l12.4684"> </span>
<a href="#l12.4685"></a><span id="l12.4685" class="difflineminus">-      err = m_mimeConverter-&gt;DecodeMimeHeader(nakedString, charSet.get(),</span>
<a href="#l12.4686"></a><span id="l12.4686" class="difflineminus">-        false, true, resultStr);</span>
<a href="#l12.4687"></a><span id="l12.4687" class="difflineplus">+      err = m_mimeConverter-&gt;DecodeMimeHeader(nakedString, charSet.get(), false,</span>
<a href="#l12.4688"></a><span id="l12.4688" class="difflineplus">+                                              true, resultStr);</span>
<a href="#l12.4689"></a><span id="l12.4689">     }</span>
<a href="#l12.4690"></a><span id="l12.4690">   }</span>
<a href="#l12.4691"></a><span id="l12.4691">   return err;</span>
<a href="#l12.4692"></a><span id="l12.4692"> }</span>
<a href="#l12.4693"></a><span id="l12.4693"> </span>
<a href="#l12.4694"></a><span id="l12.4694" class="difflineminus">-nsresult nsMsgDatabase::RowCellColumnToAddressCollationKey(nsIMdbRow *row, mdb_token colToken, uint8_t **result, uint32_t *len)</span>
<a href="#l12.4695"></a><span id="l12.4695" class="difflineminus">-{</span>
<a href="#l12.4696"></a><span id="l12.4696" class="difflineplus">+nsresult nsMsgDatabase::RowCellColumnToAddressCollationKey(nsIMdbRow *row,</span>
<a href="#l12.4697"></a><span id="l12.4697" class="difflineplus">+                                                           mdb_token colToken,</span>
<a href="#l12.4698"></a><span id="l12.4698" class="difflineplus">+                                                           uint8_t **result,</span>
<a href="#l12.4699"></a><span id="l12.4699" class="difflineplus">+                                                           uint32_t *len) {</span>
<a href="#l12.4700"></a><span id="l12.4700">   nsString sender;</span>
<a href="#l12.4701"></a><span id="l12.4701">   nsresult rv = RowCellColumnToMime2DecodedString(row, colToken, sender);</span>
<a href="#l12.4702"></a><span id="l12.4702">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.4703"></a><span id="l12.4703"> </span>
<a href="#l12.4704"></a><span id="l12.4704">   nsString name;</span>
<a href="#l12.4705"></a><span id="l12.4705">   ExtractName(DecodedHeader(sender), name);</span>
<a href="#l12.4706"></a><span id="l12.4706">   return CreateCollationKey(name, len, result);</span>
<a href="#l12.4707"></a><span id="l12.4707"> }</span>
<a href="#l12.4708"></a><span id="l12.4708"> </span>
<a href="#l12.4709"></a><span id="l12.4709" class="difflineminus">-nsresult nsMsgDatabase::GetCollationKeyGenerator()</span>
<a href="#l12.4710"></a><span id="l12.4710" class="difflineminus">-{</span>
<a href="#l12.4711"></a><span id="l12.4711" class="difflineplus">+nsresult nsMsgDatabase::GetCollationKeyGenerator() {</span>
<a href="#l12.4712"></a><span id="l12.4712">   nsresult err = NS_OK;</span>
<a href="#l12.4713"></a><span id="l12.4713" class="difflineminus">-  if (!m_collationKeyGenerator)</span>
<a href="#l12.4714"></a><span id="l12.4714" class="difflineminus">-  {</span>
<a href="#l12.4715"></a><span id="l12.4715" class="difflineminus">-    nsCOMPtr &lt;nsICollationFactory&gt; f = do_CreateInstance(NS_COLLATIONFACTORY_CONTRACTID, &amp;err);</span>
<a href="#l12.4716"></a><span id="l12.4716" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; f)</span>
<a href="#l12.4717"></a><span id="l12.4717" class="difflineminus">-    {</span>
<a href="#l12.4718"></a><span id="l12.4718" class="difflineplus">+  if (!m_collationKeyGenerator) {</span>
<a href="#l12.4719"></a><span id="l12.4719" class="difflineplus">+    nsCOMPtr&lt;nsICollationFactory&gt; f =</span>
<a href="#l12.4720"></a><span id="l12.4720" class="difflineplus">+        do_CreateInstance(NS_COLLATIONFACTORY_CONTRACTID, &amp;err);</span>
<a href="#l12.4721"></a><span id="l12.4721" class="difflineplus">+    if (NS_SUCCEEDED(err) &amp;&amp; f) {</span>
<a href="#l12.4722"></a><span id="l12.4722">       // get a collation interface instance</span>
<a href="#l12.4723"></a><span id="l12.4723">       err = f-&gt;CreateCollation(getter_AddRefs(m_collationKeyGenerator));</span>
<a href="#l12.4724"></a><span id="l12.4724">     }</span>
<a href="#l12.4725"></a><span id="l12.4725">   }</span>
<a href="#l12.4726"></a><span id="l12.4726">   return err;</span>
<a href="#l12.4727"></a><span id="l12.4727"> }</span>
<a href="#l12.4728"></a><span id="l12.4728"> </span>
<a href="#l12.4729"></a><span id="l12.4729" class="difflineminus">-nsresult nsMsgDatabase::RowCellColumnToCollationKey(nsIMdbRow *row, mdb_token columnToken, uint8_t **result, uint32_t *len)</span>
<a href="#l12.4730"></a><span id="l12.4730" class="difflineminus">-{</span>
<a href="#l12.4731"></a><span id="l12.4731" class="difflineplus">+nsresult nsMsgDatabase::RowCellColumnToCollationKey(nsIMdbRow *row,</span>
<a href="#l12.4732"></a><span id="l12.4732" class="difflineplus">+                                                    mdb_token columnToken,</span>
<a href="#l12.4733"></a><span id="l12.4733" class="difflineplus">+                                                    uint8_t **result,</span>
<a href="#l12.4734"></a><span id="l12.4734" class="difflineplus">+                                                    uint32_t *len) {</span>
<a href="#l12.4735"></a><span id="l12.4735">   const char *nakedString = nullptr;</span>
<a href="#l12.4736"></a><span id="l12.4736">   nsresult err;</span>
<a href="#l12.4737"></a><span id="l12.4737"> </span>
<a href="#l12.4738"></a><span id="l12.4738">   err = RowCellColumnToConstCharPtr(row, columnToken, &amp;nakedString);</span>
<a href="#l12.4739"></a><span id="l12.4739" class="difflineminus">-  if (!nakedString)</span>
<a href="#l12.4740"></a><span id="l12.4740" class="difflineminus">-    nakedString = &quot;&quot;;</span>
<a href="#l12.4741"></a><span id="l12.4741" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l12.4742"></a><span id="l12.4742" class="difflineminus">-  {</span>
<a href="#l12.4743"></a><span id="l12.4743" class="difflineplus">+  if (!nakedString) nakedString = &quot;&quot;;</span>
<a href="#l12.4744"></a><span id="l12.4744" class="difflineplus">+  if (NS_SUCCEEDED(err)) {</span>
<a href="#l12.4745"></a><span id="l12.4745">     GetMimeConverter();</span>
<a href="#l12.4746"></a><span id="l12.4746" class="difflineminus">-    if (m_mimeConverter)</span>
<a href="#l12.4747"></a><span id="l12.4747" class="difflineminus">-    {</span>
<a href="#l12.4748"></a><span id="l12.4748" class="difflineplus">+    if (m_mimeConverter) {</span>
<a href="#l12.4749"></a><span id="l12.4749">       nsCString decodedStr;</span>
<a href="#l12.4750"></a><span id="l12.4750">       nsCString charSet;</span>
<a href="#l12.4751"></a><span id="l12.4751">       GetEffectiveCharset(row, charSet);</span>
<a href="#l12.4752"></a><span id="l12.4752"> </span>
<a href="#l12.4753"></a><span id="l12.4753">       err = m_mimeConverter-&gt;DecodeMimeHeaderToUTF8(</span>
<a href="#l12.4754"></a><span id="l12.4754" class="difflineminus">-        nsDependentCString(nakedString), charSet.get(), false,</span>
<a href="#l12.4755"></a><span id="l12.4755" class="difflineminus">-        true, decodedStr);</span>
<a href="#l12.4756"></a><span id="l12.4756" class="difflineplus">+          nsDependentCString(nakedString), charSet.get(), false, true,</span>
<a href="#l12.4757"></a><span id="l12.4757" class="difflineplus">+          decodedStr);</span>
<a href="#l12.4758"></a><span id="l12.4758">       if (NS_SUCCEEDED(err))</span>
<a href="#l12.4759"></a><span id="l12.4759" class="difflineminus">-        err = CreateCollationKey(NS_ConvertUTF8toUTF16(decodedStr), len, result);</span>
<a href="#l12.4760"></a><span id="l12.4760" class="difflineplus">+        err =</span>
<a href="#l12.4761"></a><span id="l12.4761" class="difflineplus">+            CreateCollationKey(NS_ConvertUTF8toUTF16(decodedStr), len, result);</span>
<a href="#l12.4762"></a><span id="l12.4762">     }</span>
<a href="#l12.4763"></a><span id="l12.4763">   }</span>
<a href="#l12.4764"></a><span id="l12.4764">   return err;</span>
<a href="#l12.4765"></a><span id="l12.4765"> }</span>
<a href="#l12.4766"></a><span id="l12.4766"> </span>
<a href="#l12.4767"></a><span id="l12.4767"> NS_IMETHODIMP</span>
<a href="#l12.4768"></a><span id="l12.4768"> nsMsgDatabase::CompareCollationKeys(uint32_t len1, uint8_t *key1, uint32_t len2,</span>
<a href="#l12.4769"></a><span id="l12.4769" class="difflineminus">-                                    uint8_t *key2, int32_t *result)</span>
<a href="#l12.4770"></a><span id="l12.4770" class="difflineminus">-{</span>
<a href="#l12.4771"></a><span id="l12.4771" class="difflineplus">+                                    uint8_t *key2, int32_t *result) {</span>
<a href="#l12.4772"></a><span id="l12.4772">   nsresult rv = GetCollationKeyGenerator();</span>
<a href="#l12.4773"></a><span id="l12.4773" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.4774"></a><span id="l12.4774" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.4775"></a><span id="l12.4775">   if (!m_collationKeyGenerator) return NS_ERROR_FAILURE;</span>
<a href="#l12.4776"></a><span id="l12.4776"> </span>
<a href="#l12.4777"></a><span id="l12.4777" class="difflineminus">-  rv = m_collationKeyGenerator-&gt;CompareRawSortKey(key1,len1,key2,len2,result);</span>
<a href="#l12.4778"></a><span id="l12.4778" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.4779"></a><span id="l12.4779" class="difflineplus">+  rv = m_collationKeyGenerator-&gt;CompareRawSortKey(key1, len1, key2, len2,</span>
<a href="#l12.4780"></a><span id="l12.4780" class="difflineplus">+                                                  result);</span>
<a href="#l12.4781"></a><span id="l12.4781" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.4782"></a><span id="l12.4782">   return rv;</span>
<a href="#l12.4783"></a><span id="l12.4783"> }</span>
<a href="#l12.4784"></a><span id="l12.4784"> </span>
<a href="#l12.4785"></a><span id="l12.4785"> NS_IMETHODIMP</span>
<a href="#l12.4786"></a><span id="l12.4786" class="difflineminus">-nsMsgDatabase::CreateCollationKey(const nsAString&amp; sourceString, uint32_t *len,</span>
<a href="#l12.4787"></a><span id="l12.4787" class="difflineminus">-                                  uint8_t **result)</span>
<a href="#l12.4788"></a><span id="l12.4788" class="difflineminus">-{</span>
<a href="#l12.4789"></a><span id="l12.4789" class="difflineplus">+nsMsgDatabase::CreateCollationKey(const nsAString &amp;sourceString, uint32_t *len,</span>
<a href="#l12.4790"></a><span id="l12.4790" class="difflineplus">+                                  uint8_t **result) {</span>
<a href="#l12.4791"></a><span id="l12.4791">   nsresult err = GetCollationKeyGenerator();</span>
<a href="#l12.4792"></a><span id="l12.4792" class="difflineminus">-  NS_ENSURE_SUCCESS(err,err);</span>
<a href="#l12.4793"></a><span id="l12.4793" class="difflineplus">+  NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l12.4794"></a><span id="l12.4794">   if (!m_collationKeyGenerator) return NS_ERROR_FAILURE;</span>
<a href="#l12.4795"></a><span id="l12.4795"> </span>
<a href="#l12.4796"></a><span id="l12.4796" class="difflineminus">-  err = m_collationKeyGenerator-&gt;AllocateRawSortKey(nsICollation::kCollationCaseInSensitive, sourceString, result, len);</span>
<a href="#l12.4797"></a><span id="l12.4797" class="difflineminus">-  NS_ENSURE_SUCCESS(err,err);</span>
<a href="#l12.4798"></a><span id="l12.4798" class="difflineplus">+  err = m_collationKeyGenerator-&gt;AllocateRawSortKey(</span>
<a href="#l12.4799"></a><span id="l12.4799" class="difflineplus">+      nsICollation::kCollationCaseInSensitive, sourceString, result, len);</span>
<a href="#l12.4800"></a><span id="l12.4800" class="difflineplus">+  NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l12.4801"></a><span id="l12.4801">   return err;</span>
<a href="#l12.4802"></a><span id="l12.4802"> }</span>
<a href="#l12.4803"></a><span id="l12.4803"> </span>
<a href="#l12.4804"></a><span id="l12.4804" class="difflineminus">-nsresult nsMsgDatabase::RowCellColumnToUInt32(nsIMdbRow *hdrRow, mdb_token columnToken, uint32_t &amp;uint32Result, uint32_t defaultValue)</span>
<a href="#l12.4805"></a><span id="l12.4805" class="difflineminus">-{</span>
<a href="#l12.4806"></a><span id="l12.4806" class="difflineminus">-  return RowCellColumnToUInt32(hdrRow, columnToken, &amp;uint32Result, defaultValue);</span>
<a href="#l12.4807"></a><span id="l12.4807" class="difflineminus">-}</span>
<a href="#l12.4808"></a><span id="l12.4808" class="difflineminus">-</span>
<a href="#l12.4809"></a><span id="l12.4809" class="difflineminus">-nsresult nsMsgDatabase::RowCellColumnToUInt32(nsIMdbRow *hdrRow, mdb_token columnToken, uint32_t *uint32Result, uint32_t defaultValue)</span>
<a href="#l12.4810"></a><span id="l12.4810" class="difflineminus">-{</span>
<a href="#l12.4811"></a><span id="l12.4811" class="difflineminus">-  nsresult  err = NS_OK;</span>
<a href="#l12.4812"></a><span id="l12.4812" class="difflineminus">-</span>
<a href="#l12.4813"></a><span id="l12.4813" class="difflineminus">-  if (uint32Result)</span>
<a href="#l12.4814"></a><span id="l12.4814" class="difflineminus">-    *uint32Result = defaultValue;</span>
<a href="#l12.4815"></a><span id="l12.4815" class="difflineplus">+nsresult nsMsgDatabase::RowCellColumnToUInt32(nsIMdbRow *hdrRow,</span>
<a href="#l12.4816"></a><span id="l12.4816" class="difflineplus">+                                              mdb_token columnToken,</span>
<a href="#l12.4817"></a><span id="l12.4817" class="difflineplus">+                                              uint32_t &amp;uint32Result,</span>
<a href="#l12.4818"></a><span id="l12.4818" class="difflineplus">+                                              uint32_t defaultValue) {</span>
<a href="#l12.4819"></a><span id="l12.4819" class="difflineplus">+  return RowCellColumnToUInt32(hdrRow, columnToken, &amp;uint32Result,</span>
<a href="#l12.4820"></a><span id="l12.4820" class="difflineplus">+                               defaultValue);</span>
<a href="#l12.4821"></a><span id="l12.4821" class="difflineplus">+}</span>
<a href="#l12.4822"></a><span id="l12.4822" class="difflineplus">+</span>
<a href="#l12.4823"></a><span id="l12.4823" class="difflineplus">+nsresult nsMsgDatabase::RowCellColumnToUInt32(nsIMdbRow *hdrRow,</span>
<a href="#l12.4824"></a><span id="l12.4824" class="difflineplus">+                                              mdb_token columnToken,</span>
<a href="#l12.4825"></a><span id="l12.4825" class="difflineplus">+                                              uint32_t *uint32Result,</span>
<a href="#l12.4826"></a><span id="l12.4826" class="difflineplus">+                                              uint32_t defaultValue) {</span>
<a href="#l12.4827"></a><span id="l12.4827" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l12.4828"></a><span id="l12.4828" class="difflineplus">+</span>
<a href="#l12.4829"></a><span id="l12.4829" class="difflineplus">+  if (uint32Result) *uint32Result = defaultValue;</span>
<a href="#l12.4830"></a><span id="l12.4830">   if (hdrRow)  // ### probably should be an error if hdrRow is NULL...</span>
<a href="#l12.4831"></a><span id="l12.4831">   {</span>
<a href="#l12.4832"></a><span id="l12.4832">     struct mdbYarn yarn;</span>
<a href="#l12.4833"></a><span id="l12.4833">     err = hdrRow-&gt;AliasCellYarn(GetEnv(), columnToken, &amp;yarn);</span>
<a href="#l12.4834"></a><span id="l12.4834" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l12.4835"></a><span id="l12.4835" class="difflineminus">-      YarnToUInt32(&amp;yarn, uint32Result);</span>
<a href="#l12.4836"></a><span id="l12.4836" class="difflineplus">+    if (NS_SUCCEEDED(err)) YarnToUInt32(&amp;yarn, uint32Result);</span>
<a href="#l12.4837"></a><span id="l12.4837">   }</span>
<a href="#l12.4838"></a><span id="l12.4838">   return err;</span>
<a href="#l12.4839"></a><span id="l12.4839"> }</span>
<a href="#l12.4840"></a><span id="l12.4840"> </span>
<a href="#l12.4841"></a><span id="l12.4841" class="difflineminus">-nsresult nsMsgDatabase::UInt32ToRowCellColumn(nsIMdbRow *row, mdb_token columnToken, uint32_t value)</span>
<a href="#l12.4842"></a><span id="l12.4842" class="difflineminus">-{</span>
<a href="#l12.4843"></a><span id="l12.4843" class="difflineplus">+nsresult nsMsgDatabase::UInt32ToRowCellColumn(nsIMdbRow *row,</span>
<a href="#l12.4844"></a><span id="l12.4844" class="difflineplus">+                                              mdb_token columnToken,</span>
<a href="#l12.4845"></a><span id="l12.4845" class="difflineplus">+                                              uint32_t value) {</span>
<a href="#l12.4846"></a><span id="l12.4846">   struct mdbYarn yarn;</span>
<a href="#l12.4847"></a><span id="l12.4847" class="difflineminus">-  char  yarnBuf[100];</span>
<a href="#l12.4848"></a><span id="l12.4848" class="difflineminus">-</span>
<a href="#l12.4849"></a><span id="l12.4849" class="difflineminus">-  if (!row)</span>
<a href="#l12.4850"></a><span id="l12.4850" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.4851"></a><span id="l12.4851" class="difflineminus">-</span>
<a href="#l12.4852"></a><span id="l12.4852" class="difflineminus">-  yarn.mYarn_Buf = (void *) yarnBuf;</span>
<a href="#l12.4853"></a><span id="l12.4853" class="difflineplus">+  char yarnBuf[100];</span>
<a href="#l12.4854"></a><span id="l12.4854" class="difflineplus">+</span>
<a href="#l12.4855"></a><span id="l12.4855" class="difflineplus">+  if (!row) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.4856"></a><span id="l12.4856" class="difflineplus">+</span>
<a href="#l12.4857"></a><span id="l12.4857" class="difflineplus">+  yarn.mYarn_Buf = (void *)yarnBuf;</span>
<a href="#l12.4858"></a><span id="l12.4858">   yarn.mYarn_Size = sizeof(yarnBuf);</span>
<a href="#l12.4859"></a><span id="l12.4859">   yarn.mYarn_Fill = yarn.mYarn_Size;</span>
<a href="#l12.4860"></a><span id="l12.4860">   yarn.mYarn_Form = 0;</span>
<a href="#l12.4861"></a><span id="l12.4861">   yarn.mYarn_Grow = NULL;</span>
<a href="#l12.4862"></a><span id="l12.4862" class="difflineminus">-  return row-&gt;AddColumn(GetEnv(),  columnToken, UInt32ToYarn(&amp;yarn, value));</span>
<a href="#l12.4863"></a><span id="l12.4863" class="difflineminus">-}</span>
<a href="#l12.4864"></a><span id="l12.4864" class="difflineminus">-</span>
<a href="#l12.4865"></a><span id="l12.4865" class="difflineminus">-nsresult nsMsgDatabase::UInt64ToRowCellColumn(nsIMdbRow *row, mdb_token columnToken, uint64_t value)</span>
<a href="#l12.4866"></a><span id="l12.4866" class="difflineminus">-{</span>
<a href="#l12.4867"></a><span id="l12.4867" class="difflineplus">+  return row-&gt;AddColumn(GetEnv(), columnToken, UInt32ToYarn(&amp;yarn, value));</span>
<a href="#l12.4868"></a><span id="l12.4868" class="difflineplus">+}</span>
<a href="#l12.4869"></a><span id="l12.4869" class="difflineplus">+</span>
<a href="#l12.4870"></a><span id="l12.4870" class="difflineplus">+nsresult nsMsgDatabase::UInt64ToRowCellColumn(nsIMdbRow *row,</span>
<a href="#l12.4871"></a><span id="l12.4871" class="difflineplus">+                                              mdb_token columnToken,</span>
<a href="#l12.4872"></a><span id="l12.4872" class="difflineplus">+                                              uint64_t value) {</span>
<a href="#l12.4873"></a><span id="l12.4873">   NS_ENSURE_ARG_POINTER(row);</span>
<a href="#l12.4874"></a><span id="l12.4874">   struct mdbYarn yarn;</span>
<a href="#l12.4875"></a><span id="l12.4875" class="difflineminus">-  char  yarnBuf[17]; // max string is 16 bytes, + 1 for null.</span>
<a href="#l12.4876"></a><span id="l12.4876" class="difflineminus">-</span>
<a href="#l12.4877"></a><span id="l12.4877" class="difflineminus">-  yarn.mYarn_Buf = (void *) yarnBuf;</span>
<a href="#l12.4878"></a><span id="l12.4878" class="difflineplus">+  char yarnBuf[17];  // max string is 16 bytes, + 1 for null.</span>
<a href="#l12.4879"></a><span id="l12.4879" class="difflineplus">+</span>
<a href="#l12.4880"></a><span id="l12.4880" class="difflineplus">+  yarn.mYarn_Buf = (void *)yarnBuf;</span>
<a href="#l12.4881"></a><span id="l12.4881">   yarn.mYarn_Size = sizeof(yarnBuf);</span>
<a href="#l12.4882"></a><span id="l12.4882">   yarn.mYarn_Form = 0;</span>
<a href="#l12.4883"></a><span id="l12.4883">   yarn.mYarn_Grow = NULL;</span>
<a href="#l12.4884"></a><span id="l12.4884" class="difflineminus">-  PR_snprintf((char *) yarn.mYarn_Buf, yarn.mYarn_Size, &quot;%llx&quot;, value);</span>
<a href="#l12.4885"></a><span id="l12.4885" class="difflineminus">-  yarn.mYarn_Fill = PL_strlen((const char *) yarn.mYarn_Buf);</span>
<a href="#l12.4886"></a><span id="l12.4886" class="difflineminus">-  return row-&gt;AddColumn(GetEnv(),  columnToken, &amp;yarn);</span>
<a href="#l12.4887"></a><span id="l12.4887" class="difflineminus">-}</span>
<a href="#l12.4888"></a><span id="l12.4888" class="difflineminus">-</span>
<a href="#l12.4889"></a><span id="l12.4889" class="difflineminus">-nsresult</span>
<a href="#l12.4890"></a><span id="l12.4890" class="difflineminus">-nsMsgDatabase::RowCellColumnToUInt64(nsIMdbRow *hdrRow, mdb_token columnToken,</span>
<a href="#l12.4891"></a><span id="l12.4891" class="difflineminus">-                                     uint64_t *uint64Result,</span>
<a href="#l12.4892"></a><span id="l12.4892" class="difflineminus">-                                     uint64_t defaultValue)</span>
<a href="#l12.4893"></a><span id="l12.4893" class="difflineminus">-{</span>
<a href="#l12.4894"></a><span id="l12.4894" class="difflineminus">-  nsresult  err = NS_OK;</span>
<a href="#l12.4895"></a><span id="l12.4895" class="difflineminus">-</span>
<a href="#l12.4896"></a><span id="l12.4896" class="difflineminus">-  if (uint64Result)</span>
<a href="#l12.4897"></a><span id="l12.4897" class="difflineminus">-    *uint64Result = defaultValue;</span>
<a href="#l12.4898"></a><span id="l12.4898" class="difflineplus">+  PR_snprintf((char *)yarn.mYarn_Buf, yarn.mYarn_Size, &quot;%llx&quot;, value);</span>
<a href="#l12.4899"></a><span id="l12.4899" class="difflineplus">+  yarn.mYarn_Fill = PL_strlen((const char *)yarn.mYarn_Buf);</span>
<a href="#l12.4900"></a><span id="l12.4900" class="difflineplus">+  return row-&gt;AddColumn(GetEnv(), columnToken, &amp;yarn);</span>
<a href="#l12.4901"></a><span id="l12.4901" class="difflineplus">+}</span>
<a href="#l12.4902"></a><span id="l12.4902" class="difflineplus">+</span>
<a href="#l12.4903"></a><span id="l12.4903" class="difflineplus">+nsresult nsMsgDatabase::RowCellColumnToUInt64(nsIMdbRow *hdrRow,</span>
<a href="#l12.4904"></a><span id="l12.4904" class="difflineplus">+                                              mdb_token columnToken,</span>
<a href="#l12.4905"></a><span id="l12.4905" class="difflineplus">+                                              uint64_t *uint64Result,</span>
<a href="#l12.4906"></a><span id="l12.4906" class="difflineplus">+                                              uint64_t defaultValue) {</span>
<a href="#l12.4907"></a><span id="l12.4907" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l12.4908"></a><span id="l12.4908" class="difflineplus">+</span>
<a href="#l12.4909"></a><span id="l12.4909" class="difflineplus">+  if (uint64Result) *uint64Result = defaultValue;</span>
<a href="#l12.4910"></a><span id="l12.4910">   if (hdrRow)  // ### probably should be an error if hdrRow is NULL...</span>
<a href="#l12.4911"></a><span id="l12.4911">   {</span>
<a href="#l12.4912"></a><span id="l12.4912">     struct mdbYarn yarn;</span>
<a href="#l12.4913"></a><span id="l12.4913">     err = hdrRow-&gt;AliasCellYarn(GetEnv(), columnToken, &amp;yarn);</span>
<a href="#l12.4914"></a><span id="l12.4914" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l12.4915"></a><span id="l12.4915" class="difflineminus">-      YarnToUInt64(&amp;yarn, uint64Result);</span>
<a href="#l12.4916"></a><span id="l12.4916" class="difflineplus">+    if (NS_SUCCEEDED(err)) YarnToUInt64(&amp;yarn, uint64Result);</span>
<a href="#l12.4917"></a><span id="l12.4917">   }</span>
<a href="#l12.4918"></a><span id="l12.4918">   return err;</span>
<a href="#l12.4919"></a><span id="l12.4919"> }</span>
<a href="#l12.4920"></a><span id="l12.4920"> </span>
<a href="#l12.4921"></a><span id="l12.4921" class="difflineminus">-nsresult nsMsgDatabase::CharPtrToRowCellColumn(nsIMdbRow *row, mdb_token columnToken, const char *charPtr)</span>
<a href="#l12.4922"></a><span id="l12.4922" class="difflineminus">-{</span>
<a href="#l12.4923"></a><span id="l12.4923" class="difflineminus">-  if (!row)</span>
<a href="#l12.4924"></a><span id="l12.4924" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.4925"></a><span id="l12.4925" class="difflineplus">+nsresult nsMsgDatabase::CharPtrToRowCellColumn(nsIMdbRow *row,</span>
<a href="#l12.4926"></a><span id="l12.4926" class="difflineplus">+                                               mdb_token columnToken,</span>
<a href="#l12.4927"></a><span id="l12.4927" class="difflineplus">+                                               const char *charPtr) {</span>
<a href="#l12.4928"></a><span id="l12.4928" class="difflineplus">+  if (!row) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.4929"></a><span id="l12.4929"> </span>
<a href="#l12.4930"></a><span id="l12.4930">   struct mdbYarn yarn;</span>
<a href="#l12.4931"></a><span id="l12.4931" class="difflineminus">-  yarn.mYarn_Buf = (void *) charPtr;</span>
<a href="#l12.4932"></a><span id="l12.4932" class="difflineminus">-  yarn.mYarn_Size = PL_strlen((const char *) yarn.mYarn_Buf) + 1;</span>
<a href="#l12.4933"></a><span id="l12.4933" class="difflineplus">+  yarn.mYarn_Buf = (void *)charPtr;</span>
<a href="#l12.4934"></a><span id="l12.4934" class="difflineplus">+  yarn.mYarn_Size = PL_strlen((const char *)yarn.mYarn_Buf) + 1;</span>
<a href="#l12.4935"></a><span id="l12.4935">   yarn.mYarn_Fill = yarn.mYarn_Size - 1;</span>
<a href="#l12.4936"></a><span id="l12.4936" class="difflineminus">-  yarn.mYarn_Form = 0;  // what to do with this? we're storing csid in the msg hdr...</span>
<a href="#l12.4937"></a><span id="l12.4937" class="difflineminus">-</span>
<a href="#l12.4938"></a><span id="l12.4938" class="difflineminus">-  return row-&gt;AddColumn(GetEnv(),  columnToken, &amp;yarn);</span>
<a href="#l12.4939"></a><span id="l12.4939" class="difflineplus">+  yarn.mYarn_Form =</span>
<a href="#l12.4940"></a><span id="l12.4940" class="difflineplus">+      0;  // what to do with this? we're storing csid in the msg hdr...</span>
<a href="#l12.4941"></a><span id="l12.4941" class="difflineplus">+</span>
<a href="#l12.4942"></a><span id="l12.4942" class="difflineplus">+  return row-&gt;AddColumn(GetEnv(), columnToken, &amp;yarn);</span>
<a href="#l12.4943"></a><span id="l12.4943"> }</span>
<a href="#l12.4944"></a><span id="l12.4944"> </span>
<a href="#l12.4945"></a><span id="l12.4945"> // caller must free result</span>
<a href="#l12.4946"></a><span id="l12.4946" class="difflineminus">-nsresult nsMsgDatabase::RowCellColumnToCharPtr(nsIMdbRow *row, mdb_token columnToken, char **result)</span>
<a href="#l12.4947"></a><span id="l12.4947" class="difflineminus">-{</span>
<a href="#l12.4948"></a><span id="l12.4948" class="difflineminus">-  nsresult  err = NS_ERROR_NULL_POINTER;</span>
<a href="#l12.4949"></a><span id="l12.4949" class="difflineminus">-</span>
<a href="#l12.4950"></a><span id="l12.4950" class="difflineminus">-  if (row &amp;&amp; result)</span>
<a href="#l12.4951"></a><span id="l12.4951" class="difflineminus">-  {</span>
<a href="#l12.4952"></a><span id="l12.4952" class="difflineplus">+nsresult nsMsgDatabase::RowCellColumnToCharPtr(nsIMdbRow *row,</span>
<a href="#l12.4953"></a><span id="l12.4953" class="difflineplus">+                                               mdb_token columnToken,</span>
<a href="#l12.4954"></a><span id="l12.4954" class="difflineplus">+                                               char **result) {</span>
<a href="#l12.4955"></a><span id="l12.4955" class="difflineplus">+  nsresult err = NS_ERROR_NULL_POINTER;</span>
<a href="#l12.4956"></a><span id="l12.4956" class="difflineplus">+</span>
<a href="#l12.4957"></a><span id="l12.4957" class="difflineplus">+  if (row &amp;&amp; result) {</span>
<a href="#l12.4958"></a><span id="l12.4958">     struct mdbYarn yarn;</span>
<a href="#l12.4959"></a><span id="l12.4959">     err = row-&gt;AliasCellYarn(GetEnv(), columnToken, &amp;yarn);</span>
<a href="#l12.4960"></a><span id="l12.4960" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l12.4961"></a><span id="l12.4961" class="difflineminus">-    {</span>
<a href="#l12.4962"></a><span id="l12.4962" class="difflineplus">+    if (NS_SUCCEEDED(err)) {</span>
<a href="#l12.4963"></a><span id="l12.4963">       *result = (char *)moz_xmalloc(yarn.mYarn_Fill + 1);</span>
<a href="#l12.4964"></a><span id="l12.4964" class="difflineminus">-      if (*result)</span>
<a href="#l12.4965"></a><span id="l12.4965" class="difflineminus">-      {</span>
<a href="#l12.4966"></a><span id="l12.4966" class="difflineplus">+      if (*result) {</span>
<a href="#l12.4967"></a><span id="l12.4967">         if (yarn.mYarn_Fill &gt; 0)</span>
<a href="#l12.4968"></a><span id="l12.4968">           memcpy(*result, yarn.mYarn_Buf, yarn.mYarn_Fill);</span>
<a href="#l12.4969"></a><span id="l12.4969">         (*result)[yarn.mYarn_Fill] = '\0';</span>
<a href="#l12.4970"></a><span id="l12.4970" class="difflineminus">-      }</span>
<a href="#l12.4971"></a><span id="l12.4971" class="difflineminus">-      else</span>
<a href="#l12.4972"></a><span id="l12.4972" class="difflineplus">+      } else</span>
<a href="#l12.4973"></a><span id="l12.4973">         err = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.4974"></a><span id="l12.4974" class="difflineminus">-</span>
<a href="#l12.4975"></a><span id="l12.4975">     }</span>
<a href="#l12.4976"></a><span id="l12.4976">   }</span>
<a href="#l12.4977"></a><span id="l12.4977">   return err;</span>
<a href="#l12.4978"></a><span id="l12.4978"> }</span>
<a href="#l12.4979"></a><span id="l12.4979"> </span>
<a href="#l12.4980"></a><span id="l12.4980" class="difflineminus">-</span>
<a href="#l12.4981"></a><span id="l12.4981" class="difflineminus">-</span>
<a href="#l12.4982"></a><span id="l12.4982" class="difflineminus">-/* static */struct mdbYarn *nsMsgDatabase::nsStringToYarn(struct mdbYarn *yarn, const nsAString &amp;str)</span>
<a href="#l12.4983"></a><span id="l12.4983" class="difflineminus">-{</span>
<a href="#l12.4984"></a><span id="l12.4984" class="difflineplus">+/* static */ struct mdbYarn *nsMsgDatabase::nsStringToYarn(</span>
<a href="#l12.4985"></a><span id="l12.4985" class="difflineplus">+    struct mdbYarn *yarn, const nsAString &amp;str) {</span>
<a href="#l12.4986"></a><span id="l12.4986">   yarn-&gt;mYarn_Buf = ToNewCString(NS_ConvertUTF16toUTF8(str));</span>
<a href="#l12.4987"></a><span id="l12.4987">   yarn-&gt;mYarn_Size = str.Length() + 1;</span>
<a href="#l12.4988"></a><span id="l12.4988">   yarn-&gt;mYarn_Fill = yarn-&gt;mYarn_Size - 1;</span>
<a href="#l12.4989"></a><span id="l12.4989" class="difflineminus">-  yarn-&gt;mYarn_Form = 0;  // what to do with this? we're storing csid in the msg hdr...</span>
<a href="#l12.4990"></a><span id="l12.4990" class="difflineplus">+  yarn-&gt;mYarn_Form =</span>
<a href="#l12.4991"></a><span id="l12.4991" class="difflineplus">+      0;  // what to do with this? we're storing csid in the msg hdr...</span>
<a href="#l12.4992"></a><span id="l12.4992">   return yarn;</span>
<a href="#l12.4993"></a><span id="l12.4993"> }</span>
<a href="#l12.4994"></a><span id="l12.4994"> </span>
<a href="#l12.4995"></a><span id="l12.4995" class="difflineminus">-/* static */struct mdbYarn *nsMsgDatabase::UInt32ToYarn(struct mdbYarn *yarn, uint32_t i)</span>
<a href="#l12.4996"></a><span id="l12.4996" class="difflineminus">-{</span>
<a href="#l12.4997"></a><span id="l12.4997" class="difflineminus">-  PR_snprintf((char *) yarn-&gt;mYarn_Buf, yarn-&gt;mYarn_Size, &quot;%lx&quot;, i);</span>
<a href="#l12.4998"></a><span id="l12.4998" class="difflineminus">-  yarn-&gt;mYarn_Fill = PL_strlen((const char *) yarn-&gt;mYarn_Buf);</span>
<a href="#l12.4999"></a><span id="l12.4999" class="difflineminus">-  yarn-&gt;mYarn_Form = 0;  // what to do with this? Should be parsed out of the mime2 header?</span>
<a href="#l12.5000"></a><span id="l12.5000" class="difflineplus">+/* static */ struct mdbYarn *nsMsgDatabase::UInt32ToYarn(struct mdbYarn *yarn,</span>
<a href="#l12.5001"></a><span id="l12.5001" class="difflineplus">+                                                         uint32_t i) {</span>
<a href="#l12.5002"></a><span id="l12.5002" class="difflineplus">+  PR_snprintf((char *)yarn-&gt;mYarn_Buf, yarn-&gt;mYarn_Size, &quot;%lx&quot;, i);</span>
<a href="#l12.5003"></a><span id="l12.5003" class="difflineplus">+  yarn-&gt;mYarn_Fill = PL_strlen((const char *)yarn-&gt;mYarn_Buf);</span>
<a href="#l12.5004"></a><span id="l12.5004" class="difflineplus">+  yarn-&gt;mYarn_Form =</span>
<a href="#l12.5005"></a><span id="l12.5005" class="difflineplus">+      0;  // what to do with this? Should be parsed out of the mime2 header?</span>
<a href="#l12.5006"></a><span id="l12.5006">   return yarn;</span>
<a href="#l12.5007"></a><span id="l12.5007"> }</span>
<a href="#l12.5008"></a><span id="l12.5008"> </span>
<a href="#l12.5009"></a><span id="l12.5009" class="difflineminus">-/* static */struct mdbYarn *nsMsgDatabase::UInt64ToYarn(struct mdbYarn *yarn, uint64_t i)</span>
<a href="#l12.5010"></a><span id="l12.5010" class="difflineminus">-{</span>
<a href="#l12.5011"></a><span id="l12.5011" class="difflineminus">-  PR_snprintf((char *) yarn-&gt;mYarn_Buf, yarn-&gt;mYarn_Size, &quot;%llx&quot;, i);</span>
<a href="#l12.5012"></a><span id="l12.5012" class="difflineminus">-  yarn-&gt;mYarn_Fill = PL_strlen((const char *) yarn-&gt;mYarn_Buf);</span>
<a href="#l12.5013"></a><span id="l12.5013" class="difflineplus">+/* static */ struct mdbYarn *nsMsgDatabase::UInt64ToYarn(struct mdbYarn *yarn,</span>
<a href="#l12.5014"></a><span id="l12.5014" class="difflineplus">+                                                         uint64_t i) {</span>
<a href="#l12.5015"></a><span id="l12.5015" class="difflineplus">+  PR_snprintf((char *)yarn-&gt;mYarn_Buf, yarn-&gt;mYarn_Size, &quot;%llx&quot;, i);</span>
<a href="#l12.5016"></a><span id="l12.5016" class="difflineplus">+  yarn-&gt;mYarn_Fill = PL_strlen((const char *)yarn-&gt;mYarn_Buf);</span>
<a href="#l12.5017"></a><span id="l12.5017">   yarn-&gt;mYarn_Form = 0;</span>
<a href="#l12.5018"></a><span id="l12.5018">   return yarn;</span>
<a href="#l12.5019"></a><span id="l12.5019"> }</span>
<a href="#l12.5020"></a><span id="l12.5020"> </span>
<a href="#l12.5021"></a><span id="l12.5021" class="difflineminus">-/* static */void nsMsgDatabase::YarnTonsString(struct mdbYarn *yarn, nsAString &amp;str)</span>
<a href="#l12.5022"></a><span id="l12.5022" class="difflineminus">-{</span>
<a href="#l12.5023"></a><span id="l12.5023" class="difflineminus">-  const char* buf = (const char*)yarn-&gt;mYarn_Buf;</span>
<a href="#l12.5024"></a><span id="l12.5024" class="difflineplus">+/* static */ void nsMsgDatabase::YarnTonsString(struct mdbYarn *yarn,</span>
<a href="#l12.5025"></a><span id="l12.5025" class="difflineplus">+                                                nsAString &amp;str) {</span>
<a href="#l12.5026"></a><span id="l12.5026" class="difflineplus">+  const char *buf = (const char *)yarn-&gt;mYarn_Buf;</span>
<a href="#l12.5027"></a><span id="l12.5027">   if (buf)</span>
<a href="#l12.5028"></a><span id="l12.5028">     CopyASCIItoUTF16(Substring(buf, buf + yarn-&gt;mYarn_Fill), str);</span>
<a href="#l12.5029"></a><span id="l12.5029">   else</span>
<a href="#l12.5030"></a><span id="l12.5030">     str.Truncate();</span>
<a href="#l12.5031"></a><span id="l12.5031"> }</span>
<a href="#l12.5032"></a><span id="l12.5032"> </span>
<a href="#l12.5033"></a><span id="l12.5033" class="difflineminus">-/* static */void nsMsgDatabase::YarnTonsCString(struct mdbYarn *yarn, nsACString &amp;str)</span>
<a href="#l12.5034"></a><span id="l12.5034" class="difflineminus">-{</span>
<a href="#l12.5035"></a><span id="l12.5035" class="difflineminus">-    const char* buf = (const char*)yarn-&gt;mYarn_Buf;</span>
<a href="#l12.5036"></a><span id="l12.5036" class="difflineminus">-    if (buf)</span>
<a href="#l12.5037"></a><span id="l12.5037" class="difflineminus">-        str.Assign(buf, yarn-&gt;mYarn_Fill);</span>
<a href="#l12.5038"></a><span id="l12.5038" class="difflineminus">-    else</span>
<a href="#l12.5039"></a><span id="l12.5039" class="difflineminus">-        str.Truncate();</span>
<a href="#l12.5040"></a><span id="l12.5040" class="difflineplus">+/* static */ void nsMsgDatabase::YarnTonsCString(struct mdbYarn *yarn,</span>
<a href="#l12.5041"></a><span id="l12.5041" class="difflineplus">+                                                 nsACString &amp;str) {</span>
<a href="#l12.5042"></a><span id="l12.5042" class="difflineplus">+  const char *buf = (const char *)yarn-&gt;mYarn_Buf;</span>
<a href="#l12.5043"></a><span id="l12.5043" class="difflineplus">+  if (buf)</span>
<a href="#l12.5044"></a><span id="l12.5044" class="difflineplus">+    str.Assign(buf, yarn-&gt;mYarn_Fill);</span>
<a href="#l12.5045"></a><span id="l12.5045" class="difflineplus">+  else</span>
<a href="#l12.5046"></a><span id="l12.5046" class="difflineplus">+    str.Truncate();</span>
<a href="#l12.5047"></a><span id="l12.5047"> }</span>
<a href="#l12.5048"></a><span id="l12.5048"> </span>
<a href="#l12.5049"></a><span id="l12.5049"> // WARNING - if yarn is empty, *pResult will not be changed!!!!</span>
<a href="#l12.5050"></a><span id="l12.5050"> // this is so we can leave default values as they were.</span>
<a href="#l12.5051"></a><span id="l12.5051" class="difflineminus">-/* static */void nsMsgDatabase::YarnToUInt32(struct mdbYarn *yarn, uint32_t *pResult)</span>
<a href="#l12.5052"></a><span id="l12.5052" class="difflineminus">-{</span>
<a href="#l12.5053"></a><span id="l12.5053" class="difflineplus">+/* static */ void nsMsgDatabase::YarnToUInt32(struct mdbYarn *yarn,</span>
<a href="#l12.5054"></a><span id="l12.5054" class="difflineplus">+                                              uint32_t *pResult) {</span>
<a href="#l12.5055"></a><span id="l12.5055">   uint8_t numChars = std::min&lt;mdb_fill&gt;(8, yarn-&gt;mYarn_Fill);</span>
<a href="#l12.5056"></a><span id="l12.5056"> </span>
<a href="#l12.5057"></a><span id="l12.5057" class="difflineminus">-  if (numChars == 0)</span>
<a href="#l12.5058"></a><span id="l12.5058" class="difflineminus">-    return;</span>
<a href="#l12.5059"></a><span id="l12.5059" class="difflineminus">-</span>
<a href="#l12.5060"></a><span id="l12.5060" class="difflineminus">-  *pResult = MsgUnhex((char *) yarn-&gt;mYarn_Buf, numChars);</span>
<a href="#l12.5061"></a><span id="l12.5061" class="difflineplus">+  if (numChars == 0) return;</span>
<a href="#l12.5062"></a><span id="l12.5062" class="difflineplus">+</span>
<a href="#l12.5063"></a><span id="l12.5063" class="difflineplus">+  *pResult = MsgUnhex((char *)yarn-&gt;mYarn_Buf, numChars);</span>
<a href="#l12.5064"></a><span id="l12.5064"> }</span>
<a href="#l12.5065"></a><span id="l12.5065"> </span>
<a href="#l12.5066"></a><span id="l12.5066"> // WARNING - if yarn is empty, *pResult will not be changed!!!!</span>
<a href="#l12.5067"></a><span id="l12.5067"> // this is so we can leave default values as they were.</span>
<a href="#l12.5068"></a><span id="l12.5068" class="difflineminus">-/* static */void nsMsgDatabase::YarnToUInt64(struct mdbYarn *yarn, uint64_t *pResult)</span>
<a href="#l12.5069"></a><span id="l12.5069" class="difflineminus">-{</span>
<a href="#l12.5070"></a><span id="l12.5070" class="difflineplus">+/* static */ void nsMsgDatabase::YarnToUInt64(struct mdbYarn *yarn,</span>
<a href="#l12.5071"></a><span id="l12.5071" class="difflineplus">+                                              uint64_t *pResult) {</span>
<a href="#l12.5072"></a><span id="l12.5072">   uint8_t numChars = std::min&lt;mdb_fill&gt;(16, yarn-&gt;mYarn_Fill);</span>
<a href="#l12.5073"></a><span id="l12.5073"> </span>
<a href="#l12.5074"></a><span id="l12.5074" class="difflineminus">-  if (numChars == 0)</span>
<a href="#l12.5075"></a><span id="l12.5075" class="difflineminus">-    return;</span>
<a href="#l12.5076"></a><span id="l12.5076" class="difflineminus">-</span>
<a href="#l12.5077"></a><span id="l12.5077" class="difflineminus">-  *pResult = MsgUnhex((char *) yarn-&gt;mYarn_Buf, numChars);</span>
<a href="#l12.5078"></a><span id="l12.5078" class="difflineminus">-}</span>
<a href="#l12.5079"></a><span id="l12.5079" class="difflineminus">-</span>
<a href="#l12.5080"></a><span id="l12.5080" class="difflineminus">-nsresult nsMsgDatabase::GetProperty(nsIMdbRow *row, const char *propertyName, char **result)</span>
<a href="#l12.5081"></a><span id="l12.5081" class="difflineminus">-{</span>
<a href="#l12.5082"></a><span id="l12.5082" class="difflineplus">+  if (numChars == 0) return;</span>
<a href="#l12.5083"></a><span id="l12.5083" class="difflineplus">+</span>
<a href="#l12.5084"></a><span id="l12.5084" class="difflineplus">+  *pResult = MsgUnhex((char *)yarn-&gt;mYarn_Buf, numChars);</span>
<a href="#l12.5085"></a><span id="l12.5085" class="difflineplus">+}</span>
<a href="#l12.5086"></a><span id="l12.5086" class="difflineplus">+</span>
<a href="#l12.5087"></a><span id="l12.5087" class="difflineplus">+nsresult nsMsgDatabase::GetProperty(nsIMdbRow *row, const char *propertyName,</span>
<a href="#l12.5088"></a><span id="l12.5088" class="difflineplus">+                                    char **result) {</span>
<a href="#l12.5089"></a><span id="l12.5089">   nsresult err = NS_OK;</span>
<a href="#l12.5090"></a><span id="l12.5090" class="difflineminus">-  mdb_token  property_token;</span>
<a href="#l12.5091"></a><span id="l12.5091" class="difflineplus">+  mdb_token property_token;</span>
<a href="#l12.5092"></a><span id="l12.5092"> </span>
<a href="#l12.5093"></a><span id="l12.5093">   if (m_mdbStore)</span>
<a href="#l12.5094"></a><span id="l12.5094" class="difflineminus">-    err = m_mdbStore-&gt;StringToToken(GetEnv(),  propertyName, &amp;property_token);</span>
<a href="#l12.5095"></a><span id="l12.5095" class="difflineplus">+    err = m_mdbStore-&gt;StringToToken(GetEnv(), propertyName, &amp;property_token);</span>
<a href="#l12.5096"></a><span id="l12.5096">   else</span>
<a href="#l12.5097"></a><span id="l12.5097">     err = NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5098"></a><span id="l12.5098">   if (NS_SUCCEEDED(err))</span>
<a href="#l12.5099"></a><span id="l12.5099">     err = RowCellColumnToCharPtr(row, property_token, result);</span>
<a href="#l12.5100"></a><span id="l12.5100"> </span>
<a href="#l12.5101"></a><span id="l12.5101">   return err;</span>
<a href="#l12.5102"></a><span id="l12.5102"> }</span>
<a href="#l12.5103"></a><span id="l12.5103"> </span>
<a href="#l12.5104"></a><span id="l12.5104" class="difflineminus">-nsresult nsMsgDatabase::SetProperty(nsIMdbRow *row, const char *propertyName, const char *propertyVal)</span>
<a href="#l12.5105"></a><span id="l12.5105" class="difflineminus">-{</span>
<a href="#l12.5106"></a><span id="l12.5106" class="difflineplus">+nsresult nsMsgDatabase::SetProperty(nsIMdbRow *row, const char *propertyName,</span>
<a href="#l12.5107"></a><span id="l12.5107" class="difflineplus">+                                    const char *propertyVal) {</span>
<a href="#l12.5108"></a><span id="l12.5108">   nsresult err = NS_OK;</span>
<a href="#l12.5109"></a><span id="l12.5109" class="difflineminus">-  mdb_token  property_token;</span>
<a href="#l12.5110"></a><span id="l12.5110" class="difflineminus">-</span>
<a href="#l12.5111"></a><span id="l12.5111" class="difflineminus">-  NS_ENSURE_STATE(m_mdbStore); // db might have been closed out from under us.</span>
<a href="#l12.5112"></a><span id="l12.5112" class="difflineminus">-  if (!row)</span>
<a href="#l12.5113"></a><span id="l12.5113" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5114"></a><span id="l12.5114" class="difflineminus">-</span>
<a href="#l12.5115"></a><span id="l12.5115" class="difflineminus">-  err = m_mdbStore-&gt;StringToToken(GetEnv(),  propertyName, &amp;property_token);</span>
<a href="#l12.5116"></a><span id="l12.5116" class="difflineplus">+  mdb_token property_token;</span>
<a href="#l12.5117"></a><span id="l12.5117" class="difflineplus">+</span>
<a href="#l12.5118"></a><span id="l12.5118" class="difflineplus">+  NS_ENSURE_STATE(m_mdbStore);  // db might have been closed out from under us.</span>
<a href="#l12.5119"></a><span id="l12.5119" class="difflineplus">+  if (!row) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5120"></a><span id="l12.5120" class="difflineplus">+</span>
<a href="#l12.5121"></a><span id="l12.5121" class="difflineplus">+  err = m_mdbStore-&gt;StringToToken(GetEnv(), propertyName, &amp;property_token);</span>
<a href="#l12.5122"></a><span id="l12.5122">   if (NS_SUCCEEDED(err))</span>
<a href="#l12.5123"></a><span id="l12.5123">     CharPtrToRowCellColumn(row, property_token, propertyVal);</span>
<a href="#l12.5124"></a><span id="l12.5124">   return err;</span>
<a href="#l12.5125"></a><span id="l12.5125"> }</span>
<a href="#l12.5126"></a><span id="l12.5126"> </span>
<a href="#l12.5127"></a><span id="l12.5127" class="difflineminus">-nsresult nsMsgDatabase::GetPropertyAsNSString(nsIMdbRow *row, const char *propertyName, nsAString &amp;result)</span>
<a href="#l12.5128"></a><span id="l12.5128" class="difflineminus">-{</span>
<a href="#l12.5129"></a><span id="l12.5129" class="difflineplus">+nsresult nsMsgDatabase::GetPropertyAsNSString(nsIMdbRow *row,</span>
<a href="#l12.5130"></a><span id="l12.5130" class="difflineplus">+                                              const char *propertyName,</span>
<a href="#l12.5131"></a><span id="l12.5131" class="difflineplus">+                                              nsAString &amp;result) {</span>
<a href="#l12.5132"></a><span id="l12.5132">   nsresult err = NS_OK;</span>
<a href="#l12.5133"></a><span id="l12.5133" class="difflineminus">-  mdb_token  property_token;</span>
<a href="#l12.5134"></a><span id="l12.5134" class="difflineminus">-</span>
<a href="#l12.5135"></a><span id="l12.5135" class="difflineminus">-  NS_ENSURE_STATE(m_mdbStore); // db might have been closed out from under us.</span>
<a href="#l12.5136"></a><span id="l12.5136" class="difflineminus">-  if (!row)</span>
<a href="#l12.5137"></a><span id="l12.5137" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5138"></a><span id="l12.5138" class="difflineminus">-</span>
<a href="#l12.5139"></a><span id="l12.5139" class="difflineminus">-  err = m_mdbStore-&gt;StringToToken(GetEnv(),  propertyName, &amp;property_token);</span>
<a href="#l12.5140"></a><span id="l12.5140" class="difflineplus">+  mdb_token property_token;</span>
<a href="#l12.5141"></a><span id="l12.5141" class="difflineplus">+</span>
<a href="#l12.5142"></a><span id="l12.5142" class="difflineplus">+  NS_ENSURE_STATE(m_mdbStore);  // db might have been closed out from under us.</span>
<a href="#l12.5143"></a><span id="l12.5143" class="difflineplus">+  if (!row) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5144"></a><span id="l12.5144" class="difflineplus">+</span>
<a href="#l12.5145"></a><span id="l12.5145" class="difflineplus">+  err = m_mdbStore-&gt;StringToToken(GetEnv(), propertyName, &amp;property_token);</span>
<a href="#l12.5146"></a><span id="l12.5146">   if (NS_SUCCEEDED(err))</span>
<a href="#l12.5147"></a><span id="l12.5147">     err = RowCellColumnTonsString(row, property_token, result);</span>
<a href="#l12.5148"></a><span id="l12.5148"> </span>
<a href="#l12.5149"></a><span id="l12.5149">   return err;</span>
<a href="#l12.5150"></a><span id="l12.5150"> }</span>
<a href="#l12.5151"></a><span id="l12.5151"> </span>
<a href="#l12.5152"></a><span id="l12.5152" class="difflineminus">-nsresult nsMsgDatabase::SetPropertyFromNSString(nsIMdbRow *row, const char *propertyName, const nsAString &amp;propertyVal)</span>
<a href="#l12.5153"></a><span id="l12.5153" class="difflineminus">-{</span>
<a href="#l12.5154"></a><span id="l12.5154" class="difflineplus">+nsresult nsMsgDatabase::SetPropertyFromNSString(nsIMdbRow *row,</span>
<a href="#l12.5155"></a><span id="l12.5155" class="difflineplus">+                                                const char *propertyName,</span>
<a href="#l12.5156"></a><span id="l12.5156" class="difflineplus">+                                                const nsAString &amp;propertyVal) {</span>
<a href="#l12.5157"></a><span id="l12.5157">   nsresult err = NS_OK;</span>
<a href="#l12.5158"></a><span id="l12.5158" class="difflineminus">-  mdb_token  property_token;</span>
<a href="#l12.5159"></a><span id="l12.5159" class="difflineminus">-</span>
<a href="#l12.5160"></a><span id="l12.5160" class="difflineminus">-  NS_ENSURE_STATE(m_mdbStore); // db might have been closed out from under us.</span>
<a href="#l12.5161"></a><span id="l12.5161" class="difflineminus">-  if (!row)</span>
<a href="#l12.5162"></a><span id="l12.5162" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5163"></a><span id="l12.5163" class="difflineminus">-</span>
<a href="#l12.5164"></a><span id="l12.5164" class="difflineminus">-  err = m_mdbStore-&gt;StringToToken(GetEnv(),  propertyName, &amp;property_token);</span>
<a href="#l12.5165"></a><span id="l12.5165" class="difflineplus">+  mdb_token property_token;</span>
<a href="#l12.5166"></a><span id="l12.5166" class="difflineplus">+</span>
<a href="#l12.5167"></a><span id="l12.5167" class="difflineplus">+  NS_ENSURE_STATE(m_mdbStore);  // db might have been closed out from under us.</span>
<a href="#l12.5168"></a><span id="l12.5168" class="difflineplus">+  if (!row) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5169"></a><span id="l12.5169" class="difflineplus">+</span>
<a href="#l12.5170"></a><span id="l12.5170" class="difflineplus">+  err = m_mdbStore-&gt;StringToToken(GetEnv(), propertyName, &amp;property_token);</span>
<a href="#l12.5171"></a><span id="l12.5171">   if (NS_SUCCEEDED(err))</span>
<a href="#l12.5172"></a><span id="l12.5172">     return SetNSStringPropertyWithToken(row, property_token, propertyVal);</span>
<a href="#l12.5173"></a><span id="l12.5173"> </span>
<a href="#l12.5174"></a><span id="l12.5174">   return err;</span>
<a href="#l12.5175"></a><span id="l12.5175"> }</span>
<a href="#l12.5176"></a><span id="l12.5176"> </span>
<a href="#l12.5177"></a><span id="l12.5177" class="difflineminus">-</span>
<a href="#l12.5178"></a><span id="l12.5178" class="difflineminus">-nsresult nsMsgDatabase::GetUint32Property(nsIMdbRow *row, const char *propertyName, uint32_t *result, uint32_t defaultValue)</span>
<a href="#l12.5179"></a><span id="l12.5179" class="difflineminus">-{</span>
<a href="#l12.5180"></a><span id="l12.5180" class="difflineplus">+nsresult nsMsgDatabase::GetUint32Property(nsIMdbRow *row,</span>
<a href="#l12.5181"></a><span id="l12.5181" class="difflineplus">+                                          const char *propertyName,</span>
<a href="#l12.5182"></a><span id="l12.5182" class="difflineplus">+                                          uint32_t *result,</span>
<a href="#l12.5183"></a><span id="l12.5183" class="difflineplus">+                                          uint32_t defaultValue) {</span>
<a href="#l12.5184"></a><span id="l12.5184">   nsresult err = NS_OK;</span>
<a href="#l12.5185"></a><span id="l12.5185" class="difflineminus">-  mdb_token  property_token;</span>
<a href="#l12.5186"></a><span id="l12.5186" class="difflineminus">-</span>
<a href="#l12.5187"></a><span id="l12.5187" class="difflineminus">-  NS_ENSURE_STATE(m_mdbStore); // db might have been closed out from under us.</span>
<a href="#l12.5188"></a><span id="l12.5188" class="difflineminus">-  if (!row)</span>
<a href="#l12.5189"></a><span id="l12.5189" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5190"></a><span id="l12.5190" class="difflineminus">-</span>
<a href="#l12.5191"></a><span id="l12.5191" class="difflineminus">-  err = m_mdbStore-&gt;StringToToken(GetEnv(),  propertyName, &amp;property_token);</span>
<a href="#l12.5192"></a><span id="l12.5192" class="difflineplus">+  mdb_token property_token;</span>
<a href="#l12.5193"></a><span id="l12.5193" class="difflineplus">+</span>
<a href="#l12.5194"></a><span id="l12.5194" class="difflineplus">+  NS_ENSURE_STATE(m_mdbStore);  // db might have been closed out from under us.</span>
<a href="#l12.5195"></a><span id="l12.5195" class="difflineplus">+  if (!row) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5196"></a><span id="l12.5196" class="difflineplus">+</span>
<a href="#l12.5197"></a><span id="l12.5197" class="difflineplus">+  err = m_mdbStore-&gt;StringToToken(GetEnv(), propertyName, &amp;property_token);</span>
<a href="#l12.5198"></a><span id="l12.5198">   if (NS_SUCCEEDED(err))</span>
<a href="#l12.5199"></a><span id="l12.5199">     err = RowCellColumnToUInt32(row, property_token, result, defaultValue);</span>
<a href="#l12.5200"></a><span id="l12.5200"> </span>
<a href="#l12.5201"></a><span id="l12.5201">   return err;</span>
<a href="#l12.5202"></a><span id="l12.5202"> }</span>
<a href="#l12.5203"></a><span id="l12.5203"> </span>
<a href="#l12.5204"></a><span id="l12.5204" class="difflineminus">-nsresult nsMsgDatabase::GetUint64Property(nsIMdbRow *row, const char *propertyName, uint64_t *result, uint64_t defaultValue)</span>
<a href="#l12.5205"></a><span id="l12.5205" class="difflineminus">-{</span>
<a href="#l12.5206"></a><span id="l12.5206" class="difflineplus">+nsresult nsMsgDatabase::GetUint64Property(nsIMdbRow *row,</span>
<a href="#l12.5207"></a><span id="l12.5207" class="difflineplus">+                                          const char *propertyName,</span>
<a href="#l12.5208"></a><span id="l12.5208" class="difflineplus">+                                          uint64_t *result,</span>
<a href="#l12.5209"></a><span id="l12.5209" class="difflineplus">+                                          uint64_t defaultValue) {</span>
<a href="#l12.5210"></a><span id="l12.5210">   nsresult err = NS_OK;</span>
<a href="#l12.5211"></a><span id="l12.5211">   mdb_token property_token;</span>
<a href="#l12.5212"></a><span id="l12.5212"> </span>
<a href="#l12.5213"></a><span id="l12.5213" class="difflineminus">-  NS_ENSURE_STATE(m_mdbStore); // db might have been closed out from under us.</span>
<a href="#l12.5214"></a><span id="l12.5214" class="difflineminus">-  if (!row)</span>
<a href="#l12.5215"></a><span id="l12.5215" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5216"></a><span id="l12.5216" class="difflineplus">+  NS_ENSURE_STATE(m_mdbStore);  // db might have been closed out from under us.</span>
<a href="#l12.5217"></a><span id="l12.5217" class="difflineplus">+  if (!row) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5218"></a><span id="l12.5218"> </span>
<a href="#l12.5219"></a><span id="l12.5219">   err = m_mdbStore-&gt;StringToToken(GetEnv(), propertyName, &amp;property_token);</span>
<a href="#l12.5220"></a><span id="l12.5220">   if (NS_SUCCEEDED(err))</span>
<a href="#l12.5221"></a><span id="l12.5221">     err = RowCellColumnToUInt64(row, property_token, result, defaultValue);</span>
<a href="#l12.5222"></a><span id="l12.5222"> </span>
<a href="#l12.5223"></a><span id="l12.5223">   return err;</span>
<a href="#l12.5224"></a><span id="l12.5224"> }</span>
<a href="#l12.5225"></a><span id="l12.5225"> </span>
<a href="#l12.5226"></a><span id="l12.5226" class="difflineminus">-nsresult nsMsgDatabase::SetUint32Property(nsIMdbRow *row, const char *propertyName, uint32_t propertyVal)</span>
<a href="#l12.5227"></a><span id="l12.5227" class="difflineminus">-{</span>
<a href="#l12.5228"></a><span id="l12.5228" class="difflineplus">+nsresult nsMsgDatabase::SetUint32Property(nsIMdbRow *row,</span>
<a href="#l12.5229"></a><span id="l12.5229" class="difflineplus">+                                          const char *propertyName,</span>
<a href="#l12.5230"></a><span id="l12.5230" class="difflineplus">+                                          uint32_t propertyVal) {</span>
<a href="#l12.5231"></a><span id="l12.5231">   struct mdbYarn yarn;</span>
<a href="#l12.5232"></a><span id="l12.5232" class="difflineminus">-  char  int32StrBuf[20];</span>
<a href="#l12.5233"></a><span id="l12.5233" class="difflineplus">+  char int32StrBuf[20];</span>
<a href="#l12.5234"></a><span id="l12.5234">   yarn.mYarn_Buf = int32StrBuf;</span>
<a href="#l12.5235"></a><span id="l12.5235">   yarn.mYarn_Size = sizeof(int32StrBuf);</span>
<a href="#l12.5236"></a><span id="l12.5236">   yarn.mYarn_Fill = sizeof(int32StrBuf);</span>
<a href="#l12.5237"></a><span id="l12.5237"> </span>
<a href="#l12.5238"></a><span id="l12.5238" class="difflineminus">-  NS_ENSURE_STATE(m_mdbStore); // db might have been closed out from under us.</span>
<a href="#l12.5239"></a><span id="l12.5239" class="difflineminus">-  if (!row)</span>
<a href="#l12.5240"></a><span id="l12.5240" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5241"></a><span id="l12.5241" class="difflineminus">-</span>
<a href="#l12.5242"></a><span id="l12.5242" class="difflineminus">-  mdb_token  property_token;</span>
<a href="#l12.5243"></a><span id="l12.5243" class="difflineminus">-</span>
<a href="#l12.5244"></a><span id="l12.5244" class="difflineminus">-  nsresult err = m_mdbStore-&gt;StringToToken(GetEnv(),  propertyName, &amp;property_token);</span>
<a href="#l12.5245"></a><span id="l12.5245" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l12.5246"></a><span id="l12.5246" class="difflineminus">-  {</span>
<a href="#l12.5247"></a><span id="l12.5247" class="difflineplus">+  NS_ENSURE_STATE(m_mdbStore);  // db might have been closed out from under us.</span>
<a href="#l12.5248"></a><span id="l12.5248" class="difflineplus">+  if (!row) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5249"></a><span id="l12.5249" class="difflineplus">+</span>
<a href="#l12.5250"></a><span id="l12.5250" class="difflineplus">+  mdb_token property_token;</span>
<a href="#l12.5251"></a><span id="l12.5251" class="difflineplus">+</span>
<a href="#l12.5252"></a><span id="l12.5252" class="difflineplus">+  nsresult err =</span>
<a href="#l12.5253"></a><span id="l12.5253" class="difflineplus">+      m_mdbStore-&gt;StringToToken(GetEnv(), propertyName, &amp;property_token);</span>
<a href="#l12.5254"></a><span id="l12.5254" class="difflineplus">+  if (NS_SUCCEEDED(err)) {</span>
<a href="#l12.5255"></a><span id="l12.5255">     UInt32ToYarn(&amp;yarn, propertyVal);</span>
<a href="#l12.5256"></a><span id="l12.5256">     err = row-&gt;AddColumn(GetEnv(), property_token, &amp;yarn);</span>
<a href="#l12.5257"></a><span id="l12.5257">   }</span>
<a href="#l12.5258"></a><span id="l12.5258">   return err;</span>
<a href="#l12.5259"></a><span id="l12.5259"> }</span>
<a href="#l12.5260"></a><span id="l12.5260"> </span>
<a href="#l12.5261"></a><span id="l12.5261"> nsresult nsMsgDatabase::SetUint64Property(nsIMdbRow *row,</span>
<a href="#l12.5262"></a><span id="l12.5262">                                           const char *propertyName,</span>
<a href="#l12.5263"></a><span id="l12.5263" class="difflineminus">-                                          uint64_t propertyVal)</span>
<a href="#l12.5264"></a><span id="l12.5264" class="difflineminus">-{</span>
<a href="#l12.5265"></a><span id="l12.5265" class="difflineplus">+                                          uint64_t propertyVal) {</span>
<a href="#l12.5266"></a><span id="l12.5266">   struct mdbYarn yarn;</span>
<a href="#l12.5267"></a><span id="l12.5267" class="difflineminus">-  char  int64StrBuf[100];</span>
<a href="#l12.5268"></a><span id="l12.5268" class="difflineplus">+  char int64StrBuf[100];</span>
<a href="#l12.5269"></a><span id="l12.5269">   yarn.mYarn_Buf = int64StrBuf;</span>
<a href="#l12.5270"></a><span id="l12.5270">   yarn.mYarn_Size = sizeof(int64StrBuf);</span>
<a href="#l12.5271"></a><span id="l12.5271">   yarn.mYarn_Fill = sizeof(int64StrBuf);</span>
<a href="#l12.5272"></a><span id="l12.5272"> </span>
<a href="#l12.5273"></a><span id="l12.5273" class="difflineminus">-  NS_ENSURE_STATE(m_mdbStore); // db might have been closed out from under us.</span>
<a href="#l12.5274"></a><span id="l12.5274" class="difflineminus">-  if (!row)</span>
<a href="#l12.5275"></a><span id="l12.5275" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5276"></a><span id="l12.5276" class="difflineminus">-</span>
<a href="#l12.5277"></a><span id="l12.5277" class="difflineminus">-  mdb_token  property_token;</span>
<a href="#l12.5278"></a><span id="l12.5278" class="difflineminus">-</span>
<a href="#l12.5279"></a><span id="l12.5279" class="difflineminus">-  nsresult err = m_mdbStore-&gt;StringToToken(GetEnv(),  propertyName, &amp;property_token);</span>
<a href="#l12.5280"></a><span id="l12.5280" class="difflineminus">-  if (NS_SUCCEEDED(err))</span>
<a href="#l12.5281"></a><span id="l12.5281" class="difflineminus">-  {</span>
<a href="#l12.5282"></a><span id="l12.5282" class="difflineplus">+  NS_ENSURE_STATE(m_mdbStore);  // db might have been closed out from under us.</span>
<a href="#l12.5283"></a><span id="l12.5283" class="difflineplus">+  if (!row) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5284"></a><span id="l12.5284" class="difflineplus">+</span>
<a href="#l12.5285"></a><span id="l12.5285" class="difflineplus">+  mdb_token property_token;</span>
<a href="#l12.5286"></a><span id="l12.5286" class="difflineplus">+</span>
<a href="#l12.5287"></a><span id="l12.5287" class="difflineplus">+  nsresult err =</span>
<a href="#l12.5288"></a><span id="l12.5288" class="difflineplus">+      m_mdbStore-&gt;StringToToken(GetEnv(), propertyName, &amp;property_token);</span>
<a href="#l12.5289"></a><span id="l12.5289" class="difflineplus">+  if (NS_SUCCEEDED(err)) {</span>
<a href="#l12.5290"></a><span id="l12.5290">     UInt64ToYarn(&amp;yarn, propertyVal);</span>
<a href="#l12.5291"></a><span id="l12.5291">     err = row-&gt;AddColumn(GetEnv(), property_token, &amp;yarn);</span>
<a href="#l12.5292"></a><span id="l12.5292">   }</span>
<a href="#l12.5293"></a><span id="l12.5293">   return err;</span>
<a href="#l12.5294"></a><span id="l12.5294"> }</span>
<a href="#l12.5295"></a><span id="l12.5295"> </span>
<a href="#l12.5296"></a><span id="l12.5296" class="difflineminus">-nsresult nsMsgDatabase::GetBooleanProperty(nsIMdbRow *row, const char *propertyName,</span>
<a href="#l12.5297"></a><span id="l12.5297" class="difflineminus">-                                     bool *result,</span>
<a href="#l12.5298"></a><span id="l12.5298" class="difflineminus">-                                     bool defaultValue /* = false */)</span>
<a href="#l12.5299"></a><span id="l12.5299" class="difflineminus">-{</span>
<a href="#l12.5300"></a><span id="l12.5300" class="difflineplus">+nsresult nsMsgDatabase::GetBooleanProperty(nsIMdbRow *row,</span>
<a href="#l12.5301"></a><span id="l12.5301" class="difflineplus">+                                           const char *propertyName,</span>
<a href="#l12.5302"></a><span id="l12.5302" class="difflineplus">+                                           bool *result,</span>
<a href="#l12.5303"></a><span id="l12.5303" class="difflineplus">+                                           bool defaultValue /* = false */) {</span>
<a href="#l12.5304"></a><span id="l12.5304">   uint32_t res;</span>
<a href="#l12.5305"></a><span id="l12.5305" class="difflineminus">-  nsresult rv = GetUint32Property(row, propertyName, &amp;res, (uint32_t) defaultValue);</span>
<a href="#l12.5306"></a><span id="l12.5306" class="difflineplus">+  nsresult rv =</span>
<a href="#l12.5307"></a><span id="l12.5307" class="difflineplus">+      GetUint32Property(row, propertyName, &amp;res, (uint32_t)defaultValue);</span>
<a href="#l12.5308"></a><span id="l12.5308">   *result = !!res;</span>
<a href="#l12.5309"></a><span id="l12.5309">   return rv;</span>
<a href="#l12.5310"></a><span id="l12.5310"> }</span>
<a href="#l12.5311"></a><span id="l12.5311"> </span>
<a href="#l12.5312"></a><span id="l12.5312" class="difflineminus">-nsresult nsMsgDatabase::SetBooleanProperty(nsIMdbRow *row, const char *propertyName,</span>
<a href="#l12.5313"></a><span id="l12.5313" class="difflineminus">-                                    bool propertyVal)</span>
<a href="#l12.5314"></a><span id="l12.5314" class="difflineminus">-{</span>
<a href="#l12.5315"></a><span id="l12.5315" class="difflineminus">-  return SetUint32Property(row, propertyName, (uint32_t) propertyVal);</span>
<a href="#l12.5316"></a><span id="l12.5316" class="difflineminus">-}</span>
<a href="#l12.5317"></a><span id="l12.5317" class="difflineminus">-</span>
<a href="#l12.5318"></a><span id="l12.5318" class="difflineminus">-nsresult nsMsgDatabase::SetNSStringPropertyWithToken(nsIMdbRow *row, mdb_token aProperty, const nsAString &amp;propertyStr)</span>
<a href="#l12.5319"></a><span id="l12.5319" class="difflineminus">-{</span>
<a href="#l12.5320"></a><span id="l12.5320" class="difflineplus">+nsresult nsMsgDatabase::SetBooleanProperty(nsIMdbRow *row,</span>
<a href="#l12.5321"></a><span id="l12.5321" class="difflineplus">+                                           const char *propertyName,</span>
<a href="#l12.5322"></a><span id="l12.5322" class="difflineplus">+                                           bool propertyVal) {</span>
<a href="#l12.5323"></a><span id="l12.5323" class="difflineplus">+  return SetUint32Property(row, propertyName, (uint32_t)propertyVal);</span>
<a href="#l12.5324"></a><span id="l12.5324" class="difflineplus">+}</span>
<a href="#l12.5325"></a><span id="l12.5325" class="difflineplus">+</span>
<a href="#l12.5326"></a><span id="l12.5326" class="difflineplus">+nsresult nsMsgDatabase::SetNSStringPropertyWithToken(</span>
<a href="#l12.5327"></a><span id="l12.5327" class="difflineplus">+    nsIMdbRow *row, mdb_token aProperty, const nsAString &amp;propertyStr) {</span>
<a href="#l12.5328"></a><span id="l12.5328">   NS_ENSURE_ARG(row);</span>
<a href="#l12.5329"></a><span id="l12.5329">   struct mdbYarn yarn;</span>
<a href="#l12.5330"></a><span id="l12.5330"> </span>
<a href="#l12.5331"></a><span id="l12.5331">   yarn.mYarn_Grow = NULL;</span>
<a href="#l12.5332"></a><span id="l12.5332" class="difflineminus">-  nsresult err = row-&gt;AddColumn(GetEnv(), aProperty, nsStringToYarn(&amp;yarn, propertyStr));</span>
<a href="#l12.5333"></a><span id="l12.5333" class="difflineplus">+  nsresult err =</span>
<a href="#l12.5334"></a><span id="l12.5334" class="difflineplus">+      row-&gt;AddColumn(GetEnv(), aProperty, nsStringToYarn(&amp;yarn, propertyStr));</span>
<a href="#l12.5335"></a><span id="l12.5335">   free((char *)yarn.mYarn_Buf);  // won't need this when we have nsCString</span>
<a href="#l12.5336"></a><span id="l12.5336">   return err;</span>
<a href="#l12.5337"></a><span id="l12.5337"> }</span>
<a href="#l12.5338"></a><span id="l12.5338"> </span>
<a href="#l12.5339"></a><span id="l12.5339" class="difflineminus">-</span>
<a href="#l12.5340"></a><span id="l12.5340" class="difflineminus">-uint32_t nsMsgDatabase::GetCurVersion()</span>
<a href="#l12.5341"></a><span id="l12.5341" class="difflineminus">-{</span>
<a href="#l12.5342"></a><span id="l12.5342" class="difflineminus">-  return kMsgDBVersion;</span>
<a href="#l12.5343"></a><span id="l12.5343" class="difflineminus">-}</span>
<a href="#l12.5344"></a><span id="l12.5344" class="difflineminus">-</span>
<a href="#l12.5345"></a><span id="l12.5345" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::SetSummaryValid(bool valid /* = true */)</span>
<a href="#l12.5346"></a><span id="l12.5346" class="difflineminus">-{</span>
<a href="#l12.5347"></a><span id="l12.5347" class="difflineminus">-  // If the file was invalid when opened (for example in folder compact), then it may</span>
<a href="#l12.5348"></a><span id="l12.5348" class="difflineplus">+uint32_t nsMsgDatabase::GetCurVersion() { return kMsgDBVersion; }</span>
<a href="#l12.5349"></a><span id="l12.5349" class="difflineplus">+</span>
<a href="#l12.5350"></a><span id="l12.5350" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::SetSummaryValid(bool valid /* = true */) {</span>
<a href="#l12.5351"></a><span id="l12.5351" class="difflineplus">+  // If the file was invalid when opened (for example in folder compact), then</span>
<a href="#l12.5352"></a><span id="l12.5352" class="difflineplus">+  // it may</span>
<a href="#l12.5353"></a><span id="l12.5353">   //  not have been added to the cache. Add it now if missing.</span>
<a href="#l12.5354"></a><span id="l12.5354" class="difflineminus">-  if (valid)</span>
<a href="#l12.5355"></a><span id="l12.5355" class="difflineminus">-  {</span>
<a href="#l12.5356"></a><span id="l12.5356" class="difflineplus">+  if (valid) {</span>
<a href="#l12.5357"></a><span id="l12.5357">     nsCOMPtr&lt;nsIMsgDBService&gt; serv(mozilla::services::GetDBService());</span>
<a href="#l12.5358"></a><span id="l12.5358" class="difflineminus">-    static_cast&lt;nsMsgDBService*&gt;(serv.get())-&gt;EnsureCached(this);</span>
<a href="#l12.5359"></a><span id="l12.5359" class="difflineplus">+    static_cast&lt;nsMsgDBService *&gt;(serv.get())-&gt;EnsureCached(this);</span>
<a href="#l12.5360"></a><span id="l12.5360">   }</span>
<a href="#l12.5361"></a><span id="l12.5361">   // setting the version to 0 ought to make it pretty invalid.</span>
<a href="#l12.5362"></a><span id="l12.5362" class="difflineminus">-  if (m_dbFolderInfo)</span>
<a href="#l12.5363"></a><span id="l12.5363" class="difflineminus">-    m_dbFolderInfo-&gt;SetVersion(valid ? GetCurVersion() : 0);</span>
<a href="#l12.5364"></a><span id="l12.5364" class="difflineplus">+  if (m_dbFolderInfo) m_dbFolderInfo-&gt;SetVersion(valid ? GetCurVersion() : 0);</span>
<a href="#l12.5365"></a><span id="l12.5365"> </span>
<a href="#l12.5366"></a><span id="l12.5366">   // for default db (and news), there's no nothing to set to make it it valid</span>
<a href="#l12.5367"></a><span id="l12.5367">   return NS_OK;</span>
<a href="#l12.5368"></a><span id="l12.5368"> }</span>
<a href="#l12.5369"></a><span id="l12.5369"> </span>
<a href="#l12.5370"></a><span id="l12.5370" class="difflineminus">-</span>
<a href="#l12.5371"></a><span id="l12.5371" class="difflineminus">-NS_IMETHODIMP  nsMsgDatabase::GetSummaryValid(bool *aResult)</span>
<a href="#l12.5372"></a><span id="l12.5372" class="difflineminus">-{</span>
<a href="#l12.5373"></a><span id="l12.5373" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetSummaryValid(bool *aResult) {</span>
<a href="#l12.5374"></a><span id="l12.5374">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l12.5375"></a><span id="l12.5375">   *aResult = true;</span>
<a href="#l12.5376"></a><span id="l12.5376">   return NS_OK;</span>
<a href="#l12.5377"></a><span id="l12.5377"> }</span>
<a href="#l12.5378"></a><span id="l12.5378"> </span>
<a href="#l12.5379"></a><span id="l12.5379" class="difflineminus">-</span>
<a href="#l12.5380"></a><span id="l12.5380"> // protected routines</span>
<a href="#l12.5381"></a><span id="l12.5381"> </span>
<a href="#l12.5382"></a><span id="l12.5382" class="difflineminus">-// should we thread messages with common subjects that don't start with Re: together?</span>
<a href="#l12.5383"></a><span id="l12.5383" class="difflineminus">-// I imagine we might have separate preferences for mail and news, so this is a virtual method.</span>
<a href="#l12.5384"></a><span id="l12.5384" class="difflineminus">-bool    nsMsgDatabase::ThreadBySubjectWithoutRe()</span>
<a href="#l12.5385"></a><span id="l12.5385" class="difflineminus">-{</span>
<a href="#l12.5386"></a><span id="l12.5386" class="difflineplus">+// should we thread messages with common subjects that don't start with Re:</span>
<a href="#l12.5387"></a><span id="l12.5387" class="difflineplus">+// together? I imagine we might have separate preferences for mail and news, so</span>
<a href="#l12.5388"></a><span id="l12.5388" class="difflineplus">+// this is a virtual method.</span>
<a href="#l12.5389"></a><span id="l12.5389" class="difflineplus">+bool nsMsgDatabase::ThreadBySubjectWithoutRe() {</span>
<a href="#l12.5390"></a><span id="l12.5390">   GetGlobalPrefs();</span>
<a href="#l12.5391"></a><span id="l12.5391">   return gThreadWithoutRe;</span>
<a href="#l12.5392"></a><span id="l12.5392"> }</span>
<a href="#l12.5393"></a><span id="l12.5393"> </span>
<a href="#l12.5394"></a><span id="l12.5394" class="difflineminus">-bool nsMsgDatabase::UseStrictThreading()</span>
<a href="#l12.5395"></a><span id="l12.5395" class="difflineminus">-{</span>
<a href="#l12.5396"></a><span id="l12.5396" class="difflineplus">+bool nsMsgDatabase::UseStrictThreading() {</span>
<a href="#l12.5397"></a><span id="l12.5397">   GetGlobalPrefs();</span>
<a href="#l12.5398"></a><span id="l12.5398">   return gStrictThreading;</span>
<a href="#l12.5399"></a><span id="l12.5399"> }</span>
<a href="#l12.5400"></a><span id="l12.5400"> </span>
<a href="#l12.5401"></a><span id="l12.5401"> // Should we make sure messages are always threaded correctly (see bug 181446)</span>
<a href="#l12.5402"></a><span id="l12.5402" class="difflineminus">-bool nsMsgDatabase::UseCorrectThreading()</span>
<a href="#l12.5403"></a><span id="l12.5403" class="difflineminus">-{</span>
<a href="#l12.5404"></a><span id="l12.5404" class="difflineplus">+bool nsMsgDatabase::UseCorrectThreading() {</span>
<a href="#l12.5405"></a><span id="l12.5405">   GetGlobalPrefs();</span>
<a href="#l12.5406"></a><span id="l12.5406">   return gCorrectThreading;</span>
<a href="#l12.5407"></a><span id="l12.5407"> }</span>
<a href="#l12.5408"></a><span id="l12.5408"> </span>
<a href="#l12.5409"></a><span id="l12.5409"> // adapted from removed PL_DHashFreeStringKey</span>
<a href="#l12.5410"></a><span id="l12.5410" class="difflineminus">-static void</span>
<a href="#l12.5411"></a><span id="l12.5411" class="difflineminus">-msg_DHashFreeStringKey(PLDHashTable* aTable, PLDHashEntryHdr* aEntry)</span>
<a href="#l12.5412"></a><span id="l12.5412" class="difflineminus">-{</span>
<a href="#l12.5413"></a><span id="l12.5413" class="difflineminus">-  const PLDHashEntryStub* stub = (const PLDHashEntryStub*)aEntry;</span>
<a href="#l12.5414"></a><span id="l12.5414" class="difflineminus">-  free((void*)stub-&gt;key);</span>
<a href="#l12.5415"></a><span id="l12.5415" class="difflineplus">+static void msg_DHashFreeStringKey(PLDHashTable *aTable,</span>
<a href="#l12.5416"></a><span id="l12.5416" class="difflineplus">+                                   PLDHashEntryHdr *aEntry) {</span>
<a href="#l12.5417"></a><span id="l12.5417" class="difflineplus">+  const PLDHashEntryStub *stub = (const PLDHashEntryStub *)aEntry;</span>
<a href="#l12.5418"></a><span id="l12.5418" class="difflineplus">+  free((void *)stub-&gt;key);</span>
<a href="#l12.5419"></a><span id="l12.5419">   PLDHashTable::ClearEntryStub(aTable, aEntry);</span>
<a href="#l12.5420"></a><span id="l12.5420"> }</span>
<a href="#l12.5421"></a><span id="l12.5421"> </span>
<a href="#l12.5422"></a><span id="l12.5422" class="difflineminus">-PLDHashTableOps nsMsgDatabase::gRefHashTableOps =</span>
<a href="#l12.5423"></a><span id="l12.5423" class="difflineminus">-{</span>
<a href="#l12.5424"></a><span id="l12.5424" class="difflineminus">-  PLDHashTable::HashStringKey,</span>
<a href="#l12.5425"></a><span id="l12.5425" class="difflineminus">-  PLDHashTable::MatchStringKey,</span>
<a href="#l12.5426"></a><span id="l12.5426" class="difflineminus">-  PLDHashTable::MoveEntryStub,</span>
<a href="#l12.5427"></a><span id="l12.5427" class="difflineminus">-  msg_DHashFreeStringKey,</span>
<a href="#l12.5428"></a><span id="l12.5428" class="difflineminus">-  nullptr</span>
<a href="#l12.5429"></a><span id="l12.5429" class="difflineminus">-};</span>
<a href="#l12.5430"></a><span id="l12.5430" class="difflineminus">-</span>
<a href="#l12.5431"></a><span id="l12.5431" class="difflineminus">-nsresult nsMsgDatabase::GetRefFromHash(nsCString &amp;reference, nsMsgKey *threadId)</span>
<a href="#l12.5432"></a><span id="l12.5432" class="difflineminus">-{</span>
<a href="#l12.5433"></a><span id="l12.5433" class="difflineplus">+PLDHashTableOps nsMsgDatabase::gRefHashTableOps = {</span>
<a href="#l12.5434"></a><span id="l12.5434" class="difflineplus">+    PLDHashTable::HashStringKey, PLDHashTable::MatchStringKey,</span>
<a href="#l12.5435"></a><span id="l12.5435" class="difflineplus">+    PLDHashTable::MoveEntryStub, msg_DHashFreeStringKey, nullptr};</span>
<a href="#l12.5436"></a><span id="l12.5436" class="difflineplus">+</span>
<a href="#l12.5437"></a><span id="l12.5437" class="difflineplus">+nsresult nsMsgDatabase::GetRefFromHash(nsCString &amp;reference,</span>
<a href="#l12.5438"></a><span id="l12.5438" class="difflineplus">+                                       nsMsgKey *threadId) {</span>
<a href="#l12.5439"></a><span id="l12.5439">   // Initialize the reference hash</span>
<a href="#l12.5440"></a><span id="l12.5440" class="difflineminus">-  if (!m_msgReferences)</span>
<a href="#l12.5441"></a><span id="l12.5441" class="difflineminus">-  {</span>
<a href="#l12.5442"></a><span id="l12.5442" class="difflineplus">+  if (!m_msgReferences) {</span>
<a href="#l12.5443"></a><span id="l12.5443">     nsresult rv = InitRefHash();</span>
<a href="#l12.5444"></a><span id="l12.5444" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.5445"></a><span id="l12.5445" class="difflineminus">-      return rv;</span>
<a href="#l12.5446"></a><span id="l12.5446" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.5447"></a><span id="l12.5447">   }</span>
<a href="#l12.5448"></a><span id="l12.5448"> </span>
<a href="#l12.5449"></a><span id="l12.5449">   // Find reference from the hash</span>
<a href="#l12.5450"></a><span id="l12.5450">   PLDHashEntryHdr *entry =</span>
<a href="#l12.5451"></a><span id="l12.5451" class="difflineminus">-    m_msgReferences-&gt;Search((const void *) reference.get());</span>
<a href="#l12.5452"></a><span id="l12.5452" class="difflineminus">-  if (entry)</span>
<a href="#l12.5453"></a><span id="l12.5453" class="difflineminus">-  {</span>
<a href="#l12.5454"></a><span id="l12.5454" class="difflineplus">+      m_msgReferences-&gt;Search((const void *)reference.get());</span>
<a href="#l12.5455"></a><span id="l12.5455" class="difflineplus">+  if (entry) {</span>
<a href="#l12.5456"></a><span id="l12.5456">     RefHashElement *element = static_cast&lt;RefHashElement *&gt;(entry);</span>
<a href="#l12.5457"></a><span id="l12.5457">     *threadId = element-&gt;mThreadId;</span>
<a href="#l12.5458"></a><span id="l12.5458">     return NS_OK;</span>
<a href="#l12.5459"></a><span id="l12.5459">   }</span>
<a href="#l12.5460"></a><span id="l12.5460"> </span>
<a href="#l12.5461"></a><span id="l12.5461">   return NS_ERROR_FAILURE;</span>
<a href="#l12.5462"></a><span id="l12.5462"> }</span>
<a href="#l12.5463"></a><span id="l12.5463"> </span>
<a href="#l12.5464"></a><span id="l12.5464" class="difflineminus">-nsresult nsMsgDatabase::AddRefToHash(nsCString &amp;reference, nsMsgKey threadId)</span>
<a href="#l12.5465"></a><span id="l12.5465" class="difflineminus">-{</span>
<a href="#l12.5466"></a><span id="l12.5466" class="difflineminus">-  if (m_msgReferences)</span>
<a href="#l12.5467"></a><span id="l12.5467" class="difflineminus">-  {</span>
<a href="#l12.5468"></a><span id="l12.5468" class="difflineminus">-    PLDHashEntryHdr *entry = m_msgReferences-&gt;Add((void *) reference.get(), mozilla::fallible);</span>
<a href="#l12.5469"></a><span id="l12.5469" class="difflineminus">-    if (!entry)</span>
<a href="#l12.5470"></a><span id="l12.5470" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY; // XXX out of memory</span>
<a href="#l12.5471"></a><span id="l12.5471" class="difflineplus">+nsresult nsMsgDatabase::AddRefToHash(nsCString &amp;reference, nsMsgKey threadId) {</span>
<a href="#l12.5472"></a><span id="l12.5472" class="difflineplus">+  if (m_msgReferences) {</span>
<a href="#l12.5473"></a><span id="l12.5473" class="difflineplus">+    PLDHashEntryHdr *entry =</span>
<a href="#l12.5474"></a><span id="l12.5474" class="difflineplus">+        m_msgReferences-&gt;Add((void *)reference.get(), mozilla::fallible);</span>
<a href="#l12.5475"></a><span id="l12.5475" class="difflineplus">+    if (!entry) return NS_ERROR_OUT_OF_MEMORY;  // XXX out of memory</span>
<a href="#l12.5476"></a><span id="l12.5476"> </span>
<a href="#l12.5477"></a><span id="l12.5477">     RefHashElement *element = static_cast&lt;RefHashElement *&gt;(entry);</span>
<a href="#l12.5478"></a><span id="l12.5478" class="difflineminus">-    if (!element-&gt;mRef)</span>
<a href="#l12.5479"></a><span id="l12.5479" class="difflineminus">-    {</span>
<a href="#l12.5480"></a><span id="l12.5480" class="difflineminus">-      element-&gt;mRef = ToNewCString(reference);  // Will be freed in msg_DHashFreeStringKey()</span>
<a href="#l12.5481"></a><span id="l12.5481" class="difflineplus">+    if (!element-&gt;mRef) {</span>
<a href="#l12.5482"></a><span id="l12.5482" class="difflineplus">+      element-&gt;mRef =</span>
<a href="#l12.5483"></a><span id="l12.5483" class="difflineplus">+          ToNewCString(reference);  // Will be freed in msg_DHashFreeStringKey()</span>
<a href="#l12.5484"></a><span id="l12.5484">       element-&gt;mThreadId = threadId;</span>
<a href="#l12.5485"></a><span id="l12.5485">       element-&gt;mCount = 1;</span>
<a href="#l12.5486"></a><span id="l12.5486" class="difflineminus">-    }</span>
<a href="#l12.5487"></a><span id="l12.5487" class="difflineminus">-    else</span>
<a href="#l12.5488"></a><span id="l12.5488" class="difflineplus">+    } else</span>
<a href="#l12.5489"></a><span id="l12.5489">       element-&gt;mCount++;</span>
<a href="#l12.5490"></a><span id="l12.5490">   }</span>
<a href="#l12.5491"></a><span id="l12.5491"> </span>
<a href="#l12.5492"></a><span id="l12.5492">   return NS_OK;</span>
<a href="#l12.5493"></a><span id="l12.5493"> }</span>
<a href="#l12.5494"></a><span id="l12.5494"> </span>
<a href="#l12.5495"></a><span id="l12.5495" class="difflineminus">-nsresult nsMsgDatabase::AddMsgRefsToHash(nsIMsgDBHdr *msgHdr)</span>
<a href="#l12.5496"></a><span id="l12.5496" class="difflineminus">-{</span>
<a href="#l12.5497"></a><span id="l12.5497" class="difflineplus">+nsresult nsMsgDatabase::AddMsgRefsToHash(nsIMsgDBHdr *msgHdr) {</span>
<a href="#l12.5498"></a><span id="l12.5498">   uint16_t numReferences = 0;</span>
<a href="#l12.5499"></a><span id="l12.5499">   nsMsgKey threadId;</span>
<a href="#l12.5500"></a><span id="l12.5500">   nsresult rv = NS_OK;</span>
<a href="#l12.5501"></a><span id="l12.5501"> </span>
<a href="#l12.5502"></a><span id="l12.5502">   msgHdr-&gt;GetThreadId(&amp;threadId);</span>
<a href="#l12.5503"></a><span id="l12.5503">   msgHdr-&gt;GetNumReferences(&amp;numReferences);</span>
<a href="#l12.5504"></a><span id="l12.5504"> </span>
<a href="#l12.5505"></a><span id="l12.5505" class="difflineminus">-  for (int32_t i = 0; i &lt; numReferences; i++)</span>
<a href="#l12.5506"></a><span id="l12.5506" class="difflineminus">-  {</span>
<a href="#l12.5507"></a><span id="l12.5507" class="difflineplus">+  for (int32_t i = 0; i &lt; numReferences; i++) {</span>
<a href="#l12.5508"></a><span id="l12.5508">     nsAutoCString reference;</span>
<a href="#l12.5509"></a><span id="l12.5509"> </span>
<a href="#l12.5510"></a><span id="l12.5510">     msgHdr-&gt;GetStringReference(i, reference);</span>
<a href="#l12.5511"></a><span id="l12.5511" class="difflineminus">-    if (reference.IsEmpty())</span>
<a href="#l12.5512"></a><span id="l12.5512" class="difflineminus">-      break;</span>
<a href="#l12.5513"></a><span id="l12.5513" class="difflineplus">+    if (reference.IsEmpty()) break;</span>
<a href="#l12.5514"></a><span id="l12.5514"> </span>
<a href="#l12.5515"></a><span id="l12.5515">     rv = AddRefToHash(reference, threadId);</span>
<a href="#l12.5516"></a><span id="l12.5516" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.5517"></a><span id="l12.5517" class="difflineminus">-      break;</span>
<a href="#l12.5518"></a><span id="l12.5518" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l12.5519"></a><span id="l12.5519">   }</span>
<a href="#l12.5520"></a><span id="l12.5520"> </span>
<a href="#l12.5521"></a><span id="l12.5521">   return rv;</span>
<a href="#l12.5522"></a><span id="l12.5522"> }</span>
<a href="#l12.5523"></a><span id="l12.5523"> </span>
<a href="#l12.5524"></a><span id="l12.5524" class="difflineminus">-nsresult nsMsgDatabase::RemoveRefFromHash(nsCString &amp;reference)</span>
<a href="#l12.5525"></a><span id="l12.5525" class="difflineminus">-{</span>
<a href="#l12.5526"></a><span id="l12.5526" class="difflineminus">-  if (m_msgReferences)</span>
<a href="#l12.5527"></a><span id="l12.5527" class="difflineminus">-  {</span>
<a href="#l12.5528"></a><span id="l12.5528" class="difflineplus">+nsresult nsMsgDatabase::RemoveRefFromHash(nsCString &amp;reference) {</span>
<a href="#l12.5529"></a><span id="l12.5529" class="difflineplus">+  if (m_msgReferences) {</span>
<a href="#l12.5530"></a><span id="l12.5530">     PLDHashEntryHdr *entry =</span>
<a href="#l12.5531"></a><span id="l12.5531" class="difflineminus">-     m_msgReferences-&gt;Search((const void *) reference.get());</span>
<a href="#l12.5532"></a><span id="l12.5532" class="difflineminus">-    if (entry)</span>
<a href="#l12.5533"></a><span id="l12.5533" class="difflineminus">-    {</span>
<a href="#l12.5534"></a><span id="l12.5534" class="difflineplus">+        m_msgReferences-&gt;Search((const void *)reference.get());</span>
<a href="#l12.5535"></a><span id="l12.5535" class="difflineplus">+    if (entry) {</span>
<a href="#l12.5536"></a><span id="l12.5536">       RefHashElement *element = static_cast&lt;RefHashElement *&gt;(entry);</span>
<a href="#l12.5537"></a><span id="l12.5537">       if (--element-&gt;mCount == 0)</span>
<a href="#l12.5538"></a><span id="l12.5538" class="difflineminus">-        m_msgReferences-&gt;Remove((void *) reference.get());</span>
<a href="#l12.5539"></a><span id="l12.5539" class="difflineplus">+        m_msgReferences-&gt;Remove((void *)reference.get());</span>
<a href="#l12.5540"></a><span id="l12.5540">     }</span>
<a href="#l12.5541"></a><span id="l12.5541">   }</span>
<a href="#l12.5542"></a><span id="l12.5542">   return NS_OK;</span>
<a href="#l12.5543"></a><span id="l12.5543"> }</span>
<a href="#l12.5544"></a><span id="l12.5544"> </span>
<a href="#l12.5545"></a><span id="l12.5545"> // Filter only messages with one or more references</span>
<a href="#l12.5546"></a><span id="l12.5546" class="difflineminus">-nsresult nsMsgDatabase::RemoveMsgRefsFromHash(nsIMsgDBHdr *msgHdr)</span>
<a href="#l12.5547"></a><span id="l12.5547" class="difflineminus">-{</span>
<a href="#l12.5548"></a><span id="l12.5548" class="difflineplus">+nsresult nsMsgDatabase::RemoveMsgRefsFromHash(nsIMsgDBHdr *msgHdr) {</span>
<a href="#l12.5549"></a><span id="l12.5549">   uint16_t numReferences = 0;</span>
<a href="#l12.5550"></a><span id="l12.5550">   nsresult rv = NS_OK;</span>
<a href="#l12.5551"></a><span id="l12.5551"> </span>
<a href="#l12.5552"></a><span id="l12.5552">   msgHdr-&gt;GetNumReferences(&amp;numReferences);</span>
<a href="#l12.5553"></a><span id="l12.5553"> </span>
<a href="#l12.5554"></a><span id="l12.5554" class="difflineminus">-  for (int32_t i = 0; i &lt; numReferences; i++)</span>
<a href="#l12.5555"></a><span id="l12.5555" class="difflineminus">-  {</span>
<a href="#l12.5556"></a><span id="l12.5556" class="difflineplus">+  for (int32_t i = 0; i &lt; numReferences; i++) {</span>
<a href="#l12.5557"></a><span id="l12.5557">     nsAutoCString reference;</span>
<a href="#l12.5558"></a><span id="l12.5558"> </span>
<a href="#l12.5559"></a><span id="l12.5559">     msgHdr-&gt;GetStringReference(i, reference);</span>
<a href="#l12.5560"></a><span id="l12.5560" class="difflineminus">-    if (reference.IsEmpty())</span>
<a href="#l12.5561"></a><span id="l12.5561" class="difflineminus">-      break;</span>
<a href="#l12.5562"></a><span id="l12.5562" class="difflineplus">+    if (reference.IsEmpty()) break;</span>
<a href="#l12.5563"></a><span id="l12.5563"> </span>
<a href="#l12.5564"></a><span id="l12.5564">     rv = RemoveRefFromHash(reference);</span>
<a href="#l12.5565"></a><span id="l12.5565" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.5566"></a><span id="l12.5566" class="difflineminus">-      break;</span>
<a href="#l12.5567"></a><span id="l12.5567" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l12.5568"></a><span id="l12.5568">   }</span>
<a href="#l12.5569"></a><span id="l12.5569"> </span>
<a href="#l12.5570"></a><span id="l12.5570">   return rv;</span>
<a href="#l12.5571"></a><span id="l12.5571"> }</span>
<a href="#l12.5572"></a><span id="l12.5572"> </span>
<a href="#l12.5573"></a><span id="l12.5573" class="difflineminus">-static nsresult nsReferencesOnlyFilter(nsIMsgDBHdr *msg, void *closure)</span>
<a href="#l12.5574"></a><span id="l12.5574" class="difflineminus">-{</span>
<a href="#l12.5575"></a><span id="l12.5575" class="difflineplus">+static nsresult nsReferencesOnlyFilter(nsIMsgDBHdr *msg, void *closure) {</span>
<a href="#l12.5576"></a><span id="l12.5576">   uint16_t numReferences = 0;</span>
<a href="#l12.5577"></a><span id="l12.5577">   msg-&gt;GetNumReferences(&amp;numReferences);</span>
<a href="#l12.5578"></a><span id="l12.5578">   return (numReferences) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l12.5579"></a><span id="l12.5579"> }</span>
<a href="#l12.5580"></a><span id="l12.5580"> </span>
<a href="#l12.5581"></a><span id="l12.5581" class="difflineminus">-nsresult nsMsgDatabase::InitRefHash()</span>
<a href="#l12.5582"></a><span id="l12.5582" class="difflineminus">-{</span>
<a href="#l12.5583"></a><span id="l12.5583" class="difflineplus">+nsresult nsMsgDatabase::InitRefHash() {</span>
<a href="#l12.5584"></a><span id="l12.5584">   // Delete an existing table just in case</span>
<a href="#l12.5585"></a><span id="l12.5585" class="difflineminus">-  if (m_msgReferences)</span>
<a href="#l12.5586"></a><span id="l12.5586" class="difflineminus">-    delete m_msgReferences;</span>
<a href="#l12.5587"></a><span id="l12.5587" class="difflineplus">+  if (m_msgReferences) delete m_msgReferences;</span>
<a href="#l12.5588"></a><span id="l12.5588"> </span>
<a href="#l12.5589"></a><span id="l12.5589">   // Create new table</span>
<a href="#l12.5590"></a><span id="l12.5590" class="difflineminus">-  m_msgReferences = new PLDHashTable(&amp;gRefHashTableOps, sizeof(struct RefHashElement), MSG_HASH_SIZE);</span>
<a href="#l12.5591"></a><span id="l12.5591" class="difflineminus">-  if (!m_msgReferences)</span>
<a href="#l12.5592"></a><span id="l12.5592" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.5593"></a><span id="l12.5593" class="difflineplus">+  m_msgReferences = new PLDHashTable(</span>
<a href="#l12.5594"></a><span id="l12.5594" class="difflineplus">+      &amp;gRefHashTableOps, sizeof(struct RefHashElement), MSG_HASH_SIZE);</span>
<a href="#l12.5595"></a><span id="l12.5595" class="difflineplus">+  if (!m_msgReferences) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.5596"></a><span id="l12.5596"> </span>
<a href="#l12.5597"></a><span id="l12.5597">   // Create enumerator to go through all messages with references</span>
<a href="#l12.5598"></a><span id="l12.5598" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l12.5599"></a><span id="l12.5599" class="difflineminus">-  enumerator = new nsMsgDBEnumerator(this, m_mdbAllMsgHeadersTable, nsReferencesOnlyFilter, nullptr);</span>
<a href="#l12.5600"></a><span id="l12.5600" class="difflineminus">-  if (enumerator == nullptr)</span>
<a href="#l12.5601"></a><span id="l12.5601" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.5602"></a><span id="l12.5602" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l12.5603"></a><span id="l12.5603" class="difflineplus">+  enumerator = new nsMsgDBEnumerator(this, m_mdbAllMsgHeadersTable,</span>
<a href="#l12.5604"></a><span id="l12.5604" class="difflineplus">+                                     nsReferencesOnlyFilter, nullptr);</span>
<a href="#l12.5605"></a><span id="l12.5605" class="difflineplus">+  if (enumerator == nullptr) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.5606"></a><span id="l12.5606"> </span>
<a href="#l12.5607"></a><span id="l12.5607">   // Populate table with references of existing messages</span>
<a href="#l12.5608"></a><span id="l12.5608">   bool hasMore;</span>
<a href="#l12.5609"></a><span id="l12.5609">   nsresult rv = NS_OK;</span>
<a href="#l12.5610"></a><span id="l12.5610" class="difflineminus">-  while (NS_SUCCEEDED(rv = enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l12.5611"></a><span id="l12.5611" class="difflineminus">-  {</span>
<a href="#l12.5612"></a><span id="l12.5612" class="difflineminus">-    nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l12.5613"></a><span id="l12.5613" class="difflineplus">+  while (NS_SUCCEEDED(rv = enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l12.5614"></a><span id="l12.5614" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l12.5615"></a><span id="l12.5615">     rv = enumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l12.5616"></a><span id="l12.5616">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;nsMsgDBEnumerator broken&quot;);</span>
<a href="#l12.5617"></a><span id="l12.5617" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr = do_QueryInterface(supports);</span>
<a href="#l12.5618"></a><span id="l12.5618" class="difflineminus">-    if (msgHdr &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l12.5619"></a><span id="l12.5619" class="difflineminus">-      rv = AddMsgRefsToHash(msgHdr);</span>
<a href="#l12.5620"></a><span id="l12.5620" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.5621"></a><span id="l12.5621" class="difflineminus">-      break;</span>
<a href="#l12.5622"></a><span id="l12.5622" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryInterface(supports);</span>
<a href="#l12.5623"></a><span id="l12.5623" class="difflineplus">+    if (msgHdr &amp;&amp; NS_SUCCEEDED(rv)) rv = AddMsgRefsToHash(msgHdr);</span>
<a href="#l12.5624"></a><span id="l12.5624" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l12.5625"></a><span id="l12.5625">   }</span>
<a href="#l12.5626"></a><span id="l12.5626"> </span>
<a href="#l12.5627"></a><span id="l12.5627">   return rv;</span>
<a href="#l12.5628"></a><span id="l12.5628"> }</span>
<a href="#l12.5629"></a><span id="l12.5629"> </span>
<a href="#l12.5630"></a><span id="l12.5630" class="difflineminus">-nsresult nsMsgDatabase::CreateNewThread(nsMsgKey threadId, const char *subject, nsMsgThread **pnewThread)</span>
<a href="#l12.5631"></a><span id="l12.5631" class="difflineminus">-{</span>
<a href="#l12.5632"></a><span id="l12.5632" class="difflineminus">-  nsresult  err = NS_OK;</span>
<a href="#l12.5633"></a><span id="l12.5633" class="difflineplus">+nsresult nsMsgDatabase::CreateNewThread(nsMsgKey threadId, const char *subject,</span>
<a href="#l12.5634"></a><span id="l12.5634" class="difflineplus">+                                        nsMsgThread **pnewThread) {</span>
<a href="#l12.5635"></a><span id="l12.5635" class="difflineplus">+  nsresult err = NS_OK;</span>
<a href="#l12.5636"></a><span id="l12.5636">   nsCOMPtr&lt;nsIMdbTable&gt; threadTable;</span>
<a href="#l12.5637"></a><span id="l12.5637">   struct mdbOid threadTableOID;</span>
<a href="#l12.5638"></a><span id="l12.5638">   struct mdbOid allThreadsTableOID;</span>
<a href="#l12.5639"></a><span id="l12.5639"> </span>
<a href="#l12.5640"></a><span id="l12.5640" class="difflineminus">-  if (!pnewThread || !m_mdbStore)</span>
<a href="#l12.5641"></a><span id="l12.5641" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5642"></a><span id="l12.5642" class="difflineplus">+  if (!pnewThread || !m_mdbStore) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5643"></a><span id="l12.5643"> </span>
<a href="#l12.5644"></a><span id="l12.5644">   threadTableOID.mOid_Scope = m_hdrRowScopeToken;</span>
<a href="#l12.5645"></a><span id="l12.5645">   threadTableOID.mOid_Id = threadId;</span>
<a href="#l12.5646"></a><span id="l12.5646"> </span>
<a href="#l12.5647"></a><span id="l12.5647" class="difflineminus">-  // Under some circumstances, mork seems to reuse an old table when we create one.</span>
<a href="#l12.5648"></a><span id="l12.5648" class="difflineminus">-  // Prevent problems from that by finding any old table first, and deleting its rows.</span>
<a href="#l12.5649"></a><span id="l12.5649" class="difflineminus">-  nsresult res = GetStore()-&gt;GetTable(GetEnv(), &amp;threadTableOID, getter_AddRefs(threadTable));</span>
<a href="#l12.5650"></a><span id="l12.5650" class="difflineminus">-  if (NS_SUCCEEDED(res) &amp;&amp; threadTable)</span>
<a href="#l12.5651"></a><span id="l12.5651" class="difflineminus">-    threadTable-&gt;CutAllRows(GetEnv());</span>
<a href="#l12.5652"></a><span id="l12.5652" class="difflineminus">-</span>
<a href="#l12.5653"></a><span id="l12.5653" class="difflineminus">-  err  = GetStore()-&gt;NewTableWithOid(GetEnv(), &amp;threadTableOID, m_threadTableKindToken,</span>
<a href="#l12.5654"></a><span id="l12.5654" class="difflineminus">-    false, nullptr, getter_AddRefs(threadTable));</span>
<a href="#l12.5655"></a><span id="l12.5655" class="difflineminus">-  if (NS_FAILED(err))</span>
<a href="#l12.5656"></a><span id="l12.5656" class="difflineminus">-    return err;</span>
<a href="#l12.5657"></a><span id="l12.5657" class="difflineplus">+  // Under some circumstances, mork seems to reuse an old table when we create</span>
<a href="#l12.5658"></a><span id="l12.5658" class="difflineplus">+  // one. Prevent problems from that by finding any old table first, and</span>
<a href="#l12.5659"></a><span id="l12.5659" class="difflineplus">+  // deleting its rows.</span>
<a href="#l12.5660"></a><span id="l12.5660" class="difflineplus">+  nsresult res = GetStore()-&gt;GetTable(GetEnv(), &amp;threadTableOID,</span>
<a href="#l12.5661"></a><span id="l12.5661" class="difflineplus">+                                      getter_AddRefs(threadTable));</span>
<a href="#l12.5662"></a><span id="l12.5662" class="difflineplus">+  if (NS_SUCCEEDED(res) &amp;&amp; threadTable) threadTable-&gt;CutAllRows(GetEnv());</span>
<a href="#l12.5663"></a><span id="l12.5663" class="difflineplus">+</span>
<a href="#l12.5664"></a><span id="l12.5664" class="difflineplus">+  err = GetStore()-&gt;NewTableWithOid(GetEnv(), &amp;threadTableOID,</span>
<a href="#l12.5665"></a><span id="l12.5665" class="difflineplus">+                                    m_threadTableKindToken, false, nullptr,</span>
<a href="#l12.5666"></a><span id="l12.5666" class="difflineplus">+                                    getter_AddRefs(threadTable));</span>
<a href="#l12.5667"></a><span id="l12.5667" class="difflineplus">+  if (NS_FAILED(err)) return err;</span>
<a href="#l12.5668"></a><span id="l12.5668"> </span>
<a href="#l12.5669"></a><span id="l12.5669">   allThreadsTableOID.mOid_Scope = m_threadRowScopeToken;</span>
<a href="#l12.5670"></a><span id="l12.5670">   allThreadsTableOID.mOid_Id = threadId;</span>
<a href="#l12.5671"></a><span id="l12.5671"> </span>
<a href="#l12.5672"></a><span id="l12.5672">   // add a row for this thread in the table of all threads that we'll use</span>
<a href="#l12.5673"></a><span id="l12.5673">   // to do our mapping between subject strings and threads.</span>
<a href="#l12.5674"></a><span id="l12.5674">   nsCOMPtr&lt;nsIMdbRow&gt; threadRow;</span>
<a href="#l12.5675"></a><span id="l12.5675"> </span>
<a href="#l12.5676"></a><span id="l12.5676">   err = m_mdbStore-&gt;GetRow(GetEnv(), &amp;allThreadsTableOID,</span>
<a href="#l12.5677"></a><span id="l12.5677">                            getter_AddRefs(threadRow));</span>
<a href="#l12.5678"></a><span id="l12.5678" class="difflineminus">-  if (!threadRow)</span>
<a href="#l12.5679"></a><span id="l12.5679" class="difflineminus">-  {</span>
<a href="#l12.5680"></a><span id="l12.5680" class="difflineminus">-    err  = m_mdbStore-&gt;NewRowWithOid(GetEnv(), &amp;allThreadsTableOID,</span>
<a href="#l12.5681"></a><span id="l12.5681" class="difflineminus">-                                     getter_AddRefs(threadRow));</span>
<a href="#l12.5682"></a><span id="l12.5682" class="difflineminus">-    if (NS_SUCCEEDED(err) &amp;&amp; threadRow)</span>
<a href="#l12.5683"></a><span id="l12.5683" class="difflineminus">-    {</span>
<a href="#l12.5684"></a><span id="l12.5684" class="difflineplus">+  if (!threadRow) {</span>
<a href="#l12.5685"></a><span id="l12.5685" class="difflineplus">+    err = m_mdbStore-&gt;NewRowWithOid(GetEnv(), &amp;allThreadsTableOID,</span>
<a href="#l12.5686"></a><span id="l12.5686" class="difflineplus">+                                    getter_AddRefs(threadRow));</span>
<a href="#l12.5687"></a><span id="l12.5687" class="difflineplus">+    if (NS_SUCCEEDED(err) &amp;&amp; threadRow) {</span>
<a href="#l12.5688"></a><span id="l12.5688">       if (m_mdbAllThreadsTable)</span>
<a href="#l12.5689"></a><span id="l12.5689">         m_mdbAllThreadsTable-&gt;AddRow(GetEnv(), threadRow);</span>
<a href="#l12.5690"></a><span id="l12.5690" class="difflineminus">-      err = CharPtrToRowCellColumn(threadRow, m_threadSubjectColumnToken, subject);</span>
<a href="#l12.5691"></a><span id="l12.5691" class="difflineplus">+      err = CharPtrToRowCellColumn(threadRow, m_threadSubjectColumnToken,</span>
<a href="#l12.5692"></a><span id="l12.5692" class="difflineplus">+                                   subject);</span>
<a href="#l12.5693"></a><span id="l12.5693">     }</span>
<a href="#l12.5694"></a><span id="l12.5694" class="difflineminus">-  }</span>
<a href="#l12.5695"></a><span id="l12.5695" class="difflineminus">-  else</span>
<a href="#l12.5696"></a><span id="l12.5696" class="difflineminus">-  {</span>
<a href="#l12.5697"></a><span id="l12.5697" class="difflineplus">+  } else {</span>
<a href="#l12.5698"></a><span id="l12.5698"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l12.5699"></a><span id="l12.5699">     NS_WARNING(&quot;odd that thread row already exists&quot;);</span>
<a href="#l12.5700"></a><span id="l12.5700"> #endif</span>
<a href="#l12.5701"></a><span id="l12.5701">     threadRow-&gt;CutAllColumns(GetEnv());</span>
<a href="#l12.5702"></a><span id="l12.5702">     nsCOMPtr&lt;nsIMdbRow&gt; metaRow;</span>
<a href="#l12.5703"></a><span id="l12.5703" class="difflineminus">-    threadTable-&gt;GetMetaRow(GetEnv(), nullptr, nullptr, getter_AddRefs(metaRow));</span>
<a href="#l12.5704"></a><span id="l12.5704" class="difflineminus">-    if (metaRow)</span>
<a href="#l12.5705"></a><span id="l12.5705" class="difflineminus">-      metaRow-&gt;CutAllColumns(GetEnv());</span>
<a href="#l12.5706"></a><span id="l12.5706" class="difflineplus">+    threadTable-&gt;GetMetaRow(GetEnv(), nullptr, nullptr,</span>
<a href="#l12.5707"></a><span id="l12.5707" class="difflineplus">+                            getter_AddRefs(metaRow));</span>
<a href="#l12.5708"></a><span id="l12.5708" class="difflineplus">+    if (metaRow) metaRow-&gt;CutAllColumns(GetEnv());</span>
<a href="#l12.5709"></a><span id="l12.5709"> </span>
<a href="#l12.5710"></a><span id="l12.5710">     CharPtrToRowCellColumn(threadRow, m_threadSubjectColumnToken, subject);</span>
<a href="#l12.5711"></a><span id="l12.5711">   }</span>
<a href="#l12.5712"></a><span id="l12.5712"> </span>
<a href="#l12.5713"></a><span id="l12.5713" class="difflineminus">-</span>
<a href="#l12.5714"></a><span id="l12.5714">   *pnewThread = new nsMsgThread(this, threadTable);</span>
<a href="#l12.5715"></a><span id="l12.5715" class="difflineminus">-  if (*pnewThread)</span>
<a href="#l12.5716"></a><span id="l12.5716" class="difflineminus">-  {</span>
<a href="#l12.5717"></a><span id="l12.5717" class="difflineplus">+  if (*pnewThread) {</span>
<a href="#l12.5718"></a><span id="l12.5718">     (*pnewThread)-&gt;SetThreadKey(threadId);</span>
<a href="#l12.5719"></a><span id="l12.5719" class="difflineminus">-     m_cachedThread = *pnewThread;</span>
<a href="#l12.5720"></a><span id="l12.5720" class="difflineminus">-     m_cachedThreadId = threadId;</span>
<a href="#l12.5721"></a><span id="l12.5721" class="difflineplus">+    m_cachedThread = *pnewThread;</span>
<a href="#l12.5722"></a><span id="l12.5722" class="difflineplus">+    m_cachedThreadId = threadId;</span>
<a href="#l12.5723"></a><span id="l12.5723">   }</span>
<a href="#l12.5724"></a><span id="l12.5724">   return err;</span>
<a href="#l12.5725"></a><span id="l12.5725"> }</span>
<a href="#l12.5726"></a><span id="l12.5726"> </span>
<a href="#l12.5727"></a><span id="l12.5727" class="difflineminus">-</span>
<a href="#l12.5728"></a><span id="l12.5728" class="difflineminus">-nsIMsgThread *nsMsgDatabase::GetThreadForReference(nsCString &amp;msgID, nsIMsgDBHdr **pMsgHdr)</span>
<a href="#l12.5729"></a><span id="l12.5729" class="difflineminus">-{</span>
<a href="#l12.5730"></a><span id="l12.5730" class="difflineplus">+nsIMsgThread *nsMsgDatabase::GetThreadForReference(nsCString &amp;msgID,</span>
<a href="#l12.5731"></a><span id="l12.5731" class="difflineplus">+                                                   nsIMsgDBHdr **pMsgHdr) {</span>
<a href="#l12.5732"></a><span id="l12.5732">   nsMsgKey threadId;</span>
<a href="#l12.5733"></a><span id="l12.5733" class="difflineminus">-  nsIMsgDBHdr  *msgHdr = nullptr;</span>
<a href="#l12.5734"></a><span id="l12.5734" class="difflineplus">+  nsIMsgDBHdr *msgHdr = nullptr;</span>
<a href="#l12.5735"></a><span id="l12.5735">   GetMsgHdrForMessageID(msgID.get(), &amp;msgHdr);</span>
<a href="#l12.5736"></a><span id="l12.5736">   nsIMsgThread *thread = NULL;</span>
<a href="#l12.5737"></a><span id="l12.5737"> </span>
<a href="#l12.5738"></a><span id="l12.5738" class="difflineminus">-  if (msgHdr != NULL)</span>
<a href="#l12.5739"></a><span id="l12.5739" class="difflineminus">-  {</span>
<a href="#l12.5740"></a><span id="l12.5740" class="difflineminus">-    if (NS_SUCCEEDED(msgHdr-&gt;GetThreadId(&amp;threadId)))</span>
<a href="#l12.5741"></a><span id="l12.5741" class="difflineminus">-    {</span>
<a href="#l12.5742"></a><span id="l12.5742" class="difflineplus">+  if (msgHdr != NULL) {</span>
<a href="#l12.5743"></a><span id="l12.5743" class="difflineplus">+    if (NS_SUCCEEDED(msgHdr-&gt;GetThreadId(&amp;threadId))) {</span>
<a href="#l12.5744"></a><span id="l12.5744">       // find thread header for header whose message id we matched.</span>
<a href="#l12.5745"></a><span id="l12.5745">       thread = GetThreadForThreadId(threadId);</span>
<a href="#l12.5746"></a><span id="l12.5746">     }</span>
<a href="#l12.5747"></a><span id="l12.5747">     if (pMsgHdr)</span>
<a href="#l12.5748"></a><span id="l12.5748">       *pMsgHdr = msgHdr;</span>
<a href="#l12.5749"></a><span id="l12.5749">     else</span>
<a href="#l12.5750"></a><span id="l12.5750">       msgHdr-&gt;Release();</span>
<a href="#l12.5751"></a><span id="l12.5751">   }</span>
<a href="#l12.5752"></a><span id="l12.5752" class="difflineminus">-  // Referenced message not found, check if there are messages that reference same message</span>
<a href="#l12.5753"></a><span id="l12.5753" class="difflineminus">-  else if (UseCorrectThreading())</span>
<a href="#l12.5754"></a><span id="l12.5754" class="difflineminus">-  {</span>
<a href="#l12.5755"></a><span id="l12.5755" class="difflineplus">+  // Referenced message not found, check if there are messages that reference</span>
<a href="#l12.5756"></a><span id="l12.5756" class="difflineplus">+  // same message</span>
<a href="#l12.5757"></a><span id="l12.5757" class="difflineplus">+  else if (UseCorrectThreading()) {</span>
<a href="#l12.5758"></a><span id="l12.5758">     if (NS_SUCCEEDED(GetRefFromHash(msgID, &amp;threadId)))</span>
<a href="#l12.5759"></a><span id="l12.5759">       thread = GetThreadForThreadId(threadId);</span>
<a href="#l12.5760"></a><span id="l12.5760">   }</span>
<a href="#l12.5761"></a><span id="l12.5761"> </span>
<a href="#l12.5762"></a><span id="l12.5762">   return thread;</span>
<a href="#l12.5763"></a><span id="l12.5763"> }</span>
<a href="#l12.5764"></a><span id="l12.5764"> </span>
<a href="#l12.5765"></a><span id="l12.5765" class="difflineminus">-nsIMsgThread *  nsMsgDatabase::GetThreadForSubject(nsCString &amp;subject)</span>
<a href="#l12.5766"></a><span id="l12.5766" class="difflineminus">-{</span>
<a href="#l12.5767"></a><span id="l12.5767" class="difflineplus">+nsIMsgThread *nsMsgDatabase::GetThreadForSubject(nsCString &amp;subject) {</span>
<a href="#l12.5768"></a><span id="l12.5768">   nsIMsgThread *thread = nullptr;</span>
<a href="#l12.5769"></a><span id="l12.5769"> </span>
<a href="#l12.5770"></a><span id="l12.5770" class="difflineminus">-  mdbYarn  subjectYarn;</span>
<a href="#l12.5771"></a><span id="l12.5771" class="difflineminus">-</span>
<a href="#l12.5772"></a><span id="l12.5772" class="difflineminus">-  subjectYarn.mYarn_Buf = (void*)subject.get();</span>
<a href="#l12.5773"></a><span id="l12.5773" class="difflineplus">+  mdbYarn subjectYarn;</span>
<a href="#l12.5774"></a><span id="l12.5774" class="difflineplus">+</span>
<a href="#l12.5775"></a><span id="l12.5775" class="difflineplus">+  subjectYarn.mYarn_Buf = (void *)subject.get();</span>
<a href="#l12.5776"></a><span id="l12.5776">   subjectYarn.mYarn_Fill = PL_strlen(subject.get());</span>
<a href="#l12.5777"></a><span id="l12.5777">   subjectYarn.mYarn_Form = 0;</span>
<a href="#l12.5778"></a><span id="l12.5778">   subjectYarn.mYarn_Size = subjectYarn.mYarn_Fill;</span>
<a href="#l12.5779"></a><span id="l12.5779"> </span>
<a href="#l12.5780"></a><span id="l12.5780" class="difflineminus">-  nsCOMPtr &lt;nsIMdbRow&gt;  threadRow;</span>
<a href="#l12.5781"></a><span id="l12.5781" class="difflineminus">-  mdbOid    outRowId;</span>
<a href="#l12.5782"></a><span id="l12.5782" class="difflineminus">-  if (m_mdbStore)</span>
<a href="#l12.5783"></a><span id="l12.5783" class="difflineminus">-  {</span>
<a href="#l12.5784"></a><span id="l12.5784" class="difflineminus">-    nsresult result = m_mdbStore-&gt;FindRow(GetEnv(), m_threadRowScopeToken,</span>
<a href="#l12.5785"></a><span id="l12.5785" class="difflineminus">-      m_threadSubjectColumnToken, &amp;subjectYarn,  &amp;outRowId, getter_AddRefs(threadRow));</span>
<a href="#l12.5786"></a><span id="l12.5786" class="difflineminus">-    if (NS_SUCCEEDED(result) &amp;&amp; threadRow)</span>
<a href="#l12.5787"></a><span id="l12.5787" class="difflineminus">-    {</span>
<a href="#l12.5788"></a><span id="l12.5788" class="difflineminus">-      //Get key from row</span>
<a href="#l12.5789"></a><span id="l12.5789" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; threadRow;</span>
<a href="#l12.5790"></a><span id="l12.5790" class="difflineplus">+  mdbOid outRowId;</span>
<a href="#l12.5791"></a><span id="l12.5791" class="difflineplus">+  if (m_mdbStore) {</span>
<a href="#l12.5792"></a><span id="l12.5792" class="difflineplus">+    nsresult result = m_mdbStore-&gt;FindRow(</span>
<a href="#l12.5793"></a><span id="l12.5793" class="difflineplus">+        GetEnv(), m_threadRowScopeToken, m_threadSubjectColumnToken,</span>
<a href="#l12.5794"></a><span id="l12.5794" class="difflineplus">+        &amp;subjectYarn, &amp;outRowId, getter_AddRefs(threadRow));</span>
<a href="#l12.5795"></a><span id="l12.5795" class="difflineplus">+    if (NS_SUCCEEDED(result) &amp;&amp; threadRow) {</span>
<a href="#l12.5796"></a><span id="l12.5796" class="difflineplus">+      // Get key from row</span>
<a href="#l12.5797"></a><span id="l12.5797">       mdbOid outOid;</span>
<a href="#l12.5798"></a><span id="l12.5798">       nsMsgKey key = nsMsgKey_None;</span>
<a href="#l12.5799"></a><span id="l12.5799">       if (NS_SUCCEEDED(threadRow-&gt;GetOid(GetEnv(), &amp;outOid)))</span>
<a href="#l12.5800"></a><span id="l12.5800">         key = outOid.mOid_Id;</span>
<a href="#l12.5801"></a><span id="l12.5801">       // find thread header for header whose message id we matched.</span>
<a href="#l12.5802"></a><span id="l12.5802">       // It is fine if key was not found,</span>
<a href="#l12.5803"></a><span id="l12.5803">       // GetThreadForThreadId(nsMsgKey_None) returns nullptr.</span>
<a href="#l12.5804"></a><span id="l12.5804">       thread = GetThreadForThreadId(key);</span>
<a href="#l12.5805"></a><span id="l12.5805">     }</span>
<a href="#l12.5806"></a><span id="l12.5806"> #ifdef DEBUG_bienvenu1</span>
<a href="#l12.5807"></a><span id="l12.5807" class="difflineminus">-    else</span>
<a href="#l12.5808"></a><span id="l12.5808" class="difflineminus">-    {</span>
<a href="#l12.5809"></a><span id="l12.5809" class="difflineminus">-      nsresult  rv;</span>
<a href="#l12.5810"></a><span id="l12.5810" class="difflineplus">+    else {</span>
<a href="#l12.5811"></a><span id="l12.5811" class="difflineplus">+      nsresult rv;</span>
<a href="#l12.5812"></a><span id="l12.5812">       RefPtr&lt;nsMsgThread&gt; pThread;</span>
<a href="#l12.5813"></a><span id="l12.5813"> </span>
<a href="#l12.5814"></a><span id="l12.5814" class="difflineminus">-      nsCOMPtr &lt;nsIMdbPortTableCursor&gt; tableCursor;</span>
<a href="#l12.5815"></a><span id="l12.5815" class="difflineminus">-      m_mdbStore-&gt;GetPortTableCursor(GetEnv(), m_hdrRowScopeToken, m_threadTableKindToken,</span>
<a href="#l12.5816"></a><span id="l12.5816" class="difflineplus">+      nsCOMPtr&lt;nsIMdbPortTableCursor&gt; tableCursor;</span>
<a href="#l12.5817"></a><span id="l12.5817" class="difflineplus">+      m_mdbStore-&gt;GetPortTableCursor(GetEnv(), m_hdrRowScopeToken,</span>
<a href="#l12.5818"></a><span id="l12.5818" class="difflineplus">+                                     m_threadTableKindToken,</span>
<a href="#l12.5819"></a><span id="l12.5819">                                      getter_AddRefs(tableCursor));</span>
<a href="#l12.5820"></a><span id="l12.5820"> </span>
<a href="#l12.5821"></a><span id="l12.5821" class="difflineminus">-        nsCOMPtr&lt;nsIMdbTable&gt; table;</span>
<a href="#l12.5822"></a><span id="l12.5822" class="difflineminus">-</span>
<a href="#l12.5823"></a><span id="l12.5823" class="difflineminus">-        while (true)</span>
<a href="#l12.5824"></a><span id="l12.5824" class="difflineminus">-        {</span>
<a href="#l12.5825"></a><span id="l12.5825" class="difflineminus">-          rv = tableCursor-&gt;NextTable(GetEnv(), getter_AddRefs(table));</span>
<a href="#l12.5826"></a><span id="l12.5826" class="difflineminus">-          if (!table)</span>
<a href="#l12.5827"></a><span id="l12.5827" class="difflineplus">+      nsCOMPtr&lt;nsIMdbTable&gt; table;</span>
<a href="#l12.5828"></a><span id="l12.5828" class="difflineplus">+</span>
<a href="#l12.5829"></a><span id="l12.5829" class="difflineplus">+      while (true) {</span>
<a href="#l12.5830"></a><span id="l12.5830" class="difflineplus">+        rv = tableCursor-&gt;NextTable(GetEnv(), getter_AddRefs(table));</span>
<a href="#l12.5831"></a><span id="l12.5831" class="difflineplus">+        if (!table) break;</span>
<a href="#l12.5832"></a><span id="l12.5832" class="difflineplus">+        if (NS_FAILED(rv)) break;</span>
<a href="#l12.5833"></a><span id="l12.5833" class="difflineplus">+</span>
<a href="#l12.5834"></a><span id="l12.5834" class="difflineplus">+        pThread = new nsMsgThread(this, table);</span>
<a href="#l12.5835"></a><span id="l12.5835" class="difflineplus">+        if (pThread) {</span>
<a href="#l12.5836"></a><span id="l12.5836" class="difflineplus">+          nsCString curSubject;</span>
<a href="#l12.5837"></a><span id="l12.5837" class="difflineplus">+          pThread-&gt;GetSubject(curSubject);</span>
<a href="#l12.5838"></a><span id="l12.5838" class="difflineplus">+          if (subject.Equals(curSubject)) {</span>
<a href="#l12.5839"></a><span id="l12.5839" class="difflineplus">+            NS_ERROR(</span>
<a href="#l12.5840"></a><span id="l12.5840" class="difflineplus">+                &quot;thread with subject exists, but FindRow didn't find it\n&quot;);</span>
<a href="#l12.5841"></a><span id="l12.5841">             break;</span>
<a href="#l12.5842"></a><span id="l12.5842" class="difflineminus">-          if (NS_FAILED(rv))</span>
<a href="#l12.5843"></a><span id="l12.5843" class="difflineminus">-            break;</span>
<a href="#l12.5844"></a><span id="l12.5844" class="difflineminus">-</span>
<a href="#l12.5845"></a><span id="l12.5845" class="difflineminus">-          pThread = new nsMsgThread(this, table);</span>
<a href="#l12.5846"></a><span id="l12.5846" class="difflineminus">-          if (pThread)</span>
<a href="#l12.5847"></a><span id="l12.5847" class="difflineminus">-          {</span>
<a href="#l12.5848"></a><span id="l12.5848" class="difflineminus">-            nsCString curSubject;</span>
<a href="#l12.5849"></a><span id="l12.5849" class="difflineminus">-            pThread-&gt;GetSubject(curSubject);</span>
<a href="#l12.5850"></a><span id="l12.5850" class="difflineminus">-            if (subject.Equals(curSubject))</span>
<a href="#l12.5851"></a><span id="l12.5851" class="difflineminus">-            {</span>
<a href="#l12.5852"></a><span id="l12.5852" class="difflineminus">-              NS_ERROR(&quot;thread with subject exists, but FindRow didn't find it\n&quot;);</span>
<a href="#l12.5853"></a><span id="l12.5853" class="difflineminus">-              break;</span>
<a href="#l12.5854"></a><span id="l12.5854" class="difflineminus">-            }</span>
<a href="#l12.5855"></a><span id="l12.5855">           }</span>
<a href="#l12.5856"></a><span id="l12.5856" class="difflineminus">-          else</span>
<a href="#l12.5857"></a><span id="l12.5857" class="difflineminus">-            break;</span>
<a href="#l12.5858"></a><span id="l12.5858" class="difflineminus">-        }</span>
<a href="#l12.5859"></a><span id="l12.5859" class="difflineplus">+        } else</span>
<a href="#l12.5860"></a><span id="l12.5860" class="difflineplus">+          break;</span>
<a href="#l12.5861"></a><span id="l12.5861">       }</span>
<a href="#l12.5862"></a><span id="l12.5862" class="difflineplus">+    }</span>
<a href="#l12.5863"></a><span id="l12.5863"> #endif</span>
<a href="#l12.5864"></a><span id="l12.5864">   }</span>
<a href="#l12.5865"></a><span id="l12.5865">   return thread;</span>
<a href="#l12.5866"></a><span id="l12.5866"> }</span>
<a href="#l12.5867"></a><span id="l12.5867"> </span>
<a href="#l12.5868"></a><span id="l12.5868"> // Returns thread that contains a message that references the passed message ID</span>
<a href="#l12.5869"></a><span id="l12.5869" class="difflineminus">-nsIMsgThread *nsMsgDatabase::GetThreadForMessageId(nsCString &amp;msgId)</span>
<a href="#l12.5870"></a><span id="l12.5870" class="difflineminus">-{</span>
<a href="#l12.5871"></a><span id="l12.5871" class="difflineplus">+nsIMsgThread *nsMsgDatabase::GetThreadForMessageId(nsCString &amp;msgId) {</span>
<a href="#l12.5872"></a><span id="l12.5872">   nsIMsgThread *thread = NULL;</span>
<a href="#l12.5873"></a><span id="l12.5873">   nsMsgKey threadId;</span>
<a href="#l12.5874"></a><span id="l12.5874"> </span>
<a href="#l12.5875"></a><span id="l12.5875">   if (NS_SUCCEEDED(GetRefFromHash(msgId, &amp;threadId)))</span>
<a href="#l12.5876"></a><span id="l12.5876">     thread = GetThreadForThreadId(threadId);</span>
<a href="#l12.5877"></a><span id="l12.5877"> </span>
<a href="#l12.5878"></a><span id="l12.5878">   return thread;</span>
<a href="#l12.5879"></a><span id="l12.5879"> }</span>
<a href="#l12.5880"></a><span id="l12.5880"> </span>
<a href="#l12.5881"></a><span id="l12.5881" class="difflineminus">-nsresult nsMsgDatabase::ThreadNewHdr(nsMsgHdr* newHdr, bool &amp;newThread)</span>
<a href="#l12.5882"></a><span id="l12.5882" class="difflineminus">-{</span>
<a href="#l12.5883"></a><span id="l12.5883" class="difflineminus">-  nsresult result=NS_ERROR_UNEXPECTED;</span>
<a href="#l12.5884"></a><span id="l12.5884" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l12.5885"></a><span id="l12.5885" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; replyToHdr;</span>
<a href="#l12.5886"></a><span id="l12.5886" class="difflineplus">+nsresult nsMsgDatabase::ThreadNewHdr(nsMsgHdr *newHdr, bool &amp;newThread) {</span>
<a href="#l12.5887"></a><span id="l12.5887" class="difflineplus">+  nsresult result = NS_ERROR_UNEXPECTED;</span>
<a href="#l12.5888"></a><span id="l12.5888" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l12.5889"></a><span id="l12.5889" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; replyToHdr;</span>
<a href="#l12.5890"></a><span id="l12.5890">   nsMsgKey threadId = nsMsgKey_None, newHdrKey;</span>
<a href="#l12.5891"></a><span id="l12.5891"> </span>
<a href="#l12.5892"></a><span id="l12.5892" class="difflineminus">-  if (!newHdr)</span>
<a href="#l12.5893"></a><span id="l12.5893" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5894"></a><span id="l12.5894" class="difflineminus">-</span>
<a href="#l12.5895"></a><span id="l12.5895" class="difflineminus">-  newHdr-&gt;SetThreadParent(nsMsgKey_None); // if we're undoing, could have a thread parent</span>
<a href="#l12.5896"></a><span id="l12.5896" class="difflineplus">+  if (!newHdr) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.5897"></a><span id="l12.5897" class="difflineplus">+</span>
<a href="#l12.5898"></a><span id="l12.5898" class="difflineplus">+  newHdr-&gt;SetThreadParent(</span>
<a href="#l12.5899"></a><span id="l12.5899" class="difflineplus">+      nsMsgKey_None);  // if we're undoing, could have a thread parent</span>
<a href="#l12.5900"></a><span id="l12.5900">   uint16_t numReferences = 0;</span>
<a href="#l12.5901"></a><span id="l12.5901">   uint32_t newHdrFlags = 0;</span>
<a href="#l12.5902"></a><span id="l12.5902"> </span>
<a href="#l12.5903"></a><span id="l12.5903">   // use raw flags instead of GetFlags, because GetFlags will</span>
<a href="#l12.5904"></a><span id="l12.5904">   // pay attention to what's in m_newSet, and this new hdr isn't</span>
<a href="#l12.5905"></a><span id="l12.5905">   // in m_newSet yet.</span>
<a href="#l12.5906"></a><span id="l12.5906">   newHdr-&gt;GetRawFlags(&amp;newHdrFlags);</span>
<a href="#l12.5907"></a><span id="l12.5907">   newHdr-&gt;GetNumReferences(&amp;numReferences);</span>
<a href="#l12.5908"></a><span id="l12.5908">   newHdr-&gt;GetMessageKey(&amp;newHdrKey);</span>
<a href="#l12.5909"></a><span id="l12.5909"> </span>
<a href="#l12.5910"></a><span id="l12.5910">   // try reference threading first</span>
<a href="#l12.5911"></a><span id="l12.5911" class="difflineminus">-  for (int32_t i = numReferences - 1; i &gt;= 0;  i--)</span>
<a href="#l12.5912"></a><span id="l12.5912" class="difflineminus">-  {</span>
<a href="#l12.5913"></a><span id="l12.5913" class="difflineplus">+  for (int32_t i = numReferences - 1; i &gt;= 0; i--) {</span>
<a href="#l12.5914"></a><span id="l12.5914">     nsAutoCString reference;</span>
<a href="#l12.5915"></a><span id="l12.5915"> </span>
<a href="#l12.5916"></a><span id="l12.5916">     newHdr-&gt;GetStringReference(i, reference);</span>
<a href="#l12.5917"></a><span id="l12.5917">     // first reference we have hdr for is best top-level hdr.</span>
<a href="#l12.5918"></a><span id="l12.5918">     // but we have to handle case of promoting new header to top-level</span>
<a href="#l12.5919"></a><span id="l12.5919">     // in case the top-level header comes after a reply.</span>
<a href="#l12.5920"></a><span id="l12.5920"> </span>
<a href="#l12.5921"></a><span id="l12.5921" class="difflineminus">-    if (reference.IsEmpty())</span>
<a href="#l12.5922"></a><span id="l12.5922" class="difflineminus">-      break;</span>
<a href="#l12.5923"></a><span id="l12.5923" class="difflineminus">-</span>
<a href="#l12.5924"></a><span id="l12.5924" class="difflineminus">-    thread = dont_AddRef(GetThreadForReference(reference, getter_AddRefs(replyToHdr))) ;</span>
<a href="#l12.5925"></a><span id="l12.5925" class="difflineminus">-    if (thread)</span>
<a href="#l12.5926"></a><span id="l12.5926" class="difflineminus">-    {</span>
<a href="#l12.5927"></a><span id="l12.5927" class="difflineminus">-      if (replyToHdr)</span>
<a href="#l12.5928"></a><span id="l12.5928" class="difflineminus">-      {</span>
<a href="#l12.5929"></a><span id="l12.5929" class="difflineplus">+    if (reference.IsEmpty()) break;</span>
<a href="#l12.5930"></a><span id="l12.5930" class="difflineplus">+</span>
<a href="#l12.5931"></a><span id="l12.5931" class="difflineplus">+    thread = dont_AddRef(</span>
<a href="#l12.5932"></a><span id="l12.5932" class="difflineplus">+        GetThreadForReference(reference, getter_AddRefs(replyToHdr)));</span>
<a href="#l12.5933"></a><span id="l12.5933" class="difflineplus">+    if (thread) {</span>
<a href="#l12.5934"></a><span id="l12.5934" class="difflineplus">+      if (replyToHdr) {</span>
<a href="#l12.5935"></a><span id="l12.5935">         nsMsgKey replyToKey;</span>
<a href="#l12.5936"></a><span id="l12.5936">         replyToHdr-&gt;GetMessageKey(&amp;replyToKey);</span>
<a href="#l12.5937"></a><span id="l12.5937" class="difflineminus">-        // message claims to be a reply to itself - ignore that since it leads to corrupt threading.</span>
<a href="#l12.5938"></a><span id="l12.5938" class="difflineminus">-        if (replyToKey == newHdrKey)</span>
<a href="#l12.5939"></a><span id="l12.5939" class="difflineminus">-        {</span>
<a href="#l12.5940"></a><span id="l12.5940" class="difflineplus">+        // message claims to be a reply to itself - ignore that since it leads</span>
<a href="#l12.5941"></a><span id="l12.5941" class="difflineplus">+        // to corrupt threading.</span>
<a href="#l12.5942"></a><span id="l12.5942" class="difflineplus">+        if (replyToKey == newHdrKey) {</span>
<a href="#l12.5943"></a><span id="l12.5943">           // bad references - throw them all away.</span>
<a href="#l12.5944"></a><span id="l12.5944">           newHdr-&gt;SetMessageId(&quot;&quot;);</span>
<a href="#l12.5945"></a><span id="l12.5945">           thread = nullptr;</span>
<a href="#l12.5946"></a><span id="l12.5946">           break;</span>
<a href="#l12.5947"></a><span id="l12.5947">         }</span>
<a href="#l12.5948"></a><span id="l12.5948">       }</span>
<a href="#l12.5949"></a><span id="l12.5949">       thread-&gt;GetThreadKey(&amp;threadId);</span>
<a href="#l12.5950"></a><span id="l12.5950">       newHdr-&gt;SetThreadId(threadId);</span>
<a href="#l12.5951"></a><span id="l12.5951">       result = AddToThread(newHdr, thread, replyToHdr, true);</span>
<a href="#l12.5952"></a><span id="l12.5952">       break;</span>
<a href="#l12.5953"></a><span id="l12.5953">     }</span>
<a href="#l12.5954"></a><span id="l12.5954">   }</span>
<a href="#l12.5955"></a><span id="l12.5955">   // if user hasn't said &quot;only thread by ref headers&quot;, thread by subject</span>
<a href="#l12.5956"></a><span id="l12.5956" class="difflineminus">-  if (!thread &amp;&amp; !UseStrictThreading())</span>
<a href="#l12.5957"></a><span id="l12.5957" class="difflineminus">-  {</span>
<a href="#l12.5958"></a><span id="l12.5958" class="difflineminus">-    // try subject threading if we couldn't find a reference and the subject starts with Re:</span>
<a href="#l12.5959"></a><span id="l12.5959" class="difflineplus">+  if (!thread &amp;&amp; !UseStrictThreading()) {</span>
<a href="#l12.5960"></a><span id="l12.5960" class="difflineplus">+    // try subject threading if we couldn't find a reference and the subject</span>
<a href="#l12.5961"></a><span id="l12.5961" class="difflineplus">+    // starts with Re:</span>
<a href="#l12.5962"></a><span id="l12.5962">     nsCString subject;</span>
<a href="#l12.5963"></a><span id="l12.5963">     newHdr-&gt;GetSubject(getter_Copies(subject));</span>
<a href="#l12.5964"></a><span id="l12.5964" class="difflineminus">-    if (ThreadBySubjectWithoutRe() || (newHdrFlags &amp; nsMsgMessageFlags::HasRe))</span>
<a href="#l12.5965"></a><span id="l12.5965" class="difflineminus">-    {</span>
<a href="#l12.5966"></a><span id="l12.5966" class="difflineplus">+    if (ThreadBySubjectWithoutRe() ||</span>
<a href="#l12.5967"></a><span id="l12.5967" class="difflineplus">+        (newHdrFlags &amp; nsMsgMessageFlags::HasRe)) {</span>
<a href="#l12.5968"></a><span id="l12.5968">       nsAutoCString cSubject(subject);</span>
<a href="#l12.5969"></a><span id="l12.5969">       thread = dont_AddRef(GetThreadForSubject(cSubject));</span>
<a href="#l12.5970"></a><span id="l12.5970" class="difflineminus">-      if(thread)</span>
<a href="#l12.5971"></a><span id="l12.5971" class="difflineminus">-      {</span>
<a href="#l12.5972"></a><span id="l12.5972" class="difflineplus">+      if (thread) {</span>
<a href="#l12.5973"></a><span id="l12.5973">         thread-&gt;GetThreadKey(&amp;threadId);</span>
<a href="#l12.5974"></a><span id="l12.5974">         newHdr-&gt;SetThreadId(threadId);</span>
<a href="#l12.5975"></a><span id="l12.5975" class="difflineminus">-        //TRACE(&quot;threading based on subject %s\n&quot;, (const char *) msgHdr-&gt;m_subject);</span>
<a href="#l12.5976"></a><span id="l12.5976" class="difflineplus">+        // TRACE(&quot;threading based on subject %s\n&quot;, (const char *)</span>
<a href="#l12.5977"></a><span id="l12.5977" class="difflineplus">+        // msgHdr-&gt;m_subject);</span>
<a href="#l12.5978"></a><span id="l12.5978">         // if we move this and do subject threading after, ref threading,</span>
<a href="#l12.5979"></a><span id="l12.5979" class="difflineminus">-        // don't thread within children, since we know it won't work. But for now, pass TRUE.</span>
<a href="#l12.5980"></a><span id="l12.5980" class="difflineplus">+        // don't thread within children, since we know it won't work. But for</span>
<a href="#l12.5981"></a><span id="l12.5981" class="difflineplus">+        // now, pass TRUE.</span>
<a href="#l12.5982"></a><span id="l12.5982">         result = AddToThread(newHdr, thread, nullptr, true);</span>
<a href="#l12.5983"></a><span id="l12.5983">       }</span>
<a href="#l12.5984"></a><span id="l12.5984">     }</span>
<a href="#l12.5985"></a><span id="l12.5985">   }</span>
<a href="#l12.5986"></a><span id="l12.5986"> </span>
<a href="#l12.5987"></a><span id="l12.5987" class="difflineminus">-  // Check if this is a new parent to an existing message (that has a reference to this message)</span>
<a href="#l12.5988"></a><span id="l12.5988" class="difflineminus">-  if (!thread &amp;&amp; UseCorrectThreading())</span>
<a href="#l12.5989"></a><span id="l12.5989" class="difflineminus">-  {</span>
<a href="#l12.5990"></a><span id="l12.5990" class="difflineplus">+  // Check if this is a new parent to an existing message (that has a reference</span>
<a href="#l12.5991"></a><span id="l12.5991" class="difflineplus">+  // to this message)</span>
<a href="#l12.5992"></a><span id="l12.5992" class="difflineplus">+  if (!thread &amp;&amp; UseCorrectThreading()) {</span>
<a href="#l12.5993"></a><span id="l12.5993">     nsCString msgId;</span>
<a href="#l12.5994"></a><span id="l12.5994">     newHdr-&gt;GetMessageId(getter_Copies(msgId));</span>
<a href="#l12.5995"></a><span id="l12.5995"> </span>
<a href="#l12.5996"></a><span id="l12.5996">     thread = dont_AddRef(GetThreadForMessageId(msgId));</span>
<a href="#l12.5997"></a><span id="l12.5997" class="difflineminus">-    if (thread)</span>
<a href="#l12.5998"></a><span id="l12.5998" class="difflineminus">-    {</span>
<a href="#l12.5999"></a><span id="l12.5999" class="difflineplus">+    if (thread) {</span>
<a href="#l12.6000"></a><span id="l12.6000">       thread-&gt;GetThreadKey(&amp;threadId);</span>
<a href="#l12.6001"></a><span id="l12.6001">       newHdr-&gt;SetThreadId(threadId);</span>
<a href="#l12.6002"></a><span id="l12.6002">       result = AddToThread(newHdr, thread, nullptr, true);</span>
<a href="#l12.6003"></a><span id="l12.6003">     }</span>
<a href="#l12.6004"></a><span id="l12.6004">   }</span>
<a href="#l12.6005"></a><span id="l12.6005"> </span>
<a href="#l12.6006"></a><span id="l12.6006" class="difflineminus">-  if (!thread)</span>
<a href="#l12.6007"></a><span id="l12.6007" class="difflineminus">-  {</span>
<a href="#l12.6008"></a><span id="l12.6008" class="difflineplus">+  if (!thread) {</span>
<a href="#l12.6009"></a><span id="l12.6009">     // Not a parent or child, make it a new thread for now</span>
<a href="#l12.6010"></a><span id="l12.6010">     result = AddNewThread(newHdr);</span>
<a href="#l12.6011"></a><span id="l12.6011">     newThread = true;</span>
<a href="#l12.6012"></a><span id="l12.6012" class="difflineminus">-  }</span>
<a href="#l12.6013"></a><span id="l12.6013" class="difflineminus">-  else</span>
<a href="#l12.6014"></a><span id="l12.6014" class="difflineminus">-  {</span>
<a href="#l12.6015"></a><span id="l12.6015" class="difflineplus">+  } else {</span>
<a href="#l12.6016"></a><span id="l12.6016">     newThread = false;</span>
<a href="#l12.6017"></a><span id="l12.6017">   }</span>
<a href="#l12.6018"></a><span id="l12.6018">   return result;</span>
<a href="#l12.6019"></a><span id="l12.6019"> }</span>
<a href="#l12.6020"></a><span id="l12.6020"> </span>
<a href="#l12.6021"></a><span id="l12.6021" class="difflineminus">-nsresult nsMsgDatabase::AddToThread(nsMsgHdr *newHdr, nsIMsgThread *thread, nsIMsgDBHdr *inReplyTo, bool threadInThread)</span>
<a href="#l12.6022"></a><span id="l12.6022" class="difflineminus">-{</span>
<a href="#l12.6023"></a><span id="l12.6023" class="difflineplus">+nsresult nsMsgDatabase::AddToThread(nsMsgHdr *newHdr, nsIMsgThread *thread,</span>
<a href="#l12.6024"></a><span id="l12.6024" class="difflineplus">+                                    nsIMsgDBHdr *inReplyTo,</span>
<a href="#l12.6025"></a><span id="l12.6025" class="difflineplus">+                                    bool threadInThread) {</span>
<a href="#l12.6026"></a><span id="l12.6026">   // don't worry about real threading yet.</span>
<a href="#l12.6027"></a><span id="l12.6027">   return thread-&gt;AddChild(newHdr, inReplyTo, threadInThread, this);</span>
<a href="#l12.6028"></a><span id="l12.6028"> }</span>
<a href="#l12.6029"></a><span id="l12.6029"> </span>
<a href="#l12.6030"></a><span id="l12.6030" class="difflineminus">-nsMsgHdr * nsMsgDatabase::GetMsgHdrForReference(nsCString &amp;reference)</span>
<a href="#l12.6031"></a><span id="l12.6031" class="difflineminus">-{</span>
<a href="#l12.6032"></a><span id="l12.6032" class="difflineplus">+nsMsgHdr *nsMsgDatabase::GetMsgHdrForReference(nsCString &amp;reference) {</span>
<a href="#l12.6033"></a><span id="l12.6033">   NS_ASSERTION(false, &quot;not implemented yet.&quot;);</span>
<a href="#l12.6034"></a><span id="l12.6034">   return nullptr;</span>
<a href="#l12.6035"></a><span id="l12.6035"> }</span>
<a href="#l12.6036"></a><span id="l12.6036"> </span>
<a href="#l12.6037"></a><span id="l12.6037" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetMsgHdrForMessageID(const char *aMsgID, nsIMsgDBHdr **aHdr)</span>
<a href="#l12.6038"></a><span id="l12.6038" class="difflineminus">-{</span>
<a href="#l12.6039"></a><span id="l12.6039" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetMsgHdrForMessageID(const char *aMsgID,</span>
<a href="#l12.6040"></a><span id="l12.6040" class="difflineplus">+                                                   nsIMsgDBHdr **aHdr) {</span>
<a href="#l12.6041"></a><span id="l12.6041">   NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l12.6042"></a><span id="l12.6042">   NS_ENSURE_ARG_POINTER(aMsgID);</span>
<a href="#l12.6043"></a><span id="l12.6043" class="difflineminus">-  nsIMsgDBHdr  *msgHdr = nullptr;</span>
<a href="#l12.6044"></a><span id="l12.6044" class="difflineplus">+  nsIMsgDBHdr *msgHdr = nullptr;</span>
<a href="#l12.6045"></a><span id="l12.6045">   nsresult rv = NS_OK;</span>
<a href="#l12.6046"></a><span id="l12.6046" class="difflineminus">-  mdbYarn  messageIdYarn;</span>
<a href="#l12.6047"></a><span id="l12.6047" class="difflineminus">-</span>
<a href="#l12.6048"></a><span id="l12.6048" class="difflineminus">-  messageIdYarn.mYarn_Buf = (void *) aMsgID;</span>
<a href="#l12.6049"></a><span id="l12.6049" class="difflineplus">+  mdbYarn messageIdYarn;</span>
<a href="#l12.6050"></a><span id="l12.6050" class="difflineplus">+</span>
<a href="#l12.6051"></a><span id="l12.6051" class="difflineplus">+  messageIdYarn.mYarn_Buf = (void *)aMsgID;</span>
<a href="#l12.6052"></a><span id="l12.6052">   messageIdYarn.mYarn_Fill = PL_strlen(aMsgID);</span>
<a href="#l12.6053"></a><span id="l12.6053">   messageIdYarn.mYarn_Form = 0;</span>
<a href="#l12.6054"></a><span id="l12.6054">   messageIdYarn.mYarn_Size = messageIdYarn.mYarn_Fill;</span>
<a href="#l12.6055"></a><span id="l12.6055"> </span>
<a href="#l12.6056"></a><span id="l12.6056">   nsIMdbRow *hdrRow;</span>
<a href="#l12.6057"></a><span id="l12.6057">   mdbOid outRowId;</span>
<a href="#l12.6058"></a><span id="l12.6058">   nsresult result;</span>
<a href="#l12.6059"></a><span id="l12.6059">   if (m_mdbStore)</span>
<a href="#l12.6060"></a><span id="l12.6060">     result = m_mdbStore-&gt;FindRow(GetEnv(), m_hdrRowScopeToken,</span>
<a href="#l12.6061"></a><span id="l12.6061" class="difflineminus">-      m_messageIdColumnToken, &amp;messageIdYarn,  &amp;outRowId,</span>
<a href="#l12.6062"></a><span id="l12.6062" class="difflineminus">-      &amp;hdrRow);</span>
<a href="#l12.6063"></a><span id="l12.6063" class="difflineplus">+                                 m_messageIdColumnToken, &amp;messageIdYarn,</span>
<a href="#l12.6064"></a><span id="l12.6064" class="difflineplus">+                                 &amp;outRowId, &amp;hdrRow);</span>
<a href="#l12.6065"></a><span id="l12.6065">   else</span>
<a href="#l12.6066"></a><span id="l12.6066">     return NS_ERROR_FAILURE;</span>
<a href="#l12.6067"></a><span id="l12.6067" class="difflineminus">-  if (NS_SUCCEEDED(result) &amp;&amp; hdrRow)</span>
<a href="#l12.6068"></a><span id="l12.6068" class="difflineminus">-  {</span>
<a href="#l12.6069"></a><span id="l12.6069" class="difflineminus">-    //Get key from row</span>
<a href="#l12.6070"></a><span id="l12.6070" class="difflineplus">+  if (NS_SUCCEEDED(result) &amp;&amp; hdrRow) {</span>
<a href="#l12.6071"></a><span id="l12.6071" class="difflineplus">+    // Get key from row</span>
<a href="#l12.6072"></a><span id="l12.6072">     mdbOid outOid;</span>
<a href="#l12.6073"></a><span id="l12.6073">     nsMsgKey key = nsMsgKey_None;</span>
<a href="#l12.6074"></a><span id="l12.6074">     rv = hdrRow-&gt;GetOid(GetEnv(), &amp;outOid);</span>
<a href="#l12.6075"></a><span id="l12.6075" class="difflineminus">-    if (NS_WARN_IF(NS_FAILED(rv)))</span>
<a href="#l12.6076"></a><span id="l12.6076" class="difflineminus">-      return rv;</span>
<a href="#l12.6077"></a><span id="l12.6077" class="difflineplus">+    if (NS_WARN_IF(NS_FAILED(rv))) return rv;</span>
<a href="#l12.6078"></a><span id="l12.6078">     key = outOid.mOid_Id;</span>
<a href="#l12.6079"></a><span id="l12.6079"> </span>
<a href="#l12.6080"></a><span id="l12.6080">     rv = GetHdrFromUseCache(key, &amp;msgHdr);</span>
<a href="#l12.6081"></a><span id="l12.6081">     if (NS_SUCCEEDED(rv) &amp;&amp; msgHdr)</span>
<a href="#l12.6082"></a><span id="l12.6082">       hdrRow-&gt;Release();</span>
<a href="#l12.6083"></a><span id="l12.6083">     else {</span>
<a href="#l12.6084"></a><span id="l12.6084">       rv = CreateMsgHdr(hdrRow, key, &amp;msgHdr);</span>
<a href="#l12.6085"></a><span id="l12.6085" class="difflineminus">-      if (NS_WARN_IF(NS_FAILED(rv)))</span>
<a href="#l12.6086"></a><span id="l12.6086" class="difflineminus">-        return rv;</span>
<a href="#l12.6087"></a><span id="l12.6087" class="difflineplus">+      if (NS_WARN_IF(NS_FAILED(rv))) return rv;</span>
<a href="#l12.6088"></a><span id="l12.6088">     }</span>
<a href="#l12.6089"></a><span id="l12.6089">   }</span>
<a href="#l12.6090"></a><span id="l12.6090" class="difflineminus">-  *aHdr = msgHdr; // already addreffed above.</span>
<a href="#l12.6091"></a><span id="l12.6091" class="difflineminus">-  return NS_OK; // it's not an error not to find a msg hdr.</span>
<a href="#l12.6092"></a><span id="l12.6092" class="difflineminus">-}</span>
<a href="#l12.6093"></a><span id="l12.6093" class="difflineminus">-</span>
<a href="#l12.6094"></a><span id="l12.6094" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetMsgHdrForGMMsgID(const char *aGMMsgId, nsIMsgDBHdr **aHdr)</span>
<a href="#l12.6095"></a><span id="l12.6095" class="difflineminus">-{</span>
<a href="#l12.6096"></a><span id="l12.6096" class="difflineplus">+  *aHdr = msgHdr;  // already addreffed above.</span>
<a href="#l12.6097"></a><span id="l12.6097" class="difflineplus">+  return NS_OK;    // it's not an error not to find a msg hdr.</span>
<a href="#l12.6098"></a><span id="l12.6098" class="difflineplus">+}</span>
<a href="#l12.6099"></a><span id="l12.6099" class="difflineplus">+</span>
<a href="#l12.6100"></a><span id="l12.6100" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetMsgHdrForGMMsgID(const char *aGMMsgId,</span>
<a href="#l12.6101"></a><span id="l12.6101" class="difflineplus">+                                                 nsIMsgDBHdr **aHdr) {</span>
<a href="#l12.6102"></a><span id="l12.6102">   NS_ENSURE_ARG_POINTER(aGMMsgId);</span>
<a href="#l12.6103"></a><span id="l12.6103">   NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l12.6104"></a><span id="l12.6104">   nsIMsgDBHdr *msgHdr = nullptr;</span>
<a href="#l12.6105"></a><span id="l12.6105">   nsresult rv = NS_OK;</span>
<a href="#l12.6106"></a><span id="l12.6106">   mdbYarn gMailMessageIdYarn;</span>
<a href="#l12.6107"></a><span id="l12.6107" class="difflineminus">-  gMailMessageIdYarn.mYarn_Buf = (void *) aGMMsgId;</span>
<a href="#l12.6108"></a><span id="l12.6108" class="difflineplus">+  gMailMessageIdYarn.mYarn_Buf = (void *)aGMMsgId;</span>
<a href="#l12.6109"></a><span id="l12.6109">   gMailMessageIdYarn.mYarn_Fill = strlen(aGMMsgId);</span>
<a href="#l12.6110"></a><span id="l12.6110">   gMailMessageIdYarn.mYarn_Form = 0;</span>
<a href="#l12.6111"></a><span id="l12.6111">   gMailMessageIdYarn.mYarn_Size = gMailMessageIdYarn.mYarn_Fill;</span>
<a href="#l12.6112"></a><span id="l12.6112"> </span>
<a href="#l12.6113"></a><span id="l12.6113">   nsIMdbRow *hdrRow;</span>
<a href="#l12.6114"></a><span id="l12.6114">   mdbOid outRowId;</span>
<a href="#l12.6115"></a><span id="l12.6115">   nsresult result;</span>
<a href="#l12.6116"></a><span id="l12.6116">   mdb_token property_token;</span>
<a href="#l12.6117"></a><span id="l12.6117">   NS_ENSURE_TRUE(m_mdbStore, NS_ERROR_NULL_POINTER);</span>
<a href="#l12.6118"></a><span id="l12.6118" class="difflineminus">-  result = m_mdbStore-&gt;StringToToken(GetEnv(), &quot;X-GM-MSGID&quot;,</span>
<a href="#l12.6119"></a><span id="l12.6119" class="difflineminus">-    &amp;property_token);</span>
<a href="#l12.6120"></a><span id="l12.6120" class="difflineplus">+  result = m_mdbStore-&gt;StringToToken(GetEnv(), &quot;X-GM-MSGID&quot;, &amp;property_token);</span>
<a href="#l12.6121"></a><span id="l12.6121">   NS_ENSURE_SUCCESS(result, result);</span>
<a href="#l12.6122"></a><span id="l12.6122" class="difflineminus">-  result = m_mdbStore-&gt;FindRow(GetEnv(), m_hdrRowScopeToken,</span>
<a href="#l12.6123"></a><span id="l12.6123" class="difflineminus">-    property_token, &amp;gMailMessageIdYarn, &amp;outRowId, &amp;hdrRow);</span>
<a href="#l12.6124"></a><span id="l12.6124" class="difflineminus">-  if (NS_SUCCEEDED(result) &amp;&amp; hdrRow)</span>
<a href="#l12.6125"></a><span id="l12.6125" class="difflineminus">-  {</span>
<a href="#l12.6126"></a><span id="l12.6126" class="difflineplus">+  result = m_mdbStore-&gt;FindRow(GetEnv(), m_hdrRowScopeToken, property_token,</span>
<a href="#l12.6127"></a><span id="l12.6127" class="difflineplus">+                               &amp;gMailMessageIdYarn, &amp;outRowId, &amp;hdrRow);</span>
<a href="#l12.6128"></a><span id="l12.6128" class="difflineplus">+  if (NS_SUCCEEDED(result) &amp;&amp; hdrRow) {</span>
<a href="#l12.6129"></a><span id="l12.6129">     // Get key from row</span>
<a href="#l12.6130"></a><span id="l12.6130">     mdbOid outOid;</span>
<a href="#l12.6131"></a><span id="l12.6131">     rv = hdrRow-&gt;GetOid(GetEnv(), &amp;outOid);</span>
<a href="#l12.6132"></a><span id="l12.6132">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.6133"></a><span id="l12.6133">     nsMsgKey key = outOid.mOid_Id;</span>
<a href="#l12.6134"></a><span id="l12.6134">     rv = GetHdrFromUseCache(key, &amp;msgHdr);</span>
<a href="#l12.6135"></a><span id="l12.6135">     if ((NS_SUCCEEDED(rv) &amp;&amp; msgHdr))</span>
<a href="#l12.6136"></a><span id="l12.6136">       hdrRow-&gt;Release();</span>
<a href="#l12.6137"></a><span id="l12.6137">     else {</span>
<a href="#l12.6138"></a><span id="l12.6138">       rv = CreateMsgHdr(hdrRow, key, &amp;msgHdr);</span>
<a href="#l12.6139"></a><span id="l12.6139" class="difflineminus">-      if (NS_WARN_IF(NS_FAILED(rv)))</span>
<a href="#l12.6140"></a><span id="l12.6140" class="difflineminus">-        return rv;</span>
<a href="#l12.6141"></a><span id="l12.6141" class="difflineplus">+      if (NS_WARN_IF(NS_FAILED(rv))) return rv;</span>
<a href="#l12.6142"></a><span id="l12.6142">     }</span>
<a href="#l12.6143"></a><span id="l12.6143">   }</span>
<a href="#l12.6144"></a><span id="l12.6144">   *aHdr = msgHdr;</span>
<a href="#l12.6145"></a><span id="l12.6145" class="difflineminus">-  return NS_OK; // it's not an error not to find a msg hdr.</span>
<a href="#l12.6146"></a><span id="l12.6146" class="difflineminus">-}</span>
<a href="#l12.6147"></a><span id="l12.6147" class="difflineminus">-</span>
<a href="#l12.6148"></a><span id="l12.6148" class="difflineminus">-nsIMsgDBHdr *nsMsgDatabase::GetMsgHdrForSubject(nsCString &amp;subject)</span>
<a href="#l12.6149"></a><span id="l12.6149" class="difflineminus">-{</span>
<a href="#l12.6150"></a><span id="l12.6150" class="difflineplus">+  return NS_OK;  // it's not an error not to find a msg hdr.</span>
<a href="#l12.6151"></a><span id="l12.6151" class="difflineplus">+}</span>
<a href="#l12.6152"></a><span id="l12.6152" class="difflineplus">+</span>
<a href="#l12.6153"></a><span id="l12.6153" class="difflineplus">+nsIMsgDBHdr *nsMsgDatabase::GetMsgHdrForSubject(nsCString &amp;subject) {</span>
<a href="#l12.6154"></a><span id="l12.6154">   nsIMsgDBHdr *msgHdr = nullptr;</span>
<a href="#l12.6155"></a><span id="l12.6155">   nsresult rv = NS_OK;</span>
<a href="#l12.6156"></a><span id="l12.6156">   mdbYarn subjectYarn;</span>
<a href="#l12.6157"></a><span id="l12.6157"> </span>
<a href="#l12.6158"></a><span id="l12.6158" class="difflineminus">-  subjectYarn.mYarn_Buf = (void*)subject.get();</span>
<a href="#l12.6159"></a><span id="l12.6159" class="difflineplus">+  subjectYarn.mYarn_Buf = (void *)subject.get();</span>
<a href="#l12.6160"></a><span id="l12.6160">   subjectYarn.mYarn_Fill = PL_strlen(subject.get());</span>
<a href="#l12.6161"></a><span id="l12.6161">   subjectYarn.mYarn_Form = 0;</span>
<a href="#l12.6162"></a><span id="l12.6162">   subjectYarn.mYarn_Size = subjectYarn.mYarn_Fill;</span>
<a href="#l12.6163"></a><span id="l12.6163"> </span>
<a href="#l12.6164"></a><span id="l12.6164">   nsIMdbRow *hdrRow;</span>
<a href="#l12.6165"></a><span id="l12.6165">   mdbOid outRowId;</span>
<a href="#l12.6166"></a><span id="l12.6166" class="difflineminus">-  nsresult result = GetStore()-&gt;FindRow(GetEnv(), m_hdrRowScopeToken,</span>
<a href="#l12.6167"></a><span id="l12.6167" class="difflineminus">-    m_subjectColumnToken, &amp;subjectYarn,  &amp;outRowId,</span>
<a href="#l12.6168"></a><span id="l12.6168" class="difflineminus">-    &amp;hdrRow);</span>
<a href="#l12.6169"></a><span id="l12.6169" class="difflineminus">-  if (NS_SUCCEEDED(result) &amp;&amp; hdrRow)</span>
<a href="#l12.6170"></a><span id="l12.6170" class="difflineminus">-  {</span>
<a href="#l12.6171"></a><span id="l12.6171" class="difflineminus">-    //Get key from row</span>
<a href="#l12.6172"></a><span id="l12.6172" class="difflineplus">+  nsresult result =</span>
<a href="#l12.6173"></a><span id="l12.6173" class="difflineplus">+      GetStore()-&gt;FindRow(GetEnv(), m_hdrRowScopeToken, m_subjectColumnToken,</span>
<a href="#l12.6174"></a><span id="l12.6174" class="difflineplus">+                          &amp;subjectYarn, &amp;outRowId, &amp;hdrRow);</span>
<a href="#l12.6175"></a><span id="l12.6175" class="difflineplus">+  if (NS_SUCCEEDED(result) &amp;&amp; hdrRow) {</span>
<a href="#l12.6176"></a><span id="l12.6176" class="difflineplus">+    // Get key from row</span>
<a href="#l12.6177"></a><span id="l12.6177">     mdbOid outOid;</span>
<a href="#l12.6178"></a><span id="l12.6178">     nsMsgKey key = nsMsgKey_None;</span>
<a href="#l12.6179"></a><span id="l12.6179">     rv = hdrRow-&gt;GetOid(GetEnv(), &amp;outOid);</span>
<a href="#l12.6180"></a><span id="l12.6180" class="difflineminus">-    if (NS_WARN_IF(NS_FAILED(rv)))</span>
<a href="#l12.6181"></a><span id="l12.6181" class="difflineminus">-      return nullptr;</span>
<a href="#l12.6182"></a><span id="l12.6182" class="difflineplus">+    if (NS_WARN_IF(NS_FAILED(rv))) return nullptr;</span>
<a href="#l12.6183"></a><span id="l12.6183">     key = outOid.mOid_Id;</span>
<a href="#l12.6184"></a><span id="l12.6184"> </span>
<a href="#l12.6185"></a><span id="l12.6185">     rv = GetHdrFromUseCache(key, &amp;msgHdr);</span>
<a href="#l12.6186"></a><span id="l12.6186">     if (NS_SUCCEEDED(rv) &amp;&amp; msgHdr)</span>
<a href="#l12.6187"></a><span id="l12.6187">       hdrRow-&gt;Release();</span>
<a href="#l12.6188"></a><span id="l12.6188">     else {</span>
<a href="#l12.6189"></a><span id="l12.6189">       rv = CreateMsgHdr(hdrRow, key, &amp;msgHdr);</span>
<a href="#l12.6190"></a><span id="l12.6190" class="difflineminus">-      if (NS_WARN_IF(NS_FAILED(rv)))</span>
<a href="#l12.6191"></a><span id="l12.6191" class="difflineminus">-        return nullptr;</span>
<a href="#l12.6192"></a><span id="l12.6192" class="difflineplus">+      if (NS_WARN_IF(NS_FAILED(rv))) return nullptr;</span>
<a href="#l12.6193"></a><span id="l12.6193">     }</span>
<a href="#l12.6194"></a><span id="l12.6194">   }</span>
<a href="#l12.6195"></a><span id="l12.6195">   return msgHdr;</span>
<a href="#l12.6196"></a><span id="l12.6196"> }</span>
<a href="#l12.6197"></a><span id="l12.6197"> </span>
<a href="#l12.6198"></a><span id="l12.6198" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetThreadContainingMsgHdr(nsIMsgDBHdr *msgHdr, nsIMsgThread **result)</span>
<a href="#l12.6199"></a><span id="l12.6199" class="difflineminus">-{</span>
<a href="#l12.6200"></a><span id="l12.6200" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetThreadContainingMsgHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l12.6201"></a><span id="l12.6201" class="difflineplus">+                                                       nsIMsgThread **result) {</span>
<a href="#l12.6202"></a><span id="l12.6202">   NS_ENSURE_ARG_POINTER(msgHdr);</span>
<a href="#l12.6203"></a><span id="l12.6203">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l12.6204"></a><span id="l12.6204"> </span>
<a href="#l12.6205"></a><span id="l12.6205">   *result = nullptr;</span>
<a href="#l12.6206"></a><span id="l12.6206">   nsMsgKey threadId = nsMsgKey_None;</span>
<a href="#l12.6207"></a><span id="l12.6207">   (void)msgHdr-&gt;GetThreadId(&amp;threadId);</span>
<a href="#l12.6208"></a><span id="l12.6208" class="difflineminus">-  if (threadId != nsMsgKey_None)</span>
<a href="#l12.6209"></a><span id="l12.6209" class="difflineminus">-    *result = GetThreadForThreadId(threadId);</span>
<a href="#l12.6210"></a><span id="l12.6210" class="difflineplus">+  if (threadId != nsMsgKey_None) *result = GetThreadForThreadId(threadId);</span>
<a href="#l12.6211"></a><span id="l12.6211"> </span>
<a href="#l12.6212"></a><span id="l12.6212">   // if we can't find the thread, try using the msg key as the thread id,</span>
<a href="#l12.6213"></a><span id="l12.6213">   // because the msg hdr might not have the thread id set correctly</span>
<a href="#l12.6214"></a><span id="l12.6214">   // Or maybe the message was deleted?</span>
<a href="#l12.6215"></a><span id="l12.6215" class="difflineminus">-  if (!*result)</span>
<a href="#l12.6216"></a><span id="l12.6216" class="difflineminus">-  {</span>
<a href="#l12.6217"></a><span id="l12.6217" class="difflineplus">+  if (!*result) {</span>
<a href="#l12.6218"></a><span id="l12.6218">     nsMsgKey msgKey;</span>
<a href="#l12.6219"></a><span id="l12.6219">     msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l12.6220"></a><span id="l12.6220">     *result = GetThreadForThreadId(msgKey);</span>
<a href="#l12.6221"></a><span id="l12.6221">   }</span>
<a href="#l12.6222"></a><span id="l12.6222">   // failure is normal when message was deleted</span>
<a href="#l12.6223"></a><span id="l12.6223">   return (*result) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l12.6224"></a><span id="l12.6224"> }</span>
<a href="#l12.6225"></a><span id="l12.6225"> </span>
<a href="#l12.6226"></a><span id="l12.6226" class="difflineminus">-</span>
<a href="#l12.6227"></a><span id="l12.6227" class="difflineminus">-nsresult nsMsgDatabase::GetThreadForMsgKey(nsMsgKey msgKey, nsIMsgThread **aResult)</span>
<a href="#l12.6228"></a><span id="l12.6228" class="difflineminus">-{</span>
<a href="#l12.6229"></a><span id="l12.6229" class="difflineplus">+nsresult nsMsgDatabase::GetThreadForMsgKey(nsMsgKey msgKey,</span>
<a href="#l12.6230"></a><span id="l12.6230" class="difflineplus">+                                           nsIMsgThread **aResult) {</span>
<a href="#l12.6231"></a><span id="l12.6231">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l12.6232"></a><span id="l12.6232"> </span>
<a href="#l12.6233"></a><span id="l12.6233" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msg;</span>
<a href="#l12.6234"></a><span id="l12.6234" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msg;</span>
<a href="#l12.6235"></a><span id="l12.6235">   nsresult rv = GetMsgHdrForKey(msgKey, getter_AddRefs(msg));</span>
<a href="#l12.6236"></a><span id="l12.6236"> </span>
<a href="#l12.6237"></a><span id="l12.6237" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; msg)</span>
<a href="#l12.6238"></a><span id="l12.6238" class="difflineminus">-    rv = GetThreadContainingMsgHdr(msg, aResult);</span>
<a href="#l12.6239"></a><span id="l12.6239" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; msg) rv = GetThreadContainingMsgHdr(msg, aResult);</span>
<a href="#l12.6240"></a><span id="l12.6240"> </span>
<a href="#l12.6241"></a><span id="l12.6241">   return rv;</span>
<a href="#l12.6242"></a><span id="l12.6242"> }</span>
<a href="#l12.6243"></a><span id="l12.6243"> </span>
<a href="#l12.6244"></a><span id="l12.6244"> // caller needs to unrefer.</span>
<a href="#l12.6245"></a><span id="l12.6245" class="difflineminus">-nsIMsgThread *  nsMsgDatabase::GetThreadForThreadId(nsMsgKey threadId)</span>
<a href="#l12.6246"></a><span id="l12.6246" class="difflineminus">-{</span>
<a href="#l12.6247"></a><span id="l12.6247" class="difflineminus">-</span>
<a href="#l12.6248"></a><span id="l12.6248" class="difflineminus">-  nsIMsgThread *retThread = (threadId == m_cachedThreadId &amp;&amp; m_cachedThread) ?</span>
<a href="#l12.6249"></a><span id="l12.6249" class="difflineminus">-    m_cachedThread.get() : FindExistingThread(threadId);</span>
<a href="#l12.6250"></a><span id="l12.6250" class="difflineminus">-  if (retThread)</span>
<a href="#l12.6251"></a><span id="l12.6251" class="difflineminus">-  {</span>
<a href="#l12.6252"></a><span id="l12.6252" class="difflineplus">+nsIMsgThread *nsMsgDatabase::GetThreadForThreadId(nsMsgKey threadId) {</span>
<a href="#l12.6253"></a><span id="l12.6253" class="difflineplus">+  nsIMsgThread *retThread = (threadId == m_cachedThreadId &amp;&amp; m_cachedThread)</span>
<a href="#l12.6254"></a><span id="l12.6254" class="difflineplus">+                                ? m_cachedThread.get()</span>
<a href="#l12.6255"></a><span id="l12.6255" class="difflineplus">+                                : FindExistingThread(threadId);</span>
<a href="#l12.6256"></a><span id="l12.6256" class="difflineplus">+  if (retThread) {</span>
<a href="#l12.6257"></a><span id="l12.6257">     NS_ADDREF(retThread);</span>
<a href="#l12.6258"></a><span id="l12.6258">     return retThread;</span>
<a href="#l12.6259"></a><span id="l12.6259">   }</span>
<a href="#l12.6260"></a><span id="l12.6260" class="difflineminus">-  if (m_mdbStore)</span>
<a href="#l12.6261"></a><span id="l12.6261" class="difflineminus">-  {</span>
<a href="#l12.6262"></a><span id="l12.6262" class="difflineplus">+  if (m_mdbStore) {</span>
<a href="#l12.6263"></a><span id="l12.6263">     mdbOid tableId;</span>
<a href="#l12.6264"></a><span id="l12.6264">     tableId.mOid_Id = threadId;</span>
<a href="#l12.6265"></a><span id="l12.6265">     tableId.mOid_Scope = m_hdrRowScopeToken;</span>
<a href="#l12.6266"></a><span id="l12.6266"> </span>
<a href="#l12.6267"></a><span id="l12.6267">     nsCOMPtr&lt;nsIMdbTable&gt; threadTable;</span>
<a href="#l12.6268"></a><span id="l12.6268" class="difflineminus">-    nsresult res = m_mdbStore-&gt;GetTable(GetEnv(), &amp;tableId,</span>
<a href="#l12.6269"></a><span id="l12.6269" class="difflineminus">-                                        getter_AddRefs(threadTable));</span>
<a href="#l12.6270"></a><span id="l12.6270" class="difflineminus">-</span>
<a href="#l12.6271"></a><span id="l12.6271" class="difflineminus">-    if (NS_SUCCEEDED(res) &amp;&amp; threadTable)</span>
<a href="#l12.6272"></a><span id="l12.6272" class="difflineminus">-    {</span>
<a href="#l12.6273"></a><span id="l12.6273" class="difflineplus">+    nsresult res =</span>
<a href="#l12.6274"></a><span id="l12.6274" class="difflineplus">+        m_mdbStore-&gt;GetTable(GetEnv(), &amp;tableId, getter_AddRefs(threadTable));</span>
<a href="#l12.6275"></a><span id="l12.6275" class="difflineplus">+</span>
<a href="#l12.6276"></a><span id="l12.6276" class="difflineplus">+    if (NS_SUCCEEDED(res) &amp;&amp; threadTable) {</span>
<a href="#l12.6277"></a><span id="l12.6277">       retThread = new nsMsgThread(this, threadTable);</span>
<a href="#l12.6278"></a><span id="l12.6278" class="difflineminus">-      if (retThread)</span>
<a href="#l12.6279"></a><span id="l12.6279" class="difflineminus">-      {</span>
<a href="#l12.6280"></a><span id="l12.6280" class="difflineplus">+      if (retThread) {</span>
<a href="#l12.6281"></a><span id="l12.6281">         NS_ADDREF(retThread);</span>
<a href="#l12.6282"></a><span id="l12.6282">         m_cachedThread = retThread;</span>
<a href="#l12.6283"></a><span id="l12.6283">         m_cachedThreadId = threadId;</span>
<a href="#l12.6284"></a><span id="l12.6284">       }</span>
<a href="#l12.6285"></a><span id="l12.6285">     }</span>
<a href="#l12.6286"></a><span id="l12.6286">   }</span>
<a href="#l12.6287"></a><span id="l12.6287">   return retThread;</span>
<a href="#l12.6288"></a><span id="l12.6288"> }</span>
<a href="#l12.6289"></a><span id="l12.6289"> </span>
<a href="#l12.6290"></a><span id="l12.6290"> // make the passed in header a thread header</span>
<a href="#l12.6291"></a><span id="l12.6291" class="difflineminus">-nsresult nsMsgDatabase::AddNewThread(nsMsgHdr *msgHdr)</span>
<a href="#l12.6292"></a><span id="l12.6292" class="difflineminus">-{</span>
<a href="#l12.6293"></a><span id="l12.6293" class="difflineminus">-</span>
<a href="#l12.6294"></a><span id="l12.6294" class="difflineminus">-  if (!msgHdr)</span>
<a href="#l12.6295"></a><span id="l12.6295" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.6296"></a><span id="l12.6296" class="difflineplus">+nsresult nsMsgDatabase::AddNewThread(nsMsgHdr *msgHdr) {</span>
<a href="#l12.6297"></a><span id="l12.6297" class="difflineplus">+  if (!msgHdr) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.6298"></a><span id="l12.6298"> </span>
<a href="#l12.6299"></a><span id="l12.6299">   nsMsgThread *threadHdr = nullptr;</span>
<a href="#l12.6300"></a><span id="l12.6300"> </span>
<a href="#l12.6301"></a><span id="l12.6301">   nsCString subject;</span>
<a href="#l12.6302"></a><span id="l12.6302">   nsMsgKey threadKey;</span>
<a href="#l12.6303"></a><span id="l12.6303">   msgHdr-&gt;GetMessageKey(&amp;threadKey);</span>
<a href="#l12.6304"></a><span id="l12.6304" class="difflineminus">-  // can't have a thread with key 1 since that's the table id of the all msg hdr table,</span>
<a href="#l12.6305"></a><span id="l12.6305" class="difflineminus">-  // so give it kTableKeyForThreadOne (0xfffffffe).</span>
<a href="#l12.6306"></a><span id="l12.6306" class="difflineminus">-  if (threadKey == kAllMsgHdrsTableKey)</span>
<a href="#l12.6307"></a><span id="l12.6307" class="difflineminus">-    threadKey = kTableKeyForThreadOne;</span>
<a href="#l12.6308"></a><span id="l12.6308" class="difflineplus">+  // can't have a thread with key 1 since that's the table id of the all msg hdr</span>
<a href="#l12.6309"></a><span id="l12.6309" class="difflineplus">+  // table, so give it kTableKeyForThreadOne (0xfffffffe).</span>
<a href="#l12.6310"></a><span id="l12.6310" class="difflineplus">+  if (threadKey == kAllMsgHdrsTableKey) threadKey = kTableKeyForThreadOne;</span>
<a href="#l12.6311"></a><span id="l12.6311"> </span>
<a href="#l12.6312"></a><span id="l12.6312">   nsresult err = msgHdr-&gt;GetSubject(getter_Copies(subject));</span>
<a href="#l12.6313"></a><span id="l12.6313"> </span>
<a href="#l12.6314"></a><span id="l12.6314">   err = CreateNewThread(threadKey, subject.get(), &amp;threadHdr);</span>
<a href="#l12.6315"></a><span id="l12.6315">   msgHdr-&gt;SetThreadId(threadKey);</span>
<a href="#l12.6316"></a><span id="l12.6316" class="difflineminus">-  if (threadHdr)</span>
<a href="#l12.6317"></a><span id="l12.6317" class="difflineminus">-  {</span>
<a href="#l12.6318"></a><span id="l12.6318" class="difflineplus">+  if (threadHdr) {</span>
<a href="#l12.6319"></a><span id="l12.6319">     NS_ADDREF(threadHdr);</span>
<a href="#l12.6320"></a><span id="l12.6320">     // err = msgHdr-&gt;GetSubject(subject);</span>
<a href="#l12.6321"></a><span id="l12.6321">     // threadHdr-&gt;SetThreadKey(msgHdr-&gt;m_messageKey);</span>
<a href="#l12.6322"></a><span id="l12.6322">     // threadHdr-&gt;SetSubject(subject.get());</span>
<a href="#l12.6323"></a><span id="l12.6323">     // need to add the thread table to the db.</span>
<a href="#l12.6324"></a><span id="l12.6324">     AddToThread(msgHdr, threadHdr, nullptr, false);</span>
<a href="#l12.6325"></a><span id="l12.6325">     NS_RELEASE(threadHdr);</span>
<a href="#l12.6326"></a><span id="l12.6326">   }</span>
<a href="#l12.6327"></a><span id="l12.6327">   return err;</span>
<a href="#l12.6328"></a><span id="l12.6328"> }</span>
<a href="#l12.6329"></a><span id="l12.6329"> </span>
<a href="#l12.6330"></a><span id="l12.6330" class="difflineminus">-nsresult nsMsgDatabase::GetBoolPref(const char *prefName, bool *result)</span>
<a href="#l12.6331"></a><span id="l12.6331" class="difflineminus">-{</span>
<a href="#l12.6332"></a><span id="l12.6332" class="difflineplus">+nsresult nsMsgDatabase::GetBoolPref(const char *prefName, bool *result) {</span>
<a href="#l12.6333"></a><span id="l12.6333">   bool prefValue = false;</span>
<a href="#l12.6334"></a><span id="l12.6334">   nsresult rv;</span>
<a href="#l12.6335"></a><span id="l12.6335" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l12.6336"></a><span id="l12.6336" class="difflineminus">-  if (pPrefBranch)</span>
<a href="#l12.6337"></a><span id="l12.6337" class="difflineminus">-  {</span>
<a href="#l12.6338"></a><span id="l12.6338" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(</span>
<a href="#l12.6339"></a><span id="l12.6339" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l12.6340"></a><span id="l12.6340" class="difflineplus">+  if (pPrefBranch) {</span>
<a href="#l12.6341"></a><span id="l12.6341">     rv = pPrefBranch-&gt;GetBoolPref(prefName, &amp;prefValue);</span>
<a href="#l12.6342"></a><span id="l12.6342">     *result = prefValue;</span>
<a href="#l12.6343"></a><span id="l12.6343">   }</span>
<a href="#l12.6344"></a><span id="l12.6344">   return rv;</span>
<a href="#l12.6345"></a><span id="l12.6345"> }</span>
<a href="#l12.6346"></a><span id="l12.6346"> </span>
<a href="#l12.6347"></a><span id="l12.6347" class="difflineminus">-nsresult nsMsgDatabase::GetIntPref(const char *prefName, int32_t *result)</span>
<a href="#l12.6348"></a><span id="l12.6348" class="difflineminus">-{</span>
<a href="#l12.6349"></a><span id="l12.6349" class="difflineplus">+nsresult nsMsgDatabase::GetIntPref(const char *prefName, int32_t *result) {</span>
<a href="#l12.6350"></a><span id="l12.6350">   int32_t prefValue = 0;</span>
<a href="#l12.6351"></a><span id="l12.6351">   nsresult rv;</span>
<a href="#l12.6352"></a><span id="l12.6352" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l12.6353"></a><span id="l12.6353" class="difflineminus">-  if (pPrefBranch)</span>
<a href="#l12.6354"></a><span id="l12.6354" class="difflineminus">-  {</span>
<a href="#l12.6355"></a><span id="l12.6355" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(</span>
<a href="#l12.6356"></a><span id="l12.6356" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l12.6357"></a><span id="l12.6357" class="difflineplus">+  if (pPrefBranch) {</span>
<a href="#l12.6358"></a><span id="l12.6358">     rv = pPrefBranch-&gt;GetIntPref(prefName, &amp;prefValue);</span>
<a href="#l12.6359"></a><span id="l12.6359">     *result = prefValue;</span>
<a href="#l12.6360"></a><span id="l12.6360">   }</span>
<a href="#l12.6361"></a><span id="l12.6361">   return rv;</span>
<a href="#l12.6362"></a><span id="l12.6362"> }</span>
<a href="#l12.6363"></a><span id="l12.6363"> </span>
<a href="#l12.6364"></a><span id="l12.6364" class="difflineminus">-</span>
<a href="#l12.6365"></a><span id="l12.6365" class="difflineminus">-nsresult nsMsgDatabase::ListAllThreads(nsTArray&lt;nsMsgKey&gt; *threadIds)</span>
<a href="#l12.6366"></a><span id="l12.6366" class="difflineminus">-{</span>
<a href="#l12.6367"></a><span id="l12.6367" class="difflineplus">+nsresult nsMsgDatabase::ListAllThreads(nsTArray&lt;nsMsgKey&gt; *threadIds) {</span>
<a href="#l12.6368"></a><span id="l12.6368">   nsresult rv;</span>
<a href="#l12.6369"></a><span id="l12.6369">   nsMsgThread *pThread;</span>
<a href="#l12.6370"></a><span id="l12.6370"> </span>
<a href="#l12.6371"></a><span id="l12.6371" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; threads;</span>
<a href="#l12.6372"></a><span id="l12.6372" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; threads;</span>
<a href="#l12.6373"></a><span id="l12.6373">   rv = EnumerateThreads(getter_AddRefs(threads));</span>
<a href="#l12.6374"></a><span id="l12.6374">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.6375"></a><span id="l12.6375">   bool hasMore = false;</span>
<a href="#l12.6376"></a><span id="l12.6376"> </span>
<a href="#l12.6377"></a><span id="l12.6377" class="difflineminus">-  while (NS_SUCCEEDED(rv = threads-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l12.6378"></a><span id="l12.6378" class="difflineminus">-  {</span>
<a href="#l12.6379"></a><span id="l12.6379" class="difflineminus">-    rv = threads-&gt;GetNext((nsISupports**)&amp;pThread);</span>
<a href="#l12.6380"></a><span id="l12.6380" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.6381"></a><span id="l12.6381" class="difflineplus">+  while (NS_SUCCEEDED(rv = threads-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l12.6382"></a><span id="l12.6382" class="difflineplus">+    rv = threads-&gt;GetNext((nsISupports **)&amp;pThread);</span>
<a href="#l12.6383"></a><span id="l12.6383" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.6384"></a><span id="l12.6384"> </span>
<a href="#l12.6385"></a><span id="l12.6385">     if (threadIds) {</span>
<a href="#l12.6386"></a><span id="l12.6386">       nsMsgKey key;</span>
<a href="#l12.6387"></a><span id="l12.6387">       (void)pThread-&gt;GetThreadKey(&amp;key);</span>
<a href="#l12.6388"></a><span id="l12.6388">       threadIds-&gt;AppendElement(key);</span>
<a href="#l12.6389"></a><span id="l12.6389">     }</span>
<a href="#l12.6390"></a><span id="l12.6390">     // NS_RELEASE(pThread);</span>
<a href="#l12.6391"></a><span id="l12.6391">     pThread = nullptr;</span>
<a href="#l12.6392"></a><span id="l12.6392">   }</span>
<a href="#l12.6393"></a><span id="l12.6393">   return rv;</span>
<a href="#l12.6394"></a><span id="l12.6394"> }</span>
<a href="#l12.6395"></a><span id="l12.6395"> </span>
<a href="#l12.6396"></a><span id="l12.6396" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::SetAttributeOnPendingHdr(nsIMsgDBHdr *pendingHdr, const char *property,</span>
<a href="#l12.6397"></a><span id="l12.6397" class="difflineminus">-                                  const char *propertyVal)</span>
<a href="#l12.6398"></a><span id="l12.6398" class="difflineminus">-{</span>
<a href="#l12.6399"></a><span id="l12.6399" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::SetAttributeOnPendingHdr(nsIMsgDBHdr *pendingHdr,</span>
<a href="#l12.6400"></a><span id="l12.6400" class="difflineplus">+                                                      const char *property,</span>
<a href="#l12.6401"></a><span id="l12.6401" class="difflineplus">+                                                      const char *propertyVal) {</span>
<a href="#l12.6402"></a><span id="l12.6402">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.6403"></a><span id="l12.6403"> }</span>
<a href="#l12.6404"></a><span id="l12.6404"> </span>
<a href="#l12.6405"></a><span id="l12.6405" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::SetUint32AttributeOnPendingHdr(nsIMsgDBHdr *pendingHdr, const char *property,</span>
<a href="#l12.6406"></a><span id="l12.6406" class="difflineminus">-                                  uint32_t propertyVal)</span>
<a href="#l12.6407"></a><span id="l12.6407" class="difflineminus">-{</span>
<a href="#l12.6408"></a><span id="l12.6408" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::SetUint32AttributeOnPendingHdr(</span>
<a href="#l12.6409"></a><span id="l12.6409" class="difflineplus">+    nsIMsgDBHdr *pendingHdr, const char *property, uint32_t propertyVal) {</span>
<a href="#l12.6410"></a><span id="l12.6410">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.6411"></a><span id="l12.6411"> }</span>
<a href="#l12.6412"></a><span id="l12.6412"> </span>
<a href="#l12.6413"></a><span id="l12.6413"> NS_IMETHODIMP</span>
<a href="#l12.6414"></a><span id="l12.6414"> nsMsgDatabase::SetUint64AttributeOnPendingHdr(nsIMsgDBHdr *aPendingHdr,</span>
<a href="#l12.6415"></a><span id="l12.6415">                                               const char *aProperty,</span>
<a href="#l12.6416"></a><span id="l12.6416" class="difflineminus">-                                              uint64_t aPropertyVal)</span>
<a href="#l12.6417"></a><span id="l12.6417" class="difflineminus">-{</span>
<a href="#l12.6418"></a><span id="l12.6418" class="difflineplus">+                                              uint64_t aPropertyVal) {</span>
<a href="#l12.6419"></a><span id="l12.6419">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.6420"></a><span id="l12.6420"> }</span>
<a href="#l12.6421"></a><span id="l12.6421"> </span>
<a href="#l12.6422"></a><span id="l12.6422"> NS_IMETHODIMP</span>
<a href="#l12.6423"></a><span id="l12.6423" class="difflineminus">-nsMsgDatabase::UpdatePendingAttributes(nsIMsgDBHdr *aNewHdr)</span>
<a href="#l12.6424"></a><span id="l12.6424" class="difflineminus">-{</span>
<a href="#l12.6425"></a><span id="l12.6425" class="difflineminus">-  return NS_OK;</span>
<a href="#l12.6426"></a><span id="l12.6426" class="difflineminus">-}</span>
<a href="#l12.6427"></a><span id="l12.6427" class="difflineminus">-</span>
<a href="#l12.6428"></a><span id="l12.6428" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetOfflineOpForKey(nsMsgKey msgKey, bool create, nsIMsgOfflineImapOperation **offlineOp)</span>
<a href="#l12.6429"></a><span id="l12.6429" class="difflineminus">-{</span>
<a href="#l12.6430"></a><span id="l12.6430" class="difflineplus">+nsMsgDatabase::UpdatePendingAttributes(nsIMsgDBHdr *aNewHdr) { return NS_OK; }</span>
<a href="#l12.6431"></a><span id="l12.6431" class="difflineplus">+</span>
<a href="#l12.6432"></a><span id="l12.6432" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetOfflineOpForKey(</span>
<a href="#l12.6433"></a><span id="l12.6433" class="difflineplus">+    nsMsgKey msgKey, bool create, nsIMsgOfflineImapOperation **offlineOp) {</span>
<a href="#l12.6434"></a><span id="l12.6434">   NS_ASSERTION(false, &quot;overridden by nsMailDatabase&quot;);</span>
<a href="#l12.6435"></a><span id="l12.6435">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.6436"></a><span id="l12.6436"> }</span>
<a href="#l12.6437"></a><span id="l12.6437"> </span>
<a href="#l12.6438"></a><span id="l12.6438" class="difflineminus">-NS_IMETHODIMP  nsMsgDatabase::RemoveOfflineOp(nsIMsgOfflineImapOperation *op)</span>
<a href="#l12.6439"></a><span id="l12.6439" class="difflineminus">-{</span>
<a href="#l12.6440"></a><span id="l12.6440" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::RemoveOfflineOp(nsIMsgOfflineImapOperation *op) {</span>
<a href="#l12.6441"></a><span id="l12.6441">   NS_ASSERTION(false, &quot;overridden by nsMailDatabase&quot;);</span>
<a href="#l12.6442"></a><span id="l12.6442">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.6443"></a><span id="l12.6443"> }</span>
<a href="#l12.6444"></a><span id="l12.6444"> </span>
<a href="#l12.6445"></a><span id="l12.6445" class="difflineminus">-</span>
<a href="#l12.6446"></a><span id="l12.6446" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::ListAllOfflineMsgs(nsIMsgKeyArray *aKeys)</span>
<a href="#l12.6447"></a><span id="l12.6447" class="difflineminus">-{</span>
<a href="#l12.6448"></a><span id="l12.6448" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::ListAllOfflineMsgs(nsIMsgKeyArray *aKeys) {</span>
<a href="#l12.6449"></a><span id="l12.6449">   NS_ENSURE_ARG_POINTER(aKeys);</span>
<a href="#l12.6450"></a><span id="l12.6450" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l12.6451"></a><span id="l12.6451" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l12.6452"></a><span id="l12.6452">   uint32_t flag = nsMsgMessageFlags::Offline;</span>
<a href="#l12.6453"></a><span id="l12.6453">   // if we change this routine to return an enumerator that generates the keys</span>
<a href="#l12.6454"></a><span id="l12.6454">   // one by one, we'll need to somehow make a copy of flag for the enumerator</span>
<a href="#l12.6455"></a><span id="l12.6455" class="difflineminus">-  // to own, since the enumerator will persist past the life of flag on the stack.</span>
<a href="#l12.6456"></a><span id="l12.6456" class="difflineplus">+  // to own, since the enumerator will persist past the life of flag on the</span>
<a href="#l12.6457"></a><span id="l12.6457" class="difflineplus">+  // stack.</span>
<a href="#l12.6458"></a><span id="l12.6458">   nsresult rv = EnumerateMessagesWithFlag(getter_AddRefs(enumerator), &amp;flag);</span>
<a href="#l12.6459"></a><span id="l12.6459" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; enumerator)</span>
<a href="#l12.6460"></a><span id="l12.6460" class="difflineminus">-  {</span>
<a href="#l12.6461"></a><span id="l12.6461" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; enumerator) {</span>
<a href="#l12.6462"></a><span id="l12.6462">     bool hasMoreElements;</span>
<a href="#l12.6463"></a><span id="l12.6463" class="difflineminus">-    while(NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMoreElements)) &amp;&amp; hasMoreElements)</span>
<a href="#l12.6464"></a><span id="l12.6464" class="difflineminus">-    {</span>
<a href="#l12.6465"></a><span id="l12.6465" class="difflineplus">+    while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMoreElements)) &amp;&amp;</span>
<a href="#l12.6466"></a><span id="l12.6466" class="difflineplus">+           hasMoreElements) {</span>
<a href="#l12.6467"></a><span id="l12.6467">       nsCOMPtr&lt;nsISupports&gt; childSupports;</span>
<a href="#l12.6468"></a><span id="l12.6468">       rv = enumerator-&gt;GetNext(getter_AddRefs(childSupports));</span>
<a href="#l12.6469"></a><span id="l12.6469" class="difflineminus">-      if(NS_FAILED(rv))</span>
<a href="#l12.6470"></a><span id="l12.6470" class="difflineminus">-        return rv;</span>
<a href="#l12.6471"></a><span id="l12.6471" class="difflineminus">-</span>
<a href="#l12.6472"></a><span id="l12.6472" class="difflineminus">-      // clear out db hdr, because it won't be valid when we get rid of the .msf file</span>
<a href="#l12.6473"></a><span id="l12.6473" class="difflineplus">+      if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.6474"></a><span id="l12.6474" class="difflineplus">+</span>
<a href="#l12.6475"></a><span id="l12.6475" class="difflineplus">+      // clear out db hdr, because it won't be valid when we get rid of the .msf</span>
<a href="#l12.6476"></a><span id="l12.6476" class="difflineplus">+      // file</span>
<a href="#l12.6477"></a><span id="l12.6477">       nsCOMPtr&lt;nsIMsgDBHdr&gt; dbMessage(do_QueryInterface(childSupports, &amp;rv));</span>
<a href="#l12.6478"></a><span id="l12.6478" class="difflineminus">-      if(NS_SUCCEEDED(rv) &amp;&amp; dbMessage)</span>
<a href="#l12.6479"></a><span id="l12.6479" class="difflineminus">-      {</span>
<a href="#l12.6480"></a><span id="l12.6480" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; dbMessage) {</span>
<a href="#l12.6481"></a><span id="l12.6481">         nsMsgKey msgKey;</span>
<a href="#l12.6482"></a><span id="l12.6482">         dbMessage-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l12.6483"></a><span id="l12.6483">         aKeys-&gt;AppendElement(msgKey);</span>
<a href="#l12.6484"></a><span id="l12.6484">       }</span>
<a href="#l12.6485"></a><span id="l12.6485">     }</span>
<a href="#l12.6486"></a><span id="l12.6486">   }</span>
<a href="#l12.6487"></a><span id="l12.6487">   return rv;</span>
<a href="#l12.6488"></a><span id="l12.6488"> }</span>
<a href="#l12.6489"></a><span id="l12.6489"> </span>
<a href="#l12.6490"></a><span id="l12.6490" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::EnumerateOfflineOps(nsISimpleEnumerator **enumerator)</span>
<a href="#l12.6491"></a><span id="l12.6491" class="difflineminus">-{</span>
<a href="#l12.6492"></a><span id="l12.6492" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::EnumerateOfflineOps(</span>
<a href="#l12.6493"></a><span id="l12.6493" class="difflineplus">+    nsISimpleEnumerator **enumerator) {</span>
<a href="#l12.6494"></a><span id="l12.6494">   NS_ASSERTION(false, &quot;overridden by nsMailDatabase&quot;);</span>
<a href="#l12.6495"></a><span id="l12.6495">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.6496"></a><span id="l12.6496"> }</span>
<a href="#l12.6497"></a><span id="l12.6497"> </span>
<a href="#l12.6498"></a><span id="l12.6498" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::ListAllOfflineOpIds(nsTArray&lt;nsMsgKey&gt; *offlineOpIds)</span>
<a href="#l12.6499"></a><span id="l12.6499" class="difflineminus">-{</span>
<a href="#l12.6500"></a><span id="l12.6500" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::ListAllOfflineOpIds(</span>
<a href="#l12.6501"></a><span id="l12.6501" class="difflineplus">+    nsTArray&lt;nsMsgKey&gt; *offlineOpIds) {</span>
<a href="#l12.6502"></a><span id="l12.6502">   NS_ASSERTION(false, &quot;overridden by nsMailDatabase&quot;);</span>
<a href="#l12.6503"></a><span id="l12.6503">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.6504"></a><span id="l12.6504"> }</span>
<a href="#l12.6505"></a><span id="l12.6505"> </span>
<a href="#l12.6506"></a><span id="l12.6506" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::ListAllOfflineDeletes(nsTArray&lt;nsMsgKey&gt; *offlineDeletes)</span>
<a href="#l12.6507"></a><span id="l12.6507" class="difflineminus">-{</span>
<a href="#l12.6508"></a><span id="l12.6508" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::ListAllOfflineDeletes(</span>
<a href="#l12.6509"></a><span id="l12.6509" class="difflineplus">+    nsTArray&lt;nsMsgKey&gt; *offlineDeletes) {</span>
<a href="#l12.6510"></a><span id="l12.6510">   nsresult ret = NS_OK;</span>
<a href="#l12.6511"></a><span id="l12.6511" class="difflineminus">-  if (!offlineDeletes)</span>
<a href="#l12.6512"></a><span id="l12.6512" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.6513"></a><span id="l12.6513" class="difflineplus">+  if (!offlineDeletes) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.6514"></a><span id="l12.6514"> </span>
<a href="#l12.6515"></a><span id="l12.6515">   // technically, notimplemented, but no one's putting offline ops in anyway.</span>
<a href="#l12.6516"></a><span id="l12.6516">   return ret;</span>
<a href="#l12.6517"></a><span id="l12.6517"> }</span>
<a href="#l12.6518"></a><span id="l12.6518" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetHighWaterArticleNum(nsMsgKey *key)</span>
<a href="#l12.6519"></a><span id="l12.6519" class="difflineminus">-{</span>
<a href="#l12.6520"></a><span id="l12.6520" class="difflineminus">-  if (!m_dbFolderInfo)</span>
<a href="#l12.6521"></a><span id="l12.6521" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.6522"></a><span id="l12.6522" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetHighWaterArticleNum(nsMsgKey *key) {</span>
<a href="#l12.6523"></a><span id="l12.6523" class="difflineplus">+  if (!m_dbFolderInfo) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.6524"></a><span id="l12.6524">   return m_dbFolderInfo-&gt;GetHighWater(key);</span>
<a href="#l12.6525"></a><span id="l12.6525"> }</span>
<a href="#l12.6526"></a><span id="l12.6526"> </span>
<a href="#l12.6527"></a><span id="l12.6527" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetLowWaterArticleNum(nsMsgKey *key)</span>
<a href="#l12.6528"></a><span id="l12.6528" class="difflineminus">-{</span>
<a href="#l12.6529"></a><span id="l12.6529" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.6530"></a><span id="l12.6530" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetLowWaterArticleNum(nsMsgKey *key) {</span>
<a href="#l12.6531"></a><span id="l12.6531" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.6532"></a><span id="l12.6532"> }</span>
<a href="#l12.6533"></a><span id="l12.6533"> </span>
<a href="#l12.6534"></a><span id="l12.6534"> /* attribute nsMsgKey NextPseudoMsgKey */</span>
<a href="#l12.6535"></a><span id="l12.6535"> </span>
<a href="#l12.6536"></a><span id="l12.6536" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetNextPseudoMsgKey(nsMsgKey *nextPseudoMsgKey)</span>
<a href="#l12.6537"></a><span id="l12.6537" class="difflineminus">-{</span>
<a href="#l12.6538"></a><span id="l12.6538" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetNextPseudoMsgKey(nsMsgKey *nextPseudoMsgKey) {</span>
<a href="#l12.6539"></a><span id="l12.6539">   NS_ENSURE_ARG_POINTER(nextPseudoMsgKey);</span>
<a href="#l12.6540"></a><span id="l12.6540">   *nextPseudoMsgKey = m_nextPseudoMsgKey--;</span>
<a href="#l12.6541"></a><span id="l12.6541">   return NS_OK;</span>
<a href="#l12.6542"></a><span id="l12.6542"> }</span>
<a href="#l12.6543"></a><span id="l12.6543"> </span>
<a href="#l12.6544"></a><span id="l12.6544" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::SetNextPseudoMsgKey(nsMsgKey nextPseudoMsgKey)</span>
<a href="#l12.6545"></a><span id="l12.6545" class="difflineminus">-{</span>
<a href="#l12.6546"></a><span id="l12.6546" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::SetNextPseudoMsgKey(nsMsgKey nextPseudoMsgKey) {</span>
<a href="#l12.6547"></a><span id="l12.6547">   m_nextPseudoMsgKey = nextPseudoMsgKey;</span>
<a href="#l12.6548"></a><span id="l12.6548">   return NS_OK;</span>
<a href="#l12.6549"></a><span id="l12.6549"> }</span>
<a href="#l12.6550"></a><span id="l12.6550"> </span>
<a href="#l12.6551"></a><span id="l12.6551" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetNextFakeOfflineMsgKey(nsMsgKey *nextFakeOfflineMsgKey)</span>
<a href="#l12.6552"></a><span id="l12.6552" class="difflineminus">-{</span>
<a href="#l12.6553"></a><span id="l12.6553" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetNextFakeOfflineMsgKey(</span>
<a href="#l12.6554"></a><span id="l12.6554" class="difflineplus">+    nsMsgKey *nextFakeOfflineMsgKey) {</span>
<a href="#l12.6555"></a><span id="l12.6555">   NS_ENSURE_ARG_POINTER(nextFakeOfflineMsgKey);</span>
<a href="#l12.6556"></a><span id="l12.6556">   // iterate over hdrs looking for first non-existant fake offline msg key</span>
<a href="#l12.6557"></a><span id="l12.6557">   nsMsgKey fakeMsgKey = kIdStartOfFake;</span>
<a href="#l12.6558"></a><span id="l12.6558"> </span>
<a href="#l12.6559"></a><span id="l12.6559">   bool containsKey;</span>
<a href="#l12.6560"></a><span id="l12.6560" class="difflineminus">-  do</span>
<a href="#l12.6561"></a><span id="l12.6561" class="difflineminus">-  {</span>
<a href="#l12.6562"></a><span id="l12.6562" class="difflineminus">-     ContainsKey(fakeMsgKey, &amp;containsKey);</span>
<a href="#l12.6563"></a><span id="l12.6563" class="difflineminus">-     if (!containsKey)</span>
<a href="#l12.6564"></a><span id="l12.6564" class="difflineminus">-       break;</span>
<a href="#l12.6565"></a><span id="l12.6565" class="difflineminus">-     fakeMsgKey--;</span>
<a href="#l12.6566"></a><span id="l12.6566" class="difflineminus">-  }</span>
<a href="#l12.6567"></a><span id="l12.6567" class="difflineminus">-  while (containsKey);</span>
<a href="#l12.6568"></a><span id="l12.6568" class="difflineplus">+  do {</span>
<a href="#l12.6569"></a><span id="l12.6569" class="difflineplus">+    ContainsKey(fakeMsgKey, &amp;containsKey);</span>
<a href="#l12.6570"></a><span id="l12.6570" class="difflineplus">+    if (!containsKey) break;</span>
<a href="#l12.6571"></a><span id="l12.6571" class="difflineplus">+    fakeMsgKey--;</span>
<a href="#l12.6572"></a><span id="l12.6572" class="difflineplus">+  } while (containsKey);</span>
<a href="#l12.6573"></a><span id="l12.6573"> </span>
<a href="#l12.6574"></a><span id="l12.6574">   *nextFakeOfflineMsgKey = fakeMsgKey;</span>
<a href="#l12.6575"></a><span id="l12.6575">   return NS_OK;</span>
<a href="#l12.6576"></a><span id="l12.6576"> }</span>
<a href="#l12.6577"></a><span id="l12.6577"> </span>
<a href="#l12.6578"></a><span id="l12.6578"> #ifdef DEBUG</span>
<a href="#l12.6579"></a><span id="l12.6579" class="difflineminus">-nsresult nsMsgDatabase::DumpContents()</span>
<a href="#l12.6580"></a><span id="l12.6580" class="difflineminus">-{</span>
<a href="#l12.6581"></a><span id="l12.6581" class="difflineplus">+nsresult nsMsgDatabase::DumpContents() {</span>
<a href="#l12.6582"></a><span id="l12.6582">   nsMsgKey key;</span>
<a href="#l12.6583"></a><span id="l12.6583">   uint32_t i;</span>
<a href="#l12.6584"></a><span id="l12.6584"> </span>
<a href="#l12.6585"></a><span id="l12.6585">   RefPtr&lt;nsMsgKeyArray&gt; keys = new nsMsgKeyArray;</span>
<a href="#l12.6586"></a><span id="l12.6586" class="difflineminus">-  if (!keys)</span>
<a href="#l12.6587"></a><span id="l12.6587" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.6588"></a><span id="l12.6588" class="difflineplus">+  if (!keys) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.6589"></a><span id="l12.6589">   nsresult rv = ListAllKeys(keys);</span>
<a href="#l12.6590"></a><span id="l12.6590">   uint32_t numKeys;</span>
<a href="#l12.6591"></a><span id="l12.6591">   keys-&gt;GetLength(&amp;numKeys);</span>
<a href="#l12.6592"></a><span id="l12.6592">   for (i = 0; i &lt; numKeys; i++) {</span>
<a href="#l12.6593"></a><span id="l12.6593">     key = keys-&gt;m_keys[i];</span>
<a href="#l12.6594"></a><span id="l12.6594">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.6595"></a><span id="l12.6595">     rv = GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l12.6596"></a><span id="l12.6596" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l12.6597"></a><span id="l12.6597" class="difflineminus">-    {</span>
<a href="#l12.6598"></a><span id="l12.6598" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.6599"></a><span id="l12.6599">       nsCString author;</span>
<a href="#l12.6600"></a><span id="l12.6600">       nsCString subject;</span>
<a href="#l12.6601"></a><span id="l12.6601"> </span>
<a href="#l12.6602"></a><span id="l12.6602">       msgHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.6603"></a><span id="l12.6603">       msgHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l12.6604"></a><span id="l12.6604">       msgHdr-&gt;GetSubject(getter_Copies(subject));</span>
<a href="#l12.6605"></a><span id="l12.6605" class="difflineminus">-      printf(&quot;hdr key = %u, author = %s subject = %s\n&quot;, key, author.get(), subject.get());</span>
<a href="#l12.6606"></a><span id="l12.6606" class="difflineplus">+      printf(&quot;hdr key = %u, author = %s subject = %s\n&quot;, key, author.get(),</span>
<a href="#l12.6607"></a><span id="l12.6607" class="difflineplus">+             subject.get());</span>
<a href="#l12.6608"></a><span id="l12.6608">     }</span>
<a href="#l12.6609"></a><span id="l12.6609">   }</span>
<a href="#l12.6610"></a><span id="l12.6610">   nsTArray&lt;nsMsgKey&gt; threads;</span>
<a href="#l12.6611"></a><span id="l12.6611">   rv = ListAllThreads(&amp;threads);</span>
<a href="#l12.6612"></a><span id="l12.6612" class="difflineminus">-  for ( i = 0; i &lt; threads.Length(); i++)</span>
<a href="#l12.6613"></a><span id="l12.6613" class="difflineminus">-  {</span>
<a href="#l12.6614"></a><span id="l12.6614" class="difflineplus">+  for (i = 0; i &lt; threads.Length(); i++) {</span>
<a href="#l12.6615"></a><span id="l12.6615">     key = threads[i];</span>
<a href="#l12.6616"></a><span id="l12.6616">     printf(&quot;thread key = %u\n&quot;, key);</span>
<a href="#l12.6617"></a><span id="l12.6617">     // DumpThread(key);</span>
<a href="#l12.6618"></a><span id="l12.6618">   }</span>
<a href="#l12.6619"></a><span id="l12.6619">   return NS_OK;</span>
<a href="#l12.6620"></a><span id="l12.6620"> }</span>
<a href="#l12.6621"></a><span id="l12.6621"> </span>
<a href="#l12.6622"></a><span id="l12.6622" class="difflineminus">-nsresult nsMsgDatabase::DumpMsgChildren(nsIMsgDBHdr *msgHdr)</span>
<a href="#l12.6623"></a><span id="l12.6623" class="difflineminus">-{</span>
<a href="#l12.6624"></a><span id="l12.6624" class="difflineminus">-  return NS_OK;</span>
<a href="#l12.6625"></a><span id="l12.6625" class="difflineminus">-}</span>
<a href="#l12.6626"></a><span id="l12.6626" class="difflineminus">-</span>
<a href="#l12.6627"></a><span id="l12.6627" class="difflineminus">-nsresult nsMsgDatabase::DumpThread(nsMsgKey threadId)</span>
<a href="#l12.6628"></a><span id="l12.6628" class="difflineminus">-{</span>
<a href="#l12.6629"></a><span id="l12.6629" class="difflineplus">+nsresult nsMsgDatabase::DumpMsgChildren(nsIMsgDBHdr *msgHdr) { return NS_OK; }</span>
<a href="#l12.6630"></a><span id="l12.6630" class="difflineplus">+</span>
<a href="#l12.6631"></a><span id="l12.6631" class="difflineplus">+nsresult nsMsgDatabase::DumpThread(nsMsgKey threadId) {</span>
<a href="#l12.6632"></a><span id="l12.6632">   nsresult rv = NS_OK;</span>
<a href="#l12.6633"></a><span id="l12.6633">   nsIMsgThread *thread = nullptr;</span>
<a href="#l12.6634"></a><span id="l12.6634"> </span>
<a href="#l12.6635"></a><span id="l12.6635">   thread = GetThreadForThreadId(threadId);</span>
<a href="#l12.6636"></a><span id="l12.6636" class="difflineminus">-  if (thread)</span>
<a href="#l12.6637"></a><span id="l12.6637" class="difflineminus">-  {</span>
<a href="#l12.6638"></a><span id="l12.6638" class="difflineplus">+  if (thread) {</span>
<a href="#l12.6639"></a><span id="l12.6639">     nsISimpleEnumerator *enumerator = nullptr;</span>
<a href="#l12.6640"></a><span id="l12.6640"> </span>
<a href="#l12.6641"></a><span id="l12.6641">     rv = thread-&gt;EnumerateMessages(nsMsgKey_None, &amp;enumerator);</span>
<a href="#l12.6642"></a><span id="l12.6642" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; enumerator)</span>
<a href="#l12.6643"></a><span id="l12.6643" class="difflineminus">-    {</span>
<a href="#l12.6644"></a><span id="l12.6644" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; enumerator) {</span>
<a href="#l12.6645"></a><span id="l12.6645">       bool hasMore = false;</span>
<a href="#l12.6646"></a><span id="l12.6646"> </span>
<a href="#l12.6647"></a><span id="l12.6647">       while (NS_SUCCEEDED(rv = enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l12.6648"></a><span id="l12.6648" class="difflineminus">-             hasMore)</span>
<a href="#l12.6649"></a><span id="l12.6649" class="difflineminus">-      {</span>
<a href="#l12.6650"></a><span id="l12.6650" class="difflineminus">-        nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l12.6651"></a><span id="l12.6651" class="difflineplus">+             hasMore) {</span>
<a href="#l12.6652"></a><span id="l12.6652" class="difflineplus">+        nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l12.6653"></a><span id="l12.6653">         rv = enumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l12.6654"></a><span id="l12.6654">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;nsMsgDBEnumerator broken&quot;);</span>
<a href="#l12.6655"></a><span id="l12.6655" class="difflineminus">-        nsCOMPtr &lt;nsIMsgDBHdr&gt; pMessage = do_QueryInterface(supports);</span>
<a href="#l12.6656"></a><span id="l12.6656" class="difflineminus">-        if (NS_FAILED(rv) || !pMessage)</span>
<a href="#l12.6657"></a><span id="l12.6657" class="difflineminus">-          break;</span>
<a href="#l12.6658"></a><span id="l12.6658" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDBHdr&gt; pMessage = do_QueryInterface(supports);</span>
<a href="#l12.6659"></a><span id="l12.6659" class="difflineplus">+        if (NS_FAILED(rv) || !pMessage) break;</span>
<a href="#l12.6660"></a><span id="l12.6660">       }</span>
<a href="#l12.6661"></a><span id="l12.6661">       NS_RELEASE(enumerator);</span>
<a href="#l12.6662"></a><span id="l12.6662" class="difflineminus">-</span>
<a href="#l12.6663"></a><span id="l12.6663">     }</span>
<a href="#l12.6664"></a><span id="l12.6664">   }</span>
<a href="#l12.6665"></a><span id="l12.6665">   return rv;</span>
<a href="#l12.6666"></a><span id="l12.6666"> }</span>
<a href="#l12.6667"></a><span id="l12.6667"> #endif /* DEBUG */</span>
<a href="#l12.6668"></a><span id="l12.6668"> </span>
<a href="#l12.6669"></a><span id="l12.6669" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::SetMsgRetentionSettings(nsIMsgRetentionSettings *retentionSettings)</span>
<a href="#l12.6670"></a><span id="l12.6670" class="difflineminus">-{</span>
<a href="#l12.6671"></a><span id="l12.6671" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::SetMsgRetentionSettings(</span>
<a href="#l12.6672"></a><span id="l12.6672" class="difflineplus">+    nsIMsgRetentionSettings *retentionSettings) {</span>
<a href="#l12.6673"></a><span id="l12.6673">   m_retentionSettings = retentionSettings;</span>
<a href="#l12.6674"></a><span id="l12.6674" class="difflineminus">-  if (retentionSettings &amp;&amp; m_dbFolderInfo)</span>
<a href="#l12.6675"></a><span id="l12.6675" class="difflineminus">-  {</span>
<a href="#l12.6676"></a><span id="l12.6676" class="difflineplus">+  if (retentionSettings &amp;&amp; m_dbFolderInfo) {</span>
<a href="#l12.6677"></a><span id="l12.6677">     nsresult rv;</span>
<a href="#l12.6678"></a><span id="l12.6678"> </span>
<a href="#l12.6679"></a><span id="l12.6679">     nsMsgRetainByPreference retainByPreference;</span>
<a href="#l12.6680"></a><span id="l12.6680">     uint32_t daysToKeepHdrs;</span>
<a href="#l12.6681"></a><span id="l12.6681">     uint32_t numHeadersToKeep;</span>
<a href="#l12.6682"></a><span id="l12.6682">     uint32_t daysToKeepBodies;</span>
<a href="#l12.6683"></a><span id="l12.6683">     bool cleanupBodiesByDays;</span>
<a href="#l12.6684"></a><span id="l12.6684">     bool useServerDefaults;</span>
<a href="#l12.6685"></a><span id="l12.6685" class="difflineat">@@ -5080,767 +4603,730 @@ NS_IMETHODIMP nsMsgDatabase::SetMsgReten</span>
<a href="#l12.6686"></a><span id="l12.6686">     rv = retentionSettings-&gt;GetRetainByPreference(&amp;retainByPreference);</span>
<a href="#l12.6687"></a><span id="l12.6687">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.6688"></a><span id="l12.6688">     rv = retentionSettings-&gt;GetDaysToKeepHdrs(&amp;daysToKeepHdrs);</span>
<a href="#l12.6689"></a><span id="l12.6689">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.6690"></a><span id="l12.6690">     rv = retentionSettings-&gt;GetNumHeadersToKeep(&amp;numHeadersToKeep);</span>
<a href="#l12.6691"></a><span id="l12.6691">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.6692"></a><span id="l12.6692">     rv = retentionSettings-&gt;GetDaysToKeepBodies(&amp;daysToKeepBodies);</span>
<a href="#l12.6693"></a><span id="l12.6693">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.6694"></a><span id="l12.6694" class="difflineminus">-    (void) retentionSettings-&gt;GetCleanupBodiesByDays(&amp;cleanupBodiesByDays);</span>
<a href="#l12.6695"></a><span id="l12.6695" class="difflineminus">-    (void) retentionSettings-&gt;GetUseServerDefaults(&amp;useServerDefaults);</span>
<a href="#l12.6696"></a><span id="l12.6696" class="difflineplus">+    (void)retentionSettings-&gt;GetCleanupBodiesByDays(&amp;cleanupBodiesByDays);</span>
<a href="#l12.6697"></a><span id="l12.6697" class="difflineplus">+    (void)retentionSettings-&gt;GetUseServerDefaults(&amp;useServerDefaults);</span>
<a href="#l12.6698"></a><span id="l12.6698">     rv = retentionSettings-&gt;GetApplyToFlaggedMessages(&amp;applyToFlaggedMessages);</span>
<a href="#l12.6699"></a><span id="l12.6699">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.6700"></a><span id="l12.6700" class="difflineminus">-    // need to write this to the db. We'll just use the dbfolderinfo to write properties.</span>
<a href="#l12.6701"></a><span id="l12.6701" class="difflineplus">+    // need to write this to the db. We'll just use the dbfolderinfo to write</span>
<a href="#l12.6702"></a><span id="l12.6702" class="difflineplus">+    // properties.</span>
<a href="#l12.6703"></a><span id="l12.6703">     m_dbFolderInfo-&gt;SetUint32Property(&quot;retainBy&quot;, retainByPreference);</span>
<a href="#l12.6704"></a><span id="l12.6704">     m_dbFolderInfo-&gt;SetUint32Property(&quot;daysToKeepHdrs&quot;, daysToKeepHdrs);</span>
<a href="#l12.6705"></a><span id="l12.6705">     m_dbFolderInfo-&gt;SetUint32Property(&quot;numHdrsToKeep&quot;, numHeadersToKeep);</span>
<a href="#l12.6706"></a><span id="l12.6706">     m_dbFolderInfo-&gt;SetUint32Property(&quot;daysToKeepBodies&quot;, daysToKeepBodies);</span>
<a href="#l12.6707"></a><span id="l12.6707">     m_dbFolderInfo-&gt;SetBooleanProperty(&quot;cleanupBodies&quot;, cleanupBodiesByDays);</span>
<a href="#l12.6708"></a><span id="l12.6708">     m_dbFolderInfo-&gt;SetBooleanProperty(&quot;useServerDefaults&quot;, useServerDefaults);</span>
<a href="#l12.6709"></a><span id="l12.6709" class="difflineminus">-    m_dbFolderInfo-&gt;SetBooleanProperty(&quot;applyToFlaggedMessages&quot;, applyToFlaggedMessages);</span>
<a href="#l12.6710"></a><span id="l12.6710" class="difflineplus">+    m_dbFolderInfo-&gt;SetBooleanProperty(&quot;applyToFlaggedMessages&quot;,</span>
<a href="#l12.6711"></a><span id="l12.6711" class="difflineplus">+                                       applyToFlaggedMessages);</span>
<a href="#l12.6712"></a><span id="l12.6712">   }</span>
<a href="#l12.6713"></a><span id="l12.6713">   Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l12.6714"></a><span id="l12.6714">   return NS_OK;</span>
<a href="#l12.6715"></a><span id="l12.6715"> }</span>
<a href="#l12.6716"></a><span id="l12.6716"> </span>
<a href="#l12.6717"></a><span id="l12.6717" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetMsgRetentionSettings(nsIMsgRetentionSettings **retentionSettings)</span>
<a href="#l12.6718"></a><span id="l12.6718" class="difflineminus">-{</span>
<a href="#l12.6719"></a><span id="l12.6719" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetMsgRetentionSettings(</span>
<a href="#l12.6720"></a><span id="l12.6720" class="difflineplus">+    nsIMsgRetentionSettings **retentionSettings) {</span>
<a href="#l12.6721"></a><span id="l12.6721">   NS_ENSURE_ARG_POINTER(retentionSettings);</span>
<a href="#l12.6722"></a><span id="l12.6722" class="difflineminus">-  if (!m_retentionSettings)</span>
<a href="#l12.6723"></a><span id="l12.6723" class="difflineminus">-  {</span>
<a href="#l12.6724"></a><span id="l12.6724" class="difflineplus">+  if (!m_retentionSettings) {</span>
<a href="#l12.6725"></a><span id="l12.6725">     // create a new one, and initialize it from the db.</span>
<a href="#l12.6726"></a><span id="l12.6726">     m_retentionSettings = new nsMsgRetentionSettings;</span>
<a href="#l12.6727"></a><span id="l12.6727" class="difflineminus">-    if (m_retentionSettings &amp;&amp; m_dbFolderInfo)</span>
<a href="#l12.6728"></a><span id="l12.6728" class="difflineminus">-    {</span>
<a href="#l12.6729"></a><span id="l12.6729" class="difflineplus">+    if (m_retentionSettings &amp;&amp; m_dbFolderInfo) {</span>
<a href="#l12.6730"></a><span id="l12.6730">       nsMsgRetainByPreference retainByPreference;</span>
<a href="#l12.6731"></a><span id="l12.6731">       uint32_t daysToKeepHdrs = 0;</span>
<a href="#l12.6732"></a><span id="l12.6732">       uint32_t numHeadersToKeep = 0;</span>
<a href="#l12.6733"></a><span id="l12.6733">       bool useServerDefaults;</span>
<a href="#l12.6734"></a><span id="l12.6734">       uint32_t daysToKeepBodies = 0;</span>
<a href="#l12.6735"></a><span id="l12.6735">       bool cleanupBodiesByDays = false;</span>
<a href="#l12.6736"></a><span id="l12.6736">       bool applyToFlaggedMessages;</span>
<a href="#l12.6737"></a><span id="l12.6737"> </span>
<a href="#l12.6738"></a><span id="l12.6738" class="difflineminus">-      m_dbFolderInfo-&gt;GetUint32Property(&quot;retainBy&quot;, nsIMsgRetentionSettings::nsMsgRetainAll, &amp;retainByPreference);</span>
<a href="#l12.6739"></a><span id="l12.6739" class="difflineplus">+      m_dbFolderInfo-&gt;GetUint32Property(&quot;retainBy&quot;,</span>
<a href="#l12.6740"></a><span id="l12.6740" class="difflineplus">+                                        nsIMsgRetentionSettings::nsMsgRetainAll,</span>
<a href="#l12.6741"></a><span id="l12.6741" class="difflineplus">+                                        &amp;retainByPreference);</span>
<a href="#l12.6742"></a><span id="l12.6742">       m_dbFolderInfo-&gt;GetUint32Property(&quot;daysToKeepHdrs&quot;, 0, &amp;daysToKeepHdrs);</span>
<a href="#l12.6743"></a><span id="l12.6743">       m_dbFolderInfo-&gt;GetUint32Property(&quot;numHdrsToKeep&quot;, 0, &amp;numHeadersToKeep);</span>
<a href="#l12.6744"></a><span id="l12.6744" class="difflineminus">-      m_dbFolderInfo-&gt;GetUint32Property(&quot;daysToKeepBodies&quot;, 0, &amp;daysToKeepBodies);</span>
<a href="#l12.6745"></a><span id="l12.6745" class="difflineminus">-      m_dbFolderInfo-&gt;GetBooleanProperty(&quot;useServerDefaults&quot;, true, &amp;useServerDefaults);</span>
<a href="#l12.6746"></a><span id="l12.6746" class="difflineminus">-      m_dbFolderInfo-&gt;GetBooleanProperty(&quot;cleanupBodies&quot;, false, &amp;cleanupBodiesByDays);</span>
<a href="#l12.6747"></a><span id="l12.6747" class="difflineplus">+      m_dbFolderInfo-&gt;GetUint32Property(&quot;daysToKeepBodies&quot;, 0,</span>
<a href="#l12.6748"></a><span id="l12.6748" class="difflineplus">+                                        &amp;daysToKeepBodies);</span>
<a href="#l12.6749"></a><span id="l12.6749" class="difflineplus">+      m_dbFolderInfo-&gt;GetBooleanProperty(&quot;useServerDefaults&quot;, true,</span>
<a href="#l12.6750"></a><span id="l12.6750" class="difflineplus">+                                         &amp;useServerDefaults);</span>
<a href="#l12.6751"></a><span id="l12.6751" class="difflineplus">+      m_dbFolderInfo-&gt;GetBooleanProperty(&quot;cleanupBodies&quot;, false,</span>
<a href="#l12.6752"></a><span id="l12.6752" class="difflineplus">+                                         &amp;cleanupBodiesByDays);</span>
<a href="#l12.6753"></a><span id="l12.6753">       m_dbFolderInfo-&gt;GetBooleanProperty(&quot;applyToFlaggedMessages&quot;, false,</span>
<a href="#l12.6754"></a><span id="l12.6754">                                          &amp;applyToFlaggedMessages);</span>
<a href="#l12.6755"></a><span id="l12.6755">       m_retentionSettings-&gt;SetRetainByPreference(retainByPreference);</span>
<a href="#l12.6756"></a><span id="l12.6756">       m_retentionSettings-&gt;SetDaysToKeepHdrs(daysToKeepHdrs);</span>
<a href="#l12.6757"></a><span id="l12.6757">       m_retentionSettings-&gt;SetNumHeadersToKeep(numHeadersToKeep);</span>
<a href="#l12.6758"></a><span id="l12.6758">       m_retentionSettings-&gt;SetDaysToKeepBodies(daysToKeepBodies);</span>
<a href="#l12.6759"></a><span id="l12.6759">       m_retentionSettings-&gt;SetUseServerDefaults(useServerDefaults);</span>
<a href="#l12.6760"></a><span id="l12.6760">       m_retentionSettings-&gt;SetCleanupBodiesByDays(cleanupBodiesByDays);</span>
<a href="#l12.6761"></a><span id="l12.6761">       m_retentionSettings-&gt;SetApplyToFlaggedMessages(applyToFlaggedMessages);</span>
<a href="#l12.6762"></a><span id="l12.6762">     }</span>
<a href="#l12.6763"></a><span id="l12.6763">   }</span>
<a href="#l12.6764"></a><span id="l12.6764">   NS_IF_ADDREF(*retentionSettings = m_retentionSettings);</span>
<a href="#l12.6765"></a><span id="l12.6765">   return NS_OK;</span>
<a href="#l12.6766"></a><span id="l12.6766"> }</span>
<a href="#l12.6767"></a><span id="l12.6767"> </span>
<a href="#l12.6768"></a><span id="l12.6768" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::SetMsgDownloadSettings(nsIMsgDownloadSettings *downloadSettings)</span>
<a href="#l12.6769"></a><span id="l12.6769" class="difflineminus">-{</span>
<a href="#l12.6770"></a><span id="l12.6770" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::SetMsgDownloadSettings(</span>
<a href="#l12.6771"></a><span id="l12.6771" class="difflineplus">+    nsIMsgDownloadSettings *downloadSettings) {</span>
<a href="#l12.6772"></a><span id="l12.6772">   m_downloadSettings = downloadSettings;</span>
<a href="#l12.6773"></a><span id="l12.6773" class="difflineminus">-  if (downloadSettings &amp;&amp; m_dbFolderInfo)</span>
<a href="#l12.6774"></a><span id="l12.6774" class="difflineminus">-  {</span>
<a href="#l12.6775"></a><span id="l12.6775" class="difflineplus">+  if (downloadSettings &amp;&amp; m_dbFolderInfo) {</span>
<a href="#l12.6776"></a><span id="l12.6776">     nsresult rv;</span>
<a href="#l12.6777"></a><span id="l12.6777"> </span>
<a href="#l12.6778"></a><span id="l12.6778">     bool useServerDefaults;</span>
<a href="#l12.6779"></a><span id="l12.6779">     bool downloadByDate;</span>
<a href="#l12.6780"></a><span id="l12.6780">     uint32_t ageLimitOfMsgsToDownload;</span>
<a href="#l12.6781"></a><span id="l12.6781">     bool downloadUnreadOnly;</span>
<a href="#l12.6782"></a><span id="l12.6782"> </span>
<a href="#l12.6783"></a><span id="l12.6783">     rv = downloadSettings-&gt;GetUseServerDefaults(&amp;useServerDefaults);</span>
<a href="#l12.6784"></a><span id="l12.6784">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.6785"></a><span id="l12.6785">     rv = downloadSettings-&gt;GetDownloadByDate(&amp;downloadByDate);</span>
<a href="#l12.6786"></a><span id="l12.6786">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.6787"></a><span id="l12.6787">     rv = downloadSettings-&gt;GetDownloadUnreadOnly(&amp;downloadUnreadOnly);</span>
<a href="#l12.6788"></a><span id="l12.6788">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.6789"></a><span id="l12.6789" class="difflineminus">-    rv = downloadSettings-&gt;GetAgeLimitOfMsgsToDownload(&amp;ageLimitOfMsgsToDownload);</span>
<a href="#l12.6790"></a><span id="l12.6790" class="difflineplus">+    rv = downloadSettings-&gt;GetAgeLimitOfMsgsToDownload(</span>
<a href="#l12.6791"></a><span id="l12.6791" class="difflineplus">+        &amp;ageLimitOfMsgsToDownload);</span>
<a href="#l12.6792"></a><span id="l12.6792">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.6793"></a><span id="l12.6793" class="difflineminus">-    // need to write this to the db. We'll just use the dbfolderinfo to write properties.</span>
<a href="#l12.6794"></a><span id="l12.6794" class="difflineplus">+    // need to write this to the db. We'll just use the dbfolderinfo to write</span>
<a href="#l12.6795"></a><span id="l12.6795" class="difflineplus">+    // properties.</span>
<a href="#l12.6796"></a><span id="l12.6796">     m_dbFolderInfo-&gt;SetBooleanProperty(&quot;useServerDefaults&quot;, useServerDefaults);</span>
<a href="#l12.6797"></a><span id="l12.6797">     m_dbFolderInfo-&gt;SetBooleanProperty(&quot;downloadByDate&quot;, downloadByDate);</span>
<a href="#l12.6798"></a><span id="l12.6798" class="difflineminus">-    m_dbFolderInfo-&gt;SetBooleanProperty(&quot;downloadUnreadOnly&quot;, downloadUnreadOnly);</span>
<a href="#l12.6799"></a><span id="l12.6799" class="difflineplus">+    m_dbFolderInfo-&gt;SetBooleanProperty(&quot;downloadUnreadOnly&quot;,</span>
<a href="#l12.6800"></a><span id="l12.6800" class="difflineplus">+                                       downloadUnreadOnly);</span>
<a href="#l12.6801"></a><span id="l12.6801">     m_dbFolderInfo-&gt;SetUint32Property(&quot;ageLimit&quot;, ageLimitOfMsgsToDownload);</span>
<a href="#l12.6802"></a><span id="l12.6802">   }</span>
<a href="#l12.6803"></a><span id="l12.6803">   return NS_OK;</span>
<a href="#l12.6804"></a><span id="l12.6804"> }</span>
<a href="#l12.6805"></a><span id="l12.6805"> </span>
<a href="#l12.6806"></a><span id="l12.6806" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetMsgDownloadSettings(nsIMsgDownloadSettings **downloadSettings)</span>
<a href="#l12.6807"></a><span id="l12.6807" class="difflineminus">-{</span>
<a href="#l12.6808"></a><span id="l12.6808" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetMsgDownloadSettings(</span>
<a href="#l12.6809"></a><span id="l12.6809" class="difflineplus">+    nsIMsgDownloadSettings **downloadSettings) {</span>
<a href="#l12.6810"></a><span id="l12.6810">   NS_ENSURE_ARG_POINTER(downloadSettings);</span>
<a href="#l12.6811"></a><span id="l12.6811" class="difflineminus">-  if (!m_downloadSettings)</span>
<a href="#l12.6812"></a><span id="l12.6812" class="difflineminus">-  {</span>
<a href="#l12.6813"></a><span id="l12.6813" class="difflineplus">+  if (!m_downloadSettings) {</span>
<a href="#l12.6814"></a><span id="l12.6814">     // create a new one, and initialize it from the db.</span>
<a href="#l12.6815"></a><span id="l12.6815">     m_downloadSettings = new nsMsgDownloadSettings;</span>
<a href="#l12.6816"></a><span id="l12.6816" class="difflineminus">-    if (m_downloadSettings &amp;&amp; m_dbFolderInfo)</span>
<a href="#l12.6817"></a><span id="l12.6817" class="difflineminus">-    {</span>
<a href="#l12.6818"></a><span id="l12.6818" class="difflineplus">+    if (m_downloadSettings &amp;&amp; m_dbFolderInfo) {</span>
<a href="#l12.6819"></a><span id="l12.6819">       bool useServerDefaults;</span>
<a href="#l12.6820"></a><span id="l12.6820">       bool downloadByDate;</span>
<a href="#l12.6821"></a><span id="l12.6821">       uint32_t ageLimitOfMsgsToDownload;</span>
<a href="#l12.6822"></a><span id="l12.6822">       bool downloadUnreadOnly;</span>
<a href="#l12.6823"></a><span id="l12.6823"> </span>
<a href="#l12.6824"></a><span id="l12.6824" class="difflineminus">-      m_dbFolderInfo-&gt;GetBooleanProperty(&quot;useServerDefaults&quot;, true, &amp;useServerDefaults);</span>
<a href="#l12.6825"></a><span id="l12.6825" class="difflineminus">-      m_dbFolderInfo-&gt;GetBooleanProperty(&quot;downloadByDate&quot;, false, &amp;downloadByDate);</span>
<a href="#l12.6826"></a><span id="l12.6826" class="difflineminus">-      m_dbFolderInfo-&gt;GetBooleanProperty(&quot;downloadUnreadOnly&quot;, false, &amp;downloadUnreadOnly);</span>
<a href="#l12.6827"></a><span id="l12.6827" class="difflineminus">-      m_dbFolderInfo-&gt;GetUint32Property(&quot;ageLimit&quot;, 0, &amp;ageLimitOfMsgsToDownload);</span>
<a href="#l12.6828"></a><span id="l12.6828" class="difflineplus">+      m_dbFolderInfo-&gt;GetBooleanProperty(&quot;useServerDefaults&quot;, true,</span>
<a href="#l12.6829"></a><span id="l12.6829" class="difflineplus">+                                         &amp;useServerDefaults);</span>
<a href="#l12.6830"></a><span id="l12.6830" class="difflineplus">+      m_dbFolderInfo-&gt;GetBooleanProperty(&quot;downloadByDate&quot;, false,</span>
<a href="#l12.6831"></a><span id="l12.6831" class="difflineplus">+                                         &amp;downloadByDate);</span>
<a href="#l12.6832"></a><span id="l12.6832" class="difflineplus">+      m_dbFolderInfo-&gt;GetBooleanProperty(&quot;downloadUnreadOnly&quot;, false,</span>
<a href="#l12.6833"></a><span id="l12.6833" class="difflineplus">+                                         &amp;downloadUnreadOnly);</span>
<a href="#l12.6834"></a><span id="l12.6834" class="difflineplus">+      m_dbFolderInfo-&gt;GetUint32Property(&quot;ageLimit&quot;, 0,</span>
<a href="#l12.6835"></a><span id="l12.6835" class="difflineplus">+                                        &amp;ageLimitOfMsgsToDownload);</span>
<a href="#l12.6836"></a><span id="l12.6836"> </span>
<a href="#l12.6837"></a><span id="l12.6837">       m_downloadSettings-&gt;SetUseServerDefaults(useServerDefaults);</span>
<a href="#l12.6838"></a><span id="l12.6838">       m_downloadSettings-&gt;SetDownloadByDate(downloadByDate);</span>
<a href="#l12.6839"></a><span id="l12.6839">       m_downloadSettings-&gt;SetDownloadUnreadOnly(downloadUnreadOnly);</span>
<a href="#l12.6840"></a><span id="l12.6840">       m_downloadSettings-&gt;SetAgeLimitOfMsgsToDownload(ageLimitOfMsgsToDownload);</span>
<a href="#l12.6841"></a><span id="l12.6841">     }</span>
<a href="#l12.6842"></a><span id="l12.6842">   }</span>
<a href="#l12.6843"></a><span id="l12.6843">   NS_IF_ADDREF(*downloadSettings = m_downloadSettings);</span>
<a href="#l12.6844"></a><span id="l12.6844">   return NS_OK;</span>
<a href="#l12.6845"></a><span id="l12.6845"> }</span>
<a href="#l12.6846"></a><span id="l12.6846"> </span>
<a href="#l12.6847"></a><span id="l12.6847" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::ApplyRetentionSettings(nsIMsgRetentionSettings *aMsgRetentionSettings,</span>
<a href="#l12.6848"></a><span id="l12.6848" class="difflineminus">-                                                    bool aDeleteViaFolder)</span>
<a href="#l12.6849"></a><span id="l12.6849" class="difflineminus">-{</span>
<a href="#l12.6850"></a><span id="l12.6850" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::ApplyRetentionSettings(</span>
<a href="#l12.6851"></a><span id="l12.6851" class="difflineplus">+    nsIMsgRetentionSettings *aMsgRetentionSettings, bool aDeleteViaFolder) {</span>
<a href="#l12.6852"></a><span id="l12.6852">   NS_ENSURE_ARG_POINTER(aMsgRetentionSettings);</span>
<a href="#l12.6853"></a><span id="l12.6853">   nsresult rv = NS_OK;</span>
<a href="#l12.6854"></a><span id="l12.6854"> </span>
<a href="#l12.6855"></a><span id="l12.6855" class="difflineminus">-  if (!m_folder)</span>
<a href="#l12.6856"></a><span id="l12.6856" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.6857"></a><span id="l12.6857" class="difflineplus">+  if (!m_folder) return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.6858"></a><span id="l12.6858"> </span>
<a href="#l12.6859"></a><span id="l12.6859">   bool isDraftsTemplatesOutbox;</span>
<a href="#l12.6860"></a><span id="l12.6860">   uint32_t dtoFlags = nsMsgFolderFlags::Drafts | nsMsgFolderFlags::Templates |</span>
<a href="#l12.6861"></a><span id="l12.6861" class="difflineminus">-                        nsMsgFolderFlags::Queue;</span>
<a href="#l12.6862"></a><span id="l12.6862" class="difflineminus">-  (void) m_folder-&gt;IsSpecialFolder(dtoFlags, true, &amp;isDraftsTemplatesOutbox);</span>
<a href="#l12.6863"></a><span id="l12.6863" class="difflineplus">+                      nsMsgFolderFlags::Queue;</span>
<a href="#l12.6864"></a><span id="l12.6864" class="difflineplus">+  (void)m_folder-&gt;IsSpecialFolder(dtoFlags, true, &amp;isDraftsTemplatesOutbox);</span>
<a href="#l12.6865"></a><span id="l12.6865">   // Never apply retention settings to Drafts/Templates/Outbox.</span>
<a href="#l12.6866"></a><span id="l12.6866" class="difflineminus">-  if (isDraftsTemplatesOutbox)</span>
<a href="#l12.6867"></a><span id="l12.6867" class="difflineminus">-    return NS_OK;</span>
<a href="#l12.6868"></a><span id="l12.6868" class="difflineminus">-</span>
<a href="#l12.6869"></a><span id="l12.6869" class="difflineminus">-  nsCOMPtr &lt;nsIMutableArray&gt; msgHdrsToDelete;</span>
<a href="#l12.6870"></a><span id="l12.6870" class="difflineminus">-  if (aDeleteViaFolder)</span>
<a href="#l12.6871"></a><span id="l12.6871" class="difflineminus">-  {</span>
<a href="#l12.6872"></a><span id="l12.6872" class="difflineplus">+  if (isDraftsTemplatesOutbox) return NS_OK;</span>
<a href="#l12.6873"></a><span id="l12.6873" class="difflineplus">+</span>
<a href="#l12.6874"></a><span id="l12.6874" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; msgHdrsToDelete;</span>
<a href="#l12.6875"></a><span id="l12.6875" class="difflineplus">+  if (aDeleteViaFolder) {</span>
<a href="#l12.6876"></a><span id="l12.6876">     msgHdrsToDelete = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l12.6877"></a><span id="l12.6877">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.6878"></a><span id="l12.6878">   }</span>
<a href="#l12.6879"></a><span id="l12.6879">   nsMsgRetainByPreference retainByPreference;</span>
<a href="#l12.6880"></a><span id="l12.6880">   aMsgRetentionSettings-&gt;GetRetainByPreference(&amp;retainByPreference);</span>
<a href="#l12.6881"></a><span id="l12.6881"> </span>
<a href="#l12.6882"></a><span id="l12.6882">   bool applyToFlaggedMessages = false;</span>
<a href="#l12.6883"></a><span id="l12.6883">   aMsgRetentionSettings-&gt;GetApplyToFlaggedMessages(&amp;applyToFlaggedMessages);</span>
<a href="#l12.6884"></a><span id="l12.6884"> </span>
<a href="#l12.6885"></a><span id="l12.6885">   uint32_t daysToKeepHdrs = 0;</span>
<a href="#l12.6886"></a><span id="l12.6886">   uint32_t numHeadersToKeep = 0;</span>
<a href="#l12.6887"></a><span id="l12.6887" class="difflineminus">-  switch (retainByPreference)</span>
<a href="#l12.6888"></a><span id="l12.6888" class="difflineminus">-  {</span>
<a href="#l12.6889"></a><span id="l12.6889" class="difflineminus">-  case nsIMsgRetentionSettings::nsMsgRetainAll:</span>
<a href="#l12.6890"></a><span id="l12.6890" class="difflineminus">-    break;</span>
<a href="#l12.6891"></a><span id="l12.6891" class="difflineminus">-  case nsIMsgRetentionSettings::nsMsgRetainByAge:</span>
<a href="#l12.6892"></a><span id="l12.6892" class="difflineminus">-    aMsgRetentionSettings-&gt;GetDaysToKeepHdrs(&amp;daysToKeepHdrs);</span>
<a href="#l12.6893"></a><span id="l12.6893" class="difflineminus">-    rv = PurgeMessagesOlderThan(daysToKeepHdrs,</span>
<a href="#l12.6894"></a><span id="l12.6894" class="difflineminus">-                                applyToFlaggedMessages, msgHdrsToDelete);</span>
<a href="#l12.6895"></a><span id="l12.6895" class="difflineminus">-    break;</span>
<a href="#l12.6896"></a><span id="l12.6896" class="difflineminus">-  case nsIMsgRetentionSettings::nsMsgRetainByNumHeaders:</span>
<a href="#l12.6897"></a><span id="l12.6897" class="difflineminus">-    aMsgRetentionSettings-&gt;GetNumHeadersToKeep(&amp;numHeadersToKeep);</span>
<a href="#l12.6898"></a><span id="l12.6898" class="difflineminus">-    rv = PurgeExcessMessages(numHeadersToKeep,</span>
<a href="#l12.6899"></a><span id="l12.6899" class="difflineminus">-                             applyToFlaggedMessages, msgHdrsToDelete);</span>
<a href="#l12.6900"></a><span id="l12.6900" class="difflineminus">-    break;</span>
<a href="#l12.6901"></a><span id="l12.6901" class="difflineplus">+  switch (retainByPreference) {</span>
<a href="#l12.6902"></a><span id="l12.6902" class="difflineplus">+    case nsIMsgRetentionSettings::nsMsgRetainAll:</span>
<a href="#l12.6903"></a><span id="l12.6903" class="difflineplus">+      break;</span>
<a href="#l12.6904"></a><span id="l12.6904" class="difflineplus">+    case nsIMsgRetentionSettings::nsMsgRetainByAge:</span>
<a href="#l12.6905"></a><span id="l12.6905" class="difflineplus">+      aMsgRetentionSettings-&gt;GetDaysToKeepHdrs(&amp;daysToKeepHdrs);</span>
<a href="#l12.6906"></a><span id="l12.6906" class="difflineplus">+      rv = PurgeMessagesOlderThan(daysToKeepHdrs, applyToFlaggedMessages,</span>
<a href="#l12.6907"></a><span id="l12.6907" class="difflineplus">+                                  msgHdrsToDelete);</span>
<a href="#l12.6908"></a><span id="l12.6908" class="difflineplus">+      break;</span>
<a href="#l12.6909"></a><span id="l12.6909" class="difflineplus">+    case nsIMsgRetentionSettings::nsMsgRetainByNumHeaders:</span>
<a href="#l12.6910"></a><span id="l12.6910" class="difflineplus">+      aMsgRetentionSettings-&gt;GetNumHeadersToKeep(&amp;numHeadersToKeep);</span>
<a href="#l12.6911"></a><span id="l12.6911" class="difflineplus">+      rv = PurgeExcessMessages(numHeadersToKeep, applyToFlaggedMessages,</span>
<a href="#l12.6912"></a><span id="l12.6912" class="difflineplus">+                               msgHdrsToDelete);</span>
<a href="#l12.6913"></a><span id="l12.6913" class="difflineplus">+      break;</span>
<a href="#l12.6914"></a><span id="l12.6914">   }</span>
<a href="#l12.6915"></a><span id="l12.6915" class="difflineminus">-  if (m_folder)</span>
<a href="#l12.6916"></a><span id="l12.6916" class="difflineminus">-  {</span>
<a href="#l12.6917"></a><span id="l12.6917" class="difflineplus">+  if (m_folder) {</span>
<a href="#l12.6918"></a><span id="l12.6918">     // update the time we attempted to purge this folder</span>
<a href="#l12.6919"></a><span id="l12.6919">     char dateBuf[100];</span>
<a href="#l12.6920"></a><span id="l12.6920">     dateBuf[0] = '\0';</span>
<a href="#l12.6921"></a><span id="l12.6921">     PRExplodedTime exploded;</span>
<a href="#l12.6922"></a><span id="l12.6922">     PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;exploded);</span>
<a href="#l12.6923"></a><span id="l12.6923" class="difflineminus">-    PR_FormatTimeUSEnglish(dateBuf, sizeof(dateBuf), &quot;%a %b %d %H:%M:%S %Y&quot;, &amp;exploded);</span>
<a href="#l12.6924"></a><span id="l12.6924" class="difflineplus">+    PR_FormatTimeUSEnglish(dateBuf, sizeof(dateBuf), &quot;%a %b %d %H:%M:%S %Y&quot;,</span>
<a href="#l12.6925"></a><span id="l12.6925" class="difflineplus">+                           &amp;exploded);</span>
<a href="#l12.6926"></a><span id="l12.6926">     m_folder-&gt;SetStringProperty(&quot;LastPurgeTime&quot;, nsDependentCString(dateBuf));</span>
<a href="#l12.6927"></a><span id="l12.6927">   }</span>
<a href="#l12.6928"></a><span id="l12.6928" class="difflineminus">-  if (msgHdrsToDelete)</span>
<a href="#l12.6929"></a><span id="l12.6929" class="difflineminus">-  {</span>
<a href="#l12.6930"></a><span id="l12.6930" class="difflineplus">+  if (msgHdrsToDelete) {</span>
<a href="#l12.6931"></a><span id="l12.6931">     uint32_t count;</span>
<a href="#l12.6932"></a><span id="l12.6932">     msgHdrsToDelete-&gt;GetLength(&amp;count);</span>
<a href="#l12.6933"></a><span id="l12.6933">     if (count &gt; 0)</span>
<a href="#l12.6934"></a><span id="l12.6934" class="difflineminus">-      rv = m_folder-&gt;DeleteMessages(msgHdrsToDelete, nullptr, true, false, nullptr, false);</span>
<a href="#l12.6935"></a><span id="l12.6935" class="difflineplus">+      rv = m_folder-&gt;DeleteMessages(msgHdrsToDelete, nullptr, true, false,</span>
<a href="#l12.6936"></a><span id="l12.6936" class="difflineplus">+                                    nullptr, false);</span>
<a href="#l12.6937"></a><span id="l12.6937">   }</span>
<a href="#l12.6938"></a><span id="l12.6938">   return rv;</span>
<a href="#l12.6939"></a><span id="l12.6939"> }</span>
<a href="#l12.6940"></a><span id="l12.6940"> </span>
<a href="#l12.6941"></a><span id="l12.6941"> nsresult nsMsgDatabase::PurgeMessagesOlderThan(uint32_t daysToKeepHdrs,</span>
<a href="#l12.6942"></a><span id="l12.6942">                                                bool applyToFlaggedMessages,</span>
<a href="#l12.6943"></a><span id="l12.6943" class="difflineminus">-                                               nsIMutableArray *hdrsToDelete)</span>
<a href="#l12.6944"></a><span id="l12.6944" class="difflineminus">-{</span>
<a href="#l12.6945"></a><span id="l12.6945" class="difflineplus">+                                               nsIMutableArray *hdrsToDelete) {</span>
<a href="#l12.6946"></a><span id="l12.6946">   nsresult rv = NS_OK;</span>
<a href="#l12.6947"></a><span id="l12.6947">   nsMsgHdr *pHeader;</span>
<a href="#l12.6948"></a><span id="l12.6948" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l12.6949"></a><span id="l12.6949" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l12.6950"></a><span id="l12.6950">   rv = EnumerateMessages(getter_AddRefs(hdrs));</span>
<a href="#l12.6951"></a><span id="l12.6951">   nsTArray&lt;nsMsgKey&gt; keysToDelete;</span>
<a href="#l12.6952"></a><span id="l12.6952"> </span>
<a href="#l12.6953"></a><span id="l12.6953" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.6954"></a><span id="l12.6954" class="difflineminus">-    return rv;</span>
<a href="#l12.6955"></a><span id="l12.6955" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.6956"></a><span id="l12.6956">   bool hasMore = false;</span>
<a href="#l12.6957"></a><span id="l12.6957"> </span>
<a href="#l12.6958"></a><span id="l12.6958">   PRTime cutOffDay = PR_Now() - daysToKeepHdrs * PR_USEC_PER_DAY;</span>
<a href="#l12.6959"></a><span id="l12.6959"> </span>
<a href="#l12.6960"></a><span id="l12.6960" class="difflineminus">-  // so now cutOffDay is the PRTime cut-off point. Any msg with a date less than that will get purged.</span>
<a href="#l12.6961"></a><span id="l12.6961" class="difflineminus">-  while (NS_SUCCEEDED(rv = hdrs-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l12.6962"></a><span id="l12.6962" class="difflineminus">-  {</span>
<a href="#l12.6963"></a><span id="l12.6963" class="difflineplus">+  // so now cutOffDay is the PRTime cut-off point. Any msg with a date less than</span>
<a href="#l12.6964"></a><span id="l12.6964" class="difflineplus">+  // that will get purged.</span>
<a href="#l12.6965"></a><span id="l12.6965" class="difflineplus">+  while (NS_SUCCEEDED(rv = hdrs-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l12.6966"></a><span id="l12.6966">     bool purgeHdr = false;</span>
<a href="#l12.6967"></a><span id="l12.6967"> </span>
<a href="#l12.6968"></a><span id="l12.6968" class="difflineminus">-    rv = hdrs-&gt;GetNext((nsISupports**)&amp;pHeader);</span>
<a href="#l12.6969"></a><span id="l12.6969" class="difflineplus">+    rv = hdrs-&gt;GetNext((nsISupports **)&amp;pHeader);</span>
<a href="#l12.6970"></a><span id="l12.6970">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;nsMsgDBEnumerator broken&quot;);</span>
<a href="#l12.6971"></a><span id="l12.6971" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.6972"></a><span id="l12.6972" class="difflineminus">-      break;</span>
<a href="#l12.6973"></a><span id="l12.6973" class="difflineminus">-</span>
<a href="#l12.6974"></a><span id="l12.6974" class="difflineminus">-    if (!applyToFlaggedMessages)</span>
<a href="#l12.6975"></a><span id="l12.6975" class="difflineminus">-    {</span>
<a href="#l12.6976"></a><span id="l12.6976" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l12.6977"></a><span id="l12.6977" class="difflineplus">+</span>
<a href="#l12.6978"></a><span id="l12.6978" class="difflineplus">+    if (!applyToFlaggedMessages) {</span>
<a href="#l12.6979"></a><span id="l12.6979">       uint32_t flags;</span>
<a href="#l12.6980"></a><span id="l12.6980">       (void)pHeader-&gt;GetFlags(&amp;flags);</span>
<a href="#l12.6981"></a><span id="l12.6981" class="difflineminus">-      if (flags &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l12.6982"></a><span id="l12.6982" class="difflineminus">-        continue;</span>
<a href="#l12.6983"></a><span id="l12.6983" class="difflineplus">+      if (flags &amp; nsMsgMessageFlags::Marked) continue;</span>
<a href="#l12.6984"></a><span id="l12.6984">     }</span>
<a href="#l12.6985"></a><span id="l12.6985"> </span>
<a href="#l12.6986"></a><span id="l12.6986" class="difflineminus">-    if (!purgeHdr)</span>
<a href="#l12.6987"></a><span id="l12.6987" class="difflineminus">-    {</span>
<a href="#l12.6988"></a><span id="l12.6988" class="difflineplus">+    if (!purgeHdr) {</span>
<a href="#l12.6989"></a><span id="l12.6989">       PRTime date;</span>
<a href="#l12.6990"></a><span id="l12.6990">       pHeader-&gt;GetDate(&amp;date);</span>
<a href="#l12.6991"></a><span id="l12.6991" class="difflineminus">-      if (date &lt; cutOffDay)</span>
<a href="#l12.6992"></a><span id="l12.6992" class="difflineminus">-        purgeHdr = true;</span>
<a href="#l12.6993"></a><span id="l12.6993" class="difflineplus">+      if (date &lt; cutOffDay) purgeHdr = true;</span>
<a href="#l12.6994"></a><span id="l12.6994">     }</span>
<a href="#l12.6995"></a><span id="l12.6995" class="difflineminus">-    if (purgeHdr)</span>
<a href="#l12.6996"></a><span id="l12.6996" class="difflineminus">-    {</span>
<a href="#l12.6997"></a><span id="l12.6997" class="difflineplus">+    if (purgeHdr) {</span>
<a href="#l12.6998"></a><span id="l12.6998">       nsMsgKey msgKey;</span>
<a href="#l12.6999"></a><span id="l12.6999">       pHeader-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l12.7000"></a><span id="l12.7000">       keysToDelete.AppendElement(msgKey);</span>
<a href="#l12.7001"></a><span id="l12.7001" class="difflineminus">-      if (hdrsToDelete)</span>
<a href="#l12.7002"></a><span id="l12.7002" class="difflineminus">-        hdrsToDelete-&gt;AppendElement(pHeader);</span>
<a href="#l12.7003"></a><span id="l12.7003" class="difflineplus">+      if (hdrsToDelete) hdrsToDelete-&gt;AppendElement(pHeader);</span>
<a href="#l12.7004"></a><span id="l12.7004">     }</span>
<a href="#l12.7005"></a><span id="l12.7005">     NS_RELEASE(pHeader);</span>
<a href="#l12.7006"></a><span id="l12.7006">   }</span>
<a href="#l12.7007"></a><span id="l12.7007"> </span>
<a href="#l12.7008"></a><span id="l12.7008" class="difflineminus">-  if (!hdrsToDelete)</span>
<a href="#l12.7009"></a><span id="l12.7009" class="difflineminus">-  {</span>
<a href="#l12.7010"></a><span id="l12.7010" class="difflineplus">+  if (!hdrsToDelete) {</span>
<a href="#l12.7011"></a><span id="l12.7011">     DeleteMessages(keysToDelete.Length(), keysToDelete.Elements(), nullptr);</span>
<a href="#l12.7012"></a><span id="l12.7012"> </span>
<a href="#l12.7013"></a><span id="l12.7013" class="difflineminus">-    if (keysToDelete.Length() &gt; 10) // compress commit if we deleted more than 10</span>
<a href="#l12.7014"></a><span id="l12.7014" class="difflineplus">+    if (keysToDelete.Length() &gt;</span>
<a href="#l12.7015"></a><span id="l12.7015" class="difflineplus">+        10)  // compress commit if we deleted more than 10</span>
<a href="#l12.7016"></a><span id="l12.7016">       Commit(nsMsgDBCommitType::kCompressCommit);</span>
<a href="#l12.7017"></a><span id="l12.7017">     else if (!keysToDelete.IsEmpty())</span>
<a href="#l12.7018"></a><span id="l12.7018">       Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l12.7019"></a><span id="l12.7019">   }</span>
<a href="#l12.7020"></a><span id="l12.7020">   return rv;</span>
<a href="#l12.7021"></a><span id="l12.7021"> }</span>
<a href="#l12.7022"></a><span id="l12.7022"> </span>
<a href="#l12.7023"></a><span id="l12.7023"> nsresult nsMsgDatabase::PurgeExcessMessages(uint32_t numHeadersToKeep,</span>
<a href="#l12.7024"></a><span id="l12.7024">                                             bool applyToFlaggedMessages,</span>
<a href="#l12.7025"></a><span id="l12.7025" class="difflineminus">-                                            nsIMutableArray *hdrsToDelete)</span>
<a href="#l12.7026"></a><span id="l12.7026" class="difflineminus">-{</span>
<a href="#l12.7027"></a><span id="l12.7027" class="difflineplus">+                                            nsIMutableArray *hdrsToDelete) {</span>
<a href="#l12.7028"></a><span id="l12.7028">   nsresult rv = NS_OK;</span>
<a href="#l12.7029"></a><span id="l12.7029" class="difflineminus">-  nsMsgHdr    *pHeader;</span>
<a href="#l12.7030"></a><span id="l12.7030" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l12.7031"></a><span id="l12.7031" class="difflineplus">+  nsMsgHdr *pHeader;</span>
<a href="#l12.7032"></a><span id="l12.7032" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l12.7033"></a><span id="l12.7033">   rv = EnumerateMessages(getter_AddRefs(hdrs));</span>
<a href="#l12.7034"></a><span id="l12.7034" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l12.7035"></a><span id="l12.7035" class="difflineminus">-    return rv;</span>
<a href="#l12.7036"></a><span id="l12.7036" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l12.7037"></a><span id="l12.7037">   bool hasMore = false;</span>
<a href="#l12.7038"></a><span id="l12.7038">   nsTArray&lt;nsMsgKey&gt; keysToDelete;</span>
<a href="#l12.7039"></a><span id="l12.7039"> </span>
<a href="#l12.7040"></a><span id="l12.7040">   mdb_count numHdrs = 0;</span>
<a href="#l12.7041"></a><span id="l12.7041">   if (m_mdbAllMsgHeadersTable)</span>
<a href="#l12.7042"></a><span id="l12.7042">     m_mdbAllMsgHeadersTable-&gt;GetCount(GetEnv(), &amp;numHdrs);</span>
<a href="#l12.7043"></a><span id="l12.7043">   else</span>
<a href="#l12.7044"></a><span id="l12.7044">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l12.7045"></a><span id="l12.7045"> </span>
<a href="#l12.7046"></a><span id="l12.7046" class="difflineminus">-  while (NS_SUCCEEDED(rv = hdrs-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l12.7047"></a><span id="l12.7047" class="difflineminus">-  {</span>
<a href="#l12.7048"></a><span id="l12.7048" class="difflineplus">+  while (NS_SUCCEEDED(rv = hdrs-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l12.7049"></a><span id="l12.7049">     bool purgeHdr = false;</span>
<a href="#l12.7050"></a><span id="l12.7050" class="difflineminus">-    rv = hdrs-&gt;GetNext((nsISupports**)&amp;pHeader);</span>
<a href="#l12.7051"></a><span id="l12.7051" class="difflineplus">+    rv = hdrs-&gt;GetNext((nsISupports **)&amp;pHeader);</span>
<a href="#l12.7052"></a><span id="l12.7052">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;nsMsgDBEnumerator broken&quot;);</span>
<a href="#l12.7053"></a><span id="l12.7053" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.7054"></a><span id="l12.7054" class="difflineminus">-      break;</span>
<a href="#l12.7055"></a><span id="l12.7055" class="difflineminus">-</span>
<a href="#l12.7056"></a><span id="l12.7056" class="difflineminus">-    if (!applyToFlaggedMessages)</span>
<a href="#l12.7057"></a><span id="l12.7057" class="difflineminus">-    {</span>
<a href="#l12.7058"></a><span id="l12.7058" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l12.7059"></a><span id="l12.7059" class="difflineplus">+</span>
<a href="#l12.7060"></a><span id="l12.7060" class="difflineplus">+    if (!applyToFlaggedMessages) {</span>
<a href="#l12.7061"></a><span id="l12.7061">       uint32_t flags;</span>
<a href="#l12.7062"></a><span id="l12.7062">       (void)pHeader-&gt;GetFlags(&amp;flags);</span>
<a href="#l12.7063"></a><span id="l12.7063" class="difflineminus">-      if (flags &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l12.7064"></a><span id="l12.7064" class="difflineminus">-        continue;</span>
<a href="#l12.7065"></a><span id="l12.7065" class="difflineplus">+      if (flags &amp; nsMsgMessageFlags::Marked) continue;</span>
<a href="#l12.7066"></a><span id="l12.7066">     }</span>
<a href="#l12.7067"></a><span id="l12.7067"> </span>
<a href="#l12.7068"></a><span id="l12.7068" class="difflineminus">-    // this isn't quite right - we want to prefer unread messages (keep all of those we can)</span>
<a href="#l12.7069"></a><span id="l12.7069" class="difflineminus">-    if (numHdrs &gt; numHeadersToKeep)</span>
<a href="#l12.7070"></a><span id="l12.7070" class="difflineminus">-      purgeHdr = true;</span>
<a href="#l12.7071"></a><span id="l12.7071" class="difflineminus">-</span>
<a href="#l12.7072"></a><span id="l12.7072" class="difflineminus">-    if (purgeHdr)</span>
<a href="#l12.7073"></a><span id="l12.7073" class="difflineminus">-    {</span>
<a href="#l12.7074"></a><span id="l12.7074" class="difflineplus">+    // this isn't quite right - we want to prefer unread messages (keep all of</span>
<a href="#l12.7075"></a><span id="l12.7075" class="difflineplus">+    // those we can)</span>
<a href="#l12.7076"></a><span id="l12.7076" class="difflineplus">+    if (numHdrs &gt; numHeadersToKeep) purgeHdr = true;</span>
<a href="#l12.7077"></a><span id="l12.7077" class="difflineplus">+</span>
<a href="#l12.7078"></a><span id="l12.7078" class="difflineplus">+    if (purgeHdr) {</span>
<a href="#l12.7079"></a><span id="l12.7079">       nsMsgKey msgKey;</span>
<a href="#l12.7080"></a><span id="l12.7080">       pHeader-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l12.7081"></a><span id="l12.7081">       keysToDelete.AppendElement(msgKey);</span>
<a href="#l12.7082"></a><span id="l12.7082">       numHdrs--;</span>
<a href="#l12.7083"></a><span id="l12.7083" class="difflineminus">-      if (hdrsToDelete)</span>
<a href="#l12.7084"></a><span id="l12.7084" class="difflineminus">-        hdrsToDelete-&gt;AppendElement(pHeader);</span>
<a href="#l12.7085"></a><span id="l12.7085" class="difflineplus">+      if (hdrsToDelete) hdrsToDelete-&gt;AppendElement(pHeader);</span>
<a href="#l12.7086"></a><span id="l12.7086">     }</span>
<a href="#l12.7087"></a><span id="l12.7087">     NS_RELEASE(pHeader);</span>
<a href="#l12.7088"></a><span id="l12.7088">   }</span>
<a href="#l12.7089"></a><span id="l12.7089"> </span>
<a href="#l12.7090"></a><span id="l12.7090" class="difflineminus">-  if (!hdrsToDelete)</span>
<a href="#l12.7091"></a><span id="l12.7091" class="difflineminus">-  {</span>
<a href="#l12.7092"></a><span id="l12.7092" class="difflineplus">+  if (!hdrsToDelete) {</span>
<a href="#l12.7093"></a><span id="l12.7093">     int32_t numKeysToDelete = keysToDelete.Length();</span>
<a href="#l12.7094"></a><span id="l12.7094" class="difflineminus">-    if (numKeysToDelete &gt; 0)</span>
<a href="#l12.7095"></a><span id="l12.7095" class="difflineminus">-    {</span>
<a href="#l12.7096"></a><span id="l12.7096" class="difflineplus">+    if (numKeysToDelete &gt; 0) {</span>
<a href="#l12.7097"></a><span id="l12.7097">       DeleteMessages(keysToDelete.Length(), keysToDelete.Elements(), nullptr);</span>
<a href="#l12.7098"></a><span id="l12.7098">       if (numKeysToDelete &gt; 10)  // compress commit if we deleted more than 10</span>
<a href="#l12.7099"></a><span id="l12.7099">         Commit(nsMsgDBCommitType::kCompressCommit);</span>
<a href="#l12.7100"></a><span id="l12.7100">       else</span>
<a href="#l12.7101"></a><span id="l12.7101">         Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l12.7102"></a><span id="l12.7102">     }</span>
<a href="#l12.7103"></a><span id="l12.7103">   }</span>
<a href="#l12.7104"></a><span id="l12.7104">   return rv;</span>
<a href="#l12.7105"></a><span id="l12.7105"> }</span>
<a href="#l12.7106"></a><span id="l12.7106"> </span>
<a href="#l12.7107"></a><span id="l12.7107"> NS_IMPL_ISUPPORTS(nsMsgRetentionSettings, nsIMsgRetentionSettings)</span>
<a href="#l12.7108"></a><span id="l12.7108"> </span>
<a href="#l12.7109"></a><span id="l12.7109"> // Initialise the member variables to reasonable defaults.</span>
<a href="#l12.7110"></a><span id="l12.7110"> nsMsgRetentionSettings::nsMsgRetentionSettings()</span>
<a href="#l12.7111"></a><span id="l12.7111" class="difflineminus">-: m_retainByPreference(1),</span>
<a href="#l12.7112"></a><span id="l12.7112" class="difflineminus">-  m_daysToKeepHdrs(0),</span>
<a href="#l12.7113"></a><span id="l12.7113" class="difflineminus">-  m_numHeadersToKeep(0),</span>
<a href="#l12.7114"></a><span id="l12.7114" class="difflineminus">-  m_useServerDefaults(true),</span>
<a href="#l12.7115"></a><span id="l12.7115" class="difflineminus">-  m_cleanupBodiesByDays(false),</span>
<a href="#l12.7116"></a><span id="l12.7116" class="difflineminus">-  m_daysToKeepBodies(0),</span>
<a href="#l12.7117"></a><span id="l12.7117" class="difflineminus">-  m_applyToFlaggedMessages(false)</span>
<a href="#l12.7118"></a><span id="l12.7118" class="difflineminus">-{</span>
<a href="#l12.7119"></a><span id="l12.7119" class="difflineminus">-}</span>
<a href="#l12.7120"></a><span id="l12.7120" class="difflineminus">-</span>
<a href="#l12.7121"></a><span id="l12.7121" class="difflineminus">-nsMsgRetentionSettings::~nsMsgRetentionSettings()</span>
<a href="#l12.7122"></a><span id="l12.7122" class="difflineminus">-{</span>
<a href="#l12.7123"></a><span id="l12.7123" class="difflineminus">-}</span>
<a href="#l12.7124"></a><span id="l12.7124" class="difflineplus">+    : m_retainByPreference(1),</span>
<a href="#l12.7125"></a><span id="l12.7125" class="difflineplus">+      m_daysToKeepHdrs(0),</span>
<a href="#l12.7126"></a><span id="l12.7126" class="difflineplus">+      m_numHeadersToKeep(0),</span>
<a href="#l12.7127"></a><span id="l12.7127" class="difflineplus">+      m_useServerDefaults(true),</span>
<a href="#l12.7128"></a><span id="l12.7128" class="difflineplus">+      m_cleanupBodiesByDays(false),</span>
<a href="#l12.7129"></a><span id="l12.7129" class="difflineplus">+      m_daysToKeepBodies(0),</span>
<a href="#l12.7130"></a><span id="l12.7130" class="difflineplus">+      m_applyToFlaggedMessages(false) {}</span>
<a href="#l12.7131"></a><span id="l12.7131" class="difflineplus">+</span>
<a href="#l12.7132"></a><span id="l12.7132" class="difflineplus">+nsMsgRetentionSettings::~nsMsgRetentionSettings() {}</span>
<a href="#l12.7133"></a><span id="l12.7133"> </span>
<a href="#l12.7134"></a><span id="l12.7134"> /* attribute unsigned long retainByPreference */</span>
<a href="#l12.7135"></a><span id="l12.7135"> </span>
<a href="#l12.7136"></a><span id="l12.7136" class="difflineminus">-NS_IMETHODIMP nsMsgRetentionSettings::GetRetainByPreference(nsMsgRetainByPreference *retainByPreference)</span>
<a href="#l12.7137"></a><span id="l12.7137" class="difflineminus">-{</span>
<a href="#l12.7138"></a><span id="l12.7138" class="difflineplus">+NS_IMETHODIMP nsMsgRetentionSettings::GetRetainByPreference(</span>
<a href="#l12.7139"></a><span id="l12.7139" class="difflineplus">+    nsMsgRetainByPreference *retainByPreference) {</span>
<a href="#l12.7140"></a><span id="l12.7140">   NS_ENSURE_ARG_POINTER(retainByPreference);</span>
<a href="#l12.7141"></a><span id="l12.7141">   *retainByPreference = m_retainByPreference;</span>
<a href="#l12.7142"></a><span id="l12.7142">   return NS_OK;</span>
<a href="#l12.7143"></a><span id="l12.7143"> }</span>
<a href="#l12.7144"></a><span id="l12.7144"> </span>
<a href="#l12.7145"></a><span id="l12.7145" class="difflineminus">-NS_IMETHODIMP nsMsgRetentionSettings::SetRetainByPreference(nsMsgRetainByPreference retainByPreference)</span>
<a href="#l12.7146"></a><span id="l12.7146" class="difflineminus">-{</span>
<a href="#l12.7147"></a><span id="l12.7147" class="difflineplus">+NS_IMETHODIMP nsMsgRetentionSettings::SetRetainByPreference(</span>
<a href="#l12.7148"></a><span id="l12.7148" class="difflineplus">+    nsMsgRetainByPreference retainByPreference) {</span>
<a href="#l12.7149"></a><span id="l12.7149">   m_retainByPreference = retainByPreference;</span>
<a href="#l12.7150"></a><span id="l12.7150">   return NS_OK;</span>
<a href="#l12.7151"></a><span id="l12.7151"> }</span>
<a href="#l12.7152"></a><span id="l12.7152"> </span>
<a href="#l12.7153"></a><span id="l12.7153"> /* attribute long daysToKeepHdrs; */</span>
<a href="#l12.7154"></a><span id="l12.7154" class="difflineminus">-NS_IMETHODIMP nsMsgRetentionSettings::GetDaysToKeepHdrs(uint32_t *aDaysToKeepHdrs)</span>
<a href="#l12.7155"></a><span id="l12.7155" class="difflineminus">-{</span>
<a href="#l12.7156"></a><span id="l12.7156" class="difflineplus">+NS_IMETHODIMP nsMsgRetentionSettings::GetDaysToKeepHdrs(</span>
<a href="#l12.7157"></a><span id="l12.7157" class="difflineplus">+    uint32_t *aDaysToKeepHdrs) {</span>
<a href="#l12.7158"></a><span id="l12.7158">   NS_ENSURE_ARG_POINTER(aDaysToKeepHdrs);</span>
<a href="#l12.7159"></a><span id="l12.7159">   *aDaysToKeepHdrs = m_daysToKeepHdrs;</span>
<a href="#l12.7160"></a><span id="l12.7160">   return NS_OK;</span>
<a href="#l12.7161"></a><span id="l12.7161"> }</span>
<a href="#l12.7162"></a><span id="l12.7162"> </span>
<a href="#l12.7163"></a><span id="l12.7163" class="difflineminus">-NS_IMETHODIMP nsMsgRetentionSettings::SetDaysToKeepHdrs(uint32_t aDaysToKeepHdrs)</span>
<a href="#l12.7164"></a><span id="l12.7164" class="difflineminus">-{</span>
<a href="#l12.7165"></a><span id="l12.7165" class="difflineplus">+NS_IMETHODIMP nsMsgRetentionSettings::SetDaysToKeepHdrs(</span>
<a href="#l12.7166"></a><span id="l12.7166" class="difflineplus">+    uint32_t aDaysToKeepHdrs) {</span>
<a href="#l12.7167"></a><span id="l12.7167">   m_daysToKeepHdrs = aDaysToKeepHdrs;</span>
<a href="#l12.7168"></a><span id="l12.7168">   return NS_OK;</span>
<a href="#l12.7169"></a><span id="l12.7169"> }</span>
<a href="#l12.7170"></a><span id="l12.7170"> </span>
<a href="#l12.7171"></a><span id="l12.7171"> /* attribute long numHeadersToKeep; */</span>
<a href="#l12.7172"></a><span id="l12.7172" class="difflineminus">-NS_IMETHODIMP nsMsgRetentionSettings::GetNumHeadersToKeep(uint32_t *aNumHeadersToKeep)</span>
<a href="#l12.7173"></a><span id="l12.7173" class="difflineminus">-{</span>
<a href="#l12.7174"></a><span id="l12.7174" class="difflineplus">+NS_IMETHODIMP nsMsgRetentionSettings::GetNumHeadersToKeep(</span>
<a href="#l12.7175"></a><span id="l12.7175" class="difflineplus">+    uint32_t *aNumHeadersToKeep) {</span>
<a href="#l12.7176"></a><span id="l12.7176">   NS_ENSURE_ARG_POINTER(aNumHeadersToKeep);</span>
<a href="#l12.7177"></a><span id="l12.7177">   *aNumHeadersToKeep = m_numHeadersToKeep;</span>
<a href="#l12.7178"></a><span id="l12.7178">   return NS_OK;</span>
<a href="#l12.7179"></a><span id="l12.7179"> }</span>
<a href="#l12.7180"></a><span id="l12.7180" class="difflineminus">-NS_IMETHODIMP nsMsgRetentionSettings::SetNumHeadersToKeep(uint32_t aNumHeadersToKeep)</span>
<a href="#l12.7181"></a><span id="l12.7181" class="difflineminus">-{</span>
<a href="#l12.7182"></a><span id="l12.7182" class="difflineplus">+NS_IMETHODIMP nsMsgRetentionSettings::SetNumHeadersToKeep(</span>
<a href="#l12.7183"></a><span id="l12.7183" class="difflineplus">+    uint32_t aNumHeadersToKeep) {</span>
<a href="#l12.7184"></a><span id="l12.7184">   m_numHeadersToKeep = aNumHeadersToKeep;</span>
<a href="#l12.7185"></a><span id="l12.7185">   return NS_OK;</span>
<a href="#l12.7186"></a><span id="l12.7186"> }</span>
<a href="#l12.7187"></a><span id="l12.7187"> /* attribute boolean useServerDefaults; */</span>
<a href="#l12.7188"></a><span id="l12.7188" class="difflineminus">-NS_IMETHODIMP nsMsgRetentionSettings::GetUseServerDefaults(bool *aUseServerDefaults)</span>
<a href="#l12.7189"></a><span id="l12.7189" class="difflineminus">-{</span>
<a href="#l12.7190"></a><span id="l12.7190" class="difflineplus">+NS_IMETHODIMP nsMsgRetentionSettings::GetUseServerDefaults(</span>
<a href="#l12.7191"></a><span id="l12.7191" class="difflineplus">+    bool *aUseServerDefaults) {</span>
<a href="#l12.7192"></a><span id="l12.7192">   NS_ENSURE_ARG_POINTER(aUseServerDefaults);</span>
<a href="#l12.7193"></a><span id="l12.7193">   *aUseServerDefaults = m_useServerDefaults;</span>
<a href="#l12.7194"></a><span id="l12.7194">   return NS_OK;</span>
<a href="#l12.7195"></a><span id="l12.7195"> }</span>
<a href="#l12.7196"></a><span id="l12.7196" class="difflineminus">-NS_IMETHODIMP nsMsgRetentionSettings::SetUseServerDefaults(bool aUseServerDefaults)</span>
<a href="#l12.7197"></a><span id="l12.7197" class="difflineminus">-{</span>
<a href="#l12.7198"></a><span id="l12.7198" class="difflineplus">+NS_IMETHODIMP nsMsgRetentionSettings::SetUseServerDefaults(</span>
<a href="#l12.7199"></a><span id="l12.7199" class="difflineplus">+    bool aUseServerDefaults) {</span>
<a href="#l12.7200"></a><span id="l12.7200">   m_useServerDefaults = aUseServerDefaults;</span>
<a href="#l12.7201"></a><span id="l12.7201">   return NS_OK;</span>
<a href="#l12.7202"></a><span id="l12.7202"> }</span>
<a href="#l12.7203"></a><span id="l12.7203"> </span>
<a href="#l12.7204"></a><span id="l12.7204"> /* attribute boolean cleanupBodiesByDays; */</span>
<a href="#l12.7205"></a><span id="l12.7205" class="difflineminus">-NS_IMETHODIMP nsMsgRetentionSettings::GetCleanupBodiesByDays(bool *aCleanupBodiesByDays)</span>
<a href="#l12.7206"></a><span id="l12.7206" class="difflineminus">-{</span>
<a href="#l12.7207"></a><span id="l12.7207" class="difflineplus">+NS_IMETHODIMP nsMsgRetentionSettings::GetCleanupBodiesByDays(</span>
<a href="#l12.7208"></a><span id="l12.7208" class="difflineplus">+    bool *aCleanupBodiesByDays) {</span>
<a href="#l12.7209"></a><span id="l12.7209">   NS_ENSURE_ARG_POINTER(aCleanupBodiesByDays);</span>
<a href="#l12.7210"></a><span id="l12.7210">   *aCleanupBodiesByDays = m_cleanupBodiesByDays;</span>
<a href="#l12.7211"></a><span id="l12.7211">   return NS_OK;</span>
<a href="#l12.7212"></a><span id="l12.7212"> }</span>
<a href="#l12.7213"></a><span id="l12.7213" class="difflineminus">-NS_IMETHODIMP nsMsgRetentionSettings::SetCleanupBodiesByDays(bool aCleanupBodiesByDays)</span>
<a href="#l12.7214"></a><span id="l12.7214" class="difflineminus">-{</span>
<a href="#l12.7215"></a><span id="l12.7215" class="difflineplus">+NS_IMETHODIMP nsMsgRetentionSettings::SetCleanupBodiesByDays(</span>
<a href="#l12.7216"></a><span id="l12.7216" class="difflineplus">+    bool aCleanupBodiesByDays) {</span>
<a href="#l12.7217"></a><span id="l12.7217">   m_cleanupBodiesByDays = aCleanupBodiesByDays;</span>
<a href="#l12.7218"></a><span id="l12.7218">   return NS_OK;</span>
<a href="#l12.7219"></a><span id="l12.7219"> }</span>
<a href="#l12.7220"></a><span id="l12.7220"> </span>
<a href="#l12.7221"></a><span id="l12.7221"> /* attribute long daysToKeepBodies; */</span>
<a href="#l12.7222"></a><span id="l12.7222" class="difflineminus">-NS_IMETHODIMP nsMsgRetentionSettings::GetDaysToKeepBodies(uint32_t *aDaysToKeepBodies)</span>
<a href="#l12.7223"></a><span id="l12.7223" class="difflineminus">-{</span>
<a href="#l12.7224"></a><span id="l12.7224" class="difflineplus">+NS_IMETHODIMP nsMsgRetentionSettings::GetDaysToKeepBodies(</span>
<a href="#l12.7225"></a><span id="l12.7225" class="difflineplus">+    uint32_t *aDaysToKeepBodies) {</span>
<a href="#l12.7226"></a><span id="l12.7226">   NS_ENSURE_ARG_POINTER(aDaysToKeepBodies);</span>
<a href="#l12.7227"></a><span id="l12.7227">   *aDaysToKeepBodies = m_daysToKeepBodies;</span>
<a href="#l12.7228"></a><span id="l12.7228">   return NS_OK;</span>
<a href="#l12.7229"></a><span id="l12.7229"> }</span>
<a href="#l12.7230"></a><span id="l12.7230" class="difflineminus">-NS_IMETHODIMP nsMsgRetentionSettings::SetDaysToKeepBodies(uint32_t aDaysToKeepBodies)</span>
<a href="#l12.7231"></a><span id="l12.7231" class="difflineminus">-{</span>
<a href="#l12.7232"></a><span id="l12.7232" class="difflineplus">+NS_IMETHODIMP nsMsgRetentionSettings::SetDaysToKeepBodies(</span>
<a href="#l12.7233"></a><span id="l12.7233" class="difflineplus">+    uint32_t aDaysToKeepBodies) {</span>
<a href="#l12.7234"></a><span id="l12.7234">   m_daysToKeepBodies = aDaysToKeepBodies;</span>
<a href="#l12.7235"></a><span id="l12.7235">   return NS_OK;</span>
<a href="#l12.7236"></a><span id="l12.7236"> }</span>
<a href="#l12.7237"></a><span id="l12.7237"> </span>
<a href="#l12.7238"></a><span id="l12.7238"> /* attribute boolean applyToFlaggedMessages; */</span>
<a href="#l12.7239"></a><span id="l12.7239" class="difflineminus">-NS_IMETHODIMP nsMsgRetentionSettings::GetApplyToFlaggedMessages(bool *aApplyToFlaggedMessages)</span>
<a href="#l12.7240"></a><span id="l12.7240" class="difflineminus">-{</span>
<a href="#l12.7241"></a><span id="l12.7241" class="difflineplus">+NS_IMETHODIMP nsMsgRetentionSettings::GetApplyToFlaggedMessages(</span>
<a href="#l12.7242"></a><span id="l12.7242" class="difflineplus">+    bool *aApplyToFlaggedMessages) {</span>
<a href="#l12.7243"></a><span id="l12.7243">   NS_ENSURE_ARG_POINTER(aApplyToFlaggedMessages);</span>
<a href="#l12.7244"></a><span id="l12.7244">   *aApplyToFlaggedMessages = m_applyToFlaggedMessages;</span>
<a href="#l12.7245"></a><span id="l12.7245">   return NS_OK;</span>
<a href="#l12.7246"></a><span id="l12.7246"> }</span>
<a href="#l12.7247"></a><span id="l12.7247" class="difflineminus">-NS_IMETHODIMP nsMsgRetentionSettings::SetApplyToFlaggedMessages(bool aApplyToFlaggedMessages)</span>
<a href="#l12.7248"></a><span id="l12.7248" class="difflineminus">-{</span>
<a href="#l12.7249"></a><span id="l12.7249" class="difflineplus">+NS_IMETHODIMP nsMsgRetentionSettings::SetApplyToFlaggedMessages(</span>
<a href="#l12.7250"></a><span id="l12.7250" class="difflineplus">+    bool aApplyToFlaggedMessages) {</span>
<a href="#l12.7251"></a><span id="l12.7251">   m_applyToFlaggedMessages = aApplyToFlaggedMessages;</span>
<a href="#l12.7252"></a><span id="l12.7252">   return NS_OK;</span>
<a href="#l12.7253"></a><span id="l12.7253"> }</span>
<a href="#l12.7254"></a><span id="l12.7254"> </span>
<a href="#l12.7255"></a><span id="l12.7255"> NS_IMPL_ISUPPORTS(nsMsgDownloadSettings, nsIMsgDownloadSettings)</span>
<a href="#l12.7256"></a><span id="l12.7256"> </span>
<a href="#l12.7257"></a><span id="l12.7257" class="difflineminus">-nsMsgDownloadSettings::nsMsgDownloadSettings()</span>
<a href="#l12.7258"></a><span id="l12.7258" class="difflineminus">-{</span>
<a href="#l12.7259"></a><span id="l12.7259" class="difflineplus">+nsMsgDownloadSettings::nsMsgDownloadSettings() {</span>
<a href="#l12.7260"></a><span id="l12.7260">   m_useServerDefaults = false;</span>
<a href="#l12.7261"></a><span id="l12.7261">   m_downloadUnreadOnly = false;</span>
<a href="#l12.7262"></a><span id="l12.7262">   m_downloadByDate = false;</span>
<a href="#l12.7263"></a><span id="l12.7263">   m_ageLimitOfMsgsToDownload = 0;</span>
<a href="#l12.7264"></a><span id="l12.7264"> }</span>
<a href="#l12.7265"></a><span id="l12.7265"> </span>
<a href="#l12.7266"></a><span id="l12.7266" class="difflineminus">-nsMsgDownloadSettings::~nsMsgDownloadSettings()</span>
<a href="#l12.7267"></a><span id="l12.7267" class="difflineminus">-{</span>
<a href="#l12.7268"></a><span id="l12.7268" class="difflineminus">-}</span>
<a href="#l12.7269"></a><span id="l12.7269" class="difflineplus">+nsMsgDownloadSettings::~nsMsgDownloadSettings() {}</span>
<a href="#l12.7270"></a><span id="l12.7270"> </span>
<a href="#l12.7271"></a><span id="l12.7271"> /* attribute boolean useServerDefaults; */</span>
<a href="#l12.7272"></a><span id="l12.7272" class="difflineminus">-NS_IMETHODIMP nsMsgDownloadSettings::GetUseServerDefaults(bool *aUseServerDefaults)</span>
<a href="#l12.7273"></a><span id="l12.7273" class="difflineminus">-{</span>
<a href="#l12.7274"></a><span id="l12.7274" class="difflineplus">+NS_IMETHODIMP nsMsgDownloadSettings::GetUseServerDefaults(</span>
<a href="#l12.7275"></a><span id="l12.7275" class="difflineplus">+    bool *aUseServerDefaults) {</span>
<a href="#l12.7276"></a><span id="l12.7276">   NS_ENSURE_ARG_POINTER(aUseServerDefaults);</span>
<a href="#l12.7277"></a><span id="l12.7277">   *aUseServerDefaults = m_useServerDefaults;</span>
<a href="#l12.7278"></a><span id="l12.7278">   return NS_OK;</span>
<a href="#l12.7279"></a><span id="l12.7279"> }</span>
<a href="#l12.7280"></a><span id="l12.7280" class="difflineminus">-NS_IMETHODIMP nsMsgDownloadSettings::SetUseServerDefaults(bool aUseServerDefaults)</span>
<a href="#l12.7281"></a><span id="l12.7281" class="difflineminus">-{</span>
<a href="#l12.7282"></a><span id="l12.7282" class="difflineplus">+NS_IMETHODIMP nsMsgDownloadSettings::SetUseServerDefaults(</span>
<a href="#l12.7283"></a><span id="l12.7283" class="difflineplus">+    bool aUseServerDefaults) {</span>
<a href="#l12.7284"></a><span id="l12.7284">   m_useServerDefaults = aUseServerDefaults;</span>
<a href="#l12.7285"></a><span id="l12.7285">   return NS_OK;</span>
<a href="#l12.7286"></a><span id="l12.7286"> }</span>
<a href="#l12.7287"></a><span id="l12.7287"> </span>
<a href="#l12.7288"></a><span id="l12.7288" class="difflineminus">-</span>
<a href="#l12.7289"></a><span id="l12.7289"> /* attribute boolean downloadUnreadOnly; */</span>
<a href="#l12.7290"></a><span id="l12.7290" class="difflineminus">-NS_IMETHODIMP nsMsgDownloadSettings::GetDownloadUnreadOnly(bool *aDownloadUnreadOnly)</span>
<a href="#l12.7291"></a><span id="l12.7291" class="difflineminus">-{</span>
<a href="#l12.7292"></a><span id="l12.7292" class="difflineplus">+NS_IMETHODIMP nsMsgDownloadSettings::GetDownloadUnreadOnly(</span>
<a href="#l12.7293"></a><span id="l12.7293" class="difflineplus">+    bool *aDownloadUnreadOnly) {</span>
<a href="#l12.7294"></a><span id="l12.7294">   NS_ENSURE_ARG_POINTER(aDownloadUnreadOnly);</span>
<a href="#l12.7295"></a><span id="l12.7295">   *aDownloadUnreadOnly = m_downloadUnreadOnly;</span>
<a href="#l12.7296"></a><span id="l12.7296">   return NS_OK;</span>
<a href="#l12.7297"></a><span id="l12.7297"> }</span>
<a href="#l12.7298"></a><span id="l12.7298" class="difflineminus">-NS_IMETHODIMP nsMsgDownloadSettings::SetDownloadUnreadOnly(bool aDownloadUnreadOnly)</span>
<a href="#l12.7299"></a><span id="l12.7299" class="difflineminus">-{</span>
<a href="#l12.7300"></a><span id="l12.7300" class="difflineplus">+NS_IMETHODIMP nsMsgDownloadSettings::SetDownloadUnreadOnly(</span>
<a href="#l12.7301"></a><span id="l12.7301" class="difflineplus">+    bool aDownloadUnreadOnly) {</span>
<a href="#l12.7302"></a><span id="l12.7302">   m_downloadUnreadOnly = aDownloadUnreadOnly;</span>
<a href="#l12.7303"></a><span id="l12.7303">   return NS_OK;</span>
<a href="#l12.7304"></a><span id="l12.7304"> }</span>
<a href="#l12.7305"></a><span id="l12.7305"> </span>
<a href="#l12.7306"></a><span id="l12.7306"> /* attribute boolean downloadByDate; */</span>
<a href="#l12.7307"></a><span id="l12.7307" class="difflineminus">-NS_IMETHODIMP nsMsgDownloadSettings::GetDownloadByDate(bool *aDownloadByDate)</span>
<a href="#l12.7308"></a><span id="l12.7308" class="difflineminus">-{</span>
<a href="#l12.7309"></a><span id="l12.7309" class="difflineplus">+NS_IMETHODIMP nsMsgDownloadSettings::GetDownloadByDate(bool *aDownloadByDate) {</span>
<a href="#l12.7310"></a><span id="l12.7310">   NS_ENSURE_ARG_POINTER(aDownloadByDate);</span>
<a href="#l12.7311"></a><span id="l12.7311">   *aDownloadByDate = m_downloadByDate;</span>
<a href="#l12.7312"></a><span id="l12.7312">   return NS_OK;</span>
<a href="#l12.7313"></a><span id="l12.7313"> }</span>
<a href="#l12.7314"></a><span id="l12.7314"> </span>
<a href="#l12.7315"></a><span id="l12.7315" class="difflineminus">-NS_IMETHODIMP nsMsgDownloadSettings::SetDownloadByDate(bool aDownloadByDate)</span>
<a href="#l12.7316"></a><span id="l12.7316" class="difflineminus">-{</span>
<a href="#l12.7317"></a><span id="l12.7317" class="difflineplus">+NS_IMETHODIMP nsMsgDownloadSettings::SetDownloadByDate(bool aDownloadByDate) {</span>
<a href="#l12.7318"></a><span id="l12.7318">   m_downloadByDate = aDownloadByDate;</span>
<a href="#l12.7319"></a><span id="l12.7319">   return NS_OK;</span>
<a href="#l12.7320"></a><span id="l12.7320"> }</span>
<a href="#l12.7321"></a><span id="l12.7321"> </span>
<a href="#l12.7322"></a><span id="l12.7322" class="difflineminus">-</span>
<a href="#l12.7323"></a><span id="l12.7323"> /* attribute long ageLimitOfMsgsToDownload; */</span>
<a href="#l12.7324"></a><span id="l12.7324" class="difflineminus">-NS_IMETHODIMP nsMsgDownloadSettings::GetAgeLimitOfMsgsToDownload(uint32_t *ageLimitOfMsgsToDownload)</span>
<a href="#l12.7325"></a><span id="l12.7325" class="difflineminus">-{</span>
<a href="#l12.7326"></a><span id="l12.7326" class="difflineplus">+NS_IMETHODIMP nsMsgDownloadSettings::GetAgeLimitOfMsgsToDownload(</span>
<a href="#l12.7327"></a><span id="l12.7327" class="difflineplus">+    uint32_t *ageLimitOfMsgsToDownload) {</span>
<a href="#l12.7328"></a><span id="l12.7328">   NS_ENSURE_ARG_POINTER(ageLimitOfMsgsToDownload);</span>
<a href="#l12.7329"></a><span id="l12.7329">   *ageLimitOfMsgsToDownload = m_ageLimitOfMsgsToDownload;</span>
<a href="#l12.7330"></a><span id="l12.7330">   return NS_OK;</span>
<a href="#l12.7331"></a><span id="l12.7331"> }</span>
<a href="#l12.7332"></a><span id="l12.7332" class="difflineminus">-NS_IMETHODIMP nsMsgDownloadSettings::SetAgeLimitOfMsgsToDownload(uint32_t ageLimitOfMsgsToDownload)</span>
<a href="#l12.7333"></a><span id="l12.7333" class="difflineminus">-{</span>
<a href="#l12.7334"></a><span id="l12.7334" class="difflineplus">+NS_IMETHODIMP nsMsgDownloadSettings::SetAgeLimitOfMsgsToDownload(</span>
<a href="#l12.7335"></a><span id="l12.7335" class="difflineplus">+    uint32_t ageLimitOfMsgsToDownload) {</span>
<a href="#l12.7336"></a><span id="l12.7336">   m_ageLimitOfMsgsToDownload = ageLimitOfMsgsToDownload;</span>
<a href="#l12.7337"></a><span id="l12.7337">   return NS_OK;</span>
<a href="#l12.7338"></a><span id="l12.7338"> }</span>
<a href="#l12.7339"></a><span id="l12.7339"> </span>
<a href="#l12.7340"></a><span id="l12.7340" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetDefaultViewFlags(nsMsgViewFlagsTypeValue *aDefaultViewFlags)</span>
<a href="#l12.7341"></a><span id="l12.7341" class="difflineminus">-{</span>
<a href="#l12.7342"></a><span id="l12.7342" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetDefaultViewFlags(</span>
<a href="#l12.7343"></a><span id="l12.7343" class="difflineplus">+    nsMsgViewFlagsTypeValue *aDefaultViewFlags) {</span>
<a href="#l12.7344"></a><span id="l12.7344">   NS_ENSURE_ARG_POINTER(aDefaultViewFlags);</span>
<a href="#l12.7345"></a><span id="l12.7345">   GetIntPref(&quot;mailnews.default_view_flags&quot;, aDefaultViewFlags);</span>
<a href="#l12.7346"></a><span id="l12.7346">   if (*aDefaultViewFlags &lt; nsMsgViewFlagsType::kNone ||</span>
<a href="#l12.7347"></a><span id="l12.7347" class="difflineminus">-      *aDefaultViewFlags &gt; (nsMsgViewFlagsType::kThreadedDisplay |</span>
<a href="#l12.7348"></a><span id="l12.7348" class="difflineminus">-                            nsMsgViewFlagsType::kShowIgnored |</span>
<a href="#l12.7349"></a><span id="l12.7349" class="difflineminus">-                            nsMsgViewFlagsType::kUnreadOnly |</span>
<a href="#l12.7350"></a><span id="l12.7350" class="difflineminus">-                            nsMsgViewFlagsType::kExpandAll |</span>
<a href="#l12.7351"></a><span id="l12.7351" class="difflineminus">-                            nsMsgViewFlagsType::kGroupBySort))</span>
<a href="#l12.7352"></a><span id="l12.7352" class="difflineplus">+      *aDefaultViewFlags &gt;</span>
<a href="#l12.7353"></a><span id="l12.7353" class="difflineplus">+          (nsMsgViewFlagsType::kThreadedDisplay |</span>
<a href="#l12.7354"></a><span id="l12.7354" class="difflineplus">+           nsMsgViewFlagsType::kShowIgnored | nsMsgViewFlagsType::kUnreadOnly |</span>
<a href="#l12.7355"></a><span id="l12.7355" class="difflineplus">+           nsMsgViewFlagsType::kExpandAll | nsMsgViewFlagsType::kGroupBySort))</span>
<a href="#l12.7356"></a><span id="l12.7356">     *aDefaultViewFlags = nsMsgViewFlagsType::kNone;</span>
<a href="#l12.7357"></a><span id="l12.7357">   return NS_OK;</span>
<a href="#l12.7358"></a><span id="l12.7358"> }</span>
<a href="#l12.7359"></a><span id="l12.7359"> </span>
<a href="#l12.7360"></a><span id="l12.7360" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetDefaultSortType(nsMsgViewSortTypeValue *aDefaultSortType)</span>
<a href="#l12.7361"></a><span id="l12.7361" class="difflineminus">-{</span>
<a href="#l12.7362"></a><span id="l12.7362" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetDefaultSortType(</span>
<a href="#l12.7363"></a><span id="l12.7363" class="difflineplus">+    nsMsgViewSortTypeValue *aDefaultSortType) {</span>
<a href="#l12.7364"></a><span id="l12.7364">   NS_ENSURE_ARG_POINTER(aDefaultSortType);</span>
<a href="#l12.7365"></a><span id="l12.7365">   GetIntPref(&quot;mailnews.default_sort_type&quot;, aDefaultSortType);</span>
<a href="#l12.7366"></a><span id="l12.7366">   if (*aDefaultSortType &lt; nsMsgViewSortType::byDate ||</span>
<a href="#l12.7367"></a><span id="l12.7367">       *aDefaultSortType &gt; nsMsgViewSortType::byAccount)</span>
<a href="#l12.7368"></a><span id="l12.7368">     *aDefaultSortType = nsMsgViewSortType::byDate;</span>
<a href="#l12.7369"></a><span id="l12.7369">   return NS_OK;</span>
<a href="#l12.7370"></a><span id="l12.7370"> }</span>
<a href="#l12.7371"></a><span id="l12.7371"> </span>
<a href="#l12.7372"></a><span id="l12.7372" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetDefaultSortOrder(nsMsgViewSortOrderValue *aDefaultSortOrder)</span>
<a href="#l12.7373"></a><span id="l12.7373" class="difflineminus">-{</span>
<a href="#l12.7374"></a><span id="l12.7374" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::GetDefaultSortOrder(</span>
<a href="#l12.7375"></a><span id="l12.7375" class="difflineplus">+    nsMsgViewSortOrderValue *aDefaultSortOrder) {</span>
<a href="#l12.7376"></a><span id="l12.7376">   NS_ENSURE_ARG_POINTER(aDefaultSortOrder);</span>
<a href="#l12.7377"></a><span id="l12.7377">   GetIntPref(&quot;mailnews.default_sort_order&quot;, aDefaultSortOrder);</span>
<a href="#l12.7378"></a><span id="l12.7378">   if (*aDefaultSortOrder != nsMsgViewSortOrder::descending)</span>
<a href="#l12.7379"></a><span id="l12.7379">     *aDefaultSortOrder = nsMsgViewSortOrder::ascending;</span>
<a href="#l12.7380"></a><span id="l12.7380">   return NS_OK;</span>
<a href="#l12.7381"></a><span id="l12.7381"> }</span>
<a href="#l12.7382"></a><span id="l12.7382"> </span>
<a href="#l12.7383"></a><span id="l12.7383" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::ResetHdrCacheSize(uint32_t aSize)</span>
<a href="#l12.7384"></a><span id="l12.7384" class="difflineminus">-{</span>
<a href="#l12.7385"></a><span id="l12.7385" class="difflineminus">-  if (m_cacheSize &gt; aSize)</span>
<a href="#l12.7386"></a><span id="l12.7386" class="difflineminus">-  {</span>
<a href="#l12.7387"></a><span id="l12.7387" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::ResetHdrCacheSize(uint32_t aSize) {</span>
<a href="#l12.7388"></a><span id="l12.7388" class="difflineplus">+  if (m_cacheSize &gt; aSize) {</span>
<a href="#l12.7389"></a><span id="l12.7389">     m_cacheSize = aSize;</span>
<a href="#l12.7390"></a><span id="l12.7390">     ClearHdrCache(false);</span>
<a href="#l12.7391"></a><span id="l12.7391">   }</span>
<a href="#l12.7392"></a><span id="l12.7392">   return NS_OK;</span>
<a href="#l12.7393"></a><span id="l12.7393"> }</span>
<a href="#l12.7394"></a><span id="l12.7394"> </span>
<a href="#l12.7395"></a><span id="l12.7395"> /**</span>
<a href="#l12.7396"></a><span id="l12.7396" class="difflineminus">-  void getNewList(out unsigned long count, [array, size_is(count)] out long newKeys);</span>
<a href="#l12.7397"></a><span id="l12.7397" class="difflineplus">+  void getNewList(out unsigned long count, [array, size_is(count)] out long</span>
<a href="#l12.7398"></a><span id="l12.7398" class="difflineplus">+  newKeys);</span>
<a href="#l12.7399"></a><span id="l12.7399">  */</span>
<a href="#l12.7400"></a><span id="l12.7400"> NS_IMETHODIMP</span>
<a href="#l12.7401"></a><span id="l12.7401" class="difflineminus">-nsMsgDatabase::GetNewList(uint32_t *aCount, nsMsgKey **aNewKeys)</span>
<a href="#l12.7402"></a><span id="l12.7402" class="difflineminus">-{</span>
<a href="#l12.7403"></a><span id="l12.7403" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l12.7404"></a><span id="l12.7404" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aNewKeys);</span>
<a href="#l12.7405"></a><span id="l12.7405" class="difflineminus">-</span>
<a href="#l12.7406"></a><span id="l12.7406" class="difflineminus">-    *aCount = m_newSet.Length();</span>
<a href="#l12.7407"></a><span id="l12.7407" class="difflineminus">-    if (*aCount &gt; 0)</span>
<a href="#l12.7408"></a><span id="l12.7408" class="difflineminus">-    {</span>
<a href="#l12.7409"></a><span id="l12.7409" class="difflineminus">-      *aNewKeys = static_cast&lt;nsMsgKey *&gt;(moz_xmalloc(*aCount * sizeof(nsMsgKey)));</span>
<a href="#l12.7410"></a><span id="l12.7410" class="difflineminus">-      if (!*aNewKeys)</span>
<a href="#l12.7411"></a><span id="l12.7411" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.7412"></a><span id="l12.7412" class="difflineminus">-      memcpy(*aNewKeys, m_newSet.Elements(), *aCount * sizeof(nsMsgKey));</span>
<a href="#l12.7413"></a><span id="l12.7413" class="difflineminus">-      return NS_OK;</span>
<a href="#l12.7414"></a><span id="l12.7414" class="difflineminus">-    }</span>
<a href="#l12.7415"></a><span id="l12.7415" class="difflineminus">-    // if there were no new messages, signal this by returning a null pointer</span>
<a href="#l12.7416"></a><span id="l12.7416" class="difflineminus">-    //</span>
<a href="#l12.7417"></a><span id="l12.7417" class="difflineminus">-    *aNewKeys = nullptr;</span>
<a href="#l12.7418"></a><span id="l12.7418" class="difflineplus">+nsMsgDatabase::GetNewList(uint32_t *aCount, nsMsgKey **aNewKeys) {</span>
<a href="#l12.7419"></a><span id="l12.7419" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l12.7420"></a><span id="l12.7420" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNewKeys);</span>
<a href="#l12.7421"></a><span id="l12.7421" class="difflineplus">+</span>
<a href="#l12.7422"></a><span id="l12.7422" class="difflineplus">+  *aCount = m_newSet.Length();</span>
<a href="#l12.7423"></a><span id="l12.7423" class="difflineplus">+  if (*aCount &gt; 0) {</span>
<a href="#l12.7424"></a><span id="l12.7424" class="difflineplus">+    *aNewKeys =</span>
<a href="#l12.7425"></a><span id="l12.7425" class="difflineplus">+        static_cast&lt;nsMsgKey *&gt;(moz_xmalloc(*aCount * sizeof(nsMsgKey)));</span>
<a href="#l12.7426"></a><span id="l12.7426" class="difflineplus">+    if (!*aNewKeys) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.7427"></a><span id="l12.7427" class="difflineplus">+    memcpy(*aNewKeys, m_newSet.Elements(), *aCount * sizeof(nsMsgKey));</span>
<a href="#l12.7428"></a><span id="l12.7428">     return NS_OK;</span>
<a href="#l12.7429"></a><span id="l12.7429" class="difflineminus">-}</span>
<a href="#l12.7430"></a><span id="l12.7430" class="difflineminus">-</span>
<a href="#l12.7431"></a><span id="l12.7431" class="difflineminus">-nsresult nsMsgDatabase::GetSearchResultsTable(const char *searchFolderUri, bool createIfMissing, nsIMdbTable **table)</span>
<a href="#l12.7432"></a><span id="l12.7432" class="difflineminus">-{</span>
<a href="#l12.7433"></a><span id="l12.7433" class="difflineplus">+  }</span>
<a href="#l12.7434"></a><span id="l12.7434" class="difflineplus">+  // if there were no new messages, signal this by returning a null pointer</span>
<a href="#l12.7435"></a><span id="l12.7435" class="difflineplus">+  //</span>
<a href="#l12.7436"></a><span id="l12.7436" class="difflineplus">+  *aNewKeys = nullptr;</span>
<a href="#l12.7437"></a><span id="l12.7437" class="difflineplus">+  return NS_OK;</span>
<a href="#l12.7438"></a><span id="l12.7438" class="difflineplus">+}</span>
<a href="#l12.7439"></a><span id="l12.7439" class="difflineplus">+</span>
<a href="#l12.7440"></a><span id="l12.7440" class="difflineplus">+nsresult nsMsgDatabase::GetSearchResultsTable(const char *searchFolderUri,</span>
<a href="#l12.7441"></a><span id="l12.7441" class="difflineplus">+                                              bool createIfMissing,</span>
<a href="#l12.7442"></a><span id="l12.7442" class="difflineplus">+                                              nsIMdbTable **table) {</span>
<a href="#l12.7443"></a><span id="l12.7443">   mdb_kind kindToken;</span>
<a href="#l12.7444"></a><span id="l12.7444">   mdb_count numTables;</span>
<a href="#l12.7445"></a><span id="l12.7445">   mdb_bool mustBeUnique;</span>
<a href="#l12.7446"></a><span id="l12.7446">   NS_ENSURE_TRUE(m_mdbStore, NS_ERROR_NULL_POINTER);</span>
<a href="#l12.7447"></a><span id="l12.7447"> </span>
<a href="#l12.7448"></a><span id="l12.7448" class="difflineminus">-  nsresult err = m_mdbStore-&gt;StringToToken(GetEnv(), searchFolderUri, &amp;kindToken);</span>
<a href="#l12.7449"></a><span id="l12.7449" class="difflineminus">-  err = m_mdbStore-&gt;GetTableKind(GetEnv(), m_hdrRowScopeToken,  kindToken,</span>
<a href="#l12.7450"></a><span id="l12.7450" class="difflineminus">-                                  &amp;numTables, &amp;mustBeUnique, table);</span>
<a href="#l12.7451"></a><span id="l12.7451" class="difflineplus">+  nsresult err =</span>
<a href="#l12.7452"></a><span id="l12.7452" class="difflineplus">+      m_mdbStore-&gt;StringToToken(GetEnv(), searchFolderUri, &amp;kindToken);</span>
<a href="#l12.7453"></a><span id="l12.7453" class="difflineplus">+  err = m_mdbStore-&gt;GetTableKind(GetEnv(), m_hdrRowScopeToken, kindToken,</span>
<a href="#l12.7454"></a><span id="l12.7454" class="difflineplus">+                                 &amp;numTables, &amp;mustBeUnique, table);</span>
<a href="#l12.7455"></a><span id="l12.7455">   if ((!*table || NS_FAILED(err)) &amp;&amp; createIfMissing)</span>
<a href="#l12.7456"></a><span id="l12.7456" class="difflineminus">-    err = m_mdbStore-&gt;NewTable(GetEnv(), m_hdrRowScopeToken, kindToken, true, nullptr, table);</span>
<a href="#l12.7457"></a><span id="l12.7457" class="difflineplus">+    err = m_mdbStore-&gt;NewTable(GetEnv(), m_hdrRowScopeToken, kindToken, true,</span>
<a href="#l12.7458"></a><span id="l12.7458" class="difflineplus">+                               nullptr, table);</span>
<a href="#l12.7459"></a><span id="l12.7459"> </span>
<a href="#l12.7460"></a><span id="l12.7460">   return *table ? err : NS_ERROR_FAILURE;</span>
<a href="#l12.7461"></a><span id="l12.7461"> }</span>
<a href="#l12.7462"></a><span id="l12.7462"> </span>
<a href="#l12.7463"></a><span id="l12.7463"> NS_IMETHODIMP</span>
<a href="#l12.7464"></a><span id="l12.7464" class="difflineminus">-nsMsgDatabase::GetCachedHits(const char *aSearchFolderUri, nsISimpleEnumerator **aEnumerator)</span>
<a href="#l12.7465"></a><span id="l12.7465" class="difflineminus">-{</span>
<a href="#l12.7466"></a><span id="l12.7466" class="difflineminus">-  nsCOMPtr &lt;nsIMdbTable&gt; table;</span>
<a href="#l12.7467"></a><span id="l12.7467" class="difflineminus">-  (void) GetSearchResultsTable(aSearchFolderUri, false, getter_AddRefs(table));</span>
<a href="#l12.7468"></a><span id="l12.7468" class="difflineminus">-  if (!table)</span>
<a href="#l12.7469"></a><span id="l12.7469" class="difflineminus">-    return NS_ERROR_FAILURE; // expected result for no cached hits</span>
<a href="#l12.7470"></a><span id="l12.7470" class="difflineminus">-  NS_ADDREF(*aEnumerator = new nsMsgDBEnumerator(this, table, nullptr, nullptr));</span>
<a href="#l12.7471"></a><span id="l12.7471" class="difflineplus">+nsMsgDatabase::GetCachedHits(const char *aSearchFolderUri,</span>
<a href="#l12.7472"></a><span id="l12.7472" class="difflineplus">+                             nsISimpleEnumerator **aEnumerator) {</span>
<a href="#l12.7473"></a><span id="l12.7473" class="difflineplus">+  nsCOMPtr&lt;nsIMdbTable&gt; table;</span>
<a href="#l12.7474"></a><span id="l12.7474" class="difflineplus">+  (void)GetSearchResultsTable(aSearchFolderUri, false, getter_AddRefs(table));</span>
<a href="#l12.7475"></a><span id="l12.7475" class="difflineplus">+  if (!table) return NS_ERROR_FAILURE;  // expected result for no cached hits</span>
<a href="#l12.7476"></a><span id="l12.7476" class="difflineplus">+  NS_ADDREF(*aEnumerator =</span>
<a href="#l12.7477"></a><span id="l12.7477" class="difflineplus">+                new nsMsgDBEnumerator(this, table, nullptr, nullptr));</span>
<a href="#l12.7478"></a><span id="l12.7478">   return NS_OK;</span>
<a href="#l12.7479"></a><span id="l12.7479"> }</span>
<a href="#l12.7480"></a><span id="l12.7480"> </span>
<a href="#l12.7481"></a><span id="l12.7481" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::RefreshCache(const char *aSearchFolderUri, uint32_t aNumKeys, nsMsgKey *aNewHits, uint32_t *aNumBadHits, nsMsgKey **aStaleHits)</span>
<a href="#l12.7482"></a><span id="l12.7482" class="difflineminus">-{</span>
<a href="#l12.7483"></a><span id="l12.7483" class="difflineminus">-  nsCOMPtr &lt;nsIMdbTable&gt; table;</span>
<a href="#l12.7484"></a><span id="l12.7484" class="difflineminus">-  nsresult err = GetSearchResultsTable(aSearchFolderUri, true, getter_AddRefs(table));</span>
<a href="#l12.7485"></a><span id="l12.7485" class="difflineplus">+NS_IMETHODIMP nsMsgDatabase::RefreshCache(const char *aSearchFolderUri,</span>
<a href="#l12.7486"></a><span id="l12.7486" class="difflineplus">+                                          uint32_t aNumKeys, nsMsgKey *aNewHits,</span>
<a href="#l12.7487"></a><span id="l12.7487" class="difflineplus">+                                          uint32_t *aNumBadHits,</span>
<a href="#l12.7488"></a><span id="l12.7488" class="difflineplus">+                                          nsMsgKey **aStaleHits) {</span>
<a href="#l12.7489"></a><span id="l12.7489" class="difflineplus">+  nsCOMPtr&lt;nsIMdbTable&gt; table;</span>
<a href="#l12.7490"></a><span id="l12.7490" class="difflineplus">+  nsresult err =</span>
<a href="#l12.7491"></a><span id="l12.7491" class="difflineplus">+      GetSearchResultsTable(aSearchFolderUri, true, getter_AddRefs(table));</span>
<a href="#l12.7492"></a><span id="l12.7492">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l12.7493"></a><span id="l12.7493">   // update the table so that it just contains aNewHits.</span>
<a href="#l12.7494"></a><span id="l12.7494" class="difflineminus">-  // And, keep track of the headers in the original table but not in aNewHits, so we</span>
<a href="#l12.7495"></a><span id="l12.7495" class="difflineminus">-  // can put those in aStaleHits.</span>
<a href="#l12.7496"></a><span id="l12.7496" class="difflineminus">-  // both aNewHits and the db table are sorted by uid/key.</span>
<a href="#l12.7497"></a><span id="l12.7497" class="difflineminus">-  // So, start at the beginning of the table and the aNewHits array.</span>
<a href="#l12.7498"></a><span id="l12.7498" class="difflineplus">+  // And, keep track of the headers in the original table but not in aNewHits,</span>
<a href="#l12.7499"></a><span id="l12.7499" class="difflineplus">+  // so we can put those in aStaleHits. both aNewHits and the db table are</span>
<a href="#l12.7500"></a><span id="l12.7500" class="difflineplus">+  // sorted by uid/key. So, start at the beginning of the table and the aNewHits</span>
<a href="#l12.7501"></a><span id="l12.7501" class="difflineplus">+  // array.</span>
<a href="#l12.7502"></a><span id="l12.7502">   uint32_t newHitIndex = 0;</span>
<a href="#l12.7503"></a><span id="l12.7503">   uint32_t tableRowIndex = 0;</span>
<a href="#l12.7504"></a><span id="l12.7504"> </span>
<a href="#l12.7505"></a><span id="l12.7505">   uint32_t rowCount;</span>
<a href="#l12.7506"></a><span id="l12.7506">   table-&gt;GetCount(GetEnv(), &amp;rowCount);</span>
<a href="#l12.7507"></a><span id="l12.7507">   nsTArray&lt;nsMsgKey&gt; staleHits;</span>
<a href="#l12.7508"></a><span id="l12.7508">   // should assert that each array is sorted</span>
<a href="#l12.7509"></a><span id="l12.7509" class="difflineminus">-  while (newHitIndex &lt; aNumKeys || tableRowIndex &lt; rowCount)</span>
<a href="#l12.7510"></a><span id="l12.7510" class="difflineminus">-  {</span>
<a href="#l12.7511"></a><span id="l12.7511" class="difflineplus">+  while (newHitIndex &lt; aNumKeys || tableRowIndex &lt; rowCount) {</span>
<a href="#l12.7512"></a><span id="l12.7512">     mdbOid oid;</span>
<a href="#l12.7513"></a><span id="l12.7513">     nsMsgKey tableRowKey = nsMsgKey_None;</span>
<a href="#l12.7514"></a><span id="l12.7514" class="difflineminus">-    if (tableRowIndex &lt; rowCount)</span>
<a href="#l12.7515"></a><span id="l12.7515" class="difflineminus">-    {</span>
<a href="#l12.7516"></a><span id="l12.7516" class="difflineminus">-      nsresult ret = table-&gt;PosToOid (GetEnv(), tableRowIndex, &amp;oid);</span>
<a href="#l12.7517"></a><span id="l12.7517" class="difflineminus">-      if (NS_FAILED(ret))</span>
<a href="#l12.7518"></a><span id="l12.7518" class="difflineminus">-      {</span>
<a href="#l12.7519"></a><span id="l12.7519" class="difflineplus">+    if (tableRowIndex &lt; rowCount) {</span>
<a href="#l12.7520"></a><span id="l12.7520" class="difflineplus">+      nsresult ret = table-&gt;PosToOid(GetEnv(), tableRowIndex, &amp;oid);</span>
<a href="#l12.7521"></a><span id="l12.7521" class="difflineplus">+      if (NS_FAILED(ret)) {</span>
<a href="#l12.7522"></a><span id="l12.7522">         tableRowIndex++;</span>
<a href="#l12.7523"></a><span id="l12.7523">         continue;</span>
<a href="#l12.7524"></a><span id="l12.7524">       }</span>
<a href="#l12.7525"></a><span id="l12.7525" class="difflineminus">-      tableRowKey = oid.mOid_Id;  // ### TODO need the real key for the 0th key problem.</span>
<a href="#l12.7526"></a><span id="l12.7526" class="difflineplus">+      tableRowKey =</span>
<a href="#l12.7527"></a><span id="l12.7527" class="difflineplus">+          oid.mOid_Id;  // ### TODO need the real key for the 0th key problem.</span>
<a href="#l12.7528"></a><span id="l12.7528">     }</span>
<a href="#l12.7529"></a><span id="l12.7529"> </span>
<a href="#l12.7530"></a><span id="l12.7530" class="difflineminus">-    if (newHitIndex &lt; aNumKeys &amp;&amp; aNewHits[newHitIndex] == tableRowKey)</span>
<a href="#l12.7531"></a><span id="l12.7531" class="difflineminus">-    {</span>
<a href="#l12.7532"></a><span id="l12.7532" class="difflineplus">+    if (newHitIndex &lt; aNumKeys &amp;&amp; aNewHits[newHitIndex] == tableRowKey) {</span>
<a href="#l12.7533"></a><span id="l12.7533">       newHitIndex++;</span>
<a href="#l12.7534"></a><span id="l12.7534">       tableRowIndex++;</span>
<a href="#l12.7535"></a><span id="l12.7535">       continue;</span>
<a href="#l12.7536"></a><span id="l12.7536" class="difflineminus">-    }</span>
<a href="#l12.7537"></a><span id="l12.7537" class="difflineminus">-    else if (tableRowIndex &gt;= rowCount || (newHitIndex &lt; aNumKeys &amp;&amp; aNewHits[newHitIndex] &lt; tableRowKey))</span>
<a href="#l12.7538"></a><span id="l12.7538" class="difflineminus">-    {</span>
<a href="#l12.7539"></a><span id="l12.7539" class="difflineminus">-      nsCOMPtr &lt;nsIMdbRow&gt; hdrRow;</span>
<a href="#l12.7540"></a><span id="l12.7540" class="difflineplus">+    } else if (tableRowIndex &gt;= rowCount ||</span>
<a href="#l12.7541"></a><span id="l12.7541" class="difflineplus">+               (newHitIndex &lt; aNumKeys &amp;&amp;</span>
<a href="#l12.7542"></a><span id="l12.7542" class="difflineplus">+                aNewHits[newHitIndex] &lt; tableRowKey)) {</span>
<a href="#l12.7543"></a><span id="l12.7543" class="difflineplus">+      nsCOMPtr&lt;nsIMdbRow&gt; hdrRow;</span>
<a href="#l12.7544"></a><span id="l12.7544">       mdbOid rowObjectId;</span>
<a href="#l12.7545"></a><span id="l12.7545"> </span>
<a href="#l12.7546"></a><span id="l12.7546">       rowObjectId.mOid_Id = aNewHits[newHitIndex];</span>
<a href="#l12.7547"></a><span id="l12.7547">       rowObjectId.mOid_Scope = m_hdrRowScopeToken;</span>
<a href="#l12.7548"></a><span id="l12.7548">       err = m_mdbStore-&gt;GetRow(GetEnv(), &amp;rowObjectId, getter_AddRefs(hdrRow));</span>
<a href="#l12.7549"></a><span id="l12.7549" class="difflineminus">-      if (hdrRow)</span>
<a href="#l12.7550"></a><span id="l12.7550" class="difflineminus">-      {</span>
<a href="#l12.7551"></a><span id="l12.7551" class="difflineplus">+      if (hdrRow) {</span>
<a href="#l12.7552"></a><span id="l12.7552">         table-&gt;AddRow(GetEnv(), hdrRow);</span>
<a href="#l12.7553"></a><span id="l12.7553">         mdb_pos newPos;</span>
<a href="#l12.7554"></a><span id="l12.7554">         table-&gt;MoveRow(GetEnv(), hdrRow, rowCount, tableRowIndex, &amp;newPos);</span>
<a href="#l12.7555"></a><span id="l12.7555">         rowCount++;</span>
<a href="#l12.7556"></a><span id="l12.7556">         tableRowIndex++;</span>
<a href="#l12.7557"></a><span id="l12.7557">       }</span>
<a href="#l12.7558"></a><span id="l12.7558">       newHitIndex++;</span>
<a href="#l12.7559"></a><span id="l12.7559">       continue;</span>
<a href="#l12.7560"></a><span id="l12.7560" class="difflineminus">-    }</span>
<a href="#l12.7561"></a><span id="l12.7561" class="difflineminus">-    else if (newHitIndex &gt;= aNumKeys || aNewHits[newHitIndex] &gt; tableRowKey)</span>
<a href="#l12.7562"></a><span id="l12.7562" class="difflineminus">-    {</span>
<a href="#l12.7563"></a><span id="l12.7563" class="difflineplus">+    } else if (newHitIndex &gt;= aNumKeys || aNewHits[newHitIndex] &gt; tableRowKey) {</span>
<a href="#l12.7564"></a><span id="l12.7564">       staleHits.AppendElement(tableRowKey);</span>
<a href="#l12.7565"></a><span id="l12.7565">       table-&gt;CutOid(GetEnv(), &amp;oid);</span>
<a href="#l12.7566"></a><span id="l12.7566">       rowCount--;</span>
<a href="#l12.7567"></a><span id="l12.7567" class="difflineminus">-      continue; // don't increment tableRowIndex since we removed that row.</span>
<a href="#l12.7568"></a><span id="l12.7568" class="difflineplus">+      continue;  // don't increment tableRowIndex since we removed that row.</span>
<a href="#l12.7569"></a><span id="l12.7569">     }</span>
<a href="#l12.7570"></a><span id="l12.7570" class="difflineminus">-   }</span>
<a href="#l12.7571"></a><span id="l12.7571" class="difflineminus">-   *aNumBadHits = staleHits.Length();</span>
<a href="#l12.7572"></a><span id="l12.7572" class="difflineminus">-   if (*aNumBadHits)</span>
<a href="#l12.7573"></a><span id="l12.7573" class="difflineminus">-   {</span>
<a href="#l12.7574"></a><span id="l12.7574" class="difflineminus">-     *aStaleHits = static_cast&lt;nsMsgKey *&gt;(moz_xmalloc(*aNumBadHits * sizeof(nsMsgKey)));</span>
<a href="#l12.7575"></a><span id="l12.7575" class="difflineminus">-     if (!*aStaleHits)</span>
<a href="#l12.7576"></a><span id="l12.7576" class="difflineminus">-       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.7577"></a><span id="l12.7577" class="difflineminus">-     memcpy(*aStaleHits, staleHits.Elements(), *aNumBadHits * sizeof(nsMsgKey));</span>
<a href="#l12.7578"></a><span id="l12.7578" class="difflineminus">-   }</span>
<a href="#l12.7579"></a><span id="l12.7579" class="difflineminus">-   else</span>
<a href="#l12.7580"></a><span id="l12.7580" class="difflineminus">-     *aStaleHits = nullptr;</span>
<a href="#l12.7581"></a><span id="l12.7581" class="difflineplus">+  }</span>
<a href="#l12.7582"></a><span id="l12.7582" class="difflineplus">+  *aNumBadHits = staleHits.Length();</span>
<a href="#l12.7583"></a><span id="l12.7583" class="difflineplus">+  if (*aNumBadHits) {</span>
<a href="#l12.7584"></a><span id="l12.7584" class="difflineplus">+    *aStaleHits =</span>
<a href="#l12.7585"></a><span id="l12.7585" class="difflineplus">+        static_cast&lt;nsMsgKey *&gt;(moz_xmalloc(*aNumBadHits * sizeof(nsMsgKey)));</span>
<a href="#l12.7586"></a><span id="l12.7586" class="difflineplus">+    if (!*aStaleHits) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.7587"></a><span id="l12.7587" class="difflineplus">+    memcpy(*aStaleHits, staleHits.Elements(), *aNumBadHits * sizeof(nsMsgKey));</span>
<a href="#l12.7588"></a><span id="l12.7588" class="difflineplus">+  } else</span>
<a href="#l12.7589"></a><span id="l12.7589" class="difflineplus">+    *aStaleHits = nullptr;</span>
<a href="#l12.7590"></a><span id="l12.7590"> </span>
<a href="#l12.7591"></a><span id="l12.7591"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l12.7592"></a><span id="l12.7592">   printf(&quot;after refreshing cache\n&quot;);</span>
<a href="#l12.7593"></a><span id="l12.7593">   // iterate over table and assert that it's in id order</span>
<a href="#l12.7594"></a><span id="l12.7594">   table-&gt;GetCount(GetEnv(), &amp;rowCount);</span>
<a href="#l12.7595"></a><span id="l12.7595">   mdbOid oid;</span>
<a href="#l12.7596"></a><span id="l12.7596">   tableRowIndex = 0;</span>
<a href="#l12.7597"></a><span id="l12.7597">   mdb_id prevId = 0;</span>
<a href="#l12.7598"></a><span id="l12.7598" class="difflineminus">-  while (tableRowIndex &lt; rowCount)</span>
<a href="#l12.7599"></a><span id="l12.7599" class="difflineminus">-  {</span>
<a href="#l12.7600"></a><span id="l12.7600" class="difflineminus">-    nsresult ret = table-&gt;PosToOid (m_mdbEnv, tableRowIndex++, &amp;oid);</span>
<a href="#l12.7601"></a><span id="l12.7601" class="difflineminus">-    if (tableRowIndex &gt; 1 &amp;&amp; oid.mOid_Id &lt;= prevId)</span>
<a href="#l12.7602"></a><span id="l12.7602" class="difflineminus">-    {</span>
<a href="#l12.7603"></a><span id="l12.7603" class="difflineminus">-      NS_ASSERTION(false, &quot;inserting row into cached hits table, not sorted correctly&quot;);</span>
<a href="#l12.7604"></a><span id="l12.7604" class="difflineplus">+  while (tableRowIndex &lt; rowCount) {</span>
<a href="#l12.7605"></a><span id="l12.7605" class="difflineplus">+    nsresult ret = table-&gt;PosToOid(m_mdbEnv, tableRowIndex++, &amp;oid);</span>
<a href="#l12.7606"></a><span id="l12.7606" class="difflineplus">+    if (tableRowIndex &gt; 1 &amp;&amp; oid.mOid_Id &lt;= prevId) {</span>
<a href="#l12.7607"></a><span id="l12.7607" class="difflineplus">+      NS_ASSERTION(</span>
<a href="#l12.7608"></a><span id="l12.7608" class="difflineplus">+          false, &quot;inserting row into cached hits table, not sorted correctly&quot;);</span>
<a href="#l12.7609"></a><span id="l12.7609">       printf(&quot;key %lx is before or equal %lx\n&quot;, prevId, oid.mOid_Id);</span>
<a href="#l12.7610"></a><span id="l12.7610">     }</span>
<a href="#l12.7611"></a><span id="l12.7611">     prevId = oid.mOid_Id;</span>
<a href="#l12.7612"></a><span id="l12.7612">   }</span>
<a href="#l12.7613"></a><span id="l12.7613"> </span>
<a href="#l12.7614"></a><span id="l12.7614"> #endif</span>
<a href="#l12.7615"></a><span id="l12.7615">   Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l12.7616"></a><span id="l12.7616">   return NS_OK;</span>
<a href="#l12.7617"></a><span id="l12.7617"> }</span>
<a href="#l12.7618"></a><span id="l12.7618"> </span>
<a href="#l12.7619"></a><span id="l12.7619"> // search sorted table</span>
<a href="#l12.7620"></a><span id="l12.7620" class="difflineminus">-mdb_pos nsMsgDatabase::FindInsertIndexInSortedTable(nsIMdbTable *table, mdb_id idToInsert)</span>
<a href="#l12.7621"></a><span id="l12.7621" class="difflineminus">-{</span>
<a href="#l12.7622"></a><span id="l12.7622" class="difflineplus">+mdb_pos nsMsgDatabase::FindInsertIndexInSortedTable(nsIMdbTable *table,</span>
<a href="#l12.7623"></a><span id="l12.7623" class="difflineplus">+                                                    mdb_id idToInsert) {</span>
<a href="#l12.7624"></a><span id="l12.7624">   mdb_pos searchPos = 0;</span>
<a href="#l12.7625"></a><span id="l12.7625">   uint32_t rowCount;</span>
<a href="#l12.7626"></a><span id="l12.7626">   table-&gt;GetCount(GetEnv(), &amp;rowCount);</span>
<a href="#l12.7627"></a><span id="l12.7627">   mdb_pos hi = rowCount;</span>
<a href="#l12.7628"></a><span id="l12.7628">   mdb_pos lo = 0;</span>
<a href="#l12.7629"></a><span id="l12.7629"> </span>
<a href="#l12.7630"></a><span id="l12.7630" class="difflineminus">-  while (hi &gt; lo)</span>
<a href="#l12.7631"></a><span id="l12.7631" class="difflineminus">-  {</span>
<a href="#l12.7632"></a><span id="l12.7632" class="difflineplus">+  while (hi &gt; lo) {</span>
<a href="#l12.7633"></a><span id="l12.7633">     mdbOid outOid;</span>
<a href="#l12.7634"></a><span id="l12.7634">     searchPos = (lo + hi - 1) / 2;</span>
<a href="#l12.7635"></a><span id="l12.7635">     table-&gt;PosToOid(GetEnv(), searchPos, &amp;outOid);</span>
<a href="#l12.7636"></a><span id="l12.7636" class="difflineminus">-    if (outOid.mOid_Id == idToInsert)</span>
<a href="#l12.7637"></a><span id="l12.7637" class="difflineminus">-    {</span>
<a href="#l12.7638"></a><span id="l12.7638" class="difflineplus">+    if (outOid.mOid_Id == idToInsert) {</span>
<a href="#l12.7639"></a><span id="l12.7639">       NS_ASSERTION(false, &quot;id shouldn't be in table&quot;);</span>
<a href="#l12.7640"></a><span id="l12.7640">       return hi;</span>
<a href="#l12.7641"></a><span id="l12.7641">     }</span>
<a href="#l12.7642"></a><span id="l12.7642">     if (outOid.mOid_Id &gt; idToInsert)</span>
<a href="#l12.7643"></a><span id="l12.7643">       hi = searchPos;</span>
<a href="#l12.7644"></a><span id="l12.7644" class="difflineminus">-    else // if (outOid.mOid_Id &lt;  idToInsert)</span>
<a href="#l12.7645"></a><span id="l12.7645" class="difflineplus">+    else  // if (outOid.mOid_Id &lt;  idToInsert)</span>
<a href="#l12.7646"></a><span id="l12.7646">       lo = searchPos + 1;</span>
<a href="#l12.7647"></a><span id="l12.7647">   }</span>
<a href="#l12.7648"></a><span id="l12.7648">   return hi;</span>
<a href="#l12.7649"></a><span id="l12.7649"> }</span>
<a href="#l12.7650"></a><span id="l12.7650"> NS_IMETHODIMP</span>
<a href="#l12.7651"></a><span id="l12.7651" class="difflineminus">-nsMsgDatabase::UpdateHdrInCache(const char *aSearchFolderUri, nsIMsgDBHdr *aHdr, bool aAdd)</span>
<a href="#l12.7652"></a><span id="l12.7652" class="difflineminus">-{</span>
<a href="#l12.7653"></a><span id="l12.7653" class="difflineminus">-  nsCOMPtr &lt;nsIMdbTable&gt; table;</span>
<a href="#l12.7654"></a><span id="l12.7654" class="difflineminus">-  nsresult err = GetSearchResultsTable(aSearchFolderUri, true, getter_AddRefs(table));</span>
<a href="#l12.7655"></a><span id="l12.7655" class="difflineplus">+nsMsgDatabase::UpdateHdrInCache(const char *aSearchFolderUri, nsIMsgDBHdr *aHdr,</span>
<a href="#l12.7656"></a><span id="l12.7656" class="difflineplus">+                                bool aAdd) {</span>
<a href="#l12.7657"></a><span id="l12.7657" class="difflineplus">+  nsCOMPtr&lt;nsIMdbTable&gt; table;</span>
<a href="#l12.7658"></a><span id="l12.7658" class="difflineplus">+  nsresult err =</span>
<a href="#l12.7659"></a><span id="l12.7659" class="difflineplus">+      GetSearchResultsTable(aSearchFolderUri, true, getter_AddRefs(table));</span>
<a href="#l12.7660"></a><span id="l12.7660">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l12.7661"></a><span id="l12.7661">   nsMsgKey key;</span>
<a href="#l12.7662"></a><span id="l12.7662">   err = aHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.7663"></a><span id="l12.7663" class="difflineminus">-  nsMsgHdr* msgHdr = static_cast&lt;nsMsgHdr*&gt;(aHdr);  // closed system, so this is ok</span>
<a href="#l12.7664"></a><span id="l12.7664" class="difflineminus">-  nsIMdbRow* hdrRow = msgHdr-&gt;GetMDBRow();</span>
<a href="#l12.7665"></a><span id="l12.7665" class="difflineminus">-  if (NS_SUCCEEDED(err) &amp;&amp; m_mdbStore &amp;&amp; hdrRow)</span>
<a href="#l12.7666"></a><span id="l12.7666" class="difflineminus">-  {</span>
<a href="#l12.7667"></a><span id="l12.7667" class="difflineminus">-    if (!aAdd)</span>
<a href="#l12.7668"></a><span id="l12.7668" class="difflineminus">-    {</span>
<a href="#l12.7669"></a><span id="l12.7669" class="difflineplus">+  nsMsgHdr *msgHdr =</span>
<a href="#l12.7670"></a><span id="l12.7670" class="difflineplus">+      static_cast&lt;nsMsgHdr *&gt;(aHdr);  // closed system, so this is ok</span>
<a href="#l12.7671"></a><span id="l12.7671" class="difflineplus">+  nsIMdbRow *hdrRow = msgHdr-&gt;GetMDBRow();</span>
<a href="#l12.7672"></a><span id="l12.7672" class="difflineplus">+  if (NS_SUCCEEDED(err) &amp;&amp; m_mdbStore &amp;&amp; hdrRow) {</span>
<a href="#l12.7673"></a><span id="l12.7673" class="difflineplus">+    if (!aAdd) {</span>
<a href="#l12.7674"></a><span id="l12.7674">       table-&gt;CutRow(m_mdbEnv, hdrRow);</span>
<a href="#l12.7675"></a><span id="l12.7675" class="difflineminus">-    }</span>
<a href="#l12.7676"></a><span id="l12.7676" class="difflineminus">-    else</span>
<a href="#l12.7677"></a><span id="l12.7677" class="difflineminus">-    {</span>
<a href="#l12.7678"></a><span id="l12.7678" class="difflineplus">+    } else {</span>
<a href="#l12.7679"></a><span id="l12.7679">       mdbOid rowId;</span>
<a href="#l12.7680"></a><span id="l12.7680">       hdrRow-&gt;GetOid(m_mdbEnv, &amp;rowId);</span>
<a href="#l12.7681"></a><span id="l12.7681">       mdb_pos insertPos = FindInsertIndexInSortedTable(table, rowId.mOid_Id);</span>
<a href="#l12.7682"></a><span id="l12.7682">       uint32_t rowCount;</span>
<a href="#l12.7683"></a><span id="l12.7683">       table-&gt;GetCount(m_mdbEnv, &amp;rowCount);</span>
<a href="#l12.7684"></a><span id="l12.7684">       table-&gt;AddRow(m_mdbEnv, hdrRow);</span>
<a href="#l12.7685"></a><span id="l12.7685">       mdb_pos newPos;</span>
<a href="#l12.7686"></a><span id="l12.7686">       table-&gt;MoveRow(m_mdbEnv, hdrRow, rowCount, insertPos, &amp;newPos);</span>
<a href="#l12.7687"></a><span id="l12.7687">     }</span>
<a href="#l12.7688"></a><span id="l12.7688">   }</span>
<a href="#l12.7689"></a><span id="l12.7689"> </span>
<a href="#l12.7690"></a><span id="l12.7690" class="difflineminus">-//  if (aAdd)</span>
<a href="#l12.7691"></a><span id="l12.7691" class="difflineminus">- // if we need to add this hdr, we need to insert it in key order.</span>
<a href="#l12.7692"></a><span id="l12.7692" class="difflineplus">+  //  if (aAdd)</span>
<a href="#l12.7693"></a><span id="l12.7693" class="difflineplus">+  // if we need to add this hdr, we need to insert it in key order.</span>
<a href="#l12.7694"></a><span id="l12.7694">   return NS_OK;</span>
<a href="#l12.7695"></a><span id="l12.7695"> }</span>
<a href="#l12.7696"></a><span id="l12.7696"> NS_IMETHODIMP</span>
<a href="#l12.7697"></a><span id="l12.7697" class="difflineminus">-nsMsgDatabase::HdrIsInCache(const char* aSearchFolderUri, nsIMsgDBHdr *aHdr, bool *aResult)</span>
<a href="#l12.7698"></a><span id="l12.7698" class="difflineminus">-{</span>
<a href="#l12.7699"></a><span id="l12.7699" class="difflineplus">+nsMsgDatabase::HdrIsInCache(const char *aSearchFolderUri, nsIMsgDBHdr *aHdr,</span>
<a href="#l12.7700"></a><span id="l12.7700" class="difflineplus">+                            bool *aResult) {</span>
<a href="#l12.7701"></a><span id="l12.7701">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l12.7702"></a><span id="l12.7702" class="difflineminus">-  nsCOMPtr &lt;nsIMdbTable&gt; table;</span>
<a href="#l12.7703"></a><span id="l12.7703" class="difflineminus">-  nsresult err = GetSearchResultsTable(aSearchFolderUri, true, getter_AddRefs(table));</span>
<a href="#l12.7704"></a><span id="l12.7704" class="difflineplus">+  nsCOMPtr&lt;nsIMdbTable&gt; table;</span>
<a href="#l12.7705"></a><span id="l12.7705" class="difflineplus">+  nsresult err =</span>
<a href="#l12.7706"></a><span id="l12.7706" class="difflineplus">+      GetSearchResultsTable(aSearchFolderUri, true, getter_AddRefs(table));</span>
<a href="#l12.7707"></a><span id="l12.7707">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l12.7708"></a><span id="l12.7708">   nsMsgKey key;</span>
<a href="#l12.7709"></a><span id="l12.7709">   aHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l12.7710"></a><span id="l12.7710">   mdbOid rowObjectId;</span>
<a href="#l12.7711"></a><span id="l12.7711">   rowObjectId.mOid_Id = key;</span>
<a href="#l12.7712"></a><span id="l12.7712">   rowObjectId.mOid_Scope = m_hdrRowScopeToken;</span>
<a href="#l12.7713"></a><span id="l12.7713">   mdb_bool hasOid;</span>
<a href="#l12.7714"></a><span id="l12.7714" class="difflineminus">-  err =  table-&gt;HasOid(GetEnv(), &amp;rowObjectId, &amp;hasOid);</span>
<a href="#l12.7715"></a><span id="l12.7715" class="difflineplus">+  err = table-&gt;HasOid(GetEnv(), &amp;rowObjectId, &amp;hasOid);</span>
<a href="#l12.7716"></a><span id="l12.7716">   *aResult = hasOid;</span>
<a href="#l12.7717"></a><span id="l12.7717">   return err;</span>
<a href="#l12.7718"></a><span id="l12.7718"> }</span>
<a href="#l12.7719"></a><span id="l12.7719" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgHdr.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgHdr.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -17,685 +17,587 @@ using namespace mozilla::mailnews;</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> NS_IMPL_ISUPPORTS(nsMsgHdr, nsIMsgDBHdr)</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7"> #define FLAGS_INITED 0x1</span>
<a href="#l13.8"></a><span id="l13.8"> #define CACHED_VALUES_INITED 0x2</span>
<a href="#l13.9"></a><span id="l13.9"> #define REFERENCES_INITED 0x4</span>
<a href="#l13.10"></a><span id="l13.10"> #define THREAD_PARENT_INITED 0x8</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-nsMsgHdr::nsMsgHdr(nsMsgDatabase *db, nsIMdbRow *dbRow)</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-{</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+nsMsgHdr::nsMsgHdr(nsMsgDatabase *db, nsIMdbRow *dbRow) {</span>
<a href="#l13.15"></a><span id="l13.15">   m_mdb = db;</span>
<a href="#l13.16"></a><span id="l13.16">   Init();</span>
<a href="#l13.17"></a><span id="l13.17">   m_mdbRow = dbRow;</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-  if(m_mdb)</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-  {</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+  if (m_mdb) {</span>
<a href="#l13.21"></a><span id="l13.21">     NS_ADDREF(m_mdb);  // Released in DTOR.</span>
<a href="#l13.22"></a><span id="l13.22">     mdbOid outOid;</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-    if (dbRow &amp;&amp; NS_SUCCEEDED(dbRow-&gt;GetOid(m_mdb-&gt;GetEnv(), &amp;outOid)))</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-    {</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+    if (dbRow &amp;&amp; NS_SUCCEEDED(dbRow-&gt;GetOid(m_mdb-&gt;GetEnv(), &amp;outOid))) {</span>
<a href="#l13.26"></a><span id="l13.26">       m_messageKey = outOid.mOid_Id;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-      m_mdb-&gt;AddHdrToUseCache((nsIMsgDBHdr *) this, m_messageKey);</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+      m_mdb-&gt;AddHdrToUseCache((nsIMsgDBHdr *)this, m_messageKey);</span>
<a href="#l13.29"></a><span id="l13.29">     }</span>
<a href="#l13.30"></a><span id="l13.30">   }</span>
<a href="#l13.31"></a><span id="l13.31"> }</span>
<a href="#l13.32"></a><span id="l13.32"> </span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-void nsMsgHdr::Init()</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-{</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+void nsMsgHdr::Init() {</span>
<a href="#l13.37"></a><span id="l13.37">   m_initedValues = 0;</span>
<a href="#l13.38"></a><span id="l13.38">   m_statusOffset = 0xffffffff;</span>
<a href="#l13.39"></a><span id="l13.39">   m_messageKey = nsMsgKey_None;</span>
<a href="#l13.40"></a><span id="l13.40">   m_messageSize = 0;</span>
<a href="#l13.41"></a><span id="l13.41">   m_date = 0;</span>
<a href="#l13.42"></a><span id="l13.42">   m_flags = 0;</span>
<a href="#l13.43"></a><span id="l13.43">   m_mdbRow = NULL;</span>
<a href="#l13.44"></a><span id="l13.44">   m_threadId = nsMsgKey_None;</span>
<a href="#l13.45"></a><span id="l13.45">   m_threadParent = nsMsgKey_None;</span>
<a href="#l13.46"></a><span id="l13.46"> }</span>
<a href="#l13.47"></a><span id="l13.47"> </span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-nsresult nsMsgHdr::InitCachedValues()</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-{</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+nsresult nsMsgHdr::InitCachedValues() {</span>
<a href="#l13.51"></a><span id="l13.51">   nsresult err = NS_OK;</span>
<a href="#l13.52"></a><span id="l13.52"> </span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-  if (!m_mdb || !m_mdbRow)</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+  if (!m_mdb || !m_mdbRow) return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.56"></a><span id="l13.56"> </span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-  if (!(m_initedValues &amp; CACHED_VALUES_INITED))</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-  {</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+  if (!(m_initedValues &amp; CACHED_VALUES_INITED)) {</span>
<a href="#l13.60"></a><span id="l13.60">     uint32_t uint32Value;</span>
<a href="#l13.61"></a><span id="l13.61">     mdbOid outOid;</span>
<a href="#l13.62"></a><span id="l13.62">     if (NS_SUCCEEDED(m_mdbRow-&gt;GetOid(m_mdb-&gt;GetEnv(), &amp;outOid)))</span>
<a href="#l13.63"></a><span id="l13.63">       m_messageKey = outOid.mOid_Id;</span>
<a href="#l13.64"></a><span id="l13.64"> </span>
<a href="#l13.65"></a><span id="l13.65">     err = GetUInt32Column(m_mdb-&gt;m_messageSizeColumnToken, &amp;m_messageSize);</span>
<a href="#l13.66"></a><span id="l13.66"> </span>
<a href="#l13.67"></a><span id="l13.67">     err = GetUInt32Column(m_mdb-&gt;m_dateColumnToken, &amp;uint32Value);</span>
<a href="#l13.68"></a><span id="l13.68">     Seconds2PRTime(uint32Value, &amp;m_date);</span>
<a href="#l13.69"></a><span id="l13.69"> </span>
<a href="#l13.70"></a><span id="l13.70">     err = GetUInt32Column(m_mdb-&gt;m_messageThreadIdColumnToken, &amp;m_threadId);</span>
<a href="#l13.71"></a><span id="l13.71"> </span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-      m_initedValues |= CACHED_VALUES_INITED;</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+    if (NS_SUCCEEDED(err)) m_initedValues |= CACHED_VALUES_INITED;</span>
<a href="#l13.75"></a><span id="l13.75">   }</span>
<a href="#l13.76"></a><span id="l13.76">   return err;</span>
<a href="#l13.77"></a><span id="l13.77"> }</span>
<a href="#l13.78"></a><span id="l13.78"> </span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-nsresult nsMsgHdr::InitFlags()</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineminus">-{</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+nsresult nsMsgHdr::InitFlags() {</span>
<a href="#l13.83"></a><span id="l13.83">   nsresult err = NS_OK;</span>
<a href="#l13.84"></a><span id="l13.84"> </span>
<a href="#l13.85"></a><span id="l13.85" class="difflineminus">-  if (!m_mdb)</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+  if (!m_mdb) return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.88"></a><span id="l13.88"> </span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-  if(!(m_initedValues &amp; FLAGS_INITED))</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineminus">-  {</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+  if (!(m_initedValues &amp; FLAGS_INITED)) {</span>
<a href="#l13.92"></a><span id="l13.92">     err = GetUInt32Column(m_mdb-&gt;m_flagsColumnToken, &amp;m_flags);</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineminus">-    m_flags &amp;= ~nsMsgMessageFlags::New; // don't get new flag from MDB</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+    m_flags &amp;= ~nsMsgMessageFlags::New;  // don't get new flag from MDB</span>
<a href="#l13.95"></a><span id="l13.95"> </span>
<a href="#l13.96"></a><span id="l13.96" class="difflineminus">-    if(NS_SUCCEEDED(err))</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineminus">-      m_initedValues |= FLAGS_INITED;</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+    if (NS_SUCCEEDED(err)) m_initedValues |= FLAGS_INITED;</span>
<a href="#l13.99"></a><span id="l13.99">   }</span>
<a href="#l13.100"></a><span id="l13.100"> </span>
<a href="#l13.101"></a><span id="l13.101">   return err;</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">-</span>
<a href="#l13.103"></a><span id="l13.103"> }</span>
<a href="#l13.104"></a><span id="l13.104"> </span>
<a href="#l13.105"></a><span id="l13.105" class="difflineminus">-nsMsgHdr::~nsMsgHdr()</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineminus">-{</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineminus">-  if (m_mdbRow)</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineminus">-  {</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineminus">-    if (m_mdb)</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-    {</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+nsMsgHdr::~nsMsgHdr() {</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+  if (m_mdbRow) {</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+    if (m_mdb) {</span>
<a href="#l13.114"></a><span id="l13.114">       NS_RELEASE(m_mdbRow);</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineminus">-      m_mdb-&gt;RemoveHdrFromUseCache((nsIMsgDBHdr *) this, m_messageKey);</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+      m_mdb-&gt;RemoveHdrFromUseCache((nsIMsgDBHdr *)this, m_messageKey);</span>
<a href="#l13.117"></a><span id="l13.117">     }</span>
<a href="#l13.118"></a><span id="l13.118">   }</span>
<a href="#l13.119"></a><span id="l13.119">   NS_IF_RELEASE(m_mdb);</span>
<a href="#l13.120"></a><span id="l13.120"> }</span>
<a href="#l13.121"></a><span id="l13.121"> </span>
<a href="#l13.122"></a><span id="l13.122" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetMessageKey(nsMsgKey *result)</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineminus">-{</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineminus">-  if (m_messageKey == nsMsgKey_None &amp;&amp; m_mdbRow != NULL)</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineminus">-  {</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetMessageKey(nsMsgKey *result) {</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+  if (m_messageKey == nsMsgKey_None &amp;&amp; m_mdbRow != NULL) {</span>
<a href="#l13.128"></a><span id="l13.128">     mdbOid outOid;</span>
<a href="#l13.129"></a><span id="l13.129">     if (NS_SUCCEEDED(m_mdbRow-&gt;GetOid(m_mdb-&gt;GetEnv(), &amp;outOid)))</span>
<a href="#l13.130"></a><span id="l13.130">       m_messageKey = outOid.mOid_Id;</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineminus">-</span>
<a href="#l13.132"></a><span id="l13.132">   }</span>
<a href="#l13.133"></a><span id="l13.133">   *result = m_messageKey;</span>
<a href="#l13.134"></a><span id="l13.134">   return NS_OK;</span>
<a href="#l13.135"></a><span id="l13.135"> }</span>
<a href="#l13.136"></a><span id="l13.136"> </span>
<a href="#l13.137"></a><span id="l13.137" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetThreadId(nsMsgKey *result)</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineminus">-{</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetThreadId(nsMsgKey *result) {</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+  if (!(m_initedValues &amp; CACHED_VALUES_INITED)) InitCachedValues();</span>
<a href="#l13.141"></a><span id="l13.141"> </span>
<a href="#l13.142"></a><span id="l13.142" class="difflineminus">-  if (!(m_initedValues &amp; CACHED_VALUES_INITED))</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineminus">-    InitCachedValues();</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineminus">-</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-  if (result)</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineminus">-  {</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+  if (result) {</span>
<a href="#l13.148"></a><span id="l13.148">     *result = m_threadId;</span>
<a href="#l13.149"></a><span id="l13.149">     return NS_OK;</span>
<a href="#l13.150"></a><span id="l13.150">   }</span>
<a href="#l13.151"></a><span id="l13.151">   return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.152"></a><span id="l13.152"> }</span>
<a href="#l13.153"></a><span id="l13.153"> </span>
<a href="#l13.154"></a><span id="l13.154" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetThreadId(nsMsgKey inKey)</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineminus">-{</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetThreadId(nsMsgKey inKey) {</span>
<a href="#l13.157"></a><span id="l13.157">   m_threadId = inKey;</span>
<a href="#l13.158"></a><span id="l13.158">   return SetUInt32Column(m_threadId, m_mdb-&gt;m_messageThreadIdColumnToken);</span>
<a href="#l13.159"></a><span id="l13.159"> }</span>
<a href="#l13.160"></a><span id="l13.160"> </span>
<a href="#l13.161"></a><span id="l13.161" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetMessageKey(nsMsgKey value)</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineminus">-{</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetMessageKey(nsMsgKey value) {</span>
<a href="#l13.164"></a><span id="l13.164">   m_messageKey = value;</span>
<a href="#l13.165"></a><span id="l13.165">   return NS_OK;</span>
<a href="#l13.166"></a><span id="l13.166"> }</span>
<a href="#l13.167"></a><span id="l13.167"> </span>
<a href="#l13.168"></a><span id="l13.168" class="difflineminus">-nsresult nsMsgHdr::GetRawFlags(uint32_t *result)</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineminus">-{</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineminus">-  if (!(m_initedValues &amp; FLAGS_INITED))</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineminus">-    InitFlags();</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+nsresult nsMsgHdr::GetRawFlags(uint32_t *result) {</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+  if (!(m_initedValues &amp; FLAGS_INITED)) InitFlags();</span>
<a href="#l13.174"></a><span id="l13.174">   *result = m_flags;</span>
<a href="#l13.175"></a><span id="l13.175">   return NS_OK;</span>
<a href="#l13.176"></a><span id="l13.176"> }</span>
<a href="#l13.177"></a><span id="l13.177"> </span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetFlags(uint32_t *result)</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineminus">-{</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineminus">-  if (!(m_initedValues &amp; FLAGS_INITED))</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineminus">-    InitFlags();</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetFlags(uint32_t *result) {</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+  if (!(m_initedValues &amp; FLAGS_INITED)) InitFlags();</span>
<a href="#l13.184"></a><span id="l13.184">   if (m_mdb)</span>
<a href="#l13.185"></a><span id="l13.185">     *result = m_mdb-&gt;GetStatusFlags(this, m_flags);</span>
<a href="#l13.186"></a><span id="l13.186">   else</span>
<a href="#l13.187"></a><span id="l13.187">     *result = m_flags;</span>
<a href="#l13.188"></a><span id="l13.188"> #ifdef DEBUG_bienvenu</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineminus">-  NS_ASSERTION(! (*result &amp; (nsMsgMessageFlags::Elided)), &quot;shouldn't be set in db&quot;);</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+  NS_ASSERTION(!(*result &amp; (nsMsgMessageFlags::Elided)),</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+               &quot;shouldn't be set in db&quot;);</span>
<a href="#l13.192"></a><span id="l13.192"> #endif</span>
<a href="#l13.193"></a><span id="l13.193">   return NS_OK;</span>
<a href="#l13.194"></a><span id="l13.194"> }</span>
<a href="#l13.195"></a><span id="l13.195"> </span>
<a href="#l13.196"></a><span id="l13.196" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetFlags(uint32_t flags)</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineminus">-{</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetFlags(uint32_t flags) {</span>
<a href="#l13.199"></a><span id="l13.199"> #ifdef DEBUG_bienvenu</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineminus">-  NS_ASSERTION(! (flags &amp; (nsMsgMessageFlags::Elided)), &quot;shouldn't set this flag on db&quot;);</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineplus">+  NS_ASSERTION(!(flags &amp; (nsMsgMessageFlags::Elided)),</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+               &quot;shouldn't set this flag on db&quot;);</span>
<a href="#l13.203"></a><span id="l13.203"> #endif</span>
<a href="#l13.204"></a><span id="l13.204">   m_initedValues |= FLAGS_INITED;</span>
<a href="#l13.205"></a><span id="l13.205">   m_flags = flags;</span>
<a href="#l13.206"></a><span id="l13.206">   // don't write out nsMsgMessageFlags::New to MDB.</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineminus">-  return SetUInt32Column(m_flags &amp; ~nsMsgMessageFlags::New, m_mdb-&gt;m_flagsColumnToken);</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+  return SetUInt32Column(m_flags &amp; ~nsMsgMessageFlags::New,</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+                         m_mdb-&gt;m_flagsColumnToken);</span>
<a href="#l13.210"></a><span id="l13.210"> }</span>
<a href="#l13.211"></a><span id="l13.211"> </span>
<a href="#l13.212"></a><span id="l13.212" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::OrFlags(uint32_t flags, uint32_t *result)</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineminus">-{</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineminus">-  if (!(m_initedValues &amp; FLAGS_INITED))</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineminus">-    InitFlags();</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineminus">-  if ((m_flags &amp; flags) != flags)</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineminus">-    SetFlags (m_flags | flags);</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::OrFlags(uint32_t flags, uint32_t *result) {</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+  if (!(m_initedValues &amp; FLAGS_INITED)) InitFlags();</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+  if ((m_flags &amp; flags) != flags) SetFlags(m_flags | flags);</span>
<a href="#l13.221"></a><span id="l13.221">   *result = m_flags;</span>
<a href="#l13.222"></a><span id="l13.222">   return NS_OK;</span>
<a href="#l13.223"></a><span id="l13.223"> }</span>
<a href="#l13.224"></a><span id="l13.224"> </span>
<a href="#l13.225"></a><span id="l13.225" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::AndFlags(uint32_t flags, uint32_t *result)</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineminus">-{</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineminus">-  if (!(m_initedValues &amp; FLAGS_INITED))</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineminus">-    InitFlags();</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineminus">-  if ((m_flags &amp; flags) != m_flags)</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineminus">-    SetFlags (m_flags &amp; flags);</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::AndFlags(uint32_t flags, uint32_t *result) {</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineplus">+  if (!(m_initedValues &amp; FLAGS_INITED)) InitFlags();</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineplus">+  if ((m_flags &amp; flags) != m_flags) SetFlags(m_flags &amp; flags);</span>
<a href="#l13.234"></a><span id="l13.234">   *result = m_flags;</span>
<a href="#l13.235"></a><span id="l13.235">   return NS_OK;</span>
<a href="#l13.236"></a><span id="l13.236"> }</span>
<a href="#l13.237"></a><span id="l13.237"> </span>
<a href="#l13.238"></a><span id="l13.238" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::MarkHasAttachments(bool bHasAttachments)</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineminus">-{</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::MarkHasAttachments(bool bHasAttachments) {</span>
<a href="#l13.241"></a><span id="l13.241">   nsresult rv = NS_OK;</span>
<a href="#l13.242"></a><span id="l13.242"> </span>
<a href="#l13.243"></a><span id="l13.243" class="difflineminus">-  if(m_mdb)</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineminus">-  {</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+  if (m_mdb) {</span>
<a href="#l13.246"></a><span id="l13.246">     nsMsgKey key;</span>
<a href="#l13.247"></a><span id="l13.247">     rv = GetMessageKey(&amp;key);</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineminus">-    if(NS_SUCCEEDED(rv))</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l13.250"></a><span id="l13.250">       rv = m_mdb-&gt;MarkHasAttachments(key, bHasAttachments, nullptr);</span>
<a href="#l13.251"></a><span id="l13.251">   }</span>
<a href="#l13.252"></a><span id="l13.252">   return rv;</span>
<a href="#l13.253"></a><span id="l13.253"> }</span>
<a href="#l13.254"></a><span id="l13.254"> </span>
<a href="#l13.255"></a><span id="l13.255" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::MarkRead(bool bRead)</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineminus">-{</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::MarkRead(bool bRead) {</span>
<a href="#l13.258"></a><span id="l13.258">   nsresult rv = NS_OK;</span>
<a href="#l13.259"></a><span id="l13.259"> </span>
<a href="#l13.260"></a><span id="l13.260" class="difflineminus">-  if(m_mdb)</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineminus">-  {</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineplus">+  if (m_mdb) {</span>
<a href="#l13.263"></a><span id="l13.263">     nsMsgKey key;</span>
<a href="#l13.264"></a><span id="l13.264">     rv = GetMessageKey(&amp;key);</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineminus">-    if(NS_SUCCEEDED(rv))</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineminus">-      rv = m_mdb-&gt;MarkRead(key, bRead, nullptr);</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineplus">+    if (NS_SUCCEEDED(rv)) rv = m_mdb-&gt;MarkRead(key, bRead, nullptr);</span>
<a href="#l13.268"></a><span id="l13.268">   }</span>
<a href="#l13.269"></a><span id="l13.269">   return rv;</span>
<a href="#l13.270"></a><span id="l13.270"> }</span>
<a href="#l13.271"></a><span id="l13.271"> </span>
<a href="#l13.272"></a><span id="l13.272" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::MarkFlagged(bool bFlagged)</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineminus">-{</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::MarkFlagged(bool bFlagged) {</span>
<a href="#l13.275"></a><span id="l13.275">   nsresult rv = NS_OK;</span>
<a href="#l13.276"></a><span id="l13.276"> </span>
<a href="#l13.277"></a><span id="l13.277" class="difflineminus">-  if(m_mdb)</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineminus">-  {</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineplus">+  if (m_mdb) {</span>
<a href="#l13.280"></a><span id="l13.280">     nsMsgKey key;</span>
<a href="#l13.281"></a><span id="l13.281">     rv = GetMessageKey(&amp;key);</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineminus">-    if(NS_SUCCEEDED(rv))</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineminus">-      rv = m_mdb-&gt;MarkMarked(key, bFlagged, nullptr);</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineplus">+    if (NS_SUCCEEDED(rv)) rv = m_mdb-&gt;MarkMarked(key, bFlagged, nullptr);</span>
<a href="#l13.285"></a><span id="l13.285">   }</span>
<a href="#l13.286"></a><span id="l13.286">   return rv;</span>
<a href="#l13.287"></a><span id="l13.287"> }</span>
<a href="#l13.288"></a><span id="l13.288"> </span>
<a href="#l13.289"></a><span id="l13.289" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetProperty(const char *propertyName, nsAString &amp;resultProperty)</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineminus">-{</span>
<a href="#l13.291"></a><span id="l13.291" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetProperty(const char *propertyName,</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineplus">+                                    nsAString &amp;resultProperty) {</span>
<a href="#l13.293"></a><span id="l13.293">   NS_ENSURE_ARG_POINTER(propertyName);</span>
<a href="#l13.294"></a><span id="l13.294" class="difflineminus">-  if (!m_mdb || !m_mdbRow)</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineplus">+  if (!m_mdb || !m_mdbRow) return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.297"></a><span id="l13.297">   return m_mdb-&gt;GetPropertyAsNSString(m_mdbRow, propertyName, resultProperty);</span>
<a href="#l13.298"></a><span id="l13.298"> }</span>
<a href="#l13.299"></a><span id="l13.299"> </span>
<a href="#l13.300"></a><span id="l13.300" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetProperty(const char *propertyName, const nsAString &amp;propertyStr)</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineminus">-{</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetProperty(const char *propertyName,</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineplus">+                                    const nsAString &amp;propertyStr) {</span>
<a href="#l13.304"></a><span id="l13.304">   NS_ENSURE_ARG_POINTER(propertyName);</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineminus">-  if (!m_mdb || !m_mdbRow)</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineplus">+  if (!m_mdb || !m_mdbRow) return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.308"></a><span id="l13.308">   return m_mdb-&gt;SetPropertyFromNSString(m_mdbRow, propertyName, propertyStr);</span>
<a href="#l13.309"></a><span id="l13.309"> }</span>
<a href="#l13.310"></a><span id="l13.310"> </span>
<a href="#l13.311"></a><span id="l13.311" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetStringProperty(const char *propertyName, const char *propertyValue)</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineminus">-{</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetStringProperty(const char *propertyName,</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineplus">+                                          const char *propertyValue) {</span>
<a href="#l13.315"></a><span id="l13.315">   NS_ENSURE_ARG_POINTER(propertyName);</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineminus">-  if (!m_mdb || !m_mdbRow)</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineplus">+  if (!m_mdb || !m_mdbRow) return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.319"></a><span id="l13.319">   return m_mdb-&gt;SetProperty(m_mdbRow, propertyName, propertyValue);</span>
<a href="#l13.320"></a><span id="l13.320"> }</span>
<a href="#l13.321"></a><span id="l13.321"> </span>
<a href="#l13.322"></a><span id="l13.322" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetStringProperty(const char *propertyName, char **aPropertyValue)</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineminus">-{</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetStringProperty(const char *propertyName,</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineplus">+                                          char **aPropertyValue) {</span>
<a href="#l13.326"></a><span id="l13.326">   NS_ENSURE_ARG_POINTER(propertyName);</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineminus">-  if (!m_mdb || !m_mdbRow)</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineplus">+  if (!m_mdb || !m_mdbRow) return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.330"></a><span id="l13.330">   return m_mdb-&gt;GetProperty(m_mdbRow, propertyName, aPropertyValue);</span>
<a href="#l13.331"></a><span id="l13.331"> }</span>
<a href="#l13.332"></a><span id="l13.332"> </span>
<a href="#l13.333"></a><span id="l13.333" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetUint32Property(const char *propertyName, uint32_t *pResult)</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineminus">-{</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetUint32Property(const char *propertyName,</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineplus">+                                          uint32_t *pResult) {</span>
<a href="#l13.337"></a><span id="l13.337">   NS_ENSURE_ARG_POINTER(propertyName);</span>
<a href="#l13.338"></a><span id="l13.338" class="difflineminus">-  if (!m_mdb || !m_mdbRow)</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineplus">+  if (!m_mdb || !m_mdbRow) return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.341"></a><span id="l13.341">   return m_mdb-&gt;GetUint32Property(m_mdbRow, propertyName, pResult);</span>
<a href="#l13.342"></a><span id="l13.342"> }</span>
<a href="#l13.343"></a><span id="l13.343"> </span>
<a href="#l13.344"></a><span id="l13.344" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetUint32Property(const char *propertyName, uint32_t value)</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineminus">-{</span>
<a href="#l13.346"></a><span id="l13.346" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetUint32Property(const char *propertyName,</span>
<a href="#l13.347"></a><span id="l13.347" class="difflineplus">+                                          uint32_t value) {</span>
<a href="#l13.348"></a><span id="l13.348">   NS_ENSURE_ARG_POINTER(propertyName);</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineminus">-  if (!m_mdb || !m_mdbRow)</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineplus">+  if (!m_mdb || !m_mdbRow) return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.352"></a><span id="l13.352">   return m_mdb-&gt;SetUint32Property(m_mdbRow, propertyName, value);</span>
<a href="#l13.353"></a><span id="l13.353"> }</span>
<a href="#l13.354"></a><span id="l13.354"> </span>
<a href="#l13.355"></a><span id="l13.355" class="difflineminus">-</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetNumReferences(uint16_t *result)</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineminus">-{</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineminus">-  if (!(m_initedValues &amp; REFERENCES_INITED))</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineminus">-  {</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetNumReferences(uint16_t *result) {</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineplus">+  if (!(m_initedValues &amp; REFERENCES_INITED)) {</span>
<a href="#l13.362"></a><span id="l13.362">     const char *references;</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineminus">-    if (NS_SUCCEEDED(m_mdb-&gt;RowCellColumnToConstCharPtr(GetMDBRow(),</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineminus">-                       m_mdb-&gt;m_referencesColumnToken, &amp;references)))</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineplus">+    if (NS_SUCCEEDED(m_mdb-&gt;RowCellColumnToConstCharPtr(</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineplus">+            GetMDBRow(), m_mdb-&gt;m_referencesColumnToken, &amp;references)))</span>
<a href="#l13.367"></a><span id="l13.367">       ParseReferences(references);</span>
<a href="#l13.368"></a><span id="l13.368">     m_initedValues |= REFERENCES_INITED;</span>
<a href="#l13.369"></a><span id="l13.369">   }</span>
<a href="#l13.370"></a><span id="l13.370"> </span>
<a href="#l13.371"></a><span id="l13.371" class="difflineminus">-  if (result)</span>
<a href="#l13.372"></a><span id="l13.372" class="difflineminus">-    *result = m_references.Length();</span>
<a href="#l13.373"></a><span id="l13.373" class="difflineplus">+  if (result) *result = m_references.Length();</span>
<a href="#l13.374"></a><span id="l13.374">   // there is no real failure here; if there are no references, there are no</span>
<a href="#l13.375"></a><span id="l13.375">   //  references.</span>
<a href="#l13.376"></a><span id="l13.376">   return NS_OK;</span>
<a href="#l13.377"></a><span id="l13.377"> }</span>
<a href="#l13.378"></a><span id="l13.378"> </span>
<a href="#l13.379"></a><span id="l13.379" class="difflineminus">-nsresult nsMsgHdr::ParseReferences(const char *references)</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineminus">-{</span>
<a href="#l13.381"></a><span id="l13.381" class="difflineplus">+nsresult nsMsgHdr::ParseReferences(const char *references) {</span>
<a href="#l13.382"></a><span id="l13.382">   const char *startNextRef = references;</span>
<a href="#l13.383"></a><span id="l13.383">   nsAutoCString resultReference;</span>
<a href="#l13.384"></a><span id="l13.384">   nsCString messageId;</span>
<a href="#l13.385"></a><span id="l13.385">   GetMessageId(getter_Copies(messageId));</span>
<a href="#l13.386"></a><span id="l13.386"> </span>
<a href="#l13.387"></a><span id="l13.387" class="difflineminus">-  while (startNextRef &amp;&amp; *startNextRef)</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineminus">-  {</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineplus">+  while (startNextRef &amp;&amp; *startNextRef) {</span>
<a href="#l13.390"></a><span id="l13.390">     startNextRef = GetNextReference(startNextRef, resultReference,</span>
<a href="#l13.391"></a><span id="l13.391">                                     startNextRef == references);</span>
<a href="#l13.392"></a><span id="l13.392">     // Don't add self-references.</span>
<a href="#l13.393"></a><span id="l13.393">     if (!resultReference.IsEmpty() &amp;&amp; !resultReference.Equals(messageId))</span>
<a href="#l13.394"></a><span id="l13.394">       m_references.AppendElement(resultReference);</span>
<a href="#l13.395"></a><span id="l13.395">   }</span>
<a href="#l13.396"></a><span id="l13.396">   return NS_OK;</span>
<a href="#l13.397"></a><span id="l13.397"> }</span>
<a href="#l13.398"></a><span id="l13.398"> </span>
<a href="#l13.399"></a><span id="l13.399" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetStringReference(int32_t refNum, nsACString&amp; resultReference)</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineminus">-{</span>
<a href="#l13.401"></a><span id="l13.401" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetStringReference(int32_t refNum,</span>
<a href="#l13.402"></a><span id="l13.402" class="difflineplus">+                                           nsACString &amp;resultReference) {</span>
<a href="#l13.403"></a><span id="l13.403">   nsresult err = NS_OK;</span>
<a href="#l13.404"></a><span id="l13.404"> </span>
<a href="#l13.405"></a><span id="l13.405" class="difflineminus">-  if(!(m_initedValues &amp; REFERENCES_INITED))</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineminus">-    GetNumReferences(nullptr); // it can handle the null</span>
<a href="#l13.407"></a><span id="l13.407" class="difflineplus">+  if (!(m_initedValues &amp; REFERENCES_INITED))</span>
<a href="#l13.408"></a><span id="l13.408" class="difflineplus">+    GetNumReferences(nullptr);  // it can handle the null</span>
<a href="#l13.409"></a><span id="l13.409"> </span>
<a href="#l13.410"></a><span id="l13.410">   if ((uint32_t)refNum &lt; m_references.Length())</span>
<a href="#l13.411"></a><span id="l13.411">     resultReference = m_references.ElementAt(refNum);</span>
<a href="#l13.412"></a><span id="l13.412">   else</span>
<a href="#l13.413"></a><span id="l13.413">     err = NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l13.414"></a><span id="l13.414">   return err;</span>
<a href="#l13.415"></a><span id="l13.415"> }</span>
<a href="#l13.416"></a><span id="l13.416"> </span>
<a href="#l13.417"></a><span id="l13.417" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetDate(PRTime *result)</span>
<a href="#l13.418"></a><span id="l13.418" class="difflineminus">-{</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineminus">-  if (!(m_initedValues &amp; CACHED_VALUES_INITED))</span>
<a href="#l13.420"></a><span id="l13.420" class="difflineminus">-    InitCachedValues();</span>
<a href="#l13.421"></a><span id="l13.421" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetDate(PRTime *result) {</span>
<a href="#l13.422"></a><span id="l13.422" class="difflineplus">+  if (!(m_initedValues &amp; CACHED_VALUES_INITED)) InitCachedValues();</span>
<a href="#l13.423"></a><span id="l13.423"> </span>
<a href="#l13.424"></a><span id="l13.424">   *result = m_date;</span>
<a href="#l13.425"></a><span id="l13.425">   return NS_OK;</span>
<a href="#l13.426"></a><span id="l13.426"> }</span>
<a href="#l13.427"></a><span id="l13.427"> </span>
<a href="#l13.428"></a><span id="l13.428" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetDateInSeconds(uint32_t *aResult)</span>
<a href="#l13.429"></a><span id="l13.429" class="difflineminus">-{</span>
<a href="#l13.430"></a><span id="l13.430" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetDateInSeconds(uint32_t *aResult) {</span>
<a href="#l13.431"></a><span id="l13.431">   return GetUInt32Column(m_mdb-&gt;m_dateColumnToken, aResult);</span>
<a href="#l13.432"></a><span id="l13.432"> }</span>
<a href="#l13.433"></a><span id="l13.433"> </span>
<a href="#l13.434"></a><span id="l13.434" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetMessageId(const char *messageId)</span>
<a href="#l13.435"></a><span id="l13.435" class="difflineminus">-{</span>
<a href="#l13.436"></a><span id="l13.436" class="difflineminus">-  if (messageId &amp;&amp; *messageId == '&lt;')</span>
<a href="#l13.437"></a><span id="l13.437" class="difflineminus">-  {</span>
<a href="#l13.438"></a><span id="l13.438" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetMessageId(const char *messageId) {</span>
<a href="#l13.439"></a><span id="l13.439" class="difflineplus">+  if (messageId &amp;&amp; *messageId == '&lt;') {</span>
<a href="#l13.440"></a><span id="l13.440">     nsAutoCString tempMessageID(messageId + 1);</span>
<a href="#l13.441"></a><span id="l13.441">     if (tempMessageID.CharAt(tempMessageID.Length() - 1) == '&gt;')</span>
<a href="#l13.442"></a><span id="l13.442">       tempMessageID.SetLength(tempMessageID.Length() - 1);</span>
<a href="#l13.443"></a><span id="l13.443">     return SetStringColumn(tempMessageID.get(), m_mdb-&gt;m_messageIdColumnToken);</span>
<a href="#l13.444"></a><span id="l13.444">   }</span>
<a href="#l13.445"></a><span id="l13.445">   return SetStringColumn(messageId, m_mdb-&gt;m_messageIdColumnToken);</span>
<a href="#l13.446"></a><span id="l13.446"> }</span>
<a href="#l13.447"></a><span id="l13.447"> </span>
<a href="#l13.448"></a><span id="l13.448" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetSubject(const char *subject)</span>
<a href="#l13.449"></a><span id="l13.449" class="difflineminus">-{</span>
<a href="#l13.450"></a><span id="l13.450" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetSubject(const char *subject) {</span>
<a href="#l13.451"></a><span id="l13.451">   return SetStringColumn(subject, m_mdb-&gt;m_subjectColumnToken);</span>
<a href="#l13.452"></a><span id="l13.452"> }</span>
<a href="#l13.453"></a><span id="l13.453"> </span>
<a href="#l13.454"></a><span id="l13.454" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetAuthor(const char *author)</span>
<a href="#l13.455"></a><span id="l13.455" class="difflineminus">-{</span>
<a href="#l13.456"></a><span id="l13.456" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetAuthor(const char *author) {</span>
<a href="#l13.457"></a><span id="l13.457">   return SetStringColumn(author, m_mdb-&gt;m_senderColumnToken);</span>
<a href="#l13.458"></a><span id="l13.458"> }</span>
<a href="#l13.459"></a><span id="l13.459"> </span>
<a href="#l13.460"></a><span id="l13.460" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetReferences(const char *references)</span>
<a href="#l13.461"></a><span id="l13.461" class="difflineminus">-{</span>
<a href="#l13.462"></a><span id="l13.462" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetReferences(const char *references) {</span>
<a href="#l13.463"></a><span id="l13.463">   NS_ENSURE_ARG_POINTER(references);</span>
<a href="#l13.464"></a><span id="l13.464">   m_references.Clear();</span>
<a href="#l13.465"></a><span id="l13.465">   ParseReferences(references);</span>
<a href="#l13.466"></a><span id="l13.466"> </span>
<a href="#l13.467"></a><span id="l13.467">   m_initedValues |= REFERENCES_INITED;</span>
<a href="#l13.468"></a><span id="l13.468"> </span>
<a href="#l13.469"></a><span id="l13.469">   return SetStringColumn(references, m_mdb-&gt;m_referencesColumnToken);</span>
<a href="#l13.470"></a><span id="l13.470"> }</span>
<a href="#l13.471"></a><span id="l13.471"> </span>
<a href="#l13.472"></a><span id="l13.472" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetRecipients(const char *recipients)</span>
<a href="#l13.473"></a><span id="l13.473" class="difflineminus">-{</span>
<a href="#l13.474"></a><span id="l13.474" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetRecipients(const char *recipients) {</span>
<a href="#l13.475"></a><span id="l13.475">   // need to put in rfc822 address parsing code here (or make caller do it...)</span>
<a href="#l13.476"></a><span id="l13.476">   return SetStringColumn(recipients, m_mdb-&gt;m_recipientsColumnToken);</span>
<a href="#l13.477"></a><span id="l13.477"> }</span>
<a href="#l13.478"></a><span id="l13.478"> </span>
<a href="#l13.479"></a><span id="l13.479" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetCcList(const char *ccList)</span>
<a href="#l13.480"></a><span id="l13.480" class="difflineminus">-{</span>
<a href="#l13.481"></a><span id="l13.481" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetCcList(const char *ccList) {</span>
<a href="#l13.482"></a><span id="l13.482">   return SetStringColumn(ccList, m_mdb-&gt;m_ccListColumnToken);</span>
<a href="#l13.483"></a><span id="l13.483"> }</span>
<a href="#l13.484"></a><span id="l13.484"> </span>
<a href="#l13.485"></a><span id="l13.485" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetBccList(const char *bccList)</span>
<a href="#l13.486"></a><span id="l13.486" class="difflineminus">-{</span>
<a href="#l13.487"></a><span id="l13.487" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetBccList(const char *bccList) {</span>
<a href="#l13.488"></a><span id="l13.488">   return SetStringColumn(bccList, m_mdb-&gt;m_bccListColumnToken);</span>
<a href="#l13.489"></a><span id="l13.489"> }</span>
<a href="#l13.490"></a><span id="l13.490"> </span>
<a href="#l13.491"></a><span id="l13.491" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetMessageSize(uint32_t messageSize)</span>
<a href="#l13.492"></a><span id="l13.492" class="difflineminus">-{</span>
<a href="#l13.493"></a><span id="l13.493" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetMessageSize(uint32_t messageSize) {</span>
<a href="#l13.494"></a><span id="l13.494">   SetUInt32Column(messageSize, m_mdb-&gt;m_messageSizeColumnToken);</span>
<a href="#l13.495"></a><span id="l13.495">   m_messageSize = messageSize;</span>
<a href="#l13.496"></a><span id="l13.496">   return NS_OK;</span>
<a href="#l13.497"></a><span id="l13.497"> }</span>
<a href="#l13.498"></a><span id="l13.498"> </span>
<a href="#l13.499"></a><span id="l13.499" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetOfflineMessageSize(uint32_t *result)</span>
<a href="#l13.500"></a><span id="l13.500" class="difflineminus">-{</span>
<a href="#l13.501"></a><span id="l13.501" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetOfflineMessageSize(uint32_t *result) {</span>
<a href="#l13.502"></a><span id="l13.502">   uint32_t size;</span>
<a href="#l13.503"></a><span id="l13.503">   nsresult res = GetUInt32Column(m_mdb-&gt;m_offlineMessageSizeColumnToken, &amp;size);</span>
<a href="#l13.504"></a><span id="l13.504"> </span>
<a href="#l13.505"></a><span id="l13.505">   *result = size;</span>
<a href="#l13.506"></a><span id="l13.506">   return res;</span>
<a href="#l13.507"></a><span id="l13.507"> }</span>
<a href="#l13.508"></a><span id="l13.508"> </span>
<a href="#l13.509"></a><span id="l13.509" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetOfflineMessageSize(uint32_t messageSize)</span>
<a href="#l13.510"></a><span id="l13.510" class="difflineminus">-{</span>
<a href="#l13.511"></a><span id="l13.511" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetOfflineMessageSize(uint32_t messageSize) {</span>
<a href="#l13.512"></a><span id="l13.512">   return SetUInt32Column(messageSize, m_mdb-&gt;m_offlineMessageSizeColumnToken);</span>
<a href="#l13.513"></a><span id="l13.513"> }</span>
<a href="#l13.514"></a><span id="l13.514"> </span>
<a href="#l13.515"></a><span id="l13.515" class="difflineminus">-</span>
<a href="#l13.516"></a><span id="l13.516" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetLineCount(uint32_t lineCount)</span>
<a href="#l13.517"></a><span id="l13.517" class="difflineminus">-{</span>
<a href="#l13.518"></a><span id="l13.518" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetLineCount(uint32_t lineCount) {</span>
<a href="#l13.519"></a><span id="l13.519">   SetUInt32Column(lineCount, m_mdb-&gt;m_numLinesColumnToken);</span>
<a href="#l13.520"></a><span id="l13.520">   return NS_OK;</span>
<a href="#l13.521"></a><span id="l13.521"> }</span>
<a href="#l13.522"></a><span id="l13.522"> </span>
<a href="#l13.523"></a><span id="l13.523" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetStatusOffset(uint32_t statusOffset)</span>
<a href="#l13.524"></a><span id="l13.524" class="difflineminus">-{</span>
<a href="#l13.525"></a><span id="l13.525" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetStatusOffset(uint32_t statusOffset) {</span>
<a href="#l13.526"></a><span id="l13.526">   return SetUInt32Column(statusOffset, m_mdb-&gt;m_statusOffsetColumnToken);</span>
<a href="#l13.527"></a><span id="l13.527"> }</span>
<a href="#l13.528"></a><span id="l13.528"> </span>
<a href="#l13.529"></a><span id="l13.529" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetDate(PRTime date)</span>
<a href="#l13.530"></a><span id="l13.530" class="difflineminus">-{</span>
<a href="#l13.531"></a><span id="l13.531" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetDate(PRTime date) {</span>
<a href="#l13.532"></a><span id="l13.532">   m_date = date;</span>
<a href="#l13.533"></a><span id="l13.533">   uint32_t seconds;</span>
<a href="#l13.534"></a><span id="l13.534">   PRTime2Seconds(date, &amp;seconds);</span>
<a href="#l13.535"></a><span id="l13.535" class="difflineminus">-  return SetUInt32Column((uint32_t) seconds, m_mdb-&gt;m_dateColumnToken);</span>
<a href="#l13.536"></a><span id="l13.536" class="difflineplus">+  return SetUInt32Column((uint32_t)seconds, m_mdb-&gt;m_dateColumnToken);</span>
<a href="#l13.537"></a><span id="l13.537"> }</span>
<a href="#l13.538"></a><span id="l13.538"> </span>
<a href="#l13.539"></a><span id="l13.539" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetStatusOffset(uint32_t *result)</span>
<a href="#l13.540"></a><span id="l13.540" class="difflineminus">-{</span>
<a href="#l13.541"></a><span id="l13.541" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetStatusOffset(uint32_t *result) {</span>
<a href="#l13.542"></a><span id="l13.542">   uint32_t offset = 0;</span>
<a href="#l13.543"></a><span id="l13.543">   nsresult res = GetUInt32Column(m_mdb-&gt;m_statusOffsetColumnToken, &amp;offset);</span>
<a href="#l13.544"></a><span id="l13.544"> </span>
<a href="#l13.545"></a><span id="l13.545">   *result = offset;</span>
<a href="#l13.546"></a><span id="l13.546">   return res;</span>
<a href="#l13.547"></a><span id="l13.547"> }</span>
<a href="#l13.548"></a><span id="l13.548"> </span>
<a href="#l13.549"></a><span id="l13.549" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetPriority(nsMsgPriorityValue priority)</span>
<a href="#l13.550"></a><span id="l13.550" class="difflineminus">-{</span>
<a href="#l13.551"></a><span id="l13.551" class="difflineminus">-  SetUInt32Column((uint32_t) priority, m_mdb-&gt;m_priorityColumnToken);</span>
<a href="#l13.552"></a><span id="l13.552" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetPriority(nsMsgPriorityValue priority) {</span>
<a href="#l13.553"></a><span id="l13.553" class="difflineplus">+  SetUInt32Column((uint32_t)priority, m_mdb-&gt;m_priorityColumnToken);</span>
<a href="#l13.554"></a><span id="l13.554">   return NS_OK;</span>
<a href="#l13.555"></a><span id="l13.555"> }</span>
<a href="#l13.556"></a><span id="l13.556"> </span>
<a href="#l13.557"></a><span id="l13.557" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetPriority(nsMsgPriorityValue *result)</span>
<a href="#l13.558"></a><span id="l13.558" class="difflineminus">-{</span>
<a href="#l13.559"></a><span id="l13.559" class="difflineminus">-  if (!result)</span>
<a href="#l13.560"></a><span id="l13.560" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.561"></a><span id="l13.561" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetPriority(nsMsgPriorityValue *result) {</span>
<a href="#l13.562"></a><span id="l13.562" class="difflineplus">+  if (!result) return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.563"></a><span id="l13.563"> </span>
<a href="#l13.564"></a><span id="l13.564">   uint32_t priority = 0;</span>
<a href="#l13.565"></a><span id="l13.565">   nsresult rv = GetUInt32Column(m_mdb-&gt;m_priorityColumnToken, &amp;priority);</span>
<a href="#l13.566"></a><span id="l13.566">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l13.567"></a><span id="l13.567"> </span>
<a href="#l13.568"></a><span id="l13.568" class="difflineminus">-  *result = (nsMsgPriorityValue) priority;</span>
<a href="#l13.569"></a><span id="l13.569" class="difflineplus">+  *result = (nsMsgPriorityValue)priority;</span>
<a href="#l13.570"></a><span id="l13.570">   return NS_OK;</span>
<a href="#l13.571"></a><span id="l13.571"> }</span>
<a href="#l13.572"></a><span id="l13.572"> </span>
<a href="#l13.573"></a><span id="l13.573" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetLabel(nsMsgLabelValue label)</span>
<a href="#l13.574"></a><span id="l13.574" class="difflineminus">-{</span>
<a href="#l13.575"></a><span id="l13.575" class="difflineminus">-  SetUInt32Column((uint32_t) label, m_mdb-&gt;m_labelColumnToken);</span>
<a href="#l13.576"></a><span id="l13.576" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetLabel(nsMsgLabelValue label) {</span>
<a href="#l13.577"></a><span id="l13.577" class="difflineplus">+  SetUInt32Column((uint32_t)label, m_mdb-&gt;m_labelColumnToken);</span>
<a href="#l13.578"></a><span id="l13.578">   return NS_OK;</span>
<a href="#l13.579"></a><span id="l13.579"> }</span>
<a href="#l13.580"></a><span id="l13.580"> </span>
<a href="#l13.581"></a><span id="l13.581" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetLabel(nsMsgLabelValue *result)</span>
<a href="#l13.582"></a><span id="l13.582" class="difflineminus">-{</span>
<a href="#l13.583"></a><span id="l13.583" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetLabel(nsMsgLabelValue *result) {</span>
<a href="#l13.584"></a><span id="l13.584">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l13.585"></a><span id="l13.585"> </span>
<a href="#l13.586"></a><span id="l13.586">   return GetUInt32Column(m_mdb-&gt;m_labelColumnToken, result);</span>
<a href="#l13.587"></a><span id="l13.587"> }</span>
<a href="#l13.588"></a><span id="l13.588"> </span>
<a href="#l13.589"></a><span id="l13.589"> // I'd like to not store the account key, if the msg is in</span>
<a href="#l13.590"></a><span id="l13.590"> // the same account as it was received in, to save disk space and memory.</span>
<a href="#l13.591"></a><span id="l13.591"> // This might be problematic when a message gets moved...</span>
<a href="#l13.592"></a><span id="l13.592"> // And I'm not sure if we should short circuit it here,</span>
<a href="#l13.593"></a><span id="l13.593"> // or at a higher level where it might be more efficient.</span>
<a href="#l13.594"></a><span id="l13.594" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetAccountKey(const char *aAccountKey)</span>
<a href="#l13.595"></a><span id="l13.595" class="difflineminus">-{</span>
<a href="#l13.596"></a><span id="l13.596" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetAccountKey(const char *aAccountKey) {</span>
<a href="#l13.597"></a><span id="l13.597">   return SetStringProperty(&quot;account&quot;, aAccountKey);</span>
<a href="#l13.598"></a><span id="l13.598"> }</span>
<a href="#l13.599"></a><span id="l13.599"> </span>
<a href="#l13.600"></a><span id="l13.600" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetAccountKey(char **aResult)</span>
<a href="#l13.601"></a><span id="l13.601" class="difflineminus">-{</span>
<a href="#l13.602"></a><span id="l13.602" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetAccountKey(char **aResult) {</span>
<a href="#l13.603"></a><span id="l13.603">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l13.604"></a><span id="l13.604"> </span>
<a href="#l13.605"></a><span id="l13.605">   return GetStringProperty(&quot;account&quot;, aResult);</span>
<a href="#l13.606"></a><span id="l13.606"> }</span>
<a href="#l13.607"></a><span id="l13.607"> </span>
<a href="#l13.608"></a><span id="l13.608" class="difflineminus">-</span>
<a href="#l13.609"></a><span id="l13.609" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetMessageOffset(uint64_t *result)</span>
<a href="#l13.610"></a><span id="l13.610" class="difflineminus">-{</span>
<a href="#l13.611"></a><span id="l13.611" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetMessageOffset(uint64_t *result) {</span>
<a href="#l13.612"></a><span id="l13.612">   NS_ENSURE_ARG(result);</span>
<a href="#l13.613"></a><span id="l13.613"> </span>
<a href="#l13.614"></a><span id="l13.614">   // if there is a message offset, use it, otherwise, we'll use the message key.</span>
<a href="#l13.615"></a><span id="l13.615" class="difflineminus">-  (void) GetUInt64Column(m_mdb-&gt;m_offlineMsgOffsetColumnToken, result, (unsigned)-1);</span>
<a href="#l13.616"></a><span id="l13.616" class="difflineminus">-  if (*result == (unsigned)-1)</span>
<a href="#l13.617"></a><span id="l13.617" class="difflineminus">-    *result = m_messageKey;</span>
<a href="#l13.618"></a><span id="l13.618" class="difflineplus">+  (void)GetUInt64Column(m_mdb-&gt;m_offlineMsgOffsetColumnToken, result,</span>
<a href="#l13.619"></a><span id="l13.619" class="difflineplus">+                        (unsigned)-1);</span>
<a href="#l13.620"></a><span id="l13.620" class="difflineplus">+  if (*result == (unsigned)-1) *result = m_messageKey;</span>
<a href="#l13.621"></a><span id="l13.621">   return NS_OK;</span>
<a href="#l13.622"></a><span id="l13.622"> }</span>
<a href="#l13.623"></a><span id="l13.623"> </span>
<a href="#l13.624"></a><span id="l13.624" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetMessageOffset(uint64_t offset)</span>
<a href="#l13.625"></a><span id="l13.625" class="difflineminus">-{</span>
<a href="#l13.626"></a><span id="l13.626" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetMessageOffset(uint64_t offset) {</span>
<a href="#l13.627"></a><span id="l13.627">   SetUInt64Column(offset, m_mdb-&gt;m_offlineMsgOffsetColumnToken);</span>
<a href="#l13.628"></a><span id="l13.628">   return NS_OK;</span>
<a href="#l13.629"></a><span id="l13.629"> }</span>
<a href="#l13.630"></a><span id="l13.630"> </span>
<a href="#l13.631"></a><span id="l13.631" class="difflineminus">-</span>
<a href="#l13.632"></a><span id="l13.632" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetMessageSize(uint32_t *result)</span>
<a href="#l13.633"></a><span id="l13.633" class="difflineminus">-{</span>
<a href="#l13.634"></a><span id="l13.634" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetMessageSize(uint32_t *result) {</span>
<a href="#l13.635"></a><span id="l13.635">   uint32_t size;</span>
<a href="#l13.636"></a><span id="l13.636">   nsresult res = GetUInt32Column(m_mdb-&gt;m_messageSizeColumnToken, &amp;size);</span>
<a href="#l13.637"></a><span id="l13.637"> </span>
<a href="#l13.638"></a><span id="l13.638">   *result = size;</span>
<a href="#l13.639"></a><span id="l13.639">   return res;</span>
<a href="#l13.640"></a><span id="l13.640"> }</span>
<a href="#l13.641"></a><span id="l13.641"> </span>
<a href="#l13.642"></a><span id="l13.642" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetLineCount(uint32_t *result)</span>
<a href="#l13.643"></a><span id="l13.643" class="difflineminus">-{</span>
<a href="#l13.644"></a><span id="l13.644" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetLineCount(uint32_t *result) {</span>
<a href="#l13.645"></a><span id="l13.645">   uint32_t linecount;</span>
<a href="#l13.646"></a><span id="l13.646">   nsresult res = GetUInt32Column(m_mdb-&gt;m_numLinesColumnToken, &amp;linecount);</span>
<a href="#l13.647"></a><span id="l13.647">   *result = linecount;</span>
<a href="#l13.648"></a><span id="l13.648">   return res;</span>
<a href="#l13.649"></a><span id="l13.649"> }</span>
<a href="#l13.650"></a><span id="l13.650"> </span>
<a href="#l13.651"></a><span id="l13.651" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetPriorityString(const char *priority)</span>
<a href="#l13.652"></a><span id="l13.652" class="difflineminus">-{</span>
<a href="#l13.653"></a><span id="l13.653" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetPriorityString(const char *priority) {</span>
<a href="#l13.654"></a><span id="l13.654">   nsMsgPriorityValue priorityVal = nsMsgPriority::Default;</span>
<a href="#l13.655"></a><span id="l13.655"> </span>
<a href="#l13.656"></a><span id="l13.656">   // We can ignore |NS_MsgGetPriorityFromString()| return value,</span>
<a href="#l13.657"></a><span id="l13.657">   // since we set a default value for |priorityVal|.</span>
<a href="#l13.658"></a><span id="l13.658">   NS_MsgGetPriorityFromString(priority, priorityVal);</span>
<a href="#l13.659"></a><span id="l13.659"> </span>
<a href="#l13.660"></a><span id="l13.660">   return SetPriority(priorityVal);</span>
<a href="#l13.661"></a><span id="l13.661"> }</span>
<a href="#l13.662"></a><span id="l13.662"> </span>
<a href="#l13.663"></a><span id="l13.663" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetAuthor(char* *resultAuthor)</span>
<a href="#l13.664"></a><span id="l13.664" class="difflineminus">-{</span>
<a href="#l13.665"></a><span id="l13.665" class="difflineminus">-  return m_mdb-&gt;RowCellColumnToCharPtr(GetMDBRow(), m_mdb-&gt;m_senderColumnToken, resultAuthor);</span>
<a href="#l13.666"></a><span id="l13.666" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetAuthor(char **resultAuthor) {</span>
<a href="#l13.667"></a><span id="l13.667" class="difflineplus">+  return m_mdb-&gt;RowCellColumnToCharPtr(GetMDBRow(), m_mdb-&gt;m_senderColumnToken,</span>
<a href="#l13.668"></a><span id="l13.668" class="difflineplus">+                                       resultAuthor);</span>
<a href="#l13.669"></a><span id="l13.669"> }</span>
<a href="#l13.670"></a><span id="l13.670"> </span>
<a href="#l13.671"></a><span id="l13.671" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetSubject(char* *resultSubject)</span>
<a href="#l13.672"></a><span id="l13.672" class="difflineminus">-{</span>
<a href="#l13.673"></a><span id="l13.673" class="difflineminus">-  return m_mdb-&gt;RowCellColumnToCharPtr(GetMDBRow(), m_mdb-&gt;m_subjectColumnToken, resultSubject);</span>
<a href="#l13.674"></a><span id="l13.674" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetSubject(char **resultSubject) {</span>
<a href="#l13.675"></a><span id="l13.675" class="difflineplus">+  return m_mdb-&gt;RowCellColumnToCharPtr(GetMDBRow(), m_mdb-&gt;m_subjectColumnToken,</span>
<a href="#l13.676"></a><span id="l13.676" class="difflineplus">+                                       resultSubject);</span>
<a href="#l13.677"></a><span id="l13.677" class="difflineplus">+}</span>
<a href="#l13.678"></a><span id="l13.678" class="difflineplus">+</span>
<a href="#l13.679"></a><span id="l13.679" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetRecipients(char **resultRecipients) {</span>
<a href="#l13.680"></a><span id="l13.680" class="difflineplus">+  return m_mdb-&gt;RowCellColumnToCharPtr(</span>
<a href="#l13.681"></a><span id="l13.681" class="difflineplus">+      GetMDBRow(), m_mdb-&gt;m_recipientsColumnToken, resultRecipients);</span>
<a href="#l13.682"></a><span id="l13.682"> }</span>
<a href="#l13.683"></a><span id="l13.683"> </span>
<a href="#l13.684"></a><span id="l13.684" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetRecipients(char* *resultRecipients)</span>
<a href="#l13.685"></a><span id="l13.685" class="difflineminus">-{</span>
<a href="#l13.686"></a><span id="l13.686" class="difflineminus">-  return m_mdb-&gt;RowCellColumnToCharPtr(GetMDBRow(), m_mdb-&gt;m_recipientsColumnToken, resultRecipients);</span>
<a href="#l13.687"></a><span id="l13.687" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetCcList(char **resultCCList) {</span>
<a href="#l13.688"></a><span id="l13.688" class="difflineplus">+  return m_mdb-&gt;RowCellColumnToCharPtr(GetMDBRow(), m_mdb-&gt;m_ccListColumnToken,</span>
<a href="#l13.689"></a><span id="l13.689" class="difflineplus">+                                       resultCCList);</span>
<a href="#l13.690"></a><span id="l13.690"> }</span>
<a href="#l13.691"></a><span id="l13.691"> </span>
<a href="#l13.692"></a><span id="l13.692" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetCcList(char * *resultCCList)</span>
<a href="#l13.693"></a><span id="l13.693" class="difflineminus">-{</span>
<a href="#l13.694"></a><span id="l13.694" class="difflineminus">-  return m_mdb-&gt;RowCellColumnToCharPtr(GetMDBRow(), m_mdb-&gt;m_ccListColumnToken, resultCCList);</span>
<a href="#l13.695"></a><span id="l13.695" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetBccList(char **resultBCCList) {</span>
<a href="#l13.696"></a><span id="l13.696" class="difflineplus">+  return m_mdb-&gt;RowCellColumnToCharPtr(GetMDBRow(), m_mdb-&gt;m_bccListColumnToken,</span>
<a href="#l13.697"></a><span id="l13.697" class="difflineplus">+                                       resultBCCList);</span>
<a href="#l13.698"></a><span id="l13.698"> }</span>
<a href="#l13.699"></a><span id="l13.699"> </span>
<a href="#l13.700"></a><span id="l13.700" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetBccList(char * *resultBCCList)</span>
<a href="#l13.701"></a><span id="l13.701" class="difflineminus">-{</span>
<a href="#l13.702"></a><span id="l13.702" class="difflineminus">-  return m_mdb-&gt;RowCellColumnToCharPtr(GetMDBRow(), m_mdb-&gt;m_bccListColumnToken, resultBCCList);</span>
<a href="#l13.703"></a><span id="l13.703" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetMessageId(char **resultMessageId) {</span>
<a href="#l13.704"></a><span id="l13.704" class="difflineplus">+  return m_mdb-&gt;RowCellColumnToCharPtr(</span>
<a href="#l13.705"></a><span id="l13.705" class="difflineplus">+      GetMDBRow(), m_mdb-&gt;m_messageIdColumnToken, resultMessageId);</span>
<a href="#l13.706"></a><span id="l13.706"> }</span>
<a href="#l13.707"></a><span id="l13.707"> </span>
<a href="#l13.708"></a><span id="l13.708" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetMessageId(char * *resultMessageId)</span>
<a href="#l13.709"></a><span id="l13.709" class="difflineminus">-{</span>
<a href="#l13.710"></a><span id="l13.710" class="difflineminus">-  return m_mdb-&gt;RowCellColumnToCharPtr(GetMDBRow(), m_mdb-&gt;m_messageIdColumnToken, resultMessageId);</span>
<a href="#l13.711"></a><span id="l13.711" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetMime2DecodedAuthor(nsAString &amp;resultAuthor) {</span>
<a href="#l13.712"></a><span id="l13.712" class="difflineplus">+  return m_mdb-&gt;RowCellColumnToMime2DecodedString(</span>
<a href="#l13.713"></a><span id="l13.713" class="difflineplus">+      GetMDBRow(), m_mdb-&gt;m_senderColumnToken, resultAuthor);</span>
<a href="#l13.714"></a><span id="l13.714"> }</span>
<a href="#l13.715"></a><span id="l13.715"> </span>
<a href="#l13.716"></a><span id="l13.716" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetMime2DecodedAuthor(nsAString &amp;resultAuthor)</span>
<a href="#l13.717"></a><span id="l13.717" class="difflineminus">-{</span>
<a href="#l13.718"></a><span id="l13.718" class="difflineminus">-  return m_mdb-&gt;RowCellColumnToMime2DecodedString(GetMDBRow(), m_mdb-&gt;m_senderColumnToken, resultAuthor);</span>
<a href="#l13.719"></a><span id="l13.719" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetMime2DecodedSubject(nsAString &amp;resultSubject) {</span>
<a href="#l13.720"></a><span id="l13.720" class="difflineplus">+  return m_mdb-&gt;RowCellColumnToMime2DecodedString(</span>
<a href="#l13.721"></a><span id="l13.721" class="difflineplus">+      GetMDBRow(), m_mdb-&gt;m_subjectColumnToken, resultSubject);</span>
<a href="#l13.722"></a><span id="l13.722"> }</span>
<a href="#l13.723"></a><span id="l13.723"> </span>
<a href="#l13.724"></a><span id="l13.724" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetMime2DecodedSubject(nsAString &amp;resultSubject)</span>
<a href="#l13.725"></a><span id="l13.725" class="difflineminus">-{</span>
<a href="#l13.726"></a><span id="l13.726" class="difflineminus">-  return m_mdb-&gt;RowCellColumnToMime2DecodedString(GetMDBRow(), m_mdb-&gt;m_subjectColumnToken, resultSubject);</span>
<a href="#l13.727"></a><span id="l13.727" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetMime2DecodedRecipients(nsAString &amp;resultRecipients) {</span>
<a href="#l13.728"></a><span id="l13.728" class="difflineplus">+  return m_mdb-&gt;RowCellColumnToMime2DecodedString(</span>
<a href="#l13.729"></a><span id="l13.729" class="difflineplus">+      GetMDBRow(), m_mdb-&gt;m_recipientsColumnToken, resultRecipients);</span>
<a href="#l13.730"></a><span id="l13.730"> }</span>
<a href="#l13.731"></a><span id="l13.731"> </span>
<a href="#l13.732"></a><span id="l13.732" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetMime2DecodedRecipients(nsAString &amp;resultRecipients)</span>
<a href="#l13.733"></a><span id="l13.733" class="difflineminus">-{</span>
<a href="#l13.734"></a><span id="l13.734" class="difflineminus">-  return m_mdb-&gt;RowCellColumnToMime2DecodedString(GetMDBRow(), m_mdb-&gt;m_recipientsColumnToken, resultRecipients);</span>
<a href="#l13.735"></a><span id="l13.735" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetAuthorCollationKey(uint32_t *len,</span>
<a href="#l13.736"></a><span id="l13.736" class="difflineplus">+                                              uint8_t **resultAuthor) {</span>
<a href="#l13.737"></a><span id="l13.737" class="difflineplus">+  return m_mdb-&gt;RowCellColumnToAddressCollationKey(</span>
<a href="#l13.738"></a><span id="l13.738" class="difflineplus">+      GetMDBRow(), m_mdb-&gt;m_senderColumnToken, resultAuthor, len);</span>
<a href="#l13.739"></a><span id="l13.739"> }</span>
<a href="#l13.740"></a><span id="l13.740"> </span>
<a href="#l13.741"></a><span id="l13.741" class="difflineminus">-</span>
<a href="#l13.742"></a><span id="l13.742" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetAuthorCollationKey(uint32_t *len, uint8_t **resultAuthor)</span>
<a href="#l13.743"></a><span id="l13.743" class="difflineminus">-{</span>
<a href="#l13.744"></a><span id="l13.744" class="difflineminus">-  return m_mdb-&gt;RowCellColumnToAddressCollationKey(GetMDBRow(), m_mdb-&gt;m_senderColumnToken, resultAuthor, len);</span>
<a href="#l13.745"></a><span id="l13.745" class="difflineminus">-}</span>
<a href="#l13.746"></a><span id="l13.746" class="difflineminus">-</span>
<a href="#l13.747"></a><span id="l13.747" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetSubjectCollationKey(uint32_t *len, uint8_t **resultSubject)</span>
<a href="#l13.748"></a><span id="l13.748" class="difflineminus">-{</span>
<a href="#l13.749"></a><span id="l13.749" class="difflineminus">-  return m_mdb-&gt;RowCellColumnToCollationKey(GetMDBRow(), m_mdb-&gt;m_subjectColumnToken, resultSubject, len);</span>
<a href="#l13.750"></a><span id="l13.750" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetSubjectCollationKey(uint32_t *len,</span>
<a href="#l13.751"></a><span id="l13.751" class="difflineplus">+                                               uint8_t **resultSubject) {</span>
<a href="#l13.752"></a><span id="l13.752" class="difflineplus">+  return m_mdb-&gt;RowCellColumnToCollationKey(</span>
<a href="#l13.753"></a><span id="l13.753" class="difflineplus">+      GetMDBRow(), m_mdb-&gt;m_subjectColumnToken, resultSubject, len);</span>
<a href="#l13.754"></a><span id="l13.754"> }</span>
<a href="#l13.755"></a><span id="l13.755"> </span>
<a href="#l13.756"></a><span id="l13.756" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetRecipientsCollationKey(uint32_t *len, uint8_t **resultRecipients)</span>
<a href="#l13.757"></a><span id="l13.757" class="difflineminus">-{</span>
<a href="#l13.758"></a><span id="l13.758" class="difflineminus">-  return m_mdb-&gt;RowCellColumnToCollationKey(GetMDBRow(), m_mdb-&gt;m_recipientsColumnToken, resultRecipients, len);</span>
<a href="#l13.759"></a><span id="l13.759" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetRecipientsCollationKey(uint32_t *len,</span>
<a href="#l13.760"></a><span id="l13.760" class="difflineplus">+                                                  uint8_t **resultRecipients) {</span>
<a href="#l13.761"></a><span id="l13.761" class="difflineplus">+  return m_mdb-&gt;RowCellColumnToCollationKey(</span>
<a href="#l13.762"></a><span id="l13.762" class="difflineplus">+      GetMDBRow(), m_mdb-&gt;m_recipientsColumnToken, resultRecipients, len);</span>
<a href="#l13.763"></a><span id="l13.763"> }</span>
<a href="#l13.764"></a><span id="l13.764"> </span>
<a href="#l13.765"></a><span id="l13.765" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetCharset(char **aCharset)</span>
<a href="#l13.766"></a><span id="l13.766" class="difflineminus">-{</span>
<a href="#l13.767"></a><span id="l13.767" class="difflineminus">-  return m_mdb-&gt;RowCellColumnToCharPtr(GetMDBRow(), m_mdb-&gt;m_messageCharSetColumnToken, aCharset);</span>
<a href="#l13.768"></a><span id="l13.768" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetCharset(char **aCharset) {</span>
<a href="#l13.769"></a><span id="l13.769" class="difflineplus">+  return m_mdb-&gt;RowCellColumnToCharPtr(</span>
<a href="#l13.770"></a><span id="l13.770" class="difflineplus">+      GetMDBRow(), m_mdb-&gt;m_messageCharSetColumnToken, aCharset);</span>
<a href="#l13.771"></a><span id="l13.771"> }</span>
<a href="#l13.772"></a><span id="l13.772"> </span>
<a href="#l13.773"></a><span id="l13.773" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetCharset(const char *aCharset)</span>
<a href="#l13.774"></a><span id="l13.774" class="difflineminus">-{</span>
<a href="#l13.775"></a><span id="l13.775" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetCharset(const char *aCharset) {</span>
<a href="#l13.776"></a><span id="l13.776">   return SetStringColumn(aCharset, m_mdb-&gt;m_messageCharSetColumnToken);</span>
<a href="#l13.777"></a><span id="l13.777"> }</span>
<a href="#l13.778"></a><span id="l13.778"> </span>
<a href="#l13.779"></a><span id="l13.779" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetEffectiveCharset(nsACString &amp;resultCharset)</span>
<a href="#l13.780"></a><span id="l13.780" class="difflineminus">-{</span>
<a href="#l13.781"></a><span id="l13.781" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetEffectiveCharset(nsACString &amp;resultCharset) {</span>
<a href="#l13.782"></a><span id="l13.782">   return m_mdb-&gt;GetEffectiveCharset(m_mdbRow, resultCharset);</span>
<a href="#l13.783"></a><span id="l13.783"> }</span>
<a href="#l13.784"></a><span id="l13.784"> </span>
<a href="#l13.785"></a><span id="l13.785" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::SetThreadParent(nsMsgKey inKey)</span>
<a href="#l13.786"></a><span id="l13.786" class="difflineminus">-{</span>
<a href="#l13.787"></a><span id="l13.787" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::SetThreadParent(nsMsgKey inKey) {</span>
<a href="#l13.788"></a><span id="l13.788">   m_threadParent = inKey;</span>
<a href="#l13.789"></a><span id="l13.789" class="difflineminus">-  if (inKey == m_messageKey)</span>
<a href="#l13.790"></a><span id="l13.790" class="difflineminus">-    NS_ASSERTION(false, &quot;can't be your own parent&quot;);</span>
<a href="#l13.791"></a><span id="l13.791" class="difflineplus">+  if (inKey == m_messageKey) NS_ASSERTION(false, &quot;can't be your own parent&quot;);</span>
<a href="#l13.792"></a><span id="l13.792">   SetUInt32Column(m_threadParent, m_mdb-&gt;m_threadParentColumnToken);</span>
<a href="#l13.793"></a><span id="l13.793">   m_initedValues |= THREAD_PARENT_INITED;</span>
<a href="#l13.794"></a><span id="l13.794">   return NS_OK;</span>
<a href="#l13.795"></a><span id="l13.795"> }</span>
<a href="#l13.796"></a><span id="l13.796"> </span>
<a href="#l13.797"></a><span id="l13.797" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetThreadParent(nsMsgKey *result)</span>
<a href="#l13.798"></a><span id="l13.798" class="difflineminus">-{</span>
<a href="#l13.799"></a><span id="l13.799" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetThreadParent(nsMsgKey *result) {</span>
<a href="#l13.800"></a><span id="l13.800">   nsresult res;</span>
<a href="#l13.801"></a><span id="l13.801" class="difflineminus">-  if(!(m_initedValues &amp; THREAD_PARENT_INITED))</span>
<a href="#l13.802"></a><span id="l13.802" class="difflineminus">-  {</span>
<a href="#l13.803"></a><span id="l13.803" class="difflineminus">-    res = GetUInt32Column(m_mdb-&gt;m_threadParentColumnToken, &amp;m_threadParent, nsMsgKey_None);</span>
<a href="#l13.804"></a><span id="l13.804" class="difflineminus">-    if (NS_SUCCEEDED(res))</span>
<a href="#l13.805"></a><span id="l13.805" class="difflineminus">-      m_initedValues |= THREAD_PARENT_INITED;</span>
<a href="#l13.806"></a><span id="l13.806" class="difflineplus">+  if (!(m_initedValues &amp; THREAD_PARENT_INITED)) {</span>
<a href="#l13.807"></a><span id="l13.807" class="difflineplus">+    res = GetUInt32Column(m_mdb-&gt;m_threadParentColumnToken, &amp;m_threadParent,</span>
<a href="#l13.808"></a><span id="l13.808" class="difflineplus">+                          nsMsgKey_None);</span>
<a href="#l13.809"></a><span id="l13.809" class="difflineplus">+    if (NS_SUCCEEDED(res)) m_initedValues |= THREAD_PARENT_INITED;</span>
<a href="#l13.810"></a><span id="l13.810">   }</span>
<a href="#l13.811"></a><span id="l13.811">   *result = m_threadParent;</span>
<a href="#l13.812"></a><span id="l13.812">   return NS_OK;</span>
<a href="#l13.813"></a><span id="l13.813"> }</span>
<a href="#l13.814"></a><span id="l13.814"> </span>
<a href="#l13.815"></a><span id="l13.815" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetFolder(nsIMsgFolder **result)</span>
<a href="#l13.816"></a><span id="l13.816" class="difflineminus">-{</span>
<a href="#l13.817"></a><span id="l13.817" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetFolder(nsIMsgFolder **result) {</span>
<a href="#l13.818"></a><span id="l13.818">   NS_ENSURE_ARG(result);</span>
<a href="#l13.819"></a><span id="l13.819"> </span>
<a href="#l13.820"></a><span id="l13.820" class="difflineminus">-  if (m_mdb &amp;&amp; m_mdb-&gt;m_folder)</span>
<a href="#l13.821"></a><span id="l13.821" class="difflineminus">-  {</span>
<a href="#l13.822"></a><span id="l13.822" class="difflineplus">+  if (m_mdb &amp;&amp; m_mdb-&gt;m_folder) {</span>
<a href="#l13.823"></a><span id="l13.823">     NS_ADDREF(*result = m_mdb-&gt;m_folder);</span>
<a href="#l13.824"></a><span id="l13.824" class="difflineminus">-  }</span>
<a href="#l13.825"></a><span id="l13.825" class="difflineminus">-  else</span>
<a href="#l13.826"></a><span id="l13.826" class="difflineplus">+  } else</span>
<a href="#l13.827"></a><span id="l13.827">     *result = nullptr;</span>
<a href="#l13.828"></a><span id="l13.828">   return NS_OK;</span>
<a href="#l13.829"></a><span id="l13.829"> }</span>
<a href="#l13.830"></a><span id="l13.830"> </span>
<a href="#l13.831"></a><span id="l13.831" class="difflineminus">-nsresult nsMsgHdr::SetStringColumn(const char *str, mdb_token token)</span>
<a href="#l13.832"></a><span id="l13.832" class="difflineminus">-{</span>
<a href="#l13.833"></a><span id="l13.833" class="difflineplus">+nsresult nsMsgHdr::SetStringColumn(const char *str, mdb_token token) {</span>
<a href="#l13.834"></a><span id="l13.834">   NS_ENSURE_ARG_POINTER(str);</span>
<a href="#l13.835"></a><span id="l13.835">   return m_mdb-&gt;CharPtrToRowCellColumn(m_mdbRow, token, str);</span>
<a href="#l13.836"></a><span id="l13.836"> }</span>
<a href="#l13.837"></a><span id="l13.837"> </span>
<a href="#l13.838"></a><span id="l13.838" class="difflineminus">-nsresult nsMsgHdr::SetUInt32Column(uint32_t value, mdb_token token)</span>
<a href="#l13.839"></a><span id="l13.839" class="difflineminus">-{</span>
<a href="#l13.840"></a><span id="l13.840" class="difflineplus">+nsresult nsMsgHdr::SetUInt32Column(uint32_t value, mdb_token token) {</span>
<a href="#l13.841"></a><span id="l13.841">   return m_mdb-&gt;UInt32ToRowCellColumn(m_mdbRow, token, value);</span>
<a href="#l13.842"></a><span id="l13.842"> }</span>
<a href="#l13.843"></a><span id="l13.843"> </span>
<a href="#l13.844"></a><span id="l13.844" class="difflineminus">-nsresult nsMsgHdr::GetUInt32Column(mdb_token token, uint32_t *pvalue, uint32_t defaultValue)</span>
<a href="#l13.845"></a><span id="l13.845" class="difflineminus">-{</span>
<a href="#l13.846"></a><span id="l13.846" class="difflineplus">+nsresult nsMsgHdr::GetUInt32Column(mdb_token token, uint32_t *pvalue,</span>
<a href="#l13.847"></a><span id="l13.847" class="difflineplus">+                                   uint32_t defaultValue) {</span>
<a href="#l13.848"></a><span id="l13.848">   return m_mdb-&gt;RowCellColumnToUInt32(GetMDBRow(), token, pvalue, defaultValue);</span>
<a href="#l13.849"></a><span id="l13.849"> }</span>
<a href="#l13.850"></a><span id="l13.850"> </span>
<a href="#l13.851"></a><span id="l13.851" class="difflineminus">-nsresult nsMsgHdr::SetUInt64Column(uint64_t value, mdb_token token)</span>
<a href="#l13.852"></a><span id="l13.852" class="difflineminus">-{</span>
<a href="#l13.853"></a><span id="l13.853" class="difflineplus">+nsresult nsMsgHdr::SetUInt64Column(uint64_t value, mdb_token token) {</span>
<a href="#l13.854"></a><span id="l13.854">   return m_mdb-&gt;UInt64ToRowCellColumn(m_mdbRow, token, value);</span>
<a href="#l13.855"></a><span id="l13.855"> }</span>
<a href="#l13.856"></a><span id="l13.856"> </span>
<a href="#l13.857"></a><span id="l13.857" class="difflineminus">-nsresult nsMsgHdr::GetUInt64Column(mdb_token token, uint64_t *pvalue, uint64_t defaultValue)</span>
<a href="#l13.858"></a><span id="l13.858" class="difflineminus">-{</span>
<a href="#l13.859"></a><span id="l13.859" class="difflineplus">+nsresult nsMsgHdr::GetUInt64Column(mdb_token token, uint64_t *pvalue,</span>
<a href="#l13.860"></a><span id="l13.860" class="difflineplus">+                                   uint64_t defaultValue) {</span>
<a href="#l13.861"></a><span id="l13.861">   return m_mdb-&gt;RowCellColumnToUInt64(GetMDBRow(), token, pvalue, defaultValue);</span>
<a href="#l13.862"></a><span id="l13.862"> }</span>
<a href="#l13.863"></a><span id="l13.863"> </span>
<a href="#l13.864"></a><span id="l13.864"> /**</span>
<a href="#l13.865"></a><span id="l13.865">  * Roughly speaking, get the next message-id (starts with a '&lt;' ends with a</span>
<a href="#l13.866"></a><span id="l13.866">  *  '&gt;').  Except, we also try to handle the case where your reference is of</span>
<a href="#l13.867"></a><span id="l13.867">  *  a prehistoric vintage that just stuck any old random junk in there.  Our</span>
<a href="#l13.868"></a><span id="l13.868">  *  old logic would (unintentionally?) just trim the whitespace off the front</span>
<a href="#l13.869"></a><span id="l13.869" class="difflineat">@@ -729,367 +631,320 @@ nsresult nsMsgHdr::GetUInt64Column(mdb_t</span>
<a href="#l13.870"></a><span id="l13.870">  *     function, as if you are around to make a second call, it means we found</span>
<a href="#l13.871"></a><span id="l13.871">  *     a properly formatted message-id and so we should only look for more</span>
<a href="#l13.872"></a><span id="l13.872">  *     properly formatted message-ids.</span>
<a href="#l13.873"></a><span id="l13.873">  * @returns The next starting position of this routine, which may be pointing at</span>
<a href="#l13.874"></a><span id="l13.874">  *     a nul '\0' character to indicate termination.</span>
<a href="#l13.875"></a><span id="l13.875">  */</span>
<a href="#l13.876"></a><span id="l13.876"> const char *nsMsgHdr::GetNextReference(const char *startNextRef,</span>
<a href="#l13.877"></a><span id="l13.877">                                        nsCString &amp;reference,</span>
<a href="#l13.878"></a><span id="l13.878" class="difflineminus">-                                       bool acceptNonDelimitedReferences)</span>
<a href="#l13.879"></a><span id="l13.879" class="difflineminus">-{</span>
<a href="#l13.880"></a><span id="l13.880" class="difflineplus">+                                       bool acceptNonDelimitedReferences) {</span>
<a href="#l13.881"></a><span id="l13.881">   const char *ptr = startNextRef;</span>
<a href="#l13.882"></a><span id="l13.882">   const char *whitespaceEndedAt = nullptr;</span>
<a href="#l13.883"></a><span id="l13.883">   const char *firstMessageIdChar = nullptr;</span>
<a href="#l13.884"></a><span id="l13.884"> </span>
<a href="#l13.885"></a><span id="l13.885">   // make the reference result string empty by default; we will set it to</span>
<a href="#l13.886"></a><span id="l13.886">   //  something valid if the time comes.</span>
<a href="#l13.887"></a><span id="l13.887">   reference.Truncate();</span>
<a href="#l13.888"></a><span id="l13.888"> </span>
<a href="#l13.889"></a><span id="l13.889">   // walk until we find a '&lt;', but keep track of the first point we found that</span>
<a href="#l13.890"></a><span id="l13.890">   //  was not whitespace (as defined by previous versions of this code.)</span>
<a href="#l13.891"></a><span id="l13.891" class="difflineminus">-  for (bool foundLessThan = false; !foundLessThan; ptr++)</span>
<a href="#l13.892"></a><span id="l13.892" class="difflineminus">-  {</span>
<a href="#l13.893"></a><span id="l13.893" class="difflineminus">-    switch (*ptr)</span>
<a href="#l13.894"></a><span id="l13.894" class="difflineminus">-    {</span>
<a href="#l13.895"></a><span id="l13.895" class="difflineplus">+  for (bool foundLessThan = false; !foundLessThan; ptr++) {</span>
<a href="#l13.896"></a><span id="l13.896" class="difflineplus">+    switch (*ptr) {</span>
<a href="#l13.897"></a><span id="l13.897">       case '\0':</span>
<a href="#l13.898"></a><span id="l13.898">         // if we are at the end of the string, we found some non-whitespace, and</span>
<a href="#l13.899"></a><span id="l13.899">         //  the caller requested that we accept non-delimited whitespace,</span>
<a href="#l13.900"></a><span id="l13.900">         //  give them that as their reference.  (otherwise, leave it empty)</span>
<a href="#l13.901"></a><span id="l13.901">         if (acceptNonDelimitedReferences &amp;&amp; whitespaceEndedAt)</span>
<a href="#l13.902"></a><span id="l13.902">           reference = whitespaceEndedAt;</span>
<a href="#l13.903"></a><span id="l13.903">         return ptr;</span>
<a href="#l13.904"></a><span id="l13.904">       case ' ':</span>
<a href="#l13.905"></a><span id="l13.905">       case '\r':</span>
<a href="#l13.906"></a><span id="l13.906">       case '\n':</span>
<a href="#l13.907"></a><span id="l13.907">       case '\t':</span>
<a href="#l13.908"></a><span id="l13.908">         // do nothing, make default case mean you didn't get whitespace</span>
<a href="#l13.909"></a><span id="l13.909">         break;</span>
<a href="#l13.910"></a><span id="l13.910">       case '&lt;':</span>
<a href="#l13.911"></a><span id="l13.911" class="difflineminus">-        firstMessageIdChar = ++ptr; // skip over the '&lt;'</span>
<a href="#l13.912"></a><span id="l13.912" class="difflineminus">-        foundLessThan = true; // (flag to stop)</span>
<a href="#l13.913"></a><span id="l13.913" class="difflineplus">+        firstMessageIdChar = ++ptr;  // skip over the '&lt;'</span>
<a href="#l13.914"></a><span id="l13.914" class="difflineplus">+        foundLessThan = true;        // (flag to stop)</span>
<a href="#l13.915"></a><span id="l13.915">         // intentional fallthrough so whitespaceEndedAt will definitely have</span>
<a href="#l13.916"></a><span id="l13.916">         //  a non-NULL value, just in case the message-id is not valid (no '&gt;')</span>
<a href="#l13.917"></a><span id="l13.917">         //  and the old-school support is desired.</span>
<a href="#l13.918"></a><span id="l13.918">         MOZ_FALLTHROUGH;</span>
<a href="#l13.919"></a><span id="l13.919">       default:</span>
<a href="#l13.920"></a><span id="l13.920" class="difflineminus">-        if (!whitespaceEndedAt)</span>
<a href="#l13.921"></a><span id="l13.921" class="difflineminus">-            whitespaceEndedAt = ptr;</span>
<a href="#l13.922"></a><span id="l13.922" class="difflineplus">+        if (!whitespaceEndedAt) whitespaceEndedAt = ptr;</span>
<a href="#l13.923"></a><span id="l13.923">         break;</span>
<a href="#l13.924"></a><span id="l13.924">     }</span>
<a href="#l13.925"></a><span id="l13.925">   }</span>
<a href="#l13.926"></a><span id="l13.926"> </span>
<a href="#l13.927"></a><span id="l13.927">   // keep going until we hit a '&gt;' or hit the end of the string</span>
<a href="#l13.928"></a><span id="l13.928" class="difflineminus">-  for(; *ptr ; ptr++)</span>
<a href="#l13.929"></a><span id="l13.929" class="difflineminus">-  {</span>
<a href="#l13.930"></a><span id="l13.930" class="difflineminus">-    if (*ptr == '&gt;')</span>
<a href="#l13.931"></a><span id="l13.931" class="difflineminus">-    {</span>
<a href="#l13.932"></a><span id="l13.932" class="difflineplus">+  for (; *ptr; ptr++) {</span>
<a href="#l13.933"></a><span id="l13.933" class="difflineplus">+    if (*ptr == '&gt;') {</span>
<a href="#l13.934"></a><span id="l13.934">       // it's valid, update reference, making sure to stop before the '&gt;'</span>
<a href="#l13.935"></a><span id="l13.935">       reference.Assign(firstMessageIdChar, ptr - firstMessageIdChar);</span>
<a href="#l13.936"></a><span id="l13.936">       // and return a start point just after the '&gt;'</span>
<a href="#l13.937"></a><span id="l13.937">       return ++ptr;</span>
<a href="#l13.938"></a><span id="l13.938">     }</span>
<a href="#l13.939"></a><span id="l13.939">   }</span>
<a href="#l13.940"></a><span id="l13.940"> </span>
<a href="#l13.941"></a><span id="l13.941">   // we did not have a fully-formed, valid message-id, so consider falling back</span>
<a href="#l13.942"></a><span id="l13.942">   if (acceptNonDelimitedReferences &amp;&amp; whitespaceEndedAt)</span>
<a href="#l13.943"></a><span id="l13.943">     reference = whitespaceEndedAt;</span>
<a href="#l13.944"></a><span id="l13.944">   return ptr;</span>
<a href="#l13.945"></a><span id="l13.945"> }</span>
<a href="#l13.946"></a><span id="l13.946"> </span>
<a href="#l13.947"></a><span id="l13.947" class="difflineminus">-bool nsMsgHdr::IsParentOf(nsIMsgDBHdr *possibleChild)</span>
<a href="#l13.948"></a><span id="l13.948" class="difflineminus">-{</span>
<a href="#l13.949"></a><span id="l13.949" class="difflineplus">+bool nsMsgHdr::IsParentOf(nsIMsgDBHdr *possibleChild) {</span>
<a href="#l13.950"></a><span id="l13.950">   uint16_t referenceToCheck = 0;</span>
<a href="#l13.951"></a><span id="l13.951">   possibleChild-&gt;GetNumReferences(&amp;referenceToCheck);</span>
<a href="#l13.952"></a><span id="l13.952">   nsAutoCString reference;</span>
<a href="#l13.953"></a><span id="l13.953"> </span>
<a href="#l13.954"></a><span id="l13.954">   nsCString messageId;</span>
<a href="#l13.955"></a><span id="l13.955">   GetMessageId(getter_Copies(messageId));</span>
<a href="#l13.956"></a><span id="l13.956"> </span>
<a href="#l13.957"></a><span id="l13.957" class="difflineminus">-  while (referenceToCheck &gt; 0)</span>
<a href="#l13.958"></a><span id="l13.958" class="difflineminus">-  {</span>
<a href="#l13.959"></a><span id="l13.959" class="difflineplus">+  while (referenceToCheck &gt; 0) {</span>
<a href="#l13.960"></a><span id="l13.960">     possibleChild-&gt;GetStringReference(referenceToCheck - 1, reference);</span>
<a href="#l13.961"></a><span id="l13.961"> </span>
<a href="#l13.962"></a><span id="l13.962" class="difflineminus">-    if (reference.Equals(messageId))</span>
<a href="#l13.963"></a><span id="l13.963" class="difflineminus">-      return true;</span>
<a href="#l13.964"></a><span id="l13.964" class="difflineplus">+    if (reference.Equals(messageId)) return true;</span>
<a href="#l13.965"></a><span id="l13.965">     // if reference didn't match, check if this ref is for a non-existent</span>
<a href="#l13.966"></a><span id="l13.966">     // header. If it is, continue looking at ancestors.</span>
<a href="#l13.967"></a><span id="l13.967" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; refHdr;</span>
<a href="#l13.968"></a><span id="l13.968" class="difflineminus">-    if (!m_mdb)</span>
<a href="#l13.969"></a><span id="l13.969" class="difflineminus">-      break;</span>
<a href="#l13.970"></a><span id="l13.970" class="difflineminus">-    (void) m_mdb-&gt;GetMsgHdrForMessageID(reference.get(), getter_AddRefs(refHdr));</span>
<a href="#l13.971"></a><span id="l13.971" class="difflineminus">-    if (refHdr)</span>
<a href="#l13.972"></a><span id="l13.972" class="difflineminus">-      break;</span>
<a href="#l13.973"></a><span id="l13.973" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; refHdr;</span>
<a href="#l13.974"></a><span id="l13.974" class="difflineplus">+    if (!m_mdb) break;</span>
<a href="#l13.975"></a><span id="l13.975" class="difflineplus">+    (void)m_mdb-&gt;GetMsgHdrForMessageID(reference.get(), getter_AddRefs(refHdr));</span>
<a href="#l13.976"></a><span id="l13.976" class="difflineplus">+    if (refHdr) break;</span>
<a href="#l13.977"></a><span id="l13.977">     referenceToCheck--;</span>
<a href="#l13.978"></a><span id="l13.978">   }</span>
<a href="#l13.979"></a><span id="l13.979">   return false;</span>
<a href="#l13.980"></a><span id="l13.980"> }</span>
<a href="#l13.981"></a><span id="l13.981"> </span>
<a href="#l13.982"></a><span id="l13.982" class="difflineminus">-bool nsMsgHdr::IsAncestorOf(nsIMsgDBHdr *possibleChild)</span>
<a href="#l13.983"></a><span id="l13.983" class="difflineminus">-{</span>
<a href="#l13.984"></a><span id="l13.984" class="difflineplus">+bool nsMsgHdr::IsAncestorOf(nsIMsgDBHdr *possibleChild) {</span>
<a href="#l13.985"></a><span id="l13.985">   const char *references;</span>
<a href="#l13.986"></a><span id="l13.986" class="difflineminus">-  nsMsgHdr* curHdr = static_cast&lt;nsMsgHdr*&gt;(possibleChild);      // closed system, cast ok</span>
<a href="#l13.987"></a><span id="l13.987" class="difflineminus">-  m_mdb-&gt;RowCellColumnToConstCharPtr(curHdr-&gt;GetMDBRow(), m_mdb-&gt;m_referencesColumnToken, &amp;references);</span>
<a href="#l13.988"></a><span id="l13.988" class="difflineminus">-  if (!references)</span>
<a href="#l13.989"></a><span id="l13.989" class="difflineminus">-    return false;</span>
<a href="#l13.990"></a><span id="l13.990" class="difflineplus">+  nsMsgHdr *curHdr =</span>
<a href="#l13.991"></a><span id="l13.991" class="difflineplus">+      static_cast&lt;nsMsgHdr *&gt;(possibleChild);  // closed system, cast ok</span>
<a href="#l13.992"></a><span id="l13.992" class="difflineplus">+  m_mdb-&gt;RowCellColumnToConstCharPtr(</span>
<a href="#l13.993"></a><span id="l13.993" class="difflineplus">+      curHdr-&gt;GetMDBRow(), m_mdb-&gt;m_referencesColumnToken, &amp;references);</span>
<a href="#l13.994"></a><span id="l13.994" class="difflineplus">+  if (!references) return false;</span>
<a href="#l13.995"></a><span id="l13.995"> </span>
<a href="#l13.996"></a><span id="l13.996">   nsCString messageId;</span>
<a href="#l13.997"></a><span id="l13.997">   // should put &lt; &gt; around message id to make strstr strictly match</span>
<a href="#l13.998"></a><span id="l13.998">   GetMessageId(getter_Copies(messageId));</span>
<a href="#l13.999"></a><span id="l13.999">   return (strstr(references, messageId.get()) != nullptr);</span>
<a href="#l13.1000"></a><span id="l13.1000"> }</span>
<a href="#l13.1001"></a><span id="l13.1001"> </span>
<a href="#l13.1002"></a><span id="l13.1002" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetIsRead(bool *isRead)</span>
<a href="#l13.1003"></a><span id="l13.1003" class="difflineminus">-{</span>
<a href="#l13.1004"></a><span id="l13.1004" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetIsRead(bool *isRead) {</span>
<a href="#l13.1005"></a><span id="l13.1005">   NS_ENSURE_ARG_POINTER(isRead);</span>
<a href="#l13.1006"></a><span id="l13.1006" class="difflineminus">-  if (!(m_initedValues &amp; FLAGS_INITED))</span>
<a href="#l13.1007"></a><span id="l13.1007" class="difflineminus">-    InitFlags();</span>
<a href="#l13.1008"></a><span id="l13.1008" class="difflineplus">+  if (!(m_initedValues &amp; FLAGS_INITED)) InitFlags();</span>
<a href="#l13.1009"></a><span id="l13.1009">   *isRead = !!(m_flags &amp; nsMsgMessageFlags::Read);</span>
<a href="#l13.1010"></a><span id="l13.1010">   return NS_OK;</span>
<a href="#l13.1011"></a><span id="l13.1011"> }</span>
<a href="#l13.1012"></a><span id="l13.1012"> </span>
<a href="#l13.1013"></a><span id="l13.1013" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetIsFlagged(bool *isFlagged)</span>
<a href="#l13.1014"></a><span id="l13.1014" class="difflineminus">-{</span>
<a href="#l13.1015"></a><span id="l13.1015" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetIsFlagged(bool *isFlagged) {</span>
<a href="#l13.1016"></a><span id="l13.1016">   NS_ENSURE_ARG_POINTER(isFlagged);</span>
<a href="#l13.1017"></a><span id="l13.1017" class="difflineminus">-  if (!(m_initedValues &amp; FLAGS_INITED))</span>
<a href="#l13.1018"></a><span id="l13.1018" class="difflineminus">-    InitFlags();</span>
<a href="#l13.1019"></a><span id="l13.1019" class="difflineplus">+  if (!(m_initedValues &amp; FLAGS_INITED)) InitFlags();</span>
<a href="#l13.1020"></a><span id="l13.1020">   *isFlagged = !!(m_flags &amp; nsMsgMessageFlags::Marked);</span>
<a href="#l13.1021"></a><span id="l13.1021">   return NS_OK;</span>
<a href="#l13.1022"></a><span id="l13.1022"> }</span>
<a href="#l13.1023"></a><span id="l13.1023"> </span>
<a href="#l13.1024"></a><span id="l13.1024" class="difflineminus">-void nsMsgHdr::ReparentInThread(nsIMsgThread *thread)</span>
<a href="#l13.1025"></a><span id="l13.1025" class="difflineminus">-{</span>
<a href="#l13.1026"></a><span id="l13.1026" class="difflineplus">+void nsMsgHdr::ReparentInThread(nsIMsgThread *thread) {</span>
<a href="#l13.1027"></a><span id="l13.1027">   NS_WARNING(&quot;Borked message header, attempting to fix!&quot;);</span>
<a href="#l13.1028"></a><span id="l13.1028">   uint32_t numChildren;</span>
<a href="#l13.1029"></a><span id="l13.1029">   thread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l13.1030"></a><span id="l13.1030">   // bail out early for the singleton thread case.</span>
<a href="#l13.1031"></a><span id="l13.1031" class="difflineminus">-  if (numChildren == 1)</span>
<a href="#l13.1032"></a><span id="l13.1032" class="difflineminus">-  {</span>
<a href="#l13.1033"></a><span id="l13.1033" class="difflineplus">+  if (numChildren == 1) {</span>
<a href="#l13.1034"></a><span id="l13.1034">     SetThreadParent(nsMsgKey_None);</span>
<a href="#l13.1035"></a><span id="l13.1035">     return;</span>
<a href="#l13.1036"></a><span id="l13.1036" class="difflineminus">-  }</span>
<a href="#l13.1037"></a><span id="l13.1037" class="difflineminus">-  else</span>
<a href="#l13.1038"></a><span id="l13.1038" class="difflineminus">-  {</span>
<a href="#l13.1039"></a><span id="l13.1039" class="difflineplus">+  } else {</span>
<a href="#l13.1040"></a><span id="l13.1040">     nsCOMPtr&lt;nsIMsgDBHdr&gt; curHdr;</span>
<a href="#l13.1041"></a><span id="l13.1041">     // loop through thread, looking for our proper parent.</span>
<a href="#l13.1042"></a><span id="l13.1042" class="difflineminus">-    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l13.1043"></a><span id="l13.1043" class="difflineminus">-    {</span>
<a href="#l13.1044"></a><span id="l13.1044" class="difflineplus">+    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l13.1045"></a><span id="l13.1045">       thread-&gt;GetChildHdrAt(childIndex, getter_AddRefs(curHdr));</span>
<a href="#l13.1046"></a><span id="l13.1046">       // closed system, cast ok</span>
<a href="#l13.1047"></a><span id="l13.1047" class="difflineminus">-      nsMsgHdr* curMsgHdr = static_cast&lt;nsMsgHdr*&gt;(curHdr.get());</span>
<a href="#l13.1048"></a><span id="l13.1048" class="difflineminus">-      if (curHdr &amp;&amp; curMsgHdr-&gt;IsParentOf(this))</span>
<a href="#l13.1049"></a><span id="l13.1049" class="difflineminus">-      {</span>
<a href="#l13.1050"></a><span id="l13.1050" class="difflineplus">+      nsMsgHdr *curMsgHdr = static_cast&lt;nsMsgHdr *&gt;(curHdr.get());</span>
<a href="#l13.1051"></a><span id="l13.1051" class="difflineplus">+      if (curHdr &amp;&amp; curMsgHdr-&gt;IsParentOf(this)) {</span>
<a href="#l13.1052"></a><span id="l13.1052">         nsMsgKey curHdrKey;</span>
<a href="#l13.1053"></a><span id="l13.1053">         curHdr-&gt;GetMessageKey(&amp;curHdrKey);</span>
<a href="#l13.1054"></a><span id="l13.1054">         SetThreadParent(curHdrKey);</span>
<a href="#l13.1055"></a><span id="l13.1055">         return;</span>
<a href="#l13.1056"></a><span id="l13.1056">       }</span>
<a href="#l13.1057"></a><span id="l13.1057">     }</span>
<a href="#l13.1058"></a><span id="l13.1058">     // we didn't find it. So either the root header is our parent,</span>
<a href="#l13.1059"></a><span id="l13.1059">     // or we're the root.</span>
<a href="#l13.1060"></a><span id="l13.1060">     int32_t rootIndex;</span>
<a href="#l13.1061"></a><span id="l13.1061">     nsCOMPtr&lt;nsIMsgDBHdr&gt; rootHdr;</span>
<a href="#l13.1062"></a><span id="l13.1062">     thread-&gt;GetRootHdr(&amp;rootIndex, getter_AddRefs(rootHdr));</span>
<a href="#l13.1063"></a><span id="l13.1063">     NS_ASSERTION(rootHdr, &quot;thread has no root hdr - shouldn't happen&quot;);</span>
<a href="#l13.1064"></a><span id="l13.1064" class="difflineminus">-    if (rootHdr)</span>
<a href="#l13.1065"></a><span id="l13.1065" class="difflineminus">-    {</span>
<a href="#l13.1066"></a><span id="l13.1066" class="difflineplus">+    if (rootHdr) {</span>
<a href="#l13.1067"></a><span id="l13.1067">       nsMsgKey rootKey;</span>
<a href="#l13.1068"></a><span id="l13.1068">       rootHdr-&gt;GetMessageKey(&amp;rootKey);</span>
<a href="#l13.1069"></a><span id="l13.1069">       // if we're the root, our thread parent is -1.</span>
<a href="#l13.1070"></a><span id="l13.1070">       SetThreadParent(rootKey == m_messageKey ? nsMsgKey_None : rootKey);</span>
<a href="#l13.1071"></a><span id="l13.1071">     }</span>
<a href="#l13.1072"></a><span id="l13.1072">   }</span>
<a href="#l13.1073"></a><span id="l13.1073"> }</span>
<a href="#l13.1074"></a><span id="l13.1074"> </span>
<a href="#l13.1075"></a><span id="l13.1075" class="difflineminus">-bool nsMsgHdr::IsAncestorKilled(uint32_t ancestorsToCheck)</span>
<a href="#l13.1076"></a><span id="l13.1076" class="difflineminus">-{</span>
<a href="#l13.1077"></a><span id="l13.1077" class="difflineminus">-  if (!(m_initedValues &amp; FLAGS_INITED))</span>
<a href="#l13.1078"></a><span id="l13.1078" class="difflineminus">-    InitFlags();</span>
<a href="#l13.1079"></a><span id="l13.1079" class="difflineplus">+bool nsMsgHdr::IsAncestorKilled(uint32_t ancestorsToCheck) {</span>
<a href="#l13.1080"></a><span id="l13.1080" class="difflineplus">+  if (!(m_initedValues &amp; FLAGS_INITED)) InitFlags();</span>
<a href="#l13.1081"></a><span id="l13.1081">   bool isKilled = m_flags &amp; nsMsgMessageFlags::Ignored;</span>
<a href="#l13.1082"></a><span id="l13.1082"> </span>
<a href="#l13.1083"></a><span id="l13.1083" class="difflineminus">-  if (!isKilled)</span>
<a href="#l13.1084"></a><span id="l13.1084" class="difflineminus">-  {</span>
<a href="#l13.1085"></a><span id="l13.1085" class="difflineplus">+  if (!isKilled) {</span>
<a href="#l13.1086"></a><span id="l13.1086">     nsMsgKey threadParent;</span>
<a href="#l13.1087"></a><span id="l13.1087">     GetThreadParent(&amp;threadParent);</span>
<a href="#l13.1088"></a><span id="l13.1088"> </span>
<a href="#l13.1089"></a><span id="l13.1089" class="difflineminus">-    if (threadParent == m_messageKey)</span>
<a href="#l13.1090"></a><span id="l13.1090" class="difflineminus">-    {</span>
<a href="#l13.1091"></a><span id="l13.1091" class="difflineplus">+    if (threadParent == m_messageKey) {</span>
<a href="#l13.1092"></a><span id="l13.1092">       // isKilled is false by virtue of the enclosing if statement</span>
<a href="#l13.1093"></a><span id="l13.1093">       NS_ERROR(&quot;Thread is parent of itself, please fix!&quot;);</span>
<a href="#l13.1094"></a><span id="l13.1094">       nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l13.1095"></a><span id="l13.1095" class="difflineminus">-      (void) m_mdb-&gt;GetThreadContainingMsgHdr(this, getter_AddRefs(thread));</span>
<a href="#l13.1096"></a><span id="l13.1096" class="difflineminus">-      if (!thread)</span>
<a href="#l13.1097"></a><span id="l13.1097" class="difflineminus">-        return false;</span>
<a href="#l13.1098"></a><span id="l13.1098" class="difflineplus">+      (void)m_mdb-&gt;GetThreadContainingMsgHdr(this, getter_AddRefs(thread));</span>
<a href="#l13.1099"></a><span id="l13.1099" class="difflineplus">+      if (!thread) return false;</span>
<a href="#l13.1100"></a><span id="l13.1100">       ReparentInThread(thread);</span>
<a href="#l13.1101"></a><span id="l13.1101">       // Something's wrong, but the problem happened some time ago, so erroring</span>
<a href="#l13.1102"></a><span id="l13.1102">       // out now is probably not a good idea. Ergo, we'll pretend to be OK, show</span>
<a href="#l13.1103"></a><span id="l13.1103">       // the user the thread (err on the side of caution), and let the assertion</span>
<a href="#l13.1104"></a><span id="l13.1104">       // alert debuggers to a problem.</span>
<a href="#l13.1105"></a><span id="l13.1105">       return false;</span>
<a href="#l13.1106"></a><span id="l13.1106">     }</span>
<a href="#l13.1107"></a><span id="l13.1107" class="difflineminus">-    if (threadParent != nsMsgKey_None)</span>
<a href="#l13.1108"></a><span id="l13.1108" class="difflineminus">-    {</span>
<a href="#l13.1109"></a><span id="l13.1109" class="difflineplus">+    if (threadParent != nsMsgKey_None) {</span>
<a href="#l13.1110"></a><span id="l13.1110">       nsCOMPtr&lt;nsIMsgDBHdr&gt; parentHdr;</span>
<a href="#l13.1111"></a><span id="l13.1111" class="difflineminus">-      (void) m_mdb-&gt;GetMsgHdrForKey(threadParent, getter_AddRefs(parentHdr));</span>
<a href="#l13.1112"></a><span id="l13.1112" class="difflineplus">+      (void)m_mdb-&gt;GetMsgHdrForKey(threadParent, getter_AddRefs(parentHdr));</span>
<a href="#l13.1113"></a><span id="l13.1113"> </span>
<a href="#l13.1114"></a><span id="l13.1114" class="difflineminus">-      if (parentHdr)</span>
<a href="#l13.1115"></a><span id="l13.1115" class="difflineminus">-      {</span>
<a href="#l13.1116"></a><span id="l13.1116" class="difflineplus">+      if (parentHdr) {</span>
<a href="#l13.1117"></a><span id="l13.1117">         // More proofing against crashers. This crasher was derived from the</span>
<a href="#l13.1118"></a><span id="l13.1118">         // fact that something got borked, leaving is in hand with a circular</span>
<a href="#l13.1119"></a><span id="l13.1119">         // reference to borked headers inducing these loops. The defining</span>
<a href="#l13.1120"></a><span id="l13.1120">         // characteristic of these headers is that they don't actually seat</span>
<a href="#l13.1121"></a><span id="l13.1121">         // themselves in the thread properly.</span>
<a href="#l13.1122"></a><span id="l13.1122">         nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l13.1123"></a><span id="l13.1123" class="difflineminus">-        (void) m_mdb-&gt;GetThreadContainingMsgHdr(this, getter_AddRefs(thread));</span>
<a href="#l13.1124"></a><span id="l13.1124" class="difflineminus">-        if (thread)</span>
<a href="#l13.1125"></a><span id="l13.1125" class="difflineminus">-        {</span>
<a href="#l13.1126"></a><span id="l13.1126" class="difflineplus">+        (void)m_mdb-&gt;GetThreadContainingMsgHdr(this, getter_AddRefs(thread));</span>
<a href="#l13.1127"></a><span id="l13.1127" class="difflineplus">+        if (thread) {</span>
<a href="#l13.1128"></a><span id="l13.1128">           nsCOMPtr&lt;nsIMsgDBHdr&gt; claimant;</span>
<a href="#l13.1129"></a><span id="l13.1129" class="difflineminus">-          (void) thread-&gt;GetChild(threadParent, getter_AddRefs(claimant));</span>
<a href="#l13.1130"></a><span id="l13.1130" class="difflineminus">-          if (!claimant)</span>
<a href="#l13.1131"></a><span id="l13.1131" class="difflineminus">-          {</span>
<a href="#l13.1132"></a><span id="l13.1132" class="difflineplus">+          (void)thread-&gt;GetChild(threadParent, getter_AddRefs(claimant));</span>
<a href="#l13.1133"></a><span id="l13.1133" class="difflineplus">+          if (!claimant) {</span>
<a href="#l13.1134"></a><span id="l13.1134">             // attempt to reparent, and say the thread isn't killed,</span>
<a href="#l13.1135"></a><span id="l13.1135">             // erring on the side of safety.</span>
<a href="#l13.1136"></a><span id="l13.1136">             ReparentInThread(thread);</span>
<a href="#l13.1137"></a><span id="l13.1137">             return false;</span>
<a href="#l13.1138"></a><span id="l13.1138">           }</span>
<a href="#l13.1139"></a><span id="l13.1139">         }</span>
<a href="#l13.1140"></a><span id="l13.1140"> </span>
<a href="#l13.1141"></a><span id="l13.1141" class="difflineminus">-        if (!ancestorsToCheck)</span>
<a href="#l13.1142"></a><span id="l13.1142" class="difflineminus">-        {</span>
<a href="#l13.1143"></a><span id="l13.1143" class="difflineplus">+        if (!ancestorsToCheck) {</span>
<a href="#l13.1144"></a><span id="l13.1144">           // We think we have a parent, but we have no more ancestors to check</span>
<a href="#l13.1145"></a><span id="l13.1145">           NS_ASSERTION(false, &quot;cycle in parent relationship, please fix!&quot;);</span>
<a href="#l13.1146"></a><span id="l13.1146">           return false;</span>
<a href="#l13.1147"></a><span id="l13.1147">         }</span>
<a href="#l13.1148"></a><span id="l13.1148">         // closed system, cast ok</span>
<a href="#l13.1149"></a><span id="l13.1149" class="difflineminus">-        nsMsgHdr* parent = static_cast&lt;nsMsgHdr*&gt;(parentHdr.get());</span>
<a href="#l13.1150"></a><span id="l13.1150" class="difflineplus">+        nsMsgHdr *parent = static_cast&lt;nsMsgHdr *&gt;(parentHdr.get());</span>
<a href="#l13.1151"></a><span id="l13.1151">         return parent-&gt;IsAncestorKilled(ancestorsToCheck - 1);</span>
<a href="#l13.1152"></a><span id="l13.1152">       }</span>
<a href="#l13.1153"></a><span id="l13.1153">     }</span>
<a href="#l13.1154"></a><span id="l13.1154">   }</span>
<a href="#l13.1155"></a><span id="l13.1155">   return isKilled;</span>
<a href="#l13.1156"></a><span id="l13.1156"> }</span>
<a href="#l13.1157"></a><span id="l13.1157"> </span>
<a href="#l13.1158"></a><span id="l13.1158" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetIsKilled(bool *isKilled)</span>
<a href="#l13.1159"></a><span id="l13.1159" class="difflineminus">-{</span>
<a href="#l13.1160"></a><span id="l13.1160" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetIsKilled(bool *isKilled) {</span>
<a href="#l13.1161"></a><span id="l13.1161">   NS_ENSURE_ARG_POINTER(isKilled);</span>
<a href="#l13.1162"></a><span id="l13.1162">   *isKilled = false;</span>
<a href="#l13.1163"></a><span id="l13.1163">   nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l13.1164"></a><span id="l13.1164" class="difflineminus">-  (void) m_mdb-&gt;GetThreadContainingMsgHdr(this, getter_AddRefs(thread));</span>
<a href="#l13.1165"></a><span id="l13.1165" class="difflineplus">+  (void)m_mdb-&gt;GetThreadContainingMsgHdr(this, getter_AddRefs(thread));</span>
<a href="#l13.1166"></a><span id="l13.1166">   // if we can't find the thread, let's at least check one level; maybe</span>
<a href="#l13.1167"></a><span id="l13.1167">   // the header hasn't been added to a thread yet.</span>
<a href="#l13.1168"></a><span id="l13.1168">   uint32_t numChildren = 1;</span>
<a href="#l13.1169"></a><span id="l13.1169" class="difflineminus">-  if (thread)</span>
<a href="#l13.1170"></a><span id="l13.1170" class="difflineminus">-    thread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l13.1171"></a><span id="l13.1171" class="difflineminus">-  if (!numChildren)</span>
<a href="#l13.1172"></a><span id="l13.1172" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l13.1173"></a><span id="l13.1173" class="difflineplus">+  if (thread) thread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l13.1174"></a><span id="l13.1174" class="difflineplus">+  if (!numChildren) return NS_ERROR_FAILURE;</span>
<a href="#l13.1175"></a><span id="l13.1175">   // We can't have as many ancestors as there are messages in the thread,</span>
<a href="#l13.1176"></a><span id="l13.1176">   // so tell IsAncestorKilled to only check numChildren - 1 ancestors.</span>
<a href="#l13.1177"></a><span id="l13.1177">   *isKilled = IsAncestorKilled(numChildren - 1);</span>
<a href="#l13.1178"></a><span id="l13.1178">   return NS_OK;</span>
<a href="#l13.1179"></a><span id="l13.1179"> }</span>
<a href="#l13.1180"></a><span id="l13.1180"> </span>
<a href="#l13.1181"></a><span id="l13.1181"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l13.1182"></a><span id="l13.1182"> </span>
<a href="#l13.1183"></a><span id="l13.1183"> #include &quot;nsIStringEnumerator.h&quot;</span>
<a href="#l13.1184"></a><span id="l13.1184"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l13.1185"></a><span id="l13.1185"> #define NULL_MORK_COLUMN 0</span>
<a href="#l13.1186"></a><span id="l13.1186" class="difflineminus">-class nsMsgPropertyEnumerator : public nsStringEnumeratorBase</span>
<a href="#l13.1187"></a><span id="l13.1187" class="difflineminus">-{</span>
<a href="#l13.1188"></a><span id="l13.1188" class="difflineminus">-public:</span>
<a href="#l13.1189"></a><span id="l13.1189" class="difflineplus">+class nsMsgPropertyEnumerator : public nsStringEnumeratorBase {</span>
<a href="#l13.1190"></a><span id="l13.1190" class="difflineplus">+ public:</span>
<a href="#l13.1191"></a><span id="l13.1191">   NS_DECL_ISUPPORTS</span>
<a href="#l13.1192"></a><span id="l13.1192">   NS_DECL_NSIUTF8STRINGENUMERATOR</span>
<a href="#l13.1193"></a><span id="l13.1193"> </span>
<a href="#l13.1194"></a><span id="l13.1194">   using nsStringEnumeratorBase::GetNext;</span>
<a href="#l13.1195"></a><span id="l13.1195"> </span>
<a href="#l13.1196"></a><span id="l13.1196" class="difflineminus">-  explicit nsMsgPropertyEnumerator(nsMsgHdr* aHdr);</span>
<a href="#l13.1197"></a><span id="l13.1197" class="difflineplus">+  explicit nsMsgPropertyEnumerator(nsMsgHdr *aHdr);</span>
<a href="#l13.1198"></a><span id="l13.1198">   void PrefetchNext();</span>
<a href="#l13.1199"></a><span id="l13.1199"> </span>
<a href="#l13.1200"></a><span id="l13.1200" class="difflineminus">-protected:</span>
<a href="#l13.1201"></a><span id="l13.1201" class="difflineplus">+ protected:</span>
<a href="#l13.1202"></a><span id="l13.1202">   virtual ~nsMsgPropertyEnumerator();</span>
<a href="#l13.1203"></a><span id="l13.1203">   nsCOMPtr&lt;nsIMdbRowCellCursor&gt; mRowCellCursor;</span>
<a href="#l13.1204"></a><span id="l13.1204">   nsCOMPtr&lt;nsIMdbEnv&gt; m_mdbEnv;</span>
<a href="#l13.1205"></a><span id="l13.1205">   nsCOMPtr&lt;nsIMdbStore&gt; m_mdbStore;</span>
<a href="#l13.1206"></a><span id="l13.1206">   // Hold a reference to the hdr so it will hold an xpcom reference to the</span>
<a href="#l13.1207"></a><span id="l13.1207">   // underlying mdb row. The row cell cursor will crash if the underlying</span>
<a href="#l13.1208"></a><span id="l13.1208">   // row goes away.</span>
<a href="#l13.1209"></a><span id="l13.1209">   RefPtr&lt;nsMsgHdr&gt; m_hdr;</span>
<a href="#l13.1210"></a><span id="l13.1210">   bool mNextPrefetched;</span>
<a href="#l13.1211"></a><span id="l13.1211">   mdb_column mNextColumn;</span>
<a href="#l13.1212"></a><span id="l13.1212"> };</span>
<a href="#l13.1213"></a><span id="l13.1213"> </span>
<a href="#l13.1214"></a><span id="l13.1214" class="difflineminus">-nsMsgPropertyEnumerator::nsMsgPropertyEnumerator(nsMsgHdr* aHdr)</span>
<a href="#l13.1215"></a><span id="l13.1215" class="difflineminus">-  :  mNextPrefetched(false),</span>
<a href="#l13.1216"></a><span id="l13.1216" class="difflineminus">-     mNextColumn(NULL_MORK_COLUMN)</span>
<a href="#l13.1217"></a><span id="l13.1217" class="difflineminus">-{</span>
<a href="#l13.1218"></a><span id="l13.1218" class="difflineplus">+nsMsgPropertyEnumerator::nsMsgPropertyEnumerator(nsMsgHdr *aHdr)</span>
<a href="#l13.1219"></a><span id="l13.1219" class="difflineplus">+    : mNextPrefetched(false), mNextColumn(NULL_MORK_COLUMN) {</span>
<a href="#l13.1220"></a><span id="l13.1220">   RefPtr&lt;nsMsgDatabase&gt; mdb;</span>
<a href="#l13.1221"></a><span id="l13.1221">   nsCOMPtr&lt;nsIMdbRow&gt; mdbRow;</span>
<a href="#l13.1222"></a><span id="l13.1222"> </span>
<a href="#l13.1223"></a><span id="l13.1223" class="difflineminus">-  if (aHdr &amp;&amp;</span>
<a href="#l13.1224"></a><span id="l13.1224" class="difflineminus">-      (mdbRow = aHdr-&gt;GetMDBRow()) &amp;&amp;</span>
<a href="#l13.1225"></a><span id="l13.1225" class="difflineminus">-      (m_hdr = aHdr) &amp;&amp;</span>
<a href="#l13.1226"></a><span id="l13.1226" class="difflineminus">-      (mdb = aHdr-&gt;GetMdb()) &amp;&amp;</span>
<a href="#l13.1227"></a><span id="l13.1227" class="difflineminus">-      (m_mdbEnv = mdb-&gt;m_mdbEnv) &amp;&amp;</span>
<a href="#l13.1228"></a><span id="l13.1228" class="difflineminus">-      (m_mdbStore = mdb-&gt;m_mdbStore))</span>
<a href="#l13.1229"></a><span id="l13.1229" class="difflineminus">-  {</span>
<a href="#l13.1230"></a><span id="l13.1230" class="difflineplus">+  if (aHdr &amp;&amp; (mdbRow = aHdr-&gt;GetMDBRow()) &amp;&amp; (m_hdr = aHdr) &amp;&amp;</span>
<a href="#l13.1231"></a><span id="l13.1231" class="difflineplus">+      (mdb = aHdr-&gt;GetMdb()) &amp;&amp; (m_mdbEnv = mdb-&gt;m_mdbEnv) &amp;&amp;</span>
<a href="#l13.1232"></a><span id="l13.1232" class="difflineplus">+      (m_mdbStore = mdb-&gt;m_mdbStore)) {</span>
<a href="#l13.1233"></a><span id="l13.1233">     mdbRow-&gt;GetRowCellCursor(m_mdbEnv, -1, getter_AddRefs(mRowCellCursor));</span>
<a href="#l13.1234"></a><span id="l13.1234">   }</span>
<a href="#l13.1235"></a><span id="l13.1235"> }</span>
<a href="#l13.1236"></a><span id="l13.1236"> </span>
<a href="#l13.1237"></a><span id="l13.1237" class="difflineminus">-nsMsgPropertyEnumerator::~nsMsgPropertyEnumerator()</span>
<a href="#l13.1238"></a><span id="l13.1238" class="difflineminus">-{</span>
<a href="#l13.1239"></a><span id="l13.1239" class="difflineplus">+nsMsgPropertyEnumerator::~nsMsgPropertyEnumerator() {</span>
<a href="#l13.1240"></a><span id="l13.1240">   // Need to clear this before the nsMsgHdr and its corresponding</span>
<a href="#l13.1241"></a><span id="l13.1241">   // nsIMdbRow potentially go away.</span>
<a href="#l13.1242"></a><span id="l13.1242">   mRowCellCursor = nullptr;</span>
<a href="#l13.1243"></a><span id="l13.1243"> }</span>
<a href="#l13.1244"></a><span id="l13.1244"> </span>
<a href="#l13.1245"></a><span id="l13.1245" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgPropertyEnumerator, nsIUTF8StringEnumerator, nsIStringEnumerator)</span>
<a href="#l13.1246"></a><span id="l13.1246" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgPropertyEnumerator, nsIUTF8StringEnumerator,</span>
<a href="#l13.1247"></a><span id="l13.1247" class="difflineplus">+                  nsIStringEnumerator)</span>
<a href="#l13.1248"></a><span id="l13.1248"> </span>
<a href="#l13.1249"></a><span id="l13.1249" class="difflineminus">-NS_IMETHODIMP nsMsgPropertyEnumerator::GetNext(nsACString&amp; aItem)</span>
<a href="#l13.1250"></a><span id="l13.1250" class="difflineminus">-{</span>
<a href="#l13.1251"></a><span id="l13.1251" class="difflineplus">+NS_IMETHODIMP nsMsgPropertyEnumerator::GetNext(nsACString &amp;aItem) {</span>
<a href="#l13.1252"></a><span id="l13.1252">   PrefetchNext();</span>
<a href="#l13.1253"></a><span id="l13.1253">   if (mNextColumn == NULL_MORK_COLUMN)</span>
<a href="#l13.1254"></a><span id="l13.1254" class="difflineminus">-    return NS_ERROR_FAILURE; // call HasMore first</span>
<a href="#l13.1255"></a><span id="l13.1255" class="difflineminus">-  if (!m_mdbStore || !m_mdbEnv)</span>
<a href="#l13.1256"></a><span id="l13.1256" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l13.1257"></a><span id="l13.1257" class="difflineplus">+    return NS_ERROR_FAILURE;  // call HasMore first</span>
<a href="#l13.1258"></a><span id="l13.1258" class="difflineplus">+  if (!m_mdbStore || !m_mdbEnv) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l13.1259"></a><span id="l13.1259">   mNextPrefetched = false;</span>
<a href="#l13.1260"></a><span id="l13.1260">   char columnName[100];</span>
<a href="#l13.1261"></a><span id="l13.1261">   struct mdbYarn colYarn = {columnName, 0, sizeof(columnName), 0, 0, nullptr};</span>
<a href="#l13.1262"></a><span id="l13.1262">   // Get the column of the cell</span>
<a href="#l13.1263"></a><span id="l13.1263">   nsresult rv = m_mdbStore-&gt;TokenToString(m_mdbEnv, mNextColumn, &amp;colYarn);</span>
<a href="#l13.1264"></a><span id="l13.1264">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.1265"></a><span id="l13.1265"> </span>
<a href="#l13.1266"></a><span id="l13.1266">   aItem.Assign(static_cast&lt;char *&gt;(colYarn.mYarn_Buf), colYarn.mYarn_Fill);</span>
<a href="#l13.1267"></a><span id="l13.1267">   return NS_OK;</span>
<a href="#l13.1268"></a><span id="l13.1268"> }</span>
<a href="#l13.1269"></a><span id="l13.1269"> </span>
<a href="#l13.1270"></a><span id="l13.1270" class="difflineminus">-NS_IMETHODIMP nsMsgPropertyEnumerator::HasMore(bool *aResult)</span>
<a href="#l13.1271"></a><span id="l13.1271" class="difflineminus">-{</span>
<a href="#l13.1272"></a><span id="l13.1272" class="difflineplus">+NS_IMETHODIMP nsMsgPropertyEnumerator::HasMore(bool *aResult) {</span>
<a href="#l13.1273"></a><span id="l13.1273">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l13.1274"></a><span id="l13.1274"> </span>
<a href="#l13.1275"></a><span id="l13.1275">   PrefetchNext();</span>
<a href="#l13.1276"></a><span id="l13.1276">   *aResult = (mNextColumn != NULL_MORK_COLUMN);</span>
<a href="#l13.1277"></a><span id="l13.1277">   return NS_OK;</span>
<a href="#l13.1278"></a><span id="l13.1278"> }</span>
<a href="#l13.1279"></a><span id="l13.1279"> </span>
<a href="#l13.1280"></a><span id="l13.1280" class="difflineminus">-void nsMsgPropertyEnumerator::PrefetchNext(void)</span>
<a href="#l13.1281"></a><span id="l13.1281" class="difflineminus">-{</span>
<a href="#l13.1282"></a><span id="l13.1282" class="difflineminus">-  if (!mNextPrefetched &amp;&amp; m_mdbEnv &amp;&amp; mRowCellCursor)</span>
<a href="#l13.1283"></a><span id="l13.1283" class="difflineminus">-  {</span>
<a href="#l13.1284"></a><span id="l13.1284" class="difflineplus">+void nsMsgPropertyEnumerator::PrefetchNext(void) {</span>
<a href="#l13.1285"></a><span id="l13.1285" class="difflineplus">+  if (!mNextPrefetched &amp;&amp; m_mdbEnv &amp;&amp; mRowCellCursor) {</span>
<a href="#l13.1286"></a><span id="l13.1286">     mNextPrefetched = true;</span>
<a href="#l13.1287"></a><span id="l13.1287">     nsCOMPtr&lt;nsIMdbCell&gt; cell;</span>
<a href="#l13.1288"></a><span id="l13.1288" class="difflineminus">-    mRowCellCursor-&gt;NextCell(m_mdbEnv, getter_AddRefs(cell), &amp;mNextColumn, nullptr);</span>
<a href="#l13.1289"></a><span id="l13.1289" class="difflineminus">-    if (mNextColumn == NULL_MORK_COLUMN)</span>
<a href="#l13.1290"></a><span id="l13.1290" class="difflineminus">-    {</span>
<a href="#l13.1291"></a><span id="l13.1291" class="difflineplus">+    mRowCellCursor-&gt;NextCell(m_mdbEnv, getter_AddRefs(cell), &amp;mNextColumn,</span>
<a href="#l13.1292"></a><span id="l13.1292" class="difflineplus">+                             nullptr);</span>
<a href="#l13.1293"></a><span id="l13.1293" class="difflineplus">+    if (mNextColumn == NULL_MORK_COLUMN) {</span>
<a href="#l13.1294"></a><span id="l13.1294">       // free up references</span>
<a href="#l13.1295"></a><span id="l13.1295">       m_mdbStore = nullptr;</span>
<a href="#l13.1296"></a><span id="l13.1296">       m_mdbEnv = nullptr;</span>
<a href="#l13.1297"></a><span id="l13.1297">       mRowCellCursor = nullptr;</span>
<a href="#l13.1298"></a><span id="l13.1298">     }</span>
<a href="#l13.1299"></a><span id="l13.1299">   }</span>
<a href="#l13.1300"></a><span id="l13.1300"> }</span>
<a href="#l13.1301"></a><span id="l13.1301"> </span>
<a href="#l13.1302"></a><span id="l13.1302"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l13.1303"></a><span id="l13.1303"> </span>
<a href="#l13.1304"></a><span id="l13.1304" class="difflineminus">-NS_IMETHODIMP nsMsgHdr::GetPropertyEnumerator(nsIUTF8StringEnumerator** _result)</span>
<a href="#l13.1305"></a><span id="l13.1305" class="difflineminus">-{</span>
<a href="#l13.1306"></a><span id="l13.1306" class="difflineplus">+NS_IMETHODIMP nsMsgHdr::GetPropertyEnumerator(</span>
<a href="#l13.1307"></a><span id="l13.1307" class="difflineplus">+    nsIUTF8StringEnumerator **_result) {</span>
<a href="#l13.1308"></a><span id="l13.1308">   NS_ADDREF(*_result = new nsMsgPropertyEnumerator(this));</span>
<a href="#l13.1309"></a><span id="l13.1309">   return NS_OK;</span>
<a href="#l13.1310"></a><span id="l13.1310"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -19,358 +19,370 @@ NS_IMPL_ISUPPORTS(nsMsgOfflineImapOperat</span>
<a href="#l14.4"></a><span id="l14.4"> #define PROP_OPERATION &quot;op&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> #define PROP_OPERATION_FLAGS &quot;opFlags&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> #define PROP_NEW_FLAGS &quot;newFlags&quot;</span>
<a href="#l14.7"></a><span id="l14.7"> #define PROP_MESSAGE_KEY &quot;msgKey&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #define PROP_SRC_MESSAGE_KEY &quot;srcMsgKey&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> #define PROP_SRC_FOLDER_URI &quot;srcFolderURI&quot;</span>
<a href="#l14.10"></a><span id="l14.10"> #define PROP_MOVE_DEST_FOLDER_URI &quot;moveDest&quot;</span>
<a href="#l14.11"></a><span id="l14.11"> #define PROP_NUM_COPY_DESTS &quot;numCopyDests&quot;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-#define PROP_COPY_DESTS &quot;copyDests&quot; // how to delimit these? Or should we do the &quot;dest1&quot;,&quot;dest2&quot; etc trick? But then we'd need to shuffle</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-                                    // them around since we delete off the front first.</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+#define PROP_COPY_DESTS \</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+  &quot;copyDests&quot;  // how to delimit these? Or should we do the &quot;dest1&quot;,&quot;dest2&quot; etc</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+               // trick? But then we'd need to shuffle them around since we</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+               // delete off the front first.</span>
<a href="#l14.18"></a><span id="l14.18"> #define PROP_KEYWORD_ADD &quot;addedKeywords&quot;</span>
<a href="#l14.19"></a><span id="l14.19"> #define PROP_KEYWORD_REMOVE &quot;removedKeywords&quot;</span>
<a href="#l14.20"></a><span id="l14.20"> #define PROP_MSG_SIZE &quot;msgSize&quot;</span>
<a href="#l14.21"></a><span id="l14.21"> #define PROP_PLAYINGBACK &quot;inPlayback&quot;</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-nsMsgOfflineImapOperation::nsMsgOfflineImapOperation(nsMsgDatabase *db, nsIMdbRow *row)</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-{</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+nsMsgOfflineImapOperation::nsMsgOfflineImapOperation(nsMsgDatabase *db,</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+                                                     nsIMdbRow *row) {</span>
<a href="#l14.27"></a><span id="l14.27">   NS_ASSERTION(db, &quot;can't have null db&quot;);</span>
<a href="#l14.28"></a><span id="l14.28">   NS_ASSERTION(row, &quot;can't have null row&quot;);</span>
<a href="#l14.29"></a><span id="l14.29">   m_operation = 0;</span>
<a href="#l14.30"></a><span id="l14.30">   m_operationFlags = 0;</span>
<a href="#l14.31"></a><span id="l14.31">   m_messageKey = nsMsgKey_None;</span>
<a href="#l14.32"></a><span id="l14.32">   m_sourceMessageKey = nsMsgKey_None;</span>
<a href="#l14.33"></a><span id="l14.33">   m_mdb = db;</span>
<a href="#l14.34"></a><span id="l14.34">   NS_ADDREF(m_mdb);</span>
<a href="#l14.35"></a><span id="l14.35">   m_mdbRow = row;</span>
<a href="#l14.36"></a><span id="l14.36">   m_newFlags = 0;</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-  m_mdb-&gt;GetUint32Property(m_mdbRow, PROP_OPERATION, (uint32_t *) &amp;m_operation, 0);</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+  m_mdb-&gt;GetUint32Property(m_mdbRow, PROP_OPERATION, (uint32_t *)&amp;m_operation,</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+                           0);</span>
<a href="#l14.40"></a><span id="l14.40">   m_mdb-&gt;GetUint32Property(m_mdbRow, PROP_MESSAGE_KEY, &amp;m_messageKey, 0);</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-  m_mdb-&gt;GetUint32Property(m_mdbRow, PROP_OPERATION_FLAGS, &amp;m_operationFlags, 0);</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-  m_mdb-&gt;GetUint32Property(m_mdbRow, PROP_NEW_FLAGS, (uint32_t *) &amp;m_newFlags, 0);</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+  m_mdb-&gt;GetUint32Property(m_mdbRow, PROP_OPERATION_FLAGS, &amp;m_operationFlags,</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+                           0);</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+  m_mdb-&gt;GetUint32Property(m_mdbRow, PROP_NEW_FLAGS, (uint32_t *)&amp;m_newFlags,</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+                           0);</span>
<a href="#l14.47"></a><span id="l14.47"> }</span>
<a href="#l14.48"></a><span id="l14.48"> </span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-nsMsgOfflineImapOperation::~nsMsgOfflineImapOperation()</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-{</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+nsMsgOfflineImapOperation::~nsMsgOfflineImapOperation() {</span>
<a href="#l14.52"></a><span id="l14.52">   // clear the row first, in case we're holding the last reference</span>
<a href="#l14.53"></a><span id="l14.53">   // to the db.</span>
<a href="#l14.54"></a><span id="l14.54">   m_mdbRow = nullptr;</span>
<a href="#l14.55"></a><span id="l14.55">   NS_IF_RELEASE(m_mdb);</span>
<a href="#l14.56"></a><span id="l14.56"> }</span>
<a href="#l14.57"></a><span id="l14.57"> </span>
<a href="#l14.58"></a><span id="l14.58"> /* attribute nsOfflineImapOperationType operation; */</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::GetOperation(nsOfflineImapOperationType *aOperation)</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-{</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::GetOperation(</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+    nsOfflineImapOperationType *aOperation) {</span>
<a href="#l14.63"></a><span id="l14.63">   NS_ENSURE_ARG(aOperation);</span>
<a href="#l14.64"></a><span id="l14.64">   *aOperation = m_operation;</span>
<a href="#l14.65"></a><span id="l14.65">   return NS_OK;</span>
<a href="#l14.66"></a><span id="l14.66"> }</span>
<a href="#l14.67"></a><span id="l14.67"> </span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::SetOperation(nsOfflineImapOperationType aOperation)</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-{</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::SetOperation(</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+    nsOfflineImapOperationType aOperation) {</span>
<a href="#l14.72"></a><span id="l14.72">   if (MOZ_LOG_TEST(IMAPOffline, LogLevel::Info))</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineminus">-    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x setOperation was %x add %x&quot;, m_messageKey, m_operation, aOperation));</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info,</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+            (&quot;msg id %x setOperation was %x add %x&quot;, m_messageKey, m_operation,</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+             aOperation));</span>
<a href="#l14.77"></a><span id="l14.77"> </span>
<a href="#l14.78"></a><span id="l14.78">   m_operation |= aOperation;</span>
<a href="#l14.79"></a><span id="l14.79">   return m_mdb-&gt;SetUint32Property(m_mdbRow, PROP_OPERATION, m_operation);</span>
<a href="#l14.80"></a><span id="l14.80"> }</span>
<a href="#l14.81"></a><span id="l14.81"> </span>
<a href="#l14.82"></a><span id="l14.82"> /* void clearOperation (in nsOfflineImapOperationType operation); */</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::ClearOperation(nsOfflineImapOperationType aOperation)</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineminus">-{</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::ClearOperation(</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+    nsOfflineImapOperationType aOperation) {</span>
<a href="#l14.87"></a><span id="l14.87">   if (MOZ_LOG_TEST(IMAPOffline, LogLevel::Info))</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">-    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x clearOperation was %x clear %x&quot;, m_messageKey, m_operation, aOperation));</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info,</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+            (&quot;msg id %x clearOperation was %x clear %x&quot;, m_messageKey,</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+             m_operation, aOperation));</span>
<a href="#l14.92"></a><span id="l14.92">   m_operation &amp;= ~aOperation;</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-  switch (aOperation)</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-  {</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-  case kMsgMoved:</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineminus">-  case kAppendTemplate:</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineminus">-  case kAppendDraft:</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineminus">-    m_moveDestination.Truncate();</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineminus">-    break;</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineminus">-  case kMsgCopy:</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineminus">-    m_copyDestinations.RemoveElementAt(0);</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-    break;</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+  switch (aOperation) {</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+    case kMsgMoved:</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+    case kAppendTemplate:</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+    case kAppendDraft:</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+      m_moveDestination.Truncate();</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+      break;</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+    case kMsgCopy:</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+      m_copyDestinations.RemoveElementAt(0);</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+      break;</span>
<a href="#l14.112"></a><span id="l14.112">   }</span>
<a href="#l14.113"></a><span id="l14.113">   return m_mdb-&gt;SetUint32Property(m_mdbRow, PROP_OPERATION, m_operation);</span>
<a href="#l14.114"></a><span id="l14.114"> }</span>
<a href="#l14.115"></a><span id="l14.115"> </span>
<a href="#l14.116"></a><span id="l14.116"> /* attribute nsMsgKey messageKey; */</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::GetMessageKey(nsMsgKey *aMessageKey)</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineminus">-{</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::GetMessageKey(nsMsgKey *aMessageKey) {</span>
<a href="#l14.120"></a><span id="l14.120">   NS_ENSURE_ARG(aMessageKey);</span>
<a href="#l14.121"></a><span id="l14.121">   *aMessageKey = m_messageKey;</span>
<a href="#l14.122"></a><span id="l14.122">   return NS_OK;</span>
<a href="#l14.123"></a><span id="l14.123"> }</span>
<a href="#l14.124"></a><span id="l14.124"> </span>
<a href="#l14.125"></a><span id="l14.125" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::SetMessageKey(nsMsgKey aMessageKey)</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineminus">-{</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::SetMessageKey(nsMsgKey aMessageKey) {</span>
<a href="#l14.128"></a><span id="l14.128">   m_messageKey = aMessageKey;</span>
<a href="#l14.129"></a><span id="l14.129">   return m_mdb-&gt;SetUint32Property(m_mdbRow, PROP_MESSAGE_KEY, m_messageKey);</span>
<a href="#l14.130"></a><span id="l14.130"> }</span>
<a href="#l14.131"></a><span id="l14.131"> </span>
<a href="#l14.132"></a><span id="l14.132"> /* attribute nsMsgKey srcMessageKey; */</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::GetSrcMessageKey(nsMsgKey *aMessageKey)</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineminus">-{</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::GetSrcMessageKey(</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+    nsMsgKey *aMessageKey) {</span>
<a href="#l14.137"></a><span id="l14.137">   NS_ENSURE_ARG(aMessageKey);</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineminus">-  return m_mdb-&gt;GetUint32Property(m_mdbRow, PROP_SRC_MESSAGE_KEY, aMessageKey, nsMsgKey_None);</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+  return m_mdb-&gt;GetUint32Property(m_mdbRow, PROP_SRC_MESSAGE_KEY, aMessageKey,</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+                                  nsMsgKey_None);</span>
<a href="#l14.141"></a><span id="l14.141"> }</span>
<a href="#l14.142"></a><span id="l14.142"> </span>
<a href="#l14.143"></a><span id="l14.143" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::SetSrcMessageKey(nsMsgKey aMessageKey)</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineminus">-{</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::SetSrcMessageKey(</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+    nsMsgKey aMessageKey) {</span>
<a href="#l14.147"></a><span id="l14.147">   m_messageKey = aMessageKey;</span>
<a href="#l14.148"></a><span id="l14.148">   return m_mdb-&gt;SetUint32Property(m_mdbRow, PROP_SRC_MESSAGE_KEY, m_messageKey);</span>
<a href="#l14.149"></a><span id="l14.149"> }</span>
<a href="#l14.150"></a><span id="l14.150"> </span>
<a href="#l14.151"></a><span id="l14.151"> /* attribute imapMessageFlagsType flagOperation; */</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::GetFlagOperation(imapMessageFlagsType *aFlagOperation)</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineminus">-{</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::GetFlagOperation(</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+    imapMessageFlagsType *aFlagOperation) {</span>
<a href="#l14.156"></a><span id="l14.156">   NS_ENSURE_ARG(aFlagOperation);</span>
<a href="#l14.157"></a><span id="l14.157">   *aFlagOperation = m_operationFlags;</span>
<a href="#l14.158"></a><span id="l14.158">   return NS_OK;</span>
<a href="#l14.159"></a><span id="l14.159"> }</span>
<a href="#l14.160"></a><span id="l14.160"> </span>
<a href="#l14.161"></a><span id="l14.161" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::SetFlagOperation(imapMessageFlagsType aFlagOperation)</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineminus">-{</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::SetFlagOperation(</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+    imapMessageFlagsType aFlagOperation) {</span>
<a href="#l14.165"></a><span id="l14.165">   if (MOZ_LOG_TEST(IMAPOffline, LogLevel::Info))</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineminus">-    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x setFlagOperation was %x add %x&quot;, m_messageKey, m_operationFlags, aFlagOperation));</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info,</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+            (&quot;msg id %x setFlagOperation was %x add %x&quot;, m_messageKey,</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+             m_operationFlags, aFlagOperation));</span>
<a href="#l14.170"></a><span id="l14.170">   SetOperation(kFlagsChanged);</span>
<a href="#l14.171"></a><span id="l14.171">   nsresult rv = SetNewFlags(aFlagOperation);</span>
<a href="#l14.172"></a><span id="l14.172">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.173"></a><span id="l14.173">   m_operationFlags |= aFlagOperation;</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineminus">-  return m_mdb-&gt;SetUint32Property(m_mdbRow, PROP_OPERATION_FLAGS, m_operationFlags);</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+  return m_mdb-&gt;SetUint32Property(m_mdbRow, PROP_OPERATION_FLAGS,</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+                                  m_operationFlags);</span>
<a href="#l14.177"></a><span id="l14.177"> }</span>
<a href="#l14.178"></a><span id="l14.178"> </span>
<a href="#l14.179"></a><span id="l14.179"> /* attribute imapMessageFlagsType flagOperation; */</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::GetNewFlags(imapMessageFlagsType *aNewFlags)</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineminus">-{</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::GetNewFlags(</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+    imapMessageFlagsType *aNewFlags) {</span>
<a href="#l14.184"></a><span id="l14.184">   NS_ENSURE_ARG(aNewFlags);</span>
<a href="#l14.185"></a><span id="l14.185">   uint32_t flags;</span>
<a href="#l14.186"></a><span id="l14.186">   nsresult rv = m_mdb-&gt;GetUint32Property(m_mdbRow, PROP_NEW_FLAGS, &amp;flags, 0);</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineminus">-  *aNewFlags = m_newFlags = (imapMessageFlagsType) flags;</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+  *aNewFlags = m_newFlags = (imapMessageFlagsType)flags;</span>
<a href="#l14.189"></a><span id="l14.189">   return rv;</span>
<a href="#l14.190"></a><span id="l14.190"> }</span>
<a href="#l14.191"></a><span id="l14.191"> </span>
<a href="#l14.192"></a><span id="l14.192" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::SetNewFlags(imapMessageFlagsType aNewFlags)</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineminus">-{</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::SetNewFlags(</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineplus">+    imapMessageFlagsType aNewFlags) {</span>
<a href="#l14.196"></a><span id="l14.196">   if (MOZ_LOG_TEST(IMAPOffline, LogLevel::Info) &amp;&amp; m_newFlags != aNewFlags)</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineminus">-    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x SetNewFlags was %x to %x&quot;, m_messageKey, m_newFlags, aNewFlags));</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info,</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineplus">+            (&quot;msg id %x SetNewFlags was %x to %x&quot;, m_messageKey, m_newFlags,</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+             aNewFlags));</span>
<a href="#l14.201"></a><span id="l14.201">   m_newFlags = aNewFlags;</span>
<a href="#l14.202"></a><span id="l14.202">   return m_mdb-&gt;SetUint32Property(m_mdbRow, PROP_NEW_FLAGS, m_newFlags);</span>
<a href="#l14.203"></a><span id="l14.203"> }</span>
<a href="#l14.204"></a><span id="l14.204"> </span>
<a href="#l14.205"></a><span id="l14.205" class="difflineminus">-</span>
<a href="#l14.206"></a><span id="l14.206"> /* attribute string destinationFolderURI; */</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::GetDestinationFolderURI(char * *aDestinationFolderURI)</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineminus">-{</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::GetDestinationFolderURI(</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+    char **aDestinationFolderURI) {</span>
<a href="#l14.211"></a><span id="l14.211">   NS_ENSURE_ARG(aDestinationFolderURI);</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineminus">-  (void) m_mdb-&gt;GetProperty(m_mdbRow, PROP_MOVE_DEST_FOLDER_URI, getter_Copies(m_moveDestination));</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineplus">+  (void)m_mdb-&gt;GetProperty(m_mdbRow, PROP_MOVE_DEST_FOLDER_URI,</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineplus">+                           getter_Copies(m_moveDestination));</span>
<a href="#l14.215"></a><span id="l14.215">   *aDestinationFolderURI = ToNewCString(m_moveDestination);</span>
<a href="#l14.216"></a><span id="l14.216">   return (*aDestinationFolderURI) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l14.217"></a><span id="l14.217"> }</span>
<a href="#l14.218"></a><span id="l14.218"> </span>
<a href="#l14.219"></a><span id="l14.219" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::SetDestinationFolderURI(const char * aDestinationFolderURI)</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineminus">-{</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::SetDestinationFolderURI(</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+    const char *aDestinationFolderURI) {</span>
<a href="#l14.223"></a><span id="l14.223">   if (MOZ_LOG_TEST(IMAPOffline, LogLevel::Info))</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineminus">-    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x SetDestinationFolderURI to %s&quot;, m_messageKey, aDestinationFolderURI));</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info,</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineplus">+            (&quot;msg id %x SetDestinationFolderURI to %s&quot;, m_messageKey,</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+             aDestinationFolderURI));</span>
<a href="#l14.228"></a><span id="l14.228">   m_moveDestination = aDestinationFolderURI ? aDestinationFolderURI : 0;</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineminus">-  return m_mdb-&gt;SetProperty(m_mdbRow, PROP_MOVE_DEST_FOLDER_URI, aDestinationFolderURI);</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineplus">+  return m_mdb-&gt;SetProperty(m_mdbRow, PROP_MOVE_DEST_FOLDER_URI,</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+                            aDestinationFolderURI);</span>
<a href="#l14.232"></a><span id="l14.232"> }</span>
<a href="#l14.233"></a><span id="l14.233"> </span>
<a href="#l14.234"></a><span id="l14.234"> /* attribute string sourceFolderURI; */</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::GetSourceFolderURI(char * *aSourceFolderURI)</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineminus">-{</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::GetSourceFolderURI(</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineplus">+    char **aSourceFolderURI) {</span>
<a href="#l14.239"></a><span id="l14.239">   NS_ENSURE_ARG(aSourceFolderURI);</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineminus">-  nsresult rv = m_mdb-&gt;GetProperty(m_mdbRow, PROP_SRC_FOLDER_URI, getter_Copies(m_sourceFolder));</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineplus">+  nsresult rv = m_mdb-&gt;GetProperty(m_mdbRow, PROP_SRC_FOLDER_URI,</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineplus">+                                   getter_Copies(m_sourceFolder));</span>
<a href="#l14.243"></a><span id="l14.243">   *aSourceFolderURI = ToNewCString(m_sourceFolder);</span>
<a href="#l14.244"></a><span id="l14.244">   return rv;</span>
<a href="#l14.245"></a><span id="l14.245"> }</span>
<a href="#l14.246"></a><span id="l14.246"> </span>
<a href="#l14.247"></a><span id="l14.247" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::SetSourceFolderURI(const char * aSourceFolderURI)</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineminus">-{</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::SetSourceFolderURI(</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineplus">+    const char *aSourceFolderURI) {</span>
<a href="#l14.251"></a><span id="l14.251">   m_sourceFolder = aSourceFolderURI ? aSourceFolderURI : 0;</span>
<a href="#l14.252"></a><span id="l14.252">   SetOperation(kMoveResult);</span>
<a href="#l14.253"></a><span id="l14.253"> </span>
<a href="#l14.254"></a><span id="l14.254">   return m_mdb-&gt;SetProperty(m_mdbRow, PROP_SRC_FOLDER_URI, aSourceFolderURI);</span>
<a href="#l14.255"></a><span id="l14.255"> }</span>
<a href="#l14.256"></a><span id="l14.256"> </span>
<a href="#l14.257"></a><span id="l14.257"> /* attribute string keyword; */</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::GetKeywordsToAdd(char * *aKeywords)</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineminus">-{</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::GetKeywordsToAdd(char **aKeywords) {</span>
<a href="#l14.261"></a><span id="l14.261">   NS_ENSURE_ARG(aKeywords);</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineminus">-  nsresult rv = m_mdb-&gt;GetProperty(m_mdbRow, PROP_KEYWORD_ADD, getter_Copies(m_keywordsToAdd));</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineplus">+  nsresult rv = m_mdb-&gt;GetProperty(m_mdbRow, PROP_KEYWORD_ADD,</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineplus">+                                   getter_Copies(m_keywordsToAdd));</span>
<a href="#l14.265"></a><span id="l14.265">   *aKeywords = ToNewCString(m_keywordsToAdd);</span>
<a href="#l14.266"></a><span id="l14.266">   return rv;</span>
<a href="#l14.267"></a><span id="l14.267"> }</span>
<a href="#l14.268"></a><span id="l14.268"> </span>
<a href="#l14.269"></a><span id="l14.269" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::AddKeywordToAdd(const char * aKeyword)</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineminus">-{</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::AddKeywordToAdd(const char *aKeyword) {</span>
<a href="#l14.272"></a><span id="l14.272">   SetOperation(kAddKeywords);</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineminus">-  return AddKeyword(aKeyword, m_keywordsToAdd, PROP_KEYWORD_ADD, m_keywordsToRemove, PROP_KEYWORD_REMOVE);</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineplus">+  return AddKeyword(aKeyword, m_keywordsToAdd, PROP_KEYWORD_ADD,</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineplus">+                    m_keywordsToRemove, PROP_KEYWORD_REMOVE);</span>
<a href="#l14.276"></a><span id="l14.276"> }</span>
<a href="#l14.277"></a><span id="l14.277"> </span>
<a href="#l14.278"></a><span id="l14.278" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::GetKeywordsToRemove(char * *aKeywords)</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineminus">-{</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::GetKeywordsToRemove(char **aKeywords) {</span>
<a href="#l14.281"></a><span id="l14.281">   NS_ENSURE_ARG(aKeywords);</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineminus">-  nsresult rv = m_mdb-&gt;GetProperty(m_mdbRow, PROP_KEYWORD_REMOVE, getter_Copies(m_keywordsToRemove));</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineplus">+  nsresult rv = m_mdb-&gt;GetProperty(m_mdbRow, PROP_KEYWORD_REMOVE,</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineplus">+                                   getter_Copies(m_keywordsToRemove));</span>
<a href="#l14.285"></a><span id="l14.285">   *aKeywords = ToNewCString(m_keywordsToRemove);</span>
<a href="#l14.286"></a><span id="l14.286">   return rv;</span>
<a href="#l14.287"></a><span id="l14.287"> }</span>
<a href="#l14.288"></a><span id="l14.288"> </span>
<a href="#l14.289"></a><span id="l14.289" class="difflineminus">-nsresult nsMsgOfflineImapOperation::AddKeyword(const char *aKeyword, nsCString &amp;addList, const char *addProp,</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineminus">-                                               nsCString &amp;removeList, const char *removeProp)</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineminus">-{</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineplus">+nsresult nsMsgOfflineImapOperation::AddKeyword(const char *aKeyword,</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineplus">+                                               nsCString &amp;addList,</span>
<a href="#l14.294"></a><span id="l14.294" class="difflineplus">+                                               const char *addProp,</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineplus">+                                               nsCString &amp;removeList,</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineplus">+                                               const char *removeProp) {</span>
<a href="#l14.297"></a><span id="l14.297">   int32_t startOffset, keywordLength;</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineminus">-  if (!MsgFindKeyword(nsDependentCString(aKeyword), addList, &amp;startOffset, &amp;keywordLength))</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineminus">-  {</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineminus">-    if (!addList.IsEmpty())</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineminus">-      addList.Append(' ');</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineplus">+  if (!MsgFindKeyword(nsDependentCString(aKeyword), addList, &amp;startOffset,</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineplus">+                      &amp;keywordLength)) {</span>
<a href="#l14.304"></a><span id="l14.304" class="difflineplus">+    if (!addList.IsEmpty()) addList.Append(' ');</span>
<a href="#l14.305"></a><span id="l14.305">     addList.Append(aKeyword);</span>
<a href="#l14.306"></a><span id="l14.306">   }</span>
<a href="#l14.307"></a><span id="l14.307">   // if the keyword we're removing was in the list of keywords to add,</span>
<a href="#l14.308"></a><span id="l14.308">   // cut it from that list.</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineminus">-  if (MsgFindKeyword(nsDependentCString(aKeyword), removeList, &amp;startOffset, &amp;keywordLength))</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineminus">-  {</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineplus">+  if (MsgFindKeyword(nsDependentCString(aKeyword), removeList, &amp;startOffset,</span>
<a href="#l14.312"></a><span id="l14.312" class="difflineplus">+                     &amp;keywordLength)) {</span>
<a href="#l14.313"></a><span id="l14.313">     removeList.Cut(startOffset, keywordLength);</span>
<a href="#l14.314"></a><span id="l14.314">     m_mdb-&gt;SetProperty(m_mdbRow, removeProp, removeList.get());</span>
<a href="#l14.315"></a><span id="l14.315">   }</span>
<a href="#l14.316"></a><span id="l14.316">   return m_mdb-&gt;SetProperty(m_mdbRow, addProp, addList.get());</span>
<a href="#l14.317"></a><span id="l14.317"> }</span>
<a href="#l14.318"></a><span id="l14.318"> </span>
<a href="#l14.319"></a><span id="l14.319" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::AddKeywordToRemove(const char * aKeyword)</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineminus">-{</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::AddKeywordToRemove(</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineplus">+    const char *aKeyword) {</span>
<a href="#l14.323"></a><span id="l14.323">   SetOperation(kRemoveKeywords);</span>
<a href="#l14.324"></a><span id="l14.324" class="difflineminus">-  return AddKeyword(aKeyword, m_keywordsToRemove, PROP_KEYWORD_REMOVE, m_keywordsToAdd, PROP_KEYWORD_ADD);</span>
<a href="#l14.325"></a><span id="l14.325" class="difflineplus">+  return AddKeyword(aKeyword, m_keywordsToRemove, PROP_KEYWORD_REMOVE,</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineplus">+                    m_keywordsToAdd, PROP_KEYWORD_ADD);</span>
<a href="#l14.327"></a><span id="l14.327"> }</span>
<a href="#l14.328"></a><span id="l14.328"> </span>
<a href="#l14.329"></a><span id="l14.329" class="difflineminus">-</span>
<a href="#l14.330"></a><span id="l14.330" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::AddMessageCopyOperation(const char *destinationBox)</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineminus">-{</span>
<a href="#l14.332"></a><span id="l14.332" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::AddMessageCopyOperation(</span>
<a href="#l14.333"></a><span id="l14.333" class="difflineplus">+    const char *destinationBox) {</span>
<a href="#l14.334"></a><span id="l14.334">   SetOperation(kMsgCopy);</span>
<a href="#l14.335"></a><span id="l14.335">   nsAutoCString newDest(destinationBox);</span>
<a href="#l14.336"></a><span id="l14.336">   nsresult rv = GetCopiesFromDB();</span>
<a href="#l14.337"></a><span id="l14.337">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.338"></a><span id="l14.338">   m_copyDestinations.AppendElement(newDest);</span>
<a href="#l14.339"></a><span id="l14.339">   return SetCopiesToDB();</span>
<a href="#l14.340"></a><span id="l14.340"> }</span>
<a href="#l14.341"></a><span id="l14.341"> </span>
<a href="#l14.342"></a><span id="l14.342"> // we write out the folders as one string, separated by 0x1.</span>
<a href="#l14.343"></a><span id="l14.343"> #define FOLDER_SEP_CHAR '\001'</span>
<a href="#l14.344"></a><span id="l14.344"> </span>
<a href="#l14.345"></a><span id="l14.345" class="difflineminus">-nsresult nsMsgOfflineImapOperation::GetCopiesFromDB()</span>
<a href="#l14.346"></a><span id="l14.346" class="difflineminus">-{</span>
<a href="#l14.347"></a><span id="l14.347" class="difflineplus">+nsresult nsMsgOfflineImapOperation::GetCopiesFromDB() {</span>
<a href="#l14.348"></a><span id="l14.348">   nsCString copyDests;</span>
<a href="#l14.349"></a><span id="l14.349">   m_copyDestinations.Clear();</span>
<a href="#l14.350"></a><span id="l14.350" class="difflineminus">-  nsresult rv = m_mdb-&gt;GetProperty(m_mdbRow, PROP_COPY_DESTS, getter_Copies(copyDests));</span>
<a href="#l14.351"></a><span id="l14.351" class="difflineminus">-  // use 0x1 as the delimiter between folder names since it's not a legal character</span>
<a href="#l14.352"></a><span id="l14.352" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !copyDests.IsEmpty())</span>
<a href="#l14.353"></a><span id="l14.353" class="difflineminus">-  {</span>
<a href="#l14.354"></a><span id="l14.354" class="difflineplus">+  nsresult rv =</span>
<a href="#l14.355"></a><span id="l14.355" class="difflineplus">+      m_mdb-&gt;GetProperty(m_mdbRow, PROP_COPY_DESTS, getter_Copies(copyDests));</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineplus">+  // use 0x1 as the delimiter between folder names since it's not a legal</span>
<a href="#l14.357"></a><span id="l14.357" class="difflineplus">+  // character</span>
<a href="#l14.358"></a><span id="l14.358" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !copyDests.IsEmpty()) {</span>
<a href="#l14.359"></a><span id="l14.359">     int32_t curCopyDestStart = 0;</span>
<a href="#l14.360"></a><span id="l14.360">     int32_t nextCopyDestPos = 0;</span>
<a href="#l14.361"></a><span id="l14.361"> </span>
<a href="#l14.362"></a><span id="l14.362" class="difflineminus">-    while (nextCopyDestPos != -1)</span>
<a href="#l14.363"></a><span id="l14.363" class="difflineminus">-    {</span>
<a href="#l14.364"></a><span id="l14.364" class="difflineplus">+    while (nextCopyDestPos != -1) {</span>
<a href="#l14.365"></a><span id="l14.365">       nsCString curDest;</span>
<a href="#l14.366"></a><span id="l14.366">       nextCopyDestPos = copyDests.FindChar(FOLDER_SEP_CHAR, curCopyDestStart);</span>
<a href="#l14.367"></a><span id="l14.367">       if (nextCopyDestPos &gt; 0)</span>
<a href="#l14.368"></a><span id="l14.368" class="difflineminus">-        curDest = Substring(copyDests, curCopyDestStart, nextCopyDestPos - curCopyDestStart);</span>
<a href="#l14.369"></a><span id="l14.369" class="difflineplus">+        curDest = Substring(copyDests, curCopyDestStart,</span>
<a href="#l14.370"></a><span id="l14.370" class="difflineplus">+                            nextCopyDestPos - curCopyDestStart);</span>
<a href="#l14.371"></a><span id="l14.371">       else</span>
<a href="#l14.372"></a><span id="l14.372" class="difflineminus">-        curDest = Substring(copyDests, curCopyDestStart, copyDests.Length() - curCopyDestStart);</span>
<a href="#l14.373"></a><span id="l14.373" class="difflineplus">+        curDest = Substring(copyDests, curCopyDestStart,</span>
<a href="#l14.374"></a><span id="l14.374" class="difflineplus">+                            copyDests.Length() - curCopyDestStart);</span>
<a href="#l14.375"></a><span id="l14.375">       curCopyDestStart = nextCopyDestPos + 1;</span>
<a href="#l14.376"></a><span id="l14.376">       m_copyDestinations.AppendElement(curDest);</span>
<a href="#l14.377"></a><span id="l14.377">     }</span>
<a href="#l14.378"></a><span id="l14.378">   }</span>
<a href="#l14.379"></a><span id="l14.379">   return rv;</span>
<a href="#l14.380"></a><span id="l14.380"> }</span>
<a href="#l14.381"></a><span id="l14.381"> </span>
<a href="#l14.382"></a><span id="l14.382" class="difflineminus">-nsresult nsMsgOfflineImapOperation::SetCopiesToDB()</span>
<a href="#l14.383"></a><span id="l14.383" class="difflineminus">-{</span>
<a href="#l14.384"></a><span id="l14.384" class="difflineplus">+nsresult nsMsgOfflineImapOperation::SetCopiesToDB() {</span>
<a href="#l14.385"></a><span id="l14.385">   nsAutoCString copyDests;</span>
<a href="#l14.386"></a><span id="l14.386"> </span>
<a href="#l14.387"></a><span id="l14.387">   // use 0x1 as the delimiter between folders</span>
<a href="#l14.388"></a><span id="l14.388" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_copyDestinations.Length(); i++)</span>
<a href="#l14.389"></a><span id="l14.389" class="difflineminus">-  {</span>
<a href="#l14.390"></a><span id="l14.390" class="difflineminus">-    if (i &gt; 0)</span>
<a href="#l14.391"></a><span id="l14.391" class="difflineminus">-      copyDests.Append(FOLDER_SEP_CHAR);</span>
<a href="#l14.392"></a><span id="l14.392" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_copyDestinations.Length(); i++) {</span>
<a href="#l14.393"></a><span id="l14.393" class="difflineplus">+    if (i &gt; 0) copyDests.Append(FOLDER_SEP_CHAR);</span>
<a href="#l14.394"></a><span id="l14.394">     copyDests.Append(m_copyDestinations.ElementAt(i));</span>
<a href="#l14.395"></a><span id="l14.395">   }</span>
<a href="#l14.396"></a><span id="l14.396">   return m_mdb-&gt;SetProperty(m_mdbRow, PROP_COPY_DESTS, copyDests.get());</span>
<a href="#l14.397"></a><span id="l14.397"> }</span>
<a href="#l14.398"></a><span id="l14.398"> </span>
<a href="#l14.399"></a><span id="l14.399"> /* attribute long numberOfCopies; */</span>
<a href="#l14.400"></a><span id="l14.400" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::GetNumberOfCopies(int32_t *aNumberOfCopies)</span>
<a href="#l14.401"></a><span id="l14.401" class="difflineminus">-{</span>
<a href="#l14.402"></a><span id="l14.402" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::GetNumberOfCopies(</span>
<a href="#l14.403"></a><span id="l14.403" class="difflineplus">+    int32_t *aNumberOfCopies) {</span>
<a href="#l14.404"></a><span id="l14.404">   NS_ENSURE_ARG(aNumberOfCopies);</span>
<a href="#l14.405"></a><span id="l14.405">   nsresult rv = GetCopiesFromDB();</span>
<a href="#l14.406"></a><span id="l14.406">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.407"></a><span id="l14.407">   *aNumberOfCopies = m_copyDestinations.Length();</span>
<a href="#l14.408"></a><span id="l14.408">   return NS_OK;</span>
<a href="#l14.409"></a><span id="l14.409"> }</span>
<a href="#l14.410"></a><span id="l14.410"> </span>
<a href="#l14.411"></a><span id="l14.411"> /* string getCopyDestination (in long copyIndex); */</span>
<a href="#l14.412"></a><span id="l14.412" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::GetCopyDestination(int32_t copyIndex, char **retval)</span>
<a href="#l14.413"></a><span id="l14.413" class="difflineminus">-{</span>
<a href="#l14.414"></a><span id="l14.414" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::GetCopyDestination(int32_t copyIndex,</span>
<a href="#l14.415"></a><span id="l14.415" class="difflineplus">+                                                            char **retval) {</span>
<a href="#l14.416"></a><span id="l14.416">   NS_ENSURE_ARG(retval);</span>
<a href="#l14.417"></a><span id="l14.417">   nsresult rv = GetCopiesFromDB();</span>
<a href="#l14.418"></a><span id="l14.418">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.419"></a><span id="l14.419">   if (copyIndex &gt;= (int32_t)m_copyDestinations.Length())</span>
<a href="#l14.420"></a><span id="l14.420">     return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l14.421"></a><span id="l14.421">   *retval = ToNewCString(m_copyDestinations.ElementAt(copyIndex));</span>
<a href="#l14.422"></a><span id="l14.422">   return (*retval) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l14.423"></a><span id="l14.423"> }</span>
<a href="#l14.424"></a><span id="l14.424"> </span>
<a href="#l14.425"></a><span id="l14.425"> /* attribute unsigned log msgSize; */</span>
<a href="#l14.426"></a><span id="l14.426" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::GetMsgSize(uint32_t *aMsgSize)</span>
<a href="#l14.427"></a><span id="l14.427" class="difflineminus">-{</span>
<a href="#l14.428"></a><span id="l14.428" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::GetMsgSize(uint32_t *aMsgSize) {</span>
<a href="#l14.429"></a><span id="l14.429">   NS_ENSURE_ARG(aMsgSize);</span>
<a href="#l14.430"></a><span id="l14.430">   return m_mdb-&gt;GetUint32Property(m_mdbRow, PROP_MSG_SIZE, aMsgSize, 0);</span>
<a href="#l14.431"></a><span id="l14.431"> }</span>
<a href="#l14.432"></a><span id="l14.432"> </span>
<a href="#l14.433"></a><span id="l14.433" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::SetMsgSize(uint32_t aMsgSize)</span>
<a href="#l14.434"></a><span id="l14.434" class="difflineminus">-{</span>
<a href="#l14.435"></a><span id="l14.435" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::SetMsgSize(uint32_t aMsgSize) {</span>
<a href="#l14.436"></a><span id="l14.436">   return m_mdb-&gt;SetUint32Property(m_mdbRow, PROP_MSG_SIZE, aMsgSize);</span>
<a href="#l14.437"></a><span id="l14.437"> }</span>
<a href="#l14.438"></a><span id="l14.438"> </span>
<a href="#l14.439"></a><span id="l14.439" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::SetPlayingBack(bool aPlayingBack)</span>
<a href="#l14.440"></a><span id="l14.440" class="difflineminus">-{</span>
<a href="#l14.441"></a><span id="l14.441" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::SetPlayingBack(bool aPlayingBack) {</span>
<a href="#l14.442"></a><span id="l14.442">   return m_mdb-&gt;SetBooleanProperty(m_mdbRow, PROP_PLAYINGBACK, aPlayingBack);</span>
<a href="#l14.443"></a><span id="l14.443"> }</span>
<a href="#l14.444"></a><span id="l14.444"> </span>
<a href="#l14.445"></a><span id="l14.445" class="difflineminus">-NS_IMETHODIMP nsMsgOfflineImapOperation::GetPlayingBack(bool *aPlayingBack)</span>
<a href="#l14.446"></a><span id="l14.446" class="difflineminus">-{</span>
<a href="#l14.447"></a><span id="l14.447" class="difflineplus">+NS_IMETHODIMP nsMsgOfflineImapOperation::GetPlayingBack(bool *aPlayingBack) {</span>
<a href="#l14.448"></a><span id="l14.448">   NS_ENSURE_ARG(aPlayingBack);</span>
<a href="#l14.449"></a><span id="l14.449">   return m_mdb-&gt;GetBooleanProperty(m_mdbRow, PROP_PLAYINGBACK, aPlayingBack);</span>
<a href="#l14.450"></a><span id="l14.450"> }</span>
<a href="#l14.451"></a><span id="l14.451"> </span>
<a href="#l14.452"></a><span id="l14.452" class="difflineminus">-</span>
<a href="#l14.453"></a><span id="l14.453" class="difflineminus">-void nsMsgOfflineImapOperation::Log()</span>
<a href="#l14.454"></a><span id="l14.454" class="difflineminus">-{</span>
<a href="#l14.455"></a><span id="l14.455" class="difflineminus">-  if (!MOZ_LOG_TEST(IMAPOffline, LogLevel::Info))</span>
<a href="#l14.456"></a><span id="l14.456" class="difflineminus">-    return;</span>
<a href="#l14.457"></a><span id="l14.457" class="difflineplus">+void nsMsgOfflineImapOperation::Log() {</span>
<a href="#l14.458"></a><span id="l14.458" class="difflineplus">+  if (!MOZ_LOG_TEST(IMAPOffline, LogLevel::Info)) return;</span>
<a href="#l14.459"></a><span id="l14.459">   //  const long kMoveResult              = 0x8;</span>
<a href="#l14.460"></a><span id="l14.460">   //  const long kAppendDraft           = 0x10;</span>
<a href="#l14.461"></a><span id="l14.461">   //  const long kAddedHeader           = 0x20;</span>
<a href="#l14.462"></a><span id="l14.462">   //  const long kDeletedMsg              = 0x40;</span>
<a href="#l14.463"></a><span id="l14.463">   //  const long kMsgMarkedDeleted = 0x80;</span>
<a href="#l14.464"></a><span id="l14.464">   //  const long kAppendTemplate      = 0x100;</span>
<a href="#l14.465"></a><span id="l14.465">   //  const long kDeleteAllMsgs          = 0x200;</span>
<a href="#l14.466"></a><span id="l14.466">   if (m_operation &amp; nsIMsgOfflineImapOperation::kFlagsChanged)</span>
<a href="#l14.467"></a><span id="l14.467" class="difflineminus">-    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x changeFlag:%x&quot;, m_messageKey, m_newFlags));</span>
<a href="#l14.468"></a><span id="l14.468" class="difflineminus">-  if (m_operation &amp; nsIMsgOfflineImapOperation::kMsgMoved)</span>
<a href="#l14.469"></a><span id="l14.469" class="difflineminus">-  {</span>
<a href="#l14.470"></a><span id="l14.470" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info,</span>
<a href="#l14.471"></a><span id="l14.471" class="difflineplus">+            (&quot;msg id %x changeFlag:%x&quot;, m_messageKey, m_newFlags));</span>
<a href="#l14.472"></a><span id="l14.472" class="difflineplus">+  if (m_operation &amp; nsIMsgOfflineImapOperation::kMsgMoved) {</span>
<a href="#l14.473"></a><span id="l14.473">     nsCString moveDestFolder;</span>
<a href="#l14.474"></a><span id="l14.474">     GetDestinationFolderURI(getter_Copies(moveDestFolder));</span>
<a href="#l14.475"></a><span id="l14.475" class="difflineminus">-    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x moveTo:%s&quot;, m_messageKey, moveDestFolder.get()));</span>
<a href="#l14.476"></a><span id="l14.476" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info,</span>
<a href="#l14.477"></a><span id="l14.477" class="difflineplus">+            (&quot;msg id %x moveTo:%s&quot;, m_messageKey, moveDestFolder.get()));</span>
<a href="#l14.478"></a><span id="l14.478">   }</span>
<a href="#l14.479"></a><span id="l14.479" class="difflineminus">-  if (m_operation &amp; nsIMsgOfflineImapOperation::kMsgCopy)</span>
<a href="#l14.480"></a><span id="l14.480" class="difflineminus">-  {</span>
<a href="#l14.481"></a><span id="l14.481" class="difflineplus">+  if (m_operation &amp; nsIMsgOfflineImapOperation::kMsgCopy) {</span>
<a href="#l14.482"></a><span id="l14.482">     nsCString copyDests;</span>
<a href="#l14.483"></a><span id="l14.483">     m_mdb-&gt;GetProperty(m_mdbRow, PROP_COPY_DESTS, getter_Copies(copyDests));</span>
<a href="#l14.484"></a><span id="l14.484" class="difflineminus">-    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x moveTo:%s&quot;, m_messageKey, copyDests.get()));</span>
<a href="#l14.485"></a><span id="l14.485" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info,</span>
<a href="#l14.486"></a><span id="l14.486" class="difflineplus">+            (&quot;msg id %x moveTo:%s&quot;, m_messageKey, copyDests.get()));</span>
<a href="#l14.487"></a><span id="l14.487">   }</span>
<a href="#l14.488"></a><span id="l14.488">   if (m_operation &amp; nsIMsgOfflineImapOperation::kAppendDraft)</span>
<a href="#l14.489"></a><span id="l14.489" class="difflineminus">-    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x append draft&quot;, m_messageKey));</span>
<a href="#l14.490"></a><span id="l14.490" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info,</span>
<a href="#l14.491"></a><span id="l14.491" class="difflineplus">+            (&quot;msg id %x append draft&quot;, m_messageKey));</span>
<a href="#l14.492"></a><span id="l14.492">   if (m_operation &amp; nsIMsgOfflineImapOperation::kAddKeywords)</span>
<a href="#l14.493"></a><span id="l14.493" class="difflineminus">-    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x add keyword:%s&quot;, m_messageKey, m_keywordsToAdd.get()));</span>
<a href="#l14.494"></a><span id="l14.494" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info,</span>
<a href="#l14.495"></a><span id="l14.495" class="difflineplus">+            (&quot;msg id %x add keyword:%s&quot;, m_messageKey, m_keywordsToAdd.get()));</span>
<a href="#l14.496"></a><span id="l14.496">   if (m_operation &amp; nsIMsgOfflineImapOperation::kRemoveKeywords)</span>
<a href="#l14.497"></a><span id="l14.497" class="difflineminus">-    MOZ_LOG(IMAPOffline, LogLevel::Info, (&quot;msg id %x remove keyword:%s&quot;, m_messageKey, m_keywordsToRemove.get()));</span>
<a href="#l14.498"></a><span id="l14.498" class="difflineplus">+    MOZ_LOG(IMAPOffline, LogLevel::Info,</span>
<a href="#l14.499"></a><span id="l14.499" class="difflineplus">+            (&quot;msg id %x remove keyword:%s&quot;, m_messageKey,</span>
<a href="#l14.500"></a><span id="l14.500" class="difflineplus">+             m_keywordsToRemove.get()));</span>
<a href="#l14.501"></a><span id="l14.501"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgOfflineImapOperation.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,55 +1,52 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l15.5"></a><span id="l15.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.6"></a><span id="l15.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.7"></a><span id="l15.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.8"></a><span id="l15.8"> #ifndef _nsMsgOfflineImapOperation_H_</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10" class="difflineminus">-#include &quot;nsIMsgOfflineImapOperation.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineminus">-#include &quot;mdb.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#include &quot;nsMsgDatabase.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+#  include &quot;nsIMsgOfflineImapOperation.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+#  include &quot;mdb.h&quot;</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+#  include &quot;nsMsgDatabase.h&quot;</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+#  include &quot;prlog.h&quot;</span>
<a href="#l15.18"></a><span id="l15.18"> </span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-class nsMsgOfflineImapOperation : public nsIMsgOfflineImapOperation</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-{</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-public:</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+class nsMsgOfflineImapOperation : public nsIMsgOfflineImapOperation {</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+ public:</span>
<a href="#l15.24"></a><span id="l15.24">   /** Instance Methods **/</span>
<a href="#l15.25"></a><span id="l15.25">   nsMsgOfflineImapOperation(nsMsgDatabase *db, nsIMdbRow *row);</span>
<a href="#l15.26"></a><span id="l15.26">   NS_DECL_ISUPPORTS</span>
<a href="#l15.27"></a><span id="l15.27">   NS_DECL_NSIMSGOFFLINEIMAPOPERATION</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+  nsIMdbRow *GetMDBRow() { return m_mdbRow; }</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+  nsresult GetCopiesFromDB();</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+  nsresult SetCopiesToDB();</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+  void Log();</span>
<a href="#l15.33"></a><span id="l15.33"> </span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-  nsIMdbRow   *GetMDBRow() {return m_mdbRow;}</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-  nsresult    GetCopiesFromDB();</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-  nsresult    SetCopiesToDB();</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-  void        Log();</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-protected:</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+ protected:</span>
<a href="#l15.40"></a><span id="l15.40">   virtual ~nsMsgOfflineImapOperation();</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-  nsresult AddKeyword(const char *aKeyword, nsCString &amp;addList, const char *addProp,</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-                      nsCString &amp;removeList, const char *removeProp);</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+  nsresult AddKeyword(const char *aKeyword, nsCString &amp;addList,</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+                      const char *addProp, nsCString &amp;removeList,</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+                      const char *removeProp);</span>
<a href="#l15.46"></a><span id="l15.46"> </span>
<a href="#l15.47"></a><span id="l15.47">   nsOfflineImapOperationType m_operation;</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-  nsMsgKey          m_messageKey;</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-  nsMsgKey          m_sourceMessageKey;</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-  uint32_t          m_operationFlags; // what to do on sync</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-  imapMessageFlagsType m_newFlags; // used for kFlagsChanged</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+  nsMsgKey m_messageKey;</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+  nsMsgKey m_sourceMessageKey;</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+  uint32_t m_operationFlags;        // what to do on sync</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+  imapMessageFlagsType m_newFlags;  // used for kFlagsChanged</span>
<a href="#l15.56"></a><span id="l15.56"> </span>
<a href="#l15.57"></a><span id="l15.57">   // these are URI's, and are escaped. Thus, we can use a delimter like ' '</span>
<a href="#l15.58"></a><span id="l15.58">   // because the real spaces should be escaped.</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-  nsCString  m_sourceFolder;</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-  nsCString  m_moveDestination;</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-  nsTArray&lt;nsCString&gt;  m_copyDestinations;</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+  nsCString m_sourceFolder;</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+  nsCString m_moveDestination;</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+  nsTArray&lt;nsCString&gt; m_copyDestinations;</span>
<a href="#l15.65"></a><span id="l15.65"> </span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-  nsCString      m_keywordsToAdd;</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-  nsCString      m_keywordsToRemove;</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+  nsCString m_keywordsToAdd;</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+  nsCString m_keywordsToRemove;</span>
<a href="#l15.70"></a><span id="l15.70"> </span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-  // nsMsgOfflineImapOperation will have to know what db and row they belong to, since they are really</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-  // just a wrapper around the offline operation row in the mdb.</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-  // though I hope not.</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-  nsMsgDatabase    *m_mdb;</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-  nsCOMPtr &lt;nsIMdbRow&gt; m_mdbRow;</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+  // nsMsgOfflineImapOperation will have to know what db and row they belong to,</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+  // since they are really just a wrapper around the offline operation row in</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+  // the mdb. though I hope not.</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+  nsMsgDatabase *m_mdb;</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; m_mdbRow;</span>
<a href="#l15.81"></a><span id="l15.81"> };</span>
<a href="#l15.82"></a><span id="l15.82"> </span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-</span>
<a href="#l15.85"></a><span id="l15.85"> #endif /* _nsMsgOfflineImapOperation_H_ */</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgThread.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgThread.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -8,218 +8,211 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;nsMsgThread.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsSimpleEnumerator.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;MailNewsTypes2.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;mozilla/DebugOnly.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10"> NS_IMPL_ISUPPORTS(nsMsgThread, nsIMsgThread)</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-nsMsgThread::nsMsgThread()</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-{</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-  Init();</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-}</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+nsMsgThread::nsMsgThread() { Init(); }</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-nsMsgThread::nsMsgThread(nsMsgDatabase *db, nsIMdbTable *table)</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-{</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+nsMsgThread::nsMsgThread(nsMsgDatabase *db, nsIMdbTable *table) {</span>
<a href="#l16.21"></a><span id="l16.21">   Init();</span>
<a href="#l16.22"></a><span id="l16.22">   m_mdbTable = table;</span>
<a href="#l16.23"></a><span id="l16.23">   m_mdbDB = db;</span>
<a href="#l16.24"></a><span id="l16.24">   if (db)</span>
<a href="#l16.25"></a><span id="l16.25">     db-&gt;m_threads.AppendElement(this);</span>
<a href="#l16.26"></a><span id="l16.26">   else</span>
<a href="#l16.27"></a><span id="l16.27">     NS_ERROR(&quot;no db for thread&quot;);</span>
<a href="#l16.28"></a><span id="l16.28"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l16.29"></a><span id="l16.29">   if (m_mdbDB-&gt;m_threads.Length() &gt; 5)</span>
<a href="#l16.30"></a><span id="l16.30">     printf(&quot;more than five outstanding threads\n&quot;);</span>
<a href="#l16.31"></a><span id="l16.31"> #endif</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-  if (table &amp;&amp; db)</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-  {</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-    table-&gt;GetMetaRow(db-&gt;GetEnv(), nullptr, nullptr, getter_AddRefs(m_metaRow));</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+  if (table &amp;&amp; db) {</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+    table-&gt;GetMetaRow(db-&gt;GetEnv(), nullptr, nullptr,</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+                      getter_AddRefs(m_metaRow));</span>
<a href="#l16.38"></a><span id="l16.38">     InitCachedValues();</span>
<a href="#l16.39"></a><span id="l16.39">   }</span>
<a href="#l16.40"></a><span id="l16.40"> }</span>
<a href="#l16.41"></a><span id="l16.41"> </span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-void nsMsgThread::Init()</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-{</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+void nsMsgThread::Init() {</span>
<a href="#l16.45"></a><span id="l16.45">   m_threadKey = nsMsgKey_None;</span>
<a href="#l16.46"></a><span id="l16.46">   m_threadRootKey = nsMsgKey_None;</span>
<a href="#l16.47"></a><span id="l16.47">   m_numChildren = 0;</span>
<a href="#l16.48"></a><span id="l16.48">   m_numUnreadChildren = 0;</span>
<a href="#l16.49"></a><span id="l16.49">   m_flags = 0;</span>
<a href="#l16.50"></a><span id="l16.50">   m_newestMsgDate = 0;</span>
<a href="#l16.51"></a><span id="l16.51">   m_cachedValuesInitialized = false;</span>
<a href="#l16.52"></a><span id="l16.52"> }</span>
<a href="#l16.53"></a><span id="l16.53"> </span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-nsMsgThread::~nsMsgThread()</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-{</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-  if (m_mdbDB)</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-  {</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+nsMsgThread::~nsMsgThread() {</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+  if (m_mdbDB) {</span>
<a href="#l16.60"></a><span id="l16.60">     mozilla::DebugOnly&lt;bool&gt; found = m_mdbDB-&gt;m_threads.RemoveElement(this);</span>
<a href="#l16.61"></a><span id="l16.61">     NS_ASSERTION(found, &quot;removing thread not in threads array&quot;);</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-  }</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-  else // This can happen if db is forced closed</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+  } else  // This can happen if db is forced closed</span>
<a href="#l16.65"></a><span id="l16.65">     NS_WARNING(&quot;null db in thread&quot;);</span>
<a href="#l16.66"></a><span id="l16.66">   Clear();</span>
<a href="#l16.67"></a><span id="l16.67"> }</span>
<a href="#l16.68"></a><span id="l16.68"> </span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-void nsMsgThread::Clear()</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-{</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+void nsMsgThread::Clear() {</span>
<a href="#l16.72"></a><span id="l16.72">   m_mdbTable = nullptr;</span>
<a href="#l16.73"></a><span id="l16.73">   m_metaRow = nullptr;</span>
<a href="#l16.74"></a><span id="l16.74">   m_mdbDB = nullptr;</span>
<a href="#l16.75"></a><span id="l16.75"> }</span>
<a href="#l16.76"></a><span id="l16.76"> </span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-nsresult nsMsgThread::InitCachedValues()</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-{</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+nsresult nsMsgThread::InitCachedValues() {</span>
<a href="#l16.80"></a><span id="l16.80">   nsresult err = NS_OK;</span>
<a href="#l16.81"></a><span id="l16.81"> </span>
<a href="#l16.82"></a><span id="l16.82">   NS_ENSURE_TRUE(m_mdbDB &amp;&amp; m_metaRow, NS_ERROR_INVALID_POINTER);</span>
<a href="#l16.83"></a><span id="l16.83"> </span>
<a href="#l16.84"></a><span id="l16.84" class="difflineminus">-  if (!m_cachedValuesInitialized)</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineminus">-  {</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineminus">-    err = m_mdbDB-&gt;RowCellColumnToUInt32(m_metaRow, m_mdbDB-&gt;m_threadFlagsColumnToken, &amp;m_flags);</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-    err = m_mdbDB-&gt;RowCellColumnToUInt32(m_metaRow, m_mdbDB-&gt;m_threadChildrenColumnToken, &amp;m_numChildren);</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-    err = m_mdbDB-&gt;RowCellColumnToUInt32(m_metaRow, m_mdbDB-&gt;m_threadIdColumnToken, &amp;m_threadKey, nsMsgKey_None);</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineminus">-    err = m_mdbDB-&gt;RowCellColumnToUInt32(m_metaRow, m_mdbDB-&gt;m_threadUnreadChildrenColumnToken, &amp;m_numUnreadChildren);</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-    err = m_mdbDB-&gt;RowCellColumnToUInt32(m_metaRow, m_mdbDB-&gt;m_threadRootKeyColumnToken, &amp;m_threadRootKey, nsMsgKey_None);</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineminus">-    err = m_mdbDB-&gt;RowCellColumnToUInt32(m_metaRow, m_mdbDB-&gt;m_threadNewestMsgDateColumnToken, &amp;m_newestMsgDate, 0);</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineminus">-    // fix num children if it's wrong. this doesn't work - some DB's have a bogus thread table</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-    // that is full of bogus headers - don't know why.</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+  if (!m_cachedValuesInitialized) {</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+    err = m_mdbDB-&gt;RowCellColumnToUInt32(</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+        m_metaRow, m_mdbDB-&gt;m_threadFlagsColumnToken, &amp;m_flags);</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+    err = m_mdbDB-&gt;RowCellColumnToUInt32(</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+        m_metaRow, m_mdbDB-&gt;m_threadChildrenColumnToken, &amp;m_numChildren);</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+    err = m_mdbDB-&gt;RowCellColumnToUInt32(</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+        m_metaRow, m_mdbDB-&gt;m_threadIdColumnToken, &amp;m_threadKey, nsMsgKey_None);</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+    err = m_mdbDB-&gt;RowCellColumnToUInt32(</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+        m_metaRow, m_mdbDB-&gt;m_threadUnreadChildrenColumnToken,</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+        &amp;m_numUnreadChildren);</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+    err = m_mdbDB-&gt;RowCellColumnToUInt32(m_metaRow,</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+                                         m_mdbDB-&gt;m_threadRootKeyColumnToken,</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+                                         &amp;m_threadRootKey, nsMsgKey_None);</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+    err = m_mdbDB-&gt;RowCellColumnToUInt32(</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+        m_metaRow, m_mdbDB-&gt;m_threadNewestMsgDateColumnToken, &amp;m_newestMsgDate,</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+        0);</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+    // fix num children if it's wrong. this doesn't work - some DB's have a</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+    // bogus thread table that is full of bogus headers - don't know why.</span>
<a href="#l16.112"></a><span id="l16.112">     uint32_t rowCount = 0;</span>
<a href="#l16.113"></a><span id="l16.113">     m_mdbTable-&gt;GetCount(m_mdbDB-&gt;GetEnv(), &amp;rowCount);</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineminus">-    //    NS_ASSERTION(m_numChildren &lt;= rowCount, &quot;num children wrong - fixing&quot;);</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+    //    NS_ASSERTION(m_numChildren &lt;= rowCount, &quot;num children wrong -</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+    //    fixing&quot;);</span>
<a href="#l16.117"></a><span id="l16.117">     if (m_numChildren &gt; rowCount)</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineminus">-      ChangeChildCount((int32_t) rowCount - (int32_t) m_numChildren);</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineminus">-    if ((int32_t) m_numUnreadChildren &lt; 0)</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineminus">-      ChangeUnreadChildCount(- (int32_t) m_numUnreadChildren);</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineminus">-    if (NS_SUCCEEDED(err))</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineminus">-      m_cachedValuesInitialized = true;</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+      ChangeChildCount((int32_t)rowCount - (int32_t)m_numChildren);</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineplus">+    if ((int32_t)m_numUnreadChildren &lt; 0)</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+      ChangeUnreadChildCount(-(int32_t)m_numUnreadChildren);</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+    if (NS_SUCCEEDED(err)) m_cachedValuesInitialized = true;</span>
<a href="#l16.127"></a><span id="l16.127">   }</span>
<a href="#l16.128"></a><span id="l16.128">   return err;</span>
<a href="#l16.129"></a><span id="l16.129"> }</span>
<a href="#l16.130"></a><span id="l16.130"> </span>
<a href="#l16.131"></a><span id="l16.131" class="difflineminus">-NS_IMETHODIMP nsMsgThread::SetThreadKey(nsMsgKey threadKey)</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineminus">-{</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+NS_IMETHODIMP nsMsgThread::SetThreadKey(nsMsgKey threadKey) {</span>
<a href="#l16.134"></a><span id="l16.134">   NS_ASSERTION(m_threadKey == nsMsgKey_None || m_threadKey == threadKey,</span>
<a href="#l16.135"></a><span id="l16.135">                &quot;shouldn't be changing thread key&quot;);</span>
<a href="#l16.136"></a><span id="l16.136">   m_threadKey = threadKey;</span>
<a href="#l16.137"></a><span id="l16.137">   // by definition, the initial thread key is also the thread root key.</span>
<a href="#l16.138"></a><span id="l16.138">   SetThreadRootKey(threadKey);</span>
<a href="#l16.139"></a><span id="l16.139">   // gotta set column in meta row here.</span>
<a href="#l16.140"></a><span id="l16.140">   return m_mdbDB-&gt;UInt32ToRowCellColumn(</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineminus">-                    m_metaRow, m_mdbDB-&gt;m_threadIdColumnToken, threadKey);</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+      m_metaRow, m_mdbDB-&gt;m_threadIdColumnToken, threadKey);</span>
<a href="#l16.143"></a><span id="l16.143"> }</span>
<a href="#l16.144"></a><span id="l16.144"> </span>
<a href="#l16.145"></a><span id="l16.145" class="difflineminus">-NS_IMETHODIMP nsMsgThread::GetThreadKey(nsMsgKey *result)</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineminus">-{</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+NS_IMETHODIMP nsMsgThread::GetThreadKey(nsMsgKey *result) {</span>
<a href="#l16.148"></a><span id="l16.148">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineminus">-  nsresult res = m_mdbDB-&gt;RowCellColumnToUInt32(m_metaRow, m_mdbDB-&gt;m_threadIdColumnToken, &amp;m_threadKey);</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+  nsresult res = m_mdbDB-&gt;RowCellColumnToUInt32(</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+      m_metaRow, m_mdbDB-&gt;m_threadIdColumnToken, &amp;m_threadKey);</span>
<a href="#l16.152"></a><span id="l16.152">   *result = m_threadKey;</span>
<a href="#l16.153"></a><span id="l16.153">   return res;</span>
<a href="#l16.154"></a><span id="l16.154"> }</span>
<a href="#l16.155"></a><span id="l16.155"> </span>
<a href="#l16.156"></a><span id="l16.156" class="difflineminus">-NS_IMETHODIMP nsMsgThread::GetFlags(uint32_t *result)</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineminus">-{</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+NS_IMETHODIMP nsMsgThread::GetFlags(uint32_t *result) {</span>
<a href="#l16.159"></a><span id="l16.159">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineminus">-  nsresult res = m_mdbDB-&gt;RowCellColumnToUInt32(m_metaRow, m_mdbDB-&gt;m_threadFlagsColumnToken, &amp;m_flags);</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineplus">+  nsresult res = m_mdbDB-&gt;RowCellColumnToUInt32(</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineplus">+      m_metaRow, m_mdbDB-&gt;m_threadFlagsColumnToken, &amp;m_flags);</span>
<a href="#l16.163"></a><span id="l16.163">   *result = m_flags;</span>
<a href="#l16.164"></a><span id="l16.164">   return res;</span>
<a href="#l16.165"></a><span id="l16.165"> }</span>
<a href="#l16.166"></a><span id="l16.166"> </span>
<a href="#l16.167"></a><span id="l16.167" class="difflineminus">-NS_IMETHODIMP nsMsgThread::SetFlags(uint32_t flags)</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineminus">-{</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+NS_IMETHODIMP nsMsgThread::SetFlags(uint32_t flags) {</span>
<a href="#l16.170"></a><span id="l16.170">   m_flags = flags;</span>
<a href="#l16.171"></a><span id="l16.171">   return m_mdbDB-&gt;UInt32ToRowCellColumn(</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineminus">-                    m_metaRow, m_mdbDB-&gt;m_threadFlagsColumnToken, m_flags);</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+      m_metaRow, m_mdbDB-&gt;m_threadFlagsColumnToken, m_flags);</span>
<a href="#l16.174"></a><span id="l16.174"> }</span>
<a href="#l16.175"></a><span id="l16.175"> </span>
<a href="#l16.176"></a><span id="l16.176" class="difflineminus">-NS_IMETHODIMP nsMsgThread::SetSubject(const nsACString&amp; aSubject)</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineminus">-{</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineminus">-  return m_mdbDB-&gt;CharPtrToRowCellColumn(m_metaRow, m_mdbDB-&gt;m_threadSubjectColumnToken, nsCString(aSubject).get());</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineplus">+NS_IMETHODIMP nsMsgThread::SetSubject(const nsACString &amp;aSubject) {</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineplus">+  return m_mdbDB-&gt;CharPtrToRowCellColumn(m_metaRow,</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineplus">+                                         m_mdbDB-&gt;m_threadSubjectColumnToken,</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineplus">+                                         nsCString(aSubject).get());</span>
<a href="#l16.183"></a><span id="l16.183"> }</span>
<a href="#l16.184"></a><span id="l16.184"> </span>
<a href="#l16.185"></a><span id="l16.185" class="difflineminus">-NS_IMETHODIMP nsMsgThread::GetSubject(nsACString&amp; aSubject)</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineminus">-{</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineplus">+NS_IMETHODIMP nsMsgThread::GetSubject(nsACString &amp;aSubject) {</span>
<a href="#l16.188"></a><span id="l16.188">   nsCString subjectStr;</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineminus">-  nsresult rv = m_mdbDB-&gt;RowCellColumnToCharPtr(m_metaRow, m_mdbDB-&gt;m_threadSubjectColumnToken,</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineminus">-                                                getter_Copies(subjectStr));</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineplus">+  nsresult rv = m_mdbDB-&gt;RowCellColumnToCharPtr(</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineplus">+      m_metaRow, m_mdbDB-&gt;m_threadSubjectColumnToken,</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineplus">+      getter_Copies(subjectStr));</span>
<a href="#l16.194"></a><span id="l16.194"> </span>
<a href="#l16.195"></a><span id="l16.195">   aSubject.Assign(subjectStr);</span>
<a href="#l16.196"></a><span id="l16.196">   return rv;</span>
<a href="#l16.197"></a><span id="l16.197"> }</span>
<a href="#l16.198"></a><span id="l16.198"> </span>
<a href="#l16.199"></a><span id="l16.199" class="difflineminus">-NS_IMETHODIMP nsMsgThread::GetNumChildren(uint32_t *result)</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineminus">-{</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+NS_IMETHODIMP nsMsgThread::GetNumChildren(uint32_t *result) {</span>
<a href="#l16.202"></a><span id="l16.202">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l16.203"></a><span id="l16.203">   *result = m_numChildren;</span>
<a href="#l16.204"></a><span id="l16.204">   return NS_OK;</span>
<a href="#l16.205"></a><span id="l16.205"> }</span>
<a href="#l16.206"></a><span id="l16.206"> </span>
<a href="#l16.207"></a><span id="l16.207" class="difflineminus">-NS_IMETHODIMP nsMsgThread::GetNumUnreadChildren (uint32_t *result)</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineminus">-{</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineplus">+NS_IMETHODIMP nsMsgThread::GetNumUnreadChildren(uint32_t *result) {</span>
<a href="#l16.210"></a><span id="l16.210">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l16.211"></a><span id="l16.211">   *result = m_numUnreadChildren;</span>
<a href="#l16.212"></a><span id="l16.212">   return NS_OK;</span>
<a href="#l16.213"></a><span id="l16.213"> }</span>
<a href="#l16.214"></a><span id="l16.214"> </span>
<a href="#l16.215"></a><span id="l16.215" class="difflineminus">-nsresult nsMsgThread::RerootThread(nsIMsgDBHdr *newParentOfOldRoot, nsIMsgDBHdr *oldRoot, nsIDBChangeAnnouncer *announcer)</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineminus">-{</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineplus">+nsresult nsMsgThread::RerootThread(nsIMsgDBHdr *newParentOfOldRoot,</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineplus">+                                   nsIMsgDBHdr *oldRoot,</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineplus">+                                   nsIDBChangeAnnouncer *announcer) {</span>
<a href="#l16.220"></a><span id="l16.220">   nsresult rv = NS_OK;</span>
<a href="#l16.221"></a><span id="l16.221">   mdb_pos outPos;</span>
<a href="#l16.222"></a><span id="l16.222">   nsMsgKey newHdrAncestor;</span>
<a href="#l16.223"></a><span id="l16.223">   nsCOMPtr&lt;nsIMsgDBHdr&gt; ancestorHdr = newParentOfOldRoot;</span>
<a href="#l16.224"></a><span id="l16.224">   nsMsgKey newRoot;</span>
<a href="#l16.225"></a><span id="l16.225"> </span>
<a href="#l16.226"></a><span id="l16.226">   ancestorHdr-&gt;GetMessageKey(&amp;newRoot);</span>
<a href="#l16.227"></a><span id="l16.227">   // loop trying to find the oldest ancestor of this msg</span>
<a href="#l16.228"></a><span id="l16.228">   // that is a parent of the root. The oldest ancestor will</span>
<a href="#l16.229"></a><span id="l16.229">   // become the root of the thread.</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineminus">-  do</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineminus">-  {</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineplus">+  do {</span>
<a href="#l16.233"></a><span id="l16.233">     ancestorHdr-&gt;GetThreadParent(&amp;newHdrAncestor);</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineminus">-    if (newHdrAncestor != nsMsgKey_None &amp;&amp; newHdrAncestor != m_threadRootKey &amp;&amp; newHdrAncestor != newRoot)</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineminus">-    {</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineplus">+    if (newHdrAncestor != nsMsgKey_None &amp;&amp; newHdrAncestor != m_threadRootKey &amp;&amp;</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineplus">+        newHdrAncestor != newRoot) {</span>
<a href="#l16.238"></a><span id="l16.238">       newRoot = newHdrAncestor;</span>
<a href="#l16.239"></a><span id="l16.239">       rv = m_mdbDB-&gt;GetMsgHdrForKey(newRoot, getter_AddRefs(ancestorHdr));</span>
<a href="#l16.240"></a><span id="l16.240">     }</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineminus">-  }</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineminus">-  while (NS_SUCCEEDED(rv) &amp;&amp; ancestorHdr &amp;&amp; newHdrAncestor != nsMsgKey_None &amp;&amp; newHdrAncestor != m_threadRootKey</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineminus">-    &amp;&amp; newHdrAncestor != newRoot);</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineplus">+  } while (NS_SUCCEEDED(rv) &amp;&amp; ancestorHdr &amp;&amp; newHdrAncestor != nsMsgKey_None &amp;&amp;</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineplus">+           newHdrAncestor != m_threadRootKey &amp;&amp; newHdrAncestor != newRoot);</span>
<a href="#l16.246"></a><span id="l16.246">   SetThreadRootKey(newRoot);</span>
<a href="#l16.247"></a><span id="l16.247">   ReparentNonReferenceChildrenOf(oldRoot, newRoot, announcer);</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineminus">-  if (ancestorHdr)</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineminus">-  {</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineplus">+  if (ancestorHdr) {</span>
<a href="#l16.251"></a><span id="l16.251">     nsIMsgDBHdr *msgHdr = ancestorHdr;</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineminus">-    nsMsgHdr* rootMsgHdr = static_cast&lt;nsMsgHdr*&gt;(msgHdr);          // closed system, cast ok</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineplus">+    nsMsgHdr *rootMsgHdr =</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineplus">+        static_cast&lt;nsMsgHdr *&gt;(msgHdr);  // closed system, cast ok</span>
<a href="#l16.255"></a><span id="l16.255">     nsIMdbRow *newRootHdrRow = rootMsgHdr-&gt;GetMDBRow();</span>
<a href="#l16.256"></a><span id="l16.256">     // move the  root hdr to pos 0.</span>
<a href="#l16.257"></a><span id="l16.257">     m_mdbTable-&gt;MoveRow(m_mdbDB-&gt;GetEnv(), newRootHdrRow, -1, 0, &amp;outPos);</span>
<a href="#l16.258"></a><span id="l16.258">     ancestorHdr-&gt;SetThreadParent(nsMsgKey_None);</span>
<a href="#l16.259"></a><span id="l16.259">   }</span>
<a href="#l16.260"></a><span id="l16.260">   return rv;</span>
<a href="#l16.261"></a><span id="l16.261"> }</span>
<a href="#l16.262"></a><span id="l16.262"> </span>
<a href="#l16.263"></a><span id="l16.263" class="difflineminus">-NS_IMETHODIMP nsMsgThread::AddChild(nsIMsgDBHdr *child, nsIMsgDBHdr *inReplyTo, bool threadInThread,</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineminus">-                                    nsIDBChangeAnnouncer *announcer)</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineminus">-{</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineplus">+NS_IMETHODIMP nsMsgThread::AddChild(nsIMsgDBHdr *child, nsIMsgDBHdr *inReplyTo,</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineplus">+                                    bool threadInThread,</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineplus">+                                    nsIDBChangeAnnouncer *announcer) {</span>
<a href="#l16.269"></a><span id="l16.269">   nsresult rv = NS_OK;</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineminus">-  nsMsgHdr* hdr = static_cast&lt;nsMsgHdr*&gt;(child);          // closed system, cast ok</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineplus">+  nsMsgHdr *hdr = static_cast&lt;nsMsgHdr *&gt;(child);  // closed system, cast ok</span>
<a href="#l16.272"></a><span id="l16.272">   uint32_t newHdrFlags = 0;</span>
<a href="#l16.273"></a><span id="l16.273">   uint32_t msgDate;</span>
<a href="#l16.274"></a><span id="l16.274">   nsMsgKey newHdrKey = 0;</span>
<a href="#l16.275"></a><span id="l16.275">   bool parentKeyNeedsSetting = true;</span>
<a href="#l16.276"></a><span id="l16.276"> </span>
<a href="#l16.277"></a><span id="l16.277">   nsIMdbRow *hdrRow = hdr-&gt;GetMDBRow();</span>
<a href="#l16.278"></a><span id="l16.278">   NS_ENSURE_STATE(hdrRow);</span>
<a href="#l16.279"></a><span id="l16.279">   hdr-&gt;GetRawFlags(&amp;newHdrFlags);</span>
<a href="#l16.280"></a><span id="l16.280">   hdr-&gt;GetMessageKey(&amp;newHdrKey);</span>
<a href="#l16.281"></a><span id="l16.281">   hdr-&gt;GetDateInSeconds(&amp;msgDate);</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineminus">-  if (msgDate &gt; m_newestMsgDate)</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineminus">-    SetNewestMsgDate(msgDate);</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineplus">+  if (msgDate &gt; m_newestMsgDate) SetNewestMsgDate(msgDate);</span>
<a href="#l16.285"></a><span id="l16.285"> </span>
<a href="#l16.286"></a><span id="l16.286">   if (newHdrFlags &amp; nsMsgMessageFlags::Watched)</span>
<a href="#l16.287"></a><span id="l16.287">     SetFlags(m_flags | nsMsgMessageFlags::Watched);</span>
<a href="#l16.288"></a><span id="l16.288"> </span>
<a href="#l16.289"></a><span id="l16.289">   child-&gt;AndFlags(~(nsMsgMessageFlags::Watched), &amp;newHdrFlags);</span>
<a href="#l16.290"></a><span id="l16.290"> </span>
<a href="#l16.291"></a><span id="l16.291">   // These are threading flags that the child may have set before being added</span>
<a href="#l16.292"></a><span id="l16.292">   // to the database.</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineat">@@ -229,131 +222,115 @@ NS_IMETHODIMP nsMsgThread::AddChild(nsIM</span>
<a href="#l16.294"></a><span id="l16.294">   // Clear the flag so that it doesn't fudge anywhere else</span>
<a href="#l16.295"></a><span id="l16.295">   child-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;, 0);</span>
<a href="#l16.296"></a><span id="l16.296"> </span>
<a href="#l16.297"></a><span id="l16.297">   uint32_t numChildren = 0;</span>
<a href="#l16.298"></a><span id="l16.298">   // get the num children before we add the new header.</span>
<a href="#l16.299"></a><span id="l16.299">   GetNumChildren(&amp;numChildren);</span>
<a href="#l16.300"></a><span id="l16.300"> </span>
<a href="#l16.301"></a><span id="l16.301">   // if this is an empty thread, set the root key to this header's key</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineminus">-  if (numChildren == 0)</span>
<a href="#l16.303"></a><span id="l16.303" class="difflineminus">-    SetThreadRootKey(newHdrKey);</span>
<a href="#l16.304"></a><span id="l16.304" class="difflineplus">+  if (numChildren == 0) SetThreadRootKey(newHdrKey);</span>
<a href="#l16.305"></a><span id="l16.305"> </span>
<a href="#l16.306"></a><span id="l16.306" class="difflineminus">-  if (m_mdbTable)</span>
<a href="#l16.307"></a><span id="l16.307" class="difflineminus">-  {</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineplus">+  if (m_mdbTable) {</span>
<a href="#l16.309"></a><span id="l16.309">     m_mdbTable-&gt;AddRow(m_mdbDB-&gt;GetEnv(), hdrRow);</span>
<a href="#l16.310"></a><span id="l16.310">     ChangeChildCount(1);</span>
<a href="#l16.311"></a><span id="l16.311" class="difflineminus">-    if (! (newHdrFlags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l16.312"></a><span id="l16.312" class="difflineminus">-      ChangeUnreadChildCount(1);</span>
<a href="#l16.313"></a><span id="l16.313" class="difflineplus">+    if (!(newHdrFlags &amp; nsMsgMessageFlags::Read)) ChangeUnreadChildCount(1);</span>
<a href="#l16.314"></a><span id="l16.314">   }</span>
<a href="#l16.315"></a><span id="l16.315" class="difflineminus">-  if (inReplyTo)</span>
<a href="#l16.316"></a><span id="l16.316" class="difflineminus">-  {</span>
<a href="#l16.317"></a><span id="l16.317" class="difflineplus">+  if (inReplyTo) {</span>
<a href="#l16.318"></a><span id="l16.318">     nsMsgKey parentKey;</span>
<a href="#l16.319"></a><span id="l16.319">     inReplyTo-&gt;GetMessageKey(&amp;parentKey);</span>
<a href="#l16.320"></a><span id="l16.320">     child-&gt;SetThreadParent(parentKey);</span>
<a href="#l16.321"></a><span id="l16.321">     parentKeyNeedsSetting = false;</span>
<a href="#l16.322"></a><span id="l16.322">   }</span>
<a href="#l16.323"></a><span id="l16.323"> </span>
<a href="#l16.324"></a><span id="l16.324">   // check if this header is a parent of one of the messages in this thread</span>
<a href="#l16.325"></a><span id="l16.325">   bool hdrMoved = false;</span>
<a href="#l16.326"></a><span id="l16.326">   nsCOMPtr&lt;nsIMsgDBHdr&gt; curHdr;</span>
<a href="#l16.327"></a><span id="l16.327">   uint32_t moveIndex = 0;</span>
<a href="#l16.328"></a><span id="l16.328"> </span>
<a href="#l16.329"></a><span id="l16.329">   PRTime newHdrDate;</span>
<a href="#l16.330"></a><span id="l16.330">   child-&gt;GetDate(&amp;newHdrDate);</span>
<a href="#l16.331"></a><span id="l16.331"> </span>
<a href="#l16.332"></a><span id="l16.332" class="difflineminus">-  // This is an ugly but simple fix for a difficult problem. Basically, when we add</span>
<a href="#l16.333"></a><span id="l16.333" class="difflineminus">-  // a message to a thread, we have to run through the thread to see if the new</span>
<a href="#l16.334"></a><span id="l16.334" class="difflineminus">-  // message is a parent of an existing message in the thread, and adjust things</span>
<a href="#l16.335"></a><span id="l16.335" class="difflineminus">-  // accordingly. If you thread by subject, and you have a large folder with</span>
<a href="#l16.336"></a><span id="l16.336" class="difflineminus">-  // messages w/ all the same subject, this code can take a really long time. So the</span>
<a href="#l16.337"></a><span id="l16.337" class="difflineminus">-  // pragmatic thing is to say that for threads with more than 1000 messages, it's</span>
<a href="#l16.338"></a><span id="l16.338" class="difflineminus">-  // simply not worth dealing with the case where the parent comes in after the</span>
<a href="#l16.339"></a><span id="l16.339" class="difflineminus">-  // child. Threads with more than 1000 messages are pretty unwieldy anyway.</span>
<a href="#l16.340"></a><span id="l16.340" class="difflineminus">-  // See Bug 90452</span>
<a href="#l16.341"></a><span id="l16.341" class="difflineplus">+  // This is an ugly but simple fix for a difficult problem. Basically, when we</span>
<a href="#l16.342"></a><span id="l16.342" class="difflineplus">+  // add a message to a thread, we have to run through the thread to see if the</span>
<a href="#l16.343"></a><span id="l16.343" class="difflineplus">+  // new message is a parent of an existing message in the thread, and adjust</span>
<a href="#l16.344"></a><span id="l16.344" class="difflineplus">+  // things accordingly. If you thread by subject, and you have a large folder</span>
<a href="#l16.345"></a><span id="l16.345" class="difflineplus">+  // with messages w/ all the same subject, this code can take a really long</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineplus">+  // time. So the pragmatic thing is to say that for threads with more than 1000</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineplus">+  // messages, it's simply not worth dealing with the case where the parent</span>
<a href="#l16.348"></a><span id="l16.348" class="difflineplus">+  // comes in after the child. Threads with more than 1000 messages are pretty</span>
<a href="#l16.349"></a><span id="l16.349" class="difflineplus">+  // unwieldy anyway. See Bug 90452</span>
<a href="#l16.350"></a><span id="l16.350"> </span>
<a href="#l16.351"></a><span id="l16.351" class="difflineminus">-  if (numChildren &lt; 1000)</span>
<a href="#l16.352"></a><span id="l16.352" class="difflineminus">-  {</span>
<a href="#l16.353"></a><span id="l16.353" class="difflineminus">-    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l16.354"></a><span id="l16.354" class="difflineminus">-    {</span>
<a href="#l16.355"></a><span id="l16.355" class="difflineplus">+  if (numChildren &lt; 1000) {</span>
<a href="#l16.356"></a><span id="l16.356" class="difflineplus">+    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l16.357"></a><span id="l16.357">       nsMsgKey msgKey = nsMsgKey_None;</span>
<a href="#l16.358"></a><span id="l16.358"> </span>
<a href="#l16.359"></a><span id="l16.359">       rv = GetChildHdrAt(childIndex, getter_AddRefs(curHdr));</span>
<a href="#l16.360"></a><span id="l16.360" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; curHdr)</span>
<a href="#l16.361"></a><span id="l16.361" class="difflineminus">-      {</span>
<a href="#l16.362"></a><span id="l16.362" class="difflineminus">-        if (hdr-&gt;IsParentOf(curHdr))</span>
<a href="#l16.363"></a><span id="l16.363" class="difflineminus">-        {</span>
<a href="#l16.364"></a><span id="l16.364" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; curHdr) {</span>
<a href="#l16.365"></a><span id="l16.365" class="difflineplus">+        if (hdr-&gt;IsParentOf(curHdr)) {</span>
<a href="#l16.366"></a><span id="l16.366">           nsMsgKey oldThreadParent;</span>
<a href="#l16.367"></a><span id="l16.367">           mdb_pos outPos;</span>
<a href="#l16.368"></a><span id="l16.368">           // move this hdr before the current header.</span>
<a href="#l16.369"></a><span id="l16.369" class="difflineminus">-          if (!hdrMoved)</span>
<a href="#l16.370"></a><span id="l16.370" class="difflineminus">-          {</span>
<a href="#l16.371"></a><span id="l16.371" class="difflineminus">-            m_mdbTable-&gt;MoveRow(m_mdbDB-&gt;GetEnv(), hdrRow, -1, childIndex, &amp;outPos);</span>
<a href="#l16.372"></a><span id="l16.372" class="difflineplus">+          if (!hdrMoved) {</span>
<a href="#l16.373"></a><span id="l16.373" class="difflineplus">+            m_mdbTable-&gt;MoveRow(m_mdbDB-&gt;GetEnv(), hdrRow, -1, childIndex,</span>
<a href="#l16.374"></a><span id="l16.374" class="difflineplus">+                                &amp;outPos);</span>
<a href="#l16.375"></a><span id="l16.375">             hdrMoved = true;</span>
<a href="#l16.376"></a><span id="l16.376">             curHdr-&gt;GetThreadParent(&amp;oldThreadParent);</span>
<a href="#l16.377"></a><span id="l16.377">             curHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l16.378"></a><span id="l16.378">             nsCOMPtr&lt;nsIMsgDBHdr&gt; curParent;</span>
<a href="#l16.379"></a><span id="l16.379" class="difflineminus">-            m_mdbDB-&gt;GetMsgHdrForKey(oldThreadParent, getter_AddRefs(curParent));</span>
<a href="#l16.380"></a><span id="l16.380" class="difflineminus">-            if (curParent &amp;&amp; hdr-&gt;IsAncestorOf(curParent))</span>
<a href="#l16.381"></a><span id="l16.381" class="difflineminus">-            {</span>
<a href="#l16.382"></a><span id="l16.382" class="difflineplus">+            m_mdbDB-&gt;GetMsgHdrForKey(oldThreadParent,</span>
<a href="#l16.383"></a><span id="l16.383" class="difflineplus">+                                     getter_AddRefs(curParent));</span>
<a href="#l16.384"></a><span id="l16.384" class="difflineplus">+            if (curParent &amp;&amp; hdr-&gt;IsAncestorOf(curParent)) {</span>
<a href="#l16.385"></a><span id="l16.385">               nsMsgKey curParentKey;</span>
<a href="#l16.386"></a><span id="l16.386">               curParent-&gt;GetMessageKey(&amp;curParentKey);</span>
<a href="#l16.387"></a><span id="l16.387" class="difflineminus">-              if (curParentKey == m_threadRootKey)</span>
<a href="#l16.388"></a><span id="l16.388" class="difflineminus">-              {</span>
<a href="#l16.389"></a><span id="l16.389" class="difflineplus">+              if (curParentKey == m_threadRootKey) {</span>
<a href="#l16.390"></a><span id="l16.390">                 m_mdbTable-&gt;MoveRow(m_mdbDB-&gt;GetEnv(), hdrRow, -1, 0, &amp;outPos);</span>
<a href="#l16.391"></a><span id="l16.391">                 RerootThread(child, curParent, announcer);</span>
<a href="#l16.392"></a><span id="l16.392">                 parentKeyNeedsSetting = false;</span>
<a href="#l16.393"></a><span id="l16.393">               }</span>
<a href="#l16.394"></a><span id="l16.394" class="difflineminus">-            }</span>
<a href="#l16.395"></a><span id="l16.395" class="difflineminus">-            else if (msgKey == m_threadRootKey)</span>
<a href="#l16.396"></a><span id="l16.396" class="difflineminus">-            {</span>
<a href="#l16.397"></a><span id="l16.397" class="difflineplus">+            } else if (msgKey == m_threadRootKey) {</span>
<a href="#l16.398"></a><span id="l16.398">               RerootThread(child, curHdr, announcer);</span>
<a href="#l16.399"></a><span id="l16.399">               parentKeyNeedsSetting = false;</span>
<a href="#l16.400"></a><span id="l16.400">             }</span>
<a href="#l16.401"></a><span id="l16.401">           }</span>
<a href="#l16.402"></a><span id="l16.402">           curHdr-&gt;SetThreadParent(newHdrKey);</span>
<a href="#l16.403"></a><span id="l16.403">           // TODO: what should be msgKey if hdrMoved was true above?</span>
<a href="#l16.404"></a><span id="l16.404" class="difflineminus">-          if (msgKey == newHdrKey)</span>
<a href="#l16.405"></a><span id="l16.405" class="difflineminus">-            parentKeyNeedsSetting = false;</span>
<a href="#l16.406"></a><span id="l16.406" class="difflineplus">+          if (msgKey == newHdrKey) parentKeyNeedsSetting = false;</span>
<a href="#l16.407"></a><span id="l16.407"> </span>
<a href="#l16.408"></a><span id="l16.408">           // OK, this is a reparenting - need to send notification</span>
<a href="#l16.409"></a><span id="l16.409">           if (announcer)</span>
<a href="#l16.410"></a><span id="l16.410" class="difflineminus">-            announcer-&gt;NotifyParentChangedAll(msgKey, oldThreadParent, newHdrKey, nullptr);</span>
<a href="#l16.411"></a><span id="l16.411" class="difflineplus">+            announcer-&gt;NotifyParentChangedAll(msgKey, oldThreadParent,</span>
<a href="#l16.412"></a><span id="l16.412" class="difflineplus">+                                              newHdrKey, nullptr);</span>
<a href="#l16.413"></a><span id="l16.413"> #ifdef DEBUG_bienvenu1</span>
<a href="#l16.414"></a><span id="l16.414" class="difflineminus">-          if (newHdrKey != m_threadKey)</span>
<a href="#l16.415"></a><span id="l16.415" class="difflineminus">-            printf(&quot;adding second level child\n&quot;);</span>
<a href="#l16.416"></a><span id="l16.416" class="difflineplus">+          if (newHdrKey != m_threadKey) printf(&quot;adding second level child\n&quot;);</span>
<a href="#l16.417"></a><span id="l16.417"> #endif</span>
<a href="#l16.418"></a><span id="l16.418">         }</span>
<a href="#l16.419"></a><span id="l16.419">         // Calculate a position for this child in date order</span>
<a href="#l16.420"></a><span id="l16.420" class="difflineminus">-        else if (!hdrMoved &amp;&amp; childIndex &gt; 0 &amp;&amp; moveIndex == 0)</span>
<a href="#l16.421"></a><span id="l16.421" class="difflineminus">-        {</span>
<a href="#l16.422"></a><span id="l16.422" class="difflineplus">+        else if (!hdrMoved &amp;&amp; childIndex &gt; 0 &amp;&amp; moveIndex == 0) {</span>
<a href="#l16.423"></a><span id="l16.423">           PRTime curHdrDate;</span>
<a href="#l16.424"></a><span id="l16.424"> </span>
<a href="#l16.425"></a><span id="l16.425">           curHdr-&gt;GetDate(&amp;curHdrDate);</span>
<a href="#l16.426"></a><span id="l16.426" class="difflineminus">-          if (newHdrDate &lt; curHdrDate)</span>
<a href="#l16.427"></a><span id="l16.427" class="difflineminus">-            moveIndex = childIndex;</span>
<a href="#l16.428"></a><span id="l16.428" class="difflineplus">+          if (newHdrDate &lt; curHdrDate) moveIndex = childIndex;</span>
<a href="#l16.429"></a><span id="l16.429">         }</span>
<a href="#l16.430"></a><span id="l16.430">       }</span>
<a href="#l16.431"></a><span id="l16.431">     }</span>
<a href="#l16.432"></a><span id="l16.432">   }</span>
<a href="#l16.433"></a><span id="l16.433">   // If this header is not a reply to a header in the thread, and isn't a parent</span>
<a href="#l16.434"></a><span id="l16.434" class="difflineminus">-  // check to see if it starts with Re: - if not, and the first header does start</span>
<a href="#l16.435"></a><span id="l16.435" class="difflineminus">-  // with re, should we make this header the top level header?</span>
<a href="#l16.436"></a><span id="l16.436" class="difflineminus">-  // If it's date is less (or it's ID?), then yes.</span>
<a href="#l16.437"></a><span id="l16.437" class="difflineminus">-  if (numChildren &gt; 0 &amp;&amp; !(newHdrFlags &amp; nsMsgMessageFlags::HasRe) &amp;&amp; !inReplyTo)</span>
<a href="#l16.438"></a><span id="l16.438" class="difflineminus">-  {</span>
<a href="#l16.439"></a><span id="l16.439" class="difflineplus">+  // check to see if it starts with Re: - if not, and the first header does</span>
<a href="#l16.440"></a><span id="l16.440" class="difflineplus">+  // start with re, should we make this header the top level header? If it's</span>
<a href="#l16.441"></a><span id="l16.441" class="difflineplus">+  // date is less (or it's ID?), then yes.</span>
<a href="#l16.442"></a><span id="l16.442" class="difflineplus">+  if (numChildren &gt; 0 &amp;&amp; !(newHdrFlags &amp; nsMsgMessageFlags::HasRe) &amp;&amp;</span>
<a href="#l16.443"></a><span id="l16.443" class="difflineplus">+      !inReplyTo) {</span>
<a href="#l16.444"></a><span id="l16.444">     PRTime topLevelHdrDate;</span>
<a href="#l16.445"></a><span id="l16.445"> </span>
<a href="#l16.446"></a><span id="l16.446">     nsCOMPtr&lt;nsIMsgDBHdr&gt; topLevelHdr;</span>
<a href="#l16.447"></a><span id="l16.447">     rv = GetRootHdr(nullptr, getter_AddRefs(topLevelHdr));</span>
<a href="#l16.448"></a><span id="l16.448" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; topLevelHdr)</span>
<a href="#l16.449"></a><span id="l16.449" class="difflineminus">-    {</span>
<a href="#l16.450"></a><span id="l16.450" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; topLevelHdr) {</span>
<a href="#l16.451"></a><span id="l16.451">       topLevelHdr-&gt;GetDate(&amp;topLevelHdrDate);</span>
<a href="#l16.452"></a><span id="l16.452" class="difflineminus">-      if (newHdrDate &lt; topLevelHdrDate)</span>
<a href="#l16.453"></a><span id="l16.453" class="difflineminus">-      {</span>
<a href="#l16.454"></a><span id="l16.454" class="difflineplus">+      if (newHdrDate &lt; topLevelHdrDate) {</span>
<a href="#l16.455"></a><span id="l16.455">         RerootThread(child, topLevelHdr, announcer);</span>
<a href="#l16.456"></a><span id="l16.456">         mdb_pos outPos;</span>
<a href="#l16.457"></a><span id="l16.457">         m_mdbTable-&gt;MoveRow(m_mdbDB-&gt;GetEnv(), hdrRow, -1, 0, &amp;outPos);</span>
<a href="#l16.458"></a><span id="l16.458">         hdrMoved = true;</span>
<a href="#l16.459"></a><span id="l16.459">         topLevelHdr-&gt;SetThreadParent(newHdrKey);</span>
<a href="#l16.460"></a><span id="l16.460">         parentKeyNeedsSetting = false;</span>
<a href="#l16.461"></a><span id="l16.461">         // ### need to get ancestor of new hdr here too.</span>
<a href="#l16.462"></a><span id="l16.462">         SetThreadRootKey(newHdrKey);</span>
<a href="#l16.463"></a><span id="l16.463" class="difflineat">@@ -367,782 +344,712 @@ NS_IMETHODIMP nsMsgThread::AddChild(nsIM</span>
<a href="#l16.464"></a><span id="l16.464">     }</span>
<a href="#l16.465"></a><span id="l16.465">   }</span>
<a href="#l16.466"></a><span id="l16.466">   // OK, check to see if we added this header, and didn't parent it.</span>
<a href="#l16.467"></a><span id="l16.467"> </span>
<a href="#l16.468"></a><span id="l16.468">   if (numChildren &gt; 0 &amp;&amp; parentKeyNeedsSetting)</span>
<a href="#l16.469"></a><span id="l16.469">     child-&gt;SetThreadParent(m_threadRootKey);</span>
<a href="#l16.470"></a><span id="l16.470"> </span>
<a href="#l16.471"></a><span id="l16.471">   // Move child to keep thread sorted in ascending date order</span>
<a href="#l16.472"></a><span id="l16.472" class="difflineminus">-  if (!hdrMoved &amp;&amp; moveIndex &gt; 0)</span>
<a href="#l16.473"></a><span id="l16.473" class="difflineminus">-  {</span>
<a href="#l16.474"></a><span id="l16.474" class="difflineplus">+  if (!hdrMoved &amp;&amp; moveIndex &gt; 0) {</span>
<a href="#l16.475"></a><span id="l16.475">     mdb_pos outPos;</span>
<a href="#l16.476"></a><span id="l16.476">     m_mdbTable-&gt;MoveRow(m_mdbDB-&gt;GetEnv(), hdrRow, -1, moveIndex, &amp;outPos);</span>
<a href="#l16.477"></a><span id="l16.477">   }</span>
<a href="#l16.478"></a><span id="l16.478"> </span>
<a href="#l16.479"></a><span id="l16.479">   // do this after we've put the new hdr in the thread</span>
<a href="#l16.480"></a><span id="l16.480">   bool isKilled;</span>
<a href="#l16.481"></a><span id="l16.481">   child-&gt;GetIsKilled(&amp;isKilled);</span>
<a href="#l16.482"></a><span id="l16.482">   if ((m_flags &amp; nsMsgMessageFlags::Ignored || isKilled) &amp;&amp; m_mdbDB)</span>
<a href="#l16.483"></a><span id="l16.483">     m_mdbDB-&gt;MarkHdrRead(child, true, nullptr);</span>
<a href="#l16.484"></a><span id="l16.484"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l16.485"></a><span id="l16.485">   nsMsgKey msgHdrThreadKey;</span>
<a href="#l16.486"></a><span id="l16.486">   child-&gt;GetThreadId(&amp;msgHdrThreadKey);</span>
<a href="#l16.487"></a><span id="l16.487" class="difflineminus">-  NS_ASSERTION(msgHdrThreadKey == m_threadKey, &quot;adding msg to thread it doesn't belong to&quot;);</span>
<a href="#l16.488"></a><span id="l16.488" class="difflineplus">+  NS_ASSERTION(msgHdrThreadKey == m_threadKey,</span>
<a href="#l16.489"></a><span id="l16.489" class="difflineplus">+               &quot;adding msg to thread it doesn't belong to&quot;);</span>
<a href="#l16.490"></a><span id="l16.490"> #endif</span>
<a href="#l16.491"></a><span id="l16.491"> #ifdef DEBUG_bienvenu1</span>
<a href="#l16.492"></a><span id="l16.492" class="difflineminus">-  nsMsgDatabase *msgDB = static_cast&lt;nsMsgDatabase*&gt;(m_mdbDB);</span>
<a href="#l16.493"></a><span id="l16.493" class="difflineplus">+  nsMsgDatabase *msgDB = static_cast&lt;nsMsgDatabase *&gt;(m_mdbDB);</span>
<a href="#l16.494"></a><span id="l16.494">   msgDB-&gt;DumpThread(m_threadRootKey);</span>
<a href="#l16.495"></a><span id="l16.495"> #endif</span>
<a href="#l16.496"></a><span id="l16.496">   return rv;</span>
<a href="#l16.497"></a><span id="l16.497"> }</span>
<a href="#l16.498"></a><span id="l16.498"> </span>
<a href="#l16.499"></a><span id="l16.499" class="difflineminus">-nsresult nsMsgThread::ReparentNonReferenceChildrenOf(nsIMsgDBHdr *oldTopLevelHdr, nsMsgKey newParentKey,</span>
<a href="#l16.500"></a><span id="l16.500" class="difflineminus">-                                                            nsIDBChangeAnnouncer *announcer)</span>
<a href="#l16.501"></a><span id="l16.501" class="difflineminus">-{</span>
<a href="#l16.502"></a><span id="l16.502" class="difflineplus">+nsresult nsMsgThread::ReparentNonReferenceChildrenOf(</span>
<a href="#l16.503"></a><span id="l16.503" class="difflineplus">+    nsIMsgDBHdr *oldTopLevelHdr, nsMsgKey newParentKey,</span>
<a href="#l16.504"></a><span id="l16.504" class="difflineplus">+    nsIDBChangeAnnouncer *announcer) {</span>
<a href="#l16.505"></a><span id="l16.505">   nsCOMPtr&lt;nsIMsgDBHdr&gt; curHdr;</span>
<a href="#l16.506"></a><span id="l16.506">   uint32_t numChildren = 0;</span>
<a href="#l16.507"></a><span id="l16.507"> </span>
<a href="#l16.508"></a><span id="l16.508">   GetNumChildren(&amp;numChildren);</span>
<a href="#l16.509"></a><span id="l16.509" class="difflineminus">-  for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l16.510"></a><span id="l16.510" class="difflineminus">-  {</span>
<a href="#l16.511"></a><span id="l16.511" class="difflineplus">+  for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l16.512"></a><span id="l16.512">     nsMsgKey oldTopLevelHdrKey;</span>
<a href="#l16.513"></a><span id="l16.513"> </span>
<a href="#l16.514"></a><span id="l16.514">     oldTopLevelHdr-&gt;GetMessageKey(&amp;oldTopLevelHdrKey);</span>
<a href="#l16.515"></a><span id="l16.515">     nsresult rv = GetChildHdrAt(childIndex, getter_AddRefs(curHdr));</span>
<a href="#l16.516"></a><span id="l16.516" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; curHdr)</span>
<a href="#l16.517"></a><span id="l16.517" class="difflineminus">-    {</span>
<a href="#l16.518"></a><span id="l16.518" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; curHdr) {</span>
<a href="#l16.519"></a><span id="l16.519">       nsMsgKey oldThreadParent, curHdrKey;</span>
<a href="#l16.520"></a><span id="l16.520" class="difflineminus">-      nsMsgHdr* oldTopLevelMsgHdr = static_cast&lt;nsMsgHdr*&gt;(oldTopLevelHdr);      // closed system, cast ok</span>
<a href="#l16.521"></a><span id="l16.521" class="difflineplus">+      nsMsgHdr *oldTopLevelMsgHdr =</span>
<a href="#l16.522"></a><span id="l16.522" class="difflineplus">+          static_cast&lt;nsMsgHdr *&gt;(oldTopLevelHdr);  // closed system, cast ok</span>
<a href="#l16.523"></a><span id="l16.523">       curHdr-&gt;GetThreadParent(&amp;oldThreadParent);</span>
<a href="#l16.524"></a><span id="l16.524">       curHdr-&gt;GetMessageKey(&amp;curHdrKey);</span>
<a href="#l16.525"></a><span id="l16.525" class="difflineminus">-      if (oldThreadParent == oldTopLevelHdrKey &amp;&amp; curHdrKey != newParentKey &amp;&amp; !oldTopLevelMsgHdr-&gt;IsParentOf(curHdr))</span>
<a href="#l16.526"></a><span id="l16.526" class="difflineminus">-      {</span>
<a href="#l16.527"></a><span id="l16.527" class="difflineplus">+      if (oldThreadParent == oldTopLevelHdrKey &amp;&amp; curHdrKey != newParentKey &amp;&amp;</span>
<a href="#l16.528"></a><span id="l16.528" class="difflineplus">+          !oldTopLevelMsgHdr-&gt;IsParentOf(curHdr)) {</span>
<a href="#l16.529"></a><span id="l16.529">         curHdr-&gt;GetThreadParent(&amp;oldThreadParent);</span>
<a href="#l16.530"></a><span id="l16.530">         curHdr-&gt;SetThreadParent(newParentKey);</span>
<a href="#l16.531"></a><span id="l16.531">         // OK, this is a reparenting - need to send notification</span>
<a href="#l16.532"></a><span id="l16.532">         if (announcer)</span>
<a href="#l16.533"></a><span id="l16.533" class="difflineminus">-          announcer-&gt;NotifyParentChangedAll(curHdrKey, oldThreadParent, newParentKey, nullptr);</span>
<a href="#l16.534"></a><span id="l16.534" class="difflineplus">+          announcer-&gt;NotifyParentChangedAll(curHdrKey, oldThreadParent,</span>
<a href="#l16.535"></a><span id="l16.535" class="difflineplus">+                                            newParentKey, nullptr);</span>
<a href="#l16.536"></a><span id="l16.536">       }</span>
<a href="#l16.537"></a><span id="l16.537">     }</span>
<a href="#l16.538"></a><span id="l16.538">   }</span>
<a href="#l16.539"></a><span id="l16.539">   return NS_OK;</span>
<a href="#l16.540"></a><span id="l16.540"> }</span>
<a href="#l16.541"></a><span id="l16.541"> </span>
<a href="#l16.542"></a><span id="l16.542" class="difflineminus">-NS_IMETHODIMP nsMsgThread::GetChildKeyAt(uint32_t aIndex, nsMsgKey *aResult)</span>
<a href="#l16.543"></a><span id="l16.543" class="difflineminus">-{</span>
<a href="#l16.544"></a><span id="l16.544" class="difflineplus">+NS_IMETHODIMP nsMsgThread::GetChildKeyAt(uint32_t aIndex, nsMsgKey *aResult) {</span>
<a href="#l16.545"></a><span id="l16.545">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l16.546"></a><span id="l16.546">   nsresult rv;</span>
<a href="#l16.547"></a><span id="l16.547"> </span>
<a href="#l16.548"></a><span id="l16.548" class="difflineminus">-  if (aIndex &gt;= m_numChildren)</span>
<a href="#l16.549"></a><span id="l16.549" class="difflineminus">-  {</span>
<a href="#l16.550"></a><span id="l16.550" class="difflineplus">+  if (aIndex &gt;= m_numChildren) {</span>
<a href="#l16.551"></a><span id="l16.551">     *aResult = nsMsgKey_None;</span>
<a href="#l16.552"></a><span id="l16.552">     return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l16.553"></a><span id="l16.553">   }</span>
<a href="#l16.554"></a><span id="l16.554">   mdbOid oid;</span>
<a href="#l16.555"></a><span id="l16.555" class="difflineminus">-  rv = m_mdbTable-&gt;PosToOid( m_mdbDB-&gt;GetEnv(), aIndex, &amp;oid);</span>
<a href="#l16.556"></a><span id="l16.556" class="difflineplus">+  rv = m_mdbTable-&gt;PosToOid(m_mdbDB-&gt;GetEnv(), aIndex, &amp;oid);</span>
<a href="#l16.557"></a><span id="l16.557">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.558"></a><span id="l16.558"> </span>
<a href="#l16.559"></a><span id="l16.559">   *aResult = oid.mOid_Id;</span>
<a href="#l16.560"></a><span id="l16.560">   return NS_OK;</span>
<a href="#l16.561"></a><span id="l16.561"> }</span>
<a href="#l16.562"></a><span id="l16.562"> </span>
<a href="#l16.563"></a><span id="l16.563" class="difflineminus">-NS_IMETHODIMP nsMsgThread::GetChildHdrAt(uint32_t aIndex, nsIMsgDBHdr **result)</span>
<a href="#l16.564"></a><span id="l16.564" class="difflineminus">-{</span>
<a href="#l16.565"></a><span id="l16.565" class="difflineplus">+NS_IMETHODIMP nsMsgThread::GetChildHdrAt(uint32_t aIndex,</span>
<a href="#l16.566"></a><span id="l16.566" class="difflineplus">+                                         nsIMsgDBHdr **result) {</span>
<a href="#l16.567"></a><span id="l16.567">   // mork doesn't seem to handle this correctly, so deal with going off</span>
<a href="#l16.568"></a><span id="l16.568">   // the end here.</span>
<a href="#l16.569"></a><span id="l16.569" class="difflineminus">-  if (aIndex &gt;= m_numChildren)</span>
<a href="#l16.570"></a><span id="l16.570" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l16.571"></a><span id="l16.571" class="difflineplus">+  if (aIndex &gt;= m_numChildren) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l16.572"></a><span id="l16.572">   mdbOid oid;</span>
<a href="#l16.573"></a><span id="l16.573" class="difflineminus">-  nsresult rv = m_mdbTable-&gt;PosToOid( m_mdbDB-&gt;GetEnv(), aIndex, &amp;oid);</span>
<a href="#l16.574"></a><span id="l16.574" class="difflineplus">+  nsresult rv = m_mdbTable-&gt;PosToOid(m_mdbDB-&gt;GetEnv(), aIndex, &amp;oid);</span>
<a href="#l16.575"></a><span id="l16.575">   NS_ENSURE_SUCCESS(rv, NS_MSG_MESSAGE_NOT_FOUND);</span>
<a href="#l16.576"></a><span id="l16.576">   nsIMdbRow *hdrRow = nullptr;</span>
<a href="#l16.577"></a><span id="l16.577">   rv = m_mdbTable-&gt;PosToRow(m_mdbDB-&gt;GetEnv(), aIndex, &amp;hdrRow);</span>
<a href="#l16.578"></a><span id="l16.578">   NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; hdrRow, NS_ERROR_FAILURE);</span>
<a href="#l16.579"></a><span id="l16.579">   // CreateMsgHdr takes ownership of the hdrRow reference.</span>
<a href="#l16.580"></a><span id="l16.580" class="difflineminus">-  rv = m_mdbDB-&gt;CreateMsgHdr(hdrRow,  oid.mOid_Id , result);</span>
<a href="#l16.581"></a><span id="l16.581" class="difflineplus">+  rv = m_mdbDB-&gt;CreateMsgHdr(hdrRow, oid.mOid_Id, result);</span>
<a href="#l16.582"></a><span id="l16.582">   return (NS_SUCCEEDED(rv)) ? NS_OK : NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l16.583"></a><span id="l16.583"> }</span>
<a href="#l16.584"></a><span id="l16.584"> </span>
<a href="#l16.585"></a><span id="l16.585" class="difflineminus">-NS_IMETHODIMP nsMsgThread::GetChild(nsMsgKey msgKey, nsIMsgDBHdr **result)</span>
<a href="#l16.586"></a><span id="l16.586" class="difflineminus">-{</span>
<a href="#l16.587"></a><span id="l16.587" class="difflineplus">+NS_IMETHODIMP nsMsgThread::GetChild(nsMsgKey msgKey, nsIMsgDBHdr **result) {</span>
<a href="#l16.588"></a><span id="l16.588">   nsresult rv;</span>
<a href="#l16.589"></a><span id="l16.589"> </span>
<a href="#l16.590"></a><span id="l16.590">   mdb_bool hasOid;</span>
<a href="#l16.591"></a><span id="l16.591">   mdbOid rowObjectId;</span>
<a href="#l16.592"></a><span id="l16.592"> </span>
<a href="#l16.593"></a><span id="l16.593">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l16.594"></a><span id="l16.594">   NS_ENSURE_TRUE(m_mdbTable, NS_ERROR_INVALID_POINTER);</span>
<a href="#l16.595"></a><span id="l16.595"> </span>
<a href="#l16.596"></a><span id="l16.596">   *result = NULL;</span>
<a href="#l16.597"></a><span id="l16.597">   rowObjectId.mOid_Id = msgKey;</span>
<a href="#l16.598"></a><span id="l16.598">   rowObjectId.mOid_Scope = m_mdbDB-&gt;m_hdrRowScopeToken;</span>
<a href="#l16.599"></a><span id="l16.599">   rv = m_mdbTable-&gt;HasOid(m_mdbDB-&gt;GetEnv(), &amp;rowObjectId, &amp;hasOid);</span>
<a href="#l16.600"></a><span id="l16.600"> </span>
<a href="#l16.601"></a><span id="l16.601" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; hasOid &amp;&amp; m_mdbDB &amp;&amp; m_mdbDB-&gt;m_mdbStore)</span>
<a href="#l16.602"></a><span id="l16.602" class="difflineminus">-  {</span>
<a href="#l16.603"></a><span id="l16.603" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; hasOid &amp;&amp; m_mdbDB &amp;&amp; m_mdbDB-&gt;m_mdbStore) {</span>
<a href="#l16.604"></a><span id="l16.604">     nsIMdbRow *hdrRow = nullptr;</span>
<a href="#l16.605"></a><span id="l16.605" class="difflineminus">-    rv = m_mdbDB-&gt;m_mdbStore-&gt;GetRow(m_mdbDB-&gt;GetEnv(), &amp;rowObjectId,  &amp;hdrRow);</span>
<a href="#l16.606"></a><span id="l16.606" class="difflineplus">+    rv = m_mdbDB-&gt;m_mdbStore-&gt;GetRow(m_mdbDB-&gt;GetEnv(), &amp;rowObjectId, &amp;hdrRow);</span>
<a href="#l16.607"></a><span id="l16.607">     NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; hdrRow, NS_ERROR_FAILURE);</span>
<a href="#l16.608"></a><span id="l16.608" class="difflineminus">-    rv = m_mdbDB-&gt;CreateMsgHdr(hdrRow,  msgKey, result);</span>
<a href="#l16.609"></a><span id="l16.609" class="difflineplus">+    rv = m_mdbDB-&gt;CreateMsgHdr(hdrRow, msgKey, result);</span>
<a href="#l16.610"></a><span id="l16.610">   }</span>
<a href="#l16.611"></a><span id="l16.611"> </span>
<a href="#l16.612"></a><span id="l16.612">   return rv;</span>
<a href="#l16.613"></a><span id="l16.613"> }</span>
<a href="#l16.614"></a><span id="l16.614"> </span>
<a href="#l16.615"></a><span id="l16.615" class="difflineminus">-NS_IMETHODIMP nsMsgThread::RemoveChildAt(uint32_t aIndex)</span>
<a href="#l16.616"></a><span id="l16.616" class="difflineminus">-{</span>
<a href="#l16.617"></a><span id="l16.617" class="difflineminus">-  return NS_OK;</span>
<a href="#l16.618"></a><span id="l16.618" class="difflineminus">-}</span>
<a href="#l16.619"></a><span id="l16.619" class="difflineplus">+NS_IMETHODIMP nsMsgThread::RemoveChildAt(uint32_t aIndex) { return NS_OK; }</span>
<a href="#l16.620"></a><span id="l16.620"> </span>
<a href="#l16.621"></a><span id="l16.621" class="difflineminus">-nsresult nsMsgThread::RemoveChild(nsMsgKey msgKey)</span>
<a href="#l16.622"></a><span id="l16.622" class="difflineminus">-{</span>
<a href="#l16.623"></a><span id="l16.623" class="difflineplus">+nsresult nsMsgThread::RemoveChild(nsMsgKey msgKey) {</span>
<a href="#l16.624"></a><span id="l16.624">   nsresult rv;</span>
<a href="#l16.625"></a><span id="l16.625"> </span>
<a href="#l16.626"></a><span id="l16.626" class="difflineminus">-  mdbOid  rowObjectId;</span>
<a href="#l16.627"></a><span id="l16.627" class="difflineplus">+  mdbOid rowObjectId;</span>
<a href="#l16.628"></a><span id="l16.628">   rowObjectId.mOid_Id = msgKey;</span>
<a href="#l16.629"></a><span id="l16.629">   rowObjectId.mOid_Scope = m_mdbDB-&gt;m_hdrRowScopeToken;</span>
<a href="#l16.630"></a><span id="l16.630">   rv = m_mdbTable-&gt;CutOid(m_mdbDB-&gt;GetEnv(), &amp;rowObjectId);</span>
<a href="#l16.631"></a><span id="l16.631">   // if this thread is empty, remove it from the all threads table.</span>
<a href="#l16.632"></a><span id="l16.632" class="difflineminus">-  if (m_numChildren == 0 &amp;&amp; m_mdbDB-&gt;m_mdbAllThreadsTable)</span>
<a href="#l16.633"></a><span id="l16.633" class="difflineminus">-  {</span>
<a href="#l16.634"></a><span id="l16.634" class="difflineplus">+  if (m_numChildren == 0 &amp;&amp; m_mdbDB-&gt;m_mdbAllThreadsTable) {</span>
<a href="#l16.635"></a><span id="l16.635">     mdbOid rowID;</span>
<a href="#l16.636"></a><span id="l16.636">     rowID.mOid_Id = m_threadKey;</span>
<a href="#l16.637"></a><span id="l16.637">     rowID.mOid_Scope = m_mdbDB-&gt;m_threadRowScopeToken;</span>
<a href="#l16.638"></a><span id="l16.638"> </span>
<a href="#l16.639"></a><span id="l16.639">     m_mdbDB-&gt;m_mdbAllThreadsTable-&gt;CutOid(m_mdbDB-&gt;GetEnv(), &amp;rowID);</span>
<a href="#l16.640"></a><span id="l16.640">   }</span>
<a href="#l16.641"></a><span id="l16.641" class="difflineminus">-#if 0 // this seems to cause problems</span>
<a href="#l16.642"></a><span id="l16.642" class="difflineplus">+#if 0  // this seems to cause problems</span>
<a href="#l16.643"></a><span id="l16.643">   if (m_numChildren == 0 &amp;&amp; m_metaRow &amp;&amp; m_mdbDB)</span>
<a href="#l16.644"></a><span id="l16.644">     m_metaRow-&gt;CutAllColumns(m_mdbDB-&gt;GetEnv());</span>
<a href="#l16.645"></a><span id="l16.645"> #endif</span>
<a href="#l16.646"></a><span id="l16.646"> </span>
<a href="#l16.647"></a><span id="l16.647">   return rv;</span>
<a href="#l16.648"></a><span id="l16.648"> }</span>
<a href="#l16.649"></a><span id="l16.649"> </span>
<a href="#l16.650"></a><span id="l16.650" class="difflineminus">-NS_IMETHODIMP nsMsgThread::RemoveChildHdr(nsIMsgDBHdr *child, nsIDBChangeAnnouncer *announcer)</span>
<a href="#l16.651"></a><span id="l16.651" class="difflineminus">-{</span>
<a href="#l16.652"></a><span id="l16.652" class="difflineplus">+NS_IMETHODIMP nsMsgThread::RemoveChildHdr(nsIMsgDBHdr *child,</span>
<a href="#l16.653"></a><span id="l16.653" class="difflineplus">+                                          nsIDBChangeAnnouncer *announcer) {</span>
<a href="#l16.654"></a><span id="l16.654">   uint32_t flags;</span>
<a href="#l16.655"></a><span id="l16.655">   nsMsgKey key;</span>
<a href="#l16.656"></a><span id="l16.656">   nsMsgKey threadParent;</span>
<a href="#l16.657"></a><span id="l16.657"> </span>
<a href="#l16.658"></a><span id="l16.658">   NS_ENSURE_ARG_POINTER(child);</span>
<a href="#l16.659"></a><span id="l16.659"> </span>
<a href="#l16.660"></a><span id="l16.660">   child-&gt;GetFlags(&amp;flags);</span>
<a href="#l16.661"></a><span id="l16.661">   child-&gt;GetMessageKey(&amp;key);</span>
<a href="#l16.662"></a><span id="l16.662"> </span>
<a href="#l16.663"></a><span id="l16.663">   child-&gt;GetThreadParent(&amp;threadParent);</span>
<a href="#l16.664"></a><span id="l16.664">   ReparentChildrenOf(key, threadParent, announcer);</span>
<a href="#l16.665"></a><span id="l16.665"> </span>
<a href="#l16.666"></a><span id="l16.666">   // if this was the newest msg, clear the newest msg date so we'll recalc.</span>
<a href="#l16.667"></a><span id="l16.667">   uint32_t date;</span>
<a href="#l16.668"></a><span id="l16.668">   child-&gt;GetDateInSeconds(&amp;date);</span>
<a href="#l16.669"></a><span id="l16.669" class="difflineminus">-  if (date == m_newestMsgDate)</span>
<a href="#l16.670"></a><span id="l16.670" class="difflineminus">-    SetNewestMsgDate(0);</span>
<a href="#l16.671"></a><span id="l16.671" class="difflineplus">+  if (date == m_newestMsgDate) SetNewestMsgDate(0);</span>
<a href="#l16.672"></a><span id="l16.672"> </span>
<a href="#l16.673"></a><span id="l16.673" class="difflineminus">- if (!(flags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l16.674"></a><span id="l16.674" class="difflineminus">-    ChangeUnreadChildCount(-1);</span>
<a href="#l16.675"></a><span id="l16.675" class="difflineplus">+  if (!(flags &amp; nsMsgMessageFlags::Read)) ChangeUnreadChildCount(-1);</span>
<a href="#l16.676"></a><span id="l16.676">   ChangeChildCount(-1);</span>
<a href="#l16.677"></a><span id="l16.677">   return RemoveChild(key);</span>
<a href="#l16.678"></a><span id="l16.678"> }</span>
<a href="#l16.679"></a><span id="l16.679"> </span>
<a href="#l16.680"></a><span id="l16.680" class="difflineminus">-nsresult nsMsgThread::ReparentChildrenOf(nsMsgKey oldParent, nsMsgKey newParent, nsIDBChangeAnnouncer *announcer)</span>
<a href="#l16.681"></a><span id="l16.681" class="difflineminus">-{</span>
<a href="#l16.682"></a><span id="l16.682" class="difflineplus">+nsresult nsMsgThread::ReparentChildrenOf(nsMsgKey oldParent, nsMsgKey newParent,</span>
<a href="#l16.683"></a><span id="l16.683" class="difflineplus">+                                         nsIDBChangeAnnouncer *announcer) {</span>
<a href="#l16.684"></a><span id="l16.684">   nsresult rv = NS_OK;</span>
<a href="#l16.685"></a><span id="l16.685"> </span>
<a href="#l16.686"></a><span id="l16.686">   uint32_t numChildren = 0;</span>
<a href="#l16.687"></a><span id="l16.687">   GetNumChildren(&amp;numChildren);</span>
<a href="#l16.688"></a><span id="l16.688"> </span>
<a href="#l16.689"></a><span id="l16.689">   nsCOMPtr&lt;nsIMsgDBHdr&gt; curHdr;</span>
<a href="#l16.690"></a><span id="l16.690" class="difflineminus">-  if (numChildren &gt; 0)</span>
<a href="#l16.691"></a><span id="l16.691" class="difflineminus">-  {</span>
<a href="#l16.692"></a><span id="l16.692" class="difflineminus">-    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l16.693"></a><span id="l16.693" class="difflineminus">-    {</span>
<a href="#l16.694"></a><span id="l16.694" class="difflineplus">+  if (numChildren &gt; 0) {</span>
<a href="#l16.695"></a><span id="l16.695" class="difflineplus">+    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l16.696"></a><span id="l16.696">       rv = GetChildHdrAt(childIndex, getter_AddRefs(curHdr));</span>
<a href="#l16.697"></a><span id="l16.697" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; curHdr)</span>
<a href="#l16.698"></a><span id="l16.698" class="difflineminus">-      {</span>
<a href="#l16.699"></a><span id="l16.699" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; curHdr) {</span>
<a href="#l16.700"></a><span id="l16.700">         nsMsgKey threadParent;</span>
<a href="#l16.701"></a><span id="l16.701"> </span>
<a href="#l16.702"></a><span id="l16.702">         curHdr-&gt;GetThreadParent(&amp;threadParent);</span>
<a href="#l16.703"></a><span id="l16.703" class="difflineminus">-        if (threadParent == oldParent)</span>
<a href="#l16.704"></a><span id="l16.704" class="difflineminus">-        {</span>
<a href="#l16.705"></a><span id="l16.705" class="difflineplus">+        if (threadParent == oldParent) {</span>
<a href="#l16.706"></a><span id="l16.706">           nsMsgKey curKey;</span>
<a href="#l16.707"></a><span id="l16.707"> </span>
<a href="#l16.708"></a><span id="l16.708">           curHdr-&gt;SetThreadParent(newParent);</span>
<a href="#l16.709"></a><span id="l16.709">           curHdr-&gt;GetMessageKey(&amp;curKey);</span>
<a href="#l16.710"></a><span id="l16.710">           if (announcer)</span>
<a href="#l16.711"></a><span id="l16.711" class="difflineminus">-            announcer-&gt;NotifyParentChangedAll(curKey, oldParent, newParent, nullptr);</span>
<a href="#l16.712"></a><span id="l16.712" class="difflineminus">-          // if the old parent was the root of the thread, then only the first child gets</span>
<a href="#l16.713"></a><span id="l16.713" class="difflineminus">-          // promoted to root, and other children become children of the new root.</span>
<a href="#l16.714"></a><span id="l16.714" class="difflineminus">-          if (newParent == nsMsgKey_None)</span>
<a href="#l16.715"></a><span id="l16.715" class="difflineminus">-          {</span>
<a href="#l16.716"></a><span id="l16.716" class="difflineplus">+            announcer-&gt;NotifyParentChangedAll(curKey, oldParent, newParent,</span>
<a href="#l16.717"></a><span id="l16.717" class="difflineplus">+                                              nullptr);</span>
<a href="#l16.718"></a><span id="l16.718" class="difflineplus">+          // if the old parent was the root of the thread, then only the first</span>
<a href="#l16.719"></a><span id="l16.719" class="difflineplus">+          // child gets promoted to root, and other children become children of</span>
<a href="#l16.720"></a><span id="l16.720" class="difflineplus">+          // the new root.</span>
<a href="#l16.721"></a><span id="l16.721" class="difflineplus">+          if (newParent == nsMsgKey_None) {</span>
<a href="#l16.722"></a><span id="l16.722">             SetThreadRootKey(curKey);</span>
<a href="#l16.723"></a><span id="l16.723">             newParent = curKey;</span>
<a href="#l16.724"></a><span id="l16.724">           }</span>
<a href="#l16.725"></a><span id="l16.725">         }</span>
<a href="#l16.726"></a><span id="l16.726">       }</span>
<a href="#l16.727"></a><span id="l16.727">     }</span>
<a href="#l16.728"></a><span id="l16.728">   }</span>
<a href="#l16.729"></a><span id="l16.729">   return rv;</span>
<a href="#l16.730"></a><span id="l16.730"> }</span>
<a href="#l16.731"></a><span id="l16.731"> </span>
<a href="#l16.732"></a><span id="l16.732" class="difflineminus">-NS_IMETHODIMP nsMsgThread::MarkChildRead(bool bRead)</span>
<a href="#l16.733"></a><span id="l16.733" class="difflineminus">-{</span>
<a href="#l16.734"></a><span id="l16.734" class="difflineplus">+NS_IMETHODIMP nsMsgThread::MarkChildRead(bool bRead) {</span>
<a href="#l16.735"></a><span id="l16.735">   ChangeUnreadChildCount(bRead ? -1 : 1);</span>
<a href="#l16.736"></a><span id="l16.736">   return NS_OK;</span>
<a href="#l16.737"></a><span id="l16.737"> }</span>
<a href="#l16.738"></a><span id="l16.738"> </span>
<a href="#l16.739"></a><span id="l16.739"> class nsMsgThreadEnumerator : public nsSimpleEnumerator {</span>
<a href="#l16.740"></a><span id="l16.740" class="difflineminus">-public:</span>
<a href="#l16.741"></a><span id="l16.741" class="difflineminus">-  const nsID&amp; DefaultInterface() override</span>
<a href="#l16.742"></a><span id="l16.742" class="difflineminus">-  {</span>
<a href="#l16.743"></a><span id="l16.743" class="difflineminus">-    return NS_GET_IID(nsIMsgDBHdr);</span>
<a href="#l16.744"></a><span id="l16.744" class="difflineminus">-  }</span>
<a href="#l16.745"></a><span id="l16.745" class="difflineplus">+ public:</span>
<a href="#l16.746"></a><span id="l16.746" class="difflineplus">+  const nsID &amp;DefaultInterface() override { return NS_GET_IID(nsIMsgDBHdr); }</span>
<a href="#l16.747"></a><span id="l16.747"> </span>
<a href="#l16.748"></a><span id="l16.748">   // nsISimpleEnumerator methods:</span>
<a href="#l16.749"></a><span id="l16.749">   NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l16.750"></a><span id="l16.750"> </span>
<a href="#l16.751"></a><span id="l16.751">   // nsMsgThreadEnumerator methods:</span>
<a href="#l16.752"></a><span id="l16.752" class="difflineminus">-  typedef nsresult (*nsMsgThreadEnumeratorFilter)(nsIMsgDBHdr* hdr, void* closure);</span>
<a href="#l16.753"></a><span id="l16.753" class="difflineplus">+  typedef nsresult (*nsMsgThreadEnumeratorFilter)(nsIMsgDBHdr *hdr,</span>
<a href="#l16.754"></a><span id="l16.754" class="difflineplus">+                                                  void *closure);</span>
<a href="#l16.755"></a><span id="l16.755"> </span>
<a href="#l16.756"></a><span id="l16.756">   nsMsgThreadEnumerator(nsMsgThread *thread, nsMsgKey startKey,</span>
<a href="#l16.757"></a><span id="l16.757" class="difflineminus">-  nsMsgThreadEnumeratorFilter filter, void* closure);</span>
<a href="#l16.758"></a><span id="l16.758" class="difflineplus">+                        nsMsgThreadEnumeratorFilter filter, void *closure);</span>
<a href="#l16.759"></a><span id="l16.759">   int32_t MsgKeyFirstChildIndex(nsMsgKey inMsgKey);</span>
<a href="#l16.760"></a><span id="l16.760"> </span>
<a href="#l16.761"></a><span id="l16.761" class="difflineminus">-protected:</span>
<a href="#l16.762"></a><span id="l16.762" class="difflineplus">+ protected:</span>
<a href="#l16.763"></a><span id="l16.763">   ~nsMsgThreadEnumerator() override = default;</span>
<a href="#l16.764"></a><span id="l16.764" class="difflineminus">-  nsresult                Prefetch();</span>
<a href="#l16.765"></a><span id="l16.765" class="difflineplus">+  nsresult Prefetch();</span>
<a href="#l16.766"></a><span id="l16.766"> </span>
<a href="#l16.767"></a><span id="l16.767" class="difflineminus">-  nsIMdbTableRowCursor*   mRowCursor;</span>
<a href="#l16.768"></a><span id="l16.768" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBHdr&gt;   mResultHdr;</span>
<a href="#l16.769"></a><span id="l16.769" class="difflineminus">-  RefPtr&lt;nsMsgThread&gt;     mThread;</span>
<a href="#l16.770"></a><span id="l16.770" class="difflineminus">-  nsMsgKey                mThreadParentKey;</span>
<a href="#l16.771"></a><span id="l16.771" class="difflineminus">-  nsMsgKey                mFirstMsgKey;</span>
<a href="#l16.772"></a><span id="l16.772" class="difflineminus">-  int32_t                 mChildIndex;</span>
<a href="#l16.773"></a><span id="l16.773" class="difflineminus">-  bool                    mDone;</span>
<a href="#l16.774"></a><span id="l16.774" class="difflineminus">-  bool                    mNeedToPrefetch;</span>
<a href="#l16.775"></a><span id="l16.775" class="difflineminus">-  nsMsgThreadEnumeratorFilter     mFilter;</span>
<a href="#l16.776"></a><span id="l16.776" class="difflineminus">-  void*                   mClosure;</span>
<a href="#l16.777"></a><span id="l16.777" class="difflineminus">-  bool                    mFoundChildren;</span>
<a href="#l16.778"></a><span id="l16.778" class="difflineplus">+  nsIMdbTableRowCursor *mRowCursor;</span>
<a href="#l16.779"></a><span id="l16.779" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; mResultHdr;</span>
<a href="#l16.780"></a><span id="l16.780" class="difflineplus">+  RefPtr&lt;nsMsgThread&gt; mThread;</span>
<a href="#l16.781"></a><span id="l16.781" class="difflineplus">+  nsMsgKey mThreadParentKey;</span>
<a href="#l16.782"></a><span id="l16.782" class="difflineplus">+  nsMsgKey mFirstMsgKey;</span>
<a href="#l16.783"></a><span id="l16.783" class="difflineplus">+  int32_t mChildIndex;</span>
<a href="#l16.784"></a><span id="l16.784" class="difflineplus">+  bool mDone;</span>
<a href="#l16.785"></a><span id="l16.785" class="difflineplus">+  bool mNeedToPrefetch;</span>
<a href="#l16.786"></a><span id="l16.786" class="difflineplus">+  nsMsgThreadEnumeratorFilter mFilter;</span>
<a href="#l16.787"></a><span id="l16.787" class="difflineplus">+  void *mClosure;</span>
<a href="#l16.788"></a><span id="l16.788" class="difflineplus">+  bool mFoundChildren;</span>
<a href="#l16.789"></a><span id="l16.789"> };</span>
<a href="#l16.790"></a><span id="l16.790"> </span>
<a href="#l16.791"></a><span id="l16.791" class="difflineminus">-nsMsgThreadEnumerator::nsMsgThreadEnumerator(nsMsgThread *thread, nsMsgKey startKey,</span>
<a href="#l16.792"></a><span id="l16.792" class="difflineminus">-                                             nsMsgThreadEnumeratorFilter filter, void* closure)</span>
<a href="#l16.793"></a><span id="l16.793" class="difflineminus">-                                             : mRowCursor(nullptr), mDone(false),</span>
<a href="#l16.794"></a><span id="l16.794" class="difflineminus">-                                             mFilter(filter), mClosure(closure), mFoundChildren(false)</span>
<a href="#l16.795"></a><span id="l16.795" class="difflineminus">-{</span>
<a href="#l16.796"></a><span id="l16.796" class="difflineplus">+nsMsgThreadEnumerator::nsMsgThreadEnumerator(nsMsgThread *thread,</span>
<a href="#l16.797"></a><span id="l16.797" class="difflineplus">+                                             nsMsgKey startKey,</span>
<a href="#l16.798"></a><span id="l16.798" class="difflineplus">+                                             nsMsgThreadEnumeratorFilter filter,</span>
<a href="#l16.799"></a><span id="l16.799" class="difflineplus">+                                             void *closure)</span>
<a href="#l16.800"></a><span id="l16.800" class="difflineplus">+    : mRowCursor(nullptr),</span>
<a href="#l16.801"></a><span id="l16.801" class="difflineplus">+      mDone(false),</span>
<a href="#l16.802"></a><span id="l16.802" class="difflineplus">+      mFilter(filter),</span>
<a href="#l16.803"></a><span id="l16.803" class="difflineplus">+      mClosure(closure),</span>
<a href="#l16.804"></a><span id="l16.804" class="difflineplus">+      mFoundChildren(false) {</span>
<a href="#l16.805"></a><span id="l16.805">   mThreadParentKey = startKey;</span>
<a href="#l16.806"></a><span id="l16.806">   mChildIndex = 0;</span>
<a href="#l16.807"></a><span id="l16.807">   mThread = thread;</span>
<a href="#l16.808"></a><span id="l16.808">   mNeedToPrefetch = true;</span>
<a href="#l16.809"></a><span id="l16.809">   mFirstMsgKey = nsMsgKey_None;</span>
<a href="#l16.810"></a><span id="l16.810"> </span>
<a href="#l16.811"></a><span id="l16.811">   nsresult rv = mThread-&gt;GetRootHdr(nullptr, getter_AddRefs(mResultHdr));</span>
<a href="#l16.812"></a><span id="l16.812"> </span>
<a href="#l16.813"></a><span id="l16.813" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr)</span>
<a href="#l16.814"></a><span id="l16.814" class="difflineminus">-    mResultHdr-&gt;GetMessageKey(&amp;mFirstMsgKey);</span>
<a href="#l16.815"></a><span id="l16.815" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr) mResultHdr-&gt;GetMessageKey(&amp;mFirstMsgKey);</span>
<a href="#l16.816"></a><span id="l16.816"> </span>
<a href="#l16.817"></a><span id="l16.817">   uint32_t numChildren = 0;</span>
<a href="#l16.818"></a><span id="l16.818">   mThread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l16.819"></a><span id="l16.819"> </span>
<a href="#l16.820"></a><span id="l16.820" class="difflineminus">-  if (mThreadParentKey != nsMsgKey_None)</span>
<a href="#l16.821"></a><span id="l16.821" class="difflineminus">-  {</span>
<a href="#l16.822"></a><span id="l16.822" class="difflineplus">+  if (mThreadParentKey != nsMsgKey_None) {</span>
<a href="#l16.823"></a><span id="l16.823">     nsMsgKey msgKey = nsMsgKey_None;</span>
<a href="#l16.824"></a><span id="l16.824" class="difflineminus">-    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l16.825"></a><span id="l16.825" class="difflineminus">-    {</span>
<a href="#l16.826"></a><span id="l16.826" class="difflineplus">+    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l16.827"></a><span id="l16.827">       rv = mThread-&gt;GetChildHdrAt(childIndex, getter_AddRefs(mResultHdr));</span>
<a href="#l16.828"></a><span id="l16.828" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr)</span>
<a href="#l16.829"></a><span id="l16.829" class="difflineminus">-      {</span>
<a href="#l16.830"></a><span id="l16.830" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr) {</span>
<a href="#l16.831"></a><span id="l16.831">         mResultHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l16.832"></a><span id="l16.832"> </span>
<a href="#l16.833"></a><span id="l16.833" class="difflineminus">-        if (msgKey == startKey)</span>
<a href="#l16.834"></a><span id="l16.834" class="difflineminus">-        {</span>
<a href="#l16.835"></a><span id="l16.835" class="difflineplus">+        if (msgKey == startKey) {</span>
<a href="#l16.836"></a><span id="l16.836">           mChildIndex = MsgKeyFirstChildIndex(msgKey);</span>
<a href="#l16.837"></a><span id="l16.837">           mDone = (mChildIndex &lt; 0);</span>
<a href="#l16.838"></a><span id="l16.838">           break;</span>
<a href="#l16.839"></a><span id="l16.839">         }</span>
<a href="#l16.840"></a><span id="l16.840"> </span>
<a href="#l16.841"></a><span id="l16.841" class="difflineminus">-        if (mDone)</span>
<a href="#l16.842"></a><span id="l16.842" class="difflineminus">-          break;</span>
<a href="#l16.843"></a><span id="l16.843" class="difflineminus">-      }</span>
<a href="#l16.844"></a><span id="l16.844" class="difflineminus">-      else</span>
<a href="#l16.845"></a><span id="l16.845" class="difflineplus">+        if (mDone) break;</span>
<a href="#l16.846"></a><span id="l16.846" class="difflineplus">+      } else</span>
<a href="#l16.847"></a><span id="l16.847">         NS_ASSERTION(false, &quot;couldn't get child from thread&quot;);</span>
<a href="#l16.848"></a><span id="l16.848">     }</span>
<a href="#l16.849"></a><span id="l16.849">   }</span>
<a href="#l16.850"></a><span id="l16.850"> </span>
<a href="#l16.851"></a><span id="l16.851"> #ifdef DEBUG_bienvenu1</span>
<a href="#l16.852"></a><span id="l16.852">   nsCOMPtr&lt;nsIMsgDBHdr&gt; child;</span>
<a href="#l16.853"></a><span id="l16.853" class="difflineminus">-  for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l16.854"></a><span id="l16.854" class="difflineminus">-  {</span>
<a href="#l16.855"></a><span id="l16.855" class="difflineplus">+  for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l16.856"></a><span id="l16.856">     rv = mThread-&gt;GetChildHdrAt(childIndex, getter_AddRefs(child));</span>
<a href="#l16.857"></a><span id="l16.857" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; child)</span>
<a href="#l16.858"></a><span id="l16.858" class="difflineminus">-    {</span>
<a href="#l16.859"></a><span id="l16.859" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; child) {</span>
<a href="#l16.860"></a><span id="l16.860">       nsMsgKey threadParent;</span>
<a href="#l16.861"></a><span id="l16.861">       nsMsgKey msgKey;</span>
<a href="#l16.862"></a><span id="l16.862">       // we're only doing one level of threading, so check if caller is</span>
<a href="#l16.863"></a><span id="l16.863">       // asking for children of the first message in the thread or not.</span>
<a href="#l16.864"></a><span id="l16.864">       // if not, we will tell him there are no children.</span>
<a href="#l16.865"></a><span id="l16.865">       child-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l16.866"></a><span id="l16.866">       child-&gt;GetThreadParent(&amp;threadParent);</span>
<a href="#l16.867"></a><span id="l16.867"> </span>
<a href="#l16.868"></a><span id="l16.868" class="difflineminus">-      printf(&quot;index = %ld key = %ld parent = %lx\n&quot;, childIndex, msgKey, threadParent);</span>
<a href="#l16.869"></a><span id="l16.869" class="difflineplus">+      printf(&quot;index = %ld key = %ld parent = %lx\n&quot;, childIndex, msgKey,</span>
<a href="#l16.870"></a><span id="l16.870" class="difflineplus">+             threadParent);</span>
<a href="#l16.871"></a><span id="l16.871">     }</span>
<a href="#l16.872"></a><span id="l16.872">   }</span>
<a href="#l16.873"></a><span id="l16.873"> #endif</span>
<a href="#l16.874"></a><span id="l16.874"> }</span>
<a href="#l16.875"></a><span id="l16.875"> </span>
<a href="#l16.876"></a><span id="l16.876" class="difflineminus">-int32_t nsMsgThreadEnumerator::MsgKeyFirstChildIndex(nsMsgKey inMsgKey)</span>
<a href="#l16.877"></a><span id="l16.877" class="difflineminus">-{</span>
<a href="#l16.878"></a><span id="l16.878" class="difflineplus">+int32_t nsMsgThreadEnumerator::MsgKeyFirstChildIndex(nsMsgKey inMsgKey) {</span>
<a href="#l16.879"></a><span id="l16.879">   // if (msgKey != mThreadParentKey)</span>
<a href="#l16.880"></a><span id="l16.880">   //   mDone = true;</span>
<a href="#l16.881"></a><span id="l16.881">   // look through rest of thread looking for a child of this message.</span>
<a href="#l16.882"></a><span id="l16.882">   // If the inMsgKey is the first message in the thread, then all children</span>
<a href="#l16.883"></a><span id="l16.883">   // without parents are considered to be children of inMsgKey.</span>
<a href="#l16.884"></a><span id="l16.884">   // Otherwise, only true children qualify.</span>
<a href="#l16.885"></a><span id="l16.885"> </span>
<a href="#l16.886"></a><span id="l16.886">   int32_t firstChildIndex = -1;</span>
<a href="#l16.887"></a><span id="l16.887">   uint32_t numChildren = 0;</span>
<a href="#l16.888"></a><span id="l16.888">   mThread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l16.889"></a><span id="l16.889"> </span>
<a href="#l16.890"></a><span id="l16.890">   // if this is the first message in the thread, just check if there's more than</span>
<a href="#l16.891"></a><span id="l16.891">   // one message in the thread.</span>
<a href="#l16.892"></a><span id="l16.892">   // if (inMsgKey == mThread-&gt;m_threadRootKey)</span>
<a href="#l16.893"></a><span id="l16.893">   // return (numChildren &gt; 1) ? 1 : -1;</span>
<a href="#l16.894"></a><span id="l16.894"> </span>
<a href="#l16.895"></a><span id="l16.895" class="difflineminus">-  for (uint32_t curChildIndex = 0; curChildIndex &lt; numChildren; curChildIndex++)</span>
<a href="#l16.896"></a><span id="l16.896" class="difflineminus">-  {</span>
<a href="#l16.897"></a><span id="l16.897" class="difflineplus">+  for (uint32_t curChildIndex = 0; curChildIndex &lt; numChildren;</span>
<a href="#l16.898"></a><span id="l16.898" class="difflineplus">+       curChildIndex++) {</span>
<a href="#l16.899"></a><span id="l16.899">     nsCOMPtr&lt;nsIMsgDBHdr&gt; curHdr;</span>
<a href="#l16.900"></a><span id="l16.900">     nsresult rv = mThread-&gt;GetChildHdrAt(curChildIndex, getter_AddRefs(curHdr));</span>
<a href="#l16.901"></a><span id="l16.901" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; curHdr)</span>
<a href="#l16.902"></a><span id="l16.902" class="difflineminus">-    {</span>
<a href="#l16.903"></a><span id="l16.903" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; curHdr) {</span>
<a href="#l16.904"></a><span id="l16.904">       nsMsgKey parentKey;</span>
<a href="#l16.905"></a><span id="l16.905"> </span>
<a href="#l16.906"></a><span id="l16.906">       curHdr-&gt;GetThreadParent(&amp;parentKey);</span>
<a href="#l16.907"></a><span id="l16.907" class="difflineminus">-      if (parentKey == inMsgKey)</span>
<a href="#l16.908"></a><span id="l16.908" class="difflineminus">-      {</span>
<a href="#l16.909"></a><span id="l16.909" class="difflineplus">+      if (parentKey == inMsgKey) {</span>
<a href="#l16.910"></a><span id="l16.910">         firstChildIndex = curChildIndex;</span>
<a href="#l16.911"></a><span id="l16.911">         break;</span>
<a href="#l16.912"></a><span id="l16.912">       }</span>
<a href="#l16.913"></a><span id="l16.913">     }</span>
<a href="#l16.914"></a><span id="l16.914">   }</span>
<a href="#l16.915"></a><span id="l16.915"> #ifdef DEBUG_bienvenu1</span>
<a href="#l16.916"></a><span id="l16.916">   printf(&quot;first child index of %ld = %ld\n&quot;, inMsgKey, firstChildIndex);</span>
<a href="#l16.917"></a><span id="l16.917"> #endif</span>
<a href="#l16.918"></a><span id="l16.918">   return firstChildIndex;</span>
<a href="#l16.919"></a><span id="l16.919"> }</span>
<a href="#l16.920"></a><span id="l16.920"> </span>
<a href="#l16.921"></a><span id="l16.921" class="difflineminus">-NS_IMETHODIMP nsMsgThreadEnumerator::GetNext(nsISupports **aItem)</span>
<a href="#l16.922"></a><span id="l16.922" class="difflineminus">-{</span>
<a href="#l16.923"></a><span id="l16.923" class="difflineplus">+NS_IMETHODIMP nsMsgThreadEnumerator::GetNext(nsISupports **aItem) {</span>
<a href="#l16.924"></a><span id="l16.924">   NS_ENSURE_ARG_POINTER(aItem);</span>
<a href="#l16.925"></a><span id="l16.925">   nsresult rv;</span>
<a href="#l16.926"></a><span id="l16.926"> </span>
<a href="#l16.927"></a><span id="l16.927" class="difflineminus">-  if (mNeedToPrefetch)</span>
<a href="#l16.928"></a><span id="l16.928" class="difflineminus">-  {</span>
<a href="#l16.929"></a><span id="l16.929" class="difflineplus">+  if (mNeedToPrefetch) {</span>
<a href="#l16.930"></a><span id="l16.930">     rv = Prefetch();</span>
<a href="#l16.931"></a><span id="l16.931">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.932"></a><span id="l16.932">   }</span>
<a href="#l16.933"></a><span id="l16.933"> </span>
<a href="#l16.934"></a><span id="l16.934" class="difflineminus">-  if (mResultHdr)</span>
<a href="#l16.935"></a><span id="l16.935" class="difflineminus">-  {</span>
<a href="#l16.936"></a><span id="l16.936" class="difflineplus">+  if (mResultHdr) {</span>
<a href="#l16.937"></a><span id="l16.937">     NS_ADDREF(*aItem = mResultHdr);</span>
<a href="#l16.938"></a><span id="l16.938">     mNeedToPrefetch = true;</span>
<a href="#l16.939"></a><span id="l16.939">   }</span>
<a href="#l16.940"></a><span id="l16.940">   return NS_OK;</span>
<a href="#l16.941"></a><span id="l16.941"> }</span>
<a href="#l16.942"></a><span id="l16.942"> </span>
<a href="#l16.943"></a><span id="l16.943" class="difflineminus">-nsresult nsMsgThreadEnumerator::Prefetch()</span>
<a href="#l16.944"></a><span id="l16.944" class="difflineminus">-{</span>
<a href="#l16.945"></a><span id="l16.945" class="difflineminus">-  nsresult rv=NS_OK;          // XXX or should this default to an error?</span>
<a href="#l16.946"></a><span id="l16.946" class="difflineplus">+nsresult nsMsgThreadEnumerator::Prefetch() {</span>
<a href="#l16.947"></a><span id="l16.947" class="difflineplus">+  nsresult rv = NS_OK;  // XXX or should this default to an error?</span>
<a href="#l16.948"></a><span id="l16.948">   mResultHdr = nullptr;</span>
<a href="#l16.949"></a><span id="l16.949" class="difflineminus">-  if (mThreadParentKey == nsMsgKey_None)</span>
<a href="#l16.950"></a><span id="l16.950" class="difflineminus">-  {</span>
<a href="#l16.951"></a><span id="l16.951" class="difflineplus">+  if (mThreadParentKey == nsMsgKey_None) {</span>
<a href="#l16.952"></a><span id="l16.952">     rv = mThread-&gt;GetRootHdr(&amp;mChildIndex, getter_AddRefs(mResultHdr));</span>
<a href="#l16.953"></a><span id="l16.953" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; mResultHdr, &quot;better be able to get root hdr&quot;);</span>
<a href="#l16.954"></a><span id="l16.954" class="difflineminus">-    mChildIndex = 0; // since root can be anywhere, set mChildIndex to 0.</span>
<a href="#l16.955"></a><span id="l16.955" class="difflineminus">-  }</span>
<a href="#l16.956"></a><span id="l16.956" class="difflineminus">-  else if (!mDone)</span>
<a href="#l16.957"></a><span id="l16.957" class="difflineminus">-  {</span>
<a href="#l16.958"></a><span id="l16.958" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; mResultHdr,</span>
<a href="#l16.959"></a><span id="l16.959" class="difflineplus">+                 &quot;better be able to get root hdr&quot;);</span>
<a href="#l16.960"></a><span id="l16.960" class="difflineplus">+    mChildIndex = 0;  // since root can be anywhere, set mChildIndex to 0.</span>
<a href="#l16.961"></a><span id="l16.961" class="difflineplus">+  } else if (!mDone) {</span>
<a href="#l16.962"></a><span id="l16.962">     uint32_t numChildren = 0;</span>
<a href="#l16.963"></a><span id="l16.963">     mThread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l16.964"></a><span id="l16.964"> </span>
<a href="#l16.965"></a><span id="l16.965" class="difflineminus">-    while (mChildIndex &lt; (int32_t) numChildren)</span>
<a href="#l16.966"></a><span id="l16.966" class="difflineminus">-    {</span>
<a href="#l16.967"></a><span id="l16.967" class="difflineminus">-      rv  = mThread-&gt;GetChildHdrAt(mChildIndex++, getter_AddRefs(mResultHdr));</span>
<a href="#l16.968"></a><span id="l16.968" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr)</span>
<a href="#l16.969"></a><span id="l16.969" class="difflineminus">-      {</span>
<a href="#l16.970"></a><span id="l16.970" class="difflineplus">+    while (mChildIndex &lt; (int32_t)numChildren) {</span>
<a href="#l16.971"></a><span id="l16.971" class="difflineplus">+      rv = mThread-&gt;GetChildHdrAt(mChildIndex++, getter_AddRefs(mResultHdr));</span>
<a href="#l16.972"></a><span id="l16.972" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; mResultHdr) {</span>
<a href="#l16.973"></a><span id="l16.973">         nsMsgKey parentKey;</span>
<a href="#l16.974"></a><span id="l16.974">         nsMsgKey curKey;</span>
<a href="#l16.975"></a><span id="l16.975"> </span>
<a href="#l16.976"></a><span id="l16.976">         if (mFilter &amp;&amp; NS_FAILED(mFilter(mResultHdr, mClosure))) {</span>
<a href="#l16.977"></a><span id="l16.977">           mResultHdr = nullptr;</span>
<a href="#l16.978"></a><span id="l16.978">           continue;</span>
<a href="#l16.979"></a><span id="l16.979">         }</span>
<a href="#l16.980"></a><span id="l16.980"> </span>
<a href="#l16.981"></a><span id="l16.981">         mResultHdr-&gt;GetThreadParent(&amp;parentKey);</span>
<a href="#l16.982"></a><span id="l16.982">         mResultHdr-&gt;GetMessageKey(&amp;curKey);</span>
<a href="#l16.983"></a><span id="l16.983">         // if the parent is the same as the msg we're enumerating over,</span>
<a href="#l16.984"></a><span id="l16.984">         // or the parentKey isn't set, and we're iterating over the top</span>
<a href="#l16.985"></a><span id="l16.985">         // level message in the thread, then leave mResultHdr set to cur msg.</span>
<a href="#l16.986"></a><span id="l16.986">         if (parentKey == mThreadParentKey ||</span>
<a href="#l16.987"></a><span id="l16.987" class="difflineminus">-          (parentKey == nsMsgKey_None</span>
<a href="#l16.988"></a><span id="l16.988" class="difflineminus">-          &amp;&amp; mThreadParentKey == mFirstMsgKey &amp;&amp; curKey != mThreadParentKey))</span>
<a href="#l16.989"></a><span id="l16.989" class="difflineplus">+            (parentKey == nsMsgKey_None &amp;&amp; mThreadParentKey == mFirstMsgKey &amp;&amp;</span>
<a href="#l16.990"></a><span id="l16.990" class="difflineplus">+             curKey != mThreadParentKey))</span>
<a href="#l16.991"></a><span id="l16.991">           break;</span>
<a href="#l16.992"></a><span id="l16.992">         mResultHdr = nullptr;</span>
<a href="#l16.993"></a><span id="l16.993" class="difflineminus">-      }</span>
<a href="#l16.994"></a><span id="l16.994" class="difflineminus">-      else</span>
<a href="#l16.995"></a><span id="l16.995" class="difflineplus">+      } else</span>
<a href="#l16.996"></a><span id="l16.996">         NS_ASSERTION(false, &quot;better be able to get child&quot;);</span>
<a href="#l16.997"></a><span id="l16.997">     }</span>
<a href="#l16.998"></a><span id="l16.998" class="difflineminus">-    if (!mResultHdr &amp;&amp; mThreadParentKey == mFirstMsgKey &amp;&amp; !mFoundChildren &amp;&amp; numChildren &gt; 1)</span>
<a href="#l16.999"></a><span id="l16.999" class="difflineplus">+    if (!mResultHdr &amp;&amp; mThreadParentKey == mFirstMsgKey &amp;&amp; !mFoundChildren &amp;&amp;</span>
<a href="#l16.1000"></a><span id="l16.1000" class="difflineplus">+        numChildren &gt; 1)</span>
<a href="#l16.1001"></a><span id="l16.1001">       mThread-&gt;ReparentMsgsWithInvalidParent(numChildren, mThreadParentKey);</span>
<a href="#l16.1002"></a><span id="l16.1002">   }</span>
<a href="#l16.1003"></a><span id="l16.1003" class="difflineminus">-  if (!mResultHdr)</span>
<a href="#l16.1004"></a><span id="l16.1004" class="difflineminus">-  {</span>
<a href="#l16.1005"></a><span id="l16.1005" class="difflineplus">+  if (!mResultHdr) {</span>
<a href="#l16.1006"></a><span id="l16.1006">     mDone = true;</span>
<a href="#l16.1007"></a><span id="l16.1007">     return NS_ERROR_FAILURE;</span>
<a href="#l16.1008"></a><span id="l16.1008">   }</span>
<a href="#l16.1009"></a><span id="l16.1009" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l16.1010"></a><span id="l16.1010" class="difflineminus">-  {</span>
<a href="#l16.1011"></a><span id="l16.1011" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l16.1012"></a><span id="l16.1012">     mDone = true;</span>
<a href="#l16.1013"></a><span id="l16.1013">     return rv;</span>
<a href="#l16.1014"></a><span id="l16.1014" class="difflineminus">-  }</span>
<a href="#l16.1015"></a><span id="l16.1015" class="difflineminus">-  else</span>
<a href="#l16.1016"></a><span id="l16.1016" class="difflineplus">+  } else</span>
<a href="#l16.1017"></a><span id="l16.1017">     mNeedToPrefetch = false;</span>
<a href="#l16.1018"></a><span id="l16.1018">   mFoundChildren = true;</span>
<a href="#l16.1019"></a><span id="l16.1019"> </span>
<a href="#l16.1020"></a><span id="l16.1020"> #ifdef DEBUG_bienvenu1</span>
<a href="#l16.1021"></a><span id="l16.1021">   nsMsgKey debugMsgKey;</span>
<a href="#l16.1022"></a><span id="l16.1022">   mResultHdr-&gt;GetMessageKey(&amp;debugMsgKey);</span>
<a href="#l16.1023"></a><span id="l16.1023">   printf(&quot;next for %ld = %ld\n&quot;, mThreadParentKey, debugMsgKey);</span>
<a href="#l16.1024"></a><span id="l16.1024"> #endif</span>
<a href="#l16.1025"></a><span id="l16.1025"> </span>
<a href="#l16.1026"></a><span id="l16.1026">   return rv;</span>
<a href="#l16.1027"></a><span id="l16.1027"> }</span>
<a href="#l16.1028"></a><span id="l16.1028"> </span>
<a href="#l16.1029"></a><span id="l16.1029" class="difflineminus">-NS_IMETHODIMP nsMsgThreadEnumerator::HasMoreElements(bool *aResult)</span>
<a href="#l16.1030"></a><span id="l16.1030" class="difflineminus">-{</span>
<a href="#l16.1031"></a><span id="l16.1031" class="difflineplus">+NS_IMETHODIMP nsMsgThreadEnumerator::HasMoreElements(bool *aResult) {</span>
<a href="#l16.1032"></a><span id="l16.1032">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l16.1033"></a><span id="l16.1033" class="difflineminus">-  if (mNeedToPrefetch)</span>
<a href="#l16.1034"></a><span id="l16.1034" class="difflineminus">-    Prefetch();</span>
<a href="#l16.1035"></a><span id="l16.1035" class="difflineplus">+  if (mNeedToPrefetch) Prefetch();</span>
<a href="#l16.1036"></a><span id="l16.1036">   *aResult = !mDone;</span>
<a href="#l16.1037"></a><span id="l16.1037">   return NS_OK;</span>
<a href="#l16.1038"></a><span id="l16.1038"> }</span>
<a href="#l16.1039"></a><span id="l16.1039"> </span>
<a href="#l16.1040"></a><span id="l16.1040" class="difflineminus">-NS_IMETHODIMP nsMsgThread::EnumerateMessages(nsMsgKey parentKey, nsISimpleEnumerator* *result)</span>
<a href="#l16.1041"></a><span id="l16.1041" class="difflineminus">-{</span>
<a href="#l16.1042"></a><span id="l16.1042" class="difflineminus">-  NS_ADDREF(*result = new nsMsgThreadEnumerator(this, parentKey, nullptr, nullptr));</span>
<a href="#l16.1043"></a><span id="l16.1043" class="difflineplus">+NS_IMETHODIMP nsMsgThread::EnumerateMessages(nsMsgKey parentKey,</span>
<a href="#l16.1044"></a><span id="l16.1044" class="difflineplus">+                                             nsISimpleEnumerator **result) {</span>
<a href="#l16.1045"></a><span id="l16.1045" class="difflineplus">+  NS_ADDREF(*result =</span>
<a href="#l16.1046"></a><span id="l16.1046" class="difflineplus">+                new nsMsgThreadEnumerator(this, parentKey, nullptr, nullptr));</span>
<a href="#l16.1047"></a><span id="l16.1047">   return NS_OK;</span>
<a href="#l16.1048"></a><span id="l16.1048"> }</span>
<a href="#l16.1049"></a><span id="l16.1049"> </span>
<a href="#l16.1050"></a><span id="l16.1050" class="difflineminus">-nsresult nsMsgThread::ReparentMsgsWithInvalidParent(uint32_t numChildren, nsMsgKey threadParentKey)</span>
<a href="#l16.1051"></a><span id="l16.1051" class="difflineminus">-{</span>
<a href="#l16.1052"></a><span id="l16.1052" class="difflineplus">+nsresult nsMsgThread::ReparentMsgsWithInvalidParent(uint32_t numChildren,</span>
<a href="#l16.1053"></a><span id="l16.1053" class="difflineplus">+                                                    nsMsgKey threadParentKey) {</span>
<a href="#l16.1054"></a><span id="l16.1054">   nsresult rv = NS_OK;</span>
<a href="#l16.1055"></a><span id="l16.1055">   // run through looking for messages that don't have a correct parent,</span>
<a href="#l16.1056"></a><span id="l16.1056">   // i.e., a parent that's in the thread!</span>
<a href="#l16.1057"></a><span id="l16.1057" class="difflineminus">-  for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l16.1058"></a><span id="l16.1058" class="difflineminus">-  {</span>
<a href="#l16.1059"></a><span id="l16.1059" class="difflineplus">+  for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l16.1060"></a><span id="l16.1060">     nsCOMPtr&lt;nsIMsgDBHdr&gt; curChild;</span>
<a href="#l16.1061"></a><span id="l16.1061" class="difflineminus">-    rv  = GetChildHdrAt(childIndex, getter_AddRefs(curChild));</span>
<a href="#l16.1062"></a><span id="l16.1062" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; curChild)</span>
<a href="#l16.1063"></a><span id="l16.1063" class="difflineminus">-    {</span>
<a href="#l16.1064"></a><span id="l16.1064" class="difflineplus">+    rv = GetChildHdrAt(childIndex, getter_AddRefs(curChild));</span>
<a href="#l16.1065"></a><span id="l16.1065" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; curChild) {</span>
<a href="#l16.1066"></a><span id="l16.1066">       nsMsgKey parentKey;</span>
<a href="#l16.1067"></a><span id="l16.1067">       nsCOMPtr&lt;nsIMsgDBHdr&gt; parent;</span>
<a href="#l16.1068"></a><span id="l16.1068"> </span>
<a href="#l16.1069"></a><span id="l16.1069">       curChild-&gt;GetThreadParent(&amp;parentKey);</span>
<a href="#l16.1070"></a><span id="l16.1070"> </span>
<a href="#l16.1071"></a><span id="l16.1071" class="difflineminus">-      if (parentKey != nsMsgKey_None)</span>
<a href="#l16.1072"></a><span id="l16.1072" class="difflineminus">-      {</span>
<a href="#l16.1073"></a><span id="l16.1073" class="difflineplus">+      if (parentKey != nsMsgKey_None) {</span>
<a href="#l16.1074"></a><span id="l16.1074">         GetChild(parentKey, getter_AddRefs(parent));</span>
<a href="#l16.1075"></a><span id="l16.1075">         if (!parent)</span>
<a href="#l16.1076"></a><span id="l16.1076">           curChild-&gt;SetThreadParent(threadParentKey);</span>
<a href="#l16.1077"></a><span id="l16.1077" class="difflineminus">-        else</span>
<a href="#l16.1078"></a><span id="l16.1078" class="difflineminus">-        {</span>
<a href="#l16.1079"></a><span id="l16.1079" class="difflineplus">+        else {</span>
<a href="#l16.1080"></a><span id="l16.1080">           nsMsgKey childKey;</span>
<a href="#l16.1081"></a><span id="l16.1081">           curChild-&gt;GetMessageKey(&amp;childKey);</span>
<a href="#l16.1082"></a><span id="l16.1082">           // can't be your own parent; set parent to thread parent,</span>
<a href="#l16.1083"></a><span id="l16.1083">           // or make ourselves the root if we are the root.</span>
<a href="#l16.1084"></a><span id="l16.1084">           if (childKey == parentKey)</span>
<a href="#l16.1085"></a><span id="l16.1085" class="difflineminus">-            curChild-&gt;SetThreadParent(m_threadRootKey == childKey ?</span>
<a href="#l16.1086"></a><span id="l16.1086" class="difflineminus">-                                      nsMsgKey_None : m_threadRootKey);</span>
<a href="#l16.1087"></a><span id="l16.1087" class="difflineplus">+            curChild-&gt;SetThreadParent(</span>
<a href="#l16.1088"></a><span id="l16.1088" class="difflineplus">+                m_threadRootKey == childKey ? nsMsgKey_None : m_threadRootKey);</span>
<a href="#l16.1089"></a><span id="l16.1089">         }</span>
<a href="#l16.1090"></a><span id="l16.1090">       }</span>
<a href="#l16.1091"></a><span id="l16.1091">     }</span>
<a href="#l16.1092"></a><span id="l16.1092">   }</span>
<a href="#l16.1093"></a><span id="l16.1093">   return rv;</span>
<a href="#l16.1094"></a><span id="l16.1094"> }</span>
<a href="#l16.1095"></a><span id="l16.1095"> </span>
<a href="#l16.1096"></a><span id="l16.1096" class="difflineminus">-NS_IMETHODIMP nsMsgThread::GetRootHdr(int32_t *resultIndex, nsIMsgDBHdr **result)</span>
<a href="#l16.1097"></a><span id="l16.1097" class="difflineminus">-{</span>
<a href="#l16.1098"></a><span id="l16.1098" class="difflineplus">+NS_IMETHODIMP nsMsgThread::GetRootHdr(int32_t *resultIndex,</span>
<a href="#l16.1099"></a><span id="l16.1099" class="difflineplus">+                                      nsIMsgDBHdr **result) {</span>
<a href="#l16.1100"></a><span id="l16.1100">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l16.1101"></a><span id="l16.1101"> </span>
<a href="#l16.1102"></a><span id="l16.1102">   *result = nullptr;</span>
<a href="#l16.1103"></a><span id="l16.1103">   nsresult rv = NS_OK;</span>
<a href="#l16.1104"></a><span id="l16.1104"> </span>
<a href="#l16.1105"></a><span id="l16.1105" class="difflineminus">-  if (m_threadRootKey != nsMsgKey_None)</span>
<a href="#l16.1106"></a><span id="l16.1106" class="difflineminus">-  {</span>
<a href="#l16.1107"></a><span id="l16.1107" class="difflineplus">+  if (m_threadRootKey != nsMsgKey_None) {</span>
<a href="#l16.1108"></a><span id="l16.1108">     rv = GetChildHdrForKey(m_threadRootKey, result, resultIndex);</span>
<a href="#l16.1109"></a><span id="l16.1109" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; *result)</span>
<a href="#l16.1110"></a><span id="l16.1110" class="difflineminus">-    {</span>
<a href="#l16.1111"></a><span id="l16.1111" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; *result) {</span>
<a href="#l16.1112"></a><span id="l16.1112">       // check that we're really the root key.</span>
<a href="#l16.1113"></a><span id="l16.1113">       nsMsgKey parentKey;</span>
<a href="#l16.1114"></a><span id="l16.1114">       (*result)-&gt;GetThreadParent(&amp;parentKey);</span>
<a href="#l16.1115"></a><span id="l16.1115" class="difflineminus">-      if (parentKey == nsMsgKey_None)</span>
<a href="#l16.1116"></a><span id="l16.1116" class="difflineminus">-        return rv;</span>
<a href="#l16.1117"></a><span id="l16.1117" class="difflineplus">+      if (parentKey == nsMsgKey_None) return rv;</span>
<a href="#l16.1118"></a><span id="l16.1118">       // XXX Hack: since GetChildHdrForKey() addref'ed result, we need to</span>
<a href="#l16.1119"></a><span id="l16.1119">       // release any unwanted result before continuing.</span>
<a href="#l16.1120"></a><span id="l16.1120">       NS_RELEASE(*result);</span>
<a href="#l16.1121"></a><span id="l16.1121">     }</span>
<a href="#l16.1122"></a><span id="l16.1122"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l16.1123"></a><span id="l16.1123">     printf(&quot;need to reset thread root key\n&quot;);</span>
<a href="#l16.1124"></a><span id="l16.1124"> #endif</span>
<a href="#l16.1125"></a><span id="l16.1125">     nsMsgKey threadParentKey = nsMsgKey_None;</span>
<a href="#l16.1126"></a><span id="l16.1126">     uint32_t numChildren = 0;</span>
<a href="#l16.1127"></a><span id="l16.1127">     GetNumChildren(&amp;numChildren);</span>
<a href="#l16.1128"></a><span id="l16.1128"> </span>
<a href="#l16.1129"></a><span id="l16.1129" class="difflineminus">-    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l16.1130"></a><span id="l16.1130" class="difflineminus">-    {</span>
<a href="#l16.1131"></a><span id="l16.1131" class="difflineplus">+    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l16.1132"></a><span id="l16.1132">       nsCOMPtr&lt;nsIMsgDBHdr&gt; curChild;</span>
<a href="#l16.1133"></a><span id="l16.1133" class="difflineminus">-      rv  = GetChildHdrAt(childIndex, getter_AddRefs(curChild));</span>
<a href="#l16.1134"></a><span id="l16.1134" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; curChild)</span>
<a href="#l16.1135"></a><span id="l16.1135" class="difflineminus">-      {</span>
<a href="#l16.1136"></a><span id="l16.1136" class="difflineplus">+      rv = GetChildHdrAt(childIndex, getter_AddRefs(curChild));</span>
<a href="#l16.1137"></a><span id="l16.1137" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; curChild) {</span>
<a href="#l16.1138"></a><span id="l16.1138">         nsMsgKey parentKey;</span>
<a href="#l16.1139"></a><span id="l16.1139"> </span>
<a href="#l16.1140"></a><span id="l16.1140">         curChild-&gt;GetThreadParent(&amp;parentKey);</span>
<a href="#l16.1141"></a><span id="l16.1141" class="difflineminus">-        if (parentKey == nsMsgKey_None)</span>
<a href="#l16.1142"></a><span id="l16.1142" class="difflineminus">-        {</span>
<a href="#l16.1143"></a><span id="l16.1143" class="difflineplus">+        if (parentKey == nsMsgKey_None) {</span>
<a href="#l16.1144"></a><span id="l16.1144">           curChild-&gt;GetMessageKey(&amp;threadParentKey);</span>
<a href="#l16.1145"></a><span id="l16.1145" class="difflineminus">-          if (*result)</span>
<a href="#l16.1146"></a><span id="l16.1146" class="difflineminus">-          {</span>
<a href="#l16.1147"></a><span id="l16.1147" class="difflineplus">+          if (*result) {</span>
<a href="#l16.1148"></a><span id="l16.1148">             NS_WARNING(&quot;two top level msgs, not good&quot;);</span>
<a href="#l16.1149"></a><span id="l16.1149">             continue;</span>
<a href="#l16.1150"></a><span id="l16.1150">           }</span>
<a href="#l16.1151"></a><span id="l16.1151">           SetThreadRootKey(threadParentKey);</span>
<a href="#l16.1152"></a><span id="l16.1152" class="difflineminus">-          if (resultIndex)</span>
<a href="#l16.1153"></a><span id="l16.1153" class="difflineminus">-            *resultIndex = childIndex;</span>
<a href="#l16.1154"></a><span id="l16.1154" class="difflineplus">+          if (resultIndex) *resultIndex = childIndex;</span>
<a href="#l16.1155"></a><span id="l16.1155">           curChild.forget(result);</span>
<a href="#l16.1156"></a><span id="l16.1156">           ReparentMsgsWithInvalidParent(numChildren, threadParentKey);</span>
<a href="#l16.1157"></a><span id="l16.1157">         }</span>
<a href="#l16.1158"></a><span id="l16.1158">       }</span>
<a href="#l16.1159"></a><span id="l16.1159">     }</span>
<a href="#l16.1160"></a><span id="l16.1160">   }</span>
<a href="#l16.1161"></a><span id="l16.1161" class="difflineminus">-  if (!*result)</span>
<a href="#l16.1162"></a><span id="l16.1162" class="difflineminus">-  {</span>
<a href="#l16.1163"></a><span id="l16.1163" class="difflineplus">+  if (!*result) {</span>
<a href="#l16.1164"></a><span id="l16.1164">     // if we can't get the thread root key, we'll just get the first hdr.</span>
<a href="#l16.1165"></a><span id="l16.1165">     // there's a bug where sometimes we weren't resetting the thread root key</span>
<a href="#l16.1166"></a><span id="l16.1166">     // when removing the thread root key.</span>
<a href="#l16.1167"></a><span id="l16.1167" class="difflineminus">-    if (resultIndex)</span>
<a href="#l16.1168"></a><span id="l16.1168" class="difflineminus">-      *resultIndex = 0;</span>
<a href="#l16.1169"></a><span id="l16.1169" class="difflineplus">+    if (resultIndex) *resultIndex = 0;</span>
<a href="#l16.1170"></a><span id="l16.1170">     rv = GetChildHdrAt(0, result);</span>
<a href="#l16.1171"></a><span id="l16.1171">   }</span>
<a href="#l16.1172"></a><span id="l16.1172" class="difflineminus">-  if (!*result)</span>
<a href="#l16.1173"></a><span id="l16.1173" class="difflineminus">-    return rv;</span>
<a href="#l16.1174"></a><span id="l16.1174" class="difflineplus">+  if (!*result) return rv;</span>
<a href="#l16.1175"></a><span id="l16.1175">   // Check that the thread id of the message is this thread.</span>
<a href="#l16.1176"></a><span id="l16.1176">   nsMsgKey threadId = nsMsgKey_None;</span>
<a href="#l16.1177"></a><span id="l16.1177">   (void)(*result)-&gt;GetThreadId(&amp;threadId);</span>
<a href="#l16.1178"></a><span id="l16.1178" class="difflineminus">-  if (threadId != m_threadKey)</span>
<a href="#l16.1179"></a><span id="l16.1179" class="difflineminus">-    (*result)-&gt;SetThreadId(m_threadKey);</span>
<a href="#l16.1180"></a><span id="l16.1180" class="difflineplus">+  if (threadId != m_threadKey) (*result)-&gt;SetThreadId(m_threadKey);</span>
<a href="#l16.1181"></a><span id="l16.1181">   return rv;</span>
<a href="#l16.1182"></a><span id="l16.1182"> }</span>
<a href="#l16.1183"></a><span id="l16.1183"> </span>
<a href="#l16.1184"></a><span id="l16.1184" class="difflineminus">-nsresult nsMsgThread::ChangeChildCount(int32_t delta)</span>
<a href="#l16.1185"></a><span id="l16.1185" class="difflineminus">-{</span>
<a href="#l16.1186"></a><span id="l16.1186" class="difflineplus">+nsresult nsMsgThread::ChangeChildCount(int32_t delta) {</span>
<a href="#l16.1187"></a><span id="l16.1187">   nsresult rv;</span>
<a href="#l16.1188"></a><span id="l16.1188"> </span>
<a href="#l16.1189"></a><span id="l16.1189">   uint32_t childCount = 0;</span>
<a href="#l16.1190"></a><span id="l16.1190" class="difflineminus">-  m_mdbDB-&gt;RowCellColumnToUInt32(m_metaRow, m_mdbDB-&gt;m_threadChildrenColumnToken, childCount);</span>
<a href="#l16.1191"></a><span id="l16.1191" class="difflineplus">+  m_mdbDB-&gt;RowCellColumnToUInt32(</span>
<a href="#l16.1192"></a><span id="l16.1192" class="difflineplus">+      m_metaRow, m_mdbDB-&gt;m_threadChildrenColumnToken, childCount);</span>
<a href="#l16.1193"></a><span id="l16.1193"> </span>
<a href="#l16.1194"></a><span id="l16.1194" class="difflineminus">-  NS_WARNING_ASSERTION(childCount != 0 || delta &gt; 0, &quot;child count gone negative&quot;);</span>
<a href="#l16.1195"></a><span id="l16.1195" class="difflineplus">+  NS_WARNING_ASSERTION(childCount != 0 || delta &gt; 0,</span>
<a href="#l16.1196"></a><span id="l16.1196" class="difflineplus">+                       &quot;child count gone negative&quot;);</span>
<a href="#l16.1197"></a><span id="l16.1197">   childCount += delta;</span>
<a href="#l16.1198"></a><span id="l16.1198"> </span>
<a href="#l16.1199"></a><span id="l16.1199" class="difflineminus">-  NS_WARNING_ASSERTION((int32_t) childCount &gt;= 0, &quot;child count gone to 0 or below&quot;);</span>
<a href="#l16.1200"></a><span id="l16.1200" class="difflineminus">-  if ((int32_t) childCount &lt; 0)  // force child count to &gt;= 0</span>
<a href="#l16.1201"></a><span id="l16.1201" class="difflineplus">+  NS_WARNING_ASSERTION((int32_t)childCount &gt;= 0,</span>
<a href="#l16.1202"></a><span id="l16.1202" class="difflineplus">+                       &quot;child count gone to 0 or below&quot;);</span>
<a href="#l16.1203"></a><span id="l16.1203" class="difflineplus">+  if ((int32_t)childCount &lt; 0)  // force child count to &gt;= 0</span>
<a href="#l16.1204"></a><span id="l16.1204">     childCount = 0;</span>
<a href="#l16.1205"></a><span id="l16.1205"> </span>
<a href="#l16.1206"></a><span id="l16.1206" class="difflineminus">-  rv = m_mdbDB-&gt;UInt32ToRowCellColumn(m_metaRow, m_mdbDB-&gt;m_threadChildrenColumnToken, childCount);</span>
<a href="#l16.1207"></a><span id="l16.1207" class="difflineplus">+  rv = m_mdbDB-&gt;UInt32ToRowCellColumn(</span>
<a href="#l16.1208"></a><span id="l16.1208" class="difflineplus">+      m_metaRow, m_mdbDB-&gt;m_threadChildrenColumnToken, childCount);</span>
<a href="#l16.1209"></a><span id="l16.1209">   m_numChildren = childCount;</span>
<a href="#l16.1210"></a><span id="l16.1210">   return rv;</span>
<a href="#l16.1211"></a><span id="l16.1211"> }</span>
<a href="#l16.1212"></a><span id="l16.1212"> </span>
<a href="#l16.1213"></a><span id="l16.1213" class="difflineminus">-nsresult nsMsgThread::ChangeUnreadChildCount(int32_t delta)</span>
<a href="#l16.1214"></a><span id="l16.1214" class="difflineminus">-{</span>
<a href="#l16.1215"></a><span id="l16.1215" class="difflineplus">+nsresult nsMsgThread::ChangeUnreadChildCount(int32_t delta) {</span>
<a href="#l16.1216"></a><span id="l16.1216">   nsresult rv;</span>
<a href="#l16.1217"></a><span id="l16.1217"> </span>
<a href="#l16.1218"></a><span id="l16.1218">   uint32_t childCount = 0;</span>
<a href="#l16.1219"></a><span id="l16.1219" class="difflineminus">-  m_mdbDB-&gt;RowCellColumnToUInt32(m_metaRow, m_mdbDB-&gt;m_threadUnreadChildrenColumnToken, childCount);</span>
<a href="#l16.1220"></a><span id="l16.1220" class="difflineplus">+  m_mdbDB-&gt;RowCellColumnToUInt32(</span>
<a href="#l16.1221"></a><span id="l16.1221" class="difflineplus">+      m_metaRow, m_mdbDB-&gt;m_threadUnreadChildrenColumnToken, childCount);</span>
<a href="#l16.1222"></a><span id="l16.1222">   childCount += delta;</span>
<a href="#l16.1223"></a><span id="l16.1223" class="difflineminus">-  if ((int32_t) childCount &lt; 0)</span>
<a href="#l16.1224"></a><span id="l16.1224" class="difflineminus">-  {</span>
<a href="#l16.1225"></a><span id="l16.1225" class="difflineplus">+  if ((int32_t)childCount &lt; 0) {</span>
<a href="#l16.1226"></a><span id="l16.1226"> #ifdef DEBUG_bienvenu1</span>
<a href="#l16.1227"></a><span id="l16.1227">     NS_ASSERTION(false, &quot;negative unread child count&quot;);</span>
<a href="#l16.1228"></a><span id="l16.1228"> #endif</span>
<a href="#l16.1229"></a><span id="l16.1229">     childCount = 0;</span>
<a href="#l16.1230"></a><span id="l16.1230">   }</span>
<a href="#l16.1231"></a><span id="l16.1231" class="difflineminus">-  rv = m_mdbDB-&gt;UInt32ToRowCellColumn(m_metaRow, m_mdbDB-&gt;m_threadUnreadChildrenColumnToken, childCount);</span>
<a href="#l16.1232"></a><span id="l16.1232" class="difflineplus">+  rv = m_mdbDB-&gt;UInt32ToRowCellColumn(</span>
<a href="#l16.1233"></a><span id="l16.1233" class="difflineplus">+      m_metaRow, m_mdbDB-&gt;m_threadUnreadChildrenColumnToken, childCount);</span>
<a href="#l16.1234"></a><span id="l16.1234">   m_numUnreadChildren = childCount;</span>
<a href="#l16.1235"></a><span id="l16.1235">   return rv;</span>
<a href="#l16.1236"></a><span id="l16.1236"> }</span>
<a href="#l16.1237"></a><span id="l16.1237"> </span>
<a href="#l16.1238"></a><span id="l16.1238" class="difflineminus">-nsresult nsMsgThread::SetThreadRootKey(nsMsgKey threadRootKey)</span>
<a href="#l16.1239"></a><span id="l16.1239" class="difflineminus">-{</span>
<a href="#l16.1240"></a><span id="l16.1240" class="difflineplus">+nsresult nsMsgThread::SetThreadRootKey(nsMsgKey threadRootKey) {</span>
<a href="#l16.1241"></a><span id="l16.1241">   m_threadRootKey = threadRootKey;</span>
<a href="#l16.1242"></a><span id="l16.1242" class="difflineminus">-  return m_mdbDB-&gt;UInt32ToRowCellColumn(m_metaRow, m_mdbDB-&gt;m_threadRootKeyColumnToken, threadRootKey);</span>
<a href="#l16.1243"></a><span id="l16.1243" class="difflineplus">+  return m_mdbDB-&gt;UInt32ToRowCellColumn(</span>
<a href="#l16.1244"></a><span id="l16.1244" class="difflineplus">+      m_metaRow, m_mdbDB-&gt;m_threadRootKeyColumnToken, threadRootKey);</span>
<a href="#l16.1245"></a><span id="l16.1245"> }</span>
<a href="#l16.1246"></a><span id="l16.1246"> </span>
<a href="#l16.1247"></a><span id="l16.1247" class="difflineminus">-nsresult nsMsgThread::GetChildHdrForKey(nsMsgKey desiredKey, nsIMsgDBHdr **result, int32_t *resultIndex)</span>
<a href="#l16.1248"></a><span id="l16.1248" class="difflineminus">-{</span>
<a href="#l16.1249"></a><span id="l16.1249" class="difflineplus">+nsresult nsMsgThread::GetChildHdrForKey(nsMsgKey desiredKey,</span>
<a href="#l16.1250"></a><span id="l16.1250" class="difflineplus">+                                        nsIMsgDBHdr **result,</span>
<a href="#l16.1251"></a><span id="l16.1251" class="difflineplus">+                                        int32_t *resultIndex) {</span>
<a href="#l16.1252"></a><span id="l16.1252">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l16.1253"></a><span id="l16.1253"> </span>
<a href="#l16.1254"></a><span id="l16.1254" class="difflineminus">-  nsresult rv = NS_OK;        // XXX or should this default to an error?</span>
<a href="#l16.1255"></a><span id="l16.1255" class="difflineplus">+  nsresult rv = NS_OK;  // XXX or should this default to an error?</span>
<a href="#l16.1256"></a><span id="l16.1256">   uint32_t numChildren = 0;</span>
<a href="#l16.1257"></a><span id="l16.1257">   GetNumChildren(&amp;numChildren);</span>
<a href="#l16.1258"></a><span id="l16.1258">   uint32_t childIndex;</span>
<a href="#l16.1259"></a><span id="l16.1259" class="difflineminus">-  for (childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l16.1260"></a><span id="l16.1260" class="difflineminus">-  {</span>
<a href="#l16.1261"></a><span id="l16.1261" class="difflineplus">+  for (childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l16.1262"></a><span id="l16.1262">     rv = GetChildHdrAt(childIndex, result);</span>
<a href="#l16.1263"></a><span id="l16.1263" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; *result)</span>
<a href="#l16.1264"></a><span id="l16.1264" class="difflineminus">-    {</span>
<a href="#l16.1265"></a><span id="l16.1265" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; *result) {</span>
<a href="#l16.1266"></a><span id="l16.1266">       nsMsgKey msgKey;</span>
<a href="#l16.1267"></a><span id="l16.1267">       // we're only doing one level of threading, so check if caller is</span>
<a href="#l16.1268"></a><span id="l16.1268">       // asking for children of the first message in the thread or not.</span>
<a href="#l16.1269"></a><span id="l16.1269">       // if not, we will tell him there are no children.</span>
<a href="#l16.1270"></a><span id="l16.1270">       (*result)-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l16.1271"></a><span id="l16.1271"> </span>
<a href="#l16.1272"></a><span id="l16.1272" class="difflineminus">-      if (msgKey == desiredKey)</span>
<a href="#l16.1273"></a><span id="l16.1273" class="difflineminus">-      {</span>
<a href="#l16.1274"></a><span id="l16.1274" class="difflineplus">+      if (msgKey == desiredKey) {</span>
<a href="#l16.1275"></a><span id="l16.1275">         nsMsgKey threadKey;</span>
<a href="#l16.1276"></a><span id="l16.1276">         (*result)-&gt;GetThreadId(&amp;threadKey);</span>
<a href="#l16.1277"></a><span id="l16.1277" class="difflineminus">-        if (threadKey != m_threadKey) // this msg isn't in this thread</span>
<a href="#l16.1278"></a><span id="l16.1278" class="difflineplus">+        if (threadKey != m_threadKey)  // this msg isn't in this thread</span>
<a href="#l16.1279"></a><span id="l16.1279">         {</span>
<a href="#l16.1280"></a><span id="l16.1280">           NS_WARNING(&quot;msg in wrong thread - this shouldn't happen&quot;);</span>
<a href="#l16.1281"></a><span id="l16.1281">           uint32_t msgSize;</span>
<a href="#l16.1282"></a><span id="l16.1282">           (*result)-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l16.1283"></a><span id="l16.1283" class="difflineminus">-          if (msgSize == 0) // this is a phantom message - let's get rid of it.</span>
<a href="#l16.1284"></a><span id="l16.1284" class="difflineplus">+          if (msgSize == 0)  // this is a phantom message - let's get rid of it.</span>
<a href="#l16.1285"></a><span id="l16.1285">           {</span>
<a href="#l16.1286"></a><span id="l16.1286">             RemoveChild(msgKey);</span>
<a href="#l16.1287"></a><span id="l16.1287">             rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l16.1288"></a><span id="l16.1288" class="difflineminus">-          }</span>
<a href="#l16.1289"></a><span id="l16.1289" class="difflineminus">-          else</span>
<a href="#l16.1290"></a><span id="l16.1290" class="difflineminus">-          {</span>
<a href="#l16.1291"></a><span id="l16.1291" class="difflineplus">+          } else {</span>
<a href="#l16.1292"></a><span id="l16.1292">             // otherwise, let's try to figure out which thread</span>
<a href="#l16.1293"></a><span id="l16.1293">             // this message really belongs to.</span>
<a href="#l16.1294"></a><span id="l16.1294">             nsCOMPtr&lt;nsIMsgThread&gt; threadKeyThread =</span>
<a href="#l16.1295"></a><span id="l16.1295" class="difflineminus">-                  dont_AddRef(m_mdbDB-&gt;GetThreadForThreadId(threadKey));</span>
<a href="#l16.1296"></a><span id="l16.1296" class="difflineminus">-            if (threadKeyThread)</span>
<a href="#l16.1297"></a><span id="l16.1297" class="difflineminus">-            {</span>
<a href="#l16.1298"></a><span id="l16.1298" class="difflineplus">+                dont_AddRef(m_mdbDB-&gt;GetThreadForThreadId(threadKey));</span>
<a href="#l16.1299"></a><span id="l16.1299" class="difflineplus">+            if (threadKeyThread) {</span>
<a href="#l16.1300"></a><span id="l16.1300">               nsCOMPtr&lt;nsIMsgDBHdr&gt; otherThreadHdr;</span>
<a href="#l16.1301"></a><span id="l16.1301">               threadKeyThread-&gt;GetChild(msgKey, getter_AddRefs(otherThreadHdr));</span>
<a href="#l16.1302"></a><span id="l16.1302" class="difflineminus">-              if (otherThreadHdr)</span>
<a href="#l16.1303"></a><span id="l16.1303" class="difflineminus">-              {</span>
<a href="#l16.1304"></a><span id="l16.1304" class="difflineplus">+              if (otherThreadHdr) {</span>
<a href="#l16.1305"></a><span id="l16.1305">                 // Message is in one thread but has a different thread id.</span>
<a href="#l16.1306"></a><span id="l16.1306">                 // Remove it from the thread and then rethread it.</span>
<a href="#l16.1307"></a><span id="l16.1307">                 RemoveChild(msgKey);</span>
<a href="#l16.1308"></a><span id="l16.1308">                 threadKeyThread-&gt;RemoveChildHdr(otherThreadHdr, nullptr);</span>
<a href="#l16.1309"></a><span id="l16.1309">                 bool newThread;</span>
<a href="#l16.1310"></a><span id="l16.1310" class="difflineminus">-                nsMsgHdr* msgHdr = static_cast&lt;nsMsgHdr*&gt;(otherThreadHdr.get());</span>
<a href="#l16.1311"></a><span id="l16.1311" class="difflineplus">+                nsMsgHdr *msgHdr =</span>
<a href="#l16.1312"></a><span id="l16.1312" class="difflineplus">+                    static_cast&lt;nsMsgHdr *&gt;(otherThreadHdr.get());</span>
<a href="#l16.1313"></a><span id="l16.1313">                 m_mdbDB-&gt;ThreadNewHdr(msgHdr, newThread);</span>
<a href="#l16.1314"></a><span id="l16.1314" class="difflineminus">-              }</span>
<a href="#l16.1315"></a><span id="l16.1315" class="difflineminus">-              else</span>
<a href="#l16.1316"></a><span id="l16.1316" class="difflineminus">-              {</span>
<a href="#l16.1317"></a><span id="l16.1317" class="difflineplus">+              } else {</span>
<a href="#l16.1318"></a><span id="l16.1318">                 (*result)-&gt;SetThreadId(m_threadKey);</span>
<a href="#l16.1319"></a><span id="l16.1319">               }</span>
<a href="#l16.1320"></a><span id="l16.1320">             }</span>
<a href="#l16.1321"></a><span id="l16.1321">           }</span>
<a href="#l16.1322"></a><span id="l16.1322">         }</span>
<a href="#l16.1323"></a><span id="l16.1323">         break;</span>
<a href="#l16.1324"></a><span id="l16.1324">       }</span>
<a href="#l16.1325"></a><span id="l16.1325">       // XXX Hack: since GetChildHdrAt() addref'ed result, we need to</span>
<a href="#l16.1326"></a><span id="l16.1326">       // release any unwanted result before continuing in the loop.</span>
<a href="#l16.1327"></a><span id="l16.1327">       NS_RELEASE(*result);</span>
<a href="#l16.1328"></a><span id="l16.1328">     }</span>
<a href="#l16.1329"></a><span id="l16.1329">   }</span>
<a href="#l16.1330"></a><span id="l16.1330" class="difflineminus">-  if (resultIndex)</span>
<a href="#l16.1331"></a><span id="l16.1331" class="difflineminus">-    *resultIndex = (int32_t) childIndex;</span>
<a href="#l16.1332"></a><span id="l16.1332" class="difflineplus">+  if (resultIndex) *resultIndex = (int32_t)childIndex;</span>
<a href="#l16.1333"></a><span id="l16.1333"> </span>
<a href="#l16.1334"></a><span id="l16.1334">   return rv;</span>
<a href="#l16.1335"></a><span id="l16.1335"> }</span>
<a href="#l16.1336"></a><span id="l16.1336"> </span>
<a href="#l16.1337"></a><span id="l16.1337" class="difflineminus">-NS_IMETHODIMP nsMsgThread::GetFirstUnreadChild(nsIMsgDBHdr **result)</span>
<a href="#l16.1338"></a><span id="l16.1338" class="difflineminus">-{</span>
<a href="#l16.1339"></a><span id="l16.1339" class="difflineplus">+NS_IMETHODIMP nsMsgThread::GetFirstUnreadChild(nsIMsgDBHdr **result) {</span>
<a href="#l16.1340"></a><span id="l16.1340">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l16.1341"></a><span id="l16.1341"> </span>
<a href="#l16.1342"></a><span id="l16.1342">   nsresult rv = NS_OK;</span>
<a href="#l16.1343"></a><span id="l16.1343">   uint8_t minLevel = 0xff;</span>
<a href="#l16.1344"></a><span id="l16.1344"> </span>
<a href="#l16.1345"></a><span id="l16.1345">   uint32_t numChildren = 0;</span>
<a href="#l16.1346"></a><span id="l16.1346">   GetNumChildren(&amp;numChildren);</span>
<a href="#l16.1347"></a><span id="l16.1347"> </span>
<a href="#l16.1348"></a><span id="l16.1348">   nsCOMPtr&lt;nsIMsgDBHdr&gt; retHdr;</span>
<a href="#l16.1349"></a><span id="l16.1349"> </span>
<a href="#l16.1350"></a><span id="l16.1350" class="difflineminus">-  for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l16.1351"></a><span id="l16.1351" class="difflineminus">-  {</span>
<a href="#l16.1352"></a><span id="l16.1352" class="difflineplus">+  for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l16.1353"></a><span id="l16.1353">     nsCOMPtr&lt;nsIMsgDBHdr&gt; child;</span>
<a href="#l16.1354"></a><span id="l16.1354">     rv = GetChildHdrAt(childIndex, getter_AddRefs(child));</span>
<a href="#l16.1355"></a><span id="l16.1355" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; child)</span>
<a href="#l16.1356"></a><span id="l16.1356" class="difflineminus">-    {</span>
<a href="#l16.1357"></a><span id="l16.1357" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; child) {</span>
<a href="#l16.1358"></a><span id="l16.1358">       nsMsgKey msgKey;</span>
<a href="#l16.1359"></a><span id="l16.1359">       child-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l16.1360"></a><span id="l16.1360"> </span>
<a href="#l16.1361"></a><span id="l16.1361">       bool isRead;</span>
<a href="#l16.1362"></a><span id="l16.1362">       rv = m_mdbDB-&gt;IsRead(msgKey, &amp;isRead);</span>
<a href="#l16.1363"></a><span id="l16.1363" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; !isRead)</span>
<a href="#l16.1364"></a><span id="l16.1364" class="difflineminus">-      {</span>
<a href="#l16.1365"></a><span id="l16.1365" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; !isRead) {</span>
<a href="#l16.1366"></a><span id="l16.1366">         // this is the root, so it's the best we're going to do.</span>
<a href="#l16.1367"></a><span id="l16.1367" class="difflineminus">-        if (msgKey == m_threadRootKey)</span>
<a href="#l16.1368"></a><span id="l16.1368" class="difflineminus">-        {</span>
<a href="#l16.1369"></a><span id="l16.1369" class="difflineplus">+        if (msgKey == m_threadRootKey) {</span>
<a href="#l16.1370"></a><span id="l16.1370">           retHdr = child;</span>
<a href="#l16.1371"></a><span id="l16.1371">           break;</span>
<a href="#l16.1372"></a><span id="l16.1372">         }</span>
<a href="#l16.1373"></a><span id="l16.1373">         uint8_t level = 0;</span>
<a href="#l16.1374"></a><span id="l16.1374">         nsMsgKey parentId;</span>
<a href="#l16.1375"></a><span id="l16.1375">         child-&gt;GetThreadParent(&amp;parentId);</span>
<a href="#l16.1376"></a><span id="l16.1376">         nsCOMPtr&lt;nsIMsgDBHdr&gt; parent;</span>
<a href="#l16.1377"></a><span id="l16.1377">         // count number of ancestors - that's our level</span>
<a href="#l16.1378"></a><span id="l16.1378" class="difflineminus">-        while (parentId != nsMsgKey_None)</span>
<a href="#l16.1379"></a><span id="l16.1379" class="difflineminus">-        {</span>
<a href="#l16.1380"></a><span id="l16.1380" class="difflineplus">+        while (parentId != nsMsgKey_None) {</span>
<a href="#l16.1381"></a><span id="l16.1381">           rv = m_mdbDB-&gt;GetMsgHdrForKey(parentId, getter_AddRefs(parent));</span>
<a href="#l16.1382"></a><span id="l16.1382" class="difflineminus">-          if (parent)</span>
<a href="#l16.1383"></a><span id="l16.1383" class="difflineminus">-          {</span>
<a href="#l16.1384"></a><span id="l16.1384" class="difflineplus">+          if (parent) {</span>
<a href="#l16.1385"></a><span id="l16.1385">             parent-&gt;GetThreadParent(&amp;parentId);</span>
<a href="#l16.1386"></a><span id="l16.1386">             level++;</span>
<a href="#l16.1387"></a><span id="l16.1387">           }</span>
<a href="#l16.1388"></a><span id="l16.1388">         }</span>
<a href="#l16.1389"></a><span id="l16.1389" class="difflineminus">-        if (level &lt; minLevel)</span>
<a href="#l16.1390"></a><span id="l16.1390" class="difflineminus">-        {</span>
<a href="#l16.1391"></a><span id="l16.1391" class="difflineplus">+        if (level &lt; minLevel) {</span>
<a href="#l16.1392"></a><span id="l16.1392">           minLevel = level;</span>
<a href="#l16.1393"></a><span id="l16.1393">           retHdr = child;</span>
<a href="#l16.1394"></a><span id="l16.1394">         }</span>
<a href="#l16.1395"></a><span id="l16.1395">       }</span>
<a href="#l16.1396"></a><span id="l16.1396">     }</span>
<a href="#l16.1397"></a><span id="l16.1397">   }</span>
<a href="#l16.1398"></a><span id="l16.1398"> </span>
<a href="#l16.1399"></a><span id="l16.1399">   retHdr.forget(result);</span>
<a href="#l16.1400"></a><span id="l16.1400">   return rv;</span>
<a href="#l16.1401"></a><span id="l16.1401"> }</span>
<a href="#l16.1402"></a><span id="l16.1402"> </span>
<a href="#l16.1403"></a><span id="l16.1403" class="difflineminus">-NS_IMETHODIMP nsMsgThread::GetNewestMsgDate(uint32_t *aResult)</span>
<a href="#l16.1404"></a><span id="l16.1404" class="difflineminus">-{</span>
<a href="#l16.1405"></a><span id="l16.1405" class="difflineminus">-  // if this hasn't been set, figure it out by enumerating the msgs in the thread.</span>
<a href="#l16.1406"></a><span id="l16.1406" class="difflineminus">-  if (!m_newestMsgDate)</span>
<a href="#l16.1407"></a><span id="l16.1407" class="difflineminus">-  {</span>
<a href="#l16.1408"></a><span id="l16.1408" class="difflineplus">+NS_IMETHODIMP nsMsgThread::GetNewestMsgDate(uint32_t *aResult) {</span>
<a href="#l16.1409"></a><span id="l16.1409" class="difflineplus">+  // if this hasn't been set, figure it out by enumerating the msgs in the</span>
<a href="#l16.1410"></a><span id="l16.1410" class="difflineplus">+  // thread.</span>
<a href="#l16.1411"></a><span id="l16.1411" class="difflineplus">+  if (!m_newestMsgDate) {</span>
<a href="#l16.1412"></a><span id="l16.1412">     nsresult rv;</span>
<a href="#l16.1413"></a><span id="l16.1413">     uint32_t numChildren;</span>
<a href="#l16.1414"></a><span id="l16.1414">     GetNumChildren(&amp;numChildren);</span>
<a href="#l16.1415"></a><span id="l16.1415" class="difflineminus">-    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l16.1416"></a><span id="l16.1416" class="difflineminus">-    {</span>
<a href="#l16.1417"></a><span id="l16.1417" class="difflineplus">+    for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++) {</span>
<a href="#l16.1418"></a><span id="l16.1418">       nsCOMPtr&lt;nsIMsgDBHdr&gt; child;</span>
<a href="#l16.1419"></a><span id="l16.1419">       rv = GetChildHdrAt(childIndex, getter_AddRefs(child));</span>
<a href="#l16.1420"></a><span id="l16.1420" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l16.1421"></a><span id="l16.1421" class="difflineminus">-      {</span>
<a href="#l16.1422"></a><span id="l16.1422" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l16.1423"></a><span id="l16.1423">         uint32_t msgDate;</span>
<a href="#l16.1424"></a><span id="l16.1424">         child-&gt;GetDateInSeconds(&amp;msgDate);</span>
<a href="#l16.1425"></a><span id="l16.1425" class="difflineminus">-        if (msgDate &gt; m_newestMsgDate)</span>
<a href="#l16.1426"></a><span id="l16.1426" class="difflineminus">-          m_newestMsgDate = msgDate;</span>
<a href="#l16.1427"></a><span id="l16.1427" class="difflineplus">+        if (msgDate &gt; m_newestMsgDate) m_newestMsgDate = msgDate;</span>
<a href="#l16.1428"></a><span id="l16.1428">       }</span>
<a href="#l16.1429"></a><span id="l16.1429">     }</span>
<a href="#l16.1430"></a><span id="l16.1430">   }</span>
<a href="#l16.1431"></a><span id="l16.1431">   *aResult = m_newestMsgDate;</span>
<a href="#l16.1432"></a><span id="l16.1432">   return NS_OK;</span>
<a href="#l16.1433"></a><span id="l16.1433"> }</span>
<a href="#l16.1434"></a><span id="l16.1434"> </span>
<a href="#l16.1435"></a><span id="l16.1435" class="difflineminus">-NS_IMETHODIMP nsMsgThread::SetNewestMsgDate(uint32_t aNewestMsgDate)</span>
<a href="#l16.1436"></a><span id="l16.1436" class="difflineminus">-{</span>
<a href="#l16.1437"></a><span id="l16.1437" class="difflineplus">+NS_IMETHODIMP nsMsgThread::SetNewestMsgDate(uint32_t aNewestMsgDate) {</span>
<a href="#l16.1438"></a><span id="l16.1438">   m_newestMsgDate = aNewestMsgDate;</span>
<a href="#l16.1439"></a><span id="l16.1439" class="difflineminus">-  return m_mdbDB-&gt;UInt32ToRowCellColumn(m_metaRow, m_mdbDB-&gt;m_threadNewestMsgDateColumnToken, aNewestMsgDate);</span>
<a href="#l16.1440"></a><span id="l16.1440" class="difflineplus">+  return m_mdbDB-&gt;UInt32ToRowCellColumn(</span>
<a href="#l16.1441"></a><span id="l16.1441" class="difflineplus">+      m_metaRow, m_mdbDB-&gt;m_threadNewestMsgDateColumnToken, aNewestMsgDate);</span>
<a href="#l16.1442"></a><span id="l16.1442"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsNewsDatabase.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsNewsDatabase.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -7,354 +7,301 @@</span>
<a href="#l17.4"></a><span id="l17.4"> #include &quot;nsIMsgDBView.h&quot;</span>
<a href="#l17.5"></a><span id="l17.5"> #include &quot;nsIMsgThread.h&quot;</span>
<a href="#l17.6"></a><span id="l17.6"> #include &quot;nsNewsDatabase.h&quot;</span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;nsMsgKeySet.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> #include &quot;prlog.h&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> #if defined(DEBUG_sspitzer_) || defined(DEBUG_seth_)</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-#define DEBUG_NEWS_DATABASE 1</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+#  define DEBUG_NEWS_DATABASE 1</span>
<a href="#l17.14"></a><span id="l17.14"> #endif</span>
<a href="#l17.15"></a><span id="l17.15"> </span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-nsNewsDatabase::nsNewsDatabase()</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-{</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-  m_readSet = nullptr;</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-}</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+nsNewsDatabase::nsNewsDatabase() { m_readSet = nullptr; }</span>
<a href="#l17.21"></a><span id="l17.21"> </span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-nsNewsDatabase::~nsNewsDatabase()</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-{</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-}</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+nsNewsDatabase::~nsNewsDatabase() {}</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27"> NS_IMPL_ADDREF_INHERITED(nsNewsDatabase, nsMsgDatabase)</span>
<a href="#l17.28"></a><span id="l17.28"> NS_IMPL_RELEASE_INHERITED(nsNewsDatabase, nsMsgDatabase)</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-NS_IMETHODIMP nsNewsDatabase::QueryInterface(REFNSIID aIID, void** aInstancePtr)</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-{</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+NS_IMETHODIMP nsNewsDatabase::QueryInterface(REFNSIID aIID,</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+                                             void **aInstancePtr) {</span>
<a href="#l17.34"></a><span id="l17.34">   if (!aInstancePtr) return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.35"></a><span id="l17.35">   *aInstancePtr = nullptr;</span>
<a href="#l17.36"></a><span id="l17.36"> </span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-  if (aIID.Equals(NS_GET_IID(nsINewsDatabase)))</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-  {</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+  if (aIID.Equals(NS_GET_IID(nsINewsDatabase))) {</span>
<a href="#l17.40"></a><span id="l17.40">     *aInstancePtr = static_cast&lt;nsINewsDatabase *&gt;(this);</span>
<a href="#l17.41"></a><span id="l17.41">   }</span>
<a href="#l17.42"></a><span id="l17.42"> </span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-  if(*aInstancePtr)</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-  {</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+  if (*aInstancePtr) {</span>
<a href="#l17.46"></a><span id="l17.46">     AddRef();</span>
<a href="#l17.47"></a><span id="l17.47">     return NS_OK;</span>
<a href="#l17.48"></a><span id="l17.48">   }</span>
<a href="#l17.49"></a><span id="l17.49"> </span>
<a href="#l17.50"></a><span id="l17.50">   return nsMsgDatabase::QueryInterface(aIID, aInstancePtr);</span>
<a href="#l17.51"></a><span id="l17.51"> }</span>
<a href="#l17.52"></a><span id="l17.52"> </span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-nsresult nsNewsDatabase::Close(bool forceCommit)</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-{</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+nsresult nsNewsDatabase::Close(bool forceCommit) {</span>
<a href="#l17.56"></a><span id="l17.56">   return nsMsgDatabase::Close(forceCommit);</span>
<a href="#l17.57"></a><span id="l17.57"> }</span>
<a href="#l17.58"></a><span id="l17.58"> </span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-nsresult nsNewsDatabase::ForceClosed()</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-{</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-  return nsMsgDatabase::ForceClosed();</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-}</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+nsresult nsNewsDatabase::ForceClosed() { return nsMsgDatabase::ForceClosed(); }</span>
<a href="#l17.64"></a><span id="l17.64"> </span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-nsresult nsNewsDatabase::Commit(nsMsgDBCommit commitType)</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-{</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-  if (m_dbFolderInfo &amp;&amp; m_readSet)</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-  {</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-    // let's write out our idea of the read set so we can compare it with that of</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-    // the .rc file next time we start up.</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+nsresult nsNewsDatabase::Commit(nsMsgDBCommit commitType) {</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+  if (m_dbFolderInfo &amp;&amp; m_readSet) {</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+    // let's write out our idea of the read set so we can compare it with that</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+    // of the .rc file next time we start up.</span>
<a href="#l17.75"></a><span id="l17.75">     nsCString readSet;</span>
<a href="#l17.76"></a><span id="l17.76">     m_readSet-&gt;Output(getter_Copies(readSet));</span>
<a href="#l17.77"></a><span id="l17.77">     m_dbFolderInfo-&gt;SetCharProperty(&quot;readSet&quot;, readSet);</span>
<a href="#l17.78"></a><span id="l17.78">   }</span>
<a href="#l17.79"></a><span id="l17.79">   return nsMsgDatabase::Commit(commitType);</span>
<a href="#l17.80"></a><span id="l17.80"> }</span>
<a href="#l17.81"></a><span id="l17.81"> </span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+uint32_t nsNewsDatabase::GetCurVersion() { return kMsgDBVersion; }</span>
<a href="#l17.83"></a><span id="l17.83"> </span>
<a href="#l17.84"></a><span id="l17.84" class="difflineminus">-uint32_t nsNewsDatabase::GetCurVersion()</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineminus">-{</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineminus">-  return kMsgDBVersion;</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineminus">-}</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineminus">-NS_IMETHODIMP nsNewsDatabase::IsRead(nsMsgKey key, bool *pRead)</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineminus">-{</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+NS_IMETHODIMP nsNewsDatabase::IsRead(nsMsgKey key, bool *pRead) {</span>
<a href="#l17.92"></a><span id="l17.92">   NS_ASSERTION(pRead, &quot;null out param in IsRead&quot;);</span>
<a href="#l17.93"></a><span id="l17.93">   if (!pRead) return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.94"></a><span id="l17.94"> </span>
<a href="#l17.95"></a><span id="l17.95">   if (!m_readSet) return NS_ERROR_FAILURE;</span>
<a href="#l17.96"></a><span id="l17.96"> </span>
<a href="#l17.97"></a><span id="l17.97">   *pRead = m_readSet-&gt;IsMember(key);</span>
<a href="#l17.98"></a><span id="l17.98">   return NS_OK;</span>
<a href="#l17.99"></a><span id="l17.99"> }</span>
<a href="#l17.100"></a><span id="l17.100"> </span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-nsresult nsNewsDatabase::IsHeaderRead(nsIMsgDBHdr *msgHdr, bool *pRead)</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-{</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-    nsresult rv;</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-    nsMsgKey messageKey;</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+nsresult nsNewsDatabase::IsHeaderRead(nsIMsgDBHdr *msgHdr, bool *pRead) {</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+  nsresult rv;</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+  nsMsgKey messageKey;</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+  if (!msgHdr || !pRead) return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.110"></a><span id="l17.110"> </span>
<a href="#l17.111"></a><span id="l17.111" class="difflineminus">-    if (!msgHdr || !pRead) return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+  rv = msgHdr-&gt;GetMessageKey(&amp;messageKey);</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l17.114"></a><span id="l17.114"> </span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-    rv = msgHdr-&gt;GetMessageKey(&amp;messageKey);</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineminus">-</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineminus">-    rv = IsRead(messageKey,pRead);</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineminus">-    return rv;</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+  rv = IsRead(messageKey, pRead);</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+  return rv;</span>
<a href="#l17.122"></a><span id="l17.122"> }</span>
<a href="#l17.123"></a><span id="l17.123"> </span>
<a href="#l17.124"></a><span id="l17.124"> // return highest article number we've seen.</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineminus">-NS_IMETHODIMP nsNewsDatabase::GetHighWaterArticleNum(nsMsgKey *key)</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineminus">-{</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineplus">+NS_IMETHODIMP nsNewsDatabase::GetHighWaterArticleNum(nsMsgKey *key) {</span>
<a href="#l17.128"></a><span id="l17.128">   NS_ASSERTION(m_dbFolderInfo, &quot;null db folder info&quot;);</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineminus">-  if (!m_dbFolderInfo)</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineplus">+  if (!m_dbFolderInfo) return NS_ERROR_FAILURE;</span>
<a href="#l17.132"></a><span id="l17.132">   return m_dbFolderInfo-&gt;GetHighWater(key);</span>
<a href="#l17.133"></a><span id="l17.133"> }</span>
<a href="#l17.134"></a><span id="l17.134"> </span>
<a href="#l17.135"></a><span id="l17.135"> // return the key of the first article number we know about.</span>
<a href="#l17.136"></a><span id="l17.136"> // Since the iterator iterates in id order, we can just grab the</span>
<a href="#l17.137"></a><span id="l17.137"> // messagekey of the first header it returns.</span>
<a href="#l17.138"></a><span id="l17.138"> // ### dmb</span>
<a href="#l17.139"></a><span id="l17.139"> // This will not deal with the situation where we get holes in</span>
<a href="#l17.140"></a><span id="l17.140"> // the headers we know about. Need to figure out how and when</span>
<a href="#l17.141"></a><span id="l17.141"> // to solve that. This could happen if a transfer is interrupted.</span>
<a href="#l17.142"></a><span id="l17.142"> // Do we need to keep track of known arts permanently?</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineminus">-NS_IMETHODIMP nsNewsDatabase::GetLowWaterArticleNum(nsMsgKey *key)</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineminus">-{</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineminus">-  nsresult  rv;</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineminus">-  nsMsgHdr  *pHeader;</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+NS_IMETHODIMP nsNewsDatabase::GetLowWaterArticleNum(nsMsgKey *key) {</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineplus">+  nsresult rv;</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineplus">+  nsMsgHdr *pHeader;</span>
<a href="#l17.150"></a><span id="l17.150"> </span>
<a href="#l17.151"></a><span id="l17.151">   nsCOMPtr&lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l17.152"></a><span id="l17.152">   rv = EnumerateMessages(getter_AddRefs(hdrs));</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineminus">-    return rv;</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l17.156"></a><span id="l17.156"> </span>
<a href="#l17.157"></a><span id="l17.157" class="difflineminus">-  rv = hdrs-&gt;GetNext((nsISupports**)&amp;pHeader);</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+  rv = hdrs-&gt;GetNext((nsISupports **)&amp;pHeader);</span>
<a href="#l17.159"></a><span id="l17.159">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;nsMsgDBEnumerator broken&quot;);</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineminus">-    return rv;</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l17.163"></a><span id="l17.163"> </span>
<a href="#l17.164"></a><span id="l17.164">   return pHeader-&gt;GetMessageKey(key);</span>
<a href="#l17.165"></a><span id="l17.165"> }</span>
<a href="#l17.166"></a><span id="l17.166"> </span>
<a href="#l17.167"></a><span id="l17.167" class="difflineminus">-nsresult  nsNewsDatabase::ExpireUpTo(nsMsgKey expireKey)</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineminus">-{</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineplus">+nsresult nsNewsDatabase::ExpireUpTo(nsMsgKey expireKey) {</span>
<a href="#l17.170"></a><span id="l17.170">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l17.171"></a><span id="l17.171"> }</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineminus">-nsresult nsNewsDatabase::ExpireRange(nsMsgKey startRange, nsMsgKey endRange)</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineminus">-{</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineplus">+nsresult nsNewsDatabase::ExpireRange(nsMsgKey startRange, nsMsgKey endRange) {</span>
<a href="#l17.175"></a><span id="l17.175">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l17.176"></a><span id="l17.176"> }</span>
<a href="#l17.177"></a><span id="l17.177"> </span>
<a href="#l17.178"></a><span id="l17.178" class="difflineminus">-</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineminus">-NS_IMETHODIMP nsNewsDatabase::GetReadSet(nsMsgKeySet **pSet)</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineminus">-{</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineminus">-    if (!pSet) return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineminus">-    *pSet = m_readSet;</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineplus">+NS_IMETHODIMP nsNewsDatabase::GetReadSet(nsMsgKeySet **pSet) {</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineplus">+  if (!pSet) return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineplus">+  *pSet = m_readSet;</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineplus">+  return NS_OK;</span>
<a href="#l17.188"></a><span id="l17.188"> }</span>
<a href="#l17.189"></a><span id="l17.189"> </span>
<a href="#l17.190"></a><span id="l17.190" class="difflineminus">-NS_IMETHODIMP nsNewsDatabase::SetReadSet(nsMsgKeySet *pSet)</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineminus">-{</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineplus">+NS_IMETHODIMP nsNewsDatabase::SetReadSet(nsMsgKeySet *pSet) {</span>
<a href="#l17.193"></a><span id="l17.193">   m_readSet = pSet;</span>
<a href="#l17.194"></a><span id="l17.194"> </span>
<a href="#l17.195"></a><span id="l17.195" class="difflineminus">-  if (m_readSet)</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineminus">-  {</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineplus">+  if (m_readSet) {</span>
<a href="#l17.198"></a><span id="l17.198">     // compare this read set with the one in the db folder info.</span>
<a href="#l17.199"></a><span id="l17.199">     // If not equivalent, sync with this one.</span>
<a href="#l17.200"></a><span id="l17.200">     nsCString dbReadSet;</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineminus">-    if (m_dbFolderInfo)</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineminus">-      m_dbFolderInfo-&gt;GetCharProperty(&quot;readSet&quot;, dbReadSet);</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineplus">+    if (m_dbFolderInfo) m_dbFolderInfo-&gt;GetCharProperty(&quot;readSet&quot;, dbReadSet);</span>
<a href="#l17.204"></a><span id="l17.204">     nsCString newsrcReadSet;</span>
<a href="#l17.205"></a><span id="l17.205">     m_readSet-&gt;Output(getter_Copies(newsrcReadSet));</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineminus">-    if (!dbReadSet.Equals(newsrcReadSet))</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineminus">-      SyncWithReadSet();</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineplus">+    if (!dbReadSet.Equals(newsrcReadSet)) SyncWithReadSet();</span>
<a href="#l17.209"></a><span id="l17.209">   }</span>
<a href="#l17.210"></a><span id="l17.210">   return NS_OK;</span>
<a href="#l17.211"></a><span id="l17.211"> }</span>
<a href="#l17.212"></a><span id="l17.212"> </span>
<a href="#l17.213"></a><span id="l17.213" class="difflineplus">+bool nsNewsDatabase::SetHdrReadFlag(nsIMsgDBHdr *msgHdr, bool bRead) {</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineplus">+  nsresult rv;</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineplus">+  bool isRead;</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineplus">+  rv = IsHeaderRead(msgHdr, &amp;isRead);</span>
<a href="#l17.217"></a><span id="l17.217"> </span>
<a href="#l17.218"></a><span id="l17.218" class="difflineminus">-bool nsNewsDatabase::SetHdrReadFlag(nsIMsgDBHdr *msgHdr, bool bRead)</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineminus">-{</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineminus">-    nsresult rv;</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineminus">-    bool isRead;</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineminus">-    rv = IsHeaderRead(msgHdr, &amp;isRead);</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineplus">+  if (isRead == bRead) {</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineplus">+    // give the base class a chance to update m_flags.</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineplus">+    nsMsgDatabase::SetHdrReadFlag(msgHdr, bRead);</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineplus">+    return false;</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineplus">+  } else {</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineplus">+    nsMsgKey messageKey;</span>
<a href="#l17.229"></a><span id="l17.229"> </span>
<a href="#l17.230"></a><span id="l17.230" class="difflineminus">-    if (isRead == bRead)</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineminus">-    {</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineminus">-      // give the base class a chance to update m_flags.</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineminus">-      nsMsgDatabase::SetHdrReadFlag(msgHdr, bRead);</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineminus">-      return false;</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineminus">-    }</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineminus">-    else {</span>
<a href="#l17.237"></a><span id="l17.237" class="difflineminus">-      nsMsgKey messageKey;</span>
<a href="#l17.238"></a><span id="l17.238" class="difflineplus">+    // give the base class a chance to update m_flags.</span>
<a href="#l17.239"></a><span id="l17.239" class="difflineplus">+    nsMsgDatabase::SetHdrReadFlag(msgHdr, bRead);</span>
<a href="#l17.240"></a><span id="l17.240" class="difflineplus">+    rv = msgHdr-&gt;GetMessageKey(&amp;messageKey);</span>
<a href="#l17.241"></a><span id="l17.241" class="difflineplus">+    if (NS_FAILED(rv)) return false;</span>
<a href="#l17.242"></a><span id="l17.242"> </span>
<a href="#l17.243"></a><span id="l17.243" class="difflineminus">-      // give the base class a chance to update m_flags.</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineminus">-      nsMsgDatabase::SetHdrReadFlag(msgHdr, bRead);</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineminus">-      rv = msgHdr-&gt;GetMessageKey(&amp;messageKey);</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineminus">-      if (NS_FAILED(rv)) return false;</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineplus">+    NS_ASSERTION(m_readSet, &quot;m_readSet is null&quot;);</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineplus">+    if (!m_readSet) return false;</span>
<a href="#l17.249"></a><span id="l17.249"> </span>
<a href="#l17.250"></a><span id="l17.250" class="difflineminus">-      NS_ASSERTION(m_readSet, &quot;m_readSet is null&quot;);</span>
<a href="#l17.251"></a><span id="l17.251" class="difflineminus">-      if (!m_readSet) return false;</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineminus">-</span>
<a href="#l17.253"></a><span id="l17.253" class="difflineminus">-      if (!bRead) {</span>
<a href="#l17.254"></a><span id="l17.254" class="difflineplus">+    if (!bRead) {</span>
<a href="#l17.255"></a><span id="l17.255"> #ifdef DEBUG_NEWS_DATABASE</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineminus">-        printf(&quot;remove %d from the set\n&quot;,messageKey);</span>
<a href="#l17.257"></a><span id="l17.257" class="difflineplus">+      printf(&quot;remove %d from the set\n&quot;, messageKey);</span>
<a href="#l17.258"></a><span id="l17.258"> #endif</span>
<a href="#l17.259"></a><span id="l17.259"> </span>
<a href="#l17.260"></a><span id="l17.260" class="difflineminus">-        m_readSet-&gt;Remove(messageKey);</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineplus">+      m_readSet-&gt;Remove(messageKey);</span>
<a href="#l17.262"></a><span id="l17.262"> </span>
<a href="#l17.263"></a><span id="l17.263" class="difflineminus">-        rv = NotifyReadChanged(nullptr);</span>
<a href="#l17.264"></a><span id="l17.264" class="difflineminus">-        if (NS_FAILED(rv)) return false;</span>
<a href="#l17.265"></a><span id="l17.265" class="difflineminus">-      }</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineminus">-      else {</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineplus">+      rv = NotifyReadChanged(nullptr);</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineplus">+      if (NS_FAILED(rv)) return false;</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineplus">+    } else {</span>
<a href="#l17.270"></a><span id="l17.270"> #ifdef DEBUG_NEWS_DATABASE</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineminus">-        printf(&quot;add %d to the set\n&quot;,messageKey);</span>
<a href="#l17.272"></a><span id="l17.272" class="difflineplus">+      printf(&quot;add %d to the set\n&quot;, messageKey);</span>
<a href="#l17.273"></a><span id="l17.273"> #endif</span>
<a href="#l17.274"></a><span id="l17.274"> </span>
<a href="#l17.275"></a><span id="l17.275" class="difflineminus">-        if (m_readSet-&gt;Add(messageKey) &lt; 0) return false;</span>
<a href="#l17.276"></a><span id="l17.276" class="difflineplus">+      if (m_readSet-&gt;Add(messageKey) &lt; 0) return false;</span>
<a href="#l17.277"></a><span id="l17.277"> </span>
<a href="#l17.278"></a><span id="l17.278" class="difflineminus">-        rv = NotifyReadChanged(nullptr);</span>
<a href="#l17.279"></a><span id="l17.279" class="difflineminus">-        if (NS_FAILED(rv)) return false;</span>
<a href="#l17.280"></a><span id="l17.280" class="difflineminus">-      }</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineplus">+      rv = NotifyReadChanged(nullptr);</span>
<a href="#l17.282"></a><span id="l17.282" class="difflineplus">+      if (NS_FAILED(rv)) return false;</span>
<a href="#l17.283"></a><span id="l17.283">     }</span>
<a href="#l17.284"></a><span id="l17.284" class="difflineminus">-    return true;</span>
<a href="#l17.285"></a><span id="l17.285" class="difflineplus">+  }</span>
<a href="#l17.286"></a><span id="l17.286" class="difflineplus">+  return true;</span>
<a href="#l17.287"></a><span id="l17.287"> }</span>
<a href="#l17.288"></a><span id="l17.288"> </span>
<a href="#l17.289"></a><span id="l17.289"> NS_IMETHODIMP nsNewsDatabase::MarkAllRead(uint32_t *aNumMarked,</span>
<a href="#l17.290"></a><span id="l17.290" class="difflineminus">-                                          nsMsgKey **aThoseMarked)</span>
<a href="#l17.291"></a><span id="l17.291" class="difflineminus">-{</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineplus">+                                          nsMsgKey **aThoseMarked) {</span>
<a href="#l17.293"></a><span id="l17.293">   nsMsgKey lowWater = nsMsgKey_None, highWater;</span>
<a href="#l17.294"></a><span id="l17.294">   nsCString knownArts;</span>
<a href="#l17.295"></a><span id="l17.295" class="difflineminus">-  if (m_dbFolderInfo)</span>
<a href="#l17.296"></a><span id="l17.296" class="difflineminus">-  {</span>
<a href="#l17.297"></a><span id="l17.297" class="difflineplus">+  if (m_dbFolderInfo) {</span>
<a href="#l17.298"></a><span id="l17.298">     m_dbFolderInfo-&gt;GetKnownArtsSet(getter_Copies(knownArts));</span>
<a href="#l17.299"></a><span id="l17.299">     nsMsgKeySet *knownKeys = nsMsgKeySet::Create(knownArts.get());</span>
<a href="#l17.300"></a><span id="l17.300" class="difflineminus">-    if (knownKeys)</span>
<a href="#l17.301"></a><span id="l17.301" class="difflineminus">-      lowWater = knownKeys-&gt;GetFirstMember();</span>
<a href="#l17.302"></a><span id="l17.302" class="difflineplus">+    if (knownKeys) lowWater = knownKeys-&gt;GetFirstMember();</span>
<a href="#l17.303"></a><span id="l17.303"> </span>
<a href="#l17.304"></a><span id="l17.304">     delete knownKeys;</span>
<a href="#l17.305"></a><span id="l17.305">   }</span>
<a href="#l17.306"></a><span id="l17.306" class="difflineminus">-  if (lowWater == nsMsgKey_None)</span>
<a href="#l17.307"></a><span id="l17.307" class="difflineminus">-    GetLowWaterArticleNum(&amp;lowWater);</span>
<a href="#l17.308"></a><span id="l17.308" class="difflineplus">+  if (lowWater == nsMsgKey_None) GetLowWaterArticleNum(&amp;lowWater);</span>
<a href="#l17.309"></a><span id="l17.309">   GetHighWaterArticleNum(&amp;highWater);</span>
<a href="#l17.310"></a><span id="l17.310" class="difflineminus">-  if (lowWater &gt; 2)</span>
<a href="#l17.311"></a><span id="l17.311" class="difflineminus">-    m_readSet-&gt;AddRange(1, lowWater - 1);</span>
<a href="#l17.312"></a><span id="l17.312" class="difflineplus">+  if (lowWater &gt; 2) m_readSet-&gt;AddRange(1, lowWater - 1);</span>
<a href="#l17.313"></a><span id="l17.313">   nsresult err = nsMsgDatabase::MarkAllRead(aNumMarked, aThoseMarked);</span>
<a href="#l17.314"></a><span id="l17.314">   if (NS_SUCCEEDED(err) &amp;&amp; 1 &lt;= highWater)</span>
<a href="#l17.315"></a><span id="l17.315" class="difflineminus">-    m_readSet-&gt;AddRange(1, highWater); // mark everything read in newsrc.</span>
<a href="#l17.316"></a><span id="l17.316" class="difflineplus">+    m_readSet-&gt;AddRange(1, highWater);  // mark everything read in newsrc.</span>
<a href="#l17.317"></a><span id="l17.317"> </span>
<a href="#l17.318"></a><span id="l17.318">   return err;</span>
<a href="#l17.319"></a><span id="l17.319"> }</span>
<a href="#l17.320"></a><span id="l17.320"> </span>
<a href="#l17.321"></a><span id="l17.321" class="difflineminus">-nsresult nsNewsDatabase::SyncWithReadSet()</span>
<a href="#l17.322"></a><span id="l17.322" class="difflineminus">-{</span>
<a href="#l17.323"></a><span id="l17.323" class="difflineminus">-</span>
<a href="#l17.324"></a><span id="l17.324" class="difflineplus">+nsresult nsNewsDatabase::SyncWithReadSet() {</span>
<a href="#l17.325"></a><span id="l17.325">   // The code below attempts to update the underlying nsMsgDatabase's idea</span>
<a href="#l17.326"></a><span id="l17.326">   // of read/unread flags to match the read set in the .newsrc file. It should</span>
<a href="#l17.327"></a><span id="l17.327">   // only be called when they don't match, e.g., we crashed after committing the</span>
<a href="#l17.328"></a><span id="l17.328">   // db but before writing out the .newsrc</span>
<a href="#l17.329"></a><span id="l17.329" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l17.330"></a><span id="l17.330" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; hdrs;</span>
<a href="#l17.331"></a><span id="l17.331">   nsresult rv = EnumerateMessages(getter_AddRefs(hdrs));</span>
<a href="#l17.332"></a><span id="l17.332">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.333"></a><span id="l17.333"> </span>
<a href="#l17.334"></a><span id="l17.334">   bool hasMore = false, readInNewsrc, isReadInDB, changed = false;</span>
<a href="#l17.335"></a><span id="l17.335">   int32_t numMessages = 0, numUnreadMessages = 0;</span>
<a href="#l17.336"></a><span id="l17.336">   nsMsgKey messageKey;</span>
<a href="#l17.337"></a><span id="l17.337" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l17.338"></a><span id="l17.338" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l17.339"></a><span id="l17.339"> </span>
<a href="#l17.340"></a><span id="l17.340">   // Scan all messages in DB</span>
<a href="#l17.341"></a><span id="l17.341" class="difflineminus">-  while (NS_SUCCEEDED(rv = hdrs-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l17.342"></a><span id="l17.342" class="difflineminus">-  {</span>
<a href="#l17.343"></a><span id="l17.343" class="difflineminus">-      nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l17.344"></a><span id="l17.344" class="difflineminus">-      rv = hdrs-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l17.345"></a><span id="l17.345" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.346"></a><span id="l17.346" class="difflineplus">+  while (NS_SUCCEEDED(rv = hdrs-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l17.347"></a><span id="l17.347" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l17.348"></a><span id="l17.348" class="difflineplus">+    rv = hdrs-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l17.349"></a><span id="l17.349" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.350"></a><span id="l17.350"> </span>
<a href="#l17.351"></a><span id="l17.351" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; header = do_QueryInterface(supports, &amp;rv);</span>
<a href="#l17.352"></a><span id="l17.352" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.353"></a><span id="l17.353" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; header = do_QueryInterface(supports, &amp;rv);</span>
<a href="#l17.354"></a><span id="l17.354" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.355"></a><span id="l17.355"> </span>
<a href="#l17.356"></a><span id="l17.356" class="difflineminus">-      rv = nsMsgDatabase::IsHeaderRead(header, &amp;isReadInDB);</span>
<a href="#l17.357"></a><span id="l17.357" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.358"></a><span id="l17.358" class="difflineplus">+    rv = nsMsgDatabase::IsHeaderRead(header, &amp;isReadInDB);</span>
<a href="#l17.359"></a><span id="l17.359" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.360"></a><span id="l17.360"> </span>
<a href="#l17.361"></a><span id="l17.361" class="difflineminus">-      header-&gt;GetMessageKey(&amp;messageKey);</span>
<a href="#l17.362"></a><span id="l17.362" class="difflineminus">-      IsRead(messageKey,&amp;readInNewsrc);</span>
<a href="#l17.363"></a><span id="l17.363" class="difflineplus">+    header-&gt;GetMessageKey(&amp;messageKey);</span>
<a href="#l17.364"></a><span id="l17.364" class="difflineplus">+    IsRead(messageKey, &amp;readInNewsrc);</span>
<a href="#l17.365"></a><span id="l17.365"> </span>
<a href="#l17.366"></a><span id="l17.366" class="difflineminus">-      numMessages++;</span>
<a href="#l17.367"></a><span id="l17.367" class="difflineminus">-      if (!readInNewsrc)</span>
<a href="#l17.368"></a><span id="l17.368" class="difflineminus">-        numUnreadMessages++;</span>
<a href="#l17.369"></a><span id="l17.369" class="difflineplus">+    numMessages++;</span>
<a href="#l17.370"></a><span id="l17.370" class="difflineplus">+    if (!readInNewsrc) numUnreadMessages++;</span>
<a href="#l17.371"></a><span id="l17.371"> </span>
<a href="#l17.372"></a><span id="l17.372" class="difflineminus">-      // If DB and readSet disagree on Read/Unread, fix DB</span>
<a href="#l17.373"></a><span id="l17.373" class="difflineminus">-      if (readInNewsrc!=isReadInDB)</span>
<a href="#l17.374"></a><span id="l17.374" class="difflineminus">-      {</span>
<a href="#l17.375"></a><span id="l17.375" class="difflineminus">-        MarkHdrRead(header, readInNewsrc, nullptr);</span>
<a href="#l17.376"></a><span id="l17.376" class="difflineminus">-        changed = true;</span>
<a href="#l17.377"></a><span id="l17.377" class="difflineminus">-      }</span>
<a href="#l17.378"></a><span id="l17.378" class="difflineplus">+    // If DB and readSet disagree on Read/Unread, fix DB</span>
<a href="#l17.379"></a><span id="l17.379" class="difflineplus">+    if (readInNewsrc != isReadInDB) {</span>
<a href="#l17.380"></a><span id="l17.380" class="difflineplus">+      MarkHdrRead(header, readInNewsrc, nullptr);</span>
<a href="#l17.381"></a><span id="l17.381" class="difflineplus">+      changed = true;</span>
<a href="#l17.382"></a><span id="l17.382" class="difflineplus">+    }</span>
<a href="#l17.383"></a><span id="l17.383">   }</span>
<a href="#l17.384"></a><span id="l17.384"> </span>
<a href="#l17.385"></a><span id="l17.385">   // Update FolderInfo Counters</span>
<a href="#l17.386"></a><span id="l17.386">   int32_t oldMessages, oldUnreadMessages;</span>
<a href="#l17.387"></a><span id="l17.387">   rv = m_dbFolderInfo-&gt;GetNumMessages(&amp;oldMessages);</span>
<a href="#l17.388"></a><span id="l17.388" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; oldMessages!=numMessages)</span>
<a href="#l17.389"></a><span id="l17.389" class="difflineminus">-  {</span>
<a href="#l17.390"></a><span id="l17.390" class="difflineminus">-      changed = true;</span>
<a href="#l17.391"></a><span id="l17.391" class="difflineminus">-      m_dbFolderInfo-&gt;ChangeNumMessages(numMessages-oldMessages);</span>
<a href="#l17.392"></a><span id="l17.392" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; oldMessages != numMessages) {</span>
<a href="#l17.393"></a><span id="l17.393" class="difflineplus">+    changed = true;</span>
<a href="#l17.394"></a><span id="l17.394" class="difflineplus">+    m_dbFolderInfo-&gt;ChangeNumMessages(numMessages - oldMessages);</span>
<a href="#l17.395"></a><span id="l17.395">   }</span>
<a href="#l17.396"></a><span id="l17.396">   rv = m_dbFolderInfo-&gt;GetNumUnreadMessages(&amp;oldUnreadMessages);</span>
<a href="#l17.397"></a><span id="l17.397" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; oldUnreadMessages!=numUnreadMessages)</span>
<a href="#l17.398"></a><span id="l17.398" class="difflineminus">-  {</span>
<a href="#l17.399"></a><span id="l17.399" class="difflineminus">-      changed = true;</span>
<a href="#l17.400"></a><span id="l17.400" class="difflineminus">-      m_dbFolderInfo-&gt;ChangeNumUnreadMessages(numUnreadMessages-oldUnreadMessages);</span>
<a href="#l17.401"></a><span id="l17.401" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; oldUnreadMessages != numUnreadMessages) {</span>
<a href="#l17.402"></a><span id="l17.402" class="difflineplus">+    changed = true;</span>
<a href="#l17.403"></a><span id="l17.403" class="difflineplus">+    m_dbFolderInfo-&gt;ChangeNumUnreadMessages(numUnreadMessages -</span>
<a href="#l17.404"></a><span id="l17.404" class="difflineplus">+                                            oldUnreadMessages);</span>
<a href="#l17.405"></a><span id="l17.405">   }</span>
<a href="#l17.406"></a><span id="l17.406"> </span>
<a href="#l17.407"></a><span id="l17.407" class="difflineminus">-  if (changed)</span>
<a href="#l17.408"></a><span id="l17.408" class="difflineminus">-      Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l17.409"></a><span id="l17.409" class="difflineplus">+  if (changed) Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l17.410"></a><span id="l17.410"> </span>
<a href="#l17.411"></a><span id="l17.411">   return rv;</span>
<a href="#l17.412"></a><span id="l17.412"> }</span>
<a href="#l17.413"></a><span id="l17.413"> </span>
<a href="#l17.414"></a><span id="l17.414" class="difflineminus">-nsresult nsNewsDatabase::AdjustExpungedBytesOnDelete(nsIMsgDBHdr *msgHdr)</span>
<a href="#l17.415"></a><span id="l17.415" class="difflineminus">-{</span>
<a href="#l17.416"></a><span id="l17.416" class="difflineplus">+nsresult nsNewsDatabase::AdjustExpungedBytesOnDelete(nsIMsgDBHdr *msgHdr) {</span>
<a href="#l17.417"></a><span id="l17.417">   uint32_t msgFlags;</span>
<a href="#l17.418"></a><span id="l17.418">   msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l17.419"></a><span id="l17.419" class="difflineminus">-  if (msgFlags &amp; nsMsgMessageFlags::Offline &amp;&amp; m_dbFolderInfo)</span>
<a href="#l17.420"></a><span id="l17.420" class="difflineminus">-  {</span>
<a href="#l17.421"></a><span id="l17.421" class="difflineplus">+  if (msgFlags &amp; nsMsgMessageFlags::Offline &amp;&amp; m_dbFolderInfo) {</span>
<a href="#l17.422"></a><span id="l17.422">     uint32_t size = 0;</span>
<a href="#l17.423"></a><span id="l17.423">     (void)msgHdr-&gt;GetOfflineMessageSize(&amp;size);</span>
<a href="#l17.424"></a><span id="l17.424" class="difflineminus">-    return m_dbFolderInfo-&gt;ChangeExpungedBytes (size);</span>
<a href="#l17.425"></a><span id="l17.425" class="difflineplus">+    return m_dbFolderInfo-&gt;ChangeExpungedBytes(size);</span>
<a href="#l17.426"></a><span id="l17.426">   }</span>
<a href="#l17.427"></a><span id="l17.427">   return NS_OK;</span>
<a href="#l17.428"></a><span id="l17.428"> }</span>
<a href="#l17.429"></a><span id="l17.429"> </span>
<a href="#l17.430"></a><span id="l17.430"> NS_IMETHODIMP</span>
<a href="#l17.431"></a><span id="l17.431" class="difflineminus">-nsNewsDatabase::GetDefaultViewFlags(nsMsgViewFlagsTypeValue *aDefaultViewFlags)</span>
<a href="#l17.432"></a><span id="l17.432" class="difflineminus">-{</span>
<a href="#l17.433"></a><span id="l17.433" class="difflineplus">+nsNewsDatabase::GetDefaultViewFlags(</span>
<a href="#l17.434"></a><span id="l17.434" class="difflineplus">+    nsMsgViewFlagsTypeValue *aDefaultViewFlags) {</span>
<a href="#l17.435"></a><span id="l17.435">   NS_ENSURE_ARG_POINTER(aDefaultViewFlags);</span>
<a href="#l17.436"></a><span id="l17.436">   GetIntPref(&quot;mailnews.default_news_view_flags&quot;, aDefaultViewFlags);</span>
<a href="#l17.437"></a><span id="l17.437">   if (*aDefaultViewFlags &lt; nsMsgViewFlagsType::kNone ||</span>
<a href="#l17.438"></a><span id="l17.438" class="difflineminus">-      *aDefaultViewFlags &gt; (nsMsgViewFlagsType::kThreadedDisplay |</span>
<a href="#l17.439"></a><span id="l17.439" class="difflineminus">-                            nsMsgViewFlagsType::kShowIgnored |</span>
<a href="#l17.440"></a><span id="l17.440" class="difflineminus">-                            nsMsgViewFlagsType::kUnreadOnly |</span>
<a href="#l17.441"></a><span id="l17.441" class="difflineminus">-                            nsMsgViewFlagsType::kExpandAll |</span>
<a href="#l17.442"></a><span id="l17.442" class="difflineminus">-                            nsMsgViewFlagsType::kGroupBySort))</span>
<a href="#l17.443"></a><span id="l17.443" class="difflineplus">+      *aDefaultViewFlags &gt;</span>
<a href="#l17.444"></a><span id="l17.444" class="difflineplus">+          (nsMsgViewFlagsType::kThreadedDisplay |</span>
<a href="#l17.445"></a><span id="l17.445" class="difflineplus">+           nsMsgViewFlagsType::kShowIgnored | nsMsgViewFlagsType::kUnreadOnly |</span>
<a href="#l17.446"></a><span id="l17.446" class="difflineplus">+           nsMsgViewFlagsType::kExpandAll | nsMsgViewFlagsType::kGroupBySort))</span>
<a href="#l17.447"></a><span id="l17.447">     *aDefaultViewFlags = nsMsgViewFlagsType::kThreadedDisplay;</span>
<a href="#l17.448"></a><span id="l17.448">   return NS_OK;</span>
<a href="#l17.449"></a><span id="l17.449"> }</span>
<a href="#l17.450"></a><span id="l17.450"> </span>
<a href="#l17.451"></a><span id="l17.451"> NS_IMETHODIMP</span>
<a href="#l17.452"></a><span id="l17.452" class="difflineminus">-nsNewsDatabase::GetDefaultSortType(nsMsgViewSortTypeValue *aDefaultSortType)</span>
<a href="#l17.453"></a><span id="l17.453" class="difflineminus">-{</span>
<a href="#l17.454"></a><span id="l17.454" class="difflineplus">+nsNewsDatabase::GetDefaultSortType(nsMsgViewSortTypeValue *aDefaultSortType) {</span>
<a href="#l17.455"></a><span id="l17.455">   NS_ENSURE_ARG_POINTER(aDefaultSortType);</span>
<a href="#l17.456"></a><span id="l17.456">   GetIntPref(&quot;mailnews.default_news_sort_type&quot;, aDefaultSortType);</span>
<a href="#l17.457"></a><span id="l17.457">   if (*aDefaultSortType &lt; nsMsgViewSortType::byDate ||</span>
<a href="#l17.458"></a><span id="l17.458">       *aDefaultSortType &gt; nsMsgViewSortType::byAccount)</span>
<a href="#l17.459"></a><span id="l17.459">     *aDefaultSortType = nsMsgViewSortType::byThread;</span>
<a href="#l17.460"></a><span id="l17.460">   return NS_OK;</span>
<a href="#l17.461"></a><span id="l17.461"> }</span>
<a href="#l17.462"></a><span id="l17.462"> </span>
<a href="#l17.463"></a><span id="l17.463"> NS_IMETHODIMP</span>
<a href="#l17.464"></a><span id="l17.464" class="difflineminus">-nsNewsDatabase::GetDefaultSortOrder(nsMsgViewSortOrderValue *aDefaultSortOrder)</span>
<a href="#l17.465"></a><span id="l17.465" class="difflineminus">-{</span>
<a href="#l17.466"></a><span id="l17.466" class="difflineplus">+nsNewsDatabase::GetDefaultSortOrder(</span>
<a href="#l17.467"></a><span id="l17.467" class="difflineplus">+    nsMsgViewSortOrderValue *aDefaultSortOrder) {</span>
<a href="#l17.468"></a><span id="l17.468">   NS_ENSURE_ARG_POINTER(aDefaultSortOrder);</span>
<a href="#l17.469"></a><span id="l17.469">   GetIntPref(&quot;mailnews.default_news_sort_order&quot;, aDefaultSortOrder);</span>
<a href="#l17.470"></a><span id="l17.470">   if (*aDefaultSortOrder != nsMsgViewSortOrder::descending)</span>
<a href="#l17.471"></a><span id="l17.471">     *aDefaultSortOrder = nsMsgViewSortOrder::ascending;</span>
<a href="#l17.472"></a><span id="l17.472">   return NS_OK;</span>
<a href="#l17.473"></a><span id="l17.473"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

