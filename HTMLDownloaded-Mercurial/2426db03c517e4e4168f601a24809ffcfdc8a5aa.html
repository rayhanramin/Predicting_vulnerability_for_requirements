<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11682:2426db03c517e4e4168f601a24809ffcfdc8a5aa</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 2426db03c517e4e4168f601a24809ffcfdc8a5aa" />
<meta property="og:url" content="/comm-central/rev/2426db03c517e4e4168f601a24809ffcfdc8a5aa" />
<meta property="og:description" content="Part of Bug 820377 - Deal with removing of EnumerateForwards/Backwards from nsISupportsArray - Replace mailnews accounts interfaces use of nsISupportsArray with nsIArray. r=mconley,r=Fallen,sr=Neil CLOSED TREE" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 2426db03c517e4e4168f601a24809ffcfdc8a5aa 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/2426db03c517e4e4168f601a24809ffcfdc8a5aa">shortlog</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/2426db03c517e4e4168f601a24809ffcfdc8a5aa">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa">files</a> |
changeset |
<a href="/comm-central/raw-rev/2426db03c517e4e4168f601a24809ffcfdc8a5aa">raw</a>  | <a href="/comm-central/archive/2426db03c517e4e4168f601a24809ffcfdc8a5aa.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Part of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=820377">Bug 820377</a> - Deal with removing of EnumerateForwards/Backwards from nsISupportsArray - Replace mailnews accounts interfaces use of nsISupportsArray with nsIArray. r=mconley,r=Fallen,sr=Neil CLOSED TREE
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#114;&#107;&#32;&#66;&#97;&#110;&#110;&#101;&#114;&#32;&#60;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#115;&#116;&#97;&#110;&#100;&#97;&#114;&#100;&#56;&#46;&#112;&#108;&#117;&#115;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 12 Dec 2012 20:01:11 +0000</td></tr>

<tr>
 <td>changeset 11682</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/2426db03c517e4e4168f601a24809ffcfdc8a5aa">2426db03c517e4e4168f601a24809ffcfdc8a5aa</a></td>
</tr>



<tr>
<td>parent 11681</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7b9efef4739130f5116b081d4259d7a5599dc66d">7b9efef4739130f5116b081d4259d7a5599dc66d</a>
</td>
</tr>

<tr>
<td>child 11683</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4d81d27528c214d12bb430d82cf26fea061d350b">4d81d27528c214d12bb430d82cf26fea061d350b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=2426db03c517e4e4168f601a24809ffcfdc8a5aa">8707</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 12 Dec 2012 20:02:22 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@2426db03c517 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2426db03c517e4e4168f601a24809ffcfdc8a5aa">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2426db03c517e4e4168f601a24809ffcfdc8a5aa&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2426db03c517e4e4168f601a24809ffcfdc8a5aa&newProject=comm-central&newRevision=2426db03c517e4e4168f601a24809ffcfdc8a5aa&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2426db03c517e4e4168f601a24809ffcfdc8a5aa&newProject=comm-central&newRevision=2426db03c517e4e4168f601a24809ffcfdc8a5aa&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2426db03c517e4e4168f601a24809ffcfdc8a5aa&newProject=comm-central&newRevision=2426db03c517e4e4168f601a24809ffcfdc8a5aa&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mconley%29&revcount=50">mconley</a>, <a href="/comm-central/log?rev=reviewer%28Fallen%29&revcount=50">Fallen</a>, <a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=820377">820377</a></td></tr>




</table></div>

<div class="page_body description">Part of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=820377">Bug 820377</a> - Deal with removing of EnumerateForwards/Backwards from nsISupportsArray - Replace mailnews accounts interfaces use of nsISupportsArray with nsIArray. r=mconley,r=Fallen,sr=Neil CLOSED TREE</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/modules/calItipUtils.jsm">calendar/base/modules/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/modules/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/modules/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/modules/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/modules/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/modules/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/modules/calProviderUtils.jsm">calendar/base/modules/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/modules/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/modules/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/modules/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/modules/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/modules/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/itip/calItipEmailTransport.js">calendar/itip/calItipEmailTransport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/itip/calItipEmailTransport.js">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/itip/calItipEmailTransport.js">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/itip/calItipEmailTransport.js">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/itip/calItipEmailTransport.js">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/calendar/itip/calItipEmailTransport.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/mailCommands.js">mail/base/content/mailCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/mailCommands.js">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/mailCommands.js">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/mailCommands.js">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/mailCommands.js">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/mailCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/msgHdrViewOverlay.js">mail/base/content/msgHdrViewOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/msgHdrViewOverlay.js">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/msgHdrViewOverlay.js">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/msgHdrViewOverlay.js">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/msgHdrViewOverlay.js">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/base/content/msgHdrViewOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/test/mozmill/multiple-identities/test-display-names.js">mail/test/mozmill/multiple-identities/test-display-names.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/test/mozmill/multiple-identities/test-display-names.js">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/test/mozmill/multiple-identities/test-display-names.js">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/test/mozmill/multiple-identities/test-display-names.js">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/test/mozmill/multiple-identities/test-display-names.js">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mail/test/mozmill/multiple-identities/test-display-names.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/AccountManager.js">mailnews/base/prefs/content/AccountManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/AccountManager.js">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/AccountManager.js">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/AccountManager.js">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/AccountManager.js">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/AccountManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/AccountWizard.js">mailnews/base/prefs/content/AccountWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/AccountWizard.js">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/AccountWizard.js">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/AccountWizard.js">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/AccountWizard.js">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/AccountWizard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/accountUtils.js">mailnews/base/prefs/content/accountUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/accountUtils.js">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/accountUtils.js">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/accountUtils.js">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/accountUtils.js">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/prefs/content/accountUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/public/nsIMsgAccount.idl">mailnews/base/public/nsIMsgAccount.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/public/nsIMsgAccount.idl">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/public/nsIMsgAccount.idl">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/public/nsIMsgAccount.idl">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/public/nsIMsgAccount.idl">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/public/nsIMsgAccount.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/public/nsIMsgAccountManager.idl">mailnews/base/public/nsIMsgAccountManager.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/public/nsIMsgAccountManager.idl">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/public/nsIMsgAccountManager.idl">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/public/nsIMsgAccountManager.idl">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/public/nsIMsgAccountManager.idl">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/public/nsIMsgAccountManager.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccount.cpp">mailnews/base/src/nsMsgAccount.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccount.cpp">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccount.cpp">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccount.cpp">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccount.cpp">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccount.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccount.h">mailnews/base/src/nsMsgAccount.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccount.h">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccount.h">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccount.h">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccount.h">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccount.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManager.cpp">mailnews/base/src/nsMsgAccountManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManager.cpp">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManager.cpp">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManager.cpp">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManager.cpp">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManager.h">mailnews/base/src/nsMsgAccountManager.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManager.h">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManager.h">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManager.h">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManager.h">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManager.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManagerDS.cpp">mailnews/base/src/nsMsgAccountManagerDS.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManagerDS.cpp">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManagerDS.cpp">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManagerDS.cpp">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManagerDS.cpp">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgAccountManagerDS.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgOfflineManager.cpp">mailnews/base/src/nsMsgOfflineManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgOfflineManager.cpp">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgOfflineManager.cpp">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgOfflineManager.cpp">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgOfflineManager.cpp">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsMsgOfflineManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsSpamSettings.cpp">mailnews/base/src/nsSpamSettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsSpamSettings.cpp">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsSpamSettings.cpp">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsSpamSettings.cpp">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsSpamSettings.cpp">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/base/src/nsSpamSettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/compose/src/nsMsgSendLater.cpp">mailnews/compose/src/nsMsgSendLater.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/compose/src/nsMsgSendLater.cpp">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/compose/src/nsMsgSendLater.cpp">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/compose/src/nsMsgSendLater.cpp">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/compose/src/nsMsgSendLater.cpp">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/compose/src/nsMsgSendLater.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/db/gloda/modules/gloda.js">mailnews/db/gloda/modules/gloda.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/db/gloda/modules/gloda.js">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/db/gloda/modules/gloda.js">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/db/gloda/modules/gloda.js">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/db/gloda/modules/gloda.js">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/db/gloda/modules/gloda.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/import/test/unit/resources/import_helper.js">mailnews/import/test/unit/resources/import_helper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/import/test/unit/resources/import_helper.js">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/import/test/unit/resources/import_helper.js">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/import/test/unit/resources/import_helper.js">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/import/test/unit/resources/import_helper.js">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/import/test/unit/resources/import_helper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/mapi/mapihook/src/msgMapiHook.cpp">mailnews/mapi/mapihook/src/msgMapiHook.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/mapi/mapihook/src/msgMapiHook.cpp">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/mapi/mapihook/src/msgMapiHook.cpp">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/mapi/mapihook/src/msgMapiHook.cpp">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/mapi/mapihook/src/msgMapiHook.cpp">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/mapi/mapihook/src/msgMapiHook.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/news/src/nsNNTPProtocol.cpp">mailnews/news/src/nsNNTPProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/news/src/nsNNTPProtocol.cpp">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/news/src/nsNNTPProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/news/src/nsNNTPProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/news/src/nsNNTPProtocol.cpp">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/news/src/nsNNTPProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/news/src/nsNNTPProtocol.h">mailnews/news/src/nsNNTPProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/news/src/nsNNTPProtocol.h">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/news/src/nsNNTPProtocol.h">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/news/src/nsNNTPProtocol.h">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/news/src/nsNNTPProtocol.h">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/mailnews/news/src/nsNNTPProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/compose/MsgComposeCommands.js">suite/mailnews/compose/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/compose/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/compose/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/compose/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/compose/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/compose/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/mailCommands.js">suite/mailnews/mailCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/mailCommands.js">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/mailCommands.js">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/mailCommands.js">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/mailCommands.js">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/mailCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/mailWindowOverlay.js">suite/mailnews/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/2426db03c517e4e4168f601a24809ffcfdc8a5aa/suite/mailnews/mailWindowOverlay.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -313,43 +313,41 @@ cal.itip = {</span>
<a href="#l1.4"></a><span id="l1.4">         let identities;</span>
<a href="#l1.5"></a><span id="l1.5">         let actMgr = MailServices.accounts;</span>
<a href="#l1.6"></a><span id="l1.6">         if (aMsgHdr.accountKey) {</span>
<a href="#l1.7"></a><span id="l1.7">             // First, check if the message has an account key. If so, we can use the</span>
<a href="#l1.8"></a><span id="l1.8">             // account identities to find the correct recipient</span>
<a href="#l1.9"></a><span id="l1.9">             identities = actMgr.getAccount(aMsgHdr.accountKey).identities;</span>
<a href="#l1.10"></a><span id="l1.10">         } else {</span>
<a href="#l1.11"></a><span id="l1.11">             // Without an account key, we have to revert back to using the server</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-            identities = actMgr.GetIdentitiesForServer(aMsgHdr.folder.server);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+            identities = actMgr.getIdentitiesForServer(aMsgHdr.folder.server);</span>
<a href="#l1.14"></a><span id="l1.14">         }</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">         let emailMap = {};</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-        if (identities.Count() == 0) {</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+        if (identities.length == 0) {</span>
<a href="#l1.19"></a><span id="l1.19">             // If we were not able to retrieve identities above, then we have no</span>
<a href="#l1.20"></a><span id="l1.20">             // choice but to revert to the default identity</span>
<a href="#l1.21"></a><span id="l1.21">             let identity = actMgr.defaultAccount.defaultIdentity;</span>
<a href="#l1.22"></a><span id="l1.22">             if (!identity) {</span>
<a href="#l1.23"></a><span id="l1.23">                 // If there isn't a default identity (i.e Local Folders is your</span>
<a href="#l1.24"></a><span id="l1.24">                 // default identity), then go ahead and use the first available</span>
<a href="#l1.25"></a><span id="l1.25">                 // identity.</span>
<a href="#l1.26"></a><span id="l1.26">                 let allIdentities = actMgr.allIdentities;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-                if (allIdentities.Count() &gt; 0) {</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-                    identity = allIdentities.GetElementAt(0)</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-                                            .QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+                if (allIdentities.length &gt; 0) {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+                    identity = allIdentities.queryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l1.32"></a><span id="l1.32">                 } else {</span>
<a href="#l1.33"></a><span id="l1.33">                     // If there are no identities at all, we cannot get a recipient.</span>
<a href="#l1.34"></a><span id="l1.34">                     return null;</span>
<a href="#l1.35"></a><span id="l1.35">                 }</span>
<a href="#l1.36"></a><span id="l1.36">             }</span>
<a href="#l1.37"></a><span id="l1.37">             emailMap[identity.email.toLowerCase()] = true;</span>
<a href="#l1.38"></a><span id="l1.38">         } else {</span>
<a href="#l1.39"></a><span id="l1.39">             // Build a map of usable email addresses</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-            for (let i = 0; i &lt; identities.Count(); i++) {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-                let identity = identities.GetElementAt(i)</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-                                         .QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+            for (let i = 0; i &lt; identities.length; i++) {</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+                let identity = identities.queryElementAt(i, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l1.45"></a><span id="l1.45">                 emailMap[identity.email.toLowerCase()] = true;</span>
<a href="#l1.46"></a><span id="l1.46">             }</span>
<a href="#l1.47"></a><span id="l1.47">         }</span>
<a href="#l1.48"></a><span id="l1.48"> </span>
<a href="#l1.49"></a><span id="l1.49">         let hdrParser = MailServices.headerParser;</span>
<a href="#l1.50"></a><span id="l1.50">         let emails = {};</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52">         // First check the recipient list</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -275,21 +275,20 @@ cal.getEmailIdentityOfCalendar = functio</span>
<a href="#l2.4"></a><span id="l2.4">                 account = accounts.GetElementAt(i);</span>
<a href="#l2.5"></a><span id="l2.5">                 try {</span>
<a href="#l2.6"></a><span id="l2.6">                     account = account.QueryInterface(Components.interfaces.nsIMsgAccount);</span>
<a href="#l2.7"></a><span id="l2.7">                 } catch (exc) {</span>
<a href="#l2.8"></a><span id="l2.8">                     account = null;</span>
<a href="#l2.9"></a><span id="l2.9">                 }</span>
<a href="#l2.10"></a><span id="l2.10">             }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-            if (account &amp;&amp; account.identities.Count()) { // Pick an identity</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+            if (account &amp;&amp; account.identities.length) { // Pick an identity</span>
<a href="#l2.14"></a><span id="l2.14">                 identity = account.defaultIdentity;</span>
<a href="#l2.15"></a><span id="l2.15">                 if (!identity) { // there is no default identity, use the first</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-                    identity = account.identities.GetElementAt(0)</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-                                                 .QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+                    identity = account.identities.queryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l2.19"></a><span id="l2.19">                 }</span>
<a href="#l2.20"></a><span id="l2.20">             } else { // If this account has no identities, continue to the next account.</span>
<a href="#l2.21"></a><span id="l2.21">                 account = null;</span>
<a href="#l2.22"></a><span id="l2.22">             }</span>
<a href="#l2.23"></a><span id="l2.23">         }</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">         if (identity) {</span>
<a href="#l2.26"></a><span id="l2.26">             // If an identity was set above, set the account out parameter</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1737,18 +1737,18 @@ calPropertyBagEnumerator.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">  * Iterates all email identities and calls the passed function with identity and account.</span>
<a href="#l3.5"></a><span id="l3.5">  * If the called function returns false, iteration is stopped.</span>
<a href="#l3.6"></a><span id="l3.6">  */</span>
<a href="#l3.7"></a><span id="l3.7"> function calIterateEmailIdentities(func) {</span>
<a href="#l3.8"></a><span id="l3.8">     var accounts = MailServices.accounts.accounts;</span>
<a href="#l3.9"></a><span id="l3.9">     for (var i = 0; i &lt; accounts.Count(); ++i) {</span>
<a href="#l3.10"></a><span id="l3.10">         var account = accounts.GetElementAt(i).QueryInterface(Components.interfaces.nsIMsgAccount);</span>
<a href="#l3.11"></a><span id="l3.11">         var identities = account.identities;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-        for (var j = 0; j &lt; identities.Count(); ++j) {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-            var identity = identities.GetElementAt(j).QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+        for (var j = 0; j &lt; identities.length; ++j) {</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+            var identity = identities.queryElementAt(j, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l3.16"></a><span id="l3.16">             if (!func(identity, account)) {</span>
<a href="#l3.17"></a><span id="l3.17">                 break;</span>
<a href="#l3.18"></a><span id="l3.18">             }</span>
<a href="#l3.19"></a><span id="l3.19">         }</span>
<a href="#l3.20"></a><span id="l3.20">     }</span>
<a href="#l3.21"></a><span id="l3.21"> }</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/itip/calItipEmailTransport.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/itip/calItipEmailTransport.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -158,19 +158,18 @@ calItipEmailTransport.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4">             this.mDefaultAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l4.5"></a><span id="l4.5">             this.mDefaultIdentity = this.mDefaultAccount.defaultIdentity;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">             if (!this.mDefaultIdentity) {</span>
<a href="#l4.8"></a><span id="l4.8">                 // If there isn't a default identity (i.e Local Folders is your</span>
<a href="#l4.9"></a><span id="l4.9">                 // default identity, then go ahead and use the first available</span>
<a href="#l4.10"></a><span id="l4.10">                 // identity.</span>
<a href="#l4.11"></a><span id="l4.11">                 let allIdentities = MailServices.accounts.allIdentities;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-                if (allIdentities.Count() &gt; 0) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                    this.mDefaultIdentity = allIdentities.GetElementAt(0)</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-                                                         .QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+                if (allIdentities.length &gt; 0) {</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+                    this.mDefaultIdentity = allIdentities.queryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l4.17"></a><span id="l4.17">                 } else {</span>
<a href="#l4.18"></a><span id="l4.18">                     // If there are no identities, then we are in the same</span>
<a href="#l4.19"></a><span id="l4.19">                     // situation as if we didn't have Xpcom Mail.</span>
<a href="#l4.20"></a><span id="l4.20">                     this.mHasXpcomMail = false;</span>
<a href="#l4.21"></a><span id="l4.21">                     cal.LOG(&quot;initEmailService: No XPCOM Mail available: &quot; + e);</span>
<a href="#l4.22"></a><span id="l4.22">                 }</span>
<a href="#l4.23"></a><span id="l4.23">             }</span>
<a href="#l4.24"></a><span id="l4.24">         } catch (ex) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/mailCommands.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/mailCommands.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -7,17 +7,17 @@ Components.utils.import(&quot;resource:///mod</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> /**</span>
<a href="#l5.6"></a><span id="l5.6">  * Get the identity that most likely is the best one to use, given the hint.</span>
<a href="#l5.7"></a><span id="l5.7">  * @param identities nsISupportsArray&lt;nsIMsgIdentity&gt; of identities</span>
<a href="#l5.8"></a><span id="l5.8">  * @param optionalHint string containing comma separated mailboxes</span>
<a href="#l5.9"></a><span id="l5.9">  */</span>
<a href="#l5.10"></a><span id="l5.10"> function getBestIdentity(identities, optionalHint)</span>
<a href="#l5.11"></a><span id="l5.11"> {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  let identityCount = identities.Count();</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  let identityCount = identities.length;</span>
<a href="#l5.14"></a><span id="l5.14">   if (identityCount &lt; 1)</span>
<a href="#l5.15"></a><span id="l5.15">     return null;</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17">   // If we have more than one identity and a hint to help us pick one.</span>
<a href="#l5.18"></a><span id="l5.18">   if (identityCount &gt; 1 &amp;&amp; optionalHint) {</span>
<a href="#l5.19"></a><span id="l5.19">     // Normalize case on the optional hint to improve our chances of</span>
<a href="#l5.20"></a><span id="l5.20">     // finding a match.</span>
<a href="#l5.21"></a><span id="l5.21">     optionalHint = optionalHint.toLowerCase();</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -31,22 +31,22 @@ function getBestIdentity(identities, opt</span>
<a href="#l5.23"></a><span id="l5.23">         if (hints[i].trim() == identity.email.toLowerCase() ||</span>
<a href="#l5.24"></a><span id="l5.24">             hints[i].indexOf(&quot;&lt;&quot; + identity.email.toLowerCase() + &quot;&gt;&quot;) != -1)</span>
<a href="#l5.25"></a><span id="l5.25">           return identity;</span>
<a href="#l5.26"></a><span id="l5.26">       }</span>
<a href="#l5.27"></a><span id="l5.27">     }</span>
<a href="#l5.28"></a><span id="l5.28">   }</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30">   // Still no matches? Give up and pick the first one.</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-  return identities.QueryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  return identities.queryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l5.33"></a><span id="l5.33"> }</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35"> function getIdentityForServer(server, optionalHint)</span>
<a href="#l5.36"></a><span id="l5.36"> {</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-  var identities = accountManager.GetIdentitiesForServer(server);</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+  var identities = accountManager.getIdentitiesForServer(server);</span>
<a href="#l5.39"></a><span id="l5.39">   return getBestIdentity(identities, optionalHint);</span>
<a href="#l5.40"></a><span id="l5.40"> }</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42"> /**</span>
<a href="#l5.43"></a><span id="l5.43">  * Get the identity for the given header.</span>
<a href="#l5.44"></a><span id="l5.44">  * @param hdr nsIMsgHdr message header</span>
<a href="#l5.45"></a><span id="l5.45">  * @param type nsIMsgCompType compose type the identity ise used for.</span>
<a href="#l5.46"></a><span id="l5.46">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -2640,19 +2640,19 @@ function GetNewMsgs(server, folder)</span>
<a href="#l6.4"></a><span id="l6.4"> function SendUnsentMessages()</span>
<a href="#l6.5"></a><span id="l6.5"> {</span>
<a href="#l6.6"></a><span id="l6.6">   var msgSendlater = Components.classes[&quot;@mozilla.org/messengercompose/sendlater;1&quot;]</span>
<a href="#l6.7"></a><span id="l6.7">                                .getService(Components.interfaces.nsIMsgSendLater);</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">   var accountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l6.10"></a><span id="l6.10">                                  .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l6.11"></a><span id="l6.11">   var allIdentities = accountManager.allIdentities;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  var identitiesCount = allIdentities.Count();</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  var identitiesCount = allIdentities.length;</span>
<a href="#l6.14"></a><span id="l6.14">   for (var i = 0; i &lt; identitiesCount; i++) {</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-    var currentIdentity = allIdentities.QueryElementAt(i, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+    var currentIdentity = allIdentities.queryElementAt(i, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l6.17"></a><span id="l6.17">     var msgFolder = msgSendlater.getUnsentMessagesFolder(currentIdentity);</span>
<a href="#l6.18"></a><span id="l6.18">     if (msgFolder) {</span>
<a href="#l6.19"></a><span id="l6.19">       var numMessages = msgFolder.getTotalMessages(false /* include subfolders */);</span>
<a href="#l6.20"></a><span id="l6.20">       if(numMessages &gt; 0) {</span>
<a href="#l6.21"></a><span id="l6.21">         msgSendlater.sendUnsentMessages(currentIdentity);</span>
<a href="#l6.22"></a><span id="l6.22">         // Right now, all identities point to the same unsent messages</span>
<a href="#l6.23"></a><span id="l6.23">         // folder, so to avoid sending multiple copies of the</span>
<a href="#l6.24"></a><span id="l6.24">         // unsent messages, we only call messenger.SendUnsentMessages() once.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1247,17 +1247,17 @@ function FormatDisplayName(aEmailAddress</span>
<a href="#l7.4"></a><span id="l7.4">     // if nothing else is available.</span>
<a href="#l7.5"></a><span id="l7.5">     try {</span>
<a href="#l7.6"></a><span id="l7.6">       displayName = bundle.getString(&quot;header&quot; + aContext + &quot;FieldMe&quot;);</span>
<a href="#l7.7"></a><span id="l7.7">     } catch (ex) {</span>
<a href="#l7.8"></a><span id="l7.8">       displayName = bundle.getString(&quot;headertoFieldMe&quot;);</span>
<a href="#l7.9"></a><span id="l7.9">     }</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">     // Make sure we have an unambiguous name if there are multiple identities</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    if (accountManager.allIdentities.Count() &gt; 1)</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    if (accountManager.allIdentities.length &gt; 1)</span>
<a href="#l7.14"></a><span id="l7.14">       displayName += &quot; &lt;&quot;+identity.email+&quot;&gt;&quot;;</span>
<a href="#l7.15"></a><span id="l7.15">   }</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17">   // If we don't have a card, refuse to generate a display name. Places calling</span>
<a href="#l7.18"></a><span id="l7.18">   // this are then responsible for falling back to something else (e.g. the</span>
<a href="#l7.19"></a><span id="l7.19">   // value from the message header).</span>
<a href="#l7.20"></a><span id="l7.20">   if (card) {</span>
<a href="#l7.21"></a><span id="l7.21">     if (!displayName &amp;&amp; aHeaderDisplayName)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -2289,19 +2289,19 @@ function ComposeStartup(recycled, aParam</span>
<a href="#l8.4"></a><span id="l8.4">   }</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6">   gComposeType = params.type;</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8">   // &quot; &lt;&gt;&quot; is an empty identity, and most likely not valid</span>
<a href="#l8.9"></a><span id="l8.9">   if (!params.identity || params.identity.identityName == &quot; &lt;&gt;&quot;) {</span>
<a href="#l8.10"></a><span id="l8.10">     // no pre selected identity, so use the default account</span>
<a href="#l8.11"></a><span id="l8.11">     var identities = gAccountManager.defaultAccount.identities;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    if (identities.Count() == 0)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    if (identities.length == 0)</span>
<a href="#l8.14"></a><span id="l8.14">       identities = gAccountManager.allIdentities;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-    params.identity = identities.QueryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+    params.identity = identities.queryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l8.17"></a><span id="l8.17">   }</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19">   identityList.value = params.identity.key;</span>
<a href="#l8.20"></a><span id="l8.20">   LoadIdentity(true);</span>
<a href="#l8.21"></a><span id="l8.21">   var composeSvc = Components.classes[&quot;@mozilla.org/messengercompose;1&quot;]</span>
<a href="#l8.22"></a><span id="l8.22">                              .getService(Components.interfaces.nsIMsgComposeService);</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24">   // Get the &lt;editor&gt; element to startup an editor</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/test/mozmill/multiple-identities/test-display-names.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/test/mozmill/multiple-identities/test-display-names.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -36,18 +36,18 @@ function setupModule(module) {</span>
<a href="#l9.4"></a><span id="l9.4">   // 1) Delete all accounts except for Local Folders</span>
<a href="#l9.5"></a><span id="l9.5">   for (let i = acctMgr.accounts.Count()-1; i &gt;= 0; i--) {</span>
<a href="#l9.6"></a><span id="l9.6">     let account = acctMgr.accounts.QueryElementAt(i, Ci.nsIMsgAccount);</span>
<a href="#l9.7"></a><span id="l9.7">     if (account != localAccount)</span>
<a href="#l9.8"></a><span id="l9.8">       acctMgr.removeAccount(account);</span>
<a href="#l9.9"></a><span id="l9.9">   }</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11">   // 2) Delete all identities except for one</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  for (let i = localAccount.identities.Count()-1; i &gt;= 0; i--) {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-    let identity = localAccount.identities.QueryElementAt(i, Ci.nsIMsgIdentity);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  for (let i = localAccount.identities.length - 1; i &gt;= 0; i--) {</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+    let identity = localAccount.identities.queryElementAt(i, Ci.nsIMsgIdentity);</span>
<a href="#l9.16"></a><span id="l9.16">     if (identity.email != myEmail)</span>
<a href="#l9.17"></a><span id="l9.17">       localAccount.removeIdentity(identity);</span>
<a href="#l9.18"></a><span id="l9.18">   }</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20">   // 3) Create a second identity and hold onto it for later</span>
<a href="#l9.21"></a><span id="l9.21">   secondIdentity = acctMgr.createIdentity();</span>
<a href="#l9.22"></a><span id="l9.22">   secondIdentity.email = &quot;nobody@nowhere.com&quot;;</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24" class="difflineat">@@ -65,28 +65,28 @@ function setupModule(module) {</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26">   let bundle = Cc[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l9.27"></a><span id="l9.27">                  .getService(Ci.nsIStringBundleService).createBundle(</span>
<a href="#l9.28"></a><span id="l9.28">                    &quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l9.29"></a><span id="l9.29">   headertoFieldMe = bundle.GetStringFromName(&quot;headertoFieldMe&quot;);</span>
<a href="#l9.30"></a><span id="l9.30"> }</span>
<a href="#l9.31"></a><span id="l9.31"> </span>
<a href="#l9.32"></a><span id="l9.32"> function ensure_single_identity() {</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-  if (localAccount.identities.Count() &gt; 1)</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+  if (localAccount.identities.length &gt; 1)</span>
<a href="#l9.35"></a><span id="l9.35">     localAccount.removeIdentity(secondIdentity);</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-  assert_true(acctMgr.allIdentities.Count() == 1,</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-              &quot;Expected 1 identity, but got &quot; + acctMgr.allIdentities.Count() +</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+  assert_true(acctMgr.allIdentities.length == 1,</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+              &quot;Expected 1 identity, but got &quot; + acctMgr.allIdentities.length +</span>
<a href="#l9.40"></a><span id="l9.40">               &quot; identities&quot;);</span>
<a href="#l9.41"></a><span id="l9.41"> }</span>
<a href="#l9.42"></a><span id="l9.42"> </span>
<a href="#l9.43"></a><span id="l9.43"> function ensure_multiple_identities() {</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-  if (localAccount.identities.Count() == 1)</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  if (localAccount.identities.length == 1)</span>
<a href="#l9.46"></a><span id="l9.46">     localAccount.addIdentity(secondIdentity);</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-  assert_true(acctMgr.allIdentities.Count() &gt; 1,</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-              &quot;Expected multiple identities, but got only one identity&quot;)</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+  assert_true(acctMgr.allIdentities.length &gt; 1,</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+              &quot;Expected multiple identities, but got only one identity&quot;);</span>
<a href="#l9.51"></a><span id="l9.51"> }</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53"> function help_test_display_name(message, field, expectedValue) {</span>
<a href="#l9.54"></a><span id="l9.54">   // Switch to a decoy folder first to ensure that we refresh the message we're</span>
<a href="#l9.55"></a><span id="l9.55">   // looking at in order to update information changed in address book entries.</span>
<a href="#l9.56"></a><span id="l9.56">   be_in_folder(decoyFolder);</span>
<a href="#l9.57"></a><span id="l9.57">   be_in_folder(folder);</span>
<a href="#l9.58"></a><span id="l9.58">   let curMessage = select_click_row(message);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountManager.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountManager.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -771,17 +771,17 @@ function updateItems(tree, account, addA</span>
<a href="#l10.4"></a><span id="l10.4">     // Only try to check properties if there was anything selected in the tree</span>
<a href="#l10.5"></a><span id="l10.5">     // and it belongs to an account.</span>
<a href="#l10.6"></a><span id="l10.6">     // Otherwise we have either selected a SMTP server, or there is some</span>
<a href="#l10.7"></a><span id="l10.7">     // problem. Either way, we don't want the user to act on it.</span>
<a href="#l10.8"></a><span id="l10.8">     let server = account.incomingServer;</span>
<a href="#l10.9"></a><span id="l10.9">     let type = server.type;</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">     if (account != MailServices.accounts.defaultAccount &amp;&amp;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-        server.canBeDefaultServer &amp;&amp; account.identities.Count() &gt; 0)</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+        server.canBeDefaultServer &amp;&amp; account.identities.length &gt; 0)</span>
<a href="#l10.14"></a><span id="l10.14">       canSetDefault = true;</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16">     if (Components.classes[&quot;@mozilla.org/messenger/protocol/info;1?type=&quot; + type]</span>
<a href="#l10.17"></a><span id="l10.17">                   .getService(Components.interfaces.nsIMsgProtocolInfo).canDelete)</span>
<a href="#l10.18"></a><span id="l10.18">       canDelete = true;</span>
<a href="#l10.19"></a><span id="l10.19">     else</span>
<a href="#l10.20"></a><span id="l10.20">       canDelete = server.canDelete;</span>
<a href="#l10.21"></a><span id="l10.21">   }</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineat">@@ -1317,18 +1317,18 @@ var gAccountTree = {</span>
<a href="#l10.23"></a><span id="l10.23">       var treerow = document.createElement(&quot;treerow&quot;);</span>
<a href="#l10.24"></a><span id="l10.24">       treeitem.appendChild(treerow);</span>
<a href="#l10.25"></a><span id="l10.25">       var treecell = document.createElement(&quot;treecell&quot;);</span>
<a href="#l10.26"></a><span id="l10.26">       treerow.appendChild(treecell);</span>
<a href="#l10.27"></a><span id="l10.27">       treecell.setAttribute(&quot;label&quot;, server.rootFolder.prettyName);</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29">       // Now add our panels</span>
<a href="#l10.30"></a><span id="l10.30">       var panelsToKeep = [];</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-      let idents = MailServices.accounts.GetIdentitiesForServer(server);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-      if (idents.Count()) {</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+      let idents = MailServices.accounts.getIdentitiesForServer(server);</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+      if (idents.length) {</span>
<a href="#l10.35"></a><span id="l10.35">         panelsToKeep.push(panels[0]); // The server panel is valid</span>
<a href="#l10.36"></a><span id="l10.36">         panelsToKeep.push(panels[1]); // also the copies panel</span>
<a href="#l10.37"></a><span id="l10.37">         panelsToKeep.push(panels[4]); // and addresssing</span>
<a href="#l10.38"></a><span id="l10.38">       }</span>
<a href="#l10.39"></a><span id="l10.39"> </span>
<a href="#l10.40"></a><span id="l10.40">       // Everyone except News, RSS and IM has a junk panel</span>
<a href="#l10.41"></a><span id="l10.41">       // XXX: unextensible!</span>
<a href="#l10.42"></a><span id="l10.42">       // The existence of server.spamSettings can't currently be used for this.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountWizard.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountWizard.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -276,19 +276,19 @@ function AccountDataToPageData(accountDa</span>
<a href="#l11.4"></a><span id="l11.4">     </span>
<a href="#l11.5"></a><span id="l11.5">     var identity;</span>
<a href="#l11.6"></a><span id="l11.6">     </span>
<a href="#l11.7"></a><span id="l11.7">     if (accountData.identity) {</span>
<a href="#l11.8"></a><span id="l11.8">         dump(&quot;This is an accountdata\n&quot;);</span>
<a href="#l11.9"></a><span id="l11.9">         identity = accountData.identity;</span>
<a href="#l11.10"></a><span id="l11.10">     }</span>
<a href="#l11.11"></a><span id="l11.11">     else if (accountData.identities) {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-        identity = accountData.identities.QueryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+        identity = accountData.identities.queryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l11.14"></a><span id="l11.14">         dump(&quot;this is an account, id= &quot; + identity + &quot;\n&quot;);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-    } </span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+    }</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18">     setPageData(pageData, &quot;identity&quot;, &quot;email&quot;, identity.email);</span>
<a href="#l11.19"></a><span id="l11.19">     setPageData(pageData, &quot;identity&quot;, &quot;fullName&quot;, identity.fullName);</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21">     var smtp;</span>
<a href="#l11.22"></a><span id="l11.22">     </span>
<a href="#l11.23"></a><span id="l11.23">     if (accountData.smtp) {</span>
<a href="#l11.24"></a><span id="l11.24">         smtp = accountData.smtp;</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineat">@@ -463,19 +463,21 @@ function finishAccount(account, accountD</span>
<a href="#l11.26"></a><span id="l11.26">         }</span>
<a href="#l11.27"></a><span id="l11.27">           </span>
<a href="#l11.28"></a><span id="l11.28">         account.incomingServer.valid=true;</span>
<a href="#l11.29"></a><span id="l11.29">         // hack to cause an account loaded notification now the server is valid</span>
<a href="#l11.30"></a><span id="l11.30">         account.incomingServer = account.incomingServer;</span>
<a href="#l11.31"></a><span id="l11.31">     }</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33">     // copy identity info</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-    var destIdentity = account.identities.Count() ? account.identities.QueryElementAt(0, nsIMsgIdentity) : null;</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+    var destIdentity = account.identities.length ?</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+                       account.identities.queryElementAt(0, nsIMsgIdentity) :</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+                       null;</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-    if (destIdentity) // does this account have an identity? </span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+    if (destIdentity) // does this account have an identity?</span>
<a href="#l11.41"></a><span id="l11.41">     {   </span>
<a href="#l11.42"></a><span id="l11.42">         if (accountData.identity &amp;&amp; accountData.identity.email) {</span>
<a href="#l11.43"></a><span id="l11.43">             // fixup the email address if we have a default domain</span>
<a href="#l11.44"></a><span id="l11.44">             var emailArray = accountData.identity.email.split('@');</span>
<a href="#l11.45"></a><span id="l11.45">             if (emailArray.length &lt; 2 &amp;&amp; accountData.domain) {</span>
<a href="#l11.46"></a><span id="l11.46">                 accountData.identity.email += '@' + accountData.domain;</span>
<a href="#l11.47"></a><span id="l11.47">             }</span>
<a href="#l11.48"></a><span id="l11.48"> </span>
<a href="#l11.49"></a><span id="l11.49" class="difflineat">@@ -605,19 +607,19 @@ function verifyLocalFoldersAccount()</span>
<a href="#l11.50"></a><span id="l11.50"> </span>
<a href="#l11.51"></a><span id="l11.51"> function setupCopiesAndFoldersServer(account, accountIsDeferred, accountData)</span>
<a href="#l11.52"></a><span id="l11.52"> {</span>
<a href="#l11.53"></a><span id="l11.53">   try {</span>
<a href="#l11.54"></a><span id="l11.54">     var server = account.incomingServer;</span>
<a href="#l11.55"></a><span id="l11.55"> </span>
<a href="#l11.56"></a><span id="l11.56">     // This function sets up the default send preferences. The send preferences</span>
<a href="#l11.57"></a><span id="l11.57">     // go on identities, so there is no need to continue without any identities.</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-    if (server.type == &quot;rss&quot; || account.identities.Count() == 0)</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+    if (server.type == &quot;rss&quot; || account.identities.length == 0)</span>
<a href="#l11.60"></a><span id="l11.60">       return false;</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-    var identity = account.identities.QueryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+    let identity = account.identities.queryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l11.63"></a><span id="l11.63">     // For this server, do we default the folder prefs to this server, or to the &quot;Local Folders&quot; server</span>
<a href="#l11.64"></a><span id="l11.64">     // If it's deferred, we use the local folders account.</span>
<a href="#l11.65"></a><span id="l11.65">     var defaultCopiesAndFoldersPrefsToServer = !accountIsDeferred &amp;&amp; server.defaultCopiesAndFoldersPrefsToServer;</span>
<a href="#l11.66"></a><span id="l11.66"> </span>
<a href="#l11.67"></a><span id="l11.67">     var copiesAndFoldersServer = null;</span>
<a href="#l11.68"></a><span id="l11.68">     if (defaultCopiesAndFoldersPrefsToServer) </span>
<a href="#l11.69"></a><span id="l11.69">     {</span>
<a href="#l11.70"></a><span id="l11.70">       copiesAndFoldersServer = server;</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineat">@@ -733,17 +735,17 @@ function checkForInvalidAccounts()</span>
<a href="#l11.72"></a><span id="l11.72">         gCurrentAccount = firstInvalidAccount;</span>
<a href="#l11.73"></a><span id="l11.73"> </span>
<a href="#l11.74"></a><span id="l11.74">         // there's a possibility that the invalid account has ISP defaults</span>
<a href="#l11.75"></a><span id="l11.75">         // as well.. so first pre-fill accountData with ISP info, then</span>
<a href="#l11.76"></a><span id="l11.76">         // overwrite it with the account data</span>
<a href="#l11.77"></a><span id="l11.77"> </span>
<a href="#l11.78"></a><span id="l11.78"> </span>
<a href="#l11.79"></a><span id="l11.79">         var identity =</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-            firstInvalidAccount.identities.QueryElementAt(0, nsIMsgIdentity);</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+            firstInvalidAccount.identities.queryElementAt(0, nsIMsgIdentity);</span>
<a href="#l11.82"></a><span id="l11.82"> </span>
<a href="#l11.83"></a><span id="l11.83">         var accountData = null;</span>
<a href="#l11.84"></a><span id="l11.84">         // If there is a email address already provided, try to get to other ISP defaults.</span>
<a href="#l11.85"></a><span id="l11.85">         // If not, get pre-configured data, if any.</span>
<a href="#l11.86"></a><span id="l11.86">         if (identity.email) {</span>
<a href="#l11.87"></a><span id="l11.87">           dump(&quot;Invalid account: trying to get ISP data for &quot; + identity.email + &quot;\n&quot;);</span>
<a href="#l11.88"></a><span id="l11.88">           accountData = getIspDefaultsForEmail(identity.email);</span>
<a href="#l11.89"></a><span id="l11.89">           dump(&quot;Invalid account: Got &quot; + accountData + &quot;\n&quot;);</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineat">@@ -775,17 +777,17 @@ function getPreConfigDataForAccount(acco</span>
<a href="#l11.91"></a><span id="l11.91">   var accountData = new Object;</span>
<a href="#l11.92"></a><span id="l11.92">   accountData = new Object;</span>
<a href="#l11.93"></a><span id="l11.93">   accountData.incomingServer = new Object;</span>
<a href="#l11.94"></a><span id="l11.94">   accountData.identity = new Object;</span>
<a href="#l11.95"></a><span id="l11.95">   accountData.smtp = new Object;</span>
<a href="#l11.96"></a><span id="l11.96"> </span>
<a href="#l11.97"></a><span id="l11.97">   accountData = AccountToAccountData(account, null);</span>
<a href="#l11.98"></a><span id="l11.98"> </span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-  var identity = account.identities.QueryElementAt(0, nsIMsgIdentity);</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+  let identity = account.identities.queryElementAt(0, nsIMsgIdentity);</span>
<a href="#l11.101"></a><span id="l11.101"> </span>
<a href="#l11.102"></a><span id="l11.102">   try {</span>
<a href="#l11.103"></a><span id="l11.103">     var skipPanelsPrefStr = &quot;mail.identity.&quot; + identity.key + &quot;.wizardSkipPanels&quot;;</span>
<a href="#l11.104"></a><span id="l11.104">     accountData.wizardSkipPanels = gPrefs.getCharPref(skipPanelsPrefStr);</span>
<a href="#l11.105"></a><span id="l11.105"> </span>
<a href="#l11.106"></a><span id="l11.106">     if (identity.smtpServerKey) {</span>
<a href="#l11.107"></a><span id="l11.107">       var smtpServer = smtpService.getServerByKey(identity.smtpServerKey);</span>
<a href="#l11.108"></a><span id="l11.108">       accountData.smtp = smtpServer;</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineat">@@ -806,19 +808,19 @@ function getPreConfigDataForAccount(acco</span>
<a href="#l11.110"></a><span id="l11.110"> </span>
<a href="#l11.111"></a><span id="l11.111"> function AccountToAccountData(account, defaultAccountData)</span>
<a href="#l11.112"></a><span id="l11.112"> {</span>
<a href="#l11.113"></a><span id="l11.113">     dump(&quot;AccountToAccountData(&quot; + account + &quot;, &quot; +</span>
<a href="#l11.114"></a><span id="l11.114">          defaultAccountData + &quot;)\n&quot;);</span>
<a href="#l11.115"></a><span id="l11.115">     var accountData = defaultAccountData;</span>
<a href="#l11.116"></a><span id="l11.116">     if (!accountData)</span>
<a href="#l11.117"></a><span id="l11.117">         accountData = new Object;</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-    </span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+</span>
<a href="#l11.120"></a><span id="l11.120">     accountData.incomingServer = account.incomingServer;</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-    accountData.identity = account.identities.QueryElementAt(0, nsIMsgIdentity);</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+    accountData.identity = account.identities.queryElementAt(0, nsIMsgIdentity);</span>
<a href="#l11.123"></a><span id="l11.123">     accountData.smtp = smtpService.defaultServer;</span>
<a href="#l11.124"></a><span id="l11.124"> </span>
<a href="#l11.125"></a><span id="l11.125">     return accountData;</span>
<a href="#l11.126"></a><span id="l11.126"> }</span>
<a href="#l11.127"></a><span id="l11.127"> </span>
<a href="#l11.128"></a><span id="l11.128"> // sets the page data, automatically creating the arrays as necessary</span>
<a href="#l11.129"></a><span id="l11.129"> function setPageData(pageData, tag, slot, value) {</span>
<a href="#l11.130"></a><span id="l11.130">     if (!pageData[tag]) pageData[tag] = [];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountUtils.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountUtils.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -25,20 +25,20 @@ function getInvalidAccounts(accounts)</span>
<a href="#l12.4"></a><span id="l12.4">                 continue;</span>
<a href="#l12.5"></a><span id="l12.5">             }</span>
<a href="#l12.6"></a><span id="l12.6">         } catch (ex) {</span>
<a href="#l12.7"></a><span id="l12.7">             // this account is busted, just keep going</span>
<a href="#l12.8"></a><span id="l12.8">             continue;</span>
<a href="#l12.9"></a><span id="l12.9">         }</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11">         var identities = account.identities;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-        numIdentities = identities.Count();</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+        numIdentities = identities.length;</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-        for (var j=0; j&lt;numIdentities; j++) {</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-            var identity = identities.QueryElementAt(j, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+        for (var j = 0; j &lt; numIdentities; j++) {</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+            let identity = identities.queryElementAt(j, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l12.19"></a><span id="l12.19">             if (identity.valid) {</span>
<a href="#l12.20"></a><span id="l12.20">               gAnyValidIdentity = true;</span>
<a href="#l12.21"></a><span id="l12.21">             }</span>
<a href="#l12.22"></a><span id="l12.22">             else {</span>
<a href="#l12.23"></a><span id="l12.23">               invalidAccounts[invalidAccounts.length] = account;</span>
<a href="#l12.24"></a><span id="l12.24">             }</span>
<a href="#l12.25"></a><span id="l12.25">         }</span>
<a href="#l12.26"></a><span id="l12.26">     }</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineat">@@ -255,20 +255,20 @@ function migrateGlobalQuotingPrefs(allId</span>
<a href="#l12.28"></a><span id="l12.28">   if (quotingPrefs == 0) {</span>
<a href="#l12.29"></a><span id="l12.29">     migrated = true;</span>
<a href="#l12.30"></a><span id="l12.30">     try {</span>
<a href="#l12.31"></a><span id="l12.31">       reply_on_top = Services.prefs.getIntPref(&quot;mailnews.reply_on_top&quot;);</span>
<a href="#l12.32"></a><span id="l12.32">       auto_quote = Services.prefs.getBoolPref(&quot;mail.auto_quote&quot;);</span>
<a href="#l12.33"></a><span id="l12.33">     } catch (ex) {}</span>
<a href="#l12.34"></a><span id="l12.34"> </span>
<a href="#l12.35"></a><span id="l12.35">     if (!auto_quote || reply_on_top) {</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-      var numIdentities = allIdentities.Count();</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+      let numIdentities = allIdentities.length;</span>
<a href="#l12.38"></a><span id="l12.38">       var identity = null;</span>
<a href="#l12.39"></a><span id="l12.39">       for (var j = 0; j &lt; numIdentities; j++) {</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-        identity = allIdentities.QueryElementAt(j, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+        identity = allIdentities.queryElementAt(j, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l12.42"></a><span id="l12.42">         if (identity.valid) {</span>
<a href="#l12.43"></a><span id="l12.43">           identity.autoQuote = auto_quote;</span>
<a href="#l12.44"></a><span id="l12.44">           identity.replyOnTop = reply_on_top;</span>
<a href="#l12.45"></a><span id="l12.45">         }</span>
<a href="#l12.46"></a><span id="l12.46">       }</span>
<a href="#l12.47"></a><span id="l12.47">     }</span>
<a href="#l12.48"></a><span id="l12.48">     Services.prefs.setIntPref(&quot;mailnews.quotingPrefs.version&quot;, 1);</span>
<a href="#l12.49"></a><span id="l12.49">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgAccount.idl</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgAccount.idl</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,36 +1,37 @@</span>
<a href="#l13.4"></a><span id="l13.4"> /* -*- Mode: IDL; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l13.5"></a><span id="l13.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.6"></a><span id="l13.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.7"></a><span id="l13.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;nsIMsgIncomingServer.idl&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> #include &quot;nsIMsgIdentity.idl&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#include &quot;nsISupportsArray.idl&quot;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+interface nsIArray;</span>
<a href="#l13.15"></a><span id="l13.15"> </span>
<a href="#l13.16"></a><span id="l13.16"> /**</span>
<a href="#l13.17"></a><span id="l13.17">  * An account consists of an incoming server and one or more</span>
<a href="#l13.18"></a><span id="l13.18">  * outgoing identities. An account is identified by a key,</span>
<a href="#l13.19"></a><span id="l13.19">  * which is the &lt;account&gt; string in the account preferences,</span>
<a href="#l13.20"></a><span id="l13.20">  * such as in mail.account.&lt;account&gt;.identities.</span>
<a href="#l13.21"></a><span id="l13.21">  */</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-[scriptable, uuid(76048A12-303C-4cf8-B592-1F83BD196B14)]</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+[scriptable, uuid(84181351-4ec8-4ca8-8439-5c68cc591177)]</span>
<a href="#l13.25"></a><span id="l13.25"> interface nsIMsgAccount : nsISupports {</span>
<a href="#l13.26"></a><span id="l13.26"> </span>
<a href="#l13.27"></a><span id="l13.27">   /// Internal key identifying itself</span>
<a href="#l13.28"></a><span id="l13.28">   attribute ACString key;</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30">   /// Incoming server stuff</span>
<a href="#l13.31"></a><span id="l13.31">   attribute nsIMsgIncomingServer incomingServer;</span>
<a href="#l13.32"></a><span id="l13.32"> </span>
<a href="#l13.33"></a><span id="l13.33">   /// Outgoing identity list (array of nsIMsgIdentity's)</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-  readonly attribute nsISupportsArray identities;</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+  readonly attribute nsIArray identities;</span>
<a href="#l13.36"></a><span id="l13.36"> </span>
<a href="#l13.37"></a><span id="l13.37">   /// The default identity for this account.</span>
<a href="#l13.38"></a><span id="l13.38">   attribute nsIMsgIdentity defaultIdentity;</span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40">   /// Add a new identity to this account</span>
<a href="#l13.41"></a><span id="l13.41">   void addIdentity(in nsIMsgIdentity identity);</span>
<a href="#l13.42"></a><span id="l13.42"> </span>
<a href="#l13.43"></a><span id="l13.43">   /// Remove an identity from this account</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgAccountManager.idl</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgAccountManager.idl</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -9,17 +9,17 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;nsIMsgIncomingServer.idl&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsIIncomingServerListener.idl&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> #include &quot;nsIMsgFolder.idl&quot;</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> interface nsISupportsArray;</span>
<a href="#l14.9"></a><span id="l14.9"> interface nsIMsgFolderCache;</span>
<a href="#l14.10"></a><span id="l14.10"> interface nsIFolderListener;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-[scriptable, uuid(ae2fc99f-0d94-4e68-bc0e-7feb645b110f)]</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+[scriptable, uuid(b00a0e76-9b64-420c-b717-7196b18ff503)]</span>
<a href="#l14.14"></a><span id="l14.14"> interface nsIMsgAccountManager : nsISupports {</span>
<a href="#l14.15"></a><span id="l14.15"> </span>
<a href="#l14.16"></a><span id="l14.16">   nsIMsgAccount createAccount();</span>
<a href="#l14.17"></a><span id="l14.17">   /*</span>
<a href="#l14.18"></a><span id="l14.18">    * Return the account with the provided key, or null if none found.</span>
<a href="#l14.19"></a><span id="l14.19">    */</span>
<a href="#l14.20"></a><span id="l14.20">   nsIMsgAccount getAccount(in ACString key);</span>
<a href="#l14.21"></a><span id="l14.21">     </span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -76,17 +76,17 @@ interface nsIMsgAccountManager : nsISupp</span>
<a href="#l14.23"></a><span id="l14.23">    * Accounts with hidden servers are not returned.</span>
<a href="#l14.24"></a><span id="l14.24">    * array of nsIMsgAccount</span>
<a href="#l14.25"></a><span id="l14.25">    */</span>
<a href="#l14.26"></a><span id="l14.26">   readonly attribute nsISupportsArray accounts;</span>
<a href="#l14.27"></a><span id="l14.27"> </span>
<a href="#l14.28"></a><span id="l14.28">   /* list of all identities in all accounts</span>
<a href="#l14.29"></a><span id="l14.29">    * array of nsIMsgIdentity</span>
<a href="#l14.30"></a><span id="l14.30">    */</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-  readonly attribute nsISupportsArray allIdentities;</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+  readonly attribute nsIArray allIdentities;</span>
<a href="#l14.33"></a><span id="l14.33"> </span>
<a href="#l14.34"></a><span id="l14.34">   /* list of all servers in all accounts, except for hidden and IM servers</span>
<a href="#l14.35"></a><span id="l14.35">    * array of nsIMsgIncomingServer</span>
<a href="#l14.36"></a><span id="l14.36">    */</span>
<a href="#l14.37"></a><span id="l14.37">   readonly attribute nsISupportsArray allServers;</span>
<a href="#l14.38"></a><span id="l14.38"> </span>
<a href="#l14.39"></a><span id="l14.39">   /* summary of summary files folder cache */</span>
<a href="#l14.40"></a><span id="l14.40">   readonly attribute nsIMsgFolderCache folderCache;</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineat">@@ -134,17 +134,17 @@ interface nsIMsgAccountManager : nsISupp</span>
<a href="#l14.42"></a><span id="l14.42">    * @return        If found, the nsIMsgAccount representing the account found.</span>
<a href="#l14.43"></a><span id="l14.43">    *                Otherwise returns null.</span>
<a href="#l14.44"></a><span id="l14.44">    */</span>
<a href="#l14.45"></a><span id="l14.45">   nsIMsgAccount FindAccountForServer(in nsIMsgIncomingServer server);</span>
<a href="#l14.46"></a><span id="l14.46"> </span>
<a href="#l14.47"></a><span id="l14.47">   /* given a server, return all identities in accounts that have this server</span>
<a href="#l14.48"></a><span id="l14.48">    * returns an array of nsIMsgIdentity</span>
<a href="#l14.49"></a><span id="l14.49">    */</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-  nsISupportsArray GetIdentitiesForServer(in nsIMsgIncomingServer server);</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+  nsIArray getIdentitiesForServer(in nsIMsgIncomingServer server);</span>
<a href="#l14.52"></a><span id="l14.52"> </span>
<a href="#l14.53"></a><span id="l14.53">   /**</span>
<a href="#l14.54"></a><span id="l14.54">    * given a server, return the first identity in accounts that have this server</span>
<a href="#l14.55"></a><span id="l14.55">    */</span>
<a href="#l14.56"></a><span id="l14.56">   nsIMsgIdentity getFirstIdentityForServer(in nsIMsgIncomingServer server);</span>
<a href="#l14.57"></a><span id="l14.57"> </span>
<a href="#l14.58"></a><span id="l14.58">   /* given an identity, return all servers in accounts that have</span>
<a href="#l14.59"></a><span id="l14.59">    * this identity</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccount.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccount.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -19,16 +19,17 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;nsMsgAccount.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;nsIMsgAccount.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l15.8"></a><span id="l15.8"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l15.9"></a><span id="l15.9"> #include &quot;nsMemory.h&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13"> </span>
<a href="#l15.14"></a><span id="l15.14"> NS_IMPL_ISUPPORTS1(nsMsgAccount, nsIMsgAccount)</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16"> nsMsgAccount::nsMsgAccount()</span>
<a href="#l15.17"></a><span id="l15.17">   : mTriedToGetServer(false)</span>
<a href="#l15.18"></a><span id="l15.18"> {</span>
<a href="#l15.19"></a><span id="l15.19"> }</span>
<a href="#l15.20"></a><span id="l15.20"> </span>
<a href="#l15.21"></a><span id="l15.21" class="difflineat">@@ -170,17 +171,17 @@ nsMsgAccount::SetIncomingServer(nsIMsgIn</span>
<a href="#l15.22"></a><span id="l15.22">       notifier-&gt;NotifyFolderAdded(msgFolder);</span>
<a href="#l15.23"></a><span id="l15.23">     }</span>
<a href="#l15.24"></a><span id="l15.24">   }</span>
<a href="#l15.25"></a><span id="l15.25">   return NS_OK;</span>
<a href="#l15.26"></a><span id="l15.26"> }</span>
<a href="#l15.27"></a><span id="l15.27"> </span>
<a href="#l15.28"></a><span id="l15.28"> /* nsISupportsArray GetIdentities (); */</span>
<a href="#l15.29"></a><span id="l15.29"> NS_IMETHODIMP</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-nsMsgAccount::GetIdentities(nsISupportsArray **_retval)</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+nsMsgAccount::GetIdentities(nsIArray **_retval)</span>
<a href="#l15.32"></a><span id="l15.32"> {</span>
<a href="#l15.33"></a><span id="l15.33">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l15.34"></a><span id="l15.34">   NS_ENSURE_TRUE(m_identities, NS_ERROR_FAILURE);</span>
<a href="#l15.35"></a><span id="l15.35"> </span>
<a href="#l15.36"></a><span id="l15.36">   NS_IF_ADDREF(*_retval = m_identities);</span>
<a href="#l15.37"></a><span id="l15.37">   return NS_OK;</span>
<a href="#l15.38"></a><span id="l15.38"> }</span>
<a href="#l15.39"></a><span id="l15.39"> </span>
<a href="#l15.40"></a><span id="l15.40" class="difflineat">@@ -188,20 +189,21 @@ nsMsgAccount::GetIdentities(nsISupportsA</span>
<a href="#l15.41"></a><span id="l15.41">  * set up the m_identities array</span>
<a href="#l15.42"></a><span id="l15.42">  * do not call this more than once or we'll leak.</span>
<a href="#l15.43"></a><span id="l15.43">  */</span>
<a href="#l15.44"></a><span id="l15.44"> nsresult</span>
<a href="#l15.45"></a><span id="l15.45"> nsMsgAccount::createIdentities()</span>
<a href="#l15.46"></a><span id="l15.46"> {</span>
<a href="#l15.47"></a><span id="l15.47">   NS_ENSURE_FALSE(m_identities, NS_ERROR_FAILURE);</span>
<a href="#l15.48"></a><span id="l15.48"> </span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-  NS_NewISupportsArray(getter_AddRefs(m_identities));</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+  nsresult rv;</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+  m_identities = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.53"></a><span id="l15.53"> </span>
<a href="#l15.54"></a><span id="l15.54">   nsCString identityKey;</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-  nsresult rv;</span>
<a href="#l15.56"></a><span id="l15.56">   rv = getPrefService();</span>
<a href="#l15.57"></a><span id="l15.57">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.58"></a><span id="l15.58"> </span>
<a href="#l15.59"></a><span id="l15.59">   m_prefs-&gt;GetCharPref(&quot;identities&quot;, getter_Copies(identityKey));</span>
<a href="#l15.60"></a><span id="l15.60">   if (identityKey.IsEmpty())    // not an error if no identities, but</span>
<a href="#l15.61"></a><span id="l15.61">     return NS_OK;               // strtok will be unhappy</span>
<a href="#l15.62"></a><span id="l15.62">   // get the server from the account manager</span>
<a href="#l15.63"></a><span id="l15.63">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineat">@@ -240,50 +242,54 @@ nsMsgAccount::createIdentities()</span>
<a href="#l15.65"></a><span id="l15.65"> NS_IMETHODIMP</span>
<a href="#l15.66"></a><span id="l15.66"> nsMsgAccount::GetDefaultIdentity(nsIMsgIdentity **aDefaultIdentity)</span>
<a href="#l15.67"></a><span id="l15.67"> {</span>
<a href="#l15.68"></a><span id="l15.68">   NS_ENSURE_ARG_POINTER(aDefaultIdentity);</span>
<a href="#l15.69"></a><span id="l15.69">   NS_ENSURE_TRUE(m_identities, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l15.70"></a><span id="l15.70"> </span>
<a href="#l15.71"></a><span id="l15.71">   *aDefaultIdentity = nullptr;</span>
<a href="#l15.72"></a><span id="l15.72">   uint32_t count;</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-  nsresult rv = m_identities-&gt;Count(&amp;count);</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+  nsresult rv = m_identities-&gt;GetLength(&amp;count);</span>
<a href="#l15.75"></a><span id="l15.75">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.76"></a><span id="l15.76">   if (count == 0)</span>
<a href="#l15.77"></a><span id="l15.77">     return NS_OK;</span>
<a href="#l15.78"></a><span id="l15.78"> </span>
<a href="#l15.79"></a><span id="l15.79">   nsCOMPtr&lt;nsIMsgIdentity&gt; identity = do_QueryElementAt(m_identities, 0, &amp;rv);</span>
<a href="#l15.80"></a><span id="l15.80">   identity.swap(*aDefaultIdentity);</span>
<a href="#l15.81"></a><span id="l15.81">   return rv;</span>
<a href="#l15.82"></a><span id="l15.82"> }</span>
<a href="#l15.83"></a><span id="l15.83"> </span>
<a href="#l15.84"></a><span id="l15.84"> NS_IMETHODIMP</span>
<a href="#l15.85"></a><span id="l15.85"> nsMsgAccount::SetDefaultIdentity(nsIMsgIdentity *aDefaultIdentity)</span>
<a href="#l15.86"></a><span id="l15.86"> {</span>
<a href="#l15.87"></a><span id="l15.87">   NS_ENSURE_TRUE(m_identities, NS_ERROR_FAILURE);</span>
<a href="#l15.88"></a><span id="l15.88"> </span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-  int32_t position = m_identities-&gt;IndexOf(aDefaultIdentity);</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-  NS_ASSERTION(position != -1, &quot;Where did that identity come from?!&quot;);</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-  NS_ENSURE_TRUE(position != -1, NS_ERROR_UNEXPECTED);</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+  uint32_t position = 0;</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+  nsresult rv = m_identities-&gt;IndexOf(0, aDefaultIdentity, &amp;position);</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+  rv = m_identities-&gt;RemoveElementAt(position);</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.98"></a><span id="l15.98"> </span>
<a href="#l15.99"></a><span id="l15.99">   // The passed in identity is in the list, so we have at least one element.</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineminus">-  m_identities-&gt;MoveElement(position, 0);</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+  rv = m_identities-&gt;InsertElementAt(aDefaultIdentity, 0, false);</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.103"></a><span id="l15.103"> </span>
<a href="#l15.104"></a><span id="l15.104">   return saveIdentitiesPref();</span>
<a href="#l15.105"></a><span id="l15.105"> }</span>
<a href="#l15.106"></a><span id="l15.106"> </span>
<a href="#l15.107"></a><span id="l15.107"> // add the identity to m_identities, but don't fiddle with the</span>
<a href="#l15.108"></a><span id="l15.108"> // prefs. The assumption here is that the pref for this identity is</span>
<a href="#l15.109"></a><span id="l15.109"> // already set.</span>
<a href="#l15.110"></a><span id="l15.110"> nsresult</span>
<a href="#l15.111"></a><span id="l15.111"> nsMsgAccount::addIdentityInternal(nsIMsgIdentity *identity)</span>
<a href="#l15.112"></a><span id="l15.112"> {</span>
<a href="#l15.113"></a><span id="l15.113">   NS_ENSURE_TRUE(m_identities, NS_ERROR_FAILURE);</span>
<a href="#l15.114"></a><span id="l15.114"> </span>
<a href="#l15.115"></a><span id="l15.115" class="difflineminus">-  return m_identities-&gt;AppendElement(identity);</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+  return m_identities-&gt;AppendElement(identity, false);</span>
<a href="#l15.117"></a><span id="l15.117"> }</span>
<a href="#l15.118"></a><span id="l15.118"> </span>
<a href="#l15.119"></a><span id="l15.119"> /* void addIdentity (in nsIMsgIdentity identity); */</span>
<a href="#l15.120"></a><span id="l15.120"> NS_IMETHODIMP</span>
<a href="#l15.121"></a><span id="l15.121"> nsMsgAccount::AddIdentity(nsIMsgIdentity *identity)</span>
<a href="#l15.122"></a><span id="l15.122"> {</span>
<a href="#l15.123"></a><span id="l15.123">   NS_ENSURE_ARG_POINTER(identity);</span>
<a href="#l15.124"></a><span id="l15.124"> </span>
<a href="#l15.125"></a><span id="l15.125" class="difflineat">@@ -338,38 +344,42 @@ nsMsgAccount::AddIdentity(nsIMsgIdentity</span>
<a href="#l15.126"></a><span id="l15.126"> /* void removeIdentity (in nsIMsgIdentity identity); */</span>
<a href="#l15.127"></a><span id="l15.127"> NS_IMETHODIMP</span>
<a href="#l15.128"></a><span id="l15.128"> nsMsgAccount::RemoveIdentity(nsIMsgIdentity *aIdentity)</span>
<a href="#l15.129"></a><span id="l15.129"> {</span>
<a href="#l15.130"></a><span id="l15.130">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l15.131"></a><span id="l15.131">   NS_ENSURE_TRUE(m_identities, NS_ERROR_FAILURE);</span>
<a href="#l15.132"></a><span id="l15.132"> </span>
<a href="#l15.133"></a><span id="l15.133">   uint32_t count = 0;</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineminus">-  m_identities-&gt;Count(&amp;count);</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineplus">+  m_identities-&gt;GetLength(&amp;count);</span>
<a href="#l15.136"></a><span id="l15.136">   // At least one identity must stay after the delete.</span>
<a href="#l15.137"></a><span id="l15.137">   NS_ENSURE_TRUE(count &gt; 1, NS_ERROR_FAILURE);</span>
<a href="#l15.138"></a><span id="l15.138"> </span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+  uint32_t pos = 0;</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+  nsresult rv = m_identities-&gt;IndexOf(0, aIdentity, &amp;pos);</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineplus">+</span>
<a href="#l15.143"></a><span id="l15.143">   // remove our identity</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineminus">-  m_identities-&gt;RemoveElement(aIdentity);</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineplus">+  m_identities-&gt;RemoveElementAt(pos);</span>
<a href="#l15.146"></a><span id="l15.146"> </span>
<a href="#l15.147"></a><span id="l15.147">   // clear out the actual pref values associated with the identity</span>
<a href="#l15.148"></a><span id="l15.148">   aIdentity-&gt;ClearAllValues();</span>
<a href="#l15.149"></a><span id="l15.149"> </span>
<a href="#l15.150"></a><span id="l15.150">   return saveIdentitiesPref();</span>
<a href="#l15.151"></a><span id="l15.151"> }</span>
<a href="#l15.152"></a><span id="l15.152"> </span>
<a href="#l15.153"></a><span id="l15.153"> nsresult</span>
<a href="#l15.154"></a><span id="l15.154"> nsMsgAccount::saveIdentitiesPref()</span>
<a href="#l15.155"></a><span id="l15.155"> {</span>
<a href="#l15.156"></a><span id="l15.156">   nsAutoCString newIdentityList;</span>
<a href="#l15.157"></a><span id="l15.157"> </span>
<a href="#l15.158"></a><span id="l15.158">   // Iterate over the existing identities and build the pref value,</span>
<a href="#l15.159"></a><span id="l15.159">   // a string of identity keys: id1, id2, idX...</span>
<a href="#l15.160"></a><span id="l15.160">   uint32_t count;</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineminus">-  nsresult rv = m_identities-&gt;Count(&amp;count);</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineplus">+  nsresult rv = m_identities-&gt;GetLength(&amp;count);</span>
<a href="#l15.163"></a><span id="l15.163">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.164"></a><span id="l15.164"> </span>
<a href="#l15.165"></a><span id="l15.165">   nsCString key;</span>
<a href="#l15.166"></a><span id="l15.166">   for (uint32_t index = 0; index &lt; count; index++)</span>
<a href="#l15.167"></a><span id="l15.167">   {</span>
<a href="#l15.168"></a><span id="l15.168">     nsCOMPtr&lt;nsIMsgIdentity&gt; identity = do_QueryElementAt(m_identities, index, &amp;rv);</span>
<a href="#l15.169"></a><span id="l15.169">     if (identity)</span>
<a href="#l15.170"></a><span id="l15.170">     {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccount.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccount.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -2,33 +2,34 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.5"></a><span id="l16.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.6"></a><span id="l16.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nscore.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsIMsgAccount.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13"> </span>
<a href="#l16.14"></a><span id="l16.14"> class nsMsgAccount : public nsIMsgAccount</span>
<a href="#l16.15"></a><span id="l16.15"> {</span>
<a href="#l16.16"></a><span id="l16.16"> </span>
<a href="#l16.17"></a><span id="l16.17"> public:</span>
<a href="#l16.18"></a><span id="l16.18">   nsMsgAccount();</span>
<a href="#l16.19"></a><span id="l16.19">   virtual ~nsMsgAccount();</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21">   NS_DECL_ISUPPORTS</span>
<a href="#l16.22"></a><span id="l16.22">   NS_DECL_NSIMSGACCOUNT</span>
<a href="#l16.23"></a><span id="l16.23"> </span>
<a href="#l16.24"></a><span id="l16.24"> private:</span>
<a href="#l16.25"></a><span id="l16.25">   nsCString m_accountKey;</span>
<a href="#l16.26"></a><span id="l16.26">   nsCOMPtr&lt;nsIPrefBranch&gt; m_prefs;</span>
<a href="#l16.27"></a><span id="l16.27">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; m_incomingServer;</span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; m_identities;</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; m_identities;</span>
<a href="#l16.31"></a><span id="l16.31"> </span>
<a href="#l16.32"></a><span id="l16.32">   nsresult getPrefService();</span>
<a href="#l16.33"></a><span id="l16.33">   nsresult createIncomingServer();</span>
<a href="#l16.34"></a><span id="l16.34">   nsresult createIdentities();</span>
<a href="#l16.35"></a><span id="l16.35">   nsresult saveIdentitiesPref();</span>
<a href="#l16.36"></a><span id="l16.36">   nsresult addIdentityInternal(nsIMsgIdentity* identity);</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38">   // Have we tried to get the server yet?</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -712,21 +712,21 @@ nsMsgAccountManager::RemoveAccount(nsIMs</span>
<a href="#l17.4"></a><span id="l17.4">   // XXX - need to figure out if this is the last time this server is</span>
<a href="#l17.5"></a><span id="l17.5">   // being used, and only send notification then.</span>
<a href="#l17.6"></a><span id="l17.6">   // (and only remove from hashtable then too!)</span>
<a href="#l17.7"></a><span id="l17.7">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l17.8"></a><span id="l17.8">   rv = aAccount-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l17.9"></a><span id="l17.9">   if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l17.10"></a><span id="l17.10">     RemoveIncomingServer(server, false);</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; identityArray;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; identityArray;</span>
<a href="#l17.14"></a><span id="l17.14">   rv = aAccount-&gt;GetIdentities(getter_AddRefs(identityArray));</span>
<a href="#l17.15"></a><span id="l17.15">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.16"></a><span id="l17.16">     uint32_t count = 0;</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-    identityArray-&gt;Count(&amp;count);</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+    identityArray-&gt;GetLength(&amp;count);</span>
<a href="#l17.19"></a><span id="l17.19">     uint32_t i;</span>
<a href="#l17.20"></a><span id="l17.20">     for (i = 0; i &lt; count; i++)</span>
<a href="#l17.21"></a><span id="l17.21">     {</span>
<a href="#l17.22"></a><span id="l17.22">       nsCOMPtr&lt;nsIMsgIdentity&gt; identity( do_QueryElementAt(identityArray, i, &amp;rv));</span>
<a href="#l17.23"></a><span id="l17.23">       bool identityStillUsed = false;</span>
<a href="#l17.24"></a><span id="l17.24">       // for each identity, see if any existing account still uses it,</span>
<a href="#l17.25"></a><span id="l17.25">       // and if not, clear it.</span>
<a href="#l17.26"></a><span id="l17.26">       // Note that we are also searching here accounts with missing servers from</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineat">@@ -738,20 +738,21 @@ nsMsgAccountManager::RemoveAccount(nsIMs</span>
<a href="#l17.28"></a><span id="l17.28">         uint32_t index;</span>
<a href="#l17.29"></a><span id="l17.29">         for (index = 0; index &lt; numAccounts &amp;&amp; !identityStillUsed; index++)</span>
<a href="#l17.30"></a><span id="l17.30">         {</span>
<a href="#l17.31"></a><span id="l17.31">           nsCOMPtr&lt;nsIMsgAccount&gt; existingAccount;</span>
<a href="#l17.32"></a><span id="l17.32">           rv = m_accounts-&gt;QueryElementAt(index, NS_GET_IID(nsIMsgAccount),</span>
<a href="#l17.33"></a><span id="l17.33">                                           (void **)getter_AddRefs(existingAccount));</span>
<a href="#l17.34"></a><span id="l17.34">           if (NS_SUCCEEDED(rv))</span>
<a href="#l17.35"></a><span id="l17.35">           {</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-            nsCOMPtr&lt;nsISupportsArray&gt; existingIdentitiesArray;</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+            nsCOMPtr&lt;nsIArray&gt; existingIdentitiesArray;</span>
<a href="#l17.38"></a><span id="l17.38"> </span>
<a href="#l17.39"></a><span id="l17.39">             rv = existingAccount-&gt;GetIdentities(getter_AddRefs(existingIdentitiesArray));</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-            if (existingIdentitiesArray-&gt;IndexOf(identity) != kNotFound)</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+            uint32_t pos;</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+            if (NS_SUCCEEDED(existingIdentitiesArray-&gt;IndexOf(0, identity, &amp;pos)))</span>
<a href="#l17.43"></a><span id="l17.43">             {</span>
<a href="#l17.44"></a><span id="l17.44">               identityStillUsed = true;</span>
<a href="#l17.45"></a><span id="l17.45">               break;</span>
<a href="#l17.46"></a><span id="l17.46">             }</span>
<a href="#l17.47"></a><span id="l17.47">           }</span>
<a href="#l17.48"></a><span id="l17.48">         }</span>
<a href="#l17.49"></a><span id="l17.49">       }</span>
<a href="#l17.50"></a><span id="l17.50">       // clear out all identity information if no other account uses it.</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineat">@@ -1161,94 +1162,81 @@ nsMsgAccountManager::GetAccounts(nsISupp</span>
<a href="#l17.52"></a><span id="l17.52">     }</span>
<a href="#l17.53"></a><span id="l17.53">     nsCOMPtr&lt;nsISupports&gt; accountsSupport = do_QueryInterface(existingAccount);</span>
<a href="#l17.54"></a><span id="l17.54">     accounts-&gt;AppendElement(accountsSupport);</span>
<a href="#l17.55"></a><span id="l17.55">   }</span>
<a href="#l17.56"></a><span id="l17.56">   accounts.swap(*_retval);</span>
<a href="#l17.57"></a><span id="l17.57">   return NS_OK;</span>
<a href="#l17.58"></a><span id="l17.58"> }</span>
<a href="#l17.59"></a><span id="l17.59"> </span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-/* nsISupportsArray GetAllIdentities (); */</span>
<a href="#l17.61"></a><span id="l17.61"> NS_IMETHODIMP</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-nsMsgAccountManager::GetAllIdentities(nsISupportsArray **_retval)</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+nsMsgAccountManager::GetAllIdentities(nsIArray **_retval)</span>
<a href="#l17.64"></a><span id="l17.64"> {</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-  nsresult rv;</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-  rv = LoadAccounts();</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+  nsresult rv = LoadAccounts();</span>
<a href="#l17.68"></a><span id="l17.68">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.69"></a><span id="l17.69"> </span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-  rv = NS_NewISupportsArray(getter_AddRefs(identities));</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; result(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+  uint32_t count;</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+  rv = m_accounts-&gt;Count(&amp;count);</span>
<a href="#l17.77"></a><span id="l17.77">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.78"></a><span id="l17.78"> </span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-  // convert hash table-&gt;nsISupportsArray of identities</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">-  m_accounts-&gt;EnumerateForwards(getIdentitiesToArray,</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-                                (void *)(nsISupportsArray*)identities);</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineminus">-  // convert nsISupportsArray-&gt;nsISupportsArray</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineminus">-  // when do we free the nsISupportsArray?</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineminus">-  identities.swap(*_retval);</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineminus">-  return rv;</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineminus">-}</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineminus">-</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-bool</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineminus">-nsMsgAccountManager::addIdentityIfUnique(nsISupports *element, void *aData)</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineminus">-{</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-  nsresult rv;</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIdentity&gt; identity = do_QueryInterface(element, &amp;rv);</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-    return true;</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineminus">-</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineminus">-  nsISupportsArray *array = (nsISupportsArray*)aData;</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineminus">-</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineminus">-  nsCString key;</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">-  rv = identity-&gt;GetKey(key);</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-    return true;</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-  uint32_t count = 0;</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-  rv = array-&gt;Count(&amp;count);</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineminus">-    return true;</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineminus">-</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineminus">-  bool found=false;</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineminus">-  uint32_t i;</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineminus">-  for (i = 0; i &lt; count; i++) {</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity( do_QueryElementAt(array, i, &amp;rv));</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccount&gt; account = do_QueryElementAt(m_accounts, i, &amp;rv);</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+      continue;</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+    rv = account-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+      continue;</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineplus">+</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineplus">+    uint32_t idCount;</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+    rv = identities-&gt;GetLength(&amp;idCount);</span>
<a href="#l17.125"></a><span id="l17.125">     if (NS_FAILED(rv))</span>
<a href="#l17.126"></a><span id="l17.126">       continue;</span>
<a href="#l17.127"></a><span id="l17.127"> </span>
<a href="#l17.128"></a><span id="l17.128" class="difflineminus">-    nsCString thisKey;</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineminus">-    thisIdentity-&gt;GetKey(thisKey);</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-    if (key.Equals(thisKey)) {</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-      found = true;</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineminus">-      break;</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+    for (uint32_t j = 0; j &lt; idCount; ++j) {</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIdentity&gt; identity(do_QueryElementAt(identities, j, &amp;rv));</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+        continue;</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+      nsAutoCString key;</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+      rv = identity-&gt;GetKey(key);</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+        continue;</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+      uint32_t resultCount;</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+      rv = result-&gt;GetLength(&amp;resultCount);</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineplus">+        continue;</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineplus">+      bool found = false;</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineplus">+      for (uint32_t k = 0; k &lt; resultCount &amp;&amp; !found; ++k) {</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineplus">+        nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(do_QueryElementAt(result, k, &amp;rv));</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineplus">+          continue;</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineplus">+</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineplus">+        nsAutoCString thisKey;</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineplus">+        rv = thisIdentity-&gt;GetKey(thisKey);</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+          continue;</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+        if (key == thisKey)</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+          found = true;</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineplus">+      }</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineplus">+</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineplus">+      if (!found)</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineplus">+        result-&gt;AppendElement(identity, false);</span>
<a href="#l17.165"></a><span id="l17.165">     }</span>
<a href="#l17.166"></a><span id="l17.166">   }</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineminus">-</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineminus">-  if (!found)</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineminus">-    array-&gt;AppendElement(identity);</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineminus">-</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineminus">-  return true;</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineminus">-}</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineminus">-</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineminus">-bool</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineminus">-nsMsgAccountManager::getIdentitiesToArray(nsISupports *element, void *aData)</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineminus">-{</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineminus">-  nsresult rv;</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccount&gt; account = do_QueryInterface(element, &amp;rv);</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineminus">-    return true;</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineminus">-</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineminus">-  rv = account-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineminus">-    return true;</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineminus">-</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineminus">-  identities-&gt;EnumerateForwards(addIdentityIfUnique, aData);</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineminus">-</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineminus">-  return true;</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineplus">+  result.forget(_retval);</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineplus">+  return rv;</span>
<a href="#l17.192"></a><span id="l17.192"> }</span>
<a href="#l17.193"></a><span id="l17.193"> </span>
<a href="#l17.194"></a><span id="l17.194"> static PLDHashOperator</span>
<a href="#l17.195"></a><span id="l17.195"> hashGetNonHiddenServersToArray(nsCStringHashKey::KeyType aKey,</span>
<a href="#l17.196"></a><span id="l17.196">                                nsCOMPtr&lt;nsIMsgIncomingServer&gt;&amp; aServer,</span>
<a href="#l17.197"></a><span id="l17.197">                                void* aClosure)</span>
<a href="#l17.198"></a><span id="l17.198"> {</span>
<a href="#l17.199"></a><span id="l17.199">   if (!aServer)</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineat">@@ -1480,17 +1468,17 @@ nsMsgAccountManager::LoadAccounts()</span>
<a href="#l17.201"></a><span id="l17.201">     unavailablePref.AppendLiteral(&quot;.timeFoundUnavailable&quot;);</span>
<a href="#l17.202"></a><span id="l17.202">     toLeavePref.AppendLiteral(&quot;.secondsToLeaveUnavailable&quot;);</span>
<a href="#l17.203"></a><span id="l17.203">     int32_t secondsToLeave = 0;</span>
<a href="#l17.204"></a><span id="l17.204">     int32_t timeUnavailable = 0;</span>
<a href="#l17.205"></a><span id="l17.205"> </span>
<a href="#l17.206"></a><span id="l17.206">     m_prefs-&gt;GetIntPref(toLeavePref.get(), &amp;secondsToLeave);</span>
<a href="#l17.207"></a><span id="l17.207"> </span>
<a href="#l17.208"></a><span id="l17.208">     // force load of accounts (need to find a better way to do this)</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineminus">-    nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineplus">+    nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l17.211"></a><span id="l17.211">     account-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l17.212"></a><span id="l17.212"> </span>
<a href="#l17.213"></a><span id="l17.213">     rv = account-&gt;CreateServer();</span>
<a href="#l17.214"></a><span id="l17.214">     bool deleteAccount = NS_FAILED(rv);</span>
<a href="#l17.215"></a><span id="l17.215"> </span>
<a href="#l17.216"></a><span id="l17.216">     if (secondsToLeave)</span>
<a href="#l17.217"></a><span id="l17.217">     { // we need to process timeUnavailable</span>
<a href="#l17.218"></a><span id="l17.218">       if (NS_SUCCEEDED(rv)) // clear the time if server is available</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineat">@@ -1597,21 +1585,21 @@ nsMsgAccountManager::LoadAccounts()</span>
<a href="#l17.220"></a><span id="l17.220"> // and makes sure the folder flags are set there, too</span>
<a href="#l17.221"></a><span id="l17.221"> NS_IMETHODIMP</span>
<a href="#l17.222"></a><span id="l17.222"> nsMsgAccountManager::SetSpecialFolders()</span>
<a href="#l17.223"></a><span id="l17.223"> {</span>
<a href="#l17.224"></a><span id="l17.224">   nsresult rv;</span>
<a href="#l17.225"></a><span id="l17.225">   nsCOMPtr&lt;nsIRDFService&gt; rdf = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l17.226"></a><span id="l17.226">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.227"></a><span id="l17.227"> </span>
<a href="#l17.228"></a><span id="l17.228" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l17.230"></a><span id="l17.230">   GetAllIdentities(getter_AddRefs(identities));</span>
<a href="#l17.231"></a><span id="l17.231"> </span>
<a href="#l17.232"></a><span id="l17.232">   uint32_t idCount = 0;</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineminus">-  identities-&gt;Count(&amp;idCount);</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineplus">+  identities-&gt;GetLength(&amp;idCount);</span>
<a href="#l17.235"></a><span id="l17.235"> </span>
<a href="#l17.236"></a><span id="l17.236">   uint32_t id;</span>
<a href="#l17.237"></a><span id="l17.237">   nsCString identityKey;</span>
<a href="#l17.238"></a><span id="l17.238"> </span>
<a href="#l17.239"></a><span id="l17.239">   for (id = 0; id &lt; idCount; id++)</span>
<a href="#l17.240"></a><span id="l17.240">   {</span>
<a href="#l17.241"></a><span id="l17.241">     nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(do_QueryElementAt(identities, id, &amp;rv));</span>
<a href="#l17.242"></a><span id="l17.242">     if (NS_FAILED(rv))</span>
<a href="#l17.243"></a><span id="l17.243" class="difflineat">@@ -2153,102 +2141,95 @@ nsMsgAccountManager::findServerUrl(nsCSt</span>
<a href="#l17.244"></a><span id="l17.244"> }</span>
<a href="#l17.245"></a><span id="l17.245"> </span>
<a href="#l17.246"></a><span id="l17.246"> NS_IMETHODIMP</span>
<a href="#l17.247"></a><span id="l17.247"> nsMsgAccountManager::GetFirstIdentityForServer(nsIMsgIncomingServer *aServer, nsIMsgIdentity **aIdentity)</span>
<a href="#l17.248"></a><span id="l17.248"> {</span>
<a href="#l17.249"></a><span id="l17.249">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l17.250"></a><span id="l17.250">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l17.251"></a><span id="l17.251"> </span>
<a href="#l17.252"></a><span id="l17.252" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l17.253"></a><span id="l17.253" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l17.254"></a><span id="l17.254">   nsresult rv = GetIdentitiesForServer(aServer, getter_AddRefs(identities));</span>
<a href="#l17.255"></a><span id="l17.255">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.256"></a><span id="l17.256"> </span>
<a href="#l17.257"></a><span id="l17.257">   // not all servers have identities</span>
<a href="#l17.258"></a><span id="l17.258">   // for example, Local Folders</span>
<a href="#l17.259"></a><span id="l17.259">   uint32_t numIdentities;</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineminus">-  rv = identities-&gt;Count(&amp;numIdentities);</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineplus">+  rv = identities-&gt;GetLength(&amp;numIdentities);</span>
<a href="#l17.262"></a><span id="l17.262">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.263"></a><span id="l17.263"> </span>
<a href="#l17.264"></a><span id="l17.264">   if (numIdentities &gt; 0)</span>
<a href="#l17.265"></a><span id="l17.265">   {</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineminus">-    rv = identities-&gt;QueryElementAt(0, NS_GET_IID(nsIMsgIdentity),</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineminus">-                                  (void **)getter_AddRefs(identity));</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIdentity&gt; identity(do_QueryElementAt(identities, 0, &amp;rv));</span>
<a href="#l17.270"></a><span id="l17.270">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.271"></a><span id="l17.271">     identity.swap(*aIdentity);</span>
<a href="#l17.272"></a><span id="l17.272">   }</span>
<a href="#l17.273"></a><span id="l17.273">   else</span>
<a href="#l17.274"></a><span id="l17.274">     *aIdentity = nullptr;</span>
<a href="#l17.275"></a><span id="l17.275">   return rv;</span>
<a href="#l17.276"></a><span id="l17.276"> }</span>
<a href="#l17.277"></a><span id="l17.277"> </span>
<a href="#l17.278"></a><span id="l17.278"> NS_IMETHODIMP</span>
<a href="#l17.279"></a><span id="l17.279"> nsMsgAccountManager::GetIdentitiesForServer(nsIMsgIncomingServer *server,</span>
<a href="#l17.280"></a><span id="l17.280" class="difflineminus">-                                            nsISupportsArray **_retval)</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineplus">+                                            nsIArray **_retval)</span>
<a href="#l17.282"></a><span id="l17.282"> {</span>
<a href="#l17.283"></a><span id="l17.283">   NS_ENSURE_ARG_POINTER(server);</span>
<a href="#l17.284"></a><span id="l17.284">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l17.285"></a><span id="l17.285">   nsresult rv = LoadAccounts();</span>
<a href="#l17.286"></a><span id="l17.286">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.287"></a><span id="l17.287"> </span>
<a href="#l17.288"></a><span id="l17.288" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l17.289"></a><span id="l17.289" class="difflineminus">-  rv = NS_NewISupportsArray(getter_AddRefs(identities));</span>
<a href="#l17.290"></a><span id="l17.290" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; identities(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l17.291"></a><span id="l17.291" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineplus">+</span>
<a href="#l17.293"></a><span id="l17.293" class="difflineplus">+  uint32_t length;</span>
<a href="#l17.294"></a><span id="l17.294" class="difflineplus">+  rv = m_accounts-&gt;Count(&amp;length);</span>
<a href="#l17.295"></a><span id="l17.295" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.296"></a><span id="l17.296" class="difflineplus">+</span>
<a href="#l17.297"></a><span id="l17.297" class="difflineplus">+  nsAutoCString serverKey;</span>
<a href="#l17.298"></a><span id="l17.298" class="difflineplus">+  rv = server-&gt;GetKey(serverKey);</span>
<a href="#l17.299"></a><span id="l17.299">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.300"></a><span id="l17.300"> </span>
<a href="#l17.301"></a><span id="l17.301" class="difflineminus">-  findIdentitiesByServerEntry identityInfo;</span>
<a href="#l17.302"></a><span id="l17.302" class="difflineminus">-  identityInfo.server = server;</span>
<a href="#l17.303"></a><span id="l17.303" class="difflineminus">-  identityInfo.identities = identities;</span>
<a href="#l17.304"></a><span id="l17.304" class="difflineminus">-</span>
<a href="#l17.305"></a><span id="l17.305" class="difflineminus">-  m_accounts-&gt;EnumerateForwards(findIdentitiesForServer,</span>
<a href="#l17.306"></a><span id="l17.306" class="difflineminus">-                                (void *)&amp;identityInfo);</span>
<a href="#l17.307"></a><span id="l17.307" class="difflineminus">-</span>
<a href="#l17.308"></a><span id="l17.308" class="difflineminus">-  // do an addref for the caller.</span>
<a href="#l17.309"></a><span id="l17.309" class="difflineminus">-  identities.swap(*_retval);</span>
<a href="#l17.310"></a><span id="l17.310" class="difflineplus">+  for (uint32_t i = 0; i &lt; length; ++i)</span>
<a href="#l17.311"></a><span id="l17.311" class="difflineplus">+  {</span>
<a href="#l17.312"></a><span id="l17.312" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccount&gt; account(do_QueryElementAt(m_accounts, i, &amp;rv));</span>
<a href="#l17.313"></a><span id="l17.313" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l17.314"></a><span id="l17.314" class="difflineplus">+      continue;</span>
<a href="#l17.315"></a><span id="l17.315" class="difflineplus">+</span>
<a href="#l17.316"></a><span id="l17.316" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; thisServer;</span>
<a href="#l17.317"></a><span id="l17.317" class="difflineplus">+    rv = account-&gt;GetIncomingServer(getter_AddRefs(thisServer));</span>
<a href="#l17.318"></a><span id="l17.318" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l17.319"></a><span id="l17.319" class="difflineplus">+      continue;</span>
<a href="#l17.320"></a><span id="l17.320" class="difflineplus">+</span>
<a href="#l17.321"></a><span id="l17.321" class="difflineplus">+    nsAutoCString thisServerKey;</span>
<a href="#l17.322"></a><span id="l17.322" class="difflineplus">+    rv = thisServer-&gt;GetKey(thisServerKey);</span>
<a href="#l17.323"></a><span id="l17.323" class="difflineplus">+    if (serverKey.Equals(thisServerKey))</span>
<a href="#l17.324"></a><span id="l17.324" class="difflineplus">+    {</span>
<a href="#l17.325"></a><span id="l17.325" class="difflineplus">+      nsCOMPtr&lt;nsIArray&gt; theseIdentities;</span>
<a href="#l17.326"></a><span id="l17.326" class="difflineplus">+      rv = account-&gt;GetIdentities(getter_AddRefs(theseIdentities));</span>
<a href="#l17.327"></a><span id="l17.327" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l17.328"></a><span id="l17.328" class="difflineplus">+      {</span>
<a href="#l17.329"></a><span id="l17.329" class="difflineplus">+        uint32_t theseLength;</span>
<a href="#l17.330"></a><span id="l17.330" class="difflineplus">+        rv = theseIdentities-&gt;GetLength(&amp;theseLength);</span>
<a href="#l17.331"></a><span id="l17.331" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l17.332"></a><span id="l17.332" class="difflineplus">+        {</span>
<a href="#l17.333"></a><span id="l17.333" class="difflineplus">+          for (uint32_t j = 0; j &lt; theseLength; ++j)</span>
<a href="#l17.334"></a><span id="l17.334" class="difflineplus">+          {</span>
<a href="#l17.335"></a><span id="l17.335" class="difflineplus">+            nsCOMPtr&lt;nsISupports&gt; id(do_QueryElementAt(theseIdentities, j, &amp;rv));</span>
<a href="#l17.336"></a><span id="l17.336" class="difflineplus">+            if (NS_SUCCEEDED(rv))</span>
<a href="#l17.337"></a><span id="l17.337" class="difflineplus">+              identities-&gt;AppendElement(id, false);</span>
<a href="#l17.338"></a><span id="l17.338" class="difflineplus">+          }</span>
<a href="#l17.339"></a><span id="l17.339" class="difflineplus">+        }</span>
<a href="#l17.340"></a><span id="l17.340" class="difflineplus">+      }</span>
<a href="#l17.341"></a><span id="l17.341" class="difflineplus">+    }</span>
<a href="#l17.342"></a><span id="l17.342" class="difflineplus">+  }</span>
<a href="#l17.343"></a><span id="l17.343" class="difflineplus">+</span>
<a href="#l17.344"></a><span id="l17.344" class="difflineplus">+  identities.forget(_retval);</span>
<a href="#l17.345"></a><span id="l17.345">   return NS_OK;</span>
<a href="#l17.346"></a><span id="l17.346"> }</span>
<a href="#l17.347"></a><span id="l17.347"> </span>
<a href="#l17.348"></a><span id="l17.348" class="difflineminus">-bool</span>
<a href="#l17.349"></a><span id="l17.349" class="difflineminus">-nsMsgAccountManager::findIdentitiesForServer(nsISupports* element, void *aData)</span>
<a href="#l17.350"></a><span id="l17.350" class="difflineminus">-{</span>
<a href="#l17.351"></a><span id="l17.351" class="difflineminus">-  nsresult rv;</span>
<a href="#l17.352"></a><span id="l17.352" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccount&gt; account = do_QueryInterface(element, &amp;rv);</span>
<a href="#l17.353"></a><span id="l17.353" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.354"></a><span id="l17.354" class="difflineminus">-    return true;</span>
<a href="#l17.355"></a><span id="l17.355" class="difflineminus">-</span>
<a href="#l17.356"></a><span id="l17.356" class="difflineminus">-  findIdentitiesByServerEntry *entry = (findIdentitiesByServerEntry*)aData;</span>
<a href="#l17.357"></a><span id="l17.357" class="difflineminus">-</span>
<a href="#l17.358"></a><span id="l17.358" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIncomingServer&gt; thisServer;</span>
<a href="#l17.359"></a><span id="l17.359" class="difflineminus">-  rv = account-&gt;GetIncomingServer(getter_AddRefs(thisServer));</span>
<a href="#l17.360"></a><span id="l17.360" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.361"></a><span id="l17.361" class="difflineminus">-    return true;</span>
<a href="#l17.362"></a><span id="l17.362" class="difflineminus">-</span>
<a href="#l17.363"></a><span id="l17.363" class="difflineminus">-  nsCString serverKey;</span>
<a href="#l17.364"></a><span id="l17.364" class="difflineminus">-//  NS_ASSERTION(thisServer, &quot;thisServer is null&quot;);</span>
<a href="#l17.365"></a><span id="l17.365" class="difflineminus">-  NS_ASSERTION(entry, &quot;entry is null&quot;);</span>
<a href="#l17.366"></a><span id="l17.366" class="difflineminus">-  NS_ASSERTION(entry-&gt;server, &quot;entry-&gt;server is null&quot;);</span>
<a href="#l17.367"></a><span id="l17.367" class="difflineminus">-  // if this happens, bail.</span>
<a href="#l17.368"></a><span id="l17.368" class="difflineminus">-  if (!thisServer || !entry || !(entry-&gt;server))</span>
<a href="#l17.369"></a><span id="l17.369" class="difflineminus">-    return true;</span>
<a href="#l17.370"></a><span id="l17.370" class="difflineminus">-</span>
<a href="#l17.371"></a><span id="l17.371" class="difflineminus">-  entry-&gt;server-&gt;GetKey(serverKey);</span>
<a href="#l17.372"></a><span id="l17.372" class="difflineminus">-  nsCString thisServerKey;</span>
<a href="#l17.373"></a><span id="l17.373" class="difflineminus">-  thisServer-&gt;GetKey(thisServerKey);</span>
<a href="#l17.374"></a><span id="l17.374" class="difflineminus">-  if (serverKey.Equals(thisServerKey))</span>
<a href="#l17.375"></a><span id="l17.375" class="difflineminus">-  {</span>
<a href="#l17.376"></a><span id="l17.376" class="difflineminus">-    // add all these elements to the nsISupports array</span>
<a href="#l17.377"></a><span id="l17.377" class="difflineminus">-    nsCOMPtr&lt;nsISupportsArray&gt; theseIdentities;</span>
<a href="#l17.378"></a><span id="l17.378" class="difflineminus">-    rv = account-&gt;GetIdentities(getter_AddRefs(theseIdentities));</span>
<a href="#l17.379"></a><span id="l17.379" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l17.380"></a><span id="l17.380" class="difflineminus">-      entry-&gt;identities-&gt;AppendElements(theseIdentities);</span>
<a href="#l17.381"></a><span id="l17.381" class="difflineminus">-  }</span>
<a href="#l17.382"></a><span id="l17.382" class="difflineminus">-</span>
<a href="#l17.383"></a><span id="l17.383" class="difflineminus">-  return true;</span>
<a href="#l17.384"></a><span id="l17.384" class="difflineminus">-}</span>
<a href="#l17.385"></a><span id="l17.385" class="difflineminus">-</span>
<a href="#l17.386"></a><span id="l17.386"> NS_IMETHODIMP</span>
<a href="#l17.387"></a><span id="l17.387"> nsMsgAccountManager::GetServersForIdentity(nsIMsgIdentity *identity,</span>
<a href="#l17.388"></a><span id="l17.388">                                            nsISupportsArray **_retval)</span>
<a href="#l17.389"></a><span id="l17.389"> {</span>
<a href="#l17.390"></a><span id="l17.390">   NS_ENSURE_ARG_POINTER(identity);</span>
<a href="#l17.391"></a><span id="l17.391"> </span>
<a href="#l17.392"></a><span id="l17.392">   nsresult rv;</span>
<a href="#l17.393"></a><span id="l17.393">   rv = LoadAccounts();</span>
<a href="#l17.394"></a><span id="l17.394" class="difflineat">@@ -2273,21 +2254,21 @@ nsMsgAccountManager::findServersForIdent</span>
<a href="#l17.395"></a><span id="l17.395"> {</span>
<a href="#l17.396"></a><span id="l17.396">   nsresult rv;</span>
<a href="#l17.397"></a><span id="l17.397">   nsCOMPtr&lt;nsIMsgAccount&gt; account = do_QueryInterface(element, &amp;rv);</span>
<a href="#l17.398"></a><span id="l17.398">   if (NS_FAILED(rv))</span>
<a href="#l17.399"></a><span id="l17.399">     return true;</span>
<a href="#l17.400"></a><span id="l17.400"> </span>
<a href="#l17.401"></a><span id="l17.401">   findServersByIdentityEntry *entry = (findServersByIdentityEntry*)aData;</span>
<a href="#l17.402"></a><span id="l17.402"> </span>
<a href="#l17.403"></a><span id="l17.403" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l17.404"></a><span id="l17.404" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l17.405"></a><span id="l17.405">   account-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l17.406"></a><span id="l17.406"> </span>
<a href="#l17.407"></a><span id="l17.407">   uint32_t idCount=0;</span>
<a href="#l17.408"></a><span id="l17.408" class="difflineminus">-  identities-&gt;Count(&amp;idCount);</span>
<a href="#l17.409"></a><span id="l17.409" class="difflineplus">+  identities-&gt;GetLength(&amp;idCount);</span>
<a href="#l17.410"></a><span id="l17.410"> </span>
<a href="#l17.411"></a><span id="l17.411">   uint32_t id;</span>
<a href="#l17.412"></a><span id="l17.412">   nsCString identityKey;</span>
<a href="#l17.413"></a><span id="l17.413">   rv = entry-&gt;identity-&gt;GetKey(identityKey);</span>
<a href="#l17.414"></a><span id="l17.414">   for (id = 0; id &lt; idCount; id++)</span>
<a href="#l17.415"></a><span id="l17.415">   {</span>
<a href="#l17.416"></a><span id="l17.416">     nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity( do_QueryElementAt(identities, id, &amp;rv));</span>
<a href="#l17.417"></a><span id="l17.417">     if (NS_SUCCEEDED(rv))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.h</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -153,34 +153,25 @@ private:</span>
<a href="#l18.4"></a><span id="l18.4">     </span>
<a href="#l18.5"></a><span id="l18.5">   static PLDHashOperator hashUnloadServer(nsCStringHashKey::KeyType aKey, nsCOMPtr&lt;nsIMsgIncomingServer&gt;&amp; aServer, void* aClosure);</span>
<a href="#l18.6"></a><span id="l18.6"> </span>
<a href="#l18.7"></a><span id="l18.7">   //</span>
<a href="#l18.8"></a><span id="l18.8">   // account enumerators</span>
<a href="#l18.9"></a><span id="l18.9">   // (&quot;element&quot; is always an account)</span>
<a href="#l18.10"></a><span id="l18.10">   //</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  // find the identities that correspond to the given server</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-  static bool findIdentitiesForServer(nsISupports *element, void *aData);</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-</span>
<a href="#l18.15"></a><span id="l18.15">   // find the servers that correspond to the given identity</span>
<a href="#l18.16"></a><span id="l18.16">   static bool findServersForIdentity (nsISupports *element, void *aData);</span>
<a href="#l18.17"></a><span id="l18.17"> </span>
<a href="#l18.18"></a><span id="l18.18">   static bool findServerIndexByServer(nsISupports *element, void *aData);</span>
<a href="#l18.19"></a><span id="l18.19">   // find the account with the given key</span>
<a href="#l18.20"></a><span id="l18.20">   static bool findAccountByKey (nsISupports *element, void *aData);</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22">   static bool findAccountByServerKey (nsISupports *element, void *aData);</span>
<a href="#l18.23"></a><span id="l18.23"> </span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-  // load up the identities into the given nsISupportsArray</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-  static bool getIdentitiesToArray(nsISupports *element, void *aData);</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-  // add identities if they don't alreadby exist in the given nsISupportsArray</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-  static bool addIdentityIfUnique(nsISupports *element, void *aData);</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-</span>
<a href="#l18.30"></a><span id="l18.30">   //</span>
<a href="#l18.31"></a><span id="l18.31">   // server enumerators</span>
<a href="#l18.32"></a><span id="l18.32">   // (&quot;element&quot; is always a server)</span>
<a href="#l18.33"></a><span id="l18.33">   //</span>
<a href="#l18.34"></a><span id="l18.34"> </span>
<a href="#l18.35"></a><span id="l18.35">   // find the server given by {username, hostname, port, type}</span>
<a href="#l18.36"></a><span id="l18.36">   static PLDHashOperator findServerUrl(nsCStringHashKey::KeyType aKey,</span>
<a href="#l18.37"></a><span id="l18.37">                                        nsCOMPtr&lt;nsIMsgIncomingServer&gt;&amp; aServer,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManagerDS.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManagerDS.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -731,24 +731,24 @@ nsMsgAccountManagerDataSource::serverHas</span>
<a href="#l19.4"></a><span id="l19.4"> {</span>
<a href="#l19.5"></a><span id="l19.5">   nsresult rv;</span>
<a href="#l19.6"></a><span id="l19.6">   *aResult = false;</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8">   nsCOMPtr&lt;nsIMsgAccountManager&gt; am = do_QueryReferent(mAccountManager, &amp;rv);</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l19.14"></a><span id="l19.14">   rv = am-&gt;GetIdentitiesForServer(aServer, getter_AddRefs(identities));</span>
<a href="#l19.15"></a><span id="l19.15"> </span>
<a href="#l19.16"></a><span id="l19.16">   // no identities just means no arcs</span>
<a href="#l19.17"></a><span id="l19.17">   if (NS_FAILED(rv)) return NS_OK;</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19">   uint32_t count;</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-  rv = identities-&gt;Count(&amp;count);</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+  rv = identities-&gt;GetLength(&amp;count);</span>
<a href="#l19.22"></a><span id="l19.22">   if (NS_FAILED(rv)) return NS_OK;</span>
<a href="#l19.23"></a><span id="l19.23"> </span>
<a href="#l19.24"></a><span id="l19.24">   if (count &gt;0)</span>
<a href="#l19.25"></a><span id="l19.25">     *aResult = true;</span>
<a href="#l19.26"></a><span id="l19.26">   return NS_OK;</span>
<a href="#l19.27"></a><span id="l19.27"> }</span>
<a href="#l19.28"></a><span id="l19.28"> </span>
<a href="#l19.29"></a><span id="l19.29"> // enumeration function to convert each server (element)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/src/nsMsgOfflineManager.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgOfflineManager.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -19,18 +19,20 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l20.5"></a><span id="l20.5"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l20.6"></a><span id="l20.6"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l20.7"></a><span id="l20.7"> #include &quot;nsMsgNewsCID.h&quot;</span>
<a href="#l20.8"></a><span id="l20.8"> #include &quot;nsINntpService.h&quot;</span>
<a href="#l20.9"></a><span id="l20.9"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l20.10"></a><span id="l20.10"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l20.11"></a><span id="l20.11"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+#include &quot;nsIArray.h&quot;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l20.14"></a><span id="l20.14"> </span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-static NS_DEFINE_CID(kMsgSendLaterCID, NS_MSGSENDLATER_CID); </span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+static NS_DEFINE_CID(kMsgSendLaterCID, NS_MSGSENDLATER_CID);</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18"> NS_IMPL_THREADSAFE_ISUPPORTS5(nsMsgOfflineManager,</span>
<a href="#l20.19"></a><span id="l20.19">                               nsIMsgOfflineManager,</span>
<a href="#l20.20"></a><span id="l20.20">                               nsIMsgSendLaterListener,</span>
<a href="#l20.21"></a><span id="l20.21">                               nsIObserver,</span>
<a href="#l20.22"></a><span id="l20.22">                               nsISupportsWeakReference,</span>
<a href="#l20.23"></a><span id="l20.23">                               nsIUrlListener)</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25" class="difflineat">@@ -181,35 +183,29 @@ nsresult nsMsgOfflineManager::SendUnsent</span>
<a href="#l20.26"></a><span id="l20.26">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = </span>
<a href="#l20.27"></a><span id="l20.27">            do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l20.28"></a><span id="l20.28">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.29"></a><span id="l20.29">   // now we have to iterate over the identities, finding the *unique* unsent messages folder</span>
<a href="#l20.30"></a><span id="l20.30">   // for each one, determine if they have unsent messages, and if so, add them to the list</span>
<a href="#l20.31"></a><span id="l20.31">   // of identities to send unsent messages from.</span>
<a href="#l20.32"></a><span id="l20.32">   // However, I think there's only ever one unsent messages folder at the moment,</span>
<a href="#l20.33"></a><span id="l20.33">   // so I think we'll go with that for now.</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l20.36"></a><span id="l20.36"> </span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; accountManager) </span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; accountManager)</span>
<a href="#l20.39"></a><span id="l20.39">   {</span>
<a href="#l20.40"></a><span id="l20.40">     rv = accountManager-&gt;GetAllIdentities(getter_AddRefs(identities));</span>
<a href="#l20.41"></a><span id="l20.41">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.42"></a><span id="l20.42">   }</span>
<a href="#l20.43"></a><span id="l20.43">   nsCOMPtr &lt;nsIMsgIdentity&gt; identityToUse;</span>
<a href="#l20.44"></a><span id="l20.44">   uint32_t numIndentities;</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-  identities-&gt;Count(&amp;numIndentities);</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+  identities-&gt;GetLength(&amp;numIndentities);</span>
<a href="#l20.47"></a><span id="l20.47">   for (uint32_t i = 0; i &lt; numIndentities; i++)</span>
<a href="#l20.48"></a><span id="l20.48">   {</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-    // convert supports-&gt;Identity</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; thisSupports;</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-    rv = identities-&gt;GetElementAt(i, getter_AddRefs(thisSupports));</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-    if (NS_FAILED(rv)) continue;</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-    </span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity = do_QueryInterface(thisSupports, &amp;rv);</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(do_QueryElementAt(identities, i, &amp;rv));</span>
<a href="#l20.57"></a><span id="l20.57">     if (NS_SUCCEEDED(rv) &amp;&amp; thisIdentity)</span>
<a href="#l20.58"></a><span id="l20.58">     {</span>
<a href="#l20.59"></a><span id="l20.59">       nsCOMPtr &lt;nsIMsgFolder&gt; outboxFolder;</span>
<a href="#l20.60"></a><span id="l20.60">       pMsgSendLater-&gt;GetUnsentMessagesFolder(thisIdentity, getter_AddRefs(outboxFolder));</span>
<a href="#l20.61"></a><span id="l20.61">       if (outboxFolder)</span>
<a href="#l20.62"></a><span id="l20.62">       {</span>
<a href="#l20.63"></a><span id="l20.63">         int32_t numMessages;</span>
<a href="#l20.64"></a><span id="l20.64">         outboxFolder-&gt;GetTotalMessages(false, &amp;numMessages);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/src/nsSpamSettings.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/src/nsSpamSettings.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -18,17 +18,18 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l21.5"></a><span id="l21.5"> #include &quot;nsIRDFResource.h&quot;</span>
<a href="#l21.6"></a><span id="l21.6"> #include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l21.7"></a><span id="l21.7"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l21.8"></a><span id="l21.8"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l21.9"></a><span id="l21.9"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l21.10"></a><span id="l21.10"> #include &quot;nsDateTimeFormatCID.h&quot;</span>
<a href="#l21.11"></a><span id="l21.11"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+#include &quot;nsIArray.h&quot;</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l21.15"></a><span id="l21.15"> #include &quot;nsMailDirServiceDefs.h&quot;</span>
<a href="#l21.16"></a><span id="l21.16"> #include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l21.17"></a><span id="l21.17"> #include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l21.18"></a><span id="l21.18"> #include &quot;nsISimpleEnumerator.h&quot;</span>
<a href="#l21.19"></a><span id="l21.19"> #include &quot;nsIDirectoryEnumerator.h&quot;</span>
<a href="#l21.20"></a><span id="l21.20"> #include &quot;nsIMsgHeaderParser.h&quot;</span>
<a href="#l21.21"></a><span id="l21.21"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l21.22"></a><span id="l21.22"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineat">@@ -386,26 +387,26 @@ NS_IMETHODIMP nsSpamSettings::Initialize</span>
<a href="#l21.24"></a><span id="l21.24">       nsAutoCString deferredToAccountKey;</span>
<a href="#l21.25"></a><span id="l21.25">       if (loopServer)</span>
<a href="#l21.26"></a><span id="l21.26">         loopServer-&gt;GetCharValue(&quot;deferred_to_account&quot;, deferredToAccountKey);</span>
<a href="#l21.27"></a><span id="l21.27"> </span>
<a href="#l21.28"></a><span id="l21.28">       // Add the emails for any account that defers to this one, or for the</span>
<a href="#l21.29"></a><span id="l21.29">       // account itself.</span>
<a href="#l21.30"></a><span id="l21.30">       if (accountKey.Equals(deferredToAccountKey) || accountKey.Equals(loopAccountKey))</span>
<a href="#l21.31"></a><span id="l21.31">       {</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-        nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+        nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l21.34"></a><span id="l21.34">         loopAccount-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l21.35"></a><span id="l21.35">         if (!identities)</span>
<a href="#l21.36"></a><span id="l21.36">           continue;</span>
<a href="#l21.37"></a><span id="l21.37">         uint32_t identityCount = 0;</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-        identities-&gt;Count(&amp;identityCount);</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+        identities-&gt;GetLength(&amp;identityCount);</span>
<a href="#l21.40"></a><span id="l21.40">         for (uint32_t j = 0; j &lt; identityCount; ++j)</span>
<a href="#l21.41"></a><span id="l21.41">         {</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-          nsCOMPtr&lt;nsIMsgIdentity&gt; identity(do_QueryElementAt(identities, j));</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-          if (!identity)</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+          nsCOMPtr&lt;nsIMsgIdentity&gt; identity(do_QueryElementAt(identities, j, &amp;rv));</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+          if (NS_FAILED(rv) || !identity)</span>
<a href="#l21.46"></a><span id="l21.46">             continue;</span>
<a href="#l21.47"></a><span id="l21.47">           nsAutoCString email;</span>
<a href="#l21.48"></a><span id="l21.48">           identity-&gt;GetEmail(email);</span>
<a href="#l21.49"></a><span id="l21.49">           if (!email.IsEmpty())</span>
<a href="#l21.50"></a><span id="l21.50">             mEmails.AppendElement(email);</span>
<a href="#l21.51"></a><span id="l21.51">         }</span>
<a href="#l21.52"></a><span id="l21.52">       }</span>
<a href="#l21.53"></a><span id="l21.53">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -2546,17 +2546,17 @@ NS_IMETHODIMP QuotingOutputStreamListene</span>
<a href="#l22.4"></a><span id="l22.4">       bool replyToSelfCheckAll = false;</span>
<a href="#l22.5"></a><span id="l22.5">       prefs-&gt;GetBoolPref(&quot;mailnews.reply_to_self_check_all_ident&quot;,</span>
<a href="#l22.6"></a><span id="l22.6">                          &amp;replyToSelfCheckAll);</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8">       nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l22.9"></a><span id="l22.9">         do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l22.10"></a><span id="l22.10">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-      nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+      nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l22.14"></a><span id="l22.14">       nsCString accountKey;</span>
<a href="#l22.15"></a><span id="l22.15">       mOrigMsgHdr-&gt;GetAccountKey(getter_Copies(accountKey));</span>
<a href="#l22.16"></a><span id="l22.16">       if (replyToSelfCheckAll)</span>
<a href="#l22.17"></a><span id="l22.17">       {</span>
<a href="#l22.18"></a><span id="l22.18">         // Check all avaliable identities if the pref was set.</span>
<a href="#l22.19"></a><span id="l22.19">         accountManager-&gt;GetAllIdentities(getter_AddRefs(identities));</span>
<a href="#l22.20"></a><span id="l22.20">       }</span>
<a href="#l22.21"></a><span id="l22.21">       else if (!accountKey.IsEmpty())</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -2588,22 +2588,21 @@ NS_IMETHODIMP QuotingOutputStreamListene</span>
<a href="#l22.23"></a><span id="l22.23">       bool isReplyToSelf = false;</span>
<a href="#l22.24"></a><span id="l22.24">       if (identities)</span>
<a href="#l22.25"></a><span id="l22.25">       {</span>
<a href="#l22.26"></a><span id="l22.26">         // Go through the identities to see if any of them is the author of</span>
<a href="#l22.27"></a><span id="l22.27">         // the email.</span>
<a href="#l22.28"></a><span id="l22.28">         nsCOMPtr&lt;nsIMsgIdentity&gt; lookupIdentity;</span>
<a href="#l22.29"></a><span id="l22.29"> </span>
<a href="#l22.30"></a><span id="l22.30">         uint32_t count = 0;</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-        identities-&gt;Count(&amp;count);</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+        identities-&gt;GetLength(&amp;count);</span>
<a href="#l22.33"></a><span id="l22.33"> </span>
<a href="#l22.34"></a><span id="l22.34">         for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l22.35"></a><span id="l22.35">         {</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-          rv = identities-&gt;QueryElementAt(i, NS_GET_IID(nsIMsgIdentity),</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-                                    getter_AddRefs(lookupIdentity));</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+          lookupIdentity = do_QueryElementAt(identities, i, &amp;rv);</span>
<a href="#l22.39"></a><span id="l22.39">           if (NS_FAILED(rv))</span>
<a href="#l22.40"></a><span id="l22.40">             continue;</span>
<a href="#l22.41"></a><span id="l22.41"> </span>
<a href="#l22.42"></a><span id="l22.42">           nsCString curIdentityEmail;</span>
<a href="#l22.43"></a><span id="l22.43">           lookupIdentity-&gt;GetEmail(curIdentityEmail);</span>
<a href="#l22.44"></a><span id="l22.44"> </span>
<a href="#l22.45"></a><span id="l22.45">           // See if it's a reply to own message, but not a reply between identities.</span>
<a href="#l22.46"></a><span id="l22.46">           if (curIdentityEmail.Equals(fromEmailAddress))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendLater.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendLater.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -24,16 +24,17 @@</span>
<a href="#l23.4"></a><span id="l23.4"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l23.5"></a><span id="l23.5"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l23.6"></a><span id="l23.6"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l23.7"></a><span id="l23.7"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l23.8"></a><span id="l23.8"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l23.9"></a><span id="l23.9"> #include &quot;nsIMsgLocalMailFolder.h&quot;</span>
<a href="#l23.10"></a><span id="l23.10"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l23.11"></a><span id="l23.11"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l23.13"></a><span id="l23.13"> </span>
<a href="#l23.14"></a><span id="l23.14"> // Consts for checking and sending mail in milliseconds</span>
<a href="#l23.15"></a><span id="l23.15"> </span>
<a href="#l23.16"></a><span id="l23.16"> // 1 second from mail into the unsent messages folder to initially trying to</span>
<a href="#l23.17"></a><span id="l23.17"> // send it.</span>
<a href="#l23.18"></a><span id="l23.18"> const uint32_t kInitialMessageSendTime = 1000;</span>
<a href="#l23.19"></a><span id="l23.19"> </span>
<a href="#l23.20"></a><span id="l23.20"> NS_IMPL_ISUPPORTS7(nsMsgSendLater,</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineat">@@ -1426,30 +1427,29 @@ nsresult</span>
<a href="#l23.22"></a><span id="l23.22"> nsMsgSendLater::GetIdentityFromKey(const char *aKey, nsIMsgIdentity  **aIdentity)</span>
<a href="#l23.23"></a><span id="l23.23"> {</span>
<a href="#l23.24"></a><span id="l23.24">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l23.25"></a><span id="l23.25"> </span>
<a href="#l23.26"></a><span id="l23.26">   nsresult rv;</span>
<a href="#l23.27"></a><span id="l23.27">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = </span>
<a href="#l23.28"></a><span id="l23.28">     do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.29"></a><span id="l23.29">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">- </span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+</span>
<a href="#l23.32"></a><span id="l23.32">   if (aKey)</span>
<a href="#l23.33"></a><span id="l23.33">   {</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-    nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+    nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l23.36"></a><span id="l23.36">     if (NS_SUCCEEDED(accountManager-&gt;GetAllIdentities(getter_AddRefs(identities))))</span>
<a href="#l23.37"></a><span id="l23.37">     {</span>
<a href="#l23.38"></a><span id="l23.38">       nsCOMPtr&lt;nsIMsgIdentity&gt; lookupIdentity;</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-      uint32_t          count = 0;</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineplus">+      uint32_t count = 0;</span>
<a href="#l23.41"></a><span id="l23.41"> </span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-      identities-&gt;Count(&amp;count);</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+      identities-&gt;GetLength(&amp;count);</span>
<a href="#l23.44"></a><span id="l23.44">       for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l23.45"></a><span id="l23.45">       {</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-        rv = identities-&gt;QueryElementAt(i, NS_GET_IID(nsIMsgIdentity),</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-                                  getter_AddRefs(lookupIdentity));</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineplus">+        lookupIdentity = do_QueryElementAt(identities, i, &amp;rv);</span>
<a href="#l23.49"></a><span id="l23.49">         if (NS_FAILED(rv))</span>
<a href="#l23.50"></a><span id="l23.50">           continue;</span>
<a href="#l23.51"></a><span id="l23.51"> </span>
<a href="#l23.52"></a><span id="l23.52">         nsCString key;</span>
<a href="#l23.53"></a><span id="l23.53">         lookupIdentity-&gt;GetKey(key);</span>
<a href="#l23.54"></a><span id="l23.54">         if (key.Equals(aKey))</span>
<a href="#l23.55"></a><span id="l23.55">         {</span>
<a href="#l23.56"></a><span id="l23.56">           NS_IF_ADDREF(*aIdentity = lookupIdentity);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -511,25 +511,26 @@ var Gloda = {</span>
<a href="#l24.4"></a><span id="l24.4">     let myEmailAddresses = {}; // process each email at most once; stored here</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6">     let fullName, fallbackName;</span>
<a href="#l24.7"></a><span id="l24.7">     let existingIdentities = [];</span>
<a href="#l24.8"></a><span id="l24.8">     let identitiesToCreate = [];</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10">     let msgAccountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;].</span>
<a href="#l24.11"></a><span id="l24.11">                             getService(Ci.nsIMsgAccountManager);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-    let numIdentities = msgAccountManager.allIdentities.Count();</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+    let numIdentities = msgAccountManager.allIdentities.length;</span>
<a href="#l24.14"></a><span id="l24.14"> </span>
<a href="#l24.15"></a><span id="l24.15">     // nothing to do if there are no accounts/identities.</span>
<a href="#l24.16"></a><span id="l24.16">     if (!numIdentities)</span>
<a href="#l24.17"></a><span id="l24.17">       return;</span>
<a href="#l24.18"></a><span id="l24.18"> </span>
<a href="#l24.19"></a><span id="l24.19">     for (let iIdentity = 0; iIdentity &lt; numIdentities; iIdentity++) {</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-      let msgIdentity = msgAccountManager.allIdentities.GetElementAt(iIdentity)</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-                                         .QueryInterface(Ci.nsIMsgIdentity);</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineplus">+      let msgIdentity =</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineplus">+        msgAccountManager.allIdentities.queryElementAt(iIdentity,</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+                                                       Ci.nsIMsgIdentity);</span>
<a href="#l24.25"></a><span id="l24.25"> </span>
<a href="#l24.26"></a><span id="l24.26">       if (!fullName)</span>
<a href="#l24.27"></a><span id="l24.27">         fullName = msgIdentity.fullName;</span>
<a href="#l24.28"></a><span id="l24.28">       if (!fallbackName)</span>
<a href="#l24.29"></a><span id="l24.29">         fallbackName = msgIdentity.email;</span>
<a href="#l24.30"></a><span id="l24.30"> </span>
<a href="#l24.31"></a><span id="l24.31">       let emailAddress = msgIdentity.email;</span>
<a href="#l24.32"></a><span id="l24.32">       let replyTo = msgIdentity.replyTo;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -26,16 +26,18 @@</span>
<a href="#l25.4"></a><span id="l25.4"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l25.5"></a><span id="l25.5"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l25.6"></a><span id="l25.6"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l25.7"></a><span id="l25.7"> #include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l25.8"></a><span id="l25.8"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l25.9"></a><span id="l25.9"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l25.10"></a><span id="l25.10"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l25.11"></a><span id="l25.11"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+#include &quot;nsIArray.h&quot;</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l25.14"></a><span id="l25.14"> </span>
<a href="#l25.15"></a><span id="l25.15"> #define MDN_NOT_IN_TO_CC          ((int) 0x0001)</span>
<a href="#l25.16"></a><span id="l25.16"> #define MDN_OUTSIDE_DOMAIN        ((int) 0x0002)</span>
<a href="#l25.17"></a><span id="l25.17"> </span>
<a href="#l25.18"></a><span id="l25.18"> #define HEADER_RETURN_PATH          &quot;Return-Path&quot;</span>
<a href="#l25.19"></a><span id="l25.19"> #define HEADER_DISPOSITION_NOTIFICATION_TO  &quot;Disposition-Notification-To&quot;</span>
<a href="#l25.20"></a><span id="l25.20"> #define HEADER_APPARENTLY_TO        &quot;Apparently-To&quot;</span>
<a href="#l25.21"></a><span id="l25.21"> #define HEADER_ORIGINAL_RECIPIENT     &quot;Original-Recipient&quot;</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineat">@@ -895,28 +897,28 @@ nsresult nsMsgMdnGenerator::InitAndProce</span>
<a href="#l25.23"></a><span id="l25.23"> </span>
<a href="#l25.24"></a><span id="l25.24">           if (m_server)</span>
<a href="#l25.25"></a><span id="l25.25">           {</span>
<a href="#l25.26"></a><span id="l25.26">             // Find the correct identity based on the &quot;To:&quot; and &quot;Cc:&quot; header</span>
<a href="#l25.27"></a><span id="l25.27">             nsCString mailTo;</span>
<a href="#l25.28"></a><span id="l25.28">             nsCString mailCC;</span>
<a href="#l25.29"></a><span id="l25.29">             m_headers-&gt;ExtractHeader(HEADER_TO, true, getter_Copies(mailTo));</span>
<a href="#l25.30"></a><span id="l25.30">             m_headers-&gt;ExtractHeader(HEADER_CC, true, getter_Copies(mailCC));</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-            nsCOMPtr&lt;nsISupportsArray&gt; servIdentities;</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+            nsCOMPtr&lt;nsIArray&gt; servIdentities;</span>
<a href="#l25.33"></a><span id="l25.33">             accountManager-&gt;GetIdentitiesForServer(m_server, getter_AddRefs(servIdentities));</span>
<a href="#l25.34"></a><span id="l25.34">             if (servIdentities)</span>
<a href="#l25.35"></a><span id="l25.35">             {</span>
<a href="#l25.36"></a><span id="l25.36">               nsCOMPtr&lt;nsIMsgIdentity&gt; ident;</span>
<a href="#l25.37"></a><span id="l25.37">               nsCString identEmail;</span>
<a href="#l25.38"></a><span id="l25.38">               uint32_t count = 0;</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineminus">-              servIdentities-&gt;Count(&amp;count);</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineplus">+              servIdentities-&gt;GetLength(&amp;count);</span>
<a href="#l25.41"></a><span id="l25.41">               // First check in the &quot;To:&quot; header</span>
<a href="#l25.42"></a><span id="l25.42">               for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l25.43"></a><span id="l25.43">               {</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineminus">-                rv = servIdentities-&gt;QueryElementAt(i, NS_GET_IID(nsIMsgIdentity),getter_AddRefs(ident));</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineplus">+                ident = do_QueryElementAt(servIdentities, i, &amp;rv);</span>
<a href="#l25.46"></a><span id="l25.46">                 if (NS_FAILED(rv))</span>
<a href="#l25.47"></a><span id="l25.47">                   continue;</span>
<a href="#l25.48"></a><span id="l25.48">                 ident-&gt;GetEmail(identEmail);</span>
<a href="#l25.49"></a><span id="l25.49">                 if (!mailTo.IsEmpty() &amp;&amp; !identEmail.IsEmpty() &amp;&amp;</span>
<a href="#l25.50"></a><span id="l25.50">                     mailTo.Find(identEmail, CaseInsensitiveCompare) != kNotFound)</span>
<a href="#l25.51"></a><span id="l25.51">                 {</span>
<a href="#l25.52"></a><span id="l25.52">                   m_identity = ident;</span>
<a href="#l25.53"></a><span id="l25.53">                   break;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -9365,21 +9365,21 @@ NS_IMETHODIMP nsImapMailFolder::GetCusto</span>
<a href="#l26.4"></a><span id="l26.4">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.5"></a><span id="l26.5">       ourIdentity-&gt;GetEmail(ourEmailAddress);</span>
<a href="#l26.6"></a><span id="l26.6">       int32_t atPos = ourEmailAddress.FindChar('@');</span>
<a href="#l26.7"></a><span id="l26.7">       if (atPos != kNotFound)</span>
<a href="#l26.8"></a><span id="l26.8">       {</span>
<a href="#l26.9"></a><span id="l26.9">         nsCString otherUsersEmailAddress;</span>
<a href="#l26.10"></a><span id="l26.10">         GetFolderOwnerUserName(otherUsersEmailAddress);</span>
<a href="#l26.11"></a><span id="l26.11">         otherUsersEmailAddress.Append(Substring(ourEmailAddress, atPos, ourEmailAddress.Length()));</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-        nsCOMPtr &lt;nsISupportsArray&gt; identities;</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+        nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l26.14"></a><span id="l26.14">         rv = accountManager-&gt;GetIdentitiesForServer(server, getter_AddRefs(identities));</span>
<a href="#l26.15"></a><span id="l26.15">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.16"></a><span id="l26.16">         uint32_t numIdentities;</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-        rv = identities-&gt;Count(&amp;numIdentities);</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+        rv = identities-&gt;GetLength(&amp;numIdentities);</span>
<a href="#l26.19"></a><span id="l26.19">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.20"></a><span id="l26.20">         for (uint32_t identityIndex = 0; identityIndex &lt; numIdentities; identityIndex++)</span>
<a href="#l26.21"></a><span id="l26.21">         {</span>
<a href="#l26.22"></a><span id="l26.22">           nsCOMPtr&lt;nsIMsgIdentity&gt; identity = do_QueryElementAt(identities, identityIndex);</span>
<a href="#l26.23"></a><span id="l26.23">           if (!identity)</span>
<a href="#l26.24"></a><span id="l26.24">             continue;</span>
<a href="#l26.25"></a><span id="l26.25">           nsCString identityEmail;</span>
<a href="#l26.26"></a><span id="l26.26">           identity-&gt;GetEmail(identityEmail);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/import/test/unit/resources/import_helper.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/import/test/unit/resources/import_helper.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -473,18 +473,18 @@ SettingsImportHelper.prototype =</span>
<a href="#l27.4"></a><span id="l27.4"> </span>
<a href="#l27.5"></a><span id="l27.5">     if (expected.type == &quot;pop3&quot;)</span>
<a href="#l27.6"></a><span id="l27.6">       this._checkPop3IncomingServer(expected, actual.QueryInterface(Ci.nsIPop3IncomingServer));</span>
<a href="#l27.7"></a><span id="l27.7">   },</span>
<a href="#l27.8"></a><span id="l27.8"> </span>
<a href="#l27.9"></a><span id="l27.9">   _checkAccount: function(expected, actual) {</span>
<a href="#l27.10"></a><span id="l27.10">     this._checkIncomingServer(expected.incomingServer, actual.incomingServer);</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-    do_check_eq(1, actual.identities.Count());</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-    let actualIdentity = actual.identities.QueryElementAt(0, Ci.nsIMsgIdentity);</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+    do_check_eq(1, actual.identities.length);</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+    let actualIdentity = actual.identities.queryElementAt(0, Ci.nsIMsgIdentity);</span>
<a href="#l27.16"></a><span id="l27.16">     this._checkIdentity(expected.identity, actualIdentity);</span>
<a href="#l27.17"></a><span id="l27.17"> </span>
<a href="#l27.18"></a><span id="l27.18">     if (expected.incomingServer.type != &quot;nntp&quot;) {</span>
<a href="#l27.19"></a><span id="l27.19">       let actualSmtpServer = MailServices.smtp.getServerByKey(actualIdentity.smtpServerKey);</span>
<a href="#l27.20"></a><span id="l27.20">       this._checkSmtpServer(expected.smtpServer, actualSmtpServer);</span>
<a href="#l27.21"></a><span id="l27.21">     }</span>
<a href="#l27.22"></a><span id="l27.22">   },</span>
<a href="#l27.23"></a><span id="l27.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiHook.cpp</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiHook.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -197,29 +197,26 @@ bool nsMapiHook::VerifyUserName(const ns</span>
<a href="#l28.4"></a><span id="l28.4"> {</span>
<a href="#l28.5"></a><span id="l28.5">   nsresult rv;</span>
<a href="#l28.6"></a><span id="l28.6"> </span>
<a href="#l28.7"></a><span id="l28.7">   if (aUsername.IsEmpty())</span>
<a href="#l28.8"></a><span id="l28.8">     return false;</span>
<a href="#l28.9"></a><span id="l28.9"> </span>
<a href="#l28.10"></a><span id="l28.10">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager(do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l28.11"></a><span id="l28.11">   if (NS_FAILED(rv)) return false;</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-  nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l28.14"></a><span id="l28.14">   rv = accountManager-&gt;GetAllIdentities(getter_AddRefs(identities));</span>
<a href="#l28.15"></a><span id="l28.15">   if (NS_FAILED(rv)) return false;</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineminus">-  uint32_t numIndentities;</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">-  identities-&gt;Count(&amp;numIndentities);</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+  uint32_t numIndentities = 0;</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineplus">+  identities-&gt;GetLength(&amp;numIndentities);</span>
<a href="#l28.21"></a><span id="l28.21"> </span>
<a href="#l28.22"></a><span id="l28.22">   for (uint32_t i = 0; i &lt; numIndentities; i++)</span>
<a href="#l28.23"></a><span id="l28.23">   {</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineminus">-    // convert supports-&gt;Identity</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; thisSupports;</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineminus">-    rv = identities-&gt;GetElementAt(i, getter_AddRefs(thisSupports));</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineminus">-    if (NS_FAILED(rv)) continue;</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(do_QueryInterface(thisSupports, &amp;rv));</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(do_QueryElementAt(identities, i, &amp;rv));</span>
<a href="#l28.30"></a><span id="l28.30">     if (NS_SUCCEEDED(rv) &amp;&amp; thisIdentity)</span>
<a href="#l28.31"></a><span id="l28.31">     {</span>
<a href="#l28.32"></a><span id="l28.32">       nsCString email;</span>
<a href="#l28.33"></a><span id="l28.33">       rv = thisIdentity-&gt;GetEmail(email);</span>
<a href="#l28.34"></a><span id="l28.34">       if (NS_FAILED(rv)) continue;</span>
<a href="#l28.35"></a><span id="l28.35"> </span>
<a href="#l28.36"></a><span id="l28.36">       // get the username from the email and compare with the username</span>
<a href="#l28.37"></a><span id="l28.37">       int32_t index = email.FindChar('@');</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -1,9 +1,9 @@</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l29.6"></a><span id="l29.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.7"></a><span id="l29.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.8"></a><span id="l29.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.9"></a><span id="l29.9"> </span>
<a href="#l29.10"></a><span id="l29.10"> #ifdef MOZ_LOGGING</span>
<a href="#l29.11"></a><span id="l29.11"> #define FORCE_PR_LOG /* Allow logging in the release build (sorry this breaks the PCH) */</span>
<a href="#l29.12"></a><span id="l29.12"> #endif</span>
<a href="#l29.13"></a><span id="l29.13"> </span>
<a href="#l29.14"></a><span id="l29.14" class="difflineat">@@ -70,16 +70,18 @@</span>
<a href="#l29.15"></a><span id="l29.15"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l29.16"></a><span id="l29.16"> #include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l29.17"></a><span id="l29.17"> </span>
<a href="#l29.18"></a><span id="l29.18"> #include &quot;nsINntpService.h&quot;</span>
<a href="#l29.19"></a><span id="l29.19"> #include &quot;nntpCore.h&quot;</span>
<a href="#l29.20"></a><span id="l29.20"> #include &quot;nsIStreamConverterService.h&quot;</span>
<a href="#l29.21"></a><span id="l29.21"> #include &quot;nsIStreamListenerTee.h&quot;</span>
<a href="#l29.22"></a><span id="l29.22"> #include &quot;nsISocketTransport.h&quot;</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+#include &quot;nsIArray.h&quot;</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineplus">+#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l29.25"></a><span id="l29.25"> </span>
<a href="#l29.26"></a><span id="l29.26"> #include &lt;time.h&gt;</span>
<a href="#l29.27"></a><span id="l29.27"> </span>
<a href="#l29.28"></a><span id="l29.28"> #undef GetPort  // XXX Windows!</span>
<a href="#l29.29"></a><span id="l29.29"> #undef SetPort  // XXX Windows!</span>
<a href="#l29.30"></a><span id="l29.30"> </span>
<a href="#l29.31"></a><span id="l29.31"> #define PREF_NEWS_CANCEL_CONFIRM  &quot;news.cancel.confirm&quot;</span>
<a href="#l29.32"></a><span id="l29.32"> #define PREF_NEWS_CANCEL_ALERT_ON_SUCCESS &quot;news.cancel.alert_on_success&quot;</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineat">@@ -90,21 +92,16 @@</span>
<a href="#l29.34"></a><span id="l29.34"> </span>
<a href="#l29.35"></a><span id="l29.35"> // NNTP extensions are supported yet</span>
<a href="#l29.36"></a><span id="l29.36"> // until the extension code is ported,</span>
<a href="#l29.37"></a><span id="l29.37"> // we'll skip right to the first nntp command</span>
<a href="#l29.38"></a><span id="l29.38"> // after doing &quot;mode reader&quot;</span>
<a href="#l29.39"></a><span id="l29.39"> // and &quot;pushed&quot; authentication (if necessary),</span>
<a href="#l29.40"></a><span id="l29.40"> //#define HAVE_NNTP_EXTENSIONS</span>
<a href="#l29.41"></a><span id="l29.41"> </span>
<a href="#l29.42"></a><span id="l29.42" class="difflineminus">-typedef struct _cancelInfoEntry {</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineminus">-    nsCString from;</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineminus">-    nsCString old_from;</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineminus">-} cancelInfoEntry;</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineminus">-</span>
<a href="#l29.47"></a><span id="l29.47"> // quiet compiler warnings by defining these function prototypes</span>
<a href="#l29.48"></a><span id="l29.48"> char *MSG_UnEscapeSearchUrl (const char *commandSpecificData);</span>
<a href="#l29.49"></a><span id="l29.49"> </span>
<a href="#l29.50"></a><span id="l29.50"> /* Logging stuff */</span>
<a href="#l29.51"></a><span id="l29.51"> </span>
<a href="#l29.52"></a><span id="l29.52"> PRLogModuleInfo* NNTP = NULL;</span>
<a href="#l29.53"></a><span id="l29.53"> #define out     PR_LOG_ALWAYS</span>
<a href="#l29.54"></a><span id="l29.54"> </span>
<a href="#l29.55"></a><span id="l29.55" class="difflineat">@@ -3528,76 +3525,50 @@ nsresult nsNNTPProtocol::StartCancel()</span>
<a href="#l29.56"></a><span id="l29.56">   nsresult rv = SendData(NNTP_CMD_POST);</span>
<a href="#l29.57"></a><span id="l29.57"> </span>
<a href="#l29.58"></a><span id="l29.58">   m_nextState = NNTP_RESPONSE;</span>
<a href="#l29.59"></a><span id="l29.59">   m_nextStateAfterResponse = NEWS_DO_CANCEL;</span>
<a href="#l29.60"></a><span id="l29.60">   SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l29.61"></a><span id="l29.61">   return rv;</span>
<a href="#l29.62"></a><span id="l29.62"> }</span>
<a href="#l29.63"></a><span id="l29.63"> </span>
<a href="#l29.64"></a><span id="l29.64" class="difflineminus">-bool nsNNTPProtocol::CheckIfAuthor(nsISupports *aElement, void *data)</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineplus">+void nsNNTPProtocol::CheckIfAuthor(nsIMsgIdentity *aIdentity, const nsCString &amp;aOldFrom, nsCString &amp;aFrom)</span>
<a href="#l29.66"></a><span id="l29.66"> {</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineminus">-    nsresult rv;</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineminus">-</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineminus">-    cancelInfoEntry *cancelInfo = (cancelInfoEntry*) data;</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineminus">-</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineminus">-    if (!cancelInfo-&gt;from.IsEmpty()) {</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineminus">-        // already found a match, no need to go any further</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineminus">-        // keep going</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineminus">-        return true;</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineminus">-    }</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineminus">-</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIdentity&gt; identity = do_QueryInterface(aElement, &amp;rv);</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineminus">-        // keep going</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineminus">-        return true;</span>
<a href="#l29.81"></a><span id="l29.81" class="difflineminus">-    }</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineminus">-</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineminus">-    if (identity) {</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineminus">-        identity-&gt;GetEmail(cancelInfo-&gt;from);</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineminus">-        PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;from = %s&quot;, cancelInfo-&gt;from.get()));</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineminus">-    }</span>
<a href="#l29.87"></a><span id="l29.87" class="difflineminus">-</span>
<a href="#l29.88"></a><span id="l29.88" class="difflineminus">-    nsCOMPtr&lt;nsIMsgHeaderParser&gt; parser = do_GetService(NS_MAILNEWS_MIME_HEADER_PARSER_CONTRACTID, &amp;rv);</span>
<a href="#l29.89"></a><span id="l29.89" class="difflineminus">-</span>
<a href="#l29.90"></a><span id="l29.90" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineminus">-        cancelInfo-&gt;from.Truncate();</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineminus">-        return true;</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineminus">-    }</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineminus">-</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineminus">-    nsCString us;</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineminus">-    nsCString them;</span>
<a href="#l29.97"></a><span id="l29.97" class="difflineminus">-    nsresult rv1 = parser-&gt;ExtractHeaderAddressMailboxes(cancelInfo-&gt;from, us);</span>
<a href="#l29.98"></a><span id="l29.98" class="difflineminus">-    nsresult rv2 = parser-&gt;ExtractHeaderAddressMailboxes(cancelInfo-&gt;old_from,</span>
<a href="#l29.99"></a><span id="l29.99" class="difflineminus">-                                                         them);</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineminus">-</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineminus">-    PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;us = %s, them = %s&quot;, us.get(), them.get()));</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineminus">-</span>
<a href="#l29.103"></a><span id="l29.103" class="difflineminus">-    if (NS_FAILED(rv1) || NS_FAILED(rv2) || !us.Equals(them, nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineminus">-        //no match.  don't set cancel email</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineminus">-        cancelInfo-&gt;from.Truncate();</span>
<a href="#l29.106"></a><span id="l29.106" class="difflineminus">-        return true;</span>
<a href="#l29.107"></a><span id="l29.107" class="difflineminus">-    }</span>
<a href="#l29.108"></a><span id="l29.108" class="difflineminus">-    else {</span>
<a href="#l29.109"></a><span id="l29.109" class="difflineminus">-      // we have a match, stop.</span>
<a href="#l29.110"></a><span id="l29.110" class="difflineminus">-        return false;</span>
<a href="#l29.111"></a><span id="l29.111" class="difflineminus">-    }</span>
<a href="#l29.112"></a><span id="l29.112" class="difflineplus">+  nsAutoCString from;</span>
<a href="#l29.113"></a><span id="l29.113" class="difflineplus">+  nsresult rv = aIdentity-&gt;GetEmail(from);</span>
<a href="#l29.114"></a><span id="l29.114" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l29.115"></a><span id="l29.115" class="difflineplus">+    return;</span>
<a href="#l29.116"></a><span id="l29.116" class="difflineplus">+  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;from = %s&quot;, from.get()));</span>
<a href="#l29.117"></a><span id="l29.117" class="difflineplus">+</span>
<a href="#l29.118"></a><span id="l29.118" class="difflineplus">+  nsCOMPtr&lt;nsIMsgHeaderParser&gt; parser = do_GetService(NS_MAILNEWS_MIME_HEADER_PARSER_CONTRACTID, &amp;rv);</span>
<a href="#l29.119"></a><span id="l29.119" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l29.120"></a><span id="l29.120" class="difflineplus">+    return;</span>
<a href="#l29.121"></a><span id="l29.121" class="difflineplus">+</span>
<a href="#l29.122"></a><span id="l29.122" class="difflineplus">+  nsCString us;</span>
<a href="#l29.123"></a><span id="l29.123" class="difflineplus">+  nsCString them;</span>
<a href="#l29.124"></a><span id="l29.124" class="difflineplus">+  nsresult rv1 = parser-&gt;ExtractHeaderAddressMailboxes(from, us);</span>
<a href="#l29.125"></a><span id="l29.125" class="difflineplus">+  nsresult rv2 = parser-&gt;ExtractHeaderAddressMailboxes(aOldFrom, them);</span>
<a href="#l29.126"></a><span id="l29.126" class="difflineplus">+</span>
<a href="#l29.127"></a><span id="l29.127" class="difflineplus">+  PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;us = %s, them = %s&quot;, us.get(), them.get()));</span>
<a href="#l29.128"></a><span id="l29.128" class="difflineplus">+</span>
<a href="#l29.129"></a><span id="l29.129" class="difflineplus">+  if (NS_SUCCEEDED(rv1) &amp;&amp; NS_SUCCEEDED(rv2) &amp;&amp;</span>
<a href="#l29.130"></a><span id="l29.130" class="difflineplus">+      us.Equals(them, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l29.131"></a><span id="l29.131" class="difflineplus">+    aFrom = from;</span>
<a href="#l29.132"></a><span id="l29.132"> }</span>
<a href="#l29.133"></a><span id="l29.133"> </span>
<a href="#l29.134"></a><span id="l29.134"> nsresult nsNNTPProtocol::DoCancel()</span>
<a href="#l29.135"></a><span id="l29.135"> {</span>
<a href="#l29.136"></a><span id="l29.136">     int32_t status = 0;</span>
<a href="#l29.137"></a><span id="l29.137">     bool failure = false;</span>
<a href="#l29.138"></a><span id="l29.138">     nsresult rv = NS_OK;</span>
<a href="#l29.139"></a><span id="l29.139">     char *id = nullptr;</span>
<a href="#l29.140"></a><span id="l29.140">     char *subject = nullptr;</span>
<a href="#l29.141"></a><span id="l29.141">     char *newsgroups = nullptr;</span>
<a href="#l29.142"></a><span id="l29.142">     char *distribution = nullptr;</span>
<a href="#l29.143"></a><span id="l29.143">     char *body = nullptr;</span>
<a href="#l29.144"></a><span id="l29.144" class="difflineminus">-    cancelInfoEntry cancelInfo;</span>
<a href="#l29.145"></a><span id="l29.145">     bool requireConfirmationForCancel = true;</span>
<a href="#l29.146"></a><span id="l29.146">     bool showAlertAfterCancel = true;</span>
<a href="#l29.147"></a><span id="l29.147"> </span>
<a href="#l29.148"></a><span id="l29.148">     int L;</span>
<a href="#l29.149"></a><span id="l29.149"> </span>
<a href="#l29.150"></a><span id="l29.150">   /* #### Should we do a more real check than this?  If the POST command</span>
<a href="#l29.151"></a><span id="l29.151">      didn't respond with &quot;MK_NNTP_RESPONSE_POST_SEND_NOW Ok&quot;, then it's not ready for us to throw a</span>
<a href="#l29.152"></a><span id="l29.152">      message at it...   But the normal posting code doesn't do this check.</span>
<a href="#l29.153"></a><span id="l29.153" class="difflineat">@@ -3625,18 +3596,17 @@ nsresult nsNNTPProtocol::DoCancel()</span>
<a href="#l29.154"></a><span id="l29.154">   rv = brandBundle-&gt;GetStringFromName(NS_LITERAL_STRING(&quot;brandFullName&quot;).get(),</span>
<a href="#l29.155"></a><span id="l29.155">                                       getter_Copies(brandFullName));</span>
<a href="#l29.156"></a><span id="l29.156">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l29.157"></a><span id="l29.157">   NS_ConvertUTF16toUTF8 appName(brandFullName);</span>
<a href="#l29.158"></a><span id="l29.158"> </span>
<a href="#l29.159"></a><span id="l29.159">   newsgroups = m_cancelNewsgroups;</span>
<a href="#l29.160"></a><span id="l29.160">   distribution = m_cancelDistribution;</span>
<a href="#l29.161"></a><span id="l29.161">   id = m_cancelID;</span>
<a href="#l29.162"></a><span id="l29.162" class="difflineminus">-  cancelInfo.old_from = m_cancelFromHdr;</span>
<a href="#l29.163"></a><span id="l29.163" class="difflineminus">-  cancelInfo.from.Truncate();</span>
<a href="#l29.164"></a><span id="l29.164" class="difflineplus">+  nsCString oldFrom(m_cancelFromHdr);</span>
<a href="#l29.165"></a><span id="l29.165"> </span>
<a href="#l29.166"></a><span id="l29.166">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l29.167"></a><span id="l29.167">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l29.168"></a><span id="l29.168"> </span>
<a href="#l29.169"></a><span id="l29.169">   nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l29.170"></a><span id="l29.170">   if (m_runningURL)</span>
<a href="#l29.171"></a><span id="l29.171">   {</span>
<a href="#l29.172"></a><span id="l29.172">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl (do_QueryInterface(m_runningURL));</span>
<a href="#l29.173"></a><span id="l29.173" class="difflineat">@@ -3668,49 +3638,61 @@ nsresult nsNNTPProtocol::DoCancel()</span>
<a href="#l29.174"></a><span id="l29.174">      Yes, there are occasionally good reasons to do so.  Those people</span>
<a href="#l29.175"></a><span id="l29.175">      capable of making that decision (news admins) have other tools with</span>
<a href="#l29.176"></a><span id="l29.176">      which to cancel postings (like telnet.)</span>
<a href="#l29.177"></a><span id="l29.177"> </span>
<a href="#l29.178"></a><span id="l29.178">      Don't do this if server tells us it will validate user. DMB 3/19/97</span>
<a href="#l29.179"></a><span id="l29.179">    */</span>
<a href="#l29.180"></a><span id="l29.180">   bool cancelchk=false;</span>
<a href="#l29.181"></a><span id="l29.181">   rv = m_nntpServer-&gt;QueryExtension(&quot;CANCELCHK&quot;,&amp;cancelchk);</span>
<a href="#l29.182"></a><span id="l29.182" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !cancelchk) {</span>
<a href="#l29.183"></a><span id="l29.183" class="difflineplus">+  nsCString from;</span>
<a href="#l29.184"></a><span id="l29.184" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !cancelchk)</span>
<a href="#l29.185"></a><span id="l29.185" class="difflineplus">+  {</span>
<a href="#l29.186"></a><span id="l29.186">     NNTP_LOG_NOTE(&quot;CANCELCHK not supported&quot;);</span>
<a href="#l29.187"></a><span id="l29.187"> </span>
<a href="#l29.188"></a><span id="l29.188" class="difflineminus">-      // get the current identity from the news session....</span>
<a href="#l29.189"></a><span id="l29.189" class="difflineminus">-      nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l29.190"></a><span id="l29.190" class="difflineminus">-               do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l29.191"></a><span id="l29.191" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; accountManager) {</span>
<a href="#l29.192"></a><span id="l29.192" class="difflineminus">-          nsCOMPtr&lt;nsISupportsArray&gt; identities;</span>
<a href="#l29.193"></a><span id="l29.193" class="difflineminus">-          rv = accountManager-&gt;GetAllIdentities(getter_AddRefs(identities));</span>
<a href="#l29.194"></a><span id="l29.194" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l29.195"></a><span id="l29.195" class="difflineminus">-</span>
<a href="#l29.196"></a><span id="l29.196" class="difflineminus">-          // CheckIfAuthor will set cancelInfo.from if a match is found</span>
<a href="#l29.197"></a><span id="l29.197" class="difflineminus">-          identities-&gt;EnumerateForwards(CheckIfAuthor, (void *)&amp;cancelInfo);</span>
<a href="#l29.198"></a><span id="l29.198" class="difflineplus">+    // get the current identity from the news session....</span>
<a href="#l29.199"></a><span id="l29.199" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l29.200"></a><span id="l29.200" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l29.201"></a><span id="l29.201" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; accountManager) {</span>
<a href="#l29.202"></a><span id="l29.202" class="difflineplus">+      nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l29.203"></a><span id="l29.203" class="difflineplus">+      rv = accountManager-&gt;GetAllIdentities(getter_AddRefs(identities));</span>
<a href="#l29.204"></a><span id="l29.204" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l29.205"></a><span id="l29.205" class="difflineplus">+</span>
<a href="#l29.206"></a><span id="l29.206" class="difflineplus">+      uint32_t length;</span>
<a href="#l29.207"></a><span id="l29.207" class="difflineplus">+      rv = identities-&gt;GetLength(&amp;length);</span>
<a href="#l29.208"></a><span id="l29.208" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l29.209"></a><span id="l29.209" class="difflineplus">+</span>
<a href="#l29.210"></a><span id="l29.210" class="difflineplus">+      for (uint32_t i = 0; i &lt; length &amp;&amp; from.IsEmpty(); ++i)</span>
<a href="#l29.211"></a><span id="l29.211" class="difflineplus">+      {</span>
<a href="#l29.212"></a><span id="l29.212" class="difflineplus">+        nsCOMPtr&lt;nsIMsgIdentity&gt; identity(do_QueryElementAt(identities, i, &amp;rv));</span>
<a href="#l29.213"></a><span id="l29.213" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l29.214"></a><span id="l29.214" class="difflineplus">+          CheckIfAuthor(identity, oldFrom, from);</span>
<a href="#l29.215"></a><span id="l29.215">       }</span>
<a href="#l29.216"></a><span id="l29.216" class="difflineminus">-</span>
<a href="#l29.217"></a><span id="l29.217" class="difflineminus">-      if (cancelInfo.from.IsEmpty()) {</span>
<a href="#l29.218"></a><span id="l29.218" class="difflineminus">-          GetNewsStringByName(&quot;cancelDisallowed&quot;, getter_Copies(alertText));</span>
<a href="#l29.219"></a><span id="l29.219" class="difflineminus">-          rv = dialog-&gt;Alert(nullptr, alertText.get());</span>
<a href="#l29.220"></a><span id="l29.220" class="difflineminus">-          // XXX:  todo, check rv?</span>
<a href="#l29.221"></a><span id="l29.221" class="difflineminus">-</span>
<a href="#l29.222"></a><span id="l29.222" class="difflineminus">-/* After the cancel is disallowed, Make the status update to be the same as though the</span>
<a href="#l29.223"></a><span id="l29.223" class="difflineminus">-cancel was allowed, otherwise, the newsgroup is not able to take further requests as</span>
<a href="#l29.224"></a><span id="l29.224" class="difflineminus">-reported here */</span>
<a href="#l29.225"></a><span id="l29.225" class="difflineminus">-          status = MK_NNTP_CANCEL_DISALLOWED;</span>
<a href="#l29.226"></a><span id="l29.226" class="difflineminus">-          m_nextState = NNTP_RESPONSE;</span>
<a href="#l29.227"></a><span id="l29.227" class="difflineminus">-          m_nextStateAfterResponse = NNTP_SEND_POST_DATA_RESPONSE;</span>
<a href="#l29.228"></a><span id="l29.228" class="difflineminus">-          SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l29.229"></a><span id="l29.229" class="difflineminus">-          failure = true;</span>
<a href="#l29.230"></a><span id="l29.230" class="difflineminus">-          goto FAIL;</span>
<a href="#l29.231"></a><span id="l29.231" class="difflineminus">-      }</span>
<a href="#l29.232"></a><span id="l29.232" class="difflineminus">-      else {</span>
<a href="#l29.233"></a><span id="l29.233" class="difflineminus">-        PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) CANCELCHK not supported, so post the cancel message as %s&quot;, this, cancelInfo.from.get()));</span>
<a href="#l29.234"></a><span id="l29.234" class="difflineminus">-      }</span>
<a href="#l29.235"></a><span id="l29.235" class="difflineplus">+    }</span>
<a href="#l29.236"></a><span id="l29.236" class="difflineplus">+</span>
<a href="#l29.237"></a><span id="l29.237" class="difflineplus">+    if (from.IsEmpty())</span>
<a href="#l29.238"></a><span id="l29.238" class="difflineplus">+    {</span>
<a href="#l29.239"></a><span id="l29.239" class="difflineplus">+      GetNewsStringByName(&quot;cancelDisallowed&quot;, getter_Copies(alertText));</span>
<a href="#l29.240"></a><span id="l29.240" class="difflineplus">+      rv = dialog-&gt;Alert(nullptr, alertText.get());</span>
<a href="#l29.241"></a><span id="l29.241" class="difflineplus">+      // XXX:  todo, check rv?</span>
<a href="#l29.242"></a><span id="l29.242" class="difflineplus">+</span>
<a href="#l29.243"></a><span id="l29.243" class="difflineplus">+      /* After the cancel is disallowed, Make the status update to be the same as though the</span>
<a href="#l29.244"></a><span id="l29.244" class="difflineplus">+         cancel was allowed, otherwise, the newsgroup is not able to take further requests as</span>
<a href="#l29.245"></a><span id="l29.245" class="difflineplus">+         reported here */</span>
<a href="#l29.246"></a><span id="l29.246" class="difflineplus">+      status = MK_NNTP_CANCEL_DISALLOWED;</span>
<a href="#l29.247"></a><span id="l29.247" class="difflineplus">+      m_nextState = NNTP_RESPONSE;</span>
<a href="#l29.248"></a><span id="l29.248" class="difflineplus">+      m_nextStateAfterResponse = NNTP_SEND_POST_DATA_RESPONSE;</span>
<a href="#l29.249"></a><span id="l29.249" class="difflineplus">+      SetFlag(NNTP_PAUSE_FOR_READ);</span>
<a href="#l29.250"></a><span id="l29.250" class="difflineplus">+      failure = true;</span>
<a href="#l29.251"></a><span id="l29.251" class="difflineplus">+      goto FAIL;</span>
<a href="#l29.252"></a><span id="l29.252" class="difflineplus">+    }</span>
<a href="#l29.253"></a><span id="l29.253" class="difflineplus">+    else</span>
<a href="#l29.254"></a><span id="l29.254" class="difflineplus">+    {</span>
<a href="#l29.255"></a><span id="l29.255" class="difflineplus">+      PR_LOG(NNTP,PR_LOG_ALWAYS,(&quot;(%p) CANCELCHK not supported, so post the cancel message as %s&quot;, this, from.get()));</span>
<a href="#l29.256"></a><span id="l29.256" class="difflineplus">+    }</span>
<a href="#l29.257"></a><span id="l29.257">   }</span>
<a href="#l29.258"></a><span id="l29.258">   else</span>
<a href="#l29.259"></a><span id="l29.259">     NNTP_LOG_NOTE(&quot;CANCELCHK supported, don't do the us vs. them test&quot;);</span>
<a href="#l29.260"></a><span id="l29.260"> </span>
<a href="#l29.261"></a><span id="l29.261">   // QA needs to be able to disable this confirm dialog, for the automated tests.  see bug #31057</span>
<a href="#l29.262"></a><span id="l29.262">   rv = prefBranch-&gt;GetBoolPref(PREF_NEWS_CANCEL_CONFIRM, &amp;requireConfirmationForCancel);</span>
<a href="#l29.263"></a><span id="l29.263">   if (NS_FAILED(rv) || requireConfirmationForCancel) {</span>
<a href="#l29.264"></a><span id="l29.264">     /* Last chance to cancel the cancel.*/</span>
<a href="#l29.265"></a><span id="l29.265" class="difflineat">@@ -3763,17 +3745,17 @@ reported here */</span>
<a href="#l29.266"></a><span id="l29.266">     data = PR_smprintf(&quot;From: %s&quot; CRLF</span>
<a href="#l29.267"></a><span id="l29.267">                        &quot;Newsgroups: %s&quot; CRLF</span>
<a href="#l29.268"></a><span id="l29.268">                        &quot;Subject: %s&quot; CRLF</span>
<a href="#l29.269"></a><span id="l29.269">                        &quot;References: %s&quot; CRLF</span>
<a href="#l29.270"></a><span id="l29.270">                        &quot;%s&quot; /* otherHeaders, already with CRLF */</span>
<a href="#l29.271"></a><span id="l29.271">                        CRLF /* body separator */</span>
<a href="#l29.272"></a><span id="l29.272">                        &quot;%s&quot; /* body, already with CRLF */</span>
<a href="#l29.273"></a><span id="l29.273">                        &quot;.&quot; CRLF, /* trailing message terminator &quot;.&quot; */</span>
<a href="#l29.274"></a><span id="l29.274" class="difflineminus">-                       cancelInfo.from.get(), newsgroups, subject, id,</span>
<a href="#l29.275"></a><span id="l29.275" class="difflineplus">+                       from.get(), newsgroups, subject, id,</span>
<a href="#l29.276"></a><span id="l29.276">                        otherHeaders.get(), body);</span>
<a href="#l29.277"></a><span id="l29.277"> </span>
<a href="#l29.278"></a><span id="l29.278">     rv = SendData(data);</span>
<a href="#l29.279"></a><span id="l29.279">     PR_Free (data);</span>
<a href="#l29.280"></a><span id="l29.280">     if (NS_FAILED(rv)) {</span>
<a href="#l29.281"></a><span id="l29.281">       nsAutoCString errorText;</span>
<a href="#l29.282"></a><span id="l29.282">       errorText.AppendInt(status);</span>
<a href="#l29.283"></a><span id="l29.283">       AlertError(MK_TCP_WRITE_ERROR, errorText.get());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.h</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.h</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -1,9 +1,9 @@</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l30.6"></a><span id="l30.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l30.7"></a><span id="l30.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.8"></a><span id="l30.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l30.9"></a><span id="l30.9"> </span>
<a href="#l30.10"></a><span id="l30.10"> #ifndef nsNNTPProtocol_h___</span>
<a href="#l30.11"></a><span id="l30.11"> #define nsNNTPProtocol_h___</span>
<a href="#l30.12"></a><span id="l30.12"> </span>
<a href="#l30.13"></a><span id="l30.13"> #include &quot;nsMsgProtocol.h&quot;</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineat">@@ -181,17 +181,17 @@ private:</span>
<a href="#l30.15"></a><span id="l30.15"> </span>
<a href="#l30.16"></a><span id="l30.16">   nsresult CleanupAfterRunningUrl();</span>
<a href="#l30.17"></a><span id="l30.17">   void Cleanup(); //free char* member variables</span>
<a href="#l30.18"></a><span id="l30.18"> </span>
<a href="#l30.19"></a><span id="l30.19">   void ParseHeaderForCancel(char *buf);</span>
<a href="#l30.20"></a><span id="l30.20"> </span>
<a href="#l30.21"></a><span id="l30.21">   virtual const char* GetType() {return &quot;nntp&quot;;}</span>
<a href="#l30.22"></a><span id="l30.22"> </span>
<a href="#l30.23"></a><span id="l30.23" class="difflineminus">-  static bool CheckIfAuthor(nsISupports *aElement, void *data);</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+  static void CheckIfAuthor(nsIMsgIdentity *aIdentity, const nsCString &amp;aOldFrom, nsCString &amp;aFrom);</span>
<a href="#l30.25"></a><span id="l30.25"> </span>
<a href="#l30.26"></a><span id="l30.26">   nsCOMPtr &lt;nsINNTPNewsgroupList&gt; m_newsgroupList;</span>
<a href="#l30.27"></a><span id="l30.27">   nsCOMPtr &lt;nsINNTPArticleList&gt; m_articleList;</span>
<a href="#l30.28"></a><span id="l30.28"> </span>
<a href="#l30.29"></a><span id="l30.29">   nsCOMPtr &lt;nsIMsgNewsFolder&gt; m_newsFolder;</span>
<a href="#l30.30"></a><span id="l30.30">   nsCOMPtr &lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l30.31"></a><span id="l30.31"> </span>
<a href="#l30.32"></a><span id="l30.32">   nsCOMPtr&lt;nsIAsyncInputStream&gt; mDisplayInputStream;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/suite/mailnews/compose/MsgComposeCommands.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/suite/mailnews/compose/MsgComposeCommands.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -1277,19 +1277,19 @@ function ComposeStartup(recycled, aParam</span>
<a href="#l31.4"></a><span id="l31.4">          composeFields.body = args.body;</span>
<a href="#l31.5"></a><span id="l31.5">     }</span>
<a href="#l31.6"></a><span id="l31.6">   }</span>
<a href="#l31.7"></a><span id="l31.7"> </span>
<a href="#l31.8"></a><span id="l31.8">   // &quot; &lt;&gt;&quot; is an empty identity, and most likely not valid</span>
<a href="#l31.9"></a><span id="l31.9">   if (!params.identity || params.identity.identityName == &quot; &lt;&gt;&quot;) {</span>
<a href="#l31.10"></a><span id="l31.10">     // no pre selected identity, so use the default account</span>
<a href="#l31.11"></a><span id="l31.11">     var identities = gAccountManager.defaultAccount.identities;</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-    if (identities.Count() == 0)</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+    if (identities.length == 0)</span>
<a href="#l31.14"></a><span id="l31.14">       identities = gAccountManager.allIdentities;</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineminus">-    params.identity = identities.QueryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineplus">+    params.identity = identities.queryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l31.17"></a><span id="l31.17">   }</span>
<a href="#l31.18"></a><span id="l31.18"> </span>
<a href="#l31.19"></a><span id="l31.19">   identityList.value = params.identity.key;</span>
<a href="#l31.20"></a><span id="l31.20">   LoadIdentity(true);</span>
<a href="#l31.21"></a><span id="l31.21">   if (sMsgComposeService)</span>
<a href="#l31.22"></a><span id="l31.22">   {</span>
<a href="#l31.23"></a><span id="l31.23">     // Get the &lt;editor&gt; element to startup an editor</span>
<a href="#l31.24"></a><span id="l31.24">     var editorElement = GetCurrentEditorElement();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/suite/mailnews/mailCommands.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/suite/mailnews/mailCommands.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -19,32 +19,32 @@ function GetNewMessages(selectedFolders,</span>
<a href="#l32.4"></a><span id="l32.4">   }</span>
<a href="#l32.5"></a><span id="l32.5">   server.getNewMessages(msgFolder, msgWindow, null);</span>
<a href="#l32.6"></a><span id="l32.6"> }</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8"> function getBestIdentity(identities, optionalHint)</span>
<a href="#l32.9"></a><span id="l32.9"> {</span>
<a href="#l32.10"></a><span id="l32.10">   var identity = null;</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  var identitiesCount = identities.Count();</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+  var identitiesCount = identities.length;</span>
<a href="#l32.14"></a><span id="l32.14"> </span>
<a href="#l32.15"></a><span id="l32.15">   try</span>
<a href="#l32.16"></a><span id="l32.16">   {</span>
<a href="#l32.17"></a><span id="l32.17">     // if we have more than one identity and a hint to help us pick one</span>
<a href="#l32.18"></a><span id="l32.18">     if (identitiesCount &gt; 1 &amp;&amp; optionalHint) {</span>
<a href="#l32.19"></a><span id="l32.19">       // normalize case on the optional hint to improve our chances of finding a match</span>
<a href="#l32.20"></a><span id="l32.20">       optionalHint = optionalHint.toLowerCase();</span>
<a href="#l32.21"></a><span id="l32.21"> </span>
<a href="#l32.22"></a><span id="l32.22">       var id;</span>
<a href="#l32.23"></a><span id="l32.23">       // iterate over all of the identities</span>
<a href="#l32.24"></a><span id="l32.24">       var tempID;</span>
<a href="#l32.25"></a><span id="l32.25"> </span>
<a href="#l32.26"></a><span id="l32.26">       var lengthOfLongestMatchingEmail = 0;</span>
<a href="#l32.27"></a><span id="l32.27">       for (id = 0; id &lt; identitiesCount; ++id) {</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineminus">-        tempID = identities.GetElementAt(id).QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineplus">+        tempID = identities.queryElementAt(id, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l32.30"></a><span id="l32.30">         if (optionalHint.indexOf(tempID.email.toLowerCase()) &gt;= 0) {</span>
<a href="#l32.31"></a><span id="l32.31">           // Be careful, the user can have several adresses with the same</span>
<a href="#l32.32"></a><span id="l32.32">           // postfix e.g. aaa.bbb@ccc.ddd and bbb@ccc.ddd. Make sure we get the</span>
<a href="#l32.33"></a><span id="l32.33">           // longest match.</span>
<a href="#l32.34"></a><span id="l32.34">           if (tempID.email.length &gt; lengthOfLongestMatchingEmail) {</span>
<a href="#l32.35"></a><span id="l32.35">             identity = tempID;</span>
<a href="#l32.36"></a><span id="l32.36">             lengthOfLongestMatchingEmail = tempID.email.length;</span>
<a href="#l32.37"></a><span id="l32.37">           }</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineat">@@ -56,44 +56,44 @@ function getBestIdentity(identities, opt</span>
<a href="#l32.39"></a><span id="l32.39">       // Before we just give up, try and search for just a shared domain between the hint and</span>
<a href="#l32.40"></a><span id="l32.40">       // the email addresses for our identities. Hey, it is better than nothing and in the case</span>
<a href="#l32.41"></a><span id="l32.41">       // of multiple matches here, we'll end up picking the first one anyway which is what we would have done</span>
<a href="#l32.42"></a><span id="l32.42">       // if we didn't do this second search. This helps the case for corporate users where mailing lists will have the same domain</span>
<a href="#l32.43"></a><span id="l32.43">       // as one of your multiple identities.</span>
<a href="#l32.44"></a><span id="l32.44"> </span>
<a href="#l32.45"></a><span id="l32.45">       if (!identity) {</span>
<a href="#l32.46"></a><span id="l32.46">         for (id = 0; id &lt; identitiesCount; ++id) {</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineminus">-          tempID = identities.GetElementAt(id).QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineplus">+          tempID = identities.queryElementAt(id, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l32.49"></a><span id="l32.49">           // extract out the partial domain</span>
<a href="#l32.50"></a><span id="l32.50">           var start = tempID.email.lastIndexOf(&quot;@&quot;); // be sure to include the @ sign in our search to reduce the risk of false positives</span>
<a href="#l32.51"></a><span id="l32.51">           if (optionalHint.search(tempID.email.slice(start).toLowerCase()) &gt;= 0) {</span>
<a href="#l32.52"></a><span id="l32.52">             identity = tempID;</span>
<a href="#l32.53"></a><span id="l32.53">             break;</span>
<a href="#l32.54"></a><span id="l32.54">           }</span>
<a href="#l32.55"></a><span id="l32.55">         }</span>
<a href="#l32.56"></a><span id="l32.56">       }</span>
<a href="#l32.57"></a><span id="l32.57">     }</span>
<a href="#l32.58"></a><span id="l32.58">   }</span>
<a href="#l32.59"></a><span id="l32.59">   catch (ex) {dump (ex + &quot;\n&quot;);}</span>
<a href="#l32.60"></a><span id="l32.60"> </span>
<a href="#l32.61"></a><span id="l32.61">   // Still no matches ?</span>
<a href="#l32.62"></a><span id="l32.62">   // Give up and pick the first one (if it exists), like we used to.</span>
<a href="#l32.63"></a><span id="l32.63">   if (!identity &amp;&amp; identitiesCount &gt; 0)</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineminus">-    identity = identities.GetElementAt(0).QueryInterface(Components.interfaces.nsIMsgIdentity);</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineplus">+    identity = identities.queryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l32.66"></a><span id="l32.66"> </span>
<a href="#l32.67"></a><span id="l32.67">   return identity;</span>
<a href="#l32.68"></a><span id="l32.68"> }</span>
<a href="#l32.69"></a><span id="l32.69"> </span>
<a href="#l32.70"></a><span id="l32.70"> function getIdentityForServer(server, optionalHint)</span>
<a href="#l32.71"></a><span id="l32.71"> {</span>
<a href="#l32.72"></a><span id="l32.72">     var identity = null;</span>
<a href="#l32.73"></a><span id="l32.73"> </span>
<a href="#l32.74"></a><span id="l32.74">     if (server) {</span>
<a href="#l32.75"></a><span id="l32.75">         // Get the identities associated with this server.</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineminus">-        var identities = accountManager.GetIdentitiesForServer(server);</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineplus">+        var identities = accountManager.getIdentitiesForServer(server);</span>
<a href="#l32.78"></a><span id="l32.78">         // dump(&quot;identities = &quot; + identities + &quot;\n&quot;);</span>
<a href="#l32.79"></a><span id="l32.79">         // Try and find the best one.</span>
<a href="#l32.80"></a><span id="l32.80">         identity = getBestIdentity(identities, optionalHint);</span>
<a href="#l32.81"></a><span id="l32.81">     }</span>
<a href="#l32.82"></a><span id="l32.82"> </span>
<a href="#l32.83"></a><span id="l32.83">     return identity;</span>
<a href="#l32.84"></a><span id="l32.84"> }</span>
<a href="#l32.85"></a><span id="l32.85"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/suite/mailnews/mailWindowOverlay.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/suite/mailnews/mailWindowOverlay.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -2329,21 +2329,21 @@ function GetFolderMessages()</span>
<a href="#l33.4"></a><span id="l33.4"> }</span>
<a href="#l33.5"></a><span id="l33.5"> </span>
<a href="#l33.6"></a><span id="l33.6"> function SendUnsentMessages()</span>
<a href="#l33.7"></a><span id="l33.7"> {</span>
<a href="#l33.8"></a><span id="l33.8">   var msgSendlater = Components.classes[&quot;@mozilla.org/messengercompose/sendlater;1&quot;]</span>
<a href="#l33.9"></a><span id="l33.9">                .getService(Components.interfaces.nsIMsgSendLater);</span>
<a href="#l33.10"></a><span id="l33.10">   var identitiesCount, allIdentities, currentIdentity, numMessages, msgFolder;</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  if (accountManager) { </span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+  if (accountManager) {</span>
<a href="#l33.14"></a><span id="l33.14">     allIdentities = accountManager.allIdentities;</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">-    identitiesCount = allIdentities.Count();</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+    identitiesCount = allIdentities.length;</span>
<a href="#l33.17"></a><span id="l33.17">     for (var i = 0; i &lt; identitiesCount; i++) {</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineminus">-      currentIdentity = allIdentities.QueryElementAt(i, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+      currentIdentity = allIdentities.queryElementAt(i, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l33.20"></a><span id="l33.20">       msgFolder = msgSendlater.getUnsentMessagesFolder(currentIdentity);</span>
<a href="#l33.21"></a><span id="l33.21">       if(msgFolder) {</span>
<a href="#l33.22"></a><span id="l33.22">         numMessages = msgFolder.getTotalMessages(false /* include subfolders */);</span>
<a href="#l33.23"></a><span id="l33.23">         if(numMessages &gt; 0) {</span>
<a href="#l33.24"></a><span id="l33.24">           msgSendlater.statusFeedback = statusFeedback;</span>
<a href="#l33.25"></a><span id="l33.25">           msgSendlater.sendUnsentMessages(currentIdentity);</span>
<a href="#l33.26"></a><span id="l33.26">           // right now, all identities point to the same unsent messages</span>
<a href="#l33.27"></a><span id="l33.27">           // folder, so to avoid sending multiple copies of the</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

