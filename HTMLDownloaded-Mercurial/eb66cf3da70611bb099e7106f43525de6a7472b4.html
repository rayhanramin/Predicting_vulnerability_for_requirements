<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11243:eb66cf3da70611bb099e7106f43525de6a7472b4</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ eb66cf3da70611bb099e7106f43525de6a7472b4" />
<meta property="og:url" content="/comm-central/rev/eb66cf3da70611bb099e7106f43525de6a7472b4" />
<meta property="og:description" content="Fix bug 788267 - Replace calRecurrenceDate.cpp with a JS implementation. r=mmecca" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / eb66cf3da70611bb099e7106f43525de6a7472b4 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/eb66cf3da70611bb099e7106f43525de6a7472b4">shortlog</a> |
<a href="/comm-central/log/eb66cf3da70611bb099e7106f43525de6a7472b4">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/eb66cf3da70611bb099e7106f43525de6a7472b4">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/eb66cf3da70611bb099e7106f43525de6a7472b4">files</a> |
changeset |
<a href="/comm-central/raw-rev/eb66cf3da70611bb099e7106f43525de6a7472b4">raw</a>  | <a href="/comm-central/archive/eb66cf3da70611bb099e7106f43525de6a7472b4.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=788267">bug 788267</a> - Replace calRecurrenceDate.cpp with a JS implementation. r=mmecca
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 08 Oct 2012 18:15:08 +0200</td></tr>

<tr>
 <td>changeset 11243</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/eb66cf3da70611bb099e7106f43525de6a7472b4">eb66cf3da70611bb099e7106f43525de6a7472b4</a></td>
</tr>



<tr>
<td>parent 11242</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ae6b83c2a3c042dd9e488d50b91082451145e8ea">ae6b83c2a3c042dd9e488d50b91082451145e8ea</a>
</td>
</tr>

<tr>
<td>child 11244</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/98e6e8d81c05882e1a4750e4067402b298951f58">98e6e8d81c05882e1a4750e4067402b298951f58</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=eb66cf3da70611bb099e7106f43525de6a7472b4">8435</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Mon, 08 Oct 2012 16:15:46 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@eb66cf3da706 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=eb66cf3da70611bb099e7106f43525de6a7472b4">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=eb66cf3da70611bb099e7106f43525de6a7472b4&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=eb66cf3da70611bb099e7106f43525de6a7472b4&newProject=comm-central&newRevision=ae6b83c2a3c042dd9e488d50b91082451145e8ea&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=eb66cf3da70611bb099e7106f43525de6a7472b4&newProject=comm-central&newRevision=ae6b83c2a3c042dd9e488d50b91082451145e8ea&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=eb66cf3da70611bb099e7106f43525de6a7472b4&newProject=comm-central&newRevision=ae6b83c2a3c042dd9e488d50b91082451145e8ea&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mmecca%29&revcount=50">mmecca</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=788267">788267</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=788267">bug 788267</a> - Replace calRecurrenceDate.cpp with a JS implementation. r=mmecca</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/build/calBaseModule.cpp">calendar/base/build/calBaseModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/build/calBaseModule.cpp">file</a> |
<a href="/comm-central/annotate/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/build/calBaseModule.cpp">annotate</a> |
<a href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/build/calBaseModule.cpp">diff</a> |
<a href="/comm-central/comparison/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/build/calBaseModule.cpp">comparison</a> |
<a href="/comm-central/log/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/build/calBaseModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/public/calBaseCID.h">calendar/base/public/calBaseCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/public/calBaseCID.h">file</a> |
<a href="/comm-central/annotate/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/public/calBaseCID.h">annotate</a> |
<a href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/public/calBaseCID.h">diff</a> |
<a href="/comm-central/comparison/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/public/calBaseCID.h">comparison</a> |
<a href="/comm-central/log/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/public/calBaseCID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/Makefile.in">calendar/base/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calItemModule.js">calendar/base/src/calItemModule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calItemModule.js">file</a> |
<a href="/comm-central/annotate/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calItemModule.js">annotate</a> |
<a href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calItemModule.js">diff</a> |
<a href="/comm-central/comparison/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calItemModule.js">comparison</a> |
<a href="/comm-central/log/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calItemModule.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calItemModule.manifest">calendar/base/src/calItemModule.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calItemModule.manifest">file</a> |
<a href="/comm-central/annotate/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calItemModule.manifest">annotate</a> |
<a href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calItemModule.manifest">diff</a> |
<a href="/comm-central/comparison/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calItemModule.manifest">comparison</a> |
<a href="/comm-central/log/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calItemModule.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calRecurrenceDate.cpp">calendar/base/src/calRecurrenceDate.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calRecurrenceDate.cpp">diff</a> |
<a href="/comm-central/comparison/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calRecurrenceDate.cpp">comparison</a> |
<a href="/comm-central/log/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calRecurrenceDate.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calRecurrenceDate.h">calendar/base/src/calRecurrenceDate.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calRecurrenceDate.h">diff</a> |
<a href="/comm-central/comparison/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calRecurrenceDate.h">comparison</a> |
<a href="/comm-central/log/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calRecurrenceDate.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calRecurrenceDate.js">calendar/base/src/calRecurrenceDate.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calRecurrenceDate.js">file</a> |
<a href="/comm-central/annotate/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calRecurrenceDate.js">annotate</a> |
<a href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calRecurrenceDate.js">diff</a> |
<a href="/comm-central/comparison/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calRecurrenceDate.js">comparison</a> |
<a href="/comm-central/log/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/base/src/calRecurrenceDate.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/test/unit/test_ics_service.js">calendar/test/unit/test_ics_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/test/unit/test_ics_service.js">file</a> |
<a href="/comm-central/annotate/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/test/unit/test_ics_service.js">annotate</a> |
<a href="/comm-central/diff/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/test/unit/test_ics_service.js">diff</a> |
<a href="/comm-central/comparison/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/test/unit/test_ics_service.js">comparison</a> |
<a href="/comm-central/log/eb66cf3da70611bb099e7106f43525de6a7472b4/calendar/test/unit/test_ics_service.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/build/calBaseModule.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/build/calBaseModule.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -3,56 +3,50 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;mozilla/ModuleUtils.h&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;calDateTime.h&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;calDuration.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;calPeriod.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> #include &quot;calICSService.h&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> #include &quot;calRecurrenceRule.h&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#include &quot;calRecurrenceDate.h&quot;</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14"> #include &quot;calBaseCID.h&quot;</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> NS_GENERIC_FACTORY_CONSTRUCTOR(calDateTime)</span>
<a href="#l1.17"></a><span id="l1.17"> NS_DEFINE_NAMED_CID(CAL_DATETIME_CID);</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> NS_GENERIC_FACTORY_CONSTRUCTOR(calDuration)</span>
<a href="#l1.20"></a><span id="l1.20"> NS_DEFINE_NAMED_CID(CAL_DURATION_CID);</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22"> NS_GENERIC_FACTORY_CONSTRUCTOR(calICSService)</span>
<a href="#l1.23"></a><span id="l1.23"> NS_DEFINE_NAMED_CID(CAL_ICSSERVICE_CID);</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25"> NS_GENERIC_FACTORY_CONSTRUCTOR(calPeriod)</span>
<a href="#l1.26"></a><span id="l1.26"> NS_DEFINE_NAMED_CID(CAL_PERIOD_CID);</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR(calRecurrenceDate)</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-NS_DEFINE_NAMED_CID(CAL_RECURRENCEDATE_CID);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-</span>
<a href="#l1.31"></a><span id="l1.31"> NS_GENERIC_FACTORY_CONSTRUCTOR(calRecurrenceRule)</span>
<a href="#l1.32"></a><span id="l1.32"> NS_DEFINE_NAMED_CID(CAL_RECURRENCERULE_CID);</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35"> const mozilla::Module::CIDEntry kCalBaseCIDs[] = {</span>
<a href="#l1.36"></a><span id="l1.36">     { &amp;kCAL_DATETIME_CID, false, NULL, calDateTimeConstructor },</span>
<a href="#l1.37"></a><span id="l1.37">     { &amp;kCAL_DURATION_CID, false, NULL, calDurationConstructor },</span>
<a href="#l1.38"></a><span id="l1.38">     { &amp;kCAL_ICSSERVICE_CID, true, NULL, calICSServiceConstructor },</span>
<a href="#l1.39"></a><span id="l1.39">     { &amp;kCAL_PERIOD_CID, false, NULL, calPeriodConstructor },</span>
<a href="#l1.40"></a><span id="l1.40">     { &amp;kCAL_RECURRENCERULE_CID, false, NULL, calRecurrenceRuleConstructor },</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-    { &amp;kCAL_RECURRENCEDATE_CID, false, NULL, calRecurrenceDateConstructor },</span>
<a href="#l1.42"></a><span id="l1.42">     { NULL }</span>
<a href="#l1.43"></a><span id="l1.43"> };</span>
<a href="#l1.44"></a><span id="l1.44"> </span>
<a href="#l1.45"></a><span id="l1.45"> const mozilla::Module::ContractIDEntry kCalBaseContracts[] = {</span>
<a href="#l1.46"></a><span id="l1.46">     { CAL_DATETIME_CONTRACTID, &amp;kCAL_DATETIME_CID },</span>
<a href="#l1.47"></a><span id="l1.47">     { CAL_DURATION_CONTRACTID, &amp;kCAL_DURATION_CID },</span>
<a href="#l1.48"></a><span id="l1.48">     { CAL_ICSSERVICE_CONTRACTID, &amp;kCAL_ICSSERVICE_CID },</span>
<a href="#l1.49"></a><span id="l1.49">     { CAL_PERIOD_CONTRACTID, &amp;kCAL_PERIOD_CID },</span>
<a href="#l1.50"></a><span id="l1.50">     { CAL_RECURRENCERULE_CONTRACTID, &amp;kCAL_RECURRENCERULE_CID },</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-    { CAL_RECURRENCEDATE_CONTRACTID, &amp;kCAL_RECURRENCEDATE_CID },</span>
<a href="#l1.52"></a><span id="l1.52">     { NULL }</span>
<a href="#l1.53"></a><span id="l1.53"> };</span>
<a href="#l1.54"></a><span id="l1.54"> </span>
<a href="#l1.55"></a><span id="l1.55"> static nsresult</span>
<a href="#l1.56"></a><span id="l1.56"> nsInitBaseModule()</span>
<a href="#l1.57"></a><span id="l1.57"> {</span>
<a href="#l1.58"></a><span id="l1.58">     // This needs to be done once in the application, we want to make</span>
<a href="#l1.59"></a><span id="l1.59">     // sure that new parameters are not thrown away</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/public/calBaseCID.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/public/calBaseCID.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -37,21 +37,16 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #define CAL_TIMEZONESERVICE_CONTRACTID \</span>
<a href="#l2.5"></a><span id="l2.5">     &quot;@mozilla.org/calendar/timezone-service;1&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> #define CAL_RECURRENCERULE_CID \</span>
<a href="#l2.8"></a><span id="l2.8">     { 0xd9560bf9, 0x3065, 0x404a, { 0x90, 0x4c, 0xc8, 0x82, 0xfc, 0x9c, 0x9b, 0x74 } }</span>
<a href="#l2.9"></a><span id="l2.9"> #define CAL_RECURRENCERULE_CONTRACTID \</span>
<a href="#l2.10"></a><span id="l2.10">     &quot;@mozilla.org/calendar/recurrence-rule;1&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#define CAL_RECURRENCEDATE_CID \</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-    { 0x99706e71, 0x3df5, 0x475e, { 0x84, 0xf8, 0x0f, 0xc5, 0x21, 0x1f, 0x92, 0x09 } }</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-#define CAL_RECURRENCEDATE_CONTRACTID \</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-    &quot;@mozilla.org/calendar/recurrence-date;1&quot;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-</span>
<a href="#l2.17"></a><span id="l2.17"> /* JS -- Update these from calItemModule.js */</span>
<a href="#l2.18"></a><span id="l2.18"> #define CAL_EVENT_CID \</span>
<a href="#l2.19"></a><span id="l2.19">     { 0x974339d5, 0xab86, 0x4491, { 0xaa, 0xaf, 0x2b, 0x2c, 0xa1, 0x77, 0xc1, 0x2b } }</span>
<a href="#l2.20"></a><span id="l2.20"> #define CAL_EVENT_CONTRACTID \</span>
<a href="#l2.21"></a><span id="l2.21">     &quot;@mozilla.org/calendar/event;1&quot;</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23"> #define CAL_TODO_CID \</span>
<a href="#l2.24"></a><span id="l2.24">     { 0x7af51168, 0x6abe, 0x4a31, { 0x98, 0x4d, 0x6f, 0x8a, 0x39, 0x89, 0x21, 0x2d } }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/src/Makefile.in</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/src/Makefile.in</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -25,17 +25,16 @@ XPIDLSRCS = \</span>
<a href="#l3.4"></a><span id="l3.4"> 	$(NULL)</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> CPPSRCS = calDateTime.cpp \</span>
<a href="#l3.7"></a><span id="l3.7"> 	  calDuration.cpp \</span>
<a href="#l3.8"></a><span id="l3.8"> 	  calPeriod.cpp \</span>
<a href="#l3.9"></a><span id="l3.9"> 	  calICSService.cpp \</span>
<a href="#l3.10"></a><span id="l3.10"> 	  calTimezone.cpp \</span>
<a href="#l3.11"></a><span id="l3.11"> 	  calRecurrenceRule.cpp \</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-	  calRecurrenceDate.cpp \</span>
<a href="#l3.13"></a><span id="l3.13"> 	  calUtils.cpp \</span>
<a href="#l3.14"></a><span id="l3.14"> 	  $(NULL)</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16"> EXTRA_COMPONENTS = \</span>
<a href="#l3.17"></a><span id="l3.17">     calItemModule.manifest \</span>
<a href="#l3.18"></a><span id="l3.18">     calItemModule.js \</span>
<a href="#l3.19"></a><span id="l3.19">     calTimezoneService.manifest \</span>
<a href="#l3.20"></a><span id="l3.20">     calTimezoneService.js \</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -55,16 +54,17 @@ EXTRA_SCRIPTS = \</span>
<a href="#l3.22"></a><span id="l3.22">     calDeletedItems.js \</span>
<a href="#l3.23"></a><span id="l3.23">     calEvent.js \</span>
<a href="#l3.24"></a><span id="l3.24">     calFilter.js \</span>
<a href="#l3.25"></a><span id="l3.25">     calIcsParser.js \</span>
<a href="#l3.26"></a><span id="l3.26">     calIcsSerializer.js \</span>
<a href="#l3.27"></a><span id="l3.27">     calItemBase.js \</span>
<a href="#l3.28"></a><span id="l3.28">     calItipItem.js \</span>
<a href="#l3.29"></a><span id="l3.29">     calProtocolHandler.js \</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+    calRecurrenceDate.js \</span>
<a href="#l3.31"></a><span id="l3.31">     calRecurrenceInfo.js \</span>
<a href="#l3.32"></a><span id="l3.32">     calRelation.js \</span>
<a href="#l3.33"></a><span id="l3.33">     calStartupService.js \</span>
<a href="#l3.34"></a><span id="l3.34">     calTodo.js \</span>
<a href="#l3.35"></a><span id="l3.35">     calUtils.js \</span>
<a href="#l3.36"></a><span id="l3.36">     calWeekInfoService.js \</span>
<a href="#l3.37"></a><span id="l3.37">     calTransactionManager.js \</span>
<a href="#l3.38"></a><span id="l3.38">     calFreeBusyService.js \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/src/calItemModule.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/src/calItemModule.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -20,16 +20,17 @@ const scriptLoadOrder = [</span>
<a href="#l4.4"></a><span id="l4.4">     &quot;calDateTimeFormatter.js&quot;,</span>
<a href="#l4.5"></a><span id="l4.5">     &quot;calDeletedItems.js&quot;,</span>
<a href="#l4.6"></a><span id="l4.6">     &quot;calEvent.js&quot;,</span>
<a href="#l4.7"></a><span id="l4.7">     &quot;calFreeBusyService.js&quot;,</span>
<a href="#l4.8"></a><span id="l4.8">     &quot;calIcsParser.js&quot;,</span>
<a href="#l4.9"></a><span id="l4.9">     &quot;calIcsSerializer.js&quot;,</span>
<a href="#l4.10"></a><span id="l4.10">     &quot;calItipItem.js&quot;,</span>
<a href="#l4.11"></a><span id="l4.11">     &quot;calProtocolHandler.js&quot;,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+    &quot;calRecurrenceDate.js&quot;,</span>
<a href="#l4.13"></a><span id="l4.13">     &quot;calRecurrenceInfo.js&quot;,</span>
<a href="#l4.14"></a><span id="l4.14">     &quot;calRelation.js&quot;,</span>
<a href="#l4.15"></a><span id="l4.15">     &quot;calStartupService.js&quot;,</span>
<a href="#l4.16"></a><span id="l4.16">     &quot;calTransactionManager.js&quot;,</span>
<a href="#l4.17"></a><span id="l4.17">     &quot;calTodo.js&quot;,</span>
<a href="#l4.18"></a><span id="l4.18">     &quot;calWeekInfoService.js&quot;</span>
<a href="#l4.19"></a><span id="l4.19"> ];</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -55,16 +56,17 @@ function NSGetFactory(cid) {</span>
<a href="#l4.22"></a><span id="l4.22">         calDeletedItems,</span>
<a href="#l4.23"></a><span id="l4.23">         calEvent,</span>
<a href="#l4.24"></a><span id="l4.24">         calFreeBusyService,</span>
<a href="#l4.25"></a><span id="l4.25">         calIcsParser,</span>
<a href="#l4.26"></a><span id="l4.26">         calIcsSerializer,</span>
<a href="#l4.27"></a><span id="l4.27">         calItipItem,</span>
<a href="#l4.28"></a><span id="l4.28">         calProtocolHandlerWebcal,</span>
<a href="#l4.29"></a><span id="l4.29">         calProtocolHandlerWebcals,</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+        calRecurrenceDate,</span>
<a href="#l4.31"></a><span id="l4.31">         calRecurrenceInfo,</span>
<a href="#l4.32"></a><span id="l4.32">         calRelation,</span>
<a href="#l4.33"></a><span id="l4.33">         calStartupService,</span>
<a href="#l4.34"></a><span id="l4.34">         calTransaction,</span>
<a href="#l4.35"></a><span id="l4.35">         calTransactionManager,</span>
<a href="#l4.36"></a><span id="l4.36">         calTodo,</span>
<a href="#l4.37"></a><span id="l4.37">         calWeekInfoService,</span>
<a href="#l4.38"></a><span id="l4.38">     ];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/src/calItemModule.manifest</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/src/calItemModule.manifest</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -44,16 +44,19 @@ component {f41392ab-dcad-4bad-818f-b3d16</span>
<a href="#l5.4"></a><span id="l5.4"> contract @mozilla.org/calendar/itip-item;1 {f41392ab-dcad-4bad-818f-b3d1631c4d93}</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> component {1153c73a-39be-46aa-9ba9-656d188865ca} calItemModule.js</span>
<a href="#l5.7"></a><span id="l5.7"> contract @mozilla.org/network/protocol;1?name=webcal {1153c73a-39be-46aa-9ba9-656d188865ca}</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> component {bdf71224-365d-4493-856a-a7e74026f766} calItemModule.js</span>
<a href="#l5.10"></a><span id="l5.10"> contract @mozilla.org/network/protocol;1?name=webcals {bdf71224-365d-4493-856a-a7e74026f766}</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+component {806b6423-3aaa-4b26-afa3-de60563e9cec} calItemModule.js</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+contract @mozilla.org/calendar/recurrence-date;1 {806b6423-3aaa-4b26-afa3-de60563e9cec}</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+</span>
<a href="#l5.15"></a><span id="l5.15"> component {04027036-5884-4a30-b4af-f2cad79f6edf} calItemModule.js</span>
<a href="#l5.16"></a><span id="l5.16"> contract @mozilla.org/calendar/recurrence-info;1 {04027036-5884-4a30-b4af-f2cad79f6edf}</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18"> component {76810fae-abad-4019-917a-08e95d5bbd68} calItemModule.js</span>
<a href="#l5.19"></a><span id="l5.19"> contract @mozilla.org/calendar/relation;1 {76810fae-abad-4019-917a-08e95d5bbd68}</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21"> component {2547331f-34c0-4a4b-b93c-b503538ba6d6} calItemModule.js</span>
<a href="#l5.22"></a><span id="l5.22"> contract @mozilla.org/calendar/startup-service;1 {2547331f-34c0-4a4b-b93c-b503538ba6d6}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- a/calendar/base/src/calRecurrenceDate.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ /dev/null</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -1,33 +0,0 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 20; indent-tabs-mode: nil; c-basic-off: 4 -*- */</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-#ifndef CALRECURRENCEDATE_H_</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-#define CALRECURRENCEDATE_H_</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-#include &quot;calIDateTime.h&quot;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-#include &quot;calIRecurrenceDate.h&quot;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-class calRecurrenceDate : public calIRecurrenceDate</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-{</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-public:</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-    calRecurrenceDate();</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-    NS_DECL_CALIRECURRENCEITEM</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-    NS_DECL_CALIRECURRENCEDATE</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-protected:</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-    virtual ~calRecurrenceDate() {};</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-    bool mImmutable;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-    bool mIsNegative;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-    nsCOMPtr&lt;calIDateTime&gt; mDate;</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-};</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-#endif /* CALRECURRENCEDATE_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">rename from calendar/base/src/calRecurrenceDate.cpp</span>
<a href="#l7.2"></a><span id="l7.2">rename to calendar/base/src/calRecurrenceDate.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineminus">--- a/calendar/base/src/calRecurrenceDate.cpp</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineplus">+++ b/calendar/base/src/calRecurrenceDate.js</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineat">@@ -1,246 +1,113 @@</span>
<a href="#l7.6"></a><span id="l7.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.7"></a><span id="l7.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.8"></a><span id="l7.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-#include &quot;calRecurrenceDate.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-#include &quot;calDateTime.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-#include &quot;calPeriod.h&quot;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-#include &quot;calIItemBase.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-#include &quot;calIEvent.h&quot;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-#include &quot;calIErrors.h&quot;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-#include &quot;calICSService.h&quot;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-#include &quot;nsIClassInfoImpl.h&quot;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-#include &quot;calBaseCID.h&quot;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-extern &quot;C&quot; {</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-    #include &quot;ical.h&quot;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-}</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-NS_IMPL_CLASSINFO(calRecurrenceDate, NULL, 0, CAL_RECURRENCEDATE_CID)</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-NS_IMPL_ISUPPORTS2_CI(calRecurrenceDate, calIRecurrenceItem, calIRecurrenceDate)</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-calRecurrenceDate::calRecurrenceDate()</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-    : mImmutable(false),</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-      mIsNegative(false)</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-{</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-}</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-calRecurrenceDate::GetIsMutable(bool *aResult)</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-{</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-    *aResult = !mImmutable;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-}</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-calRecurrenceDate::MakeImmutable()</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-{</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-    if (mImmutable)</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-        return NS_ERROR_FAILURE; // XXX another error code</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-    mImmutable = true;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-}</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-calRecurrenceDate::Clone(calIRecurrenceItem **_retval)</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-{</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-    calRecurrenceDate *crd = new calRecurrenceDate;</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-    if (!crd)</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+Components.utils.import(&quot;resource:///modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.65"></a><span id="l7.65"> </span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-    crd-&gt;mIsNegative = mIsNegative;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-    if (mDate)</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-        mDate-&gt;Clone(getter_AddRefs(crd-&gt;mDate));</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-    else</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-        crd-&gt;mDate = nullptr;</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-    NS_ADDREF(*_retval = crd);</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-}</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-/* attribute boolean isNegative; */</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-calRecurrenceDate::GetIsNegative(bool *_retval)</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-{</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-    *_retval = mIsNegative;</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-}</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-calRecurrenceDate::SetIsNegative(bool aIsNegative)</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-{</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-    if (mImmutable)</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-        return NS_ERROR_FAILURE; // XXX CAL_ERROR_ITEM_IS_IMMUTABLE</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-    mIsNegative = aIsNegative;</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-}</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-/* readonly attribute boolean isFinite; */</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-calRecurrenceDate::GetIsFinite(bool *_retval)</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-{</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-    *_retval = true;</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-}</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-calRecurrenceDate::GetDate(calIDateTime **aDate)</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-{</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aDate);</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-    NS_IF_ADDREF(*aDate = mDate);</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-}</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-calRecurrenceDate::SetDate(calIDateTime *aDate)</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-{</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aDate);</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-    mDate = aDate;</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+function calRecurrenceDate() {</span>
<a href="#l7.122"></a><span id="l7.122"> }</span>
<a href="#l7.123"></a><span id="l7.123"> </span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-calRecurrenceDate::GetNextOccurrence(calIDateTime *aStartTime,</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-                                     calIDateTime *aOccurrenceTime,</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-                                     calIDateTime **_retval)</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-{</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aStartTime);</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aOccurrenceTime);</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+calRecurrenceDate.prototype = {</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+    isMutable: true,</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+    mIsNegative: false,</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+    mDate: null,</span>
<a href="#l7.137"></a><span id="l7.137"> </span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-    if (mDate) {</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-        int32_t result;</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-        if (NS_SUCCEEDED(mDate-&gt;Compare(aStartTime, &amp;result)) &amp;&amp; result &gt; 0) {</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-            NS_ADDREF (*_retval = mDate);</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-            return NS_OK;</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-        }</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-    }</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-    *_retval = nullptr;</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-}</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-calRecurrenceDate::GetOccurrences(calIDateTime *aStartTime,</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-                                  calIDateTime *aRangeStart,</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-                                  calIDateTime *aRangeEnd,</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-                                  uint32_t aMaxCount,</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-                                  uint32_t *aCount, calIDateTime ***aDates)</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-{</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aStartTime);</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aRangeStart);</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+    classID: Components.ID(&quot;{806b6423-3aaa-4b26-afa3-de60563e9cec}&quot;),</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+    QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIRecurrenceDate]),</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+    classInfo: XPCOMUtils.generateCI({</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+        classID: Components.ID(&quot;{806b6423-3aaa-4b26-afa3-de60563e9cec}&quot;),</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+        contractID: &quot;@mozilla.org/calendar/recurrence-date;1&quot;,</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+        classDescription: &quot;The Date of an occurrence of a recurring item&quot;,</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+        interfaces: [Components.interfaces.calIRecurrenceDate],</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+    }),</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+    makeImmutable: function makeImmutable() {</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+        this.isMutable = false;</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+    },</span>
<a href="#l7.170"></a><span id="l7.170"> </span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-    int32_t r1, r2;</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+    ensureMutable: function ensureMutable() {</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+        if (!this.isMutable) {</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+            throw Components.results.NS_ERROR_OBJECT_IS_MUTABLE;</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+        }</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+    },</span>
<a href="#l7.177"></a><span id="l7.177"> </span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-    if (mDate) {</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-        if (NS_SUCCEEDED(mDate-&gt;Compare(aRangeStart, &amp;r1)) &amp;&amp; r1 &gt;= 0 &amp;&amp;</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-            (!aRangeEnd || (NS_SUCCEEDED(mDate-&gt;Compare(aRangeEnd, &amp;r2)) &amp;&amp; r2 &lt; 0)))</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-        {</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-            calIDateTime **dates = (calIDateTime **) nsMemory::Alloc(sizeof(calIDateTime*));</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-            NS_ADDREF (dates[0] = mDate);</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-            *aDates = dates;</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-            *aCount = 1;</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-            return NS_OK;</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-        }</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-    }</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+    clone: function clone() {</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+        let other = new calRecurrenceDate();</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+        other.mDate = (this.mDate ? this.mDate.clone() : null);</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+        other.mIsNegative = this.mIsNegative;</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+        return other;</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+    },</span>
<a href="#l7.195"></a><span id="l7.195"> </span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-    *aDates = nullptr;</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-    *aCount = 0;</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineminus">-}</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+    get isNegative() this.mIsNegative,</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+    set isNegative(val) {</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+        this.ensureMutable();</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+        return (this.mIsNegative = val);</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+    },</span>
<a href="#l7.205"></a><span id="l7.205"> </span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-/**</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">- ** ical property getting/setting</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">- **/</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-calRecurrenceDate::GetIcalProperty(calIIcalProperty **aProp)</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-{</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aProp);</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-    if (!mDate)</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+    get isFinite() true,</span>
<a href="#l7.216"></a><span id="l7.216"> </span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-    nsresult rc = cal::getICSService()-&gt;CreateIcalProperty(</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-        (mIsNegative ? nsDependentCString(&quot;EXDATE&quot;) : nsDependentCString(&quot;RDATE&quot;)), aProp);</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineminus">-    if (NS_FAILED(rc))</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineminus">-        return rc;</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+    get date() this.mDate,</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+    set date(val) {</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+        this.ensureMutable();</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+        return (this.mDate = val);</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+    },</span>
<a href="#l7.226"></a><span id="l7.226"> </span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-    return (*aProp)-&gt;SetValueAsDatetime(mDate);</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineminus">-}</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-calRecurrenceDate::SetIcalProperty(calIIcalProperty *aProp)</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-{</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aProp);</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+    getNextOccurrence: function getNextOccurrence(aStartTime, aOccurrenceTime) {</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+        if (this.mDate &amp;&amp; this.mDate.compare(aStartTime) &gt; 0) {</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+            return this.mDate;</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+        } else {</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+            return null;</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+        }</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+    },</span>
<a href="#l7.241"></a><span id="l7.241"> </span>
<a href="#l7.242"></a><span id="l7.242" class="difflineminus">-    nsAutoCString name;</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineminus">-    nsresult rc = aProp-&gt;GetPropertyName(name);</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-    if (NS_FAILED(rc))</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineminus">-        return rc;</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-    if (name.EqualsLiteral(&quot;RDATE&quot;)) {</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineminus">-        mIsNegative = false;</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-        icalvalue * const value = icalproperty_get_value(aProp-&gt;GetIcalProperty());</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-        if (icalvalue_isa(value) == ICAL_PERIOD_VALUE) {</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-            icalperiodtype const period = icalvalue_get_period(value);</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-            // take only period's start date and skip end date, but continue parsing;</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-            // open bug 489747:</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineminus">-            mDate = new calDateTime(&amp;period.start, nullptr /* detect timezone */);</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineminus">-            return NS_OK;</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+    getOccurrences: function getOccurrences(aStartTime, aRangeStart, aRangeEnd, aMaxCount, aCount) {</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+        if (this.mDate &amp;&amp;</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+            this.mDate.compare(aRangeStart) &gt;= 0 &amp;&amp;</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+            (!aRangeEnd || this.mDate.compare(aRangeEnd) &lt; 0)) {</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+            aCount.value = 1;</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+            return [this.mDate];</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+        } else {</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+            aCount.value = 0;</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+            return [];</span>
<a href="#l7.264"></a><span id="l7.264">         }</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineminus">-    } else if (name.EqualsLiteral(&quot;EXDATE&quot;))</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineminus">-        mIsNegative = true;</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineminus">-    else</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineminus">-        return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineminus">-    return aProp-&gt;GetValueAsDatetime(getter_AddRefs(mDate));</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-}</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+    },</span>
<a href="#l7.273"></a><span id="l7.273"> </span>
<a href="#l7.274"></a><span id="l7.274" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineminus">-calRecurrenceDate::SetIcalString(const nsACString &amp;str)</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineminus">-{</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-    nsAutoCString name;</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-    nsCOMPtr&lt;calIICSService&gt; icsSvc = cal::getICSService();</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineminus">-    nsCOMPtr&lt;calIIcalProperty&gt; prop;</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+    get icalString() {</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+        let comp = this.icalProperty;</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+        return (comp ? comp.icalString : &quot;&quot;);</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+    },</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+    set icalString(val) {</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+        let prop = cal.getIcsService().createIcalPropertyFromString(val);</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineplus">+        let propName = prop.propertyName;</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+        if (propName != &quot;RDATE&quot; &amp;&amp; propName != &quot;EXDATE&quot;) {</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineplus">+            throw Components.results.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineplus">+        }</span>
<a href="#l7.291"></a><span id="l7.291"> </span>
<a href="#l7.292"></a><span id="l7.292" class="difflineminus">-    rv = icsSvc-&gt;CreateIcalPropertyFromString(str, getter_AddRefs(prop));</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineminus">-</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineminus">-    rv = prop-&gt;GetPropertyName(name);</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineminus">-</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-    if (!name.EqualsLiteral(&quot;RDATE&quot;) &amp;&amp; !name.EqualsLiteral(&quot;EXDATE&quot;)) {</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineminus">-        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineminus">-    }</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+        this.icalProperty = prop;</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+        return val;</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineplus">+    },</span>
<a href="#l7.304"></a><span id="l7.304"> </span>
<a href="#l7.305"></a><span id="l7.305" class="difflineminus">-    return SetIcalProperty(prop);</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineminus">-}</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineminus">-</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineminus">-calRecurrenceDate::GetIcalString(nsACString &amp;str)</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineminus">-{</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineminus">-</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineminus">-    nsCOMPtr&lt;calIIcalProperty&gt; prop;</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineminus">-</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineminus">-    rv = this-&gt;GetIcalProperty(getter_AddRefs(prop));</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineminus">-</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineminus">-        rv = prop-&gt;GetIcalString(str);</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+    get icalProperty() {</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+        let prop = cal.getIcsService().createIcalProperty(this.mIsNegative ? &quot;EXDATE&quot; : &quot;RDATE&quot;);</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+        prop.valueAsDatetime = this.mDate;</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineplus">+        return prop;</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineplus">+    },</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineplus">+    set icalProperty(prop) {</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineplus">+        if (prop.propertyName == &quot;RDATE&quot;) {</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineplus">+            this.mIsNegative = false;</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineplus">+            if (prop.getParameter(&quot;VALUE&quot;) == &quot;PERIOD&quot;) {</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineplus">+                let period = Components.classes[&quot;@mozilla.org/calendar/period;1&quot;]</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+                                       .createInstance(Components.interfaces.calIPeriod);</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineplus">+                period.icalString = prop.valueAsIcalString;</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+                this.mDate = period.start;</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+            } else {</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineplus">+                this.mDate = prop.valueAsDatetime;</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineplus">+            }</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineplus">+        } else if (prop.propertyName == &quot;EXDATE&quot;) {</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+            this.mIsNegative = true;</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+            this.mDate = prop.valueAsDatetime;</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+        }</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+        return prop;</span>
<a href="#l7.340"></a><span id="l7.340">     }</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineminus">-</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineminus">-    return rv;</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineminus">-}</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/test/unit/test_ics_service.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/test/unit/test_ics_service.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -53,16 +53,22 @@ function test_icalstring() {</span>
<a href="#l8.4"></a><span id="l8.4">                           { count: 5, isByCount: true, type: &quot;WEEKLY&quot;, interval: 2 });</span>
<a href="#l8.5"></a><span id="l8.5">     do_check_eq(rrule.getComponent(&quot;BYDAY&quot;, {}).toString(), [2].toString());</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">     let rdate = checkComp(cal.createRecurrenceDate.bind(cal),</span>
<a href="#l8.8"></a><span id="l8.8">                           &quot;RDATE;VALUE=DATE-TIME:20120101T000000&quot;,</span>
<a href="#l8.9"></a><span id="l8.9">                           { isNegative: false });</span>
<a href="#l8.10"></a><span id="l8.10">     do_check_eq(rdate.date.compare(cal.createDateTime(&quot;20120101T000000&quot;)), 0);</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+    /* TODO consider removing period support, ics throws badarg</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    let rdateperiod = checkComp(cal.createRecurrenceDate.bind(cal),</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+                                &quot;RDATE;VALUE=PERIOD;20120101T000000Z/20120102T000000Z&quot;);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+    do_check_eq(rdate.date.compare(cal.createDateTime(&quot;20120101T000000Z&quot;)), 0);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+    */</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+</span>
<a href="#l8.18"></a><span id="l8.18">     let exdate = checkComp(cal.createRecurrenceDate.bind(cal),</span>
<a href="#l8.19"></a><span id="l8.19">                            &quot;EXDATE:20120101T000000&quot;,</span>
<a href="#l8.20"></a><span id="l8.20">                            { isNegative: true });</span>
<a href="#l8.21"></a><span id="l8.21">     do_check_eq(rdate.date.compare(cal.createDateTime(&quot;20120101T000000&quot;)), 0);</span>
<a href="#l8.22"></a><span id="l8.22"> }</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24"> function test_icsservice() {</span>
<a href="#l8.25"></a><span id="l8.25">     let svc = cal.getIcsService();</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

