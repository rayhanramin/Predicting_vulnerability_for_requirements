<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 1208:6ae64ba031744a30f7b915ad3f391042e300ca8e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6ae64ba031744a30f7b915ad3f391042e300ca8e" />
<meta property="og:url" content="/comm-central/rev/6ae64ba031744a30f7b915ad3f391042e300ca8e" />
<meta property="og:description" content="Bug 461479 - &quot;Integrate generalized Bayes traits into mailnews classifications&quot; [r=Standard8,sr=bienvenu]" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6ae64ba031744a30f7b915ad3f391042e300ca8e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6ae64ba031744a30f7b915ad3f391042e300ca8e">shortlog</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6ae64ba031744a30f7b915ad3f391042e300ca8e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e">files</a> |
changeset |
<a href="/comm-central/raw-rev/6ae64ba031744a30f7b915ad3f391042e300ca8e">raw</a>  | <a href="/comm-central/archive/6ae64ba031744a30f7b915ad3f391042e300ca8e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=461479">Bug 461479</a> - &quot;Integrate generalized Bayes traits into mailnews classifications&quot; [r=Standard8,sr=bienvenu]
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#101;&#110;&#116;&#32;&#74;&#97;&#109;&#101;&#115;&#32;&#60;&#107;&#101;&#110;&#116;&#64;&#99;&#97;&#115;&#112;&#105;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 24 Nov 2008 19:55:17 +0000</td></tr>

<tr>
 <td>changeset 1208</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6ae64ba031744a30f7b915ad3f391042e300ca8e">6ae64ba031744a30f7b915ad3f391042e300ca8e</a></td>
</tr>



<tr>
<td>parent 1207</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7a0ccd9061eb7dba272bb3fb142a92b69aec9d34">7a0ccd9061eb7dba272bb3fb142a92b69aec9d34</a>
</td>
</tr>

<tr>
<td>child 1209</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c6e9f82a0f43be84a653386cac11e55d7b683ca0">c6e9f82a0f43be84a653386cac11e55d7b683ca0</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6ae64ba031744a30f7b915ad3f391042e300ca8e">934</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 24 Nov 2008 19:55:37 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@6ae64ba03174 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6ae64ba031744a30f7b915ad3f391042e300ca8e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6ae64ba031744a30f7b915ad3f391042e300ca8e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6ae64ba031744a30f7b915ad3f391042e300ca8e&newProject=comm-central&newRevision=6ae64ba031744a30f7b915ad3f391042e300ca8e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6ae64ba031744a30f7b915ad3f391042e300ca8e&newProject=comm-central&newRevision=6ae64ba031744a30f7b915ad3f391042e300ca8e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6ae64ba031744a30f7b915ad3f391042e300ca8e&newProject=comm-central&newRevision=6ae64ba031744a30f7b915ad3f391042e300ca8e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a>, <a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=461479">461479</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=461479">Bug 461479</a> - &quot;Integrate generalized Bayes traits into mailnews classifications&quot; [r=Standard8,sr=bienvenu]</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mail/installer/windows/packages-static">mail/installer/windows/packages-static</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/mail/installer/windows/packages-static">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/mail/installer/windows/packages-static">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mail/installer/windows/packages-static">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/mail/installer/windows/packages-static">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/mail/installer/windows/packages-static">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/public/nsIMsgFolder.idl">mailnews/base/public/nsIMsgFolder.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/public/nsIMsgFolder.idl">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/public/nsIMsgFolder.idl">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/public/nsIMsgFolder.idl">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/public/nsIMsgFolder.idl">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/public/nsIMsgFolder.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/public/nsMsgMessageFlags.h">mailnews/base/public/nsMsgMessageFlags.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/public/nsMsgMessageFlags.h">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/public/nsMsgMessageFlags.h">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/public/nsMsgMessageFlags.h">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/public/nsMsgMessageFlags.h">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/public/nsMsgMessageFlags.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/public/Makefile.in">mailnews/base/search/public/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/public/Makefile.in">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/public/Makefile.in">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/public/Makefile.in">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/public/Makefile.in">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/public/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/public/nsIMsgTraitService.idl">mailnews/base/search/public/nsIMsgTraitService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/public/nsIMsgTraitService.idl">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/public/nsIMsgTraitService.idl">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/public/nsIMsgTraitService.idl">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/public/nsIMsgTraitService.idl">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/public/nsIMsgTraitService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/src/Makefile.in">mailnews/base/search/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/src/nsMsgTraitService.js">mailnews/base/search/src/nsMsgTraitService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/src/nsMsgTraitService.js">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/src/nsMsgTraitService.js">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/src/nsMsgTraitService.js">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/src/nsMsgTraitService.js">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/search/src/nsMsgTraitService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/test/unit/test_nsMsgTraitService.js">mailnews/base/test/unit/test_nsMsgTraitService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/test/unit/test_nsMsgTraitService.js">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/test/unit/test_nsMsgTraitService.js">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/test/unit/test_nsMsgTraitService.js">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/test/unit/test_nsMsgTraitService.js">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/test/unit/test_nsMsgTraitService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/util/nsMsgDBFolder.h">mailnews/base/util/nsMsgDBFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/util/nsMsgDBFolder.h">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/util/nsMsgDBFolder.h">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/util/nsMsgDBFolder.h">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/util/nsMsgDBFolder.h">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/base/util/nsMsgDBFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/imap/src/nsImapMailFolder.h">mailnews/imap/src/nsImapMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/imap/src/nsImapMailFolder.h">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/imap/src/nsImapMailFolder.h">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/imap/src/nsImapMailFolder.h">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/imap/src/nsImapMailFolder.h">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/imap/src/nsImapMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/local/src/nsLocalMailFolder.h">mailnews/local/src/nsLocalMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/local/src/nsLocalMailFolder.h">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/local/src/nsLocalMailFolder.h">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/local/src/nsLocalMailFolder.h">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/local/src/nsLocalMailFolder.h">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/local/src/nsLocalMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/mailnews.js">mailnews/mailnews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/mailnews.js">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/mailnews.js">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/mailnews.js">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/mailnews.js">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/mailnews/mailnews.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/suite/installer/unix/packages">suite/installer/unix/packages</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/suite/installer/unix/packages">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/suite/installer/unix/packages">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/suite/installer/unix/packages">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/suite/installer/unix/packages">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/suite/installer/unix/packages">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/suite/installer/windows/packages">suite/installer/windows/packages</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6ae64ba031744a30f7b915ad3f391042e300ca8e/suite/installer/windows/packages">file</a> |
<a href="/comm-central/annotate/6ae64ba031744a30f7b915ad3f391042e300ca8e/suite/installer/windows/packages">annotate</a> |
<a href="/comm-central/diff/6ae64ba031744a30f7b915ad3f391042e300ca8e/suite/installer/windows/packages">diff</a> |
<a href="/comm-central/comparison/6ae64ba031744a30f7b915ad3f391042e300ca8e/suite/installer/windows/packages">comparison</a> |
<a href="/comm-central/log/6ae64ba031744a30f7b915ad3f391042e300ca8e/suite/installer/windows/packages">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/installer/windows/packages-static</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/installer/windows/packages-static</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -183,16 +183,19 @@ bin\components\url-classifier.xpt</span>
<a href="#l1.4"></a><span id="l1.4"> bin\components\nsAbAutoCompleteMyDomain.js</span>
<a href="#l1.5"></a><span id="l1.5"> bin\components\nsAbAutoCompleteSearch.js</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> ; Windows Search integration</span>
<a href="#l1.8"></a><span id="l1.8"> bin\components\nsWinSearchIntegration.js</span>
<a href="#l1.9"></a><span id="l1.9"> bin\components\mailwinsearch.xpt</span>
<a href="#l1.10"></a><span id="l1.10"> bin\WSEnable.exe</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+; Bayesian trait analysis</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+bin\components\nsMsgTraitService.js</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+</span>
<a href="#l1.15"></a><span id="l1.15"> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<a href="#l1.16"></a><span id="l1.16"> ; Base Package Files</span>
<a href="#l1.17"></a><span id="l1.17"> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> ; xpconnect</span>
<a href="#l1.20"></a><span id="l1.20"> bin\components\xpconnect.xpt</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22"> ; XP widgets/graphics</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -62,17 +62,17 @@ interface nsILocalFile;</span>
<a href="#l2.4"></a><span id="l2.4"> interface nsIMsgIdentity;</span>
<a href="#l2.5"></a><span id="l2.5"> interface nsIArray;</span>
<a href="#l2.6"></a><span id="l2.6"> interface nsIMutableArray;</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> typedef long nsMsgBiffState;</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> // enumerated type for determining if a message has been replied to, forwarded, etc.</span>
<a href="#l2.11"></a><span id="l2.11"> typedef long nsMsgDispositionState;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-[scriptable, uuid(EAE4729C-4CC1-4167-8E00-0C159DA05FD2)]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+[scriptable, uuid(1A293A14-3ACA-44de-BD7B-93F26BD2309D)]</span>
<a href="#l2.14"></a><span id="l2.14"> interface nsIMsgFolder : nsISupports {</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">   const nsMsgBiffState nsMsgBiffState_NewMail = 0; // User has new mail waiting.</span>
<a href="#l2.17"></a><span id="l2.17">   const nsMsgBiffState nsMsgBiffState_NoMail =  1; // No new mail is waiting.</span>
<a href="#l2.18"></a><span id="l2.18">   const nsMsgBiffState nsMsgBiffState_Unknown = 2; // We dunno whether there is new mail.</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">   nsISimpleEnumerator getMessages(in nsIMsgWindow aMsgWindow);</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -633,9 +633,32 @@ interface nsIMsgFolder : nsISupports {</span>
<a href="#l2.23"></a><span id="l2.23">                                    in unsigned long aBytesToRead, in unsigned long aMaxOutputLen, </span>
<a href="#l2.24"></a><span id="l2.24">                                    in boolean aCompressQuotes, in boolean aStripHTMLTags,</span>
<a href="#l2.25"></a><span id="l2.25">                                    out ACString aContentType);</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27">   // this allows a folder to have a special identity. E.g., you might want to</span>
<a href="#l2.28"></a><span id="l2.28">   // associate an identity with a particular newsgroup, or for IMAP shared folders in</span>
<a href="#l2.29"></a><span id="l2.29">   // the other users namespace, you might want to create a delegated identity</span>
<a href="#l2.30"></a><span id="l2.30">   readonly attribute nsIMsgIdentity customIdentity;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  /**</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+   * @{</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+   * Processing flags, used to manage message processing.</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+   *</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+   * @param msgKey   message key</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+   * @return         processing flags</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+   */</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  unsigned long getProcessingFlags(in nsMsgKey msgKey);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  /**</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+   * @param msgKey   message key</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+   * @param mask     mask to OR into the flags</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+   */</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  void orProcessingFlags(in nsMsgKey msgKey, in unsigned long mask);</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+  /**</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+   * @param msgKey   message key</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+   * @param mask     mask to AND into the flags</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+   */</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+  void andProcessingFlags(in nsMsgKey msgKey, in unsigned long mask);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  /** @} */</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+</span>
<a href="#l2.54"></a><span id="l2.54"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/public/nsMsgMessageFlags.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/public/nsMsgMessageFlags.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -133,9 +133,23 @@ typedef PRInt32 MsgFlags;</span>
<a href="#l3.4"></a><span id="l3.4"> 					   share these bits. But it would be wrong.</span>
<a href="#l3.5"></a><span id="l3.5"> 					.  */</span>
<a href="#l3.6"></a><span id="l3.6"> // we're trying to reserve the high byte of the flags for view flags,</span>
<a href="#l3.7"></a><span id="l3.7"> // so, don't add flags to the high byte if possible.</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> /* The list of all message flags to not write to disk. */</span>
<a href="#l3.10"></a><span id="l3.10"> #define MSG_FLAG_RUNTIME_ONLY   (MSG_FLAG_ELIDED)</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+/* Definitions of processing flags. These flags are not saved to the database.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ * They are used to define states for message processing. Any changes</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+ * to these flags need to be supported in the key sets in nsMsgDBFolder</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+ */</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+ </span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+/* If set, message needs junk classification */</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+#define MSG_PROCESSING_FLAG_CLASSIFY_JUNK             0x00000001</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+/* If set, message needs traits classification */</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+#define MSG_PROCESSING_FLAG_CLASSIFY_TRAITS           0x00000002</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+/* number of processing flags */</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+#define MSG_NUMBER_OF_PROCESSING_FLAGS 2</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+</span>
<a href="#l3.26"></a><span id="l3.26"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/search/public/Makefile.in</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/search/public/Makefile.in</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -67,12 +67,13 @@ XPIDLSRCS	= \</span>
<a href="#l4.4"></a><span id="l4.4"> 		nsIMsgSearchSession.idl \</span>
<a href="#l4.5"></a><span id="l4.5"> 		nsIMsgSearchScopeTerm.idl \</span>
<a href="#l4.6"></a><span id="l4.6"> 		nsIMsgSearchNotify.idl \</span>
<a href="#l4.7"></a><span id="l4.7"> 		nsIMsgSearchValidityTable.idl \</span>
<a href="#l4.8"></a><span id="l4.8"> 		nsIMsgSearchValidityManager.idl \</span>
<a href="#l4.9"></a><span id="l4.9"> 		nsMsgFilterCore.idl \</span>
<a href="#l4.10"></a><span id="l4.10"> 		nsMsgSearchCore.idl \</span>
<a href="#l4.11"></a><span id="l4.11"> 		nsIMsgFilterCustomAction.idl \</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+		nsIMsgTraitService.idl \</span>
<a href="#l4.13"></a><span id="l4.13"> 		$(NULL)</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15"> include $(topsrcdir)/config/rules.mk</span>
<a href="#l4.16"></a><span id="l4.16"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgTraitService.idl</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,175 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+ *</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+ *</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+ * License.</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+ *</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+ *</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+ * Kent James &lt;kent@caspia.com&gt;.</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+ *</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+ *</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+ *</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+ /**</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+  * This interface provides management of traits that are used to categorize</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+  * messages. A trait is some characteristic of a message, such as being &quot;junk&quot;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+  * or &quot;personal&quot;, that may be discoverable by analysis of the message.</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+  *</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+  * Traits are described by a universal identifier &quot;id&quot; as a string, as well</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+  * as a local integer identifer &quot;index&quot;. One purpose of this service is to</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+  * provide the mapping between those forms.</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+  *</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+  * Recommended (but not required) format for id:</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+  * &quot;extensionName@example.org#traitName&quot;</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+  */</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+[scriptable, uuid(e3e47690-a676-12d6-81c9-00308646b737)]</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+interface nsIMsgTraitService : nsISupports</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+{</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+  /**</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+   *  the highest ever index for a registered trait. The first trait is 1,</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+   *  == 0 means no traits are defined</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+   */</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+  readonly attribute long lastIndex;</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+  /**</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+   * Register a trait. May be called multiple times, but subsequent</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+   * calls do not register the trait</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+   *</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+   * @param id   the trait universal identifier</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+   *</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+   * @return     the internal index for the registered trait if newly</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+   *             registered, else 0</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+   */</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+  unsigned long registerTrait(in ACString id);</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+  /**</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+   * Unregister a trait.</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+   *</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+   * @param id   the trait universal identifier</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+   */</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+  void unRegisterTrait(in ACString id);</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+  /**</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+   * is a trait registered?</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+   *</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+   * @param id   the trait universal identifier</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+   *</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+   * @return     true if registered</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+   */</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+  boolean isRegistered(in ACString id);</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+  /**</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+   * set the trait name, which is an optional short description of the trait</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+   *</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+   * @param id     the trait universal identifier</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+   * @param name   description of the trait.</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+   */</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+  void setName(in ACString id, in ACString name);</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+  /**</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+   * get the trait name, which is an optional short description of the trait</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+   *</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+   * @param id   the trait universal identifier</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+   *</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+   * @return     description of the trait</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+   */</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+  ACString getName(in ACString id);</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+  /**</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+   * get the internal index number for the trait.</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+   *</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+   * @param id   the trait universal identifier</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+   *</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+   * @return     internal index number for the trait</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+   */</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+  unsigned long getIndex(in ACString id);</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+  /**</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+   * get the trait universal identifier for an internal trait index</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+   *</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+   * @param index   the internal identifier for the trait</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+   *</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+   * @return        trait universal identifier</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+   */</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+  ACString getId(in unsigned long index);</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+  /**</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+   * enable the trait for analysis. Each enabled trait will be analyzed by</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+   * the bayesian code. The enabled trait is the &quot;pro&quot; trait that represents</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+   * messages matching the trait. Each enabled trait also needs a corresponding</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+   * anti trait defined, which represents messages that do not match the trait.</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+   * The anti trait does not need to be enabled</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+   *</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+   * @param id        the trait universal identifier</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+   * @param enabled   should this trait be processed by the bayesian analyzer?</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+   */</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+  void setEnabled(in ACString id, in boolean enabled);</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+  /**</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+   * Should this trait be processed by the bayes analyzer?</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+   *</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+   * @param id   the trait universal identifier</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+   *</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+   * @return     true if this is a &quot;pro&quot; trait to process</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+   */</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+  boolean getEnabled(in ACString id);</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+  /**</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+   * set the anti trait, which indicates messages that have been marked as</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+   * NOT matching a particular trait.</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+   *</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+   * @param id      the trait universal identifier</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+   * @param antiId  trait id for messages marked as not matching the trait</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+   */</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+  void setAntiId(in ACString id, in ACString antiId);</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+  /**</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+   * get the id of traits that do not match a particular trait</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+   *</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+   * @param id   the trait universal identifier for a &quot;pro&quot; trait</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+   *</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+   * @return     universal trait identifier for an &quot;anti&quot; trait that does not</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+   *             match the &quot;pro&quot; trait messages</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+   */</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+  ACString getAntiId(in ACString id);</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+  /**</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+   * get an array of traits to be analyzed by the bayesian code. This is</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+   * a pair of traits: a &quot;pro&quot; trait of messages that match the trait (and is</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+   * set enabled) and an &quot;anti&quot; trait of messages that do not match the trait.</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+   *</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+   * @param count        length of proIndices and antiIndices arrays</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+   * @param proIndices   trait internal index for &quot;pro&quot; trait to analyze</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+   * @param antiIndices  trait internal index for corresponding &quot;anti&quot; traits</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+   */</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+  void getEnabledIndices(out unsigned long count,</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+                         [array, size_is(count)] out unsigned long proIndices,</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+                         [array, size_is(count)] out unsigned long antiIndices);</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/search/src/Makefile.in</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/search/src/Makefile.in</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -78,16 +78,20 @@ CPPSRCS		= \</span>
<a href="#l6.4"></a><span id="l6.4"> 		nsMsgLocalSearch.cpp \</span>
<a href="#l6.5"></a><span id="l6.5"> 		nsMsgSearchValue.cpp \</span>
<a href="#l6.6"></a><span id="l6.6"> 		nsMsgSearchAdapter.cpp \</span>
<a href="#l6.7"></a><span id="l6.7"> 		nsMsgSearchSession.cpp \</span>
<a href="#l6.8"></a><span id="l6.8"> 		nsMsgImapSearch.cpp \</span>
<a href="#l6.9"></a><span id="l6.9"> 		nsMsgSearchNews.cpp \</span>
<a href="#l6.10"></a><span id="l6.10"> 		$(NULL)</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+EXTRA_COMPONENTS += \</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+		nsMsgTraitService.js \</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+		$(NULL)</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+ </span>
<a href="#l6.16"></a><span id="l6.16"> EXPORT_RESOURCE_FILES	= \</span>
<a href="#l6.17"></a><span id="l6.17"> 				  SpamAssassin.sfd \</span>
<a href="#l6.18"></a><span id="l6.18"> 				  SpamPal.sfd \</span>
<a href="#l6.19"></a><span id="l6.19"> 			        $(NULL)</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21"> # we don't want the shared lib, but we want to force the creation of a static lib.</span>
<a href="#l6.22"></a><span id="l6.22"> FORCE_STATIC_LIB = 1</span>
<a href="#l6.23"></a><span id="l6.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgTraitService.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,217 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ *</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+ *</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+ * License.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+ *</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+ *</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+ * Kent James &lt;kent@caspia.com&gt;.</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+ *</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+ *</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+ *</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+// local static variables</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+var _lastIndex = 0;  // the first index will be one</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+var _traits = {};</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+                      .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+var traitsBranch = prefs.getBranch(&quot;mailnews.traits.&quot;);</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+function _registerTrait(aId, aIndex)</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+{</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+  var trait = {};</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+  trait.enabled = false;</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+  trait.name = &quot;&quot;;</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+  trait.antiId = &quot;&quot;;</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+  trait.index = aIndex;</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+  _traits[aId] = trait;</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  return;</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+}</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+function nsMsgTraitService() {}</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+nsMsgTraitService.prototype =</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+{</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+  // Component setup</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+  classDescription: &quot;nsMsgTraitService&quot;,</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  contractID: &quot;@mozilla.org/msg-trait-service;1&quot;,</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  classID: Components.ID(&quot;{A2E95F4F-DA72-4a41-9493-661AD353C00A}&quot;),</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+      Components.interfaces.nsIMsgTraitService]),</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+  // nsIMsgTraitService implementation</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  get lastIndex()</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+  {</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+    return _lastIndex;</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+  },</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+  registerTrait: function(aId)</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+  {</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+    if (_traits[aId])</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+      return 0;  // meaning already registered</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+    _registerTrait(aId, ++_lastIndex);</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+    traitsBranch.setBoolPref(&quot;enabled.&quot; + _lastIndex, false);</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+    traitsBranch.setCharPref(&quot;id.&quot; + _lastIndex, aId);</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+    return _lastIndex;</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+  },</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+  unRegisterTrait: function(aId)</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+  {</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+    if (_traits[aId])</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+    {</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+      var index = _traits[aId].index;</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+      _traits[aId] = null;</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+      traitsBranch.clearUserPref(&quot;id.&quot; + index);</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+      traitsBranch.clearUserPref(&quot;enabled.&quot; + index);</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+      traitsBranch.clearUserPref(&quot;antiId.&quot; + index);</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+      traitsBranch.clearUserPref(&quot;name.&quot; + index);</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+    }</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+    return;</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+  },</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+  isRegistered: function(aId)</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+  {</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+    return _traits[aId] ? true : false;</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+  },</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+  setName: function(aId, aName)</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+  {</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+    traitsBranch.setCharPref(&quot;name.&quot; + _traits[aId].index, aName);</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+    _traits[aId].name = aName;</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+  },</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+  getName: function(aId)</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+  {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+    return _traits[aId].name;</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+  },</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+  getIndex: function(aId)</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+  {</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+    return _traits[aId].index;</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+  },</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+  getId: function(aIndex)</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+  {</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+    for (id in _traits)</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+      if (_traits[id].index == aIndex)</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+        return id;</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+    return null;</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+  },</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+  setEnabled: function(aId, aEnabled)</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+  {</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+    traitsBranch.setBoolPref(&quot;enabled.&quot; + _traits[aId].index, aEnabled)</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+    _traits[aId].enabled = aEnabled;</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+  },</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+  getEnabled: function(aId)</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+  {</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+    return _traits[aId].enabled;</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+  },</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+  setAntiId: function(aId, aAntiId)</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+  {</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+    traitsBranch.setCharPref(&quot;antiId.&quot; + _traits[aId].index, aAntiId);</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+    _traits[aId].antiId = aAntiId;</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+  },</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+  getAntiId: function(aId)</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+  {</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+    return _traits[aId].antiId;</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+  },</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+  getEnabledIndices: function(aCount, aProIndices, aAntiIndices)</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+  {</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+    proIndices = [];</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+    antiIndices = [];</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+    for (id in _traits)</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+      if (_traits[id].enabled)</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+      {</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+        proIndices.push(_traits[id].index);</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+        antiIndices.push(_traits[_traits[id].antiId].index);</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+      }</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+    aCount.value = proIndices.length;</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+    aProIndices.value = proIndices;</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+    aAntiIndices.value = antiIndices;</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+    return;</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+  },</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+};</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+// initialization</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+_init();</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+function _init()</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+{</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+  // get existing traits</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+  var idBranch = prefs.getBranch(&quot;mailnews.traits.id.&quot;);</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+  var nameBranch = prefs.getBranch(&quot;mailnews.traits.name.&quot;);</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+  var enabledBranch = prefs.getBranch(&quot;mailnews.traits.enabled.&quot;);</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+  var antiIdBranch = prefs.getBranch(&quot;mailnews.traits.antiId.&quot;);</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+  _lastIndex = prefs.getBranch(&quot;mailnews.traits.&quot;).getIntPref(&quot;lastIndex&quot;);</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+  var ids = idBranch.getChildList(&quot;&quot;, {});</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+  for (var i = 0; i &lt; ids.length; i++)</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+  {</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+    var id = idBranch.getCharPref(ids[i]);</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+    index = parseInt(ids[i]);</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+    _registerTrait(id, index, false);</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+    // Read in values, ignore errors since that usually means the</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+    // value does not exist</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+    try {</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+      _traits[id].name = nameBranch.getCharPref(ids[i]);</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+    }</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+    catch (e) {}</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+    try {</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+      _traits[id].enabled = enabledBranch.getBoolPref(ids[i]);</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+    }</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+    catch (e) {}</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+    try {</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+      _traits[id].antiId = antiIdBranch.getCharPref(ids[i]);</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+    }</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+    catch (e) {}</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+    if (_lastIndex &lt; index)</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+      _lastIndex = index;</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+  }</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+  //for (traitId in _traits)</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+  //  dump(&quot;\nindex of &quot; + traitId + &quot; is &quot; + _traits[traitId].index);</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+  //dump(&quot;\n&quot;);</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+}</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+function NSGetModule(compMgr, fileSpec) {</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+  return XPCOMUtils.generateModule([nsMsgTraitService]);</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsMsgTraitService.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,127 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ *</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+ *</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+ * License.</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+ *</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+ *</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+ * Kent James &lt;kent@caspia.com&gt;.</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+ *</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+ *</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+ *</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+const ts = Cc[&quot;@mozilla.org/msg-trait-service;1&quot;]</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+             .getService(Ci.nsIMsgTraitService);</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+                      .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+var traitsBranch = prefs.getBranch(&quot;mailnews.traits.&quot;);</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+// junk-related traits set by default</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+const kJunkId = &quot;mailnews@mozilla.org#junk&quot;;</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+const kGoodId = &quot;mailnews@mozilla.org#good&quot;;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+const kGoodIndex = Ci.nsIJunkMailPlugin.GOOD_TRAIT;</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+const kJunkIndex = Ci.nsIJunkMailPlugin.JUNK_TRAIT;</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+// a dummy set of traits</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+const proId = &quot;TheProTrait&quot;;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+const proName = &quot;ProName&quot;;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+const antiId = &quot;TheAntiTrait&quot;;</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+const antiName = &quot;AntiName&quot;;</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+function run_test()</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+{</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+  // Check lastIndex prior to adding, 3 - 1000 are reserved for mailnews</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+  do_check_eq(ts.lastIndex, 1000);</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+  // basic junk as traits should be setup automatically</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+  do_check_eq(kGoodId, traitsBranch.getCharPref(&quot;id.&quot; + kGoodIndex));</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+  do_check_eq(kJunkId, traitsBranch.getCharPref(&quot;id.&quot; + kJunkIndex));</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+  do_check_eq(kGoodId, traitsBranch.getCharPref(&quot;antiId.&quot; + kJunkIndex));</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+  do_check_true(traitsBranch.getBoolPref(&quot;enabled.&quot; + kJunkIndex));</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+  // add the pro and anti test traits</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+  do_check_false(ts.isRegistered(proId));</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+  var proIndex = ts.registerTrait(proId);</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+  do_check_true(ts.isRegistered(proId));</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+  do_check_eq(proIndex, 1001);</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+  do_check_eq(proIndex, ts.getIndex(proId));</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+  do_check_eq(proId, ts.getId(proIndex));</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+  var antiIndex = ts.registerTrait(antiId);</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+  do_check_eq(proIndex, 1001);</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+  do_check_eq(antiIndex, 1002);</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+  // check setting and getting things through the service</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+  ts.setName(proId, proName);</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+  do_check_eq(proName, ts.getName(proId));</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+  do_check_false(ts.getEnabled(proId));</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+  ts.setEnabled(proId, true);</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+  do_check_true(ts.getEnabled(proId));</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+  ts.setAntiId(proId, antiId);</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+  do_check_eq(antiId, ts.getAntiId(proId));</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+  var proArray = {};</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+  var antiArray = {};</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+  ts.getEnabledIndices({}, proArray, antiArray);</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+  do_check_eq(proArray.value.length, 2);</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+  do_check_eq(antiArray.value.length, 2);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+  do_check_eq(proArray.value[1], proIndex);</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+  do_check_eq(antiArray.value[1], antiIndex);</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+  // now let's make sure this got saved in preferences</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+  do_check_eq(proId, traitsBranch.getCharPref(&quot;id.&quot; + proIndex));</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+  do_check_eq(proName, traitsBranch.getCharPref(&quot;name.&quot; + proIndex));</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+  do_check_true(traitsBranch.getBoolPref(&quot;enabled.&quot; + proIndex));</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+  do_check_eq(antiId, traitsBranch.getCharPref(&quot;antiId.&quot; + proIndex));</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+  // remove the pro trait</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+  ts.unRegisterTrait(proId);</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+  do_check_false(ts.isRegistered(proId));</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+  // check that this is also removed from prefs. The get calls should fail</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+  try {</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+    traitsBranch.getCharPref(&quot;id.&quot; + proIndex);</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+    do_check_true(false);</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+  }</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+  catch (e) {}</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+  try {</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+    traitsBranch.getCharPref(&quot;name.&quot; + proIndex);</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+    do_check_true(false);</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+  }</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+  catch (e) {}</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+  try {</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+    traitsBranch.getBoolPref(&quot;enabled.&quot; + proIndex);</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+    do_check_true(false);</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+  }</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+  catch (e) {}</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+  try {</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+    traitsBranch.getCharPref(&quot;antiId.&quot; + proIndex);</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+    do_check_true(false);</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+  }</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+  catch(e) {}</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -87,16 +87,17 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;plbase64.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> #include &lt;time.h&gt;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsIMsgFolderNotificationService.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsIMimeHeaders.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> #include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+#include &quot;nsIMsgTraitService.h&quot;</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14"> #define oneHour 3600000000U</span>
<a href="#l9.15"></a><span id="l9.15"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17"> static PRTime gtimeOfLastPurgeCheck;    //variable to know when to check for purge_threshhold</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19"> #define PREF_MAIL_PROMPT_PURGE_THRESHOLD &quot;mail.prompt_purge_threshhold&quot;</span>
<a href="#l9.20"></a><span id="l9.20"> #define PREF_MAIL_PURGE_THRESHOLD &quot;mail.purge_threshhold&quot;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineat">@@ -190,20 +191,28 @@ nsMsgDBFolder::nsMsgDBFolder(void)</span>
<a href="#l9.22"></a><span id="l9.22">     NS_RegisterStaticAtoms(folder_atoms, NS_ARRAY_LENGTH(folder_atoms));</span>
<a href="#l9.23"></a><span id="l9.23">     initializeStrings();</span>
<a href="#l9.24"></a><span id="l9.24">     createCollationKeyGenerator();</span>
<a href="#l9.25"></a><span id="l9.25"> #ifdef MSG_FASTER_URI_PARSING</span>
<a href="#l9.26"></a><span id="l9.26">     mParsingURL = do_CreateInstance(NS_STANDARDURL_CONTRACTID);</span>
<a href="#l9.27"></a><span id="l9.27"> #endif</span>
<a href="#l9.28"></a><span id="l9.28">     LL_I2L(gtimeOfLastPurgeCheck, 0);</span>
<a href="#l9.29"></a><span id="l9.29">   }</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+  mProcessingFlag[0].bit = MSG_PROCESSING_FLAG_CLASSIFY_JUNK;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  mProcessingFlag[1].bit = MSG_PROCESSING_FLAG_CLASSIFY_TRAITS;</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+  for (PRUint32 i = 0; i &lt; MSG_NUMBER_OF_PROCESSING_FLAGS; i++)</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+    mProcessingFlag[i].keys = nsMsgKeySetU::Create();</span>
<a href="#l9.35"></a><span id="l9.35"> }</span>
<a href="#l9.36"></a><span id="l9.36"> </span>
<a href="#l9.37"></a><span id="l9.37"> nsMsgDBFolder::~nsMsgDBFolder(void)</span>
<a href="#l9.38"></a><span id="l9.38"> {</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+  for (PRUint32 i = 0; i &lt; MSG_NUMBER_OF_PROCESSING_FLAGS; i++)</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+    delete mProcessingFlag[i].keys;</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+</span>
<a href="#l9.42"></a><span id="l9.42">   if (--mInstanceCount == 0) {</span>
<a href="#l9.43"></a><span id="l9.43">     NS_IF_RELEASE(gCollationKeyGenerator);</span>
<a href="#l9.44"></a><span id="l9.44">     NS_Free(kLocalizedInboxName);</span>
<a href="#l9.45"></a><span id="l9.45">     NS_Free(kLocalizedTrashName);</span>
<a href="#l9.46"></a><span id="l9.46">     NS_Free(kLocalizedSentName);</span>
<a href="#l9.47"></a><span id="l9.47">     NS_Free(kLocalizedDraftsName);</span>
<a href="#l9.48"></a><span id="l9.48">     NS_Free(kLocalizedTemplatesName);</span>
<a href="#l9.49"></a><span id="l9.49">     NS_Free(kLocalizedUnsentName);</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineat">@@ -1921,68 +1930,91 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l9.51"></a><span id="l9.51">   nsCString whiteListAbURI;</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l9.54"></a><span id="l9.54">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.55"></a><span id="l9.55"> </span>
<a href="#l9.56"></a><span id="l9.56">   nsCString serverType;</span>
<a href="#l9.57"></a><span id="l9.57">   server-&gt;GetType(serverType);</span>
<a href="#l9.58"></a><span id="l9.58"> </span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+  rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+  nsCOMPtr &lt;nsIMsgFilterPlugin&gt; filterPlugin;</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+  server-&gt;GetSpamFilterPlugin(getter_AddRefs(filterPlugin));</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+  if (!filterPlugin) // it's not an error not to have the filter plugin.</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+    return NS_OK;</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+  nsCOMPtr &lt;nsIJunkMailPlugin&gt; junkMailPlugin = do_QueryInterface(filterPlugin);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+  if (!junkMailPlugin) // we currently only support the junk mail plugin</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+    return NS_OK;</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+  </span>
<a href="#l9.70"></a><span id="l9.70">   // if this is the junk folder, or the trash folder</span>
<a href="#l9.71"></a><span id="l9.71">   // don't analyze for spam, because we don't care</span>
<a href="#l9.72"></a><span id="l9.72">   //</span>
<a href="#l9.73"></a><span id="l9.73">   // if it's the sent, unsent, templates, or drafts,</span>
<a href="#l9.74"></a><span id="l9.74">   // don't analyze for spam, because the user</span>
<a href="#l9.75"></a><span id="l9.75">   // created that message</span>
<a href="#l9.76"></a><span id="l9.76">   //</span>
<a href="#l9.77"></a><span id="l9.77">   // if it's a public imap folder, or another users</span>
<a href="#l9.78"></a><span id="l9.78">   // imap folder, don't analyze for spam, because</span>
<a href="#l9.79"></a><span id="l9.79">   // it's not ours to analyze</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+  //</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+  // We'll use the same folder logic for traits as well. Maybe we'll</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+  // reconsider that later.</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+</span>
<a href="#l9.84"></a><span id="l9.84">   if (serverType.EqualsLiteral(&quot;rss&quot;) ||</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-       (mFlags &amp; (nsMsgFolderFlags::Junk | nsMsgFolderFlags::Trash |</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-               nsMsgFolderFlags::SentMail | nsMsgFolderFlags::Queue |</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-               nsMsgFolderFlags::Drafts | nsMsgFolderFlags::Templates |</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-               nsMsgFolderFlags::ImapPublic | nsMsgFolderFlags::ImapOtherUser)</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-       &amp;&amp; !(mFlags &amp; nsMsgFolderFlags::Inbox)))</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-  rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFilterPlugin&gt; filterPlugin;</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-  server-&gt;GetSpamFilterPlugin(getter_AddRefs(filterPlugin));</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-  if (!filterPlugin) // it's not an error not to have the filter plugin.</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+     (mFlags &amp; (nsMsgFolderFlags::Junk | nsMsgFolderFlags::Trash |</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+             nsMsgFolderFlags::SentMail | nsMsgFolderFlags::Queue |</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+             nsMsgFolderFlags::Drafts | nsMsgFolderFlags::Templates |</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+             nsMsgFolderFlags::ImapPublic | nsMsgFolderFlags::ImapOtherUser)</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+     &amp;&amp; !(mFlags &amp; nsMsgFolderFlags::Inbox)))</span>
<a href="#l9.101"></a><span id="l9.101">     return NS_OK;</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-  nsCOMPtr &lt;nsIJunkMailPlugin&gt; junkMailPlugin = do_QueryInterface(filterPlugin);</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-  if (junkMailPlugin)</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-  {</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-    PRBool userHasClassified = PR_FALSE;</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-    // if the user has not classified any messages yet, then we shouldn't bother</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-    // running the junk mail controls. This creates a better first use experience.</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-    // See Bug #250084.</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-    junkMailPlugin-&gt;GetUserHasClassified(&amp;userHasClassified);</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-    if (!userHasClassified)</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-      return NS_OK;</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-  }</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+  PRBool filterForJunk = PR_TRUE;</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+  PRBool userHasClassified = PR_FALSE;</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+  // if the user has not classified any messages yet, then we shouldn't bother</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+  // running the junk mail controls. This creates a better first use experience.</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+  // See Bug #250084.</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+  junkMailPlugin-&gt;GetUserHasClassified(&amp;userHasClassified);</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+  if (!userHasClassified)</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+    filterForJunk = PR_FALSE;</span>
<a href="#l9.125"></a><span id="l9.125"> </span>
<a href="#l9.126"></a><span id="l9.126">   spamSettings-&gt;GetLevel(&amp;spamLevel);</span>
<a href="#l9.127"></a><span id="l9.127">   if (!spamLevel)</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+    filterForJunk = PR_FALSE;</span>
<a href="#l9.134"></a><span id="l9.134"> </span>
<a href="#l9.135"></a><span id="l9.135">   if (!mDatabase)</span>
<a href="#l9.136"></a><span id="l9.136">   {</span>
<a href="#l9.137"></a><span id="l9.137">     rv = GetDatabase(nsnull);   // XXX is nsnull a reasonable arg here?</span>
<a href="#l9.138"></a><span id="l9.138">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.139"></a><span id="l9.139">   }</span>
<a href="#l9.140"></a><span id="l9.140"> </span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+  // check if trait processing needed</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+      do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+  PRUint32 count, *proIndices, *antiIndices;</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+  rv = traitService-&gt;GetEnabledIndices(&amp;count, &amp;proIndices, &amp;antiIndices);</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+  PRBool filterForOther = PR_FALSE;</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+  for (PRUint32 i = 0; i &lt; count; ++i)</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+  {</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+    if (proIndices[i] != nsIJunkMailPlugin::JUNK_TRAIT)</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+    {</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+      filterForOther = PR_TRUE;</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineplus">+      break;</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineplus">+    }</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+  }</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineplus">+  NS_Free(proIndices);</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+  NS_Free(antiIndices);</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+  </span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+  if (!filterForOther &amp;&amp; !filterForJunk)</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+    return NS_OK;</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+  </span>
<a href="#l9.164"></a><span id="l9.164">   // get the list of new messages</span>
<a href="#l9.165"></a><span id="l9.165">   //</span>
<a href="#l9.166"></a><span id="l9.166">   PRUint32 numNewKeys;</span>
<a href="#l9.167"></a><span id="l9.167">   PRUint32 *newKeys;</span>
<a href="#l9.168"></a><span id="l9.168">   rv = mDatabase-&gt;GetNewList(&amp;numNewKeys, &amp;newKeys);</span>
<a href="#l9.169"></a><span id="l9.169">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.170"></a><span id="l9.170"> </span>
<a href="#l9.171"></a><span id="l9.171">   nsTArray&lt;nsMsgKey&gt; newMessageKeys;</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineat">@@ -2035,74 +2067,87 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l9.173"></a><span id="l9.173">   }</span>
<a href="#l9.174"></a><span id="l9.174"> </span>
<a href="#l9.175"></a><span id="l9.175">   // build up list of keys to classify</span>
<a href="#l9.176"></a><span id="l9.176">   nsCString uri;</span>
<a href="#l9.177"></a><span id="l9.177">   nsTArray&lt;nsMsgKey&gt; keysToClassify;</span>
<a href="#l9.178"></a><span id="l9.178">   PRUint32 numNewMessages = newMessageKeys.Length();</span>
<a href="#l9.179"></a><span id="l9.179">   for ( PRUint32 i=0 ; i &lt; numNewMessages ; ++i )</span>
<a href="#l9.180"></a><span id="l9.180">   {</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineminus">-    nsCString junkScore;</span>
<a href="#l9.182"></a><span id="l9.182">     nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l9.183"></a><span id="l9.183">     nsMsgKey msgKey = newMessageKeys[i];</span>
<a href="#l9.184"></a><span id="l9.184">     rv = mDatabase-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(msgHdr));</span>
<a href="#l9.185"></a><span id="l9.185">     if (!NS_SUCCEEDED(rv))</span>
<a href="#l9.186"></a><span id="l9.186">       continue;</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineminus">-    nsCString author;</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineminus">-    nsCString authorEmailAddress;</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-    if (whiteListDirArray.Count() != 0 || !trustedMailDomains.IsEmpty())</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineplus">+    // per-message junk tests.</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineplus">+    PRBool filterMessageForJunk = PR_FALSE;</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineplus">+    while (filterForJunk)  // we'll break from this at the end</span>
<a href="#l9.193"></a><span id="l9.193">     {</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-      msgHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineminus">-      rv = headerParser-&gt;ExtractHeaderAddressMailboxes(author, authorEmailAddress);</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-    }</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineminus">-    if (!trustedMailDomains.IsEmpty())</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineminus">-    {</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineminus">-      nsCAutoString domain;</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">-      PRInt32 atPos = authorEmailAddress.FindChar('@');</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineminus">-      if (atPos &gt;= 0)</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineminus">-        domain = Substring(authorEmailAddress, atPos + 1);</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineminus">-      if (!domain.IsEmpty() &amp;&amp; MsgHostDomainIsTrusted(domain, trustedMailDomains))</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineplus">+      nsCString junkScore;</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineplus">+      nsCString author;</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineplus">+      nsCString authorEmailAddress;</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineplus">+      if (whiteListDirArray.Count() != 0 || !trustedMailDomains.IsEmpty())</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineplus">+      {</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineplus">+        msgHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineplus">+        rv = headerParser-&gt;ExtractHeaderAddressMailboxes(author, authorEmailAddress);</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineplus">+      }</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineplus">+</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineplus">+      if (!trustedMailDomains.IsEmpty())</span>
<a href="#l9.215"></a><span id="l9.215">       {</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineminus">-        // mark this msg as non-junk, because we whitelisted it.</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineminus">-</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineminus">-        nsCAutoString msgJunkScore;</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineminus">-        msgJunkScore.AppendInt(nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineminus">-        mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineminus">-        mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;whitelist&quot;);</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineminus">-        continue; // skip this msg since it's in the white list</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineplus">+        nsCAutoString domain;</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineplus">+        PRInt32 atPos = authorEmailAddress.FindChar('@');</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineplus">+        if (atPos &gt;= 0)</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineplus">+          domain = Substring(authorEmailAddress, atPos + 1);</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineplus">+        if (!domain.IsEmpty() &amp;&amp; MsgHostDomainIsTrusted(domain, trustedMailDomains))</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineplus">+        {</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineplus">+          // mark this msg as non-junk, because we whitelisted it.</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineplus">+</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineplus">+          nsCAutoString msgJunkScore;</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineplus">+          msgJunkScore.AppendInt(nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineplus">+          mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineplus">+          mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;whitelist&quot;);</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineplus">+          break; // skip this msg since it's in the white list</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineplus">+        }</span>
<a href="#l9.237"></a><span id="l9.237">       }</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineminus">-    }</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineminus">-    msgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScore));</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineminus">-    if (!junkScore.IsEmpty()) // ignore already scored messages.</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineminus">-      continue;</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineminus">-    // check whitelist first:</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineminus">-    if (whiteListDirArray.Count() != 0)</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineminus">-    {</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineplus">+      msgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScore));</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+      if (!junkScore.IsEmpty()) // ignore already scored messages.</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineplus">+        break;</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineplus">+      // check whitelist first:</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; whiteListDirArray.Count() != 0)</span>
<a href="#l9.251"></a><span id="l9.251">       {</span>
<a href="#l9.252"></a><span id="l9.252">         nsIAbCard* cardForAddress = nsnull;</span>
<a href="#l9.253"></a><span id="l9.253">         // don't want to abort the rest of the scoring.</span>
<a href="#l9.254"></a><span id="l9.254">         if (!authorEmailAddress.IsEmpty())</span>
<a href="#l9.255"></a><span id="l9.255">         {</span>
<a href="#l9.256"></a><span id="l9.256">           for (PRInt32 index = 0; index &lt; whiteListDirArray.Count() &amp;&amp; !cardForAddress; index++)</span>
<a href="#l9.257"></a><span id="l9.257">             whiteListDirArray[index]-&gt;CardForEmailAddress(authorEmailAddress,</span>
<a href="#l9.258"></a><span id="l9.258">                                                           &amp;cardForAddress);</span>
<a href="#l9.259"></a><span id="l9.259">         }</span>
<a href="#l9.260"></a><span id="l9.260">         if (cardForAddress)</span>
<a href="#l9.261"></a><span id="l9.261">         {</span>
<a href="#l9.262"></a><span id="l9.262">           NS_RELEASE(cardForAddress);</span>
<a href="#l9.263"></a><span id="l9.263">           // mark this msg as non-junk, because we whitelisted it.</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineminus">-          mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, &quot;0&quot;);</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineplus">+          nsCAutoString msgJunkScore;</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineplus">+          msgJunkScore.AppendInt(nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineplus">+          mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l9.268"></a><span id="l9.268">           mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;whitelist&quot;);</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineminus">-          continue; // skip this msg since it's in the white list</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineminus">-        }</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineplus">+          break; // skip this msg since it's in the white list</span>
<a href="#l9.272"></a><span id="l9.272" class="difflineplus">+          }</span>
<a href="#l9.273"></a><span id="l9.273">       }</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineplus">+      filterMessageForJunk = PR_TRUE;</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineplus">+      break;</span>
<a href="#l9.276"></a><span id="l9.276">     }</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineminus">-    keysToClassify.AppendElement(newMessageKeys[i]);</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineplus">+    if (filterMessageForJunk || filterForOther)</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineplus">+    {</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineplus">+      keysToClassify.AppendElement(newMessageKeys[i]);</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineplus">+      if (filterMessageForJunk)</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineplus">+        OrProcessingFlags(msgKey, MSG_PROCESSING_FLAG_CLASSIFY_JUNK);</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineplus">+      if (filterForOther)</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineplus">+        OrProcessingFlags(msgKey, MSG_PROCESSING_FLAG_CLASSIFY_TRAITS);</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineplus">+    }</span>
<a href="#l9.286"></a><span id="l9.286">   }</span>
<a href="#l9.287"></a><span id="l9.287"> </span>
<a href="#l9.288"></a><span id="l9.288">   if (!keysToClassify.IsEmpty())</span>
<a href="#l9.289"></a><span id="l9.289">   {</span>
<a href="#l9.290"></a><span id="l9.290">     PRUint32 numMessagesToClassify = keysToClassify.Length();</span>
<a href="#l9.291"></a><span id="l9.291">     char ** messageURIs = (char **) PR_MALLOC(sizeof(const char *) * numMessagesToClassify);</span>
<a href="#l9.292"></a><span id="l9.292">     if (!messageURIs)</span>
<a href="#l9.293"></a><span id="l9.293">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineat">@@ -5267,8 +5312,82 @@ NS_IMETHODIMP nsMsgDBFolder::RemoveKeywo</span>
<a href="#l9.295"></a><span id="l9.295"> }</span>
<a href="#l9.296"></a><span id="l9.296"> </span>
<a href="#l9.297"></a><span id="l9.297"> NS_IMETHODIMP nsMsgDBFolder::GetCustomIdentity(nsIMsgIdentity **aIdentity)</span>
<a href="#l9.298"></a><span id="l9.298"> {</span>
<a href="#l9.299"></a><span id="l9.299">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l9.300"></a><span id="l9.300">   *aIdentity = nsnull;</span>
<a href="#l9.301"></a><span id="l9.301">   return NS_OK;</span>
<a href="#l9.302"></a><span id="l9.302"> }</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineplus">+</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetProcessingFlags(nsMsgKey aKey, PRUint32 *aFlags)</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineplus">+{</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFlags);</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineplus">+  *aFlags = 0;</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineplus">+  for (PRUint32 i = 0; i &lt; MSG_NUMBER_OF_PROCESSING_FLAGS; i++)</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineplus">+    if (mProcessingFlag[i].keys &amp;&amp; mProcessingFlag[i].keys-&gt;IsMember(aKey))</span>
<a href="#l9.310"></a><span id="l9.310" class="difflineplus">+      *aFlags |= mProcessingFlag[i].bit;</span>
<a href="#l9.311"></a><span id="l9.311" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.312"></a><span id="l9.312" class="difflineplus">+}  </span>
<a href="#l9.313"></a><span id="l9.313" class="difflineplus">+</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::OrProcessingFlags(nsMsgKey aKey, PRUint32 mask)</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineplus">+{</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineplus">+  for (PRUint32 i = 0; i &lt; MSG_NUMBER_OF_PROCESSING_FLAGS; i++)</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineplus">+    if (mProcessingFlag[i].bit &amp; mask &amp;&amp; mProcessingFlag[i].keys)</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineplus">+      mProcessingFlag[i].keys-&gt;Add(aKey);</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineplus">+}  </span>
<a href="#l9.321"></a><span id="l9.321" class="difflineplus">+</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::AndProcessingFlags(nsMsgKey aKey, PRUint32 mask)</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineplus">+{</span>
<a href="#l9.324"></a><span id="l9.324" class="difflineplus">+  for (PRUint32 i = 0; i &lt; MSG_NUMBER_OF_PROCESSING_FLAGS; i++)</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineplus">+    if (!(mProcessingFlag[i].bit &amp; mask) &amp;&amp; mProcessingFlag[i].keys)</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineplus">+      mProcessingFlag[i].keys-&gt;Remove(aKey);</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineplus">+}</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineplus">+</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineplus">+/* static */ nsMsgKeySetU* nsMsgKeySetU::Create()</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineplus">+{</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineplus">+  nsMsgKeySetU* set = new nsMsgKeySetU;</span>
<a href="#l9.333"></a><span id="l9.333" class="difflineplus">+  if (set)</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineplus">+  {</span>
<a href="#l9.335"></a><span id="l9.335" class="difflineplus">+    set-&gt;loKeySet = nsMsgKeySet::Create();</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineplus">+    set-&gt;hiKeySet = nsMsgKeySet::Create();</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineplus">+  }</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineplus">+  if (!(set &amp;&amp; set-&gt;loKeySet &amp;&amp; set-&gt;hiKeySet))</span>
<a href="#l9.339"></a><span id="l9.339" class="difflineplus">+    delete set;</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineplus">+  return set;</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineplus">+}</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineplus">+</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineplus">+nsMsgKeySetU::nsMsgKeySetU()</span>
<a href="#l9.344"></a><span id="l9.344" class="difflineplus">+{ }</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineplus">+</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineplus">+nsMsgKeySetU::~nsMsgKeySetU()</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineplus">+{</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineplus">+  delete loKeySet;</span>
<a href="#l9.349"></a><span id="l9.349" class="difflineplus">+  delete hiKeySet;</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineplus">+}</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineplus">+</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineplus">+const PRUint32 kLowerBits = 0x7fffffff;</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineplus">+</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineplus">+int nsMsgKeySetU::Add(PRUint32 aKey)</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineplus">+{</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineplus">+  PRInt32 intKey = static_cast&lt;PRInt32&gt;(aKey);</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineplus">+  if (intKey &gt;= 0)</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineplus">+    return loKeySet-&gt;Add(intKey);</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineplus">+  return hiKeySet-&gt;Add(intKey &amp; kLowerBits);</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineplus">+}</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineplus">+</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineplus">+int nsMsgKeySetU::Remove(PRUint32 aKey)</span>
<a href="#l9.363"></a><span id="l9.363" class="difflineplus">+{</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineplus">+  PRInt32 intKey = static_cast&lt;PRInt32&gt;(aKey);</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineplus">+  if (intKey &gt;= 0)</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineplus">+    return loKeySet-&gt;Remove(intKey);</span>
<a href="#l9.367"></a><span id="l9.367" class="difflineplus">+  return hiKeySet-&gt;Remove(intKey &amp; kLowerBits);</span>
<a href="#l9.368"></a><span id="l9.368" class="difflineplus">+}</span>
<a href="#l9.369"></a><span id="l9.369" class="difflineplus">+</span>
<a href="#l9.370"></a><span id="l9.370" class="difflineplus">+PRBool nsMsgKeySetU::IsMember(PRUint32 aKey)</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineplus">+{</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineplus">+  PRInt32 intKey = static_cast&lt;PRInt32&gt;(aKey);</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineplus">+  if (intKey &gt;= 0)</span>
<a href="#l9.374"></a><span id="l9.374" class="difflineplus">+    return loKeySet-&gt;IsMember(intKey);</span>
<a href="#l9.375"></a><span id="l9.375" class="difflineplus">+  return hiKeySet-&gt;IsMember(intKey &amp; kLowerBits);</span>
<a href="#l9.376"></a><span id="l9.376" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -53,19 +53,22 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #include &quot;nsIMsgFilterList.h&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;nsITransport.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+#include &quot;nsMsgKeySet.h&quot;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+#include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l10.14"></a><span id="l10.14"> class nsIMsgFolderCacheElement;</span>
<a href="#l10.15"></a><span id="l10.15"> class nsIJunkMailPlugin;</span>
<a href="#l10.16"></a><span id="l10.16"> class nsICollation;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+class nsMsgKeySetU;</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19">  /* </span>
<a href="#l10.20"></a><span id="l10.20">   * nsMsgDBFolder</span>
<a href="#l10.21"></a><span id="l10.21">   * class derived from nsMsgFolder for those folders that use an nsIMsgDatabase</span>
<a href="#l10.22"></a><span id="l10.22">   */ </span>
<a href="#l10.23"></a><span id="l10.23"> </span>
<a href="#l10.24"></a><span id="l10.24"> #undef IMETHOD_VISIBILITY</span>
<a href="#l10.25"></a><span id="l10.25"> #define IMETHOD_VISIBILITY NS_VISIBILITY_DEFAULT</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineat">@@ -271,14 +274,42 @@ protected:</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28"> #ifdef MSG_FASTER_URI_PARSING</span>
<a href="#l10.29"></a><span id="l10.29">   // cached parsing URL object</span>
<a href="#l10.30"></a><span id="l10.30">   static NS_MSG_BASE_STATIC_MEMBER_(nsCOMPtr&lt;nsIURL&gt;) mParsingURL;</span>
<a href="#l10.31"></a><span id="l10.31">   static NS_MSG_BASE_STATIC_MEMBER_(PRBool) mParsingURLInUse;</span>
<a href="#l10.32"></a><span id="l10.32"> #endif</span>
<a href="#l10.33"></a><span id="l10.33"> </span>
<a href="#l10.34"></a><span id="l10.34">   static const NS_MSG_BASE_STATIC_MEMBER_(nsStaticAtom) folder_atoms[];</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+  // store of keys that have a processing flag set</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+  struct</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+  {</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+    PRUint32 bit;</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+    nsMsgKeySetU* keys;</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+  } mProcessingFlag[MSG_NUMBER_OF_PROCESSING_FLAGS];</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+};</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+// This class is a kludge to allow nsMsgKeySet to be used with PRUint32 keys</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+class nsMsgKeySetU</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+{</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+public:</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+    // Creates an empty set.</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+  static nsMsgKeySetU* Create();</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+  ~nsMsgKeySetU();</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+  // IsMember() returns whether the given key is a member of this set.</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+  PRBool IsMember(PRUint32 key);</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+  // Add() adds the given key to the set.  (Returns 1 if a change was</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+  // made, 0 if it was already there, and negative on error.)</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+  int Add(PRUint32 key);</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+  // Remove() removes the given article from the set. </span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+  int Remove(PRUint32 key);</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+protected:</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+  nsMsgKeySetU();</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+  nsMsgKeySet* loKeySet;</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+  nsMsgKeySet* hiKeySet;</span>
<a href="#l10.63"></a><span id="l10.63"> };</span>
<a href="#l10.64"></a><span id="l10.64"> </span>
<a href="#l10.65"></a><span id="l10.65"> #undef  IMETHOD_VISIBILITY</span>
<a href="#l10.66"></a><span id="l10.66"> #define IMETHOD_VISIBILITY NS_VISIBILITY_HIDDEN</span>
<a href="#l10.67"></a><span id="l10.67"> </span>
<a href="#l10.68"></a><span id="l10.68"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1803,19 +1803,18 @@ NS_IMETHODIMP nsBayesianFilter::ResetTra</span>
<a href="#l11.4"></a><span id="l11.4">     [count][length of word]word</span>
<a href="#l11.5"></a><span id="l11.5">     ...</span>
<a href="#l11.6"></a><span id="l11.6">     [number bad tokens]</span>
<a href="#l11.7"></a><span id="l11.7">     [count][length of word]word</span>
<a href="#l11.8"></a><span id="l11.8">     ...</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10">      Format of the trait file for version 1:</span>
<a href="#l11.11"></a><span id="l11.11">     [0xFCA93601]  (the 01 is the version)</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    [number of traits to write]</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-    [id of first trait to write]</span>
<a href="#l11.14"></a><span id="l11.14">     for each trait to write</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+      [id of trait to write] (0 means end of list)</span>
<a href="#l11.16"></a><span id="l11.16">       [number of messages per trait]</span>
<a href="#l11.17"></a><span id="l11.17">       for each token with non-zero count</span>
<a href="#l11.18"></a><span id="l11.18">         [count]</span>
<a href="#l11.19"></a><span id="l11.19">         [length of word]word</span>
<a href="#l11.20"></a><span id="l11.20"> */</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22"> CorpusStore::CorpusStore() :</span>
<a href="#l11.23"></a><span id="l11.23">   TokenHash(sizeof(CorpusToken)),</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineat">@@ -2056,40 +2055,38 @@ void CorpusStore::writeTrainingData(PRIn</span>
<a href="#l11.25"></a><span id="l11.25">   }</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27">   // open the file, and write out training data</span>
<a href="#l11.28"></a><span id="l11.28">   rv = mTraitFile-&gt;OpenANSIFileDesc(&quot;wb&quot;, &amp;stream);</span>
<a href="#l11.29"></a><span id="l11.29">   if (NS_FAILED(rv))</span>
<a href="#l11.30"></a><span id="l11.30">     return;</span>
<a href="#l11.31"></a><span id="l11.31"> </span>
<a href="#l11.32"></a><span id="l11.32">   PRUint32 numberOfTraits = mMessageCounts.Length();</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-  PRUint32 firstTraitToWrite = 3;  // Traits 1 and 2 are in training.dat</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-  PRUint32 numberOfTraitsToWrite = numberOfTraits &gt;= firstTraitToWrite ?</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-                                     numberOfTraits - firstTraitToWrite + 1: 0;</span>
<a href="#l11.36"></a><span id="l11.36">   PRBool error;</span>
<a href="#l11.37"></a><span id="l11.37">   while (1) // break on error or done</span>
<a href="#l11.38"></a><span id="l11.38">   {</span>
<a href="#l11.39"></a><span id="l11.39">     if (error = (fwrite(kTraitCookie, sizeof(kTraitCookie), 1, stream) != 1))</span>
<a href="#l11.40"></a><span id="l11.40">       break;</span>
<a href="#l11.41"></a><span id="l11.41"> </span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-    if (error = (writeUInt32(stream, numberOfTraitsToWrite) != 1))</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-      break;</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-    if (error = (writeUInt32(stream, firstTraitToWrite) != 1))</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-      break;</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-    for (PRUint32 trait = firstTraitToWrite; trait &lt;= numberOfTraits; trait++)</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+    for (PRUint32 index = 0; index &lt; numberOfTraits; index++)</span>
<a href="#l11.50"></a><span id="l11.50">     {</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-      if (error = (writeUInt32(stream, getMessageCount(trait) / shrinkFactor) != 1))</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+      PRUint32 trait = mMessageCountsId[index];</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+      if (trait == 1 || trait == 2)</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+        continue; // junk traits are stored in training.dat</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+      if (error = (writeUInt32(stream, trait) != 1))</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+        break;</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+      if (error = (writeUInt32(stream, mMessageCounts[index] / shrinkFactor) != 1))</span>
<a href="#l11.58"></a><span id="l11.58">         break;</span>
<a href="#l11.59"></a><span id="l11.59">       if (error = !writeTokens(stream, shrink, trait))</span>
<a href="#l11.60"></a><span id="l11.60">         break;</span>
<a href="#l11.61"></a><span id="l11.61">     }</span>
<a href="#l11.62"></a><span id="l11.62">     break;</span>
<a href="#l11.63"></a><span id="l11.63">   }</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+  // we add a 0 at the end to represent end of trait list</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+  error = writeUInt32(stream, 0) != 1;</span>
<a href="#l11.66"></a><span id="l11.66"> </span>
<a href="#l11.67"></a><span id="l11.67">   fclose(stream);</span>
<a href="#l11.68"></a><span id="l11.68">   if (error)</span>
<a href="#l11.69"></a><span id="l11.69">   {</span>
<a href="#l11.70"></a><span id="l11.70">     NS_WARNING(&quot;failed to write trait data.&quot;);</span>
<a href="#l11.71"></a><span id="l11.71">     // delete the trait data file, since it is probably corrupt.</span>
<a href="#l11.72"></a><span id="l11.72">     mTraitFile-&gt;Remove(PR_FALSE);</span>
<a href="#l11.73"></a><span id="l11.73">   }</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineat">@@ -2097,18 +2094,18 @@ void CorpusStore::writeTrainingData(PRIn</span>
<a href="#l11.75"></a><span id="l11.75">   if (shrink)</span>
<a href="#l11.76"></a><span id="l11.76">   {</span>
<a href="#l11.77"></a><span id="l11.77">     // We'll clear the tokens, and read them back in from the file.</span>
<a href="#l11.78"></a><span id="l11.78">     // Yes this is slower than in place, but this is a rare event.</span>
<a href="#l11.79"></a><span id="l11.79"> </span>
<a href="#l11.80"></a><span id="l11.80">     if (countTokens())</span>
<a href="#l11.81"></a><span id="l11.81">     {</span>
<a href="#l11.82"></a><span id="l11.82">       clearTokens();</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-      for (PRUint32 trait = 1; trait &lt;= numberOfTraits; trait++)</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-        setMessageCount(trait, 0);</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+      for (PRUint32 index = 0; index &lt; numberOfTraits; index++)</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+        mMessageCounts[index] = 0;</span>
<a href="#l11.87"></a><span id="l11.87">     }</span>
<a href="#l11.88"></a><span id="l11.88"> </span>
<a href="#l11.89"></a><span id="l11.89">   readTrainingData();</span>
<a href="#l11.90"></a><span id="l11.90">   }</span>
<a href="#l11.91"></a><span id="l11.91"> }</span>
<a href="#l11.92"></a><span id="l11.92"> </span>
<a href="#l11.93"></a><span id="l11.93"> void CorpusStore::readTrainingData()</span>
<a href="#l11.94"></a><span id="l11.94"> {</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineat">@@ -2170,36 +2167,28 @@ void CorpusStore::readTrainingData()</span>
<a href="#l11.96"></a><span id="l11.96">   rv = mTraitFile-&gt;OpenANSIFileDesc(&quot;rb&quot;, &amp;stream);</span>
<a href="#l11.97"></a><span id="l11.97">   if (NS_FAILED(rv))</span>
<a href="#l11.98"></a><span id="l11.98">     return;</span>
<a href="#l11.99"></a><span id="l11.99"> </span>
<a href="#l11.100"></a><span id="l11.100">   rv = mTraitFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l11.101"></a><span id="l11.101">   if (NS_FAILED(rv))</span>
<a href="#l11.102"></a><span id="l11.102">     return;</span>
<a href="#l11.103"></a><span id="l11.103"> </span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-  PRUint32 numberOfTraitsToWrite, firstTraitToWrite;</span>
<a href="#l11.105"></a><span id="l11.105">   PRBool error;</span>
<a href="#l11.106"></a><span id="l11.106"> </span>
<a href="#l11.107"></a><span id="l11.107">   while(1) // break on error or done</span>
<a href="#l11.108"></a><span id="l11.108">   {</span>
<a href="#l11.109"></a><span id="l11.109">     if (error = (fread(cookie, sizeof(cookie), 1, stream) != 1))</span>
<a href="#l11.110"></a><span id="l11.110">       break;</span>
<a href="#l11.111"></a><span id="l11.111"> </span>
<a href="#l11.112"></a><span id="l11.112">     if (error = memcmp(cookie, kTraitCookie, sizeof(cookie)))</span>
<a href="#l11.113"></a><span id="l11.113">       break;</span>
<a href="#l11.114"></a><span id="l11.114"> </span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-    if (error = (readUInt32(stream, &amp;numberOfTraitsToWrite) != 1))</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-      break;</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-    if (error = (readUInt32(stream, &amp;firstTraitToWrite) != 1))</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-      break;</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-    for (PRUint32 trait = firstTraitToWrite;</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-         trait &lt; numberOfTraitsToWrite + firstTraitToWrite;</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-         trait++)</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+    PRUint32 trait;</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+    while ( !(error = (readUInt32(stream, &amp;trait) != 1)) &amp;&amp; trait)</span>
<a href="#l11.126"></a><span id="l11.126">     {</span>
<a href="#l11.127"></a><span id="l11.127">       PRUint32 count;</span>
<a href="#l11.128"></a><span id="l11.128">       if (error = (readUInt32(stream, &amp;count) != 1))</span>
<a href="#l11.129"></a><span id="l11.129">         break;</span>
<a href="#l11.130"></a><span id="l11.130"> </span>
<a href="#l11.131"></a><span id="l11.131">       setMessageCount(trait, count);</span>
<a href="#l11.132"></a><span id="l11.132"> </span>
<a href="#l11.133"></a><span id="l11.133">       if (error = !readTokens(stream, fileSize, trait))</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineat">@@ -2217,18 +2206,18 @@ void CorpusStore::readTrainingData()</span>
<a href="#l11.135"></a><span id="l11.135"> </span>
<a href="#l11.136"></a><span id="l11.136"> nsresult CorpusStore::resetTrainingData()</span>
<a href="#l11.137"></a><span id="l11.137"> {</span>
<a href="#l11.138"></a><span id="l11.138">   // clear out our in memory training tokens...</span>
<a href="#l11.139"></a><span id="l11.139">   if (countTokens())</span>
<a href="#l11.140"></a><span id="l11.140">     clearTokens();</span>
<a href="#l11.141"></a><span id="l11.141"> </span>
<a href="#l11.142"></a><span id="l11.142">   PRUint32 length = mMessageCounts.Length();</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineminus">-  for (PRUint32 trait = 1 ; trait &lt;= length; trait++)</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-    setMessageCount(trait, 0);</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+  for (PRUint32 index = 0 ; index &lt; length; index++)</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+    mMessageCounts[index] = 0;</span>
<a href="#l11.147"></a><span id="l11.147"> </span>
<a href="#l11.148"></a><span id="l11.148">   if (mTrainingFile)</span>
<a href="#l11.149"></a><span id="l11.149">     mTrainingFile-&gt;Remove(PR_FALSE);</span>
<a href="#l11.150"></a><span id="l11.150">   if (mTraitFile)</span>
<a href="#l11.151"></a><span id="l11.151">     mTraitFile-&gt;Remove(PR_FALSE);</span>
<a href="#l11.152"></a><span id="l11.152">   return NS_OK;</span>
<a href="#l11.153"></a><span id="l11.153"> }</span>
<a href="#l11.154"></a><span id="l11.154"> </span>
<a href="#l11.155"></a><span id="l11.155" class="difflineat">@@ -2325,19 +2314,29 @@ void CorpusStore::remove(const char* wor</span>
<a href="#l11.156"></a><span id="l11.156">          word, aTraitId, aCount));</span>
<a href="#l11.157"></a><span id="l11.157">   CorpusToken* token = get(word);</span>
<a href="#l11.158"></a><span id="l11.158">   if (token)</span>
<a href="#l11.159"></a><span id="l11.159">     updateTrait(token, aTraitId, -static_cast&lt;PRInt32&gt;(aCount));</span>
<a href="#l11.160"></a><span id="l11.160"> }</span>
<a href="#l11.161"></a><span id="l11.161"> </span>
<a href="#l11.162"></a><span id="l11.162"> PRUint32 CorpusStore::getMessageCount(PRUint32 aTraitId)</span>
<a href="#l11.163"></a><span id="l11.163"> {</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-  // TraitIds start at 1</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-  return mMessageCounts.SafeElementAt(aTraitId - 1, 0);</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+  const PRUint32 kNoIndex = PRUint32(-1);</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+  PRUint32 index = mMessageCountsId.IndexOf(aTraitId);</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+  if (index == kNoIndex)</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+    return 0;</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+  return mMessageCounts.ElementAt(index);</span>
<a href="#l11.171"></a><span id="l11.171"> }</span>
<a href="#l11.172"></a><span id="l11.172"> </span>
<a href="#l11.173"></a><span id="l11.173"> void CorpusStore::setMessageCount(PRUint32 aTraitId, PRUint32 aCount)</span>
<a href="#l11.174"></a><span id="l11.174"> {</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineminus">-  while (mMessageCounts.Length() &lt; aTraitId)</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineminus">-    mMessageCounts.AppendElement(0);</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineminus">-  // TraitIds start at 1</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-  mMessageCounts.ReplaceElementsAt(aTraitId - 1, 1, aCount);</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineplus">+  const PRUint32 kNoIndex = PRUint32(-1);</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+  PRUint32 index = mMessageCountsId.IndexOf(aTraitId);</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+  if (index == kNoIndex)</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+  {</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+    mMessageCounts.AppendElement(aCount);</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+    mMessageCountsId.AppendElement(aTraitId);</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+  }</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+  else</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+  {</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+    mMessageCounts[index] = aCount;</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+  }</span>
<a href="#l11.190"></a><span id="l11.190"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/src/nsBayesianFilter.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -299,16 +299,18 @@ protected:</span>
<a href="#l12.4"></a><span id="l12.4">     nsCOMPtr&lt;nsILocalFile&gt; mTrainingFile;  // file used to store junk training data</span>
<a href="#l12.5"></a><span id="l12.5">     nsCOMPtr&lt;nsILocalFile&gt; mTraitFile;     // file used to store non-junk</span>
<a href="#l12.6"></a><span id="l12.6">                                            // training data</span>
<a href="#l12.7"></a><span id="l12.7">     nsTArray&lt;TraitPerToken&gt; mTraitStore;   // memory for linked-list of counts</span>
<a href="#l12.8"></a><span id="l12.8">     PRUint32 mNextTraitIndex;              // index in mTraitStore to first empty</span>
<a href="#l12.9"></a><span id="l12.9">                                            // TraitPerToken</span>
<a href="#l12.10"></a><span id="l12.10">     nsTArray&lt;PRUint32&gt; mMessageCounts;     // count of messages per trait</span>
<a href="#l12.11"></a><span id="l12.11">                                            // represented in the store</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+    nsTArray&lt;PRUint32&gt; mMessageCountsId;   // Parallel array to mMessageCounts, with</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+                                           // the corresponding trait ID</span>
<a href="#l12.14"></a><span id="l12.14"> };</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16"> class nsBayesianFilter : public nsIJunkMailPlugin {</span>
<a href="#l12.17"></a><span id="l12.17"> public:</span>
<a href="#l12.18"></a><span id="l12.18">     NS_DECL_ISUPPORTS</span>
<a href="#l12.19"></a><span id="l12.19">     NS_DECL_NSIMSGFILTERPLUGIN</span>
<a href="#l12.20"></a><span id="l12.20">     NS_DECL_NSIJUNKMAILPLUGIN</span>
<a href="#l12.21"></a><span id="l12.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -120,16 +120,17 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;nsIExternalProtocolService.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsCExternalHandlerService.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;prprf.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;nsAutoSyncManager.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> #include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+#include &quot;nsIMsgTraitService.h&quot;</span>
<a href="#l13.13"></a><span id="l13.13"> </span>
<a href="#l13.14"></a><span id="l13.14"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l13.15"></a><span id="l13.15"> static NS_DEFINE_CID(kParseMailMsgStateCID, NS_PARSEMAILMSGSTATE_CID);</span>
<a href="#l13.16"></a><span id="l13.16"> static NS_DEFINE_CID(kCImapHostSessionList, NS_IIMAPHOSTSESSIONLIST_CID);</span>
<a href="#l13.17"></a><span id="l13.17"> </span>
<a href="#l13.18"></a><span id="l13.18"> nsIAtom* nsImapMailFolder::mImapHdrDownloadedAtom=nsnull;</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20"> #define FOUR_K 4096</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineat">@@ -266,16 +267,17 @@ NS_IMPL_RELEASE_INHERITED(nsImapMailFold</span>
<a href="#l13.22"></a><span id="l13.22"> NS_IMPL_QUERY_HEAD(nsImapMailFolder)</span>
<a href="#l13.23"></a><span id="l13.23">     NS_IMPL_QUERY_BODY(nsIMsgImapMailFolder)</span>
<a href="#l13.24"></a><span id="l13.24">     NS_IMPL_QUERY_BODY(nsICopyMessageListener)</span>
<a href="#l13.25"></a><span id="l13.25">     NS_IMPL_QUERY_BODY(nsIImapMailFolderSink)</span>
<a href="#l13.26"></a><span id="l13.26">     NS_IMPL_QUERY_BODY(nsIImapMessageSink)</span>
<a href="#l13.27"></a><span id="l13.27">     NS_IMPL_QUERY_BODY(nsIUrlListener)</span>
<a href="#l13.28"></a><span id="l13.28">     NS_IMPL_QUERY_BODY(nsIMsgFilterHitNotify)</span>
<a href="#l13.29"></a><span id="l13.29">     NS_IMPL_QUERY_BODY(nsIJunkMailClassificationListener)</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+    NS_IMPL_QUERY_BODY(nsIMsgTraitClassificationListener)</span>
<a href="#l13.31"></a><span id="l13.31"> NS_IMPL_QUERY_TAIL_INHERITING(nsMsgDBFolder)</span>
<a href="#l13.32"></a><span id="l13.32"> </span>
<a href="#l13.33"></a><span id="l13.33"> nsresult nsImapMailFolder::AddDirectorySeparator(nsILocalFile *path)</span>
<a href="#l13.34"></a><span id="l13.34"> {</span>
<a href="#l13.35"></a><span id="l13.35">   if (mURI.Equals(kImapRootURI))</span>
<a href="#l13.36"></a><span id="l13.36">   {</span>
<a href="#l13.37"></a><span id="l13.37">     // don't concat the full separator with .sbd</span>
<a href="#l13.38"></a><span id="l13.38">   }</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineat">@@ -7799,25 +7801,53 @@ nsresult nsImapMailFolder::GetMoveCoales</span>
<a href="#l13.40"></a><span id="l13.40">     m_moveCoalescer-&gt;AddRef();</span>
<a href="#l13.41"></a><span id="l13.41">   }</span>
<a href="#l13.42"></a><span id="l13.42">   return NS_OK;</span>
<a href="#l13.43"></a><span id="l13.43"> }</span>
<a href="#l13.44"></a><span id="l13.44"> </span>
<a href="#l13.45"></a><span id="l13.45"> nsresult</span>
<a href="#l13.46"></a><span id="l13.46"> nsImapMailFolder::SpamFilterClassifyMessage(const char *aURI, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin)</span>
<a href="#l13.47"></a><span id="l13.47"> {</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+  nsresult rv;</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+  PRUint32 count;</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+  PRUint32 *proIndices;</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+  PRUint32 *antiIndices;</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+  rv = traitService-&gt;GetEnabledIndices(&amp;count, &amp;proIndices, &amp;antiIndices);</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+</span>
<a href="#l13.58"></a><span id="l13.58">   ++m_numFilterClassifyRequests;</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-  return aJunkMailPlugin-&gt;ClassifyMessage(aURI, aMsgWindow, this);</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+  rv = aJunkMailPlugin-&gt;ClassifyTraitsInMessage(aURI, count, proIndices,</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+                          antiIndices, this, aMsgWindow, this);</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+  NS_Free(proIndices);</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+  NS_Free(antiIndices);</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+  return rv;</span>
<a href="#l13.65"></a><span id="l13.65"> }</span>
<a href="#l13.66"></a><span id="l13.66"> </span>
<a href="#l13.67"></a><span id="l13.67"> nsresult</span>
<a href="#l13.68"></a><span id="l13.68"> nsImapMailFolder::SpamFilterClassifyMessages(const char **aURIArray, PRUint32 aURICount, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin)</span>
<a href="#l13.69"></a><span id="l13.69"> {</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+  nsresult rv;</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+  PRUint32 count;</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+  PRUint32 *proIndices;</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+  PRUint32 *antiIndices;</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+  rv = traitService-&gt;GetEnabledIndices(&amp;count, &amp;proIndices, &amp;antiIndices);</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+</span>
<a href="#l13.80"></a><span id="l13.80">   m_numFilterClassifyRequests += aURICount;</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-  return aJunkMailPlugin-&gt;ClassifyMessages(aURICount, aURIArray, aMsgWindow, this);</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+  rv = aJunkMailPlugin-&gt;ClassifyTraitsInMessages(aURICount, aURIArray, count,</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+                          proIndices, antiIndices, this, aMsgWindow, this);</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+  NS_Free(proIndices);</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+  NS_Free(antiIndices);</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+  return rv;</span>
<a href="#l13.87"></a><span id="l13.87"> }</span>
<a href="#l13.88"></a><span id="l13.88"> </span>
<a href="#l13.89"></a><span id="l13.89"> NS_IMETHODIMP</span>
<a href="#l13.90"></a><span id="l13.90"> nsImapMailFolder::StoreCustomKeywords(nsIMsgWindow *aMsgWindow, const nsACString&amp; aFlagsToAdd,</span>
<a href="#l13.91"></a><span id="l13.91">                                       const nsACString&amp; aFlagsToSubtract, nsMsgKey *aKeysToStore, PRUint32 aNumKeys, nsIURI **_retval)</span>
<a href="#l13.92"></a><span id="l13.92"> {</span>
<a href="#l13.93"></a><span id="l13.93">   nsresult rv;</span>
<a href="#l13.94"></a><span id="l13.94">   if (WeAreOffline())</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineat">@@ -7902,112 +7932,122 @@ nsImapMailFolder::SetJunkScoreForMessage</span>
<a href="#l13.96"></a><span id="l13.96">   return rv;</span>
<a href="#l13.97"></a><span id="l13.97"> }</span>
<a href="#l13.98"></a><span id="l13.98"> </span>
<a href="#l13.99"></a><span id="l13.99"> NS_IMETHODIMP</span>
<a href="#l13.100"></a><span id="l13.100"> nsImapMailFolder::OnMessageClassified(const char * aMsgURI,</span>
<a href="#l13.101"></a><span id="l13.101">   nsMsgJunkStatus aClassification,</span>
<a href="#l13.102"></a><span id="l13.102">   PRUint32 aJunkPercent)</span>
<a href="#l13.103"></a><span id="l13.103"> {</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineminus">-  nsCString spamFolderURI;</span>
<a href="#l13.105"></a><span id="l13.105">   nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l13.106"></a><span id="l13.106">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l13.107"></a><span id="l13.107">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+  nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+  rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+</span>
<a href="#l13.113"></a><span id="l13.113">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l13.114"></a><span id="l13.114">   rv = GetMsgDBHdrFromURI(aMsgURI, getter_AddRefs(msgHdr));</span>
<a href="#l13.115"></a><span id="l13.115">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.116"></a><span id="l13.116"> </span>
<a href="#l13.117"></a><span id="l13.117">   nsMsgKey msgKey;</span>
<a href="#l13.118"></a><span id="l13.118">   rv = msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l13.119"></a><span id="l13.119">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.120"></a><span id="l13.120"> </span>
<a href="#l13.121"></a><span id="l13.121" class="difflineminus">-  nsCAutoString msgJunkScore;</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineminus">-  msgJunkScore.AppendInt(aClassification == nsIJunkMailPlugin::JUNK ?</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineminus">-        nsIJunkMailPlugin::IS_SPAM_SCORE:</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineminus">-        nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineminus">-  mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineminus">-  mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;plugin&quot;);</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineminus">-</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineminus">-  char* strScore = PR_smprintf(&quot;%u&quot;, aJunkPercent);</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineminus">-  mDatabase-&gt;SetStringProperty(msgKey, &quot;junkpercent&quot;, strScore);</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineminus">-  PR_smprintf_free(strScore);</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineminus">-</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineminus">-  GetMoveCoalescer();</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineminus">-  if (m_moveCoalescer)</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineminus">-  {</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineminus">-    nsTArray&lt;nsMsgKey&gt; *keysToClassify = m_moveCoalescer-&gt;GetKeyBucket((aClassification == nsIJunkMailPlugin::JUNK) ? 0 : 1);</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineminus">-    NS_ASSERTION(keysToClassify, &quot;error getting key bucket&quot;);</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineminus">-    if (keysToClassify)</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineminus">-      keysToClassify-&gt;AppendElement(msgKey);</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineminus">-  }</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineminus">-  if (aClassification == nsIJunkMailPlugin::JUNK)</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineminus">-  {</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineminus">-    nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineminus">-    rv = GetServer(getter_AddRefs(server));</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-    rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineminus">-</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineminus">-    PRBool markAsReadOnSpam;</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineminus">-    (void)spamSettings-&gt;GetMarkAsReadOnSpam(&amp;markAsReadOnSpam);</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineminus">-    if (markAsReadOnSpam)</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-    {</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineminus">-      if (!m_junkMessagesToMarkAsRead)</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineminus">-        m_junkMessagesToMarkAsRead = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineminus">-      m_junkMessagesToMarkAsRead-&gt;AppendElement(msgHdr, PR_FALSE);</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineminus">-    }</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineminus">-</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineminus">-    PRBool willMoveMessage = PR_FALSE;</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineminus">-</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineminus">-    // don't do the move when we are opening up</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineminus">-    // the junk mail folder or the trash folder</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineminus">-    // or when manually classifying messages in those folders</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineminus">-    if (!(mFlags &amp; nsMsgFolderFlags::Junk || mFlags &amp; nsMsgFolderFlags::Trash))</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineminus">-    {</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineminus">-      PRBool moveOnSpam;</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineminus">-      (void)spamSettings-&gt;GetMoveOnSpam(&amp;moveOnSpam);</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineminus">-      if (moveOnSpam)</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+  // check if this message needs junk classification</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+  PRUint32 processingFlags;</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+  GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+  if (processingFlags &amp; MSG_PROCESSING_FLAG_CLASSIFY_JUNK)</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+  {</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+    AndProcessingFlags(msgKey, ~MSG_PROCESSING_FLAG_CLASSIFY_JUNK);</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+    nsCString spamFolderURI;</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+    nsCAutoString msgJunkScore;</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+    msgJunkScore.AppendInt(aClassification == nsIJunkMailPlugin::JUNK ?</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+          nsIJunkMailPlugin::IS_SPAM_SCORE:</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+          nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+    mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+    mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;plugin&quot;);</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+    nsCAutoString msgJunkPercent;</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+    msgJunkPercent.AppendInt(aJunkPercent);</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+    mDatabase-&gt;SetStringProperty(msgKey, &quot;junkpercent&quot;, msgJunkPercent.get());</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+    GetMoveCoalescer();</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+    if (m_moveCoalescer)</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+    {</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+      nsTArray&lt;nsMsgKey&gt; *keysToClassify = m_moveCoalescer-&gt;GetKeyBucket((aClassification == nsIJunkMailPlugin::JUNK) ? 0 : 1);</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+      NS_ASSERTION(keysToClassify, &quot;error getting key bucket&quot;);</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+      if (keysToClassify)</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+        keysToClassify-&gt;AppendElement(msgKey);</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+    }</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+    if (aClassification == nsIJunkMailPlugin::JUNK)</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineplus">+    {</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+      PRBool markAsReadOnSpam;</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+      (void)spamSettings-&gt;GetMarkAsReadOnSpam(&amp;markAsReadOnSpam);</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+      if (markAsReadOnSpam)</span>
<a href="#l13.201"></a><span id="l13.201">       {</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineminus">-        rv = spamSettings-&gt;GetSpamFolderURI(getter_Copies(spamFolderURI));</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineminus">-</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineminus">-        if (!spamFolderURI.IsEmpty())</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineplus">+        if (!m_junkMessagesToMarkAsRead)</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineplus">+          m_junkMessagesToMarkAsRead = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+        m_junkMessagesToMarkAsRead-&gt;AppendElement(msgHdr, PR_FALSE);</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+      }</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+      PRBool willMoveMessage = PR_FALSE;</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+      // don't do the move when we are opening up</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+      // the junk mail folder or the trash folder</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+      // or when manually classifying messages in those folders</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+      if (!(mFlags &amp; nsMsgFolderFlags::Junk || mFlags &amp; nsMsgFolderFlags::Trash))</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+      {</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+        PRBool moveOnSpam;</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+        (void)spamSettings-&gt;GetMoveOnSpam(&amp;moveOnSpam);</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+        if (moveOnSpam)</span>
<a href="#l13.221"></a><span id="l13.221">         {</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineminus">-          nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineminus">-          rv = GetExistingFolder(spamFolderURI, getter_AddRefs(folder));</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; folder)</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+          rv = spamSettings-&gt;GetSpamFolderURI(getter_Copies(spamFolderURI));</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+          if (!spamFolderURI.IsEmpty())</span>
<a href="#l13.229"></a><span id="l13.229">           {</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineminus">-            rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineminus">-            NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineminus">-            if (NS_SUCCEEDED(GetMoveCoalescer()))</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineplus">+            nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+            rv = GetExistingFolder(spamFolderURI, getter_AddRefs(folder));</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; folder)</span>
<a href="#l13.236"></a><span id="l13.236">             {</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineminus">-              m_moveCoalescer-&gt;AddMove(folder, msgKey);</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineminus">-              willMoveMessage = PR_TRUE;</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+              rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineplus">+              NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+              if (NS_SUCCEEDED(GetMoveCoalescer()))</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineplus">+              {</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+                m_moveCoalescer-&gt;AddMove(folder, msgKey);</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+                willMoveMessage = PR_TRUE;</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+              }</span>
<a href="#l13.246"></a><span id="l13.246">             }</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineminus">-          }</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineminus">-          else</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineminus">-          {</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineminus">-            // XXX TODO</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineminus">-            // JUNK MAIL RELATED</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineminus">-            // the listener should do</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineminus">-            // rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineminus">-            // NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineminus">-            // if (NS_SUCCEEDED(GetMoveCoalescer())) {</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineminus">-            //   m_moveCoalescer-&gt;AddMove(folder, msgKey);</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineminus">-            //   willMoveMessage = PR_TRUE;</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineminus">-            // }</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineminus">-            rv = GetOrCreateFolder(spamFolderURI, nsnull /* aListener */);</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineminus">-            NS_ASSERTION(NS_SUCCEEDED(rv), &quot;GetOrCreateFolder failed&quot;);</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineplus">+            else</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineplus">+            {</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineplus">+              // XXX TODO</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineplus">+              // JUNK MAIL RELATED</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineplus">+              // the listener should do</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineplus">+              // rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineplus">+              // NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineplus">+              // if (NS_SUCCEEDED(GetMoveCoalescer())) {</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineplus">+              //   m_moveCoalescer-&gt;AddMove(folder, msgKey);</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineplus">+              //   willMoveMessage = PR_TRUE;</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineplus">+              // }</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineplus">+              rv = GetOrCreateFolder(spamFolderURI, nsnull /* aListener */);</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineplus">+              NS_ASSERTION(NS_SUCCEEDED(rv), &quot;GetOrCreateFolder failed&quot;);</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineplus">+            }</span>
<a href="#l13.275"></a><span id="l13.275">           }</span>
<a href="#l13.276"></a><span id="l13.276">         }</span>
<a href="#l13.277"></a><span id="l13.277">       }</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineminus">-    }</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineminus">-    rv = spamSettings-&gt;LogJunkHit(msgHdr, willMoveMessage);</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineminus">-  }</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineplus">+      rv = spamSettings-&gt;LogJunkHit(msgHdr, willMoveMessage);</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineplus">+      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineplus">+    }</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineplus">+  }</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineplus">+</span>
<a href="#l13.287"></a><span id="l13.287">   if (--m_numFilterClassifyRequests == 0)</span>
<a href="#l13.288"></a><span id="l13.288">   {</span>
<a href="#l13.289"></a><span id="l13.289">     if (m_junkMessagesToMarkAsRead)</span>
<a href="#l13.290"></a><span id="l13.290">     {</span>
<a href="#l13.291"></a><span id="l13.291">       PRUint32 count;</span>
<a href="#l13.292"></a><span id="l13.292">       m_junkMessagesToMarkAsRead-&gt;GetLength(&amp;count);</span>
<a href="#l13.293"></a><span id="l13.293">       if (count &gt; 0)</span>
<a href="#l13.294"></a><span id="l13.294">       {</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineat">@@ -8019,26 +8059,64 @@ nsImapMailFolder::OnMessageClassified(co</span>
<a href="#l13.296"></a><span id="l13.296">     PRBool pendingMoves = m_moveCoalescer &amp;&amp; m_moveCoalescer-&gt;HasPendingMoves();</span>
<a href="#l13.297"></a><span id="l13.297">     PlaybackCoalescedOperations();</span>
<a href="#l13.298"></a><span id="l13.298">     // If we are performing biff for this folder, tell the server object</span>
<a href="#l13.299"></a><span id="l13.299">     if ((!pendingMoves || !ShowPreviewText()) &amp;&amp; m_performingBiff)</span>
<a href="#l13.300"></a><span id="l13.300">     {</span>
<a href="#l13.301"></a><span id="l13.301">       // we don't need to adjust the num new messages in this folder because</span>
<a href="#l13.302"></a><span id="l13.302">       // the playback moves code already did that.</span>
<a href="#l13.303"></a><span id="l13.303">       (void) PerformBiffNotifications();</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineminus">-      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineminus">-      if (NS_SUCCEEDED(GetServer(getter_AddRefs(server))) &amp;&amp; server)</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineminus">-        server-&gt;SetPerformingBiff(PR_FALSE);</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineplus">+      server-&gt;SetPerformingBiff(PR_FALSE);</span>
<a href="#l13.308"></a><span id="l13.308">       m_performingBiff = PR_FALSE;</span>
<a href="#l13.309"></a><span id="l13.309">     }</span>
<a href="#l13.310"></a><span id="l13.310">   }</span>
<a href="#l13.311"></a><span id="l13.311">   return NS_OK;</span>
<a href="#l13.312"></a><span id="l13.312"> }</span>
<a href="#l13.313"></a><span id="l13.313"> </span>
<a href="#l13.314"></a><span id="l13.314"> NS_IMETHODIMP</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineplus">+nsImapMailFolder::OnMessageTraitsClassified(</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineplus">+    const char *aMsgURI, PRUint32 aTraitCount,</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineplus">+    PRUint32 *aTraits, PRUint32 *aPercents)</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineplus">+{</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineplus">+  nsresult rv;</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineplus">+  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineplus">+  rv = GetMsgDBHdrFromURI(aMsgURI, getter_AddRefs(msgHdr));</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineplus">+</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineplus">+  nsMsgKey msgKey;</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineplus">+  rv = msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineplus">+</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineplus">+  PRUint32 processingFlags;</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineplus">+  GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineplus">+  if (! processingFlags &amp; MSG_PROCESSING_FLAG_CLASSIFY_TRAITS)</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineplus">+    return NS_OK;</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineplus">+</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineplus">+  AndProcessingFlags(msgKey, ~MSG_PROCESSING_FLAG_CLASSIFY_TRAITS);</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineplus">+</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineplus">+  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService;</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineplus">+  traitService = do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv);</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.338"></a><span id="l13.338" class="difflineplus">+</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineplus">+  for (PRUint32 i = 0; i &lt; aTraitCount; i++)</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineplus">+  {</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineplus">+    if (aTraits[i] == nsIJunkMailPlugin::JUNK_TRAIT)</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineplus">+      continue; // junk is processed by the junk listener</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineplus">+</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineplus">+    nsCAutoString traitId;</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineplus">+    rv = traitService-&gt;GetId(aTraits[i], traitId);</span>
<a href="#l13.346"></a><span id="l13.346" class="difflineplus">+    traitId.Insert(NS_LITERAL_CSTRING(&quot;bayespercent/&quot;), 0);</span>
<a href="#l13.347"></a><span id="l13.347" class="difflineplus">+    nsCAutoString strPercent;</span>
<a href="#l13.348"></a><span id="l13.348" class="difflineplus">+    strPercent.AppendInt(aPercents[i]);</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineplus">+    mDatabase-&gt;SetStringPropertyByHdr(msgHdr, traitId.get(), strPercent.get());</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineplus">+  }</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineplus">+  return NS_OK;</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineplus">+}</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineplus">+</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l13.355"></a><span id="l13.355"> nsImapMailFolder::GetShouldDownloadAllHeaders(PRBool *aResult)</span>
<a href="#l13.356"></a><span id="l13.356"> {</span>
<a href="#l13.357"></a><span id="l13.357">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l13.358"></a><span id="l13.358">   *aResult = PR_FALSE;</span>
<a href="#l13.359"></a><span id="l13.359">   //for just the inbox, we check if the filter list has arbitary headers.</span>
<a href="#l13.360"></a><span id="l13.360">   //for all folders, check if we have a spam plugin that requires all headers</span>
<a href="#l13.361"></a><span id="l13.361">   if (mFlags &amp; nsMsgFolderFlags::Inbox)</span>
<a href="#l13.362"></a><span id="l13.362">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -215,17 +215,18 @@ struct nsPlaybackRequest</span>
<a href="#l14.4"></a><span id="l14.4"> };</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6"> class nsImapMailFolder :  public nsMsgDBFolder,</span>
<a href="#l14.7"></a><span id="l14.7">                           public nsIMsgImapMailFolder,</span>
<a href="#l14.8"></a><span id="l14.8">                           public nsIImapMailFolderSink,</span>
<a href="#l14.9"></a><span id="l14.9">                           public nsIImapMessageSink,</span>
<a href="#l14.10"></a><span id="l14.10">                           public nsICopyMessageListener,</span>
<a href="#l14.11"></a><span id="l14.11">                           public nsIMsgFilterHitNotify,</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-                          public nsIJunkMailClassificationListener</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+                          public nsIJunkMailClassificationListener,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+                          public nsIMsgTraitClassificationListener</span>
<a href="#l14.15"></a><span id="l14.15"> {</span>
<a href="#l14.16"></a><span id="l14.16">  static const PRUint32 PLAYBACK_TIMER_INTERVAL_IN_MS = 500; </span>
<a href="#l14.17"></a><span id="l14.17"> public:</span>
<a href="#l14.18"></a><span id="l14.18">   nsImapMailFolder();</span>
<a href="#l14.19"></a><span id="l14.19">   virtual ~nsImapMailFolder();</span>
<a href="#l14.20"></a><span id="l14.20"> </span>
<a href="#l14.21"></a><span id="l14.21">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23" class="difflineat">@@ -322,16 +323,17 @@ public:</span>
<a href="#l14.24"></a><span id="l14.24">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l14.25"></a><span id="l14.25"> </span>
<a href="#l14.26"></a><span id="l14.26">   // nsIUrlListener methods</span>
<a href="#l14.27"></a><span id="l14.27">   NS_IMETHOD OnStartRunningUrl(nsIURI * aUrl);</span>
<a href="#l14.28"></a><span id="l14.28">   NS_IMETHOD OnStopRunningUrl(nsIURI * aUrl, nsresult aExitCode);</span>
<a href="#l14.29"></a><span id="l14.29"> </span>
<a href="#l14.30"></a><span id="l14.30">   NS_DECL_NSIMSGFILTERHITNOTIFY</span>
<a href="#l14.31"></a><span id="l14.31">   NS_DECL_NSIJUNKMAILCLASSIFICATIONLISTENER</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+  NS_DECL_NSIMSGTRAITCLASSIFICATIONLISTENER</span>
<a href="#l14.33"></a><span id="l14.33"> </span>
<a href="#l14.34"></a><span id="l14.34">   NS_IMETHOD IsCommandEnabled(const nsACString&amp; command, PRBool *result);</span>
<a href="#l14.35"></a><span id="l14.35">   NS_IMETHOD SetFilterList(nsIMsgFilterList *aMsgFilterList);</span>
<a href="#l14.36"></a><span id="l14.36">   NS_IMETHOD GetCustomIdentity(nsIMsgIdentity **aIdentity);</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38">   nsresult AddSubfolderWithPath(nsAString&amp; name, nsILocalFile *dbPath, nsIMsgFolder **child, PRBool brandNew = PR_FALSE);</span>
<a href="#l14.39"></a><span id="l14.39">   nsresult MoveIncorporatedMessage(nsIMsgDBHdr *mailHdr,</span>
<a href="#l14.40"></a><span id="l14.40">                                   nsIMsgDatabase *sourceDB,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -105,16 +105,17 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #include &quot;nsIFileStreams.h&quot;</span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;nsIRssIncomingServer.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l15.8"></a><span id="l15.8"> #include &quot;nsIMsgFolderNotificationService.h&quot;</span>
<a href="#l15.9"></a><span id="l15.9"> #include &quot;nsReadLine.h&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> #include &quot;nsLocalStrings.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+#include &quot;nsIMsgTraitService.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13"> </span>
<a href="#l15.14"></a><span id="l15.14"> static NS_DEFINE_CID(kMailboxServiceCID,          NS_MAILBOXSERVICE_CID);</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l15.17"></a><span id="l15.17"> // nsLocal</span>
<a href="#l15.18"></a><span id="l15.18"> /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20"> nsLocalMailCopyState::nsLocalMailCopyState() :</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineat">@@ -161,21 +162,22 @@ nsMsgLocalMailFolder::nsMsgLocalMailFold</span>
<a href="#l15.22"></a><span id="l15.22">     mNumFilterClassifyRequests(0), mDownloadState(DOWNLOAD_STATE_NONE)</span>
<a href="#l15.23"></a><span id="l15.23"> {</span>
<a href="#l15.24"></a><span id="l15.24"> }</span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26"> nsMsgLocalMailFolder::~nsMsgLocalMailFolder(void)</span>
<a href="#l15.27"></a><span id="l15.27"> {</span>
<a href="#l15.28"></a><span id="l15.28"> }</span>
<a href="#l15.29"></a><span id="l15.29"> </span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED3(nsMsgLocalMailFolder,</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED4(nsMsgLocalMailFolder,</span>
<a href="#l15.32"></a><span id="l15.32">                              nsMsgDBFolder,</span>
<a href="#l15.33"></a><span id="l15.33">                              nsICopyMessageListener,</span>
<a href="#l15.34"></a><span id="l15.34">                              nsIMsgLocalMailFolder,</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-                             nsIJunkMailClassificationListener)</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+                             nsIJunkMailClassificationListener,</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+                             nsIMsgTraitClassificationListener)</span>
<a href="#l15.38"></a><span id="l15.38"> </span>
<a href="#l15.39"></a><span id="l15.39"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l15.40"></a><span id="l15.40"> </span>
<a href="#l15.41"></a><span id="l15.41"> static PRBool</span>
<a href="#l15.42"></a><span id="l15.42"> nsStringEndsWith(nsString&amp; name, const char *ending)</span>
<a href="#l15.43"></a><span id="l15.43"> {</span>
<a href="#l15.44"></a><span id="l15.44">   PRInt32 len = name.Length();</span>
<a href="#l15.45"></a><span id="l15.45">   if (len == 0) return PR_FALSE;</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineat">@@ -3466,121 +3468,154 @@ NS_IMETHODIMP nsMsgLocalMailFolder::Shut</span>
<a href="#l15.47"></a><span id="l15.47"> {</span>
<a href="#l15.48"></a><span id="l15.48">   mInitialized = PR_FALSE;</span>
<a href="#l15.49"></a><span id="l15.49">   return nsMsgDBFolder::Shutdown(shutdownChildren);</span>
<a href="#l15.50"></a><span id="l15.50"> }</span>
<a href="#l15.51"></a><span id="l15.51"> </span>
<a href="#l15.52"></a><span id="l15.52"> nsresult</span>
<a href="#l15.53"></a><span id="l15.53"> nsMsgLocalMailFolder::SpamFilterClassifyMessage(const char *aURI, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin)</span>
<a href="#l15.54"></a><span id="l15.54"> {</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+  nsresult rv;</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+  PRUint32 count;</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+  PRUint32 *proIndices;</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+  PRUint32 *antiIndices;</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+  rv = traitService-&gt;GetEnabledIndices(&amp;count, &amp;proIndices, &amp;antiIndices);</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+</span>
<a href="#l15.65"></a><span id="l15.65">   ++mNumFilterClassifyRequests;</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-  return aJunkMailPlugin-&gt;ClassifyMessage(aURI, aMsgWindow, this);</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+  rv = aJunkMailPlugin-&gt;ClassifyTraitsInMessage(aURI, count, proIndices, antiIndices, this, aMsgWindow, this);</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+  NS_Free(proIndices);</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+  NS_Free(antiIndices);</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+  return rv;</span>
<a href="#l15.71"></a><span id="l15.71"> }</span>
<a href="#l15.72"></a><span id="l15.72"> </span>
<a href="#l15.73"></a><span id="l15.73"> nsresult</span>
<a href="#l15.74"></a><span id="l15.74"> nsMsgLocalMailFolder::SpamFilterClassifyMessages(const char **aURIArray, PRUint32 aURICount, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin)</span>
<a href="#l15.75"></a><span id="l15.75"> {</span>
<a href="#l15.76"></a><span id="l15.76">   NS_ASSERTION(!mNumFilterClassifyRequests, &quot;shouldn't call this when already classifying messages&quot;);</span>
<a href="#l15.77"></a><span id="l15.77">   mNumFilterClassifyRequests = aURICount;</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-  return aJunkMailPlugin-&gt;ClassifyMessages(aURICount, aURIArray, aMsgWindow, this);</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+  nsresult rv;</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService(do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv));</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+  PRUint32 count;</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+  PRUint32 *proIndices;</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+  PRUint32 *antiIndices;</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+  rv = traitService-&gt;GetEnabledIndices(&amp;count, &amp;proIndices, &amp;antiIndices);</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+  rv = aJunkMailPlugin-&gt;ClassifyTraitsInMessages(aURICount, aURIArray, count,</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+      proIndices, antiIndices, this, aMsgWindow, this);</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+  NS_Free(proIndices);</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+  NS_Free(antiIndices);</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+  return rv;</span>
<a href="#l15.94"></a><span id="l15.94"> }</span>
<a href="#l15.95"></a><span id="l15.95"> </span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-</span>
<a href="#l15.97"></a><span id="l15.97"> NS_IMETHODIMP</span>
<a href="#l15.98"></a><span id="l15.98"> nsMsgLocalMailFolder::OnMessageClassified(const char *aMsgURI,</span>
<a href="#l15.99"></a><span id="l15.99">   nsMsgJunkStatus aClassification,</span>
<a href="#l15.100"></a><span id="l15.100">   PRUint32 aJunkPercent)</span>
<a href="#l15.101"></a><span id="l15.101"> </span>
<a href="#l15.102"></a><span id="l15.102"> {</span>
<a href="#l15.103"></a><span id="l15.103">   if (mNumFilterClassifyRequests &gt; 0)</span>
<a href="#l15.104"></a><span id="l15.104">     --mNumFilterClassifyRequests;</span>
<a href="#l15.105"></a><span id="l15.105"> </span>
<a href="#l15.106"></a><span id="l15.106">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l15.107"></a><span id="l15.107">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l15.108"></a><span id="l15.108">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineplus">+</span>
<a href="#l15.110"></a><span id="l15.110">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l15.111"></a><span id="l15.111">   rv = GetMsgDBHdrFromURI(aMsgURI, getter_AddRefs(msgHdr));</span>
<a href="#l15.112"></a><span id="l15.112">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.113"></a><span id="l15.113"> </span>
<a href="#l15.114"></a><span id="l15.114">   nsMsgKey msgKey;</span>
<a href="#l15.115"></a><span id="l15.115">   rv = msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l15.116"></a><span id="l15.116">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.117"></a><span id="l15.117"> </span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-  nsCAutoString msgJunkScore;</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineminus">-  msgJunkScore.AppendInt(aClassification == nsIJunkMailPlugin::JUNK ?</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineminus">-        nsIJunkMailPlugin::IS_SPAM_SCORE:</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-        nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-  mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-  mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;plugin&quot;);</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-  char* strScore = PR_smprintf(&quot;%u&quot;, aJunkPercent);</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-  mDatabase-&gt;SetStringProperty(msgKey, &quot;junkpercent&quot;, strScore);</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-  PR_smprintf_free(strScore);</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-</span>
<a href="#l15.129"></a><span id="l15.129">   nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-  PRBool moveOnSpam = PR_FALSE;</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineminus">-  rv = GetServer(getter_AddRefs(server));</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineminus">-</span>
<a href="#l15.135"></a><span id="l15.135">   rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l15.136"></a><span id="l15.136">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.137"></a><span id="l15.137"> </span>
<a href="#l15.138"></a><span id="l15.138" class="difflineminus">-  if (aClassification == nsIJunkMailPlugin::JUNK)</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+  // check if this message needs junk classification</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+  PRUint32 processingFlags;</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineplus">+  GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineplus">+</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineplus">+  if (processingFlags &amp; MSG_PROCESSING_FLAG_CLASSIFY_JUNK)</span>
<a href="#l15.144"></a><span id="l15.144">   {</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-    PRBool markAsReadOnSpam;</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineminus">-    (void)spamSettings-&gt;GetMarkAsReadOnSpam(&amp;markAsReadOnSpam);</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-    if (markAsReadOnSpam)</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineplus">+    AndProcessingFlags(msgKey, ~MSG_PROCESSING_FLAG_CLASSIFY_JUNK);</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineplus">+</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineplus">+    nsCAutoString msgJunkScore;</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineplus">+    msgJunkScore.AppendInt(aClassification == nsIJunkMailPlugin::JUNK ?</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineplus">+          nsIJunkMailPlugin::IS_SPAM_SCORE:</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineplus">+          nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineplus">+    mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineplus">+    mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;plugin&quot;);</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineplus">+</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineplus">+    nsCAutoString strPercent;</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineplus">+    strPercent.AppendInt(aJunkPercent);</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineplus">+    mDatabase-&gt;SetStringProperty(msgKey, &quot;junkpercent&quot;, strPercent.get());</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineplus">+</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineplus">+    PRBool moveOnSpam = PR_FALSE;</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineplus">+</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineplus">+    if (aClassification == nsIJunkMailPlugin::JUNK)</span>
<a href="#l15.164"></a><span id="l15.164">     {</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineminus">-      rv = mDatabase-&gt;MarkRead(msgKey, true, this);</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">-        if (!NS_SUCCEEDED(rv))</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineminus">-          NS_WARNING(&quot;failed marking spam message as read&quot;);</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineminus">-    }</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineminus">-</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineminus">-    PRBool willMoveMessage = PR_FALSE;</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineminus">-</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineminus">-    // don't do the move when we are opening up</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineminus">-    // the junk mail folder or the trash folder</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineminus">-    // or when manually classifying messages in those folders</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineminus">-    if (!(mFlags &amp; nsMsgFolderFlags::Junk || mFlags &amp; nsMsgFolderFlags::Trash))</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineminus">-    {</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineminus">-      rv = spamSettings-&gt;GetMoveOnSpam(&amp;moveOnSpam);</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineminus">-      if (moveOnSpam)</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineplus">+      PRBool markAsReadOnSpam;</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineplus">+      (void)spamSettings-&gt;GetMarkAsReadOnSpam(&amp;markAsReadOnSpam);</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineplus">+      if (markAsReadOnSpam)</span>
<a href="#l15.183"></a><span id="l15.183">       {</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineminus">-        nsCString uriStr;</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineminus">-        rv = spamSettings-&gt;GetSpamFolderURI(getter_Copies(uriStr));</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineplus">+        rv = mDatabase-&gt;MarkRead(msgKey, true, this);</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineplus">+          if (!NS_SUCCEEDED(rv))</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineplus">+            NS_WARNING(&quot;failed marking spam message as read&quot;);</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineplus">+      }</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineplus">+</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineplus">+      PRBool willMoveMessage = PR_FALSE;</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineplus">+</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineplus">+      // don't do the move when we are opening up</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineplus">+      // the junk mail folder or the trash folder</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineplus">+      // or when manually classifying messages in those folders</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineplus">+      if (!(mFlags &amp; nsMsgFolderFlags::Junk || mFlags &amp; nsMsgFolderFlags::Trash))</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineplus">+      {</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineplus">+        rv = spamSettings-&gt;GetMoveOnSpam(&amp;moveOnSpam);</span>
<a href="#l15.199"></a><span id="l15.199">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineminus">-        mSpamFolderURI = uriStr;</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineminus">-</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineminus">-        rv = GetExistingFolder(mSpamFolderURI, getter_AddRefs(folder));</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; folder)</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineplus">+        if (moveOnSpam)</span>
<a href="#l15.206"></a><span id="l15.206">         {</span>
<a href="#l15.207"></a><span id="l15.207" class="difflineminus">-          rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineplus">+          nsCString uriStr;</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineplus">+          rv = spamSettings-&gt;GetSpamFolderURI(getter_Copies(uriStr));</span>
<a href="#l15.210"></a><span id="l15.210">           NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineminus">-          mSpamKeysToMove.AppendElement(msgKey);</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineminus">-          willMoveMessage = PR_TRUE;</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineminus">-        }</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineminus">-        else</span>
<a href="#l15.215"></a><span id="l15.215" class="difflineminus">-        {</span>
<a href="#l15.216"></a><span id="l15.216" class="difflineminus">-          // XXX TODO</span>
<a href="#l15.217"></a><span id="l15.217" class="difflineminus">-          // JUNK MAIL RELATED</span>
<a href="#l15.218"></a><span id="l15.218" class="difflineminus">-          // the listener should do</span>
<a href="#l15.219"></a><span id="l15.219" class="difflineminus">-          // rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l15.220"></a><span id="l15.220" class="difflineminus">-          // NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.221"></a><span id="l15.221" class="difflineminus">-          // mSpamKeysToMove.AppendElement(msgKey);</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineminus">-          // willMoveMessage = PR_TRUE;</span>
<a href="#l15.223"></a><span id="l15.223" class="difflineminus">-          rv = GetOrCreateFolder(mSpamFolderURI, nsnull /* aListener */);</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineminus">-          NS_ASSERTION(NS_SUCCEEDED(rv), &quot;GetOrCreateFolder failed&quot;);</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineplus">+          mSpamFolderURI = uriStr;</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineplus">+</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l15.228"></a><span id="l15.228" class="difflineplus">+          rv = GetExistingFolder(mSpamFolderURI, getter_AddRefs(folder));</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; folder)</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineplus">+          {</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineplus">+            rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l15.232"></a><span id="l15.232" class="difflineplus">+            NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineplus">+            mSpamKeysToMove.AppendElement(msgKey);</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineplus">+            willMoveMessage = PR_TRUE;</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineplus">+          }</span>
<a href="#l15.236"></a><span id="l15.236" class="difflineplus">+          else</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineplus">+          {</span>
<a href="#l15.238"></a><span id="l15.238" class="difflineplus">+            // XXX TODO</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineplus">+            // JUNK MAIL RELATED</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineplus">+            // the listener should do</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineplus">+            // rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineplus">+            // NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.243"></a><span id="l15.243" class="difflineplus">+            // mSpamKeysToMove.AppendElement(msgKey);</span>
<a href="#l15.244"></a><span id="l15.244" class="difflineplus">+            // willMoveMessage = PR_TRUE;</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineplus">+            rv = GetOrCreateFolder(mSpamFolderURI, nsnull /* aListener */);</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineplus">+            NS_ASSERTION(NS_SUCCEEDED(rv), &quot;GetOrCreateFolder failed&quot;);</span>
<a href="#l15.247"></a><span id="l15.247" class="difflineplus">+          }</span>
<a href="#l15.248"></a><span id="l15.248">         }</span>
<a href="#l15.249"></a><span id="l15.249">       }</span>
<a href="#l15.250"></a><span id="l15.250" class="difflineplus">+      rv = spamSettings-&gt;LogJunkHit(msgHdr, willMoveMessage);</span>
<a href="#l15.251"></a><span id="l15.251" class="difflineplus">+      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.252"></a><span id="l15.252">     }</span>
<a href="#l15.253"></a><span id="l15.253" class="difflineminus">-    rv = spamSettings-&gt;LogJunkHit(msgHdr, willMoveMessage);</span>
<a href="#l15.254"></a><span id="l15.254" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l15.255"></a><span id="l15.255">   }</span>
<a href="#l15.256"></a><span id="l15.256"> </span>
<a href="#l15.257"></a><span id="l15.257">   if (mNumFilterClassifyRequests == 0)</span>
<a href="#l15.258"></a><span id="l15.258">   {</span>
<a href="#l15.259"></a><span id="l15.259">     if (!mSpamKeysToMove.IsEmpty())</span>
<a href="#l15.260"></a><span id="l15.260">     {</span>
<a href="#l15.261"></a><span id="l15.261">       if (!mSpamFolderURI.IsEmpty())</span>
<a href="#l15.262"></a><span id="l15.262">       {</span>
<a href="#l15.263"></a><span id="l15.263" class="difflineat">@@ -3618,16 +3653,55 @@ nsMsgLocalMailFolder::OnMessageClassifie</span>
<a href="#l15.264"></a><span id="l15.264">     // check if this is the inbox first...</span>
<a href="#l15.265"></a><span id="l15.265">     if (mFlags &amp; nsMsgFolderFlags::Inbox)</span>
<a href="#l15.266"></a><span id="l15.266">       PerformBiffNotifications();</span>
<a href="#l15.267"></a><span id="l15.267">   }</span>
<a href="#l15.268"></a><span id="l15.268">   return NS_OK;</span>
<a href="#l15.269"></a><span id="l15.269"> }</span>
<a href="#l15.270"></a><span id="l15.270"> </span>
<a href="#l15.271"></a><span id="l15.271"> NS_IMETHODIMP</span>
<a href="#l15.272"></a><span id="l15.272" class="difflineplus">+nsMsgLocalMailFolder::OnMessageTraitsClassified(</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineplus">+    const char *aMsgURI, PRUint32 aTraitCount,</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineplus">+    PRUint32 *aTraits, PRUint32 *aPercents)</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineplus">+{</span>
<a href="#l15.276"></a><span id="l15.276" class="difflineplus">+  nsresult rv;</span>
<a href="#l15.277"></a><span id="l15.277" class="difflineplus">+  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l15.278"></a><span id="l15.278" class="difflineplus">+  rv = GetMsgDBHdrFromURI(aMsgURI, getter_AddRefs(msgHdr));</span>
<a href="#l15.279"></a><span id="l15.279" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.280"></a><span id="l15.280" class="difflineplus">+</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineplus">+  nsMsgKey msgKey;</span>
<a href="#l15.282"></a><span id="l15.282" class="difflineplus">+  rv = msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l15.283"></a><span id="l15.283" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.284"></a><span id="l15.284" class="difflineplus">+</span>
<a href="#l15.285"></a><span id="l15.285" class="difflineplus">+  PRUint32 processingFlags;</span>
<a href="#l15.286"></a><span id="l15.286" class="difflineplus">+  GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l15.287"></a><span id="l15.287" class="difflineplus">+  if (!(processingFlags &amp; MSG_PROCESSING_FLAG_CLASSIFY_TRAITS))</span>
<a href="#l15.288"></a><span id="l15.288" class="difflineplus">+    return NS_OK;</span>
<a href="#l15.289"></a><span id="l15.289" class="difflineplus">+</span>
<a href="#l15.290"></a><span id="l15.290" class="difflineplus">+  AndProcessingFlags(msgKey, ~MSG_PROCESSING_FLAG_CLASSIFY_TRAITS);</span>
<a href="#l15.291"></a><span id="l15.291" class="difflineplus">+</span>
<a href="#l15.292"></a><span id="l15.292" class="difflineplus">+  nsCOMPtr&lt;nsIMsgTraitService&gt; traitService;</span>
<a href="#l15.293"></a><span id="l15.293" class="difflineplus">+  traitService = do_GetService(&quot;@mozilla.org/msg-trait-service;1&quot;, &amp;rv);</span>
<a href="#l15.294"></a><span id="l15.294" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.295"></a><span id="l15.295" class="difflineplus">+</span>
<a href="#l15.296"></a><span id="l15.296" class="difflineplus">+  for (PRUint32 i = 0; i &lt; aTraitCount; i++)</span>
<a href="#l15.297"></a><span id="l15.297" class="difflineplus">+  {</span>
<a href="#l15.298"></a><span id="l15.298" class="difflineplus">+    if (aTraits[i] == nsIJunkMailPlugin::JUNK_TRAIT)</span>
<a href="#l15.299"></a><span id="l15.299" class="difflineplus">+      continue; // junk is processed by the junk listener</span>
<a href="#l15.300"></a><span id="l15.300" class="difflineplus">+    nsCAutoString traitId;</span>
<a href="#l15.301"></a><span id="l15.301" class="difflineplus">+    rv = traitService-&gt;GetId(aTraits[i], traitId);</span>
<a href="#l15.302"></a><span id="l15.302" class="difflineplus">+    traitId.Insert(NS_LITERAL_CSTRING(&quot;bayespercent/&quot;), 0);</span>
<a href="#l15.303"></a><span id="l15.303" class="difflineplus">+    nsCAutoString strPercent;</span>
<a href="#l15.304"></a><span id="l15.304" class="difflineplus">+    strPercent.AppendInt(aPercents[i]);</span>
<a href="#l15.305"></a><span id="l15.305" class="difflineplus">+    mDatabase-&gt;SetStringPropertyByHdr(msgHdr, traitId.get(), strPercent.get());</span>
<a href="#l15.306"></a><span id="l15.306" class="difflineplus">+  }</span>
<a href="#l15.307"></a><span id="l15.307" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.308"></a><span id="l15.308" class="difflineplus">+}</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineplus">+</span>
<a href="#l15.310"></a><span id="l15.310" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l15.311"></a><span id="l15.311"> nsMsgLocalMailFolder::GetFolderScanState(nsLocalFolderScanState *aState)</span>
<a href="#l15.312"></a><span id="l15.312"> {</span>
<a href="#l15.313"></a><span id="l15.313">   NS_ENSURE_ARG_POINTER(aState);</span>
<a href="#l15.314"></a><span id="l15.314"> </span>
<a href="#l15.315"></a><span id="l15.315">   nsresult rv;</span>
<a href="#l15.316"></a><span id="l15.316">   GetFilePath(getter_AddRefs(aState-&gt;m_localFile));</span>
<a href="#l15.317"></a><span id="l15.317">   aState-&gt;m_fileStream = do_CreateInstance(NS_LOCALFILEINPUTSTREAM_CONTRACTID, &amp;rv);</span>
<a href="#l15.318"></a><span id="l15.318">   NS_ENSURE_SUCCESS(rv, rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -110,24 +110,26 @@ struct nsLocalFolderScanState</span>
<a href="#l16.4"></a><span id="l16.4">   nsCString m_header;</span>
<a href="#l16.5"></a><span id="l16.5">   nsCString m_accountKey;</span>
<a href="#l16.6"></a><span id="l16.6">   const char *m_uidl; // memory is owned by m_header</span>
<a href="#l16.7"></a><span id="l16.7"> };</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> class nsMsgLocalMailFolder : public nsMsgDBFolder,</span>
<a href="#l16.10"></a><span id="l16.10">                              public nsIMsgLocalMailFolder,</span>
<a href="#l16.11"></a><span id="l16.11">                              public nsICopyMessageListener,</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-                             public nsIJunkMailClassificationListener</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+                             public nsIJunkMailClassificationListener,</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+                             public nsIMsgTraitClassificationListener</span>
<a href="#l16.15"></a><span id="l16.15"> {</span>
<a href="#l16.16"></a><span id="l16.16"> public:</span>
<a href="#l16.17"></a><span id="l16.17">   nsMsgLocalMailFolder(void);</span>
<a href="#l16.18"></a><span id="l16.18">   virtual ~nsMsgLocalMailFolder(void);</span>
<a href="#l16.19"></a><span id="l16.19">   NS_DECL_NSICOPYMESSAGELISTENER</span>
<a href="#l16.20"></a><span id="l16.20">   NS_DECL_NSIMSGLOCALMAILFOLDER</span>
<a href="#l16.21"></a><span id="l16.21">   NS_DECL_NSIJUNKMAILCLASSIFICATIONLISTENER</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+  NS_DECL_NSIMSGTRAITCLASSIFICATIONLISTENER</span>
<a href="#l16.23"></a><span id="l16.23">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l16.24"></a><span id="l16.24">   // nsIRDFResource methods:</span>
<a href="#l16.25"></a><span id="l16.25">   NS_IMETHOD Init(const char *aURI);</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27">   // nsIUrlListener methods</span>
<a href="#l16.28"></a><span id="l16.28">   NS_IMETHOD OnStartRunningUrl(nsIURI * aUrl);</span>
<a href="#l16.29"></a><span id="l16.29">   NS_IMETHOD OnStopRunningUrl(nsIURI * aUrl, nsresult aExitCode);</span>
<a href="#l16.30"></a><span id="l16.30"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/mailnews.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/mailnews.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -522,16 +522,28 @@ pref(&quot;mail.adaptivefilters.junk_threshol</span>
<a href="#l17.4"></a><span id="l17.4"> pref(&quot;mail.spam.version&quot;, 0); // used to determine when to migrate global spam settings</span>
<a href="#l17.5"></a><span id="l17.5"> pref(&quot;mail.spam.logging.enabled&quot;, false);</span>
<a href="#l17.6"></a><span id="l17.6"> pref(&quot;mail.spam.manualMark&quot;, false);</span>
<a href="#l17.7"></a><span id="l17.7"> pref(&quot;mail.spam.markAsReadOnSpam&quot;, false);</span>
<a href="#l17.8"></a><span id="l17.8"> pref(&quot;mail.spam.manualMarkMode&quot;, 0); // 0 == &quot;move to junk folder&quot;, 1 == &quot;delete&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> // the number of allowed bayes tokens before the database is shrunk</span>
<a href="#l17.10"></a><span id="l17.10"> pref(&quot;mailnews.bayesian_spam_filter.junk_maxtokens&quot;, 100000);</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+// set default traits for junk and good. Index should match the values in nsIJunkMailPlugin</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+pref(&quot;mailnews.traits.id.1&quot;, &quot;mailnews@mozilla.org#good&quot;);</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+pref(&quot;mailnews.traits.name.1&quot;, &quot;Good&quot;);</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+pref(&quot;mailnews.traits.enabled.1&quot;, false);</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+pref(&quot;mailnews.traits.id.2&quot;, &quot;mailnews@mozilla.org#junk&quot;);</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+pref(&quot;mailnews.traits.name.2&quot;, &quot;Junk&quot;);</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+pref(&quot;mailnews.traits.enabled.2&quot;, true);</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+pref(&quot;mailnews.traits.antiId.2&quot;, &quot;mailnews@mozilla.org#good&quot;);</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+// traits 3 - 1000 are reserved for use by mailnews@mozilla.org</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+// the first externally defined trait will have index 1001</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+pref(&quot;mailnews.traits.lastIndex&quot;, 1000);</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+</span>
<a href="#l17.24"></a><span id="l17.24"> pref(&quot;mail.autoComplete.highlightNonMatches&quot;, true);</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26"> // if true, we'll use the password from an incoming server with</span>
<a href="#l17.27"></a><span id="l17.27"> // matching username and domain</span>
<a href="#l17.28"></a><span id="l17.28"> pref(&quot;mail.smtp.useMatchingDomainServer&quot;, false);</span>
<a href="#l17.29"></a><span id="l17.29"> </span>
<a href="#l17.30"></a><span id="l17.30"> // if true, we'll use the password from an incoming server with</span>
<a href="#l17.31"></a><span id="l17.31"> // matching username and host name</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/suite/installer/unix/packages</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/suite/installer/unix/packages</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -496,16 +496,17 @@ bin/components/nsAbAutoCompleteMyDomain.</span>
<a href="#l18.4"></a><span id="l18.4"> bin/components/nsAbAutoCompleteSearch.js</span>
<a href="#l18.5"></a><span id="l18.5"> bin/components/nsAbLDAPAttributeMap.js</span>
<a href="#l18.6"></a><span id="l18.6"> bin/components/smime-service.js</span>
<a href="#l18.7"></a><span id="l18.7"> bin/components/mdn-service.js</span>
<a href="#l18.8"></a><span id="l18.8"> bin/components/offlineStartup.js</span>
<a href="#l18.9"></a><span id="l18.9"> bin/chrome/newsblog.jar</span>
<a href="#l18.10"></a><span id="l18.10"> bin/chrome/newsblog.manifest</span>
<a href="#l18.11"></a><span id="l18.11"> bin/components/newsblog.js</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+bin/components/nsMsgTraitService.js</span>
<a href="#l18.13"></a><span id="l18.13"> </span>
<a href="#l18.14"></a><span id="l18.14"> ; Gloda</span>
<a href="#l18.15"></a><span id="l18.15"> bin/chrome/gloda.jar</span>
<a href="#l18.16"></a><span id="l18.16"> bin/chrome/gloda.manifest</span>
<a href="#l18.17"></a><span id="l18.17"> bin/components/glautocomp.js</span>
<a href="#l18.18"></a><span id="l18.18"> bin/components/jsmimeemitter.js</span>
<a href="#l18.19"></a><span id="l18.19"> </span>
<a href="#l18.20"></a><span id="l18.20"> bin/isp/movemail.rdf</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/suite/installer/windows/packages</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/suite/installer/windows/packages</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -501,16 +501,17 @@ bin\MapiProxy.dll</span>
<a href="#l19.4"></a><span id="l19.4"> bin\mozMapi32.dll</span>
<a href="#l19.5"></a><span id="l19.5"> bin\components\msgMapi.dll</span>
<a href="#l19.6"></a><span id="l19.6"> bin\components\mapihook.xpt</span>
<a href="#l19.7"></a><span id="l19.7"> bin\components\mdn-service.js</span>
<a href="#l19.8"></a><span id="l19.8"> bin\components\offlineStartup.js</span>
<a href="#l19.9"></a><span id="l19.9"> bin\chrome\newsblog.jar</span>
<a href="#l19.10"></a><span id="l19.10"> bin\chrome\newsblog.manifest</span>
<a href="#l19.11"></a><span id="l19.11"> bin\components\newsblog.js</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+bin\components\nsMsgTraitService.js</span>
<a href="#l19.13"></a><span id="l19.13"> </span>
<a href="#l19.14"></a><span id="l19.14"> ; Gloda</span>
<a href="#l19.15"></a><span id="l19.15"> bin\chrome\gloda.jar</span>
<a href="#l19.16"></a><span id="l19.16"> bin\chrome\gloda.manifest</span>
<a href="#l19.17"></a><span id="l19.17"> bin\components\glautocomp.js</span>
<a href="#l19.18"></a><span id="l19.18"> bin\components\jsmimeemitter.js</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20"> [chatzilla]</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

