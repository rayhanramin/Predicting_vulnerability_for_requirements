<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28801:a94a4098acb456ab8ad149007e9732fe6a9cd64e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ a94a4098acb456ab8ad149007e9732fe6a9cd64e" />
<meta property="og:url" content="/comm-central/rev/a94a4098acb456ab8ad149007e9732fe6a9cd64e" />
<meta property="og:description" content="Bug 1614265 - Implement nsIAbManager in javascript. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / a94a4098acb456ab8ad149007e9732fe6a9cd64e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/a94a4098acb456ab8ad149007e9732fe6a9cd64e">shortlog</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/a94a4098acb456ab8ad149007e9732fe6a9cd64e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e">files</a> |
changeset |
<a href="/comm-central/raw-rev/a94a4098acb456ab8ad149007e9732fe6a9cd64e">raw</a>  | <a href="/comm-central/archive/a94a4098acb456ab8ad149007e9732fe6a9cd64e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1614265">Bug 1614265</a> - Implement nsIAbManager in javascript. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 12 Feb 2020 23:16:27 +0000</td></tr>

<tr>
 <td>changeset 28801</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/a94a4098acb456ab8ad149007e9732fe6a9cd64e">a94a4098acb456ab8ad149007e9732fe6a9cd64e</a></td>
</tr>



<tr>
<td>parent 28800</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/306ac4b77c679440f825d487a9147544591db953">306ac4b77c679440f825d487a9147544591db953</a>
</td>
</tr>

<tr>
<td>child 28802</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3204b6752a70b3d144ceebdf36bf9414e06281dd">3204b6752a70b3d144ceebdf36bf9414e06281dd</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=a94a4098acb456ab8ad149007e9732fe6a9cd64e">17045</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Wed, 19 Feb 2020 23:43:49 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a04956310d2f [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a04956310d2fe4df06c9ba41cb7bb239a09341d4">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a04956310d2fe4df06c9ba41cb7bb239a09341d4&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a04956310d2fe4df06c9ba41cb7bb239a09341d4&newProject=comm-central&newRevision=a94a4098acb456ab8ad149007e9732fe6a9cd64e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a04956310d2fe4df06c9ba41cb7bb239a09341d4&newProject=comm-central&newRevision=a94a4098acb456ab8ad149007e9732fe6a9cd64e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a04956310d2fe4df06c9ba41cb7bb239a09341d4&newProject=comm-central&newRevision=a94a4098acb456ab8ad149007e9732fe6a9cd64e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1614265">1614265</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1614265">Bug 1614265</a> - Implement nsIAbManager in javascript. r=mkmelin

This revision recreates the manager only for the JS directory type. Other types
will be added in later revisions. As such, a number of tests are marked as
failing. Other code has been adjusted due to XPCOM behaving differently when
not crossing from C++ to/from javascript.

Also deleting a directory now notifies listeners after the file (if any) has
been closed and removed, instead of immediately.

Differential Revision: <a href="https://phabricator.services.mozilla.com/D62392">https://phabricator.services.mozilla.com/D62392</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/base/content/editContactPanel.js">mail/base/content/editContactPanel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/base/content/editContactPanel.js">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/base/content/editContactPanel.js">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/base/content/editContactPanel.js">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/base/content/editContactPanel.js">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/base/content/editContactPanel.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/base/modules/QuickFilterManager.jsm">mail/base/modules/QuickFilterManager.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/base/modules/QuickFilterManager.jsm">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/base/modules/QuickFilterManager.jsm">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/base/modules/QuickFilterManager.jsm">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/base/modules/QuickFilterManager.jsm">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/base/modules/QuickFilterManager.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/content/abTrees.js">mail/components/addrbook/content/abTrees.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/content/abTrees.js">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/content/abTrees.js">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/content/abTrees.js">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/content/abTrees.js">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/content/abTrees.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/content/menulist-addrbooks.js">mail/components/addrbook/content/menulist-addrbooks.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/content/menulist-addrbooks.js">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/content/menulist-addrbooks.js">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/content/menulist-addrbooks.js">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/content/menulist-addrbooks.js">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/content/menulist-addrbooks.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/test/browser/browser.ini">mail/components/addrbook/test/browser/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/test/browser/browser.ini">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/test/browser/browser.ini">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/test/browser/browser.ini">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/test/browser/browser.ini">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/addrbook/test/browser/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/parent/ext-addressBook.js">mail/components/extensions/parent/ext-addressBook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/parent/ext-addressBook.js">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/parent/ext-addressBook.js">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/parent/ext-addressBook.js">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/parent/ext-addressBook.js">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/parent/ext-addressBook.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/test/browser/browser_ext_quickFilter.js">mail/components/extensions/test/browser/browser_ext_quickFilter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/test/browser/browser_ext_quickFilter.js">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/test/browser/browser_ext_quickFilter.js">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/test/browser/browser_ext_quickFilter.js">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/test/browser/browser_ext_quickFilter.js">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/test/browser/browser_ext_quickFilter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">mail/components/extensions/test/xpcshell/test_ext_addressBook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/components/extensions/test/xpcshell/test_ext_addressBook.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/addrbook/browser.ini">mail/test/browser/addrbook/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/addrbook/browser.ini">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/addrbook/browser.ini">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/addrbook/browser.ini">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/addrbook/browser.ini">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/addrbook/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/message-window/browser.ini">mail/test/browser/message-window/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/message-window/browser.ini">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/message-window/browser.ini">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/message-window/browser.ini">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/message-window/browser.ini">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/message-window/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/quick-filter-bar/browser_filterLogic.js">mail/test/browser/quick-filter-bar/browser_filterLogic.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/quick-filter-bar/browser_filterLogic.js">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/quick-filter-bar/browser_filterLogic.js">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/quick-filter-bar/browser_filterLogic.js">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/quick-filter-bar/browser_filterLogic.js">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mail/test/browser/quick-filter-bar/browser_filterLogic.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/content/abResultsPane.js">mailnews/addrbook/content/abResultsPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/content/abResultsPane.js">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/content/abResultsPane.js">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/content/abResultsPane.js">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/content/abResultsPane.js">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/content/abResultsPane.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">mailnews/addrbook/jsaddrbook/AddrBookManager.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/components.conf">mailnews/addrbook/jsaddrbook/components.conf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/components.conf">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/components.conf">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/components.conf">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/components.conf">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/components.conf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/moz.build">mailnews/addrbook/jsaddrbook/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/moz.build">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/moz.build">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/moz.build">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/moz.build">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/jsaddrbook/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/prefs/content/pref-editdirectories.js">mailnews/addrbook/prefs/content/pref-editdirectories.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/prefs/content/pref-editdirectories.js">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/prefs/content/pref-editdirectories.js">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/prefs/content/pref-editdirectories.js">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/prefs/content/pref-editdirectories.js">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/prefs/content/pref-editdirectories.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/public/nsIAbManager.idl">mailnews/addrbook/public/nsIAbManager.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/public/nsIAbManager.idl">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/public/nsIAbManager.idl">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/public/nsIAbManager.idl">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/public/nsIAbManager.idl">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/public/nsIAbManager.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/AbAutoCompleteSearch.jsm">mailnews/addrbook/src/AbAutoCompleteSearch.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/AbAutoCompleteSearch.jsm">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/AbAutoCompleteSearch.jsm">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/AbAutoCompleteSearch.jsm">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/AbAutoCompleteSearch.jsm">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/AbAutoCompleteSearch.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/moz.build">mailnews/addrbook/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/moz.build">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/moz.build">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/moz.build">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/moz.build">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/nsAbView.cpp">mailnews/addrbook/src/nsAbView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/nsAbView.cpp">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/nsAbView.cpp">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/nsAbView.cpp">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/nsAbView.cpp">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/nsAbView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/nsDirPrefs.cpp">mailnews/addrbook/src/nsDirPrefs.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/nsDirPrefs.cpp">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/nsDirPrefs.cpp">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/nsDirPrefs.cpp">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/nsDirPrefs.cpp">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/src/nsDirPrefs.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_jsaddrbook.js">mailnews/addrbook/test/unit/test_jsaddrbook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_jsaddrbook.js">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_jsaddrbook.js">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_jsaddrbook.js">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_jsaddrbook.js">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_jsaddrbook.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_migration8.js">mailnews/addrbook/test/unit/test_migration8.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_migration8.js">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_migration8.js">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_migration8.js">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_migration8.js">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_migration8.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_notifications.js">mailnews/addrbook/test/unit/test_notifications.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_notifications.js">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_notifications.js">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_notifications.js">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_notifications.js">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_notifications.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager2.js">mailnews/addrbook/test/unit/test_nsAbManager2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager2.js">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager2.js">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager2.js">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager2.js">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager3.js">mailnews/addrbook/test/unit/test_nsAbManager3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager3.js">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager3.js">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager3.js">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager3.js">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager3.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager4.js">mailnews/addrbook/test/unit/test_nsAbManager4.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager4.js">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager4.js">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager4.js">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager4.js">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/test_nsAbManager4.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/xpcshell.ini">mailnews/addrbook/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/xpcshell_migration.ini">mailnews/addrbook/test/unit/xpcshell_migration.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/xpcshell_migration.ini">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/xpcshell_migration.ini">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/xpcshell_migration.ini">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/xpcshell_migration.ini">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/addrbook/test/unit/xpcshell_migration.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/build/nsMailModule.cpp">mailnews/build/nsMailModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/build/nsMailModule.cpp">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/build/nsMailModule.cpp">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/build/nsMailModule.cpp">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/build/nsMailModule.cpp">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/build/nsMailModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/src/nsImportAddressBooks.cpp">mailnews/import/src/nsImportAddressBooks.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/src/nsImportAddressBooks.cpp">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/src/nsImportAddressBooks.cpp">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/src/nsImportAddressBooks.cpp">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/src/nsImportAddressBooks.cpp">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/src/nsImportAddressBooks.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/test/unit/resources/import_helper.js">mailnews/import/test/unit/resources/import_helper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/test/unit/resources/import_helper.js">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/test/unit/resources/import_helper.js">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/test/unit/resources/import_helper.js">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/test/unit/resources/import_helper.js">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/test/unit/resources/import_helper.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/test/unit/xpcshell.ini">mailnews/import/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/a94a4098acb456ab8ad149007e9732fe6a9cd64e/mailnews/import/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/editContactPanel.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/editContactPanel.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -146,32 +146,33 @@ var editContactInlineUI = {</span>
<a href="#l1.4"></a><span id="l1.4">       &quot;editContactAddressBookList&quot;</span>
<a href="#l1.5"></a><span id="l1.5">     ).value = this._cardDetails.book.URI;</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">     // Is this card contained within mailing lists?</span>
<a href="#l1.8"></a><span id="l1.8">     let inMailList = false;</span>
<a href="#l1.9"></a><span id="l1.9">     if (this._cardDetails.book.supportsMailingLists) {</span>
<a href="#l1.10"></a><span id="l1.10">       // We only have to look in one book here, because cards currently have</span>
<a href="#l1.11"></a><span id="l1.11">       // to be in the address book they belong to.</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-      let mailingLists = this._cardDetails.book.childNodes;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-      while (mailingLists.hasMoreElements() &amp;&amp; !inMailList) {</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-        let list = mailingLists.getNext();</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-        if (!(list instanceof Ci.nsIAbDirectory) || !list.isMailList) {</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+      for (let list of this._cardDetails.book.childNodes) {</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+        if (!list.isMailList) {</span>
<a href="#l1.18"></a><span id="l1.18">           continue;</span>
<a href="#l1.19"></a><span id="l1.19">         }</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21">         for (let card of fixIterator(list.addressLists)) {</span>
<a href="#l1.22"></a><span id="l1.22">           if (</span>
<a href="#l1.23"></a><span id="l1.23">             card instanceof Ci.nsIAbCard &amp;&amp;</span>
<a href="#l1.24"></a><span id="l1.24">             card.primaryEmail == this._cardDetails.card.primaryEmail</span>
<a href="#l1.25"></a><span id="l1.25">           ) {</span>
<a href="#l1.26"></a><span id="l1.26">             inMailList = true;</span>
<a href="#l1.27"></a><span id="l1.27">             break;</span>
<a href="#l1.28"></a><span id="l1.28">           }</span>
<a href="#l1.29"></a><span id="l1.29">         }</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+        if (inMailList) {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+          break;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+        }</span>
<a href="#l1.33"></a><span id="l1.33">       }</span>
<a href="#l1.34"></a><span id="l1.34">     }</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36">     if (!this._writeable || inMailList) {</span>
<a href="#l1.37"></a><span id="l1.37">       document.getElementById(&quot;editContactAddressBookList&quot;).disabled = true;</span>
<a href="#l1.38"></a><span id="l1.38">     }</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40">     if (inMailList) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/modules/QuickFilterManager.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/modules/QuickFilterManager.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -622,17 +622,17 @@ QuickFilterManager.defineFilter({</span>
<a href="#l2.4"></a><span id="l2.4"> QuickFilterManager.defineFilter({</span>
<a href="#l2.5"></a><span id="l2.5">   name: &quot;addrBook&quot;,</span>
<a href="#l2.6"></a><span id="l2.6">   domId: &quot;qfb-inaddrbook&quot;,</span>
<a href="#l2.7"></a><span id="l2.7">   appendTerms(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l2.8"></a><span id="l2.8">     let term, value;</span>
<a href="#l2.9"></a><span id="l2.9">     let firstBook = true;</span>
<a href="#l2.10"></a><span id="l2.10">     term = null;</span>
<a href="#l2.11"></a><span id="l2.11">     for (let addrbook of MailServices.ab.directories) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-      if (addrbook instanceof Ci.nsIAbDirectory &amp;&amp; !addrbook.isRemote) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      if (!addrbook.isRemote) {</span>
<a href="#l2.14"></a><span id="l2.14">         term = aTermCreator.createTerm();</span>
<a href="#l2.15"></a><span id="l2.15">         term.attrib = Ci.nsMsgSearchAttrib.Sender;</span>
<a href="#l2.16"></a><span id="l2.16">         value = term.value;</span>
<a href="#l2.17"></a><span id="l2.17">         value.attrib = term.attrib;</span>
<a href="#l2.18"></a><span id="l2.18">         value.str = addrbook.URI;</span>
<a href="#l2.19"></a><span id="l2.19">         term.value = value;</span>
<a href="#l2.20"></a><span id="l2.20">         term.op = aFilterValue</span>
<a href="#l2.21"></a><span id="l2.21">           ? Ci.nsMsgSearchOp.IsInAB</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/addrbook/content/abTrees.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/addrbook/content/abTrees.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -214,18 +214,29 @@ directoryTreeView.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">    *       Callers should take care to re-select a desired row after calling</span>
<a href="#l3.5"></a><span id="l3.5">    *       this function.</span>
<a href="#l3.6"></a><span id="l3.6">    */</span>
<a href="#l3.7"></a><span id="l3.7">   _rebuild() {</span>
<a href="#l3.8"></a><span id="l3.8">     var oldCount = this._rowMap.length;</span>
<a href="#l3.9"></a><span id="l3.9">     this._rowMap = [];</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11">     // Make an entry for All Address Books.</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    let rootAB = MailServices.ab.getDirectory(kAllDirectoryRoot + &quot;?&quot;);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    rootAB.dirName = gAddressBookBundle.getString(&quot;allAddressBooks&quot;);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+    let rootAB = {</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+      QueryInterface: ChromeUtils.generateQI([Ci.nsIAbDirectory]),</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+      dirName: gAddressBookBundle.getString(&quot;allAddressBooks&quot;),</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+      isMailList: false,</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+      isRemote: false,</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+      isSecure: false,</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+      URI: kAllDirectoryRoot + &quot;?&quot;,</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+      get childNodes() {</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+        return MailServices.ab.directories;</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+      },</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+    };</span>
<a href="#l3.27"></a><span id="l3.27">     this._rowMap.push(new abDirTreeItem(rootAB));</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">     // Sort our addressbooks now</span>
<a href="#l3.30"></a><span id="l3.30">     this._rowMap.sort(abSort);</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32">     if (this._tree) {</span>
<a href="#l3.33"></a><span id="l3.33">       this._tree.rowCountChanged(0, this._rowMap.length - oldCount);</span>
<a href="#l3.34"></a><span id="l3.34">     }</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineat">@@ -240,17 +251,19 @@ directoryTreeView.prototype = {</span>
<a href="#l3.36"></a><span id="l3.36">       }</span>
<a href="#l3.37"></a><span id="l3.37">     }</span>
<a href="#l3.38"></a><span id="l3.38"> </span>
<a href="#l3.39"></a><span id="l3.39">     return -1;</span>
<a href="#l3.40"></a><span id="l3.40">   },</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42">   // nsIAbListener interfaces</span>
<a href="#l3.43"></a><span id="l3.43">   onItemAdded(aParent, aItem) {</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-    if (!(aItem instanceof Ci.nsIAbDirectory)) {</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+    try {</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+      aItem.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+    } catch (ex) {</span>
<a href="#l3.48"></a><span id="l3.48">       return;</span>
<a href="#l3.49"></a><span id="l3.49">     }</span>
<a href="#l3.50"></a><span id="l3.50">     // XXX we can optimize this later</span>
<a href="#l3.51"></a><span id="l3.51">     this._rebuild();</span>
<a href="#l3.52"></a><span id="l3.52"> </span>
<a href="#l3.53"></a><span id="l3.53">     if (!this._tree) {</span>
<a href="#l3.54"></a><span id="l3.54">       return;</span>
<a href="#l3.55"></a><span id="l3.55">     }</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineat">@@ -260,28 +273,31 @@ directoryTreeView.prototype = {</span>
<a href="#l3.57"></a><span id="l3.57">       if (row.id == aItem.URI) {</span>
<a href="#l3.58"></a><span id="l3.58">         this.selection.select(i);</span>
<a href="#l3.59"></a><span id="l3.59">         break;</span>
<a href="#l3.60"></a><span id="l3.60">       }</span>
<a href="#l3.61"></a><span id="l3.61">     }</span>
<a href="#l3.62"></a><span id="l3.62">   },</span>
<a href="#l3.63"></a><span id="l3.63"> </span>
<a href="#l3.64"></a><span id="l3.64">   onItemRemoved(aParent, aItem) {</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-    if (!(aItem instanceof Ci.nsIAbDirectory)) {</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+    try {</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+      aItem.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+    } catch (ex) {</span>
<a href="#l3.69"></a><span id="l3.69">       return;</span>
<a href="#l3.70"></a><span id="l3.70">     }</span>
<a href="#l3.71"></a><span id="l3.71">     // XXX we can optimize this later</span>
<a href="#l3.72"></a><span id="l3.72">     this._rebuild();</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74">     if (!this._tree) {</span>
<a href="#l3.75"></a><span id="l3.75">       return;</span>
<a href="#l3.76"></a><span id="l3.76">     }</span>
<a href="#l3.77"></a><span id="l3.77"> </span>
<a href="#l3.78"></a><span id="l3.78">     // If we're deleting a top-level address-book, just select the first book</span>
<a href="#l3.79"></a><span id="l3.79">     if (</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+      !aParent ||</span>
<a href="#l3.81"></a><span id="l3.81">       aParent.URI == kAllDirectoryRoot ||</span>
<a href="#l3.82"></a><span id="l3.82">       aParent.URI == kAllDirectoryRoot + &quot;?&quot;</span>
<a href="#l3.83"></a><span id="l3.83">     ) {</span>
<a href="#l3.84"></a><span id="l3.84">       this.selection.select(0);</span>
<a href="#l3.85"></a><span id="l3.85">       return;</span>
<a href="#l3.86"></a><span id="l3.86">     }</span>
<a href="#l3.87"></a><span id="l3.87"> </span>
<a href="#l3.88"></a><span id="l3.88">     // Now select this parent item</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineat">@@ -289,17 +305,19 @@ directoryTreeView.prototype = {</span>
<a href="#l3.90"></a><span id="l3.90">       if (row.id == aParent.URI) {</span>
<a href="#l3.91"></a><span id="l3.91">         this.selection.select(i);</span>
<a href="#l3.92"></a><span id="l3.92">         break;</span>
<a href="#l3.93"></a><span id="l3.93">       }</span>
<a href="#l3.94"></a><span id="l3.94">     }</span>
<a href="#l3.95"></a><span id="l3.95">   },</span>
<a href="#l3.96"></a><span id="l3.96"> </span>
<a href="#l3.97"></a><span id="l3.97">   onItemPropertyChanged(aItem, aProp, aOld, aNew) {</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-    if (!(aItem instanceof Ci.nsIAbDirectory)) {</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+    try {</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+      aItem.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+    } catch (ex) {</span>
<a href="#l3.102"></a><span id="l3.102">       return;</span>
<a href="#l3.103"></a><span id="l3.103">     }</span>
<a href="#l3.104"></a><span id="l3.104"> </span>
<a href="#l3.105"></a><span id="l3.105">     for (let i in this._rowMap) {</span>
<a href="#l3.106"></a><span id="l3.106">       if (this._rowMap[i]._directory == aItem) {</span>
<a href="#l3.107"></a><span id="l3.107">         this._tree.invalidateRow(i);</span>
<a href="#l3.108"></a><span id="l3.108">         break;</span>
<a href="#l3.109"></a><span id="l3.109">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/addrbook/content/menulist-addrbooks.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/addrbook/content/menulist-addrbooks.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -32,62 +32,73 @@ if (!customElements.get(&quot;menulist&quot;)) {</span>
<a href="#l4.4"></a><span id="l4.4">       this._directories = [];</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6">       this._rebuild();</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8">       // @implements {nsIAbListener}</span>
<a href="#l4.9"></a><span id="l4.9">       this.addressBookListener = {</span>
<a href="#l4.10"></a><span id="l4.10">         onItemAdded: (aParentDir, aItem) =&gt; {</span>
<a href="#l4.11"></a><span id="l4.11">           // Are we interested in this new directory?</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-          if (aItem instanceof Ci.nsIAbDirectory &amp;&amp; this._matches(aItem)) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+          try {</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+            aItem.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+          } catch (ex) {</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+            return;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+          }</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+          if (this._matches(aItem)) {</span>
<a href="#l4.19"></a><span id="l4.19">             this._rebuild();</span>
<a href="#l4.20"></a><span id="l4.20">           }</span>
<a href="#l4.21"></a><span id="l4.21">         },</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23">         onItemRemoved: (aParentDir, aItem) =&gt; {</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-          if (aItem instanceof Ci.nsIAbDirectory) {</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-            // Find the item in the list to remove.</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-            // We can't use indexOf here because we need loose equality.</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-            let len = this._directories.length;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-            for (var index = len - 1; index &gt;= 0; index--) {</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-              if (this._directories[index] == aItem) {</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-                break;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-              }</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+          try {</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+            aItem.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+          } catch (ex) {</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+            return;</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+          }</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+          // Find the item in the list to remove.</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+          // We can't use indexOf here because we need loose equality.</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+          let len = this._directories.length;</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+          for (var index = len - 1; index &gt;= 0; index--) {</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+            if (this._directories[index] == aItem) {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+              break;</span>
<a href="#l4.43"></a><span id="l4.43">             }</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-            if (index != -1) {</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-              this._directories.splice(index, 1);</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-              // Are we removing the selected directory?</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-              if (</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-                this.selectedItem ==</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-                this.menupopup.removeChild(this.menupopup.children[index])</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-              ) {</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-                // If so, try to select the first directory, if available.</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-                if (this.menupopup.hasChildNodes()) {</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-                  this.menupopup.firstElementChild.doCommand();</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-                } else {</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-                  this.selectedItem = null;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-                }</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+          }</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+          if (index != -1) {</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+            this._directories.splice(index, 1);</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+            // Are we removing the selected directory?</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+            if (</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+              this.selectedItem ==</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+              this.menupopup.removeChild(this.menupopup.children[index])</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+            ) {</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+              // If so, try to select the first directory, if available.</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+              if (this.menupopup.hasChildNodes()) {</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+                this.menupopup.firstElementChild.doCommand();</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+              } else {</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+                this.selectedItem = null;</span>
<a href="#l4.70"></a><span id="l4.70">               }</span>
<a href="#l4.71"></a><span id="l4.71">             }</span>
<a href="#l4.72"></a><span id="l4.72">           }</span>
<a href="#l4.73"></a><span id="l4.73">         },</span>
<a href="#l4.74"></a><span id="l4.74"> </span>
<a href="#l4.75"></a><span id="l4.75">         onItemPropertyChanged: (aItem, aProperty, aOldValue, aNewValue) =&gt; {</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-          if (aItem instanceof Ci.nsIAbDirectory) {</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-            // Find the item in the list to rename.</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-            // We can't use indexOf here because we need loose equality.</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-            let len = this._directories.length;</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-            for (var oldIndex = len - 1; oldIndex &gt;= 0; oldIndex--) {</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-              if (this._directories[oldIndex] == aItem) {</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-                break;</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-              }</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+          try {</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+            aItem.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+          } catch (ex) {</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+            return;</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+          }</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+          // Find the item in the list to rename.</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+          // We can't use indexOf here because we need loose equality.</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+          let len = this._directories.length;</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+          for (var oldIndex = len - 1; oldIndex &gt;= 0; oldIndex--) {</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+            if (this._directories[oldIndex] == aItem) {</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+              break;</span>
<a href="#l4.95"></a><span id="l4.95">             }</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-            if (oldIndex != -1) {</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-              this._rebuild();</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-            }</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+          }</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+          if (oldIndex != -1) {</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+            this._rebuild();</span>
<a href="#l4.102"></a><span id="l4.102">           }</span>
<a href="#l4.103"></a><span id="l4.103">         },</span>
<a href="#l4.104"></a><span id="l4.104">       };</span>
<a href="#l4.105"></a><span id="l4.105"> </span>
<a href="#l4.106"></a><span id="l4.106">       MailServices.ab.addAddressBookListener(</span>
<a href="#l4.107"></a><span id="l4.107">         this.addressBookListener,</span>
<a href="#l4.108"></a><span id="l4.108">         Ci.nsIAbListener.all</span>
<a href="#l4.109"></a><span id="l4.109">       );</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineat">@@ -118,17 +129,17 @@ if (!customElements.get(&quot;menulist&quot;)) {</span>
<a href="#l4.111"></a><span id="l4.111">       this._teardown();</span>
<a href="#l4.112"></a><span id="l4.112">     }</span>
<a href="#l4.113"></a><span id="l4.113"> </span>
<a href="#l4.114"></a><span id="l4.114">     _rebuild() {</span>
<a href="#l4.115"></a><span id="l4.115">       // Init the address book cache.</span>
<a href="#l4.116"></a><span id="l4.116">       this._directories.length = 0;</span>
<a href="#l4.117"></a><span id="l4.117"> </span>
<a href="#l4.118"></a><span id="l4.118">       for (let ab of MailServices.ab.directories) {</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-        if (ab instanceof Ci.nsIAbDirectory &amp;&amp; this._matches(ab)) {</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+        if (this._matches(ab)) {</span>
<a href="#l4.121"></a><span id="l4.121">           this._directories.push(ab);</span>
<a href="#l4.122"></a><span id="l4.122"> </span>
<a href="#l4.123"></a><span id="l4.123">           if (this.getAttribute(&quot;mailinglists&quot;) == &quot;true&quot;) {</span>
<a href="#l4.124"></a><span id="l4.124">             // Also append contained mailinglists.</span>
<a href="#l4.125"></a><span id="l4.125">             for (let list of ab.childNodes) {</span>
<a href="#l4.126"></a><span id="l4.126">               if (this._matches(list)) {</span>
<a href="#l4.127"></a><span id="l4.127">                 this._directories.push(list);</span>
<a href="#l4.128"></a><span id="l4.128">               }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/addrbook/test/browser/browser.ini</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/addrbook/test/browser/browser.ini</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -7,10 +7,11 @@ prefs =</span>
<a href="#l5.4"></a><span id="l5.4">   mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l5.5"></a><span id="l5.5">   mail.spotlight.firstRunDone=true</span>
<a href="#l5.6"></a><span id="l5.6">   mail.winsearch.firstRunDone=true</span>
<a href="#l5.7"></a><span id="l5.7">   mailnews.start_page.override_url=about:blank</span>
<a href="#l5.8"></a><span id="l5.8">   mailnews.start_page.url=about:blank</span>
<a href="#l5.9"></a><span id="l5.9"> subsuite = thunderbird</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> [browser_ldap_search.js]</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+fail-if = true</span>
<a href="#l5.13"></a><span id="l5.13"> support-files = ../../../../../mailnews/addrbook/test/unit/data/ldap_contacts.json</span>
<a href="#l5.14"></a><span id="l5.14"> [browser_mailing_lists.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-addressBook.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-addressBook.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -221,17 +221,19 @@ var addressBookCache = new (class extend</span>
<a href="#l6.4"></a><span id="l6.4">         break;</span>
<a href="#l6.5"></a><span id="l6.5">     }</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">     return copy;</span>
<a href="#l6.8"></a><span id="l6.8">   }</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10">   // nsIAbListener</span>
<a href="#l6.11"></a><span id="l6.11">   onItemAdded(parent, item) {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    parent.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    if (parent) {</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+      parent.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+    } // Otherwise item is a new address book and we don't use parent.</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17">     if (item instanceof Ci.nsIAbDirectory) {</span>
<a href="#l6.18"></a><span id="l6.18">       item.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l6.19"></a><span id="l6.19">       if (item.isMailList) {</span>
<a href="#l6.20"></a><span id="l6.20">         let newNode = this._makeDirectoryNode(item, parent);</span>
<a href="#l6.21"></a><span id="l6.21">         if (</span>
<a href="#l6.22"></a><span id="l6.22">           this._addressBooks &amp;&amp;</span>
<a href="#l6.23"></a><span id="l6.23">           this._addressBooks.has(parent.UID) &amp;&amp;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineat">@@ -261,17 +263,19 @@ var addressBookCache = new (class extend</span>
<a href="#l6.25"></a><span id="l6.25">           this._mailingLists.get(parent.UID).contacts.set(newNode.id, newNode);</span>
<a href="#l6.26"></a><span id="l6.26">         }</span>
<a href="#l6.27"></a><span id="l6.27">         this.emit(&quot;mailing-list-member-added&quot;, newNode);</span>
<a href="#l6.28"></a><span id="l6.28">       }</span>
<a href="#l6.29"></a><span id="l6.29">     }</span>
<a href="#l6.30"></a><span id="l6.30">   }</span>
<a href="#l6.31"></a><span id="l6.31">   // nsIAbListener</span>
<a href="#l6.32"></a><span id="l6.32">   onItemRemoved(parent, item) {</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-    parent = parent.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+    if (parent) {</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+      parent = parent.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+    } // Otherwise item is a removed address book and we don't use parent.</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">     if (item instanceof Ci.nsIAbDirectory) {</span>
<a href="#l6.39"></a><span id="l6.39">       item.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l6.40"></a><span id="l6.40">       if (item.isMailList) {</span>
<a href="#l6.41"></a><span id="l6.41">         this._mailingLists.delete(item.UID);</span>
<a href="#l6.42"></a><span id="l6.42">         if (</span>
<a href="#l6.43"></a><span id="l6.43">           this._addressBooks &amp;&amp;</span>
<a href="#l6.44"></a><span id="l6.44">           this._addressBooks.has(parent.UID) &amp;&amp;</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineat">@@ -467,19 +471,27 @@ this.addressBook = class extends Extensi</span>
<a href="#l6.46"></a><span id="l6.46">           let dirName = MailServices.ab.newAddressBook(name, &quot;&quot;, kJSDirectory);</span>
<a href="#l6.47"></a><span id="l6.47">           let directory = MailServices.ab.getDirectoryFromId(dirName);</span>
<a href="#l6.48"></a><span id="l6.48">           return directory.UID;</span>
<a href="#l6.49"></a><span id="l6.49">         },</span>
<a href="#l6.50"></a><span id="l6.50">         update(id, { name }) {</span>
<a href="#l6.51"></a><span id="l6.51">           let node = addressBookCache.findAddressBookById(id);</span>
<a href="#l6.52"></a><span id="l6.52">           node.item.dirName = name;</span>
<a href="#l6.53"></a><span id="l6.53">         },</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-        delete(id) {</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+        async delete(id) {</span>
<a href="#l6.56"></a><span id="l6.56">           let node = addressBookCache.findAddressBookById(id);</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+          let deletePromise = new Promise(resolve =&gt; {</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+            let listener = () =&gt; {</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+              addressBookCache.off(&quot;address-book-deleted&quot;, listener);</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+              resolve();</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+            };</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+            addressBookCache.on(&quot;address-book-deleted&quot;, listener);</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+          });</span>
<a href="#l6.64"></a><span id="l6.64">           MailServices.ab.deleteAddressBook(node.item.URI);</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+          await deletePromise;</span>
<a href="#l6.66"></a><span id="l6.66">         },</span>
<a href="#l6.67"></a><span id="l6.67"> </span>
<a href="#l6.68"></a><span id="l6.68">         onCreated: new EventManager({</span>
<a href="#l6.69"></a><span id="l6.69">           context,</span>
<a href="#l6.70"></a><span id="l6.70">           name: &quot;addressBooks.onCreated&quot;,</span>
<a href="#l6.71"></a><span id="l6.71">           register: fire =&gt; {</span>
<a href="#l6.72"></a><span id="l6.72">             let listener = (event, node) =&gt; {</span>
<a href="#l6.73"></a><span id="l6.73">               fire.sync(addressBookCache.convert(node));</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineat">@@ -690,17 +702,18 @@ this.addressBook = class extends Extensi</span>
<a href="#l6.75"></a><span id="l6.75">           let node = addressBookCache.findMailingListById(id);</span>
<a href="#l6.76"></a><span id="l6.76">           node.item.dirName = name;</span>
<a href="#l6.77"></a><span id="l6.77">           node.item.listNickName = nickName === null ? &quot;&quot; : nickName;</span>
<a href="#l6.78"></a><span id="l6.78">           node.item.description = description === null ? &quot;&quot; : description;</span>
<a href="#l6.79"></a><span id="l6.79">           node.item.editMailListToDatabase(null);</span>
<a href="#l6.80"></a><span id="l6.80">         },</span>
<a href="#l6.81"></a><span id="l6.81">         delete(id) {</span>
<a href="#l6.82"></a><span id="l6.82">           let node = addressBookCache.findMailingListById(id);</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-          MailServices.ab.deleteAddressBook(node.item.URI);</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+          let parentNode = addressBookCache.findAddressBookById(node.parentId);</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+          parentNode.item.deleteDirectory(node.item);</span>
<a href="#l6.86"></a><span id="l6.86">         },</span>
<a href="#l6.87"></a><span id="l6.87"> </span>
<a href="#l6.88"></a><span id="l6.88">         listMembers(id) {</span>
<a href="#l6.89"></a><span id="l6.89">           let node = addressBookCache.findMailingListById(id);</span>
<a href="#l6.90"></a><span id="l6.90">           return addressBookCache.convert(</span>
<a href="#l6.91"></a><span id="l6.91">             addressBookCache.getListContacts(node),</span>
<a href="#l6.92"></a><span id="l6.92">             false</span>
<a href="#l6.93"></a><span id="l6.93">           );</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/extensions/test/browser/browser_ext_quickFilter.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser_ext_quickFilter.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -125,16 +125,19 @@ add_task(async () =&gt; {</span>
<a href="#l7.4"></a><span id="l7.4">   let author = messages[7].author.replace(/[&quot;&lt;&gt;]/g, &quot;&quot;).split(&quot; &quot;);</span>
<a href="#l7.5"></a><span id="l7.5">   let card = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance(</span>
<a href="#l7.6"></a><span id="l7.6">     Ci.nsIAbCard</span>
<a href="#l7.7"></a><span id="l7.7">   );</span>
<a href="#l7.8"></a><span id="l7.8">   card.setProperty(&quot;FirstName&quot;, author[0]);</span>
<a href="#l7.9"></a><span id="l7.9">   card.setProperty(&quot;LastName&quot;, author[1]);</span>
<a href="#l7.10"></a><span id="l7.10">   card.setProperty(&quot;DisplayName&quot;, `${author[0]} ${author[1]}`);</span>
<a href="#l7.11"></a><span id="l7.11">   card.setProperty(&quot;PrimaryEmail&quot;, author[2]);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  MailServices.ab.directories.getNext().addCard(card);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  MailServices.ab.directories</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+    .getNext()</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+    .QueryInterface(Ci.nsIAbDirectory)</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+    .addCard(card);</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18">   await extension.startup();</span>
<a href="#l7.19"></a><span id="l7.19">   await extension.awaitFinish(&quot;quickFilter&quot;);</span>
<a href="#l7.20"></a><span id="l7.20">   await extension.unload();</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22">   window.gFolderTreeView.selectFolder(rootFolder);</span>
<a href="#l7.23"></a><span id="l7.23"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/extensions/test/xpcshell/test_ext_addressBook.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/extensions/test/xpcshell/test_ext_addressBook.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -12,27 +12,33 @@ var { ExtensionTestUtils } = ChromeUtils</span>
<a href="#l8.4"></a><span id="l8.4"> );</span>
<a href="#l8.5"></a><span id="l8.5"> ExtensionTestUtils.init(this);</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> add_task(async function test_addressBooks() {</span>
<a href="#l8.8"></a><span id="l8.8">   async function background() {</span>
<a href="#l8.9"></a><span id="l8.9">     let firstBookId, secondBookId, newContactId;</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11">     let events = [];</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+    let eventPromiseResolve;</span>
<a href="#l8.13"></a><span id="l8.13">     for (let eventNamespace of [&quot;addressBooks&quot;, &quot;contacts&quot;, &quot;mailingLists&quot;]) {</span>
<a href="#l8.14"></a><span id="l8.14">       for (let eventName of [</span>
<a href="#l8.15"></a><span id="l8.15">         &quot;onCreated&quot;,</span>
<a href="#l8.16"></a><span id="l8.16">         &quot;onUpdated&quot;,</span>
<a href="#l8.17"></a><span id="l8.17">         &quot;onDeleted&quot;,</span>
<a href="#l8.18"></a><span id="l8.18">         &quot;onMemberAdded&quot;,</span>
<a href="#l8.19"></a><span id="l8.19">         &quot;onMemberRemoved&quot;,</span>
<a href="#l8.20"></a><span id="l8.20">       ]) {</span>
<a href="#l8.21"></a><span id="l8.21">         if (eventName in browser[eventNamespace]) {</span>
<a href="#l8.22"></a><span id="l8.22">           browser[eventNamespace][eventName].addListener((...args) =&gt; {</span>
<a href="#l8.23"></a><span id="l8.23">             events.push({ namespace: eventNamespace, name: eventName, args });</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+            if (eventPromiseResolve) {</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+              let resolve = eventPromiseResolve;</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+              eventPromiseResolve = null;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+              resolve();</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+            }</span>
<a href="#l8.29"></a><span id="l8.29">           });</span>
<a href="#l8.30"></a><span id="l8.30">         }</span>
<a href="#l8.31"></a><span id="l8.31">       }</span>
<a href="#l8.32"></a><span id="l8.32">     }</span>
<a href="#l8.33"></a><span id="l8.33"> </span>
<a href="#l8.34"></a><span id="l8.34">     let checkEvents = function(...expectedEvents) {</span>
<a href="#l8.35"></a><span id="l8.35">       browser.test.assertEq(</span>
<a href="#l8.36"></a><span id="l8.36">         expectedEvents.length,</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineat">@@ -493,21 +499,25 @@ add_task(async function test_addressBook</span>
<a href="#l8.38"></a><span id="l8.38">       );</span>
<a href="#l8.39"></a><span id="l8.39">       let [updatedBook] = checkEvents([</span>
<a href="#l8.40"></a><span id="l8.40">         &quot;addressBooks&quot;,</span>
<a href="#l8.41"></a><span id="l8.41">         &quot;onUpdated&quot;,</span>
<a href="#l8.42"></a><span id="l8.42">         { type: &quot;addressBook&quot;, id: bookId },</span>
<a href="#l8.43"></a><span id="l8.43">       ]);</span>
<a href="#l8.44"></a><span id="l8.44">       browser.test.assertEq(&quot;external edit&quot;, updatedBook.name);</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+      let eventPromise = new Promise(resolve =&gt; {</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+        eventPromiseResolve = resolve;</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+      });</span>
<a href="#l8.49"></a><span id="l8.49">       await awaitMessage(</span>
<a href="#l8.50"></a><span id="l8.50">         &quot;outsideEventsTest&quot;,</span>
<a href="#l8.51"></a><span id="l8.51">         &quot;deleteAddressBook&quot;,</span>
<a href="#l8.52"></a><span id="l8.52">         newBookPrefId</span>
<a href="#l8.53"></a><span id="l8.53">       );</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+      await eventPromise;</span>
<a href="#l8.55"></a><span id="l8.55">       checkEvents([&quot;addressBooks&quot;, &quot;onDeleted&quot;, bookId]);</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57">       let [parentId1, contactId] = await awaitMessage(</span>
<a href="#l8.58"></a><span id="l8.58">         &quot;outsideEventsTest&quot;,</span>
<a href="#l8.59"></a><span id="l8.59">         &quot;createContact&quot;</span>
<a href="#l8.60"></a><span id="l8.60">       );</span>
<a href="#l8.61"></a><span id="l8.61">       let [newContact] = checkEvents([</span>
<a href="#l8.62"></a><span id="l8.62">         &quot;contacts&quot;,</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineat">@@ -691,17 +701,17 @@ add_task(async function test_addressBook</span>
<a href="#l8.64"></a><span id="l8.64">           extension.sendMessage();</span>
<a href="#l8.65"></a><span id="l8.65">           return;</span>
<a href="#l8.66"></a><span id="l8.66">         }</span>
<a href="#l8.67"></a><span id="l8.67">         break;</span>
<a href="#l8.68"></a><span id="l8.68">       }</span>
<a href="#l8.69"></a><span id="l8.69">       case &quot;deleteMailingList&quot;: {</span>
<a href="#l8.70"></a><span id="l8.70">         let list = findMailingList(args[0]);</span>
<a href="#l8.71"></a><span id="l8.71">         if (list) {</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-          MailServices.ab.deleteAddressBook(list.URI);</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+          parent.deleteDirectory(list);</span>
<a href="#l8.74"></a><span id="l8.74">           extension.sendMessage();</span>
<a href="#l8.75"></a><span id="l8.75">           return;</span>
<a href="#l8.76"></a><span id="l8.76">         }</span>
<a href="#l8.77"></a><span id="l8.77">         break;</span>
<a href="#l8.78"></a><span id="l8.78">       }</span>
<a href="#l8.79"></a><span id="l8.79">       case &quot;addMailingListMember&quot;: {</span>
<a href="#l8.80"></a><span id="l8.80">         let list = findMailingList(args[0]);</span>
<a href="#l8.81"></a><span id="l8.81">         let contact = findContact(args[1]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/test/browser/addrbook/browser.ini</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/test/browser/addrbook/browser.ini</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,15 +1,16 @@</span>
<a href="#l9.4"></a><span id="l9.4"> [DEFAULT]</span>
<a href="#l9.5"></a><span id="l9.5"> prefs =</span>
<a href="#l9.6"></a><span id="l9.6">   ldap_2.servers.osx.description=</span>
<a href="#l9.7"></a><span id="l9.7">   ldap_2.servers.osx.dirType=-1</span>
<a href="#l9.8"></a><span id="l9.8">   ldap_2.servers.osx.uri=</span>
<a href="#l9.9"></a><span id="l9.9">   mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l9.10"></a><span id="l9.10">   mail.spotlight.firstRunDone=true</span>
<a href="#l9.11"></a><span id="l9.11">   mail.winsearch.firstRunDone=true</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+  mailnews.database.global.indexer.enabled=false</span>
<a href="#l9.13"></a><span id="l9.13">   mailnews.start_page.override_url=about:blank</span>
<a href="#l9.14"></a><span id="l9.14">   mailnews.start_page.url=about:blank</span>
<a href="#l9.15"></a><span id="l9.15"> subsuite = thunderbird</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17"> [browser_addressBook.js]</span>
<a href="#l9.18"></a><span id="l9.18"> [browser_addressBookPanes.js]</span>
<a href="#l9.19"></a><span id="l9.19"> [browser_updateMailingList.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/test/browser/message-window/browser.ini</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/test/browser/message-window/browser.ini</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -13,9 +13,10 @@ subsuite = thunderbird</span>
<a href="#l10.4"></a><span id="l10.4"> support-files = data/**</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> [browser_autohideMenubar.js]</span>
<a href="#l10.7"></a><span id="l10.7"> skip-if = os == &quot;linux&quot; || os = &quot;mac&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> [browser_commands.js]</span>
<a href="#l10.9"></a><span id="l10.9"> [browser_emlSubject.js]</span>
<a href="#l10.10"></a><span id="l10.10"> [browser_messageSidebar.js]</span>
<a href="#l10.11"></a><span id="l10.11"> [browser_vcardActions.js]</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+fail-if = true</span>
<a href="#l10.13"></a><span id="l10.13"> [browser_viewPlaintext.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/test/browser/quick-filter-bar/browser_filterLogic.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/test/browser/quick-filter-bar/browser_filterLogic.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -122,20 +122,18 @@ add_task(function test_filter_attachment</span>
<a href="#l11.4"></a><span id="l11.4">  */</span>
<a href="#l11.5"></a><span id="l11.5"> function add_email_to_address_book(aEmailAddr) {</span>
<a href="#l11.6"></a><span id="l11.6">   let card = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance(</span>
<a href="#l11.7"></a><span id="l11.7">     Ci.nsIAbCard</span>
<a href="#l11.8"></a><span id="l11.8">   );</span>
<a href="#l11.9"></a><span id="l11.9">   card.primaryEmail = aEmailAddr;</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11">   for (let addrbook of MailServices.ab.directories) {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    if (addrbook instanceof Ci.nsIAbDirectory) {</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-      addrbook.addCard(card);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-      return;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-    }</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+    addrbook.addCard(card);</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+    return;</span>
<a href="#l11.18"></a><span id="l11.18">   }</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20">   throw new Error(&quot;Unable to find any suitable address book.&quot;);</span>
<a href="#l11.21"></a><span id="l11.21"> }</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23"> add_task(function test_filter_in_address_book() {</span>
<a href="#l11.24"></a><span id="l11.24">   let bookSetDef = {</span>
<a href="#l11.25"></a><span id="l11.25">     from: [&quot;Qbert Q Qbington&quot;, &quot;q@q.invalid&quot;],</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/addrbook/content/abResultsPane.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/addrbook/content/abResultsPane.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -40,17 +40,19 @@ var gAbView = null;</span>
<a href="#l12.4"></a><span id="l12.4"> // Holds a reference to the &quot;abResultsTree&quot; document element. Initially</span>
<a href="#l12.5"></a><span id="l12.5"> // set up by SetAbView.</span>
<a href="#l12.6"></a><span id="l12.6"> var gAbResultsTree = null;</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> function SetAbView(aURI) {</span>
<a href="#l12.9"></a><span id="l12.9">   // If we don't have a URI, just clear the view and leave everything else</span>
<a href="#l12.10"></a><span id="l12.10">   // alone.</span>
<a href="#l12.11"></a><span id="l12.11">   if (!aURI) {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    gAbView.clearView();</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+    if (gAbView) {</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+      gAbView.clearView();</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+    }</span>
<a href="#l12.16"></a><span id="l12.16">     return;</span>
<a href="#l12.17"></a><span id="l12.17">   }</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19">   // If we do have a URI, we want to allow updating the review even if the</span>
<a href="#l12.20"></a><span id="l12.20">   // URI is the same, as the search results may be different.</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22">   var sortColumn = kDefaultSortColumn;</span>
<a href="#l12.23"></a><span id="l12.23">   var sortDirection = kDefaultAscending;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -154,26 +154,26 @@ function openConnectionTo(file) {</span>
<a href="#l13.4"></a><span id="l13.4">   }</span>
<a href="#l13.5"></a><span id="l13.5">   return connection;</span>
<a href="#l13.6"></a><span id="l13.6"> }</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> /**</span>
<a href="#l13.9"></a><span id="l13.9">  * Closes the SQLite connection to `file` and removes it from the cache.</span>
<a href="#l13.10"></a><span id="l13.10">  */</span>
<a href="#l13.11"></a><span id="l13.11"> function closeConnectionTo(file) {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+  directories.delete(file.leafName);</span>
<a href="#l13.13"></a><span id="l13.13">   let connection = connections.get(file.path);</span>
<a href="#l13.14"></a><span id="l13.14">   if (connection) {</span>
<a href="#l13.15"></a><span id="l13.15">     return new Promise(resolve =&gt; {</span>
<a href="#l13.16"></a><span id="l13.16">       connection.asyncClose({</span>
<a href="#l13.17"></a><span id="l13.17">         complete() {</span>
<a href="#l13.18"></a><span id="l13.18">           resolve();</span>
<a href="#l13.19"></a><span id="l13.19">         },</span>
<a href="#l13.20"></a><span id="l13.20">       });</span>
<a href="#l13.21"></a><span id="l13.21">       connections.delete(file.path);</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-      directories.delete(file.leafName);</span>
<a href="#l13.23"></a><span id="l13.23">     });</span>
<a href="#l13.24"></a><span id="l13.24">   }</span>
<a href="#l13.25"></a><span id="l13.25">   return Promise.resolve();</span>
<a href="#l13.26"></a><span id="l13.26"> }</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28"> // One AddrBookDirectoryInner exists for each address book, multiple</span>
<a href="#l13.29"></a><span id="l13.29"> // AddrBookDirectory objects (e.g. queries) can use it as their prototype.</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31" class="difflineat">@@ -205,16 +205,19 @@ function AddrBookDirectoryInner(fileName</span>
<a href="#l13.32"></a><span id="l13.32">     file.create(Ci.nsIFile.NORMAL_FILE_TYPE, 0o644);</span>
<a href="#l13.33"></a><span id="l13.33">   }</span>
<a href="#l13.34"></a><span id="l13.34"> </span>
<a href="#l13.35"></a><span id="l13.35">   directories.set(fileName, this);</span>
<a href="#l13.36"></a><span id="l13.36">   this._inner = this;</span>
<a href="#l13.37"></a><span id="l13.37">   this._fileName = fileName;</span>
<a href="#l13.38"></a><span id="l13.38"> }</span>
<a href="#l13.39"></a><span id="l13.39"> AddrBookDirectoryInner.prototype = {</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIAbDirectory]),</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+  classID: Components.ID(&quot;{e96ee804-0bd3-472f-81a6-8a9d65277ad3}&quot;),</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+</span>
<a href="#l13.43"></a><span id="l13.43">   _uid: null,</span>
<a href="#l13.44"></a><span id="l13.44">   _nextCardId: null,</span>
<a href="#l13.45"></a><span id="l13.45">   _nextListId: null,</span>
<a href="#l13.46"></a><span id="l13.46">   get _prefBranch() {</span>
<a href="#l13.47"></a><span id="l13.47">     if (!this.dirPrefId) {</span>
<a href="#l13.48"></a><span id="l13.48">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l13.49"></a><span id="l13.49">     }</span>
<a href="#l13.50"></a><span id="l13.50">     return Services.prefs.getBranch(`${this.dirPrefId}.`);</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineat">@@ -804,19 +807,26 @@ AddrBookDirectoryInner.prototype = {</span>
<a href="#l13.52"></a><span id="l13.52">     this._saveCardProperties(card);</span>
<a href="#l13.53"></a><span id="l13.53">     for (let [name, oldValue] of oldProperties.entries()) {</span>
<a href="#l13.54"></a><span id="l13.54">       if (!newProperties.has(name)) {</span>
<a href="#l13.55"></a><span id="l13.55">         MailServices.ab.notifyItemPropertyChanged(card, name, oldValue, null);</span>
<a href="#l13.56"></a><span id="l13.56">       }</span>
<a href="#l13.57"></a><span id="l13.57">     }</span>
<a href="#l13.58"></a><span id="l13.58">     for (let [name, newValue] of newProperties.entries()) {</span>
<a href="#l13.59"></a><span id="l13.59">       let oldValue = oldProperties.get(name);</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+      if (oldValue == null &amp;&amp; newValue == &quot;&quot;) {</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+        continue;</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+      }</span>
<a href="#l13.63"></a><span id="l13.63">       if (oldValue != newValue) {</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-        // TODO We can do better than null. But MDB doesn't.</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-        MailServices.ab.notifyItemPropertyChanged(card, null, null, null);</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+        MailServices.ab.notifyItemPropertyChanged(</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+          card,</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+          name,</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+          oldValue,</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+          newValue</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+        );</span>
<a href="#l13.72"></a><span id="l13.72">       }</span>
<a href="#l13.73"></a><span id="l13.73">     }</span>
<a href="#l13.74"></a><span id="l13.74">     Services.obs.notifyObservers(card, &quot;addrbook-contact-updated&quot;, this.UID);</span>
<a href="#l13.75"></a><span id="l13.75">   },</span>
<a href="#l13.76"></a><span id="l13.76">   deleteCards(cards) {</span>
<a href="#l13.77"></a><span id="l13.77">     if (cards === null) {</span>
<a href="#l13.78"></a><span id="l13.78">       throw Cr.NS_ERROR_INVALID_POINTER;</span>
<a href="#l13.79"></a><span id="l13.79">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/AddrBookManager.jsm</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,308 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+const EXPORTED_SYMBOLS = [&quot;AddrBookManager&quot;];</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+  this,</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  &quot;AppConstants&quot;,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+  &quot;resource://gre/modules/AppConstants.jsm&quot;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+);</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+  this,</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+  &quot;closeConnectionTo&quot;,</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+  &quot;resource:///modules/AddrBookDirectory.jsm&quot;</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+);</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+  this,</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+  &quot;Services&quot;,</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+  &quot;resource://gre/modules/Services.jsm&quot;</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+);</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+  this,</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+  &quot;SimpleEnumerator&quot;,</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+  &quot;resource:///modules/AddrBookUtils.jsm&quot;</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+);</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+/** Directory type constants, as defined in nsDirPrefs.h. */</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+const LDAP_DIRECTORY_TYPE = 0;</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+const MAPI_DIRECTORY_TYPE = 3;</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+const JS_DIRECTORY_TYPE = 101;</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+/** Test for valid directory URIs. */</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+const URI_REGEXP = /^([\w-]+):\/\/([\w\.-]*)([?/:].*|$)/;</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+/**</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+ * All registered nsIAbListener objects. Keys to this map are the listeners</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+ * themselves; values are a bitmap of events to notify. See nsIAbListener.idl.</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+ */</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+let listeners = new Map();</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+/**</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+ * When initialized, a map of nsIAbDirectory objects. Keys to this map are</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+ * the directories' URIs.</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+ */</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+let store = null;</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+/** Valid address book types. This differs by operating system. */</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+let types = [&quot;jsaddrbook&quot;, &quot;moz-abldapdirectory&quot;];</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+if (AppConstants.platform == &quot;macosx&quot;) {</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+  types.push(&quot;moz-abosxdirectory&quot;);</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+} else if (AppConstants.platform == &quot;win&quot;) {</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+  types.push(&quot;moz-aboutlookdirectory&quot;);</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+}</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+/**</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+ * Initialise an address book directory by URI.</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+ *</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+ * @param {string} uri - URI for the directory.</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+ * @param {boolean} shouldStore - Whether to keep a reference to this address</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+ *   book in the store.</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+ * @returns {nsIAbDirectory}</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+ */</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+function createDirectoryObject(uri, shouldStore = false) {</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+  let uriParts = URI_REGEXP.exec(uri);</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+  if (!uriParts) {</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+    throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+  }</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+  let [, scheme] = uriParts;</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+  let dir = Cc[</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+    `@mozilla.org/addressbook/directory;1?type=${scheme}`</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+  ].createInstance(Ci.nsIAbDirectory);</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+  if (shouldStore) {</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+    store.set(uri, dir);</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+  }</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+  dir.init(uri);</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+  return dir;</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+}</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+/**</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+ * Read the preferences and create any address books defined there.</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+ */</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+function ensureInitialized() {</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+  if (store !== null) {</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+    return;</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+  }</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+  store = new Map();</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+  for (let pref of Services.prefs.getChildList(&quot;ldap_2.servers.&quot;)) {</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+    if (pref.endsWith(&quot;.dirType&quot;)) {</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+      let prefName = pref.substring(0, pref.length - 8);</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+      let dirType = Services.prefs.getIntPref(pref);</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+      let fileName = Services.prefs.getStringPref(`${prefName}.filename`, &quot;&quot;);</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+      if (dirType == JS_DIRECTORY_TYPE &amp;&amp; fileName) {</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+        let uri = `jsaddrbook://${fileName}`;</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+        createDirectoryObject(uri, true);</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+      }</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+    }</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+  }</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+}</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+Services.obs.addObserver(() =&gt; {</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+  // Clear the store. The next call to ensureInitialized will recreate it.</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+  store = null;</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+}, &quot;addrbook-reload&quot;);</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+/** @implements nsIAbManager */</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+function AddrBookManager() {}</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+AddrBookManager.prototype = {</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIAbManager]),</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+  classID: Components.ID(&quot;{224d3ef9-d81c-4d94-8826-a79a5835af93}&quot;),</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+  get directories() {</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+    ensureInitialized();</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+    let dirs = [...store.values()];</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+    dirs.sort((a, b) =&gt; {</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+      let aPosition = a.getIntValue(&quot;position&quot;, 0);</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+      let bPosition = b.getIntValue(&quot;position&quot;, 0);</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+      if (aPosition != bPosition) {</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+        return aPosition - bPosition;</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+      }</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+      return a.URI &lt; b.URI ? -1 : 1;</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+    });</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+    return new SimpleEnumerator(dirs);</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+  },</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+  getDirectory(uri) {</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+    if (uri.startsWith(&quot;moz-abdirectory://&quot;)) {</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+      return null;</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+    }</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+    ensureInitialized();</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+    if (store.has(uri)) {</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+      return store.get(uri);</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+    }</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+    let uriParts = URI_REGEXP.exec(uri);</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+    if (!uriParts) {</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+    }</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+    let [, , , tail] = uriParts;</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+    if (tail) {</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+      // `tail` could either point to a mailing list or a query.</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+      // Both of these will be handled differently in future.</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+      return createDirectoryObject(uri);</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+    }</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+    return null;</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+  },</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+  getDirectoryFromId(dirPrefId) {</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+    ensureInitialized();</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+    for (let dir of store.values()) {</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+      if (dir.dirPrefId == dirPrefId) {</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+        return dir;</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+      }</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+    }</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+    return null;</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+  },</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+  newAddressBook(dirName, uri, type, prefName) {</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+    function ensureUniquePrefName() {</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+      let leafName = dirName.replace(/\W/g, &quot;&quot;);</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+      if (!leafName) {</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+        leafName = &quot;_nonascii&quot;;</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+      }</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+      let existingNames = Array.from(store.values(), dir =&gt; dir.dirPrefId);</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+      let uniqueCount = 0;</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+      prefName = `ldap_2.servers.${leafName}`;</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+      while (existingNames.includes(prefName)) {</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+        prefName = `ldap_2.servers.${leafName}_${++uniqueCount}`;</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+      }</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+    }</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+    if (!dirName) {</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+    }</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineplus">+</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+    ensureInitialized();</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+    let file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineplus">+    file.append(&quot;abook.sqlite&quot;);</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineplus">+    file.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE, 0o644);</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineplus">+    file.remove(false);</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+    uri = `jsaddrbook://${file.leafName}`;</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+    ensureUniquePrefName();</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+    Services.prefs.setStringPref(`${prefName}.description`, dirName);</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+    Services.prefs.setIntPref(`${prefName}.dirType`, type);</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineplus">+    Services.prefs.setStringPref(`${prefName}.filename`, file.leafName);</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineplus">+    Services.prefs.setStringPref(`${prefName}.uri`, uri);</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineplus">+</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineplus">+    uri = `jsaddrbook://${file.leafName}`;</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineplus">+    let dir = createDirectoryObject(uri, true);</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineplus">+    this.notifyDirectoryItemAdded(null, dir);</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineplus">+    return prefName;</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+  },</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+  deleteAddressBook(uri) {</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+    let uriParts = URI_REGEXP.exec(uri);</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineplus">+    if (!uriParts) {</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineplus">+      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+    }</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineplus">+</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineplus">+    let [, scheme, fileName, tail] = uriParts;</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineplus">+    if (tail) {</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+      if (tail.startsWith(&quot;/MailList&quot;)) {</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+        let dir = store.get(`${scheme}://${fileName}`);</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineplus">+        let list = this.getDirectory(uri);</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineplus">+        if (dir &amp;&amp; list) {</span>
<a href="#l14.213"></a><span id="l14.213" class="difflineplus">+          dir.deleteDirectory(list);</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineplus">+          return;</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineplus">+        }</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineplus">+      }</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineplus">+      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineplus">+    }</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineplus">+</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineplus">+    let dir = this.getDirectory(uri);</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineplus">+    if (!dir) {</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+      return;</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+    }</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineplus">+</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+    let prefName = dir.dirPrefId;</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineplus">+    fileName = dir.fileName;</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineplus">+    Services.prefs.clearUserPref(`${prefName}.description`);</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineplus">+    Services.prefs.clearUserPref(`${prefName}.dirType`);</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineplus">+    Services.prefs.clearUserPref(`${prefName}.filename`);</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+    Services.prefs.clearUserPref(`${prefName}.uid`);</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineplus">+    Services.prefs.clearUserPref(`${prefName}.uri`);</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineplus">+    store.delete(`jsaddrbook://${fileName}`);</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineplus">+</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineplus">+    let file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineplus">+    file.append(fileName);</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineplus">+    closeConnectionTo(file).then(() =&gt; {</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineplus">+      if (file.exists()) {</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineplus">+        file.remove(false);</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineplus">+      }</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineplus">+      this.notifyDirectoryDeleted(null, dir);</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineplus">+    });</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineplus">+  },</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineplus">+  exportAddressBook(parentWin, directory) {</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineplus">+  },</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineplus">+  addAddressBookListener(listener, notifyFlags) {</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineplus">+    listeners.set(listener, notifyFlags);</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineplus">+  },</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineplus">+  removeAddressBookListener(listener) {</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineplus">+    listeners.delete(listener);</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineplus">+  },</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineplus">+  notifyItemPropertyChanged(item, property, oldValue, newValue) {</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineplus">+    for (let [listener, notifyFlags] of listeners.entries()) {</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineplus">+      if (notifyFlags &amp; Ci.nsIAbListener.itemChanged) {</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineplus">+        try {</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineplus">+          listener.onItemPropertyChanged(item, property, oldValue, newValue);</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineplus">+        } catch (ex) {</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineplus">+          Cu.reportError(ex);</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineplus">+        }</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineplus">+      }</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineplus">+    }</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineplus">+  },</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineplus">+  notifyDirectoryItemAdded(parentDirectory, item) {</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineplus">+    for (let [listener, notifyFlags] of listeners.entries()) {</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineplus">+      if (notifyFlags &amp; Ci.nsIAbListener.itemAdded) {</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+        try {</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+          listener.onItemAdded(parentDirectory, item);</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineplus">+        } catch (ex) {</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineplus">+          Cu.reportError(ex);</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineplus">+        }</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+      }</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineplus">+    }</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineplus">+  },</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineplus">+  notifyDirectoryItemDeleted(parentDirectory, item) {</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineplus">+    for (let [listener, notifyFlags] of listeners.entries()) {</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineplus">+      if (notifyFlags &amp; Ci.nsIAbListener.directoryItemRemoved) {</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineplus">+        try {</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineplus">+          listener.onItemRemoved(parentDirectory, item);</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineplus">+        } catch (ex) {</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineplus">+          Cu.reportError(ex);</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineplus">+        }</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineplus">+      }</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineplus">+    }</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineplus">+  },</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineplus">+  notifyDirectoryDeleted(parentDirectory, directory) {</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineplus">+    for (let [listener, notifyFlags] of listeners.entries()) {</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineplus">+      if (notifyFlags &amp; Ci.nsIAbListener.directoryRemoved) {</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineplus">+        try {</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineplus">+          listener.onItemRemoved(parentDirectory, directory);</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineplus">+        } catch (ex) {</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineplus">+          Cu.reportError(ex);</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineplus">+        }</span>
<a href="#l14.294"></a><span id="l14.294" class="difflineplus">+      }</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineplus">+    }</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineplus">+  },</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineplus">+  mailListNameExists(name) {</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineplus">+    ensureInitialized();</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineplus">+    for (let dir of store.values()) {</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineplus">+      if (dir.hasMailListWithName(name)) {</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineplus">+        return true;</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineplus">+      }</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineplus">+    }</span>
<a href="#l14.304"></a><span id="l14.304" class="difflineplus">+    return false;</span>
<a href="#l14.305"></a><span id="l14.305" class="difflineplus">+  },</span>
<a href="#l14.306"></a><span id="l14.306" class="difflineplus">+  escapedVCardToAbCard(escapedVCardStr) {</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineplus">+  },</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineplus">+  generateUUID(directoryId, localId) {</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineplus">+    return `${directoryId}#${localId}`;</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineplus">+  },</span>
<a href="#l14.312"></a><span id="l14.312" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/components.conf</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/components.conf</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -9,10 +9,15 @@ Classes = [</span>
<a href="#l15.4"></a><span id="l15.4">         'contract_ids': ['@mozilla.org/addressbook/directory;1?type=jsaddrbook'],</span>
<a href="#l15.5"></a><span id="l15.5">         'jsm': 'resource:///modules/AddrBookDirectory.jsm',</span>
<a href="#l15.6"></a><span id="l15.6">         'constructor': 'AddrBookDirectory',</span>
<a href="#l15.7"></a><span id="l15.7">     }, {</span>
<a href="#l15.8"></a><span id="l15.8">         'cid': '{1143991d-31cd-4ea6-9c97-c587d990d724}',</span>
<a href="#l15.9"></a><span id="l15.9">         'contract_ids': ['@mozilla.org/addressbook/jsaddrbookcard;1'],</span>
<a href="#l15.10"></a><span id="l15.10">         'jsm': 'resource:///modules/AddrBookCard.jsm',</span>
<a href="#l15.11"></a><span id="l15.11">         'constructor': 'AddrBookCard',</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+    }, {</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+        'cid': '{224d3ef9-d81c-4d94-8826-a79a5835af93}',</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+        'contract_ids': ['@mozilla.org/abmanager;1'],</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+        'jsm': 'resource:///modules/AddrBookManager.jsm',</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+        'constructor': 'AddrBookManager',</span>
<a href="#l15.17"></a><span id="l15.17">     },</span>
<a href="#l15.18"></a><span id="l15.18"> ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/moz.build</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/moz.build</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -2,14 +2,15 @@</span>
<a href="#l16.4"></a><span id="l16.4"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.5"></a><span id="l16.5"> # file, you can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7"> EXTRA_JS_MODULES += [</span>
<a href="#l16.8"></a><span id="l16.8">     'AddrBookCard.jsm',</span>
<a href="#l16.9"></a><span id="l16.9">     'AddrBookDirectory.jsm',</span>
<a href="#l16.10"></a><span id="l16.10">     'AddrBookFactory.jsm',</span>
<a href="#l16.11"></a><span id="l16.11">     'AddrBookMailingList.jsm',</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+    'AddrBookManager.jsm',</span>
<a href="#l16.13"></a><span id="l16.13">     'AddrBookUtils.jsm',</span>
<a href="#l16.14"></a><span id="l16.14"> ]</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16"> XPCOM_MANIFESTS += [</span>
<a href="#l16.17"></a><span id="l16.17">     'components.conf',</span>
<a href="#l16.18"></a><span id="l16.18"> ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/addrbook/prefs/content/pref-editdirectories.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/addrbook/prefs/content/pref-editdirectories.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -10,29 +10,38 @@ var { MailServices } = ChromeUtils.impor</span>
<a href="#l17.4"></a><span id="l17.4">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l17.5"></a><span id="l17.5"> );</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7"> // Listener to refresh the list items if something changes. In all these</span>
<a href="#l17.8"></a><span id="l17.8"> // cases we just rebuild the list as it is easier than searching/adding in the</span>
<a href="#l17.9"></a><span id="l17.9"> // correct places an would be an infrequent operation.</span>
<a href="#l17.10"></a><span id="l17.10"> var gAddressBookAbListener = {</span>
<a href="#l17.11"></a><span id="l17.11">   onItemAdded(parentDir, item) {</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-    if (item instanceof Ci.nsIAbDirectory) {</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-      fillDirectoryList(item);</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+    try {</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+      item.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+    } catch (ex) {</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+      return;</span>
<a href="#l17.18"></a><span id="l17.18">     }</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+    fillDirectoryList(item);</span>
<a href="#l17.20"></a><span id="l17.20">   },</span>
<a href="#l17.21"></a><span id="l17.21">   onItemRemoved(parentDir, item) {</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-    if (item instanceof Ci.nsIAbDirectory) {</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-      fillDirectoryList();</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+    try {</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+      item.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+    } catch (ex) {</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+      return;</span>
<a href="#l17.28"></a><span id="l17.28">     }</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+    fillDirectoryList();</span>
<a href="#l17.30"></a><span id="l17.30">   },</span>
<a href="#l17.31"></a><span id="l17.31">   onItemPropertyChanged(item, property, oldValue, newValue) {</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-    if (item instanceof Ci.nsIAbDirectory) {</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-      fillDirectoryList(item);</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+    try {</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+      item.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+    } catch (ex) {</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+      return;</span>
<a href="#l17.38"></a><span id="l17.38">     }</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+    fillDirectoryList(item);</span>
<a href="#l17.40"></a><span id="l17.40">   },</span>
<a href="#l17.41"></a><span id="l17.41"> };</span>
<a href="#l17.42"></a><span id="l17.42"> </span>
<a href="#l17.43"></a><span id="l17.43"> function onInitEditDirectories() {</span>
<a href="#l17.44"></a><span id="l17.44">   // For AbDeleteDirectory in abCommon.js</span>
<a href="#l17.45"></a><span id="l17.45">   gAddressBookBundle = document.getElementById(&quot;bundle_addressBook&quot;);</span>
<a href="#l17.46"></a><span id="l17.46"> </span>
<a href="#l17.47"></a><span id="l17.47">   // If the pref is locked disable the &quot;Add&quot; button</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbManager.idl</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbManager.idl</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -136,22 +136,16 @@ interface nsIAbManager : nsISupports</span>
<a href="#l18.4"></a><span id="l18.4">    * @param  aParentDirectory  The parent directory of the directory that has</span>
<a href="#l18.5"></a><span id="l18.5">    *                           been removed.</span>
<a href="#l18.6"></a><span id="l18.6">    * @param  aDirectory        The directory that has been removed.</span>
<a href="#l18.7"></a><span id="l18.7">    */</span>
<a href="#l18.8"></a><span id="l18.8">   void notifyDirectoryDeleted(in nsIAbDirectory aParentDirectory,</span>
<a href="#l18.9"></a><span id="l18.9">                               in nsISupports aDirectory);</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11">   /**</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-   * Returns the user profile directory. NOTE: this should not be used</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-   * as it may go away soon.</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-   */</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-  readonly attribute nsIFile userProfileDirectory;</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-  /**</span>
<a href="#l18.18"></a><span id="l18.18">    * Finds out if the mailing list name exists in any address book.</span>
<a href="#l18.19"></a><span id="l18.19">    *</span>
<a href="#l18.20"></a><span id="l18.20">    * @param  aName      The name of the list to try and find.</span>
<a href="#l18.21"></a><span id="l18.21">    *</span>
<a href="#l18.22"></a><span id="l18.22">    * @return            True if the name exists.</span>
<a href="#l18.23"></a><span id="l18.23">    */</span>
<a href="#l18.24"></a><span id="l18.24">   boolean mailListNameExists(in wstring name);</span>
<a href="#l18.25"></a><span id="l18.25"> </span>
<a href="#l18.26"></a><span id="l18.26" class="difflineat">@@ -170,19 +164,9 @@ interface nsIAbManager : nsISupports</span>
<a href="#l18.27"></a><span id="l18.27">    * Use of this method is preferred in such cases, since it is designed to work</span>
<a href="#l18.28"></a><span id="l18.28">    * with other methods of this interface.</span>
<a href="#l18.29"></a><span id="l18.29">    *</span>
<a href="#l18.30"></a><span id="l18.30">    * @param directoryId The directory ID.</span>
<a href="#l18.31"></a><span id="l18.31">    * @param localId     The per-directory ID.</span>
<a href="#l18.32"></a><span id="l18.32">    * @return            A string to use for the UUID.</span>
<a href="#l18.33"></a><span id="l18.33">    */</span>
<a href="#l18.34"></a><span id="l18.34">   AUTF8String generateUUID(in AUTF8String directoryId, in AUTF8String localId);</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-  /**</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-   * A utility function that converts an nsIAbDirectory query string to an</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-   * nsIAbBooleanExpression.</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-   *</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-   * @param aQueryString The nsIAbDirectory query string</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-   * @return an nsIAbBooleanExpression for the query string</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-   */</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineminus">-  nsIAbBooleanExpression convertQueryStringToExpression(in AUTF8String aQueryString);</span>
<a href="#l18.45"></a><span id="l18.45"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/addrbook/src/AbAutoCompleteSearch.jsm</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/addrbook/src/AbAutoCompleteSearch.jsm</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -461,20 +461,17 @@ AbAutoCompleteSearch.prototype = {</span>
<a href="#l19.4"></a><span id="l19.4">       let searchQuery = generateQueryURI(result.modelQuery, searchWords);</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6">       // Now do the searching</span>
<a href="#l19.7"></a><span id="l19.7">       // We're not going to bother searching sub-directories, currently the</span>
<a href="#l19.8"></a><span id="l19.8">       // architecture forces all cards that are in mailing lists to be in ABs as</span>
<a href="#l19.9"></a><span id="l19.9">       // well, therefore by searching sub-directories (aka mailing lists) we're</span>
<a href="#l19.10"></a><span id="l19.10">       // just going to find duplicates.</span>
<a href="#l19.11"></a><span id="l19.11">       for (let dir of this._abManager.directories) {</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-        if (</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-          dir instanceof Ci.nsIAbDirectory &amp;&amp;</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-          dir.useForAutocomplete(&quot;idKey&quot; in params ? params.idKey : null)</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-        ) {</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+        if (dir.useForAutocomplete(&quot;idKey&quot; in params ? params.idKey : null)) {</span>
<a href="#l19.17"></a><span id="l19.17">           this._searchCards(searchQuery, dir, result);</span>
<a href="#l19.18"></a><span id="l19.18">         }</span>
<a href="#l19.19"></a><span id="l19.19">       }</span>
<a href="#l19.20"></a><span id="l19.20"> </span>
<a href="#l19.21"></a><span id="l19.21">       result._searchResults = [...result._collectedValues.values()];</span>
<a href="#l19.22"></a><span id="l19.22">     }</span>
<a href="#l19.23"></a><span id="l19.23"> </span>
<a href="#l19.24"></a><span id="l19.24">     // Sort the results. Scoring may have changed so do it even if this is</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/addrbook/src/moz.build</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/addrbook/src/moz.build</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -15,17 +15,17 @@ SOURCES += [</span>
<a href="#l20.4"></a><span id="l20.4">     'nsAbBSDirectory.cpp',</span>
<a href="#l20.5"></a><span id="l20.5">     'nsAbCardProperty.cpp',</span>
<a href="#l20.6"></a><span id="l20.6">     'nsAbContentHandler.cpp',</span>
<a href="#l20.7"></a><span id="l20.7">     'nsAbDirectoryQuery.cpp',</span>
<a href="#l20.8"></a><span id="l20.8">     'nsAbDirectoryQueryProxy.cpp',</span>
<a href="#l20.9"></a><span id="l20.9">     'nsAbDirFactoryService.cpp',</span>
<a href="#l20.10"></a><span id="l20.10">     'nsAbDirProperty.cpp',</span>
<a href="#l20.11"></a><span id="l20.11">     'nsAbLDIFService.cpp',</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    'nsAbManager.cpp',</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+    # 'nsAbManager.cpp',</span>
<a href="#l20.14"></a><span id="l20.14">     'nsAbQueryStringToExpression.cpp',</span>
<a href="#l20.15"></a><span id="l20.15">     'nsAbView.cpp',</span>
<a href="#l20.16"></a><span id="l20.16">     'nsAddbookProtocolHandler.cpp',</span>
<a href="#l20.17"></a><span id="l20.17">     'nsAddbookUrl.cpp',</span>
<a href="#l20.18"></a><span id="l20.18">     'nsAddrDatabase.cpp',</span>
<a href="#l20.19"></a><span id="l20.19">     'nsDirPrefs.cpp',</span>
<a href="#l20.20"></a><span id="l20.20">     'nsMsgVCardService.cpp',</span>
<a href="#l20.21"></a><span id="l20.21">     'nsVCard.cpp',</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbView.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbView.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -174,26 +174,28 @@ NS_IMETHODIMP nsAbView::SetView(nsIAbDir</span>
<a href="#l21.4"></a><span id="l21.4">     rv = RemoveCardAt(i);</span>
<a href="#l21.5"></a><span id="l21.5">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;remove card failed&quot;);</span>
<a href="#l21.6"></a><span id="l21.6">   }</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8">   // We replace all cards so any sorting is no longer valid.</span>
<a href="#l21.9"></a><span id="l21.9">   mSortColumn.AssignLiteral(&quot;&quot;);</span>
<a href="#l21.10"></a><span id="l21.10">   mSortDirection.AssignLiteral(&quot;&quot;);</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  nsCString uri;</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-  aAddressBook-&gt;GetURI(uri);</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+  nsCString uri = EmptyCString();</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+  if (aAddressBook) {</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+    aAddressBook-&gt;GetURI(uri);</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+  }</span>
<a href="#l21.18"></a><span id="l21.18">   int32_t searchBegin = uri.FindChar('?');</span>
<a href="#l21.19"></a><span id="l21.19">   nsCString searchQuery(Substring(uri, searchBegin));</span>
<a href="#l21.20"></a><span id="l21.20">   // This is a special case, a workaround basically, to just have all ABs.</span>
<a href="#l21.21"></a><span id="l21.21">   if (searchQuery.EqualsLiteral(&quot;?&quot;)) {</span>
<a href="#l21.22"></a><span id="l21.22">     searchQuery.AssignLiteral(&quot;&quot;);</span>
<a href="#l21.23"></a><span id="l21.23">   }</span>
<a href="#l21.24"></a><span id="l21.24"> </span>
<a href="#l21.25"></a><span id="l21.25" class="difflineminus">-  if (Substring(uri, 0, searchBegin).EqualsLiteral(kAllDirectoryRoot)) {</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+  if (!aAddressBook) {</span>
<a href="#l21.27"></a><span id="l21.27">     mIsAllDirectoryRootView = true;</span>
<a href="#l21.28"></a><span id="l21.28">     // We have special request case to search all addressbooks, so we need</span>
<a href="#l21.29"></a><span id="l21.29">     // to iterate over all addressbooks.</span>
<a href="#l21.30"></a><span id="l21.30">     // Since the request is for all addressbooks, the URI must have been</span>
<a href="#l21.31"></a><span id="l21.31">     // passed with an extra '?'. We still check it for sanity and trim it here.</span>
<a href="#l21.32"></a><span id="l21.32">     if (searchQuery.Find(&quot;??&quot;) == 0) searchQuery = Substring(searchQuery, 1);</span>
<a href="#l21.33"></a><span id="l21.33"> </span>
<a href="#l21.34"></a><span id="l21.34">     nsCOMPtr&lt;nsIAbManager&gt; abManager(</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineat">@@ -763,16 +765,17 @@ nsCString getQuery(nsCOMPtr&lt;nsIAbDirecto</span>
<a href="#l21.36"></a><span id="l21.36">   aDir-&gt;GetURI(uri);</span>
<a href="#l21.37"></a><span id="l21.37">   int32_t searchBegin = uri.FindChar('?');</span>
<a href="#l21.38"></a><span id="l21.38">   if (searchBegin == kNotFound) return EmptyCString();</span>
<a href="#l21.39"></a><span id="l21.39"> </span>
<a href="#l21.40"></a><span id="l21.40">   return nsCString(Substring(uri, searchBegin));</span>
<a href="#l21.41"></a><span id="l21.41"> }</span>
<a href="#l21.42"></a><span id="l21.42"> </span>
<a href="#l21.43"></a><span id="l21.43"> NS_IMETHODIMP nsAbView::OnItemAdded(nsISupports *parentDir, nsISupports *item) {</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+  if (!parentDir) return NS_OK;</span>
<a href="#l21.45"></a><span id="l21.45">   if (!mDirectory)  // No address book selected.</span>
<a href="#l21.46"></a><span id="l21.46">     return NS_OK;</span>
<a href="#l21.47"></a><span id="l21.47"> </span>
<a href="#l21.48"></a><span id="l21.48">   nsresult rv;</span>
<a href="#l21.49"></a><span id="l21.49">   nsCOMPtr&lt;nsIAbDirectory&gt; directory = do_QueryInterface(parentDir, &amp;rv);</span>
<a href="#l21.50"></a><span id="l21.50">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.51"></a><span id="l21.51"> </span>
<a href="#l21.52"></a><span id="l21.52">   bool isRemote = isDirectoryRemote(directory);</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineat">@@ -867,16 +870,18 @@ int32_t nsAbView::FindIndexForInsert(AbC</span>
<a href="#l21.54"></a><span id="l21.54">     // XXX Fix me, this is not right for both ascending and descending</span>
<a href="#l21.55"></a><span id="l21.55">     if (value &lt;= 0) break;</span>
<a href="#l21.56"></a><span id="l21.56">   }</span>
<a href="#l21.57"></a><span id="l21.57">   return i;</span>
<a href="#l21.58"></a><span id="l21.58"> }</span>
<a href="#l21.59"></a><span id="l21.59"> </span>
<a href="#l21.60"></a><span id="l21.60"> NS_IMETHODIMP nsAbView::OnItemRemoved(nsISupports *parentDir,</span>
<a href="#l21.61"></a><span id="l21.61">                                       nsISupports *item) {</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+  if (!parentDir) return NS_OK;</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineplus">+</span>
<a href="#l21.64"></a><span id="l21.64">   nsresult rv;</span>
<a href="#l21.65"></a><span id="l21.65"> </span>
<a href="#l21.66"></a><span id="l21.66">   nsCOMPtr&lt;nsIAbDirectory&gt; directory = do_QueryInterface(parentDir, &amp;rv);</span>
<a href="#l21.67"></a><span id="l21.67">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.68"></a><span id="l21.68"> </span>
<a href="#l21.69"></a><span id="l21.69">   if (directory.get() == mDirectory.get())</span>
<a href="#l21.70"></a><span id="l21.70">     return RemoveCardAndSelectNextCard(item);</span>
<a href="#l21.71"></a><span id="l21.71"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/addrbook/src/nsDirPrefs.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsDirPrefs.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -23,16 +23,17 @@</span>
<a href="#l22.4"></a><span id="l22.4"> #endif</span>
<a href="#l22.5"></a><span id="l22.5"> #include &quot;prmem.h&quot;</span>
<a href="#l22.6"></a><span id="l22.6"> #include &quot;prprf.h&quot;</span>
<a href="#l22.7"></a><span id="l22.7"> #include &quot;plstr.h&quot;</span>
<a href="#l22.8"></a><span id="l22.8"> #include &quot;nsQuickSort.h&quot;</span>
<a href="#l22.9"></a><span id="l22.9"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l22.10"></a><span id="l22.10"> #include &quot;msgCore.h&quot;</span>
<a href="#l22.11"></a><span id="l22.11"> #include &quot;nsString.h&quot;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+#include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l22.13"></a><span id="l22.13"> </span>
<a href="#l22.14"></a><span id="l22.14"> #include &lt;ctype.h&gt;</span>
<a href="#l22.15"></a><span id="l22.15"> </span>
<a href="#l22.16"></a><span id="l22.16"> /*****************************************************************************</span>
<a href="#l22.17"></a><span id="l22.17">  * Private definitions</span>
<a href="#l22.18"></a><span id="l22.18">  */</span>
<a href="#l22.19"></a><span id="l22.19"> </span>
<a href="#l22.20"></a><span id="l22.20"> /* Default settings for site-configurable prefs */</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineat">@@ -564,23 +565,19 @@ static void DIR_DeleteServer(DIR_Server </span>
<a href="#l22.22"></a><span id="l22.22">     PR_Free(server-&gt;uri);</span>
<a href="#l22.23"></a><span id="l22.23">     PR_Free(server);</span>
<a href="#l22.24"></a><span id="l22.24">   }</span>
<a href="#l22.25"></a><span id="l22.25"> }</span>
<a href="#l22.26"></a><span id="l22.26"> </span>
<a href="#l22.27"></a><span id="l22.27"> nsresult DIR_DeleteServerFromList(DIR_Server *server) {</span>
<a href="#l22.28"></a><span id="l22.28">   if (!server) return NS_ERROR_NULL_POINTER;</span>
<a href="#l22.29"></a><span id="l22.29"> </span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l22.31"></a><span id="l22.31">   nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-    rv = abManager-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+  nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+                                       getter_AddRefs(dbPath));</span>
<a href="#l22.39"></a><span id="l22.39"> </span>
<a href="#l22.40"></a><span id="l22.40">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l22.41"></a><span id="l22.41">     // close the database, as long as it isn't the special ones</span>
<a href="#l22.42"></a><span id="l22.42">     // (personal addressbook and collected addressbook)</span>
<a href="#l22.43"></a><span id="l22.43">     // which can never be deleted.  There was a bug where we would slap in</span>
<a href="#l22.44"></a><span id="l22.44">     // &quot;abook.mab&quot; as the file name for LDAP directories, which would cause a</span>
<a href="#l22.45"></a><span id="l22.45">     // crash on delete of LDAP directories.  this is just extra protection.</span>
<a href="#l22.46"></a><span id="l22.46">     if (server-&gt;fileName &amp;&amp; server-&gt;dirType != JSDirectory &amp;&amp;</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineat">@@ -835,25 +832,22 @@ static void DIR_ConvertServerFileName(DI</span>
<a href="#l22.48"></a><span id="l22.48"> /* This will generate a correct filename and then remove the path.</span>
<a href="#l22.49"></a><span id="l22.49">  * Note: we are assuming that the default name is in the native</span>
<a href="#l22.50"></a><span id="l22.50">  * filesystem charset. The filename will be returned as a UTF8</span>
<a href="#l22.51"></a><span id="l22.51">  * string.</span>
<a href="#l22.52"></a><span id="l22.52">  */</span>
<a href="#l22.53"></a><span id="l22.53"> void DIR_SetFileName(char **fileName, const char *defaultName) {</span>
<a href="#l22.54"></a><span id="l22.54">   if (!fileName) return;</span>
<a href="#l22.55"></a><span id="l22.55"> </span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l22.57"></a><span id="l22.57">   nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineplus">+  nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineplus">+                                       getter_AddRefs(dbPath));</span>
<a href="#l22.60"></a><span id="l22.60"> </span>
<a href="#l22.61"></a><span id="l22.61">   *fileName = nullptr;</span>
<a href="#l22.62"></a><span id="l22.62"> </span>
<a href="#l22.63"></a><span id="l22.63" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineminus">-      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineminus">-    rv = abManager-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l22.67"></a><span id="l22.67">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l22.68"></a><span id="l22.68">     rv = dbPath-&gt;AppendNative(nsDependentCString(defaultName));</span>
<a href="#l22.69"></a><span id="l22.69">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l22.70"></a><span id="l22.70">       rv = dbPath-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0664);</span>
<a href="#l22.71"></a><span id="l22.71"> </span>
<a href="#l22.72"></a><span id="l22.72">       nsAutoString realFileName;</span>
<a href="#l22.73"></a><span id="l22.73">       rv = dbPath-&gt;GetLeafName(realFileName);</span>
<a href="#l22.74"></a><span id="l22.74"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_jsaddrbook.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_jsaddrbook.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -7,17 +7,16 @@</span>
<a href="#l23.4"></a><span id="l23.4"> var DIR_TYPE = 101;</span>
<a href="#l23.5"></a><span id="l23.5"> var FILE_NAME = &quot;abook-1.sqlite&quot;;</span>
<a href="#l23.6"></a><span id="l23.6"> var SCHEME = &quot;jsaddrbook&quot;;</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l23.9"></a><span id="l23.9">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l23.10"></a><span id="l23.10"> );</span>
<a href="#l23.11"></a><span id="l23.11"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-var { setTimeout } = ChromeUtils.import(&quot;resource://gre/modules/Timer.jsm&quot;);</span>
<a href="#l23.13"></a><span id="l23.13"> </span>
<a href="#l23.14"></a><span id="l23.14"> var book, contact, list, listCard;</span>
<a href="#l23.15"></a><span id="l23.15"> var observer = {</span>
<a href="#l23.16"></a><span id="l23.16">   setUp() {</span>
<a href="#l23.17"></a><span id="l23.17">     MailServices.ab.addAddressBookListener(observer, Ci.nsIAbListener.all);</span>
<a href="#l23.18"></a><span id="l23.18">     Services.obs.addObserver(observer, &quot;addrbook-contact-created&quot;);</span>
<a href="#l23.19"></a><span id="l23.19">     Services.obs.addObserver(observer, &quot;addrbook-contact-updated&quot;);</span>
<a href="#l23.20"></a><span id="l23.20">     Services.obs.addObserver(observer, &quot;addrbook-list-updated&quot;);</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineat">@@ -25,32 +24,47 @@ var observer = {</span>
<a href="#l23.22"></a><span id="l23.22">   },</span>
<a href="#l23.23"></a><span id="l23.23">   cleanUp() {</span>
<a href="#l23.24"></a><span id="l23.24">     MailServices.ab.removeAddressBookListener(observer);</span>
<a href="#l23.25"></a><span id="l23.25">     Services.obs.removeObserver(observer, &quot;addrbook-contact-created&quot;);</span>
<a href="#l23.26"></a><span id="l23.26">     Services.obs.removeObserver(observer, &quot;addrbook-contact-updated&quot;);</span>
<a href="#l23.27"></a><span id="l23.27">     Services.obs.removeObserver(observer, &quot;addrbook-list-updated&quot;);</span>
<a href="#l23.28"></a><span id="l23.28">     Services.obs.removeObserver(observer, &quot;addrbook-list-member-added&quot;);</span>
<a href="#l23.29"></a><span id="l23.29">   },</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineplus">+  promiseEvent() {</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+    return new Promise(resolve =&gt; {</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+      this.eventPromise = resolve;</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineplus">+    });</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+  },</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+  resolveEventPromise() {</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+    if (this.eventPromise) {</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineplus">+      let resolve = this.eventPromise;</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+      delete this.eventPromise;</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineplus">+      resolve();</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineplus">+    }</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineplus">+  },</span>
<a href="#l23.42"></a><span id="l23.42"> </span>
<a href="#l23.43"></a><span id="l23.43">   events: [],</span>
<a href="#l23.44"></a><span id="l23.44">   onItemAdded(parent, item) {</span>
<a href="#l23.45"></a><span id="l23.45">     this.events.push([&quot;onItemAdded&quot;, parent, item]);</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+    this.resolveEventPromise();</span>
<a href="#l23.47"></a><span id="l23.47">   },</span>
<a href="#l23.48"></a><span id="l23.48">   onItemRemoved(parent, item) {</span>
<a href="#l23.49"></a><span id="l23.49">     this.events.push([&quot;onItemRemoved&quot;, parent, item]);</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+    this.resolveEventPromise();</span>
<a href="#l23.51"></a><span id="l23.51">   },</span>
<a href="#l23.52"></a><span id="l23.52">   onItemPropertyChanged(item, property, oldValue, newValue) {</span>
<a href="#l23.53"></a><span id="l23.53">     this.events.push([</span>
<a href="#l23.54"></a><span id="l23.54">       &quot;onItemPropertyChanged&quot;,</span>
<a href="#l23.55"></a><span id="l23.55">       item,</span>
<a href="#l23.56"></a><span id="l23.56">       property,</span>
<a href="#l23.57"></a><span id="l23.57">       oldValue,</span>
<a href="#l23.58"></a><span id="l23.58">       newValue,</span>
<a href="#l23.59"></a><span id="l23.59">     ]);</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+    this.resolveEventPromise();</span>
<a href="#l23.61"></a><span id="l23.61">   },</span>
<a href="#l23.62"></a><span id="l23.62">   observe(subject, topic, data) {</span>
<a href="#l23.63"></a><span id="l23.63">     this.events.push([topic, subject, data]);</span>
<a href="#l23.64"></a><span id="l23.64">   },</span>
<a href="#l23.65"></a><span id="l23.65">   checkEvents(...events) {</span>
<a href="#l23.66"></a><span id="l23.66">     info(</span>
<a href="#l23.67"></a><span id="l23.67">       &quot;Actual events: &quot; +</span>
<a href="#l23.68"></a><span id="l23.68">         JSON.stringify(</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineat">@@ -217,18 +231,17 @@ add_task(async function createContact() </span>
<a href="#l23.70"></a><span id="l23.70">   );</span>
<a href="#l23.71"></a><span id="l23.71"> });</span>
<a href="#l23.72"></a><span id="l23.72"> </span>
<a href="#l23.73"></a><span id="l23.73"> add_task(async function editContact() {</span>
<a href="#l23.74"></a><span id="l23.74">   contact.firstName = &quot;updated&quot;;</span>
<a href="#l23.75"></a><span id="l23.75">   contact.lastName = &quot;contact&quot;;</span>
<a href="#l23.76"></a><span id="l23.76">   book.modifyCard(contact);</span>
<a href="#l23.77"></a><span id="l23.77">   observer.checkEvents(</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineminus">-    // TODO MDB has three null args but we can do better than that.</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineminus">-    [&quot;onItemPropertyChanged&quot;, contact],</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineplus">+    [&quot;onItemPropertyChanged&quot;, contact, &quot;FirstName&quot;, &quot;new&quot;, &quot;updated&quot;],</span>
<a href="#l23.81"></a><span id="l23.81">     [&quot;addrbook-contact-updated&quot;, contact, book.UID]</span>
<a href="#l23.82"></a><span id="l23.82">   );</span>
<a href="#l23.83"></a><span id="l23.83">   equal(contact.firstName, &quot;updated&quot;);</span>
<a href="#l23.84"></a><span id="l23.84">   equal(contact.lastName, &quot;contact&quot;);</span>
<a href="#l23.85"></a><span id="l23.85"> });</span>
<a href="#l23.86"></a><span id="l23.86"> </span>
<a href="#l23.87"></a><span id="l23.87"> add_task(async function createMailingList() {</span>
<a href="#l23.88"></a><span id="l23.88">   list = Cc[&quot;@mozilla.org/addressbook/directoryproperty;1&quot;].createInstance(</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineat">@@ -334,17 +347,17 @@ add_task(async function removeMailingLis</span>
<a href="#l23.90"></a><span id="l23.90"> </span>
<a href="#l23.91"></a><span id="l23.91">   // Check list enumerations.</span>
<a href="#l23.92"></a><span id="l23.92">   equal(Array.from(list.addressLists.enumerate()).length, 0);</span>
<a href="#l23.93"></a><span id="l23.93">   equal(Array.from(list.childNodes).length, 0);</span>
<a href="#l23.94"></a><span id="l23.94">   equal(Array.from(list.childCards).length, 0);</span>
<a href="#l23.95"></a><span id="l23.95"> });</span>
<a href="#l23.96"></a><span id="l23.96"> </span>
<a href="#l23.97"></a><span id="l23.97"> add_task(async function deleteMailingList() {</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineminus">-  MailServices.ab.deleteAddressBook(list.URI);</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineplus">+  book.deleteDirectory(list);</span>
<a href="#l23.100"></a><span id="l23.100">   observer.checkEvents(</span>
<a href="#l23.101"></a><span id="l23.101">     [&quot;onItemRemoved&quot;, book, listCard],</span>
<a href="#l23.102"></a><span id="l23.102">     [&quot;onItemRemoved&quot;, list, listCard],</span>
<a href="#l23.103"></a><span id="l23.103">     [&quot;onItemRemoved&quot;, book, list]</span>
<a href="#l23.104"></a><span id="l23.104">   );</span>
<a href="#l23.105"></a><span id="l23.105"> });</span>
<a href="#l23.106"></a><span id="l23.106"> </span>
<a href="#l23.107"></a><span id="l23.107"> add_task(async function deleteContact() {</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineat">@@ -378,29 +391,28 @@ add_task(async function createContactWit</span>
<a href="#l23.109"></a><span id="l23.109"> </span>
<a href="#l23.110"></a><span id="l23.110">   let cardArray = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l23.111"></a><span id="l23.111">   cardArray.appendElement(contactWithUID);</span>
<a href="#l23.112"></a><span id="l23.112">   book.deleteCards(cardArray);</span>
<a href="#l23.113"></a><span id="l23.113">   observer.events.length = 0;</span>
<a href="#l23.114"></a><span id="l23.114"> });</span>
<a href="#l23.115"></a><span id="l23.115"> </span>
<a href="#l23.116"></a><span id="l23.116"> add_task(async function deleteAddressBook() {</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineplus">+  let deletePromise = observer.promiseEvent();</span>
<a href="#l23.118"></a><span id="l23.118">   MailServices.ab.deleteAddressBook(book.URI);</span>
<a href="#l23.119"></a><span id="l23.119" class="difflineminus">-  // Wait for files to close.</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineminus">-  // eslint-disable-next-line mozilla/no-arbitrary-setTimeout</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineminus">-  await new Promise(resolve =&gt; setTimeout(resolve, 2000));</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineplus">+  await deletePromise;</span>
<a href="#l23.123"></a><span id="l23.123"> </span>
<a href="#l23.124"></a><span id="l23.124">   observer.checkEvents([&quot;onItemRemoved&quot;, undefined, book]);</span>
<a href="#l23.125"></a><span id="l23.125">   ok(!Services.prefs.prefHasUserValue(&quot;ldap_2.servers.newbook.dirType&quot;));</span>
<a href="#l23.126"></a><span id="l23.126">   ok(!Services.prefs.prefHasUserValue(&quot;ldap_2.servers.newbook.description&quot;));</span>
<a href="#l23.127"></a><span id="l23.127">   ok(!Services.prefs.prefHasUserValue(&quot;ldap_2.servers.newbook.filename&quot;));</span>
<a href="#l23.128"></a><span id="l23.128">   ok(!Services.prefs.prefHasUserValue(&quot;ldap_2.servers.newbook.uid&quot;));</span>
<a href="#l23.129"></a><span id="l23.129">   let dbFile = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l23.130"></a><span id="l23.130">   dbFile.append(FILE_NAME);</span>
<a href="#l23.131"></a><span id="l23.131">   ok(!dbFile.exists());</span>
<a href="#l23.132"></a><span id="l23.132">   equal([...MailServices.ab.directories].length, 2);</span>
<a href="#l23.133"></a><span id="l23.133" class="difflineminus">-  throws(() =&gt; MailServices.ab.getDirectory(`${SCHEME}://${FILE_NAME}`), /.*/);</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineplus">+  ok(!MailServices.ab.getDirectory(`${SCHEME}://${FILE_NAME}`));</span>
<a href="#l23.135"></a><span id="l23.135"> });</span>
<a href="#l23.136"></a><span id="l23.136"> </span>
<a href="#l23.137"></a><span id="l23.137"> add_task(async function cleanUp() {</span>
<a href="#l23.138"></a><span id="l23.138">   observer.checkEvents();</span>
<a href="#l23.139"></a><span id="l23.139">   observer.cleanUp();</span>
<a href="#l23.140"></a><span id="l23.140"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_migration8.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_migration8.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -21,16 +21,17 @@ add_task(async function() {</span>
<a href="#l24.4"></a><span id="l24.4">   Services.prefs.setStringPref(</span>
<a href="#l24.5"></a><span id="l24.5">     &quot;ldap_2.servers.ldap_test.uri&quot;,</span>
<a href="#l24.6"></a><span id="l24.6">     &quot;ldap://test.invalid/&quot;</span>
<a href="#l24.7"></a><span id="l24.7">   );</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9">   // Do the migration.</span>
<a href="#l24.10"></a><span id="l24.10"> </span>
<a href="#l24.11"></a><span id="l24.11">   await MailMigrator._migrateAddressBooks();</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+  await new Promise(resolve =&gt; Services.tm.dispatchToMainThread(resolve));</span>
<a href="#l24.13"></a><span id="l24.13"> </span>
<a href="#l24.14"></a><span id="l24.14">   // Check new files have been created, and old ones renamed.</span>
<a href="#l24.15"></a><span id="l24.15"> </span>
<a href="#l24.16"></a><span id="l24.16">   checkFileExists(&quot;ldap.sqlite&quot;, true);</span>
<a href="#l24.17"></a><span id="l24.17">   checkFileExists(&quot;ldap.mab&quot;, false);</span>
<a href="#l24.18"></a><span id="l24.18">   checkFileExists(&quot;ldap.mab.bak&quot;, true);</span>
<a href="#l24.19"></a><span id="l24.19"> </span>
<a href="#l24.20"></a><span id="l24.20">   // Check that the preferences are updated.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_notifications.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_notifications.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -78,19 +78,19 @@ add_test(function() {</span>
<a href="#l25.4"></a><span id="l25.4">   // Test - modify a card</span>
<a href="#l25.5"></a><span id="l25.5"> </span>
<a href="#l25.6"></a><span id="l25.6">   newCard.lastName = &quot;invalid&quot;;</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8">   AB.modifyCard(newCard);</span>
<a href="#l25.9"></a><span id="l25.9"> </span>
<a href="#l25.10"></a><span id="l25.10">   Assert.equal(abListener.result[0][0], &quot;onItemPropertyChanged&quot;);</span>
<a href="#l25.11"></a><span id="l25.11">   Assert.equal(abListener.result[0][1], newCard);</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  Assert.equal(abListener.result[0][2], null);</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+  Assert.equal(abListener.result[0][2], &quot;LastName&quot;);</span>
<a href="#l25.14"></a><span id="l25.14">   Assert.ok(!abListener.result[0][3]);</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-  Assert.ok(!abListener.result[0][4]);</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+  Assert.equal(abListener.result[0][4], &quot;invalid&quot;);</span>
<a href="#l25.17"></a><span id="l25.17">   abListener.result = [];</span>
<a href="#l25.18"></a><span id="l25.18"> </span>
<a href="#l25.19"></a><span id="l25.19">   // Test - delete a card</span>
<a href="#l25.20"></a><span id="l25.20"> </span>
<a href="#l25.21"></a><span id="l25.21">   var cardsToDelete = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(</span>
<a href="#l25.22"></a><span id="l25.22">     Ci.nsIMutableArray</span>
<a href="#l25.23"></a><span id="l25.23">   );</span>
<a href="#l25.24"></a><span id="l25.24"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbManager2.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbManager2.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -16,34 +16,50 @@ function abL() {}</span>
<a href="#l26.4"></a><span id="l26.4"> abL.prototype = {</span>
<a href="#l26.5"></a><span id="l26.5">   mReceived: 0,</span>
<a href="#l26.6"></a><span id="l26.6">   mDirectory: null,</span>
<a href="#l26.7"></a><span id="l26.7">   mAutoRemoveItem: false,</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9">   onItemAdded(parentItem, item) {</span>
<a href="#l26.10"></a><span id="l26.10">     this.mReceived |= nsIAbListener.itemAdded;</span>
<a href="#l26.11"></a><span id="l26.11">     this.mDirectory = item;</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+    this.resolveEventPromise();</span>
<a href="#l26.13"></a><span id="l26.13">     if (this.mAutoRemoveItem) {</span>
<a href="#l26.14"></a><span id="l26.14">       MailServices.ab.removeAddressBookListener(this);</span>
<a href="#l26.15"></a><span id="l26.15">     }</span>
<a href="#l26.16"></a><span id="l26.16">   },</span>
<a href="#l26.17"></a><span id="l26.17">   onItemRemoved(parentItem, item) {</span>
<a href="#l26.18"></a><span id="l26.18">     this.mReceived |= nsIAbListener.directoryRemoved;</span>
<a href="#l26.19"></a><span id="l26.19">     this.mDirectory = item;</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+    this.resolveEventPromise();</span>
<a href="#l26.21"></a><span id="l26.21">     if (this.mAutoRemoveItem) {</span>
<a href="#l26.22"></a><span id="l26.22">       MailServices.ab.removeAddressBookListener(this);</span>
<a href="#l26.23"></a><span id="l26.23">     }</span>
<a href="#l26.24"></a><span id="l26.24">   },</span>
<a href="#l26.25"></a><span id="l26.25">   onItemPropertyChanged(item, property, oldValue, newValue) {</span>
<a href="#l26.26"></a><span id="l26.26">     this.mReceived |= nsIAbListener.itemChanged;</span>
<a href="#l26.27"></a><span id="l26.27">     this.mDirectory = item;</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineplus">+    this.resolveEventPromise();</span>
<a href="#l26.29"></a><span id="l26.29">     if (this.mAutoRemoveItem) {</span>
<a href="#l26.30"></a><span id="l26.30">       MailServices.ab.removeAddressBookListener(this);</span>
<a href="#l26.31"></a><span id="l26.31">     }</span>
<a href="#l26.32"></a><span id="l26.32">   },</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+  promiseEvent() {</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineplus">+    return new Promise(resolve =&gt; {</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+      this.mEventPromise = resolve;</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineplus">+    });</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+  },</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineplus">+  resolveEventPromise() {</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineplus">+    if (this.mEventPromise) {</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineplus">+      let resolve = this.mEventPromise;</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineplus">+      delete this.mEventPromise;</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineplus">+      resolve();</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineplus">+    }</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineplus">+  },</span>
<a href="#l26.46"></a><span id="l26.46"> };</span>
<a href="#l26.47"></a><span id="l26.47"> </span>
<a href="#l26.48"></a><span id="l26.48"> function checkDirs(aDirs, aDirArray) {</span>
<a href="#l26.49"></a><span id="l26.49">   // Don't modify the passed in array.</span>
<a href="#l26.50"></a><span id="l26.50">   var dirArray = aDirArray.concat();</span>
<a href="#l26.51"></a><span id="l26.51"> </span>
<a href="#l26.52"></a><span id="l26.52">   for (let dir of aDirs) {</span>
<a href="#l26.53"></a><span id="l26.53">     var loc = dirArray.indexOf(dir.URI);</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineat">@@ -83,19 +99,21 @@ function addDirectory(dirName) {</span>
<a href="#l26.55"></a><span id="l26.55">     } else {</span>
<a href="#l26.56"></a><span id="l26.56">       Assert.equal(gAblSingle[i].mReceived, 0);</span>
<a href="#l26.57"></a><span id="l26.57">     }</span>
<a href="#l26.58"></a><span id="l26.58">   }</span>
<a href="#l26.59"></a><span id="l26.59"> </span>
<a href="#l26.60"></a><span id="l26.60">   return newDirectory;</span>
<a href="#l26.61"></a><span id="l26.61"> }</span>
<a href="#l26.62"></a><span id="l26.62"> </span>
<a href="#l26.63"></a><span id="l26.63" class="difflineminus">-function removeDirectory(directory) {</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineplus">+async function removeDirectory(directory) {</span>
<a href="#l26.65"></a><span id="l26.65">   // Remove the directory</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineplus">+  let deletePromise = gAblAll.promiseEvent();</span>
<a href="#l26.67"></a><span id="l26.67">   MailServices.ab.deleteAddressBook(directory.URI);</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineplus">+  await deletePromise;</span>
<a href="#l26.69"></a><span id="l26.69"> </span>
<a href="#l26.70"></a><span id="l26.70">   // Check correct notifications</span>
<a href="#l26.71"></a><span id="l26.71">   Assert.equal(gAblAll.mReceived, nsIAbListener.directoryRemoved);</span>
<a href="#l26.72"></a><span id="l26.72">   Assert.equal(gAblAll.mDirectory, directory);</span>
<a href="#l26.73"></a><span id="l26.73"> </span>
<a href="#l26.74"></a><span id="l26.74">   gAblAll.mReceived = 0;</span>
<a href="#l26.75"></a><span id="l26.75">   gAblAll.mDirectory = null;</span>
<a href="#l26.76"></a><span id="l26.76"> </span>
<a href="#l26.77"></a><span id="l26.77" class="difflineat">@@ -104,17 +122,17 @@ function removeDirectory(directory) {</span>
<a href="#l26.78"></a><span id="l26.78">       Assert.equal(gAblSingle[i].mReceived, nsIAbListener.directoryRemoved);</span>
<a href="#l26.79"></a><span id="l26.79">       gAblSingle[i].mReceived = 0;</span>
<a href="#l26.80"></a><span id="l26.80">     } else {</span>
<a href="#l26.81"></a><span id="l26.81">       Assert.equal(gAblSingle[i].mReceived, 0);</span>
<a href="#l26.82"></a><span id="l26.82">     }</span>
<a href="#l26.83"></a><span id="l26.83">   }</span>
<a href="#l26.84"></a><span id="l26.84"> }</span>
<a href="#l26.85"></a><span id="l26.85"> </span>
<a href="#l26.86"></a><span id="l26.86" class="difflineminus">-function run_test() {</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineplus">+async function run_test() {</span>
<a href="#l26.88"></a><span id="l26.88">   var i;</span>
<a href="#l26.89"></a><span id="l26.89"> </span>
<a href="#l26.90"></a><span id="l26.90">   // Set up listeners</span>
<a href="#l26.91"></a><span id="l26.91">   gAblAll = new abL();</span>
<a href="#l26.92"></a><span id="l26.92">   MailServices.ab.addAddressBookListener(gAblAll, nsIAbListener.all);</span>
<a href="#l26.93"></a><span id="l26.93"> </span>
<a href="#l26.94"></a><span id="l26.94">   for (i = 0; i &lt; numListenerOptions; ++i) {</span>
<a href="#l26.95"></a><span id="l26.95">     gAblSingle[i] = new abL();</span>
<a href="#l26.96"></a><span id="l26.96" class="difflineat">@@ -146,26 +164,26 @@ function run_test() {</span>
<a href="#l26.97"></a><span id="l26.97">   checkDirs(MailServices.ab.directories, expectedABs);</span>
<a href="#l26.98"></a><span id="l26.98"> </span>
<a href="#l26.99"></a><span id="l26.99">   // Test - Remove a directory</span>
<a href="#l26.100"></a><span id="l26.100"> </span>
<a href="#l26.101"></a><span id="l26.101">   var pos = expectedABs.indexOf(newDirectory1.URI);</span>
<a href="#l26.102"></a><span id="l26.102"> </span>
<a href="#l26.103"></a><span id="l26.103">   expectedABs.splice(pos, 1);</span>
<a href="#l26.104"></a><span id="l26.104"> </span>
<a href="#l26.105"></a><span id="l26.105" class="difflineminus">-  removeDirectory(newDirectory1);</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineplus">+  await removeDirectory(newDirectory1);</span>
<a href="#l26.107"></a><span id="l26.107">   newDirectory1 = null;</span>
<a href="#l26.108"></a><span id="l26.108"> </span>
<a href="#l26.109"></a><span id="l26.109">   // Test - Check new directory list</span>
<a href="#l26.110"></a><span id="l26.110"> </span>
<a href="#l26.111"></a><span id="l26.111">   checkDirs(MailServices.ab.directories, expectedABs);</span>
<a href="#l26.112"></a><span id="l26.112"> </span>
<a href="#l26.113"></a><span id="l26.113">   // Test - Repeat the removal</span>
<a href="#l26.114"></a><span id="l26.114"> </span>
<a href="#l26.115"></a><span id="l26.115" class="difflineminus">-  removeDirectory(newDirectory2);</span>
<a href="#l26.116"></a><span id="l26.116" class="difflineplus">+  await removeDirectory(newDirectory2);</span>
<a href="#l26.117"></a><span id="l26.117">   newDirectory2 = null;</span>
<a href="#l26.118"></a><span id="l26.118"> </span>
<a href="#l26.119"></a><span id="l26.119">   expectedABs.pop();</span>
<a href="#l26.120"></a><span id="l26.120"> </span>
<a href="#l26.121"></a><span id="l26.121">   // Test - Check new directory list</span>
<a href="#l26.122"></a><span id="l26.122">   checkDirs(MailServices.ab.directories, expectedABs);</span>
<a href="#l26.123"></a><span id="l26.123"> </span>
<a href="#l26.124"></a><span id="l26.124">   // Test - Clear the listeners down</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_nsAbManager3.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbManager3.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -12,32 +12,48 @@ function abListener() {}</span>
<a href="#l27.4"></a><span id="l27.4"> </span>
<a href="#l27.5"></a><span id="l27.5"> abListener.prototype = {</span>
<a href="#l27.6"></a><span id="l27.6">   mReceived: 0,</span>
<a href="#l27.7"></a><span id="l27.7">   mDirectory: null,</span>
<a href="#l27.8"></a><span id="l27.8"> </span>
<a href="#l27.9"></a><span id="l27.9">   onItemAdded(aParentItem, aItem) {</span>
<a href="#l27.10"></a><span id="l27.10">     this.mReceived |= Ci.nsIAbListener.itemAdded;</span>
<a href="#l27.11"></a><span id="l27.11">     this.mDirectory = aItem;</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+    this.resolveEventPromise();</span>
<a href="#l27.13"></a><span id="l27.13">   },</span>
<a href="#l27.14"></a><span id="l27.14"> </span>
<a href="#l27.15"></a><span id="l27.15">   onItemRemoved(aParentItem, aItem) {</span>
<a href="#l27.16"></a><span id="l27.16">     this.mReceived |= Ci.nsIAbListener.directoryRemoved;</span>
<a href="#l27.17"></a><span id="l27.17">     this.mDirectory = aItem;</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineplus">+    this.resolveEventPromise();</span>
<a href="#l27.19"></a><span id="l27.19">   },</span>
<a href="#l27.20"></a><span id="l27.20"> </span>
<a href="#l27.21"></a><span id="l27.21">   onItemPropertyChanged(aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l27.22"></a><span id="l27.22">     this.mReceived |= Ci.nsIAbListener.itemChanged;</span>
<a href="#l27.23"></a><span id="l27.23">     this.mDirectory = aItem;</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineplus">+    this.resolveEventPromise();</span>
<a href="#l27.25"></a><span id="l27.25">   },</span>
<a href="#l27.26"></a><span id="l27.26"> </span>
<a href="#l27.27"></a><span id="l27.27">   reset() {</span>
<a href="#l27.28"></a><span id="l27.28">     this.mReceived = 0;</span>
<a href="#l27.29"></a><span id="l27.29">     this.mDirectory = null;</span>
<a href="#l27.30"></a><span id="l27.30">   },</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineplus">+</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+  promiseEvent() {</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineplus">+    return new Promise(resolve =&gt; {</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineplus">+      this.mEventPromise = resolve;</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineplus">+    });</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineplus">+  },</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineplus">+  resolveEventPromise() {</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineplus">+    if (this.mEventPromise) {</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineplus">+      let resolve = this.mEventPromise;</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineplus">+      delete this.mEventPromise;</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineplus">+      resolve();</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineplus">+    }</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineplus">+  },</span>
<a href="#l27.44"></a><span id="l27.44"> };</span>
<a href="#l27.45"></a><span id="l27.45"> </span>
<a href="#l27.46"></a><span id="l27.46"> function addDirectory(dirName) {</span>
<a href="#l27.47"></a><span id="l27.47">   MailServices.ab.newAddressBook(dirName, &quot;&quot;, kPABData.dirType);</span>
<a href="#l27.48"></a><span id="l27.48"> </span>
<a href="#l27.49"></a><span id="l27.49">   Assert.equal(gAbListener.mReceived, Ci.nsIAbListener.itemAdded);</span>
<a href="#l27.50"></a><span id="l27.50"> </span>
<a href="#l27.51"></a><span id="l27.51">   let newDirectory = gAbListener.mDirectory.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineat">@@ -52,33 +68,35 @@ function renameDirectory(directory, newN</span>
<a href="#l27.53"></a><span id="l27.53">   directory.dirName = newName;</span>
<a href="#l27.54"></a><span id="l27.54"> </span>
<a href="#l27.55"></a><span id="l27.55">   Assert.equal(gAbListener.mReceived, Ci.nsIAbListener.itemChanged);</span>
<a href="#l27.56"></a><span id="l27.56">   Assert.equal(gAbListener.mDirectory, directory);</span>
<a href="#l27.57"></a><span id="l27.57"> </span>
<a href="#l27.58"></a><span id="l27.58">   gAbListener.reset();</span>
<a href="#l27.59"></a><span id="l27.59"> }</span>
<a href="#l27.60"></a><span id="l27.60"> </span>
<a href="#l27.61"></a><span id="l27.61" class="difflineminus">-function removeDirectory(directory) {</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineplus">+async function removeDirectory(directory) {</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineplus">+  let deletePromise = gAbListener.promiseEvent();</span>
<a href="#l27.64"></a><span id="l27.64">   MailServices.ab.deleteAddressBook(directory.URI);</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineplus">+  await deletePromise;</span>
<a href="#l27.66"></a><span id="l27.66"> </span>
<a href="#l27.67"></a><span id="l27.67">   Assert.equal(gAbListener.mReceived, Ci.nsIAbListener.directoryRemoved);</span>
<a href="#l27.68"></a><span id="l27.68">   Assert.equal(</span>
<a href="#l27.69"></a><span id="l27.69">     gAbListener.mDirectory,</span>
<a href="#l27.70"></a><span id="l27.70">     directory.QueryInterface(Ci.nsIAbDirectory)</span>
<a href="#l27.71"></a><span id="l27.71">   );</span>
<a href="#l27.72"></a><span id="l27.72"> </span>
<a href="#l27.73"></a><span id="l27.73">   gAbListener.reset();</span>
<a href="#l27.74"></a><span id="l27.74"> }</span>
<a href="#l27.75"></a><span id="l27.75"> </span>
<a href="#l27.76"></a><span id="l27.76"> /**</span>
<a href="#l27.77"></a><span id="l27.77">  * Create 4 addressbooks (directories). Rename the second one and delete</span>
<a href="#l27.78"></a><span id="l27.78">  * the third one. Check if their names are still correct. (bug 745664)</span>
<a href="#l27.79"></a><span id="l27.79">  */</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineminus">-function run_test() {</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineplus">+async function run_test() {</span>
<a href="#l27.82"></a><span id="l27.82">   gAbListener = new abListener();</span>
<a href="#l27.83"></a><span id="l27.83">   MailServices.ab.addAddressBookListener(gAbListener, Ci.nsIAbListener.all);</span>
<a href="#l27.84"></a><span id="l27.84">   registerCleanupFunction(function() {</span>
<a href="#l27.85"></a><span id="l27.85">     MailServices.ab.removeAddressBookListener(gAbListener);</span>
<a href="#l27.86"></a><span id="l27.86">   });</span>
<a href="#l27.87"></a><span id="l27.87"> </span>
<a href="#l27.88"></a><span id="l27.88">   let dirNames = [&quot;testAb0&quot;, &quot;testAb1&quot;, &quot;testAb2&quot;, &quot;testAb3&quot;];</span>
<a href="#l27.89"></a><span id="l27.89">   let directories = [];</span>
<a href="#l27.90"></a><span id="l27.90" class="difflineat">@@ -87,16 +105,16 @@ function run_test() {</span>
<a href="#l27.91"></a><span id="l27.91">     directories.push(addDirectory(dirName));</span>
<a href="#l27.92"></a><span id="l27.92">   }</span>
<a href="#l27.93"></a><span id="l27.93"> </span>
<a href="#l27.94"></a><span id="l27.94">   dirNames[1] = &quot;newTestAb1&quot;;</span>
<a href="#l27.95"></a><span id="l27.95">   renameDirectory(directories[1], dirNames[1]);</span>
<a href="#l27.96"></a><span id="l27.96">   for (let dir in dirNames) {</span>
<a href="#l27.97"></a><span id="l27.97">     Assert.equal(dirNames[dir], directories[dir].dirName);</span>
<a href="#l27.98"></a><span id="l27.98">   }</span>
<a href="#l27.99"></a><span id="l27.99" class="difflineminus">-  removeDirectory(directories[2]);</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineplus">+  await removeDirectory(directories[2]);</span>
<a href="#l27.101"></a><span id="l27.101">   dirNames.splice(2, 1);</span>
<a href="#l27.102"></a><span id="l27.102">   directories.splice(2, 1);</span>
<a href="#l27.103"></a><span id="l27.103"> </span>
<a href="#l27.104"></a><span id="l27.104">   for (let dir in dirNames) {</span>
<a href="#l27.105"></a><span id="l27.105">     Assert.equal(dirNames[dir], directories[dir].dirName);</span>
<a href="#l27.106"></a><span id="l27.106">   }</span>
<a href="#l27.107"></a><span id="l27.107"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">new file mode 100644</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineminus">--- /dev/null</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_nsAbManager4.js</span>
<a href="#l28.4"></a><span id="l28.4" class="difflineat">@@ -0,0 +1,20 @@</span>
<a href="#l28.5"></a><span id="l28.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.6"></a><span id="l28.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.7"></a><span id="l28.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.8"></a><span id="l28.8" class="difflineplus">+</span>
<a href="#l28.9"></a><span id="l28.9" class="difflineplus">+// Creating a new address book with the same name as an existing one should</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineplus">+// always produce a unique preference branch. Check that it does.</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineplus">+</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+function run_test() {</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+  let name0 = MailServices.ab.newAddressBook(&quot;name&quot;, null, kPABData.dirType);</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+  equal(name0, &quot;ldap_2.servers.name&quot;);</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+  let name1 = MailServices.ab.newAddressBook(&quot;name&quot;, null, kPABData.dirType);</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+  equal(name1, &quot;ldap_2.servers.name_1&quot;);</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+  let name2 = MailServices.ab.newAddressBook(&quot;name&quot;, null, kPABData.dirType);</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineplus">+  equal(name2, &quot;ldap_2.servers.name_2&quot;);</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineplus">+</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineplus">+  let name3 = MailServices.ab.newAddressBook(&quot;name&quot;, null, kPABData.dirType);</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineplus">+  equal(name3, &quot;ldap_2.servers.name_3&quot;);</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/xpcshell.ini</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/xpcshell.ini</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -1,35 +1,42 @@</span>
<a href="#l29.4"></a><span id="l29.4"> [DEFAULT]</span>
<a href="#l29.5"></a><span id="l29.5"> head = head.js</span>
<a href="#l29.6"></a><span id="l29.6"> support-files = data/*</span>
<a href="#l29.7"></a><span id="l29.7"> </span>
<a href="#l29.8"></a><span id="l29.8"> [test_basic_nsIAbCard.js]</span>
<a href="#l29.9"></a><span id="l29.9"> [test_basic_nsIAbDirectory.js]</span>
<a href="#l29.10"></a><span id="l29.10"> [test_bug387403.js]</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineplus">+fail-if = true</span>
<a href="#l29.12"></a><span id="l29.12"> [test_bug448165.js]</span>
<a href="#l29.13"></a><span id="l29.13"> [test_bug534822.js]</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+fail-if = true</span>
<a href="#l29.15"></a><span id="l29.15"> [test_bug1522453.js]</span>
<a href="#l29.16"></a><span id="l29.16"> [test_cardForEmail.js]</span>
<a href="#l29.17"></a><span id="l29.17"> [test_collection.js]</span>
<a href="#l29.18"></a><span id="l29.18"> [test_collection_2.js]</span>
<a href="#l29.19"></a><span id="l29.19"> [test_db_enumerator.js]</span>
<a href="#l29.20"></a><span id="l29.20"> [test_jsaddrbook.js]</span>
<a href="#l29.21"></a><span id="l29.21"> [test_jsaddrbook_inner.js]</span>
<a href="#l29.22"></a><span id="l29.22"> [test_ldap1.js]</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+fail-if = true</span>
<a href="#l29.24"></a><span id="l29.24"> [test_ldap2.js]</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineplus">+fail-if = true</span>
<a href="#l29.26"></a><span id="l29.26"> [test_ldapOffline.js]</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+fail-if = true</span>
<a href="#l29.28"></a><span id="l29.28"> [test_ldapReplication.js]</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineplus">+fail-if = true</span>
<a href="#l29.30"></a><span id="l29.30"> skip-if = debug # Fails for unknown reasons.</span>
<a href="#l29.31"></a><span id="l29.31"> [test_mailList1.js]</span>
<a href="#l29.32"></a><span id="l29.32"> [test_notifications.js]</span>
<a href="#l29.33"></a><span id="l29.33"> [test_nsAbAutoCompleteMyDomain.js]</span>
<a href="#l29.34"></a><span id="l29.34"> [test_nsAbAutoCompleteSearch1.js]</span>
<a href="#l29.35"></a><span id="l29.35"> [test_nsAbAutoCompleteSearch2.js]</span>
<a href="#l29.36"></a><span id="l29.36"> [test_nsAbAutoCompleteSearch3.js]</span>
<a href="#l29.37"></a><span id="l29.37"> [test_nsAbAutoCompleteSearch4.js]</span>
<a href="#l29.38"></a><span id="l29.38"> [test_nsAbAutoCompleteSearch5.js]</span>
<a href="#l29.39"></a><span id="l29.39"> [test_nsAbAutoCompleteSearch6.js]</span>
<a href="#l29.40"></a><span id="l29.40"> [test_nsAbAutoCompleteSearch7.js]</span>
<a href="#l29.41"></a><span id="l29.41"> [test_nsAbManager1.js]</span>
<a href="#l29.42"></a><span id="l29.42"> [test_nsAbManager2.js]</span>
<a href="#l29.43"></a><span id="l29.43"> [test_nsAbManager3.js]</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineplus">+[test_nsAbManager4.js]</span>
<a href="#l29.45"></a><span id="l29.45"> [test_nsIAbCard.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/xpcshell_migration.ini</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/xpcshell_migration.ini</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -5,8 +5,9 @@ support-files = data/*</span>
<a href="#l30.4"></a><span id="l30.4"> [test_migration1.js]</span>
<a href="#l30.5"></a><span id="l30.5"> [test_migration2.js]</span>
<a href="#l30.6"></a><span id="l30.6"> [test_migration3.js]</span>
<a href="#l30.7"></a><span id="l30.7"> [test_migration4.js]</span>
<a href="#l30.8"></a><span id="l30.8"> [test_migration5.js]</span>
<a href="#l30.9"></a><span id="l30.9"> [test_migration6.js]</span>
<a href="#l30.10"></a><span id="l30.10"> [test_migration7.js]</span>
<a href="#l30.11"></a><span id="l30.11"> [test_migration8.js]</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+fail-if = true</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/build/nsMailModule.cpp</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/build/nsMailModule.cpp</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -109,17 +109,17 @@</span>
<a href="#l31.4"></a><span id="l31.4"> </span>
<a href="#l31.5"></a><span id="l31.5"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.6"></a><span id="l31.6"> // addrbook includes</span>
<a href="#l31.7"></a><span id="l31.7"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.8"></a><span id="l31.8"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l31.9"></a><span id="l31.9"> #include &quot;nsAbBSDirectory.h&quot;</span>
<a href="#l31.10"></a><span id="l31.10"> #include &quot;nsAbDirFactoryService.h&quot;</span>
<a href="#l31.11"></a><span id="l31.11"> #include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-#include &quot;nsAbManager.h&quot;</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+// #include &quot;nsAbManager.h&quot;</span>
<a href="#l31.14"></a><span id="l31.14"> #include &quot;nsAbContentHandler.h&quot;</span>
<a href="#l31.15"></a><span id="l31.15"> #include &quot;nsAbDirProperty.h&quot;</span>
<a href="#l31.16"></a><span id="l31.16"> #include &quot;nsAbAddressCollector.h&quot;</span>
<a href="#l31.17"></a><span id="l31.17"> #include &quot;nsAddbookProtocolHandler.h&quot;</span>
<a href="#l31.18"></a><span id="l31.18"> #include &quot;nsAddbookUrl.h&quot;</span>
<a href="#l31.19"></a><span id="l31.19"> </span>
<a href="#l31.20"></a><span id="l31.20"> #include &quot;nsAbDirectoryQuery.h&quot;</span>
<a href="#l31.21"></a><span id="l31.21"> #include &quot;nsAbBooleanExpression.h&quot;</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineat">@@ -429,17 +429,16 @@ NS_DEFINE_NAMED_CID(NS_MSGCONTENTPOLICY_</span>
<a href="#l31.23"></a><span id="l31.23"> NS_DEFINE_NAMED_CID(NS_MSGSHUTDOWNSERVICE_CID);</span>
<a href="#l31.24"></a><span id="l31.24"> NS_DEFINE_NAMED_CID(MAILDIRPROVIDER_CID);</span>
<a href="#l31.25"></a><span id="l31.25"> NS_DEFINE_NAMED_CID(NS_STOPWATCH_CID);</span>
<a href="#l31.26"></a><span id="l31.26"> NS_DEFINE_NAMED_CID(NS_MAILNEWSDLF_CID);</span>
<a href="#l31.27"></a><span id="l31.27"> </span>
<a href="#l31.28"></a><span id="l31.28"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.29"></a><span id="l31.29"> // addrbook factories</span>
<a href="#l31.30"></a><span id="l31.30"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsAbManager, Init)</span>
<a href="#l31.32"></a><span id="l31.32"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbContentHandler)</span>
<a href="#l31.33"></a><span id="l31.33"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbDirProperty)</span>
<a href="#l31.34"></a><span id="l31.34"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbCardProperty)</span>
<a href="#l31.35"></a><span id="l31.35"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbBSDirectory)</span>
<a href="#l31.36"></a><span id="l31.36"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAddrDatabase)</span>
<a href="#l31.37"></a><span id="l31.37"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsAbAddressCollector, Init)</span>
<a href="#l31.38"></a><span id="l31.38"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAddbookUrl)</span>
<a href="#l31.39"></a><span id="l31.39"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbDirFactoryService)</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineat">@@ -892,17 +891,17 @@ const mozilla::Module::CIDEntry kMailNew</span>
<a href="#l31.41"></a><span id="l31.41">     {&amp;kNS_MESSENGERCONTENTHANDLER_CID, false, NULL,</span>
<a href="#l31.42"></a><span id="l31.42">      nsMessengerContentHandlerConstructor},</span>
<a href="#l31.43"></a><span id="l31.43">     {&amp;kNS_MSGCONTENTPOLICY_CID, false, NULL, nsMsgContentPolicyConstructor},</span>
<a href="#l31.44"></a><span id="l31.44">     {&amp;kNS_MSGSHUTDOWNSERVICE_CID, false, NULL, nsMsgShutdownServiceConstructor},</span>
<a href="#l31.45"></a><span id="l31.45">     {&amp;kMAILDIRPROVIDER_CID, false, NULL, nsMailDirProviderConstructor},</span>
<a href="#l31.46"></a><span id="l31.46">     {&amp;kNS_STOPWATCH_CID, false, NULL, nsStopwatchConstructor},</span>
<a href="#l31.47"></a><span id="l31.47">     {&amp;kNS_MAILNEWSDLF_CID, false, NULL, MailNewsDLFConstructor},</span>
<a href="#l31.48"></a><span id="l31.48">     // Address Book Entries</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineminus">-    {&amp;kNS_ABMANAGER_CID, false, NULL, nsAbManagerConstructor},</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineplus">+    // {&amp;kNS_ABMANAGER_CID, false, NULL, nsAbManagerConstructor},</span>
<a href="#l31.51"></a><span id="l31.51">     {&amp;kNS_ABDIRECTORY_CID, false, NULL, nsAbBSDirectoryConstructor},</span>
<a href="#l31.52"></a><span id="l31.52">     {&amp;kNS_ADDRDATABASE_CID, false, NULL, nsAddrDatabaseConstructor},</span>
<a href="#l31.53"></a><span id="l31.53">     {&amp;kNS_ABCARDPROPERTY_CID, false, NULL, nsAbCardPropertyConstructor},</span>
<a href="#l31.54"></a><span id="l31.54">     {&amp;kNS_ABDIRPROPERTY_CID, false, NULL, nsAbDirPropertyConstructor},</span>
<a href="#l31.55"></a><span id="l31.55">     {&amp;kNS_ABADDRESSCOLLECTOR_CID, false, NULL, nsAbAddressCollectorConstructor},</span>
<a href="#l31.56"></a><span id="l31.56">     {&amp;kNS_ADDBOOKURL_CID, false, NULL, nsAddbookUrlConstructor},</span>
<a href="#l31.57"></a><span id="l31.57">     {&amp;kNS_ADDBOOK_HANDLER_CID, false, NULL,</span>
<a href="#l31.58"></a><span id="l31.58">      nsAddbookProtocolHandlerConstructor},</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -4430,16 +4430,60 @@ nsresult nsMsgCompose::GetABDirAndMailLi</span>
<a href="#l32.4"></a><span id="l32.4">     nsTArray&lt;nsMsgMailList&gt; &amp;aMailListArray) {</span>
<a href="#l32.5"></a><span id="l32.5">   static bool collectedAddressbookFound = false;</span>
<a href="#l32.6"></a><span id="l32.6"> </span>
<a href="#l32.7"></a><span id="l32.7">   nsresult rv;</span>
<a href="#l32.8"></a><span id="l32.8">   nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l32.9"></a><span id="l32.9">       do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l32.10"></a><span id="l32.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+  if (aDirUri.Equals(kAllDirectoryRoot)) {</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+    nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+    rv = abManager-&gt;GetDirectories(getter_AddRefs(enumerator));</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineplus">+    nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineplus">+    nsCString uri;</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineplus">+    bool hasMore;</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineplus">+</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineplus">+    while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineplus">+      rv = enumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineplus">+      directory = do_QueryInterface(supports);</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineplus">+      if (directory) {</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineplus">+        nsCString uri;</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineplus">+        rv = directory-&gt;GetURI(uri);</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineplus">+</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineplus">+        int32_t pos;</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+        if (uri.EqualsLiteral(kPersonalAddressbookUri))</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineplus">+          pos = 0;</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+        else {</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineplus">+          uint32_t count = aDirArray.Count();</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineplus">+</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineplus">+          if (uri.EqualsLiteral(kCollectedAddressbookUri)) {</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineplus">+            collectedAddressbookFound = true;</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineplus">+            pos = count;</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineplus">+          } else {</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineplus">+            if (collectedAddressbookFound &amp;&amp; count &gt; 1)</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineplus">+              pos = count - 1;</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineplus">+            else</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineplus">+              pos = count;</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineplus">+          }</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineplus">+        }</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineplus">+</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineplus">+        aDirArray.InsertObjectAt(directory, pos);</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineplus">+        rv = GetABDirAndMailLists(uri, aDirArray, aMailListArray);</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+      }</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+    }</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineplus">+</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineplus">+  }</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineplus">+</span>
<a href="#l32.56"></a><span id="l32.56">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l32.57"></a><span id="l32.57">   rv = abManager-&gt;GetDirectory(aDirUri, getter_AddRefs(directory));</span>
<a href="#l32.58"></a><span id="l32.58">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.59"></a><span id="l32.59"> </span>
<a href="#l32.60"></a><span id="l32.60">   nsCOMPtr&lt;nsISimpleEnumerator&gt; subDirectories;</span>
<a href="#l32.61"></a><span id="l32.61">   if (NS_SUCCEEDED(directory-&gt;GetChildNodes(getter_AddRefs(subDirectories))) &amp;&amp;</span>
<a href="#l32.62"></a><span id="l32.62">       subDirectories) {</span>
<a href="#l32.63"></a><span id="l32.63">     nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineat">@@ -4449,42 +4493,17 @@ nsresult nsMsgCompose::GetABDirAndMailLi</span>
<a href="#l32.65"></a><span id="l32.65">       if (NS_SUCCEEDED(subDirectories-&gt;GetNext(getter_AddRefs(item)))) {</span>
<a href="#l32.66"></a><span id="l32.66">         directory = do_QueryInterface(item, &amp;rv);</span>
<a href="#l32.67"></a><span id="l32.67">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l32.68"></a><span id="l32.68">           bool bIsMailList;</span>
<a href="#l32.69"></a><span id="l32.69"> </span>
<a href="#l32.70"></a><span id="l32.70">           if (NS_SUCCEEDED(directory-&gt;GetIsMailList(&amp;bIsMailList)) &amp;&amp;</span>
<a href="#l32.71"></a><span id="l32.71">               bIsMailList) {</span>
<a href="#l32.72"></a><span id="l32.72">             aMailListArray.AppendElement(directory);</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineminus">-            continue;</span>
<a href="#l32.74"></a><span id="l32.74">           }</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineminus">-</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineminus">-          nsCString uri;</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineminus">-          rv = directory-&gt;GetURI(uri);</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineminus">-</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineminus">-          int32_t pos;</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineminus">-          if (uri.EqualsLiteral(kPersonalAddressbookUri))</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineminus">-            pos = 0;</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineminus">-          else {</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineminus">-            uint32_t count = aDirArray.Count();</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineminus">-</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineminus">-            if (uri.EqualsLiteral(kCollectedAddressbookUri)) {</span>
<a href="#l32.87"></a><span id="l32.87" class="difflineminus">-              collectedAddressbookFound = true;</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineminus">-              pos = count;</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineminus">-            } else {</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineminus">-              if (collectedAddressbookFound &amp;&amp; count &gt; 1)</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineminus">-                pos = count - 1;</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineminus">-              else</span>
<a href="#l32.93"></a><span id="l32.93" class="difflineminus">-                pos = count;</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineminus">-            }</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineminus">-          }</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineminus">-</span>
<a href="#l32.97"></a><span id="l32.97" class="difflineminus">-          aDirArray.InsertObjectAt(directory, pos);</span>
<a href="#l32.98"></a><span id="l32.98" class="difflineminus">-          rv = GetABDirAndMailLists(uri, aDirArray, aMailListArray);</span>
<a href="#l32.99"></a><span id="l32.99">         }</span>
<a href="#l32.100"></a><span id="l32.100">       }</span>
<a href="#l32.101"></a><span id="l32.101">     }</span>
<a href="#l32.102"></a><span id="l32.102">   }</span>
<a href="#l32.103"></a><span id="l32.103">   return rv;</span>
<a href="#l32.104"></a><span id="l32.104"> }</span>
<a href="#l32.105"></a><span id="l32.105"> </span>
<a href="#l32.106"></a><span id="l32.106"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/import/src/nsImportAddressBooks.cpp</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/import/src/nsImportAddressBooks.cpp</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -407,17 +407,20 @@ NS_IMETHODIMP nsImportGenericAddressBook</span>
<a href="#l33.4"></a><span id="l33.4">   m_pThreadData-&gt;successLog = m_pSuccessLog;</span>
<a href="#l33.5"></a><span id="l33.5">   m_pThreadData-&gt;pDestinationUri = m_pDestinationUri;</span>
<a href="#l33.6"></a><span id="l33.6"> </span>
<a href="#l33.7"></a><span id="l33.7">   uint32_t count = 0;</span>
<a href="#l33.8"></a><span id="l33.8">   m_Books-&gt;GetLength(&amp;count);</span>
<a href="#l33.9"></a><span id="l33.9">   // Create/obtain any address books that we need here, so that we don't need</span>
<a href="#l33.10"></a><span id="l33.10">   // to do so inside the import thread which would just proxy the create</span>
<a href="#l33.11"></a><span id="l33.11">   // operations back to the main thread anyway.</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; db = GetAddressBookFromUri(m_pDestinationUri.get());</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; db;</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+  if (!m_pDestinationUri.IsEmpty()) {</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+    db = GetAddressBookFromUri(m_pDestinationUri.get());</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+  }</span>
<a href="#l33.17"></a><span id="l33.17">   for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l33.18"></a><span id="l33.18">     nsCOMPtr&lt;nsIImportABDescriptor&gt; book = do_QueryElementAt(m_Books, i);</span>
<a href="#l33.19"></a><span id="l33.19">     if (book) {</span>
<a href="#l33.20"></a><span id="l33.20">       if (!db) {</span>
<a href="#l33.21"></a><span id="l33.21">         nsString name;</span>
<a href="#l33.22"></a><span id="l33.22">         book-&gt;GetPreferredName(name);</span>
<a href="#l33.23"></a><span id="l33.23">         db = GetAddressBook(name, true);</span>
<a href="#l33.24"></a><span id="l33.24">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/import/test/unit/resources/import_helper.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/import/test/unit/resources/import_helper.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -274,18 +274,18 @@ AbImportHelper.prototype = {</span>
<a href="#l34.4"></a><span id="l34.4">     // When do_test_pending() was called and there is an error the test hangs.</span>
<a href="#l34.5"></a><span id="l34.5">     // This try/catch block will catch any errors and call do_throw() with the</span>
<a href="#l34.6"></a><span id="l34.6">     // error to throw the error and avoid the hang.</span>
<a href="#l34.7"></a><span id="l34.7">     try {</span>
<a href="#l34.8"></a><span id="l34.8">       // make sure an address book was created</span>
<a href="#l34.9"></a><span id="l34.9">       var newAb = this.getAbByName(this.mAbName);</span>
<a href="#l34.10"></a><span id="l34.10">       Assert.ok(newAb !== null);</span>
<a href="#l34.11"></a><span id="l34.11">       Assert.ok(</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-        newAb instanceof Ci.nsIAbDirectory &amp;&amp;</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-          newAb.childCards instanceof Ci.nsISimpleEnumerator</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+        newAb.QueryInterface(Ci.nsIAbDirectory) &amp;&amp;</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+          newAb.childCards.QueryInterface(Ci.nsISimpleEnumerator)</span>
<a href="#l34.16"></a><span id="l34.16">       );</span>
<a href="#l34.17"></a><span id="l34.17">       // get the imported card(s) and check each one</span>
<a href="#l34.18"></a><span id="l34.18">       var count = 0;</span>
<a href="#l34.19"></a><span id="l34.19">       for (let importedCard of newAb.childCards) {</span>
<a href="#l34.20"></a><span id="l34.20">         this.compareCards(this.mJsonCards[count], importedCard);</span>
<a href="#l34.21"></a><span id="l34.21">         count++;</span>
<a href="#l34.22"></a><span id="l34.22">       }</span>
<a href="#l34.23"></a><span id="l34.23">       // make sure there are the same number of cards in the address book and</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineat">@@ -303,20 +303,18 @@ AbImportHelper.prototype = {</span>
<a href="#l34.25"></a><span id="l34.25">    * @param aName The name of the Address Book to find.</span>
<a href="#l34.26"></a><span id="l34.26">    * @return An nsIAbDirectory, if found.</span>
<a href="#l34.27"></a><span id="l34.27">    *         null if the requested Address Book could not be found.</span>
<a href="#l34.28"></a><span id="l34.28">    */</span>
<a href="#l34.29"></a><span id="l34.29">   getAbByName(aName) {</span>
<a href="#l34.30"></a><span id="l34.30">     Assert.ok(aName &amp;&amp; aName.length &gt; 0);</span>
<a href="#l34.31"></a><span id="l34.31"> </span>
<a href="#l34.32"></a><span id="l34.32">     for (let data of MailServices.ab.directories) {</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineminus">-      if (data instanceof Ci.nsIAbDirectory) {</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineminus">-        if (data.dirName == aName) {</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineminus">-          return data;</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineminus">-        }</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineplus">+      if (data.dirName == aName) {</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineplus">+        return data;</span>
<a href="#l34.39"></a><span id="l34.39">       }</span>
<a href="#l34.40"></a><span id="l34.40">     }</span>
<a href="#l34.41"></a><span id="l34.41">     return null;</span>
<a href="#l34.42"></a><span id="l34.42">   },</span>
<a href="#l34.43"></a><span id="l34.43">   /**</span>
<a href="#l34.44"></a><span id="l34.44">    * AbImportHelper.compareCards</span>
<a href="#l34.45"></a><span id="l34.45">    * Compares a JSON &quot;card&quot; with an imported card and throws an error if the</span>
<a href="#l34.46"></a><span id="l34.46">    * values of a supported attribute are different.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/import/test/unit/xpcshell.ini</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/import/test/unit/xpcshell.ini</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -2,21 +2,23 @@</span>
<a href="#l35.4"></a><span id="l35.4"> head = head_import.js</span>
<a href="#l35.5"></a><span id="l35.5"> tail =</span>
<a href="#l35.6"></a><span id="l35.6"> support-files = resources/*</span>
<a href="#l35.7"></a><span id="l35.7"> </span>
<a href="#l35.8"></a><span id="l35.8"> [test_bug_263304.js]</span>
<a href="#l35.9"></a><span id="l35.9"> [test_bug_437556.js]</span>
<a href="#l35.10"></a><span id="l35.10"> [test_csv_GetSample.js]</span>
<a href="#l35.11"></a><span id="l35.11"> [test_becky_addressbook.js]</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+fail-if = true</span>
<a href="#l35.13"></a><span id="l35.13"> run-if = os == 'win'</span>
<a href="#l35.14"></a><span id="l35.14"> [test_becky_filters.js]</span>
<a href="#l35.15"></a><span id="l35.15"> run-if = os == 'win'</span>
<a href="#l35.16"></a><span id="l35.16"> [test_csv_import.js]</span>
<a href="#l35.17"></a><span id="l35.17"> [test_csv_import_quote.js]</span>
<a href="#l35.18"></a><span id="l35.18"> [test_ldif_import.js]</span>
<a href="#l35.19"></a><span id="l35.19"> [test_outlook_settings.js]</span>
<a href="#l35.20"></a><span id="l35.20"> run-if = os == 'win'</span>
<a href="#l35.21"></a><span id="l35.21"> [test_shiftjis_csv.js]</span>
<a href="#l35.22"></a><span id="l35.22"> [test_utf16_csv.js]</span>
<a href="#l35.23"></a><span id="l35.23"> [test_vcard_import.js]</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineplus">+fail-if = true</span>
<a href="#l35.25"></a><span id="l35.25"> [test_winmail.js]</span>
<a href="#l35.26"></a><span id="l35.26"> run-if = os == 'win'</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

