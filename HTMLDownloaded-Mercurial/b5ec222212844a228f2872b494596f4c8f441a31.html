<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27472:b5ec222212844a228f2872b494596f4c8f441a31</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b5ec222212844a228f2872b494596f4c8f441a31" />
<meta property="og:url" content="/comm-central/rev/b5ec222212844a228f2872b494596f4c8f441a31" />
<meta property="og:description" content="Bug 1575710 - Add address book, composition, and display windows to Window API; r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b5ec222212844a228f2872b494596f4c8f441a31 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b5ec222212844a228f2872b494596f4c8f441a31">shortlog</a> |
<a href="/comm-central/log/b5ec222212844a228f2872b494596f4c8f441a31">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b5ec222212844a228f2872b494596f4c8f441a31">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b5ec222212844a228f2872b494596f4c8f441a31">files</a> |
changeset |
<a href="/comm-central/raw-rev/b5ec222212844a228f2872b494596f4c8f441a31">raw</a>  | <a href="/comm-central/archive/b5ec222212844a228f2872b494596f4c8f441a31.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1575710">Bug 1575710</a> - Add address book, composition, and display windows to Window API; r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 02 Sep 2019 12:17:23 +1200</td></tr>

<tr>
 <td>changeset 27472</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b5ec222212844a228f2872b494596f4c8f441a31">b5ec222212844a228f2872b494596f4c8f441a31</a></td>
</tr>



<tr>
<td>parent 27471</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8177b85d18db77c4787461cd6db9575ef9935aea">8177b85d18db77c4787461cd6db9575ef9935aea</a>
</td>
</tr>

<tr>
<td>child 27473</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/cba2237adb947bccf64582022fcc46445528fefe">cba2237adb947bccf64582022fcc46445528fefe</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b5ec222212844a228f2872b494596f4c8f441a31">16349</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 02 Sep 2019 05:18:33 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@71cd49851c2d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=71cd49851c2d2b1997f872b48da74453ec6fe7bc">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=71cd49851c2d2b1997f872b48da74453ec6fe7bc&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=71cd49851c2d2b1997f872b48da74453ec6fe7bc&newProject=comm-central&newRevision=b5ec222212844a228f2872b494596f4c8f441a31&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=71cd49851c2d2b1997f872b48da74453ec6fe7bc&newProject=comm-central&newRevision=b5ec222212844a228f2872b494596f4c8f441a31&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=71cd49851c2d2b1997f872b48da74453ec6fe7bc&newProject=comm-central&newRevision=b5ec222212844a228f2872b494596f4c8f441a31&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1575710">1575710</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1575710">Bug 1575710</a> - Add address book, composition, and display windows to Window API; r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/.eslintrc.js">mail/components/extensions/parent/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-compose.js">mail/components/extensions/parent/ext-compose.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-compose.js">file</a> |
<a href="/comm-central/annotate/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-compose.js">annotate</a> |
<a href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-compose.js">diff</a> |
<a href="/comm-central/comparison/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-compose.js">comparison</a> |
<a href="/comm-central/log/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-compose.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-mail.js">mail/components/extensions/parent/ext-mail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-mail.js">file</a> |
<a href="/comm-central/annotate/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-mail.js">annotate</a> |
<a href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-mail.js">diff</a> |
<a href="/comm-central/comparison/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-mail.js">comparison</a> |
<a href="/comm-central/log/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-mail.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-mailTabs.js">mail/components/extensions/parent/ext-mailTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-mailTabs.js">file</a> |
<a href="/comm-central/annotate/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-mailTabs.js">annotate</a> |
<a href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-mailTabs.js">diff</a> |
<a href="/comm-central/comparison/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-mailTabs.js">comparison</a> |
<a href="/comm-central/log/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-mailTabs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-menus.js">mail/components/extensions/parent/ext-menus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-menus.js">file</a> |
<a href="/comm-central/annotate/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-menus.js">annotate</a> |
<a href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-menus.js">diff</a> |
<a href="/comm-central/comparison/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-menus.js">comparison</a> |
<a href="/comm-central/log/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-menus.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-tabs.js">mail/components/extensions/parent/ext-tabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-tabs.js">file</a> |
<a href="/comm-central/annotate/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-tabs.js">annotate</a> |
<a href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-tabs.js">diff</a> |
<a href="/comm-central/comparison/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-tabs.js">comparison</a> |
<a href="/comm-central/log/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-tabs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-windows.js">mail/components/extensions/parent/ext-windows.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-windows.js">file</a> |
<a href="/comm-central/annotate/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-windows.js">annotate</a> |
<a href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-windows.js">diff</a> |
<a href="/comm-central/comparison/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-windows.js">comparison</a> |
<a href="/comm-central/log/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/parent/ext-windows.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/schemas/windows.json">mail/components/extensions/schemas/windows.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/schemas/windows.json">file</a> |
<a href="/comm-central/annotate/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/schemas/windows.json">annotate</a> |
<a href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/schemas/windows.json">diff</a> |
<a href="/comm-central/comparison/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/schemas/windows.json">comparison</a> |
<a href="/comm-central/log/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/schemas/windows.json">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser.ini">mail/components/extensions/test/browser/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser.ini">file</a> |
<a href="/comm-central/annotate/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser.ini">annotate</a> |
<a href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser.ini">diff</a> |
<a href="/comm-central/comparison/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser.ini">comparison</a> |
<a href="/comm-central/log/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser_ext_windows.js">mail/components/extensions/test/browser/browser_ext_windows.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser_ext_windows.js">file</a> |
<a href="/comm-central/annotate/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser_ext_windows.js">annotate</a> |
<a href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser_ext_windows.js">diff</a> |
<a href="/comm-central/comparison/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser_ext_windows.js">comparison</a> |
<a href="/comm-central/log/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser_ext_windows.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser_ext_windows_types.js">mail/components/extensions/test/browser/browser_ext_windows_types.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser_ext_windows_types.js">file</a> |
<a href="/comm-central/annotate/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser_ext_windows_types.js">annotate</a> |
<a href="/comm-central/diff/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser_ext_windows_types.js">diff</a> |
<a href="/comm-central/comparison/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser_ext_windows_types.js">comparison</a> |
<a href="/comm-central/log/b5ec222212844a228f2872b494596f4c8f441a31/mail/components/extensions/test/browser/browser_ext_windows_types.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/extensions/parent/.eslintrc.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/extensions/parent/.eslintrc.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -30,17 +30,19 @@ module.exports = {</span>
<a href="#l1.4"></a><span id="l1.4">     isContainerCookieStoreId: true,</span>
<a href="#l1.5"></a><span id="l1.5">     isDefaultCookieStoreId: true,</span>
<a href="#l1.6"></a><span id="l1.6">     isPrivateCookieStoreId: true,</span>
<a href="#l1.7"></a><span id="l1.7">     isValidCookieStoreId: true,</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9">     // These are defined in ext-mail.js.</span>
<a href="#l1.10"></a><span id="l1.10">     ExtensionError: true,</span>
<a href="#l1.11"></a><span id="l1.11">     Tab: true,</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    TabmailTab: true,</span>
<a href="#l1.13"></a><span id="l1.13">     Window: true,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    TabmailWindow: true,</span>
<a href="#l1.15"></a><span id="l1.15">     convertFolder: true,</span>
<a href="#l1.16"></a><span id="l1.16">     convertMessage: true,</span>
<a href="#l1.17"></a><span id="l1.17">     folderPathToURI: true,</span>
<a href="#l1.18"></a><span id="l1.18">     folderURIToPath: true,</span>
<a href="#l1.19"></a><span id="l1.19">     getTabBrowser: true,</span>
<a href="#l1.20"></a><span id="l1.20">     makeWidgetId: true,</span>
<a href="#l1.21"></a><span id="l1.21">     messageListTracker: true,</span>
<a href="#l1.22"></a><span id="l1.22">     messageTracker: true,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-compose.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-compose.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -81,17 +81,16 @@ async function openComposeWindow(related</span>
<a href="#l2.4"></a><span id="l2.4">     for (let field of [&quot;replyTo&quot;, &quot;subject&quot;, &quot;body&quot;]) {</span>
<a href="#l2.5"></a><span id="l2.5">       if (composeParams[field]) {</span>
<a href="#l2.6"></a><span id="l2.6">         composeFields[field] = composeParams[field];</span>
<a href="#l2.7"></a><span id="l2.7">       }</span>
<a href="#l2.8"></a><span id="l2.8">     }</span>
<a href="#l2.9"></a><span id="l2.9">   }</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">   params.composeFields = composeFields;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  console.log(params);</span>
<a href="#l2.13"></a><span id="l2.13">   MailServices.compose.OpenComposeWindowWithParams(null, params);</span>
<a href="#l2.14"></a><span id="l2.14"> }</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16"> this.compose = class extends ExtensionAPI {</span>
<a href="#l2.17"></a><span id="l2.17">   getAPI(context) {</span>
<a href="#l2.18"></a><span id="l2.18">     return {</span>
<a href="#l2.19"></a><span id="l2.19">       compose: {</span>
<a href="#l2.20"></a><span id="l2.20">         async beginNew(composeParams) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-mail.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-mail.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -130,22 +130,28 @@ global.makeWidgetId = id =&gt; {</span>
<a href="#l3.4"></a><span id="l3.4">  * @param {NativeTabInfo} nativeTabInfo     The tabInfo object to get the browser for</span>
<a href="#l3.5"></a><span id="l3.5">  * @return {?XULElement}                    The browser element for the tab</span>
<a href="#l3.6"></a><span id="l3.6">  */</span>
<a href="#l3.7"></a><span id="l3.7"> function getTabBrowser(nativeTabInfo) {</span>
<a href="#l3.8"></a><span id="l3.8">   if (!nativeTabInfo) {</span>
<a href="#l3.9"></a><span id="l3.9">     return null;</span>
<a href="#l3.10"></a><span id="l3.10">   }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  if (nativeTabInfo.mode.getBrowser) {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    return nativeTabInfo.mode.getBrowser(nativeTabInfo);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  if (nativeTabInfo.mode) {</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    if (nativeTabInfo.mode.getBrowser) {</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+      return nativeTabInfo.mode.getBrowser(nativeTabInfo);</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+    }</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+    if (nativeTabInfo.mode.tabType.getBrowser) {</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+      return nativeTabInfo.mode.tabType.getBrowser(nativeTabInfo);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+    }</span>
<a href="#l3.22"></a><span id="l3.22">   }</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-  if (nativeTabInfo.mode.tabType.getBrowser) {</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-    return nativeTabInfo.mode.tabType.getBrowser(nativeTabInfo);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+  if (nativeTabInfo.ownerGlobal &amp;&amp; nativeTabInfo.ownerGlobal.getBrowser) {</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+    return nativeTabInfo.ownerGlobal.getBrowser();</span>
<a href="#l3.28"></a><span id="l3.28">   }</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30">   return null;</span>
<a href="#l3.31"></a><span id="l3.31"> }</span>
<a href="#l3.32"></a><span id="l3.32"> global.getTabBrowser = getTabBrowser;</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34"> /* global searchInitialized */</span>
<a href="#l3.35"></a><span id="l3.35"> // This promise is used to wait for the search service to be initialized.</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineat">@@ -194,17 +200,22 @@ class WindowTracker extends WindowTracke</span>
<a href="#l3.37"></a><span id="l3.37">    * compatibility with gecko.</span>
<a href="#l3.38"></a><span id="l3.38">    *</span>
<a href="#l3.39"></a><span id="l3.39">    * @param {DOMWindow} window      The window to check</span>
<a href="#l3.40"></a><span id="l3.40">    * @return {Boolean}              True, if the window is a mail window</span>
<a href="#l3.41"></a><span id="l3.41">    */</span>
<a href="#l3.42"></a><span id="l3.42">   isBrowserWindow(window) {</span>
<a href="#l3.43"></a><span id="l3.43">     let { documentElement } = window.document;</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-    return documentElement.getAttribute(&quot;windowtype&quot;) === &quot;mail:3pane&quot;;</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+    return [</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+      &quot;mail:3pane&quot;,</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+      &quot;mail:addressbook&quot;,</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+      &quot;msgcompose&quot;,</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+      &quot;mail:messageWindow&quot;,</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+    ].includes(documentElement.getAttribute(&quot;windowtype&quot;));</span>
<a href="#l3.52"></a><span id="l3.52">   }</span>
<a href="#l3.53"></a><span id="l3.53"> </span>
<a href="#l3.54"></a><span id="l3.54">   /**</span>
<a href="#l3.55"></a><span id="l3.55">    * The currently active, or topmost, mail window, or null if no mail window is currently open.</span>
<a href="#l3.56"></a><span id="l3.56">    *</span>
<a href="#l3.57"></a><span id="l3.57">    * @property {?DOMWindow} topWindow</span>
<a href="#l3.58"></a><span id="l3.58">    * @readonly</span>
<a href="#l3.59"></a><span id="l3.59">    */</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineat">@@ -444,32 +455,40 @@ class TabTracker extends TabTrackerBase </span>
<a href="#l3.61"></a><span id="l3.61">   /**</span>
<a href="#l3.62"></a><span id="l3.62">    * A private method which is called whenever a new mail window is opened, and dispatches the</span>
<a href="#l3.63"></a><span id="l3.63">    * necessary events for it.</span>
<a href="#l3.64"></a><span id="l3.64">    *</span>
<a href="#l3.65"></a><span id="l3.65">    * @param {DOMWindow} window      The window being opened.</span>
<a href="#l3.66"></a><span id="l3.66">    */</span>
<a href="#l3.67"></a><span id="l3.67">   _handleWindowOpen(window) {</span>
<a href="#l3.68"></a><span id="l3.68">     let tabmail = window.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+    if (!tabmail) {</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+      return;</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+    }</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+</span>
<a href="#l3.73"></a><span id="l3.73">     for (let nativeTabInfo of tabmail.tabInfo) {</span>
<a href="#l3.74"></a><span id="l3.74">       if (!getTabBrowser(nativeTabInfo)) {</span>
<a href="#l3.75"></a><span id="l3.75">         continue;</span>
<a href="#l3.76"></a><span id="l3.76">       }</span>
<a href="#l3.77"></a><span id="l3.77">       this.emitCreated(nativeTabInfo);</span>
<a href="#l3.78"></a><span id="l3.78">     }</span>
<a href="#l3.79"></a><span id="l3.79">   }</span>
<a href="#l3.80"></a><span id="l3.80"> </span>
<a href="#l3.81"></a><span id="l3.81">   /**</span>
<a href="#l3.82"></a><span id="l3.82">    * A private method which is called whenever a mail window is closed, and dispatches the necessary</span>
<a href="#l3.83"></a><span id="l3.83">    * events for it.</span>
<a href="#l3.84"></a><span id="l3.84">    *</span>
<a href="#l3.85"></a><span id="l3.85">    * @param {DOMWindow} window      The window being closed.</span>
<a href="#l3.86"></a><span id="l3.86">    */</span>
<a href="#l3.87"></a><span id="l3.87">   _handleWindowClose(window) {</span>
<a href="#l3.88"></a><span id="l3.88">     let tabmail = window.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+    if (!tabmail) {</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+      return;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+    }</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+</span>
<a href="#l3.93"></a><span id="l3.93">     for (let nativeTabInfo of tabmail.tabInfo) {</span>
<a href="#l3.94"></a><span id="l3.94">       if (!getTabBrowser(nativeTabInfo)) {</span>
<a href="#l3.95"></a><span id="l3.95">         continue;</span>
<a href="#l3.96"></a><span id="l3.96">       }</span>
<a href="#l3.97"></a><span id="l3.97">       this.emitRemoved(nativeTabInfo, true);</span>
<a href="#l3.98"></a><span id="l3.98">     }</span>
<a href="#l3.99"></a><span id="l3.99">   }</span>
<a href="#l3.100"></a><span id="l3.100"> </span>
<a href="#l3.101"></a><span id="l3.101" class="difflineat">@@ -586,27 +605,19 @@ class TabTracker extends TabTrackerBase </span>
<a href="#l3.102"></a><span id="l3.102"> tabTracker = new TabTracker();</span>
<a href="#l3.103"></a><span id="l3.103"> windowTracker = new WindowTracker();</span>
<a href="#l3.104"></a><span id="l3.104"> Object.assign(global, { tabTracker, windowTracker });</span>
<a href="#l3.105"></a><span id="l3.105"> </span>
<a href="#l3.106"></a><span id="l3.106"> /**</span>
<a href="#l3.107"></a><span id="l3.107">  * Extension-specific wrapper around a Thunderbird tab.</span>
<a href="#l3.108"></a><span id="l3.108">  */</span>
<a href="#l3.109"></a><span id="l3.109"> class Tab extends TabBase {</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-  constructor(extension, nativeTab, id) {</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-    if (nativeTab.localName == &quot;tab&quot;) {</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-      let tabmail = nativeTab.ownerDocument.getElementById(&quot;tabmail&quot;);</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-      nativeTab = tabmail._getTabContextForTabbyThing(nativeTab)[1];</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-    }</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-    super(extension, nativeTab, id);</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-  }</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-</span>
<a href="#l3.118"></a><span id="l3.118">   /** Returns true if this tab is a 3-pane tab. */</span>
<a href="#l3.119"></a><span id="l3.119">   get mailTab() {</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-    return this.nativeTab.mode.type == &quot;folder&quot;;</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+    return false;</span>
<a href="#l3.122"></a><span id="l3.122">   }</span>
<a href="#l3.123"></a><span id="l3.123"> </span>
<a href="#l3.124"></a><span id="l3.124">   /** Overrides the matches function to enable querying for 3-pane tabs. */</span>
<a href="#l3.125"></a><span id="l3.125">   matches(queryInfo, context) {</span>
<a href="#l3.126"></a><span id="l3.126">     let result = super.matches(queryInfo, context);</span>
<a href="#l3.127"></a><span id="l3.127">     return result &amp;&amp; (!queryInfo.mailTab || this.mailTab);</span>
<a href="#l3.128"></a><span id="l3.128">   }</span>
<a href="#l3.129"></a><span id="l3.129"> </span>
<a href="#l3.130"></a><span id="l3.130" class="difflineat">@@ -631,36 +642,36 @@ class Tab extends TabBase {</span>
<a href="#l3.131"></a><span id="l3.131">       &quot;successorTabId&quot;,</span>
<a href="#l3.132"></a><span id="l3.132">     ]) {</span>
<a href="#l3.133"></a><span id="l3.133">       delete result[key];</span>
<a href="#l3.134"></a><span id="l3.134">     }</span>
<a href="#l3.135"></a><span id="l3.135"> </span>
<a href="#l3.136"></a><span id="l3.136">     return result;</span>
<a href="#l3.137"></a><span id="l3.137">   }</span>
<a href="#l3.138"></a><span id="l3.138"> </span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+  /** Always returns false. This feature doesn't exist in Thunderbird. */</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+  get _incognito() {</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+    return false;</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+  }</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+</span>
<a href="#l3.144"></a><span id="l3.144">   /** Returns the XUL browser for the tab. */</span>
<a href="#l3.145"></a><span id="l3.145">   get browser() {</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-    return getTabBrowser(this.nativeTab);</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-  }</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-  /** Returns the tabmail element for the tab. */</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-  get tabmail() {</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-    return this.browser.ownerDocument.getElementById(&quot;tabmail&quot;);</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+    return null;</span>
<a href="#l3.153"></a><span id="l3.153">   }</span>
<a href="#l3.154"></a><span id="l3.154"> </span>
<a href="#l3.155"></a><span id="l3.155">   /** Returns the frame loader for the tab. */</span>
<a href="#l3.156"></a><span id="l3.156">   get frameLoader() {</span>
<a href="#l3.157"></a><span id="l3.157">     // If we don't have a frameLoader yet, just return a dummy with no width and</span>
<a href="#l3.158"></a><span id="l3.158">     // height.</span>
<a href="#l3.159"></a><span id="l3.159">     return super.frameLoader || { lazyWidth: 0, lazyHeight: 0 };</span>
<a href="#l3.160"></a><span id="l3.160">   }</span>
<a href="#l3.161"></a><span id="l3.161"> </span>
<a href="#l3.162"></a><span id="l3.162">   /** Returns the favIcon, without permission checks. */</span>
<a href="#l3.163"></a><span id="l3.163">   get _favIconUrl() {</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-    return this.browser.mIconURL;</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+    return null;</span>
<a href="#l3.166"></a><span id="l3.166">   }</span>
<a href="#l3.167"></a><span id="l3.167"> </span>
<a href="#l3.168"></a><span id="l3.168">   /** Returns the last accessed time. */</span>
<a href="#l3.169"></a><span id="l3.169">   get lastAccessed() {</span>
<a href="#l3.170"></a><span id="l3.170">     return 0;</span>
<a href="#l3.171"></a><span id="l3.171">   }</span>
<a href="#l3.172"></a><span id="l3.172"> </span>
<a href="#l3.173"></a><span id="l3.173">   /** Returns the audible state. */</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineat">@@ -685,19 +696,17 @@ class Tab extends TabBase {</span>
<a href="#l3.175"></a><span id="l3.175"> </span>
<a href="#l3.176"></a><span id="l3.176">   /** Returns hidden status. */</span>
<a href="#l3.177"></a><span id="l3.177">   get hidden() {</span>
<a href="#l3.178"></a><span id="l3.178">     return false;</span>
<a href="#l3.179"></a><span id="l3.179">   }</span>
<a href="#l3.180"></a><span id="l3.180"> </span>
<a href="#l3.181"></a><span id="l3.181">   /** Returns the tab index. */</span>
<a href="#l3.182"></a><span id="l3.182">   get index() {</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-    return this.tabmail.tabInfo</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-      .filter(info =&gt; getTabBrowser(info))</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-      .indexOf(this.nativeTab);</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+    return 0;</span>
<a href="#l3.187"></a><span id="l3.187">   }</span>
<a href="#l3.188"></a><span id="l3.188"> </span>
<a href="#l3.189"></a><span id="l3.189">   /** Returns information about the muted state of the tab. */</span>
<a href="#l3.190"></a><span id="l3.190">   get mutedInfo() {</span>
<a href="#l3.191"></a><span id="l3.191">     return { muted: false };</span>
<a href="#l3.192"></a><span id="l3.192">   }</span>
<a href="#l3.193"></a><span id="l3.193"> </span>
<a href="#l3.194"></a><span id="l3.194">   /** Returns information about the sharing state of the tab. */</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineat">@@ -707,48 +716,47 @@ class Tab extends TabBase {</span>
<a href="#l3.196"></a><span id="l3.196"> </span>
<a href="#l3.197"></a><span id="l3.197">   /** Returns the pinned state of the tab. */</span>
<a href="#l3.198"></a><span id="l3.198">   get pinned() {</span>
<a href="#l3.199"></a><span id="l3.199">     return false;</span>
<a href="#l3.200"></a><span id="l3.200">   }</span>
<a href="#l3.201"></a><span id="l3.201"> </span>
<a href="#l3.202"></a><span id="l3.202">   /** Returns the active state of the tab. */</span>
<a href="#l3.203"></a><span id="l3.203">   get active() {</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-    return this.nativeTab == this.tabmail.selectedTab;</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+    return true;</span>
<a href="#l3.206"></a><span id="l3.206">   }</span>
<a href="#l3.207"></a><span id="l3.207"> </span>
<a href="#l3.208"></a><span id="l3.208">   /** Returns the highlighted state of the tab. */</span>
<a href="#l3.209"></a><span id="l3.209">   get highlighted() {</span>
<a href="#l3.210"></a><span id="l3.210">     return this.active;</span>
<a href="#l3.211"></a><span id="l3.211">   }</span>
<a href="#l3.212"></a><span id="l3.212"> </span>
<a href="#l3.213"></a><span id="l3.213">   /** Returns the selected state of the tab. */</span>
<a href="#l3.214"></a><span id="l3.214">   get selected() {</span>
<a href="#l3.215"></a><span id="l3.215">     return this.active;</span>
<a href="#l3.216"></a><span id="l3.216">   }</span>
<a href="#l3.217"></a><span id="l3.217"> </span>
<a href="#l3.218"></a><span id="l3.218">   /** Returns the loading status of the tab. */</span>
<a href="#l3.219"></a><span id="l3.219">   get status() {</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-    return this.browser.webProgress.isLoadingDocument ? &quot;loading&quot; : &quot;complete&quot;;</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+    return &quot;complete&quot;;</span>
<a href="#l3.222"></a><span id="l3.222">   }</span>
<a href="#l3.223"></a><span id="l3.223"> </span>
<a href="#l3.224"></a><span id="l3.224">   /** Returns the title of the tab, without permission checks. */</span>
<a href="#l3.225"></a><span id="l3.225">   get _title() {</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-    let tabNode = this.tabmail._getTabContextForTabbyThing(this.nativeTab)[2];</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-    return tabNode.getAttribute(&quot;label&quot;);</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+    return this.nativeTab.ownerDocument.title;</span>
<a href="#l3.229"></a><span id="l3.229">   }</span>
<a href="#l3.230"></a><span id="l3.230"> </span>
<a href="#l3.231"></a><span id="l3.231">   /** Returns the width of the tab. */</span>
<a href="#l3.232"></a><span id="l3.232">   get width() {</span>
<a href="#l3.233"></a><span id="l3.233">     return this.frameLoader.lazyWidth;</span>
<a href="#l3.234"></a><span id="l3.234">   }</span>
<a href="#l3.235"></a><span id="l3.235"> </span>
<a href="#l3.236"></a><span id="l3.236">   /** Returns the native window object of the tab. */</span>
<a href="#l3.237"></a><span id="l3.237">   get window() {</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-    return this.browser.ownerGlobal;</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+    return this.nativeTab;</span>
<a href="#l3.240"></a><span id="l3.240">   }</span>
<a href="#l3.241"></a><span id="l3.241"> </span>
<a href="#l3.242"></a><span id="l3.242">   /** Returns the window id of the tab. */</span>
<a href="#l3.243"></a><span id="l3.243">   get windowId() {</span>
<a href="#l3.244"></a><span id="l3.244">     return windowTracker.getId(this.window);</span>
<a href="#l3.245"></a><span id="l3.245">   }</span>
<a href="#l3.246"></a><span id="l3.246"> </span>
<a href="#l3.247"></a><span id="l3.247">   /** Returns the attention state of the tab. */</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineat">@@ -767,21 +775,105 @@ class Tab extends TabBase {</span>
<a href="#l3.249"></a><span id="l3.249">   }</span>
<a href="#l3.250"></a><span id="l3.250"> </span>
<a href="#l3.251"></a><span id="l3.251">   /** Returns the id of the successor tab of the tab. */</span>
<a href="#l3.252"></a><span id="l3.252">   get successorTabId() {</span>
<a href="#l3.253"></a><span id="l3.253">     return -1;</span>
<a href="#l3.254"></a><span id="l3.254">   }</span>
<a href="#l3.255"></a><span id="l3.255"> }</span>
<a href="#l3.256"></a><span id="l3.256"> </span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+class TabmailTab extends Tab {</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+  constructor(extension, nativeTab, id) {</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+    if (nativeTab.localName == &quot;tab&quot;) {</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+      let tabmail = nativeTab.ownerDocument.getElementById(&quot;tabmail&quot;);</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+      nativeTab = tabmail._getTabContextForTabbyThing(nativeTab)[1];</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+    }</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+    super(extension, nativeTab, id);</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+  }</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+  /** Returns the XUL browser for the tab. */</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+  get browser() {</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+    return getTabBrowser(this.nativeTab);</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+  }</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+  /** Returns the favIcon, without permission checks. */</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+  get _favIconUrl() {</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+    return this.browser.mIconURL;</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+  }</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+  /** Returns the tabmail element for the tab. */</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+  get tabmail() {</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+    return this.browser.ownerDocument.getElementById(&quot;tabmail&quot;);</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+  }</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+  /** Returns true if this tab is a 3-pane tab. */</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+  get mailTab() {</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+    return this.nativeTab.mode.type == &quot;folder&quot;;</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+  }</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+  /** Returns the tab index. */</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+  get index() {</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+    return this.tabmail.tabInfo</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+      .filter(info =&gt; getTabBrowser(info))</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+      .indexOf(this.nativeTab);</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+  }</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+  /** Returns the active state of the tab. */</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+  get active() {</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+    return this.nativeTab == this.tabmail.selectedTab;</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+  }</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+  /** Returns the loading status of the tab. */</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+  get status() {</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+    if (this.browser &amp;&amp; this.browser.webProgress) {</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+      return this.browser.webProgress.isLoadingDocument</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+        ? &quot;loading&quot;</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+        : &quot;complete&quot;;</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+    }</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+    return &quot;complete&quot;;</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+  }</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+  /** Returns the title of the tab, without permission checks. */</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+  get _title() {</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+    let [, , tabNode] = this.tabmail._getTabContextForTabbyThing(</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+      this.nativeTab</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+    );</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+    return tabNode.getAttribute(&quot;label&quot;);</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+  }</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+  /** Returns the native window object of the tab. */</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+  get window() {</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+    return this.tabmail.ownerGlobal;</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+  }</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+}</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+</span>
<a href="#l3.322"></a><span id="l3.322"> /**</span>
<a href="#l3.323"></a><span id="l3.323">  * Extension-specific wrapper around a Thunderbird window.</span>
<a href="#l3.324"></a><span id="l3.324">  */</span>
<a href="#l3.325"></a><span id="l3.325"> class Window extends WindowBase {</span>
<a href="#l3.326"></a><span id="l3.326">   /**</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+   * @property {string} type</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+   *        The type of the window, as defined by the WebExtension API. May be</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+   *        either &quot;normal&quot; or &quot;popup&quot;.</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+   *        @readonly</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+   */</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+  get type() {</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineplus">+    switch (this.window.document.documentElement.getAttribute(&quot;windowtype&quot;)) {</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineplus">+      case &quot;mail:addressbook&quot;:</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineplus">+        return &quot;addressBook&quot;;</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+      case &quot;msgcompose&quot;:</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+        return &quot;messageCompose&quot;;</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+      case &quot;mail:messageWindow&quot;:</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+        return &quot;messageDisplay&quot;;</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineplus">+      default:</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+        return super.type;</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+    }</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+  }</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineplus">+  /**</span>
<a href="#l3.346"></a><span id="l3.346">    * Update the geometry of the mail window.</span>
<a href="#l3.347"></a><span id="l3.347">    *</span>
<a href="#l3.348"></a><span id="l3.348">    * @param {Object} options</span>
<a href="#l3.349"></a><span id="l3.349">    *        An object containing new values for the window's geometry.</span>
<a href="#l3.350"></a><span id="l3.350">    * @param {integer} [options.left]</span>
<a href="#l3.351"></a><span id="l3.351">    *        The new pixel distance of the left side of the mail window from</span>
<a href="#l3.352"></a><span id="l3.352">    *        the left of the screen.</span>
<a href="#l3.353"></a><span id="l3.353">    * @param {integer} [options.top]</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineat">@@ -804,21 +896,16 @@ class Window extends WindowBase {</span>
<a href="#l3.355"></a><span id="l3.355">     if (options.width !== null || options.height !== null) {</span>
<a href="#l3.356"></a><span id="l3.356">       let width = options.width === null ? window.outerWidth : options.width;</span>
<a href="#l3.357"></a><span id="l3.357">       let height =</span>
<a href="#l3.358"></a><span id="l3.358">         options.height === null ? window.outerHeight : options.height;</span>
<a href="#l3.359"></a><span id="l3.359">       window.resizeTo(width, height);</span>
<a href="#l3.360"></a><span id="l3.360">     }</span>
<a href="#l3.361"></a><span id="l3.361">   }</span>
<a href="#l3.362"></a><span id="l3.362"> </span>
<a href="#l3.363"></a><span id="l3.363" class="difflineminus">-  /** Returns the tabmail element for the tab. */</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineminus">-  get tabmail() {</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineminus">-    return this.window.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineminus">-  }</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-</span>
<a href="#l3.368"></a><span id="l3.368">   /** Returns the title of the tab, without permission checks. */</span>
<a href="#l3.369"></a><span id="l3.369">   get _title() {</span>
<a href="#l3.370"></a><span id="l3.370">     return this.window.document.title;</span>
<a href="#l3.371"></a><span id="l3.371">   }</span>
<a href="#l3.372"></a><span id="l3.372"> </span>
<a href="#l3.373"></a><span id="l3.373">   /** Returns the title of the tab, checking tab permissions. */</span>
<a href="#l3.374"></a><span id="l3.374">   get title() {</span>
<a href="#l3.375"></a><span id="l3.375">     // Thunderbird can have an empty active tab while a window is loading</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineat">@@ -951,16 +1038,53 @@ class Window extends WindowBase {</span>
<a href="#l3.377"></a><span id="l3.377"> </span>
<a href="#l3.378"></a><span id="l3.378">   /**</span>
<a href="#l3.379"></a><span id="l3.379">    * Retrieves the (relevant) tabs in this window.</span>
<a href="#l3.380"></a><span id="l3.380">    *</span>
<a href="#l3.381"></a><span id="l3.381">    * @yields {Tab}      The wrapped Tab in this window</span>
<a href="#l3.382"></a><span id="l3.382">    */</span>
<a href="#l3.383"></a><span id="l3.383">   *getTabs() {</span>
<a href="#l3.384"></a><span id="l3.384">     let { tabManager } = this.extension;</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineplus">+    yield tabManager.getWrapper(this.window);</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+  }</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineplus">+</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineplus">+  /** Retrieves the active tab in this window */</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineplus">+  get activeTab() {</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineplus">+    let { tabManager } = this.extension;</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineplus">+    return tabManager.getWrapper(this.window);</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineplus">+  }</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineplus">+</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineplus">+  /**</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineplus">+   * Retrieves the tab at the given index.</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineplus">+   *</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineplus">+   * @param {Number} index      The index to look at</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineplus">+   * @return {Tab}              The wrapped tab at the index</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineplus">+   */</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineplus">+  getTabAtIndex(index) {</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineplus">+    let { tabManager } = this.extension;</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineplus">+    if (index == 0) {</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineplus">+      return tabManager.getWrapper(this.window);</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineplus">+    }</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineplus">+    return null;</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineplus">+  }</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineplus">+}</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineplus">+</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+class TabmailWindow extends Window {</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineplus">+  /** Returns the tabmail element for the tab. */</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineplus">+  get tabmail() {</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineplus">+    return this.window.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineplus">+  }</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineplus">+</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineplus">+  /**</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineplus">+   * Retrieves the (relevant) tabs in this window.</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineplus">+   *</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineplus">+   * @yields {Tab}      The wrapped Tab in this window</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineplus">+   */</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineplus">+  *getTabs() {</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineplus">+    let { tabManager } = this.extension;</span>
<a href="#l3.422"></a><span id="l3.422"> </span>
<a href="#l3.423"></a><span id="l3.423">     for (let nativeTabInfo of this.tabmail.tabInfo) {</span>
<a href="#l3.424"></a><span id="l3.424">       if (getTabBrowser(nativeTabInfo)) {</span>
<a href="#l3.425"></a><span id="l3.425">         // Only tabs that have a browser element</span>
<a href="#l3.426"></a><span id="l3.426">         yield tabManager.getWrapper(nativeTabInfo);</span>
<a href="#l3.427"></a><span id="l3.427">       }</span>
<a href="#l3.428"></a><span id="l3.428">     }</span>
<a href="#l3.429"></a><span id="l3.429">   }</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineat">@@ -1049,17 +1173,21 @@ class TabManager extends TabManagerBase </span>
<a href="#l3.431"></a><span id="l3.431"> </span>
<a href="#l3.432"></a><span id="l3.432">   /**</span>
<a href="#l3.433"></a><span id="l3.433">    * Returns a new Tab instance wrapping the given native tab info.</span>
<a href="#l3.434"></a><span id="l3.434">    *</span>
<a href="#l3.435"></a><span id="l3.435">    * @param {NativeTabInfo} nativeTabInfo       The native tab for which to return a wrapper.</span>
<a href="#l3.436"></a><span id="l3.436">    * @return {Tab}                              The wrapped native tab</span>
<a href="#l3.437"></a><span id="l3.437">    */</span>
<a href="#l3.438"></a><span id="l3.438">   wrapTab(nativeTabInfo) {</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineminus">-    return new Tab(</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineplus">+    let tabClass = TabmailTab;</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineplus">+    if (nativeTabInfo instanceof Ci.nsIDOMWindow) {</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineplus">+      tabClass = Tab;</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineplus">+    }</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineplus">+    return new tabClass(</span>
<a href="#l3.445"></a><span id="l3.445">       this.extension,</span>
<a href="#l3.446"></a><span id="l3.446">       nativeTabInfo,</span>
<a href="#l3.447"></a><span id="l3.447">       tabTracker.getId(nativeTabInfo)</span>
<a href="#l3.448"></a><span id="l3.448">     );</span>
<a href="#l3.449"></a><span id="l3.449">   }</span>
<a href="#l3.450"></a><span id="l3.450"> }</span>
<a href="#l3.451"></a><span id="l3.451"> </span>
<a href="#l3.452"></a><span id="l3.452"> /**</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineat">@@ -1092,17 +1220,23 @@ class WindowManager extends WindowManage</span>
<a href="#l3.454"></a><span id="l3.454"> </span>
<a href="#l3.455"></a><span id="l3.455">   /**</span>
<a href="#l3.456"></a><span id="l3.456">    * Returns a new Window instance wrapping the given mail window.</span>
<a href="#l3.457"></a><span id="l3.457">    *</span>
<a href="#l3.458"></a><span id="l3.458">    * @param {DOMWindow} window      The mail window for which to return a wrapper.</span>
<a href="#l3.459"></a><span id="l3.459">    * @returns {Window}              The wrapped window</span>
<a href="#l3.460"></a><span id="l3.460">    */</span>
<a href="#l3.461"></a><span id="l3.461">   wrapWindow(window) {</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineminus">-    return new Window(this.extension, window, windowTracker.getId(window));</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineplus">+    let windowClass = Window;</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+    if (</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineplus">+      window.document.documentElement.getAttribute(&quot;windowtype&quot;) == &quot;mail:3pane&quot;</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineplus">+    ) {</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineplus">+      windowClass = TabmailWindow;</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineplus">+    }</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineplus">+    return new windowClass(this.extension, window, windowTracker.getId(window));</span>
<a href="#l3.470"></a><span id="l3.470">   }</span>
<a href="#l3.471"></a><span id="l3.471"> }</span>
<a href="#l3.472"></a><span id="l3.472"> </span>
<a href="#l3.473"></a><span id="l3.473"> /**</span>
<a href="#l3.474"></a><span id="l3.474">  * The following functions turn nsIMsgFolder references into more human-friendly forms.</span>
<a href="#l3.475"></a><span id="l3.475">  * A folder can be referenced with the account key, and the path to the folder in that account.</span>
<a href="#l3.476"></a><span id="l3.476">  */</span>
<a href="#l3.477"></a><span id="l3.477"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-mailTabs.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-mailTabs.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -75,21 +75,21 @@ function convertMailTab(tab, context) {</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> /**</span>
<a href="#l4.6"></a><span id="l4.6">  * Listens for changes in the UI to fire events.</span>
<a href="#l4.7"></a><span id="l4.7">  */</span>
<a href="#l4.8"></a><span id="l4.8"> var uiListener = new (class extends EventEmitter {</span>
<a href="#l4.9"></a><span id="l4.9">   constructor() {</span>
<a href="#l4.10"></a><span id="l4.10">     super();</span>
<a href="#l4.11"></a><span id="l4.11">     this.listenerCount = 0;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    this.handleSelect = this.handleSelect.bind(this);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    this.handleEvent = this.handleEvent.bind(this);</span>
<a href="#l4.14"></a><span id="l4.14">     this.lastSelected = new WeakMap();</span>
<a href="#l4.15"></a><span id="l4.15">   }</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-  handleSelect(event) {</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  handleEvent(event) {</span>
<a href="#l4.19"></a><span id="l4.19">     let tab = tabTracker.activeTab;</span>
<a href="#l4.20"></a><span id="l4.20">     if (event.target.id == &quot;folderTree&quot;) {</span>
<a href="#l4.21"></a><span id="l4.21">       let folder = tab.folderDisplay.displayedFolder;</span>
<a href="#l4.22"></a><span id="l4.22">       if (this.lastSelected.get(tab) == folder) {</span>
<a href="#l4.23"></a><span id="l4.23">         return;</span>
<a href="#l4.24"></a><span id="l4.24">       }</span>
<a href="#l4.25"></a><span id="l4.25">       this.lastSelected.set(tab, folder);</span>
<a href="#l4.26"></a><span id="l4.26">       this.emit(&quot;folder-changed&quot;, tab, folder);</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineat">@@ -99,38 +99,26 @@ var uiListener = new (class extends Even</span>
<a href="#l4.28"></a><span id="l4.28">       this.emit(</span>
<a href="#l4.29"></a><span id="l4.29">         &quot;messages-changed&quot;,</span>
<a href="#l4.30"></a><span id="l4.30">         tab,</span>
<a href="#l4.31"></a><span id="l4.31">         tab.folderDisplay.view.dbView.getSelectedMsgHdrs()</span>
<a href="#l4.32"></a><span id="l4.32">       );</span>
<a href="#l4.33"></a><span id="l4.33">     }</span>
<a href="#l4.34"></a><span id="l4.34">   }</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-  addListenersToWindow(window) {</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-    window.addEventListener(&quot;select&quot;, uiListener.handleSelect);</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-  }</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-  removeListenersFromWindow(window) {</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-    window.removeEventListener(&quot;select&quot;, uiListener.handleSelect);</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-  }</span>
<a href="#l4.42"></a><span id="l4.42">   incrementListeners() {</span>
<a href="#l4.43"></a><span id="l4.43">     this.listenerCount++;</span>
<a href="#l4.44"></a><span id="l4.44">     if (this.listenerCount == 1) {</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-      for (let window of windowTracker.browserWindows()) {</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-        this.addListenersToWindow(window);</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-      }</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-      windowTracker.addOpenListener(this.addListenersToWindow);</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+      windowTracker.addListener(&quot;select&quot;, this);</span>
<a href="#l4.50"></a><span id="l4.50">     }</span>
<a href="#l4.51"></a><span id="l4.51">   }</span>
<a href="#l4.52"></a><span id="l4.52">   decrementListeners() {</span>
<a href="#l4.53"></a><span id="l4.53">     this.listenerCount--;</span>
<a href="#l4.54"></a><span id="l4.54">     if (this.listenerCount == 0) {</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-      for (let window of windowTracker.browserWindows()) {</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-        this.removeListenersFromWindow(window);</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-      }</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-      windowTracker.removeOpenListener(this.addListenersToWindow);</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+      windowTracker.removeListener(&quot;select&quot;, this);</span>
<a href="#l4.60"></a><span id="l4.60">       this.lastSelected = new WeakMap();</span>
<a href="#l4.61"></a><span id="l4.61">     }</span>
<a href="#l4.62"></a><span id="l4.62">   }</span>
<a href="#l4.63"></a><span id="l4.63"> })();</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65"> class PermissionedEventManager extends EventManager {</span>
<a href="#l4.66"></a><span id="l4.66">   constructor({ permission, context, name, register }) {</span>
<a href="#l4.67"></a><span id="l4.67">     super({ context, name, register });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-menus.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-menus.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -960,31 +960,35 @@ const menuTracker = {</span>
<a href="#l5.4"></a><span id="l5.4">     windowTracker.addOpenListener(this.onWindowOpen);</span>
<a href="#l5.5"></a><span id="l5.5">   },</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">   unregister() {</span>
<a href="#l5.8"></a><span id="l5.8">     Services.obs.removeObserver(this, &quot;on-build-contextmenu&quot;);</span>
<a href="#l5.9"></a><span id="l5.9">     for (const window of windowTracker.browserWindows()) {</span>
<a href="#l5.10"></a><span id="l5.10">       for (const id of this.menuIds) {</span>
<a href="#l5.11"></a><span id="l5.11">         const menu = window.document.getElementById(id);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-        menu.removeEventListener(&quot;popupshowing&quot;, this);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+        if (menu) {</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+          menu.removeEventListener(&quot;popupshowing&quot;, this);</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+        }</span>
<a href="#l5.16"></a><span id="l5.16">       }</span>
<a href="#l5.17"></a><span id="l5.17">     }</span>
<a href="#l5.18"></a><span id="l5.18">     windowTracker.removeOpenListener(this.onWindowOpen);</span>
<a href="#l5.19"></a><span id="l5.19">   },</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">   observe(subject, topic, data) {</span>
<a href="#l5.22"></a><span id="l5.22">     subject = subject.wrappedJSObject;</span>
<a href="#l5.23"></a><span id="l5.23">     gMenuBuilder.build(subject);</span>
<a href="#l5.24"></a><span id="l5.24">   },</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26">   onWindowOpen(window) {</span>
<a href="#l5.27"></a><span id="l5.27">     for (const id of menuTracker.menuIds) {</span>
<a href="#l5.28"></a><span id="l5.28">       const menu = window.document.getElementById(id);</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-      menu.addEventListener(&quot;popupshowing&quot;, menuTracker);</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+      if (menu) {</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+        menu.addEventListener(&quot;popupshowing&quot;, menuTracker);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+      }</span>
<a href="#l5.33"></a><span id="l5.33">     }</span>
<a href="#l5.34"></a><span id="l5.34">   },</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36">   handleEvent(event) {</span>
<a href="#l5.37"></a><span id="l5.37">     const menu = event.target;</span>
<a href="#l5.38"></a><span id="l5.38">     if (menu.id === &quot;tabContextMenu&quot;) {</span>
<a href="#l5.39"></a><span id="l5.39">       let trigger = menu.triggerNode;</span>
<a href="#l5.40"></a><span id="l5.40">       while (trigger &amp;&amp; trigger.localName != &quot;tab&quot;) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-tabs.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-tabs.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -115,17 +115,17 @@ class TabsUpdateFilterEventManager exten</span>
<a href="#l6.4"></a><span id="l6.4">             nonempty = true;</span>
<a href="#l6.5"></a><span id="l6.5">             result[prop] = changeInfo[prop];</span>
<a href="#l6.6"></a><span id="l6.6">           }</span>
<a href="#l6.7"></a><span id="l6.7">         }</span>
<a href="#l6.8"></a><span id="l6.8">         return nonempty &amp;&amp; result;</span>
<a href="#l6.9"></a><span id="l6.9">       }</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">       function getWindowID(windowId) {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-        if (windowId === Window.WINDOW_ID_CURRENT) {</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+        if (windowId === WindowBase.WINDOW_ID_CURRENT) {</span>
<a href="#l6.14"></a><span id="l6.14">           return windowTracker.getId(windowTracker.topWindow);</span>
<a href="#l6.15"></a><span id="l6.15">         }</span>
<a href="#l6.16"></a><span id="l6.16">         return windowId;</span>
<a href="#l6.17"></a><span id="l6.17">       }</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">       function matchFilters(tab, changed) {</span>
<a href="#l6.20"></a><span id="l6.20">         if (!filterProps) {</span>
<a href="#l6.21"></a><span id="l6.21">           return true;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -433,24 +433,33 @@ this.tabs = class extends ExtensionAPI {</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24">         async remove(tabs) {</span>
<a href="#l6.25"></a><span id="l6.25">           if (!Array.isArray(tabs)) {</span>
<a href="#l6.26"></a><span id="l6.26">             tabs = [tabs];</span>
<a href="#l6.27"></a><span id="l6.27">           }</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">           for (let tabId of tabs) {</span>
<a href="#l6.30"></a><span id="l6.30">             let nativeTabInfo = tabTracker.getTab(tabId);</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+            if (nativeTabInfo instanceof Ci.nsIDOMWindow) {</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+              nativeTabInfo.close();</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+              continue;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+            }</span>
<a href="#l6.35"></a><span id="l6.35">             let browser = getTabBrowser(nativeTabInfo);</span>
<a href="#l6.36"></a><span id="l6.36">             let tabmail = browser.ownerDocument.getElementById(&quot;tabmail&quot;);</span>
<a href="#l6.37"></a><span id="l6.37">             tabmail.closeTab(nativeTabInfo);</span>
<a href="#l6.38"></a><span id="l6.38">           }</span>
<a href="#l6.39"></a><span id="l6.39">         },</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41">         async update(tabId, updateProperties) {</span>
<a href="#l6.42"></a><span id="l6.42">           let nativeTabInfo = getTabOrActive(tabId);</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+          if (nativeTabInfo instanceof Ci.nsIDOMWindow) {</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+            throw new ExtensionError(</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+              &quot;tabs.update is not applicable to this tab.&quot;</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+            );</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+          }</span>
<a href="#l6.48"></a><span id="l6.48">           let browser = getTabBrowser(nativeTabInfo);</span>
<a href="#l6.49"></a><span id="l6.49">           let tabmail = browser.ownerDocument.getElementById(&quot;tabmail&quot;);</span>
<a href="#l6.50"></a><span id="l6.50"> </span>
<a href="#l6.51"></a><span id="l6.51">           if (updateProperties.url) {</span>
<a href="#l6.52"></a><span id="l6.52">             let url = context.uri.resolve(updateProperties.url);</span>
<a href="#l6.53"></a><span id="l6.53"> </span>
<a href="#l6.54"></a><span id="l6.54">             if (!context.checkLoadURL(url, { dontReportErrors: true })) {</span>
<a href="#l6.55"></a><span id="l6.55">               return Promise.reject({ message: `Illegal URL: ${url}` });</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineat">@@ -473,16 +482,21 @@ this.tabs = class extends ExtensionAPI {</span>
<a href="#l6.57"></a><span id="l6.57">             }</span>
<a href="#l6.58"></a><span id="l6.58">           }</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60">           return tabManager.convert(nativeTabInfo);</span>
<a href="#l6.61"></a><span id="l6.61">         },</span>
<a href="#l6.62"></a><span id="l6.62"> </span>
<a href="#l6.63"></a><span id="l6.63">         async reload(tabId, reloadProperties) {</span>
<a href="#l6.64"></a><span id="l6.64">           let nativeTabInfo = getTabOrActive(tabId);</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+          if (nativeTabInfo instanceof Ci.nsIDOMWindow) {</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+            throw new ExtensionError(</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+              &quot;tabs.reload is not applicable to this tab.&quot;</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+            );</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+          }</span>
<a href="#l6.70"></a><span id="l6.70">           let browser = getTabBrowser(nativeTabInfo);</span>
<a href="#l6.71"></a><span id="l6.71"> </span>
<a href="#l6.72"></a><span id="l6.72">           let flags = Ci.nsIWebNavigation.LOAD_FLAGS_NONE;</span>
<a href="#l6.73"></a><span id="l6.73">           if (reloadProperties &amp;&amp; reloadProperties.bypassCache) {</span>
<a href="#l6.74"></a><span id="l6.74">             flags |= Ci.nsIWebNavigation.LOAD_FLAGS_BYPASS_CACHE;</span>
<a href="#l6.75"></a><span id="l6.75">           }</span>
<a href="#l6.76"></a><span id="l6.76">           browser.reloadWithFlags(flags);</span>
<a href="#l6.77"></a><span id="l6.77">         },</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineat">@@ -573,16 +587,22 @@ this.tabs = class extends ExtensionAPI {</span>
<a href="#l6.79"></a><span id="l6.79">               move([tabA, tabB], {index: 0})</span>
<a href="#l6.80"></a><span id="l6.80">                 -&gt; tabA to 0, tabB to 0 if tabA and tabB are in different windows</span>
<a href="#l6.81"></a><span id="l6.81">           */</span>
<a href="#l6.82"></a><span id="l6.82">           let indexMap = new Map();</span>
<a href="#l6.83"></a><span id="l6.83">           let lastInsertion = new Map();</span>
<a href="#l6.84"></a><span id="l6.84"> </span>
<a href="#l6.85"></a><span id="l6.85">           let tabs = tabIds.map(tabId =&gt; tabTracker.getTab(tabId));</span>
<a href="#l6.86"></a><span id="l6.86">           for (let nativeTabInfo of tabs) {</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+            if (nativeTabInfo instanceof Ci.nsIDOMWindow) {</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+              throw new ExtensionError(</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+                &quot;tabs.move is not applicable to this tab.&quot;</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+              );</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+            }</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+</span>
<a href="#l6.93"></a><span id="l6.93">             // If the window is not specified, use the window from the tab.</span>
<a href="#l6.94"></a><span id="l6.94">             let browser = getTabBrowser(nativeTabInfo);</span>
<a href="#l6.95"></a><span id="l6.95"> </span>
<a href="#l6.96"></a><span id="l6.96">             let srcwindow = browser.ownerGlobal;</span>
<a href="#l6.97"></a><span id="l6.97">             let tgtwindow = destinationWindow || browser.ownerGlobal;</span>
<a href="#l6.98"></a><span id="l6.98">             let tgttabmail = tgtwindow.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l6.99"></a><span id="l6.99">             let srctabmail = srcwindow.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l6.100"></a><span id="l6.100"> </span>
<a href="#l6.101"></a><span id="l6.101" class="difflineat">@@ -635,16 +655,21 @@ this.tabs = class extends ExtensionAPI {</span>
<a href="#l6.102"></a><span id="l6.102"> </span>
<a href="#l6.103"></a><span id="l6.103">           return tabsMoved.map(nativeTabInfo =&gt;</span>
<a href="#l6.104"></a><span id="l6.104">             tabManager.convert(nativeTabInfo)</span>
<a href="#l6.105"></a><span id="l6.105">           );</span>
<a href="#l6.106"></a><span id="l6.106">         },</span>
<a href="#l6.107"></a><span id="l6.107"> </span>
<a href="#l6.108"></a><span id="l6.108">         duplicate(tabId) {</span>
<a href="#l6.109"></a><span id="l6.109">           let nativeTabInfo = tabTracker.getTab(tabId);</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+          if (nativeTabInfo instanceof Ci.nsIDOMWindow) {</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+            throw new ExtensionError(</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+              &quot;tabs.duplicate is not applicable to this tab.&quot;</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+            );</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+          }</span>
<a href="#l6.115"></a><span id="l6.115">           let browser = getTabBrowser(nativeTabInfo);</span>
<a href="#l6.116"></a><span id="l6.116">           let tabmail = browser.ownerDocument.getElementById(&quot;tabmail&quot;);</span>
<a href="#l6.117"></a><span id="l6.117"> </span>
<a href="#l6.118"></a><span id="l6.118">           // This is our best approximation of duplicating tabs. It might produce unreliable results</span>
<a href="#l6.119"></a><span id="l6.119">           let state = tabmail.persistTab(nativeTabInfo);</span>
<a href="#l6.120"></a><span id="l6.120">           let mode = tabmail.tabModes[state.mode];</span>
<a href="#l6.121"></a><span id="l6.121">           state.state.duplicate = true;</span>
<a href="#l6.122"></a><span id="l6.122"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-windows.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-windows.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -70,17 +70,17 @@ this.windows = class extends ExtensionAP</span>
<a href="#l7.4"></a><span id="l7.4">           register: fire =&gt; {</span>
<a href="#l7.5"></a><span id="l7.5">             // Keep track of the last windowId used to fire an onFocusChanged event</span>
<a href="#l7.6"></a><span id="l7.6">             let lastOnFocusChangedWindowId;</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8">             let listener = event =&gt; {</span>
<a href="#l7.9"></a><span id="l7.9">               // Wait a tick to avoid firing a superfluous WINDOW_ID_NONE</span>
<a href="#l7.10"></a><span id="l7.10">               // event when switching focus between two Thunderbird windows.</span>
<a href="#l7.11"></a><span id="l7.11">               Promise.resolve().then(() =&gt; {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-                let windowId = Window.WINDOW_ID_NONE;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+                let windowId = WindowBase.WINDOW_ID_NONE;</span>
<a href="#l7.14"></a><span id="l7.14">                 let window = Services.focus.activeWindow;</span>
<a href="#l7.15"></a><span id="l7.15">                 if (window) {</span>
<a href="#l7.16"></a><span id="l7.16">                   if (!context.canAccessWindow(window)) {</span>
<a href="#l7.17"></a><span id="l7.17">                     return;</span>
<a href="#l7.18"></a><span id="l7.18">                   }</span>
<a href="#l7.19"></a><span id="l7.19">                   windowId = windowTracker.getId(window);</span>
<a href="#l7.20"></a><span id="l7.20">                 }</span>
<a href="#l7.21"></a><span id="l7.21">                 if (windowId !== lastOnFocusChangedWindowId) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/extensions/schemas/windows.json</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/extensions/schemas/windows.json</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -6,17 +6,26 @@</span>
<a href="#l8.4"></a><span id="l8.4">   {</span>
<a href="#l8.5"></a><span id="l8.5">     &quot;namespace&quot;: &quot;windows&quot;,</span>
<a href="#l8.6"></a><span id="l8.6">     &quot;description&quot;: &quot;Use the &lt;code&gt;browser.windows&lt;/code&gt; API to interact with Thunderbird. You can use this API to create, modify, and rearrange windows.&quot;,</span>
<a href="#l8.7"></a><span id="l8.7">     &quot;types&quot;: [</span>
<a href="#l8.8"></a><span id="l8.8">       {</span>
<a href="#l8.9"></a><span id="l8.9">         &quot;id&quot;: &quot;WindowType&quot;,</span>
<a href="#l8.10"></a><span id="l8.10">         &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l8.11"></a><span id="l8.11">         &quot;description&quot;: &quot;The type of window this is. Under some circumstances a Window may not be assigned type property.&quot;,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-        &quot;enum&quot;: [&quot;normal&quot;, &quot;popup&quot;, &quot;panel&quot;, &quot;app&quot;, &quot;devtools&quot;]</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+        &quot;enum&quot;: [</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+          &quot;normal&quot;,</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+          &quot;popup&quot;,</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+          &quot;panel&quot;,</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+          &quot;app&quot;,</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+          &quot;devtools&quot;,</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+          &quot;addressBook&quot;,</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+          &quot;messageCompose&quot;,</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+          &quot;messageDisplay&quot;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+        ]</span>
<a href="#l8.23"></a><span id="l8.23">       },</span>
<a href="#l8.24"></a><span id="l8.24">       {</span>
<a href="#l8.25"></a><span id="l8.25">         &quot;id&quot;: &quot;WindowState&quot;,</span>
<a href="#l8.26"></a><span id="l8.26">         &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l8.27"></a><span id="l8.27">         &quot;description&quot;: &quot;The state of this window.&quot;,</span>
<a href="#l8.28"></a><span id="l8.28">         &quot;enum&quot;: [&quot;normal&quot;, &quot;minimized&quot;, &quot;maximized&quot;, &quot;fullscreen&quot;, &quot;docked&quot;]</span>
<a href="#l8.29"></a><span id="l8.29">       },</span>
<a href="#l8.30"></a><span id="l8.30">       {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/components/extensions/test/browser/browser.ini</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser.ini</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -14,12 +14,13 @@ tags = webextensions</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> [browser_ext_addressBooksUI.js]</span>
<a href="#l9.6"></a><span id="l9.6"> [browser_ext_browserAction.js]</span>
<a href="#l9.7"></a><span id="l9.7"> [browser_ext_commands_execute_browser_action.js]</span>
<a href="#l9.8"></a><span id="l9.8"> [browser_ext_commands_getAll.js]</span>
<a href="#l9.9"></a><span id="l9.9"> [browser_ext_commands_onCommand.js]</span>
<a href="#l9.10"></a><span id="l9.10"> [browser_ext_commands_update.js]</span>
<a href="#l9.11"></a><span id="l9.11"> [browser_ext_composeAction.js]</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+[browser_ext_mailTabs.js]</span>
<a href="#l9.13"></a><span id="l9.13"> [browser_ext_menus.js]</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-[browser_ext_mailTabs.js]</span>
<a href="#l9.15"></a><span id="l9.15"> [browser_ext_quickFilter.js]</span>
<a href="#l9.16"></a><span id="l9.16"> [browser_ext_windows.js]</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+[browser_ext_windows_types.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/components/extensions/test/browser/browser_ext_windows.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser_ext_windows.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -114,27 +114,28 @@ add_task(async () =&gt; {</span>
<a href="#l10.4"></a><span id="l10.4">       browser.windows.onFocusChanged.removeListener(listener.focusChanged);</span>
<a href="#l10.5"></a><span id="l10.5">       browser.windows.onRemoved.removeListener(listener.removed);</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7">       browser.test.notifyPass();</span>
<a href="#l10.8"></a><span id="l10.8">     },</span>
<a href="#l10.9"></a><span id="l10.9">   });</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">   let account = createAccount();</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+  // For some unknown reason, this test doesn't like switching to the main</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  // window if the thread tree has focus. Make sure it doesn't have focus.</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  document.getElementById(&quot;folderTree&quot;).focus();</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16">   await extension.startup();</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18">   await extension.awaitMessage(&quot;openWindow&quot;);</span>
<a href="#l10.19"></a><span id="l10.19">   let newWindowPromise = BrowserTestUtils.domWindowOpened();</span>
<a href="#l10.20"></a><span id="l10.20">   MsgOpenNewWindowForFolder(account.incomingServer.rootFolder.URI);</span>
<a href="#l10.21"></a><span id="l10.21">   let newWindow = await newWindowPromise;</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23">   await extension.awaitMessage(&quot;switchWindows&quot;);</span>
<a href="#l10.24"></a><span id="l10.24">   window.focus();</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26">   await extension.awaitMessage(&quot;closeWindow&quot;);</span>
<a href="#l10.27"></a><span id="l10.27">   newWindow.close();</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29">   await extension.awaitFinish();</span>
<a href="#l10.30"></a><span id="l10.30">   await extension.unload();</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-  cleanUpAccount(account);</span>
<a href="#l10.33"></a><span id="l10.33"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser_ext_windows_types.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,110 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+/* globals gFolderDisplay, gFolderTreeView, MsgOpenNewWindowForMessage */</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+let { BrowserTestUtils } = ChromeUtils.import(</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+  &quot;resource://testing-common/BrowserTestUtils.jsm&quot;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+  let extension = ExtensionTestUtils.loadExtension({</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+    async background() {</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+      function waitForEvent(eventName) {</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+        return new Promise(resolve =&gt; {</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+          let listener = arg1 =&gt; {</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+            browser.windows[eventName].removeListener(listener);</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+            resolve(arg1);</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+          };</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+          browser.windows[eventName].addListener(listener);</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+        });</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+      }</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+      // Address book window.</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+      let createdWindowPromise = waitForEvent(&quot;onCreated&quot;);</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+      await browser.addressBooks.openUI();</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+      let createdWindow = await createdWindowPromise;</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+      browser.test.assertEq(&quot;addressBook&quot;, createdWindow.type);</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+      let windowDetail = await browser.windows.get(createdWindow.id, {</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+        populate: true,</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+      });</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+      browser.test.assertEq(&quot;addressBook&quot;, windowDetail.type);</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+      browser.test.assertEq(1, windowDetail.tabs.length);</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+      let removedWindowPromise = waitForEvent(&quot;onRemoved&quot;);</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+      await browser.addressBooks.closeUI();</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+      await removedWindowPromise;</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+      // Message compose window.</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+      createdWindowPromise = waitForEvent(&quot;onCreated&quot;);</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+      await browser.compose.beginNew();</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+      createdWindow = await createdWindowPromise;</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+      browser.test.assertEq(&quot;messageCompose&quot;, createdWindow.type);</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+      windowDetail = await browser.windows.get(createdWindow.id, {</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+        populate: true,</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+      });</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+      browser.test.assertEq(&quot;messageCompose&quot;, windowDetail.type);</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+      browser.test.assertEq(1, windowDetail.tabs.length);</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+      removedWindowPromise = waitForEvent(&quot;onRemoved&quot;);</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+      await browser.tabs.remove(windowDetail.tabs[0].id);</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+      await removedWindowPromise;</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+      // Message display window.</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+      createdWindowPromise = waitForEvent(&quot;onCreated&quot;);</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+      browser.test.sendMessage(&quot;openMessage&quot;);</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+      createdWindow = await createdWindowPromise;</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+      browser.test.assertEq(&quot;messageDisplay&quot;, createdWindow.type);</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+      windowDetail = await browser.windows.get(createdWindow.id, {</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+        populate: true,</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+      });</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+      browser.test.assertEq(&quot;messageDisplay&quot;, windowDetail.type);</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+      browser.test.assertEq(1, windowDetail.tabs.length);</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+      removedWindowPromise = waitForEvent(&quot;onRemoved&quot;);</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+      browser.test.sendMessage(&quot;closeMessage&quot;);</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+      await removedWindowPromise;</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+      browser.test.notifyPass();</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+    },</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+    manifest: {</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+      permissions: [&quot;addressBooks&quot;],</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+    },</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+  });</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+  let account = createAccount();</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+  addIdentity(account);</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+  let rootFolder = account.incomingServer.rootFolder;</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+  rootFolder.createSubfolder(&quot;test1&quot;, null);</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+  let subFolders = {};</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+  for (let folder of rootFolder.subFolders) {</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+    subFolders[folder.name] = folder;</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+  }</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+  createMessages(subFolders.test1, 1);</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+  gFolderTreeView.selectFolder(subFolders.test1);</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+  gFolderDisplay.selectViewIndex(0);</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+  // For some unknown reason, this test doesn't like switching to the main</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+  // window if the thread tree has focus. Make sure it doesn't have focus.</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+  document.getElementById(&quot;folderTree&quot;).focus();</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+  await extension.startup();</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+  await extension.awaitMessage(&quot;openMessage&quot;);</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+  let newWindowPromise = BrowserTestUtils.domWindowOpened();</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+  MsgOpenNewWindowForMessage();</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+  let newWindow = await newWindowPromise;</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+  await extension.awaitMessage(&quot;closeMessage&quot;);</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+  newWindow.close();</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+  await extension.awaitFinish();</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+  await extension.unload();</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+});</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

