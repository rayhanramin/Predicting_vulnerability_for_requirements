<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 15353:e66c41fe9b48559f3e439810465e40afbfd541dd</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ e66c41fe9b48559f3e439810465e40afbfd541dd" />
<meta property="og:url" content="/comm-central/rev/e66c41fe9b48559f3e439810465e40afbfd541dd" />
<meta property="og:description" content="Bug 953867 - Add support for tabs with arbitrary content in the conversation window, r=Mic,florian." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / e66c41fe9b48559f3e439810465e40afbfd541dd 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/e66c41fe9b48559f3e439810465e40afbfd541dd">shortlog</a> |
<a href="/comm-central/log/e66c41fe9b48559f3e439810465e40afbfd541dd">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/e66c41fe9b48559f3e439810465e40afbfd541dd">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/e66c41fe9b48559f3e439810465e40afbfd541dd">files</a> |
changeset |
<a href="/comm-central/raw-rev/e66c41fe9b48559f3e439810465e40afbfd541dd">raw</a>  | <a href="/comm-central/archive/e66c41fe9b48559f3e439810465e40afbfd541dd.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=953867">Bug 953867</a> - Add support for tabs with arbitrary content in the conversation window, r=Mic,florian.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#78;&#105;&#104;&#97;&#110;&#116;&#104;&#32;&#83;&#117;&#98;&#114;&#97;&#109;&#97;&#110;&#121;&#97;&#32;&#60;&#110;&#104;&#110;&#116;&#49;&#49;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 21 Jun 2013 16:36:07 +0530</td></tr>

<tr>
 <td>changeset 15353</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/e66c41fe9b48559f3e439810465e40afbfd541dd">e66c41fe9b48559f3e439810465e40afbfd541dd</a></td>
</tr>



<tr>
<td>parent 15352</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6382b153ac35277b3c61e9267823122496299b3a">6382b153ac35277b3c61e9267823122496299b3a</a>
</td>
</tr>

<tr>
<td>child 15354</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1e72434937ef1a2ab24d5d5e7574cb60ff5768c4">1e72434937ef1a2ab24d5d5e7574cb60ff5768c4</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=e66c41fe9b48559f3e439810465e40afbfd541dd">9778</a></td></tr>
<tr><td>push user</td><td>florian@queze.net</td></tr>
<tr><td>push date</td><td class="date age">Sun, 12 Jan 2014 18:25:45 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f81a23bfefcd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Mic%29&revcount=50">Mic</a>, <a href="/comm-central/log?rev=reviewer%28florian%29&revcount=50">florian</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=953867">953867</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=953867">Bug 953867</a> - Add support for tabs with arbitrary content in the conversation window, r=Mic,florian.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/buddytooltip.xml">im/content/buddytooltip.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/buddytooltip.xml">file</a> |
<a href="/comm-central/annotate/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/buddytooltip.xml">annotate</a> |
<a href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/buddytooltip.xml">diff</a> |
<a href="/comm-central/comparison/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/buddytooltip.xml">comparison</a> |
<a href="/comm-central/log/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/buddytooltip.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/convZoom.js">im/content/convZoom.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/convZoom.js">file</a> |
<a href="/comm-central/annotate/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/convZoom.js">annotate</a> |
<a href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/convZoom.js">diff</a> |
<a href="/comm-central/comparison/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/convZoom.js">comparison</a> |
<a href="/comm-central/log/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/convZoom.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/conversation.xml">im/content/conversation.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/conversation.xml">file</a> |
<a href="/comm-central/annotate/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/conversation.xml">annotate</a> |
<a href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/conversation.xml">diff</a> |
<a href="/comm-central/comparison/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/conversation.xml">comparison</a> |
<a href="/comm-central/log/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/conversation.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/instantbird.js">im/content/instantbird.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/instantbird.js">file</a> |
<a href="/comm-central/annotate/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/instantbird.js">annotate</a> |
<a href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/instantbird.js">diff</a> |
<a href="/comm-central/comparison/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/instantbird.js">comparison</a> |
<a href="/comm-central/log/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/instantbird.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/instantbird.xul">im/content/instantbird.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/instantbird.xul">file</a> |
<a href="/comm-central/annotate/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/instantbird.xul">annotate</a> |
<a href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/instantbird.xul">diff</a> |
<a href="/comm-central/comparison/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/instantbird.xul">comparison</a> |
<a href="/comm-central/log/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/instantbird.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/macgestures.js">im/content/macgestures.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/macgestures.js">file</a> |
<a href="/comm-central/annotate/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/macgestures.js">annotate</a> |
<a href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/macgestures.js">diff</a> |
<a href="/comm-central/comparison/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/macgestures.js">comparison</a> |
<a href="/comm-central/log/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/macgestures.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/tabbrowser.css">im/content/tabbrowser.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/tabbrowser.css">file</a> |
<a href="/comm-central/annotate/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/tabbrowser.css">annotate</a> |
<a href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/tabbrowser.css">diff</a> |
<a href="/comm-central/comparison/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/tabbrowser.css">comparison</a> |
<a href="/comm-central/log/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/tabbrowser.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/tabbrowser.xml">im/content/tabbrowser.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/tabbrowser.xml">file</a> |
<a href="/comm-central/annotate/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/tabbrowser.xml">annotate</a> |
<a href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/tabbrowser.xml">diff</a> |
<a href="/comm-central/comparison/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/tabbrowser.xml">comparison</a> |
<a href="/comm-central/log/e66c41fe9b48559f3e439810465e40afbfd541dd/im/content/tabbrowser.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/en-US/chrome/instantbird/conversation.properties">im/locales/en-US/chrome/instantbird/conversation.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/en-US/chrome/instantbird/conversation.properties">file</a> |
<a href="/comm-central/annotate/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/en-US/chrome/instantbird/conversation.properties">annotate</a> |
<a href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/en-US/chrome/instantbird/conversation.properties">diff</a> |
<a href="/comm-central/comparison/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/en-US/chrome/instantbird/conversation.properties">comparison</a> |
<a href="/comm-central/log/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/en-US/chrome/instantbird/conversation.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/en-US/chrome/instantbird/tabbrowser.dtd">im/locales/en-US/chrome/instantbird/tabbrowser.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/en-US/chrome/instantbird/tabbrowser.dtd">file</a> |
<a href="/comm-central/annotate/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/en-US/chrome/instantbird/tabbrowser.dtd">annotate</a> |
<a href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/en-US/chrome/instantbird/tabbrowser.dtd">diff</a> |
<a href="/comm-central/comparison/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/en-US/chrome/instantbird/tabbrowser.dtd">comparison</a> |
<a href="/comm-central/log/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/en-US/chrome/instantbird/tabbrowser.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/jar.mn">im/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/e66c41fe9b48559f3e439810465e40afbfd541dd/im/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/modules/imWindows.jsm">im/modules/imWindows.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e66c41fe9b48559f3e439810465e40afbfd541dd/im/modules/imWindows.jsm">file</a> |
<a href="/comm-central/annotate/e66c41fe9b48559f3e439810465e40afbfd541dd/im/modules/imWindows.jsm">annotate</a> |
<a href="/comm-central/diff/e66c41fe9b48559f3e439810465e40afbfd541dd/im/modules/imWindows.jsm">diff</a> |
<a href="/comm-central/comparison/e66c41fe9b48559f3e439810465e40afbfd541dd/im/modules/imWindows.jsm">comparison</a> |
<a href="/comm-central/log/e66c41fe9b48559f3e439810465e40afbfd541dd/im/modules/imWindows.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/im/content/buddytooltip.xml</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/im/content/buddytooltip.xml</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -400,20 +400,19 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">          let elt = document.tooltipNode;</span>
<a href="#l1.6"></a><span id="l1.6">          // No tooltip for elements that have already been removed.</span>
<a href="#l1.7"></a><span id="l1.7">          if (!elt.parentNode)</span>
<a href="#l1.8"></a><span id="l1.8">            return false;</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10">          let localName = elt.localName;</span>
<a href="#l1.11"></a><span id="l1.11">          if (localName == &quot;tab&quot;) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-           let conv = elt.linkedConversation.conv;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-           if (conv)</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-             return updateTooltipFromConversation(conv, elt);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-           return false;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+           if (!elt.linkedConversation || !elt.linkedConversation.conv)</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+             return false;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+           return updateTooltipFromConversation(elt.linkedConversation.conv, elt);</span>
<a href="#l1.19"></a><span id="l1.19">          }</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21">          if (localName == &quot;conv&quot;)</span>
<a href="#l1.22"></a><span id="l1.22">            return updateTooltipFromConversation(elt.conv, elt);</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24">          if (localName == &quot;buddy&quot;)</span>
<a href="#l1.25"></a><span id="l1.25">            return updateTooltipFromBuddy(elt.buddy.preferredAccountBuddy, elt);</span>
<a href="#l1.26"></a><span id="l1.26"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/im/content/convZoom.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/im/content/convZoom.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -76,16 +76,19 @@ var FullZoom = {</span>
<a href="#l2.4"></a><span id="l2.4">    * Set the zoom level for the current browser.</span>
<a href="#l2.5"></a><span id="l2.5">    *</span>
<a href="#l2.6"></a><span id="l2.6">    * Per nsPresContext::setFullZoom, we can set the zoom to its current value</span>
<a href="#l2.7"></a><span id="l2.7">    * without significant impact on performance, as the setting is only applied</span>
<a href="#l2.8"></a><span id="l2.8">    * if it differs from the current setting.  In fact getting the zoom and then</span>
<a href="#l2.9"></a><span id="l2.9">    * checking ourselves if it differs costs more.</span>
<a href="#l2.10"></a><span id="l2.10">    **/</span>
<a href="#l2.11"></a><span id="l2.11">   applyPrefValue: function FullZoom_applyPrefValue() {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    // If there's no browser (non-conversation tabs), don't do anything.</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    if (!getBrowser())</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+      return;</span>
<a href="#l2.15"></a><span id="l2.15">     let value = parseFloat(Services.prefs.getCharPref(FullZoom.prefName));</span>
<a href="#l2.16"></a><span id="l2.16">     if (isNaN(value))</span>
<a href="#l2.17"></a><span id="l2.17">       value = 1;</span>
<a href="#l2.18"></a><span id="l2.18">     else if (value &lt; ZoomManager.MIN)</span>
<a href="#l2.19"></a><span id="l2.19">       value = ZoomManager.MIN;</span>
<a href="#l2.20"></a><span id="l2.20">     else if (value &gt; ZoomManager.MAX)</span>
<a href="#l2.21"></a><span id="l2.21">       value = ZoomManager.MAX;</span>
<a href="#l2.22"></a><span id="l2.22">     ZoomManager.zoom = value;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/im/content/conversation.xml</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/im/content/conversation.xml</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -142,16 +142,20 @@</span>
<a href="#l3.4"></a><span id="l3.4">         ]]&gt;</span>
<a href="#l3.5"></a><span id="l3.5">         &lt;/body&gt;</span>
<a href="#l3.6"></a><span id="l3.6">       &lt;/method&gt;</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">       &lt;method name=&quot;finishImport&quot;&gt;</span>
<a href="#l3.9"></a><span id="l3.9">         &lt;parameter name=&quot;aConversation&quot;/&gt;</span>
<a href="#l3.10"></a><span id="l3.10">         &lt;body&gt;</span>
<a href="#l3.11"></a><span id="l3.11">         &lt;![CDATA[</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+          // Swap the docshells.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+          this.browser.swapDocShells(aConversation.browser);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+          // Ensure observers are removed.</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+          aConversation.conv = null;</span>
<a href="#l3.16"></a><span id="l3.16">           this.editor.value = aConversation.editor.value;</span>
<a href="#l3.17"></a><span id="l3.17">           this.browser.browserResize();</span>
<a href="#l3.18"></a><span id="l3.18">           this.updateTyping();</span>
<a href="#l3.19"></a><span id="l3.19">           this.inputValueChanged();</span>
<a href="#l3.20"></a><span id="l3.20">           this.loaded = true;</span>
<a href="#l3.21"></a><span id="l3.21">           Services.obs.notifyObservers(this.browser, &quot;conversation-loaded&quot;, null);</span>
<a href="#l3.22"></a><span id="l3.22">         ]]&gt;</span>
<a href="#l3.23"></a><span id="l3.23">         &lt;/body&gt;</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineat">@@ -913,17 +917,17 @@</span>
<a href="#l3.25"></a><span id="l3.25">             input.style.overflowY = &quot;&quot;;</span>
<a href="#l3.26"></a><span id="l3.26">             // Set it to the maximum possible value.</span>
<a href="#l3.27"></a><span id="l3.27">             deck.height = oldDeckHeight + (topSize - topMinSize);</span>
<a href="#l3.28"></a><span id="l3.28">           }</span>
<a href="#l3.29"></a><span id="l3.29">         ]]&gt;</span>
<a href="#l3.30"></a><span id="l3.30">         &lt;/body&gt;</span>
<a href="#l3.31"></a><span id="l3.31">       &lt;/method&gt;</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-      &lt;method name=&quot;onConvResize&quot;&gt;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+      &lt;method name=&quot;onResize&quot;&gt;</span>
<a href="#l3.35"></a><span id="l3.35">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l3.36"></a><span id="l3.36">         &lt;body&gt;</span>
<a href="#l3.37"></a><span id="l3.37">         &lt;![CDATA[</span>
<a href="#l3.38"></a><span id="l3.38">           let splitter = this.getElt(&quot;splitter-bottom&quot;);</span>
<a href="#l3.39"></a><span id="l3.39">           let textbox = this.editor;</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41">           if (!splitter.hasAttribute(&quot;state&quot;)) {</span>
<a href="#l3.42"></a><span id="l3.42">             this.calculateTextboxDefaultHeight();</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineat">@@ -1472,25 +1476,95 @@</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45">           this.tab.removeAttribute(&quot;unread&quot;);</span>
<a href="#l3.46"></a><span id="l3.46">           this.tab.removeAttribute(&quot;attention&quot;);</span>
<a href="#l3.47"></a><span id="l3.47">           this._conv.markAsRead();</span>
<a href="#l3.48"></a><span id="l3.48">         ]]&gt;</span>
<a href="#l3.49"></a><span id="l3.49">         &lt;/body&gt;</span>
<a href="#l3.50"></a><span id="l3.50">       &lt;/method&gt;</span>
<a href="#l3.51"></a><span id="l3.51"> </span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+      &lt;method name=&quot;switchingToPanel&quot;&gt;</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+        &lt;![CDATA[</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+          if (this._visibleTimer)</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+            return;</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+          // Start a timer to detect if the tab has been visible to the</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+          // user for long enough to actually be seen (as opposed to the</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+          // tab only being visible &quot;accidentally in passing&quot;).</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+          delete this._wasVisible;</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+          this._visibleTimer = setTimeout(function() {</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+            this._wasVisible = true;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+            delete this._visibleTimer;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+          }.bind(this), 1000);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+        ]]&gt;</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+</span>
<a href="#l3.70"></a><span id="l3.70">       &lt;method name=&quot;focus&quot;&gt;</span>
<a href="#l3.71"></a><span id="l3.71">         &lt;body&gt;</span>
<a href="#l3.72"></a><span id="l3.72">         &lt;![CDATA[</span>
<a href="#l3.73"></a><span id="l3.73">           this.editor.focus();</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-          this.onSelect();</span>
<a href="#l3.75"></a><span id="l3.75">         ]]&gt;</span>
<a href="#l3.76"></a><span id="l3.76">         &lt;/body&gt;</span>
<a href="#l3.77"></a><span id="l3.77">       &lt;/method&gt;</span>
<a href="#l3.78"></a><span id="l3.78"> </span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+      &lt;method name=&quot;switchingAwayFromPanel&quot;&gt;</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+            if (this._visibleTimer) {</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+              clearTimeout(this._visibleTimer);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+              delete this._visibleTimer;</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+            }</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+            // Remove the unread ruler if the tab has been visible without</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+            // interruptions for sufficiently long.</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+            if (this._wasVisible)</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+              this.browser.removeUnreadRuler();</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+          ]]&gt;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+      &lt;method name=&quot;getPanelSpecificMenuItems&quot;&gt;</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+            let items = [];</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+            const XUL_NS =</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+              &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;;</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+            let bundle =</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+              Services.strings.createBundle(&quot;chrome://instantbird/locale/conversation.properties&quot;);</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+            let conv = this;</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+            function createMenuItem(aId, aCommandHandler) {</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+              let item = document.createElementNS(XUL_NS, &quot;menuitem&quot;);</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+              item.setAttribute(&quot;label&quot;, bundle.GetStringFromName(aId + &quot;.label&quot;));</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+              item.setAttribute(&quot;accesskey&quot;, bundle.GetStringFromName(aId + &quot;.accesskey&quot;));</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+              item.addEventListener(&quot;command&quot;, aCommandHandler);</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+              return item;</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+            }</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+            let showLogsItem = createMenuItem(&quot;contextShowLogs&quot;, function() conv.showLogs());</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+            showLogsItem.disabled = !this.hasLogs();</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+            items.push(showLogsItem);</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+            let hideConvItem = createMenuItem(&quot;contextHideConv&quot;, function() {</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+              conv.hide();</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+              document.getBindingParent(conv).removeTab(conv.tab);</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+            });</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+            items.push(hideConvItem);</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+            let closeConvItem = createMenuItem(&quot;contextCloseConv&quot;, function() {</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+              conv.close();</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+              document.getBindingParent(conv).removeTab(conv.tab);</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+            });</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+            items.push(closeConvItem);</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+            return items;</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+          ]]&gt;</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+</span>
<a href="#l3.132"></a><span id="l3.132">       &lt;method name=&quot;hasLogs&quot;&gt;</span>
<a href="#l3.133"></a><span id="l3.133">         &lt;body&gt;</span>
<a href="#l3.134"></a><span id="l3.134">         &lt;![CDATA[</span>
<a href="#l3.135"></a><span id="l3.135">           return Services.logs.getLogsForConversation(this.conv).hasMoreElements();</span>
<a href="#l3.136"></a><span id="l3.136">         ]]&gt;</span>
<a href="#l3.137"></a><span id="l3.137">         &lt;/body&gt;</span>
<a href="#l3.138"></a><span id="l3.138">       &lt;/method&gt;</span>
<a href="#l3.139"></a><span id="l3.139"> </span>
<a href="#l3.140"></a><span id="l3.140" class="difflineat">@@ -1658,18 +1732,20 @@</span>
<a href="#l3.141"></a><span id="l3.141">                        .forEach(function(a) this.addBuddy(a.buddy, true), this);</span>
<a href="#l3.142"></a><span id="l3.142">             this.updateParticipantCount();</span>
<a href="#l3.143"></a><span id="l3.143">             if (Services.prefs.getBoolPref(&quot;messenger.conversations.showNicks&quot;))</span>
<a href="#l3.144"></a><span id="l3.144">               this.browser.addTextModifier(this.getShowNickModifier());</span>
<a href="#l3.145"></a><span id="l3.145">           }</span>
<a href="#l3.146"></a><span id="l3.146">           else if (this._conv.contact &amp;&amp; this._conv.contact.getBuddies().length &gt; 1)</span>
<a href="#l3.147"></a><span id="l3.147">             this.getElt(&quot;conv-top-info&quot;).allowTargetChange();</span>
<a href="#l3.148"></a><span id="l3.148"> </span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-          if (this.tab)</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+          if (this.tab) {</span>
<a href="#l3.151"></a><span id="l3.151">             this.tab.setAttribute(&quot;label&quot;, this._conv.title);</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+            this.tab.setAttribute(&quot;tooltip&quot;, &quot;buddyTooltip&quot;);</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+          }</span>
<a href="#l3.154"></a><span id="l3.154"> </span>
<a href="#l3.155"></a><span id="l3.155">           if (!(&quot;Status&quot; in window))</span>
<a href="#l3.156"></a><span id="l3.156">             Components.utils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l3.157"></a><span id="l3.157">           this.updateConvStatus();</span>
<a href="#l3.158"></a><span id="l3.158">           this.initTextboxFormat();</span>
<a href="#l3.159"></a><span id="l3.159">         ]]&gt;</span>
<a href="#l3.160"></a><span id="l3.160">         &lt;/body&gt;</span>
<a href="#l3.161"></a><span id="l3.161">       &lt;/method&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/im/content/instantbird.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/im/content/instantbird.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -10,17 +10,17 @@ var convWindow = {</span>
<a href="#l4.4"></a><span id="l4.4">     Components.utils.import(&quot;resource:///modules/imWindows.jsm&quot;);</span>
<a href="#l4.5"></a><span id="l4.5">     Conversations.registerWindow(window);</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">     if (&quot;arguments&quot; in window) {</span>
<a href="#l4.8"></a><span id="l4.8">       while (window.arguments[0] instanceof XULElement) {</span>
<a href="#l4.9"></a><span id="l4.9">         // swap the given tab with the default dummy conversation tab</span>
<a href="#l4.10"></a><span id="l4.10">         // and then close the original tab in the other window.</span>
<a href="#l4.11"></a><span id="l4.11">         let tab = window.arguments.shift();</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-        document.getElementById(&quot;conversations&quot;).importConversation(tab);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+        getTabBrowser().importPanel(tab);</span>
<a href="#l4.14"></a><span id="l4.14">       }</span>
<a href="#l4.15"></a><span id="l4.15">     }</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17">     window.addEventListener(&quot;unload&quot;, convWindow.unload);</span>
<a href="#l4.18"></a><span id="l4.18">     window.addEventListener(&quot;resize&quot;, convWindow.onresize);</span>
<a href="#l4.19"></a><span id="l4.19">     window.addEventListener(&quot;activate&quot;, convWindow.onactivate, true);</span>
<a href="#l4.20"></a><span id="l4.20">     window.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l4.21"></a><span id="l4.21">           .getInterface(Ci.nsIWebNavigation)</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -31,39 +31,43 @@ var convWindow = {</span>
<a href="#l4.23"></a><span id="l4.23">   },</span>
<a href="#l4.24"></a><span id="l4.24">   unload: function mo_unload() {</span>
<a href="#l4.25"></a><span id="l4.25">     Conversations.unregisterWindow(window);</span>
<a href="#l4.26"></a><span id="l4.26">   },</span>
<a href="#l4.27"></a><span id="l4.27">   onactivate: function mo_onactivate(aEvent) {</span>
<a href="#l4.28"></a><span id="l4.28">     Conversations.onWindowFocus(window);</span>
<a href="#l4.29"></a><span id="l4.29">     setTimeout(function () {</span>
<a href="#l4.30"></a><span id="l4.30">       // setting the focus to the textbox just after the window is</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-      // activated puts the textbox in an unconsistant state, some</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+      // activated puts the textbox in an inconsistent state, some</span>
<a href="#l4.33"></a><span id="l4.33">       // special characters like ^ don't work, so delay the focus</span>
<a href="#l4.34"></a><span id="l4.34">       // operation...</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-      getBrowser().selectedConversation.focus();</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+      let panel = getTabBrowser().selectedPanel;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+      panel.focus();</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+      if (&quot;onSelect&quot; in panel)</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+        panel.onSelect();</span>
<a href="#l4.40"></a><span id="l4.40">     }, 0);</span>
<a href="#l4.41"></a><span id="l4.41">   },</span>
<a href="#l4.42"></a><span id="l4.42">   onresize: function mo_onresize(aEvent) {</span>
<a href="#l4.43"></a><span id="l4.43">     if (aEvent.originalTarget != window)</span>
<a href="#l4.44"></a><span id="l4.44">       return;</span>
<a href="#l4.45"></a><span id="l4.45"> </span>
<a href="#l4.46"></a><span id="l4.46">     // Resize each textbox (if the splitter has not been used).</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-    let convs = getBrowser().conversations;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-    for each (let conv in convs)</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-      conv.onConvResize(aEvent);</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+    let panels = getTabBrowser().tabPanels;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    for (let panel of panels) {</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+      if (&quot;onResize&quot; in panel)</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+        panel.onResize(aEvent);</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+    }</span>
<a href="#l4.55"></a><span id="l4.55">   }</span>
<a href="#l4.56"></a><span id="l4.56"> };</span>
<a href="#l4.57"></a><span id="l4.57"> </span>
<a href="#l4.58"></a><span id="l4.58"> function getConvWindowURL() &quot;chrome://instantbird/content/instantbird.xul&quot;</span>
<a href="#l4.59"></a><span id="l4.59"> </span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-function getBrowser()</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-{</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-  return document.getElementById(&quot;conversations&quot;);</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-}</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+function getTabBrowser() document.getElementById(&quot;conversations&quot;)</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+function getBrowser() getTabBrowser().selectedBrowser</span>
<a href="#l4.67"></a><span id="l4.67"> </span>
<a href="#l4.68"></a><span id="l4.68"> // Copied from mozilla/browser/base/content/browser.js (and simplified)</span>
<a href="#l4.69"></a><span id="l4.69"> var XULBrowserWindow = {</span>
<a href="#l4.70"></a><span id="l4.70">   // Stored Status</span>
<a href="#l4.71"></a><span id="l4.71">   status: &quot;&quot;,</span>
<a href="#l4.72"></a><span id="l4.72">   defaultStatus: &quot;&quot;,</span>
<a href="#l4.73"></a><span id="l4.73">   jsStatus: &quot;&quot;,</span>
<a href="#l4.74"></a><span id="l4.74">   jsDefaultStatus: &quot;&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/im/content/instantbird.xul</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/im/content/instantbird.xul</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -27,17 +27,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> &lt;window</span>
<a href="#l5.5"></a><span id="l5.5">   id     = &quot;convWindow&quot;</span>
<a href="#l5.6"></a><span id="l5.6">   windowtype=&quot;Messenger:convs&quot;</span>
<a href="#l5.7"></a><span id="l5.7">   title  = &quot;&amp;convWindow.title;&quot;</span>
<a href="#l5.8"></a><span id="l5.8">   titlemenuseparator=&quot;&amp;convWindow.titlemodifiermenuseparator;&quot;</span>
<a href="#l5.9"></a><span id="l5.9">   titlemodifier=&quot;&amp;convWindow.titlemodifier;&quot;</span>
<a href="#l5.10"></a><span id="l5.10">   width  = &quot;500&quot;</span>
<a href="#l5.11"></a><span id="l5.11">   height = &quot;600&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  onclose= &quot;return getBrowser().warnAboutClosingTabs(true);&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  onclose= &quot;return getTabBrowser().warnAboutClosingTabs(true);&quot;</span>
<a href="#l5.14"></a><span id="l5.14">   persist= &quot;width height screenX screenY&quot;</span>
<a href="#l5.15"></a><span id="l5.15">   xmlns:svg=&quot;http://www.w3.org/2000/svg&quot;</span>
<a href="#l5.16"></a><span id="l5.16">   xmlns  = &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l5.17"></a><span id="l5.17">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://instantbird/content/utilities.js&quot;/&gt;</span>
<a href="#l5.18"></a><span id="l5.18">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://instantbird/content/instantbird.js&quot;/&gt;</span>
<a href="#l5.19"></a><span id="l5.19"> #ifdef XP_MACOSX</span>
<a href="#l5.20"></a><span id="l5.20">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://instantbird/content/macgestures.js&quot;/&gt;</span>
<a href="#l5.21"></a><span id="l5.21"> #else</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -47,30 +47,37 @@</span>
<a href="#l5.23"></a><span id="l5.23">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://instantbird/content/convZoom.js&quot;/&gt;</span>
<a href="#l5.24"></a><span id="l5.24">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://instantbird/content/nsContextMenu.js&quot;/&gt;</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26"> #ifdef XP_MACOSX</span>
<a href="#l5.27"></a><span id="l5.27"> #include menus.xul.inc</span>
<a href="#l5.28"></a><span id="l5.28"> #endif</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30">   &lt;commandset id=&quot;conversationsCommands&quot;&gt;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-    &lt;command id=&quot;cmd_close&quot; oncommand=&quot;document.getElementById('conversations').removeCurrentTab()&quot;/&gt;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-    &lt;command id=&quot;cmd_putOnHold&quot; oncommand=&quot;var tabbrowser = document.getElementById('conversations');</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-                                           tabbrowser.mCurrentTab.linkedConversation.hide();</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-                                           tabbrowser.removeTab(tabbrowser.mCurrentTab);&quot;/&gt;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-    &lt;command id=&quot;cmd_showLogs&quot; oncommand=&quot;document.getElementById('conversations').mCurrentTab.linkedConversation.showLogs();&quot;/&gt;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-    &lt;command id=&quot;cmd_textZoomReduce&quot; oncommand=&quot;FullZoom.reduce();&quot;/&gt;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-    &lt;command id=&quot;cmd_textZoomEnlarge&quot; oncommand=&quot;FullZoom.enlarge();&quot;/&gt;</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-    &lt;command id=&quot;cmd_textZoomReset&quot; oncommand=&quot;FullZoom.reset();&quot;/&gt;</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+    &lt;command id=&quot;cmd_close&quot; oncommand=&quot;getTabBrowser().removeCurrentTab()&quot;/&gt;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+    &lt;command id=&quot;cmd_putOnHold&quot;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+             oncommand=&quot;var tabbrowser = getTabBrowser();</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+                        if (!tabbrowser.selectedConversation) return;</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+                        tabbrowser.selectedConversation.hide();</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+                        tabbrowser.removeCurrentTab();&quot;/&gt;</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+    &lt;command id=&quot;cmd_showLogs&quot;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+             oncommand=&quot;var conv = getTabBrowser().selectedConversation;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+                        if (conv) conv.showLogs();&quot;/&gt;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+    &lt;command id=&quot;cmd_textZoomReduce&quot; oncommand=&quot;if (getBrowser()) FullZoom.reduce();&quot;/&gt;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+    &lt;command id=&quot;cmd_textZoomEnlarge&quot; oncommand=&quot;if (getBrowser()) FullZoom.enlarge();&quot;/&gt;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+    &lt;command id=&quot;cmd_textZoomReset&quot; oncommand=&quot;if (getBrowser()) FullZoom.reset();&quot;/&gt;</span>
<a href="#l5.51"></a><span id="l5.51">     &lt;command id=&quot;cmd_find&quot;</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-             oncommand=&quot;document.getElementById('conversations').findbar.onFindCommand();&quot;/&gt;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+             oncommand=&quot;var conv = getTabBrowser().selectedConversation;</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+                        if (conv) conv.findbar.onFindCommand();&quot;/&gt;</span>
<a href="#l5.55"></a><span id="l5.55">     &lt;command id=&quot;cmd_findAgain&quot;</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-             oncommand=&quot;document.getElementById('conversations').findbar.onFindAgainCommand(false);&quot;/&gt;</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+             oncommand=&quot;var conv = getTabBrowser().selectedConversation;</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+                        if (conv) conv.findbar.onFindAgainCommand(false);&quot;/&gt;</span>
<a href="#l5.59"></a><span id="l5.59">     &lt;command id=&quot;cmd_findPrevious&quot;</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-             oncommand=&quot;document.getElementById('conversations').findbar.onFindAgainCommand(true);&quot;/&gt;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+             oncommand=&quot;var conv = getTabBrowser().selectedConversation;</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+                        if (conv) conv.findbar.onFindAgainCommand(true);&quot;/&gt;</span>
<a href="#l5.63"></a><span id="l5.63">     &lt;commandset id=&quot;editMenuCommands&quot;/&gt;</span>
<a href="#l5.64"></a><span id="l5.64">   &lt;/commandset&gt;</span>
<a href="#l5.65"></a><span id="l5.65"> </span>
<a href="#l5.66"></a><span id="l5.66">   &lt;keyset id=&quot;conversationsKeys&quot;&gt;</span>
<a href="#l5.67"></a><span id="l5.67">     &lt;key id=&quot;key_close&quot; key=&quot;w&quot; modifiers=&quot;accel&quot; command=&quot;cmd_close&quot;/&gt;</span>
<a href="#l5.68"></a><span id="l5.68">     &lt;key id=&quot;key_putOnHold&quot; keycode=&quot;VK_ESCAPE&quot; command=&quot;cmd_putOnHold&quot;/&gt;</span>
<a href="#l5.69"></a><span id="l5.69">     &lt;key id=&quot;key_showLogs&quot; key=&quot;h&quot; modifiers=&quot;accel,shift&quot; command=&quot;cmd_showLogs&quot;/&gt;</span>
<a href="#l5.70"></a><span id="l5.70">     &lt;key id=&quot;key_textZoomEnlarge&quot; key=&quot;&amp;textEnlarge.commandkey;&quot; command=&quot;cmd_textZoomEnlarge&quot; modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineat">@@ -91,38 +98,38 @@</span>
<a href="#l5.72"></a><span id="l5.72"> #define XP_LINUX</span>
<a href="#l5.73"></a><span id="l5.73"> #endif</span>
<a href="#l5.74"></a><span id="l5.74"> #endif</span>
<a href="#l5.75"></a><span id="l5.75"> #ifdef XP_LINUX</span>
<a href="#l5.76"></a><span id="l5.76"> #define NUM_SELECT_TAB_MODIFIER alt</span>
<a href="#l5.77"></a><span id="l5.77"> #else</span>
<a href="#l5.78"></a><span id="l5.78"> #define NUM_SELECT_TAB_MODIFIER accel</span>
<a href="#l5.79"></a><span id="l5.79"> #endif</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-#expand    &lt;key id=&quot;key_selectTab1&quot; oncommand=&quot;getBrowser().selectTabAtIndex(0, event);&quot; key=&quot;1&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-#expand    &lt;key id=&quot;key_selectTab2&quot; oncommand=&quot;getBrowser().selectTabAtIndex(1, event);&quot; key=&quot;2&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-#expand    &lt;key id=&quot;key_selectTab3&quot; oncommand=&quot;getBrowser().selectTabAtIndex(2, event);&quot; key=&quot;3&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-#expand    &lt;key id=&quot;key_selectTab4&quot; oncommand=&quot;getBrowser().selectTabAtIndex(3, event);&quot; key=&quot;4&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-#expand    &lt;key id=&quot;key_selectTab5&quot; oncommand=&quot;getBrowser().selectTabAtIndex(4, event);&quot; key=&quot;5&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-#expand    &lt;key id=&quot;key_selectTab6&quot; oncommand=&quot;getBrowser().selectTabAtIndex(5, event);&quot; key=&quot;6&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-#expand    &lt;key id=&quot;key_selectTab7&quot; oncommand=&quot;getBrowser().selectTabAtIndex(6, event);&quot; key=&quot;7&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-#expand    &lt;key id=&quot;key_selectTab8&quot; oncommand=&quot;getBrowser().selectTabAtIndex(7, event);&quot; key=&quot;8&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-#expand    &lt;key id=&quot;key_selectLastTab&quot; oncommand=&quot;getBrowser().selectTabAtIndex(-1, event);&quot; key=&quot;9&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+#expand    &lt;key id=&quot;key_selectTab1&quot; oncommand=&quot;getTabBrowser().selectTabAtIndex(0, event);&quot; key=&quot;1&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+#expand    &lt;key id=&quot;key_selectTab2&quot; oncommand=&quot;getTabBrowser().selectTabAtIndex(1, event);&quot; key=&quot;2&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+#expand    &lt;key id=&quot;key_selectTab3&quot; oncommand=&quot;getTabBrowser().selectTabAtIndex(2, event);&quot; key=&quot;3&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+#expand    &lt;key id=&quot;key_selectTab4&quot; oncommand=&quot;getTabBrowser().selectTabAtIndex(3, event);&quot; key=&quot;4&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+#expand    &lt;key id=&quot;key_selectTab5&quot; oncommand=&quot;getTabBrowser().selectTabAtIndex(4, event);&quot; key=&quot;5&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+#expand    &lt;key id=&quot;key_selectTab6&quot; oncommand=&quot;getTabBrowser().selectTabAtIndex(5, event);&quot; key=&quot;6&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+#expand    &lt;key id=&quot;key_selectTab7&quot; oncommand=&quot;getTabBrowser().selectTabAtIndex(6, event);&quot; key=&quot;7&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+#expand    &lt;key id=&quot;key_selectTab8&quot; oncommand=&quot;getTabBrowser().selectTabAtIndex(7, event);&quot; key=&quot;8&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+#expand    &lt;key id=&quot;key_selectLastTab&quot; oncommand=&quot;getTabBrowser().selectTabAtIndex(-1, event);&quot; key=&quot;9&quot; modifiers=&quot;__NUM_SELECT_TAB_MODIFIER__&quot;/&gt;</span>
<a href="#l5.98"></a><span id="l5.98">   &lt;/keyset&gt;</span>
<a href="#l5.99"></a><span id="l5.99"> </span>
<a href="#l5.100"></a><span id="l5.100">   &lt;stringbundleset id=&quot;stringbundleset&quot;&gt;</span>
<a href="#l5.101"></a><span id="l5.101">     &lt;stringbundle id=&quot;bundle_instantbird&quot; src=&quot;chrome://instantbird/locale/instantbird.properties&quot;/&gt;</span>
<a href="#l5.102"></a><span id="l5.102">   &lt;/stringbundleset&gt;</span>
<a href="#l5.103"></a><span id="l5.103"> </span>
<a href="#l5.104"></a><span id="l5.104">   &lt;popupset id=&quot;mainPopupSet&quot;&gt;</span>
<a href="#l5.105"></a><span id="l5.105">     &lt;tooltip id=&quot;aHTMLTooltip&quot;</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-             onpopupshowing=&quot;return getBrowser().selectedBrowser.FillInHTMLTooltip(document.tooltipNode);&quot;/&gt;</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+             onpopupshowing=&quot;return getBrowser().FillInHTMLTooltip(document.tooltipNode);&quot;/&gt;</span>
<a href="#l5.108"></a><span id="l5.108">     &lt;tooltip id=&quot;buddyTooltip&quot; type=&quot;buddy&quot;/&gt;</span>
<a href="#l5.109"></a><span id="l5.109"> </span>
<a href="#l5.110"></a><span id="l5.110">     &lt;menupopup id=&quot;contentAreaContextMenu&quot;</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-               onpopupshowing=&quot;if (event.target != this) return true; gContextMenu = new nsContextMenu(this, window.getBrowser()); return gContextMenu.shouldDisplay;&quot;</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+               onpopupshowing=&quot;if (event.target != this) return true; gContextMenu = new nsContextMenu(this, window.getTabBrowser()); return gContextMenu.shouldDisplay;&quot;</span>
<a href="#l5.113"></a><span id="l5.113">                onpopuphiding=&quot;if (event.target == this &amp;amp;&amp;amp; gContextMenu) { gContextMenu.cleanup(); gContextMenu = null; }&quot;&gt;</span>
<a href="#l5.114"></a><span id="l5.114">       &lt;menuitem id=&quot;context-openlink&quot;</span>
<a href="#l5.115"></a><span id="l5.115">                 label=&quot;&amp;openLinkCmd.label;&quot;</span>
<a href="#l5.116"></a><span id="l5.116">                 accesskey=&quot;&amp;openLinkCmd.accesskey;&quot;</span>
<a href="#l5.117"></a><span id="l5.117">                 oncommand=&quot;gContextMenu.openLink();&quot;/&gt;</span>
<a href="#l5.118"></a><span id="l5.118">       &lt;menuitem id=&quot;context-copyemail&quot;</span>
<a href="#l5.119"></a><span id="l5.119">                 label=&quot;&amp;copyEmailCmd.label;&quot;</span>
<a href="#l5.120"></a><span id="l5.120">                 accesskey=&quot;&amp;copyEmailCmd.accesskey;&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/im/content/macgestures.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/im/content/macgestures.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -143,24 +143,36 @@ let gGestureSupport = {</span>
<a href="#l6.4"></a><span id="l6.4">         if (this._tabs)</span>
<a href="#l6.5"></a><span id="l6.5">           this._tabs.selectedIndex--;</span>
<a href="#l6.6"></a><span id="l6.6">         break;</span>
<a href="#l6.7"></a><span id="l6.7">       case &quot;twist-right&quot;:</span>
<a href="#l6.8"></a><span id="l6.8">         if (this._tabs)</span>
<a href="#l6.9"></a><span id="l6.9">           this._tabs.selectedIndex++;</span>
<a href="#l6.10"></a><span id="l6.10">         break;</span>
<a href="#l6.11"></a><span id="l6.11">       case &quot;swipe-down&quot;:</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+        // This gesture isn't available if there's no browser.</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+        if (!getBrowser())</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+          break;</span>
<a href="#l6.15"></a><span id="l6.15">         if (aEvent.originalTarget.ownerDocument == getBrowser().contentDocument)</span>
<a href="#l6.16"></a><span id="l6.16">           getBrowser().contentWindow.focus();</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-        getBrowser().selectedBrowser.scrollToNextSection();</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+        if (getTabBrowser().selectedConversation)</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+          getBrowser().scrollToNextSection();</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+        else</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+          goDoCommand(&quot;cmd_scrollBottom&quot;);</span>
<a href="#l6.22"></a><span id="l6.22">         break;</span>
<a href="#l6.23"></a><span id="l6.23">       case &quot;swipe-up&quot;:</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+        // This gesture isn't available if there's no browser.</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+        if (!getBrowser())</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+          break;</span>
<a href="#l6.27"></a><span id="l6.27">         if (aEvent.originalTarget.ownerDocument == getBrowser().contentDocument)</span>
<a href="#l6.28"></a><span id="l6.28">           getBrowser().contentWindow.focus();</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-        getBrowser().selectedBrowser.scrollToPreviousSection();</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+        if (getTabBrowser().selectedConversation)</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+          getBrowser().scrollToPreviousSection();</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+        else</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+          goDoCommand(&quot;cmd_scrollTop&quot;);</span>
<a href="#l6.34"></a><span id="l6.34">         break;</span>
<a href="#l6.35"></a><span id="l6.35">       case &quot;swipe-left&quot;:</span>
<a href="#l6.36"></a><span id="l6.36">       case &quot;swipe-right&quot;:</span>
<a href="#l6.37"></a><span id="l6.37">         var newIndex = -1;</span>
<a href="#l6.38"></a><span id="l6.38">         if (this._lastSelectedTab)</span>
<a href="#l6.39"></a><span id="l6.39">           newIndex = this._tabs.getIndexOfItem(this._lastSelectedTab);</span>
<a href="#l6.40"></a><span id="l6.40">         if (newIndex == -1)</span>
<a href="#l6.41"></a><span id="l6.41">           newIndex =</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/im/content/tabbrowser.css</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/im/content/tabbrowser.css</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -48,8 +48,13 @@ tabconversation {</span>
<a href="#l7.4"></a><span id="l7.4">   display: none;</span>
<a href="#l7.5"></a><span id="l7.5"> }</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> .tabs-newtab-button,</span>
<a href="#l7.8"></a><span id="l7.8"> #context_newTab,</span>
<a href="#l7.9"></a><span id="l7.9"> #context_newTabSeparator {</span>
<a href="#l7.10"></a><span id="l7.10">   display: none;</span>
<a href="#l7.11"></a><span id="l7.11"> }</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+/* Ensure two menuseparators aren't shown together when no tab-specific menuitems exist */</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+#context_tabSpecificStartSeparator + #context_tabSpecificEndSeparator {</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  display: none;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/im/content/tabbrowser.xml</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/im/content/tabbrowser.xml</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -20,82 +20,69 @@</span>
<a href="#l8.4"></a><span id="l8.4">   &lt;binding id=&quot;tabbrowser&quot;&gt;</span>
<a href="#l8.5"></a><span id="l8.5">     &lt;resources&gt;</span>
<a href="#l8.6"></a><span id="l8.6">       &lt;stylesheet src=&quot;chrome://instantbird/content/tabbrowser.css&quot;/&gt;</span>
<a href="#l8.7"></a><span id="l8.7">     &lt;/resources&gt;</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9">     &lt;content&gt;</span>
<a href="#l8.10"></a><span id="l8.10">       &lt;xul:stringbundle anonid=&quot;tbstringbundle&quot; src=&quot;chrome://instantbird/locale/tabbrowser.properties&quot;/&gt;</span>
<a href="#l8.11"></a><span id="l8.11">       &lt;xul:tabbox anonid=&quot;tabbox&quot; flex=&quot;1&quot; eventnode=&quot;document&quot; xbl:inherits=&quot;handleCtrlPageUpDown&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-                  onselect=&quot;if (!('updateCurrentBrowser' in this.parentNode) || event.target.localName != 'tabpanels') return; this.parentNode.updateCurrentBrowser();&quot;&gt;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+                  onselect=&quot;if (event.target.localName != 'tabpanels') return;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+                            document.getBindingParent(this).updateCurrentTab();&quot;&gt;</span>
<a href="#l8.15"></a><span id="l8.15">         &lt;xul:hbox class=&quot;tab-drop-indicator-bar&quot; collapsed=&quot;true&quot; chromedir=&quot;&amp;locale.dir;&quot;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-                  ondragover=&quot;this.parentNode.parentNode._onDragOver(event);&quot;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-                  ondragleave=&quot;this.parentNode.parentNode._onDragLeave(event);&quot;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-                  ondrop=&quot;this.parentNode.parentNode._onDrop(event);&quot;&gt;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+                  ondragover=&quot;document.getBindingParent(this)._onDragOver(event);&quot;</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+                  ondragleave=&quot;document.getBindingParent(this)._onDragLeave(event);&quot;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+                  ondrop=&quot;document.getBindingParent(this)._onDrop(event);&quot;&gt;</span>
<a href="#l8.22"></a><span id="l8.22">           &lt;xul:hbox class=&quot;tab-drop-indicator&quot; mousethrough=&quot;always&quot;/&gt;</span>
<a href="#l8.23"></a><span id="l8.23">         &lt;/xul:hbox&gt;</span>
<a href="#l8.24"></a><span id="l8.24">         &lt;xul:hbox class=&quot;tabbrowser-strip&quot; collapsed=&quot;true&quot;</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-                  tooltip=&quot;buddyTooltip&quot; context=&quot;_child&quot;</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+                  context=&quot;_child&quot;</span>
<a href="#l8.27"></a><span id="l8.27">                   anonid=&quot;strip&quot;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-                  ondragstart=&quot;this.parentNode.parentNode._onDragStart(event);&quot;</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-                  ondragover=&quot;this.parentNode.parentNode._onDragOver(event);&quot;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-                  ondrop=&quot;this.parentNode.parentNode._onDrop(event);&quot;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-                  ondragend=&quot;this.parentNode.parentNode._onDragEnd(event);&quot;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-                  ondragleave=&quot;this.parentNode.parentNode._onDragLeave(event);&quot;&gt;</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-          &lt;xul:menupopup id=&quot;tabContextMenu&quot; onpopupshowing=&quot;return this.parentNode.parentNode.parentNode.updatePopupMenu(this);&quot;&gt;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+                  ondragstart=&quot;document.getBindingParent(this)._onDragStart(event);&quot;</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+                  ondragover=&quot;document.getBindingParent(this)._onDragOver(event);&quot;</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+                  ondrop=&quot;document.getBindingParent(this)._onDrop(event);&quot;</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+                  ondragend=&quot;document.getBindingParent(this)._onDragEnd(event);&quot;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+                  ondragleave=&quot;document.getBindingParent(this)._onDragLeave(event);&quot;&gt;</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+          &lt;xul:menupopup id=&quot;tabContextMenu&quot; onpopupshowing=&quot;return document.getBindingParent(this).tabContextMenuShowing(this);&quot;</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+                  onpopuphiding=&quot;return document.getBindingParent(this).tabContextMenuHiding(this)&quot;&gt;</span>
<a href="#l8.41"></a><span id="l8.41">             &lt;xul:menuitem id=&quot;context_newTab&quot; label=&quot;&amp;newTab.label;&quot; accesskey=&quot;&amp;newTab.accesskey;&quot;</span>
<a href="#l8.42"></a><span id="l8.42">                           xbl:inherits=&quot;oncommand=onnewtab&quot;/&gt;</span>
<a href="#l8.43"></a><span id="l8.43">             &lt;xul:menuseparator id=&quot;context_newTabSeparator&quot;/&gt;</span>
<a href="#l8.44"></a><span id="l8.44">             &lt;xul:menuitem id=&quot;context_openTabInWindow&quot; label=&quot;&amp;openTabInNewWindow.label;&quot;</span>
<a href="#l8.45"></a><span id="l8.45">                           accesskey=&quot;&amp;openTabInNewWindow.accesskey;&quot;</span>
<a href="#l8.46"></a><span id="l8.46">                           tbattr=&quot;tabbrowser-multiple&quot;</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-                          oncommand=&quot;var tabbrowser = this.parentNode.parentNode.parentNode.parentNode;</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+                          oncommand=&quot;var tabbrowser = document.getBindingParent(this);</span>
<a href="#l8.49"></a><span id="l8.49">                                      tabbrowser.replaceTabsWithWindow([tabbrowser.mContextTab]);&quot;/&gt;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-            &lt;xul:menuseparator/&gt;</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-            &lt;xul:menuitem id=&quot;context_showLogs&quot; label=&quot;&amp;showLogs.label;&quot; accesskey=&quot;&amp;showLogs.accesskey;&quot;</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-                          oncommand=&quot;var tabbrowser = this.parentNode.parentNode.parentNode.parentNode;</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-                                     tabbrowser.mContextTab.linkedConversation.showLogs();&quot;/&gt;</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-            &lt;xul:menuseparator/&gt;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-            &lt;xul:menuitem id=&quot;context_closeConv&quot; label=&quot;&amp;closeConv.label;&quot; accesskey=&quot;&amp;closeConv.accesskey;&quot;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-                          oncommand=&quot;var tabbrowser = this.parentNode.parentNode.parentNode.parentNode;</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-                                     tabbrowser.mContextTab.linkedConversation.close();</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-                                     tabbrowser.removeTab(tabbrowser.mContextTab);&quot;/&gt;</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-            &lt;xul:menuitem id=&quot;context_hideConv&quot; label=&quot;&amp;hideConv.label;&quot; accesskey=&quot;&amp;hideConv.accesskey;&quot;</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-                          oncommand=&quot;var tabbrowser = this.parentNode.parentNode.parentNode.parentNode;</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-                                     tabbrowser.mContextTab.linkedConversation.hide();</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-                                     tabbrowser.removeTab(tabbrowser.mContextTab);&quot;/&gt;</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-            &lt;xul:menuseparator/&gt;</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+            &lt;xul:menuseparator id=&quot;context_tabSpecificStartSeparator&quot;/&gt;</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+            &lt;xul:menuseparator id=&quot;context_tabSpecificEndSeparator&quot;/&gt;</span>
<a href="#l8.66"></a><span id="l8.66">             &lt;xul:menuitem id=&quot;context_closeOtherTabs&quot; label=&quot;&amp;closeOtherTabs.label;&quot; accesskey=&quot;&amp;closeOtherTabs.accesskey;&quot;</span>
<a href="#l8.67"></a><span id="l8.67">                           tbattr=&quot;tabbrowser-multiple&quot;</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-                          oncommand=&quot;var tabbrowser = this.parentNode.parentNode.parentNode.parentNode;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+                          oncommand=&quot;var tabbrowser = document.getBindingParent(this);</span>
<a href="#l8.70"></a><span id="l8.70">                                      tabbrowser.removeAllTabsBut(tabbrowser.mContextTab);&quot;/&gt;</span>
<a href="#l8.71"></a><span id="l8.71">             &lt;xul:menuitem id=&quot;context_closeTab&quot; label=&quot;&amp;closeTab.label;&quot; accesskey=&quot;&amp;closeTab.accesskey;&quot;</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-                          oncommand=&quot;var tabbrowser = this.parentNode.parentNode.parentNode.parentNode;</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+                          oncommand=&quot;var tabbrowser = document.getBindingParent(this);</span>
<a href="#l8.74"></a><span id="l8.74">                                      tabbrowser.removeTab(tabbrowser.mContextTab);&quot;/&gt;</span>
<a href="#l8.75"></a><span id="l8.75">           &lt;/xul:menupopup&gt;</span>
<a href="#l8.76"></a><span id="l8.76"> </span>
<a href="#l8.77"></a><span id="l8.77">           &lt;xul:tabs class=&quot;tabbrowser-tabs&quot; flex=&quot;1&quot;</span>
<a href="#l8.78"></a><span id="l8.78">                     anonid=&quot;tabcontainer&quot;</span>
<a href="#l8.79"></a><span id="l8.79">                     setfocus=&quot;false&quot;</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-                    onclick=&quot;this.parentNode.parentNode.parentNode.onTabClick(event);&quot;</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+                    onclick=&quot;document.getBindingParent(this).onTabClick(event);&quot;</span>
<a href="#l8.82"></a><span id="l8.82">                     xbl:inherits=&quot;onnewtab&quot;</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-                    ondblclick=&quot;this.parentNode.parentNode.parentNode.onTabBarDblClick(event);&quot;</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-                    onclosetab=&quot;var node = this.parentNode;</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-                                while (node.localName != 'tabbrowser')</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-                                  node = node.parentNode;</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-                                node.removeCurrentTab();&quot;</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-                    onkeypress=&quot;this.parentNode.parentNode.parentNode.onTabKeypress(event);&quot;&gt;</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+                    ondblclick=&quot;document.getBindingParent(this).onTabBarDblClick(event);&quot;</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+                    onclosetab=&quot;document.getBindingParent(this).removeCurrentTab();&quot;</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+                    onkeypress=&quot;document.getBindingParent(this).onTabKeypress(event);&quot;&gt;</span>
<a href="#l8.92"></a><span id="l8.92">             &lt;xul:tab selected=&quot;true&quot; validate=&quot;never&quot;</span>
<a href="#l8.93"></a><span id="l8.93">                      onerror=&quot;this.removeAttribute('image');&quot;</span>
<a href="#l8.94"></a><span id="l8.94">                      maxwidth=&quot;250&quot; width=&quot;0&quot; minwidth=&quot;100&quot; flex=&quot;100&quot;</span>
<a href="#l8.95"></a><span id="l8.95">                      class=&quot;tabbrowser-tab&quot; label=&quot;&amp;untitledTab;&quot; crop=&quot;end&quot;/&gt;</span>
<a href="#l8.96"></a><span id="l8.96">           &lt;/xul:tabs&gt;</span>
<a href="#l8.97"></a><span id="l8.97">         &lt;/xul:hbox&gt;</span>
<a href="#l8.98"></a><span id="l8.98">         &lt;xul:tabpanels flex=&quot;1&quot; class=&quot;tabbrowser-tabpanels plain&quot; selectedIndex=&quot;0&quot; anonid=&quot;panelcontainer&quot;&gt;</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-          &lt;xul:conversation selected=&quot;true&quot;/&gt;</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+          &lt;xul:tabpanel selected=&quot;true&quot;/&gt;</span>
<a href="#l8.101"></a><span id="l8.101">         &lt;/xul:tabpanels&gt;</span>
<a href="#l8.102"></a><span id="l8.102">       &lt;/xul:tabbox&gt;</span>
<a href="#l8.103"></a><span id="l8.103">       &lt;children/&gt;</span>
<a href="#l8.104"></a><span id="l8.104">     &lt;/content&gt;</span>
<a href="#l8.105"></a><span id="l8.105">     &lt;implementation implements=&quot;nsIDOMEventListener&quot;&gt;</span>
<a href="#l8.106"></a><span id="l8.106">       &lt;field name=&quot;mTabBox&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l8.107"></a><span id="l8.107">         document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;tabbox&quot;);</span>
<a href="#l8.108"></a><span id="l8.108">       &lt;/field&gt;</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineat">@@ -115,78 +102,59 @@</span>
<a href="#l8.110"></a><span id="l8.110">         this.mTabContainer.childNodes</span>
<a href="#l8.111"></a><span id="l8.111">       &lt;/field&gt;</span>
<a href="#l8.112"></a><span id="l8.112">       &lt;field name=&quot;mStringBundle&quot;&gt;</span>
<a href="#l8.113"></a><span id="l8.113">         document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;tbstringbundle&quot;);</span>
<a href="#l8.114"></a><span id="l8.114">       &lt;/field&gt;</span>
<a href="#l8.115"></a><span id="l8.115">       &lt;field name=&quot;mCurrentTab&quot;&gt;</span>
<a href="#l8.116"></a><span id="l8.116">         null</span>
<a href="#l8.117"></a><span id="l8.117">       &lt;/field&gt;</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-      &lt;field name=&quot;mCurrentBrowser&quot;&gt;</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-        null</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l8.121"></a><span id="l8.121">       &lt;field name=&quot;mFirstTabIsDummy&quot;&gt;</span>
<a href="#l8.122"></a><span id="l8.122">         true</span>
<a href="#l8.123"></a><span id="l8.123">       &lt;/field&gt;</span>
<a href="#l8.124"></a><span id="l8.124">       &lt;field name=&quot;mContextTab&quot;&gt;</span>
<a href="#l8.125"></a><span id="l8.125">         null</span>
<a href="#l8.126"></a><span id="l8.126">       &lt;/field&gt;</span>
<a href="#l8.127"></a><span id="l8.127">       &lt;field name=&quot;arrowKeysShouldWrap&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l8.128"></a><span id="l8.128"> #ifdef XP_MACOSX</span>
<a href="#l8.129"></a><span id="l8.129">         true</span>
<a href="#l8.130"></a><span id="l8.130"> #else</span>
<a href="#l8.131"></a><span id="l8.131">         false</span>
<a href="#l8.132"></a><span id="l8.132"> #endif</span>
<a href="#l8.133"></a><span id="l8.133">       &lt;/field&gt;</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineminus">-      &lt;field name=&quot;_browsers&quot;&gt;</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+      &lt;!-- _conversations and _tabPanels are used as caches</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+           to avoid creating arrays multiple times</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+           (See conversations and tabPanels properties) --&gt;</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+      &lt;field name=&quot;_conversations&quot;&gt;</span>
<a href="#l8.140"></a><span id="l8.140">         null</span>
<a href="#l8.141"></a><span id="l8.141">       &lt;/field&gt;</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-      &lt;field name=&quot;_conversations&quot;&gt;</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+      &lt;field name=&quot;_tabPanels&quot;&gt;</span>
<a href="#l8.144"></a><span id="l8.144">         null</span>
<a href="#l8.145"></a><span id="l8.145">       &lt;/field&gt;</span>
<a href="#l8.146"></a><span id="l8.146"> </span>
<a href="#l8.147"></a><span id="l8.147">       &lt;field name=&quot;_blockDblClick&quot;&gt;</span>
<a href="#l8.148"></a><span id="l8.148">         false</span>
<a href="#l8.149"></a><span id="l8.149">       &lt;/field&gt;</span>
<a href="#l8.150"></a><span id="l8.150">       &lt;field name=&quot;_autoScrollPopup&quot;&gt;</span>
<a href="#l8.151"></a><span id="l8.151">         null</span>
<a href="#l8.152"></a><span id="l8.152">       &lt;/field&gt;</span>
<a href="#l8.153"></a><span id="l8.153"> </span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-      &lt;method name=&quot;getBrowserAtIndex&quot;&gt;</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-        &lt;parameter name=&quot;aIndex&quot;/&gt;</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-            return this.browsers[aIndex];</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-          ]]&gt;</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-      &lt;method name=&quot;getConversationAtIndex&quot;&gt;</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-        &lt;parameter name=&quot;aIndex&quot;/&gt;</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-            return this.conversations[aIndex];</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-          ]]&gt;</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineminus">-</span>
<a href="#l8.172"></a><span id="l8.172">       &lt;method name=&quot;updateTitlebar&quot;&gt;</span>
<a href="#l8.173"></a><span id="l8.173">         &lt;body&gt;</span>
<a href="#l8.174"></a><span id="l8.174">           &lt;![CDATA[</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineminus">-            if (!this.mCurrentConversation) // tabbrowser not initialized yet</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+            if (!this.mCurrentTab) // tabbrowser not initialized yet</span>
<a href="#l8.177"></a><span id="l8.177">               return;</span>
<a href="#l8.178"></a><span id="l8.178"> </span>
<a href="#l8.179"></a><span id="l8.179">             var newTitle = &quot;&quot;;</span>
<a href="#l8.180"></a><span id="l8.180">             var docTitle;</span>
<a href="#l8.181"></a><span id="l8.181">             var docElement = this.ownerDocument.documentElement;</span>
<a href="#l8.182"></a><span id="l8.182">             var sep = docElement.getAttribute(&quot;titlemenuseparator&quot;);</span>
<a href="#l8.183"></a><span id="l8.183"> </span>
<a href="#l8.184"></a><span id="l8.184" class="difflineminus">-            if (this.mCurrentTab)</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineminus">-              docTitle = this.mCurrentTab.getAttribute(&quot;label&quot;);</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineminus">-</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+            docTitle = this.mCurrentTab.getAttribute(&quot;label&quot;);</span>
<a href="#l8.188"></a><span id="l8.188">             if (!docTitle)</span>
<a href="#l8.189"></a><span id="l8.189">               docTitle = docElement.getAttribute(&quot;titledefault&quot;);</span>
<a href="#l8.190"></a><span id="l8.190"> </span>
<a href="#l8.191"></a><span id="l8.191">             var modifier = docElement.getAttribute(&quot;titlemodifier&quot;);</span>
<a href="#l8.192"></a><span id="l8.192">             if (docTitle) {</span>
<a href="#l8.193"></a><span id="l8.193">               newTitle += docElement.getAttribute(&quot;titlepreface&quot;);</span>
<a href="#l8.194"></a><span id="l8.194">               newTitle += docTitle;</span>
<a href="#l8.195"></a><span id="l8.195">               if (modifier)</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineat">@@ -194,53 +162,86 @@</span>
<a href="#l8.197"></a><span id="l8.197">             }</span>
<a href="#l8.198"></a><span id="l8.198">             newTitle += modifier;</span>
<a href="#l8.199"></a><span id="l8.199"> </span>
<a href="#l8.200"></a><span id="l8.200">             this.ownerDocument.title = newTitle;</span>
<a href="#l8.201"></a><span id="l8.201">           ]]&gt;</span>
<a href="#l8.202"></a><span id="l8.202">         &lt;/body&gt;</span>
<a href="#l8.203"></a><span id="l8.203">       &lt;/method&gt;</span>
<a href="#l8.204"></a><span id="l8.204"> </span>
<a href="#l8.205"></a><span id="l8.205" class="difflineminus">-      &lt;method name=&quot;updatePopupMenu&quot;&gt;</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+      &lt;method name=&quot;tabContextMenuShowing&quot;&gt;</span>
<a href="#l8.207"></a><span id="l8.207">         &lt;parameter name=&quot;aPopupMenu&quot;/&gt;</span>
<a href="#l8.208"></a><span id="l8.208">         &lt;body&gt;</span>
<a href="#l8.209"></a><span id="l8.209">           &lt;![CDATA[</span>
<a href="#l8.210"></a><span id="l8.210">             let tagName = document.popupNode.localName;</span>
<a href="#l8.211"></a><span id="l8.211">             if (tagName == &quot;tabs&quot;)</span>
<a href="#l8.212"></a><span id="l8.212">               return false;</span>
<a href="#l8.213"></a><span id="l8.213">             this.mContextTab = tagName == &quot;tab&quot; ?</span>
<a href="#l8.214"></a><span id="l8.214">                                document.popupNode : this.selectedTab;</span>
<a href="#l8.215"></a><span id="l8.215">             var disabled = this.mTabs.length == 1;</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineminus">-            var menuItems = aPopupMenu.getElementsByAttribute(&quot;tbattr&quot;, &quot;tabbrowser-multiple&quot;);</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineminus">-            for (var i = 0; i &lt; menuItems.length; i++)</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineminus">-              menuItems[i].disabled = disabled;</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-            document.getElementById(&quot;context_showLogs&quot;).disabled =</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-              !this.mContextTab.linkedConversation.hasLogs();</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+            var multipleTabMenuItems = aPopupMenu.getElementsByAttribute(&quot;tbattr&quot;, &quot;tabbrowser-multiple&quot;);</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+            for (let item of multipleTabMenuItems)</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+              item.disabled = disabled;</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+            let tabSpecificEndSeparator = document.getElementById(&quot;context_tabSpecificEndSeparator&quot;);</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+            if (&quot;getPanelSpecificMenuItems&quot; in this.mContextTab.linkedTabPanel) {</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+              // Add in tab-specific menu items from the tab panel</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+              let panelMenuItems = this.mContextTab.linkedTabPanel.getPanelSpecificMenuItems();</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+              for (let item of panelMenuItems)</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+                aPopupMenu.insertBefore(item, tabSpecificEndSeparator);</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+            }</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+            return true;</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+          ]]&gt;</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+      &lt;method name=&quot;tabContextMenuHiding&quot;&gt;</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+        &lt;parameter name=&quot;aPopupMenu&quot;/&gt;</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+            // Remove tab specific menu items added onpopupshowing.</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+            let range = document.createRange();</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+            range.setStartAfter(document.getElementById(&quot;context_tabSpecificStartSeparator&quot;));</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+            range.setEndBefore(document.getElementById(&quot;context_tabSpecificEndSeparator&quot;));</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+            range.deleteContents();</span>
<a href="#l8.245"></a><span id="l8.245">             return true;</span>
<a href="#l8.246"></a><span id="l8.246">           ]]&gt;</span>
<a href="#l8.247"></a><span id="l8.247">         &lt;/body&gt;</span>
<a href="#l8.248"></a><span id="l8.248">       &lt;/method&gt;</span>
<a href="#l8.249"></a><span id="l8.249"> </span>
<a href="#l8.250"></a><span id="l8.250" class="difflineminus">-      &lt;method name=&quot;updateCurrentBrowser&quot;&gt;</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+      &lt;method name=&quot;updateCurrentTab&quot;&gt;</span>
<a href="#l8.252"></a><span id="l8.252">         &lt;parameter name=&quot;aForceUpdate&quot;/&gt;</span>
<a href="#l8.253"></a><span id="l8.253">         &lt;body&gt;</span>
<a href="#l8.254"></a><span id="l8.254">           &lt;![CDATA[</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineminus">-            var newConversation = this.getConversationAtIndex(this.mTabContainer.selectedIndex);</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineminus">-            if (!aForceUpdate &amp;&amp; this.mCurrentConversation == newConversation)</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+            /* This method handles transitioning when switching tabs.</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+             * When a new tab is selected, mCurrentTab still refers to the</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+             * previously selected tab until we set it in this method.</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+             * this.selectedTab always refers to the actual selected tab</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+             * (see the &quot;selectedTab&quot; property).</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+             * Also, the selected* properties other than selectedTab use</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+             * mCurrentTab and not selectedTab. This ensures a newly selected</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+             * tab's properties are not accessed till this method is called.</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+             */</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+            // We check that the currently selected tab is different from</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+            // mCurrentTab (i.e.  a different tab was selected) before updating.</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineplus">+            if (!aForceUpdate &amp;&amp; this.mCurrentTab == this.selectedTab)</span>
<a href="#l8.269"></a><span id="l8.269">               return;</span>
<a href="#l8.270"></a><span id="l8.270"> </span>
<a href="#l8.271"></a><span id="l8.271" class="difflineminus">-            this.mCurrentConversation = newConversation;</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+            // Deactivate the previous browser if it existed...</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+            if (this.selectedBrowser)</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+              this.selectedBrowser.docShell.isActive = false;</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+            // ... set mCurrentTab to newly selected tab...</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+            this.mCurrentTab = this.selectedTab;</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+            // ... and activate the new browser if it exists.</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+            if (this.selectedBrowser) {</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+              this.mCurrentTab.linkedBrowser.docShell.isActive =</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+                (window.windowState != window.STATE_MINIMIZED);</span>
<a href="#l8.281"></a><span id="l8.281" class="difflineplus">+            }</span>
<a href="#l8.282"></a><span id="l8.282"> </span>
<a href="#l8.283"></a><span id="l8.283" class="difflineminus">-            this.mCurrentBrowser.docShell.isActive = false;</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineminus">-            this.mCurrentBrowser = newConversation.browser;</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineminus">-            this.mCurrentBrowser.docShell.isActive =</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineminus">-              (window.windowState != window.STATE_MINIMIZED);</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineminus">-</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineminus">-            this.mCurrentTab = this.selectedTab;</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineminus">-            this.mCurrentTab.switchingToTab();</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+            if (&quot;switchingToPanel&quot; in this.selectedPanel)</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+              this.selectedPanel.switchingToPanel();</span>
<a href="#l8.292"></a><span id="l8.292"> </span>
<a href="#l8.293"></a><span id="l8.293">             // Update the window title.</span>
<a href="#l8.294"></a><span id="l8.294">             this.updateTitlebar();</span>
<a href="#l8.295"></a><span id="l8.295"> </span>
<a href="#l8.296"></a><span id="l8.296">             // We've selected the new tab, so go ahead and notify listeners.</span>
<a href="#l8.297"></a><span id="l8.297">             var event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l8.298"></a><span id="l8.298">             event.initEvent(&quot;TabSelect&quot;, true, false);</span>
<a href="#l8.299"></a><span id="l8.299">             this.mCurrentTab.dispatchEvent(event);</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineat">@@ -254,60 +255,64 @@</span>
<a href="#l8.301"></a><span id="l8.301">               // Nevertheless update the visible conversation, but only if</span>
<a href="#l8.302"></a><span id="l8.302">               // the user stays on the tab for more than a moment, to prevent</span>
<a href="#l8.303"></a><span id="l8.303">               // tabs from being marked as read if the user is just scrolling</span>
<a href="#l8.304"></a><span id="l8.304">               // past them with the arrow keys. 400ms is between &quot;200ms - a bit</span>
<a href="#l8.305"></a><span id="l8.305">               // too quick for people who repeat-keypress more slowly than me&quot;</span>
<a href="#l8.306"></a><span id="l8.306">               // and &quot;600ms - a bit too noticeable already&quot;.</span>
<a href="#l8.307"></a><span id="l8.307">               if (this._tabSelectTimer)</span>
<a href="#l8.308"></a><span id="l8.308">                 clearTimeout(this._tabSelectTimer);</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineplus">+              if (!(&quot;onSelect&quot; in this.selectedPanel))</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineplus">+                return;</span>
<a href="#l8.311"></a><span id="l8.311">               this._tabSelectTimer = setTimeout(function() {</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineminus">-                this.mCurrentConversation.onSelect();</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineplus">+                this.selectedPanel.onSelect();</span>
<a href="#l8.314"></a><span id="l8.314">               }.bind(this), 400);</span>
<a href="#l8.315"></a><span id="l8.315">               return;</span>
<a href="#l8.316"></a><span id="l8.316">             }</span>
<a href="#l8.317"></a><span id="l8.317"> </span>
<a href="#l8.318"></a><span id="l8.318">             delete this._tabSelectTimer;</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineminus">-            this.mCurrentConversation.focus();</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+            this.selectedPanel.focus();</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineplus">+            if (&quot;onSelect&quot; in this.selectedPanel)</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineplus">+              this.selectedPanel.onSelect();</span>
<a href="#l8.323"></a><span id="l8.323">           ]]&gt;</span>
<a href="#l8.324"></a><span id="l8.324">         &lt;/body&gt;</span>
<a href="#l8.325"></a><span id="l8.325">       &lt;/method&gt;</span>
<a href="#l8.326"></a><span id="l8.326"> </span>
<a href="#l8.327"></a><span id="l8.327">       &lt;method name=&quot;onTabKeypress&quot;&gt;</span>
<a href="#l8.328"></a><span id="l8.328">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l8.329"></a><span id="l8.329">         &lt;body&gt;</span>
<a href="#l8.330"></a><span id="l8.330">           &lt;![CDATA[</span>
<a href="#l8.331"></a><span id="l8.331">             const tabKeyCodes = [KeyEvent.DOM_VK_TAB,</span>
<a href="#l8.332"></a><span id="l8.332">                                  KeyEvent.DOM_VK_HOME, KeyEvent.DOM_VK_END,</span>
<a href="#l8.333"></a><span id="l8.333">                                  KeyEvent.DOM_VK_UP, KeyEvent.DOM_VK_DOWN,</span>
<a href="#l8.334"></a><span id="l8.334">                                  KeyEvent.DOM_VK_LEFT, KeyEvent.DOM_VK_RIGHT];</span>
<a href="#l8.335"></a><span id="l8.335"> </span>
<a href="#l8.336"></a><span id="l8.336">             if (tabKeyCodes.indexOf(event.keyCode) != -1)</span>
<a href="#l8.337"></a><span id="l8.337">               return;</span>
<a href="#l8.338"></a><span id="l8.338"> </span>
<a href="#l8.339"></a><span id="l8.339" class="difflineminus">-            // Focus the editbox and pass the key to it.</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineplus">+            // Focus the panel and pass the key to it.</span>
<a href="#l8.341"></a><span id="l8.341">             event.preventDefault();</span>
<a href="#l8.342"></a><span id="l8.342">             event.stopPropagation();</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineminus">-            this.mCurrentConversation.editor.focus();</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+            this.selectedPanel.focus();</span>
<a href="#l8.345"></a><span id="l8.345"> </span>
<a href="#l8.346"></a><span id="l8.346">             const masks = Components.interfaces.nsIDOMNSEvent;</span>
<a href="#l8.347"></a><span id="l8.347">             var modifiers = 0;</span>
<a href="#l8.348"></a><span id="l8.348">             if (event.shiftKey)</span>
<a href="#l8.349"></a><span id="l8.349">               modifiers |= masks.SHIFT_MASK;</span>
<a href="#l8.350"></a><span id="l8.350">             if (event.ctrlKey)</span>
<a href="#l8.351"></a><span id="l8.351">               modifiers |= masks.CONTROL_MASK;</span>
<a href="#l8.352"></a><span id="l8.352">             if (event.altKey)</span>
<a href="#l8.353"></a><span id="l8.353">               modifiers |= masks.ALT_MASK;</span>
<a href="#l8.354"></a><span id="l8.354">             if (event.metaKey)</span>
<a href="#l8.355"></a><span id="l8.355">               modifiers |= masks.META_MASK;</span>
<a href="#l8.356"></a><span id="l8.356">             if (event.accelKey)</span>
<a href="#l8.357"></a><span id="l8.357">               modifiers |= (navigator.platform.indexOf(&quot;Mac&quot;) &gt;= 0) ? masks.META_MASK</span>
<a href="#l8.358"></a><span id="l8.358">                                                                     : masks.CONTROL_MASK;</span>
<a href="#l8.359"></a><span id="l8.359">             // Can't use dispatchEvent to the textbox as these refuse untrusted key events.</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineminus">-            this.mCurrentConversation.ownerDocument.defaultView</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineplus">+            this.selectedPanel.ownerDocument.defaultView</span>
<a href="#l8.362"></a><span id="l8.362">               .QueryInterface(Components.interfaces.nsIInterfaceRequestor)</span>
<a href="#l8.363"></a><span id="l8.363">               .getInterface(Components.interfaces.nsIDOMWindowUtils)</span>
<a href="#l8.364"></a><span id="l8.364">               .sendKeyEvent(event.type, event.keyCode, event.charCode, modifiers);</span>
<a href="#l8.365"></a><span id="l8.365">           ]]&gt;</span>
<a href="#l8.366"></a><span id="l8.366">         &lt;/body&gt;</span>
<a href="#l8.367"></a><span id="l8.367">       &lt;/method&gt;</span>
<a href="#l8.368"></a><span id="l8.368"> </span>
<a href="#l8.369"></a><span id="l8.369">       &lt;method name=&quot;onTabClick&quot;&gt;</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineat">@@ -394,76 +399,115 @@</span>
<a href="#l8.371"></a><span id="l8.371">         &lt;/body&gt;</span>
<a href="#l8.372"></a><span id="l8.372">       &lt;/method&gt;</span>
<a href="#l8.373"></a><span id="l8.373"> </span>
<a href="#l8.374"></a><span id="l8.374">       &lt;method name=&quot;addConversation&quot;&gt;</span>
<a href="#l8.375"></a><span id="l8.375">         &lt;parameter name=&quot;aConv&quot;/&gt;</span>
<a href="#l8.376"></a><span id="l8.376">         &lt;body&gt;</span>
<a href="#l8.377"></a><span id="l8.377">           &lt;![CDATA[</span>
<a href="#l8.378"></a><span id="l8.378">             if (!this.mFirstTabIsDummy) {</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineminus">-              if (!Services.prefs.getBoolPref(&quot;messenger.conversations.openInTabs&quot;))</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineminus">-                return null;</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineminus">-</span>
<a href="#l8.382"></a><span id="l8.382">               if (Services.prefs.getBoolPref(&quot;messenger.conversations.useSeparateWindowsForMUCs&quot;) &amp;&amp;</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineminus">-                  aConv.isChat != this.conversations[0].hasAttribute(&quot;chat&quot;))</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineplus">+                  this.conversations[0] &amp;&amp; aConv.isChat != this.conversations[0].hasAttribute(&quot;chat&quot;))</span>
<a href="#l8.385"></a><span id="l8.385">                 return null;</span>
<a href="#l8.386"></a><span id="l8.386">             }</span>
<a href="#l8.387"></a><span id="l8.387"> </span>
<a href="#l8.388"></a><span id="l8.388" class="difflineminus">-            return this._addConversation(aConv);</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineminus">-        ]]&gt;</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineplus">+            let convPanel = document.createElementNS(</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineplus">+              &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;,</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineplus">+              &quot;conversation&quot;);</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineplus">+            return this.addPanel(convPanel, aConv);</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineplus">+          ]]&gt;</span>
<a href="#l8.395"></a><span id="l8.395">         &lt;/body&gt;</span>
<a href="#l8.396"></a><span id="l8.396">       &lt;/method&gt;</span>
<a href="#l8.397"></a><span id="l8.397"> </span>
<a href="#l8.398"></a><span id="l8.398" class="difflineminus">-      &lt;method name=&quot;_addConversation&quot;&gt;</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineplus">+      &lt;!-- Adds a tab panel.</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineplus">+           Conversation specific properties and attributes are set if aConv is defined.</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineplus">+</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineplus">+           Note that a panel must focus a child element in its focus method to</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineplus">+           prevent a previously focused element from retaining focus and continuing</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineplus">+           to receive input.</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineplus">+</span>
<a href="#l8.406"></a><span id="l8.406" class="difflineplus">+           Panels can implement the following methods to customize behavior in certain situations:</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineplus">+           destroy:</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineplus">+             Called before panel is removed.</span>
<a href="#l8.409"></a><span id="l8.409" class="difflineplus">+             The destructor doesn't always get called when the panel is removed,</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineplus">+             so use this method to force any required cleanup.</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineplus">+           finishImport:</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineplus">+             When a tab is moved to a different window, a new instance of the panel</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineplus">+             is created. This method is called on the new instance after adding it.</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineplus">+             Use it to initialize the panel from the instance in the previous window,</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineplus">+             which is passed as a parameter.</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineplus">+           getPanelSpecificMenuItems:</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineplus">+             Called before showing the tab's context menu.</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineplus">+             Use it to return an array of menu items specific to this panel.</span>
<a href="#l8.419"></a><span id="l8.419" class="difflineplus">+           onResize:</span>
<a href="#l8.420"></a><span id="l8.420" class="difflineplus">+             Called when the window is resized.</span>
<a href="#l8.421"></a><span id="l8.421" class="difflineplus">+             Use it to perform any changes required due to the new size.</span>
<a href="#l8.422"></a><span id="l8.422" class="difflineplus">+           onSelect:</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineplus">+             Called when the tab is selected and the user is not just scrolling past it.</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineplus">+             Use it for things like marking conversations as read.</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineplus">+           switchingToPanel:</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineplus">+             Called when switching to the panel, even just in passing.</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineplus">+             Use it to customize behavior when the panel is displayed.</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineplus">+           switchingAwayFromPanel:</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineplus">+             Called when switching away from the panel.</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineplus">+             Use it to customize behavior when the panel is hidden. --&gt;</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineplus">+      &lt;method name=&quot;addPanel&quot;&gt;</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineplus">+        &lt;parameter name=&quot;aPanel&quot;/&gt;</span>
<a href="#l8.433"></a><span id="l8.433">         &lt;parameter name=&quot;aConv&quot;/&gt;</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineplus">+        &lt;!-- aPanel is a node containing the content of the panel</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineplus">+             aConv is an (optional) imIConversation instance --&gt;</span>
<a href="#l8.436"></a><span id="l8.436">         &lt;body&gt;</span>
<a href="#l8.437"></a><span id="l8.437">           &lt;![CDATA[</span>
<a href="#l8.438"></a><span id="l8.438" class="difflineminus">-            // invalidate cache, because mTabContainer is about to change</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineminus">-            this._browsers = null;</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineminus">-            this._conversations = null;</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineminus">-</span>
<a href="#l8.442"></a><span id="l8.442" class="difflineminus">-            var conv;</span>
<a href="#l8.443"></a><span id="l8.443" class="difflineminus">-            if (this.mFirstTabIsDummy)</span>
<a href="#l8.444"></a><span id="l8.444" class="difflineminus">-              conv = this.mPanelContainer.firstChild;</span>
<a href="#l8.445"></a><span id="l8.445" class="difflineminus">-            else {</span>
<a href="#l8.446"></a><span id="l8.446" class="difflineminus">-              conv = document.createElementNS(</span>
<a href="#l8.447"></a><span id="l8.447" class="difflineminus">-                &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;,</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineminus">-                                              &quot;conversation&quot;);</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineminus">-              this.mPanelContainer.appendChild(conv);</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineminus">-              if (this.mStrip.collapsed)</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineminus">-                this.setStripVisibilityTo(true);</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineplus">+            if (!this.mFirstTabIsDummy) {</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineplus">+              if (!Services.prefs.getBoolPref(&quot;messenger.conversations.openInTabs&quot;))</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineplus">+                return null;</span>
<a href="#l8.455"></a><span id="l8.455">             }</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineminus">-            conv.setAttribute(&quot;contenttooltip&quot;, this.getAttribute(&quot;contenttooltip&quot;));</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineminus">-            conv.setAttribute(&quot;contentcontextmenu&quot;, this.getAttribute(&quot;contentcontextmenu&quot;));</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineminus">-            conv.setAttribute(&quot;autoscrollpopup&quot;, this._autoScrollPopup.id);</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineplus">+            // invalidate cache, because mTabContainer is about to change</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineplus">+            this._conversations = null;</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineplus">+            this._tabPanels = null;</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineplus">+</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineplus">+            this.mPanelContainer.appendChild(aPanel);</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineplus">+</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineplus">+            var t = this.mTabContainer.addTab();</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineplus">+            aPanel.tab = t;</span>
<a href="#l8.467"></a><span id="l8.467"> </span>
<a href="#l8.468"></a><span id="l8.468" class="difflineminus">-            var t;</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineplus">+            if (aConv) {</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineplus">+              aConv.QueryInterface(Components.interfaces.imIConversation);</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineplus">+              // set up the shared autoscroll popup if it doesn't exist yet</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineplus">+              if (!this._autoScrollPopup) {</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineplus">+                this._autoScrollPopup = aPanel.browser._createAutoScrollPopup();</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineplus">+                this._autoScrollPopup.id = &quot;autoscroller&quot;;</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineplus">+                this.appendChild(this._autoScrollPopup);</span>
<a href="#l8.476"></a><span id="l8.476" class="difflineplus">+              }</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineplus">+              aPanel.setAttribute(&quot;contenttooltip&quot;, this.getAttribute(&quot;contenttooltip&quot;));</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineplus">+              aPanel.setAttribute(&quot;contentcontextmenu&quot;, this.getAttribute(&quot;contentcontextmenu&quot;));</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineplus">+              aPanel.setAttribute(&quot;autoscrollpopup&quot;, this._autoScrollPopup.id);</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineplus">+              aPanel.conv = aConv;</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineplus">+              t.linkedConversation = aPanel;</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineplus">+              t.linkedBrowser = aPanel.browser;</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineplus">+              // We start our browsers out as inactive, and then maintain</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineplus">+              // activeness in updateCurrentTab.</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineplus">+              aPanel.browser.docShell.isActive = false;</span>
<a href="#l8.486"></a><span id="l8.486" class="difflineplus">+            }</span>
<a href="#l8.487"></a><span id="l8.487" class="difflineplus">+</span>
<a href="#l8.488"></a><span id="l8.488" class="difflineplus">+            this.setStripVisibilityTo(</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineplus">+              !(this.mFirstTabIsDummy &amp;&amp; Services.prefs.getBoolPref(&quot;browser.tabs.autoHide&quot;)));</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineplus">+</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineplus">+            var uniqueId = &quot;panel&quot; + Date.now() + t._tPos;</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineplus">+            aPanel.id = uniqueId;</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineplus">+            t.linkedPanel = uniqueId;</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineplus">+            t.linkedTabPanel = aPanel;</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineplus">+</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineplus">+            this.updateCurrentTab(true);</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineplus">+</span>
<a href="#l8.498"></a><span id="l8.498">             if (this.mFirstTabIsDummy)</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineminus">-              t = this.mTabContainer.firstChild;</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineminus">-            else</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineminus">-              t = this.mTabContainer.addTab();</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineminus">-            conv.tab = t;</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineminus">-            conv.conv = aConv;</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineminus">-</span>
<a href="#l8.505"></a><span id="l8.505" class="difflineminus">-            if (this.mStrip.collapsed &amp;&amp;</span>
<a href="#l8.506"></a><span id="l8.506" class="difflineminus">-                !Services.prefs.getBoolPref(&quot;browser.tabs.autoHide&quot;))</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineminus">-              this.setStripVisibilityTo(true);</span>
<a href="#l8.508"></a><span id="l8.508" class="difflineplus">+              this.removeTab(this.mTabContainer.firstChild);</span>
<a href="#l8.509"></a><span id="l8.509">             this.mFirstTabIsDummy = false;</span>
<a href="#l8.510"></a><span id="l8.510"> </span>
<a href="#l8.511"></a><span id="l8.511" class="difflineminus">-            var uniqueId = &quot;panel&quot; + Date.now() + t._tPos;</span>
<a href="#l8.512"></a><span id="l8.512" class="difflineminus">-            this.mPanelContainer.lastChild.id = uniqueId;</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineminus">-            t.linkedPanel = uniqueId;</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineminus">-            t.linkedConversation = conv;</span>
<a href="#l8.515"></a><span id="l8.515" class="difflineminus">-            t.linkedBrowser = conv.browser;</span>
<a href="#l8.516"></a><span id="l8.516" class="difflineminus">-            // We start our browsers out as inactive, and then maintain</span>
<a href="#l8.517"></a><span id="l8.517" class="difflineminus">-            // activeness in updateCurrentBrowser.</span>
<a href="#l8.518"></a><span id="l8.518" class="difflineminus">-            t.linkedBrowser.docShell.isActive = false;</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineminus">-            this.updateCurrentBrowser(true);</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineminus">-</span>
<a href="#l8.521"></a><span id="l8.521" class="difflineminus">-            return conv;</span>
<a href="#l8.522"></a><span id="l8.522" class="difflineplus">+            return aPanel;</span>
<a href="#l8.523"></a><span id="l8.523">           ]]&gt;</span>
<a href="#l8.524"></a><span id="l8.524">         &lt;/body&gt;</span>
<a href="#l8.525"></a><span id="l8.525">       &lt;/method&gt;</span>
<a href="#l8.526"></a><span id="l8.526"> </span>
<a href="#l8.527"></a><span id="l8.527">       &lt;method name=&quot;warnAboutClosingTabs&quot;&gt;</span>
<a href="#l8.528"></a><span id="l8.528">       &lt;parameter name=&quot;aAll&quot;/&gt;</span>
<a href="#l8.529"></a><span id="l8.529">       &lt;body&gt;</span>
<a href="#l8.530"></a><span id="l8.530">         &lt;![CDATA[</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineat">@@ -567,19 +611,19 @@</span>
<a href="#l8.532"></a><span id="l8.532">         &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l8.533"></a><span id="l8.533">         &lt;parameter name=&quot;aTabWillBeMoved&quot;/&gt;</span>
<a href="#l8.534"></a><span id="l8.534">         &lt;parameter name=&quot;aCloseWindowFastpath&quot;/&gt;</span>
<a href="#l8.535"></a><span id="l8.535">         &lt;body&gt;</span>
<a href="#l8.536"></a><span id="l8.536">           &lt;![CDATA[</span>
<a href="#l8.537"></a><span id="l8.537">             if (this._removingTabs.indexOf(aTab) &gt; -1 || this._windowIsClosing)</span>
<a href="#l8.538"></a><span id="l8.538">               return null;</span>
<a href="#l8.539"></a><span id="l8.539"> </span>
<a href="#l8.540"></a><span id="l8.540" class="difflineminus">-            var browser = this.getBrowserForTab(aTab);</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineplus">+            var browser = aTab.linkedBrowser;</span>
<a href="#l8.542"></a><span id="l8.542"> </span>
<a href="#l8.543"></a><span id="l8.543" class="difflineminus">-            if (!aTabWillBeMoved) {</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineplus">+            if (!aTabWillBeMoved &amp;&amp; browser) {</span>
<a href="#l8.545"></a><span id="l8.545">               let ds = browser.docShell;</span>
<a href="#l8.546"></a><span id="l8.546">               if (ds.contentViewer &amp;&amp; !ds.contentViewer.permitUnload())</span>
<a href="#l8.547"></a><span id="l8.547">                 return null;</span>
<a href="#l8.548"></a><span id="l8.548">             }</span>
<a href="#l8.549"></a><span id="l8.549"> </span>
<a href="#l8.550"></a><span id="l8.550">             var closeWindow = false;</span>
<a href="#l8.551"></a><span id="l8.551">             var l = this.mTabs.length - this._removingTabs.length;</span>
<a href="#l8.552"></a><span id="l8.552">             if (l == 1) {</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineat">@@ -635,36 +679,32 @@</span>
<a href="#l8.554"></a><span id="l8.554">               // see notes in addTab</span>
<a href="#l8.555"></a><span id="l8.555">               function _delayedUpdate(aTabContainer) {</span>
<a href="#l8.556"></a><span id="l8.556">                 aTabContainer.adjustTabstrip();</span>
<a href="#l8.557"></a><span id="l8.557">                 aTabContainer.mTabstrip._updateScrollButtonsDisabledState();</span>
<a href="#l8.558"></a><span id="l8.558">               };</span>
<a href="#l8.559"></a><span id="l8.559">               setTimeout(_delayedUpdate, 0, this.tabContainer);</span>
<a href="#l8.560"></a><span id="l8.560">             }</span>
<a href="#l8.561"></a><span id="l8.561"> </span>
<a href="#l8.562"></a><span id="l8.562" class="difflineminus">-            var conversation = this.getConversationForTab(aTab);</span>
<a href="#l8.563"></a><span id="l8.563" class="difflineminus">-            var browser = this.getBrowserForTab(aTab);</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineplus">+            var panel = aTab.linkedTabPanel;</span>
<a href="#l8.565"></a><span id="l8.565"> </span>
<a href="#l8.566"></a><span id="l8.566">             // Because of the way XBL works (fields just set JS</span>
<a href="#l8.567"></a><span id="l8.567">             // properties on the element) and the code we have in place</span>
<a href="#l8.568"></a><span id="l8.568">             // to preserve the JS objects for any elements that have</span>
<a href="#l8.569"></a><span id="l8.569">             // JS properties set on them, the browser element won't be</span>
<a href="#l8.570"></a><span id="l8.570">             // destroyed until the document goes away.  So we force a</span>
<a href="#l8.571"></a><span id="l8.571">             // cleanup ourselves.</span>
<a href="#l8.572"></a><span id="l8.572">             // This has to happen before we remove the child so that the</span>
<a href="#l8.573"></a><span id="l8.573">             // XBL implementation of nsIObserver still works.</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineminus">-            conversation.destroy();</span>
<a href="#l8.575"></a><span id="l8.575" class="difflineminus">-</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineminus">-            if (conversation == this.mCurrentConversation)</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineminus">-              this.mCurrentConversation = null;</span>
<a href="#l8.578"></a><span id="l8.578" class="difflineplus">+            if (&quot;destroy&quot; in panel)</span>
<a href="#l8.579"></a><span id="l8.579" class="difflineplus">+              panel.destroy();</span>
<a href="#l8.580"></a><span id="l8.580"> </span>
<a href="#l8.581"></a><span id="l8.581" class="difflineminus">-            // Invalidate browsers cache, as the tab is removed from the</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineminus">-            // tab container.</span>
<a href="#l8.583"></a><span id="l8.583" class="difflineminus">-            this._browsers = null;</span>
<a href="#l8.584"></a><span id="l8.584" class="difflineplus">+            // Invalidate caches, as the tab is removed from the tab container.</span>
<a href="#l8.585"></a><span id="l8.585">             this._conversations = null;</span>
<a href="#l8.586"></a><span id="l8.586" class="difflineplus">+            this._tabPanels = null;</span>
<a href="#l8.587"></a><span id="l8.587"> </span>
<a href="#l8.588"></a><span id="l8.588">             // Remove the tab ...</span>
<a href="#l8.589"></a><span id="l8.589">             this.tabContainer.removeChild(aTab);</span>
<a href="#l8.590"></a><span id="l8.590"> </span>
<a href="#l8.591"></a><span id="l8.591">             // ... and fix up the _tPos properties immediately.</span>
<a href="#l8.592"></a><span id="l8.592">             for (let i = aTab._tPos; i &lt; this.mTabs.length; i++)</span>
<a href="#l8.593"></a><span id="l8.593">               this.mTabs[i]._tPos = i;</span>
<a href="#l8.594"></a><span id="l8.594"> </span>
<a href="#l8.595"></a><span id="l8.595" class="difflineat">@@ -672,23 +712,23 @@</span>
<a href="#l8.596"></a><span id="l8.596">             if (this.selectedTab) // can be null if we removed the last tab</span>
<a href="#l8.597"></a><span id="l8.597">               this.selectedTab._selected = true;</span>
<a href="#l8.598"></a><span id="l8.598"> </span>
<a href="#l8.599"></a><span id="l8.599">             // This will unload the document. An unload handler could remove</span>
<a href="#l8.600"></a><span id="l8.600">             // dependant tabs, so it's important that the tabbrowser is now in</span>
<a href="#l8.601"></a><span id="l8.601">             // a consistent state (tab removed, tab positions updated, etc.).</span>
<a href="#l8.602"></a><span id="l8.602">             // Also, it's important that another tab has been selected before</span>
<a href="#l8.603"></a><span id="l8.603">             // the panel is removed; otherwise, a random sibling panel can flash.</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineminus">-            this.mPanelContainer.removeChild(conversation);</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineplus">+            this.mPanelContainer.removeChild(panel);</span>
<a href="#l8.606"></a><span id="l8.606"> </span>
<a href="#l8.607"></a><span id="l8.607">             // As the panel is removed, the removal of a dependent document can</span>
<a href="#l8.608"></a><span id="l8.608">             // cause the whole window to close. So at this point, it's possible</span>
<a href="#l8.609"></a><span id="l8.609">             // that the binding is destructed.</span>
<a href="#l8.610"></a><span id="l8.610">             if (this.mTabBox)</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineminus">-              this.mTabBox.selectedPanel = this.getConversationForTab(this.mCurrentTab);</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineplus">+              this.mTabBox.selectedPanel = this.selectedPanel;</span>
<a href="#l8.613"></a><span id="l8.613"> </span>
<a href="#l8.614"></a><span id="l8.614">             if (aCloseWindow)</span>
<a href="#l8.615"></a><span id="l8.615">               this._windowIsClosing = closeWindow(true);</span>
<a href="#l8.616"></a><span id="l8.616">           ]]&gt;</span>
<a href="#l8.617"></a><span id="l8.617">         &lt;/body&gt;</span>
<a href="#l8.618"></a><span id="l8.618">       &lt;/method&gt;</span>
<a href="#l8.619"></a><span id="l8.619"> </span>
<a href="#l8.620"></a><span id="l8.620">       &lt;method name=&quot;_blurTab&quot;&gt;</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineat">@@ -712,51 +752,47 @@</span>
<a href="#l8.622"></a><span id="l8.622">               } while (tab &amp;&amp; this._removingTabs.indexOf(tab) != -1);</span>
<a href="#l8.623"></a><span id="l8.623">             }</span>
<a href="#l8.624"></a><span id="l8.624"> </span>
<a href="#l8.625"></a><span id="l8.625">             this.selectedTab = tab;</span>
<a href="#l8.626"></a><span id="l8.626">           ]]&gt;</span>
<a href="#l8.627"></a><span id="l8.627">         &lt;/body&gt;</span>
<a href="#l8.628"></a><span id="l8.628">       &lt;/method&gt;</span>
<a href="#l8.629"></a><span id="l8.629"> </span>
<a href="#l8.630"></a><span id="l8.630" class="difflineminus">-      &lt;method name=&quot;importConversation&quot;&gt;</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineplus">+      &lt;method name=&quot;importPanel&quot;&gt;</span>
<a href="#l8.632"></a><span id="l8.632">         &lt;parameter name=&quot;aOtherTab&quot;/&gt;</span>
<a href="#l8.633"></a><span id="l8.633">         &lt;body&gt;</span>
<a href="#l8.634"></a><span id="l8.634">           &lt;![CDATA[</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineminus">-            // That's gBrowser for the other window, not the tab's browser!</span>
<a href="#l8.636"></a><span id="l8.636" class="difflineminus">-            var remoteBrowser =</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineminus">-              aOtherTab.ownerDocument.defaultView.getBrowser();</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineplus">+            var remoteTabBrowser = aOtherTab.ownerDocument.defaultView.getTabBrowser();</span>
<a href="#l8.639"></a><span id="l8.639"> </span>
<a href="#l8.640"></a><span id="l8.640">             // First, start teardown of the other browser.  Make sure to not</span>
<a href="#l8.641"></a><span id="l8.641">             // fire the beforeunload event in the process.  Close the other</span>
<a href="#l8.642"></a><span id="l8.642">             // window if this was its last tab.</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineminus">-            var endRemoveArgs = remoteBrowser._beginRemoveTab(aOtherTab, true);</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineminus">-</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineminus">-</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineminus">-            var conv = this._addConversation(aOtherTab.linkedConversation.conv);</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineplus">+            var endRemoveArgs = remoteTabBrowser._beginRemoveTab(aOtherTab, true);</span>
<a href="#l8.648"></a><span id="l8.648"> </span>
<a href="#l8.649"></a><span id="l8.649" class="difflineminus">-            var aOurTab = conv.tab;</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineminus">-            var ourBrowser = this.getBrowserForTab(aOurTab);</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineminus">-            // make sure it has a docshell</span>
<a href="#l8.652"></a><span id="l8.652" class="difflineminus">-            ourBrowser.docShell;</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineplus">+            var newPanel = document.createElementNS(</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineplus">+              &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;,</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineplus">+              aOtherTab.linkedTabPanel.nodeName);</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineplus">+            this.addPanel(newPanel, aOtherTab.linkedTabPanel.conv || null);</span>
<a href="#l8.657"></a><span id="l8.657"> </span>
<a href="#l8.658"></a><span id="l8.658" class="difflineminus">-            // Swap the docshells</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineminus">-            ourBrowser.swapDocShells(aOtherTab.linkedBrowser);</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineminus">-            aOtherTab.linkedConversation.conv = null;</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineminus">-            conv.finishImport(aOtherTab.linkedConversation);</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineplus">+            var aOurTab = newPanel.tab;</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineplus">+</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineplus">+            // Tell the new panel to sync up with the other one.</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineplus">+            if (&quot;finishImport&quot; in newPanel)</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineplus">+              newPanel.finishImport(aOtherTab.linkedTabPanel);</span>
<a href="#l8.667"></a><span id="l8.667"> </span>
<a href="#l8.668"></a><span id="l8.668">             // Finish tearing down the tab that's going away.</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineminus">-            remoteBrowser._endRemoveTab(endRemoveArgs);</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineplus">+            remoteTabBrowser._endRemoveTab(endRemoveArgs);</span>
<a href="#l8.671"></a><span id="l8.671"> </span>
<a href="#l8.672"></a><span id="l8.672">             // If the tab was already selected (this happpens in the scenario</span>
<a href="#l8.673"></a><span id="l8.673">             // of replaceTabsWithWindow), notify onLocationChange, etc.</span>
<a href="#l8.674"></a><span id="l8.674">             if (aOurTab == this.selectedTab)</span>
<a href="#l8.675"></a><span id="l8.675" class="difflineminus">-              this.updateCurrentBrowser(true);</span>
<a href="#l8.676"></a><span id="l8.676" class="difflineplus">+              this.updateCurrentTab(true);</span>
<a href="#l8.677"></a><span id="l8.677"> </span>
<a href="#l8.678"></a><span id="l8.678" class="difflineminus">-            return conv;</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineplus">+            return newPanel;</span>
<a href="#l8.680"></a><span id="l8.680">           ]]&gt;</span>
<a href="#l8.681"></a><span id="l8.681">         &lt;/body&gt;</span>
<a href="#l8.682"></a><span id="l8.682">       &lt;/method&gt;</span>
<a href="#l8.683"></a><span id="l8.683"> </span>
<a href="#l8.684"></a><span id="l8.684">       &lt;method name=&quot;onTabBarDblClick&quot;&gt;</span>
<a href="#l8.685"></a><span id="l8.685">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l8.686"></a><span id="l8.686">         &lt;body&gt;</span>
<a href="#l8.687"></a><span id="l8.687">           &lt;![CDATA[</span>
<a href="#l8.688"></a><span id="l8.688" class="difflineat">@@ -767,34 +803,16 @@</span>
<a href="#l8.689"></a><span id="l8.689">               var e = document.createEvent(&quot;Events&quot;);</span>
<a href="#l8.690"></a><span id="l8.690">               e.initEvent(&quot;NewTab&quot;, true, true);</span>
<a href="#l8.691"></a><span id="l8.691">               this.dispatchEvent(e);</span>
<a href="#l8.692"></a><span id="l8.692">             }</span>
<a href="#l8.693"></a><span id="l8.693">           ]]&gt;</span>
<a href="#l8.694"></a><span id="l8.694">         &lt;/body&gt;</span>
<a href="#l8.695"></a><span id="l8.695">       &lt;/method&gt;</span>
<a href="#l8.696"></a><span id="l8.696"> </span>
<a href="#l8.697"></a><span id="l8.697" class="difflineminus">-      &lt;method name=&quot;getBrowserForTab&quot;&gt;</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineminus">-        &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineminus">-          return aTab.linkedBrowser;</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineminus">-        ]]&gt;</span>
<a href="#l8.703"></a><span id="l8.703" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineminus">-</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineminus">-      &lt;method name=&quot;getConversationForTab&quot;&gt;</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineminus">-        &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l8.709"></a><span id="l8.709" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineminus">-          return aTab.linkedConversation;</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineminus">-        ]]&gt;</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineminus">-</span>
<a href="#l8.715"></a><span id="l8.715">       &lt;method name=&quot;selectTabAtIndex&quot;&gt;</span>
<a href="#l8.716"></a><span id="l8.716">         &lt;parameter name=&quot;aIndex&quot;/&gt;</span>
<a href="#l8.717"></a><span id="l8.717">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l8.718"></a><span id="l8.718">         &lt;body&gt;</span>
<a href="#l8.719"></a><span id="l8.719">         &lt;![CDATA[</span>
<a href="#l8.720"></a><span id="l8.720">           // count backwards for aIndex &lt; 0</span>
<a href="#l8.721"></a><span id="l8.721">           if (aIndex &lt; 0)</span>
<a href="#l8.722"></a><span id="l8.722">             aIndex += this.mTabs.length;</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineat">@@ -827,38 +845,45 @@</span>
<a href="#l8.724"></a><span id="l8.724">           // Update the tab</span>
<a href="#l8.725"></a><span id="l8.725">           this.mTabBox.selectedTab = val;</span>
<a href="#l8.726"></a><span id="l8.726">           return val;</span>
<a href="#l8.727"></a><span id="l8.727">           ]]&gt;</span>
<a href="#l8.728"></a><span id="l8.728">         &lt;/setter&gt;</span>
<a href="#l8.729"></a><span id="l8.729">       &lt;/property&gt;</span>
<a href="#l8.730"></a><span id="l8.730"> </span>
<a href="#l8.731"></a><span id="l8.731">       &lt;property name=&quot;selectedBrowser&quot;</span>
<a href="#l8.732"></a><span id="l8.732" class="difflineminus">-                onget=&quot;return this.mCurrentBrowser;&quot;</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineplus">+                onget=&quot;return this.mCurrentTab.linkedBrowser || null;&quot;</span>
<a href="#l8.734"></a><span id="l8.734">                 readonly=&quot;true&quot;/&gt;</span>
<a href="#l8.735"></a><span id="l8.735"> </span>
<a href="#l8.736"></a><span id="l8.736">       &lt;property name=&quot;selectedConversation&quot;</span>
<a href="#l8.737"></a><span id="l8.737" class="difflineminus">-                onget=&quot;return this.mCurrentConversation;&quot;</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineplus">+                onget=&quot;return this.mCurrentTab.linkedConversation || null;&quot;</span>
<a href="#l8.739"></a><span id="l8.739">                 readonly=&quot;true&quot;/&gt;</span>
<a href="#l8.740"></a><span id="l8.740"> </span>
<a href="#l8.741"></a><span id="l8.741" class="difflineminus">-      &lt;property name=&quot;browsers&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineplus">+      &lt;property name=&quot;selectedPanel&quot;</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineplus">+                onget=&quot;return this.mCurrentTab.linkedTabPanel || null;&quot;</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineplus">+                readonly=&quot;true&quot;/&gt;</span>
<a href="#l8.745"></a><span id="l8.745" class="difflineplus">+</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineplus">+      &lt;property name=&quot;tabPanels&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l8.747"></a><span id="l8.747">        &lt;getter&gt;</span>
<a href="#l8.748"></a><span id="l8.748">           &lt;![CDATA[</span>
<a href="#l8.749"></a><span id="l8.749" class="difflineminus">-            return this._browsers ||</span>
<a href="#l8.750"></a><span id="l8.750" class="difflineminus">-                   (this._browsers = Array.map(this.mTabs, function (tab) tab.linkedBrowser));</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineplus">+            return this._tabPanels ||</span>
<a href="#l8.752"></a><span id="l8.752" class="difflineplus">+                   (this._tabPanels = Array.map(this.mTabs, function (tab) tab.linkedTabPanel));</span>
<a href="#l8.753"></a><span id="l8.753">           ]]&gt;</span>
<a href="#l8.754"></a><span id="l8.754">         &lt;/getter&gt;</span>
<a href="#l8.755"></a><span id="l8.755">       &lt;/property&gt;</span>
<a href="#l8.756"></a><span id="l8.756"> </span>
<a href="#l8.757"></a><span id="l8.757">       &lt;property name=&quot;conversations&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l8.758"></a><span id="l8.758">        &lt;getter&gt;</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l8.760"></a><span id="l8.760" class="difflineminus">-            return this._conversations ||</span>
<a href="#l8.761"></a><span id="l8.761" class="difflineminus">-                   (this._conversations = Array.map(this.mTabs, function (tab) tab.linkedConversation));</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineminus">-          ]]&gt;</span>
<a href="#l8.763"></a><span id="l8.763" class="difflineplus">+        &lt;![CDATA[</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineplus">+          if (!this._conversations) {</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineplus">+            this._conversations = Array.map(this.mTabs, function(aTab) aTab.linkedConversation)</span>
<a href="#l8.766"></a><span id="l8.766" class="difflineplus">+                                       .filter(function(aConv) aConv);</span>
<a href="#l8.767"></a><span id="l8.767" class="difflineplus">+          }</span>
<a href="#l8.768"></a><span id="l8.768" class="difflineplus">+          return this._conversations;</span>
<a href="#l8.769"></a><span id="l8.769" class="difflineplus">+        ]]&gt;</span>
<a href="#l8.770"></a><span id="l8.770">         &lt;/getter&gt;</span>
<a href="#l8.771"></a><span id="l8.771">       &lt;/property&gt;</span>
<a href="#l8.772"></a><span id="l8.772"> </span>
<a href="#l8.773"></a><span id="l8.773">       &lt;method name=&quot;_onDragStart&quot;&gt;</span>
<a href="#l8.774"></a><span id="l8.774">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l8.775"></a><span id="l8.775">         &lt;body&gt;</span>
<a href="#l8.776"></a><span id="l8.776">         &lt;![CDATA[</span>
<a href="#l8.777"></a><span id="l8.777">           var target = aEvent.target;</span>
<a href="#l8.778"></a><span id="l8.778" class="difflineat">@@ -1031,21 +1056,21 @@</span>
<a href="#l8.779"></a><span id="l8.779">             }</span>
<a href="#l8.780"></a><span id="l8.780">             else {</span>
<a href="#l8.781"></a><span id="l8.781">               // swap the dropped tab with a new one we create and then close</span>
<a href="#l8.782"></a><span id="l8.782">               // it in the other window (making it seem to have moved between</span>
<a href="#l8.783"></a><span id="l8.783">               // windows)</span>
<a href="#l8.784"></a><span id="l8.784"> </span>
<a href="#l8.785"></a><span id="l8.785">               // Compute the new index *before* we add a tab</span>
<a href="#l8.786"></a><span id="l8.786">               newIndex = this.getNewIndex(aEvent);</span>
<a href="#l8.787"></a><span id="l8.787" class="difflineminus">-              var conv = this.importConversation(draggedTab);</span>
<a href="#l8.788"></a><span id="l8.788" class="difflineminus">-              this.moveTabTo(conv.tab, newIndex);</span>
<a href="#l8.789"></a><span id="l8.789" class="difflineplus">+              var panel = this.importPanel(draggedTab);</span>
<a href="#l8.790"></a><span id="l8.790" class="difflineplus">+              this.moveTabTo(panel.tab, newIndex);</span>
<a href="#l8.791"></a><span id="l8.791"> </span>
<a href="#l8.792"></a><span id="l8.792">               // We need to set selectedTab after we've swapped the docShells</span>
<a href="#l8.793"></a><span id="l8.793" class="difflineminus">-              this.selectedTab = conv.tab;</span>
<a href="#l8.794"></a><span id="l8.794" class="difflineplus">+              this.selectedTab = panel.tab;</span>
<a href="#l8.795"></a><span id="l8.795">             }</span>
<a href="#l8.796"></a><span id="l8.796">           ]]&gt;</span>
<a href="#l8.797"></a><span id="l8.797">         &lt;/body&gt;</span>
<a href="#l8.798"></a><span id="l8.798">       &lt;/method&gt;</span>
<a href="#l8.799"></a><span id="l8.799"> </span>
<a href="#l8.800"></a><span id="l8.800">       &lt;method name=&quot;_onDragEnd&quot;&gt;</span>
<a href="#l8.801"></a><span id="l8.801">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l8.802"></a><span id="l8.802">         &lt;body&gt;</span>
<a href="#l8.803"></a><span id="l8.803" class="difflineat">@@ -1120,29 +1145,30 @@</span>
<a href="#l8.804"></a><span id="l8.804">         &lt;/body&gt;</span>
<a href="#l8.805"></a><span id="l8.805">       &lt;/method&gt;</span>
<a href="#l8.806"></a><span id="l8.806"> </span>
<a href="#l8.807"></a><span id="l8.807">       &lt;method name=&quot;moveTabTo&quot;&gt;</span>
<a href="#l8.808"></a><span id="l8.808">         &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l8.809"></a><span id="l8.809">         &lt;parameter name=&quot;aIndex&quot;/&gt;</span>
<a href="#l8.810"></a><span id="l8.810">         &lt;body&gt;</span>
<a href="#l8.811"></a><span id="l8.811">         &lt;![CDATA[</span>
<a href="#l8.812"></a><span id="l8.812" class="difflineminus">-          this._browsers = null; // invalidate cache</span>
<a href="#l8.813"></a><span id="l8.813" class="difflineplus">+          // Invalidate caches.</span>
<a href="#l8.814"></a><span id="l8.814">           this._conversations = null;</span>
<a href="#l8.815"></a><span id="l8.815" class="difflineplus">+          this._tabPanels = null;</span>
<a href="#l8.816"></a><span id="l8.816"> </span>
<a href="#l8.817"></a><span id="l8.817">           var oldPosition = aTab._tPos;</span>
<a href="#l8.818"></a><span id="l8.818"> </span>
<a href="#l8.819"></a><span id="l8.819">           aIndex = aIndex &lt; aTab._tPos ? aIndex: aIndex+1;</span>
<a href="#l8.820"></a><span id="l8.820">           this.mCurrentTab._selected = false;</span>
<a href="#l8.821"></a><span id="l8.821">           // use .item() instead of [] because dragging to the end of the strip goes out of</span>
<a href="#l8.822"></a><span id="l8.822">           // bounds: .item() returns null (so it acts like appendChild), but [] throws</span>
<a href="#l8.823"></a><span id="l8.823">           this.mTabContainer.insertBefore(aTab, this.mTabContainer.childNodes.item(aIndex));</span>
<a href="#l8.824"></a><span id="l8.824">           // invalidate cache, because mTabContainer is about to change</span>
<a href="#l8.825"></a><span id="l8.825" class="difflineminus">-          this._browsers = null;</span>
<a href="#l8.826"></a><span id="l8.826">           this._conversations = null;</span>
<a href="#l8.827"></a><span id="l8.827" class="difflineplus">+          this._tabPanels = null;</span>
<a href="#l8.828"></a><span id="l8.828"> </span>
<a href="#l8.829"></a><span id="l8.829">           var i;</span>
<a href="#l8.830"></a><span id="l8.830">           for (i = 0; i &lt; this.mTabContainer.childNodes.length; i++) {</span>
<a href="#l8.831"></a><span id="l8.831">             this.mTabContainer.childNodes[i]._tPos = i;</span>
<a href="#l8.832"></a><span id="l8.832">             this.mTabContainer.childNodes[i]._selected = false;</span>
<a href="#l8.833"></a><span id="l8.833">           }</span>
<a href="#l8.834"></a><span id="l8.834">           this.mCurrentTab._selected = true;</span>
<a href="#l8.835"></a><span id="l8.835">           this.mTabContainer.mTabstrip.scrollBoxObject.ensureElementIsVisible(this.mCurrentTab);</span>
<a href="#l8.836"></a><span id="l8.836" class="difflineat">@@ -1175,17 +1201,17 @@</span>
<a href="#l8.837"></a><span id="l8.837">         &lt;/body&gt;</span>
<a href="#l8.838"></a><span id="l8.838">       &lt;/method&gt;</span>
<a href="#l8.839"></a><span id="l8.839"> </span>
<a href="#l8.840"></a><span id="l8.840"> </span>
<a href="#l8.841"></a><span id="l8.841">       &lt;method name=&quot;moveTabForward&quot;&gt;</span>
<a href="#l8.842"></a><span id="l8.842">         &lt;body&gt;</span>
<a href="#l8.843"></a><span id="l8.843">           &lt;![CDATA[</span>
<a href="#l8.844"></a><span id="l8.844">             var tabPos = this.mCurrentTab._tPos;</span>
<a href="#l8.845"></a><span id="l8.845" class="difflineminus">-            if (tabPos &lt; this.browsers.length - 1) {</span>
<a href="#l8.846"></a><span id="l8.846" class="difflineplus">+            if (tabPos &lt; this.mTabs.length - 1) {</span>
<a href="#l8.847"></a><span id="l8.847">               this.moveTabTo(this.mCurrentTab, tabPos + 1);</span>
<a href="#l8.848"></a><span id="l8.848">               this.mCurrentTab.focus();</span>
<a href="#l8.849"></a><span id="l8.849">             }</span>
<a href="#l8.850"></a><span id="l8.850">             else if (this.arrowKeysShouldWrap)</span>
<a href="#l8.851"></a><span id="l8.851">               this.moveTabToStart();</span>
<a href="#l8.852"></a><span id="l8.852">           ]]&gt;</span>
<a href="#l8.853"></a><span id="l8.853">         &lt;/body&gt;</span>
<a href="#l8.854"></a><span id="l8.854">       &lt;/method&gt;</span>
<a href="#l8.855"></a><span id="l8.855" class="difflineat">@@ -1215,19 +1241,18 @@</span>
<a href="#l8.856"></a><span id="l8.856">           ]]&gt;</span>
<a href="#l8.857"></a><span id="l8.857">         &lt;/body&gt;</span>
<a href="#l8.858"></a><span id="l8.858">       &lt;/method&gt;</span>
<a href="#l8.859"></a><span id="l8.859"> </span>
<a href="#l8.860"></a><span id="l8.860">       &lt;method name=&quot;moveTabToEnd&quot;&gt;</span>
<a href="#l8.861"></a><span id="l8.861">         &lt;body&gt;</span>
<a href="#l8.862"></a><span id="l8.862">           &lt;![CDATA[</span>
<a href="#l8.863"></a><span id="l8.863">             var tabPos = this.mCurrentTab._tPos;</span>
<a href="#l8.864"></a><span id="l8.864" class="difflineminus">-            if (tabPos &lt; this.browsers.length - 1) {</span>
<a href="#l8.865"></a><span id="l8.865" class="difflineminus">-              this.moveTabTo(this.mCurrentTab,</span>
<a href="#l8.866"></a><span id="l8.866" class="difflineminus">-                             this.browsers.length - 1);</span>
<a href="#l8.867"></a><span id="l8.867" class="difflineplus">+            if (tabPos &lt; this.mTabs.length - 1) {</span>
<a href="#l8.868"></a><span id="l8.868" class="difflineplus">+              this.moveTabTo(this.mCurrentTab, this.mTabs.length - 1);</span>
<a href="#l8.869"></a><span id="l8.869">               this.mCurrentTab.focus();</span>
<a href="#l8.870"></a><span id="l8.870">             }</span>
<a href="#l8.871"></a><span id="l8.871">           ]]&gt;</span>
<a href="#l8.872"></a><span id="l8.872">         &lt;/body&gt;</span>
<a href="#l8.873"></a><span id="l8.873">       &lt;/method&gt;</span>
<a href="#l8.874"></a><span id="l8.874"> </span>
<a href="#l8.875"></a><span id="l8.875">       &lt;method name=&quot;moveTabOver&quot;&gt;</span>
<a href="#l8.876"></a><span id="l8.876">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l8.877"></a><span id="l8.877" class="difflineat">@@ -1238,43 +1263,16 @@</span>
<a href="#l8.878"></a><span id="l8.878">                 (direction == &quot;rtl&quot; &amp;&amp; aEvent.keyCode == KeyEvent.DOM_VK_LEFT))</span>
<a href="#l8.879"></a><span id="l8.879">               this.moveTabForward();</span>
<a href="#l8.880"></a><span id="l8.880">             else</span>
<a href="#l8.881"></a><span id="l8.881">               this.moveTabBackward();</span>
<a href="#l8.882"></a><span id="l8.882">           ]]&gt;</span>
<a href="#l8.883"></a><span id="l8.883">         &lt;/body&gt;</span>
<a href="#l8.884"></a><span id="l8.884">       &lt;/method&gt;</span>
<a href="#l8.885"></a><span id="l8.885"> </span>
<a href="#l8.886"></a><span id="l8.886" class="difflineminus">-      &lt;!-- BEGIN FORWARDED BROWSER PROPERTIES.  IF YOU ADD A PROPERTY TO THE BROWSER ELEMENT</span>
<a href="#l8.887"></a><span id="l8.887" class="difflineminus">-           MAKE SURE TO ADD IT HERE AS WELL. --&gt;</span>
<a href="#l8.888"></a><span id="l8.888" class="difflineminus">-</span>
<a href="#l8.889"></a><span id="l8.889" class="difflineminus">-      &lt;property name=&quot;docShell&quot;</span>
<a href="#l8.890"></a><span id="l8.890" class="difflineminus">-                onget=&quot;return this.mCurrentBrowser.docShell&quot;</span>
<a href="#l8.891"></a><span id="l8.891" class="difflineminus">-                readonly=&quot;true&quot;/&gt;</span>
<a href="#l8.892"></a><span id="l8.892" class="difflineminus">-</span>
<a href="#l8.893"></a><span id="l8.893" class="difflineminus">-      &lt;property name=&quot;contentWindow&quot;</span>
<a href="#l8.894"></a><span id="l8.894" class="difflineminus">-                readonly=&quot;true&quot;</span>
<a href="#l8.895"></a><span id="l8.895" class="difflineminus">-                onget=&quot;return this.mCurrentBrowser.contentWindow&quot;/&gt;</span>
<a href="#l8.896"></a><span id="l8.896" class="difflineminus">-</span>
<a href="#l8.897"></a><span id="l8.897" class="difflineminus">-      &lt;property name=&quot;markupDocumentViewer&quot;</span>
<a href="#l8.898"></a><span id="l8.898" class="difflineminus">-                onget=&quot;return this.mCurrentBrowser.markupDocumentViewer;&quot;</span>
<a href="#l8.899"></a><span id="l8.899" class="difflineminus">-                readonly=&quot;true&quot;/&gt;</span>
<a href="#l8.900"></a><span id="l8.900" class="difflineminus">-</span>
<a href="#l8.901"></a><span id="l8.901" class="difflineminus">-      &lt;property name=&quot;contentDocument&quot;</span>
<a href="#l8.902"></a><span id="l8.902" class="difflineminus">-                onget=&quot;return this.mCurrentBrowser.contentDocument;&quot;</span>
<a href="#l8.903"></a><span id="l8.903" class="difflineminus">-                readonly=&quot;true&quot;/&gt;</span>
<a href="#l8.904"></a><span id="l8.904" class="difflineminus">-</span>
<a href="#l8.905"></a><span id="l8.905" class="difflineminus">-      &lt;property name=&quot;contentTitle&quot;</span>
<a href="#l8.906"></a><span id="l8.906" class="difflineminus">-                onget=&quot;return this.mCurrentBrowser.contentTitle;&quot;</span>
<a href="#l8.907"></a><span id="l8.907" class="difflineminus">-                readonly=&quot;true&quot;/&gt;</span>
<a href="#l8.908"></a><span id="l8.908" class="difflineminus">-</span>
<a href="#l8.909"></a><span id="l8.909" class="difflineminus">-      &lt;property name=&quot;findbar&quot;</span>
<a href="#l8.910"></a><span id="l8.910" class="difflineminus">-                onget=&quot;return this.mCurrentConversation.findbar;&quot;</span>
<a href="#l8.911"></a><span id="l8.911" class="difflineminus">-                readonly=&quot;true&quot;/&gt;</span>
<a href="#l8.912"></a><span id="l8.912" class="difflineminus">-</span>
<a href="#l8.913"></a><span id="l8.913">       &lt;method name=&quot;dragDropSecurityCheck&quot;&gt;</span>
<a href="#l8.914"></a><span id="l8.914">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l8.915"></a><span id="l8.915">         &lt;parameter name=&quot;aDragSession&quot;/&gt;</span>
<a href="#l8.916"></a><span id="l8.916">         &lt;parameter name=&quot;aUri&quot;/&gt;</span>
<a href="#l8.917"></a><span id="l8.917">         &lt;body&gt;</span>
<a href="#l8.918"></a><span id="l8.918">           &lt;![CDATA[</span>
<a href="#l8.919"></a><span id="l8.919">             nsDragAndDrop.dragDropSecurityCheck(aEvent, aDragSession, aUri);</span>
<a href="#l8.920"></a><span id="l8.920">           ]]&gt;</span>
<a href="#l8.921"></a><span id="l8.921" class="difflineat">@@ -1366,64 +1364,62 @@</span>
<a href="#l8.922"></a><span id="l8.922">       })]]&gt;</span>
<a href="#l8.923"></a><span id="l8.923">       &lt;/field&gt;</span>
<a href="#l8.924"></a><span id="l8.924"> </span>
<a href="#l8.925"></a><span id="l8.925">       &lt;method name=&quot;handleEvent&quot;&gt;</span>
<a href="#l8.926"></a><span id="l8.926">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l8.927"></a><span id="l8.927">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.928"></a><span id="l8.928">           switch (aEvent.type) {</span>
<a href="#l8.929"></a><span id="l8.929">             case &quot;sizemodechange&quot;:</span>
<a href="#l8.930"></a><span id="l8.930" class="difflineminus">-              if (aEvent.target == window) {</span>
<a href="#l8.931"></a><span id="l8.931" class="difflineminus">-                this.mCurrentBrowser.docShell.isActive =</span>
<a href="#l8.932"></a><span id="l8.932" class="difflineplus">+              if (this.selectedBrowser &amp;&amp; aEvent.target == window) {</span>
<a href="#l8.933"></a><span id="l8.933" class="difflineplus">+                this.selectedBrowser.docShell.isActive =</span>
<a href="#l8.934"></a><span id="l8.934">                   (window.windowState != window.STATE_MINIMIZED);</span>
<a href="#l8.935"></a><span id="l8.935">               }</span>
<a href="#l8.936"></a><span id="l8.936">               break;</span>
<a href="#l8.937"></a><span id="l8.937">           }</span>
<a href="#l8.938"></a><span id="l8.938">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.939"></a><span id="l8.939">       &lt;/method&gt;</span>
<a href="#l8.940"></a><span id="l8.940"> </span>
<a href="#l8.941"></a><span id="l8.941">       &lt;field name=&quot;_windowActivateHandler&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l8.942"></a><span id="l8.942">       &lt;![CDATA[({</span>
<a href="#l8.943"></a><span id="l8.943">         tabbrowser: this,</span>
<a href="#l8.944"></a><span id="l8.944" class="difflineminus">-        handleEvent: function handleEvent(aEvent)</span>
<a href="#l8.945"></a><span id="l8.945" class="difflineminus">-          this.tabbrowser.mCurrentTab.switchingToTab()</span>
<a href="#l8.946"></a><span id="l8.946" class="difflineplus">+        handleEvent: function handleEvent() {</span>
<a href="#l8.947"></a><span id="l8.947" class="difflineplus">+          if (&quot;switchingToPanel&quot; in this.tabbrowser.selectedPanel)</span>
<a href="#l8.948"></a><span id="l8.948" class="difflineplus">+            this.tabbrowser.selectedPanel.switchingToPanel();</span>
<a href="#l8.949"></a><span id="l8.949" class="difflineplus">+        }</span>
<a href="#l8.950"></a><span id="l8.950">       })]]&gt;</span>
<a href="#l8.951"></a><span id="l8.951">       &lt;/field&gt;</span>
<a href="#l8.952"></a><span id="l8.952"> </span>
<a href="#l8.953"></a><span id="l8.953">       &lt;field name=&quot;_windowDeactivateHandler&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l8.954"></a><span id="l8.954">       &lt;![CDATA[({</span>
<a href="#l8.955"></a><span id="l8.955">         tabbrowser: this,</span>
<a href="#l8.956"></a><span id="l8.956" class="difflineminus">-        handleEvent: function handleEvent(aEvent)</span>
<a href="#l8.957"></a><span id="l8.957" class="difflineminus">-          this.tabbrowser.mCurrentTab.switchingAwayFromTab()</span>
<a href="#l8.958"></a><span id="l8.958" class="difflineplus">+        handleEvent: function handleEvent() {</span>
<a href="#l8.959"></a><span id="l8.959" class="difflineplus">+          if (&quot;switchingAwayFromPanel&quot; in this.tabbrowser.selectedPanel)</span>
<a href="#l8.960"></a><span id="l8.960" class="difflineplus">+            this.tabbrowser.selectedPanel.switchingAwayFromPanel();</span>
<a href="#l8.961"></a><span id="l8.961" class="difflineplus">+        }</span>
<a href="#l8.962"></a><span id="l8.962">       })]]&gt;</span>
<a href="#l8.963"></a><span id="l8.963">       &lt;/field&gt;</span>
<a href="#l8.964"></a><span id="l8.964"> </span>
<a href="#l8.965"></a><span id="l8.965">       &lt;constructor&gt;</span>
<a href="#l8.966"></a><span id="l8.966">         &lt;![CDATA[</span>
<a href="#l8.967"></a><span id="l8.967" class="difflineminus">-          this.mCurrentConversation = this.mPanelContainer.firstChild;</span>
<a href="#l8.968"></a><span id="l8.968" class="difflineminus">-          this.mCurrentBrowser = this.mCurrentConversation.browser;</span>
<a href="#l8.969"></a><span id="l8.969">           this.mCurrentTab = this.mTabContainer.firstChild;</span>
<a href="#l8.970"></a><span id="l8.970" class="difflineplus">+          // Dummy tab is not a conversation</span>
<a href="#l8.971"></a><span id="l8.971" class="difflineplus">+          this.mCurrentTab.linkedTabPanel = this.mPanelContainer.firstChild;</span>
<a href="#l8.972"></a><span id="l8.972" class="difflineplus">+          this.mCurrentTab.linkedTabPanel.tab = this.mCurrentTab;</span>
<a href="#l8.973"></a><span id="l8.973"> </span>
<a href="#l8.974"></a><span id="l8.974">           document.addEventListener(&quot;keypress&quot;, this._keyEventHandler);</span>
<a href="#l8.975"></a><span id="l8.975">           document.addEventListener(&quot;sizemodechange&quot;, this);</span>
<a href="#l8.976"></a><span id="l8.976">           window.addEventListener(&quot;deactivate&quot;, this._windowDeactivateHandler);</span>
<a href="#l8.977"></a><span id="l8.977">           window.addEventListener(&quot;activate&quot;, this._windowActivateHandler);</span>
<a href="#l8.978"></a><span id="l8.978"> </span>
<a href="#l8.979"></a><span id="l8.979">           var uniqueId = &quot;panel&quot; + Date.now();</span>
<a href="#l8.980"></a><span id="l8.980" class="difflineminus">-          this.mCurrentConversation.id = uniqueId;</span>
<a href="#l8.981"></a><span id="l8.981" class="difflineplus">+          this.mCurrentTab.linkedTabPanel.id = uniqueId;</span>
<a href="#l8.982"></a><span id="l8.982">           this.mCurrentTab.linkedPanel = uniqueId;</span>
<a href="#l8.983"></a><span id="l8.983">           this.mCurrentTab._tPos = 0;</span>
<a href="#l8.984"></a><span id="l8.984" class="difflineminus">-          this.mCurrentTab.linkedConversation = this.mCurrentConversation;</span>
<a href="#l8.985"></a><span id="l8.985" class="difflineminus">-          this.mCurrentTab.linkedBrowser = this.mCurrentBrowser;</span>
<a href="#l8.986"></a><span id="l8.986"> </span>
<a href="#l8.987"></a><span id="l8.987" class="difflineminus">-          // set up the shared autoscroll popup</span>
<a href="#l8.988"></a><span id="l8.988" class="difflineminus">-          this._autoScrollPopup = this.mCurrentBrowser._createAutoScrollPopup();</span>
<a href="#l8.989"></a><span id="l8.989" class="difflineminus">-          this._autoScrollPopup.id = &quot;autoscroller&quot;;</span>
<a href="#l8.990"></a><span id="l8.990" class="difflineminus">-          this.appendChild(this._autoScrollPopup);</span>
<a href="#l8.991"></a><span id="l8.991" class="difflineminus">-          this.mCurrentBrowser.setAttribute(&quot;autoscrollpopup&quot;, this._autoScrollPopup.id);</span>
<a href="#l8.992"></a><span id="l8.992">           Services.prefs.addObserver(&quot;browser.tabs.autoHide&quot;, this._prefObserver, false);</span>
<a href="#l8.993"></a><span id="l8.993">           Services.prefs.addObserver(&quot;messenger.conversations.useSeparateWindowsForMUCs&quot;, this._prefObserver, false);</span>
<a href="#l8.994"></a><span id="l8.994">         ]]&gt;</span>
<a href="#l8.995"></a><span id="l8.995">       &lt;/constructor&gt;</span>
<a href="#l8.996"></a><span id="l8.996"> </span>
<a href="#l8.997"></a><span id="l8.997">       &lt;destructor&gt;</span>
<a href="#l8.998"></a><span id="l8.998">         &lt;![CDATA[</span>
<a href="#l8.999"></a><span id="l8.999">           document.removeEventListener(&quot;keypress&quot;, this._keyEventHandler);</span>
<a href="#l8.1000"></a><span id="l8.1000" class="difflineat">@@ -2072,50 +2068,16 @@</span>
<a href="#l8.1001"></a><span id="l8.1001">           &lt;xul:toolbarbutton anonid=&quot;close-button&quot; tabindex=&quot;-1&quot; class=&quot;tab-close-button&quot; tooltiptext=&quot;&amp;closeTab.label;&quot;/&gt;</span>
<a href="#l8.1002"></a><span id="l8.1002">         &lt;/xul:hbox&gt;</span>
<a href="#l8.1003"></a><span id="l8.1003">       &lt;/xul:stack&gt;</span>
<a href="#l8.1004"></a><span id="l8.1004">     &lt;/content&gt;</span>
<a href="#l8.1005"></a><span id="l8.1005"> </span>
<a href="#l8.1006"></a><span id="l8.1006">     &lt;implementation&gt;</span>
<a href="#l8.1007"></a><span id="l8.1007">       &lt;field name=&quot;mOverCloseButton&quot;&gt;false&lt;/field&gt;</span>
<a href="#l8.1008"></a><span id="l8.1008">       &lt;field name=&quot;mCorrespondingMenuitem&quot;&gt;null&lt;/field&gt;</span>
<a href="#l8.1009"></a><span id="l8.1009" class="difflineminus">-</span>
<a href="#l8.1010"></a><span id="l8.1010" class="difflineminus">-      &lt;method name=&quot;switchingToTab&quot;&gt;</span>
<a href="#l8.1011"></a><span id="l8.1011" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l8.1012"></a><span id="l8.1012" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l8.1013"></a><span id="l8.1013" class="difflineminus">-            if (this._visibleTimer)</span>
<a href="#l8.1014"></a><span id="l8.1014" class="difflineminus">-              return;</span>
<a href="#l8.1015"></a><span id="l8.1015" class="difflineminus">-</span>
<a href="#l8.1016"></a><span id="l8.1016" class="difflineminus">-            // Start a timer to detect if the tab has been visible to the</span>
<a href="#l8.1017"></a><span id="l8.1017" class="difflineminus">-            // user for long enough to actually be seen (as opposed to the</span>
<a href="#l8.1018"></a><span id="l8.1018" class="difflineminus">-            // tab only being visible &quot;accidentally in passing&quot;).</span>
<a href="#l8.1019"></a><span id="l8.1019" class="difflineminus">-            delete this._wasVisible;</span>
<a href="#l8.1020"></a><span id="l8.1020" class="difflineminus">-            this._visibleTimer = setTimeout(function() {</span>
<a href="#l8.1021"></a><span id="l8.1021" class="difflineminus">-              this._wasVisible = true;</span>
<a href="#l8.1022"></a><span id="l8.1022" class="difflineminus">-              delete this._visibleTimer;</span>
<a href="#l8.1023"></a><span id="l8.1023" class="difflineminus">-            }.bind(this), 1000);</span>
<a href="#l8.1024"></a><span id="l8.1024" class="difflineminus">-          ]]&gt;</span>
<a href="#l8.1025"></a><span id="l8.1025" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l8.1026"></a><span id="l8.1026" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l8.1027"></a><span id="l8.1027" class="difflineminus">-</span>
<a href="#l8.1028"></a><span id="l8.1028" class="difflineminus">-      &lt;method name=&quot;switchingAwayFromTab&quot;&gt;</span>
<a href="#l8.1029"></a><span id="l8.1029" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l8.1030"></a><span id="l8.1030" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l8.1031"></a><span id="l8.1031" class="difflineminus">-            if (this._visibleTimer) {</span>
<a href="#l8.1032"></a><span id="l8.1032" class="difflineminus">-              clearTimeout(this._visibleTimer);</span>
<a href="#l8.1033"></a><span id="l8.1033" class="difflineminus">-              delete this._visibleTimer;</span>
<a href="#l8.1034"></a><span id="l8.1034" class="difflineminus">-            }</span>
<a href="#l8.1035"></a><span id="l8.1035" class="difflineminus">-</span>
<a href="#l8.1036"></a><span id="l8.1036" class="difflineminus">-            // Remove the unread ruler if the tab has been visible without</span>
<a href="#l8.1037"></a><span id="l8.1037" class="difflineminus">-            // interruptions for sufficiently long.</span>
<a href="#l8.1038"></a><span id="l8.1038" class="difflineminus">-            if (this._wasVisible)</span>
<a href="#l8.1039"></a><span id="l8.1039" class="difflineminus">-              this.linkedBrowser.removeUnreadRuler();</span>
<a href="#l8.1040"></a><span id="l8.1040" class="difflineminus">-          ]]&gt;</span>
<a href="#l8.1041"></a><span id="l8.1041" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l8.1042"></a><span id="l8.1042" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l8.1043"></a><span id="l8.1043">     &lt;/implementation&gt;</span>
<a href="#l8.1044"></a><span id="l8.1044"> </span>
<a href="#l8.1045"></a><span id="l8.1045">     &lt;handlers&gt;</span>
<a href="#l8.1046"></a><span id="l8.1046">       &lt;handler event=&quot;mouseover&quot;&gt;</span>
<a href="#l8.1047"></a><span id="l8.1047">         var anonid = event.originalTarget.getAttribute(&quot;anonid&quot;);</span>
<a href="#l8.1048"></a><span id="l8.1048">         if (anonid == &quot;close-button&quot;)</span>
<a href="#l8.1049"></a><span id="l8.1049">           this.mOverCloseButton = true;</span>
<a href="#l8.1050"></a><span id="l8.1050">       &lt;/handler&gt;</span>
<a href="#l8.1051"></a><span id="l8.1051" class="difflineat">@@ -2132,19 +2094,20 @@</span>
<a href="#l8.1052"></a><span id="l8.1052">         if (this.mOverCloseButton) {</span>
<a href="#l8.1053"></a><span id="l8.1053">           event.stopPropagation();</span>
<a href="#l8.1054"></a><span id="l8.1054">         }</span>
<a href="#l8.1055"></a><span id="l8.1055">         else {</span>
<a href="#l8.1056"></a><span id="l8.1056">           // If this tab is not currently selected, call the onSelect method of</span>
<a href="#l8.1057"></a><span id="l8.1057">           // the current tab to mark the conversation as read before leaving it.</span>
<a href="#l8.1058"></a><span id="l8.1058">           // This is necessary when Instantbird (and therefore the current tab)</span>
<a href="#l8.1059"></a><span id="l8.1059">           // did not have focus before this click.</span>
<a href="#l8.1060"></a><span id="l8.1060" class="difflineminus">-          if (!this.linkedConversation.hasAttribute(&quot;selected&quot;)) {</span>
<a href="#l8.1061"></a><span id="l8.1061" class="difflineminus">-            let tabbrowser = document.getBindingParent(this);</span>
<a href="#l8.1062"></a><span id="l8.1062" class="difflineminus">-            tabbrowser.mCurrentConversation.onSelect();</span>
<a href="#l8.1063"></a><span id="l8.1063" class="difflineplus">+          if (!this.linkedTabPanel.hasAttribute(&quot;selected&quot;)) {</span>
<a href="#l8.1064"></a><span id="l8.1064" class="difflineplus">+            let panel = document.getBindingParent(this).selectedPanel;</span>
<a href="#l8.1065"></a><span id="l8.1065" class="difflineplus">+            if (&quot;onSelect&quot; in panel)</span>
<a href="#l8.1066"></a><span id="l8.1066" class="difflineplus">+              panel.onSelect();</span>
<a href="#l8.1067"></a><span id="l8.1067">           }</span>
<a href="#l8.1068"></a><span id="l8.1068"> </span>
<a href="#l8.1069"></a><span id="l8.1069">           this.style.MozUserFocus = 'ignore';</span>
<a href="#l8.1070"></a><span id="l8.1070">           this.clientTop; // just using this to flush style updates</span>
<a href="#l8.1071"></a><span id="l8.1071">         }</span>
<a href="#l8.1072"></a><span id="l8.1072">       ]]&gt;</span>
<a href="#l8.1073"></a><span id="l8.1073">       &lt;/handler&gt;</span>
<a href="#l8.1074"></a><span id="l8.1074">       &lt;handler event=&quot;mousedown&quot; button=&quot;1&quot;&gt;</span>
<a href="#l8.1075"></a><span id="l8.1075" class="difflineat">@@ -2155,26 +2118,40 @@</span>
<a href="#l8.1076"></a><span id="l8.1076">         this.style.MozUserFocus = 'ignore';</span>
<a href="#l8.1077"></a><span id="l8.1077">         this.clientTop;</span>
<a href="#l8.1078"></a><span id="l8.1078">       &lt;/handler&gt;</span>
<a href="#l8.1079"></a><span id="l8.1079">       &lt;handler event=&quot;mouseup&quot;&gt;</span>
<a href="#l8.1080"></a><span id="l8.1080">         this.style.MozUserFocus = '';</span>
<a href="#l8.1081"></a><span id="l8.1081">       &lt;/handler&gt;</span>
<a href="#l8.1082"></a><span id="l8.1082">       &lt;handler event=&quot;DOMAttrModified&quot;&gt;</span>
<a href="#l8.1083"></a><span id="l8.1083">        &lt;![CDATA[</span>
<a href="#l8.1084"></a><span id="l8.1084" class="difflineminus">-        if (event.attrName == &quot;label&quot; &amp;&amp; (&quot;getBrowser&quot; in window))</span>
<a href="#l8.1085"></a><span id="l8.1085" class="difflineminus">-          getBrowser().updateTitlebar();</span>
<a href="#l8.1086"></a><span id="l8.1086" class="difflineminus">-</span>
<a href="#l8.1087"></a><span id="l8.1087" class="difflineminus">-        if (event.attrName != &quot;selected&quot;)</span>
<a href="#l8.1088"></a><span id="l8.1088" class="difflineminus">-          return;</span>
<a href="#l8.1089"></a><span id="l8.1089" class="difflineminus">-</span>
<a href="#l8.1090"></a><span id="l8.1090" class="difflineminus">-        if (event.attrChange == event.REMOVAL) {</span>
<a href="#l8.1091"></a><span id="l8.1091" class="difflineminus">-          this.linkedConversation.removeAttribute(&quot;selected&quot;);</span>
<a href="#l8.1092"></a><span id="l8.1092" class="difflineminus">-          this.switchingAwayFromTab();</span>
<a href="#l8.1093"></a><span id="l8.1093" class="difflineplus">+        if (event.attrName == &quot;label&quot;) {</span>
<a href="#l8.1094"></a><span id="l8.1094" class="difflineplus">+          if (&quot;getTabBrowser&quot; in window)</span>
<a href="#l8.1095"></a><span id="l8.1095" class="difflineplus">+            getTabBrowser().updateTitlebar();</span>
<a href="#l8.1096"></a><span id="l8.1096" class="difflineplus">+          // Update our tooltiptext, but only if a tooltip hasn't been set.</span>
<a href="#l8.1097"></a><span id="l8.1097" class="difflineplus">+          if (!this.hasAttribute(&quot;tooltip&quot;))</span>
<a href="#l8.1098"></a><span id="l8.1098" class="difflineplus">+            this.setAttribute(&quot;tooltiptext&quot;, event.newValue);</span>
<a href="#l8.1099"></a><span id="l8.1099">         }</span>
<a href="#l8.1100"></a><span id="l8.1100" class="difflineminus">-        else</span>
<a href="#l8.1101"></a><span id="l8.1101" class="difflineminus">-          this.linkedConversation.setAttribute(&quot;selected&quot;, event.newValue);</span>
<a href="#l8.1102"></a><span id="l8.1102" class="difflineplus">+        else if (event.attrName == &quot;tooltip&quot;) {</span>
<a href="#l8.1103"></a><span id="l8.1103" class="difflineplus">+          if (event.attrChange == event.ADDITION) {</span>
<a href="#l8.1104"></a><span id="l8.1104" class="difflineplus">+            // Tooltip was added. Stop using our tooltiptext attribute.</span>
<a href="#l8.1105"></a><span id="l8.1105" class="difflineplus">+            this.removeAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l8.1106"></a><span id="l8.1106" class="difflineplus">+          }</span>
<a href="#l8.1107"></a><span id="l8.1107" class="difflineplus">+          else if (event.attrChange == event.REMOVAL) {</span>
<a href="#l8.1108"></a><span id="l8.1108" class="difflineplus">+            // Tooltip was removed. Switch to using our label as tooltiptext.</span>
<a href="#l8.1109"></a><span id="l8.1109" class="difflineplus">+            this.setAttribute(&quot;tooltiptext&quot;, this.getAttribute(&quot;label&quot;));</span>
<a href="#l8.1110"></a><span id="l8.1110" class="difflineplus">+          }</span>
<a href="#l8.1111"></a><span id="l8.1111" class="difflineplus">+        }</span>
<a href="#l8.1112"></a><span id="l8.1112" class="difflineplus">+        else if (event.attrName == &quot;selected&quot;) {</span>
<a href="#l8.1113"></a><span id="l8.1113" class="difflineplus">+          if (event.attrChange == event.REMOVAL) {</span>
<a href="#l8.1114"></a><span id="l8.1114" class="difflineplus">+            this.linkedTabPanel.removeAttribute(&quot;selected&quot;);</span>
<a href="#l8.1115"></a><span id="l8.1115" class="difflineplus">+            if (&quot;switchingAwayFromPanel&quot; in this.linkedTabPanel)</span>
<a href="#l8.1116"></a><span id="l8.1116" class="difflineplus">+              this.linkedTabPanel.switchingAwayFromPanel();</span>
<a href="#l8.1117"></a><span id="l8.1117" class="difflineplus">+          }</span>
<a href="#l8.1118"></a><span id="l8.1118" class="difflineplus">+          else</span>
<a href="#l8.1119"></a><span id="l8.1119" class="difflineplus">+            this.linkedTabPanel.setAttribute(&quot;selected&quot;, event.newValue);</span>
<a href="#l8.1120"></a><span id="l8.1120" class="difflineplus">+        }</span>
<a href="#l8.1121"></a><span id="l8.1121">        ]]&gt;</span>
<a href="#l8.1122"></a><span id="l8.1122">       &lt;/handler&gt;</span>
<a href="#l8.1123"></a><span id="l8.1123">     &lt;/handlers&gt;</span>
<a href="#l8.1124"></a><span id="l8.1124">   &lt;/binding&gt;</span>
<a href="#l8.1125"></a><span id="l8.1125"> </span>
<a href="#l8.1126"></a><span id="l8.1126"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/im/locales/en-US/chrome/instantbird/conversation.properties</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,10 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+contextShowLogs.label=Show Logs</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+contextShowLogs.accesskey=L</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+contextCloseConv.label=Close Conversation</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+contextCloseConv.accesskey=v</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+contextHideConv.label=Put Conversation on Hold</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+contextHideConv.accesskey=h</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/im/locales/en-US/chrome/instantbird/tabbrowser.dtd</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/im/locales/en-US/chrome/instantbird/tabbrowser.dtd</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -6,16 +6,10 @@</span>
<a href="#l10.4"></a><span id="l10.4"> &lt;!ENTITY  newTab.label           &quot;New Tab&quot;&gt;</span>
<a href="#l10.5"></a><span id="l10.5"> &lt;!ENTITY  newTab.accesskey       &quot;N&quot;&gt;</span>
<a href="#l10.6"></a><span id="l10.6"> &lt;!ENTITY  closeTab.label         &quot;Close Tab&quot;&gt;</span>
<a href="#l10.7"></a><span id="l10.7"> &lt;!ENTITY  closeTab.accesskey     &quot;c&quot;&gt;</span>
<a href="#l10.8"></a><span id="l10.8"> &lt;!ENTITY  closeOtherTabs.accesskey &quot;o&quot;&gt;</span>
<a href="#l10.9"></a><span id="l10.9"> &lt;!ENTITY  closeOtherTabs.label     &quot;Close Other Tabs&quot;&gt;</span>
<a href="#l10.10"></a><span id="l10.10"> &lt;!ENTITY  openTabInNewWindow.label     &quot;Open in a New Window&quot;&gt;</span>
<a href="#l10.11"></a><span id="l10.11"> &lt;!ENTITY  openTabInNewWindow.accesskey &quot;W&quot;&gt;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-&lt;!ENTITY  showLogs.label         &quot;Show Logs&quot;&gt;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-&lt;!ENTITY  showLogs.accesskey     &quot;L&quot;&gt;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-&lt;!ENTITY  closeConv.label        &quot;Close Conversation&quot;&gt;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-&lt;!ENTITY  closeConv.accesskey    &quot;v&quot;&gt;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-&lt;!ENTITY  hideConv.label         &quot;Put Conversation on Hold&quot;&gt;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-&lt;!ENTITY  hideConv.accesskey     &quot;h&quot;&gt;</span>
<a href="#l10.18"></a><span id="l10.18"> &lt;!ENTITY  listAllTabs.label      &quot;List all tabs&quot;&gt;</span>
<a href="#l10.19"></a><span id="l10.19"> &lt;!ENTITY  newTabButton.tooltip   &quot;Open a new tab&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/im/locales/jar.mn</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/im/locales/jar.mn</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -9,16 +9,17 @@</span>
<a href="#l11.4"></a><span id="l11.4"> 	locale/@AB_CD@/instantbird/aboutDialog.dtd	(%chrome/instantbird/aboutDialog.dtd)</span>
<a href="#l11.5"></a><span id="l11.5"> 	locale/@AB_CD@/instantbird/account.dtd		(%chrome/instantbird/account.dtd)</span>
<a href="#l11.6"></a><span id="l11.6"> 	locale/@AB_CD@/instantbird/accounts.dtd		(%chrome/instantbird/accounts.dtd)</span>
<a href="#l11.7"></a><span id="l11.7"> 	locale/@AB_CD@/instantbird/accounts.properties	(%chrome/instantbird/accounts.properties)</span>
<a href="#l11.8"></a><span id="l11.8"> 	locale/@AB_CD@/instantbird/accountWizard.dtd	(%chrome/instantbird/accountWizard.dtd)</span>
<a href="#l11.9"></a><span id="l11.9"> 	locale/@AB_CD@/instantbird/accountWizard.properties	(%chrome/instantbird/accountWizard.properties)</span>
<a href="#l11.10"></a><span id="l11.10"> 	locale/@AB_CD@/instantbird/addbuddy.dtd		(%chrome/instantbird/addbuddy.dtd)</span>
<a href="#l11.11"></a><span id="l11.11"> 	locale/@AB_CD@/instantbird/buddytooltip.properties (%chrome/instantbird/buddytooltip.properties)</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+	locale/@AB_CD@/instantbird/conversation.properties	(%chrome/instantbird/conversation.properties)</span>
<a href="#l11.13"></a><span id="l11.13"> 	locale/@AB_CD@/instantbird/core.properties	(%chrome/instantbird/core.properties)</span>
<a href="#l11.14"></a><span id="l11.14"> 	locale/@AB_CD@/instantbird/credits.dtd		(%chrome/instantbird/credits.dtd)</span>
<a href="#l11.15"></a><span id="l11.15"> 	locale/@AB_CD@/instantbird/engineManager.dtd	(%chrome/instantbird/engineManager.dtd)</span>
<a href="#l11.16"></a><span id="l11.16"> 	locale/@AB_CD@/instantbird/engineManager.properties (%chrome/instantbird/engineManager.properties)</span>
<a href="#l11.17"></a><span id="l11.17"> 	locale/@AB_CD@/instantbird/extensions.properties (%chrome/instantbird/extensions.properties)</span>
<a href="#l11.18"></a><span id="l11.18"> 	locale/@AB_CD@/instantbird/extensions-discover.dtd (%chrome/instantbird/extensions-discover.dtd)</span>
<a href="#l11.19"></a><span id="l11.19"> 	locale/@AB_CD@/instantbird/instantbird.dtd	(%chrome/instantbird/instantbird.dtd)</span>
<a href="#l11.20"></a><span id="l11.20"> 	locale/@AB_CD@/instantbird/instantbird.properties (%chrome/instantbird/instantbird.properties)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/im/modules/imWindows.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/im/modules/imWindows.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -72,16 +72,18 @@ var Conversations = {</span>
<a href="#l12.4"></a><span id="l12.4">     // The conversation may still not be displayed if we are waiting</span>
<a href="#l12.5"></a><span id="l12.5">     // for a new window. In this case the conversation will be focused</span>
<a href="#l12.6"></a><span id="l12.6">     // automatically anyway.</span>
<a href="#l12.7"></a><span id="l12.7">     if (this.isUIConversationDisplayed(uiConv)) {</span>
<a href="#l12.8"></a><span id="l12.8">       let conv = this._uiConv[uiConv.id];</span>
<a href="#l12.9"></a><span id="l12.9">       let doc = conv.ownerDocument;</span>
<a href="#l12.10"></a><span id="l12.10">       doc.getElementById(&quot;conversations&quot;).selectedTab = conv.tab;</span>
<a href="#l12.11"></a><span id="l12.11">       conv.focus();</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+      // Tell it to mark itself as read.</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+      conv.onSelect();</span>
<a href="#l12.14"></a><span id="l12.14">       doc.defaultView.focus();</span>
<a href="#l12.15"></a><span id="l12.15"> #ifdef XP_MACOSX</span>
<a href="#l12.16"></a><span id="l12.16">       Components.classes[&quot;@mozilla.org/widget/macdocksupport;1&quot;]</span>
<a href="#l12.17"></a><span id="l12.17">                 .getService(Components.interfaces.nsIMacDockSupport)</span>
<a href="#l12.18"></a><span id="l12.18">                 .activateApplication(true);</span>
<a href="#l12.19"></a><span id="l12.19"> #endif</span>
<a href="#l12.20"></a><span id="l12.20">     }</span>
<a href="#l12.21"></a><span id="l12.21">     return uiConv;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

