<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 8570:9fa12b677b96af32705c70646afa5ce7fc871f17</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9fa12b677b96af32705c70646afa5ce7fc871f17" />
<meta property="og:url" content="/comm-central/rev/9fa12b677b96af32705c70646afa5ce7fc871f17" />
<meta property="og:description" content="Bug 661410 - Implement UI for out-of-process plugins. r=Standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9fa12b677b96af32705c70646afa5ce7fc871f17 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9fa12b677b96af32705c70646afa5ce7fc871f17">shortlog</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9fa12b677b96af32705c70646afa5ce7fc871f17">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17">files</a> |
changeset |
<a href="/comm-central/raw-rev/9fa12b677b96af32705c70646afa5ce7fc871f17">raw</a>  | <a href="/comm-central/archive/9fa12b677b96af32705c70646afa5ce7fc871f17.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=661410">Bug 661410</a> - Implement UI for out-of-process plugins. r=Standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#105;&#107;&#101;&#32;&#67;&#111;&#110;&#108;&#101;&#121;&#32;&#60;&#109;&#99;&#111;&#110;&#108;&#101;&#121;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 26 Sep 2011 22:33:14 +0100</td></tr>

<tr>
 <td>changeset 8570</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9fa12b677b96af32705c70646afa5ce7fc871f17">9fa12b677b96af32705c70646afa5ce7fc871f17</a></td>
</tr>



<tr>
<td>parent 8569</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ad1f76cfcbcc4022373b78129ae685ee2f363a10">ad1f76cfcbcc4022373b78129ae685ee2f363a10</a>
</td>
</tr>

<tr>
<td>child 8571</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/06fafe4cdac0de94841306f9c7f6baf7cd57fea8">06fafe4cdac0de94841306f9c7f6baf7cd57fea8</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9fa12b677b96af32705c70646afa5ce7fc871f17">6583</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 26 Sep 2011 21:35:21 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9fa12b677b96 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9fa12b677b96af32705c70646afa5ce7fc871f17">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9fa12b677b96af32705c70646afa5ce7fc871f17&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9fa12b677b96af32705c70646afa5ce7fc871f17&newProject=comm-central&newRevision=6ff6a3f0364ed19eff2841230ec30a6715ebace5&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9fa12b677b96af32705c70646afa5ce7fc871f17&newProject=comm-central&newRevision=6ff6a3f0364ed19eff2841230ec30a6715ebace5&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9fa12b677b96af32705c70646afa5ce7fc871f17&newProject=comm-central&newRevision=6ff6a3f0364ed19eff2841230ec30a6715ebace5&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=661410">661410</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=661410">Bug 661410</a> - Implement UI for out-of-process plugins. r=Standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/app/profile/all-thunderbird.js">mail/app/profile/all-thunderbird.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/app/profile/all-thunderbird.js">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/app/profile/all-thunderbird.js">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/app/profile/all-thunderbird.js">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/app/profile/all-thunderbird.js">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/app/profile/all-thunderbird.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/mailWindowOverlay.xul">mail/base/content/mailWindowOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/mailWindowOverlay.xul">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/mailWindowOverlay.xul">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/mailWindowOverlay.xul">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/mailWindowOverlay.xul">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/mailWindowOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/plugins.js">mail/base/content/plugins.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/plugins.js">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/plugins.js">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/plugins.js">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/plugins.js">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/plugins.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/specialTabs.js">mail/base/content/specialTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/specialTabs.js">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/specialTabs.js">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/specialTabs.js">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/specialTabs.js">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/content/specialTabs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/jar.mn">mail/base/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/jar.mn">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/jar.mn">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/jar.mn">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/jar.mn">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/base/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/locales/en-US/chrome/messenger/messenger.properties">mail/locales/en-US/chrome/messenger/messenger.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/locales/en-US/chrome/messenger/messenger.properties">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/locales/en-US/chrome/messenger/messenger.properties">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/locales/en-US/chrome/messenger/messenger.properties">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/locales/en-US/chrome/messenger/messenger.properties">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/locales/en-US/chrome/messenger/messenger.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/blocklist.xml">mail/test/mozmill/content-tabs/html/blocklist.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/blocklist.xml">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/blocklist.xml">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/blocklist.xml">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/blocklist.xml">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/blocklist.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/blocklist_details.html">mail/test/mozmill/content-tabs/html/blocklist_details.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/blocklist_details.html">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/blocklist_details.html">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/blocklist_details.html">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/blocklist_details.html">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/blocklist_details.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin.html">mail/test/mozmill/content-tabs/html/plugin.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin.html">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin.html">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin.html">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin.html">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin_crashed_help.html">mail/test/mozmill/content-tabs/html/plugin_crashed_help.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin_crashed_help.html">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin_crashed_help.html">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin_crashed_help.html">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin_crashed_help.html">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin_crashed_help.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin_update.html">mail/test/mozmill/content-tabs/html/plugin_update.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin_update.html">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin_update.html">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin_update.html">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin_update.html">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/plugin_update.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/unknown-plugin.html">mail/test/mozmill/content-tabs/html/unknown-plugin.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/unknown-plugin.html">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/unknown-plugin.html">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/unknown-plugin.html">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/unknown-plugin.html">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/html/unknown-plugin.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-lwthemes.js">mail/test/mozmill/content-tabs/test-lwthemes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-lwthemes.js">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-lwthemes.js">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-lwthemes.js">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-lwthemes.js">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-lwthemes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-blocked.js">mail/test/mozmill/content-tabs/test-plugin-blocked.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-blocked.js">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-blocked.js">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-blocked.js">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-blocked.js">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-blocked.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-crashing.js">mail/test/mozmill/content-tabs/test-plugin-crashing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-crashing.js">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-crashing.js">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-crashing.js">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-crashing.js">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-crashing.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-outdated.js">mail/test/mozmill/content-tabs/test-plugin-outdated.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-outdated.js">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-outdated.js">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-outdated.js">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-outdated.js">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-outdated.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-unknown.js">mail/test/mozmill/content-tabs/test-plugin-unknown.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-unknown.js">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-unknown.js">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-unknown.js">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-unknown.js">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/content-tabs/test-plugin-unknown.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">mail/test/mozmill/shared-modules/test-content-tab-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">file</a> |
<a href="/comm-central/annotate/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">annotate</a> |
<a href="/comm-central/diff/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">diff</a> |
<a href="/comm-central/comparison/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">comparison</a> |
<a href="/comm-central/log/9fa12b677b96af32705c70646afa5ce7fc871f17/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/app/profile/all-thunderbird.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/app/profile/all-thunderbird.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -695,13 +695,32 @@ pref(&quot;dom.ipc.plugins.enabled&quot;, true);</span>
<a href="#l1.4"></a><span id="l1.4"> // OS calls in the plugin process, then arranging to make certain OS calls</span>
<a href="#l1.5"></a><span id="l1.5"> // in the browser process.  Eventually plugins will be required to use the</span>
<a href="#l1.6"></a><span id="l1.6"> // NPAPI to manipulate the cursor, and these workarounds will be removed.</span>
<a href="#l1.7"></a><span id="l1.7"> // See bug 621117.</span>
<a href="#l1.8"></a><span id="l1.8"> #ifdef XP_MACOSX</span>
<a href="#l1.9"></a><span id="l1.9"> pref(&quot;dom.ipc.plugins.nativeCursorSupport&quot;, true);</span>
<a href="#l1.10"></a><span id="l1.10"> #endif</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+// plugin finder service url</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+pref(&quot;pfs.datasource.url&quot;, &quot;https://pfs.mozilla.org/plugins/PluginFinderService.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+php?mimetype=%PLUGIN_MIMETYPE%&amp;appID=%APP_ID%&amp;appVersion=%APP_VERSION%&amp;clientOS=</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+%CLIENT_OS%&amp;chromeLocale=%CHROME_LOCALE%&amp;appRelease=%APP_RELEASE%&quot;);</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+// By default we show an infobar message when pages require plugins the user has</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+// not installed, or are outdated.</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+pref(&quot;plugins.hide_infobar_for_missing_plugin&quot;, false);</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+pref(&quot;plugins.hide_infobar_for_outdated_plugin&quot;, false);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+#ifdef XP_MACOSX</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+pref(&quot;plugins.use_layers&quot;, false);</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+pref(&quot;plugins.hide_infobar_for_carbon_failure_plugin&quot;, false);</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+#endif</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+pref(&quot;plugins.update.url&quot;, &quot;https://www.mozilla.com/%LOCALE%/plugincheck/&quot;);</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+pref(&quot;plugins.update.notifyUser&quot;, false);</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+pref(&quot;plugins.crash.supportUrl&quot;, &quot;https://live.mozillamessaging.com/%APP%/plugin-crashed?locale=%LOCALE%&amp;version=%VERSION%&amp;os=%OS%&amp;buildid=%APPBUILDID%&quot;);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+</span>
<a href="#l1.31"></a><span id="l1.31"> // Windows taskbar support</span>
<a href="#l1.32"></a><span id="l1.32"> #ifdef XP_WIN</span>
<a href="#l1.33"></a><span id="l1.33"> pref(&quot;mail.taskbar.lists.enabled&quot;, true);</span>
<a href="#l1.34"></a><span id="l1.34"> pref(&quot;mail.taskbar.lists.tasks.enabled&quot;, true);</span>
<a href="#l1.35"></a><span id="l1.35"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -77,16 +77,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/mailWindowOverlay.js&quot;/&gt;</span>
<a href="#l2.5"></a><span id="l2.5"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/mailTabs.js&quot;/&gt;</span>
<a href="#l2.6"></a><span id="l2.6"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/messageDisplay.js&quot;/&gt;</span>
<a href="#l2.7"></a><span id="l2.7"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/folderDisplay.js&quot;/&gt;</span>
<a href="#l2.8"></a><span id="l2.8"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger-newsblog/content/newsblogOverlay.js&quot;/&gt;</span>
<a href="#l2.9"></a><span id="l2.9"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/mail-offline.js&quot;/&gt;</span>
<a href="#l2.10"></a><span id="l2.10"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://global/content/printUtils.js&quot;/&gt;</span>
<a href="#l2.11"></a><span id="l2.11"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/msgViewPickerOverlay.js&quot;/&gt;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+&lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/plugins.js&quot;/&gt;</span>
<a href="#l2.13"></a><span id="l2.13"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://global/content/viewZoomOverlay.js&quot;/&gt;</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> &lt;stringbundleset id=&quot;stringbundleset&quot;&gt;</span>
<a href="#l2.16"></a><span id="l2.16">   &lt;stringbundle id=&quot;bundle_messenger&quot; src=&quot;chrome://messenger/locale/messenger.properties&quot;/&gt;</span>
<a href="#l2.17"></a><span id="l2.17">   &lt;stringbundle id=&quot;bundle_offlinePrompts&quot; src=&quot;chrome://messenger/locale/offline.properties&quot;/&gt;</span>
<a href="#l2.18"></a><span id="l2.18"> &lt;/stringbundleset&gt;</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> &lt;!-- Performance optimization...we include utilityOverlay.xul which defines some command sets</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -389,16 +389,18 @@ function OnLoadMessenger()</span>
<a href="#l3.4"></a><span id="l3.4">     panelcontainer.addEventListener(&quot;InstallBrowserTheme&quot;,</span>
<a href="#l3.5"></a><span id="l3.5">                                     LightWeightThemeWebInstaller, false, true);</span>
<a href="#l3.6"></a><span id="l3.6">     panelcontainer.addEventListener(&quot;PreviewBrowserTheme&quot;,</span>
<a href="#l3.7"></a><span id="l3.7">                                     LightWeightThemeWebInstaller, false, true);</span>
<a href="#l3.8"></a><span id="l3.8">     panelcontainer.addEventListener(&quot;ResetBrowserThemePreview&quot;,</span>
<a href="#l3.9"></a><span id="l3.9">                                     LightWeightThemeWebInstaller, false, true);</span>
<a href="#l3.10"></a><span id="l3.10">   }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  Services.obs.addObserver(gPluginHandler.pluginCrashed, &quot;plugin-crashed&quot;, false);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+</span>
<a href="#l3.14"></a><span id="l3.14">   // This also registers the contentTabType (&quot;contentTab&quot;)</span>
<a href="#l3.15"></a><span id="l3.15">   specialTabs.openSpecialTabsOnStartup();</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17">   window.addEventListener(&quot;AppCommand&quot;, HandleAppCommandEvent, true);</span>
<a href="#l3.18"></a><span id="l3.18"> }</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20"> function LoadPostAccountWizard()</span>
<a href="#l3.21"></a><span id="l3.21"> {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -585,16 +587,18 @@ function OnUnloadMessenger()</span>
<a href="#l3.23"></a><span id="l3.23">   tabmail._teardown();</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25">   var mailSession = Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l3.26"></a><span id="l3.26">                               .getService(Components.interfaces.nsIMsgMailSession);</span>
<a href="#l3.27"></a><span id="l3.27">   mailSession.RemoveFolderListener(folderListener);</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">   gPhishingDetector.shutdown();</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  Services.obs.removeObserver(gPluginHandler.pluginCrashed, &quot;plugin-crashed&quot;);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+</span>
<a href="#l3.33"></a><span id="l3.33">   // FIX ME - later we will be able to use onload from the overlay</span>
<a href="#l3.34"></a><span id="l3.34">   OnUnloadMsgHeaderPane();</span>
<a href="#l3.35"></a><span id="l3.35"> </span>
<a href="#l3.36"></a><span id="l3.36">   UnloadPanes();</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38">   OnMailWindowUnload();</span>
<a href="#l3.39"></a><span id="l3.39">   try {</span>
<a href="#l3.40"></a><span id="l3.40">     mailInstrumentationManager.uninit();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mail/base/content/plugins.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,668 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ *</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ *</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ * License.</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+ *</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+ *</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+ * the Mozilla Foundation.</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+ *</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+ *   Mike Conley &lt;mconley@mozilla.com&gt;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+ *</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+ *</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+/* A note to the curious: a large portion of this code was copied over from</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+ * mozilla/browser/base/content/browser.js</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+ */</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+#ifdef MOZ_CRASHREPORTER</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(this, &quot;gCrashReporter&quot;,</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+                                   &quot;@mozilla.org/xre/app-info;1&quot;,</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+                                   &quot;nsICrashReporter&quot;);</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+#endif</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+function getPluginInfo(pluginElement)</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+{</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+  var tagMimetype;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+  var pluginsPage;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  if (pluginElement instanceof HTMLAppletElement) {</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+    tagMimetype = &quot;application/x-java-vm&quot;;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  } else {</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+    if (pluginElement instanceof HTMLObjectElement) {</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+      pluginsPage = pluginElement.getAttribute(&quot;codebase&quot;);</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+    } else {</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+      pluginsPage = pluginElement.getAttribute(&quot;pluginspage&quot;);</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+    }</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+    // only attempt if a pluginsPage is defined.</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+    if (pluginsPage) {</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+      var doc = pluginElement.ownerDocument;</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+      var docShell = findChildShell(doc, gBrowser.docShell, null);</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+      try {</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+        pluginsPage = makeURI(pluginsPage, doc.characterSet, docShell.currentURI).spec;</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+      } catch (ex) {</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+        pluginsPage = &quot;&quot;;</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+      }</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+    }</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+    tagMimetype = pluginElement.QueryInterface(Components.interfaces.nsIObjectLoadingContent)</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+                 .actualType;</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+    if (tagMimetype == &quot;&quot;) {</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+      tagMimetype = pluginElement.type;</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+    }</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+  }</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  return {mimetype: tagMimetype, pluginsPage: pluginsPage};</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+}</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+/**</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+ * Format a URL</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+ * eg:</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+ * echo formatURL(&quot;https://addons.mozilla.org/%LOCALE%/%APP%/%VERSION%/&quot;);</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+ * &gt; https://addons.mozilla.org/en-US/firefox/3.0a1/</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+ *</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+ * Currently supported built-ins are LOCALE, APP, and any value from nsIXULAppInfo, uppercased.</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+ */</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+function formatURL(aFormat, aIsPref) {</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+  var formatter = Services.urlFormatter;</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+  return aIsPref ? formatter.formatURLPref(aFormat) : formatter.formatURL(aFormat);</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+}</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+var gPluginHandler = {</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+  addEventListeners: function ph_addEventListeners(browser) {</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+    browser.addEventListener(&quot;PluginNotFound&quot;, gPluginHandler, true);</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+    browser.addEventListener(&quot;PluginCrashed&quot;, gPluginHandler, true);</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+    browser.addEventListener(&quot;PluginBlocklisted&quot;, gPluginHandler, true);</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+    browser.addEventListener(&quot;PluginOutdated&quot;, gPluginHandler, true);</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+    browser.addEventListener(&quot;PluginDisabled&quot;, gPluginHandler, true);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+    browser.addEventListener(&quot;NewPluginInstalled&quot;, gPluginHandler, true);</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+  },</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+  removeEventListeners: function ph_removeEventListeners(browser) {</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+    browser.removeEventListener(&quot;PluginNotFound&quot;, gPluginHandler);</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+    browser.removeEventListener(&quot;PluginCrashed&quot;, gPluginHandler);</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+    browser.removeEventListener(&quot;PluginBlocklisted&quot;, gPluginHandler);</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+    browser.removeEventListener(&quot;PluginOutdated&quot;, gPluginHandler);</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+    browser.removeEventListener(&quot;PluginDisabled&quot;, gPluginHandler);</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+    browser.removeEventListener(&quot;NewPluginInstalled&quot;, gPluginHandler);</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+  },</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+  get CrashSubmit() {</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+    delete this.CrashSubmit;</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+    Components.utils.import(&quot;resource://gre/modules/CrashSubmit.jsm&quot;, this);</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+    return this.CrashSubmit;</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+  },</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+  // Map the plugin's name to a filtered version more suitable for user UI.</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+  makeNicePluginName : function ph_makeNicePluginName(aName, aFilename) {</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+    if (aName == &quot;Shockwave Flash&quot;)</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+      return &quot;Adobe Flash&quot;;</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+    // Clean up the plugin name by stripping off any trailing version numbers</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+    // or &quot;plugin&quot;. EG, &quot;Foo Bar Plugin 1.23_02&quot; --&gt; &quot;Foo Bar&quot;</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+    return aName.replace(/\bplug-?in\b/i, &quot;&quot;).replace(/[\s\d\.\-\_\(\)]+$/, &quot;&quot;);</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+  },</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+  isTooSmall : function ph_isTooSmall(plugin, overlay) {</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+    // Is the &lt;object&gt;'s size too small to hold what we want to show?</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+    let pluginRect = plugin.getBoundingClientRect();</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+    // XXX bug 446693. The text-shadow on the submitted-report text at</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+    //     the bottom causes scrollHeight to be larger than it should be.</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+    let overflows = (overlay.scrollWidth &gt; pluginRect.width) ||</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+                    (overlay.scrollHeight - 5 &gt; pluginRect.height);</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+    return overflows;</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+  },</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+  addLinkClickCallback: function ph_addLinkClickCallback(linkNode, callbackName /*callbackArgs...*/) {</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+    // XXX just doing (callback)(arg) was giving a same-origin error. bug?</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+    let self = this;</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+    let callbackArgs = Array.prototype.slice.call(arguments).slice(2);</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+    linkNode.addEventListener(&quot;click&quot;,</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+                              function(evt) {</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+                                if (!evt.isTrusted)</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+                                  return;</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+                                evt.preventDefault();</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+                                if (callbackArgs.length == 0)</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+                                  callbackArgs = [ evt ];</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+                                (self[callbackName]).apply(self, callbackArgs);</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+                              },</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+                              true);</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+    linkNode.addEventListener(&quot;keydown&quot;,</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+                              function(evt) {</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+                                if (!evt.isTrusted)</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+                                  return;</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+                                if (evt.keyCode == evt.DOM_VK_RETURN) {</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+                                  evt.preventDefault();</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+                                  if (callbackArgs.length == 0)</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+                                    callbackArgs = [ evt ];</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+                                  evt.preventDefault();</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+                                  (self[callbackName]).apply(self, callbackArgs);</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+                                }</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+                              },</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+                              true);</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+  },</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+  handleEvent : function ph_handleEvent(event) {</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+    let self = gPluginHandler;</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+    let plugin = event.target;</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+    let doc = plugin.ownerDocument;</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+    // We're expecting the target to be a plugin.</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+    if (!(plugin instanceof Components.interfaces.nsIObjectLoadingContent))</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+      return;</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+    // Force a style flush, so that we ensure our binding is attached.</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+    plugin.clientTop;</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+    switch (event.type) {</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+      case &quot;PluginCrashed&quot;:</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+        self.pluginInstanceCrashed(plugin, event);</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+        break;</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+      case &quot;PluginNotFound&quot;:</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+        // For non-object plugin tags, register a click handler to install the</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+        // plugin. Object tags can, and often do, deal with that themselves,</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+        // so don't stomp on the page developers toes.</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+        if (!(plugin instanceof HTMLObjectElement)) {</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+          // We don't yet check to see if there's actually an installer available.</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+          let installStatus = doc.getAnonymousElementByAttribute(plugin, &quot;class&quot;, &quot;installStatus&quot;);</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+          installStatus.setAttribute(&quot;status&quot;, &quot;ready&quot;);</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+          let iconStatus = doc.getAnonymousElementByAttribute(plugin, &quot;class&quot;, &quot;icon&quot;);</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+          iconStatus.setAttribute(&quot;status&quot;, &quot;ready&quot;);</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+          let installLink = doc.getAnonymousElementByAttribute(plugin, &quot;class&quot;, &quot;installPluginLink&quot;);</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+          self.addLinkClickCallback(installLink, &quot;installSinglePlugin&quot;, plugin);</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+        }</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+        /* FALLTHRU */</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+      case &quot;PluginBlocklisted&quot;:</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+      case &quot;PluginOutdated&quot;:</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+#ifdef XP_MACOSX</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+      case &quot;npapi-carbon-event-model-failure&quot;:</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+#endif</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+        self.pluginUnavailable(plugin, event.type);</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+        break;</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+      case &quot;PluginDisabled&quot;:</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+        let manageLink = doc.getAnonymousElementByAttribute(plugin, &quot;class&quot;, &quot;managePluginsLink&quot;);</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+        self.addLinkClickCallback(manageLink, &quot;managePlugins&quot;);</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+        break;</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+    }</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+    // Hide the in-content UI if it's too big. The crashed plugin handler already did this.</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+    if (event.type != &quot;PluginCrashed&quot;) {</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+      let overlay = doc.getAnonymousElementByAttribute(plugin, &quot;class&quot;, &quot;mainBox&quot;);</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+      if (self.isTooSmall(plugin, overlay))</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+          overlay.style.visibility = &quot;hidden&quot;;</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+    }</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+  },</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+  newPluginInstalled : function ph_newPluginInstalled(event) {</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+    // browser elements are anonymous so we can't just use target.</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+    var browser = event.originalTarget;</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+    // clear the plugin list, now that at least one plugin has been installed</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+    browser.missingPlugins = null;</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+    var notificationBox = getNotificationBox(browser.contentWindow);</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+    var notification = notificationBox.getNotificationWithValue(&quot;missing-plugins&quot;);</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+    if (notification)</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+      notificationBox.removeNotification(notification);</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+    // reload the browser to make the new plugin show.</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+    browser.reload();</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+  },</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+  // Callback for user clicking on a missing (unsupported) plugin.</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+  installSinglePlugin: function ph_installSinglePlugin(plugin) {</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+    var missingPluginsArray = {};</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+    var pluginInfo = getPluginInfo(plugin);</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+    missingPluginsArray[pluginInfo.mimetype] = pluginInfo;</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+    openDialog(&quot;chrome://mozapps/content/plugins/pluginInstallerWizard.xul&quot;,</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+               &quot;PFSWindow&quot;, &quot;chrome,centerscreen,resizable=yes&quot;,</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+               {plugins: missingPluginsArray, browser: getBrowser});</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+  },</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+  // Callback for user clicking on a disabled plugin</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+  managePlugins: function ph_managePlugins(aEvent) {</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+    openAddonsMgr(&quot;addons://list/plugin&quot;);</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+  },</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+  // Callback for user clicking &quot;submit a report&quot; link</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+  submitReport : function ph_submitReport(pluginDumpID, browserDumpID) {</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+    // The crash reporter wants a DOM element it can append an IFRAME to,</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+    // which it uses to submit a form. Let's just give it curBrowser.</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+    var curBrowser = document.getElementById('tabmail').getBrowserForSelectedTab();</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+    this.CrashSubmit.submit(pluginDumpID, curBrowser, null, null);</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+    if (browserDumpID)</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+      this.CrashSubmit.submit(browserDumpID, curBrowser, null, null);</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+  },</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+  // Callback for user clicking a &quot;reload page&quot; link</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+  reloadPage: function ph_reloadPage(browser) {</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+    browser.reload();</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+  },</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+  // Callback for user clicking the help icon</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+  openPluginCrashHelpPage: function ph_openHelpPage() {</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+    // Grab the plugin crash support URL</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+    let url = Services.urlFormatter.formatURLPref(&quot;plugins.crash.supportUrl&quot;);</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+    // Now open up a content tab to display it in</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+    let tabmail = document.getElementById('tabmail');</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+    tabmail.openTab(&quot;contentTab&quot;, {contentPage: url,</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+                                   background: false});</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+  },</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineplus">+  // event listener for missing/blocklisted/outdated/carbonFailure plugins.</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+  pluginUnavailable: function ph_pluginUnavailable(plugin, eventType) {</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+    let Cc = Components.classes;</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineplus">+    let Ci = Components.interfaces;</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+    var tabmail = document.getElementById('tabmail');</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+    let browser = tabmail.getBrowserForDocument(plugin.ownerDocument</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+                                                .defaultView).browser;</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+    if (!browser.missingPlugins)</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+      browser.missingPlugins = {};</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+    var pluginInfo = getPluginInfo(plugin);</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+    browser.missingPlugins[pluginInfo.mimetype] = pluginInfo;</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+    var notificationBox = getNotificationBox(browser.contentWindow);</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+    // Should only display one of these warnings per page.</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineplus">+    // In order of priority, they are: outdated &gt; missing &gt; blocklisted</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineplus">+    let outdatedNotification = notificationBox.getNotificationWithValue(&quot;outdated-plugins&quot;);</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineplus">+    let blockedNotification  = notificationBox.getNotificationWithValue(&quot;blocked-plugins&quot;);</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineplus">+    let missingNotification  = notificationBox.getNotificationWithValue(&quot;missing-plugins&quot;);</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineplus">+</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineplus">+    function showBlocklistInfo() {</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineplus">+      var url = formatURL(&quot;extensions.blocklist.detailsURL&quot;, true);</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+      tabmail.openTab(&quot;contentTab&quot;, {contentPage: url,</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+                                     background: false});</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+      return true;</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+    }</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineplus">+    function showOutdatedPluginsInfo() {</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+      Services.prefs.setBoolPref(&quot;plugins.update.notifyUser&quot;, false);</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+      var url = formatURL(&quot;plugins.update.url&quot;, true);</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineplus">+      tabmail.openTab(&quot;contentTab&quot;, {contentPage: url,</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineplus">+                                     background: false});</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineplus">+      return true;</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineplus">+    }</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+    function showPluginsMissing() {</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineplus">+      // get the urls of missing plugins</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineplus">+      var curBrowser = tabmail.getBrowserForSelectedTab();</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineplus">+      var missingPluginsArray = curBrowser.missingPlugins;</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineplus">+      if (missingPluginsArray) {</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineplus">+        openDialog(&quot;chrome://mozapps/content/plugins/pluginInstallerWizard.xul&quot;,</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineplus">+                   &quot;PFSWindow&quot;, &quot;chrome,centerscreen,resizable=yes&quot;,</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineplus">+                   {plugins: missingPluginsArray, browser: curBrowser});</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+      }</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+    }</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineplus">+</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+#ifdef XP_MACOSX</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+    function carbonFailurePluginsRestartBrowser()</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineplus">+    {</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineplus">+      // Notify all windows that an application quit has been requested.</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineplus">+      let cancelQuit = Cc[&quot;@mozilla.org/supports-PRBool;1&quot;].</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineplus">+                         createInstance(Ci.nsISupportsPRBool);</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineplus">+      Services.obs.notifyObservers(cancelQuit, &quot;quit-application-requested&quot;, null);</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+      // Something aborted the quit process.</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineplus">+      if (cancelQuit.data)</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineplus">+        return;</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+      let as = Cc[&quot;@mozilla.org/toolkit/app-startup;1&quot;].getService(Ci.nsIAppStartup);</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+      as.quit(Ci.nsIAppStartup.eRestarti386 | Ci.nsIAppStartup.eRestart | Ci.nsIAppStartup.eAttemptQuit);</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineplus">+    }</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineplus">+#endif</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineplus">+    let messengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineplus">+    let notifications = {</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+      PluginBlocklisted : {</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+        barID: &quot;blocked-plugins&quot;,</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+        iconURL: &quot;chrome://mozapps/skin/plugins/notifyPluginBlocked.png&quot;,</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+        message: messengerBundle.getString(&quot;blockedpluginsMessage.title&quot;),</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineplus">+        buttons: [{</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineplus">+          label: messengerBundle.getString(&quot;blockedpluginsMessage.infoButton.label&quot;),</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+          accessKey: messengerBundle.getString(&quot;blockedpluginsMessage.infoButton.accesskey&quot;),</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineplus">+          popup: null,</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineplus">+          callback: showBlocklistInfo</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineplus">+        },</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineplus">+        {</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineplus">+          label: messengerBundle.getString(&quot;blockedpluginsMessage.searchButton.label&quot;),</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineplus">+          accessKey: messengerBundle.getString(&quot;blockedpluginsMessage.searchButton.accesskey&quot;),</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineplus">+          popup: null,</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineplus">+          callback: showOutdatedPluginsInfo</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineplus">+        }],</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineplus">+      },</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineplus">+      PluginOutdated: {</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineplus">+        barID: &quot;outdated-plugins&quot;,</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineplus">+        iconURL: &quot;chrome://mozapps/skin/plugins/notifyPluginOutdated.png&quot;,</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineplus">+        message: messengerBundle.getString(&quot;outdatedpluginsMessage.title&quot;),</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineplus">+        buttons: [{</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineplus">+          label: messengerBundle.getString(&quot;outdatedpluginsMessage.updateButton.label&quot;),</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineplus">+          accessKey: messengerBundle.getString(&quot;outdatedpluginsMessage.updateButton.accesskey&quot;),</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineplus">+          popup: null,</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineplus">+          callback: showOutdatedPluginsInfo</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineplus">+        }],</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineplus">+      },</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineplus">+      PluginNotFound: {</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineplus">+        barID: &quot;missing-plugins&quot;,</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+        iconURL: &quot;chrome://mozapps/skin/plugins/notifyPluginGeneric.png&quot;,</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineplus">+        message: messengerBundle.getString(&quot;missingpluginsMessage.title&quot;),</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineplus">+        buttons: [{</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineplus">+          label: messengerBundle.getString(&quot;missingpluginsMessage.button.label&quot;),</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineplus">+          accessKey: messengerBundle.getString(&quot;missingpluginsMessage.button.accesskey&quot;),</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineplus">+          popup: null,</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineplus">+          callback: showPluginsMissing</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineplus">+        }],</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+      },</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineplus">+#ifdef XP_MACOSX</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineplus">+      &quot;npapi-carbon-event-model-failure&quot;: {</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineplus">+        barID: &quot;carbon-failure-plugins&quot;,</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineplus">+        iconURL: &quot;chrome://mozapps/skin/plugins/notifyPluginGeneric.png&quot;,</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+        message: messengerBundle.getString(&quot;carbonFailurePluginsMessage.message&quot;),</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+        buttons: [{</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+          label: messengerBundle.getString(&quot;carbonFailurePluginsMessage.restartButton.label&quot;),</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+          accessKey: messengerBundle.getString(&quot;carbonFailurePluginsMessage.restartButton.accesskey&quot;),</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineplus">+          popup: null,</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+          callback: carbonFailurePluginsRestartBrowser</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+        }],</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineplus">+      }</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineplus">+#endif</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineplus">+    };</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineplus">+</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineplus">+</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineplus">+    // If there is already an outdated plugin notification then do nothing</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineplus">+    if (outdatedNotification)</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineplus">+      return;</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineplus">+</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineplus">+#ifdef XP_MACOSX</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineplus">+    if (eventType == &quot;npapi-carbon-event-model-failure&quot;) {</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineplus">+      if (Services.prefs.getBoolPref(&quot;plugins.hide_infobar_for_carbon_failure_plugin&quot;))</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineplus">+        return;</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineplus">+</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineplus">+      let carbonFailureNotification =</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineplus">+        notificationBox.getNotificationWithValue(&quot;carbon-failure-plugins&quot;);</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+      if (carbonFailureNotification)</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineplus">+         carbonFailureNotification.close();</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineplus">+</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineplus">+      let macutils = Cc[&quot;@mozilla.org/xpcom/mac-utils;1&quot;].getService(Ci.nsIMacUtils);</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineplus">+      // if this is not a Universal build, just follow PluginNotFound path</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineplus">+      if (!macutils.isUniversalBinary)</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineplus">+        eventType = &quot;PluginNotFound&quot;;</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineplus">+    }</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineplus">+#endif</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineplus">+</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineplus">+    if (eventType == &quot;PluginBlocklisted&quot;) {</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineplus">+      if (Services.prefs.getBoolPref(&quot;plugins.hide_infobar_for_missing_plugin&quot;))</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineplus">+        return;</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineplus">+</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineplus">+      if (blockedNotification || missingNotification)</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineplus">+        return;</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineplus">+    }</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+    else if (eventType == &quot;PluginOutdated&quot;) {</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineplus">+      if (Services.prefs.getBoolPref(&quot;plugins.hide_infobar_for_outdated_plugin&quot;))</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineplus">+        return;</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineplus">+</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineplus">+      // Cancel any notification about blocklisting/missing plugins</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineplus">+      if (blockedNotification)</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineplus">+        blockedNotification.close();</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineplus">+      if (missingNotification)</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineplus">+        missingNotification.close();</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineplus">+    }</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineplus">+    else if (eventType == &quot;PluginNotFound&quot;) {</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineplus">+      if (Services.prefs.getBoolPref(&quot;plugins.hide_infobar_for_missing_plugin&quot;))</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineplus">+        return;</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineplus">+</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineplus">+</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineplus">+      if (missingNotification)</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineplus">+        return;</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineplus">+</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineplus">+      // Cancel any notification about blocklisting plugins</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineplus">+      if (blockedNotification)</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineplus">+        blockedNotification.close();</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineplus">+    }</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineplus">+</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineplus">+    let notify = notifications[eventType];</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineplus">+    notificationBox.appendNotification(notify.message, notify.barID, notify.iconURL,</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineplus">+                                       notificationBox.PRIORITY_WARNING_MEDIUM,</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineplus">+                                       notify.buttons);</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineplus">+  },</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineplus">+</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineplus">+  // Crashed-plugin observer. Notified once per plugin crash, before events</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineplus">+  // are dispatched to individual plugin instances.</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineplus">+  pluginCrashed : function(subject, topic, data) {</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineplus">+    let propertyBag = subject;</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineplus">+    if (!(propertyBag instanceof Components.interfaces.nsIPropertyBag2) ||</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineplus">+        !(propertyBag instanceof Components.interfaces.nsIWritablePropertyBag2))</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineplus">+     return;</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineplus">+</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineplus">+#ifdef MOZ_CRASHREPORTER</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineplus">+    let pluginDumpID = propertyBag.getPropertyAsAString(&quot;pluginDumpID&quot;);</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineplus">+    let browserDumpID = propertyBag.getPropertyAsAString(&quot;browserDumpID&quot;);</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineplus">+    let shouldSubmit = gCrashReporter.submitReports;</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineplus">+    let doPrompt = true; // XXX followup to get via gCrashReporter</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineplus">+</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineplus">+    // Submit automatically when appropriate.</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineplus">+    if (pluginDumpID &amp;&amp; shouldSubmit &amp;&amp; !doPrompt) {</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineplus">+      this.submitReport(pluginDumpID, browserDumpID);</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineplus">+      // Submission is async, so we can't easily show failure UI.</span>
<a href="#l4.488"></a><span id="l4.488" class="difflineplus">+      propertyBag.setPropertyAsBool(&quot;submittedCrashReport&quot;, true);</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineplus">+    }</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineplus">+#endif</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineplus">+  },</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineplus">+</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineplus">+  // Crashed-plugin event listener. Called for every instance of a</span>
<a href="#l4.494"></a><span id="l4.494" class="difflineplus">+  // plugin in content.</span>
<a href="#l4.495"></a><span id="l4.495" class="difflineplus">+  pluginInstanceCrashed: function (plugin, aEvent) {</span>
<a href="#l4.496"></a><span id="l4.496" class="difflineplus">+    // Ensure the plugin and event are of the right type.</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineplus">+    if (!(aEvent instanceof Components.interfaces.nsIDOMDataContainerEvent))</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineplus">+      return;</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineplus">+</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineplus">+    let submittedReport = aEvent.getData(&quot;submittedCrashReport&quot;);</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineplus">+    let doPrompt = true; // XXX followup for .getData(&quot;doPrompt&quot;);</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineplus">+    let submitReports = true; // XXX followup for .getData(&quot;submitReports&quot;);</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineplus">+    let pluginName = aEvent.getData(&quot;pluginName&quot;);</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineplus">+    let pluginFilename = aEvent.getData(&quot;pluginFilename&quot;);</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineplus">+    let pluginDumpID = aEvent.getData(&quot;pluginDumpID&quot;);</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineplus">+    let browserDumpID = aEvent.getData(&quot;browserDumpID&quot;);</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineplus">+    let messengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineplus">+    let tabmail = document.getElementById('tabmail');</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineplus">+</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineplus">+    // Remap the plugin name to a more user-presentable form.</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineplus">+    pluginName = this.makeNicePluginName(pluginName, pluginFilename);</span>
<a href="#l4.512"></a><span id="l4.512" class="difflineplus">+</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineplus">+    let messageString = messengerBundle.getFormattedString(&quot;crashedpluginsMessage.title&quot;, [pluginName]);</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineplus">+</span>
<a href="#l4.515"></a><span id="l4.515" class="difflineplus">+    //</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineplus">+    // Configure the crashed-plugin placeholder.</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineplus">+    //</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineplus">+    let doc = plugin.ownerDocument;</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineplus">+    let overlay = doc.getAnonymousElementByAttribute(plugin, &quot;class&quot;, &quot;mainBox&quot;);</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineplus">+    let statusDiv = doc.getAnonymousElementByAttribute(plugin, &quot;class&quot;, &quot;submitStatus&quot;);</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineplus">+#ifdef MOZ_CRASHREPORTER</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineplus">+    let status;</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineplus">+</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineplus">+    // Determine which message to show regarding crash reports.</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineplus">+    if (submittedReport) { // submitReports &amp;&amp; !doPrompt, handled in observer</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineplus">+      status = &quot;submitted&quot;;</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineplus">+    }</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineplus">+    else if (!submitReports &amp;&amp; !doPrompt) {</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineplus">+      status = &quot;noSubmit&quot;;</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineplus">+    }</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineplus">+    else { // doPrompt</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineplus">+      status = &quot;please&quot;;</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineplus">+      // XXX can we make the link target actually be blank?</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineplus">+      let pleaseLink = doc.getAnonymousElementByAttribute(</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineplus">+                            plugin, &quot;class&quot;, &quot;pleaseSubmitLink&quot;);</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineplus">+      this.addLinkClickCallback(pleaseLink, &quot;submitReport&quot;,</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineplus">+                                pluginDumpID, browserDumpID);</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineplus">+    }</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineplus">+</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineplus">+    // If we don't have a minidumpID, we can't (or didn't) submit anything.</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineplus">+    // This can happen if the plugin is killed from the task manager.</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineplus">+    if (!pluginDumpID) {</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineplus">+      status = &quot;noReport&quot;;</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineplus">+    }</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineplus">+</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineplus">+    statusDiv.setAttribute(&quot;status&quot;, status);</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineplus">+</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineplus">+    let bottomLinks = doc.getAnonymousElementByAttribute(plugin, &quot;class&quot;, &quot;msg msgBottomLinks&quot;);</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineplus">+    bottomLinks.style.display = &quot;block&quot;;</span>
<a href="#l4.550"></a><span id="l4.550" class="difflineplus">+    let helpIcon = doc.getAnonymousElementByAttribute(plugin, &quot;class&quot;, &quot;helpIcon&quot;);</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineplus">+    this.addLinkClickCallback(helpIcon, &quot;openPluginCrashHelpPage&quot;);</span>
<a href="#l4.552"></a><span id="l4.552" class="difflineplus">+</span>
<a href="#l4.553"></a><span id="l4.553" class="difflineplus">+    // If we're showing the link to manually trigger report submission, we'll</span>
<a href="#l4.554"></a><span id="l4.554" class="difflineplus">+    // want to be able to update all the instances of the UI for this crash to</span>
<a href="#l4.555"></a><span id="l4.555" class="difflineplus">+    // show an updated message when a report is submitted.</span>
<a href="#l4.556"></a><span id="l4.556" class="difflineplus">+    if (doPrompt) {</span>
<a href="#l4.557"></a><span id="l4.557" class="difflineplus">+      let observer = {</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineplus">+        QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIObserver,</span>
<a href="#l4.559"></a><span id="l4.559" class="difflineplus">+                                               Components.interfaces.nsISupportsWeakReference]),</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineplus">+        observe : function(subject, topic, data) {</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineplus">+          let propertyBag = subject;</span>
<a href="#l4.562"></a><span id="l4.562" class="difflineplus">+          if (!(propertyBag instanceof Components.interfaces.nsIPropertyBag2))</span>
<a href="#l4.563"></a><span id="l4.563" class="difflineplus">+            return;</span>
<a href="#l4.564"></a><span id="l4.564" class="difflineplus">+          // Ignore notifications for other crashes.</span>
<a href="#l4.565"></a><span id="l4.565" class="difflineplus">+          if (propertyBag.get(&quot;minidumpID&quot;) != pluginDumpID)</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineplus">+            return;</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineplus">+          statusDiv.setAttribute(&quot;status&quot;, data);</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineplus">+        },</span>
<a href="#l4.569"></a><span id="l4.569" class="difflineplus">+</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineplus">+        handleEvent : function(event) {</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineplus">+            // Not expected to be called, just here for the closure.</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineplus">+        }</span>
<a href="#l4.573"></a><span id="l4.573" class="difflineplus">+      };</span>
<a href="#l4.574"></a><span id="l4.574" class="difflineplus">+</span>
<a href="#l4.575"></a><span id="l4.575" class="difflineplus">+      // Use a weak reference, so we don't have to remove it...</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineplus">+      Services.obs.addObserver(observer, &quot;crash-report-status&quot;, true);</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineplus">+      // ...alas, now we need something to hold a strong reference to prevent</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineplus">+      // it from being GC. But I don't want to manually manage the reference's</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineplus">+      // lifetime (which should be no greater than the page).</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineplus">+      // Clever solution? Use a closue with an event listener on the document.</span>
<a href="#l4.581"></a><span id="l4.581" class="difflineplus">+      // When the doc goes away, so do the listener references and the closure.</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineplus">+      doc.addEventListener(&quot;mozCleverClosureHack&quot;, observer, false);</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineplus">+    }</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineplus">+#endif</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineplus">+</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineplus">+    let crashText = doc.getAnonymousElementByAttribute(plugin, &quot;class&quot;, &quot;msg msgCrashed&quot;);</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineplus">+    crashText.textContent = messageString;</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineplus">+    let browser = tabmail.getBrowserForSelectedTab();</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineplus">+</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineplus">+    let link = doc.getAnonymousElementByAttribute(plugin, &quot;class&quot;, &quot;reloadLink&quot;);</span>
<a href="#l4.591"></a><span id="l4.591" class="difflineplus">+    this.addLinkClickCallback(link, &quot;reloadPage&quot;, browser);</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineplus">+</span>
<a href="#l4.593"></a><span id="l4.593" class="difflineplus">+    let notificationBox = getNotificationBox(browser.contentWindow);</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineplus">+</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineplus">+    // Is the &lt;object&gt;'s size too small to hold what we want to show?</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineplus">+    if (this.isTooSmall(plugin, overlay)) {</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineplus">+        // Hide the overlay's contents. Use visibility style, so that it</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineplus">+        // doesn't collapse down to 0x0.</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineplus">+        overlay.style.visibility = &quot;hidden&quot;;</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineplus">+        // If another plugin on the page was large enough to show our UI, we</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineplus">+        // don't want to show a notification bar.</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineplus">+        if (!doc.mozNoPluginCrashedNotification)</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineplus">+          showNotificationBar(pluginDumpID, browserDumpID);</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineplus">+    } else {</span>
<a href="#l4.605"></a><span id="l4.605" class="difflineplus">+        // If a previous plugin on the page was too small and resulted in</span>
<a href="#l4.606"></a><span id="l4.606" class="difflineplus">+        // adding a notification bar, then remove it because this plugin</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineplus">+        // instance it big enough to serve as in-content notification.</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineplus">+        hideNotificationBar();</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineplus">+        doc.mozNoPluginCrashedNotification = true;</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineplus">+    }</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineplus">+</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineplus">+    function hideNotificationBar() {</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineplus">+      let notification = notificationBox.getNotificationWithValue(&quot;plugin-crashed&quot;);</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineplus">+      if (notification)</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineplus">+        notificationBox.removeNotification(notification, true);</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineplus">+    }</span>
<a href="#l4.617"></a><span id="l4.617" class="difflineplus">+</span>
<a href="#l4.618"></a><span id="l4.618" class="difflineplus">+    function showNotificationBar(pluginDumpID, browserDumpID) {</span>
<a href="#l4.619"></a><span id="l4.619" class="difflineplus">+      // If there's already an existing notification bar, don't do anything.</span>
<a href="#l4.620"></a><span id="l4.620" class="difflineplus">+      let messengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l4.621"></a><span id="l4.621" class="difflineplus">+      let notification = notificationBox.getNotificationWithValue(&quot;plugin-crashed&quot;);</span>
<a href="#l4.622"></a><span id="l4.622" class="difflineplus">+      if (notification)</span>
<a href="#l4.623"></a><span id="l4.623" class="difflineplus">+        return;</span>
<a href="#l4.624"></a><span id="l4.624" class="difflineplus">+</span>
<a href="#l4.625"></a><span id="l4.625" class="difflineplus">+      // Configure the notification bar</span>
<a href="#l4.626"></a><span id="l4.626" class="difflineplus">+      let priority = notificationBox.PRIORITY_WARNING_MEDIUM;</span>
<a href="#l4.627"></a><span id="l4.627" class="difflineplus">+      let iconURL = &quot;chrome://mozapps/skin/plugins/notifyPluginCrashed.png&quot;;</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineplus">+      let reloadLabel = messengerBundle.getString(&quot;crashedpluginsMessage.reloadButton.label&quot;);</span>
<a href="#l4.629"></a><span id="l4.629" class="difflineplus">+      let reloadKey   = messengerBundle.getString(&quot;crashedpluginsMessage.reloadButton.accesskey&quot;);</span>
<a href="#l4.630"></a><span id="l4.630" class="difflineplus">+      let submitLabel = messengerBundle.getString(&quot;crashedpluginsMessage.submitButton.label&quot;);</span>
<a href="#l4.631"></a><span id="l4.631" class="difflineplus">+      let submitKey   = messengerBundle.getString(&quot;crashedpluginsMessage.submitButton.accesskey&quot;);</span>
<a href="#l4.632"></a><span id="l4.632" class="difflineplus">+</span>
<a href="#l4.633"></a><span id="l4.633" class="difflineplus">+      let buttons = [{</span>
<a href="#l4.634"></a><span id="l4.634" class="difflineplus">+        label: reloadLabel,</span>
<a href="#l4.635"></a><span id="l4.635" class="difflineplus">+        accessKey: reloadKey,</span>
<a href="#l4.636"></a><span id="l4.636" class="difflineplus">+        popup: null,</span>
<a href="#l4.637"></a><span id="l4.637" class="difflineplus">+        callback: function() { browser.reload(); },</span>
<a href="#l4.638"></a><span id="l4.638" class="difflineplus">+      }];</span>
<a href="#l4.639"></a><span id="l4.639" class="difflineplus">+#ifdef MOZ_CRASHREPORTER</span>
<a href="#l4.640"></a><span id="l4.640" class="difflineplus">+      let submitButton = {</span>
<a href="#l4.641"></a><span id="l4.641" class="difflineplus">+        label: submitLabel,</span>
<a href="#l4.642"></a><span id="l4.642" class="difflineplus">+        accessKey: submitKey,</span>
<a href="#l4.643"></a><span id="l4.643" class="difflineplus">+        popup: null,</span>
<a href="#l4.644"></a><span id="l4.644" class="difflineplus">+          callback: function() { gPluginHandler.submitReport(pluginDumpID, browserDumpID); },</span>
<a href="#l4.645"></a><span id="l4.645" class="difflineplus">+      };</span>
<a href="#l4.646"></a><span id="l4.646" class="difflineplus">+      if (pluginDumpID)</span>
<a href="#l4.647"></a><span id="l4.647" class="difflineplus">+        buttons.push(submitButton);</span>
<a href="#l4.648"></a><span id="l4.648" class="difflineplus">+#endif</span>
<a href="#l4.649"></a><span id="l4.649" class="difflineplus">+</span>
<a href="#l4.650"></a><span id="l4.650" class="difflineplus">+      let notification = notificationBox.appendNotification(messageString, &quot;plugin-crashed&quot;,</span>
<a href="#l4.651"></a><span id="l4.651" class="difflineplus">+                                                            iconURL, priority, buttons);</span>
<a href="#l4.652"></a><span id="l4.652" class="difflineplus">+</span>
<a href="#l4.653"></a><span id="l4.653" class="difflineplus">+      // Add the &quot;learn more&quot; link.</span>
<a href="#l4.654"></a><span id="l4.654" class="difflineplus">+      let XULNS = &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;;</span>
<a href="#l4.655"></a><span id="l4.655" class="difflineplus">+      let link = notification.ownerDocument.createElementNS(XULNS, &quot;label&quot;);</span>
<a href="#l4.656"></a><span id="l4.656" class="difflineplus">+      let crashHelpUrl = Services.urlFormatter</span>
<a href="#l4.657"></a><span id="l4.657" class="difflineplus">+                                 .formatURLPref(&quot;plugins.crash.supportUrl&quot;);</span>
<a href="#l4.658"></a><span id="l4.658" class="difflineplus">+      link.className = &quot;text-link&quot;;</span>
<a href="#l4.659"></a><span id="l4.659" class="difflineplus">+      link.setAttribute(&quot;value&quot;, messengerBundle.getString(&quot;crashedpluginsMessage.learnMore&quot;));</span>
<a href="#l4.660"></a><span id="l4.660" class="difflineplus">+      link.href = crashHelpUrl;</span>
<a href="#l4.661"></a><span id="l4.661" class="difflineplus">+      let description = notification.ownerDocument.getAnonymousElementByAttribute(notification, &quot;anonid&quot;, &quot;messageText&quot;);</span>
<a href="#l4.662"></a><span id="l4.662" class="difflineplus">+      description.appendChild(link);</span>
<a href="#l4.663"></a><span id="l4.663" class="difflineplus">+</span>
<a href="#l4.664"></a><span id="l4.664" class="difflineplus">+      // Remove the notfication when the page is reloaded.</span>
<a href="#l4.665"></a><span id="l4.665" class="difflineplus">+      doc.defaultView.top.addEventListener(&quot;unload&quot;, function() {</span>
<a href="#l4.666"></a><span id="l4.666" class="difflineplus">+        notificationBox.removeNotification(notification);</span>
<a href="#l4.667"></a><span id="l4.667" class="difflineplus">+      }, false);</span>
<a href="#l4.668"></a><span id="l4.668" class="difflineplus">+    }</span>
<a href="#l4.669"></a><span id="l4.669" class="difflineplus">+</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineplus">+  }</span>
<a href="#l4.671"></a><span id="l4.671" class="difflineplus">+};</span>
<a href="#l4.672"></a><span id="l4.672" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/specialTabs.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/specialTabs.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -403,16 +403,17 @@ var specialTabs = {</span>
<a href="#l5.4"></a><span id="l5.4">                           &quot;specialTabs.defaultClickHandler(event);&quot;;</span>
<a href="#l5.5"></a><span id="l5.5">       aTab.browser.setAttribute(&quot;onclick&quot;, aTab.clickHandler);</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">       // Set this attribute so that when favicons fail to load, we remove the</span>
<a href="#l5.8"></a><span id="l5.8">       // image attribute and just show the default tab icon.</span>
<a href="#l5.9"></a><span id="l5.9">       aTab.tabNode.setAttribute(&quot;onerror&quot;, &quot;this.removeAttribute('image');&quot;);</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">       aTab.browser.addEventListener(&quot;DOMLinkAdded&quot;, DOMLinkHandler, false);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+      gPluginHandler.addEventListeners(aTab.browser);</span>
<a href="#l5.13"></a><span id="l5.13"> </span>
<a href="#l5.14"></a><span id="l5.14">       // Now initialise the find bar.</span>
<a href="#l5.15"></a><span id="l5.15">       aTab.findbar = aTab.panel.getElementsByTagName(&quot;findbar&quot;)[0];</span>
<a href="#l5.16"></a><span id="l5.16">       aTab.findbar.setAttribute(&quot;browserid&quot;,</span>
<a href="#l5.17"></a><span id="l5.17">                                 &quot;contentTabBrowser&quot; + this.lastBrowserId);</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19">       // Default to reload being disabled.</span>
<a href="#l5.20"></a><span id="l5.20">       aTab.reloadEnabled = false;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -457,16 +458,17 @@ var specialTabs = {</span>
<a href="#l5.22"></a><span id="l5.22">         &amp;&amp; !docShell.contentViewer.permitUnload());</span>
<a href="#l5.23"></a><span id="l5.23">     },</span>
<a href="#l5.24"></a><span id="l5.24">     closeTab: function onTabClosed(aTab) {</span>
<a href="#l5.25"></a><span id="l5.25">       aTab.browser.removeEventListener(&quot;DOMTitleChanged&quot;,</span>
<a href="#l5.26"></a><span id="l5.26">                                        aTab.titleListener, true);</span>
<a href="#l5.27"></a><span id="l5.27">       aTab.browser.removeEventListener(&quot;DOMWindowClose&quot;,</span>
<a href="#l5.28"></a><span id="l5.28">                                        aTab.closeListener, true);</span>
<a href="#l5.29"></a><span id="l5.29">       aTab.browser.removeEventListener(&quot;DOMLinkAdded&quot;, DOMLinkHandler, false);</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+      gPluginHandler.removeEventListeners(aTab.browser);</span>
<a href="#l5.31"></a><span id="l5.31">       aTab.browser.webProgress.removeProgressListener(aTab.filter);</span>
<a href="#l5.32"></a><span id="l5.32">       aTab.filter.removeProgressListener(aTab.progressListener);</span>
<a href="#l5.33"></a><span id="l5.33">       aTab.browser.destroy();</span>
<a href="#l5.34"></a><span id="l5.34">     },</span>
<a href="#l5.35"></a><span id="l5.35">     saveTabState: function onSaveTabState(aTab) {</span>
<a href="#l5.36"></a><span id="l5.36">       aTab.browser.setAttribute(&quot;type&quot;, &quot;content-targetable&quot;);</span>
<a href="#l5.37"></a><span id="l5.37">     },</span>
<a href="#l5.38"></a><span id="l5.38">     showTab: function onShowTab(aTab) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/jar.mn</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/jar.mn</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -41,16 +41,17 @@ messenger.jar:</span>
<a href="#l6.4"></a><span id="l6.4">     content/messenger/commandglue.js                (content/commandglue.js)</span>
<a href="#l6.5"></a><span id="l6.5">     content/messenger/widgetglue.js                 (content/widgetglue.js)</span>
<a href="#l6.6"></a><span id="l6.6"> *   content/messenger/SearchDialog.xul              (content/SearchDialog.xul)</span>
<a href="#l6.7"></a><span id="l6.7">     content/messenger/SearchDialog.js               (content/SearchDialog.js)</span>
<a href="#l6.8"></a><span id="l6.8"> *   content/messenger/ABSearchDialog.xul            (content/ABSearchDialog.xul)</span>
<a href="#l6.9"></a><span id="l6.9"> *   content/messenger/ABSearchDialog.js             (content/ABSearchDialog.js)</span>
<a href="#l6.10"></a><span id="l6.10"> *   content/messenger/FilterListDialog.xul          (content/FilterListDialog.xul)</span>
<a href="#l6.11"></a><span id="l6.11"> *   content/messenger/FilterListDialog.js           (content/FilterListDialog.js)</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+*   content/messenger/plugins.js                    (content/plugins.js)</span>
<a href="#l6.13"></a><span id="l6.13">     content/messenger/specialTabs.js                (content/specialTabs.js)</span>
<a href="#l6.14"></a><span id="l6.14">     content/messenger/specialTabs.xul               (content/specialTabs.xul)</span>
<a href="#l6.15"></a><span id="l6.15"> *   content/messenger/subscribe.xul                 (content/subscribe.xul)</span>
<a href="#l6.16"></a><span id="l6.16">     content/messenger/subscribe.js                  (content/subscribe.js)</span>
<a href="#l6.17"></a><span id="l6.17"> *   content/messenger/aboutDialog.xul               (content/aboutDialog.xul)</span>
<a href="#l6.18"></a><span id="l6.18"> *   content/messenger/aboutDialog.js                (content/aboutDialog.js)</span>
<a href="#l6.19"></a><span id="l6.19"> *   content/messenger/aboutRights.xhtml             (content/aboutRights.xhtml)</span>
<a href="#l6.20"></a><span id="l6.20">     content/messenger/featureConfigurator.xhtml     (content/featureConfigurator.xhtml)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -694,8 +694,30 @@ update.resumeButton.accesskey=D</span>
<a href="#l7.4"></a><span id="l7.4"> update.openUpdateUI.applyButton.label=Apply Update…</span>
<a href="#l7.5"></a><span id="l7.5"> update.openUpdateUI.applyButton.accesskey=A</span>
<a href="#l7.6"></a><span id="l7.6"> update.restart.applyButton.label=Apply Update</span>
<a href="#l7.7"></a><span id="l7.7"> update.restart.applyButton.accesskey=A</span>
<a href="#l7.8"></a><span id="l7.8"> update.openUpdateUI.upgradeButton.label=Upgrade Now…</span>
<a href="#l7.9"></a><span id="l7.9"> update.openUpdateUI.upgradeButton.accesskey=U</span>
<a href="#l7.10"></a><span id="l7.10"> update.restart.upgradeButton.label=Upgrade Now</span>
<a href="#l7.11"></a><span id="l7.11"> update.restart.upgradeButton.accesskey=U</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+# missing plugin installer</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+missingpluginsMessage.title=Additional plugins are required to display all the media on this page.</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+missingpluginsMessage.button.label=Install Missing Plugins…</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+missingpluginsMessage.button.accesskey=I</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+outdatedpluginsMessage.title=Some plugins used by this page are out of date.</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+outdatedpluginsMessage.updateButton.label=Update Plugins…</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+outdatedpluginsMessage.updateButton.accesskey=U</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+blockedpluginsMessage.title=Some plugins required by this page have been blocked for your protection.</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+blockedpluginsMessage.infoButton.label=Details…</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+blockedpluginsMessage.infoButton.accesskey=D</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+blockedpluginsMessage.searchButton.label=Update Plugins…</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+blockedpluginsMessage.searchButton.accesskey=U</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+crashedpluginsMessage.title=The %S plugin has crashed.</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+crashedpluginsMessage.reloadButton.label=Reload page</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+crashedpluginsMessage.reloadButton.accesskey=R</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+crashedpluginsMessage.submitButton.label=Submit a crash report</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+crashedpluginsMessage.submitButton.accesskey=S</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+crashedpluginsMessage.learnMore=Learn More…</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+carbonFailurePluginsMessage.message=This page asks to use a plugin that can only run in 32-bit mode</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+carbonFailurePluginsMessage.restartButton.label=Restart in 32-bit mode</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+carbonFailurePluginsMessage.restartButton.accesskey=R</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/html/blocklist.xml</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,10 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+&lt;blocklist xmlns=&quot;http://www.mozilla.org/2006/addons-blocklist&quot;&gt;</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+  &lt;pluginItems&gt;</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+    &lt;pluginItem&gt;</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+      &lt;match name=&quot;name&quot; exp=&quot;Test Plug-in&quot;/&gt;</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+      &lt;versionRange severity=&quot;0&quot;/&gt;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+    &lt;/pluginItem&gt;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  &lt;/pluginItems&gt;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+&lt;/blocklist&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/html/blocklist_details.html</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,8 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+&lt;html&gt;</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+  &lt;head&gt;</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+    &lt;title&gt;Plugin Blocklist Details&lt;/title&gt;</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+  &lt;/head&gt;</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+  &lt;body bgcolor=&quot;#FFFFFF&quot;&gt;</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+    &lt;h1&gt;Plugin Blocklist Details Page&lt;/h1&gt;</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+  &lt;/body&gt;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/html/plugin.html</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,9 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+&lt;html&gt;</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+  &lt;head&gt;</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+    &lt;title&gt;Plugin Test&lt;/title&gt;</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+  &lt;/head&gt;</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+  &lt;body bgcolor=&quot;#FFFFFF&quot;&gt;</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+    &lt;h1&gt;Plugin Test&lt;/h1&gt;</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+    &lt;embed id=&quot;test-plugin&quot; type=&quot;application/x-test&quot; width=&quot;200&quot; height=&quot;200&quot;&gt;&lt;/embed&gt;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+  &lt;/body&gt;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/html/plugin_crashed_help.html</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,8 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+&lt;html&gt;</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+  &lt;head&gt;</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+    &lt;title&gt;Plugin Crashed Help&lt;/title&gt;</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+  &lt;/head&gt;</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+  &lt;body bgcolor=&quot;#FFFFFF&quot;&gt;</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+    &lt;h1&gt;Plugin Crashed Help&lt;/h1&gt;</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+  &lt;/body&gt;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/html/plugin_update.html</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,8 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+&lt;html&gt;</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+  &lt;head&gt;</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+    &lt;title&gt;Plugin Update Page&lt;/title&gt;</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+  &lt;/head&gt;</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+  &lt;body bgcolor=&quot;#FFFFFF&quot;&gt;</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+    &lt;h1&gt;Plugin Update Page&lt;/h1&gt;</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+  &lt;/body&gt;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/html/unknown-plugin.html</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,9 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+&lt;html&gt;</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+  &lt;head&gt;</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+    &lt;title&gt;Unknown Plugin Test&lt;/title&gt;</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+  &lt;/head&gt;</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+  &lt;body bgcolor=&quot;#FFFFFF&quot;&gt;</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+    &lt;h1&gt;Unknown Plugin Test&lt;/h1&gt;</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+    &lt;embed id=&quot;test-plugin&quot; type=&quot;application/x-test-unknown&quot; width=&quot;200&quot; height=&quot;200&quot;&gt;&lt;/embed&gt;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+  &lt;/body&gt;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-lwthemes.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-lwthemes.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -60,44 +60,16 @@ var setupModule = function (module) {</span>
<a href="#l14.4"></a><span id="l14.4">   let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l14.5"></a><span id="l14.5">   fdh.installInto(module);</span>
<a href="#l14.6"></a><span id="l14.6">   let cth = collector.getModule('content-tab-helpers');</span>
<a href="#l14.7"></a><span id="l14.7">   cth.installInto(module);</span>
<a href="#l14.8"></a><span id="l14.8"> };</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> const ALERT_TIMEOUT = 10000;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-let AlertWatcher = {</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-  planForAlert: function(aController) {</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-    this.alerted = false;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-    aController.window.document.addEventListener(&quot;AlertActive&quot;,</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-                                                 this.alertActive, false);</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-  },</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-  waitForAlert: function(aController) {</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-    if (!this.alerted) {</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-      aController.waitFor(function () this.alerted, &quot;Timeout waiting for alert&quot;,</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-                          ALERT_TIMEOUT, 100, this);</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-    }</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-    // Double check the notification box has finished animating.</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-    let notificationBox =</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-      mc.tabmail.selectedTab.panel.getElementsByTagName(&quot;notificationbox&quot;)[0];</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-    if (notificationBox &amp;&amp; notificationBox._animating)</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-      aController.waitFor(function () !notificationBox._animating,</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-                          &quot;Timeout waiting for notification box animation to finish&quot;,</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-                          ALERT_TIMEOUT, 100);</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-    aController.window.document.removeEventListener(&quot;AlertActive&quot;,</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-                                                    this.alertActive, false);</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-  },</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-  alerted: false,</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-  alertActive: function() {</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-    AlertWatcher.alerted = true;</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-  }</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-};</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-</span>
<a href="#l14.40"></a><span id="l14.40"> function check_and_click_notification_box_action_in_current_tab(totalButtons,</span>
<a href="#l14.41"></a><span id="l14.41">                                                                 selectButton) {</span>
<a href="#l14.42"></a><span id="l14.42">   let notificationBox =</span>
<a href="#l14.43"></a><span id="l14.43">     mc.tabmail.selectedTab.panel.getElementsByTagName(&quot;notificationbox&quot;)[0];</span>
<a href="#l14.44"></a><span id="l14.44"> </span>
<a href="#l14.45"></a><span id="l14.45">   // This is a crude check to see that we've got the number of buttons we expect</span>
<a href="#l14.46"></a><span id="l14.46">   // and hence this is the right notification that is being shown.</span>
<a href="#l14.47"></a><span id="l14.47">   let buttons = notificationBox.currentNotification.getElementsByTagName(&quot;button&quot;);</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineat">@@ -118,28 +90,28 @@ function currentLwTheme() {</span>
<a href="#l14.49"></a><span id="l14.49"> }</span>
<a href="#l14.50"></a><span id="l14.50"> </span>
<a href="#l14.51"></a><span id="l14.51"> function install_theme(themeNo, previousThemeNo) {</span>
<a href="#l14.52"></a><span id="l14.52">   let notificationBox =</span>
<a href="#l14.53"></a><span id="l14.53">     mc.tabmail.selectedTab.panel.getElementsByTagName(&quot;notificationbox&quot;)[0];</span>
<a href="#l14.54"></a><span id="l14.54"> </span>
<a href="#l14.55"></a><span id="l14.55">   // Clicking the button will bring up a notification box requesting to allow</span>
<a href="#l14.56"></a><span id="l14.56">   // installation of the theme</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-  AlertWatcher.planForAlert(mc);</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+  NotificationWatcher.planForNotification(mc);</span>
<a href="#l14.59"></a><span id="l14.59">   mc.click(new elib.Elem(mc.window.content.document</span>
<a href="#l14.60"></a><span id="l14.60">                            .getElementById(&quot;install&quot; + themeNo)));</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-  AlertWatcher.waitForAlert(mc);</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+  NotificationWatcher.waitForNotification(mc);</span>
<a href="#l14.63"></a><span id="l14.63"> </span>
<a href="#l14.64"></a><span id="l14.64">   // We're going to acknowledge the theme installation being allowed, and</span>
<a href="#l14.65"></a><span id="l14.65">   // in doing so, the theme will be installed. However, we also will get a new</span>
<a href="#l14.66"></a><span id="l14.66">   // notification box displayed saying the installation is complete, so we'll</span>
<a href="#l14.67"></a><span id="l14.67">   // have to handle that here as well.</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-  AlertWatcher.planForAlert(mc);</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+  NotificationWatcher.planForNotification(mc);</span>
<a href="#l14.70"></a><span id="l14.70">   check_and_click_notification_box_action_in_current_tab(1, 0);</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-  AlertWatcher.waitForAlert(mc);</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+  NotificationWatcher.waitForNotification(mc);</span>
<a href="#l14.73"></a><span id="l14.73"> </span>
<a href="#l14.74"></a><span id="l14.74">   // Before we do anything more, check what we've got installed.</span>
<a href="#l14.75"></a><span id="l14.75">   if (!currentLwTheme())</span>
<a href="#l14.76"></a><span id="l14.76">     throw new Error(&quot;No lightweight theme selected when there should have been.&quot;);</span>
<a href="#l14.77"></a><span id="l14.77"> </span>
<a href="#l14.78"></a><span id="l14.78">   if (currentLwTheme().id != (&quot;test-0&quot; + themeNo))</span>
<a href="#l14.79"></a><span id="l14.79">     throw new Error(&quot;Incorrect theme installed, expected: test-0&quot; + themeNo +</span>
<a href="#l14.80"></a><span id="l14.80">                     &quot; got &quot; + currentLwTheme().id);</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineat">@@ -155,28 +127,28 @@ function install_theme(themeNo, previous</span>
<a href="#l14.82"></a><span id="l14.82">       throw new Error(&quot;No lightweight theme installed after selecting undo&quot;);</span>
<a href="#l14.83"></a><span id="l14.83"> </span>
<a href="#l14.84"></a><span id="l14.84">     if (currentLwTheme().id != (&quot;test-0&quot; + previousThemeNo))</span>
<a href="#l14.85"></a><span id="l14.85">       throw new Error(&quot;After undo expected: test-0&quot; + previousThemeNo +</span>
<a href="#l14.86"></a><span id="l14.86">                       &quot; but got &quot; + currentLwTheme().id);</span>
<a href="#l14.87"></a><span id="l14.87">   }</span>
<a href="#l14.88"></a><span id="l14.88"> </span>
<a href="#l14.89"></a><span id="l14.89">   // Now Click again to install, and this time, we'll leave it there.</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-  AlertWatcher.planForAlert(mc);</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+  NotificationWatcher.planForNotification(mc);</span>
<a href="#l14.92"></a><span id="l14.92">   mc.click(new elib.Elem(mc.window.content.document</span>
<a href="#l14.93"></a><span id="l14.93">                            .getElementById(&quot;install&quot; + themeNo)));</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-  AlertWatcher.waitForAlert(mc);</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+  NotificationWatcher.waitForNotification(mc);</span>
<a href="#l14.96"></a><span id="l14.96"> </span>
<a href="#l14.97"></a><span id="l14.97">   // We're going to acknowledge the theme installation being allowed, and</span>
<a href="#l14.98"></a><span id="l14.98">   // in doing so, the theme will be installed. However, we also will get a new</span>
<a href="#l14.99"></a><span id="l14.99">   // notification box displayed saying the installation is complete, so we'll</span>
<a href="#l14.100"></a><span id="l14.100">   // have to handle that here as well.</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineminus">-  AlertWatcher.planForAlert(mc);</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+  NotificationWatcher.planForNotification(mc);</span>
<a href="#l14.103"></a><span id="l14.103">   check_and_click_notification_box_action_in_current_tab(1, 0);</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-  AlertWatcher.waitForAlert(mc);</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+  NotificationWatcher.waitForNotification(mc);</span>
<a href="#l14.106"></a><span id="l14.106"> </span>
<a href="#l14.107"></a><span id="l14.107">   // Now just close the notification box</span>
<a href="#l14.108"></a><span id="l14.108">   close_notification_box_in_current_tab();</span>
<a href="#l14.109"></a><span id="l14.109"> </span>
<a href="#l14.110"></a><span id="l14.110">   // And one final check for what we've got installed.</span>
<a href="#l14.111"></a><span id="l14.111">   if (!currentLwTheme())</span>
<a href="#l14.112"></a><span id="l14.112">     throw new Error(&quot;No lightweight theme selected when there should have been.&quot;);</span>
<a href="#l14.113"></a><span id="l14.113"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-plugin-blocked.js</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,137 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+ *</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+ *</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+ * License.</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+ *</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+ *</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+ * the Mozilla Foundation.</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+ *</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+ *   Mike Conley &lt;mconley@mozilla.com&gt;</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+ *</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+ *</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+var MODULE_NAME = 'test-plugin-blocked';</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'content-tab-helpers'];</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+var controller = {};</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+Components.utils.import('resource://mozmill/modules/controller.js', controller);</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+var elib = {};</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+Components.utils.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+Components.utils.import('resource://gre/modules/Services.jsm');</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+var gOldStartUrl = null;</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+var gOldBlDetailsUrl = null;</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+var gOldPluginUpdateUrl = null;</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+const kPluginId = &quot;test-plugin&quot;;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+const kStartPagePref = &quot;mailnews.start_page.override_url&quot;;</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+const kBlDetailsPagePref = &quot;extensions.blocklist.detailsURL&quot;;</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+const kPluginsUpdatePref = &quot;plugins.update.url&quot;;</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+// RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+// so we get the right path for the resources.</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+const kUrl = collector.addHttpResource('../content-tabs/html', '');</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+const kPluginUrl = kUrl + &quot;plugin.html&quot;;</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+const kBlDetailsUrl = kUrl + &quot;blocklist_details.html&quot;;</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+const kPluginUpdateUrl = kUrl + &quot;plugin_update.html&quot;;</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+function setupModule(module) {</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+  let cth = collector.getModule('content-tab-helpers');</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+  cth.installInto(module);</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+  // Set the pref so that what's new opens a local url - we'll save the old</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+  // url and put it back in the module teardown.</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+  gOldStartUrl = Services.prefs.getCharPref(kStartPagePref);</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+  gOldBlDetailsUrl = Services.prefs.getCharPref(kBlDetailsPagePref);</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+  gOldPluginUpdateUrl = Services.prefs.getCharPref(kPluginsUpdatePref);</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+  Services.prefs.setCharPref(kStartPagePref, kPluginUrl);</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+  Services.prefs.setCharPref(kBlDetailsPagePref, kBlDetailsUrl);</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+  Services.prefs.setCharPref(kPluginsUpdatePref, kPluginUpdateUrl);</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+};</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+function teardownModule(module) {</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+  Services.prefs.setCharPref(kStartPagePref, gOldStartUrl);</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+  Services.prefs.setCharPref(kBlDetailsPagePref, gOldBlDetailsUrl);</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+  Services.prefs.setCharPref(kPluginsUpdatePref, gOldPluginUpdateUrl);</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+}</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+function setupTest() {</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+  let plugin = get_test_plugin();</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+  plugin.disabled = false;</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+  plugin.blocklisted = true;</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+}</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+function teardownTest() {</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+  let plugin = get_test_plugin();</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+  plugin.disabled = false;</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+  plugin.blocklisted = false;</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+}</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+/* Tests that the notification bar appears for plugins that</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineplus">+ * are blocklisted.  Ensures that the notification bar gives</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineplus">+ * links to the human-readable blocklist, as well as the</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+ * plugin update page.</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+ */</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineplus">+function test_blocklisted_plugin_notification() {</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+  // Prepare to capture the notification bar</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineplus">+  NotificationWatcher.planForNotification(mc);</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineplus">+  let pluginTab = open_content_tab_with_click(mc.menus.helpMenu.whatsNew,</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+                                              kPluginUrl);</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+  NotificationWatcher.waitForNotification(mc);</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+  // If we got here, then the notification bar appeared.  Now</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+  // let's make sure it displayed the right message.</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+  let notificationBar = get_notification_bar_for_tab(mc.tabmail.selectedTab);</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+  assert_not_equals(null, notificationBar, &quot;Could not get notification bar&quot;);</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineplus">+  let blNotification = notificationBar.getNotificationWithValue(&quot;blocked-plugins&quot;);</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineplus">+  assert_not_equals(null, blNotification, &quot;Notification value was not correct&quot;);</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineplus">+</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineplus">+  // buttons[0] should be the &quot;more info&quot; button, and buttons[1]</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineplus">+  // should be the &quot;update my plugins&quot; button.</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineplus">+  let buttons = notificationBar.getElementsByTagName(&quot;button&quot;);</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineplus">+</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineplus">+  // Let's make sure that the &quot;more info&quot; button opens up a tab</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineplus">+  // and takes us to the right place.</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineplus">+  let detailsTab = open_content_tab_with_click(buttons[0], kBlDetailsUrl);</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineplus">+  assert_tab_has_title(detailsTab, &quot;Plugin Blocklist Details&quot;);</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineplus">+  mc.tabmail.closeTab(detailsTab);</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineplus">+  // Let's make sure that the &quot;update my plugins&quot; button opens up</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineplus">+  // a tab and takes us to the right place.</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineplus">+  let updateTab = open_content_tab_with_click(buttons[1], kPluginUpdateUrl);</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineplus">+  assert_tab_has_title(updateTab, &quot;Plugin Update Page&quot;);</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineplus">+  mc.tabmail.closeTab(updateTab);</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+  // Close the tab to finish up.</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+  mc.tabmail.closeTab(pluginTab);</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-plugin-crashing.js</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,259 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+ *</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+ *</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+ * License.</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+ *</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+ *</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+ * the Mozilla Foundation.</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+ *</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+ *   Mike Conley &lt;mconley@mozilla.com&gt;</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+ *</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+ *</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+var MODULE_NAME = 'test-plugin-crashing';</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'content-tab-helpers'];</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+var frame = {};</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+Components.utils.import('resource://mozmill/modules/frame.js', frame);</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+var controller = {};</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+Components.utils.import('resource://mozmill/modules/controller.js', controller);</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+var elib = {};</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+Components.utils.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+Components.utils.import('resource://gre/modules/Services.jsm');</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+var gContentWindow = null;</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+var gJSObject = null;</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+var gTabDoc = null;</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+var gOldStartPage = null;</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+const kPluginId = &quot;test-plugin&quot;;</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+const kStartPagePref = &quot;mailnews.start_page.override_url&quot;;</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+const kPluginCrashDocPref = &quot;plugins.crash.supportUrl&quot;;</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+// RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+// so we get the right path for the resources.</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+const kUrl = collector.addHttpResource('../content-tabs/html', '');</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+const kPluginUrl = kUrl + &quot;plugin.html&quot;;</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+const kPluginCrashDocUrl = kUrl + &quot;plugin_crashed_help.html&quot;;</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+function setupModule(module) {</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+  let cth = collector.getModule('content-tab-helpers');</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+  cth.installInto(module);</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+  // Set the pref so that what's new opens a local url - we'll save the old</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+  // url and put it back in the module teardown.</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+  gOldStartPage = Services.prefs.getCharPref(kStartPagePref);</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+  gOldPluginCrashDocPage = Services.prefs.getCharPref(kPluginCrashDocPref);</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+  Services.prefs.setCharPref(kStartPagePref, kPluginUrl);</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+  Services.prefs.setCharPref(kPluginCrashDocPref, kPluginCrashDocUrl);</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+  if (!plugins_run_in_separate_processes(mc)) {</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+    let funcsToSkip = [test_can_crash_plugin,</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+                       test_crashed_plugin_notification_bar,</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+                       test_crashed_plugin_notification_inline];</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+    funcsToSkip.forEach(function(func) {</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+      func.__force_skip__ = true;</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+    });</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+  }</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+};</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+function teardownModule(module) {</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+  Services.prefs.setCharPref(kStartPagePref, gOldStartPage);</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+  Services.prefs.setCharPref(kPluginCrashDocPref, gOldPluginCrashDocPage);</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+}</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+function setupTest() {</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+  let tab = open_content_tab_with_click(mc.menus.helpMenu.whatsNew, kPluginUrl);</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+  assert_tab_has_title(tab, &quot;Plugin Test&quot;);</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+  // Check that window.content is set up correctly wrt content-primary and</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+  // content-targetable.</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+  if (mc.window.content.location != kPluginUrl)</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+    throw new Error(&quot;window.content is not set to the url loaded, incorrect type=\&quot;...\&quot;?&quot;);</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+  gContentWindow = mc.tabmail.selectedTab.browser.contentWindow;</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+  gJSObject = gContentWindow.wrappedJSObject;</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+  // Strangely, in order to manipulate the embedded plugin,</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+  // we have to use getElementById within the context of the</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+  // wrappedJSObject of the content tab browser.</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+  gTabDoc = gJSObject.window.document;</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineplus">+}</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineplus">+</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+function teardownTest() {</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+  let tab = mc.tabmail.selectedTab;</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+  mc.tabmail.closeTab(tab);</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+}</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineplus">+/* PluginCrashObserver lets us plan for and wait for plugin crashes. After</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+ * a plugin has crashed, PluginCrashObserver cleans up the minidump files</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+ * left behind.</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+ *</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+ * IMPORTANT:  Calls to planForCrash must be followed by waitForCrash in</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+ * order to remove PluginCrashObserver from the nsIObserverService.</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+ */</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+let PluginCrashObserver = {</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+  _sawCrash: false,</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+  planForCrash: function(aController) {</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+    this._sawCrash = false;</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+    Services.obs.addObserver(this, &quot;plugin-crashed&quot;, false);</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+  },</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+  waitForCrash: function(aController) {</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+    if (!this._sawCrash)</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+      aController.waitFor(function() this._sawCrash, &quot;Timeout waiting for crash&quot;,</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+                          5000, 100, this);</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+    Services.obs.removeObserver(this, &quot;plugin-crashed&quot;);</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+  },</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineplus">+    if (aTopic != &quot;plugin-crashed&quot;)</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+      return;</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+    try {</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+      this.removeMinidump(</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineplus">+        aSubject.QueryInterface(Components.interfaces.nsIPropertyBag2));</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineplus">+    } catch (ex) {</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+      Cu.reportError(ex);</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+      frame.events.fail({exception: ex, test: frame.events.currentTest});</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+    }</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+  },</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineplus">+</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineplus">+  removeMinidump: function PluginCrashObserver_removeMinidump(aPropBag) {</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineplus">+    this._sawCrash = true;</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineplus">+</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineplus">+    let profD = Services.dirsvc.get(&quot;ProfD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+    profD.append(&quot;minidumps&quot;);</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineplus">+</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+    // Let's check to see if a minidump was created.  If so, delete</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineplus">+    // it (along with the .extra file)</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+    let crashId = aPropBag.getPropertyAsAString(&quot;pluginDumpID&quot;);</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+    let dumpFile = profD.clone();</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+    dumpFile.append(crashId + &quot;.dmp&quot;);</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+    let extraFile = profD.clone();</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+    extraFile.append(crashId + &quot;.extra&quot;);</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineplus">+    if (dumpFile.exists())</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineplus">+      dumpFile.remove(false);</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineplus">+</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineplus">+    if (extraFile.exists())</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineplus">+      extraFile.remove(false);</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineplus">+  }</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineplus">+}</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineplus">+</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineplus">+/* Crash the plugin */</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineplus">+function crash_plugin() {</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineplus">+  try {</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineplus">+    let plugin = gTabDoc.getElementById(kPluginId);</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineplus">+    PluginCrashObserver.planForCrash(mc);</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineplus">+    plugin.crash();</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineplus">+  } catch(e) {</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineplus">+    PluginCrashObserver.waitForCrash(mc);</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineplus">+    return true;</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineplus">+  }</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineplus">+  return false;</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineplus">+}</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineplus">+</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineplus">+/* A quick sanity check - let's ensure that we can actually</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+ * crash the plugin.</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineplus">+ */</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineplus">+function test_can_crash_plugin() {</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineplus">+  assert_true(crash_plugin());</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineplus">+}</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineplus">+/* Test to check that if a plugin crashes, and the plugin's</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineplus">+ * &lt;object&gt; is too small to display a message, then a</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineplus">+ * notification box appears to tell us about the crash.</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineplus">+ */</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineplus">+function test_crashed_plugin_notification_bar() {</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineplus">+  let plugin = gTabDoc.getElementById(kPluginId);</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineplus">+  plugin.style.width = '10px';</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineplus">+  plugin.style.height = '10px';</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineplus">+</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineplus">+  NotificationWatcher.planForNotification(mc);</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineplus">+  assert_true(crash_plugin());</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineplus">+  NotificationWatcher.waitForNotification(mc);</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineplus">+}</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineplus">+</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineplus">+/* Test that if a plugin crashes, and the plugin's &lt;object&gt;</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineplus">+ * is large enough to display a message, it'll display the</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineplus">+ * appropriate crash message.</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineplus">+ */</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineplus">+function test_crashed_plugin_notification_inline() {</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineplus">+  let plugin = gTabDoc.getElementById(kPluginId);</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineplus">+  plugin.style.width = '200px';</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineplus">+  plugin.style.height = '200px';</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineplus">+</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineplus">+  assert_true(crash_plugin());</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineplus">+</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineplus">+  /* This function attempts to return the status div on the</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineplus">+   * crashed plugin widget.  Returns null on failure.</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineplus">+   */</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineplus">+  function getStatusDiv() {</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineplus">+    let submitDiv = gContentWindow.document</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineplus">+                                  .getAnonymousElementByAttribute(plugin,</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineplus">+                                                                  &quot;class&quot;,</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineplus">+                                                                  &quot;submitStatus&quot;);</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineplus">+</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineplus">+    if (!submitDiv)</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineplus">+      return null;</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineplus">+</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineplus">+    return submitDiv;</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineplus">+  }</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineplus">+</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineplus">+  mc.waitFor(function() (getStatusDiv() != null),</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineplus">+             &quot;Timed out waiting for plugin status div to appear&quot;);</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineplus">+</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineplus">+  let submitDiv = getStatusDiv();</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineplus">+</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineplus">+  // Depending on the environment we're running this test on,</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineplus">+  // the status attribute might be &quot;noReport&quot; or &quot;please&quot;.</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineplus">+  let statusString = submitDiv.getAttribute(&quot;status&quot;);</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineplus">+  assert_true(statusString == &quot;noReport&quot; || statusString == &quot;please&quot;,</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineplus">+              &quot;Expected the status to be \&quot;noReport\&quot; or \&quot;please\&quot;&quot;);</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineplus">+</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineplus">+  // Make sure that the help link in the inline notification works.</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineplus">+  let helpIcon = gContentWindow.document</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineplus">+                               .getAnonymousElementByAttribute(plugin,</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineplus">+                                                               &quot;class&quot;,</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineplus">+                                                               &quot;helpIcon&quot;);</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineplus">+  assert_not_equals(null, helpIcon, &quot;Help Icon should have been available&quot;);</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineplus">+</span>
<a href="#l16.260"></a><span id="l16.260" class="difflineplus">+  let helpTab = open_content_tab_with_click(helpIcon, kPluginCrashDocUrl);</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineplus">+  assert_tab_has_title(helpTab, &quot;Plugin Crashed Help&quot;);</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineplus">+  mc.tabmail.closeTab(helpTab);</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-plugin-outdated.js</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,149 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+ *</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+ *</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+ * License.</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+ *</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+ *</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+ * the Mozilla Foundation.</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+ *</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+ *   Mike Conley &lt;mconley@mozilla.com&gt;</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+ *</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+ *</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+var MODULE_NAME = 'test-plugin-outdated';</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'content-tab-helpers'];</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+var controller = {};</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+Components.utils.import('resource://mozmill/modules/controller.js', controller);</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+var elib = {};</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+Components.utils.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+Components.utils.import('resource://gre/modules/Services.jsm');</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+var gOldStartUrl = null;</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+var gOldPluginUpdateUrl = null;</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+var gHadBlocklist = false;</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+const kPluginId = &quot;test-plugin&quot;;</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+const kStartPagePref = &quot;mailnews.start_page.override_url&quot;;</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+const kPluginsUpdatePref = &quot;plugins.update.url&quot;;</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+const kBlEnabledPref = &quot;extensions.blocklist.enabled&quot;;</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+// RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+// so we get the right path for the resources.</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+const kUrl = collector.addHttpResource('../content-tabs/html', '');</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+const kPluginUrl = kUrl + &quot;plugin.html&quot;;</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+const kPluginUpdateUrl = kUrl + &quot;plugin_update.html&quot;;</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+const kBlocklist = &quot;blocklist.xml&quot;;</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+const kBlocklistOld = &quot;blocklist-old.xml&quot;;</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+const kNewBlocklistPath = &quot;./html/&quot; + kBlocklist;</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+function setupModule(module) {</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+  let cth = collector.getModule('content-tab-helpers');</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+  cth.installInto(module);</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+  // Set the pref so that what's new opens a local url - we'll save the old</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+  // url and put it back in the module teardown.</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+  gOldStartUrl = Services.prefs.getCharPref(kStartPagePref);</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+  // Stash the old plugin update URL so we can put it back on module</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+  // teardown</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+  gOldPluginUpdateUrl = Services.prefs.getCharPref(kPluginsUpdatePref);</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+  Services.prefs.setCharPref(kStartPagePref, kPluginUrl);</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+  Services.prefs.setCharPref(kPluginsUpdatePref, kPluginUpdateUrl);</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+  // See if there's a local blocklist.xml in the profile directory.</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+  // If so, rename it.</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+  let profD = Services.dirsvc.get(&quot;ProfD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+  let blFile = profD.clone();</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+  blFile.append(kBlocklist);</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+  if (blFile.exists()) {</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+    gHadBlocklist = true;</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+    blFile.moveTo(profD, kBlocklistOld);</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+  }</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineplus">+</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+  // Now copy the blocklist from the test to the profile directory</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+  let path = os.getFileForPath(__file__);</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineplus">+  let newBlFile = os.getFileForPath(os.abspath(kNewBlocklistPath, path));</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineplus">+  newBlFile.copyTo(profD, kBlocklist);</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineplus">+  // Cause a reload of blocklist.xml</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+  Services.prefs.setBoolPref(kBlEnabledPref, false);</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+  Services.prefs.setBoolPref(kBlEnabledPref, true);</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+}</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+function teardownModule(module) {</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+  Services.prefs.setCharPref(kStartPagePref, gOldStartUrl);</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+  Services.prefs.setCharPref(kPluginsUpdatePref, gOldPluginUpdateUrl);</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+  // Remove the blocklist.xml we put into the profile directory.</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineplus">+  let profD = Services.dirsvc.get(&quot;ProfD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineplus">+  newBlFile = profD.clone();</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+  newBlFile.append(&quot;blocklist.xml&quot;);</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+  newBlFile.remove(false);</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+  // If there was a blocklist there originally, put it back.</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+  if (gHadBlocklist) {</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+    let blOldFile = profD.clone();</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineplus">+    blOldFile.append(&quot;blocklist-old.xml&quot;);</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineplus">+    blOldFile.moveTo(profD, &quot;blocklist.xml&quot;);</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+  }</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+  // Cause a reload of blocklist.xml</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineplus">+  Services.prefs.setBoolPref(kBlEnabledPref, false);</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineplus">+  Services.prefs.setBoolPref(kBlEnabledPref, true);</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineplus">+}</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineplus">+</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineplus">+function test_outdated_plugin_notification() {</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+  // Prepare to capture the notification bar</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+  NotificationWatcher.planForNotification(mc);</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineplus">+  let pluginTab = open_content_tab_with_click(mc.menus.helpMenu.whatsNew,</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineplus">+                                              kPluginUrl);</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+  NotificationWatcher.waitForNotification(mc);</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+  let notificationBar = get_notification_bar_for_tab(mc.tabmail.selectedTab);</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+  assert_not_equals(null, notificationBar, &quot;Could not get notification bar&quot;);</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+  let notifValue = notificationBar.getNotificationWithValue(&quot;outdated-plugins&quot;);</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+  assert_not_equals(null, notifValue, &quot;Notification value was not correct&quot;);</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+  // buttons[0] should be the &quot;update my plugins&quot; button.</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+  let buttons = notificationBar.getElementsByTagName(&quot;button&quot;);</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineplus">+  // Let's make sure that the &quot;update my plugins&quot; button opens up</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+  // a tab and takes us to the right place.</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineplus">+  let updateTab = open_content_tab_with_click(buttons[0], kPluginUpdateUrl);</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineplus">+  assert_tab_has_title(updateTab, &quot;Plugin Update Page&quot;);</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineplus">+  mc.tabmail.closeTab(updateTab);</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineplus">+</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineplus">+  mc.tabmail.closeTab(pluginTab);</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-plugin-unknown.js</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,137 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+ *</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+ *</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+ * License.</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+ *</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+ *</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+ * the Mozilla Foundation.</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+ *</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+ *   Mike Conley &lt;mconley@mozilla.com&gt;</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+ *</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+ *</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+var MODULE_NAME = 'test-plugin-unknown';</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+                       'content-tab-helpers',</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+                       'window-helpers'];</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+var controller = {};</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+Components.utils.import('resource://mozmill/modules/controller.js', controller);</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+Components.utils.import('resource://gre/modules/Services.jsm');</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+var elib = {};</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+Components.utils.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+var gTabmail = null;</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+var gContentWindow = null;</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+var gJSObject = null;</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+var gTabDoc = null;</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+var gOldStartPage = null;</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+const kPluginId = &quot;test-plugin&quot;;</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+const kStartPagePref = &quot;mailnews.start_page.override_url&quot;;</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+// RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+// so we get the right path for the resources.</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+const kUrl = collector.addHttpResource('../content-tabs/html', '');</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+const kPluginUrl = kUrl + &quot;unknown-plugin.html&quot;;</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+function setupModule(module) {</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+  let cth = collector.getModule('content-tab-helpers');</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+  cth.installInto(module);</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+  // Set the pref so that what's new opens a local url - we'll save the old</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+  // url and put it back in the module teardown.</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+  gOldStartPage = Services.prefs.getCharPref(kStartPagePref);</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+  Services.prefs.setCharPref(kStartPagePref, kPluginUrl);</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+  gTabmail = mc.tabmail;</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+};</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineplus">+function teardownModule(module) {</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+  Services.prefs.setCharPref(kStartPagePref, gOldStartPage);</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+}</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+function openPluginTab() {</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+  let tab = open_content_tab_with_click(mc.menus.helpMenu.whatsNew, kPluginUrl);</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+  assert_tab_has_title(tab, &quot;Unknown Plugin Test&quot;);</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+  assert_content_tab_has_url(tab, kPluginUrl);</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+  gContentWindow = gTabmail.selectedTab.browser.contentWindow;</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+  gJSObject = gContentWindow.wrappedJSObject;</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+  // Strangely, in order to manipulate the embedded plugin,</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+  // we have to use getElementById within the context of the</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+  // wrappedJSObject of the content tab browser.</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+  gTabDoc = gJSObject.window.document;</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+}</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+function closeCurrentTab() {</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+  let tab = gTabmail.selectedTab;</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+  gTabmail.closeTab(tab);</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+}</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+function test_unknown_plugin_notification_inline() {</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+  openPluginTab();</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineplus">+  let plugin = gTabDoc.getElementById(kPluginId);</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineplus">+  function getStatusDiv() {</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineplus">+    let submitDiv = gContentWindow</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineplus">+                    .document</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineplus">+                    .getAnonymousElementByAttribute(plugin,</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineplus">+                                                    &quot;class&quot;,</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineplus">+                                                    &quot;installStatus&quot;);</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineplus">+</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+    if (!submitDiv)</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineplus">+      return null;</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineplus">+</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineplus">+    return submitDiv;</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineplus">+  }</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineplus">+  mc.waitFor(function() (getStatusDiv() != null),</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineplus">+             &quot;Timed out waiting for plugin status div to appear&quot;);</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineplus">+</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+  let submitDiv = getStatusDiv();</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineplus">+  assert_equals(&quot;ready&quot;, submitDiv.getAttribute(&quot;status&quot;),</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineplus">+                &quot;The plugin install status should have been ready&quot;);</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineplus">+  closeCurrentTab();</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineplus">+}</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineplus">+</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineplus">+function test_unknown_plugin_notification_bar() {</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineplus">+  // We need to prepare for the notification before the</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+  // tab is actually loaded, so we'll close the tab that's</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineplus">+  // been auto-loaded, and re-open.</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineplus">+  NotificationWatcher.planForNotification(mc);</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+  openPluginTab();</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+  NotificationWatcher.waitForNotification(mc);</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineplus">+  closeCurrentTab();</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-content-tab-helpers.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-content-tab-helpers.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -40,16 +40,17 @@ var Cc = Components.classes;</span>
<a href="#l19.4"></a><span id="l19.4"> var Cu = Components.utils;</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6"> var elib = {};</span>
<a href="#l19.7"></a><span id="l19.7"> Cu.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l19.8"></a><span id="l19.8"> var mozmill = {};</span>
<a href="#l19.9"></a><span id="l19.9"> Cu.import('resource://mozmill/modules/mozmill.js', mozmill);</span>
<a href="#l19.10"></a><span id="l19.10"> var utils = {};</span>
<a href="#l19.11"></a><span id="l19.11"> Cu.import('resource://mozmill/modules/utils.js', utils);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.13"></a><span id="l19.13"> </span>
<a href="#l19.14"></a><span id="l19.14"> const MODULE_NAME = 'content-tab-helpers';</span>
<a href="#l19.15"></a><span id="l19.15"> </span>
<a href="#l19.16"></a><span id="l19.16"> const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l19.17"></a><span id="l19.17"> </span>
<a href="#l19.18"></a><span id="l19.18"> // we need this for the main controller</span>
<a href="#l19.19"></a><span id="l19.19"> const MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l19.20"></a><span id="l19.20"> </span>
<a href="#l19.21"></a><span id="l19.21" class="difflineat">@@ -85,18 +86,56 @@ function installInto(module) {</span>
<a href="#l19.22"></a><span id="l19.22">   module.content_tab_e = content_tab_e;</span>
<a href="#l19.23"></a><span id="l19.23">   module.content_tab_eid = content_tab_eid;</span>
<a href="#l19.24"></a><span id="l19.24">   module.get_content_tab_element_display = get_content_tab_element_display;</span>
<a href="#l19.25"></a><span id="l19.25">   module.assert_content_tab_element_hidden = assert_content_tab_element_hidden;</span>
<a href="#l19.26"></a><span id="l19.26">   module.assert_content_tab_element_visible = assert_content_tab_element_visible;</span>
<a href="#l19.27"></a><span id="l19.27">   module.wait_for_content_tab_element_display_value = wait_for_content_tab_element_display_value;</span>
<a href="#l19.28"></a><span id="l19.28">   module.assert_content_tab_text_present = assert_content_tab_text_present;</span>
<a href="#l19.29"></a><span id="l19.29">   module.assert_content_tab_text_absent = assert_content_tab_text_absent;</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+  module.NotificationWatcher = NotificationWatcher;</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+  module.get_notification_bar_for_tab = get_notification_bar_for_tab;</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+  module.get_test_plugin = get_test_plugin;</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+  module.plugins_run_in_separate_processes = plugins_run_in_separate_processes;</span>
<a href="#l19.34"></a><span id="l19.34"> }</span>
<a href="#l19.35"></a><span id="l19.35"> </span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+/* Allows for planning / capture of notification events within</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+ * content tabs, for example: plugin crash notifications, theme</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+ * install notifications.</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+ */</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+const ALERT_TIMEOUT = 10000;</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+let NotificationWatcher = {</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+  planForNotification: function(aController) {</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+    this.alerted = false;</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+    aController.window.document.addEventListener(&quot;AlertActive&quot;,</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+                                                 this.alertActive, false);</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+  },</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+  waitForNotification: function(aController) {</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+    if (!this.alerted) {</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+      aController.waitFor(function () this.alerted, &quot;Timeout waiting for alert&quot;,</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+                          ALERT_TIMEOUT, 100, this);</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+    }</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+    // Double check the notification box has finished animating.</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+    let notificationBox =</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+      mc.tabmail.selectedTab.panel.getElementsByTagName(&quot;notificationbox&quot;)[0];</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+    if (notificationBox &amp;&amp; notificationBox._animating)</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+      aController.waitFor(function () !notificationBox._animating,</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+                          &quot;Timeout waiting for notification box animation to finish&quot;,</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+                          ALERT_TIMEOUT, 100);</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+    aController.window.document.removeEventListener(&quot;AlertActive&quot;,</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+                                                    this.alertActive, false);</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+  },</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+  alerted: false,</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+  alertActive: function() {</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+    NotificationWatcher.alerted = true;</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+  }</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+};</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+</span>
<a href="#l19.70"></a><span id="l19.70"> /**</span>
<a href="#l19.71"></a><span id="l19.71">  * Opens a content tab with the given URL.</span>
<a href="#l19.72"></a><span id="l19.72">  *</span>
<a href="#l19.73"></a><span id="l19.73">  * @param aURL The URL to load (string).</span>
<a href="#l19.74"></a><span id="l19.74">  * @param [aBackground] Whether the tab is opened in the background. Defaults to</span>
<a href="#l19.75"></a><span id="l19.75">  *                      false.</span>
<a href="#l19.76"></a><span id="l19.76">  * @param [aController] The controller to open the tab in. Defaults to |mc|.</span>
<a href="#l19.77"></a><span id="l19.77">  *</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineat">@@ -294,8 +333,66 @@ function assert_content_tab_text_present</span>
<a href="#l19.79"></a><span id="l19.79">  * Asserts that the given text is absent on the content tab's page.</span>
<a href="#l19.80"></a><span id="l19.80">  */</span>
<a href="#l19.81"></a><span id="l19.81"> function assert_content_tab_text_absent(aTab, aText) {</span>
<a href="#l19.82"></a><span id="l19.82">   let html = aTab.browser.contentDocument.documentElement.innerHTML;</span>
<a href="#l19.83"></a><span id="l19.83">   if (html.indexOf(aText) != -1) {</span>
<a href="#l19.84"></a><span id="l19.84">     mark_failure([&quot;Found string \&quot;&quot; + aText + &quot;\&quot; on the content tab's page&quot;]);</span>
<a href="#l19.85"></a><span id="l19.85">   }</span>
<a href="#l19.86"></a><span id="l19.86"> }</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+/**</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+ * Returns the notification bar for a tab if one is currently visible,</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+ * null if otherwise.</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+ */</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineplus">+function get_notification_bar_for_tab(aTab) {</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+  let notificationBoxEls = mc.tabmail.selectedTab.panel.getElementsByTagName(&quot;notificationbox&quot;);</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+  if (notificationBoxEls.length == 0)</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+    return null;</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+  return notificationBoxEls[0];</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+}</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+/**</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+ * Returns the nsIPluginTag for the test plug-in, if it is available.</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+ * Returns null otherwise.</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+ */</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineplus">+function get_test_plugin() {</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+  var ph = Components.classes[&quot;@mozilla.org/plugin/host;1&quot;]</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+           .getService(Components.interfaces.nsIPluginHost);</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineplus">+  var tags = ph.getPluginTags();</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineplus">+</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+  // Find the test plugin</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+  for (var i = 0; i &lt; tags.length; i++) {</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineplus">+    if (tags[i].name == &quot;Test Plug-in&quot;)</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineplus">+      return tags[i];</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineplus">+  }</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineplus">+  return null;</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineplus">+}</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineplus">+</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineplus">+/* Returns true if we're currently set up to run plugins in seperate</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineplus">+ * processes, false otherwise.</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineplus">+ */</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineplus">+function plugins_run_in_separate_processes(aController) {</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineplus">+  let supportsOOPP = false;</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineplus">+</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineplus">+  if (aController.mozmillModule.isMac) {</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineplus">+    if (Services.appinfo.XPCOMABI.match(/x86-/)) {</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineplus">+      try {</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineplus">+        supportsOOPP = Services.prefs.getBoolPref(&quot;dom.ipc.plugins.enabled.i386.test.plugin&quot;);</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineplus">+      } catch(e) {</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineplus">+        supportsOOPP = Services.prefs.getBoolPref(&quot;dom.ipc.plugins.enabled.i386&quot;);</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineplus">+      }</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineplus">+    }</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineplus">+    else if (Services.appinfo.XPCOMABI.match(/x86_64-/)) {</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineplus">+      try {</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineplus">+        supportsOOPP = Services.prefs.getBoolPref(&quot;dom.ipc.plugins.enabled.x86_64.test.plugin&quot;);</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineplus">+      } catch(e) {</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineplus">+        supportsOOPP = Services.prefs.getBoolPref(&quot;dom.ipc.plugins.enabled.x86_64&quot;);</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineplus">+      }</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineplus">+    }</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineplus">+  }</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineplus">+  else {</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineplus">+    supportsOOPP = Services.prefs.getBoolPref(&quot;dom.ipc.plugins.enabled&quot;);</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineplus">+  }</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineplus">+</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineplus">+  return supportsOOPP;</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineplus">+}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

