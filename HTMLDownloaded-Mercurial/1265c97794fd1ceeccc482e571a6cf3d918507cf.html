<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29370:1265c97794fd1ceeccc482e571a6cf3d918507cf</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1265c97794fd1ceeccc482e571a6cf3d918507cf" />
<meta property="og:url" content="/comm-central/rev/1265c97794fd1ceeccc482e571a6cf3d918507cf" />
<meta property="og:description" content="Bug 1631247 - Support additional mechanisms to obtain sender's public OpenPGP key. r=PatrickBrunschwig" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1265c97794fd1ceeccc482e571a6cf3d918507cf 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1265c97794fd1ceeccc482e571a6cf3d918507cf">shortlog</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1265c97794fd1ceeccc482e571a6cf3d918507cf">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf">files</a> |
changeset |
<a href="/comm-central/raw-rev/1265c97794fd1ceeccc482e571a6cf3d918507cf">raw</a>  | <a href="/comm-central/archive/1265c97794fd1ceeccc482e571a6cf3d918507cf.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1631247">Bug 1631247</a> - Support additional mechanisms to obtain sender's public OpenPGP key. r=PatrickBrunschwig
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#97;&#105;&#32;&#69;&#110;&#103;&#101;&#114;&#116;&#32;&#60;&#107;&#97;&#105;&#101;&#64;&#107;&#117;&#105;&#120;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 19 Apr 2020 12:02:26 +0200</td></tr>

<tr>
 <td>changeset 29370</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1265c97794fd1ceeccc482e571a6cf3d918507cf">1265c97794fd1ceeccc482e571a6cf3d918507cf</a></td>
</tr>



<tr>
<td>parent 29369</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/804e09a2b5711c710984702bfca2551ac7d4e24d">804e09a2b5711c710984702bfca2551ac7d4e24d</a>
</td>
</tr>

<tr>
<td>child 29371</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a432e1a57c2805be8bbd3ab16a641a39bca7a17c">a432e1a57c2805be8bbd3ab16a641a39bca7a17c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1265c97794fd1ceeccc482e571a6cf3d918507cf">17332</a></td></tr>
<tr><td>push user</td><td>kaie@kuix.de</td></tr>
<tr><td>push date</td><td class="date age">Wed, 22 Apr 2020 17:09:13 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f0676c4790a1 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f0676c4790a181e102e26c54b13a526d33e0e63c">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f0676c4790a181e102e26c54b13a526d33e0e63c&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f0676c4790a181e102e26c54b13a526d33e0e63c&newProject=comm-central&newRevision=804e09a2b5711c710984702bfca2551ac7d4e24d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f0676c4790a181e102e26c54b13a526d33e0e63c&newProject=comm-central&newRevision=804e09a2b5711c710984702bfca2551ac7d4e24d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f0676c4790a181e102e26c54b13a526d33e0e63c&newProject=comm-central&newRevision=804e09a2b5711c710984702bfca2551ac7d4e24d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28PatrickBrunschwig%29&revcount=50">PatrickBrunschwig</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1631247">1631247</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1631247">Bug 1631247</a> - Support additional mechanisms to obtain sender's public OpenPGP key. r=PatrickBrunschwig

Differential Revision: <a href="https://phabricator.services.mozilla.com/D71464">https://phabricator.services.mozilla.com/D71464</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/mainPopupSet.inc.xhtml">mail/base/content/mainPopupSet.inc.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/mainPopupSet.inc.xhtml">file</a> |
<a href="/comm-central/annotate/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/mainPopupSet.inc.xhtml">annotate</a> |
<a href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/mainPopupSet.inc.xhtml">diff</a> |
<a href="/comm-central/comparison/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/mainPopupSet.inc.xhtml">comparison</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/mainPopupSet.inc.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/msgHdrView.inc.xhtml">mail/base/content/msgHdrView.inc.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/msgHdrView.inc.xhtml">file</a> |
<a href="/comm-central/annotate/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/msgHdrView.inc.xhtml">annotate</a> |
<a href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/msgHdrView.inc.xhtml">diff</a> |
<a href="/comm-central/comparison/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/msgHdrView.inc.xhtml">comparison</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/msgHdrView.inc.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/msgOpenPGPKey.inc.xhtml">mail/base/content/msgOpenPGPKey.inc.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/msgOpenPGPKey.inc.xhtml">file</a> |
<a href="/comm-central/annotate/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/msgOpenPGPKey.inc.xhtml">annotate</a> |
<a href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/msgOpenPGPKey.inc.xhtml">diff</a> |
<a href="/comm-central/comparison/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/msgOpenPGPKey.inc.xhtml">comparison</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/base/content/msgOpenPGPKey.inc.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/constants.jsm">mail/extensions/openpgp/content/modules/constants.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/constants.jsm">file</a> |
<a href="/comm-central/annotate/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/constants.jsm">annotate</a> |
<a href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/constants.jsm">diff</a> |
<a href="/comm-central/comparison/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/constants.jsm">comparison</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/constants.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/core.jsm">mail/extensions/openpgp/content/modules/core.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/core.jsm">file</a> |
<a href="/comm-central/annotate/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/core.jsm">annotate</a> |
<a href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/core.jsm">diff</a> |
<a href="/comm-central/comparison/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/core.jsm">comparison</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/core.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/keyRing.jsm">mail/extensions/openpgp/content/modules/keyRing.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/keyRing.jsm">file</a> |
<a href="/comm-central/annotate/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/keyRing.jsm">annotate</a> |
<a href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/keyRing.jsm">diff</a> |
<a href="/comm-central/comparison/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/keyRing.jsm">comparison</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/keyRing.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/keyserver.jsm">mail/extensions/openpgp/content/modules/keyserver.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/keyserver.jsm">file</a> |
<a href="/comm-central/annotate/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/keyserver.jsm">annotate</a> |
<a href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/keyserver.jsm">diff</a> |
<a href="/comm-central/comparison/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/keyserver.jsm">comparison</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/keyserver.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/rnp.jsm">mail/extensions/openpgp/content/modules/rnp.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/rnp.jsm">file</a> |
<a href="/comm-central/annotate/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/rnp.jsm">annotate</a> |
<a href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/rnp.jsm">diff</a> |
<a href="/comm-central/comparison/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/rnp.jsm">comparison</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/rnp.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/rnpLib.jsm">mail/extensions/openpgp/content/modules/rnpLib.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/rnpLib.jsm">file</a> |
<a href="/comm-central/annotate/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/rnpLib.jsm">annotate</a> |
<a href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/rnpLib.jsm">diff</a> |
<a href="/comm-central/comparison/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/rnpLib.jsm">comparison</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/rnpLib.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/sqliteDb.jsm">mail/extensions/openpgp/content/modules/sqliteDb.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/sqliteDb.jsm">file</a> |
<a href="/comm-central/annotate/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/sqliteDb.jsm">annotate</a> |
<a href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/sqliteDb.jsm">diff</a> |
<a href="/comm-central/comparison/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/sqliteDb.jsm">comparison</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/sqliteDb.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/uidHelper.jsm">mail/extensions/openpgp/content/modules/uidHelper.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/uidHelper.jsm">file</a> |
<a href="/comm-central/annotate/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/uidHelper.jsm">annotate</a> |
<a href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/uidHelper.jsm">diff</a> |
<a href="/comm-central/comparison/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/uidHelper.jsm">comparison</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/uidHelper.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/wkdLookup.jsm">mail/extensions/openpgp/content/modules/wkdLookup.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/wkdLookup.jsm">file</a> |
<a href="/comm-central/annotate/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/wkdLookup.jsm">annotate</a> |
<a href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/wkdLookup.jsm">diff</a> |
<a href="/comm-central/comparison/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/wkdLookup.jsm">comparison</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/modules/wkdLookup.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/strings/bond.dtd">mail/extensions/openpgp/content/strings/bond.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/strings/bond.dtd">file</a> |
<a href="/comm-central/annotate/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/strings/bond.dtd">annotate</a> |
<a href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/strings/bond.dtd">diff</a> |
<a href="/comm-central/comparison/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/strings/bond.dtd">comparison</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/strings/bond.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/strings/enigmail.properties">mail/extensions/openpgp/content/strings/enigmail.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/strings/enigmail.properties">file</a> |
<a href="/comm-central/annotate/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/strings/enigmail.properties">annotate</a> |
<a href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/strings/enigmail.properties">diff</a> |
<a href="/comm-central/comparison/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/strings/enigmail.properties">comparison</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/strings/enigmail.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.js">mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.js">file</a> |
<a href="/comm-central/annotate/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.js">annotate</a> |
<a href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.js">diff</a> |
<a href="/comm-central/comparison/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.js">comparison</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">file</a> |
<a href="/comm-central/annotate/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">annotate</a> |
<a href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">diff</a> |
<a href="/comm-central/comparison/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">comparison</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">file</a> |
<a href="/comm-central/annotate/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">annotate</a> |
<a href="/comm-central/diff/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">diff</a> |
<a href="/comm-central/comparison/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">comparison</a> |
<a href="/comm-central/log/1265c97794fd1ceeccc482e571a6cf3d918507cf/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/mainPopupSet.inc.xhtml</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/mainPopupSet.inc.xhtml</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -22,16 +22,21 @@</span>
<a href="#l1.4"></a><span id="l1.4">               accesskey=&quot;&amp;SendMessageTo.accesskey;&quot;</span>
<a href="#l1.5"></a><span id="l1.5">               oncommand=&quot;SendMailToNode(document.popupNode, event)&quot;/&gt;</span>
<a href="#l1.6"></a><span id="l1.6">     &lt;menuitem id=&quot;copyEmailAddressItem&quot; label=&quot;&amp;CopyEmailAddress.label;&quot;</span>
<a href="#l1.7"></a><span id="l1.7">               accesskey=&quot;&amp;CopyEmailAddress.accesskey;&quot;</span>
<a href="#l1.8"></a><span id="l1.8">               oncommand=&quot;CopyEmailNewsAddress(document.popupNode)&quot;/&gt;</span>
<a href="#l1.9"></a><span id="l1.9">     &lt;menuitem id=&quot;copyNameAndEmailAddressItem&quot; label=&quot;&amp;CopyNameAndEmailAddress.label;&quot;</span>
<a href="#l1.10"></a><span id="l1.10">               accesskey=&quot;&amp;CopyNameAndEmailAddress.accesskey;&quot;</span>
<a href="#l1.11"></a><span id="l1.11">               oncommand=&quot;CopyEmailNewsAddress(document.popupNode, true)&quot;/&gt;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+#ifdef MOZ_OPENPGP</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    &lt;menuseparator/&gt;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    &lt;menuitem id=&quot;searchKeysOpenPGP&quot; label=&quot;&amp;searchKeysOpenPGP.label;&quot;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+              oncommand=&quot;Enigmail.msg.searchKeysOnInternet(document.popupNode)&quot;/&gt;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+#endif</span>
<a href="#l1.17"></a><span id="l1.17">     &lt;menuseparator/&gt;</span>
<a href="#l1.18"></a><span id="l1.18">     &lt;menuitem id=&quot;createFilterFromItem&quot; label=&quot;&amp;CreateFilterFrom.label;&quot;</span>
<a href="#l1.19"></a><span id="l1.19">               accesskey=&quot;&amp;CreateFilterFrom.accesskey;&quot;</span>
<a href="#l1.20"></a><span id="l1.20">               oncommand=&quot;CreateFilter(document.popupNode, gMessageDisplay.displayedMessage)&quot;</span>
<a href="#l1.21"></a><span id="l1.21">               observes=&quot;cmd_createFilterFromPopup&quot;/&gt;</span>
<a href="#l1.22"></a><span id="l1.22">   &lt;/menupopup&gt;</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24">   &lt;menupopup id=&quot;copyPopup&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/msgHdrView.inc.xhtml</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/msgHdrView.inc.xhtml</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -3,26 +3,16 @@</span>
<a href="#l2.4"></a><span id="l2.4"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">                         &lt;deck id=&quot;msgHeaderViewDeck&quot; selectedIndex=&quot;0&quot;</span>
<a href="#l2.7"></a><span id="l2.7">                               persist=&quot;selectedIndex&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">                           &lt;!-- the message pane consists of 3 'boxes'. Box #2 is the expanded headers view (the default view) --&gt;</span>
<a href="#l2.10"></a><span id="l2.10">                           &lt;vbox id=&quot;expandedHeaderView&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#ifdef MOZ_OPENPGP</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-                            &lt;vbox flex=&quot;1&quot; pack=&quot;start&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-                              &lt;hbox flex=&quot;1&quot; align=&quot;center&quot;&gt;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-                                &lt;label id=&quot;enigmailStatusText&quot; flex=&quot;1&quot;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-                                       class=&quot;enigmailHeaderValue&quot;&gt;...</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-                                &lt;/label&gt;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-                              &lt;/hbox&gt;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-                            &lt;/vbox&gt;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-#endif</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-</span>
<a href="#l2.22"></a><span id="l2.22">                             &lt;!-- a convenience box for ease of extension overlaying --&gt;</span>
<a href="#l2.23"></a><span id="l2.23">                             &lt;vbox id=&quot;expandedHeadersBox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25">                               &lt;!-- This hbox has display:block set to imbue it with the HTML layout</span>
<a href="#l2.26"></a><span id="l2.26">                                    model. This lets us float the message header toolbar to the right</span>
<a href="#l2.27"></a><span id="l2.27">                                    so we don't waste space when the From field and the toolbar could</span>
<a href="#l2.28"></a><span id="l2.28">                                    fit alongside each other. --&gt;</span>
<a href="#l2.29"></a><span id="l2.29">                               &lt;hbox id=&quot;expandedHeadersTopBox&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/msgOpenPGPKey.inc.xhtml</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/msgOpenPGPKey.inc.xhtml</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -3,9 +3,14 @@</span>
<a href="#l3.4"></a><span id="l3.4"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6">                         &lt;hbox id=&quot;openpgpKeyBox&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l3.7"></a><span id="l3.7">                           &lt;label id=&quot;hasKeyOpenPGP&quot; value=&quot;&amp;enigmail.hasSenderKey.label;&quot;/&gt;</span>
<a href="#l3.8"></a><span id="l3.8">                            &lt;toolbarbutton id=&quot;openpgpImportButton&quot;</span>
<a href="#l3.9"></a><span id="l3.9">                                          label=&quot;&amp;enigmail.importSenderKey.label;&quot;</span>
<a href="#l3.10"></a><span id="l3.10">                                          oncommand=&quot;Enigmail.msg.importAutocryptKeydata();&quot;/&gt;</span>
<a href="#l3.11"></a><span id="l3.11">                         &lt;/hbox&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+                        &lt;hbox id=&quot;signatureKeyBox&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+                          &lt;label id=&quot;missingSignatureKey&quot; value=&quot;&amp;enigmail.missingSignatureKey.label;&quot;/&gt;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+                          &lt;toolbarbutton id=&quot;searchSignatureKeyButton&quot;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+                                         label=&quot;&amp;enigmail.searchSignatureKey.label;&quot;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+                                         oncommand=&quot;Enigmail.msg.searchSignatureKey();&quot;/&gt;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+                        &lt;/hbox&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/constants.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/constants.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -122,16 +122,17 @@ var EnigmailConstants = {</span>
<a href="#l4.4"></a><span id="l4.4">   /* Keyserver Action Flags */</span>
<a href="#l4.5"></a><span id="l4.5">   SEARCH_KEY: 1,</span>
<a href="#l4.6"></a><span id="l4.6">   DOWNLOAD_KEY: 2,</span>
<a href="#l4.7"></a><span id="l4.7">   UPLOAD_KEY: 3,</span>
<a href="#l4.8"></a><span id="l4.8">   REFRESH_KEY: 4,</span>
<a href="#l4.9"></a><span id="l4.9">   GET_SKS_CACERT: 5,</span>
<a href="#l4.10"></a><span id="l4.10">   UPLOAD_WKD: 6,</span>
<a href="#l4.11"></a><span id="l4.11">   GET_CONFIRMATION_LINK: 7,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  DOWNLOAD_KEY_NO_IMPORT: 8,</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14">   /* attachment handling */</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16">   /* per-recipient rules */</span>
<a href="#l4.17"></a><span id="l4.17">   AC_RULE_PREFIX: &quot;autocrypt://&quot;,</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19">   CARD_PIN_CHANGE: 1,</span>
<a href="#l4.20"></a><span id="l4.20">   CARD_PIN_UNBLOCK: 2,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/core.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/core.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -64,22 +64,20 @@ const getEnigmailApp = EnigmailLazy.load</span>
<a href="#l5.4"></a><span id="l5.4"> //  &quot;enigmail/wksMimeHandler.jsm&quot;,</span>
<a href="#l5.5"></a><span id="l5.5"> //  &quot;EnigmailWksMimeHandler&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> //);</span>
<a href="#l5.7"></a><span id="l5.7"> const getEnigmailPgpmimeHander = EnigmailLazy.loader(</span>
<a href="#l5.8"></a><span id="l5.8">   &quot;enigmail/pgpmimeHandler.jsm&quot;,</span>
<a href="#l5.9"></a><span id="l5.9">   &quot;EnigmailPgpmimeHander&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> );</span>
<a href="#l5.11"></a><span id="l5.11"> //const getEnigmailOverlays = EnigmailLazy.loader(&quot;enigmail/enigmailOverlays.jsm&quot;, &quot;EnigmailOverlays&quot;);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-/*</span>
<a href="#l5.13"></a><span id="l5.13"> const getEnigmailSqlite = EnigmailLazy.loader(</span>
<a href="#l5.14"></a><span id="l5.14">   &quot;enigmail/sqliteDb.jsm&quot;,</span>
<a href="#l5.15"></a><span id="l5.15">   &quot;EnigmailSqliteDb&quot;</span>
<a href="#l5.16"></a><span id="l5.16"> );</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-*/</span>
<a href="#l5.18"></a><span id="l5.18"> const getPgpSqlite2 = EnigmailLazy.loader(</span>
<a href="#l5.19"></a><span id="l5.19">   &quot;enigmail/sqliteDb.jsm&quot;,</span>
<a href="#l5.20"></a><span id="l5.20">   &quot;PgpSqliteDb2&quot;</span>
<a href="#l5.21"></a><span id="l5.21"> );</span>
<a href="#l5.22"></a><span id="l5.22"> const getOpenPGPMasterpass = EnigmailLazy.loader(</span>
<a href="#l5.23"></a><span id="l5.23">   &quot;enigmail/masterpass.jsm&quot;,</span>
<a href="#l5.24"></a><span id="l5.24">   &quot;OpenPGPMasterpass&quot;</span>
<a href="#l5.25"></a><span id="l5.25"> );</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineat">@@ -113,17 +111,17 @@ var EnigmailCore = {</span>
<a href="#l5.27"></a><span id="l5.27">     let env = getEnvironment();</span>
<a href="#l5.28"></a><span id="l5.28">     initializeLogDirectory();</span>
<a href="#l5.29"></a><span id="l5.29">     initializeLogging(env);</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31">     const logger = getEnigmailLog();</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33">     logger.DEBUG(&quot;core.jsm: startup()\n&quot;);</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-    //getEnigmailSqlite().checkDatabaseStructure();</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+    getEnigmailSqlite().checkDatabaseStructure();</span>
<a href="#l5.37"></a><span id="l5.37">     getPgpSqlite2().checkDatabaseStructure();</span>
<a href="#l5.38"></a><span id="l5.38">     getEnigmailPrefs().startup(reason);</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40">     this.factories = [];</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42">     function continueStartup(type) {</span>
<a href="#l5.43"></a><span id="l5.43">       logger.DEBUG(`core.jsm: startup.continueStartup(${type})\n`);</span>
<a href="#l5.44"></a><span id="l5.44"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyRing.jsm</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/keyRing.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -610,17 +610,19 @@ var EnigmailKeyRing = {</span>
<a href="#l6.4"></a><span id="l6.4">         )</span>
<a href="#l6.5"></a><span id="l6.5">       ) {</span>
<a href="#l6.6"></a><span id="l6.6">         errorMsgObj.value = EnigmailLocale.getString(&quot;failCancel&quot;);</span>
<a href="#l6.7"></a><span id="l6.7">         return -1;</span>
<a href="#l6.8"></a><span id="l6.8">       }</span>
<a href="#l6.9"></a><span id="l6.9">     }</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">     if (limitedUids.length &gt; 0) {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-      throw new Error(&quot;importKeyAsync with limitedUids: not implemented&quot;);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+      throw new Error(</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+        &quot;importKeyAsync with limitedUids: not implemented &quot; + limitedUids</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+      );</span>
<a href="#l6.16"></a><span id="l6.16">     }</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18">     if (minimizeKey) {</span>
<a href="#l6.19"></a><span id="l6.19">       throw new Error(&quot;importKeyAsync with minimizeKey: not implemented&quot;);</span>
<a href="#l6.20"></a><span id="l6.20">     }</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22">     const cApi = EnigmailCryptoAPI();</span>
<a href="#l6.23"></a><span id="l6.23">     if (isBinary) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyserver.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/keyserver.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -167,16 +167,17 @@ const accessHkpInternal = {</span>
<a href="#l7.4"></a><span id="l7.4">         if (keyData.length === 0) {</span>
<a href="#l7.5"></a><span id="l7.5">           return null;</span>
<a href="#l7.6"></a><span id="l7.6">         }</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8">         payLoad = &quot;keytext=&quot; + encodeURIComponent(keyData);</span>
<a href="#l7.9"></a><span id="l7.9">         return payLoad;</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">       case EnigmailConstants.DOWNLOAD_KEY:</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+      case EnigmailConstants.DOWNLOAD_KEY_NO_IMPORT:</span>
<a href="#l7.13"></a><span id="l7.13">       case EnigmailConstants.SEARCH_KEY:</span>
<a href="#l7.14"></a><span id="l7.14">       case EnigmailConstants.GET_SKS_CACERT:</span>
<a href="#l7.15"></a><span id="l7.15">         return &quot;&quot;;</span>
<a href="#l7.16"></a><span id="l7.16">     }</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18">     // other actions are not yet implemented</span>
<a href="#l7.19"></a><span id="l7.19">     return null;</span>
<a href="#l7.20"></a><span id="l7.20">   },</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineat">@@ -201,17 +202,20 @@ const accessHkpInternal = {</span>
<a href="#l7.22"></a><span id="l7.22">         protocol = &quot;https&quot;;</span>
<a href="#l7.23"></a><span id="l7.23">     }</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25">     let url = protocol + &quot;://&quot; + keySrv.host + &quot;:&quot; + keySrv.port;</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27">     if (actionFlag === EnigmailConstants.UPLOAD_KEY) {</span>
<a href="#l7.28"></a><span id="l7.28">       url += &quot;/pks/add&quot;;</span>
<a href="#l7.29"></a><span id="l7.29">       method = &quot;POST&quot;;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-    } else if (actionFlag === EnigmailConstants.DOWNLOAD_KEY) {</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+    } else if (</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+      actionFlag === EnigmailConstants.DOWNLOAD_KEY ||</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+      actionFlag === EnigmailConstants.DOWNLOAD_KEY_NO_IMPORT</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+    ) {</span>
<a href="#l7.35"></a><span id="l7.35">       if (searchTerm.indexOf(&quot;0x&quot;) !== 0) {</span>
<a href="#l7.36"></a><span id="l7.36">         searchTerm = &quot;0x&quot; + searchTerm;</span>
<a href="#l7.37"></a><span id="l7.37">       }</span>
<a href="#l7.38"></a><span id="l7.38">       url += &quot;/pks/lookup?search=&quot; + searchTerm + &quot;&amp;op=get&amp;options=mr&quot;;</span>
<a href="#l7.39"></a><span id="l7.39">     } else if (actionFlag === EnigmailConstants.SEARCH_KEY) {</span>
<a href="#l7.40"></a><span id="l7.40">       url +=</span>
<a href="#l7.41"></a><span id="l7.41">         &quot;/pks/lookup?search=&quot; +</span>
<a href="#l7.42"></a><span id="l7.42">         escape(searchTerm) +</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineat">@@ -298,16 +302,17 @@ const accessHkpInternal = {</span>
<a href="#l7.44"></a><span id="l7.44">             } else if (xmlReq.status &gt;= 400) {</span>
<a href="#l7.45"></a><span id="l7.45">               reject(createError(EnigmailConstants.KEYSERVER_ERR_SERVER_ERROR));</span>
<a href="#l7.46"></a><span id="l7.46">             } else {</span>
<a href="#l7.47"></a><span id="l7.47">               resolve(xmlReq.responseText);</span>
<a href="#l7.48"></a><span id="l7.48">             }</span>
<a href="#l7.49"></a><span id="l7.49">             return;</span>
<a href="#l7.50"></a><span id="l7.50"> </span>
<a href="#l7.51"></a><span id="l7.51">           case EnigmailConstants.DOWNLOAD_KEY:</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+          case EnigmailConstants.DOWNLOAD_KEY_NO_IMPORT:</span>
<a href="#l7.53"></a><span id="l7.53">             if (xmlReq.status &gt;= 400 &amp;&amp; xmlReq.status &lt; 500) {</span>
<a href="#l7.54"></a><span id="l7.54">               // key not found</span>
<a href="#l7.55"></a><span id="l7.55">               resolve(1);</span>
<a href="#l7.56"></a><span id="l7.56">             } else if (xmlReq.status &gt;= 500) {</span>
<a href="#l7.57"></a><span id="l7.57">               EnigmailLog.DEBUG(</span>
<a href="#l7.58"></a><span id="l7.58">                 &quot;keyserver.jsm: accessHkpInternal: onload: &quot; +</span>
<a href="#l7.59"></a><span id="l7.59">                   xmlReq.responseText +</span>
<a href="#l7.60"></a><span id="l7.60">                   &quot;\n&quot;</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineat">@@ -452,29 +457,31 @@ const accessHkpInternal = {</span>
<a href="#l7.62"></a><span id="l7.62">   /**</span>
<a href="#l7.63"></a><span id="l7.63">    * Download keys from a keyserver</span>
<a href="#l7.64"></a><span id="l7.64">    * @param keyIDs:      String  - space-separated list of search terms or key IDs</span>
<a href="#l7.65"></a><span id="l7.65">    * @param keyserver:   String  - keyserver URL (optionally incl. protocol)</span>
<a href="#l7.66"></a><span id="l7.66">    * @param listener:    optional Object implementing the KeySrvListener API (above)</span>
<a href="#l7.67"></a><span id="l7.67">    *</span>
<a href="#l7.68"></a><span id="l7.68">    * @return:   Promise&lt;...&gt;</span>
<a href="#l7.69"></a><span id="l7.69">    */</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-  async download(keyIDs, keyserver, listener = null) {</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+  async download(autoImport, keyIDs, keyserver, listener = null) {</span>
<a href="#l7.72"></a><span id="l7.72">     EnigmailLog.DEBUG(`keyserver.jsm: accessHkpInternal.download(${keyIDs})\n`);</span>
<a href="#l7.73"></a><span id="l7.73">     let keyIdArr = keyIDs.split(/ +/);</span>
<a href="#l7.74"></a><span id="l7.74">     let retObj = {</span>
<a href="#l7.75"></a><span id="l7.75">       result: 0,</span>
<a href="#l7.76"></a><span id="l7.76">       errorDetails: &quot;&quot;,</span>
<a href="#l7.77"></a><span id="l7.77">       keyList: [],</span>
<a href="#l7.78"></a><span id="l7.78">     };</span>
<a href="#l7.79"></a><span id="l7.79"> </span>
<a href="#l7.80"></a><span id="l7.80">     for (let i = 0; i &lt; keyIdArr.length; i++) {</span>
<a href="#l7.81"></a><span id="l7.81">       try {</span>
<a href="#l7.82"></a><span id="l7.82">         let r = await this.accessKeyServer(</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-          EnigmailConstants.DOWNLOAD_KEY,</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+          autoImport</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+            ? EnigmailConstants.DOWNLOAD_KEY</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+            : EnigmailConstants.DOWNLOAD_KEY_NO_IMPORT,</span>
<a href="#l7.87"></a><span id="l7.87">           keyserver,</span>
<a href="#l7.88"></a><span id="l7.88">           keyIdArr[i],</span>
<a href="#l7.89"></a><span id="l7.89">           listener</span>
<a href="#l7.90"></a><span id="l7.90">         );</span>
<a href="#l7.91"></a><span id="l7.91">         if (Array.isArray(r)) {</span>
<a href="#l7.92"></a><span id="l7.92">           retObj.keyList = retObj.keyList.concat(r);</span>
<a href="#l7.93"></a><span id="l7.93">         }</span>
<a href="#l7.94"></a><span id="l7.94">       } catch (ex) {</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineat">@@ -493,17 +500,17 @@ const accessHkpInternal = {</span>
<a href="#l7.96"></a><span id="l7.96"> </span>
<a href="#l7.97"></a><span id="l7.97">   refresh(keyServer, listener = null) {</span>
<a href="#l7.98"></a><span id="l7.98">     let keyList = EnigmailKeyRing.getAllKeys()</span>
<a href="#l7.99"></a><span id="l7.99">       .keyList.map(keyObj =&gt; {</span>
<a href="#l7.100"></a><span id="l7.100">         return &quot;0x&quot; + keyObj.fpr;</span>
<a href="#l7.101"></a><span id="l7.101">       })</span>
<a href="#l7.102"></a><span id="l7.102">       .join(&quot; &quot;);</span>
<a href="#l7.103"></a><span id="l7.103"> </span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-    return this.download(keyList, keyServer, listener);</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+    return this.download(true, keyList, keyServer, listener);</span>
<a href="#l7.106"></a><span id="l7.106">   },</span>
<a href="#l7.107"></a><span id="l7.107"> </span>
<a href="#l7.108"></a><span id="l7.108">   /**</span>
<a href="#l7.109"></a><span id="l7.109">    * Upload keys to a keyserver</span>
<a href="#l7.110"></a><span id="l7.110">    * @param keyIDs: String  - space-separated list of search terms or key IDs</span>
<a href="#l7.111"></a><span id="l7.111">    * @param keyserver:   String  - keyserver URL (optionally incl. protocol)</span>
<a href="#l7.112"></a><span id="l7.112">    * @param listener:    optional Object implementing the KeySrvListener API (above)</span>
<a href="#l7.113"></a><span id="l7.113">    *</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineat">@@ -646,17 +653,20 @@ const accessKeyBase = {</span>
<a href="#l7.115"></a><span id="l7.115">    * return the URL and the HTTP access method for a given action</span>
<a href="#l7.116"></a><span id="l7.116">    */</span>
<a href="#l7.117"></a><span id="l7.117">   createRequestUrl(actionFlag, searchTerm) {</span>
<a href="#l7.118"></a><span id="l7.118">     let url = &quot;https://keybase.io/_/api/1.0/user/&quot;;</span>
<a href="#l7.119"></a><span id="l7.119"> </span>
<a href="#l7.120"></a><span id="l7.120">     if (actionFlag === EnigmailConstants.UPLOAD_KEY) {</span>
<a href="#l7.121"></a><span id="l7.121">       // not supported</span>
<a href="#l7.122"></a><span id="l7.122">       throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-    } else if (actionFlag === EnigmailConstants.DOWNLOAD_KEY) {</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+    } else if (</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+      actionFlag === EnigmailConstants.DOWNLOAD_KEY ||</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+      actionFlag === EnigmailConstants.DOWNLOAD_KEY_NO_IMPORT</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+    ) {</span>
<a href="#l7.128"></a><span id="l7.128">       if (searchTerm.indexOf(&quot;0x&quot;) === 0) {</span>
<a href="#l7.129"></a><span id="l7.129">         searchTerm = searchTerm.substr(0, 40);</span>
<a href="#l7.130"></a><span id="l7.130">       }</span>
<a href="#l7.131"></a><span id="l7.131">       url +=</span>
<a href="#l7.132"></a><span id="l7.132">         &quot;lookup.json?key_fingerprint=&quot; +</span>
<a href="#l7.133"></a><span id="l7.133">         escape(searchTerm) +</span>
<a href="#l7.134"></a><span id="l7.134">         &quot;&amp;fields=public_keys&quot;;</span>
<a href="#l7.135"></a><span id="l7.135">     } else if (actionFlag === EnigmailConstants.SEARCH_KEY) {</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineat">@@ -709,16 +719,17 @@ const accessKeyBase = {</span>
<a href="#l7.137"></a><span id="l7.137">             if (xmlReq.status &gt;= 400) {</span>
<a href="#l7.138"></a><span id="l7.138">               reject(createError(EnigmailConstants.KEYSERVER_ERR_SERVER_ERROR));</span>
<a href="#l7.139"></a><span id="l7.139">             } else {</span>
<a href="#l7.140"></a><span id="l7.140">               resolve(xmlReq.responseText);</span>
<a href="#l7.141"></a><span id="l7.141">             }</span>
<a href="#l7.142"></a><span id="l7.142">             return;</span>
<a href="#l7.143"></a><span id="l7.143"> </span>
<a href="#l7.144"></a><span id="l7.144">           case EnigmailConstants.DOWNLOAD_KEY:</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+          case EnigmailConstants.DOWNLOAD_KEY_NO_IMPORT:</span>
<a href="#l7.146"></a><span id="l7.146">             if (xmlReq.status &gt;= 400 &amp;&amp; xmlReq.status &lt; 500) {</span>
<a href="#l7.147"></a><span id="l7.147">               // key not found</span>
<a href="#l7.148"></a><span id="l7.148">               resolve([]);</span>
<a href="#l7.149"></a><span id="l7.149">             } else if (xmlReq.status &gt;= 500) {</span>
<a href="#l7.150"></a><span id="l7.150">               EnigmailLog.DEBUG(</span>
<a href="#l7.151"></a><span id="l7.151">                 &quot;keyserver.jsm: onload: &quot; + xmlReq.responseText + &quot;\n&quot;</span>
<a href="#l7.152"></a><span id="l7.152">               );</span>
<a href="#l7.153"></a><span id="l7.153">               reject(createError(EnigmailConstants.KEYSERVER_ERR_SERVER_ERROR));</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineat">@@ -797,29 +808,31 @@ const accessKeyBase = {</span>
<a href="#l7.155"></a><span id="l7.155">   /**</span>
<a href="#l7.156"></a><span id="l7.156">    * Download keys from a KeyBase</span>
<a href="#l7.157"></a><span id="l7.157">    * @param keyIDs:      String  - space-separated list of search terms or key IDs</span>
<a href="#l7.158"></a><span id="l7.158">    * @param keyserver:   (not used for keybase)</span>
<a href="#l7.159"></a><span id="l7.159">    * @param listener:    optional Object implementing the KeySrvListener API (above)</span>
<a href="#l7.160"></a><span id="l7.160">    *</span>
<a href="#l7.161"></a><span id="l7.161">    * @return:   Promise&lt;...&gt;</span>
<a href="#l7.162"></a><span id="l7.162">    */</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-  async download(keyIDs, keyserver, listener = null) {</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+  async download(autoImport, keyIDs, keyserver, listener = null) {</span>
<a href="#l7.165"></a><span id="l7.165">     EnigmailLog.DEBUG(`keyserver.jsm: accessKeyBase: download()\n`);</span>
<a href="#l7.166"></a><span id="l7.166">     let keyIdArr = keyIDs.split(/ +/);</span>
<a href="#l7.167"></a><span id="l7.167">     let retObj = {</span>
<a href="#l7.168"></a><span id="l7.168">       result: 0,</span>
<a href="#l7.169"></a><span id="l7.169">       errorDetails: &quot;&quot;,</span>
<a href="#l7.170"></a><span id="l7.170">       keyList: [],</span>
<a href="#l7.171"></a><span id="l7.171">     };</span>
<a href="#l7.172"></a><span id="l7.172"> </span>
<a href="#l7.173"></a><span id="l7.173">     for (let i = 0; i &lt; keyIdArr.length; i++) {</span>
<a href="#l7.174"></a><span id="l7.174">       try {</span>
<a href="#l7.175"></a><span id="l7.175">         let r = await this.accessKeyServer(</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-          EnigmailConstants.DOWNLOAD_KEY,</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+          autoImport</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+            ? EnigmailConstants.DOWNLOAD_KEY</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+            : EnigmailConstants.DOWNLOAD_KEY_NO_IMPORT,</span>
<a href="#l7.180"></a><span id="l7.180">           keyIdArr[i],</span>
<a href="#l7.181"></a><span id="l7.181">           listener</span>
<a href="#l7.182"></a><span id="l7.182">         );</span>
<a href="#l7.183"></a><span id="l7.183">         if (r.length &gt; 0) {</span>
<a href="#l7.184"></a><span id="l7.184">           retObj.keyList = retObj.keyList.concat(r);</span>
<a href="#l7.185"></a><span id="l7.185">         }</span>
<a href="#l7.186"></a><span id="l7.186">       } catch (ex) {</span>
<a href="#l7.187"></a><span id="l7.187">         retObj.result = ex.result;</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineat">@@ -913,17 +926,17 @@ const accessKeyBase = {</span>
<a href="#l7.189"></a><span id="l7.189">   refresh(keyServer, listener = null) {</span>
<a href="#l7.190"></a><span id="l7.190">     EnigmailLog.DEBUG(`keyserver.jsm: accessKeyBase: refresh()\n`);</span>
<a href="#l7.191"></a><span id="l7.191">     let keyList = EnigmailKeyRing.getAllKeys()</span>
<a href="#l7.192"></a><span id="l7.192">       .keyList.map(keyObj =&gt; {</span>
<a href="#l7.193"></a><span id="l7.193">         return &quot;0x&quot; + keyObj.fpr;</span>
<a href="#l7.194"></a><span id="l7.194">       })</span>
<a href="#l7.195"></a><span id="l7.195">       .join(&quot; &quot;);</span>
<a href="#l7.196"></a><span id="l7.196"> </span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-    return this.download(keyList, keyServer, listener);</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+    return this.download(true, keyList, keyServer, listener);</span>
<a href="#l7.199"></a><span id="l7.199">   },</span>
<a href="#l7.200"></a><span id="l7.200"> };</span>
<a href="#l7.201"></a><span id="l7.201"> </span>
<a href="#l7.202"></a><span id="l7.202"> /**</span>
<a href="#l7.203"></a><span id="l7.203">  Object to handle HKP/HKPS and LDAP/LDAPS requests via GnuPG</span>
<a href="#l7.204"></a><span id="l7.204">  */</span>
<a href="#l7.205"></a><span id="l7.205"> const accessGnuPG = {</span>
<a href="#l7.206"></a><span id="l7.206">   /**</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineat">@@ -947,16 +960,17 @@ const accessGnuPG = {</span>
<a href="#l7.208"></a><span id="l7.208">     }</span>
<a href="#l7.209"></a><span id="l7.209"> </span>
<a href="#l7.210"></a><span id="l7.210">     let proxyHost = EnigmailHttpProxy.getHttpProxy();</span>
<a href="#l7.211"></a><span id="l7.211"> </span>
<a href="#l7.212"></a><span id="l7.212">     switch (actionFlag) {</span>
<a href="#l7.213"></a><span id="l7.213">       case EnigmailConstants.SEARCH_KEY:</span>
<a href="#l7.214"></a><span id="l7.214">         break;</span>
<a href="#l7.215"></a><span id="l7.215">       case EnigmailConstants.DOWNLOAD_KEY:</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+      case EnigmailConstants.DOWNLOAD_KEY_NO_IMPORT:</span>
<a href="#l7.217"></a><span id="l7.217">         break;</span>
<a href="#l7.218"></a><span id="l7.218">       case EnigmailConstants.UPLOAD_KEY:</span>
<a href="#l7.219"></a><span id="l7.219">         break;</span>
<a href="#l7.220"></a><span id="l7.220">     }</span>
<a href="#l7.221"></a><span id="l7.221">     */</span>
<a href="#l7.222"></a><span id="l7.222">   },</span>
<a href="#l7.223"></a><span id="l7.223"> </span>
<a href="#l7.224"></a><span id="l7.224">   parseStatusMsg(execResult) {</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineat">@@ -1012,28 +1026,30 @@ const accessGnuPG = {</span>
<a href="#l7.226"></a><span id="l7.226">   /**</span>
<a href="#l7.227"></a><span id="l7.227">    * Download keys from a keyserver</span>
<a href="#l7.228"></a><span id="l7.228">    * @param keyIDs:      String  - space-separated list of search terms or key IDs</span>
<a href="#l7.229"></a><span id="l7.229">    * @param keyserver:   String  - keyserver URL (optionally incl. protocol)</span>
<a href="#l7.230"></a><span id="l7.230">    * @param listener:    optional Object implementing the KeySrvListener API (above)</span>
<a href="#l7.231"></a><span id="l7.231">    *</span>
<a href="#l7.232"></a><span id="l7.232">    * @return:   Promise&lt;...&gt;</span>
<a href="#l7.233"></a><span id="l7.233">    */</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-  async download(keyIDs, keyserver, listener = null) {</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+  async download(autoImport, keyIDs, keyserver, listener = null) {</span>
<a href="#l7.236"></a><span id="l7.236">     EnigmailLog.DEBUG(`keyserver.jsm: accessGnuPG.download(${keyIDs})\n`);</span>
<a href="#l7.237"></a><span id="l7.237">     let retObj = {</span>
<a href="#l7.238"></a><span id="l7.238">       result: 0,</span>
<a href="#l7.239"></a><span id="l7.239">       errorDetails: &quot;&quot;,</span>
<a href="#l7.240"></a><span id="l7.240">       keyList: [],</span>
<a href="#l7.241"></a><span id="l7.241">     };</span>
<a href="#l7.242"></a><span id="l7.242">     let keyIdArr = keyIDs.split(/ +/);</span>
<a href="#l7.243"></a><span id="l7.243"> </span>
<a href="#l7.244"></a><span id="l7.244">     for (let i = 0; i &lt; keyIdArr.length; i++) {</span>
<a href="#l7.245"></a><span id="l7.245">       let r = await this.accessKeyServer(</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-        EnigmailConstants.DOWNLOAD_KEY,</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+        autoImport</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+          ? EnigmailConstants.DOWNLOAD_KEY</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+          : EnigmailConstants.DOWNLOAD_KEY_NO_IMPORT,</span>
<a href="#l7.250"></a><span id="l7.250">         keyserver,</span>
<a href="#l7.251"></a><span id="l7.251">         keyIdArr[i],</span>
<a href="#l7.252"></a><span id="l7.252">         listener</span>
<a href="#l7.253"></a><span id="l7.253">       );</span>
<a href="#l7.254"></a><span id="l7.254"> </span>
<a href="#l7.255"></a><span id="l7.255">       let exitValue = this.parseStatusMsg(r);</span>
<a href="#l7.256"></a><span id="l7.256">       if (exitValue) {</span>
<a href="#l7.257"></a><span id="l7.257">         exitValue.keyList = [];</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineat">@@ -1060,17 +1076,17 @@ const accessGnuPG = {</span>
<a href="#l7.259"></a><span id="l7.259"> </span>
<a href="#l7.260"></a><span id="l7.260">   refresh(keyServer, listener = null) {</span>
<a href="#l7.261"></a><span id="l7.261">     let keyList = EnigmailKeyRing.getAllKeys()</span>
<a href="#l7.262"></a><span id="l7.262">       .keyList.map(keyObj =&gt; {</span>
<a href="#l7.263"></a><span id="l7.263">         return &quot;0x&quot; + keyObj.fpr;</span>
<a href="#l7.264"></a><span id="l7.264">       })</span>
<a href="#l7.265"></a><span id="l7.265">       .join(&quot; &quot;);</span>
<a href="#l7.266"></a><span id="l7.266"> </span>
<a href="#l7.267"></a><span id="l7.267" class="difflineminus">-    return this.download(keyList, keyServer, listener);</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+    return this.download(true, keyList, keyServer, listener);</span>
<a href="#l7.269"></a><span id="l7.269">   },</span>
<a href="#l7.270"></a><span id="l7.270"> </span>
<a href="#l7.271"></a><span id="l7.271">   /**</span>
<a href="#l7.272"></a><span id="l7.272">    * Upload keys to a keyserver</span>
<a href="#l7.273"></a><span id="l7.273">    * @param keyIDs: String  - space-separated list of search terms or key IDs</span>
<a href="#l7.274"></a><span id="l7.274">    * @param keyserver:   String  - keyserver URL (optionally incl. protocol)</span>
<a href="#l7.275"></a><span id="l7.275">    * @param listener:    optional Object implementing the KeySrvListener API (above)</span>
<a href="#l7.276"></a><span id="l7.276">    *</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineat">@@ -1259,16 +1275,17 @@ const accessVksServer = {</span>
<a href="#l7.278"></a><span id="l7.278">         payLoad = JSON.stringify({</span>
<a href="#l7.279"></a><span id="l7.279">           token: searchTerms.token,</span>
<a href="#l7.280"></a><span id="l7.280">           addresses: searchTerms.addresses,</span>
<a href="#l7.281"></a><span id="l7.281">           locale: [locale],</span>
<a href="#l7.282"></a><span id="l7.282">         });</span>
<a href="#l7.283"></a><span id="l7.283">         return payLoad;</span>
<a href="#l7.284"></a><span id="l7.284"> </span>
<a href="#l7.285"></a><span id="l7.285">       case EnigmailConstants.DOWNLOAD_KEY:</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+      case EnigmailConstants.DOWNLOAD_KEY_NO_IMPORT:</span>
<a href="#l7.287"></a><span id="l7.287">       case EnigmailConstants.SEARCH_KEY:</span>
<a href="#l7.288"></a><span id="l7.288">       case EnigmailConstants.GET_SKS_CACERT:</span>
<a href="#l7.289"></a><span id="l7.289">         return &quot;&quot;;</span>
<a href="#l7.290"></a><span id="l7.290">     }</span>
<a href="#l7.291"></a><span id="l7.291"> </span>
<a href="#l7.292"></a><span id="l7.292">     // other actions are not yet implemented</span>
<a href="#l7.293"></a><span id="l7.293">     return null;</span>
<a href="#l7.294"></a><span id="l7.294">   },</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineat">@@ -1289,16 +1306,17 @@ const accessVksServer = {</span>
<a href="#l7.296"></a><span id="l7.296">       method = &quot;POST&quot;;</span>
<a href="#l7.297"></a><span id="l7.297">       contentType = &quot;application/json&quot;;</span>
<a href="#l7.298"></a><span id="l7.298">     } else if (actionFlag === EnigmailConstants.GET_CONFIRMATION_LINK) {</span>
<a href="#l7.299"></a><span id="l7.299">       url += &quot;/vks/v1/request-verify&quot;;</span>
<a href="#l7.300"></a><span id="l7.300">       method = &quot;POST&quot;;</span>
<a href="#l7.301"></a><span id="l7.301">       contentType = &quot;application/json&quot;;</span>
<a href="#l7.302"></a><span id="l7.302">     } else if (</span>
<a href="#l7.303"></a><span id="l7.303">       actionFlag === EnigmailConstants.DOWNLOAD_KEY ||</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineplus">+      actionFlag === EnigmailConstants.DOWNLOAD_KEY_NO_IMPORT ||</span>
<a href="#l7.305"></a><span id="l7.305">       actionFlag === EnigmailConstants.SEARCH_KEY</span>
<a href="#l7.306"></a><span id="l7.306">     ) {</span>
<a href="#l7.307"></a><span id="l7.307">       if (searchTerm) {</span>
<a href="#l7.308"></a><span id="l7.308">         let lookup = &quot;/vks/&quot;;</span>
<a href="#l7.309"></a><span id="l7.309">         if (searchTerm.indexOf(&quot;0x&quot;) === 0) {</span>
<a href="#l7.310"></a><span id="l7.310">           searchTerm = searchTerm.substr(2);</span>
<a href="#l7.311"></a><span id="l7.311">           if (</span>
<a href="#l7.312"></a><span id="l7.312">             searchTerm.length == 16 &amp;&amp;</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineat">@@ -1400,44 +1418,50 @@ const accessVksServer = {</span>
<a href="#l7.314"></a><span id="l7.314">             } else if (xmlReq.status &gt;= 400) {</span>
<a href="#l7.315"></a><span id="l7.315">               reject(createError(EnigmailConstants.KEYSERVER_ERR_SERVER_ERROR));</span>
<a href="#l7.316"></a><span id="l7.316">             } else {</span>
<a href="#l7.317"></a><span id="l7.317">               resolve(xmlReq.responseText);</span>
<a href="#l7.318"></a><span id="l7.318">             }</span>
<a href="#l7.319"></a><span id="l7.319">             return;</span>
<a href="#l7.320"></a><span id="l7.320"> </span>
<a href="#l7.321"></a><span id="l7.321">           case EnigmailConstants.DOWNLOAD_KEY:</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineplus">+          case EnigmailConstants.DOWNLOAD_KEY_NO_IMPORT:</span>
<a href="#l7.323"></a><span id="l7.323">             if (xmlReq.status &gt;= 400 &amp;&amp; xmlReq.status &lt; 500) {</span>
<a href="#l7.324"></a><span id="l7.324">               // key not found</span>
<a href="#l7.325"></a><span id="l7.325">               resolve(1);</span>
<a href="#l7.326"></a><span id="l7.326">             } else if (xmlReq.status &gt;= 500) {</span>
<a href="#l7.327"></a><span id="l7.327">               EnigmailLog.DEBUG(</span>
<a href="#l7.328"></a><span id="l7.328">                 &quot;keyserver.jsm: accessVksServer.onload: &quot; +</span>
<a href="#l7.329"></a><span id="l7.329">                   xmlReq.responseText +</span>
<a href="#l7.330"></a><span id="l7.330">                   &quot;\n&quot;</span>
<a href="#l7.331"></a><span id="l7.331">               );</span>
<a href="#l7.332"></a><span id="l7.332">               reject(createError(EnigmailConstants.KEYSERVER_ERR_SERVER_ERROR));</span>
<a href="#l7.333"></a><span id="l7.333">             } else {</span>
<a href="#l7.334"></a><span id="l7.334">               let errorMsgObj = {},</span>
<a href="#l7.335"></a><span id="l7.335">                 importedKeysObj = {};</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineminus">-              let r = EnigmailKeyRing.importKey(</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineminus">-                null,</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-                false,</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineminus">-                xmlReq.responseText,</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineminus">-                false,</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineminus">-                &quot;&quot;,</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineminus">-                errorMsgObj,</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineminus">-                importedKeysObj</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineminus">-              );</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineminus">-              if (r === 0) {</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineminus">-                resolve(importedKeysObj.value);</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineplus">+              if (actionFlag === EnigmailConstants.DOWNLOAD_KEY) {</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineplus">+                let r = EnigmailKeyRing.importKey(</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineplus">+                  null,</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineplus">+                  false,</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineplus">+                  xmlReq.responseText,</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineplus">+                  false,</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineplus">+                  &quot;&quot;,</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineplus">+                  errorMsgObj,</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineplus">+                  importedKeysObj</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineplus">+                );</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineplus">+                if (r === 0) {</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineplus">+                  resolve(importedKeysObj.value);</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineplus">+                } else {</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineplus">+                  reject(</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineplus">+                    createError(EnigmailConstants.KEYSERVER_ERR_IMPORT_ERROR)</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineplus">+                  );</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineplus">+                }</span>
<a href="#l7.364"></a><span id="l7.364">               } else {</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineminus">-                reject(</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineminus">-                  createError(EnigmailConstants.KEYSERVER_ERR_IMPORT_ERROR)</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineminus">-                );</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineplus">+                // DOWNLOAD_KEY_NO_IMPORT</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineplus">+                resolve(xmlReq.responseText);</span>
<a href="#l7.370"></a><span id="l7.370">               }</span>
<a href="#l7.371"></a><span id="l7.371">             }</span>
<a href="#l7.372"></a><span id="l7.372">             return;</span>
<a href="#l7.373"></a><span id="l7.373">         }</span>
<a href="#l7.374"></a><span id="l7.374">         resolve(-1);</span>
<a href="#l7.375"></a><span id="l7.375">       };</span>
<a href="#l7.376"></a><span id="l7.376"> </span>
<a href="#l7.377"></a><span id="l7.377">       xmlReq.onerror = function(e) {</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineat">@@ -1487,35 +1511,43 @@ const accessVksServer = {</span>
<a href="#l7.379"></a><span id="l7.379">   /**</span>
<a href="#l7.380"></a><span id="l7.380">    * Download keys from a keyserver</span>
<a href="#l7.381"></a><span id="l7.381">    * @param keyIDs:      String  - space-separated list of search terms or key IDs</span>
<a href="#l7.382"></a><span id="l7.382">    * @param keyserver:   String  - keyserver URL (optionally incl. protocol)</span>
<a href="#l7.383"></a><span id="l7.383">    * @param listener:    optional Object implementing the KeySrvListener API (above)</span>
<a href="#l7.384"></a><span id="l7.384">    *</span>
<a href="#l7.385"></a><span id="l7.385">    * @return:   Promise&lt;...&gt;</span>
<a href="#l7.386"></a><span id="l7.386">    */</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineminus">-  async download(keyIDs, keyserver, listener = null) {</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineplus">+  async download(autoImport, keyIDs, keyserver, listener = null) {</span>
<a href="#l7.389"></a><span id="l7.389">     EnigmailLog.DEBUG(`keyserver.jsm: accessVksServer.download(${keyIDs})\n`);</span>
<a href="#l7.390"></a><span id="l7.390">     let keyIdArr = keyIDs.split(/ +/);</span>
<a href="#l7.391"></a><span id="l7.391">     let retObj = {</span>
<a href="#l7.392"></a><span id="l7.392">       result: 0,</span>
<a href="#l7.393"></a><span id="l7.393">       errorDetails: &quot;&quot;,</span>
<a href="#l7.394"></a><span id="l7.394">       keyList: [],</span>
<a href="#l7.395"></a><span id="l7.395">     };</span>
<a href="#l7.396"></a><span id="l7.396"> </span>
<a href="#l7.397"></a><span id="l7.397">     for (let i = 0; i &lt; keyIdArr.length; i++) {</span>
<a href="#l7.398"></a><span id="l7.398">       try {</span>
<a href="#l7.399"></a><span id="l7.399">         let r = await this.accessKeyServer(</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineminus">-          EnigmailConstants.DOWNLOAD_KEY,</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineplus">+          autoImport</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineplus">+            ? EnigmailConstants.DOWNLOAD_KEY</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineplus">+            : EnigmailConstants.DOWNLOAD_KEY_NO_IMPORT,</span>
<a href="#l7.404"></a><span id="l7.404">           keyserver,</span>
<a href="#l7.405"></a><span id="l7.405">           keyIdArr[i],</span>
<a href="#l7.406"></a><span id="l7.406">           listener</span>
<a href="#l7.407"></a><span id="l7.407">         );</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineminus">-        if (Array.isArray(r)) {</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineminus">-          retObj.keyList = retObj.keyList.concat(r);</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineplus">+        if (autoImport) {</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineplus">+          if (Array.isArray(r)) {</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineplus">+            retObj.keyList = retObj.keyList.concat(r);</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineplus">+          }</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+        } else if (typeof r == &quot;string&quot;) {</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineplus">+          retObj.keyData = r;</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineplus">+        } else {</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineplus">+          retObj.result = r;</span>
<a href="#l7.418"></a><span id="l7.418">         }</span>
<a href="#l7.419"></a><span id="l7.419">       } catch (ex) {</span>
<a href="#l7.420"></a><span id="l7.420">         retObj.result = ex.result;</span>
<a href="#l7.421"></a><span id="l7.421">         retObj.errorDetails = ex.errorDetails;</span>
<a href="#l7.422"></a><span id="l7.422">         throw retObj;</span>
<a href="#l7.423"></a><span id="l7.423">       }</span>
<a href="#l7.424"></a><span id="l7.424"> </span>
<a href="#l7.425"></a><span id="l7.425">       if (listener &amp;&amp; &quot;onProgress&quot; in listener) {</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineat">@@ -1528,17 +1560,17 @@ const accessVksServer = {</span>
<a href="#l7.427"></a><span id="l7.427"> </span>
<a href="#l7.428"></a><span id="l7.428">   refresh(keyServer, listener = null) {</span>
<a href="#l7.429"></a><span id="l7.429">     let keyList = EnigmailKeyRing.getAllKeys()</span>
<a href="#l7.430"></a><span id="l7.430">       .keyList.map(keyObj =&gt; {</span>
<a href="#l7.431"></a><span id="l7.431">         return &quot;0x&quot; + keyObj.fpr;</span>
<a href="#l7.432"></a><span id="l7.432">       })</span>
<a href="#l7.433"></a><span id="l7.433">       .join(&quot; &quot;);</span>
<a href="#l7.434"></a><span id="l7.434"> </span>
<a href="#l7.435"></a><span id="l7.435" class="difflineminus">-    return this.download(keyList, keyServer, listener);</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineplus">+    return this.download(true, keyList, keyServer, listener);</span>
<a href="#l7.437"></a><span id="l7.437">   },</span>
<a href="#l7.438"></a><span id="l7.438"> </span>
<a href="#l7.439"></a><span id="l7.439">   async requestConfirmationLink(keyserver, jsonFragment) {</span>
<a href="#l7.440"></a><span id="l7.440">     EnigmailLog.DEBUG(</span>
<a href="#l7.441"></a><span id="l7.441">       `keyserver.jsm: accessVksServer.requestConfirmationLink()\n`</span>
<a href="#l7.442"></a><span id="l7.442">     );</span>
<a href="#l7.443"></a><span id="l7.443"> </span>
<a href="#l7.444"></a><span id="l7.444">     let response = JSON.parse(jsonFragment);</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineat">@@ -1704,17 +1736,22 @@ var EnigmailKeyServer = {</span>
<a href="#l7.446"></a><span id="l7.446">    * @param listener:    optional Object implementing the KeySrvListener API (above)</span>
<a href="#l7.447"></a><span id="l7.447">    *</span>
<a href="#l7.448"></a><span id="l7.448">    * @return:   Promise&lt;Object&gt;</span>
<a href="#l7.449"></a><span id="l7.449">    *     Object: - result: Number           - result Code (0 = OK),</span>
<a href="#l7.450"></a><span id="l7.450">    *             - keyList: Array of String - imported key FPR</span>
<a href="#l7.451"></a><span id="l7.451">    */</span>
<a href="#l7.452"></a><span id="l7.452">   download(keyIDs, keyserver = null, listener) {</span>
<a href="#l7.453"></a><span id="l7.453">     let acc = getAccessType(keyserver);</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineminus">-    return acc.download(keyIDs, keyserver, listener);</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineplus">+    return acc.download(true, keyIDs, keyserver, listener);</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineplus">+  },</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineplus">+</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineplus">+  downloadNoImport(keyIDs, keyserver = null, listener) {</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineplus">+    let acc = getAccessType(keyserver);</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineplus">+    return acc.download(false, keyIDs, keyserver, listener);</span>
<a href="#l7.461"></a><span id="l7.461">   },</span>
<a href="#l7.462"></a><span id="l7.462"> </span>
<a href="#l7.463"></a><span id="l7.463">   /**</span>
<a href="#l7.464"></a><span id="l7.464">    * Upload keys to a keyserver</span>
<a href="#l7.465"></a><span id="l7.465">    * @param keyIDs:      String  - space-separated list of key IDs or FPR</span>
<a href="#l7.466"></a><span id="l7.466">    * @param keyserver:   String  - keyserver URL (optionally incl. protocol)</span>
<a href="#l7.467"></a><span id="l7.467">    * @param listener:    optional Object implementing the KeySrvListener API (above)</span>
<a href="#l7.468"></a><span id="l7.468">    *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/rnp.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/rnp.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -377,20 +377,25 @@ var RNP = {</span>
<a href="#l8.4"></a><span id="l8.4">         }</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6">         RNPLib.rnp_uid_handle_destroy(uid_handle);</span>
<a href="#l8.7"></a><span id="l8.7">       }</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9">       if (!keyObj.userId) {</span>
<a href="#l8.10"></a><span id="l8.10">         let prim_uid_str = new ctypes.char.ptr();</span>
<a href="#l8.11"></a><span id="l8.11">         if (RNPLib.rnp_key_get_primary_uid(handle, prim_uid_str.address())) {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-          throw new Error(&quot;rnp_key_get_primary_uid failed&quot;);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+          // Seen with some stripped keys from keys.openpgp.org</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+          // if an essential key is distributed, but the owner didn't</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+          // agree to ship their user id.</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+          keyObj.userId = &quot;?&quot;;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+          console.debug(&quot;rnp_key_get_primary_uid failed&quot;);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+        } else {</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+          keyObj.userId = prim_uid_str.readString();</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+          RNPLib.rnp_buffer_destroy(prim_uid_str);</span>
<a href="#l8.21"></a><span id="l8.21">         }</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-        keyObj.userId = prim_uid_str.readString();</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-        RNPLib.rnp_buffer_destroy(prim_uid_str);</span>
<a href="#l8.24"></a><span id="l8.24">       }</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26">       if (RNPLib.rnp_key_get_subkey_count(handle, sub_count.address())) {</span>
<a href="#l8.27"></a><span id="l8.27">         throw new Error(&quot;rnp_key_get_subkey_count failed&quot;);</span>
<a href="#l8.28"></a><span id="l8.28">       }</span>
<a href="#l8.29"></a><span id="l8.29">       for (let i = 0; i &lt; sub_count.value; i++) {</span>
<a href="#l8.30"></a><span id="l8.30">         let sub_handle = new RNPLib.rnp_key_handle_t();</span>
<a href="#l8.31"></a><span id="l8.31">         if (RNPLib.rnp_key_get_subkey_at(handle, i, sub_handle.address())) {</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineat">@@ -457,34 +462,35 @@ var RNP = {</span>
<a href="#l8.33"></a><span id="l8.33">           }</span>
<a href="#l8.34"></a><span id="l8.34">           let userIdStr = uid_str.readString();</span>
<a href="#l8.35"></a><span id="l8.35">           RNPLib.rnp_buffer_destroy(uid_str);</span>
<a href="#l8.36"></a><span id="l8.36"> </span>
<a href="#l8.37"></a><span id="l8.37">           if (userIdStr !== RNP_PHOTO_USERID_ID) {</span>
<a href="#l8.38"></a><span id="l8.38">             let id = outputIndex;</span>
<a href="#l8.39"></a><span id="l8.39">             ++outputIndex;</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-            rList[id] = {};</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-            rList[id].created = mainKeyObj.created;</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-            rList[id].fpr = mainKeyObj.fpr;</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-            rList[id].keyId = mainKeyObj.keyId;</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+            let subList = {};</span>
<a href="#l8.46"></a><span id="l8.46"> </span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-            rList[id].userId = userIdStr;</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-            rList[id].sigList = [];</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+            subList = {};</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+            subList.created = mainKeyObj.created;</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+            subList.fpr = mainKeyObj.fpr;</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+            subList.keyId = mainKeyObj.keyId;</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+            subList.userId = userIdStr;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+            subList.sigList = [];</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57">             let sig_count = new ctypes.size_t();</span>
<a href="#l8.58"></a><span id="l8.58">             if (</span>
<a href="#l8.59"></a><span id="l8.59">               RNPLib.rnp_uid_get_signature_count(</span>
<a href="#l8.60"></a><span id="l8.60">                 uid_handle,</span>
<a href="#l8.61"></a><span id="l8.61">                 sig_count.address()</span>
<a href="#l8.62"></a><span id="l8.62">               )</span>
<a href="#l8.63"></a><span id="l8.63">             ) {</span>
<a href="#l8.64"></a><span id="l8.64">               throw new Error(&quot;rnp_uid_get_signature_count failed&quot;);</span>
<a href="#l8.65"></a><span id="l8.65">             }</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-</span>
<a href="#l8.67"></a><span id="l8.67">             for (let j = 0; j &lt; sig_count.value; j++) {</span>
<a href="#l8.68"></a><span id="l8.68">               let sigObj = {};</span>
<a href="#l8.69"></a><span id="l8.69"> </span>
<a href="#l8.70"></a><span id="l8.70">               let sig_handle = new RNPLib.rnp_signature_handle_t();</span>
<a href="#l8.71"></a><span id="l8.71">               if (</span>
<a href="#l8.72"></a><span id="l8.72">                 RNPLib.rnp_uid_get_signature_at(</span>
<a href="#l8.73"></a><span id="l8.73">                   uid_handle,</span>
<a href="#l8.74"></a><span id="l8.74">                   j,</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineat">@@ -531,36 +537,37 @@ var RNP = {</span>
<a href="#l8.76"></a><span id="l8.76">               ) {</span>
<a href="#l8.77"></a><span id="l8.77">                 throw new Error(&quot;rnp_signature_get_signer failed&quot;);</span>
<a href="#l8.78"></a><span id="l8.78">               }</span>
<a href="#l8.79"></a><span id="l8.79"> </span>
<a href="#l8.80"></a><span id="l8.80">               if (signerHandle.isNull()) {</span>
<a href="#l8.81"></a><span id="l8.81">                 if (!ignoreUnknownUid) {</span>
<a href="#l8.82"></a><span id="l8.82">                   sigObj.userId = &quot;?&quot;;</span>
<a href="#l8.83"></a><span id="l8.83">                   sigObj.sigKnown = false;</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-                  rList[id].sigList.push(sigObj);</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+                  subList.sigList.push(sigObj);</span>
<a href="#l8.86"></a><span id="l8.86">                 }</span>
<a href="#l8.87"></a><span id="l8.87">               } else {</span>
<a href="#l8.88"></a><span id="l8.88">                 let signer_uid_str = new ctypes.char.ptr();</span>
<a href="#l8.89"></a><span id="l8.89">                 if (</span>
<a href="#l8.90"></a><span id="l8.90">                   RNPLib.rnp_key_get_primary_uid(</span>
<a href="#l8.91"></a><span id="l8.91">                     signerHandle,</span>
<a href="#l8.92"></a><span id="l8.92">                     signer_uid_str.address()</span>
<a href="#l8.93"></a><span id="l8.93">                   )</span>
<a href="#l8.94"></a><span id="l8.94">                 ) {</span>
<a href="#l8.95"></a><span id="l8.95">                   throw new Error(&quot;rnp_key_get_uid_at failed&quot;);</span>
<a href="#l8.96"></a><span id="l8.96">                 }</span>
<a href="#l8.97"></a><span id="l8.97">                 sigObj.userId = signer_uid_str.readString();</span>
<a href="#l8.98"></a><span id="l8.98">                 RNPLib.rnp_buffer_destroy(signer_uid_str);</span>
<a href="#l8.99"></a><span id="l8.99">                 sigObj.sigKnown = true;</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-                rList[id].sigList.push(sigObj);</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+                subList.sigList.push(sigObj);</span>
<a href="#l8.102"></a><span id="l8.102">                 RNPLib.rnp_key_handle_destroy(signerHandle);</span>
<a href="#l8.103"></a><span id="l8.103">               }</span>
<a href="#l8.104"></a><span id="l8.104">               RNPLib.rnp_signature_handle_destroy(sig_handle);</span>
<a href="#l8.105"></a><span id="l8.105">             }</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+            rList[id] = subList;</span>
<a href="#l8.107"></a><span id="l8.107">           }</span>
<a href="#l8.108"></a><span id="l8.108">         }</span>
<a href="#l8.109"></a><span id="l8.109"> </span>
<a href="#l8.110"></a><span id="l8.110">         RNPLib.rnp_uid_handle_destroy(uid_handle);</span>
<a href="#l8.111"></a><span id="l8.111">       }</span>
<a href="#l8.112"></a><span id="l8.112">     } catch (ex) {</span>
<a href="#l8.113"></a><span id="l8.113">       console.log(ex);</span>
<a href="#l8.114"></a><span id="l8.114">     } finally {</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineat">@@ -664,32 +671,45 @@ var RNP = {</span>
<a href="#l8.116"></a><span id="l8.116">       return false;</span>
<a href="#l8.117"></a><span id="l8.117">     }</span>
<a href="#l8.118"></a><span id="l8.118"> </span>
<a href="#l8.119"></a><span id="l8.119">     let sig = new RNPLib.rnp_op_verify_signature_t();</span>
<a href="#l8.120"></a><span id="l8.120">     if (RNPLib.rnp_op_verify_get_signature_at(verify_op, 0, sig.address())) {</span>
<a href="#l8.121"></a><span id="l8.121">       throw new Error(&quot;rnp_op_verify_get_signature_at failed&quot;);</span>
<a href="#l8.122"></a><span id="l8.122">     }</span>
<a href="#l8.123"></a><span id="l8.123"> </span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+    let sig_handle = new RNPLib.rnp_signature_handle_t();</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+    if (RNPLib.rnp_op_verify_signature_get_handle(sig, sig_handle.address())) {</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+      throw new Error(&quot;rnp_op_verify_signature_get_handle failed&quot;);</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+    }</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+    let sig_id_str = new ctypes.char.ptr();</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+    if (RNPLib.rnp_signature_get_keyid(sig_handle, sig_id_str.address())) {</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+      throw new Error(&quot;rnp_signature_get_keyid failed&quot;);</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+    }</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+    result.keyId = sig_id_str.readString();</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+    RNPLib.rnp_buffer_destroy(sig_id_str);</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+    RNPLib.rnp_signature_handle_destroy(sig_handle);</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+</span>
<a href="#l8.137"></a><span id="l8.137">     let sig_status = RNPLib.rnp_op_verify_signature_get_status(sig);</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-</span>
<a href="#l8.139"></a><span id="l8.139">     if (sig_status != RNPLib.RNP_SUCCESS &amp;&amp; !result.exitCode) {</span>
<a href="#l8.140"></a><span id="l8.140">       /* Don't allow a good exit code. Keep existing bad code. */</span>
<a href="#l8.141"></a><span id="l8.141">       result.exitCode = -1;</span>
<a href="#l8.142"></a><span id="l8.142">     }</span>
<a href="#l8.143"></a><span id="l8.143"> </span>
<a href="#l8.144"></a><span id="l8.144">     let query_times = true;</span>
<a href="#l8.145"></a><span id="l8.145">     let query_signer = true;</span>
<a href="#l8.146"></a><span id="l8.146"> </span>
<a href="#l8.147"></a><span id="l8.147">     switch (sig_status) {</span>
<a href="#l8.148"></a><span id="l8.148">       case RNPLib.RNP_SUCCESS:</span>
<a href="#l8.149"></a><span id="l8.149">         result.statusFlags |= EnigmailConstants.GOOD_SIGNATURE;</span>
<a href="#l8.150"></a><span id="l8.150">         break;</span>
<a href="#l8.151"></a><span id="l8.151">       case RNPLib.RNP_ERROR_KEY_NOT_FOUND:</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-        result.statusFlags |= EnigmailConstants.UNCERTAIN_SIGNATURE;</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+        result.statusFlags |=</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+          EnigmailConstants.UNCERTAIN_SIGNATURE | EnigmailConstants.NO_PUBKEY;</span>
<a href="#l8.155"></a><span id="l8.155">         query_signer = false;</span>
<a href="#l8.156"></a><span id="l8.156">         break;</span>
<a href="#l8.157"></a><span id="l8.157">       case RNPLib.RNP_ERROR_SIGNATURE_EXPIRED:</span>
<a href="#l8.158"></a><span id="l8.158">         result.statusFlags |= EnigmailConstants.EXPIRED_SIGNATURE;</span>
<a href="#l8.159"></a><span id="l8.159">         break;</span>
<a href="#l8.160"></a><span id="l8.160">       case RNPLib.RNP_ERROR_SIGNATURE_INVALID:</span>
<a href="#l8.161"></a><span id="l8.161">         result.statusFlags |= EnigmailConstants.BAD_SIGNATURE;</span>
<a href="#l8.162"></a><span id="l8.162">         break;</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineat">@@ -722,18 +742,16 @@ var RNP = {</span>
<a href="#l8.164"></a><span id="l8.164">       }</span>
<a href="#l8.165"></a><span id="l8.165"> </span>
<a href="#l8.166"></a><span id="l8.166">       let keyInfo = {};</span>
<a href="#l8.167"></a><span id="l8.167">       let ok = this.getKeyInfoFromHandle(ffi, key, keyInfo, true, false);</span>
<a href="#l8.168"></a><span id="l8.168">       if (!ok) {</span>
<a href="#l8.169"></a><span id="l8.169">         throw new Error(&quot;getKeyInfoFromHandle failed&quot;);</span>
<a href="#l8.170"></a><span id="l8.170">       }</span>
<a href="#l8.171"></a><span id="l8.171"> </span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-      result.keyId = keyInfo.keyId;</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-</span>
<a href="#l8.174"></a><span id="l8.174">       let fromMatchesAnyUid = false;</span>
<a href="#l8.175"></a><span id="l8.175">       let fromLower = fromAddr ? fromAddr.toLowerCase() : &quot;&quot;;</span>
<a href="#l8.176"></a><span id="l8.176"> </span>
<a href="#l8.177"></a><span id="l8.177">       for (let uid of keyInfo.userIds) {</span>
<a href="#l8.178"></a><span id="l8.178">         if (uid.type !== &quot;uid&quot;) {</span>
<a href="#l8.179"></a><span id="l8.179">           continue;</span>
<a href="#l8.180"></a><span id="l8.180">         }</span>
<a href="#l8.181"></a><span id="l8.181">         let split = {};</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineat">@@ -1018,27 +1036,34 @@ var RNP = {</span>
<a href="#l8.183"></a><span id="l8.183"> </span>
<a href="#l8.184"></a><span id="l8.184">   importToFFI(ffi, keyBlockStr, usePublic, useSecret) {</span>
<a href="#l8.185"></a><span id="l8.185">     let input_from_memory = new RNPLib.rnp_input_t();</span>
<a href="#l8.186"></a><span id="l8.186"> </span>
<a href="#l8.187"></a><span id="l8.187">     if (!keyBlockStr) {</span>
<a href="#l8.188"></a><span id="l8.188">       throw new Error(&quot;no keyBlockStr parameter in importToFFI&quot;);</span>
<a href="#l8.189"></a><span id="l8.189">     }</span>
<a href="#l8.190"></a><span id="l8.190"> </span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+    if (typeof keyBlockStr != &quot;string&quot;) {</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+      throw new Error(</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+        &quot;keyBlockStr of unepected type importToFFI: %o&quot;,</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+        keyBlockStr</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+      );</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+    }</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+</span>
<a href="#l8.198"></a><span id="l8.198">     let arr = [];</span>
<a href="#l8.199"></a><span id="l8.199">     for (let i = 0; i &lt; keyBlockStr.length; i++) {</span>
<a href="#l8.200"></a><span id="l8.200">       arr[i] = keyBlockStr.charCodeAt(i);</span>
<a href="#l8.201"></a><span id="l8.201">     }</span>
<a href="#l8.202"></a><span id="l8.202">     var key_array = ctypes.uint8_t.array()(arr);</span>
<a href="#l8.203"></a><span id="l8.203"> </span>
<a href="#l8.204"></a><span id="l8.204">     if (</span>
<a href="#l8.205"></a><span id="l8.205">       RNPLib.rnp_input_from_memory(</span>
<a href="#l8.206"></a><span id="l8.206">         input_from_memory.address(),</span>
<a href="#l8.207"></a><span id="l8.207">         key_array,</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineminus">-        keyBlockStr.length,</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+        key_array.length,</span>
<a href="#l8.210"></a><span id="l8.210">         false</span>
<a href="#l8.211"></a><span id="l8.211">       )</span>
<a href="#l8.212"></a><span id="l8.212">     ) {</span>
<a href="#l8.213"></a><span id="l8.213">       throw new Error(&quot;rnp_input_from_memory failed&quot;);</span>
<a href="#l8.214"></a><span id="l8.214">     }</span>
<a href="#l8.215"></a><span id="l8.215"> </span>
<a href="#l8.216"></a><span id="l8.216">     let jsonInfo = new ctypes.char.ptr();</span>
<a href="#l8.217"></a><span id="l8.217"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/rnpLib.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/rnpLib.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -986,16 +986,24 @@ function enableRNPLibJS() {</span>
<a href="#l9.4"></a><span id="l9.4">       &quot;rnp_op_verify_get_signature_at&quot;,</span>
<a href="#l9.5"></a><span id="l9.5">       abi,</span>
<a href="#l9.6"></a><span id="l9.6">       rnp_result_t,</span>
<a href="#l9.7"></a><span id="l9.7">       rnp_op_verify_t,</span>
<a href="#l9.8"></a><span id="l9.8">       ctypes.size_t,</span>
<a href="#l9.9"></a><span id="l9.9">       rnp_op_verify_signature_t.ptr</span>
<a href="#l9.10"></a><span id="l9.10">     ),</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+    rnp_op_verify_signature_get_handle: librnp.declare(</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+      &quot;rnp_op_verify_signature_get_handle&quot;,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+      abi,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+      rnp_result_t,</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+      rnp_op_verify_signature_t,</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+      rnp_signature_handle_t.ptr</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+    ),</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+</span>
<a href="#l9.20"></a><span id="l9.20">     rnp_op_verify_signature_get_status: librnp.declare(</span>
<a href="#l9.21"></a><span id="l9.21">       &quot;rnp_op_verify_signature_get_status&quot;,</span>
<a href="#l9.22"></a><span id="l9.22">       abi,</span>
<a href="#l9.23"></a><span id="l9.23">       rnp_result_t,</span>
<a href="#l9.24"></a><span id="l9.24">       rnp_op_verify_signature_t</span>
<a href="#l9.25"></a><span id="l9.25">     ),</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27">     rnp_op_verify_signature_get_key: librnp.declare(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/sqliteDb.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/sqliteDb.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -170,41 +170,43 @@ var PgpSqliteDb2 = {</span>
<a href="#l10.4"></a><span id="l10.4"> var EnigmailSqliteDb = {</span>
<a href="#l10.5"></a><span id="l10.5">   /**</span>
<a href="#l10.6"></a><span id="l10.6">    * Provide an sqlite conection object asynchronously, retrying if needed</span>
<a href="#l10.7"></a><span id="l10.7">    *</span>
<a href="#l10.8"></a><span id="l10.8">    * @return {Promise&lt;Sqlite Connection&gt;}: the Sqlite database object</span>
<a href="#l10.9"></a><span id="l10.9">    */</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">   openDatabase() {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    /*</span>
<a href="#l10.13"></a><span id="l10.13">     EnigmailLog.DEBUG(&quot;sqliteDb.jsm: openDatabase()\n&quot;);</span>
<a href="#l10.14"></a><span id="l10.14">     return new Promise((resolve, reject) =&gt; {</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-      openDatabaseConn(&quot;enigmail.sqlite&quot;, resolve, reject, 100, Date.now() + 10000);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+      openDatabaseConn(</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+        &quot;enigmail.sqlite&quot;,</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+        resolve,</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+        reject,</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+        100,</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+        Date.now() + 10000</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+      );</span>
<a href="#l10.23"></a><span id="l10.23">     });</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-    */</span>
<a href="#l10.25"></a><span id="l10.25">   },</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27">   async checkDatabaseStructure() {</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-    /*</span>
<a href="#l10.29"></a><span id="l10.29">     EnigmailLog.DEBUG(`sqliteDb.jsm: checkDatabaseStructure()\n`);</span>
<a href="#l10.30"></a><span id="l10.30">     let conn;</span>
<a href="#l10.31"></a><span id="l10.31">     try {</span>
<a href="#l10.32"></a><span id="l10.32">       conn = await this.openDatabase();</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-      await checkAutocryptTable(conn);</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+      //await checkAutocryptTable(conn);</span>
<a href="#l10.35"></a><span id="l10.35">       await checkWkdTable(conn);</span>
<a href="#l10.36"></a><span id="l10.36">       conn.close();</span>
<a href="#l10.37"></a><span id="l10.37">       EnigmailLog.DEBUG(`sqliteDb.jsm: checkDatabaseStructure - success\n`);</span>
<a href="#l10.38"></a><span id="l10.38">     } catch (ex) {</span>
<a href="#l10.39"></a><span id="l10.39">       EnigmailLog.ERROR(`sqliteDb.jsm: checkDatabaseStructure: ERROR: ${ex}\n`);</span>
<a href="#l10.40"></a><span id="l10.40">       if (conn) {</span>
<a href="#l10.41"></a><span id="l10.41">         conn.close();</span>
<a href="#l10.42"></a><span id="l10.42">       }</span>
<a href="#l10.43"></a><span id="l10.43">     }</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-    */</span>
<a href="#l10.45"></a><span id="l10.45">   },</span>
<a href="#l10.46"></a><span id="l10.46"> };</span>
<a href="#l10.47"></a><span id="l10.47"> </span>
<a href="#l10.48"></a><span id="l10.48"> /**</span>
<a href="#l10.49"></a><span id="l10.49">  * use a promise to open the Enigmail database.</span>
<a href="#l10.50"></a><span id="l10.50">  *</span>
<a href="#l10.51"></a><span id="l10.51">  * it's possible that there will be an NS_ERROR_STORAGE_BUSY</span>
<a href="#l10.52"></a><span id="l10.52">  * so we're willing to retry for a little while.</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineat">@@ -365,43 +367,39 @@ async function createAutocryptTable(conn</span>
<a href="#l10.54"></a><span id="l10.54"> </span>
<a href="#l10.55"></a><span id="l10.55"> /**</span>
<a href="#l10.56"></a><span id="l10.56">  * Ensure that the database has the wkd_lookup_timestamp table.</span>
<a href="#l10.57"></a><span id="l10.57">  *</span>
<a href="#l10.58"></a><span id="l10.58">  * @param connection: Object - SQLite connection</span>
<a href="#l10.59"></a><span id="l10.59">  *</span>
<a href="#l10.60"></a><span id="l10.60">  * @return Promise</span>
<a href="#l10.61"></a><span id="l10.61">  */</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-/*</span>
<a href="#l10.63"></a><span id="l10.63"> async function checkWkdTable(connection) {</span>
<a href="#l10.64"></a><span id="l10.64">   EnigmailLog.DEBUG(&quot;sqliteDB.jsm: checkWkdTable()\n&quot;);</span>
<a href="#l10.65"></a><span id="l10.65"> </span>
<a href="#l10.66"></a><span id="l10.66">   try {</span>
<a href="#l10.67"></a><span id="l10.67">     let exists = await connection.tableExists(&quot;wkd_lookup_timestamp&quot;);</span>
<a href="#l10.68"></a><span id="l10.68">     EnigmailLog.DEBUG(&quot;sqliteDB.jsm: checkWkdTable - success\n&quot;);</span>
<a href="#l10.69"></a><span id="l10.69">     if (!exists) {</span>
<a href="#l10.70"></a><span id="l10.70">       await createWkdTable(connection);</span>
<a href="#l10.71"></a><span id="l10.71">     }</span>
<a href="#l10.72"></a><span id="l10.72">   } catch (error) {</span>
<a href="#l10.73"></a><span id="l10.73">     EnigmailLog.DEBUG(&quot;sqliteDB.jsm: checkWkdTable - error\n&quot;);</span>
<a href="#l10.74"></a><span id="l10.74">     throw error;</span>
<a href="#l10.75"></a><span id="l10.75">   }</span>
<a href="#l10.76"></a><span id="l10.76"> }</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-*/</span>
<a href="#l10.78"></a><span id="l10.78"> </span>
<a href="#l10.79"></a><span id="l10.79"> /**</span>
<a href="#l10.80"></a><span id="l10.80">  * Create the &quot;wkd_lookup_timestamp&quot; table.</span>
<a href="#l10.81"></a><span id="l10.81">  *</span>
<a href="#l10.82"></a><span id="l10.82">  * @param connection: Object - SQLite connection</span>
<a href="#l10.83"></a><span id="l10.83">  *</span>
<a href="#l10.84"></a><span id="l10.84">  * @return Promise</span>
<a href="#l10.85"></a><span id="l10.85">  */</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-/*</span>
<a href="#l10.87"></a><span id="l10.87"> function createWkdTable(connection) {</span>
<a href="#l10.88"></a><span id="l10.88">   EnigmailLog.DEBUG(&quot;sqliteDB.jsm: createWkdTable()\n&quot;);</span>
<a href="#l10.89"></a><span id="l10.89"> </span>
<a href="#l10.90"></a><span id="l10.90">   return connection.execute(</span>
<a href="#l10.91"></a><span id="l10.91">     &quot;create table wkd_lookup_timestamp (&quot; +</span>
<a href="#l10.92"></a><span id="l10.92">     &quot;email text not null primary key, &quot; + // email address of correspondent</span>
<a href="#l10.93"></a><span id="l10.93">       &quot;last_seen integer);&quot;</span>
<a href="#l10.94"></a><span id="l10.94">   ); // timestamp of last mail received for the email/type combination</span>
<a href="#l10.95"></a><span id="l10.95"> }</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-*/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/uidHelper.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/uidHelper.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -18,16 +18,20 @@ var uidHelper = {</span>
<a href="#l11.4"></a><span id="l11.4">   getPartsFromUidStr(uid, resultObj) {</span>
<a href="#l11.5"></a><span id="l11.5">     // RegExp strategy:</span>
<a href="#l11.6"></a><span id="l11.6">     // Search until the first ( or &lt; character, use that as Name.</span>
<a href="#l11.7"></a><span id="l11.7">     // Then search for the () characters, allow any characters until ).</span>
<a href="#l11.8"></a><span id="l11.8">     // Do the same for &lt;&gt;.</span>
<a href="#l11.9"></a><span id="l11.9">     // No characters are allowed between a closing ) and opening &lt;.</span>
<a href="#l11.10"></a><span id="l11.10">     // All characters after a trailing &gt; are ignored.</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+    if (!uid) {</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+      return false;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+    }</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+</span>
<a href="#l11.16"></a><span id="l11.16">     let result = uid.match(/^ *([^(&lt;]*)? *(\([^)]*\))? *(&lt;[^&gt;]*&gt;)?/);</span>
<a href="#l11.17"></a><span id="l11.17">     if (result.length != 4) {</span>
<a href="#l11.18"></a><span id="l11.18">       return false;</span>
<a href="#l11.19"></a><span id="l11.19">     }</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21">     resultObj.name = result[1].trim();</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23">     resultObj.comment = &quot;&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/wkdLookup.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/wkdLookup.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -18,16 +18,23 @@ const { EnigmailZBase32 } = ChromeUtils.</span>
<a href="#l12.4"></a><span id="l12.4">   &quot;chrome://openpgp/content/modules/zbase32.jsm&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> );</span>
<a href="#l12.6"></a><span id="l12.6"> const { EnigmailData } = ChromeUtils.import(</span>
<a href="#l12.7"></a><span id="l12.7">   &quot;chrome://openpgp/content/modules/data.jsm&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> );</span>
<a href="#l12.9"></a><span id="l12.9"> const { EnigmailSqliteDb } = ChromeUtils.import(</span>
<a href="#l12.10"></a><span id="l12.10">   &quot;chrome://openpgp/content/modules/sqliteDb.jsm&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> );</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+var { EnigmailKey } = ChromeUtils.import(</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  &quot;chrome://openpgp/content/modules/key.jsm&quot;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+);</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+var EnigmailKeyRing = ChromeUtils.import(</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+  &quot;chrome://openpgp/content/modules/keyRing.jsm&quot;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+).EnigmailKeyRing;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+var { DNS } = ChromeUtils.import(&quot;resource:///modules/DNS.jsm&quot;);</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20"> Cu.importGlobalProperties([&quot;fetch&quot;]);</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22"> // Those domains are not expected to have WKD:</span>
<a href="#l12.23"></a><span id="l12.23"> var BLACKLIST_DOMAINS = [</span>
<a href="#l12.24"></a><span id="l12.24">   /* Default domains included */</span>
<a href="#l12.25"></a><span id="l12.25">   &quot;aol.com&quot;,</span>
<a href="#l12.26"></a><span id="l12.26">   &quot;att.net&quot;,</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineat">@@ -268,17 +275,21 @@ var EnigmailWkdLookup = {</span>
<a href="#l12.28"></a><span id="l12.28">                 let gotKeys = [];</span>
<a href="#l12.29"></a><span id="l12.29">                 for (let i = 0; i &lt; dataArr.length; i++) {</span>
<a href="#l12.30"></a><span id="l12.30">                   if (dataArr[i] !== null) {</span>
<a href="#l12.31"></a><span id="l12.31">                     gotKeys.push(dataArr[i]);</span>
<a href="#l12.32"></a><span id="l12.32">                   }</span>
<a href="#l12.33"></a><span id="l12.33">                 }</span>
<a href="#l12.34"></a><span id="l12.34"> </span>
<a href="#l12.35"></a><span id="l12.35">                 if (gotKeys.length &gt; 0) {</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-                  importDownloadedKeys(gotKeys);</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+                  if (gotKeys.length == 1) {</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+                    importOneDownloadedKey(gotKeys[0]);</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+                  } else {</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+                    importDownloadedKeys(gotKeys);</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+                  }</span>
<a href="#l12.42"></a><span id="l12.42">                   resolve(true);</span>
<a href="#l12.43"></a><span id="l12.43">                 } else {</span>
<a href="#l12.44"></a><span id="l12.44">                   resolve(false);</span>
<a href="#l12.45"></a><span id="l12.45">                 }</span>
<a href="#l12.46"></a><span id="l12.46">               }</span>
<a href="#l12.47"></a><span id="l12.47">             });</span>
<a href="#l12.48"></a><span id="l12.48">           } else {</span>
<a href="#l12.49"></a><span id="l12.49">             resolve(false);</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineat">@@ -530,50 +541,74 @@ function timeForRecheck(connection, emai</span>
<a href="#l12.51"></a><span id="l12.51"> /**</span>
<a href="#l12.52"></a><span id="l12.52">  * Import downloaded keys</span>
<a href="#l12.53"></a><span id="l12.53">  *</span>
<a href="#l12.54"></a><span id="l12.54">  * @param {Array of String}: ASCII armored or binary string</span>
<a href="#l12.55"></a><span id="l12.55">  *</span>
<a href="#l12.56"></a><span id="l12.56">  * no return value</span>
<a href="#l12.57"></a><span id="l12.57">  */</span>
<a href="#l12.58"></a><span id="l12.58"> function importDownloadedKeys(keysArr) {</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-  throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-  /*</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-  EnigmailLog.DEBUG(&quot;wkdLookup.jsm: importDownloadedKeys(&quot; + keysArr.length + &quot;)\n&quot;);</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+  EnigmailLog.DEBUG(</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+    &quot;wkdLookup.jsm: importDownloadedKeys(&quot; + keysArr.length + &quot;)\n&quot;</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+  );</span>
<a href="#l12.66"></a><span id="l12.66"> </span>
<a href="#l12.67"></a><span id="l12.67">   let keyData = &quot;&quot;;</span>
<a href="#l12.68"></a><span id="l12.68">   let domainArr = [];</span>
<a href="#l12.69"></a><span id="l12.69">   for (let k in keysArr) {</span>
<a href="#l12.70"></a><span id="l12.70">     if (keysArr[k]) {</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-      if (keysArr[k].keyData.search(/^-----BEGIN PGP PUBLIC KEY BLOCK-----/) &lt; 0) {</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+      if (</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+        keysArr[k].keyData.search(/^-----BEGIN PGP PUBLIC KEY BLOCK-----/) &lt; 0</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+      ) {</span>
<a href="#l12.75"></a><span id="l12.75">         try {</span>
<a href="#l12.76"></a><span id="l12.76">           // TODO: need a MPL version of bytesToArmor</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-          keyData += EnigmailOpenPGP.enigmailFuncs.bytesToArmor(EnigmailOpenPGP.armor.public_key, keysArr[k].keyData);</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+          throw new Error(&quot;WKD importDownloadedKeys dont' have bytesToArmor&quot;);</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+          /*</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+          keyData += EnigmailOpenPGP.enigmailFuncs.bytesToArmor(</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+            EnigmailOpenPGP.armor.public_key,</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+            keysArr[k].keyData</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+          );</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+          */</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+        } catch (ex) {</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+          EnigmailLog.DEBUG(</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+            &quot;wkdLookup.jsm: importDownloadedKeys: exeption=&quot; + ex + &quot;\n&quot;</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+          );</span>
<a href="#l12.89"></a><span id="l12.89">         }</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-        catch (ex) {</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-          EnigmailLog.DEBUG(&quot;wkdLookup.jsm: importDownloadedKeys: exeption=&quot; + ex + &quot;\n&quot;);</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-        }</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineminus">-      }</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-      else {</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+      } else {</span>
<a href="#l12.96"></a><span id="l12.96">         keyData += keysArr[k].keyData;</span>
<a href="#l12.97"></a><span id="l12.97">       }</span>
<a href="#l12.98"></a><span id="l12.98"> </span>
<a href="#l12.99"></a><span id="l12.99">       domainArr.push(keysArr[k].email.replace(/^.*@/, &quot;@&quot;));</span>
<a href="#l12.100"></a><span id="l12.100">     }</span>
<a href="#l12.101"></a><span id="l12.101">   }</span>
<a href="#l12.102"></a><span id="l12.102"> </span>
<a href="#l12.103"></a><span id="l12.103">   let keyList = EnigmailKey.getKeyListFromKeyBlock(keyData, {}, false);</span>
<a href="#l12.104"></a><span id="l12.104"> </span>
<a href="#l12.105"></a><span id="l12.105">   for (let k in keyList) {</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-    EnigmailLog.DEBUG(&quot;wkdLookup.jsm: importDownloadedKeys: fpr=&quot; + keyList[k].fpr + &quot;\n&quot;);</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+    EnigmailLog.DEBUG(</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+      &quot;wkdLookup.jsm: importDownloadedKeys: fpr=&quot; + keyList[k].fpr + &quot;\n&quot;</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+    );</span>
<a href="#l12.110"></a><span id="l12.110">   }</span>
<a href="#l12.111"></a><span id="l12.111"> </span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-  EnigmailKeyRing.importKey(null, false, keyData, false, &quot;&quot;, {}, {}, false, domainArr);</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineminus">-  */</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+  EnigmailKeyRing.importKey(</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+    null,</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+    false,</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+    keyData,</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+    false,</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+    &quot;&quot;,</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+    {},</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+    {},</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+    false,</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+    domainArr</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+  );</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+}</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+function importOneDownloadedKey(key) {</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+  EnigmailLog.DEBUG(&quot;wkdLookup.jsm: importOneDownloadedKey\n&quot;);</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+  //let keyList = EnigmailKey.getKeyListFromKeyBlock(key.keyData, {}, false);</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+  EnigmailKeyRing.importKey(null, true, key.keyData, true, &quot;&quot;, {}, {}, false);</span>
<a href="#l12.131"></a><span id="l12.131"> }</span>
<a href="#l12.132"></a><span id="l12.132"> </span>
<a href="#l12.133"></a><span id="l12.133"> /**</span>
<a href="#l12.134"></a><span id="l12.134">  * Get special URLs for specific sites that don't use WKD, but still provide</span>
<a href="#l12.135"></a><span id="l12.135">  * public keys of their users in</span>
<a href="#l12.136"></a><span id="l12.136">  *</span>
<a href="#l12.137"></a><span id="l12.137">  * @param {String}: emailAddr: email address in lowercase</span>
<a href="#l12.138"></a><span id="l12.138">  *</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineat">@@ -587,27 +622,25 @@ async function getSiteSpecificUrl(emailA</span>
<a href="#l12.140"></a><span id="l12.140">     case &quot;protonmail.ch&quot;:</span>
<a href="#l12.141"></a><span id="l12.141">     case &quot;protonmail.com&quot;:</span>
<a href="#l12.142"></a><span id="l12.142">     case &quot;pm.me&quot;:</span>
<a href="#l12.143"></a><span id="l12.143">       url =</span>
<a href="#l12.144"></a><span id="l12.144">         &quot;https://api.protonmail.ch/pks/lookup?op=get&amp;options=mr&amp;search=&quot; +</span>
<a href="#l12.145"></a><span id="l12.145">         escape(emailAddr);</span>
<a href="#l12.146"></a><span id="l12.146">       break;</span>
<a href="#l12.147"></a><span id="l12.147">   }</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+  if (!url) {</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+    let records = await DNS.mx(domain);</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+    const mxHosts = records.filter(record =&gt; record.host);</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+    console.debug(mxHosts);</span>
<a href="#l12.152"></a><span id="l12.152"> </span>
<a href="#l12.153"></a><span id="l12.153" class="difflineminus">-  if (!url) {</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineminus">-    throw new Error(</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineminus">-      &quot;EnigmailWkdLookup getSiteSpecificUrl with DNS not implemented&quot;</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-    );</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineminus">-    /*</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineminus">-    try {</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineminus">-      let mxHosts = await EnigmailDns.lookup(&quot;MX&quot;, domain);</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineminus">-      if (mxHosts &amp; mxHosts.indexOf(&quot;mail.protonmail.ch&quot;) &gt;= 0 ||</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineminus">-        mxHosts.indexOf(&quot;mailsec.protonmail.ch&quot;) &gt;= 0) {</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineminus">-        url = &quot;https://api.protonmail.ch/pks/lookup?op=get&amp;options=mr&amp;search=&quot; + escape(emailAddr);</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineminus">-      }</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+    if (</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+      mxHosts &amp;&amp;</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+      (mxHosts.includes(&quot;mail.protonmail.ch&quot;) ||</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+        mxHosts.includes(&quot;mailsec.protonmail.ch&quot;))</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+    ) {</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+      url =</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+        &quot;https://api.protonmail.ch/pks/lookup?op=get&amp;options=mr&amp;search=&quot; +</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+        escape(emailAddr);</span>
<a href="#l12.172"></a><span id="l12.172">     }</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineminus">-    catch (ex) {}</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineminus">-    */</span>
<a href="#l12.175"></a><span id="l12.175">   }</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineminus">-</span>
<a href="#l12.177"></a><span id="l12.177">   return url;</span>
<a href="#l12.178"></a><span id="l12.178"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/extensions/openpgp/content/strings/bond.dtd</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/strings/bond.dtd</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -7,8 +7,13 @@</span>
<a href="#l13.4"></a><span id="l13.4"> &lt;!ENTITY enigmail.ctxVerifyAtt.label                &quot;Verify signature&quot;&gt;</span>
<a href="#l13.5"></a><span id="l13.5"> &lt;!ENTITY enigmail.ctxDecryptOpen.accesskey          &quot;D&quot;&gt;</span>
<a href="#l13.6"></a><span id="l13.6"> &lt;!ENTITY enigmail.ctxDecryptSave.accesskey          &quot;C&quot;&gt;</span>
<a href="#l13.7"></a><span id="l13.7"> &lt;!ENTITY enigmail.ctxImportKey.accesskey            &quot;I&quot;&gt;</span>
<a href="#l13.8"></a><span id="l13.8"> &lt;!ENTITY enigmail.ctxVerifyAtt.accesskey            &quot;V&quot;&gt;</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> &lt;!ENTITY enigmail.hasSenderKey.label                &quot;This message claims to contain the sender's OpenPGP public key.&quot;&gt;</span>
<a href="#l13.11"></a><span id="l13.11"> &lt;!ENTITY enigmail.importSenderKey.label             &quot;Import&quot;&gt;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+&lt;!ENTITY searchKeysOpenPGP.label                    &quot;Discover OpenPGP Key&quot;&gt;</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+&lt;!ENTITY enigmail.missingSignatureKey.label         &quot;Message was signed with a key that you don't have yet&quot;&gt;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+&lt;!ENTITY enigmail.searchSignatureKey.label          &quot;Discover&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/extensions/openpgp/content/strings/enigmail.properties</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/strings/enigmail.properties</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -511,17 +511,17 @@ revokeUidFailed=Revoking the user ID %S </span>
<a href="#l14.4"></a><span id="l14.4"> revokeUidOK=User ID %S was revoked successfully. If your key is available on a key server, it is recommended to re-upload it, so that others can see the revocation.</span>
<a href="#l14.5"></a><span id="l14.5"> revokeUidQuestion=Do you really want to revoke the user ID %S?</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7"> # Strings in enigmailKeyImportInfo.xhtml</span>
<a href="#l14.8"></a><span id="l14.8"> importInfoTitle=SUCCESS! Keys imported</span>
<a href="#l14.9"></a><span id="l14.9"> importInfoBits=Bits</span>
<a href="#l14.10"></a><span id="l14.10"> importInfoCreated=Created</span>
<a href="#l14.11"></a><span id="l14.11"> importInfoFpr=Fingerprint</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-importInfoDetails=(Details)</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+importInfoDetails2=View Details and manage key acceptance</span>
<a href="#l14.14"></a><span id="l14.14"> importInfoNoKeys=No keys imported.</span>
<a href="#l14.15"></a><span id="l14.15"> </span>
<a href="#l14.16"></a><span id="l14.16"> # Strings in enigmailKeyDetailsDlg.xhtml</span>
<a href="#l14.17"></a><span id="l14.17"> keyTypePublic=public key</span>
<a href="#l14.18"></a><span id="l14.18"> keyTypePrimary=primary key</span>
<a href="#l14.19"></a><span id="l14.19"> keyTypeSubkey=subkey</span>
<a href="#l14.20"></a><span id="l14.20"> keyTypePair2=personal key (secret key and public key)</span>
<a href="#l14.21"></a><span id="l14.21"> keyExpiryNever=never</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeyImportInfo.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -100,17 +100,17 @@ function onLoad() {</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5">   EnigmailEvents.dispatchEvent(resizeDlg, 0);</span>
<a href="#l15.6"></a><span id="l15.6"> }</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> function buildKeyGroupBox(keyObj) {</span>
<a href="#l15.9"></a><span id="l15.9">   let i,</span>
<a href="#l15.10"></a><span id="l15.10">     groupBox = document.createXULElement(&quot;vbox&quot;),</span>
<a href="#l15.11"></a><span id="l15.11">     vbox = document.createXULElement(&quot;hbox&quot;),</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    caption = document.createXULElement(&quot;image&quot;),</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+    //caption = document.createXULElement(&quot;image&quot;),</span>
<a href="#l15.14"></a><span id="l15.14">     userid = document.createXULElement(&quot;label&quot;),</span>
<a href="#l15.15"></a><span id="l15.15">     infoGrid = document.createXULElement(&quot;grid&quot;),</span>
<a href="#l15.16"></a><span id="l15.16">     infoColumns = document.createXULElement(&quot;columns&quot;),</span>
<a href="#l15.17"></a><span id="l15.17">     infoColId = document.createXULElement(&quot;column&quot;),</span>
<a href="#l15.18"></a><span id="l15.18">     infoColDate = document.createXULElement(&quot;column&quot;),</span>
<a href="#l15.19"></a><span id="l15.19">     infoRows = document.createXULElement(&quot;rows&quot;),</span>
<a href="#l15.20"></a><span id="l15.20">     infoRowHead = document.createXULElement(&quot;row&quot;),</span>
<a href="#l15.21"></a><span id="l15.21">     infoRowBody = document.createXULElement(&quot;row&quot;),</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -126,39 +126,32 @@ function buildKeyGroupBox(keyObj) {</span>
<a href="#l15.23"></a><span id="l15.23">     fprRows = document.createXULElement(&quot;rows&quot;),</span>
<a href="#l15.24"></a><span id="l15.24">     fprRow1 = document.createXULElement(&quot;row&quot;),</span>
<a href="#l15.25"></a><span id="l15.25">     fprRow2 = document.createXULElement(&quot;row&quot;);</span>
<a href="#l15.26"></a><span id="l15.26"> </span>
<a href="#l15.27"></a><span id="l15.27">   groupBox.setAttribute(&quot;class&quot;, &quot;enigmailGroupbox&quot;);</span>
<a href="#l15.28"></a><span id="l15.28">   userid.setAttribute(&quot;value&quot;, keyObj.userId);</span>
<a href="#l15.29"></a><span id="l15.29">   userid.setAttribute(&quot;class&quot;, &quot;enigmailKeyImportUserId&quot;);</span>
<a href="#l15.30"></a><span id="l15.30">   vbox.setAttribute(&quot;align&quot;, &quot;start&quot;);</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-  caption.setAttribute(&quot;class&quot;, &quot;enigmailKeyImportCaption&quot;);</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+  //caption.setAttribute(&quot;class&quot;, &quot;enigmailKeyImportCaption&quot;);</span>
<a href="#l15.33"></a><span id="l15.33">   infoLabelH1.setAttribute(&quot;value&quot;, EnigmailLocale.getString(&quot;importInfoBits&quot;));</span>
<a href="#l15.34"></a><span id="l15.34">   infoLabelH2.setAttribute(</span>
<a href="#l15.35"></a><span id="l15.35">     &quot;value&quot;,</span>
<a href="#l15.36"></a><span id="l15.36">     EnigmailLocale.getString(&quot;importInfoCreated&quot;)</span>
<a href="#l15.37"></a><span id="l15.37">   );</span>
<a href="#l15.38"></a><span id="l15.38">   infoLabelH3.setAttribute(&quot;value&quot;, &quot;&quot;);</span>
<a href="#l15.39"></a><span id="l15.39">   infoLabelB1.setAttribute(&quot;value&quot;, keyObj.keySize);</span>
<a href="#l15.40"></a><span id="l15.40">   infoLabelB2.setAttribute(&quot;value&quot;, keyObj.created);</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-  infoLabelB3.setAttribute(</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-    &quot;value&quot;,</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-    EnigmailLocale.getString(&quot;importInfoDetails&quot;)</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-  );</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-  infoLabelB3.setAttribute(&quot;keyid&quot;, keyObj.keyId);</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-  infoLabelB3.setAttribute(&quot;class&quot;, &quot;enigmailKeyImportDetails&quot;);</span>
<a href="#l15.47"></a><span id="l15.47"> </span>
<a href="#l15.48"></a><span id="l15.48">   infoRowHead.appendChild(infoLabelH1);</span>
<a href="#l15.49"></a><span id="l15.49">   infoRowHead.appendChild(infoLabelH2);</span>
<a href="#l15.50"></a><span id="l15.50">   infoRowHead.appendChild(infoLabelH3);</span>
<a href="#l15.51"></a><span id="l15.51">   infoRowHead.setAttribute(&quot;class&quot;, &quot;enigmailKeyImportHeader&quot;);</span>
<a href="#l15.52"></a><span id="l15.52">   infoRowBody.appendChild(infoLabelB1);</span>
<a href="#l15.53"></a><span id="l15.53">   infoRowBody.appendChild(infoLabelB2);</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-  infoRowBody.appendChild(infoLabelB3);</span>
<a href="#l15.55"></a><span id="l15.55">   infoRows.appendChild(infoRowHead);</span>
<a href="#l15.56"></a><span id="l15.56">   infoRows.appendChild(infoRowBody);</span>
<a href="#l15.57"></a><span id="l15.57">   infoColumns.appendChild(infoColId);</span>
<a href="#l15.58"></a><span id="l15.58">   infoColumns.appendChild(infoColDate);</span>
<a href="#l15.59"></a><span id="l15.59">   infoGrid.appendChild(infoColumns);</span>
<a href="#l15.60"></a><span id="l15.60">   infoGrid.appendChild(infoRows);</span>
<a href="#l15.61"></a><span id="l15.61"> </span>
<a href="#l15.62"></a><span id="l15.62">   fprLabel.setAttribute(&quot;value&quot;, EnigmailLocale.getString(&quot;importInfoFpr&quot;));</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineat">@@ -173,23 +166,31 @@ function buildKeyGroupBox(keyObj) {</span>
<a href="#l15.64"></a><span id="l15.64">       fprRow2.appendChild(label);</span>
<a href="#l15.65"></a><span id="l15.65">     }</span>
<a href="#l15.66"></a><span id="l15.66">   }</span>
<a href="#l15.67"></a><span id="l15.67"> </span>
<a href="#l15.68"></a><span id="l15.68">   fprRows.appendChild(fprRow1);</span>
<a href="#l15.69"></a><span id="l15.69">   fprRows.appendChild(fprRow2);</span>
<a href="#l15.70"></a><span id="l15.70">   fprGrid.appendChild(fprColumns);</span>
<a href="#l15.71"></a><span id="l15.71">   fprGrid.appendChild(fprRows);</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-  vbox.appendChild(caption);</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+  //vbox.appendChild(caption);</span>
<a href="#l15.74"></a><span id="l15.74">   groupBox.appendChild(vbox);</span>
<a href="#l15.75"></a><span id="l15.75">   groupBox.appendChild(userid);</span>
<a href="#l15.76"></a><span id="l15.76">   groupBox.appendChild(infoGrid);</span>
<a href="#l15.77"></a><span id="l15.77">   groupBox.appendChild(fprLabel);</span>
<a href="#l15.78"></a><span id="l15.78">   groupBox.appendChild(fprGrid);</span>
<a href="#l15.79"></a><span id="l15.79"> </span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+  infoLabelB3.setAttribute(</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+    &quot;value&quot;,</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+    EnigmailLocale.getString(&quot;importInfoDetails2&quot;)</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+  );</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+  infoLabelB3.setAttribute(&quot;keyid&quot;, keyObj.keyId);</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+  infoLabelB3.setAttribute(&quot;class&quot;, &quot;enigmailKeyImportDetails&quot;);</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+  groupBox.appendChild(infoLabelB3);</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+</span>
<a href="#l15.88"></a><span id="l15.88">   return groupBox;</span>
<a href="#l15.89"></a><span id="l15.89"> }</span>
<a href="#l15.90"></a><span id="l15.90"> </span>
<a href="#l15.91"></a><span id="l15.91"> function resizeDlg() {</span>
<a href="#l15.92"></a><span id="l15.92">   var txt = document.getElementById(&quot;keyInfo&quot;);</span>
<a href="#l15.93"></a><span id="l15.93">   var box = document.getElementById(&quot;outerbox&quot;);</span>
<a href="#l15.94"></a><span id="l15.94"> </span>
<a href="#l15.95"></a><span id="l15.95">   var deltaWidth = window.outerWidth - box.clientWidth;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -81,16 +81,22 @@ var EnigmailStreams = ChromeUtils.import</span>
<a href="#l16.4"></a><span id="l16.4">   &quot;chrome://openpgp/content/modules/streams.jsm&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> ).EnigmailStreams;</span>
<a href="#l16.6"></a><span id="l16.6"> var EnigmailEvents = ChromeUtils.import(</span>
<a href="#l16.7"></a><span id="l16.7">   &quot;chrome://openpgp/content/modules/events.jsm&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> ).EnigmailEvents;</span>
<a href="#l16.9"></a><span id="l16.9"> var EnigmailKeyRing = ChromeUtils.import(</span>
<a href="#l16.10"></a><span id="l16.10">   &quot;chrome://openpgp/content/modules/keyRing.jsm&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> ).EnigmailKeyRing;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+var EnigmailKeyServer = ChromeUtils.import(</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+  &quot;chrome://openpgp/content/modules/keyserver.jsm&quot;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+).EnigmailKeyServer;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+var { EnigmailKeyserverURIs } = ChromeUtils.import(</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+  &quot;chrome://openpgp/content/modules/keyserverUris.jsm&quot;</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+);</span>
<a href="#l16.18"></a><span id="l16.18"> var EnigmailDecryption = ChromeUtils.import(</span>
<a href="#l16.19"></a><span id="l16.19">   &quot;chrome://openpgp/content/modules/decryption.jsm&quot;</span>
<a href="#l16.20"></a><span id="l16.20"> ).EnigmailDecryption;</span>
<a href="#l16.21"></a><span id="l16.21"> var EnigmailAttachment = ChromeUtils.import(</span>
<a href="#l16.22"></a><span id="l16.22">   &quot;chrome://openpgp/content/modules/attachment.jsm&quot;</span>
<a href="#l16.23"></a><span id="l16.23"> ).EnigmailAttachment;</span>
<a href="#l16.24"></a><span id="l16.24"> var EnigmailConstants = ChromeUtils.import(</span>
<a href="#l16.25"></a><span id="l16.25">   &quot;chrome://openpgp/content/modules/constants.jsm&quot;</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineat">@@ -110,16 +116,19 @@ var EnigmailMime = ChromeUtils.import(</span>
<a href="#l16.27"></a><span id="l16.27"> var EnigmailArmor = ChromeUtils.import(</span>
<a href="#l16.28"></a><span id="l16.28">   &quot;chrome://openpgp/content/modules/armor.jsm&quot;</span>
<a href="#l16.29"></a><span id="l16.29"> ).EnigmailArmor;</span>
<a href="#l16.30"></a><span id="l16.30"> /*</span>
<a href="#l16.31"></a><span id="l16.31"> var EnigmailWks = ChromeUtils.import(</span>
<a href="#l16.32"></a><span id="l16.32">   &quot;chrome://openpgp/content/modules/webKey.jsm&quot;</span>
<a href="#l16.33"></a><span id="l16.33"> ).EnigmailWks;</span>
<a href="#l16.34"></a><span id="l16.34"> */</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+var EnigmailWkdLookup = ChromeUtils.import(</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+  &quot;chrome://openpgp/content/modules/wkdLookup.jsm&quot;</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+).EnigmailWkdLookup;</span>
<a href="#l16.38"></a><span id="l16.38"> var EnigmailStdlib = ChromeUtils.import(</span>
<a href="#l16.39"></a><span id="l16.39">   &quot;chrome://openpgp/content/modules/stdlib.jsm&quot;</span>
<a href="#l16.40"></a><span id="l16.40"> ).EnigmailStdlib;</span>
<a href="#l16.41"></a><span id="l16.41"> var EnigmailConfigure = ChromeUtils.import(</span>
<a href="#l16.42"></a><span id="l16.42">   &quot;chrome://openpgp/content/modules/configure.jsm&quot;</span>
<a href="#l16.43"></a><span id="l16.43"> ).EnigmailConfigure;</span>
<a href="#l16.44"></a><span id="l16.44"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l16.45"></a><span id="l16.45"> </span>
<a href="#l16.46"></a><span id="l16.46" class="difflineat">@@ -300,16 +309,21 @@ Enigmail.msg = {</span>
<a href="#l16.47"></a><span id="l16.47">   },</span>
<a href="#l16.48"></a><span id="l16.48"> </span>
<a href="#l16.49"></a><span id="l16.49">   messageListener: {</span>
<a href="#l16.50"></a><span id="l16.50">     onStartHeaders() {</span>
<a href="#l16.51"></a><span id="l16.51">       Enigmail.msg.mimeParts = null;</span>
<a href="#l16.52"></a><span id="l16.52">       let b = document.getElementById(&quot;openpgpKeyBox&quot;);</span>
<a href="#l16.53"></a><span id="l16.53">       b.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l16.54"></a><span id="l16.54">       b.removeAttribute(&quot;keydata&quot;);</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+      let b2 = document.getElementById(&quot;signatureKeyBox&quot;);</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+      b2.setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+      b2.removeAttribute(&quot;keyid&quot;);</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+</span>
<a href="#l16.60"></a><span id="l16.60">       /*</span>
<a href="#l16.61"></a><span id="l16.61">       if (&quot;autocrypt&quot; in gExpandedHeaderView) {</span>
<a href="#l16.62"></a><span id="l16.62">         delete gExpandedHeaderView.autocrypt;</span>
<a href="#l16.63"></a><span id="l16.63">       }</span>
<a href="#l16.64"></a><span id="l16.64">       */</span>
<a href="#l16.65"></a><span id="l16.65">       if (&quot;openpgp&quot; in gExpandedHeaderView) {</span>
<a href="#l16.66"></a><span id="l16.66">         delete gExpandedHeaderView.openpgp;</span>
<a href="#l16.67"></a><span id="l16.67">       }</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineat">@@ -1789,16 +1803,49 @@ Enigmail.msg = {</span>
<a href="#l16.69"></a><span id="l16.69">     } else {</span>
<a href="#l16.70"></a><span id="l16.70">       EnigmailDialog.alert(</span>
<a href="#l16.71"></a><span id="l16.71">         window,</span>
<a href="#l16.72"></a><span id="l16.72">         EnigmailLocale.getString(&quot;previewFailed&quot;) + &quot;\n&quot; + errorMsgObj.value</span>
<a href="#l16.73"></a><span id="l16.73">       );</span>
<a href="#l16.74"></a><span id="l16.74">     }</span>
<a href="#l16.75"></a><span id="l16.75">   },</span>
<a href="#l16.76"></a><span id="l16.76"> </span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+  async searchSignatureKey() {</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+    let keyId = document</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+      .getElementById(&quot;signatureKeyBox&quot;)</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+      .getAttribute(&quot;keyid&quot;);</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+    if (!keyId) {</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+      return;</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+    }</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+    let defKs = EnigmailKeyserverURIs.getDefaultKeyServer();</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+    // We don't have great code yet to handle multiple results,</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+    // or poisoned results. So avoid SKS.</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+    // Let's start with verifying keyservers, only, which return only</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+    // one result.</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+    if (!defKs.startsWith(&quot;vks://&quot;)) {</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+      console.debug(&quot;Not using &quot; + defKs + &quot; in searchSignatureKey&quot;);</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+      return;</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+    }</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+    let vks = await EnigmailKeyServer.downloadNoImport(&quot;0x&quot; + keyId, defKs);</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+    if (&quot;keyData&quot; in vks) {</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+      let keyList = EnigmailKey.getKeyListFromKeyBlock(</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+        vks.keyData,</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+        {},</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+        false,</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+        true,</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+        false</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+      );</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+      this.importKeyDataWithConfirmation(keyList, vks.keyData, true);</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+    } else {</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+      console.debug(&quot;searchKeysOnInternet no data in keys.openpgp.org&quot;);</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+    }</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+  },</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+</span>
<a href="#l16.110"></a><span id="l16.110">   importKeyFromMsgBody(msgData) {</span>
<a href="#l16.111"></a><span id="l16.111">     let beginIndexObj = {};</span>
<a href="#l16.112"></a><span id="l16.112">     let endIndexObj = {};</span>
<a href="#l16.113"></a><span id="l16.113">     let indentStrObj = {};</span>
<a href="#l16.114"></a><span id="l16.114">     let blockType = EnigmailArmor.locateArmoredBlock(</span>
<a href="#l16.115"></a><span id="l16.115">       msgData,</span>
<a href="#l16.116"></a><span id="l16.116">       0,</span>
<a href="#l16.117"></a><span id="l16.117">       &quot;&quot;,</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineat">@@ -3054,16 +3101,63 @@ Enigmail.msg = {</span>
<a href="#l16.119"></a><span id="l16.119">         this.handleAttachment(&quot;importKey&quot;, currentAttachments[i]);</span>
<a href="#l16.120"></a><span id="l16.120">         keyFound = true;</span>
<a href="#l16.121"></a><span id="l16.121">       }</span>
<a href="#l16.122"></a><span id="l16.122">     }</span>
<a href="#l16.123"></a><span id="l16.123"> </span>
<a href="#l16.124"></a><span id="l16.124">     return keyFound;</span>
<a href="#l16.125"></a><span id="l16.125">   },</span>
<a href="#l16.126"></a><span id="l16.126"> </span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+  async searchKeysOnInternet(aHeaderNode) {</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+    let address = aHeaderNode</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+      .closest(&quot;mail-emailaddress&quot;)</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+      .getAttribute(&quot;emailAddress&quot;);</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+    let foundKeys = null;</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+    foundKeys = await EnigmailWkdLookup.downloadKey(address);</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+    if (!foundKeys) {</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+      console.debug(&quot;searchKeysOnInternet no wkd data&quot;);</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+    } else {</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+      let keyList = EnigmailKey.getKeyListFromKeyBlock(</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+        foundKeys.keyData,</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+        {},</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+        false</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+      );</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+      this.importKeyDataWithConfirmation(keyList, foundKeys.keyData, true);</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+    }</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+    if (foundKeys) {</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+      return;</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+    }</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineplus">+</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+    let defKs = EnigmailKeyserverURIs.getDefaultKeyServer();</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+    // We don't have great code yet to handle multiple results,</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+    // or poisoned results. So avoid SKS.</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+    // Let's start with verifying keyservers, only, which return only</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineplus">+    // one result.</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineplus">+    if (!defKs.startsWith(&quot;vks://&quot;)) {</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+      console.debug(&quot;Not using &quot; + defKs + &quot; in searchKeysOnInternet&quot;);</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+      return;</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+    }</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineplus">+    let vks = await EnigmailKeyServer.downloadNoImport(address, defKs);</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineplus">+    if (&quot;keyData&quot; in vks) {</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineplus">+      let keyList = EnigmailKey.getKeyListFromKeyBlock(</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineplus">+        vks.keyData,</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineplus">+        {},</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+        false,</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineplus">+        true,</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+        false</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineplus">+      );</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+      this.importKeyDataWithConfirmation(keyList, vks.keyData, true);</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+    } else {</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+      console.debug(&quot;searchKeysOnInternet no data in keys.openpgp.org&quot;);</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+    }</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+  },</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+</span>
<a href="#l16.174"></a><span id="l16.174">   importKeyFromKeyserver() {</span>
<a href="#l16.175"></a><span id="l16.175">     var pubKeyId = &quot;0x&quot; + Enigmail.msg.securityInfo.keyId;</span>
<a href="#l16.176"></a><span id="l16.176">     var inputObj = {</span>
<a href="#l16.177"></a><span id="l16.177">       searchList: [pubKeyId],</span>
<a href="#l16.178"></a><span id="l16.178">       autoKeyServer: EnigmailPrefs.getPref(&quot;autoKeyServerSelection&quot;)</span>
<a href="#l16.179"></a><span id="l16.179">         ? EnigmailPrefs.getPref(&quot;keyserver&quot;).split(/[ ,;]/g)[0]</span>
<a href="#l16.180"></a><span id="l16.180">         : null,</span>
<a href="#l16.181"></a><span id="l16.181">     };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -179,19 +179,19 @@ Enigmail.hdrView = {</span>
<a href="#l17.4"></a><span id="l17.4">       //enigMsgPane.setAttribute(&quot;collapsed&quot;, true);</span>
<a href="#l17.5"></a><span id="l17.5">       bodyElement.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l17.6"></a><span id="l17.6">     } catch (ex) {</span>
<a href="#l17.7"></a><span id="l17.7">       console.debug(ex);</span>
<a href="#l17.8"></a><span id="l17.8">     }</span>
<a href="#l17.9"></a><span id="l17.9">   },</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11">   setStatusText(txt) {</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-    let s = document.getElementById(&quot;enigmailStatusText&quot;);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-    if (s) {</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-      s.firstChild.data = txt;</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+    // TODO: replace with other information display, tracker bug 1595227</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+    if (txt) {</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+      console.debug(txt);</span>
<a href="#l17.18"></a><span id="l17.18">     }</span>
<a href="#l17.19"></a><span id="l17.19">   },</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21">   updateHdrIcons(</span>
<a href="#l17.22"></a><span id="l17.22">     exitCode,</span>
<a href="#l17.23"></a><span id="l17.23">     statusFlags,</span>
<a href="#l17.24"></a><span id="l17.24">     extStatusFlags,</span>
<a href="#l17.25"></a><span id="l17.25">     keyId,</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineat">@@ -368,16 +368,21 @@ Enigmail.hdrView = {</span>
<a href="#l17.27"></a><span id="l17.27">         statusInfo = EnigmailLocale.getString(&quot;missingPassphrase&quot;);</span>
<a href="#l17.28"></a><span id="l17.28">       } else if (statusFlags &amp; EnigmailConstants.NO_SECKEY) {</span>
<a href="#l17.29"></a><span id="l17.29">         statusInfo = EnigmailLocale.getString(&quot;needKey&quot;);</span>
<a href="#l17.30"></a><span id="l17.30">       } else {</span>
<a href="#l17.31"></a><span id="l17.31">         statusInfo = EnigmailLocale.getString(&quot;failedDecrypt&quot;);</span>
<a href="#l17.32"></a><span id="l17.32">       }</span>
<a href="#l17.33"></a><span id="l17.33">     } else if (statusFlags &amp; EnigmailConstants.UNCERTAIN_SIGNATURE) {</span>
<a href="#l17.34"></a><span id="l17.34">       statusInfo = EnigmailLocale.getString(&quot;uncertainSig&quot;);</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+      if (statusFlags &amp; EnigmailConstants.NO_PUBKEY) {</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+        let b = document.getElementById(&quot;signatureKeyBox&quot;);</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+        b.setAttribute(&quot;hidden&quot;, false);</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+        b.setAttribute(&quot;keyid&quot;, keyId);</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+      }</span>
<a href="#l17.40"></a><span id="l17.40">     } else if (statusFlags &amp; EnigmailConstants.GOOD_SIGNATURE) {</span>
<a href="#l17.41"></a><span id="l17.41">       statusInfo = EnigmailLocale.getString(&quot;goodSig&quot;, [keyId]);</span>
<a href="#l17.42"></a><span id="l17.42">     } else if (</span>
<a href="#l17.43"></a><span id="l17.43">       statusFlags &amp;</span>
<a href="#l17.44"></a><span id="l17.44">       (EnigmailConstants.BAD_SIGNATURE |</span>
<a href="#l17.45"></a><span id="l17.45">         EnigmailConstants.EXPIRED_SIGNATURE |</span>
<a href="#l17.46"></a><span id="l17.46">         EnigmailConstants.EXPIRED_KEY_SIGNATURE)</span>
<a href="#l17.47"></a><span id="l17.47">     ) {</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineat">@@ -631,18 +636,16 @@ Enigmail.hdrView = {</span>
<a href="#l17.49"></a><span id="l17.49">   displayAutocryptMessage(allowImport) {</span>
<a href="#l17.50"></a><span id="l17.50">     EnigmailLog.DEBUG(</span>
<a href="#l17.51"></a><span id="l17.51">       &quot;enigmailMsgHdrViewOverlay.js: displayAutocryptMessage()\n&quot;</span>
<a href="#l17.52"></a><span id="l17.52">     );</span>
<a href="#l17.53"></a><span id="l17.53">   },</span>
<a href="#l17.54"></a><span id="l17.54">   */</span>
<a href="#l17.55"></a><span id="l17.55"> </span>
<a href="#l17.56"></a><span id="l17.56">   displayStatusBar() {</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-    //let statusText = document.getElementById(&quot;enigmailStatusText&quot;);</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-    //let icon = document.getElementById(&quot;enigToggleHeaderView2&quot;);</span>
<a href="#l17.59"></a><span id="l17.59">     let bodyElement = document.getElementById(&quot;messagepanebox&quot;);</span>
<a href="#l17.60"></a><span id="l17.60"> </span>
<a href="#l17.61"></a><span id="l17.61">     let secInfo = Enigmail.msg.securityInfo;</span>
<a href="#l17.62"></a><span id="l17.62">     let statusFlags = secInfo.statusFlags;</span>
<a href="#l17.63"></a><span id="l17.63">     let extStatusFlags =</span>
<a href="#l17.64"></a><span id="l17.64">       &quot;extStatusFlags&quot; in secInfo ? secInfo.extStatusFlags : 0;</span>
<a href="#l17.65"></a><span id="l17.65">     let sMimeContainer, encryptedUINode, signedUINode;</span>
<a href="#l17.66"></a><span id="l17.66"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

