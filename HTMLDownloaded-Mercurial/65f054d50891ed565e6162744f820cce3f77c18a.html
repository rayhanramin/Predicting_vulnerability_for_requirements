<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11673:65f054d50891ed565e6162744f820cce3f77c18a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 65f054d50891ed565e6162744f820cce3f77c18a" />
<meta property="og:url" content="/comm-central/rev/65f054d50891ed565e6162744f820cce3f77c18a" />
<meta property="og:description" content="Bug 762594 - Prompts to save unmodified message forward draft. r=mconley" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 65f054d50891ed565e6162744f820cce3f77c18a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/65f054d50891ed565e6162744f820cce3f77c18a">shortlog</a> |
<a href="/comm-central/log/65f054d50891ed565e6162744f820cce3f77c18a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/65f054d50891ed565e6162744f820cce3f77c18a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/65f054d50891ed565e6162744f820cce3f77c18a">files</a> |
changeset |
<a href="/comm-central/raw-rev/65f054d50891ed565e6162744f820cce3f77c18a">raw</a>  | <a href="/comm-central/archive/65f054d50891ed565e6162744f820cce3f77c18a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=762594">Bug 762594</a> - Prompts to save unmodified message forward draft. r=mconley
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#103;&#110;&#117;&#115;&#32;&#77;&#101;&#108;&#105;&#110;&#32;&#60;&#109;&#107;&#109;&#101;&#108;&#105;&#110;&#43;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#105;&#107;&#105;&#46;&#102;&#105;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 09 Dec 2012 22:36:48 +0200</td></tr>

<tr>
 <td>changeset 11673</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/65f054d50891ed565e6162744f820cce3f77c18a">65f054d50891ed565e6162744f820cce3f77c18a</a></td>
</tr>



<tr>
<td>parent 11672</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2a546fb885e34bc7866ae2ceb33ad93f25dc5738">2a546fb885e34bc7866ae2ceb33ad93f25dc5738</a>
</td>
</tr>

<tr>
<td>child 11674</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a86f2efe5ffaa64ceb4c02f885ba0662e27ef209">a86f2efe5ffaa64ceb4c02f885ba0662e27ef209</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=65f054d50891ed565e6162744f820cce3f77c18a">8702</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Sun, 09 Dec 2012 20:38:26 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@65f054d50891 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=65f054d50891ed565e6162744f820cce3f77c18a">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=65f054d50891ed565e6162744f820cce3f77c18a&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=65f054d50891ed565e6162744f820cce3f77c18a&newProject=comm-central&newRevision=65f054d50891ed565e6162744f820cce3f77c18a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=65f054d50891ed565e6162744f820cce3f77c18a&newProject=comm-central&newRevision=65f054d50891ed565e6162744f820cce3f77c18a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=65f054d50891ed565e6162744f820cce3f77c18a&newProject=comm-central&newRevision=65f054d50891ed565e6162744f820cce3f77c18a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mconley%29&revcount=50">mconley</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=762594">762594</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=762594">Bug 762594</a> - Prompts to save unmodified message forward draft. r=mconley</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/65f054d50891ed565e6162744f820cce3f77c18a/mail/components/compose/content/cloudAttachmentLinkManager.js">mail/components/compose/content/cloudAttachmentLinkManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/65f054d50891ed565e6162744f820cce3f77c18a/mail/components/compose/content/cloudAttachmentLinkManager.js">file</a> |
<a href="/comm-central/annotate/65f054d50891ed565e6162744f820cce3f77c18a/mail/components/compose/content/cloudAttachmentLinkManager.js">annotate</a> |
<a href="/comm-central/diff/65f054d50891ed565e6162744f820cce3f77c18a/mail/components/compose/content/cloudAttachmentLinkManager.js">diff</a> |
<a href="/comm-central/comparison/65f054d50891ed565e6162744f820cce3f77c18a/mail/components/compose/content/cloudAttachmentLinkManager.js">comparison</a> |
<a href="/comm-central/log/65f054d50891ed565e6162744f820cce3f77c18a/mail/components/compose/content/cloudAttachmentLinkManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/composition/test-forwarded-eml-actions.js">mail/test/mozmill/composition/test-forwarded-eml-actions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/composition/test-forwarded-eml-actions.js">file</a> |
<a href="/comm-central/annotate/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/composition/test-forwarded-eml-actions.js">annotate</a> |
<a href="/comm-central/diff/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/composition/test-forwarded-eml-actions.js">diff</a> |
<a href="/comm-central/comparison/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/composition/test-forwarded-eml-actions.js">comparison</a> |
<a href="/comm-central/log/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/composition/test-forwarded-eml-actions.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/composition/test-save-changes-on-quit.js">mail/test/mozmill/composition/test-save-changes-on-quit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/composition/test-save-changes-on-quit.js">file</a> |
<a href="/comm-central/annotate/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/composition/test-save-changes-on-quit.js">annotate</a> |
<a href="/comm-central/diff/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/composition/test-save-changes-on-quit.js">diff</a> |
<a href="/comm-central/comparison/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/composition/test-save-changes-on-quit.js">comparison</a> |
<a href="/comm-central/log/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/composition/test-save-changes-on-quit.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/shared-modules/test-compose-helpers.js">mail/test/mozmill/shared-modules/test-compose-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/shared-modules/test-compose-helpers.js">file</a> |
<a href="/comm-central/annotate/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/shared-modules/test-compose-helpers.js">annotate</a> |
<a href="/comm-central/diff/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/shared-modules/test-compose-helpers.js">diff</a> |
<a href="/comm-central/comparison/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/shared-modules/test-compose-helpers.js">comparison</a> |
<a href="/comm-central/log/65f054d50891ed565e6162744f820cce3f77c18a/mail/test/mozmill/shared-modules/test-compose-helpers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/compose/content/cloudAttachmentLinkManager.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/compose/content/cloudAttachmentLinkManager.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -40,31 +40,35 @@ var gCloudAttachmentLinkManager = {</span>
<a href="#l1.4"></a><span id="l1.4">     if (gComposeType != Components.interfaces.nsIMsgCompType.ForwardInline)</span>
<a href="#l1.5"></a><span id="l1.5">       return;</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">     let mailDoc = document.getElementById(&quot;content-frame&quot;).contentDocument;</span>
<a href="#l1.8"></a><span id="l1.8">     let mailBody = mailDoc.getElementsByTagName(&quot;body&quot;)[0];</span>
<a href="#l1.9"></a><span id="l1.9">     let editor = GetCurrentEditor();</span>
<a href="#l1.10"></a><span id="l1.10">     let selection = editor.selection;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    let childNodes = mailBody.childNodes;</span>
<a href="#l1.13"></a><span id="l1.13">     let container = editor.createElementWithDefaults(&quot;div&quot;);</span>
<a href="#l1.14"></a><span id="l1.14">     container.setAttribute(&quot;class&quot;, &quot;moz-forward-container&quot;);</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+    editor.enableUndo(false);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+</span>
<a href="#l1.18"></a><span id="l1.18">     if (mailBody.hasChildNodes()) {</span>
<a href="#l1.19"></a><span id="l1.19">       while (mailBody.childNodes.length &gt; 0) {</span>
<a href="#l1.20"></a><span id="l1.20">         let removedChild = mailBody.removeChild(mailBody.firstChild);</span>
<a href="#l1.21"></a><span id="l1.21">         container.appendChild(removedChild);</span>
<a href="#l1.22"></a><span id="l1.22">       }</span>
<a href="#l1.23"></a><span id="l1.23">     }</span>
<a href="#l1.24"></a><span id="l1.24">     editor.insertLineBreak();</span>
<a href="#l1.25"></a><span id="l1.25">     selection.collapse(mailBody, 1);</span>
<a href="#l1.26"></a><span id="l1.26">     editor.insertElementAtSelection(container, false);</span>
<a href="#l1.27"></a><span id="l1.27">     editor.insertLineBreak();</span>
<a href="#l1.28"></a><span id="l1.28">     editor.beginningOfDocument();</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+    editor.enableUndo(true);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+    editor.resetModificationCount();</span>
<a href="#l1.32"></a><span id="l1.32">   },</span>
<a href="#l1.33"></a><span id="l1.33">   ComposeProcessDone: function() {},</span>
<a href="#l1.34"></a><span id="l1.34">   SaveInFolderDone: function() {},</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36">   handleEvent: function(event) {</span>
<a href="#l1.37"></a><span id="l1.37">     let mailDoc = document.getElementById(&quot;content-frame&quot;).contentDocument;</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39">     if (event.type == &quot;attachment-uploaded&quot;) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-forwarded-eml-actions.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-forwarded-eml-actions.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -109,17 +109,17 @@ function setupWindowAndTest(hotkeyToHit,</span>
<a href="#l2.4"></a><span id="l2.4">     throw new Error(&quot;body text didn't contain the body text; msgbodyA=&quot; +</span>
<a href="#l2.5"></a><span id="l2.5">                     msgbodyB + &quot;, bodyText=&quot; + bodyText);</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">   let subjectText = compWin.e(&quot;msgSubject&quot;).value;</span>
<a href="#l2.8"></a><span id="l2.8">   if (subjectText.indexOf(msgsubject) == -1)</span>
<a href="#l2.9"></a><span id="l2.9">     throw new Error(&quot;subject text didn't contain the original subject; &quot; +</span>
<a href="#l2.10"></a><span id="l2.10">                     &quot;msgsubject=&quot; +  msgsubject + &quot;, subjectText=&quot; + subjectText);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  close_compose_window(compWin);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  close_compose_window(compWin, false);</span>
<a href="#l2.14"></a><span id="l2.14">   close_window(msgWin);</span>
<a href="#l2.15"></a><span id="l2.15"> }</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> /**</span>
<a href="#l2.18"></a><span id="l2.18">  * Test that replying to an attached .eml contains the expected texts.</span>
<a href="#l2.19"></a><span id="l2.19">  */</span>
<a href="#l2.20"></a><span id="l2.20"> function test_reply_to_attached_eml() {</span>
<a href="#l2.21"></a><span id="l2.21">   setupWindowAndTest(&quot;R&quot;, {shiftKey: false, accelKey: true});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-save-changes-on-quit.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-save-changes-on-quit.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,44 +1,46 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> /**</span>
<a href="#l3.9"></a><span id="l3.9">  * Tests that we prompt the user if they'd like to save their message when they</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">- * try to quit with an open compose window with unsaved changes.</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+ * try to quit/close with an open compose window with unsaved changes, and</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+ * that we don't prompt if there are no changes.</span>
<a href="#l3.13"></a><span id="l3.13">  */</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+// make SOLO_TEST=composition/test-save-changes-on-quit.js mozmill-one</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+</span>
<a href="#l3.17"></a><span id="l3.17"> const MODULE_NAME = &quot;test-save-changes-on-close&quot;;</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19"> const RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l3.20"></a><span id="l3.20"> const MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;,</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-                         &quot;prompt-helpers&quot;];</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+                         &quot;prompt-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l3.23"></a><span id="l3.23"> const SAVE = 0</span>
<a href="#l3.24"></a><span id="l3.24"> const CANCEL = 1</span>
<a href="#l3.25"></a><span id="l3.25"> const DONT_SAVE = 2;</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27"> var jumlib = {};</span>
<a href="#l3.28"></a><span id="l3.28"> Components.utils.import(&quot;resource://mozmill/modules/jum.js&quot;, jumlib);</span>
<a href="#l3.29"></a><span id="l3.29"> var elib = {};</span>
<a href="#l3.30"></a><span id="l3.30"> Components.utils.import(&quot;resource://mozmill/modules/elementslib.js&quot;, elib);</span>
<a href="#l3.31"></a><span id="l3.31"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-var composeHelper = null;</span>
<a href="#l3.34"></a><span id="l3.34"> var cwc = null; // compose window controller</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+var folder = null;</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37"> var setupModule = function (module) {</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-  fdh.installInto(module);</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+  collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+  collector.getModule(&quot;compose-helpers&quot;).installInto(module);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+  collector.getModule(&quot;prompt-helpers&quot;).installInto(module);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+  collector.getModule(&quot;window-helpers&quot;).installInto(module);</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-  let composeHelper = collector.getModule(&quot;compose-helpers&quot;);</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-  composeHelper.installInto(module);</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-  let ph = collector.getModule(&quot;prompt-helpers&quot;);</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-  ph.installInto(module);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+  folder = create_folder(&quot;PromptToSaveTest&quot;);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+  add_message_to_folder(folder, create_message());</span>
<a href="#l3.52"></a><span id="l3.52"> };</span>
<a href="#l3.53"></a><span id="l3.53"> </span>
<a href="#l3.54"></a><span id="l3.54"> /**</span>
<a href="#l3.55"></a><span id="l3.55">  * Test that when a compose window is open with changes, and</span>
<a href="#l3.56"></a><span id="l3.56">  * a Quit is requested (for example, from File &gt; Quit from the</span>
<a href="#l3.57"></a><span id="l3.57">  * 3pane), that the user gets a confirmation dialog to discard</span>
<a href="#l3.58"></a><span id="l3.58">  * the changes. This also tests that the user can cancel the</span>
<a href="#l3.59"></a><span id="l3.59">  * quit request.</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineat">@@ -173,8 +175,49 @@ function test_window_quit_state_reset_on</span>
<a href="#l3.61"></a><span id="l3.61">   cwc2.click(cwc2.eid(&quot;menu_close&quot;));</span>
<a href="#l3.62"></a><span id="l3.62"> </span>
<a href="#l3.63"></a><span id="l3.63">   let promptState = gMockPromptService.promptState;</span>
<a href="#l3.64"></a><span id="l3.64">   assert_not_equals(null, promptState, &quot;Expected a confirmEx prompt&quot;);</span>
<a href="#l3.65"></a><span id="l3.65"> </span>
<a href="#l3.66"></a><span id="l3.66">   gMockPromptService.unregister();</span>
<a href="#l3.67"></a><span id="l3.67"> }</span>
<a href="#l3.68"></a><span id="l3.68"> </span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+/**</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+ * Tests that we don't get a prompt to save if there has been no user input</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+ * into the message yet, when trying to close.</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+ */</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+function test_no_prompt_on_close_for_unmodified() {</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  let msg = select_click_row(0);</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+  let nwc = open_compose_new_mail();</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+  close_compose_window(nwc, false);</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+  let rwc = open_compose_with_reply();</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+  close_compose_window(rwc, false);</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+  let fwc = open_compose_with_forward();</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+  close_compose_window(fwc, false);</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+}</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+/**</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+ * Tests that we get a prompt to save if the user made changes to the message</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+ * before trying to close it.</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+ */</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+function test_prompt_on_close_for_modified() {</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+  let msg = select_click_row(0);</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+  assert_selected_and_displayed(mc, msg);</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+  let nwc = open_compose_new_mail();</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+  nwc.type(nwc.eid(&quot;content-frame&quot;), &quot;Hey hey hey!&quot;);</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+  close_compose_window(nwc, true);</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+  let rwc = open_compose_with_reply();</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+  rwc.type(rwc.eid(&quot;content-frame&quot;), &quot;Howdy!&quot;);</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+  close_compose_window(rwc, true);</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+  let fwc = open_compose_with_forward();</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+  fwc.type(fwc.eid(&quot;content-frame&quot;), &quot;Greetings!&quot;);</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+  close_compose_window(fwc, true);</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+}</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-compose-helpers.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-compose-helpers.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -181,26 +181,41 @@ function open_compose_with_element_click</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5">   windowHelper.plan_for_new_window(&quot;msgcompose&quot;);</span>
<a href="#l4.6"></a><span id="l4.6">   aController.click(new elib.ID(mc.window.document, aElement));</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8">   return wait_for_compose_window();</span>
<a href="#l4.9"></a><span id="l4.9"> }</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> /**</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">- * Closes the requested compose window. This function currently just forwards to</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">- * windowHelper but means we don't have to include windowHelper elsewhere if we</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">- * don't want it.</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">- *</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">- * In future it could also be expanded to handle prompting on close.</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+ * Closes the requested compose window.</span>
<a href="#l4.18"></a><span id="l4.18">  *</span>
<a href="#l4.19"></a><span id="l4.19">  * @param aController the controller whose window is to be closed.</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+ * @param aShouldPrompt (optional) true: check that the prompt to save appears</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+ *                                 false: check there's no prompt to save</span>
<a href="#l4.22"></a><span id="l4.22">  */</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-function close_compose_window(aController) {</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-  windowHelper.close_window(aController);</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+function close_compose_window(aController, aShouldPrompt) {</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+  if (aShouldPrompt === undefined) { // caller doesn't care if we get a prompt</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+    windowHelper.close_window(aController);</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+    return;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+  }</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+  windowHelper.plan_for_window_close(aController);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  if (aShouldPrompt) {</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+    windowHelper.plan_for_modal_dialog(&quot;commonDialog&quot;, function clickDontSave(controller) {</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+       controller.window.document.documentElement.getButton(&quot;extra1&quot;).doCommand();</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+    });</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+    // Try to close, we should get a prompt to save.</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+    aController.window.goDoCommand(&quot;cmd_close&quot;);</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+    windowHelper.wait_for_modal_dialog();</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  }</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+  else {</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+    aController.window.goDoCommand(&quot;cmd_close&quot;);</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+  }</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  windowHelper.wait_for_window_close();</span>
<a href="#l4.44"></a><span id="l4.44"> }</span>
<a href="#l4.45"></a><span id="l4.45"> </span>
<a href="#l4.46"></a><span id="l4.46"> /**</span>
<a href="#l4.47"></a><span id="l4.47">  * Waits for a new compose window to open. This assumes you have already called</span>
<a href="#l4.48"></a><span id="l4.48">  * &quot;windowHelper.plan_for_new_window(&quot;msgcompose&quot;);&quot; and the command to open</span>
<a href="#l4.49"></a><span id="l4.49">  * the compose window itself.</span>
<a href="#l4.50"></a><span id="l4.50">  *</span>
<a href="#l4.51"></a><span id="l4.51">  * @return The loaded window of type &quot;msgcompose&quot; wrapped in a MozmillController</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

