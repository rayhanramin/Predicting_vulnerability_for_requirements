<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10285:97f864cca479fc7a353d120a7c10dfce85c69593</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 97f864cca479fc7a353d120a7c10dfce85c69593" />
<meta property="og:url" content="/comm-central/rev/97f864cca479fc7a353d120a7c10dfce85c69593" />
<meta property="og:description" content="Bug 754780 - If Tb 10 and Tb 11 is skipped, Gloda Scheme change is not correctly detected and gloda error is reported to Error Console by Tb 12 or newer, then Global Search doesn't work. fix. r=Standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 97f864cca479fc7a353d120a7c10dfce85c69593 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/97f864cca479fc7a353d120a7c10dfce85c69593">shortlog</a> |
<a href="/comm-central/log/97f864cca479fc7a353d120a7c10dfce85c69593">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/97f864cca479fc7a353d120a7c10dfce85c69593">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/97f864cca479fc7a353d120a7c10dfce85c69593">files</a> |
changeset |
<a href="/comm-central/raw-rev/97f864cca479fc7a353d120a7c10dfce85c69593">raw</a>  | <a href="/comm-central/archive/97f864cca479fc7a353d120a7c10dfce85c69593.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=754780">Bug 754780</a> - If Tb 10 and Tb 11 is skipped, Gloda Scheme change is not correctly detected and gloda error is reported to Error Console by Tb 12 or newer, then Global Search doesn't work. fix. r=Standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 25 May 2012 11:25:19 -0700</td></tr>

<tr>
 <td>changeset 10285</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/97f864cca479fc7a353d120a7c10dfce85c69593">97f864cca479fc7a353d120a7c10dfce85c69593</a></td>
</tr>



<tr>
<td>parent 10284</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fef7d27efeaa8178465cf9dcb67707fb61caa6c0">fef7d27efeaa8178465cf9dcb67707fb61caa6c0</a>
</td>
</tr>

<tr>
<td>child 10286</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f2729b390e7bb12f30d622878b88cc89e244c6b9">f2729b390e7bb12f30d622878b88cc89e244c6b9</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=97f864cca479fc7a353d120a7c10dfce85c69593">7789</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Fri, 25 May 2012 18:25:51 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f2729b390e7b [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f2729b390e7bb12f30d622878b88cc89e244c6b9">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f2729b390e7bb12f30d622878b88cc89e244c6b9&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f2729b390e7bb12f30d622878b88cc89e244c6b9&newProject=comm-central&newRevision=97f864cca479fc7a353d120a7c10dfce85c69593&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f2729b390e7bb12f30d622878b88cc89e244c6b9&newProject=comm-central&newRevision=97f864cca479fc7a353d120a7c10dfce85c69593&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f2729b390e7bb12f30d622878b88cc89e244c6b9&newProject=comm-central&newRevision=97f864cca479fc7a353d120a7c10dfce85c69593&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=754780">754780</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=754780">Bug 754780</a> - If Tb 10 and Tb 11 is skipped, Gloda Scheme change is not correctly detected and gloda error is reported to Error Console by Tb 12 or newer, then Global Search doesn't work. fix. r=Standard8</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/97f864cca479fc7a353d120a7c10dfce85c69593/mailnews/db/gloda/modules/datastore.js">mailnews/db/gloda/modules/datastore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/97f864cca479fc7a353d120a7c10dfce85c69593/mailnews/db/gloda/modules/datastore.js">file</a> |
<a href="/comm-central/annotate/97f864cca479fc7a353d120a7c10dfce85c69593/mailnews/db/gloda/modules/datastore.js">annotate</a> |
<a href="/comm-central/diff/97f864cca479fc7a353d120a7c10dfce85c69593/mailnews/db/gloda/modules/datastore.js">diff</a> |
<a href="/comm-central/comparison/97f864cca479fc7a353d120a7c10dfce85c69593/mailnews/db/gloda/modules/datastore.js">comparison</a> |
<a href="/comm-central/log/97f864cca479fc7a353d120a7c10dfce85c69593/mailnews/db/gloda/modules/datastore.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -42,17 +42,17 @@</span>
<a href="#l1.4"></a><span id="l1.4">  */</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> const EXPORTED_SYMBOLS = [&quot;GlodaDatastore&quot;];</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> const Cc = Components.classes;</span>
<a href="#l1.9"></a><span id="l1.9"> const Ci = Components.interfaces;</span>
<a href="#l1.10"></a><span id="l1.10"> const Cr = Components.results;</span>
<a href="#l1.11"></a><span id="l1.11"> const Cu = Components.utils;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">- </span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14"> Cu.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l1.15"></a><span id="l1.15"> Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> Cu.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> Cu.import(&quot;resource:///modules/gloda/datamodel.js&quot;);</span>
<a href="#l1.20"></a><span id="l1.20"> Cu.import(&quot;resource:///modules/gloda/databind.js&quot;);</span>
<a href="#l1.21"></a><span id="l1.21"> Cu.import(&quot;resource:///modules/gloda/collection.js&quot;);</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -730,17 +730,17 @@ var GlodaDatastore = {</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24">   /**</span>
<a href="#l1.25"></a><span id="l1.25">    * Schema version policy. IMPORTANT!  We expect the following potential things</span>
<a href="#l1.26"></a><span id="l1.26">    *  to happen in the life of gloda that can impact our schema and the ability</span>
<a href="#l1.27"></a><span id="l1.27">    *  to move between different versions of Thunderbird:</span>
<a href="#l1.28"></a><span id="l1.28">    *</span>
<a href="#l1.29"></a><span id="l1.29">    * - Fundamental changes to the schema so that two versions of Thunderbird</span>
<a href="#l1.30"></a><span id="l1.30">    *    cannot use the same global database.  To wit, Thunderbird N+1 needs to</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-   *    blow away the database of Thunderbird N and reindex from scratch. </span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+   *    blow away the database of Thunderbird N and reindex from scratch.</span>
<a href="#l1.33"></a><span id="l1.33">    *    Likewise, Thunderbird N will need to blow away Thunderbird N+1's</span>
<a href="#l1.34"></a><span id="l1.34">    *    database because it can't understand it.  And we can't simply use a</span>
<a href="#l1.35"></a><span id="l1.35">    *    different file because there would be fatal bookkeeping losses.</span>
<a href="#l1.36"></a><span id="l1.36">    *</span>
<a href="#l1.37"></a><span id="l1.37">    * - Bidirectional minor schema changes (rare).</span>
<a href="#l1.38"></a><span id="l1.38">    *    Thunderbird N+1 does something that does not affect Thunderbird N's use</span>
<a href="#l1.39"></a><span id="l1.39">    *    of the database, and a user switching back to Thunderbird N will not be</span>
<a href="#l1.40"></a><span id="l1.40">    *    negatively impacted.  It will also be fine when they go back to N+1 and</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineat">@@ -785,17 +785,17 @@ var GlodaDatastore = {</span>
<a href="#l1.42"></a><span id="l1.42">    *</span>
<a href="#l1.43"></a><span id="l1.43">    *</span>
<a href="#l1.44"></a><span id="l1.44">    * SO, YOU WANT TO CHANGE THE SCHEMA?</span>
<a href="#l1.45"></a><span id="l1.45">    *</span>
<a href="#l1.46"></a><span id="l1.46">    * Use the ranges below for Thunderbird 11 as a guide, bumping things as little</span>
<a href="#l1.47"></a><span id="l1.47">    *  as possible.  If we start to use up the &quot;accepts and leaves intact&quot; range</span>
<a href="#l1.48"></a><span id="l1.48">    *  without majorly changing things up, re-do the numbering acceptance range</span>
<a href="#l1.49"></a><span id="l1.49">    *  to give us additional runway.</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-   * </span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+   *</span>
<a href="#l1.52"></a><span id="l1.52">    * Also, if we keep needing non-nuking upgrades, consider adding an additional</span>
<a href="#l1.53"></a><span id="l1.53">    *  table to the database that can tell older versions of Thunderbird what to</span>
<a href="#l1.54"></a><span id="l1.54">    *  do when confronted with a newer database and where it can set flags to tell</span>
<a href="#l1.55"></a><span id="l1.55">    *  the newer Thunderbird what the older Thunderbird got up to.  For example,</span>
<a href="#l1.56"></a><span id="l1.56">    *  it would be much easier if we just tell Thunderbird N what to do when it's</span>
<a href="#l1.57"></a><span id="l1.57">    *  confronted with the database.</span>
<a href="#l1.58"></a><span id="l1.58">    *</span>
<a href="#l1.59"></a><span id="l1.59">    *</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineat">@@ -1114,17 +1114,18 @@ var GlodaDatastore = {</span>
<a href="#l1.61"></a><span id="l1.61">             let newVersion = dbSchemaVersion - DB_SCHEMA_DOWNGRADE_DELTA;</span>
<a href="#l1.62"></a><span id="l1.62">             this._log.debug(&quot;db from the future in downgrade range; setting &quot; +</span>
<a href="#l1.63"></a><span id="l1.63">                             &quot;version to &quot; + newVersion + &quot; down from &quot; +</span>
<a href="#l1.64"></a><span id="l1.64">                             dbSchemaVersion);</span>
<a href="#l1.65"></a><span id="l1.65">             dbConnection.schemaVersion = this._actualSchemaVersion = newVersion;</span>
<a href="#l1.66"></a><span id="l1.66">           }</span>
<a href="#l1.67"></a><span id="l1.67">           // too far from the future, nuke it.</span>
<a href="#l1.68"></a><span id="l1.68">           else {</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-            dbConnection = this._nukeMigration(dbConnection);</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+            dbConnection = this._nukeMigration(dbService, dbFile,</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+                                               dbConnection);</span>
<a href="#l1.72"></a><span id="l1.72">           }</span>
<a href="#l1.73"></a><span id="l1.73">         }</span>
<a href="#l1.74"></a><span id="l1.74">         // - database from the past!  migrate it, possibly.</span>
<a href="#l1.75"></a><span id="l1.75">         else if (dbSchemaVersion &lt; this._schemaVersion) {</span>
<a href="#l1.76"></a><span id="l1.76">           this._log.debug(&quot;Need to migrate database.  (DB version: &quot; +</span>
<a href="#l1.77"></a><span id="l1.77">             this._actualSchemaVersion + &quot; desired version: &quot; +</span>
<a href="#l1.78"></a><span id="l1.78">             this._schemaVersion);</span>
<a href="#l1.79"></a><span id="l1.79">           dbConnection = this._migrate(dbService, dbFile,</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineat">@@ -1442,20 +1443,21 @@ var GlodaDatastore = {</span>
<a href="#l1.81"></a><span id="l1.81">     aNounDef.dbAttribAdjuster = aNounDef._dataBinder.adjustAttributes;</span>
<a href="#l1.82"></a><span id="l1.82"> </span>
<a href="#l1.83"></a><span id="l1.83">     if (aNounDef.schema.genericAttributes) {</span>
<a href="#l1.84"></a><span id="l1.84">       aNounDef.attrTableName = aNounDef.tableName + &quot;Attributes&quot;;</span>
<a href="#l1.85"></a><span id="l1.85">       aNounDef.attrIDColumnName = &quot;nounID&quot;;</span>
<a href="#l1.86"></a><span id="l1.86">     }</span>
<a href="#l1.87"></a><span id="l1.87">   },</span>
<a href="#l1.88"></a><span id="l1.88"> </span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-  _nukeMigration: function gloda_ds_nukeMigration(aDBConnection) {</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+  _nukeMigration: function gloda_ds_nukeMigration(aDBService, aDBFile,</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+                                                  aDBConnection) {</span>
<a href="#l1.92"></a><span id="l1.92">     aDBConnection.close();</span>
<a href="#l1.93"></a><span id="l1.93">     aDBFile.remove(false);</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-    this._log.warn(&quot;Global database has been purged due to schema change.  &quot; + </span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+    this._log.warn(&quot;Global database has been purged due to schema change.  &quot; +</span>
<a href="#l1.96"></a><span id="l1.96">                    &quot;old version was &quot; + this._actualSchemaVersion +</span>
<a href="#l1.97"></a><span id="l1.97">                    &quot;, new version is: &quot; + this._schemaVersion);</span>
<a href="#l1.98"></a><span id="l1.98">     return this._createDB(aDBService, aDBFile);</span>
<a href="#l1.99"></a><span id="l1.99">   },</span>
<a href="#l1.100"></a><span id="l1.100"> </span>
<a href="#l1.101"></a><span id="l1.101">   /**</span>
<a href="#l1.102"></a><span id="l1.102">    * Migrate the database _to the latest version_ from an older version.  We</span>
<a href="#l1.103"></a><span id="l1.103">    *  only keep enough logic around to get us to the recent version.  This code</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineat">@@ -1498,26 +1500,26 @@ var GlodaDatastore = {</span>
<a href="#l1.105"></a><span id="l1.105">     // - add the messagesAttribFastDeletion index we thought was already covered</span>
<a href="#l1.106"></a><span id="l1.106">     //  by an index we removed a while ago (migrate-able)</span>
<a href="#l1.107"></a><span id="l1.107">     // version 26</span>
<a href="#l1.108"></a><span id="l1.108">     // - bump page size and also cache size (blow away)</span>
<a href="#l1.109"></a><span id="l1.109">     // version 30</span>
<a href="#l1.110"></a><span id="l1.110">     // - recover from bug 732372 that affected TB 11 beta / TB 12 alpha / TB 13</span>
<a href="#l1.111"></a><span id="l1.111">     //    trunk.  The fix is bug 734507.  The revision bump happens</span>
<a href="#l1.112"></a><span id="l1.112">     //    asynchronously. (migrate-able)</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-    </span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+</span>
<a href="#l1.115"></a><span id="l1.115">     // nuke if prior to 26</span>
<a href="#l1.116"></a><span id="l1.116">     if (aCurVersion &lt; 26)</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-      return this._nukeMigration(aDBConnection);</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+      return this._nukeMigration(aDBService, aDBFile, aDBConnection);</span>
<a href="#l1.119"></a><span id="l1.119"> </span>
<a href="#l1.120"></a><span id="l1.120">     // They must be desiring our &quot;a.contact is undefined&quot; fix!</span>
<a href="#l1.121"></a><span id="l1.121">     // This fix runs asynchronously as the first indexing job the indexer ever</span>
<a href="#l1.122"></a><span id="l1.122">     //  performs.  It is scheduled by the enabling of the message indexer and</span>
<a href="#l1.123"></a><span id="l1.123">     //  it is the one that updates the schema version when done.</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-    </span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+</span>
<a href="#l1.126"></a><span id="l1.126">     // return the same DB connection since we didn't create a new one or do</span>
<a href="#l1.127"></a><span id="l1.127">     //  anything.</span>
<a href="#l1.128"></a><span id="l1.128">     return aDBConnection;</span>
<a href="#l1.129"></a><span id="l1.129">   },</span>
<a href="#l1.130"></a><span id="l1.130"> </span>
<a href="#l1.131"></a><span id="l1.131">   /**</span>
<a href="#l1.132"></a><span id="l1.132">    * Asynchronously update the schema version; only for use by in-tree callers</span>
<a href="#l1.133"></a><span id="l1.133">    *  who asynchronously perform migration work triggered by their initial</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

