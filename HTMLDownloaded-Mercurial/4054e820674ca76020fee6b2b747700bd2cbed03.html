<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26506:4054e820674ca76020fee6b2b747700bd2cbed03</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 4054e820674ca76020fee6b2b747700bd2cbed03" />
<meta property="og:url" content="/comm-central/rev/4054e820674ca76020fee6b2b747700bd2cbed03" />
<meta property="og:description" content="Bug 1531595 - Remove Box and Hightail FileLink providers; r=Fallen" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 4054e820674ca76020fee6b2b747700bd2cbed03 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/4054e820674ca76020fee6b2b747700bd2cbed03">shortlog</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/4054e820674ca76020fee6b2b747700bd2cbed03">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/4054e820674ca76020fee6b2b747700bd2cbed03">files</a> |
changeset |
<a href="/comm-central/raw-rev/4054e820674ca76020fee6b2b747700bd2cbed03">raw</a>  | <a href="/comm-central/archive/4054e820674ca76020fee6b2b747700bd2cbed03.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1531595">Bug 1531595</a> - Remove Box and Hightail FileLink providers; r=Fallen
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 03 May 2019 16:49:15 +1200</td></tr>

<tr>
 <td>changeset 26506</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/4054e820674ca76020fee6b2b747700bd2cbed03">4054e820674ca76020fee6b2b747700bd2cbed03</a></td>
</tr>



<tr>
<td>parent 26505</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ff752764d9f77667f8d5efe75a60501749bd3c46">ff752764d9f77667f8d5efe75a60501749bd3c46</a>
</td>
</tr>

<tr>
<td>child 26507</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/17a0eac83bc55c87a6f0dbe706c78b06d99a8354">17a0eac83bc55c87a6f0dbe706c78b06d99a8354</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=4054e820674ca76020fee6b2b747700bd2cbed03">15866</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Fri, 03 May 2019 04:53:23 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4054e820674c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4054e820674ca76020fee6b2b747700bd2cbed03">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4054e820674ca76020fee6b2b747700bd2cbed03&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4054e820674ca76020fee6b2b747700bd2cbed03&newProject=comm-central&newRevision=ff752764d9f77667f8d5efe75a60501749bd3c46&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4054e820674ca76020fee6b2b747700bd2cbed03&newProject=comm-central&newRevision=ff752764d9f77667f8d5efe75a60501749bd3c46&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4054e820674ca76020fee6b2b747700bd2cbed03&newProject=comm-central&newRevision=ff752764d9f77667f8d5efe75a60501749bd3c46&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Fallen%29&revcount=50">Fallen</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1531595">1531595</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1531595">Bug 1531595</a> - Remove Box and Hightail FileLink providers; r=Fallen</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/app/profile/all-thunderbird.js">mail/app/profile/all-thunderbird.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4054e820674ca76020fee6b2b747700bd2cbed03/mail/app/profile/all-thunderbird.js">file</a> |
<a href="/comm-central/annotate/4054e820674ca76020fee6b2b747700bd2cbed03/mail/app/profile/all-thunderbird.js">annotate</a> |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/app/profile/all-thunderbird.js">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/app/profile/all-thunderbird.js">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/app/profile/all-thunderbird.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/box/box.jsm">mail/components/cloudfile/box/box.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/box/box.jsm">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/box/box.jsm">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/box/box.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/box/management.js">mail/components/cloudfile/box/management.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/box/management.js">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/box/management.js">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/box/management.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/box/management.xhtml">mail/components/cloudfile/box/management.xhtml</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/box/management.xhtml">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/box/management.xhtml">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/box/management.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/cloudFileAccounts.jsm">mail/components/cloudfile/cloudFileAccounts.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/cloudFileAccounts.jsm">file</a> |
<a href="/comm-central/annotate/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/cloudFileAccounts.jsm">annotate</a> |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/cloudFileAccounts.jsm">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/cloudFileAccounts.jsm">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/cloudFileAccounts.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/fileExceeds2GB.xul">mail/components/cloudfile/hightail/fileExceeds2GB.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/fileExceeds2GB.xul">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/fileExceeds2GB.xul">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/fileExceeds2GB.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/fileExceedsLimit.xul">mail/components/cloudfile/hightail/fileExceedsLimit.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/fileExceedsLimit.xul">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/fileExceedsLimit.xul">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/fileExceedsLimit.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/fileExceedsQuota.js">mail/components/cloudfile/hightail/fileExceedsQuota.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/fileExceedsQuota.js">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/fileExceedsQuota.js">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/fileExceedsQuota.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/fileExceedsQuota.xul">mail/components/cloudfile/hightail/fileExceedsQuota.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/fileExceedsQuota.xul">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/fileExceedsQuota.xul">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/fileExceedsQuota.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/hightail.jsm">mail/components/cloudfile/hightail/hightail.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/hightail.jsm">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/hightail.jsm">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/hightail.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/management.js">mail/components/cloudfile/hightail/management.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/management.js">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/management.js">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/management.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/management.xhtml">mail/components/cloudfile/hightail/management.xhtml</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/management.xhtml">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/management.xhtml">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/hightail/management.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/jar.mn">mail/components/cloudfile/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/jar.mn">file</a> |
<a href="/comm-central/annotate/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/jar.mn">annotate</a> |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/jar.mn">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/jar.mn">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/cloudfile/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/preferences/applications.js">mail/components/preferences/applications.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/preferences/applications.js">file</a> |
<a href="/comm-central/annotate/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/preferences/applications.js">annotate</a> |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/preferences/applications.js">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/preferences/applications.js">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/preferences/applications.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/preferences/test/browser/browser_cloudfile.js">mail/components/preferences/test/browser/browser_cloudfile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/preferences/test/browser/browser_cloudfile.js">file</a> |
<a href="/comm-central/annotate/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/preferences/test/browser/browser_cloudfile.js">annotate</a> |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/preferences/test/browser/browser_cloudfile.js">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/preferences/test/browser/browser_cloudfile.js">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/components/preferences/test/browser/browser_cloudfile.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/installer/allowed-dupes.mn">mail/installer/allowed-dupes.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4054e820674ca76020fee6b2b747700bd2cbed03/mail/installer/allowed-dupes.mn">file</a> |
<a href="/comm-central/annotate/4054e820674ca76020fee6b2b747700bd2cbed03/mail/installer/allowed-dupes.mn">annotate</a> |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/installer/allowed-dupes.mn">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/installer/allowed-dupes.mn">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/installer/allowed-dupes.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Box/management.dtd">mail/locales/en-US/chrome/messenger/cloudfile/Box/management.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Box/management.dtd">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Box/management.dtd">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Box/management.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceeds2GB.dtd">mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceeds2GB.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceeds2GB.dtd">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceeds2GB.dtd">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceeds2GB.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceedsLimit.dtd">mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceedsLimit.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceedsLimit.dtd">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceedsLimit.dtd">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceedsLimit.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceedsQuota.dtd">mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceedsQuota.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceedsQuota.dtd">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceedsQuota.dtd">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceedsQuota.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/management.dtd">mail/locales/en-US/chrome/messenger/cloudfile/Hightail/management.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/management.dtd">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/management.dtd">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/management.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/management.dtd">mail/locales/en-US/chrome/messenger/cloudfile/management.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/management.dtd">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/management.dtd">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/en-US/chrome/messenger/cloudfile/management.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/jar.mn">mail/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js">mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4054e820674ca76020fee6b2b747700bd2cbed03/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">file</a> |
<a href="/comm-central/annotate/4054e820674ca76020fee6b2b747700bd2cbed03/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">annotate</a> |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/jar.mn">mail/themes/linux/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/jar.mn">file</a> |
<a href="/comm-central/annotate/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/jar.mn">annotate</a> |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/jar.mn">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/jar.mn">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/mail/cloudfile/Hightail/check.png">mail/themes/linux/mail/cloudfile/Hightail/check.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/mail/cloudfile/Hightail/check.png">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/mail/cloudfile/Hightail/check.png">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/mail/cloudfile/Hightail/check.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/mail/cloudfile/Hightail/fileExceedsLimit.css">mail/themes/linux/mail/cloudfile/Hightail/fileExceedsLimit.css</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/mail/cloudfile/Hightail/fileExceedsLimit.css">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/mail/cloudfile/Hightail/fileExceedsLimit.css">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/mail/cloudfile/Hightail/fileExceedsLimit.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/mail/icons/box-logo.png">mail/themes/linux/mail/icons/box-logo.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/mail/icons/box-logo.png">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/mail/icons/box-logo.png">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/mail/icons/box-logo.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/mail/icons/hightail.png">mail/themes/linux/mail/icons/hightail.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/mail/icons/hightail.png">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/mail/icons/hightail.png">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/linux/mail/icons/hightail.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/jar.mn">mail/themes/osx/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/jar.mn">file</a> |
<a href="/comm-central/annotate/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/jar.mn">annotate</a> |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/jar.mn">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/jar.mn">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/mail/cloudfile/Hightail/check.png">mail/themes/osx/mail/cloudfile/Hightail/check.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/mail/cloudfile/Hightail/check.png">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/mail/cloudfile/Hightail/check.png">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/mail/cloudfile/Hightail/check.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/mail/cloudfile/Hightail/fileExceedsLimit.css">mail/themes/osx/mail/cloudfile/Hightail/fileExceedsLimit.css</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/mail/cloudfile/Hightail/fileExceedsLimit.css">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/mail/cloudfile/Hightail/fileExceedsLimit.css">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/mail/cloudfile/Hightail/fileExceedsLimit.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/mail/icons/box-logo.png">mail/themes/osx/mail/icons/box-logo.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/mail/icons/box-logo.png">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/mail/icons/box-logo.png">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/mail/icons/box-logo.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/mail/icons/hightail.png">mail/themes/osx/mail/icons/hightail.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/mail/icons/hightail.png">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/mail/icons/hightail.png">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/osx/mail/icons/hightail.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/jar.mn">mail/themes/windows/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/jar.mn">file</a> |
<a href="/comm-central/annotate/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/jar.mn">annotate</a> |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/jar.mn">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/jar.mn">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/mail/cloudfile/Hightail/check.png">mail/themes/windows/mail/cloudfile/Hightail/check.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/mail/cloudfile/Hightail/check.png">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/mail/cloudfile/Hightail/check.png">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/mail/cloudfile/Hightail/check.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/mail/cloudfile/Hightail/fileExceedsLimit.css">mail/themes/windows/mail/cloudfile/Hightail/fileExceedsLimit.css</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/mail/cloudfile/Hightail/fileExceedsLimit.css">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/mail/cloudfile/Hightail/fileExceedsLimit.css">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/mail/cloudfile/Hightail/fileExceedsLimit.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/mail/icons/box-logo.png">mail/themes/windows/mail/icons/box-logo.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/mail/icons/box-logo.png">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/mail/icons/box-logo.png">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/mail/icons/box-logo.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/mail/icons/hightail.png">mail/themes/windows/mail/icons/hightail.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/mail/icons/hightail.png">diff</a> |
<a href="/comm-central/comparison/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/mail/icons/hightail.png">comparison</a> |
<a href="/comm-central/log/4054e820674ca76020fee6b2b747700bd2cbed03/mail/themes/windows/mail/icons/hightail.png">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/app/profile/all-thunderbird.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/app/profile/all-thunderbird.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -804,17 +804,17 @@ pref(&quot;security.sandbox.content.mac.early</span>
<a href="#l1.4"></a><span id="l1.4"> #endif</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> // Enable FIDO U2F</span>
<a href="#l1.7"></a><span id="l1.7"> pref(&quot;security.webauth.u2f&quot;, true);</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> #if defined(DEBUG)</span>
<a href="#l1.10"></a><span id="l1.10"> // Allow eval in these files, see bug 1522608.</span>
<a href="#l1.11"></a><span id="l1.11"> pref(&quot;security.allow_eval_with_system_principal&quot;, false);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-pref(&quot;security.uris_using_eval_with_system_principal&quot;, &quot;ajv-4.1.1.js,autocomplete.xml,box.jsm,calDavCalendar.js,chrometask_chromescript,content-task.js,dialog.xml,gdataSession.jsm,helperappdlg.jsm,jsol.js,jszip.js,lodash.js,parent_utils.js,preferencesbindings.js,react-redux.js,redux.js,setup,sinon-7.2.7.js,tree.xml,updates.js&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+pref(&quot;security.uris_using_eval_with_system_principal&quot;, &quot;ajv-4.1.1.js,autocomplete.xml,calDavCalendar.js,chrometask_chromescript,content-task.js,dialog.xml,gdataSession.jsm,helperappdlg.jsm,jsol.js,jszip.js,lodash.js,parent_utils.js,preferencesbindings.js,react-redux.js,redux.js,setup,sinon-7.2.7.js,tree.xml,updates.js&quot;);</span>
<a href="#l1.14"></a><span id="l1.14"> #endif</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> // Use OS date and time settings by default.</span>
<a href="#l1.17"></a><span id="l1.17"> pref(&quot;intl.regional_prefs.use_os_locales&quot;, true);</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> // Multi-lingual preferences</span>
<a href="#l1.20"></a><span id="l1.20"> pref(&quot;intl.multilingual.enabled&quot;, false);</span>
<a href="#l1.21"></a><span id="l1.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">deleted file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- a/mail/components/cloudfile/box/box.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ /dev/null</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -1,809 +0,0 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineminus">-</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineminus">-/* This is the Box cloudfile provider.</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineminus">- * It's in a JSM that exports nothing because it's a self-contained singleton. */</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineminus">-</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-/* globals kClientId, kClientSecret */</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-this.EXPORTED_SYMBOLS = [];</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-var {Log4Moz} = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-var {OAuth2} = ChromeUtils.import(&quot;resource:///modules/OAuth2.jsm&quot;);</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-var {httpRequest} = ChromeUtils.import(&quot;resource://gre/modules/Http.jsm&quot;);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-var gServerUrl = &quot;https://api.box.com/2.0/&quot;;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-var gUploadUrl = &quot;https://upload.box.com/api/2.0/&quot;;</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-var kAuthBaseUrl = &quot;https://www.box.com/api/&quot;;</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-var kAuthUrl = &quot;oauth2/authorize&quot;;</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-function nsBox() {</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-  this.log = Log4Moz.getConfiguredLogger(&quot;BoxService&quot;);</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-  this._oauth = new OAuth2(kAuthBaseUrl, null, kClientId, kClientSecret);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  this._oauth.authURI = kAuthBaseUrl + kAuthUrl;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-  let account = this;</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-  Object.defineProperty(this._oauth, &quot;refreshToken&quot;, {</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-    get() {</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-      if (!this.mRefreshToken) {</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-        let authToken = cloudFileAccounts.getSecretValue(account.accountKey,</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-                                                         cloudFileAccounts.kTokenRealm);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-        this.mRefreshToken = authToken || &quot;&quot;;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-      }</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-      return this.mRefreshToken;</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-    },</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-    set(aVal) {</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-      if (!aVal)</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-        aVal = &quot;&quot;;</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-      cloudFileAccounts.setSecretValue(account.accountKey,</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-                                       cloudFileAccounts.kTokenRealm,</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-                                       aVal);</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-      return (this.mRefreshToken = aVal);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-    },</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-    enumerable: true,</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-  });</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-}</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-nsBox.prototype = {</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-  get type() { return &quot;Box&quot;; },</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-  get displayName() { return &quot;Box&quot;; },</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-  get serviceURL() { return &quot;https://www.box.com/thunderbird&quot;; },</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-  get iconURL() { return &quot;chrome://messenger/skin/icons/box-logo.png&quot;; },</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-  get accountKey() { return this._accountKey; },</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-  get lastError() { return this._lastErrorText; },</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-  get settingsURL() { return &quot;chrome://messenger/content/cloudfile/Box/settings.xhtml&quot;; },</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-  get managementURL() { return &quot;chrome://messenger/content/cloudfile/Box/management.xhtml&quot;; },</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-  get configured() {</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-    return !!cloudFileAccounts.getSecretValue(this._accountKey, cloudFileAccounts.kTokenRealm);</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-  },</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-  completionURI: &quot;http://boxauthcallback.local/&quot;,</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-  _accountKey: false,</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-  _prefBranch: null,</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-  _folderId: &quot;&quot;,</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-  // If an access token exists, the user is logged in.</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-  get _loggedIn() { return !!this._oauth.accessToken; },</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-  _userInfo: null,</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-  _file: null,</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-  _maxFileSize: -1,</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-  _fileSpaceUsed: -1,</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-  _totalStorage: -1,</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-  _lastErrorText: &quot;&quot;,</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-  _uploadingFile: null,</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-  _uploader: null,</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-  _urlsForFiles: {},</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-  _uploadInfo: {},</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-  _uploads: [],</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-  _oauth: null,</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-  /**</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-   * Used by our testing framework to override the URLs that this component</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-   * communicates to.</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-   */</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-  overrideUrls(aNumUrls, aUrls) {</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-    gServerUrl = aUrls[0];</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-  },</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-  /**</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-   * Initializes an instance of this nsIMsgCloudFileProvider for an account</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-   * with key aAccountKey.</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-   *</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-   * @param aAccountKey the account key to initialize this</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-   *                    nsIMsgCloudFileProvider with.</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-   */</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-  init(aAccountKey) {</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-    this._accountKey = aAccountKey;</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-    this._prefBranch = Services.prefs.getBranch(`mail.cloud_files.accounts.${aAccountKey}.`);</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-  },</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-  /**</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-   * Private function for assigning the folder id from a cached version</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-   * If the folder doesn't exist, check if it exists on the server. If it</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-   * doesn't, set in motion the creation.</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-   *</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-   * @param aCallback called if folder is ready.</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-   */</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-  _initFolder(aCallback) {</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-    this.log.info(&quot;_initFolder, cached folder id  = &quot; + this._cachedFolderId);</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-    let saveFolderId = (aFolderId) =&gt; {</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-      this.log.info(&quot;saveFolderId : &quot; + aFolderId);</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-      this._cachedFolderId = this._folderId = aFolderId;</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-      if (aCallback)</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-        aCallback();</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-    };</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-    let createThunderbirdFolder = () =&gt; {</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-      this._createFolder(&quot;Thunderbird&quot;, saveFolderId);</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-    };</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-    // If there's no cached folder, try to get one, otherwise create one.</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-    if (this._cachedFolderId == &quot;&quot;) {</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-      this._getFolder(&quot;Thunderbird&quot;, saveFolderId, createThunderbirdFolder);</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-    } else {</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-      this._folderId = this._cachedFolderId;</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-      if (aCallback)</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-        aCallback();</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-    }</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-  },</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-  /**</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-   * Private callback function passed to, and called from</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-   * nsBoxFileUploader.</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-   *</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-   * @param aRequestObserver a request observer for monitoring the start and</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-   *                         stop states of a request.</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-   * @param aStatus the status of the request.</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-   */</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-  _uploaderCallback(aRequestObserver, aStatus) {</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-    aRequestObserver.onStopRequest(null, aStatus);</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-    this._uploadingFile = null;</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-    this._uploads.shift();</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-    if (this._uploads.length &gt; 0) {</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-      let nextUpload = this._uploads[0];</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-      this.log.info(&quot;chaining upload, file = &quot; + nextUpload.file.leafName);</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-      this._uploadingFile = nextUpload.file;</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-      this._uploader = nextUpload;</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-      try {</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-        this.uploadFile(nextUpload.file, nextUpload.requestObserver);</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-      } catch (ex) {</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-        nextUpload.callback(nextUpload.requestObserver, Cr.NS_ERROR_FAILURE);</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-      }</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-    } else {</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-      this._uploader = null;</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-    }</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-  },</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-  /**</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-   * Attempt to upload a file to Box's servers.</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-   *</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-   * @param aFile an nsIFile for uploading.</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-   * @param aCallback an nsIRequestObserver for monitoring the start and</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-   *                  stop states of the upload procedure.</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineminus">-   */</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineminus">-  uploadFile(aFile, aCallback) {</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-    if (Services.io.offline)</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-    this.log.info(&quot;uploading &quot; + aFile.leafName);</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-    // Some ugliness here - we stash requestObserver here, because we might</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-    // use it again in _getUserInfo.</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-    this.requestObserver = aCallback;</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineminus">-</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-    // if we're uploading a file, queue this request.</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-    if (this._uploadingFile &amp;&amp; this._uploadingFile != aFile) {</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-      let uploader = new nsBoxFileUploader(this, aFile,</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-                                               this._uploaderCallback</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-                                                   .bind(this),</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-                                               aCallback);</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineminus">-      this._uploads.push(uploader);</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-      return;</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-    }</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-    this._file = aFile;</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-    this._uploadingFile = aFile;</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-    let finish = function() {</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-      this._finishUpload(aFile, aCallback);</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-    }.bind(this);</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-    let onGetUserInfoSuccess = function() {</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-      this._initFolder(finish);</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-    }.bind(this);</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-    let onAuthFailure = function() {</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-      aCallback.onStopRequest(null, cloudFileAccounts.constants.authErr);</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-    };</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-    this.log.info(&quot;Checking to see if we're logged in&quot;);</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-    if (!this._loggedIn) {</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-      let onLoginSuccess = function() {</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-        this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-      }.bind(this);</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-      this.logon(onLoginSuccess, onAuthFailure, true);</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-      return;</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-    }</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineminus">-</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineminus">-    if (!this._userInfo) {</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-      this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineminus">-      return;</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineminus">-    }</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineminus">-    onGetUserInfoSuccess();</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineminus">-  },</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-  /**</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineminus">-   * A private function called when we're almost ready to kick off the upload</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineminus">-   * for a file. First, ensures that the file size is not too large, and that</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-   * we won't exceed our storage quota, and then kicks off the upload.</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-   *</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-   * @param aFile the nsIFile to upload</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-   * @param aCallback the nsIRequestObserver for monitoring the start and stop</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-   *                  states of the upload procedure.</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-   */</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-  _finishUpload(aFile, aCallback) {</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-    let exceedsFileLimit = cloudFileAccounts.constants.uploadExceedsFileLimit;</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-    let exceedsQuota = cloudFileAccounts.constants.uploadWouldExceedQuota;</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-    if (aFile.fileSize &gt; this._maxFileSize) {</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineminus">-      aCallback.onStopRequest(null, exceedsFileLimit);</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineminus">-      return;</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineminus">-    }</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineminus">-    if (aFile.fileSize &gt; this.remainingFileSpace) {</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineminus">-      aCallback.onStopRequest(null, exceedsQuota);</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-      return;</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-    }</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-    delete this._userInfo; // force us to update userInfo on every upload.</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-    if (!this._uploader) {</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-      this._uploader = new nsBoxFileUploader(this, aFile,</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-                                             this._uploaderCallback</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-                                                 .bind(this),</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-                                             aCallback);</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-      this._uploads.unshift(this._uploader);</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineminus">-    }</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-    this._uploadingFile = aFile;</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-    this._uploader.uploadFile();</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-  },</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-  /**</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-   * Cancels an in-progress file upload.</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-   *</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-   * @param aFile the nsIFile being uploaded.</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-   */</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-  cancelFileUpload(aFile) {</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-    if (this._uploadingFile.equals(aFile)) {</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-      this._uploader.cancel();</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">-    } else {</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-      for (let i = 0; i &lt; this._uploads.length; i++)</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">-        if (this._uploads[i].file.equals(aFile)) {</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineminus">-          this._uploads[i].requestObserver.onStopRequest(</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineminus">-            null, cloudFileAccounts.constants.uploadCancelled);</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-          this._uploads.splice(i, 1);</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-          return;</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-        }</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-    }</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-  },</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-  /**</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-   * A private function for retrieving profile information about a user.</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-   *</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineminus">-   * @param successCallback a callback fired if retrieving profile information</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineminus">-   *                        is successful.</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineminus">-   * @param failureCallback a callback fired if retrieving profile information</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-   *                        fails.</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-   */</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineminus">-  _getUserInfo(successCallback, failureCallback) {</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineminus">-    let requestUrl = gServerUrl + &quot;users/me&quot;;</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-    this.log.info(&quot;get_account_info requestUrl = &quot; + requestUrl);</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineminus">-    if (!successCallback)</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineminus">-      successCallback = function() {</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineminus">-        this.requestObserver</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineminus">-            .onStopRequest(null,</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineminus">-                           this._loggedIn ? Cr.NS_OK : cloudFileAccounts.constants.authErr);</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineminus">-    }.bind(this);</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineminus">-</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineminus">-    if (!failureCallback)</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineminus">-      failureCallback = function() {</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-        this.requestObserver</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-            .onStopRequest(null, cloudFileAccounts.constants.authErr);</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-    }.bind(this);</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-    let accountInfoSuccess = function(aResponseText, aRequest) {</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineminus">-      this.log.info(&quot;get_account_info request response = &quot; + aResponseText);</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineminus">-</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineminus">-      try {</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-        this._userInfo = JSON.parse(aResponseText);</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineminus">-</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineminus">-        if (!this._userInfo || !this._userInfo.id) {</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineminus">-          this.failureCallback();</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-          return;</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineminus">-        }</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineminus">-</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineminus">-        this._totalStorage = this._userInfo.space_amount;</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineminus">-        this._fileSpaceUsed = this._userInfo.space_used;</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineminus">-        this._maxFileSize = this._userInfo.max_upload_size;</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineminus">-        this.log.info(&quot;storage total = &quot; + this._totalStorage);</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineminus">-        this.log.info(&quot;storage used = &quot; + this._fileSpaceUsed);</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineminus">-        this.log.info(&quot;max file size = &quot; + this._maxFileSize);</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineminus">-        successCallback();</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineminus">-      } catch (e) {</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineminus">-        // most likely bad JSON</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineminus">-        this.log.error(&quot;Failed to parse account info response: &quot; + e);</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineminus">-        this.log.error(&quot;Account info response: &quot; + aResponseText);</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-        failureCallback();</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-      }</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineminus">-    }.bind(this);</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineminus">-    let accountInfoFailure = function(aException, aResponseText, aRequest) {</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-      this.log.info(&quot;Failed to acquire user info:&quot; + aResponseText);</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-      this.log.error(&quot;user info failed, status = &quot; + aRequest.status);</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-      this.log.error(&quot;response text = &quot; + aResponseText);</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineminus">-      this.log.error(&quot;exception = &quot; + aException);</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineminus">-      failureCallback();</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineminus">-    }.bind(this);</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineminus">-</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineminus">-    // Request to get user info</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineminus">-    httpRequest(requestUrl, {</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineminus">-                  onLoad: accountInfoSuccess,</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineminus">-                  onError: accountInfoFailure,</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineminus">-                  method: &quot;GET&quot;,</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineminus">-                  headers: [[&quot;Authorization&quot;, &quot;Bearer &quot; + this._oauth.accessToken]],</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineminus">-                });</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineminus">-  },</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineminus">-</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineminus">-  /**</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineminus">-   * A private function that first ensures that the user is logged in, and then</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineminus">-   * retrieves the user's profile information.</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">-   *</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineminus">-   * @param aSuccessCallback the function called on successful information</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineminus">-   *                         retrieval</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineminus">-   * @param aFailureCallback the function called on failed information retrieval</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineminus">-   * @param aWithUI a boolean for whether or not we should display authorization</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineminus">-   *                UI if we don't have a valid token anymore, or just fail out.</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineminus">-   */</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineminus">-  _logonAndGetUserInfo(aSuccessCallback, aFailureCallback, aWithUI) {</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineminus">-    if (!aFailureCallback)</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineminus">-      aFailureCallback = function() {</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineminus">-        this.requestObserver</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineminus">-            .onStopRequest(null, cloudFileAccounts.constants.authErr);</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-      }.bind(this);</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineminus">-</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineminus">-    return this.logon(function() {</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-      this._getUserInfo(aSuccessCallback, aFailureCallback);</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-    }.bind(this), aFailureCallback, aWithUI);</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-  },</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineminus">-</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineminus">-  /**</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineminus">-   * Returns the sharing URL for some uploaded file.</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineminus">-   *</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineminus">-   * @param aFile the nsIFile to get the URL for.</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineminus">-   */</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineminus">-  urlForFile(aFile) {</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineminus">-    return this._urlsForFiles[aFile.path];</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineminus">-  },</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineminus">-</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineminus">-  /**</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineminus">-   * Updates the profile information for the account associated with the</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineminus">-   * account key.</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineminus">-   *</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineminus">-   * @param aWithUI a boolean for whether or not we should display authorization</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineminus">-   *                UI if we don't have a valid token anymore, or just fail out.</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineminus">-   * @param aCallback an nsIRequestObserver for observing the starting and</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineminus">-   *                  ending states of the request.</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineminus">-   */</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineminus">-  refreshUserInfo(aWithUI, aCallback) {</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineminus">-    this.log.info(&quot;Getting User Info 1 : &quot; + this._loggedIn);</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-    if (Services.io.offline)</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineminus">-      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineminus">-    this.requestObserver = aCallback;</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineminus">-    aCallback.onStartRequest(null);</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineminus">-    if (!this._loggedIn)</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineminus">-      return this._logonAndGetUserInfo(null, null, aWithUI);</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineminus">-    if (!this._userInfo)</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineminus">-      return this._getUserInfo();</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineminus">-</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineminus">-    aCallback.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineminus">-    return this._userInfo;</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineminus">-  },</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineminus">-</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineminus">-  /**</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineminus">-   * Our Box implementation does not implement the createNewAccount</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineminus">-   * function defined in nsIMsgCloudFileProvider.idl.</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineminus">-   */</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineminus">-  createNewAccount(aEmailAddress, aPassword, aFirstName, aLastName) {</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineminus">-    return Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineminus">-  },</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineminus">-</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineminus">-  /**</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineminus">-   * Private function to get the ID of an already existing folder on the Box</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineminus">-   * website.</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineminus">-   *</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineminus">-   * @param aName name of folder</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineminus">-   * @param aSuccessCallback called if the folder exists</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineminus">-   * @param aFailureCallback called if the folder cannot be found</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineminus">-   */</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineminus">-  _getFolder(aName, aSuccessCallback, aFailureCallback) {</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineminus">-    this.log.info(&quot;Getting folder: &quot; + aName);</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineminus">-    if (Services.io.offline)</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineminus">-      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineminus">-</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineminus">-    // There's no API to search by name and we don't know the ID. Get the root</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineminus">-    // folder and search for this name inside of it.</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineminus">-    const ROOT_ID = &quot;0&quot;;</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineminus">-    let requestUrl = gServerUrl + &quot;folders/&quot; + ROOT_ID;</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineminus">-    this.log.info(&quot;get_folder requestUrl = &quot; + requestUrl);</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineminus">-</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineminus">-    let getSuccess = (aResponseText, aRequest) =&gt; {</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineminus">-      this.log.info(&quot;get_folder request response = &quot; + aResponseText);</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineminus">-</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineminus">-      let folderId = null;</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineminus">-      try {</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineminus">-        let result = JSON.parse(aResponseText);</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineminus">-</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineminus">-        // Ensure the JSON is somewhat valid.</span>
<a href="#l2.440"></a><span id="l2.440" class="difflineminus">-        if (!result || !result.item_collection) {</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineminus">-          this._lastErrorText = &quot;Get folder failure&quot;;</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineminus">-          return;</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineminus">-        }</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineminus">-</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineminus">-        // Search the paths for the folder.</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineminus">-        for (let item of result.item_collection.entries) {</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineminus">-          // Found it!</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineminus">-          if (item.type == &quot;folder&quot; &amp;&amp; item.name == aName) {</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineminus">-            folderId = item.id;</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineminus">-            break;</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineminus">-          }</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineminus">-        }</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineminus">-      } catch (e) {</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineminus">-        // most likely bad JSON</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineminus">-        this.log.error(&quot;Failed to get the folder:\n&quot; + e);</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineminus">-      }</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineminus">-</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineminus">-      // Return outside of the try-catch.</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineminus">-      if (folderId) {</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineminus">-        this.log.info(&quot;folder id = &quot; + folderId);</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineminus">-        aSuccessCallback(folderId);</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineminus">-      } else {</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineminus">-        // Didn't find any item.</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineminus">-        aFailureCallback();</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineminus">-      }</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineminus">-    };</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineminus">-    let getFailure = (aException, aResponseText, aRequest) =&gt; {</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineminus">-      this.log.error(&quot;Failed to get an existing folder: &quot; + aRequest.status);</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineminus">-    };</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineminus">-</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineminus">-    // Request to create the folder</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineminus">-    httpRequest(requestUrl, {</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineminus">-                  onLoad: getSuccess,</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineminus">-                  onError: getFailure,</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineminus">-                  method: &quot;GET&quot;,</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineminus">-                  headers: [[&quot;Authorization&quot;, &quot;Bearer &quot; + this._oauth.accessToken]],</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineminus">-                });</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineminus">-  },</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineminus">-</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineminus">-  /**</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineminus">-   * Private function for creating folder on the Box website.</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineminus">-   *</span>
<a href="#l2.483"></a><span id="l2.483" class="difflineminus">-   * @param aName name of folder</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineminus">-   * @param aSuccessCallback called when folder is created</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineminus">-   */</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineminus">-  _createFolder(aName, aSuccessCallback) {</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineminus">-    this.log.info(&quot;Creating folder: &quot; + aName);</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineminus">-    if (Services.io.offline)</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineminus">-      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineminus">-</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineminus">-    let body = {</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineminus">-      parent: {</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineminus">-        id: &quot;0&quot;,</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineminus">-      },</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineminus">-      name: aName,</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineminus">-    };</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineminus">-    let requestUrl = gServerUrl + &quot;folders&quot;;</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineminus">-    this.log.info(&quot;create_folder requestUrl = &quot; + requestUrl);</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineminus">-</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineminus">-    let createSuccess = function(aResponseText, aRequest) {</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineminus">-      this.log.info(&quot;create_folder request response = &quot; + aResponseText);</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineminus">-</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineminus">-      try {</span>
<a href="#l2.504"></a><span id="l2.504" class="difflineminus">-        let result = JSON.parse(aResponseText);</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineminus">-</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineminus">-        if (!result || !result.id) {</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineminus">-          this._lastErrorText = &quot;Create folder failure&quot;;</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineminus">-          return;</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineminus">-        }</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineminus">-        let folderId = result.id;</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineminus">-        this.log.info(&quot;folder id = &quot; + folderId);</span>
<a href="#l2.512"></a><span id="l2.512" class="difflineminus">-        aSuccessCallback(folderId);</span>
<a href="#l2.513"></a><span id="l2.513" class="difflineminus">-      } catch (e) {</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineminus">-        // most likely bad JSON</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineminus">-        this.log.error(&quot;Failed to create a new folder&quot;);</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineminus">-      }</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineminus">-    }.bind(this);</span>
<a href="#l2.518"></a><span id="l2.518" class="difflineminus">-    let createFailure = function(aException, aResponseText, aRequest) {</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineminus">-      this.log.error(&quot;Failed to create a new folder: &quot; + aRequest.status);</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineminus">-    }.bind(this);</span>
<a href="#l2.521"></a><span id="l2.521" class="difflineminus">-</span>
<a href="#l2.522"></a><span id="l2.522" class="difflineminus">-    // Request to create the folder</span>
<a href="#l2.523"></a><span id="l2.523" class="difflineminus">-    httpRequest(requestUrl, {</span>
<a href="#l2.524"></a><span id="l2.524" class="difflineminus">-                  onLoad: createSuccess,</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineminus">-                  onError: createFailure,</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineminus">-                  method: &quot;POST&quot;,</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineminus">-                  headers: [[&quot;Authorization&quot;, &quot;Bearer &quot; + this._oauth.accessToken]],</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineminus">-                  postData: JSON.stringify(body),</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineminus">-                });</span>
<a href="#l2.530"></a><span id="l2.530" class="difflineminus">-  },</span>
<a href="#l2.531"></a><span id="l2.531" class="difflineminus">-</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineminus">-  /**</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineminus">-   * If a the user associated with this account key already has an account,</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineminus">-   * allows them to log in.</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineminus">-   *</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineminus">-   * @param aRequestObserver an nsIRequestObserver for monitoring the start and</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineminus">-   *                         stop states of the login procedure.</span>
<a href="#l2.538"></a><span id="l2.538" class="difflineminus">-   */</span>
<a href="#l2.539"></a><span id="l2.539" class="difflineminus">-  createExistingAccount(aRequestObserver) {</span>
<a href="#l2.540"></a><span id="l2.540" class="difflineminus">-     // XXX: replace this with a better function</span>
<a href="#l2.541"></a><span id="l2.541" class="difflineminus">-    let successCb = () =&gt; {</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineminus">-      aRequestObserver.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineminus">-    };</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineminus">-</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineminus">-    let failureCb = (aResponseText) =&gt; {</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineminus">-      aRequestObserver.onStopRequest(null, cloudFileAccounts.constants.authErr);</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineminus">-    };</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineminus">-</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineminus">-    this.logon(successCb, failureCb, true);</span>
<a href="#l2.550"></a><span id="l2.550" class="difflineminus">-  },</span>
<a href="#l2.551"></a><span id="l2.551" class="difflineminus">-</span>
<a href="#l2.552"></a><span id="l2.552" class="difflineminus">-  /**</span>
<a href="#l2.553"></a><span id="l2.553" class="difflineminus">-   * Returns an appropriate provider-specific URL for dealing with a particular</span>
<a href="#l2.554"></a><span id="l2.554" class="difflineminus">-   * error type.</span>
<a href="#l2.555"></a><span id="l2.555" class="difflineminus">-   *</span>
<a href="#l2.556"></a><span id="l2.556" class="difflineminus">-   * @param aError an error to get the URL for.</span>
<a href="#l2.557"></a><span id="l2.557" class="difflineminus">-   */</span>
<a href="#l2.558"></a><span id="l2.558" class="difflineminus">-  providerUrlForError(aError) {</span>
<a href="#l2.559"></a><span id="l2.559" class="difflineminus">-    if (aError == cloudFileAccounts.constants.uploadWouldExceedQuota)</span>
<a href="#l2.560"></a><span id="l2.560" class="difflineminus">-      return &quot;https://www.box.com/pricing/&quot;;</span>
<a href="#l2.561"></a><span id="l2.561" class="difflineminus">-    return &quot;&quot;;</span>
<a href="#l2.562"></a><span id="l2.562" class="difflineminus">-  },</span>
<a href="#l2.563"></a><span id="l2.563" class="difflineminus">-</span>
<a href="#l2.564"></a><span id="l2.564" class="difflineminus">-  /**</span>
<a href="#l2.565"></a><span id="l2.565" class="difflineminus">-   * If the provider doesn't have an API for creating an account, perhaps</span>
<a href="#l2.566"></a><span id="l2.566" class="difflineminus">-   * there's a url we can load in a content tab that will allow the user</span>
<a href="#l2.567"></a><span id="l2.567" class="difflineminus">-   * to create an account.</span>
<a href="#l2.568"></a><span id="l2.568" class="difflineminus">-   */</span>
<a href="#l2.569"></a><span id="l2.569" class="difflineminus">-  get createNewAccountUrl() { return &quot;&quot;; },</span>
<a href="#l2.570"></a><span id="l2.570" class="difflineminus">-</span>
<a href="#l2.571"></a><span id="l2.571" class="difflineminus">-  /**</span>
<a href="#l2.572"></a><span id="l2.572" class="difflineminus">-   * If we don't know the limit, this will return -1.</span>
<a href="#l2.573"></a><span id="l2.573" class="difflineminus">-   */</span>
<a href="#l2.574"></a><span id="l2.574" class="difflineminus">-  get fileUploadSizeLimit() { return this._maxFileSize; },</span>
<a href="#l2.575"></a><span id="l2.575" class="difflineminus">-  get remainingFileSpace() { return this._totalStorage - this._fileSpaceUsed; },</span>
<a href="#l2.576"></a><span id="l2.576" class="difflineminus">-  get fileSpaceUsed() { return this._fileSpaceUsed; },</span>
<a href="#l2.577"></a><span id="l2.577" class="difflineminus">-</span>
<a href="#l2.578"></a><span id="l2.578" class="difflineminus">-  /**</span>
<a href="#l2.579"></a><span id="l2.579" class="difflineminus">-   * Attempts to delete an uploaded file.</span>
<a href="#l2.580"></a><span id="l2.580" class="difflineminus">-   *</span>
<a href="#l2.581"></a><span id="l2.581" class="difflineminus">-   * @param aFile the nsIFile to delete.</span>
<a href="#l2.582"></a><span id="l2.582" class="difflineminus">-   * @param aCallback an nsIRequestObserver for monitoring the start and stop</span>
<a href="#l2.583"></a><span id="l2.583" class="difflineminus">-   *                  states of the delete procedure.</span>
<a href="#l2.584"></a><span id="l2.584" class="difflineminus">-   */</span>
<a href="#l2.585"></a><span id="l2.585" class="difflineminus">-  deleteFile(aFile, aCallback) {</span>
<a href="#l2.586"></a><span id="l2.586" class="difflineminus">-    this.log.info(&quot;Deleting a file&quot;);</span>
<a href="#l2.587"></a><span id="l2.587" class="difflineminus">-</span>
<a href="#l2.588"></a><span id="l2.588" class="difflineminus">-    if (Services.io.offline) {</span>
<a href="#l2.589"></a><span id="l2.589" class="difflineminus">-      this.log.error(&quot;We're offline - we can't delete the file.&quot;);</span>
<a href="#l2.590"></a><span id="l2.590" class="difflineminus">-      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l2.591"></a><span id="l2.591" class="difflineminus">-    }</span>
<a href="#l2.592"></a><span id="l2.592" class="difflineminus">-</span>
<a href="#l2.593"></a><span id="l2.593" class="difflineminus">-    let uploadInfo = this._uploadInfo[aFile.path];</span>
<a href="#l2.594"></a><span id="l2.594" class="difflineminus">-    if (!uploadInfo) {</span>
<a href="#l2.595"></a><span id="l2.595" class="difflineminus">-      this.log.error(&quot;Could not find a record for the file to be deleted.&quot;);</span>
<a href="#l2.596"></a><span id="l2.596" class="difflineminus">-      throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l2.597"></a><span id="l2.597" class="difflineminus">-    }</span>
<a href="#l2.598"></a><span id="l2.598" class="difflineminus">-</span>
<a href="#l2.599"></a><span id="l2.599" class="difflineminus">-    let requestUrl = gServerUrl + &quot;files/&quot; + uploadInfo.fileId;</span>
<a href="#l2.600"></a><span id="l2.600" class="difflineminus">-    this.log.info(&quot;delete requestUrl = &quot; + requestUrl);</span>
<a href="#l2.601"></a><span id="l2.601" class="difflineminus">-</span>
<a href="#l2.602"></a><span id="l2.602" class="difflineminus">-    let deleteSuccess = function(aResponseText, aRequest) {</span>
<a href="#l2.603"></a><span id="l2.603" class="difflineminus">-      // An empty 204 is sent on successful delete.</span>
<a href="#l2.604"></a><span id="l2.604" class="difflineminus">-      this.log.info(&quot;delete request response = &quot; + aRequest.status);</span>
<a href="#l2.605"></a><span id="l2.605" class="difflineminus">-</span>
<a href="#l2.606"></a><span id="l2.606" class="difflineminus">-      if (aRequest.status != 204)</span>
<a href="#l2.607"></a><span id="l2.607" class="difflineminus">-        aCallback.onStopRequest(null, Cr.NS_ERROR_FAILURE);</span>
<a href="#l2.608"></a><span id="l2.608" class="difflineminus">-    }.bind(this);</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineminus">-    let deleteFailure = function(aException, aResponseText, aRequest) {</span>
<a href="#l2.610"></a><span id="l2.610" class="difflineminus">-      this.log.error(&quot;Failed to delete file:&quot; + aResponseText);</span>
<a href="#l2.611"></a><span id="l2.611" class="difflineminus">-      aCallback.onStopRequest(null, Cr.NS_ERROR_FAILURE);</span>
<a href="#l2.612"></a><span id="l2.612" class="difflineminus">-    }.bind(this);</span>
<a href="#l2.613"></a><span id="l2.613" class="difflineminus">-</span>
<a href="#l2.614"></a><span id="l2.614" class="difflineminus">-    // Request to delete a file</span>
<a href="#l2.615"></a><span id="l2.615" class="difflineminus">-    httpRequest(requestUrl, {</span>
<a href="#l2.616"></a><span id="l2.616" class="difflineminus">-                  onLoad: deleteSuccess,</span>
<a href="#l2.617"></a><span id="l2.617" class="difflineminus">-                  onError: deleteFailure,</span>
<a href="#l2.618"></a><span id="l2.618" class="difflineminus">-                  method: &quot;DELETE&quot;,</span>
<a href="#l2.619"></a><span id="l2.619" class="difflineminus">-                  headers: [[&quot;Authorization&quot;, &quot;Bearer &quot; + this._oauth.accessToken]],</span>
<a href="#l2.620"></a><span id="l2.620" class="difflineminus">-                });</span>
<a href="#l2.621"></a><span id="l2.621" class="difflineminus">-  },</span>
<a href="#l2.622"></a><span id="l2.622" class="difflineminus">-</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineminus">-  /**</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineminus">-   * Attempt to log on and get the auth token for this Box account.</span>
<a href="#l2.625"></a><span id="l2.625" class="difflineminus">-   *</span>
<a href="#l2.626"></a><span id="l2.626" class="difflineminus">-   * @param successCallback the callback to be fired if logging on is successful</span>
<a href="#l2.627"></a><span id="l2.627" class="difflineminus">-   * @param failureCallback the callback to be fired if loggong on fails</span>
<a href="#l2.628"></a><span id="l2.628" class="difflineminus">-   * @aparam aWithUI a boolean for whether or not we should prompt for a password</span>
<a href="#l2.629"></a><span id="l2.629" class="difflineminus">-   *                 if no auth token is currently stored.</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineminus">-   */</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineminus">-  logon(successCallback, failureCallback, aWithUI) {</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineminus">-    // The token has expired, reauthenticate.</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineminus">-    if (this._oauth.tokenExpires &lt; (new Date()).getTime()) {</span>
<a href="#l2.634"></a><span id="l2.634" class="difflineminus">-      this._oauth.connect(successCallback, failureCallback, aWithUI);</span>
<a href="#l2.635"></a><span id="l2.635" class="difflineminus">-    } else {</span>
<a href="#l2.636"></a><span id="l2.636" class="difflineminus">-      // The token is still valid, success!</span>
<a href="#l2.637"></a><span id="l2.637" class="difflineminus">-      successCallback();</span>
<a href="#l2.638"></a><span id="l2.638" class="difflineminus">-    }</span>
<a href="#l2.639"></a><span id="l2.639" class="difflineminus">-  },</span>
<a href="#l2.640"></a><span id="l2.640" class="difflineminus">-</span>
<a href="#l2.641"></a><span id="l2.641" class="difflineminus">-  get _cachedFolderId() {</span>
<a href="#l2.642"></a><span id="l2.642" class="difflineminus">-    return this._prefBranch.getCharPref(&quot;folderid&quot;, &quot;&quot;);</span>
<a href="#l2.643"></a><span id="l2.643" class="difflineminus">-  },</span>
<a href="#l2.644"></a><span id="l2.644" class="difflineminus">-</span>
<a href="#l2.645"></a><span id="l2.645" class="difflineminus">-  set _cachedFolderId(aVal) {</span>
<a href="#l2.646"></a><span id="l2.646" class="difflineminus">-    if (!aVal)</span>
<a href="#l2.647"></a><span id="l2.647" class="difflineminus">-      aVal = &quot;&quot;;</span>
<a href="#l2.648"></a><span id="l2.648" class="difflineminus">-</span>
<a href="#l2.649"></a><span id="l2.649" class="difflineminus">-    this._prefBranch.setCharPref(&quot;folderid&quot;, aVal);</span>
<a href="#l2.650"></a><span id="l2.650" class="difflineminus">-  },</span>
<a href="#l2.651"></a><span id="l2.651" class="difflineminus">-};</span>
<a href="#l2.652"></a><span id="l2.652" class="difflineminus">-</span>
<a href="#l2.653"></a><span id="l2.653" class="difflineminus">-function nsBoxFileUploader(aBox, aFile, aCallback,</span>
<a href="#l2.654"></a><span id="l2.654" class="difflineminus">-                                 aRequestObserver) {</span>
<a href="#l2.655"></a><span id="l2.655" class="difflineminus">-  this.box = aBox;</span>
<a href="#l2.656"></a><span id="l2.656" class="difflineminus">-  this.log = this.box.log;</span>
<a href="#l2.657"></a><span id="l2.657" class="difflineminus">-  this.log.info(&quot;new nsBoxFileUploader file = &quot; + aFile.leafName);</span>
<a href="#l2.658"></a><span id="l2.658" class="difflineminus">-  this.file = aFile;</span>
<a href="#l2.659"></a><span id="l2.659" class="difflineminus">-  this.callback = aCallback;</span>
<a href="#l2.660"></a><span id="l2.660" class="difflineminus">-  this.requestObserver = aRequestObserver;</span>
<a href="#l2.661"></a><span id="l2.661" class="difflineminus">-}</span>
<a href="#l2.662"></a><span id="l2.662" class="difflineminus">-</span>
<a href="#l2.663"></a><span id="l2.663" class="difflineminus">-nsBoxFileUploader.prototype = {</span>
<a href="#l2.664"></a><span id="l2.664" class="difflineminus">-  box: null,</span>
<a href="#l2.665"></a><span id="l2.665" class="difflineminus">-  file: null,</span>
<a href="#l2.666"></a><span id="l2.666" class="difflineminus">-  callback: null,</span>
<a href="#l2.667"></a><span id="l2.667" class="difflineminus">-  request: null,</span>
<a href="#l2.668"></a><span id="l2.668" class="difflineminus">-</span>
<a href="#l2.669"></a><span id="l2.669" class="difflineminus">-  /**</span>
<a href="#l2.670"></a><span id="l2.670" class="difflineminus">-   * Do the upload of the file to Box.</span>
<a href="#l2.671"></a><span id="l2.671" class="difflineminus">-   */</span>
<a href="#l2.672"></a><span id="l2.672" class="difflineminus">-  uploadFile() {</span>
<a href="#l2.673"></a><span id="l2.673" class="difflineminus">-    this.requestObserver.onStartRequest(null);</span>
<a href="#l2.674"></a><span id="l2.674" class="difflineminus">-    let requestUrl = gUploadUrl + &quot;files/content&quot;;</span>
<a href="#l2.675"></a><span id="l2.675" class="difflineminus">-    this.box._uploadInfo[this.file.path] = {};</span>
<a href="#l2.676"></a><span id="l2.676" class="difflineminus">-    this.box._uploadInfo[this.file.path].uploadUrl = requestUrl;</span>
<a href="#l2.677"></a><span id="l2.677" class="difflineminus">-</span>
<a href="#l2.678"></a><span id="l2.678" class="difflineminus">-    let req = new XMLHttpRequest();</span>
<a href="#l2.679"></a><span id="l2.679" class="difflineminus">-</span>
<a href="#l2.680"></a><span id="l2.680" class="difflineminus">-    this.log.info(&quot;upload url = &quot; + requestUrl);</span>
<a href="#l2.681"></a><span id="l2.681" class="difflineminus">-    this.request = req;</span>
<a href="#l2.682"></a><span id="l2.682" class="difflineminus">-    req.open(&quot;POST&quot;, requestUrl, true);</span>
<a href="#l2.683"></a><span id="l2.683" class="difflineminus">-    req.onload = function() {</span>
<a href="#l2.684"></a><span id="l2.684" class="difflineminus">-      if (req.status &gt;= 200 &amp;&amp; req.status &lt; 400) {</span>
<a href="#l2.685"></a><span id="l2.685" class="difflineminus">-        try {</span>
<a href="#l2.686"></a><span id="l2.686" class="difflineminus">-          this.log.info(&quot;upload response = &quot; + req.responseText);</span>
<a href="#l2.687"></a><span id="l2.687" class="difflineminus">-          let result = JSON.parse(req.responseText);</span>
<a href="#l2.688"></a><span id="l2.688" class="difflineminus">-</span>
<a href="#l2.689"></a><span id="l2.689" class="difflineminus">-          if (result.total_count &amp;&amp; result.total_count &gt; 0) {</span>
<a href="#l2.690"></a><span id="l2.690" class="difflineminus">-            // Request a shared link for this file.</span>
<a href="#l2.691"></a><span id="l2.691" class="difflineminus">-            let shareSuccess = function(aResponseText, aRequest) {</span>
<a href="#l2.692"></a><span id="l2.692" class="difflineminus">-              this.log.info(&quot;share response = &quot; + aResponseText);</span>
<a href="#l2.693"></a><span id="l2.693" class="difflineminus">-</span>
<a href="#l2.694"></a><span id="l2.694" class="difflineminus">-              let result = JSON.parse(aResponseText);</span>
<a href="#l2.695"></a><span id="l2.695" class="difflineminus">-              // If shared_link doesn't exist or is empty, an error occurred.</span>
<a href="#l2.696"></a><span id="l2.696" class="difflineminus">-              if (!result.shared_link || !result.shared_link.url) {</span>
<a href="#l2.697"></a><span id="l2.697" class="difflineminus">-                this.callback(this.requestObserver,</span>
<a href="#l2.698"></a><span id="l2.698" class="difflineminus">-                  cloudFileAccounts.constants.uploadErr);</span>
<a href="#l2.699"></a><span id="l2.699" class="difflineminus">-              }</span>
<a href="#l2.700"></a><span id="l2.700" class="difflineminus">-</span>
<a href="#l2.701"></a><span id="l2.701" class="difflineminus">-              // Can't use download_url because free accounts do not have access</span>
<a href="#l2.702"></a><span id="l2.702" class="difflineminus">-              // to provide direct download URLs.</span>
<a href="#l2.703"></a><span id="l2.703" class="difflineminus">-              let url = result.shared_link.url;</span>
<a href="#l2.704"></a><span id="l2.704" class="difflineminus">-              this.log.info(&quot;public_name = &quot; + url);</span>
<a href="#l2.705"></a><span id="l2.705" class="difflineminus">-              this.box._urlsForFiles[this.file.path] = url;</span>
<a href="#l2.706"></a><span id="l2.706" class="difflineminus">-</span>
<a href="#l2.707"></a><span id="l2.707" class="difflineminus">-              this.callback(this.requestObserver, Cr.NS_OK);</span>
<a href="#l2.708"></a><span id="l2.708" class="difflineminus">-            }.bind(this);</span>
<a href="#l2.709"></a><span id="l2.709" class="difflineminus">-            let shareFailure = function(aResponseText, aReqest) {</span>
<a href="#l2.710"></a><span id="l2.710" class="difflineminus">-              this.callback(this.requestObserver,</span>
<a href="#l2.711"></a><span id="l2.711" class="difflineminus">-                cloudFileAccounts.constants.uploadErr);</span>
<a href="#l2.712"></a><span id="l2.712" class="difflineminus">-            }.bind(this);</span>
<a href="#l2.713"></a><span id="l2.713" class="difflineminus">-</span>
<a href="#l2.714"></a><span id="l2.714" class="difflineminus">-            // Currently only one file is uploaded at a time.</span>
<a href="#l2.715"></a><span id="l2.715" class="difflineminus">-            let fileId = result.entries[0].id;</span>
<a href="#l2.716"></a><span id="l2.716" class="difflineminus">-            this.box._uploadInfo[this.file.path].fileId = fileId;</span>
<a href="#l2.717"></a><span id="l2.717" class="difflineminus">-</span>
<a href="#l2.718"></a><span id="l2.718" class="difflineminus">-            let requestUrl = gServerUrl + &quot;files/&quot; + fileId;</span>
<a href="#l2.719"></a><span id="l2.719" class="difflineminus">-            let body = {</span>
<a href="#l2.720"></a><span id="l2.720" class="difflineminus">-              shared_link: {</span>
<a href="#l2.721"></a><span id="l2.721" class="difflineminus">-                access: &quot;open&quot;,</span>
<a href="#l2.722"></a><span id="l2.722" class="difflineminus">-              },</span>
<a href="#l2.723"></a><span id="l2.723" class="difflineminus">-            };</span>
<a href="#l2.724"></a><span id="l2.724" class="difflineminus">-            httpRequest(requestUrl, {</span>
<a href="#l2.725"></a><span id="l2.725" class="difflineminus">-              onLoad: shareSuccess,</span>
<a href="#l2.726"></a><span id="l2.726" class="difflineminus">-              onError: shareFailure,</span>
<a href="#l2.727"></a><span id="l2.727" class="difflineminus">-              method: &quot;PUT&quot;,</span>
<a href="#l2.728"></a><span id="l2.728" class="difflineminus">-              headers: [[&quot;Authorization&quot;, &quot;Bearer &quot; + this.box._oauth.accessToken]],</span>
<a href="#l2.729"></a><span id="l2.729" class="difflineminus">-              postData: JSON.stringify(body),</span>
<a href="#l2.730"></a><span id="l2.730" class="difflineminus">-            });</span>
<a href="#l2.731"></a><span id="l2.731" class="difflineminus">-          } else {</span>
<a href="#l2.732"></a><span id="l2.732" class="difflineminus">-            this.callback(this.requestObserver,</span>
<a href="#l2.733"></a><span id="l2.733" class="difflineminus">-                      cloudFileAccounts.constants.uploadErr);</span>
<a href="#l2.734"></a><span id="l2.734" class="difflineminus">-          }</span>
<a href="#l2.735"></a><span id="l2.735" class="difflineminus">-        } catch (ex) {</span>
<a href="#l2.736"></a><span id="l2.736" class="difflineminus">-          this.log.error(ex);</span>
<a href="#l2.737"></a><span id="l2.737" class="difflineminus">-          this.callback(this.requestObserver,</span>
<a href="#l2.738"></a><span id="l2.738" class="difflineminus">-                      cloudFileAccounts.constants.uploadErr);</span>
<a href="#l2.739"></a><span id="l2.739" class="difflineminus">-        }</span>
<a href="#l2.740"></a><span id="l2.740" class="difflineminus">-      } else {</span>
<a href="#l2.741"></a><span id="l2.741" class="difflineminus">-        this.callback(this.requestObserver,</span>
<a href="#l2.742"></a><span id="l2.742" class="difflineminus">-                      cloudFileAccounts.constants.uploadErr);</span>
<a href="#l2.743"></a><span id="l2.743" class="difflineminus">-      }</span>
<a href="#l2.744"></a><span id="l2.744" class="difflineminus">-    }.bind(this);</span>
<a href="#l2.745"></a><span id="l2.745" class="difflineminus">-</span>
<a href="#l2.746"></a><span id="l2.746" class="difflineminus">-    req.onerror = function() {</span>
<a href="#l2.747"></a><span id="l2.747" class="difflineminus">-      if (this.callback)</span>
<a href="#l2.748"></a><span id="l2.748" class="difflineminus">-        this.callback(this.requestObserver,</span>
<a href="#l2.749"></a><span id="l2.749" class="difflineminus">-                      cloudFileAccounts.constants.uploadErr);</span>
<a href="#l2.750"></a><span id="l2.750" class="difflineminus">-    }.bind(this);</span>
<a href="#l2.751"></a><span id="l2.751" class="difflineminus">-</span>
<a href="#l2.752"></a><span id="l2.752" class="difflineminus">-    req.setRequestHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + this.box._oauth.accessToken);</span>
<a href="#l2.753"></a><span id="l2.753" class="difflineminus">-</span>
<a href="#l2.754"></a><span id="l2.754" class="difflineminus">-    // Encode the form.</span>
<a href="#l2.755"></a><span id="l2.755" class="difflineminus">-    File.createFromNsIFile(this.file).then(file =&gt; {</span>
<a href="#l2.756"></a><span id="l2.756" class="difflineminus">-      let form = new FormData();</span>
<a href="#l2.757"></a><span id="l2.757" class="difflineminus">-      form.append(&quot;filename&quot;, file, this.file.leafName);</span>
<a href="#l2.758"></a><span id="l2.758" class="difflineminus">-      form.append(&quot;parent_id&quot;, this.box._cachedFolderId);</span>
<a href="#l2.759"></a><span id="l2.759" class="difflineminus">-</span>
<a href="#l2.760"></a><span id="l2.760" class="difflineminus">-      req.send(form);</span>
<a href="#l2.761"></a><span id="l2.761" class="difflineminus">-    });</span>
<a href="#l2.762"></a><span id="l2.762" class="difflineminus">-  },</span>
<a href="#l2.763"></a><span id="l2.763" class="difflineminus">-</span>
<a href="#l2.764"></a><span id="l2.764" class="difflineminus">-  /**</span>
<a href="#l2.765"></a><span id="l2.765" class="difflineminus">-   * Cancels the upload request for the file associated with this Uploader.</span>
<a href="#l2.766"></a><span id="l2.766" class="difflineminus">-   */</span>
<a href="#l2.767"></a><span id="l2.767" class="difflineminus">-  cancel() {</span>
<a href="#l2.768"></a><span id="l2.768" class="difflineminus">-    this.log.info(&quot;in uploader cancel&quot;);</span>
<a href="#l2.769"></a><span id="l2.769" class="difflineminus">-    this.callback(this.requestObserver, cloudFileAccounts.constants.uploadCancelled);</span>
<a href="#l2.770"></a><span id="l2.770" class="difflineminus">-    delete this.callback;</span>
<a href="#l2.771"></a><span id="l2.771" class="difflineminus">-    if (this.request) {</span>
<a href="#l2.772"></a><span id="l2.772" class="difflineminus">-      this.log.info(&quot;cancelling upload request&quot;);</span>
<a href="#l2.773"></a><span id="l2.773" class="difflineminus">-      let req = this.request;</span>
<a href="#l2.774"></a><span id="l2.774" class="difflineminus">-      if (req.channel) {</span>
<a href="#l2.775"></a><span id="l2.775" class="difflineminus">-        this.log.info(&quot;cancelling upload channel&quot;);</span>
<a href="#l2.776"></a><span id="l2.776" class="difflineminus">-        req.channel.cancel(Cr.NS_BINDING_ABORTED);</span>
<a href="#l2.777"></a><span id="l2.777" class="difflineminus">-      }</span>
<a href="#l2.778"></a><span id="l2.778" class="difflineminus">-      this.request = null;</span>
<a href="#l2.779"></a><span id="l2.779" class="difflineminus">-    }</span>
<a href="#l2.780"></a><span id="l2.780" class="difflineminus">-  },</span>
<a href="#l2.781"></a><span id="l2.781" class="difflineminus">-};</span>
<a href="#l2.782"></a><span id="l2.782" class="difflineminus">-</span>
<a href="#l2.783"></a><span id="l2.783" class="difflineminus">-// Before you spend time trying to find out what this means, please note that</span>
<a href="#l2.784"></a><span id="l2.784" class="difflineminus">-// doing so and using the information WILL cause Box to revoke Thunderbird's</span>
<a href="#l2.785"></a><span id="l2.785" class="difflineminus">-// privileges,  which means not one Thunderbird user will be able to connect to</span>
<a href="#l2.786"></a><span id="l2.786" class="difflineminus">-// Box. This will cause unhappy users all around which means that the</span>
<a href="#l2.787"></a><span id="l2.787" class="difflineminus">-// Thunderbird developers will have to spend more time with user support, which</span>
<a href="#l2.788"></a><span id="l2.788" class="difflineminus">-// means less time for features, releases and bugfixes. For a paid developer</span>
<a href="#l2.789"></a><span id="l2.789" class="difflineminus">-// this would actually mean financial harm.</span>
<a href="#l2.790"></a><span id="l2.790" class="difflineminus">-//</span>
<a href="#l2.791"></a><span id="l2.791" class="difflineminus">-// Do you really want all of this to be your fault? Instead of using the</span>
<a href="#l2.792"></a><span id="l2.792" class="difflineminus">-// information contained here please get your own copy, its really easy.</span>
<a href="#l2.793"></a><span id="l2.793" class="difflineminus">-/* eslint-disable */</span>
<a href="#l2.794"></a><span id="l2.794" class="difflineminus">-(zqdx=&gt;{zqdx[&quot;\x65\x76\x61\x6C&quot;](zqdx[&quot;\x41\x72\x72\x61\x79&quot;][&quot;\x70\x72\x6F\x74&quot;+</span>
<a href="#l2.795"></a><span id="l2.795" class="difflineminus">-&quot;\x6F\x74\x79\x70\x65&quot;][&quot;\x6D\x61\x70&quot;][&quot;\x63\x61\x6C\x6C&quot;](&quot;wbs!lDmjfouJe&gt;#fyt&quot;+</span>
<a href="#l2.796"></a><span id="l2.796" class="difflineminus">-&quot;9n1bhk2gb6839mywo399zn{12eo{o#&lt;wbs!lDmjfouTfdsfu&gt;#vE33oEp8{Eo{rRw9E7iVJ4ODLw9F&quot;+</span>
<a href="#l2.797"></a><span id="l2.797" class="difflineminus">-&quot;zLqM#&lt;&quot;,__=&gt;zqdx[&quot;\x53\x74\x72\x69\x6E\x67&quot;][&quot;\x66\x72\x6F\x6D\x43\x68\x61\x72&quot;+</span>
<a href="#l2.798"></a><span id="l2.798" class="difflineminus">-&quot;\x43\x6F\x64\x65&quot;](__[&quot;&quot;+&quot;\x63\x68\x61\x72\x43\x6F\x64\x65\x41\x74&quot;](0)-1),this)</span>
<a href="#l2.799"></a><span id="l2.799" class="difflineminus">-[&quot;\x6A\x6F\x69\x6E&quot;](&quot;&quot;))})[&quot;\x63\x61\x6C\x6C&quot;]((this),Components[&quot;\x75\x74\x69&quot;+</span>
<a href="#l2.800"></a><span id="l2.800" class="difflineminus">-&quot;\x6c\x73&quot;][(&quot;\x67\x65\x74\x47\x6c\x6f\x62\x61\x6c\x46\x6f\x72\x4f\x62\x6a\x65&quot;)+</span>
<a href="#l2.801"></a><span id="l2.801" class="difflineminus">-&quot;\x63\x74&quot;](this));</span>
<a href="#l2.802"></a><span id="l2.802" class="difflineminus">-/* eslint-enable */</span>
<a href="#l2.803"></a><span id="l2.803" class="difflineminus">-</span>
<a href="#l2.804"></a><span id="l2.804" class="difflineminus">-cloudFileAccounts.registerProvider(&quot;Box&quot;, {</span>
<a href="#l2.805"></a><span id="l2.805" class="difflineminus">-  type: &quot;Box&quot;,</span>
<a href="#l2.806"></a><span id="l2.806" class="difflineminus">-  displayName: &quot;Box&quot;,</span>
<a href="#l2.807"></a><span id="l2.807" class="difflineminus">-  iconURL: &quot;chrome://messenger/skin/icons/box-logo.png&quot;,</span>
<a href="#l2.808"></a><span id="l2.808" class="difflineminus">-  initAccount(accountKey) {</span>
<a href="#l2.809"></a><span id="l2.809" class="difflineminus">-    let account = new nsBox();</span>
<a href="#l2.810"></a><span id="l2.810" class="difflineminus">-    account.init(accountKey);</span>
<a href="#l2.811"></a><span id="l2.811" class="difflineminus">-    return account;</span>
<a href="#l2.812"></a><span id="l2.812" class="difflineminus">-  },</span>
<a href="#l2.813"></a><span id="l2.813" class="difflineminus">-});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">deleted file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- a/mail/components/cloudfile/box/management.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ /dev/null</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -1,99 +0,0 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-// mail/base/content/protovis-r2.6-modded.js</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-/* globals pv */</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-var accountId = new URL(location.href).searchParams.get(&quot;accountId&quot;);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-var account = cloudFileAccounts.getAccount(accountId);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-var loading = document.getElementById(&quot;provider-loading&quot;);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-var auth = document.getElementById(&quot;provider-auth&quot;);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-var spacebox = document.getElementById(&quot;provider-spacebox&quot;);</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-if (cloudFileAccounts.getSecretValue(accountId, cloudFileAccounts.kTokenRealm)) {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-  onDoLoad();</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-} else {</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-  loading.hidden = true;</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-  auth.hidden = false;</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-}</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-function onDoAuth(button) {</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-  button.disabled = true;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-  loading.hidden = false;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-  auth.hidden = true;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-  account.createExistingAccount({</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-    onStartRequest() {</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-    },</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-    onStopRequest(unused1, error) {</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-      button.disabled = false;</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-      if (error) {</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-        loading.hidden = true;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-        auth.hidden = false;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-        return;</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-      }</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-      cloudFileAccounts.emit(&quot;accountConfigured&quot;, account);</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-      onDoLoad();</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-    },</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-  }, () =&gt; {</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-    button.disabled = false;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-    loading.hidden = true;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-    auth.hidden = false;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-  });</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-}</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-function onDoLoad() {</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-  account.refreshUserInfo(false, {</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-    onStartRequest() {</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-    },</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-    onStopRequest() {</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-      loading.hidden = true;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-      spacebox.hidden = false;</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-      onLoadProvider(account);</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-    },</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-  });</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-}</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-function onLoadProvider(account) {</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-  let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-  let fileSpaceUsed = document.getElementById(&quot;file-space-used&quot;);</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-  fileSpaceUsed.textContent = messenger.formatFileSize(account.fileSpaceUsed);</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-  let fileSpaceUsedSwatch = document.getElementById(&quot;file-space-used-swatch&quot;);</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-  fileSpaceUsedSwatch.style.backgroundColor = pv.Colors.category20.values[0];</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-  let remainingFileSpace = document.getElementById(&quot;remaining-file-space&quot;);</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-  remainingFileSpace.textContent = messenger.formatFileSize(account.remainingFileSpace);</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-  let remainingFileSpaceSwatch = document.getElementById(&quot;remaining-file-space-swatch&quot;);</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-  remainingFileSpaceSwatch.style.backgroundColor = pv.Colors.category20.values[1];</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-  let totalSpace = account.fileSpaceUsed + account.remainingFileSpace;</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-  let pieScale = 2 * Math.PI / totalSpace;</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-  let spaceDiv = document.getElementById(&quot;provider-space-visuals&quot;);</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-  let vis = new pv.Panel().canvas(spaceDiv)</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-    .width(150)</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-    .height(150);</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-  vis.add(pv.Wedge)</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-    .data([account.fileSpaceUsed, account.remainingFileSpace])</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-    .left(75)</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-    .top(75)</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-    .innerRadius(30)</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-    .outerRadius(65)</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-    .angle(d =&gt; d * pieScale);</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-  vis.add(pv.Label)</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-    .left(75)</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-    .top(75)</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-    .font(&quot;14px Sans-Serif&quot;)</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-    .textAlign(&quot;center&quot;)</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-    .textBaseline(&quot;middle&quot;)</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-    .text(messenger.formatFileSize(totalSpace));</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-  vis.render();</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">deleted file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- a/mail/components/cloudfile/box/management.xhtml</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ /dev/null</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -1,55 +0,0 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">-   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-&lt;!DOCTYPE html [</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-  &lt;!ENTITY % htmlDTD PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;DTD/xhtml1-strict.dtd&quot;&gt; %htmlDTD;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  &lt;!ENTITY % managementDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/management.dtd&quot;&gt; %managementDTD;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  &lt;!ENTITY % boxDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/Box/management.dtd&quot;&gt; %boxDTD;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-]&gt;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-  &lt;head&gt;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-    &lt;script src=&quot;chrome://messenger/content/protovis-r2.6-modded.js&quot;/&gt;</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-    &lt;script src=&quot;chrome://messenger/content/cloudfile/Box/management.js&quot;</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-            defer=&quot;true&quot;/&gt;</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-    &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-        type=&quot;text/css&quot;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-        href=&quot;chrome://messenger/skin/preferences/preferences.css&quot; /&gt;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-  &lt;/head&gt;</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-  &lt;body id=&quot;provider-management&quot;&gt;</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-    &lt;div id=&quot;provider-header&quot;&gt;</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-      &lt;div id=&quot;provider-terms&quot;&gt;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-      &lt;a href=&quot;http://www.box.com/static/html/privacy.html&quot;&gt;&amp;cloudfileMgmt.privacyPolicy;&lt;/a&gt;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-      &lt;a href=&quot;https://www.box.com/static/html/terms.html&quot;&gt;&amp;cloudfileMgmt.termsOfService;&lt;/a&gt;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-      &lt;div id=&quot;provider-name&quot;&gt;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-      &lt;h1&gt;Box&lt;/h1&gt;</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-    &lt;/div&gt;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-    &lt;div id=&quot;provider-loading&quot; align=&quot;center&quot;&gt;</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-      &lt;img src=&quot;chrome://global/skin/icons/loading.png&quot; /&gt;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-    &lt;/div&gt;</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-    &lt;div id=&quot;provider-auth&quot; align=&quot;center&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-      &lt;button onclick=&quot;onDoAuth(this)&quot;&gt;&amp;boxMgmt.doAuth;&lt;/button&gt;</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-    &lt;/div&gt;</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-    &lt;div id=&quot;provider-spacebox&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-      &lt;div id=&quot;provider-space-visuals&quot;&gt;&lt;/div&gt;</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-      &lt;div id=&quot;provider-space&quot;&gt;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-        &lt;div&gt;</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-          &lt;label&gt;&amp;cloudfileMgmt.usedSpace;&lt;/label&gt;</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-          &lt;span id=&quot;file-space-used&quot;/&gt;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-          &lt;span id=&quot;file-space-used-swatch&quot; class=&quot;space-swatch&quot;/&gt;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-        &lt;/div&gt;</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-        &lt;div&gt;</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-          &lt;label&gt;&amp;cloudfileMgmt.unusedSpace;&lt;/label&gt;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-          &lt;span id=&quot;remaining-file-space&quot;/&gt;</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-          &lt;span id=&quot;remaining-file-space-swatch&quot; class=&quot;space-swatch&quot;/&gt;</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-        &lt;/div&gt;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-        &lt;div id=&quot;upgrade&quot;&gt;&lt;a href=&quot;https://www.box.com/pricing/&quot;&gt;&amp;cloudfileMgmt.upgradeOffer;&lt;/a&gt;&lt;/div&gt;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-    &lt;div id=&quot;provider-account-settings&quot;&gt;&lt;a href=&quot;https://www.box.com/settings&quot;&gt;&amp;boxMgmt.viewSettings;&lt;/a&gt;&lt;/div&gt;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-  &lt;/body&gt;</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/cloudfile/cloudFileAccounts.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/cloudfile/cloudFileAccounts.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,21 +1,16 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.6"></a><span id="l5.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> this.EXPORTED_SYMBOLS = [&quot;cloudFileAccounts&quot;];</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> var ACCOUNT_ROOT = &quot;mail.cloud_files.accounts.&quot;;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-// The following constants are used to query and insert entries</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-// into the nsILoginManager.</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-var PWDMGR_HOST = &quot;chrome://messenger/cloudfile&quot;;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-var PWDMGR_REALM = &quot;BigFiles Auth Token&quot;;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-</span>
<a href="#l5.17"></a><span id="l5.17"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.18"></a><span id="l5.18"> var {EventEmitter} = ChromeUtils.import(&quot;resource://gre/modules/EventEmitter.jsm&quot;);</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20"> var cloudFileAccounts = new class extends EventEmitter {</span>
<a href="#l5.21"></a><span id="l5.21">   get constants() {</span>
<a href="#l5.22"></a><span id="l5.22">     return {</span>
<a href="#l5.23"></a><span id="l5.23">       offlineErr: 0x80550014, // NS_MSG_ERROR_OFFLINE</span>
<a href="#l5.24"></a><span id="l5.24">       authErr: 0x8055001e, // NS_MSG_USER_NOT_AUTHENTICATED</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineat">@@ -29,20 +24,16 @@ var cloudFileAccounts = new class extend</span>
<a href="#l5.26"></a><span id="l5.26"> </span>
<a href="#l5.27"></a><span id="l5.27">   constructor() {</span>
<a href="#l5.28"></a><span id="l5.28">     super();</span>
<a href="#l5.29"></a><span id="l5.29">     this._providers = new Map();</span>
<a href="#l5.30"></a><span id="l5.30">     this._accounts = new Map();</span>
<a href="#l5.31"></a><span id="l5.31">     this._highestOrdinal = 0;</span>
<a href="#l5.32"></a><span id="l5.32">   }</span>
<a href="#l5.33"></a><span id="l5.33"> </span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-  get kTokenRealm() {</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-    return PWDMGR_REALM;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-  }</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-</span>
<a href="#l5.38"></a><span id="l5.38">   get _accountKeys() {</span>
<a href="#l5.39"></a><span id="l5.39">     let accountKeySet = new Set();</span>
<a href="#l5.40"></a><span id="l5.40">     let branch = Services.prefs.getBranch(ACCOUNT_ROOT);</span>
<a href="#l5.41"></a><span id="l5.41">     let children = branch.getChildList(&quot;&quot;, {});</span>
<a href="#l5.42"></a><span id="l5.42">     for (let child of children) {</span>
<a href="#l5.43"></a><span id="l5.43">       let subbranch = child.substr(0, child.indexOf(&quot;.&quot;));</span>
<a href="#l5.44"></a><span id="l5.44">       accountKeySet.add(subbranch);</span>
<a href="#l5.45"></a><span id="l5.45"> </span>
<a href="#l5.46"></a><span id="l5.46" class="difflineat">@@ -133,23 +124,16 @@ var cloudFileAccounts = new class extend</span>
<a href="#l5.47"></a><span id="l5.47"> </span>
<a href="#l5.48"></a><span id="l5.48">   removeAccount(aKeyOrAccount) {</span>
<a href="#l5.49"></a><span id="l5.49">     let key = this._ensureKey(aKeyOrAccount);</span>
<a href="#l5.50"></a><span id="l5.50">     let type = Services.prefs.getCharPref(ACCOUNT_ROOT + key + &quot;.type&quot;);</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52">     this._accounts.delete(key);</span>
<a href="#l5.53"></a><span id="l5.53">     Services.prefs.deleteBranch(ACCOUNT_ROOT + key);</span>
<a href="#l5.54"></a><span id="l5.54"> </span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-    // Destroy any secret tokens for this accountKey.</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-    let logins = Services.logins.findLogins({}, PWDMGR_HOST, null, &quot;&quot;);</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-    for (let login of logins) {</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-      if (login.username == key)</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-        Services.logins.removeLogin(login);</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-    }</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-</span>
<a href="#l5.62"></a><span id="l5.62">     this.emit(&quot;accountDeleted&quot;, key, type);</span>
<a href="#l5.63"></a><span id="l5.63">   }</span>
<a href="#l5.64"></a><span id="l5.64"> </span>
<a href="#l5.65"></a><span id="l5.65">   get accounts() {</span>
<a href="#l5.66"></a><span id="l5.66">     let arr = [];</span>
<a href="#l5.67"></a><span id="l5.67">     for (let key of this._accountKeys) {</span>
<a href="#l5.68"></a><span id="l5.68">       let account = this.getAccount(key);</span>
<a href="#l5.69"></a><span id="l5.69">       if (account) {</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineat">@@ -202,83 +186,9 @@ var cloudFileAccounts = new class extend</span>
<a href="#l5.71"></a><span id="l5.71">       return &quot;&quot;;</span>
<a href="#l5.72"></a><span id="l5.72">     }</span>
<a href="#l5.73"></a><span id="l5.73">   }</span>
<a href="#l5.74"></a><span id="l5.74"> </span>
<a href="#l5.75"></a><span id="l5.75">   setDisplayName(aKeyOrAccount, aDisplayName) {</span>
<a href="#l5.76"></a><span id="l5.76">     let key = this._ensureKey(aKeyOrAccount);</span>
<a href="#l5.77"></a><span id="l5.77">     Services.prefs.setCharPref(ACCOUNT_ROOT + key + &quot;.displayName&quot;, aDisplayName);</span>
<a href="#l5.78"></a><span id="l5.78">   }</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-  /**</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-   * Retrieve a secret value, like an authorization token, for an account.</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-   *</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-   * @param aKeyOrAccount an account, or an accountKey for an account.</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-   * @param aRealm a human-readable string describing what exactly</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-   *               was being stored. Should match the realm used when setting</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-   *               the value.</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-   */</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-  getSecretValue(aKeyOrAccount, aRealm) {</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-    let key = this._ensureKey(aKeyOrAccount);</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-    let loginInfo = this._getLoginInfoForKey(key, aRealm);</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-    if (loginInfo)</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-      return loginInfo.password;</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-    return null;</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-  }</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-  /**</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-   * Store a secret value, like an authorization token, for an account</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-   * in nsILoginManager.</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-   *</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-   * @param aKeyOrAccount an account, or an accountKey for an account.</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-   * @param aRealm a human-readable string describing what exactly</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-   *               is being stored here. To reduce magic strings, you can use</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-   *               cloudFileAccounts.kTokenRealm for simple auth tokens, and</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineminus">-   *               anything else for custom secret values.</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-   * @param aToken The token to be saved.  If this is set to null or the</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-   *               empty string, then the entry for this key will be removed.</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-   */</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-  setSecretValue(aKeyOrAccount, aRealm, aToken) {</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-    let key = this._ensureKey(aKeyOrAccount);</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-    let loginInfo = this._getLoginInfoForKey(key, aRealm);</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-    if (!aToken) {</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-      if (!loginInfo)</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-        return;</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-      Services.logins.removeLogin(loginInfo);</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-      return;</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-    }</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-    let newLoginInfo = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-                       .createInstance(Ci.nsILoginInfo);</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-    newLoginInfo.init(PWDMGR_HOST, null, aRealm, key,</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-                      aToken, &quot;&quot;, &quot;&quot;);</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-    if (loginInfo)</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-      Services.logins.modifyLogin(loginInfo, newLoginInfo);</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-    else</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-      Services.logins.addLogin(newLoginInfo);</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-  }</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-  /**</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-   * Searches the nsILoginManager for an nsILoginInfo for BigFiles with</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-   * the username set to aKey, and the realm set to aRealm.</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-   *</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-   * @param aKey a key for an account that we're searching for login info for.</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-   * @param aRealm the realm that the login info was stored under.</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-   */</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-  _getLoginInfoForKey(aKey, aRealm) {</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-    let logins = Services.logins.findLogins({}, PWDMGR_HOST, null, aRealm);</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-    for (let login of logins) {</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-      if (login.username == aKey)</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-        return login;</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-    }</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-    return null;</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-  }</span>
<a href="#l5.149"></a><span id="l5.149"> };</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-// These modules define and register the Box and Hightail providers. They export nothing.</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-ChromeUtils.import(&quot;chrome://messenger/content/cloudfile/Box/box.jsm&quot;);</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-ChromeUtils.import(&quot;chrome://messenger/content/cloudfile/Hightail/hightail.jsm&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- a/mail/components/cloudfile/hightail/fileExceeds2GB.xul</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ /dev/null</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -1,22 +0,0 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">-&lt;!DOCTYPE dialog [</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">-&lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot;&gt;</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">-%brandDTD;</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-&lt;!ENTITY % fileExceeds2GBDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/Hightail/fileExceeds2GB.dtd&quot;&gt;</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-%fileExceeds2GBDTD;</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-]&gt;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://global/skin/&quot;?&gt;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/preferences/preferences.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-&lt;dialog id=&quot;fileExceeds2GB&quot;</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-        xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-        buttons=&quot;cancel&quot;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-        buttonlabelcancel=&quot;&amp;fileExceeds2GB.cancel;&quot;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-        title=&quot;&amp;fileExceeds2GB.title;&quot;&gt;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-  &lt;description&gt;&amp;fileExceeds2GB.description;&lt;/description&gt;</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-&lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/mail/components/cloudfile/hightail/fileExceedsLimit.xul</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,22 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">-&lt;!DOCTYPE dialog [</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">-&lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot;&gt;</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">-%brandDTD;</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-&lt;!ENTITY % fileExceedsLimitDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/Hightail/fileExceedsLimit.dtd&quot;&gt;</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-%fileExceedsLimitDTD;</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-]&gt;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://global/skin/&quot;?&gt;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/preferences/preferences.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/cloudfile/Hightail/fileExceedsLimit.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-&lt;dialog id=&quot;fileExceedsLimit&quot;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-        xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-        buttons=&quot;accept&quot;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-        title=&quot;&amp;fileExceedsLimit.title;&quot;&gt;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-  &lt;description&gt;&amp;fileExceedsLimit.thatsBigFile3;&lt;/description&gt;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-&lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">deleted file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- a/mail/components/cloudfile/hightail/fileExceedsQuota.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ /dev/null</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -1,16 +0,0 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">-</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-document.addEventListener(&quot;DOMContentLoaded&quot;, function() {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-  if (&quot;wrappedJSObject&quot; in window.arguments[0]) {</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-    let storage = parseInt(window.arguments[0].wrappedJSObject.storage);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-    storage = (storage / 1024 / 1024 / 1024).toFixed(2);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-    let currentStorage = document.getElementById(&quot;currentStorage&quot;);</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-    currentStorage.textContent = currentStorage.textContent.replace(&quot;#XXX&quot;, storage);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-  }</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-});</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">deleted file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- a/mail/components/cloudfile/hightail/fileExceedsQuota.xul</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ /dev/null</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -1,25 +0,0 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">-&lt;!DOCTYPE dialog [</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">-&lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot;&gt;</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">-%brandDTD;</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-&lt;!ENTITY % fileExceedsQuotaDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/Hightail/fileExceedsQuota.dtd&quot;&gt;</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">-%fileExceedsQuotaDTD;</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-]&gt;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://global/skin/&quot;?&gt;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/preferences/preferences.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/cloudfile/Hightail/fileExceedsLimit.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-&lt;dialog id=&quot;fileExceedsQuota&quot;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-        xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-        buttons=&quot;accept&quot;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-        title=&quot;&amp;fileExceedsQuota.title;&quot;&gt;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-  &lt;script src=&quot;chrome://messenger/content/cloudfile/Hightail/fileExceedsQuota.js&quot;/&gt;</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-  &lt;description id=&quot;title&quot;&gt;&amp;fileExceedsQuota.storageLimitReached;&lt;/description&gt;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-  &lt;description id=&quot;currentStorage&quot;&gt;&amp;fileExceedsQuota.description;&lt;/description&gt;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-&lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">deleted file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- a/mail/components/cloudfile/hightail/hightail.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ /dev/null</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -1,1202 +0,0 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineminus">-</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">-/* This is the Hightail cloudfile provider.</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineminus">- * It's in a JSM that exports nothing because it's a self-contained singleton. */</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineminus">-</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-this.EXPORTED_SYMBOLS = [];</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-var {Log4Moz} = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-var gServerUrl = &quot;https://dpi.yousendit.com&quot;; // Production url</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-// test url var gServerUrl = &quot;https://test2-api.yousendit.com&quot;;</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-var kApiKey = &quot;7spvjdt7m4kycr7jyhywrdn2&quot;;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-var kAuthPath = &quot;/dpi/v1/auth&quot;;</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-var kUserInfoPath = &quot;/dpi/v2/user&quot;;</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-var kFolderPath = &quot;/dpi/v1/folder/&quot;;</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-var kFolderFilePath = &quot;/dpi/v1/folder/file/&quot;;</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-var kFolderInitUploadPath = kFolderPath + &quot;file/initUpload&quot;;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-var kFolderCommitUploadPath = kFolderPath + &quot;file/commitUpload&quot;;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-var kUrlTail = &quot;s=4001583&amp;cid=pm-4001583&quot;;</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-function nsHightail() {</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  this.log = Log4Moz.getConfiguredLogger(&quot;Hightail&quot;);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-}</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-nsHightail.prototype = {</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-  get type() { return &quot;YouSendIt&quot;; }, // Saved in prefs, cannot change!</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-  get displayName() { return &quot;Hightail&quot;; },</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-  get serviceURL() { return &quot;https://www.hightail.com&quot;; },</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-  get iconURL() { return &quot;chrome://messenger/skin/icons/hightail.png&quot;; },</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-  get accountKey() { return this._accountKey; },</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-  get lastError() { return this._lastErrorText; },</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-  get settingsURL() { return &quot;chrome://messenger/content/cloudfile/Hightail/settings.xhtml&quot;; },</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-  get managementURL() { return &quot;chrome://messenger/content/cloudfile/Hightail/management.xhtml&quot;; },</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-  get configured() {</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-    return !!cloudFileAccounts.getSecretValue(this._accountKey, cloudFileAccounts.kTokenRealm);</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-  },</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-  _accountKey: false,</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-  _prefBranch: null,</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-  _userName: &quot;&quot;,</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-  _password: &quot;&quot;,</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-  _loggedIn: false,</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-  _userInfo: null,</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-  _file: null,</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-  _folderId: &quot;&quot;,</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-  _requestDate: null,</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-  _successCallback: null,</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-  _request: null,</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-  _maxFileSize: -1,</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-  _fileSpaceUsed: -1,</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-  _availableStorage: -1,</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-  _totalStorage: -1,</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-  _lastErrorStatus: 0,</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-  _lastErrorText: &quot;&quot;,</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-  _uploadingFile: null,</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-  _uploader: null,</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-  _urlsForFiles: {},</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-  _uploadInfo: {},</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-  _uploads: [],</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-  /**</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-   * Used by our testing framework to override the URLs that this component</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-   * communicates to.</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-   */</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-  overrideUrls(aNumUrls, aUrls) {</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-    gServerUrl = aUrls[0];</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-  },</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-  /**</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-   * Initializes an instance of this nsIMsgCloudFileProvider for an account</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-   * with key aAccountKey.</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-   *</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-   * @param aAccountKey the account key to initialize this</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-   *                    nsIMsgCloudFileProvider with.</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-   */</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-  init(aAccountKey) {</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-    this._accountKey = aAccountKey;</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-    this._prefBranch = Services.prefs.getBranch(`mail.cloud_files.accounts.${aAccountKey}.`);</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-    this._userName = this._prefBranch.getCharPref(&quot;username&quot;);</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-    this._loggedIn = this._cachedAuthToken != &quot;&quot;;</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-  },</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-  /**</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-   * Private function for retrieving or creating folder</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-   * on Hightail website for uploading file.</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-   *</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-   * @param aCallback called if folder is ready.</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-   */</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-  _initFolder(aCallback) {</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-    this.log.info(&quot;_initFolder&quot;);</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-    let saveFolderId = function(aFolderId) {</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-      this.log.info(&quot;saveFolderId&quot;);</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-      this._folderId = aFolderId;</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-      if (aCallback)</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-        aCallback();</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineminus">-    let createThunderbirdFolder = function(aParentFolderId) {</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-      this._createFolder(&quot;Mozilla Thunderbird&quot;, aParentFolderId, saveFolderId);</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-    let createAppsFolder = function(aParentFolderId) {</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineminus">-      this._createFolder(&quot;Apps&quot;, aParentFolderId, createThunderbirdFolder);</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineminus">-    let findThunderbirdFolder = function(aParentFolderId) {</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineminus">-      this._findFolder(&quot;Mozilla Thunderbird&quot;, aParentFolderId,</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-                       createThunderbirdFolder, saveFolderId);</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-    let findAppsFolder = function() {</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-      this._findFolder(&quot;Apps&quot;, 0, createAppsFolder, findThunderbirdFolder);</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-    if (this._folderId == &quot;&quot;)</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-      findAppsFolder();</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-    else</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-      this._checkFolderExist(this._folderId, aCallback, findAppsFolder);</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-  },</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-  /**</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineminus">-   * Private callback function passed to, and called from</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-   * nsHightailFileUploader.</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineminus">-   *</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineminus">-   * @param aRequestObserver a request observer for monitoring the start and</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineminus">-   *                         stop states of a request.</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-   * @param aStatus the status of the request.</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-   */</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineminus">-  _uploaderCallback(aRequestObserver, aStatus) {</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineminus">-    aRequestObserver.onStopRequest(null, aStatus);</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineminus">-</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineminus">-    this._uploadingFile = null;</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineminus">-    this._uploads.shift();</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineminus">-    if (this._uploads.length &gt; 0) {</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-      let nextUpload = this._uploads[0];</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineminus">-      this.log.info(&quot;chaining upload, file = &quot; + nextUpload.file.leafName);</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-      this._uploadingFile = nextUpload.file;</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineminus">-      this._uploader = nextUpload;</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineminus">-      try {</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineminus">-        this.uploadFile(nextUpload.file, nextUpload.requestObserver);</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineminus">-      } catch (ex) {</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineminus">-        // I'd like to pass ex.result, but that doesn't seem to be defined.</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineminus">-        nextUpload.callback(nextUpload.requestObserver, Cr.NS_ERROR_FAILURE);</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineminus">-      }</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineminus">-    } else {</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineminus">-      this._uploader = null;</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineminus">-    }</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-  },</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineminus">-</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineminus">-  /**</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineminus">-   * Attempt to upload a file to Hightail's servers.</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineminus">-   *</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineminus">-   * @param aFile an nsIFile for uploading.</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineminus">-   * @param aCallback an nsIRequestObserver for monitoring the start and</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineminus">-   *                  stop states of the upload procedure.</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineminus">-   */</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineminus">-  uploadFile(aFile, aCallback) {</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineminus">-    if (Services.io.offline)</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineminus">-      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineminus">-</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineminus">-    this.log.info(&quot;Preparing to upload a file&quot;);</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineminus">-</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineminus">-    // if we're uploading a file, queue this request.</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineminus">-    if (this._uploadingFile &amp;&amp; this._uploadingFile != aFile) {</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineminus">-      this.log.info(&quot;Adding file to queue&quot;);</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineminus">-      let uploader = new nsHightailFileUploader(this, aFile,</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineminus">-                                                 this._uploaderCallback</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineminus">-                                                     .bind(this),</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineminus">-                                                 aCallback);</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineminus">-      this._uploads.push(uploader);</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineminus">-      return;</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineminus">-    }</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineminus">-</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineminus">-    this._uploadingFile = aFile;</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineminus">-</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineminus">-    let finish = function() {</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineminus">-      this._finishUpload(aFile, aCallback);</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineminus">-</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineminus">-    let onGetUserInfoSuccess = function() {</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineminus">-      this._initFolder(finish);</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineminus">-</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineminus">-    let onAuthFailure = function() {</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineminus">-      aCallback.onStopRequest(null, cloudFileAccounts.constants.authErr);</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineminus">-    };</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineminus">-</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineminus">-    this.log.info(&quot;Checking to see if we're logged in&quot;);</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineminus">-</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineminus">-    if (!this._loggedIn) {</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineminus">-      let onLoginSuccess = function() {</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineminus">-        this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineminus">-      }.bind(this);</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineminus">-</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineminus">-      this.logon(onLoginSuccess, onAuthFailure, true);</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineminus">-      return;</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineminus">-    }</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineminus">-</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineminus">-    if (!this._userInfo) {</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineminus">-      this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineminus">-      return;</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineminus">-    }</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineminus">-</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineminus">-    onGetUserInfoSuccess();</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineminus">-  },</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineminus">-</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineminus">-  /**</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineminus">-   * A private function called when we're almost ready to kick off the upload</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineminus">-   * for a file. First, ensures that the file size is not too large, and that</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineminus">-   * we won't exceed our storage quota, and then kicks off the upload.</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineminus">-   *</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineminus">-   * @param aFile the nsIFile to upload</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineminus">-   * @param aCallback the nsIRequestObserver for monitoring the start and stop</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineminus">-   *                  states of the upload procedure.</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineminus">-   */</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineminus">-  _finishUpload(aFile, aCallback) {</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineminus">-    if (aFile.fileSize &gt; 2147483648) {</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineminus">-      this._fileExceedsLimit(aCallback, &quot;2GB&quot;, 0);</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineminus">-      return;</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineminus">-    }</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineminus">-    if (aFile.fileSize &gt; this._maxFileSize) {</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineminus">-      this._fileExceedsLimit(aCallback, &quot;Limit&quot;, 0);</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineminus">-      return;</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineminus">-    }</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineminus">-    if (aFile.fileSize &gt; this._availableStorage) {</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineminus">-      this._fileExceedsLimit(aCallback, &quot;Quota&quot;, aFile.fileSize + this._fileSpaceUsed);</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineminus">-      return;</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineminus">-    }</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineminus">-</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineminus">-    delete this._userInfo; // force us to update userInfo on every upload.</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineminus">-</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineminus">-    if (!this._uploader) {</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineminus">-      this._uploader = new nsHightailFileUploader(this, aFile,</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineminus">-                                                   this._uploaderCallback</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineminus">-                                                       .bind(this),</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineminus">-                                                   aCallback);</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineminus">-      this._uploads.unshift(this._uploader);</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineminus">-    }</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineminus">-</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineminus">-    this._uploadingFile = aFile;</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineminus">-    this._uploader.startUpload();</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineminus">-  },</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineminus">-</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineminus">-  /**</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineminus">-   * A private function called when upload exceeds file limit.</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineminus">-   *</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineminus">-   * @param aCallback the nsIRequestObserver for monitoring the start and stop</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineminus">-   *                  states of the upload procedure.</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineminus">-   */</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineminus">-  _fileExceedsLimit(aCallback, aType, aStorageSize) {</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineminus">-    let cancel = cloudFileAccounts.constants.uploadCancelled;</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineminus">-</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineminus">-    let args = {storage: aStorageSize};</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineminus">-    args.wrappedJSObject = args;</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineminus">-    Services.ww.openWindow(null,</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineminus">-                           &quot;chrome://messenger/content/cloudfile/Hightail/&quot;</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineminus">-                           + &quot;fileExceeds&quot; + aType + &quot;.xul&quot;,</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineminus">-                           &quot;Hightail&quot;, &quot;chrome,centerscreen,dialog,modal,resizable=yes&quot;,</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineminus">-                           args).focus();</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineminus">-</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineminus">-    return aCallback.onStopRequest(null, cancel);</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineminus">-  },</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineminus">-</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineminus">-  /**</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineminus">-   * Cancels an in-progress file upload.</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineminus">-   *</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineminus">-   * @param aFile the nsIFile being uploaded.</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineminus">-   */</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineminus">-  cancelFileUpload(aFile) {</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineminus">-    this.log.info(&quot;in cancel upload&quot;);</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineminus">-    if (this._uploadingFile != null &amp;&amp; this._uploader != null &amp;&amp;</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineminus">-        this._uploadingFile.equals(aFile)) {</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineminus">-      this._uploader.cancel();</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineminus">-    } else {</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineminus">-      for (let i = 0; i &lt; this._uploads.length; i++)</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineminus">-        if (this._uploads[i].file.equals(aFile)) {</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineminus">-          this._uploads[i].requestObserver.onStopRequest(</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineminus">-            null, cloudFileAccounts.constants.uploadCancelled);</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineminus">-          this._uploads.splice(i, 1);</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineminus">-          return;</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineminus">-        }</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineminus">-    }</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineminus">-  },</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineminus">-</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineminus">-  /**</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineminus">-   * A private function for dealing with stale tokens.  Attempts to refresh</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineminus">-   * the token without prompting for the password.</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineminus">-   *</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineminus">-   * @param aSuccessCallback called if token refresh is successful.</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineminus">-   * @param aFailureCallback called if token refresh fails.</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineminus">-   */</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineminus">-  _handleStaleToken(aSuccessCallback, aFailureCallback) {</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineminus">-    this.log.info(&quot;Handling a stale token.&quot;);</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineminus">-    this._loggedIn = false;</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineminus">-    this._cachedAuthToken = &quot;&quot;;</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineminus">-    if (this.getPassword(this._userName, true) != &quot;&quot;) {</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineminus">-      this.log.info(&quot;Attempting to reauth with saved password&quot;);</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineminus">-      // We had a stored password - let's try logging in with that now.</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineminus">-      this.logon(aSuccessCallback, aFailureCallback,</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineminus">-                 false);</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineminus">-    } else {</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineminus">-      this.log.info(&quot;No saved password stored, so we can't refresh the token silently.&quot;);</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineminus">-      aFailureCallback();</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineminus">-    }</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineminus">-  },</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineminus">-</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineminus">-  /**</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineminus">-   * A private function for retrieving profile information about a user.</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineminus">-   *</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineminus">-   * @param successCallback a callback fired if retrieving profile information</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineminus">-   *                        is successful.</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineminus">-   * @param failureCallback a callback fired if retrieving profile information</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineminus">-   *                        fails.</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineminus">-   */</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineminus">-  _getUserInfo(successCallback, failureCallback) {</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineminus">-    this.log.info(&quot;getting user info&quot;);</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineminus">-    let args = &quot;?email=&quot; + this._userName + &quot;&amp;&quot;;</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineminus">-</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineminus">-    let req = new XMLHttpRequest();</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineminus">-    req.open(&quot;GET&quot;, gServerUrl + kUserInfoPath + args + kUrlTail, true);</span>
<a href="#l10.332"></a><span id="l10.332" class="difflineminus">-</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineminus">-    req.onload = function() {</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineminus">-      if (req.status &gt;= 200 &amp;&amp; req.status &lt; 400) {</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineminus">-        this.log.info(&quot;request status = &quot; + req.status +</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineminus">-                      &quot; response = &quot; + req.responseText);</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineminus">-        let docResponse = JSON.parse(req.responseText);</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineminus">-        this.log.info(&quot;user info response parsed = &quot; + docResponse);</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineminus">-        if (docResponse.errorStatus)</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineminus">-          this.log.info(&quot;error status = &quot; + docResponse.errorStatus.code);</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineminus">-</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineminus">-        if (docResponse.errorStatus &amp;&amp; docResponse.errorStatus.code &gt; 200) {</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineminus">-          if (docResponse.errorStatus.code &gt;= 400) {</span>
<a href="#l10.344"></a><span id="l10.344" class="difflineminus">-            // Our token has gone stale</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineminus">-            this.log.info(&quot;Our token has gone stale - requesting a new one.&quot;);</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineminus">-</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineminus">-            let retryGetUserInfo = function() {</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineminus">-              this._getUserInfo(successCallback, failureCallback);</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineminus">-            }.bind(this);</span>
<a href="#l10.350"></a><span id="l10.350" class="difflineminus">-</span>
<a href="#l10.351"></a><span id="l10.351" class="difflineminus">-            this._handleStaleToken(retryGetUserInfo, failureCallback);</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineminus">-            return;</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineminus">-          }</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineminus">-</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineminus">-          failureCallback();</span>
<a href="#l10.356"></a><span id="l10.356" class="difflineminus">-          return;</span>
<a href="#l10.357"></a><span id="l10.357" class="difflineminus">-        }</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineminus">-        this._userInfo = docResponse;</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineminus">-        let account = docResponse.account;</span>
<a href="#l10.360"></a><span id="l10.360" class="difflineminus">-        let storage = docResponse.storage;</span>
<a href="#l10.361"></a><span id="l10.361" class="difflineminus">-        if (storage) {</span>
<a href="#l10.362"></a><span id="l10.362" class="difflineminus">-          this._fileSpaceUsed = parseInt(storage.currentUsage);</span>
<a href="#l10.363"></a><span id="l10.363" class="difflineminus">-          this._availableStorage = parseInt(storage.storageQuota) - this._fileSpaceUsed;</span>
<a href="#l10.364"></a><span id="l10.364" class="difflineminus">-        } else {</span>
<a href="#l10.365"></a><span id="l10.365" class="difflineminus">-          this._availableStorage = parseInt(account.availableStorage);</span>
<a href="#l10.366"></a><span id="l10.366" class="difflineminus">-        }</span>
<a href="#l10.367"></a><span id="l10.367" class="difflineminus">-</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineminus">-        this._maxFileSize = docResponse.type == &quot;BAS&quot; ? 52428800 : (parseInt(account.maxFileSize));</span>
<a href="#l10.369"></a><span id="l10.369" class="difflineminus">-        this.log.info(&quot;available storage = &quot; + this._availableStorage + &quot; max file size = &quot; + this._maxFileSize);</span>
<a href="#l10.370"></a><span id="l10.370" class="difflineminus">-</span>
<a href="#l10.371"></a><span id="l10.371" class="difflineminus">-        successCallback();</span>
<a href="#l10.372"></a><span id="l10.372" class="difflineminus">-      } else {</span>
<a href="#l10.373"></a><span id="l10.373" class="difflineminus">-        failureCallback();</span>
<a href="#l10.374"></a><span id="l10.374" class="difflineminus">-      }</span>
<a href="#l10.375"></a><span id="l10.375" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.376"></a><span id="l10.376" class="difflineminus">-</span>
<a href="#l10.377"></a><span id="l10.377" class="difflineminus">-    req.onerror = function() {</span>
<a href="#l10.378"></a><span id="l10.378" class="difflineminus">-      this.log.info(&quot;getUserInfo failed - status = &quot; + req.status);</span>
<a href="#l10.379"></a><span id="l10.379" class="difflineminus">-      failureCallback();</span>
<a href="#l10.380"></a><span id="l10.380" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.381"></a><span id="l10.381" class="difflineminus">-    // Add a space at the end because http logging looks for two</span>
<a href="#l10.382"></a><span id="l10.382" class="difflineminus">-    // spaces in the X-Auth-Token header to avoid putting passwords</span>
<a href="#l10.383"></a><span id="l10.383" class="difflineminus">-    // in the log, and crashes if there aren't two spaces.</span>
<a href="#l10.384"></a><span id="l10.384" class="difflineminus">-    req.setRequestHeader(&quot;X-Auth-Token&quot;, this._cachedAuthToken + &quot; &quot;);</span>
<a href="#l10.385"></a><span id="l10.385" class="difflineminus">-    req.setRequestHeader(&quot;X-Api-Key&quot;, kApiKey);</span>
<a href="#l10.386"></a><span id="l10.386" class="difflineminus">-    req.setRequestHeader(&quot;Accept&quot;, &quot;application/json&quot;);</span>
<a href="#l10.387"></a><span id="l10.387" class="difflineminus">-    req.send();</span>
<a href="#l10.388"></a><span id="l10.388" class="difflineminus">-  },</span>
<a href="#l10.389"></a><span id="l10.389" class="difflineminus">-</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineminus">-  /**</span>
<a href="#l10.391"></a><span id="l10.391" class="difflineminus">-   * Returns the sharing URL for some uploaded file.</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineminus">-   *</span>
<a href="#l10.393"></a><span id="l10.393" class="difflineminus">-   * @param aFile the nsIFile to get the URL for.</span>
<a href="#l10.394"></a><span id="l10.394" class="difflineminus">-   */</span>
<a href="#l10.395"></a><span id="l10.395" class="difflineminus">-  urlForFile(aFile) {</span>
<a href="#l10.396"></a><span id="l10.396" class="difflineminus">-    return this._urlsForFiles[aFile.path];</span>
<a href="#l10.397"></a><span id="l10.397" class="difflineminus">-  },</span>
<a href="#l10.398"></a><span id="l10.398" class="difflineminus">-</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineminus">-  /**</span>
<a href="#l10.400"></a><span id="l10.400" class="difflineminus">-   * Attempts to refresh cached profile information for the account associated</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineminus">-   * with this instance's account key.</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineminus">-   *</span>
<a href="#l10.403"></a><span id="l10.403" class="difflineminus">-   * @param aWithUI a boolean for whether or not we should prompt the user for</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineminus">-   *                a password if we don't have a proper token.</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineminus">-   * @param aListener an nsIRequestObserver for monitoring the start and stop</span>
<a href="#l10.406"></a><span id="l10.406" class="difflineminus">-   *                  states of fetching profile information.</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineminus">-   */</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineminus">-  refreshUserInfo(aWithUI, aListener) {</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineminus">-    if (Services.io.offline)</span>
<a href="#l10.410"></a><span id="l10.410" class="difflineminus">-      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l10.411"></a><span id="l10.411" class="difflineminus">-</span>
<a href="#l10.412"></a><span id="l10.412" class="difflineminus">-    aListener.onStartRequest(null);</span>
<a href="#l10.413"></a><span id="l10.413" class="difflineminus">-</span>
<a href="#l10.414"></a><span id="l10.414" class="difflineminus">-    // Let's define some reusable callback functions...</span>
<a href="#l10.415"></a><span id="l10.415" class="difflineminus">-    let onGetUserInfoSuccess = function() {</span>
<a href="#l10.416"></a><span id="l10.416" class="difflineminus">-      aListener.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l10.417"></a><span id="l10.417" class="difflineminus">-    };</span>
<a href="#l10.418"></a><span id="l10.418" class="difflineminus">-</span>
<a href="#l10.419"></a><span id="l10.419" class="difflineminus">-    let onAuthFailure = function() {</span>
<a href="#l10.420"></a><span id="l10.420" class="difflineminus">-      aListener.onStopRequest(null, cloudFileAccounts.constants.authErr);</span>
<a href="#l10.421"></a><span id="l10.421" class="difflineminus">-    };</span>
<a href="#l10.422"></a><span id="l10.422" class="difflineminus">-</span>
<a href="#l10.423"></a><span id="l10.423" class="difflineminus">-    // If we're not logged in, attempt to login, and then attempt to</span>
<a href="#l10.424"></a><span id="l10.424" class="difflineminus">-    // get user info if logging in is successful.</span>
<a href="#l10.425"></a><span id="l10.425" class="difflineminus">-    this.log.info(&quot;Checking to see if we're logged in&quot;);</span>
<a href="#l10.426"></a><span id="l10.426" class="difflineminus">-    if (!this._loggedIn) {</span>
<a href="#l10.427"></a><span id="l10.427" class="difflineminus">-      let onLoginSuccess = function() {</span>
<a href="#l10.428"></a><span id="l10.428" class="difflineminus">-        this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l10.429"></a><span id="l10.429" class="difflineminus">-      }.bind(this);</span>
<a href="#l10.430"></a><span id="l10.430" class="difflineminus">-</span>
<a href="#l10.431"></a><span id="l10.431" class="difflineminus">-      this.logon(onLoginSuccess, onAuthFailure, aWithUI);</span>
<a href="#l10.432"></a><span id="l10.432" class="difflineminus">-      return;</span>
<a href="#l10.433"></a><span id="l10.433" class="difflineminus">-    }</span>
<a href="#l10.434"></a><span id="l10.434" class="difflineminus">-</span>
<a href="#l10.435"></a><span id="l10.435" class="difflineminus">-    // If we're logged in, attempt to get user info.</span>
<a href="#l10.436"></a><span id="l10.436" class="difflineminus">-    if (!this._userInfo)</span>
<a href="#l10.437"></a><span id="l10.437" class="difflineminus">-      this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l10.438"></a><span id="l10.438" class="difflineminus">-  },</span>
<a href="#l10.439"></a><span id="l10.439" class="difflineminus">-</span>
<a href="#l10.440"></a><span id="l10.440" class="difflineminus">-  /**</span>
<a href="#l10.441"></a><span id="l10.441" class="difflineminus">-   * Creates an account for a user.  Note that, currently, this function is</span>
<a href="#l10.442"></a><span id="l10.442" class="difflineminus">-   * not being used by the UI.</span>
<a href="#l10.443"></a><span id="l10.443" class="difflineminus">-   */</span>
<a href="#l10.444"></a><span id="l10.444" class="difflineminus">-  createNewAccount(aEmailAddress, aPassword, aFirstName, aLastName, aRequestObserver) {</span>
<a href="#l10.445"></a><span id="l10.445" class="difflineminus">-    if (Services.io.offline)</span>
<a href="#l10.446"></a><span id="l10.446" class="difflineminus">-      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l10.447"></a><span id="l10.447" class="difflineminus">-</span>
<a href="#l10.448"></a><span id="l10.448" class="difflineminus">-    let args = &quot;?email=&quot; + aEmailAddress + &quot;&amp;password=&quot; + aPassword + &quot;&amp;firstname=&quot;</span>
<a href="#l10.449"></a><span id="l10.449" class="difflineminus">-               + aFirstName + &quot;&amp;lastname=&quot; + aLastName + &quot;&amp;&quot;;</span>
<a href="#l10.450"></a><span id="l10.450" class="difflineminus">-</span>
<a href="#l10.451"></a><span id="l10.451" class="difflineminus">-    let req = new XMLHttpRequest();</span>
<a href="#l10.452"></a><span id="l10.452" class="difflineminus">-</span>
<a href="#l10.453"></a><span id="l10.453" class="difflineminus">-    req.open(&quot;POST&quot;, gServerUrl + kUserInfoPath + args + kUrlTail, true);</span>
<a href="#l10.454"></a><span id="l10.454" class="difflineminus">-</span>
<a href="#l10.455"></a><span id="l10.455" class="difflineminus">-    req.onload = function() {</span>
<a href="#l10.456"></a><span id="l10.456" class="difflineminus">-      if (req.status &gt;= 200 &amp;&amp;</span>
<a href="#l10.457"></a><span id="l10.457" class="difflineminus">-          req.status &lt; 400) {</span>
<a href="#l10.458"></a><span id="l10.458" class="difflineminus">-        this.log.info(&quot;request status = &quot; + req + &quot; response = &quot; +</span>
<a href="#l10.459"></a><span id="l10.459" class="difflineminus">-                      req.responseText);</span>
<a href="#l10.460"></a><span id="l10.460" class="difflineminus">-        aRequestObserver.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l10.461"></a><span id="l10.461" class="difflineminus">-      } else {</span>
<a href="#l10.462"></a><span id="l10.462" class="difflineminus">-        let docResponse = JSON.parse(req.responseText);</span>
<a href="#l10.463"></a><span id="l10.463" class="difflineminus">-        this._lastErrorText = docResponse.errorStatus.message;</span>
<a href="#l10.464"></a><span id="l10.464" class="difflineminus">-        this._lastErrorStatus = docResponse.errorStatus.code;</span>
<a href="#l10.465"></a><span id="l10.465" class="difflineminus">-        aRequestObserver.onStopRequest(null, Cr.NS_ERROR_FAILURE);</span>
<a href="#l10.466"></a><span id="l10.466" class="difflineminus">-      }</span>
<a href="#l10.467"></a><span id="l10.467" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.468"></a><span id="l10.468" class="difflineminus">-</span>
<a href="#l10.469"></a><span id="l10.469" class="difflineminus">-    req.onerror = function() {</span>
<a href="#l10.470"></a><span id="l10.470" class="difflineminus">-      this.log.info(&quot;getUserInfo failed - status = &quot; + req.status);</span>
<a href="#l10.471"></a><span id="l10.471" class="difflineminus">-      aRequestObserver.onStopRequest(null, Cr.NS_ERROR_FAILURE);</span>
<a href="#l10.472"></a><span id="l10.472" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.473"></a><span id="l10.473" class="difflineminus">-    // Add a space at the end because http logging looks for two</span>
<a href="#l10.474"></a><span id="l10.474" class="difflineminus">-    // spaces in the X-Auth-Token header to avoid putting passwords</span>
<a href="#l10.475"></a><span id="l10.475" class="difflineminus">-    // in the log, and crashes if there aren't two spaces.</span>
<a href="#l10.476"></a><span id="l10.476" class="difflineminus">-    req.setRequestHeader(&quot;X-Auth-Token&quot;, this._cachedAuthToken + &quot; &quot;);</span>
<a href="#l10.477"></a><span id="l10.477" class="difflineminus">-    req.setRequestHeader(&quot;X-Api-Key&quot;, kApiKey);</span>
<a href="#l10.478"></a><span id="l10.478" class="difflineminus">-    req.setRequestHeader(&quot;Accept&quot;, &quot;application/json&quot;);</span>
<a href="#l10.479"></a><span id="l10.479" class="difflineminus">-    req.send();</span>
<a href="#l10.480"></a><span id="l10.480" class="difflineminus">-  },</span>
<a href="#l10.481"></a><span id="l10.481" class="difflineminus">-</span>
<a href="#l10.482"></a><span id="l10.482" class="difflineminus">-  /**</span>
<a href="#l10.483"></a><span id="l10.483" class="difflineminus">-   * Attempt to find folder by name on Hightail website.</span>
<a href="#l10.484"></a><span id="l10.484" class="difflineminus">-   *</span>
<a href="#l10.485"></a><span id="l10.485" class="difflineminus">-   * @param aFolderName name of folder</span>
<a href="#l10.486"></a><span id="l10.486" class="difflineminus">-   * @param aParentFolderId id of folder where we are looking</span>
<a href="#l10.487"></a><span id="l10.487" class="difflineminus">-   * @param aNotFoundCallback called if folder is not found</span>
<a href="#l10.488"></a><span id="l10.488" class="difflineminus">-   * @param aFoundCallback called if folder is found</span>
<a href="#l10.489"></a><span id="l10.489" class="difflineminus">-   */</span>
<a href="#l10.490"></a><span id="l10.490" class="difflineminus">-  _findFolder(aFolderName, aParentFolderId, aNotFoundCallback, aFoundCallback) {</span>
<a href="#l10.491"></a><span id="l10.491" class="difflineminus">-    this.log.info(&quot;Find folder: &quot; + aFolderName);</span>
<a href="#l10.492"></a><span id="l10.492" class="difflineminus">-</span>
<a href="#l10.493"></a><span id="l10.493" class="difflineminus">-    let checkChildFolders = function(folders) {</span>
<a href="#l10.494"></a><span id="l10.494" class="difflineminus">-      this.log.info(&quot;Looking for a child folder&quot;);</span>
<a href="#l10.495"></a><span id="l10.495" class="difflineminus">-      let folderId = 0;</span>
<a href="#l10.496"></a><span id="l10.496" class="difflineminus">-      let folder = folders.folder;</span>
<a href="#l10.497"></a><span id="l10.497" class="difflineminus">-      for (let i in folder) {</span>
<a href="#l10.498"></a><span id="l10.498" class="difflineminus">-        if (folder[i].name == aFolderName) {</span>
<a href="#l10.499"></a><span id="l10.499" class="difflineminus">-          folderId = folder[i].id;</span>
<a href="#l10.500"></a><span id="l10.500" class="difflineminus">-          break;</span>
<a href="#l10.501"></a><span id="l10.501" class="difflineminus">-        }</span>
<a href="#l10.502"></a><span id="l10.502" class="difflineminus">-      }</span>
<a href="#l10.503"></a><span id="l10.503" class="difflineminus">-</span>
<a href="#l10.504"></a><span id="l10.504" class="difflineminus">-      if (!folderId &amp;&amp; aNotFoundCallback)</span>
<a href="#l10.505"></a><span id="l10.505" class="difflineminus">-        aNotFoundCallback(aParentFolderId);</span>
<a href="#l10.506"></a><span id="l10.506" class="difflineminus">-</span>
<a href="#l10.507"></a><span id="l10.507" class="difflineminus">-      if (folderId &amp;&amp; aFoundCallback)</span>
<a href="#l10.508"></a><span id="l10.508" class="difflineminus">-        aFoundCallback(folderId);</span>
<a href="#l10.509"></a><span id="l10.509" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.510"></a><span id="l10.510" class="difflineminus">-</span>
<a href="#l10.511"></a><span id="l10.511" class="difflineminus">-    this._checkFolderExist(aParentFolderId, checkChildFolders);</span>
<a href="#l10.512"></a><span id="l10.512" class="difflineminus">-  },</span>
<a href="#l10.513"></a><span id="l10.513" class="difflineminus">-</span>
<a href="#l10.514"></a><span id="l10.514" class="difflineminus">-  /**</span>
<a href="#l10.515"></a><span id="l10.515" class="difflineminus">-   * Attempt to find folder by id on Hightail website.</span>
<a href="#l10.516"></a><span id="l10.516" class="difflineminus">-   *</span>
<a href="#l10.517"></a><span id="l10.517" class="difflineminus">-   * @param aFolderId id of folder</span>
<a href="#l10.518"></a><span id="l10.518" class="difflineminus">-   * @param aNotFoundCallback called if folder is not found</span>
<a href="#l10.519"></a><span id="l10.519" class="difflineminus">-   * @param aFoundCallback called if folder is found</span>
<a href="#l10.520"></a><span id="l10.520" class="difflineminus">-   */</span>
<a href="#l10.521"></a><span id="l10.521" class="difflineminus">-  _checkFolderExist(aFolderId, aFoundCallback, aNotFoundCallback) {</span>
<a href="#l10.522"></a><span id="l10.522" class="difflineminus">-    this.log.info(&quot;checkFolderExist&quot;);</span>
<a href="#l10.523"></a><span id="l10.523" class="difflineminus">-    if (Services.io.offline)</span>
<a href="#l10.524"></a><span id="l10.524" class="difflineminus">-      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l10.525"></a><span id="l10.525" class="difflineminus">-</span>
<a href="#l10.526"></a><span id="l10.526" class="difflineminus">-    let args = &quot;?includeFiles=false&amp;includeFolders=true&amp;&quot;;</span>
<a href="#l10.527"></a><span id="l10.527" class="difflineminus">-</span>
<a href="#l10.528"></a><span id="l10.528" class="difflineminus">-    let req = new XMLHttpRequest();</span>
<a href="#l10.529"></a><span id="l10.529" class="difflineminus">-</span>
<a href="#l10.530"></a><span id="l10.530" class="difflineminus">-    req.open(&quot;GET&quot;,</span>
<a href="#l10.531"></a><span id="l10.531" class="difflineminus">-             gServerUrl + kFolderPath + aFolderId + args + kUrlTail,</span>
<a href="#l10.532"></a><span id="l10.532" class="difflineminus">-             true);</span>
<a href="#l10.533"></a><span id="l10.533" class="difflineminus">-</span>
<a href="#l10.534"></a><span id="l10.534" class="difflineminus">-    req.onload = function() {</span>
<a href="#l10.535"></a><span id="l10.535" class="difflineminus">-      let docResponse = JSON.parse(req.responseText);</span>
<a href="#l10.536"></a><span id="l10.536" class="difflineminus">-      if (req.status &gt;= 200 &amp;&amp; req.status &lt; 400) {</span>
<a href="#l10.537"></a><span id="l10.537" class="difflineminus">-        this.log.info(&quot;request status = &quot; + req + &quot; response = &quot; +</span>
<a href="#l10.538"></a><span id="l10.538" class="difflineminus">-                      req.responseText);</span>
<a href="#l10.539"></a><span id="l10.539" class="difflineminus">-</span>
<a href="#l10.540"></a><span id="l10.540" class="difflineminus">-        if (aFoundCallback &amp;&amp; docResponse.folders)</span>
<a href="#l10.541"></a><span id="l10.541" class="difflineminus">-          aFoundCallback(docResponse.folders);</span>
<a href="#l10.542"></a><span id="l10.542" class="difflineminus">-      } else {</span>
<a href="#l10.543"></a><span id="l10.543" class="difflineminus">-        this._lastErrorText = docResponse.errorStatus.message;</span>
<a href="#l10.544"></a><span id="l10.544" class="difflineminus">-        this._lastErrorStatus = docResponse.errorStatus.code;</span>
<a href="#l10.545"></a><span id="l10.545" class="difflineminus">-        if (this._lastErrorStatus == 400 &amp;&amp; this._lastErrorText == &quot;Not Found&quot; &amp;&amp; aNotFoundCallback)</span>
<a href="#l10.546"></a><span id="l10.546" class="difflineminus">-          aNotFoundCallback();</span>
<a href="#l10.547"></a><span id="l10.547" class="difflineminus">-      }</span>
<a href="#l10.548"></a><span id="l10.548" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.549"></a><span id="l10.549" class="difflineminus">-</span>
<a href="#l10.550"></a><span id="l10.550" class="difflineminus">-    req.onerror = function() {</span>
<a href="#l10.551"></a><span id="l10.551" class="difflineminus">-      this.log.info(&quot;_checkFolderExist failed - status = &quot; + req.status);</span>
<a href="#l10.552"></a><span id="l10.552" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.553"></a><span id="l10.553" class="difflineminus">-    // Add a space at the end because http logging looks for two</span>
<a href="#l10.554"></a><span id="l10.554" class="difflineminus">-    // spaces in the X-Auth-Token header to avoid putting passwords</span>
<a href="#l10.555"></a><span id="l10.555" class="difflineminus">-    // in the log, and crashes if there aren't two spaces.</span>
<a href="#l10.556"></a><span id="l10.556" class="difflineminus">-    req.setRequestHeader(&quot;X-Auth-Token&quot;, this._cachedAuthToken + &quot; &quot;);</span>
<a href="#l10.557"></a><span id="l10.557" class="difflineminus">-    req.setRequestHeader(&quot;X-Api-Key&quot;, kApiKey);</span>
<a href="#l10.558"></a><span id="l10.558" class="difflineminus">-    req.setRequestHeader(&quot;Accept&quot;, &quot;application/json&quot;);</span>
<a href="#l10.559"></a><span id="l10.559" class="difflineminus">-    req.send();</span>
<a href="#l10.560"></a><span id="l10.560" class="difflineminus">-  },</span>
<a href="#l10.561"></a><span id="l10.561" class="difflineminus">-</span>
<a href="#l10.562"></a><span id="l10.562" class="difflineminus">-  /**</span>
<a href="#l10.563"></a><span id="l10.563" class="difflineminus">-   * Private function for creating folder on Hightail website.</span>
<a href="#l10.564"></a><span id="l10.564" class="difflineminus">-   *</span>
<a href="#l10.565"></a><span id="l10.565" class="difflineminus">-   * @param aName name of folder</span>
<a href="#l10.566"></a><span id="l10.566" class="difflineminus">-   * @param aParent id of parent folder</span>
<a href="#l10.567"></a><span id="l10.567" class="difflineminus">-   * @param aSuccessCallback called when folder is created</span>
<a href="#l10.568"></a><span id="l10.568" class="difflineminus">-   */</span>
<a href="#l10.569"></a><span id="l10.569" class="difflineminus">-  _createFolder(aName, aParent, aSuccessCallback) {</span>
<a href="#l10.570"></a><span id="l10.570" class="difflineminus">-    this.log.info(&quot;Create folder: &quot; + aName);</span>
<a href="#l10.571"></a><span id="l10.571" class="difflineminus">-    if (Services.io.offline)</span>
<a href="#l10.572"></a><span id="l10.572" class="difflineminus">-      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l10.573"></a><span id="l10.573" class="difflineminus">-</span>
<a href="#l10.574"></a><span id="l10.574" class="difflineminus">-    let args = &quot;?name=&quot; + aName + &quot;&amp;parentId=&quot; + aParent + &quot;&amp;&quot;;</span>
<a href="#l10.575"></a><span id="l10.575" class="difflineminus">-</span>
<a href="#l10.576"></a><span id="l10.576" class="difflineminus">-    let req = new XMLHttpRequest();</span>
<a href="#l10.577"></a><span id="l10.577" class="difflineminus">-</span>
<a href="#l10.578"></a><span id="l10.578" class="difflineminus">-    req.open(&quot;POST&quot;, gServerUrl + kFolderPath.replace(/\/$/, &quot;&quot;) + args + kUrlTail, true);</span>
<a href="#l10.579"></a><span id="l10.579" class="difflineminus">-</span>
<a href="#l10.580"></a><span id="l10.580" class="difflineminus">-    req.onload = function() {</span>
<a href="#l10.581"></a><span id="l10.581" class="difflineminus">-      let docResponse = JSON.parse(req.responseText);</span>
<a href="#l10.582"></a><span id="l10.582" class="difflineminus">-      if (req.status &gt;= 200 &amp;&amp; req.status &lt; 400) {</span>
<a href="#l10.583"></a><span id="l10.583" class="difflineminus">-        this.log.info(&quot;request status = &quot; + req + &quot; response = &quot; +</span>
<a href="#l10.584"></a><span id="l10.584" class="difflineminus">-                      req.responseText);</span>
<a href="#l10.585"></a><span id="l10.585" class="difflineminus">-</span>
<a href="#l10.586"></a><span id="l10.586" class="difflineminus">-        if (aSuccessCallback)</span>
<a href="#l10.587"></a><span id="l10.587" class="difflineminus">-          aSuccessCallback(docResponse.id);</span>
<a href="#l10.588"></a><span id="l10.588" class="difflineminus">-      } else {</span>
<a href="#l10.589"></a><span id="l10.589" class="difflineminus">-        this._lastErrorText = docResponse.errorStatus.message;</span>
<a href="#l10.590"></a><span id="l10.590" class="difflineminus">-        this._lastErrorStatus = docResponse.errorStatus.code;</span>
<a href="#l10.591"></a><span id="l10.591" class="difflineminus">-      }</span>
<a href="#l10.592"></a><span id="l10.592" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.593"></a><span id="l10.593" class="difflineminus">-</span>
<a href="#l10.594"></a><span id="l10.594" class="difflineminus">-    req.onerror = function() {</span>
<a href="#l10.595"></a><span id="l10.595" class="difflineminus">-      this.log.info(&quot;createFolder failed - status = &quot; + req.status);</span>
<a href="#l10.596"></a><span id="l10.596" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.597"></a><span id="l10.597" class="difflineminus">-    // Add a space at the end because http logging looks for two</span>
<a href="#l10.598"></a><span id="l10.598" class="difflineminus">-    // spaces in the X-Auth-Token header to avoid putting passwords</span>
<a href="#l10.599"></a><span id="l10.599" class="difflineminus">-    // in the log, and crashes if there aren't two spaces.</span>
<a href="#l10.600"></a><span id="l10.600" class="difflineminus">-    req.setRequestHeader(&quot;X-Auth-Token&quot;, this._cachedAuthToken + &quot; &quot;);</span>
<a href="#l10.601"></a><span id="l10.601" class="difflineminus">-    req.setRequestHeader(&quot;X-Api-Key&quot;, kApiKey);</span>
<a href="#l10.602"></a><span id="l10.602" class="difflineminus">-    req.setRequestHeader(&quot;Accept&quot;, &quot;application/json&quot;);</span>
<a href="#l10.603"></a><span id="l10.603" class="difflineminus">-    req.send();</span>
<a href="#l10.604"></a><span id="l10.604" class="difflineminus">-  },</span>
<a href="#l10.605"></a><span id="l10.605" class="difflineminus">-</span>
<a href="#l10.606"></a><span id="l10.606" class="difflineminus">-  /**</span>
<a href="#l10.607"></a><span id="l10.607" class="difflineminus">-   * If a the user associated with this account key already has an account,</span>
<a href="#l10.608"></a><span id="l10.608" class="difflineminus">-   * allows them to log in.</span>
<a href="#l10.609"></a><span id="l10.609" class="difflineminus">-   *</span>
<a href="#l10.610"></a><span id="l10.610" class="difflineminus">-   * @param aRequestObserver an nsIRequestObserver for monitoring the start and</span>
<a href="#l10.611"></a><span id="l10.611" class="difflineminus">-   *                         stop states of the login procedure.</span>
<a href="#l10.612"></a><span id="l10.612" class="difflineminus">-   */</span>
<a href="#l10.613"></a><span id="l10.613" class="difflineminus">-  createExistingAccount(aRequestObserver) {</span>
<a href="#l10.614"></a><span id="l10.614" class="difflineminus">-     // XXX: replace this with a better function</span>
<a href="#l10.615"></a><span id="l10.615" class="difflineminus">-    let successCb = function(aResponseText, aRequest) {</span>
<a href="#l10.616"></a><span id="l10.616" class="difflineminus">-      aRequestObserver.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l10.617"></a><span id="l10.617" class="difflineminus">-    };</span>
<a href="#l10.618"></a><span id="l10.618" class="difflineminus">-</span>
<a href="#l10.619"></a><span id="l10.619" class="difflineminus">-    let failureCb = function(aResponseText, aRequest) {</span>
<a href="#l10.620"></a><span id="l10.620" class="difflineminus">-      aRequestObserver.onStopRequest(null, cloudFileAccounts.constants.authErr);</span>
<a href="#l10.621"></a><span id="l10.621" class="difflineminus">-    };</span>
<a href="#l10.622"></a><span id="l10.622" class="difflineminus">-</span>
<a href="#l10.623"></a><span id="l10.623" class="difflineminus">-    this.logon(successCb, failureCb, true);</span>
<a href="#l10.624"></a><span id="l10.624" class="difflineminus">-  },</span>
<a href="#l10.625"></a><span id="l10.625" class="difflineminus">-</span>
<a href="#l10.626"></a><span id="l10.626" class="difflineminus">-  /**</span>
<a href="#l10.627"></a><span id="l10.627" class="difflineminus">-   * Returns an appropriate provider-specific URL for dealing with a particular</span>
<a href="#l10.628"></a><span id="l10.628" class="difflineminus">-   * error type.</span>
<a href="#l10.629"></a><span id="l10.629" class="difflineminus">-   *</span>
<a href="#l10.630"></a><span id="l10.630" class="difflineminus">-   * @param aError an error to get the URL for.</span>
<a href="#l10.631"></a><span id="l10.631" class="difflineminus">-   */</span>
<a href="#l10.632"></a><span id="l10.632" class="difflineminus">-  providerUrlForError(aError) {</span>
<a href="#l10.633"></a><span id="l10.633" class="difflineminus">-    if (aError == cloudFileAccounts.constants.uploadExceedsFileLimit)</span>
<a href="#l10.634"></a><span id="l10.634" class="difflineminus">-      return &quot;http://www.hightail.com&quot;;</span>
<a href="#l10.635"></a><span id="l10.635" class="difflineminus">-    return &quot;&quot;;</span>
<a href="#l10.636"></a><span id="l10.636" class="difflineminus">-  },</span>
<a href="#l10.637"></a><span id="l10.637" class="difflineminus">-</span>
<a href="#l10.638"></a><span id="l10.638" class="difflineminus">-  /**</span>
<a href="#l10.639"></a><span id="l10.639" class="difflineminus">-   * If the provider doesn't have an API for creating an account, perhaps</span>
<a href="#l10.640"></a><span id="l10.640" class="difflineminus">-   * there's a url we can load in a content tab that will allow the user</span>
<a href="#l10.641"></a><span id="l10.641" class="difflineminus">-   * to create an account.</span>
<a href="#l10.642"></a><span id="l10.642" class="difflineminus">-   */</span>
<a href="#l10.643"></a><span id="l10.643" class="difflineminus">-  get createNewAccountUrl() { return &quot;&quot;; },</span>
<a href="#l10.644"></a><span id="l10.644" class="difflineminus">-</span>
<a href="#l10.645"></a><span id="l10.645" class="difflineminus">-  /**</span>
<a href="#l10.646"></a><span id="l10.646" class="difflineminus">-   * If we don't know the limit, this will return -1.</span>
<a href="#l10.647"></a><span id="l10.647" class="difflineminus">-   */</span>
<a href="#l10.648"></a><span id="l10.648" class="difflineminus">-  get fileUploadSizeLimit() { return this._maxFileSize; },</span>
<a href="#l10.649"></a><span id="l10.649" class="difflineminus">-</span>
<a href="#l10.650"></a><span id="l10.650" class="difflineminus">-  get remainingFileSpace() { return this._availableStorage; },</span>
<a href="#l10.651"></a><span id="l10.651" class="difflineminus">-</span>
<a href="#l10.652"></a><span id="l10.652" class="difflineminus">-  get fileSpaceUsed() { return this._fileSpaceUsed; },</span>
<a href="#l10.653"></a><span id="l10.653" class="difflineminus">-</span>
<a href="#l10.654"></a><span id="l10.654" class="difflineminus">-  /**</span>
<a href="#l10.655"></a><span id="l10.655" class="difflineminus">-   * Attempts to delete an uploaded file.</span>
<a href="#l10.656"></a><span id="l10.656" class="difflineminus">-   *</span>
<a href="#l10.657"></a><span id="l10.657" class="difflineminus">-   * @param aFile the nsIFile to delete.</span>
<a href="#l10.658"></a><span id="l10.658" class="difflineminus">-   * @param aCallback an nsIRequestObserver for monitoring the start and stop</span>
<a href="#l10.659"></a><span id="l10.659" class="difflineminus">-   *                  states of the delete procedure.</span>
<a href="#l10.660"></a><span id="l10.660" class="difflineminus">-   */</span>
<a href="#l10.661"></a><span id="l10.661" class="difflineminus">-  deleteFile(aFile, aCallback) {</span>
<a href="#l10.662"></a><span id="l10.662" class="difflineminus">-    this.log.info(&quot;Deleting a file&quot;);</span>
<a href="#l10.663"></a><span id="l10.663" class="difflineminus">-</span>
<a href="#l10.664"></a><span id="l10.664" class="difflineminus">-    if (Services.io.offline) {</span>
<a href="#l10.665"></a><span id="l10.665" class="difflineminus">-      this.log.error(&quot;We're offline - we can't delete the file.&quot;);</span>
<a href="#l10.666"></a><span id="l10.666" class="difflineminus">-      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l10.667"></a><span id="l10.667" class="difflineminus">-    }</span>
<a href="#l10.668"></a><span id="l10.668" class="difflineminus">-</span>
<a href="#l10.669"></a><span id="l10.669" class="difflineminus">-    let uploadInfo = this._uploadInfo[aFile.path];</span>
<a href="#l10.670"></a><span id="l10.670" class="difflineminus">-    if (!uploadInfo) {</span>
<a href="#l10.671"></a><span id="l10.671" class="difflineminus">-      this.log.error(&quot;Could not find a record for the file to be deleted.&quot;);</span>
<a href="#l10.672"></a><span id="l10.672" class="difflineminus">-      throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l10.673"></a><span id="l10.673" class="difflineminus">-    }</span>
<a href="#l10.674"></a><span id="l10.674" class="difflineminus">-</span>
<a href="#l10.675"></a><span id="l10.675" class="difflineminus">-    let req = new XMLHttpRequest();</span>
<a href="#l10.676"></a><span id="l10.676" class="difflineminus">-</span>
<a href="#l10.677"></a><span id="l10.677" class="difflineminus">-    let args = kFolderFilePath + uploadInfo.fileId + &quot;?&quot;;</span>
<a href="#l10.678"></a><span id="l10.678" class="difflineminus">-</span>
<a href="#l10.679"></a><span id="l10.679" class="difflineminus">-    req.open(&quot;DELETE&quot;, gServerUrl + args + kUrlTail, true);</span>
<a href="#l10.680"></a><span id="l10.680" class="difflineminus">-    this.log.info(&quot;Sending request to: &quot; + gServerUrl + args);</span>
<a href="#l10.681"></a><span id="l10.681" class="difflineminus">-</span>
<a href="#l10.682"></a><span id="l10.682" class="difflineminus">-    req.onerror = function() {</span>
<a href="#l10.683"></a><span id="l10.683" class="difflineminus">-      let response = JSON.parse(req.responseText);</span>
<a href="#l10.684"></a><span id="l10.684" class="difflineminus">-      this._lastErrorStatus = response.errorStatus.status;</span>
<a href="#l10.685"></a><span id="l10.685" class="difflineminus">-      this._lastErrorText = response.errorStatus.message;</span>
<a href="#l10.686"></a><span id="l10.686" class="difflineminus">-      this.log.error(&quot;There was a problem deleting: &quot; + this._lastErrorText);</span>
<a href="#l10.687"></a><span id="l10.687" class="difflineminus">-      aCallback.onStopRequest(null, Cr.NS_ERROR_FAILURE);</span>
<a href="#l10.688"></a><span id="l10.688" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.689"></a><span id="l10.689" class="difflineminus">-</span>
<a href="#l10.690"></a><span id="l10.690" class="difflineminus">-    req.onload = function() {</span>
<a href="#l10.691"></a><span id="l10.691" class="difflineminus">-      // Response is the URL.</span>
<a href="#l10.692"></a><span id="l10.692" class="difflineminus">-      let response = req.responseText;</span>
<a href="#l10.693"></a><span id="l10.693" class="difflineminus">-      this.log.info(&quot;delete response = &quot; + response);</span>
<a href="#l10.694"></a><span id="l10.694" class="difflineminus">-      let deleteInfo = JSON.parse(response);</span>
<a href="#l10.695"></a><span id="l10.695" class="difflineminus">-</span>
<a href="#l10.696"></a><span id="l10.696" class="difflineminus">-      if (deleteInfo.errorStatus) {</span>
<a href="#l10.697"></a><span id="l10.697" class="difflineminus">-        // Argh - for some reason, on deletion, the error code for a stale</span>
<a href="#l10.698"></a><span id="l10.698" class="difflineminus">-        // token is 401 instead of 500.</span>
<a href="#l10.699"></a><span id="l10.699" class="difflineminus">-        if (deleteInfo.errorStatus.code == 401) {</span>
<a href="#l10.700"></a><span id="l10.700" class="difflineminus">-          this.log.warn(&quot;Token has gone stale! Will attempt to reauth.&quot;);</span>
<a href="#l10.701"></a><span id="l10.701" class="difflineminus">-          // Our token has gone stale</span>
<a href="#l10.702"></a><span id="l10.702" class="difflineminus">-          let onTokenRefresh = function() {</span>
<a href="#l10.703"></a><span id="l10.703" class="difflineminus">-            this.deleteFile(aFile, aCallback);</span>
<a href="#l10.704"></a><span id="l10.704" class="difflineminus">-          }.bind(this);</span>
<a href="#l10.705"></a><span id="l10.705" class="difflineminus">-</span>
<a href="#l10.706"></a><span id="l10.706" class="difflineminus">-          let onTokenRefreshFailure = function() {</span>
<a href="#l10.707"></a><span id="l10.707" class="difflineminus">-            aCallback.onStopRequest(null, cloudFileAccounts.constants.authErr);</span>
<a href="#l10.708"></a><span id="l10.708" class="difflineminus">-          };</span>
<a href="#l10.709"></a><span id="l10.709" class="difflineminus">-          this._handleStaleToken(onTokenRefresh, onTokenRefreshFailure);</span>
<a href="#l10.710"></a><span id="l10.710" class="difflineminus">-          return;</span>
<a href="#l10.711"></a><span id="l10.711" class="difflineminus">-        }</span>
<a href="#l10.712"></a><span id="l10.712" class="difflineminus">-</span>
<a href="#l10.713"></a><span id="l10.713" class="difflineminus">-        this.log.error(&quot;Server has returned a failure on our delete request.&quot;);</span>
<a href="#l10.714"></a><span id="l10.714" class="difflineminus">-        this.log.error(&quot;Error code: &quot; + deleteInfo.errorStatus.code);</span>
<a href="#l10.715"></a><span id="l10.715" class="difflineminus">-        this.log.error(&quot;Error message: &quot; + deleteInfo.errorStatus.message);</span>
<a href="#l10.716"></a><span id="l10.716" class="difflineminus">-        // aCallback.onStopRequest(null, Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l10.717"></a><span id="l10.717" class="difflineminus">-        return;</span>
<a href="#l10.718"></a><span id="l10.718" class="difflineminus">-      }</span>
<a href="#l10.719"></a><span id="l10.719" class="difflineminus">-</span>
<a href="#l10.720"></a><span id="l10.720" class="difflineminus">-      this.log.info(&quot;Delete was successful!&quot;);</span>
<a href="#l10.721"></a><span id="l10.721" class="difflineminus">-      // Success!</span>
<a href="#l10.722"></a><span id="l10.722" class="difflineminus">-      aCallback.onStopRequest(null, Cr.NS_OK);</span>
<a href="#l10.723"></a><span id="l10.723" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.724"></a><span id="l10.724" class="difflineminus">-</span>
<a href="#l10.725"></a><span id="l10.725" class="difflineminus">-    req.setRequestHeader(&quot;X-Auth-Token&quot;, this._cachedAuthToken + &quot; &quot;);</span>
<a href="#l10.726"></a><span id="l10.726" class="difflineminus">-    req.setRequestHeader(&quot;X-Api-Key&quot;, kApiKey);</span>
<a href="#l10.727"></a><span id="l10.727" class="difflineminus">-    req.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);</span>
<a href="#l10.728"></a><span id="l10.728" class="difflineminus">-    req.setRequestHeader(&quot;Accept&quot;, &quot;application/json&quot;);</span>
<a href="#l10.729"></a><span id="l10.729" class="difflineminus">-    req.send();</span>
<a href="#l10.730"></a><span id="l10.730" class="difflineminus">-  },</span>
<a href="#l10.731"></a><span id="l10.731" class="difflineminus">-</span>
<a href="#l10.732"></a><span id="l10.732" class="difflineminus">-  /**</span>
<a href="#l10.733"></a><span id="l10.733" class="difflineminus">-   * Returns the saved password for this account if one exists, or prompts</span>
<a href="#l10.734"></a><span id="l10.734" class="difflineminus">-   * the user for a password. Returns the empty string on failure.</span>
<a href="#l10.735"></a><span id="l10.735" class="difflineminus">-   *</span>
<a href="#l10.736"></a><span id="l10.736" class="difflineminus">-   * @param aUsername the username associated with the account / password.</span>
<a href="#l10.737"></a><span id="l10.737" class="difflineminus">-   * @param aNoPrompt a boolean for whether or not we should suppress</span>
<a href="#l10.738"></a><span id="l10.738" class="difflineminus">-   *                  the password prompt if no password exists.  If so,</span>
<a href="#l10.739"></a><span id="l10.739" class="difflineminus">-   *                  returns the empty string if no password exists.</span>
<a href="#l10.740"></a><span id="l10.740" class="difflineminus">-   */</span>
<a href="#l10.741"></a><span id="l10.741" class="difflineminus">-  getPassword(aUsername, aNoPrompt) {</span>
<a href="#l10.742"></a><span id="l10.742" class="difflineminus">-    this.log.info(&quot;Getting password for user: &quot; + aUsername);</span>
<a href="#l10.743"></a><span id="l10.743" class="difflineminus">-</span>
<a href="#l10.744"></a><span id="l10.744" class="difflineminus">-    if (aNoPrompt)</span>
<a href="#l10.745"></a><span id="l10.745" class="difflineminus">-      this.log.info(&quot;Suppressing password prompt&quot;);</span>
<a href="#l10.746"></a><span id="l10.746" class="difflineminus">-</span>
<a href="#l10.747"></a><span id="l10.747" class="difflineminus">-    let passwordURI = gServerUrl;</span>
<a href="#l10.748"></a><span id="l10.748" class="difflineminus">-    let logins = Services.logins.findLogins({}, passwordURI, null, passwordURI);</span>
<a href="#l10.749"></a><span id="l10.749" class="difflineminus">-    for (let loginInfo of logins) {</span>
<a href="#l10.750"></a><span id="l10.750" class="difflineminus">-      if (loginInfo.username == aUsername)</span>
<a href="#l10.751"></a><span id="l10.751" class="difflineminus">-        return loginInfo.password;</span>
<a href="#l10.752"></a><span id="l10.752" class="difflineminus">-    }</span>
<a href="#l10.753"></a><span id="l10.753" class="difflineminus">-    if (aNoPrompt)</span>
<a href="#l10.754"></a><span id="l10.754" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l10.755"></a><span id="l10.755" class="difflineminus">-</span>
<a href="#l10.756"></a><span id="l10.756" class="difflineminus">-    // OK, let's prompt for it.</span>
<a href="#l10.757"></a><span id="l10.757" class="difflineminus">-    let win = Services.wm.getMostRecentWindow(null);</span>
<a href="#l10.758"></a><span id="l10.758" class="difflineminus">-</span>
<a href="#l10.759"></a><span id="l10.759" class="difflineminus">-    let authPrompter = Services.ww.getNewAuthPrompter(win);</span>
<a href="#l10.760"></a><span id="l10.760" class="difflineminus">-    let password = { value: &quot;&quot; };</span>
<a href="#l10.761"></a><span id="l10.761" class="difflineminus">-    // Use the service name in the prompt text</span>
<a href="#l10.762"></a><span id="l10.762" class="difflineminus">-    let serverUrl = gServerUrl;</span>
<a href="#l10.763"></a><span id="l10.763" class="difflineminus">-    let userPos = gServerUrl.indexOf(&quot;//&quot;) + 2;</span>
<a href="#l10.764"></a><span id="l10.764" class="difflineminus">-    let userNamePart = encodeURIComponent(this._userName) + &quot;@&quot;;</span>
<a href="#l10.765"></a><span id="l10.765" class="difflineminus">-    serverUrl = gServerUrl.substr(0, userPos) + userNamePart + gServerUrl.substr(userPos);</span>
<a href="#l10.766"></a><span id="l10.766" class="difflineminus">-    let messengerBundle = Services.strings.createBundle(</span>
<a href="#l10.767"></a><span id="l10.767" class="difflineminus">-      &quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l10.768"></a><span id="l10.768" class="difflineminus">-    let promptString = messengerBundle.formatStringFromName(&quot;passwordPrompt&quot;,</span>
<a href="#l10.769"></a><span id="l10.769" class="difflineminus">-                                                            [this._userName,</span>
<a href="#l10.770"></a><span id="l10.770" class="difflineminus">-                                                             this.displayName],</span>
<a href="#l10.771"></a><span id="l10.771" class="difflineminus">-                                                            2);</span>
<a href="#l10.772"></a><span id="l10.772" class="difflineminus">-</span>
<a href="#l10.773"></a><span id="l10.773" class="difflineminus">-    if (authPrompter.promptPassword(this.displayName, promptString, serverUrl,</span>
<a href="#l10.774"></a><span id="l10.774" class="difflineminus">-                                    authPrompter.SAVE_PASSWORD_PERMANENTLY,</span>
<a href="#l10.775"></a><span id="l10.775" class="difflineminus">-                                    password))</span>
<a href="#l10.776"></a><span id="l10.776" class="difflineminus">-      return password.value;</span>
<a href="#l10.777"></a><span id="l10.777" class="difflineminus">-</span>
<a href="#l10.778"></a><span id="l10.778" class="difflineminus">-    return &quot;&quot;;</span>
<a href="#l10.779"></a><span id="l10.779" class="difflineminus">-  },</span>
<a href="#l10.780"></a><span id="l10.780" class="difflineminus">-</span>
<a href="#l10.781"></a><span id="l10.781" class="difflineminus">-  /**</span>
<a href="#l10.782"></a><span id="l10.782" class="difflineminus">-   * Clears any saved Hightail passwords for this instance's account.</span>
<a href="#l10.783"></a><span id="l10.783" class="difflineminus">-   */</span>
<a href="#l10.784"></a><span id="l10.784" class="difflineminus">-  clearPassword() {</span>
<a href="#l10.785"></a><span id="l10.785" class="difflineminus">-    let logins = Services.logins.findLogins({}, gServerUrl, null, gServerUrl);</span>
<a href="#l10.786"></a><span id="l10.786" class="difflineminus">-    for (let loginInfo of logins)</span>
<a href="#l10.787"></a><span id="l10.787" class="difflineminus">-      if (loginInfo.username == this._userName)</span>
<a href="#l10.788"></a><span id="l10.788" class="difflineminus">-        Services.logins.removeLogin(loginInfo);</span>
<a href="#l10.789"></a><span id="l10.789" class="difflineminus">-  },</span>
<a href="#l10.790"></a><span id="l10.790" class="difflineminus">-</span>
<a href="#l10.791"></a><span id="l10.791" class="difflineminus">-  /**</span>
<a href="#l10.792"></a><span id="l10.792" class="difflineminus">-   * Attempt to log on and get the auth token for this Hightail account.</span>
<a href="#l10.793"></a><span id="l10.793" class="difflineminus">-   *</span>
<a href="#l10.794"></a><span id="l10.794" class="difflineminus">-   * @param successCallback the callback to be fired if logging on is successful</span>
<a href="#l10.795"></a><span id="l10.795" class="difflineminus">-   * @param failureCallback the callback to be fired if loggong on fails</span>
<a href="#l10.796"></a><span id="l10.796" class="difflineminus">-   * @aparam aWithUI a boolean for whether or not we should prompt for a password</span>
<a href="#l10.797"></a><span id="l10.797" class="difflineminus">-   *                 if no auth token is currently stored.</span>
<a href="#l10.798"></a><span id="l10.798" class="difflineminus">-   */</span>
<a href="#l10.799"></a><span id="l10.799" class="difflineminus">-  logon(successCallback, failureCallback, aWithUI) {</span>
<a href="#l10.800"></a><span id="l10.800" class="difflineminus">-    this.log.info(&quot;Logging in, aWithUI = &quot; + aWithUI);</span>
<a href="#l10.801"></a><span id="l10.801" class="difflineminus">-    if (this._password == undefined || !this._password)</span>
<a href="#l10.802"></a><span id="l10.802" class="difflineminus">-      this._password = this.getPassword(this._userName, !aWithUI);</span>
<a href="#l10.803"></a><span id="l10.803" class="difflineminus">-    let args = &quot;?email=&quot; + this._userName + &quot;&amp;password=&quot; + this._password + &quot;&amp;&quot;;</span>
<a href="#l10.804"></a><span id="l10.804" class="difflineminus">-    this.log.info(&quot;Sending login information...&quot;);</span>
<a href="#l10.805"></a><span id="l10.805" class="difflineminus">-    let req = new XMLHttpRequest();</span>
<a href="#l10.806"></a><span id="l10.806" class="difflineminus">-    let curDate = Date.now().toString();</span>
<a href="#l10.807"></a><span id="l10.807" class="difflineminus">-</span>
<a href="#l10.808"></a><span id="l10.808" class="difflineminus">-    req.open(&quot;POST&quot;, gServerUrl + kAuthPath + args + kUrlTail, true);</span>
<a href="#l10.809"></a><span id="l10.809" class="difflineminus">-    req.onerror = function() {</span>
<a href="#l10.810"></a><span id="l10.810" class="difflineminus">-      this.log.info(&quot;logon failure&quot;);</span>
<a href="#l10.811"></a><span id="l10.811" class="difflineminus">-      failureCallback();</span>
<a href="#l10.812"></a><span id="l10.812" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.813"></a><span id="l10.813" class="difflineminus">-</span>
<a href="#l10.814"></a><span id="l10.814" class="difflineminus">-    req.onload = function() {</span>
<a href="#l10.815"></a><span id="l10.815" class="difflineminus">-      if (req.status &gt;= 200 &amp;&amp; req.status &lt; 400) {</span>
<a href="#l10.816"></a><span id="l10.816" class="difflineminus">-        this.log.info(&quot;auth token response = &quot; + req.responseText);</span>
<a href="#l10.817"></a><span id="l10.817" class="difflineminus">-        let docResponse = JSON.parse(req.responseText);</span>
<a href="#l10.818"></a><span id="l10.818" class="difflineminus">-        this.log.info(&quot;login response parsed = &quot; + docResponse);</span>
<a href="#l10.819"></a><span id="l10.819" class="difflineminus">-        this._cachedAuthToken = docResponse.authToken;</span>
<a href="#l10.820"></a><span id="l10.820" class="difflineminus">-        this.log.info(&quot;authToken = &quot; + this._cachedAuthToken);</span>
<a href="#l10.821"></a><span id="l10.821" class="difflineminus">-        if (this._cachedAuthToken) {</span>
<a href="#l10.822"></a><span id="l10.822" class="difflineminus">-          this._loggedIn = true;</span>
<a href="#l10.823"></a><span id="l10.823" class="difflineminus">-          successCallback();</span>
<a href="#l10.824"></a><span id="l10.824" class="difflineminus">-        } else {</span>
<a href="#l10.825"></a><span id="l10.825" class="difflineminus">-          this.clearPassword();</span>
<a href="#l10.826"></a><span id="l10.826" class="difflineminus">-          this._loggedIn = false;</span>
<a href="#l10.827"></a><span id="l10.827" class="difflineminus">-          this._lastErrorText = docResponse.errorStatus.message;</span>
<a href="#l10.828"></a><span id="l10.828" class="difflineminus">-          this._lastErrorStatus = docResponse.errorStatus.code;</span>
<a href="#l10.829"></a><span id="l10.829" class="difflineminus">-          failureCallback();</span>
<a href="#l10.830"></a><span id="l10.830" class="difflineminus">-        }</span>
<a href="#l10.831"></a><span id="l10.831" class="difflineminus">-      } else {</span>
<a href="#l10.832"></a><span id="l10.832" class="difflineminus">-        this.clearPassword();</span>
<a href="#l10.833"></a><span id="l10.833" class="difflineminus">-        failureCallback();</span>
<a href="#l10.834"></a><span id="l10.834" class="difflineminus">-      }</span>
<a href="#l10.835"></a><span id="l10.835" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.836"></a><span id="l10.836" class="difflineminus">-    req.setRequestHeader(&quot;X-Api-Key&quot;, kApiKey);</span>
<a href="#l10.837"></a><span id="l10.837" class="difflineminus">-    req.setRequestHeader(&quot;Date&quot;, curDate);</span>
<a href="#l10.838"></a><span id="l10.838" class="difflineminus">-    req.setRequestHeader(&quot;Accept&quot;, &quot;application/json&quot;);</span>
<a href="#l10.839"></a><span id="l10.839" class="difflineminus">-    req.send();</span>
<a href="#l10.840"></a><span id="l10.840" class="difflineminus">-    this.log.info(&quot;Login information sent!&quot;);</span>
<a href="#l10.841"></a><span id="l10.841" class="difflineminus">-  },</span>
<a href="#l10.842"></a><span id="l10.842" class="difflineminus">-</span>
<a href="#l10.843"></a><span id="l10.843" class="difflineminus">-  get _cachedAuthToken() {</span>
<a href="#l10.844"></a><span id="l10.844" class="difflineminus">-    let authToken = cloudFileAccounts.getSecretValue(this.accountKey,</span>
<a href="#l10.845"></a><span id="l10.845" class="difflineminus">-                                                     cloudFileAccounts.kTokenRealm);</span>
<a href="#l10.846"></a><span id="l10.846" class="difflineminus">-</span>
<a href="#l10.847"></a><span id="l10.847" class="difflineminus">-    if (!authToken)</span>
<a href="#l10.848"></a><span id="l10.848" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l10.849"></a><span id="l10.849" class="difflineminus">-</span>
<a href="#l10.850"></a><span id="l10.850" class="difflineminus">-    return authToken;</span>
<a href="#l10.851"></a><span id="l10.851" class="difflineminus">-  },</span>
<a href="#l10.852"></a><span id="l10.852" class="difflineminus">-</span>
<a href="#l10.853"></a><span id="l10.853" class="difflineminus">-  set _cachedAuthToken(aVal) {</span>
<a href="#l10.854"></a><span id="l10.854" class="difflineminus">-    if (!aVal)</span>
<a href="#l10.855"></a><span id="l10.855" class="difflineminus">-      aVal = &quot;&quot;;</span>
<a href="#l10.856"></a><span id="l10.856" class="difflineminus">-</span>
<a href="#l10.857"></a><span id="l10.857" class="difflineminus">-    cloudFileAccounts.setSecretValue(this.accountKey,</span>
<a href="#l10.858"></a><span id="l10.858" class="difflineminus">-                                     cloudFileAccounts.kTokenRealm,</span>
<a href="#l10.859"></a><span id="l10.859" class="difflineminus">-                                     aVal);</span>
<a href="#l10.860"></a><span id="l10.860" class="difflineminus">-  },</span>
<a href="#l10.861"></a><span id="l10.861" class="difflineminus">-};</span>
<a href="#l10.862"></a><span id="l10.862" class="difflineminus">-</span>
<a href="#l10.863"></a><span id="l10.863" class="difflineminus">-function nsHightailFileUploader(aHightail, aFile, aCallback, aRequestObserver) {</span>
<a href="#l10.864"></a><span id="l10.864" class="difflineminus">-  this.hightail = aHightail;</span>
<a href="#l10.865"></a><span id="l10.865" class="difflineminus">-  this.log = this.hightail.log;</span>
<a href="#l10.866"></a><span id="l10.866" class="difflineminus">-  this.log.info(&quot;new nsHightailFileUploader file = &quot; + aFile.leafName);</span>
<a href="#l10.867"></a><span id="l10.867" class="difflineminus">-  this.file = aFile;</span>
<a href="#l10.868"></a><span id="l10.868" class="difflineminus">-  this.callback = aCallback;</span>
<a href="#l10.869"></a><span id="l10.869" class="difflineminus">-  this.requestObserver = aRequestObserver;</span>
<a href="#l10.870"></a><span id="l10.870" class="difflineminus">-}</span>
<a href="#l10.871"></a><span id="l10.871" class="difflineminus">-</span>
<a href="#l10.872"></a><span id="l10.872" class="difflineminus">-nsHightailFileUploader.prototype = {</span>
<a href="#l10.873"></a><span id="l10.873" class="difflineminus">-  hightail: null,</span>
<a href="#l10.874"></a><span id="l10.874" class="difflineminus">-  file: null,</span>
<a href="#l10.875"></a><span id="l10.875" class="difflineminus">-  callback: null,</span>
<a href="#l10.876"></a><span id="l10.876" class="difflineminus">-  _request: null,</span>
<a href="#l10.877"></a><span id="l10.877" class="difflineminus">-</span>
<a href="#l10.878"></a><span id="l10.878" class="difflineminus">-  /**</span>
<a href="#l10.879"></a><span id="l10.879" class="difflineminus">-   * Kicks off the upload procedure for this uploader.</span>
<a href="#l10.880"></a><span id="l10.880" class="difflineminus">-   */</span>
<a href="#l10.881"></a><span id="l10.881" class="difflineminus">-  startUpload() {</span>
<a href="#l10.882"></a><span id="l10.882" class="difflineminus">-    this.requestObserver.onStartRequest(null);</span>
<a href="#l10.883"></a><span id="l10.883" class="difflineminus">-</span>
<a href="#l10.884"></a><span id="l10.884" class="difflineminus">-    let onSuccess = function() {</span>
<a href="#l10.885"></a><span id="l10.885" class="difflineminus">-      this._uploadFile();</span>
<a href="#l10.886"></a><span id="l10.886" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.887"></a><span id="l10.887" class="difflineminus">-</span>
<a href="#l10.888"></a><span id="l10.888" class="difflineminus">-    let onFailure = function() {</span>
<a href="#l10.889"></a><span id="l10.889" class="difflineminus">-      this.callback(this.requestObserver, cloudFileAccounts.constants.uploadErr);</span>
<a href="#l10.890"></a><span id="l10.890" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.891"></a><span id="l10.891" class="difflineminus">-</span>
<a href="#l10.892"></a><span id="l10.892" class="difflineminus">-    return this._prepareToSend(onSuccess, onFailure);</span>
<a href="#l10.893"></a><span id="l10.893" class="difflineminus">-  },</span>
<a href="#l10.894"></a><span id="l10.894" class="difflineminus">-</span>
<a href="#l10.895"></a><span id="l10.895" class="difflineminus">-  /**</span>
<a href="#l10.896"></a><span id="l10.896" class="difflineminus">-   * Communicates with Hightail to get the URL that we will send the upload</span>
<a href="#l10.897"></a><span id="l10.897" class="difflineminus">-   * request to.</span>
<a href="#l10.898"></a><span id="l10.898" class="difflineminus">-   *</span>
<a href="#l10.899"></a><span id="l10.899" class="difflineminus">-   * @param successCallback the callback fired if getting the URL is successful</span>
<a href="#l10.900"></a><span id="l10.900" class="difflineminus">-   * @param failureCallback the callback fired if getting the URL fails</span>
<a href="#l10.901"></a><span id="l10.901" class="difflineminus">-   */</span>
<a href="#l10.902"></a><span id="l10.902" class="difflineminus">-  _prepareToSend(successCallback, failureCallback) {</span>
<a href="#l10.903"></a><span id="l10.903" class="difflineminus">-    let req = new XMLHttpRequest();</span>
<a href="#l10.904"></a><span id="l10.904" class="difflineminus">-</span>
<a href="#l10.905"></a><span id="l10.905" class="difflineminus">-    req.open(&quot;POST&quot;, gServerUrl + kFolderInitUploadPath + &quot;?&quot; + kUrlTail, true);</span>
<a href="#l10.906"></a><span id="l10.906" class="difflineminus">-</span>
<a href="#l10.907"></a><span id="l10.907" class="difflineminus">-    req.onerror = failureCallback;</span>
<a href="#l10.908"></a><span id="l10.908" class="difflineminus">-</span>
<a href="#l10.909"></a><span id="l10.909" class="difflineminus">-    req.onload = function() {</span>
<a href="#l10.910"></a><span id="l10.910" class="difflineminus">-      let response = req.responseText;</span>
<a href="#l10.911"></a><span id="l10.911" class="difflineminus">-      if (req.status &gt;= 200 &amp;&amp; req.status &lt; 400) {</span>
<a href="#l10.912"></a><span id="l10.912" class="difflineminus">-        this._urlInfo = JSON.parse(response);</span>
<a href="#l10.913"></a><span id="l10.913" class="difflineminus">-        this.hightail._uploadInfo[this.file.path] = this._urlInfo;</span>
<a href="#l10.914"></a><span id="l10.914" class="difflineminus">-        this.log.info(&quot;in prepare to send response = &quot; + response);</span>
<a href="#l10.915"></a><span id="l10.915" class="difflineminus">-        this.log.info(&quot;file id = &quot; + this._urlInfo.fileId);</span>
<a href="#l10.916"></a><span id="l10.916" class="difflineminus">-        this.log.info(&quot;upload url = &quot; + this._urlInfo.uploadUrl[0]);</span>
<a href="#l10.917"></a><span id="l10.917" class="difflineminus">-        successCallback();</span>
<a href="#l10.918"></a><span id="l10.918" class="difflineminus">-      } else {</span>
<a href="#l10.919"></a><span id="l10.919" class="difflineminus">-        this.log.error(&quot;Preparing to send failed!&quot;);</span>
<a href="#l10.920"></a><span id="l10.920" class="difflineminus">-        this.log.error(&quot;Response was: &quot; + response);</span>
<a href="#l10.921"></a><span id="l10.921" class="difflineminus">-        this.hightail._lastErrorText = req.responseText;</span>
<a href="#l10.922"></a><span id="l10.922" class="difflineminus">-        this.hightail._lastErrorStatus = req.status;</span>
<a href="#l10.923"></a><span id="l10.923" class="difflineminus">-        failureCallback();</span>
<a href="#l10.924"></a><span id="l10.924" class="difflineminus">-      }</span>
<a href="#l10.925"></a><span id="l10.925" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.926"></a><span id="l10.926" class="difflineminus">-</span>
<a href="#l10.927"></a><span id="l10.927" class="difflineminus">-    // Add a space at the end because http logging looks for two</span>
<a href="#l10.928"></a><span id="l10.928" class="difflineminus">-    // spaces in the X-Auth-Token header to avoid putting passwords</span>
<a href="#l10.929"></a><span id="l10.929" class="difflineminus">-    // in the log, and crashes if there aren't two spaces.</span>
<a href="#l10.930"></a><span id="l10.930" class="difflineminus">-    req.setRequestHeader(&quot;X-Auth-Token&quot;, this.hightail._cachedAuthToken + &quot; &quot;);</span>
<a href="#l10.931"></a><span id="l10.931" class="difflineminus">-    req.setRequestHeader(&quot;X-Api-Key&quot;, kApiKey);</span>
<a href="#l10.932"></a><span id="l10.932" class="difflineminus">-    req.setRequestHeader(&quot;Accept&quot;, &quot;application/json&quot;);</span>
<a href="#l10.933"></a><span id="l10.933" class="difflineminus">-    req.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);</span>
<a href="#l10.934"></a><span id="l10.934" class="difflineminus">-    req.send();</span>
<a href="#l10.935"></a><span id="l10.935" class="difflineminus">-  },</span>
<a href="#l10.936"></a><span id="l10.936" class="difflineminus">-</span>
<a href="#l10.937"></a><span id="l10.937" class="difflineminus">-  /**</span>
<a href="#l10.938"></a><span id="l10.938" class="difflineminus">-   * Once we've got the URL to upload the file to, this function actually does</span>
<a href="#l10.939"></a><span id="l10.939" class="difflineminus">-   * the upload of the file to Hightail.</span>
<a href="#l10.940"></a><span id="l10.940" class="difflineminus">-   */</span>
<a href="#l10.941"></a><span id="l10.941" class="difflineminus">-  _uploadFile() {</span>
<a href="#l10.942"></a><span id="l10.942" class="difflineminus">-    let req = new XMLHttpRequest();</span>
<a href="#l10.943"></a><span id="l10.943" class="difflineminus">-</span>
<a href="#l10.944"></a><span id="l10.944" class="difflineminus">-    let curDate = Date.now().toString();</span>
<a href="#l10.945"></a><span id="l10.945" class="difflineminus">-    this.log.info(&quot;upload url = &quot; + this._urlInfo.uploadUrl[0]);</span>
<a href="#l10.946"></a><span id="l10.946" class="difflineminus">-    this.request = req;</span>
<a href="#l10.947"></a><span id="l10.947" class="difflineminus">-    req.open(&quot;POST&quot;, this._urlInfo.uploadUrl[0] + &quot;?&quot; + kUrlTail, true);</span>
<a href="#l10.948"></a><span id="l10.948" class="difflineminus">-    req.onload = function() {</span>
<a href="#l10.949"></a><span id="l10.949" class="difflineminus">-      this.cleanupTempFile();</span>
<a href="#l10.950"></a><span id="l10.950" class="difflineminus">-      if (req.status &gt;= 200 &amp;&amp; req.status &lt; 400) {</span>
<a href="#l10.951"></a><span id="l10.951" class="difflineminus">-        try {</span>
<a href="#l10.952"></a><span id="l10.952" class="difflineminus">-          this.log.info(&quot;upload response = &quot; + req.responseText);</span>
<a href="#l10.953"></a><span id="l10.953" class="difflineminus">-          this._commitSend();</span>
<a href="#l10.954"></a><span id="l10.954" class="difflineminus">-        } catch (ex) {</span>
<a href="#l10.955"></a><span id="l10.955" class="difflineminus">-          this.log.error(ex);</span>
<a href="#l10.956"></a><span id="l10.956" class="difflineminus">-        }</span>
<a href="#l10.957"></a><span id="l10.957" class="difflineminus">-      } else {</span>
<a href="#l10.958"></a><span id="l10.958" class="difflineminus">-        this.callback(this.requestObserver,</span>
<a href="#l10.959"></a><span id="l10.959" class="difflineminus">-                      cloudFileAccounts.constants.uploadErr);</span>
<a href="#l10.960"></a><span id="l10.960" class="difflineminus">-      }</span>
<a href="#l10.961"></a><span id="l10.961" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.962"></a><span id="l10.962" class="difflineminus">-</span>
<a href="#l10.963"></a><span id="l10.963" class="difflineminus">-    req.onerror = function() {</span>
<a href="#l10.964"></a><span id="l10.964" class="difflineminus">-      this.cleanupTempFile();</span>
<a href="#l10.965"></a><span id="l10.965" class="difflineminus">-      if (this.callback)</span>
<a href="#l10.966"></a><span id="l10.966" class="difflineminus">-        this.callback(this.requestObserver,</span>
<a href="#l10.967"></a><span id="l10.967" class="difflineminus">-                      cloudFileAccounts.constants.uploadErr);</span>
<a href="#l10.968"></a><span id="l10.968" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.969"></a><span id="l10.969" class="difflineminus">-</span>
<a href="#l10.970"></a><span id="l10.970" class="difflineminus">-    req.setRequestHeader(&quot;Date&quot;, curDate);</span>
<a href="#l10.971"></a><span id="l10.971" class="difflineminus">-    let boundary = &quot;------&quot; + curDate;</span>
<a href="#l10.972"></a><span id="l10.972" class="difflineminus">-    let contentType = &quot;multipart/form-data; boundary=&quot; + boundary;</span>
<a href="#l10.973"></a><span id="l10.973" class="difflineminus">-    req.setRequestHeader(&quot;Content-Type&quot;, contentType);</span>
<a href="#l10.974"></a><span id="l10.974" class="difflineminus">-</span>
<a href="#l10.975"></a><span id="l10.975" class="difflineminus">-    let fileContents = &quot;--&quot; + boundary +</span>
<a href="#l10.976"></a><span id="l10.976" class="difflineminus">-      &quot;\r\nContent-Disposition: form-data; name=\&quot;bid\&quot;\r\n\r\n&quot; +</span>
<a href="#l10.977"></a><span id="l10.977" class="difflineminus">-       this._urlInfo.fileId;</span>
<a href="#l10.978"></a><span id="l10.978" class="difflineminus">-</span>
<a href="#l10.979"></a><span id="l10.979" class="difflineminus">-    let fileName = /^[\040-\176]+$/.test(this.file.leafName)</span>
<a href="#l10.980"></a><span id="l10.980" class="difflineminus">-        ? this.file.leafName</span>
<a href="#l10.981"></a><span id="l10.981" class="difflineminus">-        : encodeURIComponent(this.file.leafName);</span>
<a href="#l10.982"></a><span id="l10.982" class="difflineminus">-</span>
<a href="#l10.983"></a><span id="l10.983" class="difflineminus">-    fileContents += &quot;\r\n--&quot; + boundary +</span>
<a href="#l10.984"></a><span id="l10.984" class="difflineminus">-      &quot;\r\nContent-Disposition: form-data; name=\&quot;fname\&quot;; filename=\&quot;&quot; +</span>
<a href="#l10.985"></a><span id="l10.985" class="difflineminus">-      fileName + &quot;\&quot;\r\nContent-Type: application/octet-stream&quot; +</span>
<a href="#l10.986"></a><span id="l10.986" class="difflineminus">-      &quot;\r\n\r\n&quot;;</span>
<a href="#l10.987"></a><span id="l10.987" class="difflineminus">-</span>
<a href="#l10.988"></a><span id="l10.988" class="difflineminus">-    // Since js doesn't like binary data in strings, we're going to create</span>
<a href="#l10.989"></a><span id="l10.989" class="difflineminus">-    // a temp file consisting of the message preamble, the file contents, and</span>
<a href="#l10.990"></a><span id="l10.990" class="difflineminus">-    // the post script, and pass a stream based on that file to</span>
<a href="#l10.991"></a><span id="l10.991" class="difflineminus">-    // XMLHttpRequest.send().</span>
<a href="#l10.992"></a><span id="l10.992" class="difflineminus">-</span>
<a href="#l10.993"></a><span id="l10.993" class="difflineminus">-    try {</span>
<a href="#l10.994"></a><span id="l10.994" class="difflineminus">-      this._tempFile = this.getTempFile(this.file.leafName);</span>
<a href="#l10.995"></a><span id="l10.995" class="difflineminus">-      let ostream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l10.996"></a><span id="l10.996" class="difflineminus">-                     .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l10.997"></a><span id="l10.997" class="difflineminus">-      ostream.init(this._tempFile, -1, -1, 0);</span>
<a href="#l10.998"></a><span id="l10.998" class="difflineminus">-      ostream.write(fileContents, fileContents.length);</span>
<a href="#l10.999"></a><span id="l10.999" class="difflineminus">-</span>
<a href="#l10.1000"></a><span id="l10.1000" class="difflineminus">-      this._fstream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l10.1001"></a><span id="l10.1001" class="difflineminus">-                       .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l10.1002"></a><span id="l10.1002" class="difflineminus">-      let sstream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l10.1003"></a><span id="l10.1003" class="difflineminus">-                       .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l10.1004"></a><span id="l10.1004" class="difflineminus">-      this._fstream.init(this.file, -1, 0, 0);</span>
<a href="#l10.1005"></a><span id="l10.1005" class="difflineminus">-      sstream.init(this._fstream);</span>
<a href="#l10.1006"></a><span id="l10.1006" class="difflineminus">-</span>
<a href="#l10.1007"></a><span id="l10.1007" class="difflineminus">-      // This blocks the UI which is less than ideal. But it's a local</span>
<a href="#l10.1008"></a><span id="l10.1008" class="difflineminus">-      // file operations so probably not the end of the world.</span>
<a href="#l10.1009"></a><span id="l10.1009" class="difflineminus">-      while (sstream.available() &gt; 0) {</span>
<a href="#l10.1010"></a><span id="l10.1010" class="difflineminus">-        let bytes = sstream.readBytes(sstream.available());</span>
<a href="#l10.1011"></a><span id="l10.1011" class="difflineminus">-        ostream.write(bytes, bytes.length);</span>
<a href="#l10.1012"></a><span id="l10.1012" class="difflineminus">-      }</span>
<a href="#l10.1013"></a><span id="l10.1013" class="difflineminus">-</span>
<a href="#l10.1014"></a><span id="l10.1014" class="difflineminus">-      fileContents = &quot;\r\n--&quot; + boundary + &quot;--\r\n&quot;;</span>
<a href="#l10.1015"></a><span id="l10.1015" class="difflineminus">-      ostream.write(fileContents, fileContents.length);</span>
<a href="#l10.1016"></a><span id="l10.1016" class="difflineminus">-</span>
<a href="#l10.1017"></a><span id="l10.1017" class="difflineminus">-      ostream.close();</span>
<a href="#l10.1018"></a><span id="l10.1018" class="difflineminus">-      this._fstream.close();</span>
<a href="#l10.1019"></a><span id="l10.1019" class="difflineminus">-      sstream.close();</span>
<a href="#l10.1020"></a><span id="l10.1020" class="difflineminus">-</span>
<a href="#l10.1021"></a><span id="l10.1021" class="difflineminus">-      // defeat fstat caching</span>
<a href="#l10.1022"></a><span id="l10.1022" class="difflineminus">-      this._tempFile = this._tempFile.clone();</span>
<a href="#l10.1023"></a><span id="l10.1023" class="difflineminus">-      this._fstream.init(this._tempFile, -1, 0, 0);</span>
<a href="#l10.1024"></a><span id="l10.1024" class="difflineminus">-      this._fstream.close();</span>
<a href="#l10.1025"></a><span id="l10.1025" class="difflineminus">-      // I don't trust re-using the old fstream.</span>
<a href="#l10.1026"></a><span id="l10.1026" class="difflineminus">-      this._fstream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l10.1027"></a><span id="l10.1027" class="difflineminus">-                     .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l10.1028"></a><span id="l10.1028" class="difflineminus">-      this._fstream.init(this._tempFile, -1, 0, 0);</span>
<a href="#l10.1029"></a><span id="l10.1029" class="difflineminus">-      this._bufStream = Cc[&quot;@mozilla.org/network/buffered-input-stream;1&quot;]</span>
<a href="#l10.1030"></a><span id="l10.1030" class="difflineminus">-                        .createInstance(Ci.nsIBufferedInputStream);</span>
<a href="#l10.1031"></a><span id="l10.1031" class="difflineminus">-      this._bufStream.init(this._fstream, 4096);</span>
<a href="#l10.1032"></a><span id="l10.1032" class="difflineminus">-      // XMLHttpRequest's nsIVariant handling requires that we QI</span>
<a href="#l10.1033"></a><span id="l10.1033" class="difflineminus">-      // to nsIInputStream.</span>
<a href="#l10.1034"></a><span id="l10.1034" class="difflineminus">-      req.sendInputStream(this._bufStream.QueryInterface(Ci.nsIInputStream));</span>
<a href="#l10.1035"></a><span id="l10.1035" class="difflineminus">-    } catch (ex) {</span>
<a href="#l10.1036"></a><span id="l10.1036" class="difflineminus">-      this.cleanupTempFile();</span>
<a href="#l10.1037"></a><span id="l10.1037" class="difflineminus">-      this.log.error(ex);</span>
<a href="#l10.1038"></a><span id="l10.1038" class="difflineminus">-      throw ex;</span>
<a href="#l10.1039"></a><span id="l10.1039" class="difflineminus">-    }</span>
<a href="#l10.1040"></a><span id="l10.1040" class="difflineminus">-  },</span>
<a href="#l10.1041"></a><span id="l10.1041" class="difflineminus">-</span>
<a href="#l10.1042"></a><span id="l10.1042" class="difflineminus">-  /**</span>
<a href="#l10.1043"></a><span id="l10.1043" class="difflineminus">-   * Cancels the upload request for the file associated with this Uploader.</span>
<a href="#l10.1044"></a><span id="l10.1044" class="difflineminus">-   */</span>
<a href="#l10.1045"></a><span id="l10.1045" class="difflineminus">-  cancel() {</span>
<a href="#l10.1046"></a><span id="l10.1046" class="difflineminus">-    this.log.info(&quot;in uploader cancel&quot;);</span>
<a href="#l10.1047"></a><span id="l10.1047" class="difflineminus">-    this.callback(this.requestObserver, cloudFileAccounts.constants.uploadCancelled);</span>
<a href="#l10.1048"></a><span id="l10.1048" class="difflineminus">-    delete this.callback;</span>
<a href="#l10.1049"></a><span id="l10.1049" class="difflineminus">-    if (this.request) {</span>
<a href="#l10.1050"></a><span id="l10.1050" class="difflineminus">-      this.log.info(&quot;cancelling upload request&quot;);</span>
<a href="#l10.1051"></a><span id="l10.1051" class="difflineminus">-      let req = this.request;</span>
<a href="#l10.1052"></a><span id="l10.1052" class="difflineminus">-      if (req.channel) {</span>
<a href="#l10.1053"></a><span id="l10.1053" class="difflineminus">-        this.log.info(&quot;cancelling upload channel&quot;);</span>
<a href="#l10.1054"></a><span id="l10.1054" class="difflineminus">-        req.channel.cancel(Cr.NS_BINDING_ABORTED);</span>
<a href="#l10.1055"></a><span id="l10.1055" class="difflineminus">-      }</span>
<a href="#l10.1056"></a><span id="l10.1056" class="difflineminus">-      this.request = null;</span>
<a href="#l10.1057"></a><span id="l10.1057" class="difflineminus">-    }</span>
<a href="#l10.1058"></a><span id="l10.1058" class="difflineminus">-  },</span>
<a href="#l10.1059"></a><span id="l10.1059" class="difflineminus">-  /**</span>
<a href="#l10.1060"></a><span id="l10.1060" class="difflineminus">-   * Once the file is uploaded, if we want to get a sharing URL back, we have</span>
<a href="#l10.1061"></a><span id="l10.1061" class="difflineminus">-   * to send a &quot;commit&quot; request - which this function does.</span>
<a href="#l10.1062"></a><span id="l10.1062" class="difflineminus">-   */</span>
<a href="#l10.1063"></a><span id="l10.1063" class="difflineminus">-  _commitSend() {</span>
<a href="#l10.1064"></a><span id="l10.1064" class="difflineminus">-    this.log.info(&quot;commit sending file &quot; + this._urlInfo.fileId);</span>
<a href="#l10.1065"></a><span id="l10.1065" class="difflineminus">-    let req = new XMLHttpRequest();</span>
<a href="#l10.1066"></a><span id="l10.1066" class="difflineminus">-    let args = &quot;?name=&quot; + this.file.leafName +</span>
<a href="#l10.1067"></a><span id="l10.1067" class="difflineminus">-               &quot;&amp;fileId=&quot; + this._urlInfo.fileId +</span>
<a href="#l10.1068"></a><span id="l10.1068" class="difflineminus">-               &quot;&amp;parentId=&quot; + this.hightail._folderId + &quot;&amp;&quot;;</span>
<a href="#l10.1069"></a><span id="l10.1069" class="difflineminus">-</span>
<a href="#l10.1070"></a><span id="l10.1070" class="difflineminus">-    req.open(&quot;POST&quot;, gServerUrl + kFolderCommitUploadPath + args + kUrlTail, true);</span>
<a href="#l10.1071"></a><span id="l10.1071" class="difflineminus">-</span>
<a href="#l10.1072"></a><span id="l10.1072" class="difflineminus">-    req.onerror = function() {</span>
<a href="#l10.1073"></a><span id="l10.1073" class="difflineminus">-      this.log.info(&quot;error in commit send&quot;);</span>
<a href="#l10.1074"></a><span id="l10.1074" class="difflineminus">-      this.callback(this.requestObserver,</span>
<a href="#l10.1075"></a><span id="l10.1075" class="difflineminus">-                    cloudFileAccounts.constants.uploadErr);</span>
<a href="#l10.1076"></a><span id="l10.1076" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.1077"></a><span id="l10.1077" class="difflineminus">-</span>
<a href="#l10.1078"></a><span id="l10.1078" class="difflineminus">-    req.onload = function() {</span>
<a href="#l10.1079"></a><span id="l10.1079" class="difflineminus">-      // Response is the URL.</span>
<a href="#l10.1080"></a><span id="l10.1080" class="difflineminus">-      let response = req.responseText;</span>
<a href="#l10.1081"></a><span id="l10.1081" class="difflineminus">-      this.log.info(&quot;commit response = &quot; + response);</span>
<a href="#l10.1082"></a><span id="l10.1082" class="difflineminus">-      let uploadInfo = JSON.parse(response);</span>
<a href="#l10.1083"></a><span id="l10.1083" class="difflineminus">-</span>
<a href="#l10.1084"></a><span id="l10.1084" class="difflineminus">-      let succeed = function() {</span>
<a href="#l10.1085"></a><span id="l10.1085" class="difflineminus">-        this.callback(this.requestObserver, Cr.NS_OK);</span>
<a href="#l10.1086"></a><span id="l10.1086" class="difflineminus">-      }.bind(this);</span>
<a href="#l10.1087"></a><span id="l10.1087" class="difflineminus">-</span>
<a href="#l10.1088"></a><span id="l10.1088" class="difflineminus">-      let failed = function() {</span>
<a href="#l10.1089"></a><span id="l10.1089" class="difflineminus">-        this.callback(this.requestObserver, this.file.leafName.length &gt; 120</span>
<a href="#l10.1090"></a><span id="l10.1090" class="difflineminus">-                      ? cloudFileAccounts.constants.uploadExceedsFileNameLimit</span>
<a href="#l10.1091"></a><span id="l10.1091" class="difflineminus">-                      : cloudFileAccounts.constants.uploadErr);</span>
<a href="#l10.1092"></a><span id="l10.1092" class="difflineminus">-      }.bind(this);</span>
<a href="#l10.1093"></a><span id="l10.1093" class="difflineminus">-</span>
<a href="#l10.1094"></a><span id="l10.1094" class="difflineminus">-      if (uploadInfo.errorStatus) {</span>
<a href="#l10.1095"></a><span id="l10.1095" class="difflineminus">-        this.hightail._lastErrorText = uploadInfo.errorStatus.message;</span>
<a href="#l10.1096"></a><span id="l10.1096" class="difflineminus">-        this.hightail._lastErrorStatus = uploadInfo.errorStatus.code;</span>
<a href="#l10.1097"></a><span id="l10.1097" class="difflineminus">-        failed();</span>
<a href="#l10.1098"></a><span id="l10.1098" class="difflineminus">-      } else if (uploadInfo.clickableDownloadUrl) {</span>
<a href="#l10.1099"></a><span id="l10.1099" class="difflineminus">-        // We need a kludge here because Hightail is returning URLs without the scheme...</span>
<a href="#l10.1100"></a><span id="l10.1100" class="difflineminus">-        let url = this._ensureScheme(uploadInfo.clickableDownloadUrl);</span>
<a href="#l10.1101"></a><span id="l10.1101" class="difflineminus">-        this.hightail._urlsForFiles[this.file.path] = url;</span>
<a href="#l10.1102"></a><span id="l10.1102" class="difflineminus">-        succeed();</span>
<a href="#l10.1103"></a><span id="l10.1103" class="difflineminus">-      } else {</span>
<a href="#l10.1104"></a><span id="l10.1104" class="difflineminus">-        this._findDownloadUrl(uploadInfo.id, succeed, failed);</span>
<a href="#l10.1105"></a><span id="l10.1105" class="difflineminus">-      }</span>
<a href="#l10.1106"></a><span id="l10.1106" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.1107"></a><span id="l10.1107" class="difflineminus">-</span>
<a href="#l10.1108"></a><span id="l10.1108" class="difflineminus">-    req.setRequestHeader(&quot;X-Auth-Token&quot;, this.hightail._cachedAuthToken + &quot; &quot;);</span>
<a href="#l10.1109"></a><span id="l10.1109" class="difflineminus">-    req.setRequestHeader(&quot;X-Api-Key&quot;, kApiKey);</span>
<a href="#l10.1110"></a><span id="l10.1110" class="difflineminus">-    req.setRequestHeader(&quot;Accept&quot;, &quot;application/json&quot;);</span>
<a href="#l10.1111"></a><span id="l10.1111" class="difflineminus">-    req.send();</span>
<a href="#l10.1112"></a><span id="l10.1112" class="difflineminus">-  },</span>
<a href="#l10.1113"></a><span id="l10.1113" class="difflineminus">-</span>
<a href="#l10.1114"></a><span id="l10.1114" class="difflineminus">-  /**</span>
<a href="#l10.1115"></a><span id="l10.1115" class="difflineminus">-   * If there's no scheme prefix for a URL, attaches an https:// prefix</span>
<a href="#l10.1116"></a><span id="l10.1116" class="difflineminus">-   * and returns the new result.</span>
<a href="#l10.1117"></a><span id="l10.1117" class="difflineminus">-   *</span>
<a href="#l10.1118"></a><span id="l10.1118" class="difflineminus">-   * @param aURL to ensure a scheme with</span>
<a href="#l10.1119"></a><span id="l10.1119" class="difflineminus">-   */</span>
<a href="#l10.1120"></a><span id="l10.1120" class="difflineminus">-  _ensureScheme(aURL) {</span>
<a href="#l10.1121"></a><span id="l10.1121" class="difflineminus">-    try {</span>
<a href="#l10.1122"></a><span id="l10.1122" class="difflineminus">-      Services.io.extractScheme(aURL);</span>
<a href="#l10.1123"></a><span id="l10.1123" class="difflineminus">-      return aURL;</span>
<a href="#l10.1124"></a><span id="l10.1124" class="difflineminus">-    } catch (e) {</span>
<a href="#l10.1125"></a><span id="l10.1125" class="difflineminus">-      // If we got NS_ERROR_MALFORMED_URI back, there's no scheme here.</span>
<a href="#l10.1126"></a><span id="l10.1126" class="difflineminus">-      if (e.result == Cr.NS_ERROR_MALFORMED_URI)</span>
<a href="#l10.1127"></a><span id="l10.1127" class="difflineminus">-        return &quot;https://&quot; + aURL;</span>
<a href="#l10.1128"></a><span id="l10.1128" class="difflineminus">-      // Otherwise, we hit something different, and should throw.</span>
<a href="#l10.1129"></a><span id="l10.1129" class="difflineminus">-      throw e;</span>
<a href="#l10.1130"></a><span id="l10.1130" class="difflineminus">-    }</span>
<a href="#l10.1131"></a><span id="l10.1131" class="difflineminus">-  },</span>
<a href="#l10.1132"></a><span id="l10.1132" class="difflineminus">-</span>
<a href="#l10.1133"></a><span id="l10.1133" class="difflineminus">-  /**</span>
<a href="#l10.1134"></a><span id="l10.1134" class="difflineminus">-   * Attempt to find download url for file.</span>
<a href="#l10.1135"></a><span id="l10.1135" class="difflineminus">-   *</span>
<a href="#l10.1136"></a><span id="l10.1136" class="difflineminus">-   * @param aFileId id of file</span>
<a href="#l10.1137"></a><span id="l10.1137" class="difflineminus">-   * @param aSuccessCallback called if url is found</span>
<a href="#l10.1138"></a><span id="l10.1138" class="difflineminus">-   * @param aFailureCallback called if url is not found</span>
<a href="#l10.1139"></a><span id="l10.1139" class="difflineminus">-   */</span>
<a href="#l10.1140"></a><span id="l10.1140" class="difflineminus">-  _findDownloadUrl(aFileId, aSuccessCallback, aFailureCallback) {</span>
<a href="#l10.1141"></a><span id="l10.1141" class="difflineminus">-    let req = new XMLHttpRequest();</span>
<a href="#l10.1142"></a><span id="l10.1142" class="difflineminus">-</span>
<a href="#l10.1143"></a><span id="l10.1143" class="difflineminus">-    req.open(&quot;GET&quot;, gServerUrl + kFolderFilePath + aFileId, true);</span>
<a href="#l10.1144"></a><span id="l10.1144" class="difflineminus">-</span>
<a href="#l10.1145"></a><span id="l10.1145" class="difflineminus">-    req.onerror = function() {</span>
<a href="#l10.1146"></a><span id="l10.1146" class="difflineminus">-      this.log.info(&quot;error in findDownloadUrl&quot;);</span>
<a href="#l10.1147"></a><span id="l10.1147" class="difflineminus">-      aFailureCallback();</span>
<a href="#l10.1148"></a><span id="l10.1148" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.1149"></a><span id="l10.1149" class="difflineminus">-</span>
<a href="#l10.1150"></a><span id="l10.1150" class="difflineminus">-    req.onload = function() {</span>
<a href="#l10.1151"></a><span id="l10.1151" class="difflineminus">-      let response = req.responseText;</span>
<a href="#l10.1152"></a><span id="l10.1152" class="difflineminus">-      this.log.info(&quot;findDownloadUrl response = &quot; + response);</span>
<a href="#l10.1153"></a><span id="l10.1153" class="difflineminus">-      let fileInfo = JSON.parse(response);</span>
<a href="#l10.1154"></a><span id="l10.1154" class="difflineminus">-</span>
<a href="#l10.1155"></a><span id="l10.1155" class="difflineminus">-      if (fileInfo.errorStatus) {</span>
<a href="#l10.1156"></a><span id="l10.1156" class="difflineminus">-        aFailureCallback();</span>
<a href="#l10.1157"></a><span id="l10.1157" class="difflineminus">-      } else {</span>
<a href="#l10.1158"></a><span id="l10.1158" class="difflineminus">-        // We need a kludge here because Hightail is returning URLs without the scheme...</span>
<a href="#l10.1159"></a><span id="l10.1159" class="difflineminus">-        let url = this._ensureScheme(fileInfo.clickableDownloadUrl);</span>
<a href="#l10.1160"></a><span id="l10.1160" class="difflineminus">-        this.hightail._urlsForFiles[this.file.path] = url;</span>
<a href="#l10.1161"></a><span id="l10.1161" class="difflineminus">-        aSuccessCallback();</span>
<a href="#l10.1162"></a><span id="l10.1162" class="difflineminus">-      }</span>
<a href="#l10.1163"></a><span id="l10.1163" class="difflineminus">-    }.bind(this);</span>
<a href="#l10.1164"></a><span id="l10.1164" class="difflineminus">-</span>
<a href="#l10.1165"></a><span id="l10.1165" class="difflineminus">-    req.setRequestHeader(&quot;X-Auth-Token&quot;, this.hightail._cachedAuthToken + &quot; &quot;);</span>
<a href="#l10.1166"></a><span id="l10.1166" class="difflineminus">-    req.setRequestHeader(&quot;X-Api-Key&quot;, kApiKey);</span>
<a href="#l10.1167"></a><span id="l10.1167" class="difflineminus">-    req.setRequestHeader(&quot;Accept&quot;, &quot;application/json&quot;);</span>
<a href="#l10.1168"></a><span id="l10.1168" class="difflineminus">-    req.send();</span>
<a href="#l10.1169"></a><span id="l10.1169" class="difflineminus">-  },</span>
<a href="#l10.1170"></a><span id="l10.1170" class="difflineminus">-</span>
<a href="#l10.1171"></a><span id="l10.1171" class="difflineminus">-  /**</span>
<a href="#l10.1172"></a><span id="l10.1172" class="difflineminus">-   * Creates and returns a temporary file on the local file system.</span>
<a href="#l10.1173"></a><span id="l10.1173" class="difflineminus">-   */</span>
<a href="#l10.1174"></a><span id="l10.1174" class="difflineminus">-  getTempFile(leafName) {</span>
<a href="#l10.1175"></a><span id="l10.1175" class="difflineminus">-    let tempfile = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l10.1176"></a><span id="l10.1176" class="difflineminus">-    tempfile.append(leafName);</span>
<a href="#l10.1177"></a><span id="l10.1177" class="difflineminus">-    tempfile.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE, parseInt(&quot;0666&quot;, 8));</span>
<a href="#l10.1178"></a><span id="l10.1178" class="difflineminus">-    // do whatever you need to the created file</span>
<a href="#l10.1179"></a><span id="l10.1179" class="difflineminus">-    return tempfile.clone();</span>
<a href="#l10.1180"></a><span id="l10.1180" class="difflineminus">-  },</span>
<a href="#l10.1181"></a><span id="l10.1181" class="difflineminus">-</span>
<a href="#l10.1182"></a><span id="l10.1182" class="difflineminus">-  /**</span>
<a href="#l10.1183"></a><span id="l10.1183" class="difflineminus">-   * Cleans up any temporary files that this nsHightailFileUploader may have</span>
<a href="#l10.1184"></a><span id="l10.1184" class="difflineminus">-   * created.</span>
<a href="#l10.1185"></a><span id="l10.1185" class="difflineminus">-   */</span>
<a href="#l10.1186"></a><span id="l10.1186" class="difflineminus">-  cleanupTempFile() {</span>
<a href="#l10.1187"></a><span id="l10.1187" class="difflineminus">-    if (this._bufStream)</span>
<a href="#l10.1188"></a><span id="l10.1188" class="difflineminus">-      this._bufStream.close();</span>
<a href="#l10.1189"></a><span id="l10.1189" class="difflineminus">-    if (this._fstream)</span>
<a href="#l10.1190"></a><span id="l10.1190" class="difflineminus">-      this._fstream.close();</span>
<a href="#l10.1191"></a><span id="l10.1191" class="difflineminus">-    if (this._tempFile)</span>
<a href="#l10.1192"></a><span id="l10.1192" class="difflineminus">-      this._tempFile.remove(false);</span>
<a href="#l10.1193"></a><span id="l10.1193" class="difflineminus">-  },</span>
<a href="#l10.1194"></a><span id="l10.1194" class="difflineminus">-};</span>
<a href="#l10.1195"></a><span id="l10.1195" class="difflineminus">-</span>
<a href="#l10.1196"></a><span id="l10.1196" class="difflineminus">-// Hightail used to be named YouSendIt, which is the constant used in the prefs.</span>
<a href="#l10.1197"></a><span id="l10.1197" class="difflineminus">-cloudFileAccounts.registerProvider(&quot;YouSendIt&quot;, {</span>
<a href="#l10.1198"></a><span id="l10.1198" class="difflineminus">-  type: &quot;YouSendIt&quot;,</span>
<a href="#l10.1199"></a><span id="l10.1199" class="difflineminus">-  displayName: &quot;Hightail&quot;,</span>
<a href="#l10.1200"></a><span id="l10.1200" class="difflineminus">-  iconURL: &quot;chrome://messenger/skin/icons/hightail.png&quot;,</span>
<a href="#l10.1201"></a><span id="l10.1201" class="difflineminus">-  initAccount(accountKey) {</span>
<a href="#l10.1202"></a><span id="l10.1202" class="difflineminus">-    let account = new nsHightail();</span>
<a href="#l10.1203"></a><span id="l10.1203" class="difflineminus">-    account.init(accountKey);</span>
<a href="#l10.1204"></a><span id="l10.1204" class="difflineminus">-    return account;</span>
<a href="#l10.1205"></a><span id="l10.1205" class="difflineminus">-  },</span>
<a href="#l10.1206"></a><span id="l10.1206" class="difflineminus">-});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/mail/components/cloudfile/hightail/management.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,100 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">-</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-// mail/base/content/protovis-r2.6-modded.js</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">-/* globals pv */</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-var accountId = new URL(location.href).searchParams.get(&quot;accountId&quot;);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-var account = cloudFileAccounts.getAccount(accountId);</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-var loading = document.getElementById(&quot;provider-loading&quot;);</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-var auth = document.getElementById(&quot;provider-auth&quot;);</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-var spacebox = document.getElementById(&quot;provider-spacebox&quot;);</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-if (cloudFileAccounts.getSecretValue(accountId, cloudFileAccounts.kTokenRealm)) {</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-  onDoLoad();</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-} else {</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-  loading.hidden = true;</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-  auth.hidden = false;</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-}</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-function onDoAuth(button) {</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-  button.disabled = true;</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-  loading.hidden = false;</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-  auth.hidden = true;</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-  account.createExistingAccount({</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-    onStartRequest() {</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-    },</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-    onStopRequest(unused1, error) {</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-      button.disabled = false;</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-      if (error) {</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-        loading.hidden = true;</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-        auth.hidden = false;</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-        return;</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-      }</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-      cloudFileAccounts.emit(&quot;accountConfigured&quot;, account);</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-      onDoLoad();</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-    },</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-  }, () =&gt; {</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-    button.disabled = false;</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-    loading.hidden = true;</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-    auth.hidden = false;</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-  });</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-}</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-function onDoLoad() {</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-  account.refreshUserInfo(false, {</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-    onStartRequest() {</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-    },</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-    onStopRequest() {</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-      loading.hidden = true;</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-      spacebox.hidden = false;</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-      onLoadProvider(account);</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-    },</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-  });</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-}</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-function onLoadProvider(account) {</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-  let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-  let fileSpaceUsed = document.getElementById(&quot;file-space-used&quot;);</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-  fileSpaceUsed.textContent = messenger.formatFileSize(account.fileSpaceUsed);</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-  let fileSpaceUsedSwatch = document.getElementById(&quot;file-space-used-swatch&quot;);</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-  fileSpaceUsedSwatch.style.backgroundColor = pv.Colors.category20.values[0];</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-  let remainingFileSpace = document.getElementById(&quot;remaining-file-space&quot;);</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-  remainingFileSpace.textContent = messenger.formatFileSize(</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-    account.remainingFileSpace);</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-  let remainingFileSpaceSwatch = document.getElementById(&quot;remaining-file-space-swatch&quot;);</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-  remainingFileSpaceSwatch.style.backgroundColor = pv.Colors.category20.values[1];</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-  let totalSpace = account.fileSpaceUsed + account.remainingFileSpace;</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-  let pieScale = 2 * Math.PI / totalSpace;</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-  let spaceDiv = document.getElementById(&quot;provider-space-visuals&quot;);</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-  let vis = new pv.Panel().canvas(spaceDiv)</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-    .width(150)</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-    .height(150);</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-  vis.add(pv.Wedge)</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-    .data([account.fileSpaceUsed, account.remainingFileSpace])</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-    .left(75)</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-    .top(75)</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-    .innerRadius(30)</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-    .outerRadius(65)</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-    .angle(d =&gt; d * pieScale);</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-  vis.add(pv.Label)</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-    .left(75)</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-    .top(75)</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-    .font(&quot;14px Sans-Serif&quot;)</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-    .textAlign(&quot;center&quot;)</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-    .textBaseline(&quot;middle&quot;)</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-    .text(messenger.formatFileSize(totalSpace));</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-  vis.render();</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">deleted file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- a/mail/components/cloudfile/hightail/management.xhtml</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ /dev/null</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -1,55 +0,0 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineminus">-   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineminus">-</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-&lt;!DOCTYPE html [</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-  &lt;!ENTITY % htmlDTD PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;DTD/xhtml1-strict.dtd&quot;&gt; %htmlDTD;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  &lt;!ENTITY % managementDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/management.dtd&quot;&gt; %managementDTD;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-  &lt;!ENTITY % hightailDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/Hightail/management.dtd&quot;&gt; %hightailDTD;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-]&gt;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-  &lt;head&gt;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-    &lt;script src=&quot;chrome://messenger/content/protovis-r2.6-modded.js&quot;/&gt;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-    &lt;script src=&quot;chrome://messenger/content/cloudfile/Hightail/management.js&quot;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-            defer=&quot;true&quot;/&gt;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-    &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-        type=&quot;text/css&quot;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-        href=&quot;chrome://messenger/skin/preferences/preferences.css&quot; /&gt;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-  &lt;/head&gt;</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-  &lt;body id=&quot;provider-management&quot;&gt;</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-    &lt;div id=&quot;provider-header&quot;&gt;</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-      &lt;div id=&quot;provider-terms&quot;&gt;</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-      &lt;a href=&quot;http://www.hightail.com/aboutus/legal/privacy&quot;&gt;&amp;cloudfileMgmt.privacyPolicy;&lt;/a&gt;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-      &lt;a href=&quot;http://www.hightail.com/aboutus/legal/terms-of-service&quot;&gt;&amp;cloudfileMgmt.termsOfService;&lt;/a&gt;</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-      &lt;div id=&quot;provider-name&quot;&gt;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-      &lt;h1&gt;Hightail&lt;/h1&gt;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-    &lt;/div&gt;</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-    &lt;div id=&quot;provider-loading&quot; align=&quot;center&quot;&gt;</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-      &lt;img src=&quot;chrome://global/skin/icons/loading.png&quot; /&gt;</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-    &lt;/div&gt;</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-    &lt;div id=&quot;provider-auth&quot; align=&quot;center&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-      &lt;button onclick=&quot;onDoAuth(this)&quot;&gt;&amp;hightailMgmt.doAuth;&lt;/button&gt;</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-    &lt;/div&gt;</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-    &lt;div id=&quot;provider-spacebox&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-      &lt;div id=&quot;provider-space-visuals&quot;&gt;&lt;/div&gt;</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-      &lt;div id=&quot;provider-space&quot;&gt;</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-        &lt;div&gt;</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-          &lt;label&gt;&amp;cloudfileMgmt.usedSpace;&lt;/label&gt;</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-          &lt;span id=&quot;file-space-used&quot;/&gt;</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-          &lt;span id=&quot;file-space-used-swatch&quot; class=&quot;space-swatch&quot;/&gt;</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-        &lt;/div&gt;</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-        &lt;div&gt;</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-          &lt;label&gt;&amp;cloudfileMgmt.unusedSpace;&lt;/label&gt;</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-          &lt;span id=&quot;remaining-file-space&quot;/&gt;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-          &lt;span id=&quot;remaining-file-space-swatch&quot; class=&quot;space-swatch&quot;/&gt;</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-        &lt;/div&gt;</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-        &lt;div id=&quot;upgrade&quot;&gt;&lt;a href=&quot;https://www.hightail.com/compare-plans&quot;&gt;&amp;cloudfileMgmt.upgradeOffer;&lt;/a&gt;&lt;/div&gt;</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-    &lt;div id=&quot;provider-account-settings&quot;&gt;&lt;a href=&quot;https://www.hightail.com/myaccount&quot;&gt;&amp;hightailMgmt.viewSettings;&lt;/a&gt;&lt;/div&gt;</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-  &lt;/body&gt;</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/components/cloudfile/jar.mn</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/components/cloudfile/jar.mn</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,18 +1,8 @@</span>
<a href="#l13.4"></a><span id="l13.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.5"></a><span id="l13.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.6"></a><span id="l13.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> messenger.jar:</span>
<a href="#l13.9"></a><span id="l13.9">     content/messenger/cloudfile/selectDialog.css              (content/selectDialog.css)</span>
<a href="#l13.10"></a><span id="l13.10">     content/messenger/cloudfile/selectDialog.js               (content/selectDialog.js)</span>
<a href="#l13.11"></a><span id="l13.11">     content/messenger/cloudfile/selectDialog.xul              (content/selectDialog.xul)</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-    content/messenger/cloudfile/Box/box.jsm                   (box/box.jsm)</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-    content/messenger/cloudfile/Box/management.xhtml          (box/management.xhtml)</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-    content/messenger/cloudfile/Box/management.js             (box/management.js)</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-    content/messenger/cloudfile/Hightail/hightail.jsm         (hightail/hightail.jsm)</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-    content/messenger/cloudfile/Hightail/management.xhtml     (hightail/management.xhtml)</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-    content/messenger/cloudfile/Hightail/management.js        (hightail/management.js)</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-    content/messenger/cloudfile/Hightail/fileExceedsLimit.xul (hightail/fileExceedsLimit.xul)</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-    content/messenger/cloudfile/Hightail/fileExceedsQuota.xul (hightail/fileExceedsQuota.xul)</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-    content/messenger/cloudfile/Hightail/fileExceedsQuota.js  (hightail/fileExceedsQuota.js)</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-    content/messenger/cloudfile/Hightail/fileExceeds2GB.xul   (hightail/fileExceeds2GB.xul)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/components/preferences/applications.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/components/preferences/applications.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -512,17 +512,16 @@ var gCloudFileTab = {</span>
<a href="#l14.4"></a><span id="l14.4">   _list: null,</span>
<a href="#l14.5"></a><span id="l14.5">   _buttonContainer: null,</span>
<a href="#l14.6"></a><span id="l14.6">   _listContainer: null,</span>
<a href="#l14.7"></a><span id="l14.7">   _settings: null,</span>
<a href="#l14.8"></a><span id="l14.8">   _settingsDeck: null,</span>
<a href="#l14.9"></a><span id="l14.9">   _tabpanel: null,</span>
<a href="#l14.10"></a><span id="l14.10">   _settingsPanelWrap: null,</span>
<a href="#l14.11"></a><span id="l14.11">   _defaultPanel: null,</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  _blacklist: new Set([&quot;YouSendIt&quot;]),</span>
<a href="#l14.13"></a><span id="l14.13"> </span>
<a href="#l14.14"></a><span id="l14.14">   get _strings() {</span>
<a href="#l14.15"></a><span id="l14.15">     return Services.strings</span>
<a href="#l14.16"></a><span id="l14.16">                    .createBundle(&quot;chrome://messenger/locale/preferences/applications.properties&quot;);</span>
<a href="#l14.17"></a><span id="l14.17">   },</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19">   init() {</span>
<a href="#l14.20"></a><span id="l14.20">     // Because this leads to another document being loaded, do it only when really necessary.</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineat">@@ -584,20 +583,18 @@ var gCloudFileTab = {</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23">     // Always add newly-enabled accounts to the end of the list, this makes</span>
<a href="#l14.24"></a><span id="l14.24">     // it clearer to users what's happening.</span>
<a href="#l14.25"></a><span id="l14.25">     for (let account of accounts) {</span>
<a href="#l14.26"></a><span id="l14.26">       let item = this.makeRichListItemForAccount(account);</span>
<a href="#l14.27"></a><span id="l14.27">       this._list.appendChild(item);</span>
<a href="#l14.28"></a><span id="l14.28">     }</span>
<a href="#l14.29"></a><span id="l14.29"> </span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-    if (!this._blacklist.has(provider.type)) {</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-      this._buttonContainer.appendChild(this.makeButtonForProvider(provider));</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-      this._listContainer.appendChild(this.makeListItemForProvider(provider));</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-    }</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+    this._buttonContainer.appendChild(this.makeButtonForProvider(provider));</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+    this._listContainer.appendChild(this.makeListItemForProvider(provider));</span>
<a href="#l14.36"></a><span id="l14.36">   },</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38">   _onProviderUnregistered(event, type) {</span>
<a href="#l14.39"></a><span id="l14.39">     for (let item of this._list.children) {</span>
<a href="#l14.40"></a><span id="l14.40">       // If the provider is unregistered, getAccount returns null.</span>
<a href="#l14.41"></a><span id="l14.41">       if (!cloudFileAccounts.getAccount(item.value)) {</span>
<a href="#l14.42"></a><span id="l14.42">         if (item.hasAttribute(&quot;selected&quot;)) {</span>
<a href="#l14.43"></a><span id="l14.43">           this._settingsDeck.selectedPanel = this._defaultPanel;</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineat">@@ -709,20 +706,16 @@ var gCloudFileTab = {</span>
<a href="#l14.45"></a><span id="l14.45">     }</span>
<a href="#l14.46"></a><span id="l14.46"> </span>
<a href="#l14.47"></a><span id="l14.47">     while (this._buttonContainer.hasChildNodes())</span>
<a href="#l14.48"></a><span id="l14.48">       this._buttonContainer.lastChild.remove();</span>
<a href="#l14.49"></a><span id="l14.49"> </span>
<a href="#l14.50"></a><span id="l14.50">     let providers = cloudFileAccounts.providers;</span>
<a href="#l14.51"></a><span id="l14.51">     providers.sort(this._sortDisplayNames);</span>
<a href="#l14.52"></a><span id="l14.52">     for (let provider of providers) {</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-      if (this._blacklist.has(provider.type)) {</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-        continue;</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-      }</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-</span>
<a href="#l14.57"></a><span id="l14.57">       this._buttonContainer.appendChild(this.makeButtonForProvider(provider));</span>
<a href="#l14.58"></a><span id="l14.58">       this._listContainer.appendChild(this.makeListItemForProvider(provider));</span>
<a href="#l14.59"></a><span id="l14.59">     }</span>
<a href="#l14.60"></a><span id="l14.60">   },</span>
<a href="#l14.61"></a><span id="l14.61"> </span>
<a href="#l14.62"></a><span id="l14.62">   onSelectionChanged(aEvent) {</span>
<a href="#l14.63"></a><span id="l14.63">     if (!this._initialized || aEvent.target != this._list) {</span>
<a href="#l14.64"></a><span id="l14.64">       return;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/components/preferences/test/browser/browser_cloudfile.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/components/preferences/test/browser/browser_cloudfile.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -21,39 +21,37 @@ add_task(async () =&gt; {</span>
<a href="#l15.4"></a><span id="l15.4">     mockPromptService</span>
<a href="#l15.5"></a><span id="l15.5">   );</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7">   registerCleanupFunction(() =&gt; {</span>
<a href="#l15.8"></a><span id="l15.8">     MockRegistrar.unregister(mockPromptServiceCID);</span>
<a href="#l15.9"></a><span id="l15.9">   });</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11">   let { cloudFileAccounts } = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  is(cloudFileAccounts.providers.length, 3);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  is(cloudFileAccounts.providers.length, 1);</span>
<a href="#l15.14"></a><span id="l15.14">   is(cloudFileAccounts.accounts.length, 0);</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16">   // Load the preferences tab.</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18">   let { prefsDocument, prefsWindow } = await openNewPrefsTab(&quot;paneApplications&quot;, &quot;attachmentsOutTab&quot;);</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20">   // Check everything is as it should be.</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22">   let accountList = prefsDocument.getElementById(&quot;cloudFileView&quot;);</span>
<a href="#l15.23"></a><span id="l15.23">   is(accountList.itemCount, 0);</span>
<a href="#l15.24"></a><span id="l15.24"> </span>
<a href="#l15.25"></a><span id="l15.25">   let buttonList = prefsDocument.getElementById(&quot;addCloudFileAccountButtons&quot;);</span>
<a href="#l15.26"></a><span id="l15.26">   ok(!buttonList.hidden);</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-  is(buttonList.childElementCount, 2);</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-  is(buttonList.children[0].getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-  is(buttonList.children[1].getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+  is(buttonList.childElementCount, 1);</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+  is(buttonList.children[0].getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l15.32"></a><span id="l15.32"> </span>
<a href="#l15.33"></a><span id="l15.33">   let menuButton = prefsDocument.getElementById(&quot;addCloudFileAccount&quot;);</span>
<a href="#l15.34"></a><span id="l15.34">   ok(menuButton.hidden);</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-  is(menuButton.itemCount, 2);</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-  is(menuButton.getItemAtIndex(0).getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-  is(menuButton.getItemAtIndex(1).getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+  is(menuButton.itemCount, 1);</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+  is(menuButton.getItemAtIndex(0).getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l15.40"></a><span id="l15.40"> </span>
<a href="#l15.41"></a><span id="l15.41">   let removeButton = prefsDocument.getElementById(&quot;removeCloudFileAccount&quot;);</span>
<a href="#l15.42"></a><span id="l15.42">   ok(removeButton.disabled);</span>
<a href="#l15.43"></a><span id="l15.43"> </span>
<a href="#l15.44"></a><span id="l15.44">   let settingsDeck = prefsDocument.getElementById(&quot;cloudFileSettingsDeck&quot;);</span>
<a href="#l15.45"></a><span id="l15.45">   is(settingsDeck.selectedPanel.id, &quot;cloudFileDefaultPanel&quot;);</span>
<a href="#l15.46"></a><span id="l15.46"> </span>
<a href="#l15.47"></a><span id="l15.47">   let iframeWrapper = prefsDocument.getElementById(&quot;cloudFileSettingsWrapper&quot;);</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineat">@@ -81,36 +79,34 @@ add_task(async () =&gt; {</span>
<a href="#l15.49"></a><span id="l15.49">         },</span>
<a href="#l15.50"></a><span id="l15.50">         iconURL: ICON_URL,</span>
<a href="#l15.51"></a><span id="l15.51">         configured: accountIsConfigured,</span>
<a href="#l15.52"></a><span id="l15.52">         managementURL: MANAGEMENT_URL,</span>
<a href="#l15.53"></a><span id="l15.53">       };</span>
<a href="#l15.54"></a><span id="l15.54">     },</span>
<a href="#l15.55"></a><span id="l15.55">   };</span>
<a href="#l15.56"></a><span id="l15.56">   cloudFileAccounts.registerProvider(&quot;Mochitest&quot;, provider);</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-  is(cloudFileAccounts.providers.length, 4);</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+  is(cloudFileAccounts.providers.length, 2);</span>
<a href="#l15.59"></a><span id="l15.59">   is(cloudFileAccounts.accounts.length, 0);</span>
<a href="#l15.60"></a><span id="l15.60"> </span>
<a href="#l15.61"></a><span id="l15.61">   await new Promise(resolve =&gt; prefsWindow.requestAnimationFrame(resolve));</span>
<a href="#l15.62"></a><span id="l15.62"> </span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-  is(buttonList.childElementCount, 3);</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-  is(buttonList.children[0].getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-  is(buttonList.children[1].getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-  is(buttonList.children[2].getAttribute(&quot;value&quot;), &quot;Mochitest&quot;);</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-  is(buttonList.children[2].style.listStyleImage, `url(&quot;${ICON_URL}&quot;)`);</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+  is(buttonList.childElementCount, 2);</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+  is(buttonList.children[0].getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+  is(buttonList.children[1].getAttribute(&quot;value&quot;), &quot;Mochitest&quot;);</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+  is(buttonList.children[1].style.listStyleImage, `url(&quot;${ICON_URL}&quot;)`);</span>
<a href="#l15.72"></a><span id="l15.72"> </span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-  is(menuButton.itemCount, 3);</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-  is(menuButton.getItemAtIndex(0).getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-  is(menuButton.getItemAtIndex(1).getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-  is(menuButton.getItemAtIndex(2).getAttribute(&quot;value&quot;), &quot;Mochitest&quot;);</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-  is(menuButton.getItemAtIndex(2).getAttribute(&quot;image&quot;), ICON_URL);</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+  is(menuButton.itemCount, 2);</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+  is(menuButton.getItemAtIndex(0).getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+  is(menuButton.getItemAtIndex(1).getAttribute(&quot;value&quot;), &quot;Mochitest&quot;);</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+  is(menuButton.getItemAtIndex(1).getAttribute(&quot;image&quot;), ICON_URL);</span>
<a href="#l15.82"></a><span id="l15.82"> </span>
<a href="#l15.83"></a><span id="l15.83">   // Create a new account.</span>
<a href="#l15.84"></a><span id="l15.84"> </span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-  EventUtils.synthesizeMouseAtCenter(buttonList.children[2], { clickCount: 1 }, prefsWindow);</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+  EventUtils.synthesizeMouseAtCenter(buttonList.children[1], { clickCount: 1 }, prefsWindow);</span>
<a href="#l15.87"></a><span id="l15.87">   is(cloudFileAccounts.accounts.length, 1);</span>
<a href="#l15.88"></a><span id="l15.88">   is(cloudFileAccounts.configuredAccounts.length, 0);</span>
<a href="#l15.89"></a><span id="l15.89"> </span>
<a href="#l15.90"></a><span id="l15.90">   let account = cloudFileAccounts.accounts[0];</span>
<a href="#l15.91"></a><span id="l15.91">   let accountKey = account.accountKey;</span>
<a href="#l15.92"></a><span id="l15.92">   is(cloudFileAccounts.accounts[0].type, &quot;Mochitest&quot;);</span>
<a href="#l15.93"></a><span id="l15.93"> </span>
<a href="#l15.94"></a><span id="l15.94">   // Check prefs were updated.</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineat">@@ -189,70 +185,66 @@ add_task(async () =&gt; {</span>
<a href="#l15.96"></a><span id="l15.96"> </span>
<a href="#l15.97"></a><span id="l15.97">   is(accountListItem.querySelector(&quot;image.configuredWarning&quot;).hidden, true);</span>
<a href="#l15.98"></a><span id="l15.98">   is(cloudFileAccounts.accounts.length, 1);</span>
<a href="#l15.99"></a><span id="l15.99">   is(cloudFileAccounts.configuredAccounts.length, 1);</span>
<a href="#l15.100"></a><span id="l15.100"> </span>
<a href="#l15.101"></a><span id="l15.101">   // Remove the test provider. The list item, button, and iframe should disappear.</span>
<a href="#l15.102"></a><span id="l15.102"> </span>
<a href="#l15.103"></a><span id="l15.103">   cloudFileAccounts.unregisterProvider(&quot;Mochitest&quot;);</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineminus">-  is(cloudFileAccounts.providers.length, 3);</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineplus">+  is(cloudFileAccounts.providers.length, 1);</span>
<a href="#l15.106"></a><span id="l15.106">   is(cloudFileAccounts.accounts.length, 0);</span>
<a href="#l15.107"></a><span id="l15.107"> </span>
<a href="#l15.108"></a><span id="l15.108">   await new Promise(resolve =&gt; prefsWindow.requestAnimationFrame(resolve));</span>
<a href="#l15.109"></a><span id="l15.109"> </span>
<a href="#l15.110"></a><span id="l15.110" class="difflineminus">-  is(buttonList.childElementCount, 2);</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-  is(buttonList.children[0].getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-  is(buttonList.children[1].getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineminus">-  is(menuButton.itemCount, 2);</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineminus">-  is(menuButton.getItemAtIndex(0).getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineminus">-  is(menuButton.getItemAtIndex(1).getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+  is(buttonList.childElementCount, 1);</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+  is(buttonList.children[0].getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+  is(menuButton.itemCount, 1);</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+  is(menuButton.getItemAtIndex(0).getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l15.120"></a><span id="l15.120">   is(accountList.itemCount, 0);</span>
<a href="#l15.121"></a><span id="l15.121">   is(settingsDeck.selectedPanel.id, &quot;cloudFileDefaultPanel&quot;);</span>
<a href="#l15.122"></a><span id="l15.122">   is(iframeWrapper.childElementCount, 0);</span>
<a href="#l15.123"></a><span id="l15.123"> </span>
<a href="#l15.124"></a><span id="l15.124">   // Re-add the test provider.</span>
<a href="#l15.125"></a><span id="l15.125"> </span>
<a href="#l15.126"></a><span id="l15.126">   cloudFileAccounts.registerProvider(&quot;Mochitest&quot;, provider);</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-  is(cloudFileAccounts.providers.length, 4);</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineplus">+  is(cloudFileAccounts.providers.length, 2);</span>
<a href="#l15.129"></a><span id="l15.129">   is(cloudFileAccounts.accounts.length, 1);</span>
<a href="#l15.130"></a><span id="l15.130">   is(cloudFileAccounts.configuredAccounts.length, 1);</span>
<a href="#l15.131"></a><span id="l15.131"> </span>
<a href="#l15.132"></a><span id="l15.132">   await new Promise(resolve =&gt; prefsWindow.requestAnimationFrame(resolve));</span>
<a href="#l15.133"></a><span id="l15.133"> </span>
<a href="#l15.134"></a><span id="l15.134" class="difflineminus">-  is(buttonList.childElementCount, 3);</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineminus">-  is(buttonList.children[0].getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-  is(buttonList.children[1].getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-  is(buttonList.children[2].getAttribute(&quot;value&quot;), &quot;Mochitest&quot;);</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+  is(buttonList.childElementCount, 2);</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+  is(buttonList.children[0].getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+  is(buttonList.children[1].getAttribute(&quot;value&quot;), &quot;Mochitest&quot;);</span>
<a href="#l15.141"></a><span id="l15.141"> </span>
<a href="#l15.142"></a><span id="l15.142" class="difflineminus">-  is(menuButton.itemCount, 3);</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineminus">-  is(menuButton.getItemAtIndex(0).getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineminus">-  is(menuButton.getItemAtIndex(1).getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-  is(menuButton.getItemAtIndex(2).getAttribute(&quot;value&quot;), &quot;Mochitest&quot;);</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineplus">+  is(menuButton.itemCount, 2);</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineplus">+  is(menuButton.getItemAtIndex(0).getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineplus">+  is(menuButton.getItemAtIndex(1).getAttribute(&quot;value&quot;), &quot;Mochitest&quot;);</span>
<a href="#l15.149"></a><span id="l15.149"> </span>
<a href="#l15.150"></a><span id="l15.150">   is(accountList.itemCount, 1);</span>
<a href="#l15.151"></a><span id="l15.151">   is(accountList.selectedIndex, -1);</span>
<a href="#l15.152"></a><span id="l15.152">   ok(removeButton.disabled);</span>
<a href="#l15.153"></a><span id="l15.153"> </span>
<a href="#l15.154"></a><span id="l15.154">   accountListItem = accountList.getItemAtIndex(0);</span>
<a href="#l15.155"></a><span id="l15.155">   is(Services.prefs.getCharPref(`mail.cloud_files.accounts.${accountKey}.displayName`), &quot;Mochitest Account!&quot;);</span>
<a href="#l15.156"></a><span id="l15.156"> </span>
<a href="#l15.157"></a><span id="l15.157">   EventUtils.synthesizeMouseAtCenter(accountList.getItemAtIndex(0), { clickCount: 1 }, prefsWindow);</span>
<a href="#l15.158"></a><span id="l15.158">   ok(!removeButton.disabled);</span>
<a href="#l15.159"></a><span id="l15.159">   EventUtils.synthesizeMouseAtCenter(removeButton, { clickCount: 1 }, prefsWindow);</span>
<a href="#l15.160"></a><span id="l15.160">   is(mockPromptService.confirmCount, 1);</span>
<a href="#l15.161"></a><span id="l15.161"> </span>
<a href="#l15.162"></a><span id="l15.162">   ok(!Services.prefs.prefHasUserValue(`mail.cloud_files.accounts.${accountKey}.displayName`));</span>
<a href="#l15.163"></a><span id="l15.163">   ok(!Services.prefs.prefHasUserValue(`mail.cloud_files.accounts.${accountKey}.type`));</span>
<a href="#l15.164"></a><span id="l15.164"> </span>
<a href="#l15.165"></a><span id="l15.165" class="difflineminus">-  is(cloudFileAccounts.providers.length, 4);</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineplus">+  is(cloudFileAccounts.providers.length, 2);</span>
<a href="#l15.167"></a><span id="l15.167">   is(cloudFileAccounts.accounts.length, 0);</span>
<a href="#l15.168"></a><span id="l15.168"> </span>
<a href="#l15.169"></a><span id="l15.169">   cloudFileAccounts.unregisterProvider(&quot;Mochitest&quot;, provider);</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineminus">-  is(cloudFileAccounts.providers.length, 3);</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineplus">+  is(cloudFileAccounts.providers.length, 1);</span>
<a href="#l15.172"></a><span id="l15.172">   is(cloudFileAccounts.accounts.length, 0);</span>
<a href="#l15.173"></a><span id="l15.173"> </span>
<a href="#l15.174"></a><span id="l15.174">   // Close the preferences tab.</span>
<a href="#l15.175"></a><span id="l15.175"> </span>
<a href="#l15.176"></a><span id="l15.176">   await closePrefsTab();</span>
<a href="#l15.177"></a><span id="l15.177"> });</span>
<a href="#l15.178"></a><span id="l15.178"> </span>
<a href="#l15.179"></a><span id="l15.179"> add_task(async () =&gt; {</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineat">@@ -280,17 +272,17 @@ add_task(async () =&gt; {</span>
<a href="#l15.181"></a><span id="l15.181">         },</span>
<a href="#l15.182"></a><span id="l15.182">         iconURL: ICON_URL,</span>
<a href="#l15.183"></a><span id="l15.183">         configured: accountIsConfigured,</span>
<a href="#l15.184"></a><span id="l15.184">         managementURL: MANAGEMENT_URL,</span>
<a href="#l15.185"></a><span id="l15.185">       };</span>
<a href="#l15.186"></a><span id="l15.186">     },</span>
<a href="#l15.187"></a><span id="l15.187">   };</span>
<a href="#l15.188"></a><span id="l15.188">   cloudFileAccounts.registerProvider(&quot;Mochitest&quot;, provider);</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineminus">-  is(cloudFileAccounts.providers.length, 4);</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineplus">+  is(cloudFileAccounts.providers.length, 2);</span>
<a href="#l15.191"></a><span id="l15.191">   is(cloudFileAccounts.accounts.length, 0);</span>
<a href="#l15.192"></a><span id="l15.192"> </span>
<a href="#l15.193"></a><span id="l15.193">   // Load the preferences tab.</span>
<a href="#l15.194"></a><span id="l15.194"> </span>
<a href="#l15.195"></a><span id="l15.195">   let { prefsDocument, prefsWindow } = await openNewPrefsTab(&quot;paneApplications&quot;, &quot;attachmentsOutTab&quot;);</span>
<a href="#l15.196"></a><span id="l15.196"> </span>
<a href="#l15.197"></a><span id="l15.197">   let accountList = prefsDocument.getElementById(&quot;cloudFileView&quot;);</span>
<a href="#l15.198"></a><span id="l15.198">   is(accountList.itemCount, 0);</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineat">@@ -301,17 +293,17 @@ add_task(async () =&gt; {</span>
<a href="#l15.200"></a><span id="l15.200">   let menuButton = prefsDocument.getElementById(&quot;addCloudFileAccount&quot;);</span>
<a href="#l15.201"></a><span id="l15.201">   ok(menuButton.hidden);</span>
<a href="#l15.202"></a><span id="l15.202"> </span>
<a href="#l15.203"></a><span id="l15.203">   // Add new accounts until the list overflows. The list of buttons should be hidden</span>
<a href="#l15.204"></a><span id="l15.204">   // and the button with the drop-down should appear.</span>
<a href="#l15.205"></a><span id="l15.205"> </span>
<a href="#l15.206"></a><span id="l15.206">   let count = 0;</span>
<a href="#l15.207"></a><span id="l15.207">   do {</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineminus">-    EventUtils.synthesizeMouseAtCenter(buttonList.children[1], { clickCount: 1 }, prefsWindow);</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineplus">+    EventUtils.synthesizeMouseAtCenter(buttonList.children[0], { clickCount: 1 }, prefsWindow);</span>
<a href="#l15.210"></a><span id="l15.210">     await new Promise(resolve =&gt; setTimeout(resolve));</span>
<a href="#l15.211"></a><span id="l15.211">     if (buttonList.hidden) {</span>
<a href="#l15.212"></a><span id="l15.212">       break;</span>
<a href="#l15.213"></a><span id="l15.213">     }</span>
<a href="#l15.214"></a><span id="l15.214">   } while (++count &lt; 25);</span>
<a href="#l15.215"></a><span id="l15.215"> </span>
<a href="#l15.216"></a><span id="l15.216">   ok(count &lt; 24); // If count reaches 25, we have a problem.</span>
<a href="#l15.217"></a><span id="l15.217">   ok(!menuButton.hidden);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/installer/allowed-dupes.mn</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/installer/allowed-dupes.mn</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -22,18 +22,16 @@ chrome/classic/skin/classic/messenger/ic</span>
<a href="#l16.4"></a><span id="l16.4"> chrome/classic/skin/classic/messenger/icons/security.svg</span>
<a href="#l16.5"></a><span id="l16.5"> chrome/classic/skin/classic/messenger/icons/spelling.svg</span>
<a href="#l16.6"></a><span id="l16.6"> chrome/classic/skin/classic/messenger/icons/tag.svg</span>
<a href="#l16.7"></a><span id="l16.7"> chrome/classic/skin/classic/messenger/shared/in-content/account.svg</span>
<a href="#l16.8"></a><span id="l16.8"> chrome/classic/skin/classic/messenger/shared/in-content/calendar.svg</span>
<a href="#l16.9"></a><span id="l16.9"> chrome/classic/skin/classic/messenger/shared/in-content/compose.svg</span>
<a href="#l16.10"></a><span id="l16.10"> chrome/messenger/content/branding/icon48.png</span>
<a href="#l16.11"></a><span id="l16.11"> chrome/messenger/content/branding/icon64.png</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-chrome/messenger/content/messenger/cloudfile/Box/management.js</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-chrome/messenger/content/messenger/cloudfile/Hightail/management.js</span>
<a href="#l16.14"></a><span id="l16.14"> chrome/messenger/skin/classic/messenger/messages/simple/Variants/Normal.css</span>
<a href="#l16.15"></a><span id="l16.15"> chrome/messenger/skin/classic/messenger/messages/simple/Incoming/Context.html</span>
<a href="#l16.16"></a><span id="l16.16"> chrome/messenger/skin/classic/messenger/messages/simple/Incoming/NextContext.html</span>
<a href="#l16.17"></a><span id="l16.17"> chrome/messenger/skin/classic/messenger/messages/bubbles/Bitmaps/plus.png</span>
<a href="#l16.18"></a><span id="l16.18"> chrome/messenger/skin/classic/messenger/messages/mail/Bitmaps/plus.png</span>
<a href="#l16.19"></a><span id="l16.19"> chrome/messenger/skin/classic/messenger/messages/bubbles/Bitmaps/plus-hover.png</span>
<a href="#l16.20"></a><span id="l16.20"> chrome/messenger/skin/classic/messenger/messages/mail/Bitmaps/plus-hover.png</span>
<a href="#l16.21"></a><span id="l16.21"> chrome/messenger/skin/classic/messenger/messages/bubbles/Bitmaps/minus.png</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">deleted file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/cloudfile/Box/management.dtd</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ /dev/null</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -1,6 +0,0 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">-</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineminus">-&lt;!ENTITY boxMgmt.doAuth &quot;Connect your Box account&quot;&gt;</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineminus">-&lt;!ENTITY boxMgmt.viewSettings &quot;View my account settings on box.com&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">deleted file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceeds2GB.dtd</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ /dev/null</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -1,6 +0,0 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineminus">-&lt;!ENTITY fileExceeds2GB.title   &quot;Hightail&quot;&gt;</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineminus">-&lt;!ENTITY fileExceeds2GB.cancel &quot;OK&quot;&gt;</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineminus">-&lt;!ENTITY fileExceeds2GB.description &quot;Sending files over 2GB is not supported.&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">deleted file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceedsLimit.dtd</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ /dev/null</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -1,6 +0,0 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineminus">-&lt;!ENTITY fileExceedsLimit.title   &quot;Hightail&quot;&gt;</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineminus">-&lt;!ENTITY fileExceedsLimit.thatsBigFile3 &quot;Sending files larger than 50 MB is only supported for premium accounts.&quot;&gt;</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">-&lt;!ENTITY fileExceedsLimit.style &quot;width: 40em; min-height: 20em;&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">deleted file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/fileExceedsQuota.dtd</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ /dev/null</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -1,7 +0,0 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineminus">-&lt;!ENTITY fileExceedsQuota.title   &quot;Hightail&quot;&gt;</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineminus">-&lt;!ENTITY fileExceedsQuota.storageLimitReached   &quot;Storage limit reached&quot;&gt;</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineminus">-&lt;!ENTITY fileExceedsQuota.description &quot;You have reached your account storage limit of 2GB.&quot;&gt;</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineminus">-&lt;!ENTITY fileExceedsQuota.description1 &quot;Your current storage usage is #XXX GB.&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">deleted file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/management.dtd</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ /dev/null</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -1,5 +0,0 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineminus">-&lt;!ENTITY hightailMgmt.doAuth &quot;Connect your Hightail account&quot;&gt;</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineminus">-&lt;!ENTITY hightailMgmt.viewSettings &quot;View my account settings on hightail.com&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">deleted file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/cloudfile/management.dtd</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ /dev/null</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -1,8 +0,0 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineminus">-&lt;!ENTITY cloudfileMgmt.privacyPolicy &quot;Privacy Policy&quot;&gt;</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineminus">-&lt;!ENTITY cloudfileMgmt.termsOfService &quot;Terms of Service&quot;&gt;</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineminus">-&lt;!ENTITY cloudfileMgmt.usedSpace &quot;Used Space:&quot;&gt;</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineminus">-&lt;!ENTITY cloudfileMgmt.unusedSpace &quot;Unused Space:&quot;&gt;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-&lt;!ENTITY cloudfileMgmt.upgradeOffer &quot;Get more space&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/locales/jar.mn</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/locales/jar.mn</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -139,22 +139,16 @@</span>
<a href="#l23.4"></a><span id="l23.4">   locale/@AB_CD@/messenger/addressbook/abCard.dtd                       (%chrome/messenger/addressbook/abCard.dtd)</span>
<a href="#l23.5"></a><span id="l23.5">   locale/@AB_CD@/messenger/addressbook/abResultsPane.dtd                (%chrome/messenger/addressbook/abResultsPane.dtd)</span>
<a href="#l23.6"></a><span id="l23.6">   locale/@AB_CD@/messenger/addressbook/abMailListDialog.dtd             (%chrome/messenger/addressbook/abMailListDialog.dtd)</span>
<a href="#l23.7"></a><span id="l23.7">   locale/@AB_CD@/messenger/addressbook/addressBook.properties           (%chrome/messenger/addressbook/addressBook.properties)</span>
<a href="#l23.8"></a><span id="l23.8">   locale/@AB_CD@/messenger/addressbook/ldapAutoCompErrs.properties      (%chrome/messenger/addressbook/ldapAutoCompErrs.properties)</span>
<a href="#l23.9"></a><span id="l23.9">   locale/@AB_CD@/messenger/addressbook/pref-directory.dtd               (%chrome/messenger/addressbook/pref-directory.dtd)</span>
<a href="#l23.10"></a><span id="l23.10">   locale/@AB_CD@/messenger/addressbook/pref-directory-add.dtd           (%chrome/messenger/addressbook/pref-directory-add.dtd)</span>
<a href="#l23.11"></a><span id="l23.11">   locale/@AB_CD@/messenger/addressbook/replicationProgress.properties   (%chrome/messenger/addressbook/replicationProgress.properties)</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  locale/@AB_CD@/messenger/cloudfile/management.dtd                     (%chrome/messenger/cloudfile/management.dtd)</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-  locale/@AB_CD@/messenger/cloudfile/Hightail/management.dtd           (%chrome/messenger/cloudfile/Hightail/management.dtd)</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-  locale/@AB_CD@/messenger/cloudfile/Hightail/fileExceedsLimit.dtd     (%chrome/messenger/cloudfile/Hightail/fileExceedsLimit.dtd)</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-  locale/@AB_CD@/messenger/cloudfile/Hightail/fileExceedsQuota.dtd     (%chrome/messenger/cloudfile/Hightail/fileExceedsQuota.dtd)</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-  locale/@AB_CD@/messenger/cloudfile/Hightail/fileExceeds2GB.dtd       (%chrome/messenger/cloudfile/Hightail/fileExceeds2GB.dtd)</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-  locale/@AB_CD@/messenger/cloudfile/Box/management.dtd                 (%chrome/messenger/cloudfile/Box/management.dtd)</span>
<a href="#l23.18"></a><span id="l23.18">   locale/@AB_CD@/messenger/messengercompose/messengercompose.dtd        (%chrome/messenger/messengercompose/messengercompose.dtd)</span>
<a href="#l23.19"></a><span id="l23.19">   locale/@AB_CD@/messenger/messengercompose/askSendFormat.dtd           (%chrome/messenger/messengercompose/askSendFormat.dtd)</span>
<a href="#l23.20"></a><span id="l23.20">   locale/@AB_CD@/messenger/messengercompose/askSendFormat.properties    (%chrome/messenger/messengercompose/askSendFormat.properties)</span>
<a href="#l23.21"></a><span id="l23.21">   locale/@AB_CD@/messenger/messengercompose/sendProgress.dtd            (%chrome/messenger/messengercompose/sendProgress.dtd)</span>
<a href="#l23.22"></a><span id="l23.22">   locale/@AB_CD@/messenger/messengercompose/sendProgress.properties     (%chrome/messenger/messengercompose/sendProgress.properties)</span>
<a href="#l23.23"></a><span id="l23.23">   locale/@AB_CD@/messenger/messengercompose/composeMsgs.properties      (%chrome/messenger/messengercompose/composeMsgs.properties)</span>
<a href="#l23.24"></a><span id="l23.24">   locale/@AB_CD@/messenger/messengercompose/mailComposeEditorOverlay.dtd (%chrome/messenger/messengercompose/mailComposeEditorOverlay.dtd)</span>
<a href="#l23.25"></a><span id="l23.25">   locale/@AB_CD@/messenger/preferences/preferences.dtd                  (%chrome/messenger/preferences/preferences.dtd)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">deleted file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineplus">+++ /dev/null</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineat">@@ -1,321 +0,0 @@</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineminus">-  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineminus">-</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineminus">-/**</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineminus">- * Tests the Hightail Bigfile backend.</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineminus">- */</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-var MODULE_NAME = &quot;test-cloudfile-backend-hightail&quot;;</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineminus">-                         &quot;compose-helpers&quot;,</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-                         &quot;cloudfile-helpers&quot;,</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-                         &quot;cloudfile-backend-helpers&quot;,</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-                         &quot;cloudfile-hightail-helpers&quot;,</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-                         &quot;observer-helpers&quot;,</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-                         &quot;prompt-helpers&quot;,];</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineminus">-</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineminus">-var gServer, gObsManager;</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineminus">-</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-function setupModule(module) {</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-  for (let lib of MODULE_REQUIRES) {</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-    collector.getModule(lib).installInto(module);</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-  }</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineminus">-  gObsManager = new SimpleRequestObserverManager();</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineminus">-</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineminus">-  // Enable logging for this group of tests.</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineminus">-  Services.prefs.setCharPref(&quot;Hightail.logging.dump&quot;, &quot;All&quot;);</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-}</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">-  Services.prefs.clearUserPref(&quot;Hightail.logging.dump&quot;);</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-}</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">-</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">-function setupTest() {</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-  gServer = new MockHightailServer();</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">-  gServer.init();</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-  gServer.start();</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">-}</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineminus">-</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineminus">-function teardownTest() {</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineminus">-  for (let account of cloudFileAccounts.accounts) {</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineminus">-    cloudFileAccounts.removeAccount(account);</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineminus">-  }</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineminus">-</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-  gObsManager.check();</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineminus">-  gObsManager.reset();</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineminus">-  gServer.stop(mc);</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineminus">-}</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-function test_simple_case() {</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineminus">-  const kExpectedUrl = &quot;http://www.example.com/expectedUrl&quot;;</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineminus">-  const kTopics = [kUploadFile, kGetFileURL];</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineminus">-</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-  gServer.planForUploadFile(&quot;testFile1&quot;);</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineminus">-  gServer.planForGetFileURL(&quot;testFile1&quot;, {url: kExpectedUrl});</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineminus">-</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineminus">-  let obs = new ObservationRecorder();</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-  for (let topic of kTopics) {</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineminus">-    obs.planFor(topic);</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineminus">-    Services.obs.addObserver(obs, topic);</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineminus">-  }</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineminus">-</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineminus">-  let uploadComplete = false;</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineminus">-  let file = getFile(&quot;./data/testFile1&quot;, __file__);</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineminus">-  provider.uploadFile(file).then(() =&gt; {</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineminus">-    uploadComplete = true;</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineminus">-  });</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineminus">-</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineminus">-  mc.waitFor(() =&gt; uploadComplete);</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineminus">-</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineminus">-  let urlForFile = provider.urlForFile(file);</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineminus">-  assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineminus">-  assert_equals(1, obs.numSightings(kUploadFile));</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineminus">-  assert_equals(1, obs.numSightings(kGetFileURL));</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineminus">-</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineminus">-  uploadComplete = false;</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineminus">-  gServer.planForUploadFile(&quot;testFile1&quot;);</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineminus">-  gServer.planForGetFileURL(&quot;testFile1&quot;, {url: kExpectedUrl});</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineminus">-  provider.uploadFile(file).then(() =&gt; {</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineminus">-    uploadComplete = true;</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineminus">-  });</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineminus">-  mc.waitFor(() =&gt; uploadComplete);</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineminus">-  urlForFile = provider.urlForFile(file);</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineminus">-  assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineminus">-</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineminus">-  assert_equals(2, obs.numSightings(kUploadFile));</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineminus">-  assert_equals(2, obs.numSightings(kGetFileURL));</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineminus">-</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineminus">-  for (let topic of kTopics) {</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineminus">-    Services.obs.removeObserver(obs, topic);</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineminus">-  }</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineminus">-}</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineminus">-</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineminus">-function test_chained_uploads() {</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineminus">-  const kExpectedUrlRoot = &quot;http://www.example.com/&quot;;</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineminus">-  const kTopics = [kUploadFile, kGetFileURL];</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineminus">-  const kFilenames = [&quot;testFile1&quot;, &quot;testFile2&quot;, &quot;testFile3&quot;];</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineminus">-</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineminus">-  for (let filename of kFilenames) {</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineminus">-    let expectedUrl = kExpectedUrlRoot + filename;</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineminus">-    gServer.planForUploadFile(filename);</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineminus">-    gServer.planForGetFileURL(filename, {url: expectedUrl});</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineminus">-  }</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineminus">-</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineminus">-  let obs = new ObservationRecorder();</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineminus">-  for (let topic of kTopics) {</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineminus">-    obs.planFor(topic);</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineminus">-    Services.obs.addObserver(obs, topic);</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineminus">-  }</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineminus">-</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineminus">-</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineminus">-  let files = [];</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineminus">-</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineminus">-  let observers = kFilenames.map(function(aFilename) {</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineminus">-    let requestObserver = { success: false };</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineminus">-    let file = getFile(&quot;./data/&quot; + aFilename, __file__);</span>
<a href="#l24.131"></a><span id="l24.131" class="difflineminus">-    files.push(file);</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineminus">-    provider.uploadFile(file).then(() =&gt; {</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineminus">-      requestObserver.success = true;</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineminus">-    });</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineminus">-    return requestObserver;</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineminus">-  });</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineminus">-</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineminus">-  mc.waitFor(function() {</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineminus">-    return observers.every(aListener =&gt; aListener.success);</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineminus">-  }, &quot;Timed out waiting for chained uploads to complete.&quot;, 10000);</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineminus">-</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineminus">-  assert_equals(kFilenames.length, obs.numSightings(kUploadFile));</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineminus">-</span>
<a href="#l24.144"></a><span id="l24.144" class="difflineminus">-  for (let [index, filename] of kFilenames.entries()) {</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineminus">-    assert_equals(obs.data[kUploadFile][index], filename);</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineminus">-    let file = getFile(&quot;./data/&quot; + filename, __file__);</span>
<a href="#l24.147"></a><span id="l24.147" class="difflineminus">-    let expectedUriForFile = kExpectedUrlRoot + filename;</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineminus">-    let uriForFile = provider.urlForFile(files[index]);</span>
<a href="#l24.149"></a><span id="l24.149" class="difflineminus">-    assert_equals(expectedUriForFile, uriForFile);</span>
<a href="#l24.150"></a><span id="l24.150" class="difflineminus">-  }</span>
<a href="#l24.151"></a><span id="l24.151" class="difflineminus">-</span>
<a href="#l24.152"></a><span id="l24.152" class="difflineminus">-  assert_equals(kFilenames.length, obs.numSightings(kGetFileURL));</span>
<a href="#l24.153"></a><span id="l24.153" class="difflineminus">-</span>
<a href="#l24.154"></a><span id="l24.154" class="difflineminus">-  for (let topic of kTopics) {</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineminus">-    Services.obs.removeObserver(obs, topic);</span>
<a href="#l24.156"></a><span id="l24.156" class="difflineminus">-  }</span>
<a href="#l24.157"></a><span id="l24.157" class="difflineminus">-}</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineminus">-</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineminus">-function test_deleting_uploads() {</span>
<a href="#l24.160"></a><span id="l24.160" class="difflineminus">-  const kFilename = &quot;testFile1&quot;;</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineminus">-  // Upload a file</span>
<a href="#l24.163"></a><span id="l24.163" class="difflineminus">-</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineminus">-  let file = getFile(&quot;./data/&quot; + kFilename, __file__);</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineminus">-  gServer.planForUploadFile(kFilename);</span>
<a href="#l24.166"></a><span id="l24.166" class="difflineminus">-  let uploadComplete = false;</span>
<a href="#l24.167"></a><span id="l24.167" class="difflineminus">-  provider.uploadFile(file).then(() =&gt; {</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineminus">-    uploadComplete = true;</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineminus">-  });</span>
<a href="#l24.170"></a><span id="l24.170" class="difflineminus">-  mc.waitFor(() =&gt; uploadComplete);</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineminus">-</span>
<a href="#l24.172"></a><span id="l24.172" class="difflineminus">-  // Try deleting a file</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineminus">-  let obs = new ObservationRecorder();</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineminus">-  obs.planFor(kDeleteFile);</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineminus">-  Services.obs.addObserver(obs, kDeleteFile);</span>
<a href="#l24.176"></a><span id="l24.176" class="difflineminus">-</span>
<a href="#l24.177"></a><span id="l24.177" class="difflineminus">-  gServer.planForDeleteFile(kFilename);</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineminus">-  let deleteObserver = gObsManager.create(&quot;test_deleting_uploads - delete 1&quot;);</span>
<a href="#l24.179"></a><span id="l24.179" class="difflineminus">-  provider.deleteFile(file, deleteObserver);</span>
<a href="#l24.180"></a><span id="l24.180" class="difflineminus">-  mc.waitFor(() =&gt; deleteObserver.success);</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineminus">-</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineminus">-  // Check to make sure the file was deleted on the server</span>
<a href="#l24.183"></a><span id="l24.183" class="difflineminus">-  assert_equals(1, obs.numSightings(kDeleteFile));</span>
<a href="#l24.184"></a><span id="l24.184" class="difflineminus">-  assert_equals(obs.data[kDeleteFile][0], kFilename);</span>
<a href="#l24.185"></a><span id="l24.185" class="difflineminus">-  Services.obs.removeObserver(obs, kDeleteFile);</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineminus">-}</span>
<a href="#l24.187"></a><span id="l24.187" class="difflineminus">-</span>
<a href="#l24.188"></a><span id="l24.188" class="difflineminus">-/**</span>
<a href="#l24.189"></a><span id="l24.189" class="difflineminus">- * Test that cancelling an upload causes onStopRequest to be</span>
<a href="#l24.190"></a><span id="l24.190" class="difflineminus">- * called with cloudFileAccounts.constants.uploadCancelled.</span>
<a href="#l24.191"></a><span id="l24.191" class="difflineminus">- */</span>
<a href="#l24.192"></a><span id="l24.192" class="difflineminus">-function test_can_cancel_upload() {</span>
<a href="#l24.193"></a><span id="l24.193" class="difflineminus">-  const kFilename = &quot;testFile1&quot;;</span>
<a href="#l24.194"></a><span id="l24.194" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;anAccount&quot;);</span>
<a href="#l24.195"></a><span id="l24.195" class="difflineminus">-  let file = getFile(&quot;./data/&quot; + kFilename, __file__);</span>
<a href="#l24.196"></a><span id="l24.196" class="difflineminus">-  gServer.planForUploadFile(kFilename, 2000);</span>
<a href="#l24.197"></a><span id="l24.197" class="difflineminus">-  assert_can_cancel_uploads(mc, provider, [file]);</span>
<a href="#l24.198"></a><span id="l24.198" class="difflineminus">-}</span>
<a href="#l24.199"></a><span id="l24.199" class="difflineminus">-</span>
<a href="#l24.200"></a><span id="l24.200" class="difflineminus">-/**</span>
<a href="#l24.201"></a><span id="l24.201" class="difflineminus">- * Test that cancelling several uploads causes onStopRequest to be</span>
<a href="#l24.202"></a><span id="l24.202" class="difflineminus">- * called with cloudFileAccounts.constants.uploadCancelled.</span>
<a href="#l24.203"></a><span id="l24.203" class="difflineminus">- */</span>
<a href="#l24.204"></a><span id="l24.204" class="difflineminus">-function test_can_cancel_uploads() {</span>
<a href="#l24.205"></a><span id="l24.205" class="difflineminus">-  const kFiles = [&quot;testFile2&quot;, &quot;testFile3&quot;, &quot;testFile4&quot;];</span>
<a href="#l24.206"></a><span id="l24.206" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;anAccount&quot;);</span>
<a href="#l24.207"></a><span id="l24.207" class="difflineminus">-  let files = [];</span>
<a href="#l24.208"></a><span id="l24.208" class="difflineminus">-  for (let filename of kFiles) {</span>
<a href="#l24.209"></a><span id="l24.209" class="difflineminus">-    gServer.planForUploadFile(filename, 2000);</span>
<a href="#l24.210"></a><span id="l24.210" class="difflineminus">-    files.push(getFile(&quot;./data/&quot; + filename, __file__));</span>
<a href="#l24.211"></a><span id="l24.211" class="difflineminus">-  }</span>
<a href="#l24.212"></a><span id="l24.212" class="difflineminus">-  assert_can_cancel_uploads(mc, provider, files);</span>
<a href="#l24.213"></a><span id="l24.213" class="difflineminus">-}</span>
<a href="#l24.214"></a><span id="l24.214" class="difflineminus">-</span>
<a href="#l24.215"></a><span id="l24.215" class="difflineminus">-/**</span>
<a href="#l24.216"></a><span id="l24.216" class="difflineminus">- * Test that when we call createExistingAccount, onStopRequest is successfully</span>
<a href="#l24.217"></a><span id="l24.217" class="difflineminus">- * called, and we pass the correct parameters.</span>
<a href="#l24.218"></a><span id="l24.218" class="difflineminus">- */</span>
<a href="#l24.219"></a><span id="l24.219" class="difflineminus">-function test_create_existing_account() {</span>
<a href="#l24.220"></a><span id="l24.220" class="difflineminus">-  // We have to mock out the auth prompter, or else we'll lock up.</span>
<a href="#l24.221"></a><span id="l24.221" class="difflineminus">-  gMockAuthPromptReg.register();</span>
<a href="#l24.222"></a><span id="l24.222" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someNewAccount&quot;);</span>
<a href="#l24.223"></a><span id="l24.223" class="difflineminus">-  let done = false;</span>
<a href="#l24.224"></a><span id="l24.224" class="difflineminus">-  let myObs = {</span>
<a href="#l24.225"></a><span id="l24.225" class="difflineminus">-    onStartRequest(aRequest) {</span>
<a href="#l24.226"></a><span id="l24.226" class="difflineminus">-    },</span>
<a href="#l24.227"></a><span id="l24.227" class="difflineminus">-    onStopRequest(aRequest, aStatusCode) {</span>
<a href="#l24.228"></a><span id="l24.228" class="difflineminus">-      assert_equals(aStatusCode, Cr.NS_OK);</span>
<a href="#l24.229"></a><span id="l24.229" class="difflineminus">-      done = true;</span>
<a href="#l24.230"></a><span id="l24.230" class="difflineminus">-    },</span>
<a href="#l24.231"></a><span id="l24.231" class="difflineminus">-  };</span>
<a href="#l24.232"></a><span id="l24.232" class="difflineminus">-</span>
<a href="#l24.233"></a><span id="l24.233" class="difflineminus">-  provider.createExistingAccount(myObs);</span>
<a href="#l24.234"></a><span id="l24.234" class="difflineminus">-  mc.waitFor(() =&gt; done);</span>
<a href="#l24.235"></a><span id="l24.235" class="difflineminus">-  gMockAuthPromptReg.unregister();</span>
<a href="#l24.236"></a><span id="l24.236" class="difflineminus">-}</span>
<a href="#l24.237"></a><span id="l24.237" class="difflineminus">-</span>
<a href="#l24.238"></a><span id="l24.238" class="difflineminus">-function test_delete_refreshes_stale_token() {</span>
<a href="#l24.239"></a><span id="l24.239" class="difflineminus">-  const kFilename = &quot;testFile1&quot;;</span>
<a href="#l24.240"></a><span id="l24.240" class="difflineminus">-  const kUserEmail = &quot;test@example.com&quot;;</span>
<a href="#l24.241"></a><span id="l24.241" class="difflineminus">-</span>
<a href="#l24.242"></a><span id="l24.242" class="difflineminus">-  // Stop the default Hightail mock server, and create our own.</span>
<a href="#l24.243"></a><span id="l24.243" class="difflineminus">-  gServer.stop(mc);</span>
<a href="#l24.244"></a><span id="l24.244" class="difflineminus">-  gServer = new MockHightailServer();</span>
<a href="#l24.245"></a><span id="l24.245" class="difflineminus">-  // Replace the auth component with one that counts auth</span>
<a href="#l24.246"></a><span id="l24.246" class="difflineminus">-  // requests.</span>
<a href="#l24.247"></a><span id="l24.247" class="difflineminus">-  gServer.auth = new MockHightailAuthCounter(gServer);</span>
<a href="#l24.248"></a><span id="l24.248" class="difflineminus">-  // Replace the deleter component with one that returns the</span>
<a href="#l24.249"></a><span id="l24.249" class="difflineminus">-  // stale token error.</span>
<a href="#l24.250"></a><span id="l24.250" class="difflineminus">-  gServer.deleter = new MockHightailDeleterStaleToken(gServer);</span>
<a href="#l24.251"></a><span id="l24.251" class="difflineminus">-  // Fire up the server.</span>
<a href="#l24.252"></a><span id="l24.252" class="difflineminus">-  gServer.init();</span>
<a href="#l24.253"></a><span id="l24.253" class="difflineminus">-  gServer.start();</span>
<a href="#l24.254"></a><span id="l24.254" class="difflineminus">-</span>
<a href="#l24.255"></a><span id="l24.255" class="difflineminus">-  gServer.setupUser({email: kUserEmail});</span>
<a href="#l24.256"></a><span id="l24.256" class="difflineminus">-</span>
<a href="#l24.257"></a><span id="l24.257" class="difflineminus">-  // We're testing to make sure that we refresh on stale tokens</span>
<a href="#l24.258"></a><span id="l24.258" class="difflineminus">-  // iff a password has been remembered for the user, so make</span>
<a href="#l24.259"></a><span id="l24.259" class="difflineminus">-  // sure we remember a password...</span>
<a href="#l24.260"></a><span id="l24.260" class="difflineminus">-  remember_hightail_credentials(kUserEmail, &quot;somePassword&quot;);</span>
<a href="#l24.261"></a><span id="l24.261" class="difflineminus">-</span>
<a href="#l24.262"></a><span id="l24.262" class="difflineminus">-  // Get a prepared provider...</span>
<a href="#l24.263"></a><span id="l24.263" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l24.264"></a><span id="l24.264" class="difflineminus">-  let file = getFile(&quot;./data/&quot; + kFilename, __file__);</span>
<a href="#l24.265"></a><span id="l24.265" class="difflineminus">-  gServer.planForUploadFile(kFilename);</span>
<a href="#l24.266"></a><span id="l24.266" class="difflineminus">-  let uploadComplete = false</span>
<a href="#l24.267"></a><span id="l24.267" class="difflineminus">-  provider.uploadFile(file).then(() =&gt; {</span>
<a href="#l24.268"></a><span id="l24.268" class="difflineminus">-    uploadComplete = true;</span>
<a href="#l24.269"></a><span id="l24.269" class="difflineminus">-  });</span>
<a href="#l24.270"></a><span id="l24.270" class="difflineminus">-  mc.waitFor(() =&gt; uploadComplete);</span>
<a href="#l24.271"></a><span id="l24.271" class="difflineminus">-</span>
<a href="#l24.272"></a><span id="l24.272" class="difflineminus">-  // At this point, we should not have seen any auth attempts.</span>
<a href="#l24.273"></a><span id="l24.273" class="difflineminus">-  assert_equals(gServer.auth.count, 0,</span>
<a href="#l24.274"></a><span id="l24.274" class="difflineminus">-                &quot;Should not have seen any authorization attempts yet&quot;);</span>
<a href="#l24.275"></a><span id="l24.275" class="difflineminus">-</span>
<a href="#l24.276"></a><span id="l24.276" class="difflineminus">-  // Now delete the file, and get the stale auth token warning.</span>
<a href="#l24.277"></a><span id="l24.277" class="difflineminus">-  gServer.planForDeleteFile(kFilename);</span>
<a href="#l24.278"></a><span id="l24.278" class="difflineminus">-  // We have to pass an observer, so we'll just generate a dummy one.</span>
<a href="#l24.279"></a><span id="l24.279" class="difflineminus">-  let deleteObserver = new SimpleRequestObserver();</span>
<a href="#l24.280"></a><span id="l24.280" class="difflineminus">-  provider.deleteFile(file, deleteObserver);</span>
<a href="#l24.281"></a><span id="l24.281" class="difflineminus">-</span>
<a href="#l24.282"></a><span id="l24.282" class="difflineminus">-  // Now, since the token was stale, we should see us hit authentication</span>
<a href="#l24.283"></a><span id="l24.283" class="difflineminus">-  // again.</span>
<a href="#l24.284"></a><span id="l24.284" class="difflineminus">-  mc.waitFor(() =&gt; gServer.auth.count &gt; 0,</span>
<a href="#l24.285"></a><span id="l24.285" class="difflineminus">-             &quot;Timed out waiting for authorization attempt&quot;);</span>
<a href="#l24.286"></a><span id="l24.286" class="difflineminus">-}</span>
<a href="#l24.287"></a><span id="l24.287" class="difflineminus">-</span>
<a href="#l24.288"></a><span id="l24.288" class="difflineminus">-/**</span>
<a href="#l24.289"></a><span id="l24.289" class="difflineminus">- * Test for bug 771132 - if Hightail returns malformed URLs, prefix with</span>
<a href="#l24.290"></a><span id="l24.290" class="difflineminus">- * https://.</span>
<a href="#l24.291"></a><span id="l24.291" class="difflineminus">- */</span>
<a href="#l24.292"></a><span id="l24.292" class="difflineminus">-function test_bug771132_fix_no_scheme() {</span>
<a href="#l24.293"></a><span id="l24.293" class="difflineminus">-  const kMalformedUrl = &quot;www.example.com/download/abcd1234&quot;;</span>
<a href="#l24.294"></a><span id="l24.294" class="difflineminus">-  const kExpectedUrl = &quot;https://&quot; + kMalformedUrl;</span>
<a href="#l24.295"></a><span id="l24.295" class="difflineminus">-</span>
<a href="#l24.296"></a><span id="l24.296" class="difflineminus">-  const kTopics = [kUploadFile, kGetFileURL];</span>
<a href="#l24.297"></a><span id="l24.297" class="difflineminus">-</span>
<a href="#l24.298"></a><span id="l24.298" class="difflineminus">-  gServer.planForUploadFile(&quot;testFile1&quot;);</span>
<a href="#l24.299"></a><span id="l24.299" class="difflineminus">-  gServer.planForGetFileURL(&quot;testFile1&quot;, {url: kMalformedUrl});</span>
<a href="#l24.300"></a><span id="l24.300" class="difflineminus">-</span>
<a href="#l24.301"></a><span id="l24.301" class="difflineminus">-  let uploadComplete = false;</span>
<a href="#l24.302"></a><span id="l24.302" class="difflineminus">-  let file = getFile(&quot;./data/testFile1&quot;, __file__);</span>
<a href="#l24.303"></a><span id="l24.303" class="difflineminus">-  let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l24.304"></a><span id="l24.304" class="difflineminus">-  provider.uploadFile(file).then(() =&gt; {</span>
<a href="#l24.305"></a><span id="l24.305" class="difflineminus">-    uploadComplete = true;</span>
<a href="#l24.306"></a><span id="l24.306" class="difflineminus">-  });</span>
<a href="#l24.307"></a><span id="l24.307" class="difflineminus">-</span>
<a href="#l24.308"></a><span id="l24.308" class="difflineminus">-  mc.waitFor(() =&gt; uploadComplete);</span>
<a href="#l24.309"></a><span id="l24.309" class="difflineminus">-</span>
<a href="#l24.310"></a><span id="l24.310" class="difflineminus">-  let urlForFile = provider.urlForFile(file);</span>
<a href="#l24.311"></a><span id="l24.311" class="difflineminus">-  assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l24.312"></a><span id="l24.312" class="difflineminus">-</span>
<a href="#l24.313"></a><span id="l24.313" class="difflineminus">-  // Now make sure that we don't accidentally prefix with https when there's</span>
<a href="#l24.314"></a><span id="l24.314" class="difflineminus">-  // already a scheme.</span>
<a href="#l24.315"></a><span id="l24.315" class="difflineminus">-  gServer.planForUploadFile(&quot;testFile1&quot;);</span>
<a href="#l24.316"></a><span id="l24.316" class="difflineminus">-  gServer.planForGetFileURL(&quot;testFile1&quot;, {url: kExpectedUrl});</span>
<a href="#l24.317"></a><span id="l24.317" class="difflineminus">-  uploadComplete = false;</span>
<a href="#l24.318"></a><span id="l24.318" class="difflineminus">-  provider.uploadFile(file).then(() =&gt; {</span>
<a href="#l24.319"></a><span id="l24.319" class="difflineminus">-    uploadComplete = true;</span>
<a href="#l24.320"></a><span id="l24.320" class="difflineminus">-  });</span>
<a href="#l24.321"></a><span id="l24.321" class="difflineminus">-  mc.waitFor(() =&gt; uploadComplete);</span>
<a href="#l24.322"></a><span id="l24.322" class="difflineminus">-</span>
<a href="#l24.323"></a><span id="l24.323" class="difflineminus">-  urlForFile = provider.urlForFile(file);</span>
<a href="#l24.324"></a><span id="l24.324" class="difflineminus">-  assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l24.325"></a><span id="l24.325" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -12,17 +12,17 @@ var MODULE_REQUIRES = [&quot;folder-display-h</span>
<a href="#l25.4"></a><span id="l25.4"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l25.5"></a><span id="l25.5"> var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l25.6"></a><span id="l25.6"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8"> var kMockContractIDPrefix = &quot;@mozilla.org/mail/mockCloudFile;1?id=&quot;;</span>
<a href="#l25.9"></a><span id="l25.9"> </span>
<a href="#l25.10"></a><span id="l25.10"> var kDefaults = {</span>
<a href="#l25.11"></a><span id="l25.11">   type: &quot;default&quot;,</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  iconURL: &quot;chrome://messenger/skin/icons/box-logo.png&quot;,</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+  iconURL: &quot;chrome://messenger/content/extension.svg&quot;,</span>
<a href="#l25.14"></a><span id="l25.14">   accountKey: null,</span>
<a href="#l25.15"></a><span id="l25.15">   settingsURL: &quot;&quot;,</span>
<a href="#l25.16"></a><span id="l25.16">   managementURL: &quot;&quot;,</span>
<a href="#l25.17"></a><span id="l25.17">   authErr: cloudFileAccounts.constants.authErr,</span>
<a href="#l25.18"></a><span id="l25.18">   offlineErr: cloudFileAccounts.constants.offlineErr,</span>
<a href="#l25.19"></a><span id="l25.19">   uploadErr: cloudFileAccounts.constants.uploadErr,</span>
<a href="#l25.20"></a><span id="l25.20">   uploadWouldExceedQuota: cloudFileAccounts.constants.uploadWouldExceedQuota,</span>
<a href="#l25.21"></a><span id="l25.21">   uploadExceedsFileLimit: cloudFileAccounts.constants.uploadExceedsFileLimit,</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineat">@@ -108,17 +108,17 @@ var gMockCloudfileManager = {</span>
<a href="#l25.23"></a><span id="l25.23">       aID = &quot;default&quot;;</span>
<a href="#l25.24"></a><span id="l25.24"> </span>
<a href="#l25.25"></a><span id="l25.25">     if (!aOverrides)</span>
<a href="#l25.26"></a><span id="l25.26">       aOverrides = {};</span>
<a href="#l25.27"></a><span id="l25.27"> </span>
<a href="#l25.28"></a><span id="l25.28">     cloudFileAccounts.registerProvider(aID, {</span>
<a href="#l25.29"></a><span id="l25.29">       type: aID,</span>
<a href="#l25.30"></a><span id="l25.30">       displayName: aID,</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-      iconURL: &quot;chrome://messenger/skin/icons/box-logo.png&quot;,</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+      iconURL: &quot;chrome://messenger/content/extension.svg&quot;,</span>
<a href="#l25.33"></a><span id="l25.33">       initAccount(accountKey) {</span>
<a href="#l25.34"></a><span id="l25.34">         let account = new MockCloudfileAccount();</span>
<a href="#l25.35"></a><span id="l25.35"> </span>
<a href="#l25.36"></a><span id="l25.36">         for (let someDefault in kDefaults)</span>
<a href="#l25.37"></a><span id="l25.37">           account[someDefault] = kDefaults[someDefault];</span>
<a href="#l25.38"></a><span id="l25.38"> </span>
<a href="#l25.39"></a><span id="l25.39">         for (let override in aOverrides)</span>
<a href="#l25.40"></a><span id="l25.40">           account[override] = aOverrides[override];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">deleted file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ /dev/null</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -1,795 +0,0 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineminus">-</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineminus">-</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineminus">-var MODULE_NAME = &quot;cloudfile-hightail-helpers&quot;;</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-var {HttpServer} = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/httpd.jsm&quot;);</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-var kDefaultServerPort = 4444;</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineminus">-var kServerRoot = &quot;http://localhost:&quot; + kDefaultServerPort;</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineminus">-var kServerPath = &quot;&quot;;</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineminus">-var kServerURL = kServerRoot + kServerPath;</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-var kAuthPath = &quot;/dpi/v1/auth&quot;;</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-var kUserInfoPath = &quot;/dpi/v2/user&quot;;</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-var kFolderPath = &quot;/dpi/v1/folder/&quot;;</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-var kFolderInitUploadPath = kFolderPath + &quot;file/initUpload&quot;;</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineminus">-var kFolderCommitUploadPath = kFolderPath + &quot;file/commitUpload&quot;;</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineminus">-var kDeletePath = kFolderPath + &quot;file&quot;;</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineminus">-var kDefaultFileUploadPath = &quot;/uploads&quot;;</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineminus">-var kDownloadURLPrefix = &quot;http://www.example.com/downloads&quot;;</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineminus">-</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineminus">-var kAuthResult = {</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-  authToken: &quot;someAuthToken&quot;,</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-  errorStatus: null,</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-};</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-var kDefaultConfig = {</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-  port: kDefaultServerPort,</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-};</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineminus">-</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineminus">-var kDefaultReturnHeader = {</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineminus">-  statusCode: 200,</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineminus">-  statusString: &quot;OK&quot;,</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineminus">-  contentType: &quot;text/plain&quot;,</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineminus">-};</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineminus">-</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineminus">-var kDefaultUser = {</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineminus">-  key: null,</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineminus">-  id: null,</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineminus">-  type: &quot;BAS&quot;,</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineminus">-  policy: null,</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-  version: &quot;v3&quot;,</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-  password: null,</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineminus">-  role: null,</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineminus">-  email: &quot;john@example.com&quot;,</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-  firstname: &quot;John&quot;,</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-  lastname: &quot;User&quot;,</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineminus">-  created: null,</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineminus">-  account: {</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineminus">-    passwordProtect: &quot;Pay-per-use&quot;,</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineminus">-    returnReceipt: &quot;Pay-per-use&quot;,</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineminus">-    availableStorage: &quot;2147483648&quot;,</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineminus">-    billingPlan: null,</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineminus">-    controlExpirationDate: null,</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineminus">-    dropboxUrl: null,</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineminus">-    knowledgeBase: &quot;Yes&quot;,</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineminus">-    maxDownloadBWpermonth: &quot;1073741824&quot;,</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineminus">-    maxFileDownloads: &quot;100&quot;,</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineminus">-    maxFileSize: &quot;104857600&quot;,</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineminus">-    premiumDelivery: null,</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineminus">-    verifyRecipientIdentity: &quot;Included&quot;,</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineminus">-  },</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineminus">-  storage: {</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineminus">-    currentUsage: 1045,</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineminus">-    storageQuota: 2147483648,</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineminus">-  },</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineminus">-  status: null,</span>
<a href="#l26.76"></a><span id="l26.76" class="difflineminus">-  errorStatus: null,</span>
<a href="#l26.77"></a><span id="l26.77" class="difflineminus">-};</span>
<a href="#l26.78"></a><span id="l26.78" class="difflineminus">-</span>
<a href="#l26.79"></a><span id="l26.79" class="difflineminus">-var kDefaultFilePrepare = {</span>
<a href="#l26.80"></a><span id="l26.80" class="difflineminus">-  fileId: &quot;&quot;,</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineminus">-  uploadUrl: [</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineminus">-  ],</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineminus">-  status: null,</span>
<a href="#l26.84"></a><span id="l26.84" class="difflineminus">-  errorStatus: null,</span>
<a href="#l26.85"></a><span id="l26.85" class="difflineminus">-};</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineminus">-</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineminus">-var kDefaultCommitReturn = {</span>
<a href="#l26.88"></a><span id="l26.88" class="difflineminus">-  clickableDownloadUrl: &quot;&quot;,</span>
<a href="#l26.89"></a><span id="l26.89" class="difflineminus">-  errorStatus: null,</span>
<a href="#l26.90"></a><span id="l26.90" class="difflineminus">-};</span>
<a href="#l26.91"></a><span id="l26.91" class="difflineminus">-</span>
<a href="#l26.92"></a><span id="l26.92" class="difflineminus">-function installInto(module) {</span>
<a href="#l26.93"></a><span id="l26.93" class="difflineminus">-  module.MockHightailServer = MockHightailServer;</span>
<a href="#l26.94"></a><span id="l26.94" class="difflineminus">-  module.MockHightailAuthCounter = MockHightailAuthCounter;</span>
<a href="#l26.95"></a><span id="l26.95" class="difflineminus">-  module.MockHightailDeleterStaleToken = MockHightailDeleterStaleToken;</span>
<a href="#l26.96"></a><span id="l26.96" class="difflineminus">-  module.remember_hightail_credentials = remember_hightail_credentials;</span>
<a href="#l26.97"></a><span id="l26.97" class="difflineminus">-}</span>
<a href="#l26.98"></a><span id="l26.98" class="difflineminus">-</span>
<a href="#l26.99"></a><span id="l26.99" class="difflineminus">-function MockHightailServer() {</span>
<a href="#l26.100"></a><span id="l26.100" class="difflineminus">-  this.auth = new MockHightailAuthSimple(this);</span>
<a href="#l26.101"></a><span id="l26.101" class="difflineminus">-  this.userInfo = new MockHightailUserInfoSimple(this);</span>
<a href="#l26.102"></a><span id="l26.102" class="difflineminus">-  this.registry = new MockHightailItemIdRegistry(this);</span>
<a href="#l26.103"></a><span id="l26.103" class="difflineminus">-  this.committer = new MockHightailCommitterSimple(this);</span>
<a href="#l26.104"></a><span id="l26.104" class="difflineminus">-  this.receiver = new MockHightailReceiverSimple(this);</span>
<a href="#l26.105"></a><span id="l26.105" class="difflineminus">-  this.deleter = new MockHightailDeleterSimple(this);</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineminus">-  this.preparer = new MockHightailPrepareSimple(this);</span>
<a href="#l26.107"></a><span id="l26.107" class="difflineminus">-}</span>
<a href="#l26.108"></a><span id="l26.108" class="difflineminus">-</span>
<a href="#l26.109"></a><span id="l26.109" class="difflineminus">-MockHightailServer.prototype = {</span>
<a href="#l26.110"></a><span id="l26.110" class="difflineminus">-  _server: null,</span>
<a href="#l26.111"></a><span id="l26.111" class="difflineminus">-</span>
<a href="#l26.112"></a><span id="l26.112" class="difflineminus">-  getPreparedBackend(aAccountKey) {</span>
<a href="#l26.113"></a><span id="l26.113" class="difflineminus">-    let username = this.userInfo.username;</span>
<a href="#l26.114"></a><span id="l26.114" class="difflineminus">-    Services.prefs.setCharPref(`mail.cloud_files.accounts.${aAccountKey}.type`, &quot;YouSendIt&quot;);</span>
<a href="#l26.115"></a><span id="l26.115" class="difflineminus">-    Services.prefs.setCharPref(`mail.cloud_files.accounts.${aAccountKey}.username`, username);</span>
<a href="#l26.116"></a><span id="l26.116" class="difflineminus">-</span>
<a href="#l26.117"></a><span id="l26.117" class="difflineminus">-    cloudFileAccounts.setSecretValue(aAccountKey, cloudFileAccounts.kTokenRealm, &quot;someAuthToken&quot;);</span>
<a href="#l26.118"></a><span id="l26.118" class="difflineminus">-</span>
<a href="#l26.119"></a><span id="l26.119" class="difflineminus">-    let hightail = cloudFileAccounts.getAccount(aAccountKey);</span>
<a href="#l26.120"></a><span id="l26.120" class="difflineminus">-</span>
<a href="#l26.121"></a><span id="l26.121" class="difflineminus">-    let urls = [kServerURL];</span>
<a href="#l26.122"></a><span id="l26.122" class="difflineminus">-    hightail.overrideUrls(urls.length, urls);</span>
<a href="#l26.123"></a><span id="l26.123" class="difflineminus">-    hightail.init(aAccountKey);</span>
<a href="#l26.124"></a><span id="l26.124" class="difflineminus">-</span>
<a href="#l26.125"></a><span id="l26.125" class="difflineminus">-    return hightail;</span>
<a href="#l26.126"></a><span id="l26.126" class="difflineminus">-  },</span>
<a href="#l26.127"></a><span id="l26.127" class="difflineminus">-</span>
<a href="#l26.128"></a><span id="l26.128" class="difflineminus">-  init(aConfig) {</span>
<a href="#l26.129"></a><span id="l26.129" class="difflineminus">-    this._config = overrideDefault(kDefaultConfig, aConfig);</span>
<a href="#l26.130"></a><span id="l26.130" class="difflineminus">-</span>
<a href="#l26.131"></a><span id="l26.131" class="difflineminus">-    this._server = new HttpServer();</span>
<a href="#l26.132"></a><span id="l26.132" class="difflineminus">-    this.auth.init(this._server);</span>
<a href="#l26.133"></a><span id="l26.133" class="difflineminus">-    this.userInfo.init(this._server);</span>
<a href="#l26.134"></a><span id="l26.134" class="difflineminus">-    this.registry.init(this._server);</span>
<a href="#l26.135"></a><span id="l26.135" class="difflineminus">-    this.receiver.init(this._server);</span>
<a href="#l26.136"></a><span id="l26.136" class="difflineminus">-    this.preparer.init(this._server);</span>
<a href="#l26.137"></a><span id="l26.137" class="difflineminus">-    this.deleter.init(this._server);</span>
<a href="#l26.138"></a><span id="l26.138" class="difflineminus">-    this.committer.init(this._server);</span>
<a href="#l26.139"></a><span id="l26.139" class="difflineminus">-</span>
<a href="#l26.140"></a><span id="l26.140" class="difflineminus">-    this.userInfo.setupUser();</span>
<a href="#l26.141"></a><span id="l26.141" class="difflineminus">-  },</span>
<a href="#l26.142"></a><span id="l26.142" class="difflineminus">-</span>
<a href="#l26.143"></a><span id="l26.143" class="difflineminus">-  start() {</span>
<a href="#l26.144"></a><span id="l26.144" class="difflineminus">-    this._server.start(this._config.port);</span>
<a href="#l26.145"></a><span id="l26.145" class="difflineminus">-  },</span>
<a href="#l26.146"></a><span id="l26.146" class="difflineminus">-</span>
<a href="#l26.147"></a><span id="l26.147" class="difflineminus">-  stop(aController) {</span>
<a href="#l26.148"></a><span id="l26.148" class="difflineminus">-    this.auth.shutdown();</span>
<a href="#l26.149"></a><span id="l26.149" class="difflineminus">-    this.userInfo.shutdown();</span>
<a href="#l26.150"></a><span id="l26.150" class="difflineminus">-    this.registry.shutdown();</span>
<a href="#l26.151"></a><span id="l26.151" class="difflineminus">-    this.receiver.shutdown();</span>
<a href="#l26.152"></a><span id="l26.152" class="difflineminus">-    this.preparer.shutdown();</span>
<a href="#l26.153"></a><span id="l26.153" class="difflineminus">-    this.deleter.shutdown();</span>
<a href="#l26.154"></a><span id="l26.154" class="difflineminus">-    this.committer.shutdown();</span>
<a href="#l26.155"></a><span id="l26.155" class="difflineminus">-</span>
<a href="#l26.156"></a><span id="l26.156" class="difflineminus">-    let allDone = false;</span>
<a href="#l26.157"></a><span id="l26.157" class="difflineminus">-    this._server.stop(function() {</span>
<a href="#l26.158"></a><span id="l26.158" class="difflineminus">-      allDone = true;</span>
<a href="#l26.159"></a><span id="l26.159" class="difflineminus">-    });</span>
<a href="#l26.160"></a><span id="l26.160" class="difflineminus">-    aController.waitFor(() =&gt; allDone,</span>
<a href="#l26.161"></a><span id="l26.161" class="difflineminus">-                        &quot;Timed out waiting for Hightail server to stop!&quot;,</span>
<a href="#l26.162"></a><span id="l26.162" class="difflineminus">-                        10000);</span>
<a href="#l26.163"></a><span id="l26.163" class="difflineminus">-  },</span>
<a href="#l26.164"></a><span id="l26.164" class="difflineminus">-</span>
<a href="#l26.165"></a><span id="l26.165" class="difflineminus">-  setupUser(aData) {</span>
<a href="#l26.166"></a><span id="l26.166" class="difflineminus">-    this.userInfo.shutdown();</span>
<a href="#l26.167"></a><span id="l26.167" class="difflineminus">-    this.userInfo.init(this._server);</span>
<a href="#l26.168"></a><span id="l26.168" class="difflineminus">-    this.userInfo.setupUser(aData);</span>
<a href="#l26.169"></a><span id="l26.169" class="difflineminus">-  },</span>
<a href="#l26.170"></a><span id="l26.170" class="difflineminus">-</span>
<a href="#l26.171"></a><span id="l26.171" class="difflineminus">-  /**</span>
<a href="#l26.172"></a><span id="l26.172" class="difflineminus">-   * Prepare the mock server to have a file with filename aFilename be</span>
<a href="#l26.173"></a><span id="l26.173" class="difflineminus">-   * uploaded.</span>
<a href="#l26.174"></a><span id="l26.174" class="difflineminus">-   *</span>
<a href="#l26.175"></a><span id="l26.175" class="difflineminus">-   * @param aFilename the name of the file to be uploaded.</span>
<a href="#l26.176"></a><span id="l26.176" class="difflineminus">-   * @param aMSeconds an optional argument, for the amount of time the upload</span>
<a href="#l26.177"></a><span id="l26.177" class="difflineminus">-   *                  should take in milliseconds.</span>
<a href="#l26.178"></a><span id="l26.178" class="difflineminus">-   */</span>
<a href="#l26.179"></a><span id="l26.179" class="difflineminus">-  planForUploadFile(aFilename, aMSeconds) {</span>
<a href="#l26.180"></a><span id="l26.180" class="difflineminus">-    this.receiver.expect(aFilename, aMSeconds);</span>
<a href="#l26.181"></a><span id="l26.181" class="difflineminus">-    let downloadUrl = kDownloadURLPrefix + &quot;/&quot; + aFilename;</span>
<a href="#l26.182"></a><span id="l26.182" class="difflineminus">-    this.committer.prepareDownloadURL(aFilename, downloadUrl);</span>
<a href="#l26.183"></a><span id="l26.183" class="difflineminus">-  },</span>
<a href="#l26.184"></a><span id="l26.184" class="difflineminus">-</span>
<a href="#l26.185"></a><span id="l26.185" class="difflineminus">-  planForGetFileURL(aFilename, aData) {</span>
<a href="#l26.186"></a><span id="l26.186" class="difflineminus">-    this.committer.prepareDownloadURL(aFilename, aData.url);</span>
<a href="#l26.187"></a><span id="l26.187" class="difflineminus">-  },</span>
<a href="#l26.188"></a><span id="l26.188" class="difflineminus">-</span>
<a href="#l26.189"></a><span id="l26.189" class="difflineminus">-  planForDeleteFile(aFilename) {</span>
<a href="#l26.190"></a><span id="l26.190" class="difflineminus">-    this.deleter.prepareForDelete(aFilename);</span>
<a href="#l26.191"></a><span id="l26.191" class="difflineminus">-  },</span>
<a href="#l26.192"></a><span id="l26.192" class="difflineminus">-};</span>
<a href="#l26.193"></a><span id="l26.193" class="difflineminus">-</span>
<a href="#l26.194"></a><span id="l26.194" class="difflineminus">-/**</span>
<a href="#l26.195"></a><span id="l26.195" class="difflineminus">- * A simple authentication handler, regardless of input, returns</span>
<a href="#l26.196"></a><span id="l26.196" class="difflineminus">- * an authorization token, and fires the cloudfile:auth observable</span>
<a href="#l26.197"></a><span id="l26.197" class="difflineminus">- * topic.</span>
<a href="#l26.198"></a><span id="l26.198" class="difflineminus">- */</span>
<a href="#l26.199"></a><span id="l26.199" class="difflineminus">-function MockHightailAuthSimple(aHightail) {</span>
<a href="#l26.200"></a><span id="l26.200" class="difflineminus">-  this._server = null;</span>
<a href="#l26.201"></a><span id="l26.201" class="difflineminus">-  this._auth = null;</span>
<a href="#l26.202"></a><span id="l26.202" class="difflineminus">-}</span>
<a href="#l26.203"></a><span id="l26.203" class="difflineminus">-</span>
<a href="#l26.204"></a><span id="l26.204" class="difflineminus">-MockHightailAuthSimple.prototype = {</span>
<a href="#l26.205"></a><span id="l26.205" class="difflineminus">-  init(aServer) {</span>
<a href="#l26.206"></a><span id="l26.206" class="difflineminus">-    this._server = aServer;</span>
<a href="#l26.207"></a><span id="l26.207" class="difflineminus">-    this._auth = generateObservableRequestHandler(</span>
<a href="#l26.208"></a><span id="l26.208" class="difflineminus">-        &quot;cloudfile:auth&quot;, &quot;&quot;, JSON.stringify(kAuthResult));</span>
<a href="#l26.209"></a><span id="l26.209" class="difflineminus">-</span>
<a href="#l26.210"></a><span id="l26.210" class="difflineminus">-    this._server.registerPathHandler(kAuthPath, this._auth);</span>
<a href="#l26.211"></a><span id="l26.211" class="difflineminus">-  },</span>
<a href="#l26.212"></a><span id="l26.212" class="difflineminus">-</span>
<a href="#l26.213"></a><span id="l26.213" class="difflineminus">-  shutdown() {</span>
<a href="#l26.214"></a><span id="l26.214" class="difflineminus">-    this._server.registerPathHandler(kAuthPath, null);</span>
<a href="#l26.215"></a><span id="l26.215" class="difflineminus">-    this._server = null;</span>
<a href="#l26.216"></a><span id="l26.216" class="difflineminus">-    this._auth = null;</span>
<a href="#l26.217"></a><span id="l26.217" class="difflineminus">-  },</span>
<a href="#l26.218"></a><span id="l26.218" class="difflineminus">-};</span>
<a href="#l26.219"></a><span id="l26.219" class="difflineminus">-</span>
<a href="#l26.220"></a><span id="l26.220" class="difflineminus">-function MockHightailUserInfoSimple(aHightail) {</span>
<a href="#l26.221"></a><span id="l26.221" class="difflineminus">-  this._server = null;</span>
<a href="#l26.222"></a><span id="l26.222" class="difflineminus">-  this._userInfo = null;</span>
<a href="#l26.223"></a><span id="l26.223" class="difflineminus">-}</span>
<a href="#l26.224"></a><span id="l26.224" class="difflineminus">-</span>
<a href="#l26.225"></a><span id="l26.225" class="difflineminus">-MockHightailUserInfoSimple.prototype = {</span>
<a href="#l26.226"></a><span id="l26.226" class="difflineminus">-  init(aServer) {</span>
<a href="#l26.227"></a><span id="l26.227" class="difflineminus">-    this._server = aServer;</span>
<a href="#l26.228"></a><span id="l26.228" class="difflineminus">-  },</span>
<a href="#l26.229"></a><span id="l26.229" class="difflineminus">-</span>
<a href="#l26.230"></a><span id="l26.230" class="difflineminus">-  setupUser(aData) {</span>
<a href="#l26.231"></a><span id="l26.231" class="difflineminus">-    aData = overrideDefault(kDefaultUser, aData);</span>
<a href="#l26.232"></a><span id="l26.232" class="difflineminus">-</span>
<a href="#l26.233"></a><span id="l26.233" class="difflineminus">-    this._userInfo = generateObservableRequestHandler(</span>
<a href="#l26.234"></a><span id="l26.234" class="difflineminus">-        &quot;cloudfile:auth&quot;, &quot;&quot;, JSON.stringify(aData));</span>
<a href="#l26.235"></a><span id="l26.235" class="difflineminus">-    this._server.registerPathHandler(kUserInfoPath, this._userInfo);</span>
<a href="#l26.236"></a><span id="l26.236" class="difflineminus">-  },</span>
<a href="#l26.237"></a><span id="l26.237" class="difflineminus">-</span>
<a href="#l26.238"></a><span id="l26.238" class="difflineminus">-  shutdown() {</span>
<a href="#l26.239"></a><span id="l26.239" class="difflineminus">-    this._server.registerPathHandler(kUserInfoPath, null);</span>
<a href="#l26.240"></a><span id="l26.240" class="difflineminus">-    this._server = null;</span>
<a href="#l26.241"></a><span id="l26.241" class="difflineminus">-  },</span>
<a href="#l26.242"></a><span id="l26.242" class="difflineminus">-</span>
<a href="#l26.243"></a><span id="l26.243" class="difflineminus">-  get username() {</span>
<a href="#l26.244"></a><span id="l26.244" class="difflineminus">-    return kDefaultUser.email;</span>
<a href="#l26.245"></a><span id="l26.245" class="difflineminus">-  },</span>
<a href="#l26.246"></a><span id="l26.246" class="difflineminus">-};</span>
<a href="#l26.247"></a><span id="l26.247" class="difflineminus">-</span>
<a href="#l26.248"></a><span id="l26.248" class="difflineminus">-function MockHightailItemIdRegistry(aHightail) {</span>
<a href="#l26.249"></a><span id="l26.249" class="difflineminus">-  this._itemIdMap = {};</span>
<a href="#l26.250"></a><span id="l26.250" class="difflineminus">-  this._itemIds = [];</span>
<a href="#l26.251"></a><span id="l26.251" class="difflineminus">-}</span>
<a href="#l26.252"></a><span id="l26.252" class="difflineminus">-</span>
<a href="#l26.253"></a><span id="l26.253" class="difflineminus">-MockHightailItemIdRegistry.prototype = {</span>
<a href="#l26.254"></a><span id="l26.254" class="difflineminus">-  init(aServer) {</span>
<a href="#l26.255"></a><span id="l26.255" class="difflineminus">-    this._itemIdMap = {};</span>
<a href="#l26.256"></a><span id="l26.256" class="difflineminus">-    this._itemIds = [];</span>
<a href="#l26.257"></a><span id="l26.257" class="difflineminus">-  },</span>
<a href="#l26.258"></a><span id="l26.258" class="difflineminus">-</span>
<a href="#l26.259"></a><span id="l26.259" class="difflineminus">-  shutdown() {</span>
<a href="#l26.260"></a><span id="l26.260" class="difflineminus">-  },</span>
<a href="#l26.261"></a><span id="l26.261" class="difflineminus">-</span>
<a href="#l26.262"></a><span id="l26.262" class="difflineminus">-  createItemId() {</span>
<a href="#l26.263"></a><span id="l26.263" class="difflineminus">-    let itemId = generateUUID();</span>
<a href="#l26.264"></a><span id="l26.264" class="difflineminus">-    this._itemIds.push(itemId);</span>
<a href="#l26.265"></a><span id="l26.265" class="difflineminus">-    return itemId;</span>
<a href="#l26.266"></a><span id="l26.266" class="difflineminus">-  },</span>
<a href="#l26.267"></a><span id="l26.267" class="difflineminus">-</span>
<a href="#l26.268"></a><span id="l26.268" class="difflineminus">-  setMapping(aItemId, aFilename) {</span>
<a href="#l26.269"></a><span id="l26.269" class="difflineminus">-    let oldItemId = this.lookupItemId(aFilename);</span>
<a href="#l26.270"></a><span id="l26.270" class="difflineminus">-    if (oldItemId)</span>
<a href="#l26.271"></a><span id="l26.271" class="difflineminus">-      delete this._itemIdMap[oldItemId];</span>
<a href="#l26.272"></a><span id="l26.272" class="difflineminus">-</span>
<a href="#l26.273"></a><span id="l26.273" class="difflineminus">-    if (this._itemIds.includes(aItemId)) {</span>
<a href="#l26.274"></a><span id="l26.274" class="difflineminus">-      this._itemIdMap[aItemId] = aFilename;</span>
<a href="#l26.275"></a><span id="l26.275" class="difflineminus">-    }</span>
<a href="#l26.276"></a><span id="l26.276" class="difflineminus">-  },</span>
<a href="#l26.277"></a><span id="l26.277" class="difflineminus">-</span>
<a href="#l26.278"></a><span id="l26.278" class="difflineminus">-  lookupFilename(aItemId) {</span>
<a href="#l26.279"></a><span id="l26.279" class="difflineminus">-    return this._itemIdMap[aItemId];</span>
<a href="#l26.280"></a><span id="l26.280" class="difflineminus">-  },</span>
<a href="#l26.281"></a><span id="l26.281" class="difflineminus">-</span>
<a href="#l26.282"></a><span id="l26.282" class="difflineminus">-  hasItemId(aItemId) {</span>
<a href="#l26.283"></a><span id="l26.283" class="difflineminus">-    return (aItemId in this._itemIdMap);</span>
<a href="#l26.284"></a><span id="l26.284" class="difflineminus">-  },</span>
<a href="#l26.285"></a><span id="l26.285" class="difflineminus">-</span>
<a href="#l26.286"></a><span id="l26.286" class="difflineminus">-  lookupItemId(aFilename) {</span>
<a href="#l26.287"></a><span id="l26.287" class="difflineminus">-    // Slow lookup</span>
<a href="#l26.288"></a><span id="l26.288" class="difflineminus">-    for (let itemId in this._itemIdMap) {</span>
<a href="#l26.289"></a><span id="l26.289" class="difflineminus">-      if (this._itemIdMap[itemId] == aFilename)</span>
<a href="#l26.290"></a><span id="l26.290" class="difflineminus">-        return itemId;</span>
<a href="#l26.291"></a><span id="l26.291" class="difflineminus">-    }</span>
<a href="#l26.292"></a><span id="l26.292" class="difflineminus">-    return null;</span>
<a href="#l26.293"></a><span id="l26.293" class="difflineminus">-  },</span>
<a href="#l26.294"></a><span id="l26.294" class="difflineminus">-};</span>
<a href="#l26.295"></a><span id="l26.295" class="difflineminus">-</span>
<a href="#l26.296"></a><span id="l26.296" class="difflineminus">-/**</span>
<a href="#l26.297"></a><span id="l26.297" class="difflineminus">- * A simple preparation handler for a Hightail mock server. Allows</span>
<a href="#l26.298"></a><span id="l26.298" class="difflineminus">- * a client to query for a unique URL to upload to.  Redirects the actual</span>
<a href="#l26.299"></a><span id="l26.299" class="difflineminus">- * uploads to the passed receiver</span>
<a href="#l26.300"></a><span id="l26.300" class="difflineminus">- */</span>
<a href="#l26.301"></a><span id="l26.301" class="difflineminus">-function MockHightailPrepareSimple(aHightail) {</span>
<a href="#l26.302"></a><span id="l26.302" class="difflineminus">-  this._server = null;</span>
<a href="#l26.303"></a><span id="l26.303" class="difflineminus">-  this._hightail = aHightail;</span>
<a href="#l26.304"></a><span id="l26.304" class="difflineminus">-}</span>
<a href="#l26.305"></a><span id="l26.305" class="difflineminus">-</span>
<a href="#l26.306"></a><span id="l26.306" class="difflineminus">-MockHightailPrepareSimple.prototype = {</span>
<a href="#l26.307"></a><span id="l26.307" class="difflineminus">-  init(aServer) {</span>
<a href="#l26.308"></a><span id="l26.308" class="difflineminus">-    this._server = aServer;</span>
<a href="#l26.309"></a><span id="l26.309" class="difflineminus">-    this._server.registerPathHandler(kFolderInitUploadPath,</span>
<a href="#l26.310"></a><span id="l26.310" class="difflineminus">-                                     this._prepare.bind(this));</span>
<a href="#l26.311"></a><span id="l26.311" class="difflineminus">-</span>
<a href="#l26.312"></a><span id="l26.312" class="difflineminus">-    this._foldersId = {</span>
<a href="#l26.313"></a><span id="l26.313" class="difflineminus">-      root: 0,</span>
<a href="#l26.314"></a><span id="l26.314" class="difflineminus">-      Apps: this._hightail.registry.createItemId(),</span>
<a href="#l26.315"></a><span id="l26.315" class="difflineminus">-      &quot;Mozilla Thunderbird&quot;: this._hightail.registry.createItemId(),</span>
<a href="#l26.316"></a><span id="l26.316" class="difflineminus">-    };</span>
<a href="#l26.317"></a><span id="l26.317" class="difflineminus">-</span>
<a href="#l26.318"></a><span id="l26.318" class="difflineminus">-    // Set up folders info</span>
<a href="#l26.319"></a><span id="l26.319" class="difflineminus">-    for (let i in this._foldersId) {</span>
<a href="#l26.320"></a><span id="l26.320" class="difflineminus">-      this._server.registerPathHandler(kFolderPath + this._foldersId[i],</span>
<a href="#l26.321"></a><span id="l26.321" class="difflineminus">-                                       this._getFolderInfo.bind(this));</span>
<a href="#l26.322"></a><span id="l26.322" class="difflineminus">-    }</span>
<a href="#l26.323"></a><span id="l26.323" class="difflineminus">-  },</span>
<a href="#l26.324"></a><span id="l26.324" class="difflineminus">-</span>
<a href="#l26.325"></a><span id="l26.325" class="difflineminus">-  shutdown() {</span>
<a href="#l26.326"></a><span id="l26.326" class="difflineminus">-    this._server.registerPathHandler(kFolderInitUploadPath, null);</span>
<a href="#l26.327"></a><span id="l26.327" class="difflineminus">-    for (let i in this._foldersId) {</span>
<a href="#l26.328"></a><span id="l26.328" class="difflineminus">-      this._server.registerPathHandler(kFolderPath + this._foldersId[i],</span>
<a href="#l26.329"></a><span id="l26.329" class="difflineminus">-                                       null);</span>
<a href="#l26.330"></a><span id="l26.330" class="difflineminus">-    }</span>
<a href="#l26.331"></a><span id="l26.331" class="difflineminus">-    this._server = null;</span>
<a href="#l26.332"></a><span id="l26.332" class="difflineminus">-  },</span>
<a href="#l26.333"></a><span id="l26.333" class="difflineminus">-</span>
<a href="#l26.334"></a><span id="l26.334" class="difflineminus">-  _getFolderInfo(aRequest, aResponse) {</span>
<a href="#l26.335"></a><span id="l26.335" class="difflineminus">-    let folderId = aRequest.path.substring(kFolderPath.length);</span>
<a href="#l26.336"></a><span id="l26.336" class="difflineminus">-    let nextFolder = folderId == (this._foldersId.root + &quot;&quot;)</span>
<a href="#l26.337"></a><span id="l26.337" class="difflineminus">-                        ? &quot;Apps&quot;</span>
<a href="#l26.338"></a><span id="l26.338" class="difflineminus">-                        : &quot;Mozilla Thunderbird&quot;;</span>
<a href="#l26.339"></a><span id="l26.339" class="difflineminus">-    let response = {</span>
<a href="#l26.340"></a><span id="l26.340" class="difflineminus">-      folders: {</span>
<a href="#l26.341"></a><span id="l26.341" class="difflineminus">-        folder: [{name: nextFolder, id: this._foldersId[nextFolder]}],</span>
<a href="#l26.342"></a><span id="l26.342" class="difflineminus">-      },</span>
<a href="#l26.343"></a><span id="l26.343" class="difflineminus">-      status: 200,</span>
<a href="#l26.344"></a><span id="l26.344" class="difflineminus">-    };</span>
<a href="#l26.345"></a><span id="l26.345" class="difflineminus">-    aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l26.346"></a><span id="l26.346" class="difflineminus">-    aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l26.347"></a><span id="l26.347" class="difflineminus">-    aResponse.write(JSON.stringify(response));</span>
<a href="#l26.348"></a><span id="l26.348" class="difflineminus">-  },</span>
<a href="#l26.349"></a><span id="l26.349" class="difflineminus">-</span>
<a href="#l26.350"></a><span id="l26.350" class="difflineminus">-  _prepare(aRequest, aResponse) {</span>
<a href="#l26.351"></a><span id="l26.351" class="difflineminus">-    let fileId = this._hightail.registry.createItemId();</span>
<a href="#l26.352"></a><span id="l26.352" class="difflineminus">-    let uploadPath = kDefaultFileUploadPath + &quot;/&quot; + fileId;</span>
<a href="#l26.353"></a><span id="l26.353" class="difflineminus">-</span>
<a href="#l26.354"></a><span id="l26.354" class="difflineminus">-    let injectedData = {</span>
<a href="#l26.355"></a><span id="l26.355" class="difflineminus">-      fileId,</span>
<a href="#l26.356"></a><span id="l26.356" class="difflineminus">-      uploadUrl: [</span>
<a href="#l26.357"></a><span id="l26.357" class="difflineminus">-        kServerURL + uploadPath,</span>
<a href="#l26.358"></a><span id="l26.358" class="difflineminus">-      ],</span>
<a href="#l26.359"></a><span id="l26.359" class="difflineminus">-    };</span>
<a href="#l26.360"></a><span id="l26.360" class="difflineminus">-</span>
<a href="#l26.361"></a><span id="l26.361" class="difflineminus">-    // Set up the path that will accept an uploaded file</span>
<a href="#l26.362"></a><span id="l26.362" class="difflineminus">-    this._server.registerPathHandler(uploadPath,</span>
<a href="#l26.363"></a><span id="l26.363" class="difflineminus">-                                     this._hightail.receiver.receiveUpload</span>
<a href="#l26.364"></a><span id="l26.364" class="difflineminus">-                                         .bind(this._hightail.receiver));</span>
<a href="#l26.365"></a><span id="l26.365" class="difflineminus">-</span>
<a href="#l26.366"></a><span id="l26.366" class="difflineminus">-    // Set up the path that will accept file deletion</span>
<a href="#l26.367"></a><span id="l26.367" class="difflineminus">-</span>
<a href="#l26.368"></a><span id="l26.368" class="difflineminus">-    let deletePath = kDeletePath + &quot;/&quot; + fileId;</span>
<a href="#l26.369"></a><span id="l26.369" class="difflineminus">-</span>
<a href="#l26.370"></a><span id="l26.370" class="difflineminus">-    this._server.registerPathHandler(deletePath,</span>
<a href="#l26.371"></a><span id="l26.371" class="difflineminus">-                                     this._hightail.deleter.receiveDelete</span>
<a href="#l26.372"></a><span id="l26.372" class="difflineminus">-                                                      .bind(this._hightail.deleter));</span>
<a href="#l26.373"></a><span id="l26.373" class="difflineminus">-</span>
<a href="#l26.374"></a><span id="l26.374" class="difflineminus">-    let data = overrideDefault(kDefaultFilePrepare, injectedData);</span>
<a href="#l26.375"></a><span id="l26.375" class="difflineminus">-    aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l26.376"></a><span id="l26.376" class="difflineminus">-    aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l26.377"></a><span id="l26.377" class="difflineminus">-    aResponse.write(JSON.stringify(data));</span>
<a href="#l26.378"></a><span id="l26.378" class="difflineminus">-  },</span>
<a href="#l26.379"></a><span id="l26.379" class="difflineminus">-</span>
<a href="#l26.380"></a><span id="l26.380" class="difflineminus">-};</span>
<a href="#l26.381"></a><span id="l26.381" class="difflineminus">-</span>
<a href="#l26.382"></a><span id="l26.382" class="difflineminus">-function MockHightailReceiverSimple(aHightail) {</span>
<a href="#l26.383"></a><span id="l26.383" class="difflineminus">-  this._server = null;</span>
<a href="#l26.384"></a><span id="l26.384" class="difflineminus">-  this._hightail = aHightail;</span>
<a href="#l26.385"></a><span id="l26.385" class="difflineminus">-  this._expectedFiles = [];</span>
<a href="#l26.386"></a><span id="l26.386" class="difflineminus">-  this._mSeconds = {};</span>
<a href="#l26.387"></a><span id="l26.387" class="difflineminus">-  this._timers = [];</span>
<a href="#l26.388"></a><span id="l26.388" class="difflineminus">-}</span>
<a href="#l26.389"></a><span id="l26.389" class="difflineminus">-</span>
<a href="#l26.390"></a><span id="l26.390" class="difflineminus">-MockHightailReceiverSimple.prototype = {</span>
<a href="#l26.391"></a><span id="l26.391" class="difflineminus">-  init(aServer) {</span>
<a href="#l26.392"></a><span id="l26.392" class="difflineminus">-    this._server = aServer;</span>
<a href="#l26.393"></a><span id="l26.393" class="difflineminus">-  },</span>
<a href="#l26.394"></a><span id="l26.394" class="difflineminus">-</span>
<a href="#l26.395"></a><span id="l26.395" class="difflineminus">-  shutdown() {</span>
<a href="#l26.396"></a><span id="l26.396" class="difflineminus">-    this._server = null;</span>
<a href="#l26.397"></a><span id="l26.397" class="difflineminus">-    this._expectedFiles = [];</span>
<a href="#l26.398"></a><span id="l26.398" class="difflineminus">-  },</span>
<a href="#l26.399"></a><span id="l26.399" class="difflineminus">-</span>
<a href="#l26.400"></a><span id="l26.400" class="difflineminus">-  receiveUpload(aRequest, aResponse) {</span>
<a href="#l26.401"></a><span id="l26.401" class="difflineminus">-    if (aRequest.method != &quot;POST&quot;)</span>
<a href="#l26.402"></a><span id="l26.402" class="difflineminus">-      throw new Error(&quot;Uploads should occur with a POST request&quot;);</span>
<a href="#l26.403"></a><span id="l26.403" class="difflineminus">-</span>
<a href="#l26.404"></a><span id="l26.404" class="difflineminus">-    let formData = parseMultipartForm(aRequest);</span>
<a href="#l26.405"></a><span id="l26.405" class="difflineminus">-</span>
<a href="#l26.406"></a><span id="l26.406" class="difflineminus">-    if (!formData)</span>
<a href="#l26.407"></a><span id="l26.407" class="difflineminus">-      throw new Error(&quot;Could not parse multi-part form during upload&quot;);</span>
<a href="#l26.408"></a><span id="l26.408" class="difflineminus">-</span>
<a href="#l26.409"></a><span id="l26.409" class="difflineminus">-    let filename = formData.filename;</span>
<a href="#l26.410"></a><span id="l26.410" class="difflineminus">-    let filenameIndex = this._expectedFiles.indexOf(filename);</span>
<a href="#l26.411"></a><span id="l26.411" class="difflineminus">-</span>
<a href="#l26.412"></a><span id="l26.412" class="difflineminus">-    Services.obs.notifyObservers(null, &quot;cloudfile:uploadStarted&quot;,</span>
<a href="#l26.413"></a><span id="l26.413" class="difflineminus">-                                 filename);</span>
<a href="#l26.414"></a><span id="l26.414" class="difflineminus">-</span>
<a href="#l26.415"></a><span id="l26.415" class="difflineminus">-    if (filename in this._mSeconds)</span>
<a href="#l26.416"></a><span id="l26.416" class="difflineminus">-      aResponse.processAsync();</span>
<a href="#l26.417"></a><span id="l26.417" class="difflineminus">-</span>
<a href="#l26.418"></a><span id="l26.418" class="difflineminus">-    if (filenameIndex == -1)</span>
<a href="#l26.419"></a><span id="l26.419" class="difflineminus">-      throw new Error(&quot;Unexpected file upload: &quot; + formData.filename);</span>
<a href="#l26.420"></a><span id="l26.420" class="difflineminus">-</span>
<a href="#l26.421"></a><span id="l26.421" class="difflineminus">-    Services.obs.notifyObservers(null, &quot;cloudfile:uploadFile&quot;,</span>
<a href="#l26.422"></a><span id="l26.422" class="difflineminus">-                                 filename);</span>
<a href="#l26.423"></a><span id="l26.423" class="difflineminus">-</span>
<a href="#l26.424"></a><span id="l26.424" class="difflineminus">-    this._expectedFiles.splice(filenameIndex, 1);</span>
<a href="#l26.425"></a><span id="l26.425" class="difflineminus">-</span>
<a href="#l26.426"></a><span id="l26.426" class="difflineminus">-    let itemId = formData.bid;</span>
<a href="#l26.427"></a><span id="l26.427" class="difflineminus">-    // Tell the committer how to map the uuid to the filename</span>
<a href="#l26.428"></a><span id="l26.428" class="difflineminus">-    this._hightail.registry.setMapping(itemId, filename);</span>
<a href="#l26.429"></a><span id="l26.429" class="difflineminus">-</span>
<a href="#l26.430"></a><span id="l26.430" class="difflineminus">-    // De-register this URL...</span>
<a href="#l26.431"></a><span id="l26.431" class="difflineminus">-    this._server.registerPathHandler(aRequest.path, null);</span>
<a href="#l26.432"></a><span id="l26.432" class="difflineminus">-</span>
<a href="#l26.433"></a><span id="l26.433" class="difflineminus">-    if (filename in this._mSeconds) {</span>
<a href="#l26.434"></a><span id="l26.434" class="difflineminus">-      let timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l26.435"></a><span id="l26.435" class="difflineminus">-      let timerEvent = {</span>
<a href="#l26.436"></a><span id="l26.436" class="difflineminus">-        notify(aTimer) {</span>
<a href="#l26.437"></a><span id="l26.437" class="difflineminus">-          aResponse.finish();</span>
<a href="#l26.438"></a><span id="l26.438" class="difflineminus">-        },</span>
<a href="#l26.439"></a><span id="l26.439" class="difflineminus">-      };</span>
<a href="#l26.440"></a><span id="l26.440" class="difflineminus">-      timer.initWithCallback(timerEvent, this._mSeconds[filename],</span>
<a href="#l26.441"></a><span id="l26.441" class="difflineminus">-                             Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l26.442"></a><span id="l26.442" class="difflineminus">-      // This is kind of ridiculous, but it seems that we have to hold a</span>
<a href="#l26.443"></a><span id="l26.443" class="difflineminus">-      // reference to this timer, or else it can get garbage collected before</span>
<a href="#l26.444"></a><span id="l26.444" class="difflineminus">-      // it fires.</span>
<a href="#l26.445"></a><span id="l26.445" class="difflineminus">-      this._timers.push(timer);</span>
<a href="#l26.446"></a><span id="l26.446" class="difflineminus">-    }</span>
<a href="#l26.447"></a><span id="l26.447" class="difflineminus">-  },</span>
<a href="#l26.448"></a><span id="l26.448" class="difflineminus">-</span>
<a href="#l26.449"></a><span id="l26.449" class="difflineminus">-  expect(aFilename, aMSeconds) {</span>
<a href="#l26.450"></a><span id="l26.450" class="difflineminus">-    this._expectedFiles.push(aFilename);</span>
<a href="#l26.451"></a><span id="l26.451" class="difflineminus">-</span>
<a href="#l26.452"></a><span id="l26.452" class="difflineminus">-    if (aMSeconds)</span>
<a href="#l26.453"></a><span id="l26.453" class="difflineminus">-      this._mSeconds[aFilename] = aMSeconds;</span>
<a href="#l26.454"></a><span id="l26.454" class="difflineminus">-  },</span>
<a href="#l26.455"></a><span id="l26.455" class="difflineminus">-</span>
<a href="#l26.456"></a><span id="l26.456" class="difflineminus">-  get expecting() {</span>
<a href="#l26.457"></a><span id="l26.457" class="difflineminus">-    return this._expectedFiles;</span>
<a href="#l26.458"></a><span id="l26.458" class="difflineminus">-  },</span>
<a href="#l26.459"></a><span id="l26.459" class="difflineminus">-};</span>
<a href="#l26.460"></a><span id="l26.460" class="difflineminus">-</span>
<a href="#l26.461"></a><span id="l26.461" class="difflineminus">-function MockHightailCommitterSimple(aHightail) {</span>
<a href="#l26.462"></a><span id="l26.462" class="difflineminus">-  this._server = null;</span>
<a href="#l26.463"></a><span id="l26.463" class="difflineminus">-  this._hightail = aHightail;</span>
<a href="#l26.464"></a><span id="l26.464" class="difflineminus">-  this._itemIdMap = {};</span>
<a href="#l26.465"></a><span id="l26.465" class="difflineminus">-  this._filenameURLMap = {};</span>
<a href="#l26.466"></a><span id="l26.466" class="difflineminus">-}</span>
<a href="#l26.467"></a><span id="l26.467" class="difflineminus">-</span>
<a href="#l26.468"></a><span id="l26.468" class="difflineminus">-MockHightailCommitterSimple.prototype = {</span>
<a href="#l26.469"></a><span id="l26.469" class="difflineminus">-  init(aServer) {</span>
<a href="#l26.470"></a><span id="l26.470" class="difflineminus">-    this._server = aServer;</span>
<a href="#l26.471"></a><span id="l26.471" class="difflineminus">-    // Since fileId is in query, we need to register path only once.</span>
<a href="#l26.472"></a><span id="l26.472" class="difflineminus">-    this._server.registerPathHandler(kFolderCommitUploadPath,</span>
<a href="#l26.473"></a><span id="l26.473" class="difflineminus">-                                     this.commit.bind(this));</span>
<a href="#l26.474"></a><span id="l26.474" class="difflineminus">-  },</span>
<a href="#l26.475"></a><span id="l26.475" class="difflineminus">-</span>
<a href="#l26.476"></a><span id="l26.476" class="difflineminus">-  shutdown() {</span>
<a href="#l26.477"></a><span id="l26.477" class="difflineminus">-    this._server.registerPathHandler(kFolderCommitUploadPath,</span>
<a href="#l26.478"></a><span id="l26.478" class="difflineminus">-                                     null);</span>
<a href="#l26.479"></a><span id="l26.479" class="difflineminus">-    this._server = null;</span>
<a href="#l26.480"></a><span id="l26.480" class="difflineminus">-    this._itemIdMap = {};</span>
<a href="#l26.481"></a><span id="l26.481" class="difflineminus">-    this._filenameURLMap = {};</span>
<a href="#l26.482"></a><span id="l26.482" class="difflineminus">-  },</span>
<a href="#l26.483"></a><span id="l26.483" class="difflineminus">-</span>
<a href="#l26.484"></a><span id="l26.484" class="difflineminus">-  prepareDownloadURL(aFilename, aURL) {</span>
<a href="#l26.485"></a><span id="l26.485" class="difflineminus">-    this._filenameURLMap[aFilename] = aURL;</span>
<a href="#l26.486"></a><span id="l26.486" class="difflineminus">-  },</span>
<a href="#l26.487"></a><span id="l26.487" class="difflineminus">-</span>
<a href="#l26.488"></a><span id="l26.488" class="difflineminus">-  commit(aRequest, aResponse) {</span>
<a href="#l26.489"></a><span id="l26.489" class="difflineminus">-    let fileId = aRequest.queryString;</span>
<a href="#l26.490"></a><span id="l26.490" class="difflineminus">-    fileId = fileId.substring(fileId.indexOf(&quot;fileId=&quot;) + 7);</span>
<a href="#l26.491"></a><span id="l26.491" class="difflineminus">-    fileId = fileId.substring(0, fileId.indexOf(&quot;&amp;&quot;));</span>
<a href="#l26.492"></a><span id="l26.492" class="difflineminus">-</span>
<a href="#l26.493"></a><span id="l26.493" class="difflineminus">-    if (!this._hightail.registry.hasItemId(fileId)) {</span>
<a href="#l26.494"></a><span id="l26.494" class="difflineminus">-      aResponse.setStatusLine(null, 500, &quot;Bad request&quot;);</span>
<a href="#l26.495"></a><span id="l26.495" class="difflineminus">-      aResponse.write(&quot;The item ID &quot; + fileId + &quot; did not map to an item we &quot;</span>
<a href="#l26.496"></a><span id="l26.496" class="difflineminus">-                      + &quot;were prepared for committing&quot;);</span>
<a href="#l26.497"></a><span id="l26.497" class="difflineminus">-      return;</span>
<a href="#l26.498"></a><span id="l26.498" class="difflineminus">-    }</span>
<a href="#l26.499"></a><span id="l26.499" class="difflineminus">-</span>
<a href="#l26.500"></a><span id="l26.500" class="difflineminus">-    let filename = this._hightail.registry.lookupFilename(fileId);</span>
<a href="#l26.501"></a><span id="l26.501" class="difflineminus">-    let url;</span>
<a href="#l26.502"></a><span id="l26.502" class="difflineminus">-</span>
<a href="#l26.503"></a><span id="l26.503" class="difflineminus">-    if (filename in this._filenameURLMap)</span>
<a href="#l26.504"></a><span id="l26.504" class="difflineminus">-      url = this._filenameURLMap[filename];</span>
<a href="#l26.505"></a><span id="l26.505" class="difflineminus">-    else</span>
<a href="#l26.506"></a><span id="l26.506" class="difflineminus">-      url = kDownloadURLPrefix + &quot;/&quot; + filename;</span>
<a href="#l26.507"></a><span id="l26.507" class="difflineminus">-</span>
<a href="#l26.508"></a><span id="l26.508" class="difflineminus">-    let injectedData = {</span>
<a href="#l26.509"></a><span id="l26.509" class="difflineminus">-      clickableDownloadUrl: url,</span>
<a href="#l26.510"></a><span id="l26.510" class="difflineminus">-    };</span>
<a href="#l26.511"></a><span id="l26.511" class="difflineminus">-    let data = overrideDefault(kDefaultCommitReturn, injectedData);</span>
<a href="#l26.512"></a><span id="l26.512" class="difflineminus">-</span>
<a href="#l26.513"></a><span id="l26.513" class="difflineminus">-    // Return the default share URL</span>
<a href="#l26.514"></a><span id="l26.514" class="difflineminus">-    aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l26.515"></a><span id="l26.515" class="difflineminus">-    aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l26.516"></a><span id="l26.516" class="difflineminus">-    aResponse.write(JSON.stringify(data));</span>
<a href="#l26.517"></a><span id="l26.517" class="difflineminus">-</span>
<a href="#l26.518"></a><span id="l26.518" class="difflineminus">-    Services.obs.notifyObservers(null, &quot;cloudfile:getFileURL&quot;, filename);</span>
<a href="#l26.519"></a><span id="l26.519" class="difflineminus">-  },</span>
<a href="#l26.520"></a><span id="l26.520" class="difflineminus">-};</span>
<a href="#l26.521"></a><span id="l26.521" class="difflineminus">-</span>
<a href="#l26.522"></a><span id="l26.522" class="difflineminus">-function MockHightailDeleterSimple(aHightail) {</span>
<a href="#l26.523"></a><span id="l26.523" class="difflineminus">-  this._server = null;</span>
<a href="#l26.524"></a><span id="l26.524" class="difflineminus">-  this._hightail = aHightail;</span>
<a href="#l26.525"></a><span id="l26.525" class="difflineminus">-  this._expectDelete = [];</span>
<a href="#l26.526"></a><span id="l26.526" class="difflineminus">-}</span>
<a href="#l26.527"></a><span id="l26.527" class="difflineminus">-</span>
<a href="#l26.528"></a><span id="l26.528" class="difflineminus">-MockHightailDeleterSimple.prototype = {</span>
<a href="#l26.529"></a><span id="l26.529" class="difflineminus">-  init(aServer) {</span>
<a href="#l26.530"></a><span id="l26.530" class="difflineminus">-    this._server = aServer;</span>
<a href="#l26.531"></a><span id="l26.531" class="difflineminus">-  },</span>
<a href="#l26.532"></a><span id="l26.532" class="difflineminus">-  shutdown() {},</span>
<a href="#l26.533"></a><span id="l26.533" class="difflineminus">-</span>
<a href="#l26.534"></a><span id="l26.534" class="difflineminus">-  receiveDelete(aRequest, aResponse) {</span>
<a href="#l26.535"></a><span id="l26.535" class="difflineminus">-    if (aRequest.method != &quot;DELETE&quot;) {</span>
<a href="#l26.536"></a><span id="l26.536" class="difflineminus">-      aResponse.setStatusLine(null, 500, &quot;Bad request&quot;);</span>
<a href="#l26.537"></a><span id="l26.537" class="difflineminus">-      aResponse.write(&quot;Expected a DELETE for deleting.&quot;);</span>
<a href="#l26.538"></a><span id="l26.538" class="difflineminus">-      return;</span>
<a href="#l26.539"></a><span id="l26.539" class="difflineminus">-    }</span>
<a href="#l26.540"></a><span id="l26.540" class="difflineminus">-</span>
<a href="#l26.541"></a><span id="l26.541" class="difflineminus">-</span>
<a href="#l26.542"></a><span id="l26.542" class="difflineminus">-    let fileId = aRequest.path.substring(kDeletePath.length + 1);</span>
<a href="#l26.543"></a><span id="l26.543" class="difflineminus">-</span>
<a href="#l26.544"></a><span id="l26.544" class="difflineminus">-    if (!this._hightail.registry.hasItemId(fileId)) {</span>
<a href="#l26.545"></a><span id="l26.545" class="difflineminus">-      aResponse.setStatusLine(null, 500, &quot;Bad request&quot;);</span>
<a href="#l26.546"></a><span id="l26.546" class="difflineminus">-      aResponse.write(&quot;The item ID &quot; + fileId + &quot; did not map to an item &quot;</span>
<a href="#l26.547"></a><span id="l26.547" class="difflineminus">-                      + &quot;we were prepared for deleting&quot;);</span>
<a href="#l26.548"></a><span id="l26.548" class="difflineminus">-      return;</span>
<a href="#l26.549"></a><span id="l26.549" class="difflineminus">-    }</span>
<a href="#l26.550"></a><span id="l26.550" class="difflineminus">-</span>
<a href="#l26.551"></a><span id="l26.551" class="difflineminus">-    let filename = this._hightail.registry.lookupFilename(fileId);</span>
<a href="#l26.552"></a><span id="l26.552" class="difflineminus">-    let itemIndex = this._expectDelete.indexOf(filename);</span>
<a href="#l26.553"></a><span id="l26.553" class="difflineminus">-    if (itemIndex == -1) {</span>
<a href="#l26.554"></a><span id="l26.554" class="difflineminus">-      aResponse.setStatusLine(null, 500, &quot;Bad request&quot;);</span>
<a href="#l26.555"></a><span id="l26.555" class="difflineminus">-      aResponse.write(&quot;Not prepared to delete file with filename: &quot;</span>
<a href="#l26.556"></a><span id="l26.556" class="difflineminus">-                      + filename);</span>
<a href="#l26.557"></a><span id="l26.557" class="difflineminus">-      return;</span>
<a href="#l26.558"></a><span id="l26.558" class="difflineminus">-    }</span>
<a href="#l26.559"></a><span id="l26.559" class="difflineminus">-</span>
<a href="#l26.560"></a><span id="l26.560" class="difflineminus">-    this._expectDelete.splice(itemIndex, 1);</span>
<a href="#l26.561"></a><span id="l26.561" class="difflineminus">-</span>
<a href="#l26.562"></a><span id="l26.562" class="difflineminus">-    let response = {status: 200};</span>
<a href="#l26.563"></a><span id="l26.563" class="difflineminus">-    aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l26.564"></a><span id="l26.564" class="difflineminus">-    aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l26.565"></a><span id="l26.565" class="difflineminus">-    aResponse.write(JSON.stringify(response));</span>
<a href="#l26.566"></a><span id="l26.566" class="difflineminus">-</span>
<a href="#l26.567"></a><span id="l26.567" class="difflineminus">-    Services.obs.notifyObservers(null, &quot;cloudfile:deleteFile&quot;, filename);</span>
<a href="#l26.568"></a><span id="l26.568" class="difflineminus">-    this._server.registerPathHandler(aRequest.path, null);</span>
<a href="#l26.569"></a><span id="l26.569" class="difflineminus">-  },</span>
<a href="#l26.570"></a><span id="l26.570" class="difflineminus">-  prepareForDelete(aFilename) {</span>
<a href="#l26.571"></a><span id="l26.571" class="difflineminus">-    this._expectDelete.push(aFilename);</span>
<a href="#l26.572"></a><span id="l26.572" class="difflineminus">-  },</span>
<a href="#l26.573"></a><span id="l26.573" class="difflineminus">-};</span>
<a href="#l26.574"></a><span id="l26.574" class="difflineminus">-</span>
<a href="#l26.575"></a><span id="l26.575" class="difflineminus">-function MockHightailDeleterStaleToken(aHightail) {</span>
<a href="#l26.576"></a><span id="l26.576" class="difflineminus">-  this._server = null;</span>
<a href="#l26.577"></a><span id="l26.577" class="difflineminus">-  this._hightail = aHightail;</span>
<a href="#l26.578"></a><span id="l26.578" class="difflineminus">-}</span>
<a href="#l26.579"></a><span id="l26.579" class="difflineminus">-</span>
<a href="#l26.580"></a><span id="l26.580" class="difflineminus">-MockHightailDeleterStaleToken.prototype = {</span>
<a href="#l26.581"></a><span id="l26.581" class="difflineminus">-  init(aServer) {</span>
<a href="#l26.582"></a><span id="l26.582" class="difflineminus">-    this._server = aServer;</span>
<a href="#l26.583"></a><span id="l26.583" class="difflineminus">-  },</span>
<a href="#l26.584"></a><span id="l26.584" class="difflineminus">-</span>
<a href="#l26.585"></a><span id="l26.585" class="difflineminus">-  shutdown() {},</span>
<a href="#l26.586"></a><span id="l26.586" class="difflineminus">-</span>
<a href="#l26.587"></a><span id="l26.587" class="difflineminus">-  receiveDelete(aRequest, aResponse) {</span>
<a href="#l26.588"></a><span id="l26.588" class="difflineminus">-    let data = { errorStatus: { code: 401, message: &quot;Invalid auth token&quot; } };</span>
<a href="#l26.589"></a><span id="l26.589" class="difflineminus">-</span>
<a href="#l26.590"></a><span id="l26.590" class="difflineminus">-    aResponse.setStatusLine(null, 401, &quot;Invalid auth token&quot;);</span>
<a href="#l26.591"></a><span id="l26.591" class="difflineminus">-    aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l26.592"></a><span id="l26.592" class="difflineminus">-    aResponse.write(JSON.stringify(data));</span>
<a href="#l26.593"></a><span id="l26.593" class="difflineminus">-  },</span>
<a href="#l26.594"></a><span id="l26.594" class="difflineminus">-</span>
<a href="#l26.595"></a><span id="l26.595" class="difflineminus">-  prepareForDelete(aFilename) {},</span>
<a href="#l26.596"></a><span id="l26.596" class="difflineminus">-};</span>
<a href="#l26.597"></a><span id="l26.597" class="difflineminus">-</span>
<a href="#l26.598"></a><span id="l26.598" class="difflineminus">-function MockHightailAuthCounter(aHightail) {</span>
<a href="#l26.599"></a><span id="l26.599" class="difflineminus">-  this._server = null;</span>
<a href="#l26.600"></a><span id="l26.600" class="difflineminus">-  this._hightail = aHightail;</span>
<a href="#l26.601"></a><span id="l26.601" class="difflineminus">-  this.count = 0;</span>
<a href="#l26.602"></a><span id="l26.602" class="difflineminus">-}</span>
<a href="#l26.603"></a><span id="l26.603" class="difflineminus">-</span>
<a href="#l26.604"></a><span id="l26.604" class="difflineminus">-MockHightailAuthCounter.prototype = {</span>
<a href="#l26.605"></a><span id="l26.605" class="difflineminus">-</span>
<a href="#l26.606"></a><span id="l26.606" class="difflineminus">-  init(aServer) {</span>
<a href="#l26.607"></a><span id="l26.607" class="difflineminus">-    this._server = aServer;</span>
<a href="#l26.608"></a><span id="l26.608" class="difflineminus">-    this._server.registerPathHandler(kAuthPath, this._auth.bind(this));</span>
<a href="#l26.609"></a><span id="l26.609" class="difflineminus">-  },</span>
<a href="#l26.610"></a><span id="l26.610" class="difflineminus">-</span>
<a href="#l26.611"></a><span id="l26.611" class="difflineminus">-  _auth(aRequest, aResponse) {</span>
<a href="#l26.612"></a><span id="l26.612" class="difflineminus">-    this.count += 1;</span>
<a href="#l26.613"></a><span id="l26.613" class="difflineminus">-    aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l26.614"></a><span id="l26.614" class="difflineminus">-    aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l26.615"></a><span id="l26.615" class="difflineminus">-    aResponse.write(JSON.stringify(kAuthResult));</span>
<a href="#l26.616"></a><span id="l26.616" class="difflineminus">-  },</span>
<a href="#l26.617"></a><span id="l26.617" class="difflineminus">-</span>
<a href="#l26.618"></a><span id="l26.618" class="difflineminus">-  shutdown() {</span>
<a href="#l26.619"></a><span id="l26.619" class="difflineminus">-    this._server.registerPathHandler(kAuthPath, null);</span>
<a href="#l26.620"></a><span id="l26.620" class="difflineminus">-    this._server = null;</span>
<a href="#l26.621"></a><span id="l26.621" class="difflineminus">-    this._auth = null;</span>
<a href="#l26.622"></a><span id="l26.622" class="difflineminus">-  },</span>
<a href="#l26.623"></a><span id="l26.623" class="difflineminus">-};</span>
<a href="#l26.624"></a><span id="l26.624" class="difflineminus">-</span>
<a href="#l26.625"></a><span id="l26.625" class="difflineminus">-/**</span>
<a href="#l26.626"></a><span id="l26.626" class="difflineminus">- * Adds a username and password pair to nsILoginManager</span>
<a href="#l26.627"></a><span id="l26.627" class="difflineminus">- * for the Hightail provider instance to retrieve. This may</span>
<a href="#l26.628"></a><span id="l26.628" class="difflineminus">- * fail if a password already exists for aUserrname.</span>
<a href="#l26.629"></a><span id="l26.629" class="difflineminus">- *</span>
<a href="#l26.630"></a><span id="l26.630" class="difflineminus">- * @param aUsername the username to save the password for</span>
<a href="#l26.631"></a><span id="l26.631" class="difflineminus">- * @param aPassword the password to save</span>
<a href="#l26.632"></a><span id="l26.632" class="difflineminus">- */</span>
<a href="#l26.633"></a><span id="l26.633" class="difflineminus">-function remember_hightail_credentials(aUsername, aPassword) {</span>
<a href="#l26.634"></a><span id="l26.634" class="difflineminus">-  let loginInfo = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l26.635"></a><span id="l26.635" class="difflineminus">-                  .createInstance(Ci.nsILoginInfo);</span>
<a href="#l26.636"></a><span id="l26.636" class="difflineminus">-</span>
<a href="#l26.637"></a><span id="l26.637" class="difflineminus">-  loginInfo.init(kServerURL, null, kServerURL, aUsername,</span>
<a href="#l26.638"></a><span id="l26.638" class="difflineminus">-                 aPassword, &quot;&quot;, &quot;&quot;);</span>
<a href="#l26.639"></a><span id="l26.639" class="difflineminus">-  Services.logins.addLogin(loginInfo);</span>
<a href="#l26.640"></a><span id="l26.640" class="difflineminus">-}</span>
<a href="#l26.641"></a><span id="l26.641" class="difflineminus">-</span>
<a href="#l26.642"></a><span id="l26.642" class="difflineminus">-/**</span>
<a href="#l26.643"></a><span id="l26.643" class="difflineminus">- * Utility functions</span>
<a href="#l26.644"></a><span id="l26.644" class="difflineminus">- */</span>
<a href="#l26.645"></a><span id="l26.645" class="difflineminus">-</span>
<a href="#l26.646"></a><span id="l26.646" class="difflineminus">-function generateObservableRequestHandler(aKey, aValue, aString, aOptions) {</span>
<a href="#l26.647"></a><span id="l26.647" class="difflineminus">-  aOptions = overrideDefault(kDefaultReturnHeader, aOptions);</span>
<a href="#l26.648"></a><span id="l26.648" class="difflineminus">-</span>
<a href="#l26.649"></a><span id="l26.649" class="difflineminus">-  let subjectString = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l26.650"></a><span id="l26.650" class="difflineminus">-                      .createInstance(Ci.nsISupportsString);</span>
<a href="#l26.651"></a><span id="l26.651" class="difflineminus">-  subjectString.data = aString;</span>
<a href="#l26.652"></a><span id="l26.652" class="difflineminus">-</span>
<a href="#l26.653"></a><span id="l26.653" class="difflineminus">-  let func = function(aMeta, aResponse) {</span>
<a href="#l26.654"></a><span id="l26.654" class="difflineminus">-    aResponse.setStatusLine(null, aOptions.statusCode,</span>
<a href="#l26.655"></a><span id="l26.655" class="difflineminus">-                            aOptions.statusString);</span>
<a href="#l26.656"></a><span id="l26.656" class="difflineminus">-    aResponse.setHeader(&quot;Content-Type&quot;, aOptions.contentType);</span>
<a href="#l26.657"></a><span id="l26.657" class="difflineminus">-    aResponse.write(aString);</span>
<a href="#l26.658"></a><span id="l26.658" class="difflineminus">-    Services.obs.notifyObservers(subjectString, aKey, aValue);</span>
<a href="#l26.659"></a><span id="l26.659" class="difflineminus">-  };</span>
<a href="#l26.660"></a><span id="l26.660" class="difflineminus">-  return func;</span>
<a href="#l26.661"></a><span id="l26.661" class="difflineminus">-}</span>
<a href="#l26.662"></a><span id="l26.662" class="difflineminus">-</span>
<a href="#l26.663"></a><span id="l26.663" class="difflineminus">-function overrideDefault(aDefault, aData) {</span>
<a href="#l26.664"></a><span id="l26.664" class="difflineminus">-  if (aData === undefined)</span>
<a href="#l26.665"></a><span id="l26.665" class="difflineminus">-    return aDefault;</span>
<a href="#l26.666"></a><span id="l26.666" class="difflineminus">-</span>
<a href="#l26.667"></a><span id="l26.667" class="difflineminus">-  for (let param in aDefault) {</span>
<a href="#l26.668"></a><span id="l26.668" class="difflineminus">-    if (param in aData)</span>
<a href="#l26.669"></a><span id="l26.669" class="difflineminus">-      aDefault[param] = aData[param];</span>
<a href="#l26.670"></a><span id="l26.670" class="difflineminus">-  }</span>
<a href="#l26.671"></a><span id="l26.671" class="difflineminus">-  return aDefault;</span>
<a href="#l26.672"></a><span id="l26.672" class="difflineminus">-}</span>
<a href="#l26.673"></a><span id="l26.673" class="difflineminus">-</span>
<a href="#l26.674"></a><span id="l26.674" class="difflineminus">-</span>
<a href="#l26.675"></a><span id="l26.675" class="difflineminus">-/**</span>
<a href="#l26.676"></a><span id="l26.676" class="difflineminus">- * Large swaths of this were liberally stolen from</span>
<a href="#l26.677"></a><span id="l26.677" class="difflineminus">- * mozilla/toolkit/crashreporter/test/browser/crashreport.sjs</span>
<a href="#l26.678"></a><span id="l26.678" class="difflineminus">- *</span>
<a href="#l26.679"></a><span id="l26.679" class="difflineminus">- */</span>
<a href="#l26.680"></a><span id="l26.680" class="difflineminus">-function generateUUID() {</span>
<a href="#l26.681"></a><span id="l26.681" class="difflineminus">-  let uuidGen = Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l26.682"></a><span id="l26.682" class="difflineminus">-                  .getService(Ci.nsIUUIDGenerator);</span>
<a href="#l26.683"></a><span id="l26.683" class="difflineminus">-  let uuid = uuidGen.generateUUID().toString();</span>
<a href="#l26.684"></a><span id="l26.684" class="difflineminus">-  return uuid.substring(1, uuid.length - 2);</span>
<a href="#l26.685"></a><span id="l26.685" class="difflineminus">-</span>
<a href="#l26.686"></a><span id="l26.686" class="difflineminus">-}</span>
<a href="#l26.687"></a><span id="l26.687" class="difflineminus">-</span>
<a href="#l26.688"></a><span id="l26.688" class="difflineminus">-function parseHeaders(data, start) {</span>
<a href="#l26.689"></a><span id="l26.689" class="difflineminus">-  let headers = {};</span>
<a href="#l26.690"></a><span id="l26.690" class="difflineminus">-</span>
<a href="#l26.691"></a><span id="l26.691" class="difflineminus">-  while (true) {</span>
<a href="#l26.692"></a><span id="l26.692" class="difflineminus">-    let end = data.indexOf(&quot;\r\n&quot;, start);</span>
<a href="#l26.693"></a><span id="l26.693" class="difflineminus">-    if (end == -1) {</span>
<a href="#l26.694"></a><span id="l26.694" class="difflineminus">-      end = data.length;</span>
<a href="#l26.695"></a><span id="l26.695" class="difflineminus">-    }</span>
<a href="#l26.696"></a><span id="l26.696" class="difflineminus">-    let line = data.substring(start, end);</span>
<a href="#l26.697"></a><span id="l26.697" class="difflineminus">-    start = end + 2;</span>
<a href="#l26.698"></a><span id="l26.698" class="difflineminus">-    if (line == &quot;&quot;)</span>
<a href="#l26.699"></a><span id="l26.699" class="difflineminus">-      // empty line, we're done</span>
<a href="#l26.700"></a><span id="l26.700" class="difflineminus">-      break;</span>
<a href="#l26.701"></a><span id="l26.701" class="difflineminus">-</span>
<a href="#l26.702"></a><span id="l26.702" class="difflineminus">-    // XXX: this doesn't handle multi-line headers. do we care?</span>
<a href="#l26.703"></a><span id="l26.703" class="difflineminus">-    let [name, value] = line.split(&quot;:&quot;);</span>
<a href="#l26.704"></a><span id="l26.704" class="difflineminus">-    // XXX: not normalized, should probably use nsHttpHeaders or something</span>
<a href="#l26.705"></a><span id="l26.705" class="difflineminus">-    headers[name] = value.trimLeft();</span>
<a href="#l26.706"></a><span id="l26.706" class="difflineminus">-  }</span>
<a href="#l26.707"></a><span id="l26.707" class="difflineminus">-  return [headers, start];</span>
<a href="#l26.708"></a><span id="l26.708" class="difflineminus">-}</span>
<a href="#l26.709"></a><span id="l26.709" class="difflineminus">-</span>
<a href="#l26.710"></a><span id="l26.710" class="difflineminus">-function parseMultipartForm(request) {</span>
<a href="#l26.711"></a><span id="l26.711" class="difflineminus">-  let boundary = null;</span>
<a href="#l26.712"></a><span id="l26.712" class="difflineminus">-  // See if this is a multipart/form-data request, and if so, find the</span>
<a href="#l26.713"></a><span id="l26.713" class="difflineminus">-  // boundary string</span>
<a href="#l26.714"></a><span id="l26.714" class="difflineminus">-  if (request.hasHeader(&quot;Content-Type&quot;)) {</span>
<a href="#l26.715"></a><span id="l26.715" class="difflineminus">-    let contenttype = request.getHeader(&quot;Content-Type&quot;);</span>
<a href="#l26.716"></a><span id="l26.716" class="difflineminus">-    let bits = contenttype.split(&quot;;&quot;);</span>
<a href="#l26.717"></a><span id="l26.717" class="difflineminus">-    if (bits[0] == &quot;multipart/form-data&quot;) {</span>
<a href="#l26.718"></a><span id="l26.718" class="difflineminus">-      for (let i = 1; i &lt; bits.length; i++) {</span>
<a href="#l26.719"></a><span id="l26.719" class="difflineminus">-        let b = bits[i].trimLeft();</span>
<a href="#l26.720"></a><span id="l26.720" class="difflineminus">-        if (b.startsWith(&quot;boundary=&quot;)) {</span>
<a href="#l26.721"></a><span id="l26.721" class="difflineminus">-          // grab everything after boundary=</span>
<a href="#l26.722"></a><span id="l26.722" class="difflineminus">-          boundary = &quot;--&quot; + b.substring(9);</span>
<a href="#l26.723"></a><span id="l26.723" class="difflineminus">-          break;</span>
<a href="#l26.724"></a><span id="l26.724" class="difflineminus">-        }</span>
<a href="#l26.725"></a><span id="l26.725" class="difflineminus">-      }</span>
<a href="#l26.726"></a><span id="l26.726" class="difflineminus">-    }</span>
<a href="#l26.727"></a><span id="l26.727" class="difflineminus">-  }</span>
<a href="#l26.728"></a><span id="l26.728" class="difflineminus">-  if (boundary == null)</span>
<a href="#l26.729"></a><span id="l26.729" class="difflineminus">-    return null;</span>
<a href="#l26.730"></a><span id="l26.730" class="difflineminus">-</span>
<a href="#l26.731"></a><span id="l26.731" class="difflineminus">-  let body = Cc[&quot;@mozilla.org/binaryinputstream;1&quot;]</span>
<a href="#l26.732"></a><span id="l26.732" class="difflineminus">-               .createInstance(Ci.nsIBinaryInputStream);</span>
<a href="#l26.733"></a><span id="l26.733" class="difflineminus">-  body.setInputStream(request.bodyInputStream);</span>
<a href="#l26.734"></a><span id="l26.734" class="difflineminus">-</span>
<a href="#l26.735"></a><span id="l26.735" class="difflineminus">-  let avail;</span>
<a href="#l26.736"></a><span id="l26.736" class="difflineminus">-  let bytes = [];</span>
<a href="#l26.737"></a><span id="l26.737" class="difflineminus">-  while ((avail = body.available()) &gt; 0)</span>
<a href="#l26.738"></a><span id="l26.738" class="difflineminus">-    Array.prototype.push.apply(bytes, body.readByteArray(avail));</span>
<a href="#l26.739"></a><span id="l26.739" class="difflineminus">-  let data = String.fromCharCode.apply(null, bytes);</span>
<a href="#l26.740"></a><span id="l26.740" class="difflineminus">-  let formData = {};</span>
<a href="#l26.741"></a><span id="l26.741" class="difflineminus">-  let start = 0;</span>
<a href="#l26.742"></a><span id="l26.742" class="difflineminus">-  while (true) {</span>
<a href="#l26.743"></a><span id="l26.743" class="difflineminus">-    // read first line</span>
<a href="#l26.744"></a><span id="l26.744" class="difflineminus">-    let end = data.indexOf(&quot;\r\n&quot;, start);</span>
<a href="#l26.745"></a><span id="l26.745" class="difflineminus">-    if (end == -1) {</span>
<a href="#l26.746"></a><span id="l26.746" class="difflineminus">-      end = data.length;</span>
<a href="#l26.747"></a><span id="l26.747" class="difflineminus">-    }</span>
<a href="#l26.748"></a><span id="l26.748" class="difflineminus">-</span>
<a href="#l26.749"></a><span id="l26.749" class="difflineminus">-    let line = data.substring(start, end);</span>
<a href="#l26.750"></a><span id="l26.750" class="difflineminus">-    // look for closing boundary delimiter line</span>
<a href="#l26.751"></a><span id="l26.751" class="difflineminus">-    if (line == boundary + &quot;--&quot;) {</span>
<a href="#l26.752"></a><span id="l26.752" class="difflineminus">-      break;</span>
<a href="#l26.753"></a><span id="l26.753" class="difflineminus">-    }</span>
<a href="#l26.754"></a><span id="l26.754" class="difflineminus">-</span>
<a href="#l26.755"></a><span id="l26.755" class="difflineminus">-    if (line != boundary) {</span>
<a href="#l26.756"></a><span id="l26.756" class="difflineminus">-      dump(&quot;expected boundary line but didn't find it!&quot;);</span>
<a href="#l26.757"></a><span id="l26.757" class="difflineminus">-      break;</span>
<a href="#l26.758"></a><span id="l26.758" class="difflineminus">-    }</span>
<a href="#l26.759"></a><span id="l26.759" class="difflineminus">-</span>
<a href="#l26.760"></a><span id="l26.760" class="difflineminus">-    // parse headers</span>
<a href="#l26.761"></a><span id="l26.761" class="difflineminus">-    start = end + 2;</span>
<a href="#l26.762"></a><span id="l26.762" class="difflineminus">-    let headers = null;</span>
<a href="#l26.763"></a><span id="l26.763" class="difflineminus">-    [headers, start] = parseHeaders(data, start);</span>
<a href="#l26.764"></a><span id="l26.764" class="difflineminus">-</span>
<a href="#l26.765"></a><span id="l26.765" class="difflineminus">-    // find next boundary string</span>
<a href="#l26.766"></a><span id="l26.766" class="difflineminus">-    end = data.indexOf(&quot;\r\n&quot; + boundary, start);</span>
<a href="#l26.767"></a><span id="l26.767" class="difflineminus">-    if (end == -1) {</span>
<a href="#l26.768"></a><span id="l26.768" class="difflineminus">-      dump(&quot;couldn't find next boundary string\n&quot;);</span>
<a href="#l26.769"></a><span id="l26.769" class="difflineminus">-      break;</span>
<a href="#l26.770"></a><span id="l26.770" class="difflineminus">-    }</span>
<a href="#l26.771"></a><span id="l26.771" class="difflineminus">-</span>
<a href="#l26.772"></a><span id="l26.772" class="difflineminus">-    // read part data, stick in formData using Content-Disposition header</span>
<a href="#l26.773"></a><span id="l26.773" class="difflineminus">-    let part = data.substring(start, end);</span>
<a href="#l26.774"></a><span id="l26.774" class="difflineminus">-    start = end + 2;</span>
<a href="#l26.775"></a><span id="l26.775" class="difflineminus">-</span>
<a href="#l26.776"></a><span id="l26.776" class="difflineminus">-    if (&quot;Content-Disposition&quot; in headers) {</span>
<a href="#l26.777"></a><span id="l26.777" class="difflineminus">-      let bits = headers[&quot;Content-Disposition&quot;].split(&quot;;&quot;);</span>
<a href="#l26.778"></a><span id="l26.778" class="difflineminus">-      if (bits[0] == &quot;form-data&quot;) {</span>
<a href="#l26.779"></a><span id="l26.779" class="difflineminus">-        for (let i = 0; i &lt; bits.length; i++) {</span>
<a href="#l26.780"></a><span id="l26.780" class="difflineminus">-          let b = bits[i].trimLeft();</span>
<a href="#l26.781"></a><span id="l26.781" class="difflineminus">-          if (b.startsWith(&quot;name=&quot;)) {</span>
<a href="#l26.782"></a><span id="l26.782" class="difflineminus">-            // TODO: handle non-ascii here?</span>
<a href="#l26.783"></a><span id="l26.783" class="difflineminus">-            let name = b.substring(6, b.length - 1);</span>
<a href="#l26.784"></a><span id="l26.784" class="difflineminus">-            // TODO: handle multiple-value properties?</span>
<a href="#l26.785"></a><span id="l26.785" class="difflineminus">-            formData[name] = part;</span>
<a href="#l26.786"></a><span id="l26.786" class="difflineminus">-          }</span>
<a href="#l26.787"></a><span id="l26.787" class="difflineminus">-          if (b.startsWith(&quot;filename=&quot;)) {</span>
<a href="#l26.788"></a><span id="l26.788" class="difflineminus">-            let filename = b.substring(10, b.length - 1);</span>
<a href="#l26.789"></a><span id="l26.789" class="difflineminus">-            formData.filename = filename;</span>
<a href="#l26.790"></a><span id="l26.790" class="difflineminus">-          }</span>
<a href="#l26.791"></a><span id="l26.791" class="difflineminus">-          // TODO: handle filename= ?</span>
<a href="#l26.792"></a><span id="l26.792" class="difflineminus">-          // TODO: handle multipart/mixed for multi-file uploads?</span>
<a href="#l26.793"></a><span id="l26.793" class="difflineminus">-        }</span>
<a href="#l26.794"></a><span id="l26.794" class="difflineminus">-      }</span>
<a href="#l26.795"></a><span id="l26.795" class="difflineminus">-    }</span>
<a href="#l26.796"></a><span id="l26.796" class="difflineminus">-  }</span>
<a href="#l26.797"></a><span id="l26.797" class="difflineminus">-  return formData;</span>
<a href="#l26.798"></a><span id="l26.798" class="difflineminus">-}</span>
<a href="#l26.799"></a><span id="l26.799" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mail/themes/linux/jar.mn</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mail/themes/linux/jar.mn</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -80,18 +80,16 @@ classic.jar:</span>
<a href="#l27.4"></a><span id="l27.4">   skin/classic/messenger/addressbook/icons/addressbook-toolbar-small.png   (mail/addrbook/addressbook-toolbar-small.png)</span>
<a href="#l27.5"></a><span id="l27.5">   skin/classic/messenger/addressbook/icons/ablist.png         (mail/addrbook/ablist.png)</span>
<a href="#l27.6"></a><span id="l27.6">   skin/classic/messenger/addressbook/icons/contact-generic.png             (mail/addrbook/contact-generic.png)</span>
<a href="#l27.7"></a><span id="l27.7">   skin/classic/messenger/addressbook/icons/contact-generic-tiny.png        (mail/addrbook/contact-generic-tiny.png)</span>
<a href="#l27.8"></a><span id="l27.8">   skin/classic/messenger/addressbook/icons/abcard-large.png   (mail/addrbook/abcard-large.png)</span>
<a href="#l27.9"></a><span id="l27.9">   skin/classic/messenger/addressbook/icons/remote-addrbook.png (mail/addrbook/remote-addrbook.png)</span>
<a href="#l27.10"></a><span id="l27.10">   skin/classic/messenger/addressbook/icons/remote-addrbook-error.png      (mail/addrbook/remote-addrbook-error.png)</span>
<a href="#l27.11"></a><span id="l27.11">   skin/classic/messenger/addressbook/icons/secure-remote-addrbook.png     (mail/addrbook/secure-remote-addrbook.png)</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  skin/classic/messenger/cloudfile/Hightail/fileExceedsLimit.css       (mail/cloudfile/Hightail/fileExceedsLimit.css)</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-  skin/classic/messenger/cloudfile/Hightail/check.png                  (mail/cloudfile/Hightail/check.png)</span>
<a href="#l27.14"></a><span id="l27.14">   skin/classic/messenger/messengercompose/messengercompose.css (mail/compose/messengercompose.css)</span>
<a href="#l27.15"></a><span id="l27.15">   skin/classic/messenger/downloads/aboutDownloads.css         (mail/downloads/aboutDownloads.css)</span>
<a href="#l27.16"></a><span id="l27.16"> % skin messenger-newsblog classic/1.0 %skin/classic/messenger-newsblog/</span>
<a href="#l27.17"></a><span id="l27.17">   skin/classic/messenger-newsblog/feed-subscriptions.css      (mail/newsblog/feed-subscriptions.css)</span>
<a href="#l27.18"></a><span id="l27.18">   skin/classic/messenger-newsblog/rss-feed.png                (mail/newsblog/rss-feed.png)</span>
<a href="#l27.19"></a><span id="l27.19">   skin/classic/messenger-newsblog/rss-feed-folder.png         (mail/newsblog/rss-feed-folder.png)</span>
<a href="#l27.20"></a><span id="l27.20">   skin/classic/messenger/preferences/alwaysAsk.png            (mail/preferences/alwaysAsk.png)</span>
<a href="#l27.21"></a><span id="l27.21">   skin/classic/messenger/preferences/preferences.css          (mail/preferences/preferences.css)</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineat">@@ -173,20 +171,18 @@ classic.jar:</span>
<a href="#l27.23"></a><span id="l27.23">   skin/classic/messenger/newmailaccount/accountProvisioner.css (mail/newmailaccount/accountProvisioner.css)</span>
<a href="#l27.24"></a><span id="l27.24">   skin/classic/messenger/newmailaccount/search.gif            (mail/newmailaccount/search.gif)</span>
<a href="#l27.25"></a><span id="l27.25">   skin/classic/messenger/newmailaccount/spinner.gif           (mail/newmailaccount/spinner.gif)</span>
<a href="#l27.26"></a><span id="l27.26">   skin/classic/messenger/newmailaccount/success-addons.png    (mail/newmailaccount/success-addons.png)</span>
<a href="#l27.27"></a><span id="l27.27">   skin/classic/messenger/newmailaccount/success-border.png    (mail/newmailaccount/success-border.png)</span>
<a href="#l27.28"></a><span id="l27.28">   skin/classic/messenger/newmailaccount/success-compose.png   (mail/newmailaccount/success-compose.png)</span>
<a href="#l27.29"></a><span id="l27.29">   skin/classic/messenger/newmailaccount/success-signature.png (mail/newmailaccount/success-signature.png)</span>
<a href="#l27.30"></a><span id="l27.30">   skin/classic/messenger/newmailaccount/search.png            (mail/newmailaccount/search.png)</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-  skin/classic/messenger/icons/hightail.png                   (mail/icons/hightail.png)</span>
<a href="#l27.32"></a><span id="l27.32">   skin/classic/messenger/sanitizeDialog.css                   (mail/sanitizeDialog.css)</span>
<a href="#l27.33"></a><span id="l27.33">   skin/classic/messenger/converterDialog.css                  (mail/converterDialog.css)</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineminus">-  skin/classic/messenger/icons/box-logo.png                   (mail/icons/box-logo.png)</span>
<a href="#l27.35"></a><span id="l27.35"> % skin communicator classic/1.0 %skin/classic/communicator/</span>
<a href="#l27.36"></a><span id="l27.36">   skin/classic/communicator/icons/smileys/smiley-smile.png    (mail/icons/smiley-smile.png)</span>
<a href="#l27.37"></a><span id="l27.37">   skin/classic/communicator/icons/smileys/smiley-frown.png    (mail/icons/smiley-frown.png)</span>
<a href="#l27.38"></a><span id="l27.38">   skin/classic/communicator/icons/smileys/smiley-wink.png     (mail/icons/smiley-wink.png)</span>
<a href="#l27.39"></a><span id="l27.39">   skin/classic/communicator/icons/smileys/smiley-tongue-out.png (mail/icons/smiley-tongue-out.png)</span>
<a href="#l27.40"></a><span id="l27.40">   skin/classic/communicator/icons/smileys/smiley-laughing.png (mail/icons/smiley-laughing.png)</span>
<a href="#l27.41"></a><span id="l27.41">   skin/classic/communicator/icons/smileys/smiley-embarassed.png (mail/icons/smiley-embarassed.png)</span>
<a href="#l27.42"></a><span id="l27.42">   skin/classic/communicator/icons/smileys/smiley-undecided.png  (mail/icons/smiley-undecided.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">deleted file mode 100644</span>
<a href="#l28.2"></a><span id="l28.2">index b0f5119deb0c8745faebfd39efacd21671fbe3d7..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l28.3"></a><span id="l28.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">deleted file mode 100644</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineminus">--- a/mail/themes/linux/mail/cloudfile/Hightail/fileExceedsLimit.css</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineplus">+++ /dev/null</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineat">@@ -1,19 +0,0 @@</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.6"></a><span id="l29.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l29.7"></a><span id="l29.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.8"></a><span id="l29.8" class="difflineminus">-</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineminus">-html, body {</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineminus">-  font: message-box;</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineminus">-  margin: 0;</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-}</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-#fileExceedsLimit {</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">-  padding-left: 15px;</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineminus">-  padding-right: 13px;</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineminus">-  padding-top: 15px;</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineminus">-  padding-bottom: 15px;</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineminus">-}</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineminus">-</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-#title {</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-  font-weight: bold;</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">deleted file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2">index 87ca7deb6c0b7bcee770c95d6b14deb3ea2ec0dd..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l30.3"></a><span id="l30.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1">deleted file mode 100644</span>
<a href="#l31.2"></a><span id="l31.2">index 04b8a6a955b90acb175216c866da98c62a3e1631..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l31.3"></a><span id="l31.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mail/themes/osx/jar.mn</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mail/themes/osx/jar.mn</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -76,18 +76,16 @@ classic.jar:</span>
<a href="#l32.4"></a><span id="l32.4">   skin/classic/messenger/addressbook/icons/contact-generic@2x.png          (mail/addrbook/contact-generic@2x.png)</span>
<a href="#l32.5"></a><span id="l32.5">   skin/classic/messenger/addressbook/icons/contact-generic-tiny.png        (mail/addrbook/contact-generic-tiny.png)</span>
<a href="#l32.6"></a><span id="l32.6">   skin/classic/messenger/addressbook/icons/contact-generic-tiny@2x.png     (mail/addrbook/contact-generic-tiny@2x.png)</span>
<a href="#l32.7"></a><span id="l32.7">   skin/classic/messenger/addressbook/icons/addressbook@2x.png              (mail/addrbook/addressbook@2x.png)</span>
<a href="#l32.8"></a><span id="l32.8">   skin/classic/messenger/addressbook/icons/addrbook.png                    (mail/addrbook/addrbook.png)</span>
<a href="#l32.9"></a><span id="l32.9">   skin/classic/messenger/addressbook/icons/remote-addrbook-error.png       (mail/addrbook/remote-addrbook-error.png)</span>
<a href="#l32.10"></a><span id="l32.10">   skin/classic/messenger/addressbook/icons/remote-addrbook.png             (mail/addrbook/remote-addrbook.png)</span>
<a href="#l32.11"></a><span id="l32.11">   skin/classic/messenger/addressbook/icons/secure-remote-addrbook.png      (mail/addrbook/secure-remote-addrbook.png)</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  skin/classic/messenger/cloudfile/Hightail/fileExceedsLimit.css           (mail/cloudfile/Hightail/fileExceedsLimit.css)</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-  skin/classic/messenger/cloudfile/Hightail/check.png                      (mail/cloudfile/Hightail/check.png)</span>
<a href="#l32.14"></a><span id="l32.14">   skin/classic/messenger/messengercompose/messengercompose.css             (mail/compose/messengercompose.css)</span>
<a href="#l32.15"></a><span id="l32.15">   skin/classic/messenger/messengercompose/emoticon_cool.png                (mail/compose/emoticon_cool.png)</span>
<a href="#l32.16"></a><span id="l32.16">   skin/classic/messenger/messengercompose/emoticon_cry.png                 (mail/compose/emoticon_cry.png)</span>
<a href="#l32.17"></a><span id="l32.17">   skin/classic/messenger/messengercompose/emoticon_embarrassed.png         (mail/compose/emoticon_embarrassed.png)</span>
<a href="#l32.18"></a><span id="l32.18">   skin/classic/messenger/messengercompose/emoticon_foot_in_mouth.png       (mail/compose/emoticon_foot_in_mouth.png)</span>
<a href="#l32.19"></a><span id="l32.19">   skin/classic/messenger/messengercompose/emoticon_frown.png               (mail/compose/emoticon_frown.png)</span>
<a href="#l32.20"></a><span id="l32.20">   skin/classic/messenger/messengercompose/emoticon_innocent.png            (mail/compose/emoticon_innocent.png)</span>
<a href="#l32.21"></a><span id="l32.21">   skin/classic/messenger/messengercompose/emoticon_kiss.png                (mail/compose/emoticon_kiss.png)</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineat">@@ -227,20 +225,18 @@ classic.jar:</span>
<a href="#l32.23"></a><span id="l32.23">   skin/classic/messenger/newmailaccount/accountProvisioner.css   (mail/newmailaccount/accountProvisioner.css)</span>
<a href="#l32.24"></a><span id="l32.24">   skin/classic/messenger/newmailaccount/search.gif               (mail/newmailaccount/search.gif)</span>
<a href="#l32.25"></a><span id="l32.25">   skin/classic/messenger/newmailaccount/spinner.gif              (mail/newmailaccount/spinner.gif)</span>
<a href="#l32.26"></a><span id="l32.26">   skin/classic/messenger/newmailaccount/success-addons.png       (mail/newmailaccount/success-addons.png)</span>
<a href="#l32.27"></a><span id="l32.27">   skin/classic/messenger/newmailaccount/success-border.png       (mail/newmailaccount/success-border.png)</span>
<a href="#l32.28"></a><span id="l32.28">   skin/classic/messenger/newmailaccount/success-compose.png      (mail/newmailaccount/success-compose.png)</span>
<a href="#l32.29"></a><span id="l32.29">   skin/classic/messenger/newmailaccount/success-signature.png    (mail/newmailaccount/success-signature.png)</span>
<a href="#l32.30"></a><span id="l32.30">   skin/classic/messenger/newmailaccount/search.png               (mail/newmailaccount/search.png)</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-  skin/classic/messenger/icons/hightail.png                      (mail/icons/hightail.png)</span>
<a href="#l32.32"></a><span id="l32.32">   skin/classic/messenger/sanitizeDialog.css                      (mail/sanitizeDialog.css)</span>
<a href="#l32.33"></a><span id="l32.33">   skin/classic/messenger/converterDialog.css                     (mail/converterDialog.css)</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineminus">-  skin/classic/messenger/icons/box-logo.png                      (mail/icons/box-logo.png)</span>
<a href="#l32.35"></a><span id="l32.35"> % skin communicator classic/1.0 %skin/classic/communicator/</span>
<a href="#l32.36"></a><span id="l32.36">   skin/classic/communicator/smileys.css                          (mail/smileys.css)</span>
<a href="#l32.37"></a><span id="l32.37">   skin/classic/communicator/icons/smileys/smiley-smile.png       (mail/icons/smiley-smile.png)</span>
<a href="#l32.38"></a><span id="l32.38">   skin/classic/communicator/icons/smileys/smiley-frown.png       (mail/icons/smiley-frown.png)</span>
<a href="#l32.39"></a><span id="l32.39">   skin/classic/communicator/icons/smileys/smiley-wink.png        (mail/icons/smiley-wink.png)</span>
<a href="#l32.40"></a><span id="l32.40">   skin/classic/communicator/icons/smileys/smiley-tongue-out.png  (mail/icons/smiley-tongue-out.png)</span>
<a href="#l32.41"></a><span id="l32.41">   skin/classic/communicator/icons/smileys/smiley-laughing.png    (mail/icons/smiley-laughing.png)</span>
<a href="#l32.42"></a><span id="l32.42">   skin/classic/communicator/icons/smileys/smiley-embarassed.png  (mail/icons/smiley-embarassed.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1">deleted file mode 100644</span>
<a href="#l33.2"></a><span id="l33.2">index b0f5119deb0c8745faebfd39efacd21671fbe3d7..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l33.3"></a><span id="l33.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1">deleted file mode 100644</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineminus">--- a/mail/themes/osx/mail/cloudfile/Hightail/fileExceedsLimit.css</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineplus">+++ /dev/null</span>
<a href="#l34.4"></a><span id="l34.4" class="difflineat">@@ -1,19 +0,0 @@</span>
<a href="#l34.5"></a><span id="l34.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l34.6"></a><span id="l34.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineminus">-</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineminus">-html, body {</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineminus">-  font: message-box;</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineminus">-  margin: 0;</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-}</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineminus">-#fileExceedsLimit {</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineminus">-  padding-left: 15px;</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineminus">-  padding-right: 13px;</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineminus">-  padding-top: 15px;</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineminus">-  padding-bottom: 15px;</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineminus">-}</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineminus">-</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineminus">-#title {</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineminus">-  font-weight: bold;</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1">deleted file mode 100644</span>
<a href="#l35.2"></a><span id="l35.2">index 87ca7deb6c0b7bcee770c95d6b14deb3ea2ec0dd..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l35.3"></a><span id="l35.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1">deleted file mode 100644</span>
<a href="#l36.2"></a><span id="l36.2">index 04b8a6a955b90acb175216c866da98c62a3e1631..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l36.3"></a><span id="l36.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mail/themes/windows/jar.mn</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mail/themes/windows/jar.mn</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -77,18 +77,16 @@ classic.jar:</span>
<a href="#l37.4"></a><span id="l37.4">   skin/classic/messenger/addressbook/icons/addrbook.png       (mail/addrbook/addrbook.png)</span>
<a href="#l37.5"></a><span id="l37.5">   skin/classic/messenger/addressbook/icons/ablist.png         (mail/addrbook/ablist.png)</span>
<a href="#l37.6"></a><span id="l37.6">   skin/classic/messenger/addressbook/icons/contact-generic.png             (mail/addrbook/contact-generic.png)</span>
<a href="#l37.7"></a><span id="l37.7">   skin/classic/messenger/addressbook/icons/contact-generic-tiny.png        (mail/addrbook/contact-generic-tiny.png)</span>
<a href="#l37.8"></a><span id="l37.8">   skin/classic/messenger/addressbook/icons/abcard-large.png                (mail/addrbook/abcard-large.png)</span>
<a href="#l37.9"></a><span id="l37.9">   skin/classic/messenger/addressbook/icons/remote-addrbook.png             (mail/addrbook/remote-addrbook.png)</span>
<a href="#l37.10"></a><span id="l37.10">   skin/classic/messenger/addressbook/icons/remote-addrbook-error.png       (mail/addrbook/remote-addrbook-error.png)</span>
<a href="#l37.11"></a><span id="l37.11">   skin/classic/messenger/addressbook/icons/secure-remote-addrbook.png      (mail/addrbook/secure-remote-addrbook.png)</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-  skin/classic/messenger/cloudfile/Hightail/fileExceedsLimit.css       (mail/cloudfile/Hightail/fileExceedsLimit.css)</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-  skin/classic/messenger/cloudfile/Hightail/check.png                  (mail/cloudfile/Hightail/check.png)</span>
<a href="#l37.14"></a><span id="l37.14">   skin/classic/messenger/messengercompose/messengercompose.css (mail/compose/messengercompose.css)</span>
<a href="#l37.15"></a><span id="l37.15">   skin/classic/messenger/downloads/aboutDownloads.css         (mail/downloads/aboutDownloads.css)</span>
<a href="#l37.16"></a><span id="l37.16">   skin/classic/messenger/preferences/aboutPreferences.css     (mail/preferences/aboutPreferences.css)</span>
<a href="#l37.17"></a><span id="l37.17">   skin/classic/messenger/preferences/alwaysAsk.png            (mail/preferences/alwaysAsk.png)</span>
<a href="#l37.18"></a><span id="l37.18">   skin/classic/messenger/preferences/application.png          (mail/preferences/application.png)</span>
<a href="#l37.19"></a><span id="l37.19">   skin/classic/messenger/preferences/applications.css         (mail/preferences/applications.css)</span>
<a href="#l37.20"></a><span id="l37.20">   skin/classic/messenger/preferences/dialog.css               (mail/preferences/dialog.css)</span>
<a href="#l37.21"></a><span id="l37.21">   skin/classic/messenger/preferences/preferences.css          (mail/preferences/preferences.css)</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineat">@@ -194,18 +192,16 @@ classic.jar:</span>
<a href="#l37.23"></a><span id="l37.23">   skin/classic/messenger/newmailaccount/spinner.gif           (mail/newmailaccount/spinner.gif)</span>
<a href="#l37.24"></a><span id="l37.24">   skin/classic/messenger/newmailaccount/success-addons.png    (mail/newmailaccount/success-addons.png)</span>
<a href="#l37.25"></a><span id="l37.25">   skin/classic/messenger/newmailaccount/success-border.png    (mail/newmailaccount/success-border.png)</span>
<a href="#l37.26"></a><span id="l37.26">   skin/classic/messenger/newmailaccount/success-compose.png   (mail/newmailaccount/success-compose.png)</span>
<a href="#l37.27"></a><span id="l37.27">   skin/classic/messenger/newmailaccount/success-signature.png (mail/newmailaccount/success-signature.png)</span>
<a href="#l37.28"></a><span id="l37.28">   skin/classic/messenger/newmailaccount/search.png            (mail/newmailaccount/search.png)</span>
<a href="#l37.29"></a><span id="l37.29">   skin/classic/messenger/sanitizeDialog.css                   (mail/sanitizeDialog.css)</span>
<a href="#l37.30"></a><span id="l37.30">   skin/classic/messenger/converterDialog.css                  (mail/converterDialog.css)</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineminus">-  skin/classic/messenger/icons/hightail.png                   (mail/icons/hightail.png)</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineminus">-  skin/classic/messenger/icons/box-logo.png                   (mail/icons/box-logo.png)</span>
<a href="#l37.33"></a><span id="l37.33"> % skin communicator classic/1.0 %skin/classic/communicator/</span>
<a href="#l37.34"></a><span id="l37.34">   skin/classic/communicator/smileys.css                            (mail/smileys.css)</span>
<a href="#l37.35"></a><span id="l37.35">   skin/classic/communicator/icons/smileys/smiley-smile.png         (mail/icons/smiley-smile.png)</span>
<a href="#l37.36"></a><span id="l37.36">   skin/classic/communicator/icons/smileys/smiley-frown.png         (mail/icons/smiley-frown.png)</span>
<a href="#l37.37"></a><span id="l37.37">   skin/classic/communicator/icons/smileys/smiley-wink.png          (mail/icons/smiley-wink.png)</span>
<a href="#l37.38"></a><span id="l37.38">   skin/classic/communicator/icons/smileys/smiley-tongue-out.png    (mail/icons/smiley-tongue-out.png)</span>
<a href="#l37.39"></a><span id="l37.39">   skin/classic/communicator/icons/smileys/smiley-laughing.png      (mail/icons/smiley-laughing.png)</span>
<a href="#l37.40"></a><span id="l37.40">   skin/classic/communicator/icons/smileys/smiley-embarassed.png    (mail/icons/smiley-embarassed.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1">deleted file mode 100644</span>
<a href="#l38.2"></a><span id="l38.2">index b0f5119deb0c8745faebfd39efacd21671fbe3d7..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l38.3"></a><span id="l38.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1">deleted file mode 100644</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineminus">--- a/mail/themes/windows/mail/cloudfile/Hightail/fileExceedsLimit.css</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineplus">+++ /dev/null</span>
<a href="#l39.4"></a><span id="l39.4" class="difflineat">@@ -1,19 +0,0 @@</span>
<a href="#l39.5"></a><span id="l39.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l39.6"></a><span id="l39.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l39.7"></a><span id="l39.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l39.8"></a><span id="l39.8" class="difflineminus">-</span>
<a href="#l39.9"></a><span id="l39.9" class="difflineminus">-html, body {</span>
<a href="#l39.10"></a><span id="l39.10" class="difflineminus">-  font: message-box;</span>
<a href="#l39.11"></a><span id="l39.11" class="difflineminus">-  margin: 0;</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-}</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineminus">-#fileExceedsLimit {</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineminus">-  padding-left: 15px;</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineminus">-  padding-right: 13px;</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineminus">-  padding-top: 15px;</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineminus">-  padding-bottom: 15px;</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineminus">-}</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineminus">-</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineminus">-#title {</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineminus">-  font-weight: bold;</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1">deleted file mode 100644</span>
<a href="#l40.2"></a><span id="l40.2">index 87ca7deb6c0b7bcee770c95d6b14deb3ea2ec0dd..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l40.3"></a><span id="l40.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1">deleted file mode 100644</span>
<a href="#l41.2"></a><span id="l41.2">index 04b8a6a955b90acb175216c866da98c62a3e1631..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391</span>
<a href="#l41.3"></a><span id="l41.3">GIT binary patch
literal 0
Hc$@&lt;O00001</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

