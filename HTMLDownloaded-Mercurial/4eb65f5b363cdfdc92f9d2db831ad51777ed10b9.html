<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 2229:4eb65f5b363cdfdc92f9d2db831ad51777ed10b9</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 4eb65f5b363cdfdc92f9d2db831ad51777ed10b9" />
<meta property="og:url" content="/comm-central/rev/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9" />
<meta property="og:description" content="Bug 482416 -  Gloda jsmimeemitter.js error: this._curBodyPart is null.  v1 provide confidence in the JS mime emitter. r/sr=bienvenu." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 4eb65f5b363cdfdc92f9d2db831ad51777ed10b9 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9">shortlog</a> |
<a href="/comm-central/log/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9">files</a> |
changeset |
<a href="/comm-central/raw-rev/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9">raw</a>  | <a href="/comm-central/archive/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=482416">Bug 482416</a> -  Gloda jsmimeemitter.js error: this._curBodyPart is null.  v1 provide confidence in the JS mime emitter. r/sr=bienvenu.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 16 Mar 2009 20:37:01 -0700</td></tr>

<tr>
 <td>changeset 2229</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9">4eb65f5b363cdfdc92f9d2db831ad51777ed10b9</a></td>
</tr>



<tr>
<td>parent 2228</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/358ec16450f3b7c058276e06e448e80ebc800c16">358ec16450f3b7c058276e06e448e80ebc800c16</a>
</td>
</tr>

<tr>
<td>child 2230</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d9fef5145cbae23399e813fb8aa041da9cb494e8">d9fef5145cbae23399e813fb8aa041da9cb494e8</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=4eb65f5b363cdfdc92f9d2db831ad51777ed10b9">1802</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Tue, 17 Mar 2009 03:37:17 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4eb65f5b363c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4eb65f5b363cdfdc92f9d2db831ad51777ed10b9">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4eb65f5b363cdfdc92f9d2db831ad51777ed10b9&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4eb65f5b363cdfdc92f9d2db831ad51777ed10b9&newProject=comm-central&newRevision=4eb65f5b363cdfdc92f9d2db831ad51777ed10b9&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4eb65f5b363cdfdc92f9d2db831ad51777ed10b9&newProject=comm-central&newRevision=4eb65f5b363cdfdc92f9d2db831ad51777ed10b9&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4eb65f5b363cdfdc92f9d2db831ad51777ed10b9&newProject=comm-central&newRevision=4eb65f5b363cdfdc92f9d2db831ad51777ed10b9&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=482416">482416</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=482416">Bug 482416</a> -  Gloda jsmimeemitter.js error: this._curBodyPart is null.  v1 provide confidence in the JS mime emitter. r/sr=bienvenu.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/components/jsmimeemitter.js">mailnews/db/gloda/components/jsmimeemitter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/components/jsmimeemitter.js">file</a> |
<a href="/comm-central/annotate/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/components/jsmimeemitter.js">annotate</a> |
<a href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/components/jsmimeemitter.js">diff</a> |
<a href="/comm-central/comparison/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/components/jsmimeemitter.js">comparison</a> |
<a href="/comm-central/log/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/components/jsmimeemitter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/modules/mimemsg.js">mailnews/db/gloda/modules/mimemsg.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/modules/mimemsg.js">file</a> |
<a href="/comm-central/annotate/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/modules/mimemsg.js">annotate</a> |
<a href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/modules/mimemsg.js">diff</a> |
<a href="/comm-central/comparison/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/modules/mimemsg.js">comparison</a> |
<a href="/comm-central/log/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/modules/mimemsg.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/test/resources/messageGenerator.js">mailnews/db/gloda/test/resources/messageGenerator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/test/resources/messageGenerator.js">file</a> |
<a href="/comm-central/annotate/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/test/resources/messageGenerator.js">annotate</a> |
<a href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/test/resources/messageGenerator.js">diff</a> |
<a href="/comm-central/comparison/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/test/resources/messageGenerator.js">comparison</a> |
<a href="/comm-central/log/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/test/resources/messageGenerator.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/test/unit/test_mime_emitter.js">mailnews/db/gloda/test/unit/test_mime_emitter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/test/unit/test_mime_emitter.js">file</a> |
<a href="/comm-central/annotate/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/test/unit/test_mime_emitter.js">annotate</a> |
<a href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/test/unit/test_mime_emitter.js">diff</a> |
<a href="/comm-central/comparison/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/test/unit/test_mime_emitter.js">comparison</a> |
<a href="/comm-central/log/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/db/gloda/test/unit/test_mime_emitter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimei.cpp">mailnews/mime/src/mimei.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimei.cpp">file</a> |
<a href="/comm-central/annotate/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimei.cpp">annotate</a> |
<a href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimei.cpp">diff</a> |
<a href="/comm-central/comparison/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimei.cpp">comparison</a> |
<a href="/comm-central/log/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimei.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimeiimg.cpp">mailnews/mime/src/mimeiimg.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimeiimg.cpp">file</a> |
<a href="/comm-central/annotate/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimeiimg.cpp">annotate</a> |
<a href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimeiimg.cpp">diff</a> |
<a href="/comm-central/comparison/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimeiimg.cpp">comparison</a> |
<a href="/comm-central/log/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimeiimg.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimemoz2.cpp">mailnews/mime/src/mimemoz2.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimemoz2.cpp">file</a> |
<a href="/comm-central/annotate/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimemoz2.cpp">annotate</a> |
<a href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimemoz2.cpp">diff</a> |
<a href="/comm-central/comparison/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimemoz2.cpp">comparison</a> |
<a href="/comm-central/log/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimemoz2.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimemrel.cpp">mailnews/mime/src/mimemrel.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimemrel.cpp">file</a> |
<a href="/comm-central/annotate/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimemrel.cpp">annotate</a> |
<a href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimemrel.cpp">diff</a> |
<a href="/comm-central/comparison/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimemrel.cpp">comparison</a> |
<a href="/comm-central/log/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/mimemrel.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/modlmime.h">mailnews/mime/src/modlmime.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/modlmime.h">file</a> |
<a href="/comm-central/annotate/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/modlmime.h">annotate</a> |
<a href="/comm-central/diff/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/modlmime.h">diff</a> |
<a href="/comm-central/comparison/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/modlmime.h">comparison</a> |
<a href="/comm-central/log/4eb65f5b363cdfdc92f9d2db831ad51777ed10b9/mailnews/mime/src/modlmime.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/db/gloda/components/jsmimeemitter.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/db/gloda/components/jsmimeemitter.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l1.5"></a><span id="l1.5">  *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l1.6"></a><span id="l1.6">  *</span>
<a href="#l1.7"></a><span id="l1.7">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l1.8"></a><span id="l1.8">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l1.9"></a><span id="l1.9">  * the License. You may obtain a copy of the License at</span>
<a href="#l1.10"></a><span id="l1.10">  * http://www.mozilla.org/MPL/</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineminus">- * </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+ *</span>
<a href="#l1.13"></a><span id="l1.13">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l1.14"></a><span id="l1.14">  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l1.15"></a><span id="l1.15">  * for the specific language governing rights and limitations under the</span>
<a href="#l1.16"></a><span id="l1.16">  * License.</span>
<a href="#l1.17"></a><span id="l1.17">  *</span>
<a href="#l1.18"></a><span id="l1.18">  * The Original Code is Thunderbird Global Database.</span>
<a href="#l1.19"></a><span id="l1.19">  *</span>
<a href="#l1.20"></a><span id="l1.20">  * The Initial Developer of the Original Code is</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -27,17 +27,17 @@</span>
<a href="#l1.22"></a><span id="l1.22">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l1.23"></a><span id="l1.23">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l1.24"></a><span id="l1.24">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l1.25"></a><span id="l1.25">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l1.26"></a><span id="l1.26">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l1.27"></a><span id="l1.27">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.28"></a><span id="l1.28">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.29"></a><span id="l1.29">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">- * </span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+ *</span>
<a href="#l1.32"></a><span id="l1.32">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34"> const Cc = Components.classes;</span>
<a href="#l1.35"></a><span id="l1.35"> const Ci = Components.interfaces;</span>
<a href="#l1.36"></a><span id="l1.36"> const Cr = Components.results;</span>
<a href="#l1.37"></a><span id="l1.37"> const Cu = Components.utils;</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39"> Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineat">@@ -71,262 +71,249 @@ const kStateInAttachment = 3;</span>
<a href="#l1.41"></a><span id="l1.41">  *  pass to create the attachment objects proper, which we then substitute into</span>
<a href="#l1.42"></a><span id="l1.42">  *  the part tree we have already built.</span>
<a href="#l1.43"></a><span id="l1.43">  */</span>
<a href="#l1.44"></a><span id="l1.44"> function MimeMessageEmitter() {</span>
<a href="#l1.45"></a><span id="l1.45">   this._mimeMsg = {};</span>
<a href="#l1.46"></a><span id="l1.46">   Cu.import(&quot;resource://app/modules/gloda/mimemsg.js&quot;, this._mimeMsg);</span>
<a href="#l1.47"></a><span id="l1.47"> </span>
<a href="#l1.48"></a><span id="l1.48">   this._url = null;</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-  this._channel = null;</span>
<a href="#l1.50"></a><span id="l1.50"> </span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-  this._inputStream = null;</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-  this._outputStream = null;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-  </span>
<a href="#l1.54"></a><span id="l1.54">   this._outputListener = null;</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-  </span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-  this._rootMsg = null;</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-  this._messageStack = [];</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-  this._parentMsg = null;</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-  this._curMsg = null;</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-  </span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-  this._messageIndex = 0;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-  this._allSubMessages = [];</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-  </span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+  this._curPart = null;</span>
<a href="#l1.66"></a><span id="l1.66">   this._partMap = {};</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-  this._curPart = null;</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-  this._curBodyPart = null;</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-  </span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+</span>
<a href="#l1.71"></a><span id="l1.71">   this._state = kStateUnknown;</span>
<a href="#l1.72"></a><span id="l1.72"> }</span>
<a href="#l1.73"></a><span id="l1.73"> </span>
<a href="#l1.74"></a><span id="l1.74"> MimeMessageEmitter.prototype = {</span>
<a href="#l1.75"></a><span id="l1.75">   classDescription: &quot;JS Mime Message Emitter&quot;,</span>
<a href="#l1.76"></a><span id="l1.76">   classID: Components.ID(&quot;{8cddbbbc-7ced-46b0-a936-8cddd1928c24}&quot;),</span>
<a href="#l1.77"></a><span id="l1.77">   contractID: &quot;@mozilla.org/gloda/jsmimeemitter;1&quot;,</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-  </span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+</span>
<a href="#l1.80"></a><span id="l1.80">   _partRE: new RegExp(&quot;^[^?]+\?(?:[^&amp;]+&amp;)*part=([^&amp;]+)(?:&amp;[^&amp;]+)*$&quot;),</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-  </span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+</span>
<a href="#l1.83"></a><span id="l1.83">   _xpcom_categories: [{</span>
<a href="#l1.84"></a><span id="l1.84">     category: &quot;mime-emitter&quot;,</span>
<a href="#l1.85"></a><span id="l1.85">     entry:</span>
<a href="#l1.86"></a><span id="l1.86">       &quot;@mozilla.org/messenger/mimeemitter;1?type=application/x-js-mime-message&quot;,</span>
<a href="#l1.87"></a><span id="l1.87">   }],</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-  </span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+</span>
<a href="#l1.90"></a><span id="l1.90">   QueryInterface: XPCOMUtils.generateQI([Ci.nsIMimeEmitter]),</span>
<a href="#l1.91"></a><span id="l1.91"> </span>
<a href="#l1.92"></a><span id="l1.92">   initialize: function mime_emitter_initialize(aUrl, aChannel, aFormat) {</span>
<a href="#l1.93"></a><span id="l1.93">     this._url = aUrl;</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-    this._curMsg = this._parentMsg = this._rootMsg = new this._mimeMsg.MimeMessage();</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-    this._curMsg.partName = &quot;&quot;;</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-    this._partMap[&quot;&quot;] = this._curMsg;</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-    </span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+    this._curPart = new this._mimeMsg.MimeMessage();</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+    // the partName is intentionally &quot;&quot;!  not a place-holder!</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+    this._curPart.partName = &quot;&quot;;</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+    this._partMap[&quot;&quot;] = this._curPart;</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+</span>
<a href="#l1.103"></a><span id="l1.103">     this._mimeMsg.MsgHdrToMimeMessage.RESULT_RENDEVOUZ[aUrl.spec] =</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineminus">-      this._rootMsg;</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">-    </span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-    this._channel = aChannel;</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+      this._curPart;</span>
<a href="#l1.108"></a><span id="l1.108">   },</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-  </span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+</span>
<a href="#l1.111"></a><span id="l1.111">   complete: function mime_emitter_complete() {</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-    // dump(&quot;!!!!\n!!!!\n!!!!\n&quot; + this._rootMsg.prettyString() + &quot;\n&quot;);</span>
<a href="#l1.113"></a><span id="l1.113">     this._url = null;</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-    this._channel = null;</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">-    </span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-    this._inputStream = null;</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-    this._outputStream = null;</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-    </span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+</span>
<a href="#l1.120"></a><span id="l1.120">     this._outputListener = null;</span>
<a href="#l1.121"></a><span id="l1.121"> </span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-    this._curMsg = this._parentMsg = this._messageStack = this._rootMsg = null;</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-    this._messageIndex = null;</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-    this._allSubMessages = null;</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-    </span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+    this._curPart = null;</span>
<a href="#l1.127"></a><span id="l1.127">     this._partMap = null;</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-    this._curPart = null;</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-    this._curBodyPart = null;</span>
<a href="#l1.130"></a><span id="l1.130">   },</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-  </span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+</span>
<a href="#l1.133"></a><span id="l1.133">   setPipe: function mime_emitter_setPipe(aInputStream, aOutputStream) {</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-    this._inputStream = aInputStream;</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-    this._outputStream = aOutputStream;</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+    // we do not care about these</span>
<a href="#l1.137"></a><span id="l1.137">   },</span>
<a href="#l1.138"></a><span id="l1.138">   set outputListener(aListener) {</span>
<a href="#l1.139"></a><span id="l1.139">     this._outputListener = aListener;</span>
<a href="#l1.140"></a><span id="l1.140">   },</span>
<a href="#l1.141"></a><span id="l1.141">   get outputListener() {</span>
<a href="#l1.142"></a><span id="l1.142">     return this._outputListener;</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-  }, </span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-  </span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-  _beginPayload: function mime_emitter__beginPayload(aContentType, aIsPart) {</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-    aContentType = aContentType.toLowerCase();</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+  },</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+  _stripParams: function mime_emitter__stripParams(aValue) {</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+    let indexSemi = aValue.indexOf(&quot;;&quot;);</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+    if (indexSemi &gt;= 0)</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+        aValue = aValue.substring(0, indexSemi);</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+    return aValue;</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+  },</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+  _beginPayload: function mime_emitter__beginPayload(aContentType) {</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+    aContentType = this._stripParams(aContentType).toLowerCase();</span>
<a href="#l1.158"></a><span id="l1.158">     if (aContentType == &quot;text/plain&quot; || aContentType == &quot;text/html&quot;) {</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-      this._curBodyPart = new this._mimeMsg.MimeBody(aContentType, aIsPart);</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineminus">-      this._parentMsg.bodyParts.push(this._curBodyPart);</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineminus">-      this._curPart = aIsPart ? this._curBodyPart : null;</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+      this._curPart = new this._mimeMsg.MimeBody(aContentType);</span>
<a href="#l1.163"></a><span id="l1.163">     }</span>
<a href="#l1.164"></a><span id="l1.164">     else if (aContentType == &quot;message/rfc822&quot;) {</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-      // startBody will take care of this</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-      this._curPart = this._curBodyPart = null;</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+      // startHeader will take care of this</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+      this._curPart = new this._mimeMsg.MimeMessage();</span>
<a href="#l1.169"></a><span id="l1.169">     }</span>
<a href="#l1.170"></a><span id="l1.170">     // this is going to fall-down with TNEF encapsulation and such, we really</span>
<a href="#l1.171"></a><span id="l1.171">     //  need to just be consuming the object model.</span>
<a href="#l1.172"></a><span id="l1.172">     else if (aContentType.indexOf(&quot;multipart/&quot;) == 0) {</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-      this._curBodyPart = null;</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-      // alternatives are always parts for part numbering purposes</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-      this._curPart = aIsPart ? new this._mimeMsg.MimeContainer(aContentType)</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-                              : null;</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+      this._curPart = new this._mimeMsg.MimeContainer(aContentType);</span>
<a href="#l1.178"></a><span id="l1.178">     }</span>
<a href="#l1.179"></a><span id="l1.179">     else {</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-      this._curBodyPart = null;</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-      this._curPart = aIsPart ?</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-        new this._mimeMsg.MimeUnknown(aContentType, aIsPart) : null;</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+      this._curPart = new this._mimeMsg.MimeUnknown(aContentType);</span>
<a href="#l1.184"></a><span id="l1.184">     }</span>
<a href="#l1.185"></a><span id="l1.185">   },</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-  </span>
<a href="#l1.187"></a><span id="l1.187" class="difflineplus">+</span>
<a href="#l1.188"></a><span id="l1.188">   // ----- Header Routines</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+  /**</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+   * StartHeader provides the base case for our processing.  It is the first</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+   *  notification we receive when processing begins on the outer rfc822</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+   *  message.  We do not receive an x-jsemitter-part-path notification for the</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+   *  message, but the aIsRootMailHeader tells us everything we need to know.</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+   *  (Or it would if we hadn't already set everything up in initialize.)</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+   *</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+   * When dealing with nested RFC822 messages, we will receive the</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+   *  addHeaderFields for the content-type and the x-jsemitter-part-path</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+   *  prior to the startHeader call.  This is because the MIME multipart</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+   *  container that holds the message is the one generating the notification.</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+   *  For that reason, we do not process them here, but instead in</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+   *  addHeaderField and _beginPayload.</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+   *</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+   * We do need to track our state for addHeaderField's benefit though.</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+   */</span>
<a href="#l1.205"></a><span id="l1.205">   startHeader: function mime_emitter_startHeader(aIsRootMailHeader,</span>
<a href="#l1.206"></a><span id="l1.206">       aIsHeaderOnly, aMsgID, aOutputCharset) {</span>
<a href="#l1.207"></a><span id="l1.207">     this._state = kStateInHeaders;</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-    if (aIsRootMailHeader) {</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-      this.updateCharacterSet(aOutputCharset);</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-      // nothing to do curMsg-wise, already initialized.</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-    }</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-    else {</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-      this._curMsg = new this._mimeMsg.MimeMessage();</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-      </span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-      this._curMsg.partName = this._savedPartPath;</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-      this._placePart(this._curMsg);</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-      delete this._savedPartPath;</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-      </span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-      this._parentMsg.messages.push(this._curMsg);</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineminus">-      this._allSubMessages.push(this._curMsg);</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-    }</span>
<a href="#l1.222"></a><span id="l1.222">   },</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+  /**</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+   * Receives a header field name and value for the current MIME part, which</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+   *  can be an rfc822/message or one of its sub-parts.</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+   *</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+   * The emitter architecture treats rfc822/messages as special because it was</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+   *  architected around presentation.  In that case, the organizing concept</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+   *  is the single top-level rfc822/message.  (It did not 'look into' nested</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+   *  messages in most cases.)</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+   * As a result the interface is biased towards being 'in the headers' or</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+   *  'in the body', corresponding to calls to startHeader and startBody,</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+   *  respectively.</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+   * This information is interesting to us because the message itself is an</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+   *  odd pseudo-mime-part.  Because it has only one child, its headers are,</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+   *  in a way, its payload, but they also serve as the description of its</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineplus">+   *  MIME child part.  This introduces a complication in that we see the</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+   *  content-type for the message's &quot;body&quot; part before we actually see any</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineplus">+   *  of the headers.  To deal with this, we punt on the construction of the</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+   *  body part to the call to startBody() and predicate our logic on the</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+   *  _state field.</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+   */</span>
<a href="#l1.243"></a><span id="l1.243">   addHeaderField: function mime_emitter_addHeaderField(aField, aValue) {</span>
<a href="#l1.244"></a><span id="l1.244">     if (this._state == kStateInBody) {</span>
<a href="#l1.245"></a><span id="l1.245">       aField = aField.toLowerCase();</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-      let indexSemi = aValue.indexOf(&quot;;&quot;);</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-      if (indexSemi &gt;= 0)</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-        aValue = aValue.substring(0, indexSemi);</span>
<a href="#l1.249"></a><span id="l1.249">       if (aField == &quot;content-type&quot;)</span>
<a href="#l1.250"></a><span id="l1.250">         this._beginPayload(aValue, true);</span>
<a href="#l1.251"></a><span id="l1.251">       else if (aField == &quot;x-jsemitter-part-path&quot;) {</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineminus">-        if (this._curPart) {</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineminus">-          this._curPart.partName = aValue;</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+        // This is either naming the current part, or referring to an already</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+        //  existing part (in the case of multipart/related on its second pass).</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+        // As such, check if the name already exists in our part map.</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+        let partName = this._stripParams(aValue);</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+        // if it does, then make the already-existing part at that path current</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+        if (partName in this._partMap)</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+          this._curPart = this._partMap[partName];</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+        // otherwise, name the part we are holding onto and place it.</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineplus">+        else {</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+          this._curPart.partName = partName;</span>
<a href="#l1.264"></a><span id="l1.264">           this._placePart(this._curPart);</span>
<a href="#l1.265"></a><span id="l1.265">         }</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineminus">-        else</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineminus">-          this._savedPartPath = aValue;</span>
<a href="#l1.268"></a><span id="l1.268">       }</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-      return;</span>
<a href="#l1.270"></a><span id="l1.270">     }</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-    if (this._state != kStateInHeaders)</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineminus">-      return;</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineminus">-    let lowerField = aField.toLowerCase();</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineminus">-    if (lowerField in this._curMsg.headers)</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineminus">-      this._curMsg.headers[lowerField].push(aValue);</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineminus">-    else</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineminus">-      this._curMsg.headers[lowerField] = [aValue];</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineplus">+    else if (this._state == kStateInHeaders) {</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineplus">+      let lowerField = aField.toLowerCase();</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineplus">+      if (lowerField in this._curPart.headers)</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineplus">+        this._curPart.headers[lowerField].push(aValue);</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineplus">+      else</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineplus">+        this._curPart.headers[lowerField] = [aValue];</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineplus">+    }</span>
<a href="#l1.285"></a><span id="l1.285">   },</span>
<a href="#l1.286"></a><span id="l1.286">   addAllHeaders: function mime_emitter_addAllHeaders(aAllHeaders, aHeaderSize) {</span>
<a href="#l1.287"></a><span id="l1.287">     // This is called by the parsing code after the calls to AddHeaderField (or</span>
<a href="#l1.288"></a><span id="l1.288">     //  AddAttachmentField if the part is an attachment), and seems to serve</span>
<a href="#l1.289"></a><span id="l1.289">     //  a specialized, quasi-redundant purpose.  (nsMimeBaseEmitter creates a</span>
<a href="#l1.290"></a><span id="l1.290">     //  nsIMimeHeaders instance and hands it to the nsIMsgMailNewsUrl.)</span>
<a href="#l1.291"></a><span id="l1.291">     // nop</span>
<a href="#l1.292"></a><span id="l1.292">   },</span>
<a href="#l1.293"></a><span id="l1.293">   writeHTMLHeaders: function mime_emitter_writeHTMLHeaders() {</span>
<a href="#l1.294"></a><span id="l1.294">     // It does't look like this should even be part of the interface; I think</span>
<a href="#l1.295"></a><span id="l1.295">     //  only the nsMimeHtmlDisplayEmitter::EndHeader call calls this signature.</span>
<a href="#l1.296"></a><span id="l1.296">     // nop</span>
<a href="#l1.297"></a><span id="l1.297">   },</span>
<a href="#l1.298"></a><span id="l1.298">   endHeader: function mime_emitter_endHeader() {</span>
<a href="#l1.299"></a><span id="l1.299">   },</span>
<a href="#l1.300"></a><span id="l1.300">   updateCharacterSet: function mime_emitter_updateCharacterSet(aCharset) {</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineminus">-    // for non US-ASCII, ISO-8859-1, or UTF-8 charsets (case-insensitive),</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineminus">-    //  nsMimeBaseEmitter grabs the channel's content type, nukes the &quot;charset=&quot;</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineminus">-    //  parameter if it exists, and tells the channel the updated content type</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-    //  and new character set.</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineminus">-    </span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-    // Disabling for now; we get a NS_ERROR_NOT_IMPLEMENTED from the channel</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineminus">-    //  when we try and set the contentCharset... and I'm not totally up on the</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineminus">-    //  intent of why we were doing this in the first place.</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineminus">-    /*</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineminus">-    let upperCharset = aCharset.toUpperCase();</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineminus">-    </span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-    if ((upperCharset != &quot;US-ASCII&quot;) &amp;&amp; (upperCharset != &quot;ISO-8859-1&quot;) &amp;&amp;</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineminus">-        (upperCharset != &quot;UTF-8&quot;)) {  </span>
<a href="#l1.314"></a><span id="l1.314" class="difflineminus">-    </span>
<a href="#l1.315"></a><span id="l1.315" class="difflineminus">-      let curContentType = this._channel.contentType;</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineminus">-      let charsetIndex = curContentType.toLowerCase().indexOf(&quot;charset=&quot;);</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-      if (charsetIndex &gt;= 0) {</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineminus">-        // assume a space or semicolon delimits</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineminus">-        curContentType = curContentType.substring(0, charsetIndex-1);</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineminus">-      }</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineminus">-      </span>
<a href="#l1.322"></a><span id="l1.322" class="difflineminus">-      this._channel.contentType = curContentType;</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineminus">-      this._channel.contentCharset = aCharset;</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-    }</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineminus">-    */</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineplus">+    // we do not need to worry about this.  it turns out this notification is</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineplus">+    //  exclusively for the benefit of the UI.  libmime, believe it or not,</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineplus">+    //  is actually doing the right thing under the hood and handles all the</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineplus">+    //  encoding issues for us.</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineplus">+    // so, get ready for the only time you will ever hear this:</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineplus">+    //  three cheers for libmime!</span>
<a href="#l1.332"></a><span id="l1.332">   },</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineminus">-  </span>
<a href="#l1.334"></a><span id="l1.334" class="difflineplus">+</span>
<a href="#l1.335"></a><span id="l1.335">   /**</span>
<a href="#l1.336"></a><span id="l1.336">    * Place a part in its proper location; requires the parent to be present.</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineminus">-   * </span>
<a href="#l1.338"></a><span id="l1.338" class="difflineplus">+   * However, we no longer require in-order addition of children.  (This is</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineplus">+   *  currently a hedge against extension code doing wacky things.  Our</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineplus">+   *  motivating use-case is multipart/related which actually does generate</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineplus">+   *  everything in order on its first pass, but has a wacky second pass. It</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineplus">+   *  does not actually trigger the out-of-order code because we have</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineplus">+   *  augmented the libmime code to generate its x-jsemitter-part-path info</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineplus">+   *  a second time, in which case we reuse the part we already created.)</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineplus">+   *</span>
<a href="#l1.346"></a><span id="l1.346">    * @param aPart Part to place.</span>
<a href="#l1.347"></a><span id="l1.347">    */</span>
<a href="#l1.348"></a><span id="l1.348">   _placePart: function(aPart) {</span>
<a href="#l1.349"></a><span id="l1.349">     let partName = aPart.partName;</span>
<a href="#l1.350"></a><span id="l1.350">     this._partMap[partName] = aPart;</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineminus">-    let parentName = partName.substring(0, partName.lastIndexOf(&quot;.&quot;));</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineplus">+    let lastDotIndex = partName.lastIndexOf(&quot;.&quot;);</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineplus">+    let parentName = partName.substring(0, lastDotIndex);</span>
<a href="#l1.354"></a><span id="l1.354">     let parentPart = this._partMap[parentName];</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineminus">-    if (parentPart)</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-      parentPart.parts.push(aPart);</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineplus">+    if (parentPart !== undefined) {</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineplus">+      let indexInParent = parseInt(partName.substring(lastDotIndex+1)) - 1;</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineplus">+      // handle out-of-order notification...</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineplus">+      if (indexInParent &lt; parentPart.parts.length)</span>
<a href="#l1.361"></a><span id="l1.361" class="difflineplus">+        parentPart.parts[indexInParent] = aPart;</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineplus">+      else {</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineplus">+        while (indexInParent &gt; parentPart.parts.length)</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineplus">+          parentPart.parts.push(null);</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineplus">+        parentPart.parts.push(aPart);</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineplus">+      }</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineplus">+    }</span>
<a href="#l1.368"></a><span id="l1.368">   },</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineminus">-  </span>
<a href="#l1.370"></a><span id="l1.370" class="difflineplus">+</span>
<a href="#l1.371"></a><span id="l1.371">   /**</span>
<a href="#l1.372"></a><span id="l1.372">    * In the case of attachments, we need to replace an existing part with a</span>
<a href="#l1.373"></a><span id="l1.373">    *  more representative part...</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineminus">-   *  </span>
<a href="#l1.375"></a><span id="l1.375" class="difflineplus">+   *</span>
<a href="#l1.376"></a><span id="l1.376">    * @param aPart Part to place.</span>
<a href="#l1.377"></a><span id="l1.377">    */</span>
<a href="#l1.378"></a><span id="l1.378">   _replacePart: function(aPart) {</span>
<a href="#l1.379"></a><span id="l1.379">     let partName = aPart.partName;</span>
<a href="#l1.380"></a><span id="l1.380">     this._partMap[partName] = aPart;</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineminus">-    </span>
<a href="#l1.382"></a><span id="l1.382" class="difflineplus">+</span>
<a href="#l1.383"></a><span id="l1.383">     let parentName = partName.substring(0, partName.lastIndexOf(&quot;.&quot;));</span>
<a href="#l1.384"></a><span id="l1.384">     let parentPart = this._partMap[parentName];</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineminus">-    </span>
<a href="#l1.386"></a><span id="l1.386" class="difflineplus">+</span>
<a href="#l1.387"></a><span id="l1.387">     let childNamePart = partName.substring(partName.lastIndexOf(&quot;.&quot;)+1);</span>
<a href="#l1.388"></a><span id="l1.388">     let childIndex = parseInt(childNamePart) - 1;</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineminus">-    </span>
<a href="#l1.390"></a><span id="l1.390" class="difflineplus">+</span>
<a href="#l1.391"></a><span id="l1.391">     let oldPart = parentPart.parts[childIndex];</span>
<a href="#l1.392"></a><span id="l1.392">     parentPart.parts[childIndex] = aPart;</span>
<a href="#l1.393"></a><span id="l1.393">     aPart.parts = oldPart.parts;</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineplus">+  },</span>
<a href="#l1.395"></a><span id="l1.395"> </span>
<a href="#l1.396"></a><span id="l1.396" class="difflineminus">-    // - remove it if it was a body part.  This can happen for text/plain</span>
<a href="#l1.397"></a><span id="l1.397" class="difflineminus">-    //  attachments.  Like patches.</span>
<a href="#l1.398"></a><span id="l1.398" class="difflineminus">-    // (climb the parents until we find a message/bodyparts holder...)</span>
<a href="#l1.399"></a><span id="l1.399" class="difflineminus">-    while (parentPart.partName &amp;&amp; !parentPart.bodyParts) {</span>
<a href="#l1.400"></a><span id="l1.400" class="difflineminus">-      parentName = parentName.substring(0, parentName.lastIndexOf(&quot;.&quot;));</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineminus">-      parentPart = this._partMap[parentName];</span>
<a href="#l1.402"></a><span id="l1.402" class="difflineminus">-    }</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineminus">-    if (parentPart.bodyParts &amp;&amp; parentPart.bodyParts.indexOf(oldPart) &gt;= 0)</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineminus">-      parentPart.bodyParts.splice(parentPart.bodyParts.indexOf(oldPart), 1);</span>
<a href="#l1.405"></a><span id="l1.405" class="difflineminus">-  },</span>
<a href="#l1.406"></a><span id="l1.406" class="difflineminus">-  </span>
<a href="#l1.407"></a><span id="l1.407">   // ----- Attachment Routines</span>
<a href="#l1.408"></a><span id="l1.408">   // The attachment processing happens after the initial streaming phase (during</span>
<a href="#l1.409"></a><span id="l1.409">   //  which time we receive the messages, both bodies and headers).  Our caller</span>
<a href="#l1.410"></a><span id="l1.410">   //  traverses the libmime child object hierarchy, emitting an attachment for</span>
<a href="#l1.411"></a><span id="l1.411">   //  each leaf object or sub-message.</span>
<a href="#l1.412"></a><span id="l1.412">   startAttachment: function mime_emitter_startAttachment(aName, aContentType,</span>
<a href="#l1.413"></a><span id="l1.413">       aUrl, aIsExternalAttachment) {</span>
<a href="#l1.414"></a><span id="l1.414">     this._state = kStateInAttachment;</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineminus">-    </span>
<a href="#l1.416"></a><span id="l1.416" class="difflineplus">+</span>
<a href="#l1.417"></a><span id="l1.417">     if (aContentType == &quot;message/rfc822&quot;) {</span>
<a href="#l1.418"></a><span id="l1.418">       // we already have all we need to know about the message, ignore it</span>
<a href="#l1.419"></a><span id="l1.419">     }</span>
<a href="#l1.420"></a><span id="l1.420">     else if (aIsExternalAttachment) {</span>
<a href="#l1.421"></a><span id="l1.421">       // external attachments do not pass their part path information.</span>
<a href="#l1.422"></a><span id="l1.422">       // both aUrl in this call and the call to addAttachmentField (with</span>
<a href="#l1.423"></a><span id="l1.423">       // X-Mozilla-PartURL) receive the same thing; the URL to the file on disk.</span>
<a href="#l1.424"></a><span id="l1.424">     }</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineat">@@ -353,55 +340,50 @@ MimeMessageEmitter.prototype = {</span>
<a href="#l1.426"></a><span id="l1.426">     //  no reason to handle anything here.</span>
<a href="#l1.427"></a><span id="l1.427">   },</span>
<a href="#l1.428"></a><span id="l1.428">   endAttachment: function mime_emitter_endAttachment() {</span>
<a href="#l1.429"></a><span id="l1.429">     // don't need to do anything here, since we don't care about the headers.</span>
<a href="#l1.430"></a><span id="l1.430">   },</span>
<a href="#l1.431"></a><span id="l1.431">   endAllAttachments: function mime_emitter_endAllAttachments() {</span>
<a href="#l1.432"></a><span id="l1.432">     // nop</span>
<a href="#l1.433"></a><span id="l1.433">   },</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineminus">-  </span>
<a href="#l1.435"></a><span id="l1.435" class="difflineplus">+</span>
<a href="#l1.436"></a><span id="l1.436">   // ----- Body Routines</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineplus">+  /**</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineplus">+   * We don't get an x-jsemitter-part-path for the message body, and we ignored</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineplus">+   *  our body part's content-type in addHeaderField, so this serves as our</span>
<a href="#l1.440"></a><span id="l1.440" class="difflineplus">+   *  notice to set up the part (giving it a name).</span>
<a href="#l1.441"></a><span id="l1.441" class="difflineplus">+   */</span>
<a href="#l1.442"></a><span id="l1.442">   startBody: function mime_emitter_startBody(aIsBodyOnly, aMsgID, aOutCharset) {</span>
<a href="#l1.443"></a><span id="l1.443">     this._state = kStateInBody;</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineminus">-    </span>
<a href="#l1.445"></a><span id="l1.445" class="difflineminus">-    this._messageStack.push(this._curMsg);</span>
<a href="#l1.446"></a><span id="l1.446" class="difflineminus">-    this._parentMsg = this._curMsg;</span>
<a href="#l1.447"></a><span id="l1.447"> </span>
<a href="#l1.448"></a><span id="l1.448" class="difflineminus">-    // begin payload processing</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineminus">-    let contentType = this._curMsg.get(&quot;content-type&quot;, &quot;text/plain&quot;);</span>
<a href="#l1.450"></a><span id="l1.450" class="difflineminus">-    let indexSemi = contentType.indexOf(&quot;;&quot;);</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineminus">-    if (indexSemi &gt;= 0)</span>
<a href="#l1.452"></a><span id="l1.452" class="difflineminus">-      contentType = contentType.substring(0, indexSemi);</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineminus">-    this._beginPayload(contentType, true);</span>
<a href="#l1.454"></a><span id="l1.454" class="difflineminus">-    if (this._parentMsg.partName == &quot;&quot;)</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineminus">-      this._curPart.partName = &quot;1&quot;;</span>
<a href="#l1.456"></a><span id="l1.456" class="difflineminus">-    else</span>
<a href="#l1.457"></a><span id="l1.457" class="difflineminus">-      this._curPart.partName = this._curMsg.partName + &quot;.1&quot;;</span>
<a href="#l1.458"></a><span id="l1.458" class="difflineplus">+    let subPartName = (this._curPart.partName == &quot;&quot;) ?</span>
<a href="#l1.459"></a><span id="l1.459" class="difflineplus">+                        &quot;1&quot; :</span>
<a href="#l1.460"></a><span id="l1.460" class="difflineplus">+                        this._curPart.partName + &quot;.1&quot;;</span>
<a href="#l1.461"></a><span id="l1.461" class="difflineplus">+    this._beginPayload(this._curPart.get(&quot;content-type&quot;, &quot;text/plain&quot;));</span>
<a href="#l1.462"></a><span id="l1.462" class="difflineplus">+    this._curPart.partName = subPartName;</span>
<a href="#l1.463"></a><span id="l1.463">     this._placePart(this._curPart);</span>
<a href="#l1.464"></a><span id="l1.464">   },</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineminus">-  </span>
<a href="#l1.466"></a><span id="l1.466" class="difflineplus">+</span>
<a href="#l1.467"></a><span id="l1.467">   writeBody: function mime_emitter_writeBody(aBuf, aSize, aOutAmountWritten) {</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineminus">-    this._curBodyPart.body += aBuf;</span>
<a href="#l1.469"></a><span id="l1.469" class="difflineplus">+    this._curPart.body += aBuf;</span>
<a href="#l1.470"></a><span id="l1.470">   },</span>
<a href="#l1.471"></a><span id="l1.471" class="difflineminus">-  </span>
<a href="#l1.472"></a><span id="l1.472" class="difflineplus">+</span>
<a href="#l1.473"></a><span id="l1.473">   endBody: function mime_emitter_endBody() {</span>
<a href="#l1.474"></a><span id="l1.474" class="difflineminus">-    this._messageStack.pop();</span>
<a href="#l1.475"></a><span id="l1.475" class="difflineminus">-    this._parentMsg = this._messageStack[this._messageStack.length - 1];</span>
<a href="#l1.476"></a><span id="l1.476">   },</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineminus">-  </span>
<a href="#l1.478"></a><span id="l1.478" class="difflineplus">+</span>
<a href="#l1.479"></a><span id="l1.479">   // ----- Generic Write (confusing)</span>
<a href="#l1.480"></a><span id="l1.480">   // (binary data writing...)</span>
<a href="#l1.481"></a><span id="l1.481">   write: function mime_emitter_write(aBuf, aSize, aOutAmountWritten) {</span>
<a href="#l1.482"></a><span id="l1.482">     // we don't actually ever get called because we don't have the attachment</span>
<a href="#l1.483"></a><span id="l1.483">     //  binary payloads pass through us, but we do the following just in case</span>
<a href="#l1.484"></a><span id="l1.484">     //  we did get called (otherwise the caller gets mad and throws exceptions).</span>
<a href="#l1.485"></a><span id="l1.485">     aOutAmountWritten.value = aSize;</span>
<a href="#l1.486"></a><span id="l1.486">   },</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineminus">-  </span>
<a href="#l1.488"></a><span id="l1.488" class="difflineplus">+</span>
<a href="#l1.489"></a><span id="l1.489">   // (string writing)</span>
<a href="#l1.490"></a><span id="l1.490">   utilityWrite: function mime_emitter_utilityWrite(aBuf) {</span>
<a href="#l1.491"></a><span id="l1.491">     this.write(aBuf, aBuf.length, {});</span>
<a href="#l1.492"></a><span id="l1.492">   },</span>
<a href="#l1.493"></a><span id="l1.493"> };</span>
<a href="#l1.494"></a><span id="l1.494"> </span>
<a href="#l1.495"></a><span id="l1.495"> var components = [MimeMessageEmitter];</span>
<a href="#l1.496"></a><span id="l1.496"> function NSGetModule(compMgr, fileSpec) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/db/gloda/modules/mimemsg.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/mimemsg.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l2.5"></a><span id="l2.5">  *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l2.6"></a><span id="l2.6">  *</span>
<a href="#l2.7"></a><span id="l2.7">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l2.8"></a><span id="l2.8">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l2.9"></a><span id="l2.9">  * the License. You may obtain a copy of the License at</span>
<a href="#l2.10"></a><span id="l2.10">  * http://www.mozilla.org/MPL/</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineminus">- * </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+ *</span>
<a href="#l2.13"></a><span id="l2.13">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l2.14"></a><span id="l2.14">  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l2.15"></a><span id="l2.15">  * for the specific language governing rights and limitations under the</span>
<a href="#l2.16"></a><span id="l2.16">  * License.</span>
<a href="#l2.17"></a><span id="l2.17">  *</span>
<a href="#l2.18"></a><span id="l2.18">  * The Original Code is Thunderbird Global Database.</span>
<a href="#l2.19"></a><span id="l2.19">  *</span>
<a href="#l2.20"></a><span id="l2.20">  * The Initial Developer of the Original Code is</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -27,17 +27,17 @@</span>
<a href="#l2.22"></a><span id="l2.22">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l2.23"></a><span id="l2.23">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l2.24"></a><span id="l2.24">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l2.25"></a><span id="l2.25">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l2.26"></a><span id="l2.26">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l2.27"></a><span id="l2.27">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l2.28"></a><span id="l2.28">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l2.29"></a><span id="l2.29">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">- * </span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+ *</span>
<a href="#l2.32"></a><span id="l2.32">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34"> EXPORTED_SYMBOLS = ['MsgHdrToMimeMessage',</span>
<a href="#l2.35"></a><span id="l2.35">                     'MimeMessage', 'MimeContainer', 'MimeBody', 'MimeUnknown',</span>
<a href="#l2.36"></a><span id="l2.36">                     'MimeMessageAttachment'];</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38"> const Cc = Components.classes;</span>
<a href="#l2.39"></a><span id="l2.39"> const Ci = Components.interfaces;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineat">@@ -67,29 +67,29 @@ let dumbUrlListener = {</span>
<a href="#l2.41"></a><span id="l2.41">  */</span>
<a href="#l2.42"></a><span id="l2.42"> let activeStreamListeners = [];</span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44"> let shutdownCleanupObserver = {</span>
<a href="#l2.45"></a><span id="l2.45">   _initialized: false,</span>
<a href="#l2.46"></a><span id="l2.46">   ensureInitialized: function mimemsg_shutdownCleanupObserver_init() {</span>
<a href="#l2.47"></a><span id="l2.47">     if (this._initialized)</span>
<a href="#l2.48"></a><span id="l2.48">       return;</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-    </span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+</span>
<a href="#l2.51"></a><span id="l2.51">     Cc[&quot;@mozilla.org/observer-service;1&quot;].getService(Ci.nsIObserverService)</span>
<a href="#l2.52"></a><span id="l2.52">       .addObserver(this, &quot;quit-application&quot;, false);</span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54">     this._initialized = true;</span>
<a href="#l2.55"></a><span id="l2.55">   },</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-  </span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+</span>
<a href="#l2.58"></a><span id="l2.58">   observe: function mimemsg_shutdownCleanupObserver_observe(</span>
<a href="#l2.59"></a><span id="l2.59">       aSubject, aTopic, aData) {</span>
<a href="#l2.60"></a><span id="l2.60">     if (aTopic == &quot;quit-application&quot;) {</span>
<a href="#l2.61"></a><span id="l2.61">       Cc[&quot;@mozilla.org/observer-service;1&quot;].getService(Ci.nsIObserverService)</span>
<a href="#l2.62"></a><span id="l2.62">         .removeObserver(this, &quot;quit-application&quot;);</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-      </span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+</span>
<a href="#l2.65"></a><span id="l2.65">       for each (let [, streamListener] in</span>
<a href="#l2.66"></a><span id="l2.66">                 Iterator(activeStreamListeners.concat())) {</span>
<a href="#l2.67"></a><span id="l2.67">         streamListener._request.cancel(Cr.NS_BINDING_ABORTED);</span>
<a href="#l2.68"></a><span id="l2.68">       }</span>
<a href="#l2.69"></a><span id="l2.69">     }</span>
<a href="#l2.70"></a><span id="l2.70">   }</span>
<a href="#l2.71"></a><span id="l2.71"> }</span>
<a href="#l2.72"></a><span id="l2.72"> </span>
<a href="#l2.73"></a><span id="l2.73" class="difflineat">@@ -112,82 +112,82 @@ CallbackStreamListener.prototype = {</span>
<a href="#l2.74"></a><span id="l2.74"> </span>
<a href="#l2.75"></a><span id="l2.75">   // nsIRequestObserver part</span>
<a href="#l2.76"></a><span id="l2.76">   onStartRequest: function (aRequest, aContext) {</span>
<a href="#l2.77"></a><span id="l2.77">     this._request = aRequest;</span>
<a href="#l2.78"></a><span id="l2.78">     activeStreamListeners.push(this);</span>
<a href="#l2.79"></a><span id="l2.79">   },</span>
<a href="#l2.80"></a><span id="l2.80">   onStopRequest: function (aRequest, aContext, aStatusCode) {</span>
<a href="#l2.81"></a><span id="l2.81">     activeStreamListeners.splice(activeStreamListeners.indexOf(this), 1);</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-    </span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+</span>
<a href="#l2.84"></a><span id="l2.84">     aContext.QueryInterface(Ci.nsIURI);</span>
<a href="#l2.85"></a><span id="l2.85">     let message = MsgHdrToMimeMessage.RESULT_RENDEVOUZ[aContext.spec];</span>
<a href="#l2.86"></a><span id="l2.86">     if (message === undefined)</span>
<a href="#l2.87"></a><span id="l2.87">       message = null;</span>
<a href="#l2.88"></a><span id="l2.88"> </span>
<a href="#l2.89"></a><span id="l2.89">     delete MsgHdrToMimeMessage.RESULT_RENDEVOUZ[aContext.spec];</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-    </span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+</span>
<a href="#l2.92"></a><span id="l2.92">     if (this._callbackThis)</span>
<a href="#l2.93"></a><span id="l2.93">       this._callback.call(this._callbackThis, this._msgHdr, message);</span>
<a href="#l2.94"></a><span id="l2.94">     else</span>
<a href="#l2.95"></a><span id="l2.95">       this._callback.call(null, this._msgHdr, message);</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-    </span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+</span>
<a href="#l2.98"></a><span id="l2.98">     this._msgHdr = null;</span>
<a href="#l2.99"></a><span id="l2.99">     this._request = null;</span>
<a href="#l2.100"></a><span id="l2.100">     this._stream = null;</span>
<a href="#l2.101"></a><span id="l2.101">     this._callbackThis = null;</span>
<a href="#l2.102"></a><span id="l2.102">     this._callback = null;</span>
<a href="#l2.103"></a><span id="l2.103">   },</span>
<a href="#l2.104"></a><span id="l2.104"> </span>
<a href="#l2.105"></a><span id="l2.105">   /* okay, our onDataAvailable should actually never be called.  the stream</span>
<a href="#l2.106"></a><span id="l2.106">      converter is actually eating everything except the start and stop</span>
<a href="#l2.107"></a><span id="l2.107">      notification. */</span>
<a href="#l2.108"></a><span id="l2.108">   // nsIStreamListener part</span>
<a href="#l2.109"></a><span id="l2.109">   onDataAvailable: function (aRequest,aContext,aInputStream,aOffset,aCount) {</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-    dump(&quot;this should not be happening! arrgggggh!\n&quot;)</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+    dump(&quot;this should not be happening! arrgggggh!\n&quot;);</span>
<a href="#l2.112"></a><span id="l2.112">     if (this._stream === null) {</span>
<a href="#l2.113"></a><span id="l2.113">       this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].</span>
<a href="#l2.114"></a><span id="l2.114">                     createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l2.115"></a><span id="l2.115">       this._stream.init(aInputStream);</span>
<a href="#l2.116"></a><span id="l2.116">     }</span>
<a href="#l2.117"></a><span id="l2.117">     this._stream.read(aCount);</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-    </span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+</span>
<a href="#l2.120"></a><span id="l2.120">   },</span>
<a href="#l2.121"></a><span id="l2.121"> };</span>
<a href="#l2.122"></a><span id="l2.122"> </span>
<a href="#l2.123"></a><span id="l2.123"> let gMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;].</span>
<a href="#l2.124"></a><span id="l2.124">                    createInstance(Ci.nsIMessenger);</span>
<a href="#l2.125"></a><span id="l2.125"> </span>
<a href="#l2.126"></a><span id="l2.126"> /**</span>
<a href="#l2.127"></a><span id="l2.127">  * Starts retrieval of a MimeMessage instance for the given message header.</span>
<a href="#l2.128"></a><span id="l2.128">  *  Your callback will be called with the message header you provide and the</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">- *  </span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+ *</span>
<a href="#l2.131"></a><span id="l2.131">  * @param aMsgHdr The message header to retrieve the body for and build a MIME</span>
<a href="#l2.132"></a><span id="l2.132">  *     representation of the message.</span>
<a href="#l2.133"></a><span id="l2.133">  * @param aCallbackThis The (optional) 'this' to use for your callback function.</span>
<a href="#l2.134"></a><span id="l2.134">  * @param aCallback The callback function to invoke on completion of message</span>
<a href="#l2.135"></a><span id="l2.135">  *     parsing or failure.  The first argument passed will be the nsIMsgDBHdr</span>
<a href="#l2.136"></a><span id="l2.136">  *     you passed to this function.  The second argument will be the MimeMessage</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">- *     instance resulting from the processing on success, and null on failure. </span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+ *     instance resulting from the processing on success, and null on failure.</span>
<a href="#l2.139"></a><span id="l2.139">  */</span>
<a href="#l2.140"></a><span id="l2.140"> function MsgHdrToMimeMessage(aMsgHdr, aCallbackThis, aCallback) {</span>
<a href="#l2.141"></a><span id="l2.141">   shutdownCleanupObserver.ensureInitialized();</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-  </span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+</span>
<a href="#l2.144"></a><span id="l2.144">   let msgURI = aMsgHdr.folder.getUriForMsg(aMsgHdr);</span>
<a href="#l2.145"></a><span id="l2.145">   let msgService = gMessenger.messageServiceFromURI(msgURI);</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-  </span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+</span>
<a href="#l2.148"></a><span id="l2.148">   let streamListener = new CallbackStreamListener(aMsgHdr,</span>
<a href="#l2.149"></a><span id="l2.149">                                                   aCallbackThis, aCallback);</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-  </span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+</span>
<a href="#l2.152"></a><span id="l2.152">   let streamURI = msgService.streamMessage(msgURI,</span>
<a href="#l2.153"></a><span id="l2.153">                                            streamListener, // consumer</span>
<a href="#l2.154"></a><span id="l2.154">                                            null, // nsIMsgWindow</span>
<a href="#l2.155"></a><span id="l2.155">                                            dumbUrlListener, // nsIUrlListener</span>
<a href="#l2.156"></a><span id="l2.156">                                            true, // have them create the converter</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-      // additional uri payload, note that &quot;header=&quot; is prepended automatically </span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+      // additional uri payload, note that &quot;header=&quot; is prepended automatically</span>
<a href="#l2.159"></a><span id="l2.159">                                            &quot;filter&amp;emitter=js&quot;,</span>
<a href="#l2.160"></a><span id="l2.160">                                            true);</span>
<a href="#l2.161"></a><span id="l2.161"> }</span>
<a href="#l2.162"></a><span id="l2.162"> </span>
<a href="#l2.163"></a><span id="l2.163"> /**</span>
<a href="#l2.164"></a><span id="l2.164">  * Let the jsmimeemitter provide us with results.  The poor emitter (if I am</span>
<a href="#l2.165"></a><span id="l2.165">  *  understanding things correctly) is evaluated outside of the C.u.import</span>
<a href="#l2.166"></a><span id="l2.166">  *  world, so if we were to import him, we would not see him, but rather a new</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineat">@@ -204,45 +204,33 @@ function MsgHdrToMimeMessage(aMsgHdr, aC</span>
<a href="#l2.168"></a><span id="l2.168"> MsgHdrToMimeMessage.RESULT_RENDEVOUZ = {};</span>
<a href="#l2.169"></a><span id="l2.169"> </span>
<a href="#l2.170"></a><span id="l2.170"> /**</span>
<a href="#l2.171"></a><span id="l2.171">  * @ivar partName The MIME part, ex &quot;1.2.2.1&quot;.  The partName of a (top-level)</span>
<a href="#l2.172"></a><span id="l2.172">  *     message is &quot;1&quot;, its first child is &quot;1.1&quot;, its second child is &quot;1.2&quot;,</span>
<a href="#l2.173"></a><span id="l2.173">  *     its first child's first child is &quot;1.1.1&quot;, etc.</span>
<a href="#l2.174"></a><span id="l2.174">  * @ivar headers Maps lower-cased header field names to a list of the values</span>
<a href="#l2.175"></a><span id="l2.175">  *     seen for the given header.  Use get or getAll as convenience helpers.</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineminus">- * </span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">- * @ivar bodyParts A list of the MimeBody instances that belong to this message.</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">- *     If there are nested messages, any bodies under the nested messages will</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">- *     belong to those messages.</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">- * </span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">- * @ivar messages A list of the sub-message children of this message.  Strict</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">- *     MIME part hierarchy is not maintained; a sub-message's parent is the</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">- *     closest sub-message above it.  Sub-messages can also be found in the</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">- *     parts list, if you want a more strict traversal.</span>
<a href="#l2.185"></a><span id="l2.185">  * @ivar parts The list of the MIME part children of this message.  Children</span>
<a href="#l2.186"></a><span id="l2.186">  *     will be either MimeMessage instances, MimeMessageAttachment instances,</span>
<a href="#l2.187"></a><span id="l2.187">  *     MimeContainer instances, or MimeUnknown instances.  The latter two are</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">- *     the result of limitations in the Javascript representation generation  </span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+ *     the result of limitations in the Javascript representation generation</span>
<a href="#l2.190"></a><span id="l2.190">  *     at this time, combined with the need to most accurately represent the</span>
<a href="#l2.191"></a><span id="l2.191">  *     MIME structure.</span>
<a href="#l2.192"></a><span id="l2.192">  */</span>
<a href="#l2.193"></a><span id="l2.193"> function MimeMessage() {</span>
<a href="#l2.194"></a><span id="l2.194">   this.partName = null;</span>
<a href="#l2.195"></a><span id="l2.195">   this.headers = {};</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-  </span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-  this.bodyParts = [];</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-  this.messages = [];</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-  this.attachments = [];</span>
<a href="#l2.201"></a><span id="l2.201"> </span>
<a href="#l2.202"></a><span id="l2.202">   this.parts = [];</span>
<a href="#l2.203"></a><span id="l2.203"> }</span>
<a href="#l2.204"></a><span id="l2.204"> </span>
<a href="#l2.205"></a><span id="l2.205"> MimeMessage.prototype = {</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+  contentType: &quot;message/rfc822&quot;,</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+</span>
<a href="#l2.208"></a><span id="l2.208">   /**</span>
<a href="#l2.209"></a><span id="l2.209">    * Look-up a header that should be present at most once.</span>
<a href="#l2.210"></a><span id="l2.210">    *</span>
<a href="#l2.211"></a><span id="l2.211">    * @param aHeaderName The header name to retrieve, case does not matter.</span>
<a href="#l2.212"></a><span id="l2.212">    * @param aDefaultValue The value to return if the header was not found, null</span>
<a href="#l2.213"></a><span id="l2.213">    *     if left unspecified.</span>
<a href="#l2.214"></a><span id="l2.214">    * @return the value of the header if present, and the default value if not</span>
<a href="#l2.215"></a><span id="l2.215">    *  (defaults to null).  If the header was present multiple times, the first</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineat">@@ -292,38 +280,22 @@ MimeMessage.prototype = {</span>
<a href="#l2.217"></a><span id="l2.217">   get allAttachments() {</span>
<a href="#l2.218"></a><span id="l2.218">     let results = []; // messages are not attachments, don't include self</span>
<a href="#l2.219"></a><span id="l2.219">     for (let iChild = 0; iChild &lt; this.parts.length; iChild++) {</span>
<a href="#l2.220"></a><span id="l2.220">       let child = this.parts[iChild];</span>
<a href="#l2.221"></a><span id="l2.221">       results = results.concat(child.allAttachments);</span>
<a href="#l2.222"></a><span id="l2.222">     }</span>
<a href="#l2.223"></a><span id="l2.223">     return results;</span>
<a href="#l2.224"></a><span id="l2.224">   },</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-  </span>
<a href="#l2.226"></a><span id="l2.226" class="difflineminus">-  /**</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineminus">-   * @return A list of the MimeBody instances on this message with a content</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-   *     type of text/plain.</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-   */</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineminus">-  get bodyPartsPlain() {</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineminus">-    return [part for each ([, part] in Iterator(this.bodyParts)) if</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-            (part.contentType == &quot;text/plain&quot;)];</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-  },</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-  /**</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-   * @return all of the plaintext body parts of this message (as provided by</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-   *     bodyPartsPlain), concatenated together into a single string.</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-   */</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-  get bodyPlain() {</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-    return [bodyPart.body for each</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-            ([, bodyPart] in Iterator(this.bodyPartsPlain))].join(&quot;&quot;);</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-  },</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+</span>
<a href="#l2.243"></a><span id="l2.243">   /**</span>
<a href="#l2.244"></a><span id="l2.244">    * @param aMsgFolder A message folder, any message folder.  Because this is</span>
<a href="#l2.245"></a><span id="l2.245">    *    a hack.</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineminus">-   * @return The concatenation of all of the bodyParts where parts</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-   *    available as text/plain are pulled from there, and parts only available</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+   * @return The concatenation of all of the body parts where parts</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+   *    available as text/plain are pulled as-is, and parts only available</span>
<a href="#l2.250"></a><span id="l2.250">    *    as text/html are converted to plaintext form first.  In other words,</span>
<a href="#l2.251"></a><span id="l2.251">    *    if we see a multipart/alternative with a text/plain, we take the</span>
<a href="#l2.252"></a><span id="l2.252">    *    text/plain.  If we see a text/html without an alternative, we convert</span>
<a href="#l2.253"></a><span id="l2.253">    *    that to text.</span>
<a href="#l2.254"></a><span id="l2.254">    */</span>
<a href="#l2.255"></a><span id="l2.255">   coerceBodyToPlaintext:</span>
<a href="#l2.256"></a><span id="l2.256">       function MimeMessage_coerceBodyToPlaintext(aMsgFolder) {</span>
<a href="#l2.257"></a><span id="l2.257">     let bodies = [];</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineat">@@ -334,54 +306,38 @@ MimeMessage.prototype = {</span>
<a href="#l2.259"></a><span id="l2.259">       if (body)</span>
<a href="#l2.260"></a><span id="l2.260">         bodies.push(body);</span>
<a href="#l2.261"></a><span id="l2.261">     }</span>
<a href="#l2.262"></a><span id="l2.262">     if (bodies)</span>
<a href="#l2.263"></a><span id="l2.263">       return bodies.join(&quot;&quot;);</span>
<a href="#l2.264"></a><span id="l2.264">     else</span>
<a href="#l2.265"></a><span id="l2.265">       return &quot;&quot;;</span>
<a href="#l2.266"></a><span id="l2.266">   },</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-  /**</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-   * @return a list of the MimeBody instances on this message with a content</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-   *     type of text/html.</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-   */</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-  get bodyPartsHTML() {</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">-    return [part for each ([, part] in Iterator(this.bodyParts)) if</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-        (part.contentType == &quot;text/html&quot;)];</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">-  },</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineminus">-  /**</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineminus">-   * @return all of the HTML body parts of this message (as provided by</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-   *     bodyPartsHTML), concatenated together into a single string.</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-   */</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-  get bodyHTML() {</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-    return [bodyPart.body for each</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-            ([, bodyPart] in Iterator(this.bodyPartsHTML))].join(&quot;&quot;);</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-  },</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-  </span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+</span>
<a href="#l2.285"></a><span id="l2.285">   /**</span>
<a href="#l2.286"></a><span id="l2.286">    * Convert the message and its hierarchy into a &quot;pretty string&quot;.  The message</span>
<a href="#l2.287"></a><span id="l2.287">    *  and each MIME part get their own line.  The string never ends with a</span>
<a href="#l2.288"></a><span id="l2.288">    *  newline.  For a non-multi-part message, only a single line will be</span>
<a href="#l2.289"></a><span id="l2.289">    *  returned.</span>
<a href="#l2.290"></a><span id="l2.290">    * Messages have their subject displayed, attachments have their filename and</span>
<a href="#l2.291"></a><span id="l2.291">    *  content-type (ex: image/jpeg) displayed.  &quot;Filler&quot; classes simply have</span>
<a href="#l2.292"></a><span id="l2.292">    *  their class displayed.</span>
<a href="#l2.293"></a><span id="l2.293">    */</span>
<a href="#l2.294"></a><span id="l2.294">   prettyString: function MimeMessage_prettyString(aIndent) {</span>
<a href="#l2.295"></a><span id="l2.295">     if (aIndent === undefined)</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineminus">-      aIndent = &quot;&quot;; </span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+      aIndent = &quot;&quot;;</span>
<a href="#l2.298"></a><span id="l2.298">     let nextIndent = aIndent + &quot;  &quot;;</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineminus">-  </span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+</span>
<a href="#l2.301"></a><span id="l2.301">     let s = &quot;Message: &quot; + this.headers.subject;</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineminus">-    </span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+</span>
<a href="#l2.304"></a><span id="l2.304">     for (let iPart = 0; iPart &lt; this.parts.length; iPart++) {</span>
<a href="#l2.305"></a><span id="l2.305">       let part = this.parts[iPart];</span>
<a href="#l2.306"></a><span id="l2.306">       s += &quot;\n&quot; + nextIndent + (iPart+1) + &quot; &quot; + part.prettyString(nextIndent);</span>
<a href="#l2.307"></a><span id="l2.307">     }</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-    </span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+</span>
<a href="#l2.310"></a><span id="l2.310">     return s;</span>
<a href="#l2.311"></a><span id="l2.311">   },</span>
<a href="#l2.312"></a><span id="l2.312"> };</span>
<a href="#l2.313"></a><span id="l2.313"> </span>
<a href="#l2.314"></a><span id="l2.314"> </span>
<a href="#l2.315"></a><span id="l2.315"> /**</span>
<a href="#l2.316"></a><span id="l2.316">  * @ivar contentType The content-type of this container.</span>
<a href="#l2.317"></a><span id="l2.317">  * @ivar parts The parts held by this container.  These can be instances of any</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineat">@@ -417,44 +373,43 @@ MimeContainer.prototype = {</span>
<a href="#l2.319"></a><span id="l2.319">       if (htmlPart)</span>
<a href="#l2.320"></a><span id="l2.320">         return aMsgFolder.convertMsgSnippetToPlainText(htmlPart.body);</span>
<a href="#l2.321"></a><span id="l2.321">     }</span>
<a href="#l2.322"></a><span id="l2.322">     // if it's not alternative, recurse/aggregate using MimeMessage logic</span>
<a href="#l2.323"></a><span id="l2.323">     return MimeMessage.prototype.coerceBodyToPlaintext.call(this, aMsgFolder);</span>
<a href="#l2.324"></a><span id="l2.324">   },</span>
<a href="#l2.325"></a><span id="l2.325">   prettyString: function MimeContainer_prettyString(aIndent) {</span>
<a href="#l2.326"></a><span id="l2.326">     let nextIndent = aIndent + &quot;  &quot;;</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineminus">-  </span>
<a href="#l2.328"></a><span id="l2.328" class="difflineplus">+</span>
<a href="#l2.329"></a><span id="l2.329">     let s = &quot;Container: &quot; + this.contentType;</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-    </span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+</span>
<a href="#l2.332"></a><span id="l2.332">     for (let iPart = 0; iPart &lt; this.parts.length; iPart++) {</span>
<a href="#l2.333"></a><span id="l2.333">       let part = this.parts[iPart];</span>
<a href="#l2.334"></a><span id="l2.334">       s += &quot;\n&quot; + nextIndent + (iPart+1) + &quot; &quot; + part.prettyString(nextIndent);</span>
<a href="#l2.335"></a><span id="l2.335">     }</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-    </span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+</span>
<a href="#l2.338"></a><span id="l2.338">     return s;</span>
<a href="#l2.339"></a><span id="l2.339">   },</span>
<a href="#l2.340"></a><span id="l2.340">   toString: function MimeContainer_toString() {</span>
<a href="#l2.341"></a><span id="l2.341">     return &quot;Container: &quot; + this.contentType;</span>
<a href="#l2.342"></a><span id="l2.342">   }</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineminus">-}</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+};</span>
<a href="#l2.345"></a><span id="l2.345"> </span>
<a href="#l2.346"></a><span id="l2.346"> /**</span>
<a href="#l2.347"></a><span id="l2.347">  * @class Represents a body portion that we understand and do not believe to be</span>
<a href="#l2.348"></a><span id="l2.348">  *  a proper attachment.  This means text/plain or text/html and it has no</span>
<a href="#l2.349"></a><span id="l2.349">  *  filename.  (A filename suggests an attachment.)</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineminus">- *  </span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+ *</span>
<a href="#l2.352"></a><span id="l2.352">  * @ivar contentType The content type of this body materal; text/plain or</span>
<a href="#l2.353"></a><span id="l2.353">  *     text/html.</span>
<a href="#l2.354"></a><span id="l2.354">  * @ivar body The actual body content.</span>
<a href="#l2.355"></a><span id="l2.355">  */</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineminus">-function MimeBody(aContentType, aIsPart) {</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineplus">+function MimeBody(aContentType) {</span>
<a href="#l2.358"></a><span id="l2.358">   this.partName = null;</span>
<a href="#l2.359"></a><span id="l2.359">   this.contentType = aContentType;</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineminus">-  this.isPart = aIsPart;</span>
<a href="#l2.361"></a><span id="l2.361">   this.body = &quot;&quot;;</span>
<a href="#l2.362"></a><span id="l2.362"> }</span>
<a href="#l2.363"></a><span id="l2.363"> </span>
<a href="#l2.364"></a><span id="l2.364"> MimeBody.prototype = {</span>
<a href="#l2.365"></a><span id="l2.365">   get allAttachments() {</span>
<a href="#l2.366"></a><span id="l2.366">     return []; // we are a leaf</span>
<a href="#l2.367"></a><span id="l2.367">   },</span>
<a href="#l2.368"></a><span id="l2.368">   coerceBodyToPlaintext:</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineat">@@ -466,64 +421,63 @@ MimeBody.prototype = {</span>
<a href="#l2.370"></a><span id="l2.370">     return &quot;&quot;;</span>
<a href="#l2.371"></a><span id="l2.371">   },</span>
<a href="#l2.372"></a><span id="l2.372">   prettyString: function MimeBody_prettyString(aIndent) {</span>
<a href="#l2.373"></a><span id="l2.373">     return &quot;Body: &quot; + this.contentType + &quot; (&quot; + this.body.length + &quot; bytes)&quot;;</span>
<a href="#l2.374"></a><span id="l2.374">   },</span>
<a href="#l2.375"></a><span id="l2.375">   toString: function MimeBody_toString() {</span>
<a href="#l2.376"></a><span id="l2.376">     return &quot;Body: &quot; + this.contentType + &quot; (&quot; + this.body.length + &quot; bytes)&quot;;</span>
<a href="#l2.377"></a><span id="l2.377">   }</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineminus">-}</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+};</span>
<a href="#l2.380"></a><span id="l2.380"> </span>
<a href="#l2.381"></a><span id="l2.381"> /**</span>
<a href="#l2.382"></a><span id="l2.382">  * @class A MIME Leaf node that doesn't have a filename so we assume it's not</span>
<a href="#l2.383"></a><span id="l2.383">  *  intended to be an attachment proper.  This is probably meant for inline</span>
<a href="#l2.384"></a><span id="l2.384">  *  display or is the result of someone amusing themselves by composing messages</span>
<a href="#l2.385"></a><span id="l2.385">  *  by hand or a bad client.  This class should probably be renamed or we should</span>
<a href="#l2.386"></a><span id="l2.386">  *  introduce a better named class that we try and use in preference to this</span>
<a href="#l2.387"></a><span id="l2.387">  *  class.</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineminus">- * </span>
<a href="#l2.389"></a><span id="l2.389" class="difflineplus">+ *</span>
<a href="#l2.390"></a><span id="l2.390">  * @ivar contentType The content type of this part.</span>
<a href="#l2.391"></a><span id="l2.391">  */</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-function MimeUnknown(aContentType, aIsPart) {</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+function MimeUnknown(aContentType) {</span>
<a href="#l2.394"></a><span id="l2.394">   this.partName = null;</span>
<a href="#l2.395"></a><span id="l2.395">   this.contentType = aContentType;</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineminus">-  this.isPart = aIsPart;</span>
<a href="#l2.397"></a><span id="l2.397"> }</span>
<a href="#l2.398"></a><span id="l2.398"> </span>
<a href="#l2.399"></a><span id="l2.399"> MimeUnknown.prototype = {</span>
<a href="#l2.400"></a><span id="l2.400">   get allAttachments() {</span>
<a href="#l2.401"></a><span id="l2.401">     return []; // we are a leaf</span>
<a href="#l2.402"></a><span id="l2.402">   },</span>
<a href="#l2.403"></a><span id="l2.403">   prettyString: function MimeUnknown_prettyString(aIndent) {</span>
<a href="#l2.404"></a><span id="l2.404">     return &quot;Unknown: &quot; + this.contentType;</span>
<a href="#l2.405"></a><span id="l2.405">   },</span>
<a href="#l2.406"></a><span id="l2.406">   toString: function MimeUnknown_toString() {</span>
<a href="#l2.407"></a><span id="l2.407">     return &quot;Unknown: &quot; + this.contentType;</span>
<a href="#l2.408"></a><span id="l2.408">   }</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineminus">-}</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+};</span>
<a href="#l2.411"></a><span id="l2.411"> </span>
<a href="#l2.412"></a><span id="l2.412"> /**</span>
<a href="#l2.413"></a><span id="l2.413">  * @class An attachment proper.  We think it's an attachment because it has a</span>
<a href="#l2.414"></a><span id="l2.414">  *  filename that libmime was able to figure out.</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineminus">- * </span>
<a href="#l2.416"></a><span id="l2.416" class="difflineplus">+ *</span>
<a href="#l2.417"></a><span id="l2.417">  * @ivar partName @see{MimeMessage.partName}</span>
<a href="#l2.418"></a><span id="l2.418">  * @ivar name The filename of this attachment.</span>
<a href="#l2.419"></a><span id="l2.419">  * @ivar contentType The MIME content type of this part.</span>
<a href="#l2.420"></a><span id="l2.420">  * @ivar url The URL to stream if you want the contents of this part.</span>
<a href="#l2.421"></a><span id="l2.421">  * @ivar isExternal Is the attachment stored someplace else than in the message?</span>
<a href="#l2.422"></a><span id="l2.422">  */</span>
<a href="#l2.423"></a><span id="l2.423"> function MimeMessageAttachment(aPartName, aName, aContentType, aUrl,</span>
<a href="#l2.424"></a><span id="l2.424">                                aIsExternal) {</span>
<a href="#l2.425"></a><span id="l2.425">   this.partName = aPartName;</span>
<a href="#l2.426"></a><span id="l2.426">   this.name = aName;</span>
<a href="#l2.427"></a><span id="l2.427">   this.contentType = aContentType;</span>
<a href="#l2.428"></a><span id="l2.428">   this.url = aUrl;</span>
<a href="#l2.429"></a><span id="l2.429">   this.isExternal = aIsExternal;</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineminus">-  </span>
<a href="#l2.431"></a><span id="l2.431" class="difflineplus">+</span>
<a href="#l2.432"></a><span id="l2.432">   this.fields = {};</span>
<a href="#l2.433"></a><span id="l2.433"> }</span>
<a href="#l2.434"></a><span id="l2.434"> </span>
<a href="#l2.435"></a><span id="l2.435"> MimeMessageAttachment.prototype = {</span>
<a href="#l2.436"></a><span id="l2.436">   /**</span>
<a href="#l2.437"></a><span id="l2.437">    * Is this an actual attachment, as far as we can tell?  An example of</span>
<a href="#l2.438"></a><span id="l2.438">    *  something that's not a real attachment is a mailing list footer that</span>
<a href="#l2.439"></a><span id="l2.439">    *  gets its own MIME part because the original message had both HTML and text</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/db/gloda/test/resources/messageGenerator.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/db/gloda/test/resources/messageGenerator.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -98,35 +98,45 @@ const SUBJECT_SUFFIXES = [</span>
<a href="#l3.4"></a><span id="l3.4">   &quot;In The Lobby&quot;, &quot;On Your Desk&quot;, &quot;In Your Car&quot;, &quot;Hiding Behind The Door&quot;,</span>
<a href="#l3.5"></a><span id="l3.5">   ];</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> /**</span>
<a href="#l3.8"></a><span id="l3.8">  * Base class for MIME Part representation.</span>
<a href="#l3.9"></a><span id="l3.9">  */</span>
<a href="#l3.10"></a><span id="l3.10"> function SyntheticPart(aProperties) {</span>
<a href="#l3.11"></a><span id="l3.11">   if (aProperties) {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    if (aProperties.charset)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    if (&quot;contentType&quot; in aProperties)</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+      this._contentType = aProperties.contentType;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    if (&quot;charset&quot; in aProperties)</span>
<a href="#l3.16"></a><span id="l3.16">       this._charset = aProperties.charset;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-    if (aProperties.format)</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+    if (&quot;format&quot; in aProperties)</span>
<a href="#l3.19"></a><span id="l3.19">       this._format = aProperties.format;</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-    if (aProperties.filename)</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+    if (&quot;filename&quot; in aProperties)</span>
<a href="#l3.22"></a><span id="l3.22">       this._filename = aProperties.filename;</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-    if (aProperties.boundary)</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+    if (&quot;boundary&quot; in aProperties)</span>
<a href="#l3.25"></a><span id="l3.25">       this._boundary = aProperties.boundary;</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+    if (&quot;encoding&quot; in aProperties)</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+      this._encoding = aProperties.encoding;</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+    if (&quot;contentId&quot; in aProperties)</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+      this._contentId = aProperties.contentId;</span>
<a href="#l3.30"></a><span id="l3.30">   }</span>
<a href="#l3.31"></a><span id="l3.31"> }</span>
<a href="#l3.32"></a><span id="l3.32"> SyntheticPart.prototype = {</span>
<a href="#l3.33"></a><span id="l3.33">   get contentTypeHeaderValue() {</span>
<a href="#l3.34"></a><span id="l3.34">     s = this._contentType;</span>
<a href="#l3.35"></a><span id="l3.35">     if (this._charset)</span>
<a href="#l3.36"></a><span id="l3.36">       s += '; charset=' + this._charset;</span>
<a href="#l3.37"></a><span id="l3.37">     if (this._format)</span>
<a href="#l3.38"></a><span id="l3.38">       s += '; format=' + this._format;</span>
<a href="#l3.39"></a><span id="l3.39">     if (this._filename)</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-      s += ';\r\n name=&quot;' + this._filename +'&quot;'</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+      s += ';\r\n name=&quot;' + this._filename +'&quot;';</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+    if (this._contentTypeExtra) {</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+      for (let [key, value] in Iterator(this._contentTypeExtra))</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+        s += ';\r\n ' + key + '=&quot;' + value + '&quot;';</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+    }</span>
<a href="#l3.46"></a><span id="l3.46">     if (this._boundary)</span>
<a href="#l3.47"></a><span id="l3.47">       s += ';\r\n boundary=&quot;' + this._boundary + '&quot;';</span>
<a href="#l3.48"></a><span id="l3.48">     return s;</span>
<a href="#l3.49"></a><span id="l3.49">   },</span>
<a href="#l3.50"></a><span id="l3.50">   get hasTransferEncoding() {</span>
<a href="#l3.51"></a><span id="l3.51">     return this._encoding;</span>
<a href="#l3.52"></a><span id="l3.52">   },</span>
<a href="#l3.53"></a><span id="l3.53">   get contentTransferEncodingHeaderValue() {</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineat">@@ -136,16 +146,22 @@ SyntheticPart.prototype = {</span>
<a href="#l3.55"></a><span id="l3.55">     return this._filename;</span>
<a href="#l3.56"></a><span id="l3.56">   },</span>
<a href="#l3.57"></a><span id="l3.57">   get contentDispositionHeaderValue() {</span>
<a href="#l3.58"></a><span id="l3.58">     s = '';</span>
<a href="#l3.59"></a><span id="l3.59">     if (this._filename)</span>
<a href="#l3.60"></a><span id="l3.60">       s += 'attachment;\r\n filename=&quot;' + this._filename + '&quot;';</span>
<a href="#l3.61"></a><span id="l3.61">     return s;</span>
<a href="#l3.62"></a><span id="l3.62">   },</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+  get hasContentId() {</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+    return this._contentId;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+  },</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+  get contentIdHeaderValue() {</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+    return '&lt;' + this._contentId + '&gt;';</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+  },</span>
<a href="#l3.69"></a><span id="l3.69"> };</span>
<a href="#l3.70"></a><span id="l3.70"> </span>
<a href="#l3.71"></a><span id="l3.71"> /**</span>
<a href="#l3.72"></a><span id="l3.72">  * Leaf MIME part, defaulting to text/plain.</span>
<a href="#l3.73"></a><span id="l3.73">  */</span>
<a href="#l3.74"></a><span id="l3.74"> function SyntheticPartLeaf(aBody, aProperties) {</span>
<a href="#l3.75"></a><span id="l3.75">   SyntheticPart.call(this, aProperties);</span>
<a href="#l3.76"></a><span id="l3.76">   this.body = aBody;</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineat">@@ -153,73 +169,171 @@ function SyntheticPartLeaf(aBody, aPrope</span>
<a href="#l3.78"></a><span id="l3.78"> SyntheticPartLeaf.prototype = {</span>
<a href="#l3.79"></a><span id="l3.79">   __proto__: SyntheticPart.prototype,</span>
<a href="#l3.80"></a><span id="l3.80">   _contentType: 'text/plain',</span>
<a href="#l3.81"></a><span id="l3.81">   _charset: 'ISO-8859-1',</span>
<a href="#l3.82"></a><span id="l3.82">   _format: 'flowed',</span>
<a href="#l3.83"></a><span id="l3.83">   _encoding: '7bit',</span>
<a href="#l3.84"></a><span id="l3.84">   toMessageString: function() {</span>
<a href="#l3.85"></a><span id="l3.85">     return this.body;</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-  }</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-}</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+  },</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+  prettyString: function MimeMessage_prettyString(aIndent) {</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+    return &quot;Leaf: &quot; + this._contentType;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+  },</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+};</span>
<a href="#l3.93"></a><span id="l3.93"> </span>
<a href="#l3.94"></a><span id="l3.94"> /**</span>
<a href="#l3.95"></a><span id="l3.95">  * Multipart (multipart/*) MIME part base class.</span>
<a href="#l3.96"></a><span id="l3.96">  */</span>
<a href="#l3.97"></a><span id="l3.97"> function SyntheticPartMulti(aParts, aProperties) {</span>
<a href="#l3.98"></a><span id="l3.98">   SyntheticPart.call(this, aProperties);</span>
<a href="#l3.99"></a><span id="l3.99"> </span>
<a href="#l3.100"></a><span id="l3.100">   this._boundary = '--------------CHOPCHOP' + this.BOUNDARY_COUNTER;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-  this.__proto__.BOUNDARY_COUNTER += 1;</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+  this.BOUNDARY_COUNTER_HOME.BOUNDARY_COUNTER += 1;</span>
<a href="#l3.103"></a><span id="l3.103">   this.parts = (aParts != null) ? aParts : [];</span>
<a href="#l3.104"></a><span id="l3.104"> }</span>
<a href="#l3.105"></a><span id="l3.105"> SyntheticPartMulti.prototype = {</span>
<a href="#l3.106"></a><span id="l3.106">   __proto__: SyntheticPart.prototype,</span>
<a href="#l3.107"></a><span id="l3.107">   BOUNDARY_COUNTER: 0,</span>
<a href="#l3.108"></a><span id="l3.108">   toMessageString: function() {</span>
<a href="#l3.109"></a><span id="l3.109">     s = &quot;This is a multi-part message in MIME format.\r\n&quot;;</span>
<a href="#l3.110"></a><span id="l3.110">     for (let [,part] in Iterator(this.parts)) {</span>
<a href="#l3.111"></a><span id="l3.111">       s += &quot;--&quot; + this._boundary + &quot;\r\n&quot;;</span>
<a href="#l3.112"></a><span id="l3.112">       s += &quot;Content-Type: &quot; + part.contentTypeHeaderValue + '\r\n';</span>
<a href="#l3.113"></a><span id="l3.113">       if (part.hasTransferEncoding)</span>
<a href="#l3.114"></a><span id="l3.114">         s += 'Content-Transfer-Encoding: ' +</span>
<a href="#l3.115"></a><span id="l3.115">              part.contentTransferEncodingHeaderValue + '\r\n';</span>
<a href="#l3.116"></a><span id="l3.116">       if (part.hasDisposition)</span>
<a href="#l3.117"></a><span id="l3.117">         s += 'Content-Disposition: ' + part.contentDispositionHeaderValue +</span>
<a href="#l3.118"></a><span id="l3.118">              '\r\n';</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+      if (part.hasContentId)</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+        s += 'Content-ID: ' + part.contentIdHeaderValue + '\r\n';</span>
<a href="#l3.121"></a><span id="l3.121">       s += '\r\n';</span>
<a href="#l3.122"></a><span id="l3.122">       s += part.toMessageString() + '\r\n\r\n';</span>
<a href="#l3.123"></a><span id="l3.123">     }</span>
<a href="#l3.124"></a><span id="l3.124">     s += &quot;--&quot; + this._boundary + '--';</span>
<a href="#l3.125"></a><span id="l3.125">     return s;</span>
<a href="#l3.126"></a><span id="l3.126">   },</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+  prettyString: function(aIndent) {</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+    let nextIndent = (aIndent != null) ? (aIndent + &quot;  &quot;) : &quot;&quot;;</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+    let s = &quot;Container: &quot; + this._contentType;</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+    for (let iPart = 0; iPart &lt; this.parts.length; iPart++) {</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+      let part = this.parts[iPart];</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+      s += &quot;\n&quot; + nextIndent + (iPart+1) + &quot; &quot; + part.prettyString(nextIndent);</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+    }</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+    return s;</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+  }</span>
<a href="#l3.139"></a><span id="l3.139"> };</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+SyntheticPartMulti.prototype.BOUNDARY_COUNTER_HOME = SyntheticPartMulti.prototype;</span>
<a href="#l3.141"></a><span id="l3.141"> </span>
<a href="#l3.142"></a><span id="l3.142"> /**</span>
<a href="#l3.143"></a><span id="l3.143">  * Multipart mixed (multipart/mixed) MIME part.</span>
<a href="#l3.144"></a><span id="l3.144">  */</span>
<a href="#l3.145"></a><span id="l3.145"> function SyntheticPartMultiMixed() {</span>
<a href="#l3.146"></a><span id="l3.146">   SyntheticPartMulti.apply(this, arguments);</span>
<a href="#l3.147"></a><span id="l3.147"> }</span>
<a href="#l3.148"></a><span id="l3.148"> SyntheticPartMultiMixed.prototype = {</span>
<a href="#l3.149"></a><span id="l3.149">   __proto__: SyntheticPartMulti.prototype,</span>
<a href="#l3.150"></a><span id="l3.150">   _contentType: 'multipart/mixed',</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+};</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+/**</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+ * Multipart mixed (multipart/mixed) MIME part.</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+ */</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+function SyntheticPartMultiParallel() {</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+  SyntheticPartMulti.apply(this, arguments);</span>
<a href="#l3.158"></a><span id="l3.158"> }</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+SyntheticPartMultiParallel.prototype = {</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+  __proto__: SyntheticPartMulti.prototype,</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+  _contentType: 'multipart/parallel',</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+};</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+/**</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+ * Multipart digest (multipart/digest) MIME part.</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+ */</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+function SyntheticPartMultiDigest() {</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+  SyntheticPartMulti.apply(this, arguments);</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+}</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+SyntheticPartMultiDigest.prototype = {</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+  __proto__: SyntheticPartMulti.prototype,</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+  _contentType: 'multipart/digest',</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+};</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+/**</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+ * Multipart alternative (multipart/alternative) MIME part.</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+ */</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+function SyntheticPartMultiAlternative() {</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+  SyntheticPartMulti.apply(this, arguments);</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+}</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+SyntheticPartMultiAlternative.prototype = {</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+  __proto__: SyntheticPartMulti.prototype,</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+  _contentType: 'multipart/alternative',</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+};</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+/**</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+ * Multipart related (multipart/related) MIME part.</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+ */</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+function SyntheticPartMultiRelated() {</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+  SyntheticPartMulti.apply(this, arguments);</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+}</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+SyntheticPartMultiRelated.prototype = {</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+  __proto__: SyntheticPartMulti.prototype,</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+  _contentType: 'multipart/related',</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+};</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+const PKCS_SIGNATURE_MIME_TYPE = 'application/x-pkcs7-signature';</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+/**</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+ * Multipart signed (multipart/signed) MIME part.  This is helperish and makes</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+ *  up a gibberish signature.  We wrap the provided parts in the standard</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+ *  signature idiom</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+ *</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+ * @param aPart The content part to wrap. Only one part!  Use a multipart if</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+ *     you need to cram extra stuff in there.</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+ * @param aProperties Properties, propagated to SyntheticPart, see that.</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+ */</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+function SyntheticPartMultiSigned(aPart, aProperties) {</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+  SyntheticPartMulti.call(this, [aPart], aProperties);</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+  this.parts.push(new SyntheticPartLeaf(</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+    &quot;I am not really a signature but let's hope no one figures it out.&quot;,</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+    {</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+      contentType: PKCS_SIGNATURE_MIME_TYPE,</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+      name: 'smime.p7s',</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+    }));</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+}</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+SyntheticPartMultiSigned.prototype = {</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+  __proto__: SyntheticPartMulti.prototype,</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+  _contentType: 'multipart/signed',</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+  _contentTypeExtra: {</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+    protocol: PKCS_SIGNATURE_MIME_TYPE,</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+    micalg: 'SHA1'</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+  },</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+};</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+</span>
<a href="#l3.225"></a><span id="l3.225"> </span>
<a href="#l3.226"></a><span id="l3.226"> /**</span>
<a href="#l3.227"></a><span id="l3.227">  * A synthetic message, created by the MessageGenerator.  Captures both the</span>
<a href="#l3.228"></a><span id="l3.228">  *  ingredients that went into the synthetic message as well as the rfc822 form</span>
<a href="#l3.229"></a><span id="l3.229">  *  of the message.</span>
<a href="#l3.230"></a><span id="l3.230">  */</span>
<a href="#l3.231"></a><span id="l3.231"> function SyntheticMessage(aHeaders, aBodyPart) {</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+  // we currently do not need to call SyntheticPart's constructor...</span>
<a href="#l3.233"></a><span id="l3.233">   this.headers = aHeaders || {};</span>
<a href="#l3.234"></a><span id="l3.234">   this.bodyPart = aBodyPart || new SyntheticPartLeaf(&quot;&quot;);</span>
<a href="#l3.235"></a><span id="l3.235"> }</span>
<a href="#l3.236"></a><span id="l3.236"> </span>
<a href="#l3.237"></a><span id="l3.237"> SyntheticMessage.prototype = {</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+  __proto__: SyntheticPart.prototype,</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+  _contentType: 'message/rfc822',</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+  _charset: null,</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+  _format: null,</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+  _encoding: null,</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+</span>
<a href="#l3.244"></a><span id="l3.244">   /** @returns the Message-Id header value. */</span>
<a href="#l3.245"></a><span id="l3.245">   get messageId() { return this._messageId; },</span>
<a href="#l3.246"></a><span id="l3.246">   /**</span>
<a href="#l3.247"></a><span id="l3.247">    * Sets the Message-Id header value.</span>
<a href="#l3.248"></a><span id="l3.248">    *</span>
<a href="#l3.249"></a><span id="l3.249">    * @param aMessageId A unique string without the greater-than and less-than,</span>
<a href="#l3.250"></a><span id="l3.250">    *     we add those for you.</span>
<a href="#l3.251"></a><span id="l3.251">    */</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineat">@@ -375,16 +489,35 @@ SyntheticMessage.prototype = {</span>
<a href="#l3.253"></a><span id="l3.253">    * @returns a string uniquely identifying this message, at least as long as</span>
<a href="#l3.254"></a><span id="l3.254">    *     the messageId is set and unique.</span>
<a href="#l3.255"></a><span id="l3.255">    */</span>
<a href="#l3.256"></a><span id="l3.256">   toString: function() {</span>
<a href="#l3.257"></a><span id="l3.257">     return &quot;msg:&quot; + this._messageId;</span>
<a href="#l3.258"></a><span id="l3.258">   },</span>
<a href="#l3.259"></a><span id="l3.259"> </span>
<a href="#l3.260"></a><span id="l3.260">   /**</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+   * Convert the message and its hierarchy into a &quot;pretty string&quot;.  The message</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+   *  and each MIME part get their own line.  The string never ends with a</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+   *  newline.  For a non-multi-part message, only a single line will be</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+   *  returned.</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+   * Messages have their subject displayed, everyone else just shows their</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+   *  content type.</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+   */</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+  prettyString: function MimeMessage_prettyString(aIndent) {</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+    if (aIndent === undefined)</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+      aIndent = &quot;&quot;;</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+    let nextIndent = aIndent + &quot;  &quot;;</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+    let s = &quot;Message: &quot; + this.subject;</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+    s += &quot;\n&quot; + nextIndent + &quot;1 &quot; + this.bodyPart.prettyString(nextIndent);</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+    return s;</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+  },</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+  /**</span>
<a href="#l3.280"></a><span id="l3.280">    * @returns this messages in rfc822 format, or something close enough.</span>
<a href="#l3.281"></a><span id="l3.281">    */</span>
<a href="#l3.282"></a><span id="l3.282">   toMessageString: function() {</span>
<a href="#l3.283"></a><span id="l3.283">     let lines = [headerKey + &quot;: &quot; + this._formatHeaderValues(headerValues)</span>
<a href="#l3.284"></a><span id="l3.284">                  for each ([headerKey, headerValues] in Iterator(this.headers))];</span>
<a href="#l3.285"></a><span id="l3.285"> </span>
<a href="#l3.286"></a><span id="l3.286">     return lines.join(&quot;\r\n&quot;) + &quot;\r\n\r\n&quot; + this.bodyPart.toMessageString() +</span>
<a href="#l3.287"></a><span id="l3.287">       &quot;\r\n&quot;;</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineat">@@ -405,17 +538,17 @@ SyntheticMessage.prototype = {</span>
<a href="#l3.289"></a><span id="l3.289">    * Writes this message to an mbox stream.  This means adding a &quot;From &quot; line</span>
<a href="#l3.290"></a><span id="l3.290">    *  and making sure we've got a trailing newline.</span>
<a href="#l3.291"></a><span id="l3.291">    */</span>
<a href="#l3.292"></a><span id="l3.292">   writeToMboxStream: function (aStream) {</span>
<a href="#l3.293"></a><span id="l3.293">     let str = &quot;From &quot; + this._from[1] + &quot;\r\n&quot; + this.toMessageString() +</span>
<a href="#l3.294"></a><span id="l3.294">       &quot;\r\n&quot;;</span>
<a href="#l3.295"></a><span id="l3.295">     aStream.write(str, str.length);</span>
<a href="#l3.296"></a><span id="l3.296">   }</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-}</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+};</span>
<a href="#l3.299"></a><span id="l3.299"> </span>
<a href="#l3.300"></a><span id="l3.300"> /**</span>
<a href="#l3.301"></a><span id="l3.301">  * Write a list of messages in mbox format to a file</span>
<a href="#l3.302"></a><span id="l3.302">  *</span>
<a href="#l3.303"></a><span id="l3.303">  * @param aMessages The list of SyntheticMessages instances to write.</span>
<a href="#l3.304"></a><span id="l3.304">  * @param aBaseDir The base directory to start from.</span>
<a href="#l3.305"></a><span id="l3.305">  * @param ... Zero or more relative paths to join to the base directory.</span>
<a href="#l3.306"></a><span id="l3.306">  */</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineat">@@ -644,48 +777,48 @@ MessageGenerator.prototype = {</span>
<a href="#l3.308"></a><span id="l3.308">       msg.headers[&quot;In-Reply-To&quot;] = srcMsg.headers[&quot;Message-Id&quot;];</span>
<a href="#l3.309"></a><span id="l3.309">       msg.headers[&quot;References&quot;] = (srcMsg.headers[&quot;References&quot;] || []).concat(</span>
<a href="#l3.310"></a><span id="l3.310">                                    [srcMsg.headers[&quot;Message-Id&quot;]]);</span>
<a href="#l3.311"></a><span id="l3.311">     }</span>
<a href="#l3.312"></a><span id="l3.312">     else {</span>
<a href="#l3.313"></a><span id="l3.313">       msg.parent = null;</span>
<a href="#l3.314"></a><span id="l3.314"> </span>
<a href="#l3.315"></a><span id="l3.315">       msg.subject = aArgs.subject || this.makeSubject();</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-      msg.from = this.makeNameAndAddress();</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineminus">-      msg.to = this.makeNamesAndAddresses(aArgs.toCount || 1);</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+      msg.from = aArgs.from || this.makeNameAndAddress();</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+      msg.to = aArgs.to || this.makeNamesAndAddresses(aArgs.toCount || 1);</span>
<a href="#l3.320"></a><span id="l3.320">     }</span>
<a href="#l3.321"></a><span id="l3.321"> </span>
<a href="#l3.322"></a><span id="l3.322">     msg.children = [];</span>
<a href="#l3.323"></a><span id="l3.323">     msg.messageId = this.makeMessageId(msg);</span>
<a href="#l3.324"></a><span id="l3.324">     msg.date = this.makeDate();</span>
<a href="#l3.325"></a><span id="l3.325"> </span>
<a href="#l3.326"></a><span id="l3.326">     let bodyPart;</span>
<a href="#l3.327"></a><span id="l3.327">     if (aArgs.bodyPart)</span>
<a href="#l3.328"></a><span id="l3.328">       bodyPart = aArgs.bodyPart;</span>
<a href="#l3.329"></a><span id="l3.329">     else if (aArgs.body)</span>
<a href="#l3.330"></a><span id="l3.330">       bodyPart = new SyntheticPartLeaf(aArgs.body.body, aArgs.body);</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineminus">-    else</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineminus">-      bodyPart = new SyntheticPartLeaf(&quot;I am an e-mail.&quot;);</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineplus">+    else // different messages should have a chance at different bodies</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineplus">+      bodyPart = new SyntheticPartLeaf(&quot;Hello &quot; + msg.toName + &quot;!&quot;);</span>
<a href="#l3.335"></a><span id="l3.335"> </span>
<a href="#l3.336"></a><span id="l3.336">     // if it has any attachments, create a multipart/mixed to be the body and</span>
<a href="#l3.337"></a><span id="l3.337">     //  have it be the parent of the existing body and all the attachments</span>
<a href="#l3.338"></a><span id="l3.338">     if (aArgs.attachments) {</span>
<a href="#l3.339"></a><span id="l3.339">       let parts = [bodyPart];</span>
<a href="#l3.340"></a><span id="l3.340">       for each (let [,attachDesc] in Iterator(aArgs.attachments))</span>
<a href="#l3.341"></a><span id="l3.341">         parts.push(new SyntheticPartLeaf(attachDesc.body, attachDesc));</span>
<a href="#l3.342"></a><span id="l3.342">       bodyPart = new SyntheticPartMultiMixed(parts);</span>
<a href="#l3.343"></a><span id="l3.343">     }</span>
<a href="#l3.344"></a><span id="l3.344"> </span>
<a href="#l3.345"></a><span id="l3.345">     msg.bodyPart = bodyPart;</span>
<a href="#l3.346"></a><span id="l3.346"> </span>
<a href="#l3.347"></a><span id="l3.347">     msg.callerData = aArgs.callerData;</span>
<a href="#l3.348"></a><span id="l3.348"> </span>
<a href="#l3.349"></a><span id="l3.349">     return msg;</span>
<a href="#l3.350"></a><span id="l3.350">   }</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">-}</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineplus">+};</span>
<a href="#l3.353"></a><span id="l3.353"> </span>
<a href="#l3.354"></a><span id="l3.354"> /**</span>
<a href="#l3.355"></a><span id="l3.355">  * Repository of generative message scenarios.  Uses the magic bindMethods</span>
<a href="#l3.356"></a><span id="l3.356">  *  function below to allow you to reference methods/attributes without worrying</span>
<a href="#l3.357"></a><span id="l3.357">  *  about how those methods will get the right 'this' pointer if passed as</span>
<a href="#l3.358"></a><span id="l3.358">  *  simply a function argument to someone.  So if you do:</span>
<a href="#l3.359"></a><span id="l3.359">  *  foo = messageScenarioFactory.method, followed by foo(...), it will be</span>
<a href="#l3.360"></a><span id="l3.360">  *  equivalent to having simply called messageScenarioFactory.method(...).</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_mime_emitter.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,287 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/*</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+ * General testing of the JS Mime Emitter to make sure it doesn't choke on any</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ *  scenarios.</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+ *</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+ * We do not test, but should consider testing:</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+ * - MimeEncryptedPKCS7, whatever that translates to.</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+ * - apple double</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ * - sun attachment</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ */</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+do_import_script(&quot;../mailnews/db/gloda/test/resources/messageGenerator.js&quot;);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+do_import_script(&quot;../mailnews/db/gloda/test/resources/glodaTestHelper.js&quot;);</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/gloda/mimemsg.js&quot;);</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+// Create a message generator</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+var msgGen = new MessageGenerator();</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+var partText = new SyntheticPartLeaf(&quot;I am text! Woo!&quot;);</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+var partHtml = new SyntheticPartLeaf(</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  &quot;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;I am HTML! Woo! &lt;/body&gt;&lt;/html&gt;&quot;,</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+  {</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+    contentType: &quot;text/html&quot;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+  }</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+);</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+var partAlternative = new SyntheticPartMultiAlternative([partText, partHtml]);</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+var partMailingListFooter = new SyntheticPartLeaf(&quot;I am an annoying footer!&quot;);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+var tachText = {filename: 'bob.txt', body: 'I like cheese!'};</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+var partTachText = new SyntheticPartLeaf(tachText.body, tachText);</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+var tachImage = {filename: 'bob.png', contentType: 'image/png',</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+                 encoding: 'base64', charset: null, format: null,</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+                 body: 'YWJj\n'};</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+var partTachImage = new SyntheticPartLeaf(tachImage.body, tachImage);</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+var relImage = {contentType: 'image/png',</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+                encoding: 'base64', charset: null, format: null,</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+                contentId: 'part1.foo@bar.com',</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+                body: 'YWJj\n'};</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+var partRelImage = new SyntheticPartLeaf(relImage.body, relImage);</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+var tachVCard = {filename: 'bob.vcf', contentType: 'text/x-vcard',</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+                 encoding: '7bit', body: 'begin:vcard\nfn:Bob\nend:vcard\n'};</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+var partTachVCard = new SyntheticPartLeaf(tachVCard.body, tachVCard);</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+var tachApplication = {filename: 'funky.funk',</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+                       contentType: 'application/x-funky', body: 'funk!'};</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+var partTachApplication = new SyntheticPartLeaf(tachApplication.body,</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+                                                tachApplication);</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+var partTachMessages = [msgGen.makeMessage(), msgGen.makeMessage()];</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+var messageInfos = [</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+  // -- simple</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+  {</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+    name: 'text/plain',</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+    bodyPart: partText,</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  },</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+  {</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+    name: 'text/html',</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+    bodyPart: partHtml,</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+  },</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+  // -- simple w/attachment</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+  {</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+    name: 'text/plain w/text attachment (=&gt; multipart/mixed)',</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+    bodyPart: partText,</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+    attachments: [tachText],</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+  },</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+  {</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+    name: 'text/plain w/image attachment (=&gt; multipart/mixed)',</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+    bodyPart: partText,</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+    attachments: [tachImage],</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  },</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+  {</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+    name: 'text/plain w/vcard attachment (=&gt; multipart/mixed)',</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+    bodyPart: partText,</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+    attachments: [tachVCard],</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  },</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  {</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+    name: 'text/plain w/app attachment (=&gt; multipart/mixed)',</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+    bodyPart: partText,</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+    attachments: [tachApplication],</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+  },</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+  {</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+    name: 'text/html w/text attachment (=&gt; multipart/mixed)',</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+    bodyPart: partHtml,</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+    attachments: [tachText],</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+  },</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+  {</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+    name: 'text/html w/image attachment (=&gt; multipart/mixed)',</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+    bodyPart: partHtml,</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+    attachments: [tachImage],</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+  },</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+  {</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+    name: 'text/html w/vcard attachment (=&gt; multipart/mixed)',</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+    bodyPart: partHtml,</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+    attachments: [tachVCard],</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+  },</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+  {</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+    name: 'text/html w/app attachment (=&gt; multipart/mixed)',</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+    bodyPart: partHtml,</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+    attachments: [tachApplication],</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+  },</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+  // -- alternatives</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+  {</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+    name: 'multipart/alternative: text/plain, text/html',</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+    bodyPart: partAlternative,</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+  },</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+  {</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+    name: 'multipart/alternative plain/html w/text attachment',</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+    bodyPart: partAlternative,</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+    attachments: [tachText],</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+  },</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+  {</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+    name: 'multipart/alternative plain/html w/image attachment',</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+    bodyPart: partAlternative,</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+    attachments: [tachImage],</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+  },</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+  {</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+    name: 'multipart/alternative plain/html w/vcard attachment',</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+    bodyPart: partAlternative,</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+    attachments: [tachVCard],</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+  },</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+  {</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+    name: 'multipart/alternative plain/html w/app attachment',</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+    bodyPart: partAlternative,</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+    attachments: [tachApplication],</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+  },</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+  // -- S/MIME.</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+  {</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+    name: 'S/MIME alternative',</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+    bodyPart: new SyntheticPartMultiSigned(partAlternative),</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+  },</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+  {</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+    name: 'S/MIME alternative with text attachment inside',</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+    // we have to do the attachment packing ourselves on this one.</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+    bodyPart: new SyntheticPartMultiSigned(</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+      new SyntheticPartMultiMixed([partAlternative, partTachText])),</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+  },</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+  {</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+    name: 'S/MIME alternative with image attachment inside',</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+    // we have to do the attachment packing ourselves on this one.</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+    bodyPart: new SyntheticPartMultiSigned(</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+      new SyntheticPartMultiMixed([partAlternative, partTachImage])),</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+  },</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+  {</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+    name: 'S/MIME alternative with image attachment inside',</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+    // we have to do the attachment packing ourselves on this one.</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+    bodyPart: new SyntheticPartMultiSigned(</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+      new SyntheticPartMultiMixed([partAlternative, partTachVCard])),</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+  },</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+  {</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+    name: 'S/MIME alternative with app attachment inside',</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+    // we have to do the attachment packing ourselves on this one.</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+    bodyPart: new SyntheticPartMultiSigned(</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+      new SyntheticPartMultiMixed([partAlternative, partTachApplication])),</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+  },</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+  {</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+    name: 'S/MIME alternative wrapped in mailing list',</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+    bodyPart: new SyntheticPartMultiMixed(</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+      [new SyntheticPartMultiSigned(partAlternative), partMailingListFooter]),</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+  },</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+  // -- attached RFC822</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+  {</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+    // not your average attachment, pack ourselves for now</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+    name: 'attached rfc822',</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+    bodyPart: new SyntheticPartMultiMixed([partAlternative,</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+                                           partTachMessages[0]]),</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+  },</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+  // -- multipart/related</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+  {</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+    name: 'multipart/related',</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+    bodyPart: new SyntheticPartMultiRelated([partHtml, partRelImage]),</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+  },</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+  {</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+    name: 'multipart/related inside multipart/alternative',</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+    bodyPart: new SyntheticPartMultiAlternative([partText,</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+      new SyntheticPartMultiRelated([partHtml, partRelImage])]),</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+  },</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+  // -- multipart/digest</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+  {</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+    name: 'multipart/digest',</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+    bodyPart: new SyntheticPartMultiDigest(partTachMessages.concat()),</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+  },</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+  // -- multipart/parallel (allegedly the same as mixed)</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+  {</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+    name: 'multipart/parallel',</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+    bodyPart: new SyntheticPartMultiParallel([partText, partTachImage]),</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+  }</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+];</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+function setup_create_message(info) {</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+  info._synMsg = msgGen.makeMessage(info);</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+  next_test();</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+}</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+var emittyFolder;</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+/**</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+ * Actually inject all the messages we created above.</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+ */</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+function setup_inject_messages() {</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+  let synMessages = [info._synMsg for each</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+                      ([, info] in Iterator(messageInfos))];</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+  writeMessagesToMbox(synMessages, gProfileDir,</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+                      &quot;Mail&quot;, &quot;Local Folders&quot;, &quot;emitty&quot;);</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+  emittyFolder = gLocalIncomingServer.rootMsgFolder.addSubfolder(&quot;emitty&quot;);</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+  updateFolderAndNotify(emittyFolder, next_test);</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+}</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+function test_stream_message(info) {</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+  let msgHdr =</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+    emittyFolder.msgDatabase.getMsgHdrForMessageID(info._synMsg.messageId);</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+  MsgHdrToMimeMessage(msgHdr, null, function(aMsgHdr, aMimeMsg) {</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+    verify_stream_message(info, info._synMsg, aMsgHdr, aMimeMsg);</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+  });</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+}</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+function verify_body_part_equivalence(aSynBodyPart, aMimePart) {</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+  do_check_eq(aSynBodyPart._contentType, aMimePart.contentType);</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+  // XXX body part checking will get brittle if we ever actually encode things!</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+  if (aSynBodyPart.body &amp;&amp; !aSynBodyPart._filename &amp;&amp;</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+      aSynBodyPart._contentType.indexOf(&quot;text/&quot;) == 0)</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+    do_check_eq(aSynBodyPart.body.trim(), aMimePart.body.trim());</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+  if (aSynBodyPart.parts) {</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+    let iPart;</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+    for (iPart = 0; iPart &lt; aSynBodyPart.parts.length; iPart++) {</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+      let subSyn = aSynBodyPart.parts[iPart];</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+      let subMime = aMimePart.parts[iPart];</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+      // our special case is the signature, which libmime does not expose to us.</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+      // ignore! (also, have our too-many-part checker below not trip on this)</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+      if (subSyn._contentType != PKCS_SIGNATURE_MIME_TYPE) {</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+        if (subMime == null)</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+          do_throw(&quot;No MIME part matching &quot; +</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+                   subSyn.contentTypeHeaderValue + &quot;\n&quot;);</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+        verify_body_part_equivalence(subSyn, subMime);</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+      }</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+    }</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+    // only check if there are still more mime parts; don't check for a count</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+    //  mismatch (the PKCS case from above needs to be handled)</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+    if (iPart &lt; aMimePart.parts.length)</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+      do_throw(&quot;MIME part has more sub-parts than syn part?&quot;);</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+  }</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+}</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+/**</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+ * Verify the streamed results are what we wanted.  For now, this just means</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+ *  receiving a representation; we don't check it for correctness.</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+ */</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+function verify_stream_message(aInfo, aSynMsg, aMsgHdr, aMimeMsg) {</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+  if (aMimeMsg == null)</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+    do_throw(&quot;We really should have gotten a result!&quot;);</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+  try {</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+    // aMimeMsg is normalized; it only ever actually gets one child...</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+    verify_body_part_equivalence(aSynMsg.bodyPart, aMimeMsg.parts[0]);</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+  }</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+  catch (ex) {</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+    dump(&quot;Something was wrong with the MIME rep!\n!!!!!!!!\n&quot;);</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+    dump(&quot;Synthetic looks like:\n  &quot; + aSynMsg.prettyString() +</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+         &quot;\n\n&quot;);</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+    dump(&quot;MIME looks like:\n  &quot; + aMimeMsg.prettyString() + &quot;\n\n&quot;);</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+    do_throw(ex);</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+  }</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+  dump(&quot;Everything is just fine.\n&quot;);</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+  dump(&quot;Synthetic looks like:\n  &quot; + aSynMsg.prettyString() +</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+       &quot;\n\n&quot;);</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+  dump(&quot;MIME looks like:\n  &quot; + aMimeMsg.prettyString() + &quot;\n\n&quot;);</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+  next_test();</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+}</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+/* ===== Driver ===== */</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+var tests = [</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+  parameterizeTest(setup_create_message, messageInfos),</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+  setup_inject_messages,</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+  parameterizeTest(test_stream_message, messageInfos),</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+];</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+function run_test() {</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+  // use mbox injection because the fake server chokes sometimes right now</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineplus">+  injectMessagesUsing(INJECT_MBOX);</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+  glodaHelperRunTests(tests);</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/mime/src/mimei.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/mime/src/mimei.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1559,18 +1559,32 @@ mime_parse_url_options(const char *url, </span>
<a href="#l5.4"></a><span id="l5.4">       }</span>
<a href="#l5.5"></a><span id="l5.5">     }</span>
<a href="#l5.6"></a><span id="l5.6">     else if (!PL_strncasecmp (&quot;rot13&quot;, q, name_end - q))</span>
<a href="#l5.7"></a><span id="l5.7">     {</span>
<a href="#l5.8"></a><span id="l5.8">       options-&gt;rot13_p = end &lt;= value || !PL_strncasecmp (&quot;true&quot;, value, end - value);</span>
<a href="#l5.9"></a><span id="l5.9">     }</span>
<a href="#l5.10"></a><span id="l5.10">     else if (!PL_strncasecmp (&quot;emitter&quot;, q, name_end - q))</span>
<a href="#l5.11"></a><span id="l5.11">     {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-      options-&gt;notify_nested_bodies = </span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-        (end &gt; value) &amp;&amp; !PL_strncasecmp (&quot;js&quot;, value, end - value);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+      if ((end &gt; value) &amp;&amp; !PL_strncasecmp (&quot;js&quot;, value, end - value))</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+      {</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+        // the js emitter needs to hear about nested message bodies</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+        //  in order to build a proper representation.</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+        options-&gt;notify_nested_bodies = PR_TRUE;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+        // show_attachment_inline_p has the side-effect of letting the</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+        //  emitter see all parts of a multipart/alternative, which it</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+        //  really appreciates.</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+        options-&gt;show_attachment_inline_p = PR_TRUE;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+        // however, show_attachment_inline_p also results in a few</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+        //  subclasses writing junk into the body for display purposes.</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+        // put a stop to these shenanigans by enabling write_pure_bodies.</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+        //  current offenders are:</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+        //  - MimeInlineImage</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+        options-&gt;write_pure_bodies = PR_TRUE;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+      }</span>
<a href="#l5.30"></a><span id="l5.30">     }</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32">     q = end;</span>
<a href="#l5.33"></a><span id="l5.33">     if (*q)</span>
<a href="#l5.34"></a><span id="l5.34">       q++;</span>
<a href="#l5.35"></a><span id="l5.35">   }</span>
<a href="#l5.36"></a><span id="l5.36"> </span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38" class="difflineat">@@ -1730,17 +1744,19 @@ MimeObject_write(MimeObject *obj, const </span>
<a href="#l5.39"></a><span id="l5.39">   }</span>
<a href="#l5.40"></a><span id="l5.40"> </span>
<a href="#l5.41"></a><span id="l5.41">   return MimeOptions_write(obj-&gt;options, output, length, user_visible_p);</span>
<a href="#l5.42"></a><span id="l5.42"> }</span>
<a href="#l5.43"></a><span id="l5.43"> </span>
<a href="#l5.44"></a><span id="l5.44"> int</span>
<a href="#l5.45"></a><span id="l5.45"> MimeObject_write_separator(MimeObject *obj)</span>
<a href="#l5.46"></a><span id="l5.46"> {</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state)</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+  if (obj-&gt;options &amp;&amp; obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+      // we never want separators if we are asking for pure bodies</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+      !obj-&gt;options-&gt;write_pure_bodies)</span>
<a href="#l5.51"></a><span id="l5.51">     obj-&gt;options-&gt;state-&gt;separator_queued_p = PR_TRUE;</span>
<a href="#l5.52"></a><span id="l5.52">   return 0;</span>
<a href="#l5.53"></a><span id="l5.53"> }</span>
<a href="#l5.54"></a><span id="l5.54"> </span>
<a href="#l5.55"></a><span id="l5.55"> int</span>
<a href="#l5.56"></a><span id="l5.56"> MimeObject_output_init(MimeObject *obj, const char *content_type)</span>
<a href="#l5.57"></a><span id="l5.57"> {</span>
<a href="#l5.58"></a><span id="l5.58">   if (obj &amp;&amp;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/mime/src/mimeiimg.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/mime/src/mimeiimg.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -94,17 +94,20 @@ MimeInlineImage_parse_begin (MimeObject </span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">   int status;</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">   status = ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_begin(obj);</span>
<a href="#l6.8"></a><span id="l6.8">   if (status &lt; 0) return status;</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10">   if (!obj-&gt;output_p) return 0;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  if (!obj-&gt;options || !obj-&gt;options-&gt;output_fn)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  if (!obj-&gt;options || !obj-&gt;options-&gt;output_fn ||</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+      // don't bother processing if the consumer doesn't want us</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+      //  gunking the body up.</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+      obj-&gt;options-&gt;write_pure_bodies)</span>
<a href="#l6.17"></a><span id="l6.17">     return 0;</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">   clazz = (MimeInlineImageClass *) obj-&gt;clazz;</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21">   if (obj-&gt;options &amp;&amp;</span>
<a href="#l6.22"></a><span id="l6.22">     obj-&gt;options-&gt;image_begin &amp;&amp;</span>
<a href="#l6.23"></a><span id="l6.23">     obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l6.24"></a><span id="l6.24">     obj-&gt;options-&gt;image_write_buffer)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1445,16 +1445,17 @@ MimeDisplayOptions::MimeDisplayOptions()</span>
<a href="#l7.4"></a><span id="l7.4"> #endif /* MIME_DRAFTS */</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6">   attachment_icon_layer_id = 0;</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8">   missing_parts = PR_FALSE;</span>
<a href="#l7.9"></a><span id="l7.9">   show_attachment_inline_p = PR_FALSE;</span>
<a href="#l7.10"></a><span id="l7.10">   quote_attachment_inline_p = PR_FALSE;</span>
<a href="#l7.11"></a><span id="l7.11">   notify_nested_bodies = PR_FALSE;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+  write_pure_bodies = PR_FALSE;</span>
<a href="#l7.13"></a><span id="l7.13"> }</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> MimeDisplayOptions::~MimeDisplayOptions()</span>
<a href="#l7.16"></a><span id="l7.16"> {</span>
<a href="#l7.17"></a><span id="l7.17">   PR_FREEIF(part_to_load);</span>
<a href="#l7.18"></a><span id="l7.18">   PR_FREEIF(default_charset);</span>
<a href="#l7.19"></a><span id="l7.19"> }</span>
<a href="#l7.20"></a><span id="l7.20"> ////////////////////////////////////////////////////////////////</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/mime/src/mimemrel.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/mime/src/mimemrel.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1054,16 +1054,29 @@ MimeMultipartRelated_parse_eof (MimeObje</span>
<a href="#l8.4"></a><span id="l8.4">      (relobj-&gt;file_buffer || relobj-&gt;head_buffer))</span>
<a href="#l8.5"></a><span id="l8.5">   {</span>
<a href="#l8.6"></a><span id="l8.6">     status = obj-&gt;options-&gt;decompose_file_init_fn ( obj-&gt;options-&gt;stream_closure,</span>
<a href="#l8.7"></a><span id="l8.7">                             relobj-&gt;buffered_hdrs );</span>
<a href="#l8.8"></a><span id="l8.8">     if (status &lt; 0) return status;</span>
<a href="#l8.9"></a><span id="l8.9">   }</span>
<a href="#l8.10"></a><span id="l8.10"> #endif /* MIME_DRAFTS */</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+  /* if the emitter wants to know about nested bodies, then it needs</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+     to know that we jumped back to this body part. */</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+  if (obj-&gt;options-&gt;notify_nested_bodies)</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+  {</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+    char *part_path = mime_part_address(body);</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+    if (part_path)</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+    {</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+      mimeEmitterAddHeaderField(obj-&gt;options,</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+                                &quot;x-jsemitter-part-path&quot;,</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+                                part_path);</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+      PR_Free(part_path);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+    }</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+  }</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26">   /* Now that we've added this new object to our list of children,</span>
<a href="#l8.27"></a><span id="l8.27">      start its parser going. */</span>
<a href="#l8.28"></a><span id="l8.28">   status = body-&gt;clazz-&gt;parse_begin(body);</span>
<a href="#l8.29"></a><span id="l8.29">   if (status &lt; 0) goto FAIL;</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31">   if (relobj-&gt;head_buffer)</span>
<a href="#l8.32"></a><span id="l8.32">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/mime/src/modlmime.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/mime/src/modlmime.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -394,11 +394,18 @@ public:</span>
<a href="#l9.4"></a><span id="l9.4">                          quotes of replies) */</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6">   /**</span>
<a href="#l9.7"></a><span id="l9.7">    * Should StartBody/EndBody events be generated for nested MimeMessages.  If</span>
<a href="#l9.8"></a><span id="l9.8">    *  false (the default value), the events are only generated for the outermost</span>
<a href="#l9.9"></a><span id="l9.9">    *  MimeMessage.</span>
<a href="#l9.10"></a><span id="l9.10">    */</span>
<a href="#l9.11"></a><span id="l9.11">   PRBool notify_nested_bodies;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  /**</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+   * When true, compels mime parts to only write the actual body</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+   *  payload and not display-gunk like links to attachments. This was</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+   *  primarily introduced for the benefit of the javascript emitter.</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+   */</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+  PRBool write_pure_bodies;</span>
<a href="#l9.19"></a><span id="l9.19"> };</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21"> #endif /* _MODLMIME_H_ */</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

