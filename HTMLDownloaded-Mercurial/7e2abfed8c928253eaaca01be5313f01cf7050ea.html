<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3619:7e2abfed8c928253eaaca01be5313f01cf7050ea</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7e2abfed8c928253eaaca01be5313f01cf7050ea" />
<meta property="og:url" content="/comm-central/rev/7e2abfed8c928253eaaca01be5313f01cf7050ea" />
<meta property="og:description" content="Import the gloda-facet patch with davida's quicksearch changes and CSS pulled in." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7e2abfed8c928253eaaca01be5313f01cf7050ea 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7e2abfed8c928253eaaca01be5313f01cf7050ea">shortlog</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7e2abfed8c928253eaaca01be5313f01cf7050ea">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea">files</a> |
changeset |
<a href="/comm-central/raw-rev/7e2abfed8c928253eaaca01be5313f01cf7050ea">raw</a>  | <a href="/comm-central/archive/7e2abfed8c928253eaaca01be5313f01cf7050ea.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Import the gloda-facet patch with davida's quicksearch changes and CSS pulled in.
<span class="logtags"><span class="inbranchtag" title="gloda-facet">gloda-facet</span> </span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 01 Sep 2009 11:26:31 -0700</td></tr>
<tr><td>branch</td><td>gloda-facet</td></tr>
<tr>
 <td>changeset 3619</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7e2abfed8c928253eaaca01be5313f01cf7050ea">7e2abfed8c928253eaaca01be5313f01cf7050ea</a></td>
</tr>



<tr>
<td>parent 3618</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fc30b12098c11b17f2970e7e47d5bf1bfbed9920">fc30b12098c11b17f2970e7e47d5bf1bfbed9920</a>
</td>
</tr>

<tr>
<td>child 3620</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9e9d511e378042e5cfdc333dd5ffb582b752d951">9e9d511e378042e5cfdc333dd5ffb582b752d951</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7e2abfed8c928253eaaca01be5313f01cf7050ea">2927</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Thu, 10 Sep 2009 01:15:56 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0b161ed73eb6 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0b161ed73eb66538ade852cb5a4b9b1b2c319a33&newProject=comm-central&newRevision=b5e0aff84bf4077a47919481912ad0bd11c6a8d8&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>






</table></div>

<div class="page_body description">Import the gloda-facet patch with davida's quicksearch changes and CSS pulled in.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/extraCustomizeItems.xul">mail/base/content/extraCustomizeItems.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/extraCustomizeItems.xul">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/extraCustomizeItems.xul">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/extraCustomizeItems.xul">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/extraCustomizeItems.xul">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/extraCustomizeItems.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/folderDisplay.js">mail/base/content/folderDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/folderDisplay.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/folderDisplay.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/folderDisplay.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/folderDisplay.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/folderDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetBindings.css">mail/base/content/glodaFacetBindings.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetBindings.css">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetBindings.css">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetBindings.css">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetBindings.css">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetBindings.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetBindings.xml">mail/base/content/glodaFacetBindings.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetBindings.xml">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetBindings.xml">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetBindings.xml">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetBindings.xml">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetBindings.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetTab.js">mail/base/content/glodaFacetTab.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetTab.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetTab.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetTab.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetTab.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetTab.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.css">mail/base/content/glodaFacetView.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.css">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.css">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.css">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.css">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.js">mail/base/content/glodaFacetView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.xhtml">mail/base/content/glodaFacetView.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.xhtml">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.xhtml">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.xhtml">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.xhtml">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetView.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetViewWrapper.xul">mail/base/content/glodaFacetViewWrapper.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetViewWrapper.xul">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetViewWrapper.xul">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetViewWrapper.xul">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetViewWrapper.xul">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetViewWrapper.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetVis.js">mail/base/content/glodaFacetVis.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetVis.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetVis.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetVis.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetVis.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/glodaFacetVis.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/messenger.css">mail/base/content/messenger.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/messenger.css">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/messenger.css">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/messenger.css">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/messenger.css">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/messenger.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/messenger.xul">mail/base/content/messenger.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/messenger.xul">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/messenger.xul">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/messenger.xul">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/messenger.xul">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/messenger.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/search.xml">mail/base/content/search.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/search.xml">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/search.xml">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/search.xml">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/search.xml">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/search.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/searchBar.js">mail/base/content/searchBar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/searchBar.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/searchBar.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/searchBar.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/searchBar.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/searchBar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/tabmail.xml">mail/base/content/tabmail.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/tabmail.xml">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/tabmail.xml">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/tabmail.xml">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/tabmail.xml">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/content/tabmail.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/jar.mn">mail/base/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/jar.mn">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/jar.mn">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/jar.mn">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/jar.mn">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/base/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/gloda.properties">mail/locales/en-US/chrome/messenger/gloda.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/gloda.properties">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/gloda.properties">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/gloda.properties">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/gloda.properties">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/gloda.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/glodaFacetView.dtd">mail/locales/en-US/chrome/messenger/glodaFacetView.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/glodaFacetView.dtd">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/glodaFacetView.dtd">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/glodaFacetView.dtd">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/glodaFacetView.dtd">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/glodaFacetView.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/glodaFacetView.properties">mail/locales/en-US/chrome/messenger/glodaFacetView.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/glodaFacetView.properties">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/glodaFacetView.properties">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/glodaFacetView.properties">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/glodaFacetView.properties">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/glodaFacetView.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/messenger.dtd">mail/locales/en-US/chrome/messenger/messenger.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/messenger.dtd">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/messenger.dtd">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/messenger.dtd">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/messenger.dtd">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/messenger.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/messenger.properties">mail/locales/en-US/chrome/messenger/messenger.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/messenger.properties">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/messenger.properties">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/messenger.properties">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/messenger.properties">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/messenger.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/quickSearch.properties">mail/locales/en-US/chrome/messenger/quickSearch.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/quickSearch.properties">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/quickSearch.properties">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/quickSearch.properties">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/quickSearch.properties">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/quickSearch.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/search.properties">mail/locales/en-US/chrome/messenger/search.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/search.properties">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/search.properties">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/search.properties">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/search.properties">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/en-US/chrome/messenger/search.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/jar.mn">mail/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/themes/pinstripe/mail/searchBox.css">mail/themes/pinstripe/mail/searchBox.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/themes/pinstripe/mail/searchBox.css">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/themes/pinstripe/mail/searchBox.css">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/themes/pinstripe/mail/searchBox.css">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/themes/pinstripe/mail/searchBox.css">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mail/themes/pinstripe/mail/searchBox.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/src/dbViewWrapper.js">mailnews/base/src/dbViewWrapper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/src/dbViewWrapper.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/src/dbViewWrapper.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/src/dbViewWrapper.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/src/dbViewWrapper.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/src/dbViewWrapper.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/src/quickSearchManager.js">mailnews/base/src/quickSearchManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/src/quickSearchManager.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/src/quickSearchManager.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/src/quickSearchManager.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/src/quickSearchManager.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/src/quickSearchManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/util/errUtils.js">mailnews/base/util/errUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/util/errUtils.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/util/errUtils.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/util/errUtils.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/util/errUtils.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/base/util/errUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/components/glautocomp.js">mailnews/db/gloda/components/glautocomp.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/components/glautocomp.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/components/glautocomp.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/components/glautocomp.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/components/glautocomp.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/components/glautocomp.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/content/glodacomplete.css">mailnews/db/gloda/content/glodacomplete.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/content/glodacomplete.css">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/content/glodacomplete.css">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/content/glodacomplete.css">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/content/glodacomplete.css">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/content/glodacomplete.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/content/glodacomplete.xml">mailnews/db/gloda/content/glodacomplete.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/content/glodacomplete.xml">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/content/glodacomplete.xml">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/content/glodacomplete.xml">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/content/glodacomplete.xml">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/content/glodacomplete.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/collection.js">mailnews/db/gloda/modules/collection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/collection.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/collection.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/collection.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/collection.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/collection.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/datamodel.js">mailnews/db/gloda/modules/datamodel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/datamodel.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/datamodel.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/datamodel.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/datamodel.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/datamodel.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/datastore.js">mailnews/db/gloda/modules/datastore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/datastore.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/datastore.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/datastore.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/datastore.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/datastore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/dbview.js">mailnews/db/gloda/modules/dbview.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/dbview.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/dbview.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/dbview.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/dbview.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/dbview.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/explattr.js">mailnews/db/gloda/modules/explattr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/explattr.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/explattr.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/explattr.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/explattr.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/explattr.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/facet.js">mailnews/db/gloda/modules/facet.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/facet.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/facet.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/facet.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/facet.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/facet.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/fundattr.js">mailnews/db/gloda/modules/fundattr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/fundattr.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/fundattr.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/fundattr.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/fundattr.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/fundattr.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/gloda.js">mailnews/db/gloda/modules/gloda.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/gloda.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/gloda.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/gloda.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/gloda.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/gloda.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/index_ab.js">mailnews/db/gloda/modules/index_ab.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/index_ab.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/index_ab.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/index_ab.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/index_ab.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/index_ab.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/indexer.js">mailnews/db/gloda/modules/indexer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/indexer.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/indexer.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/indexer.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/indexer.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/indexer.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/mimeTypeCategories.js">mailnews/db/gloda/modules/mimeTypeCategories.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/mimeTypeCategories.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/mimeTypeCategories.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/mimeTypeCategories.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/mimeTypeCategories.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/mimeTypeCategories.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/msg_search.js">mailnews/db/gloda/modules/msg_search.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/msg_search.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/msg_search.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/msg_search.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/msg_search.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/msg_search.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_freetag.js">mailnews/db/gloda/modules/noun_freetag.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_freetag.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_freetag.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_freetag.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_freetag.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_freetag.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_mimetype.js">mailnews/db/gloda/modules/noun_mimetype.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_mimetype.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_mimetype.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_mimetype.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_mimetype.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_mimetype.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_tag.js">mailnews/db/gloda/modules/noun_tag.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_tag.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_tag.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_tag.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_tag.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/noun_tag.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/query.js">mailnews/db/gloda/modules/query.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/query.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/query.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/query.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/query.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/query.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/utils.js">mailnews/db/gloda/modules/utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/utils.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/utils.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/utils.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/utils.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/modules/utils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/test/unit/resources/glodaTestHelper.js">mailnews/db/gloda/test/unit/resources/glodaTestHelper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/test/unit/resources/glodaTestHelper.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/test/unit/resources/glodaTestHelper.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/test/unit/resources/glodaTestHelper.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/test/unit/resources/glodaTestHelper.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/test/unit/resources/glodaTestHelper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/test/unit/test_query_core.js">mailnews/db/gloda/test/unit/test_query_core.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/test/unit/test_query_core.js">file</a> |
<a href="/comm-central/annotate/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/test/unit/test_query_core.js">annotate</a> |
<a href="/comm-central/diff/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/test/unit/test_query_core.js">diff</a> |
<a href="/comm-central/comparison/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/test/unit/test_query_core.js">comparison</a> |
<a href="/comm-central/log/7e2abfed8c928253eaaca01be5313f01cf7050ea/mailnews/db/gloda/test/unit/test_query_core.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/extraCustomizeItems.xul</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/extraCustomizeItems.xul</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -47,32 +47,43 @@</span>
<a href="#l1.4"></a><span id="l1.4">   &lt;!ENTITY % msgViewPickerDTD SYSTEM &quot;chrome://messenger/locale/msgViewPickerOverlay.dtd&quot; &gt;</span>
<a href="#l1.5"></a><span id="l1.5">   %msgViewPickerDTD;</span>
<a href="#l1.6"></a><span id="l1.6">   &lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot;&gt;</span>
<a href="#l1.7"></a><span id="l1.7">   %brandDTD;</span>
<a href="#l1.8"></a><span id="l1.8"> ]&gt;</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> &lt;overlay xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+  &lt;popupset&gt;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    &lt;panel type=&quot;glodacomplete-richlistbox&quot; chromedir=&quot;ltr&quot;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+           id=&quot;PopupGlodaAutocomplete&quot; noautofocus=&quot;true&quot; /&gt;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  &lt;/popupset&gt;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+</span>
<a href="#l1.17"></a><span id="l1.17">   &lt;toolbarpalette id=&quot;MailToolbarPalette&quot;&gt;</span>
<a href="#l1.18"></a><span id="l1.18">     &lt;!-- gloda search widget; provides global (message) searching.  --&gt;</span>
<a href="#l1.19"></a><span id="l1.19">     &lt;toolbaritem id=&quot;gloda-search&quot; insertafter=&quot;search-container&quot;</span>
<a href="#l1.20"></a><span id="l1.20">                  title=&quot;&amp;glodaSearch.title;&quot;</span>
<a href="#l1.21"></a><span id="l1.21">                  align=&quot;center&quot;</span>
<a href="#l1.22"></a><span id="l1.22">                  class=&quot;chromeclass-toolbar-additional&quot;&gt;</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-      &lt;textbox id=&quot;glodaSearchInput&quot; flex=&quot;1&quot; type=&quot;search&quot;</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-               searchbutton=&quot;true&quot;</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-               emptytext=&quot;&amp;glodaSearchBar.emptyText;&quot;/&gt;</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+        &lt;textbox id=&quot;searchInput&quot; flex=&quot;1&quot;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+                 chromedir=&quot;ltr&quot;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+                 searchCriteria=&quot;true&quot;</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+                 type=&quot;glodacomplete&quot;</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+                 searchbutton=&quot;true&quot;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+                 autocompletesearch=&quot;gloda&quot;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+                 autocompletepopup=&quot;PopupGlodaAutocomplete&quot;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+                 &gt;</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+        &lt;/textbox&gt;</span>
<a href="#l1.35"></a><span id="l1.35">     &lt;/toolbaritem&gt;</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37">     &lt;toolbaritem id=&quot;search-container&quot; insertafter=&quot;button-stop&quot;</span>
<a href="#l1.38"></a><span id="l1.38">                  title=&quot;&amp;searchItem.title;&quot;</span>
<a href="#l1.39"></a><span id="l1.39">                  align=&quot;center&quot;</span>
<a href="#l1.40"></a><span id="l1.40">                  class=&quot;chromeclass-toolbar-additional&quot;&gt;</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-      &lt;textbox id=&quot;searchInput&quot; timeout=&quot;800&quot; flex=&quot;1&quot;</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+      &lt;textbox id=&quot;old_searchInput&quot; timeout=&quot;800&quot; flex=&quot;1&quot;</span>
<a href="#l1.43"></a><span id="l1.43">                onfocus=&quot;onSearchInputFocus(event);&quot;</span>
<a href="#l1.44"></a><span id="l1.44">                onclick=&quot;onSearchInputClick(event);&quot;</span>
<a href="#l1.45"></a><span id="l1.45">                onmousedown=&quot;onSearchInputMousedown(event);&quot;</span>
<a href="#l1.46"></a><span id="l1.46">                onblur=&quot;onSearchInputBlur(event);&quot;</span>
<a href="#l1.47"></a><span id="l1.47">                oncommand=&quot;onEnterInSearchBar();&quot;</span>
<a href="#l1.48"></a><span id="l1.48">                onkeypress=&quot;onSearchKeyPress();&quot;</span>
<a href="#l1.49"></a><span id="l1.49">                chromedir=&quot;&amp;locale.dir;&quot;&gt;</span>
<a href="#l1.50"></a><span id="l1.50">         &lt;button id=&quot;quick-search-button&quot; type=&quot;menu&quot; chromedir=&quot;&amp;locale.dir;&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/folderDisplay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/folderDisplay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -778,22 +778,22 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">   /**</span>
<a href="#l2.5"></a><span id="l2.5">    * The view wrapper tells us when a search is active, and we mark the tab as</span>
<a href="#l2.6"></a><span id="l2.6">    *  thinking so the user knows something is happening.  'Searching' in this</span>
<a href="#l2.7"></a><span id="l2.7">    *  case is more than just a user-initiated search.  Virtual folders / saved</span>
<a href="#l2.8"></a><span id="l2.8">    *  searches, mail views, plus the more obvious quick search are all based off</span>
<a href="#l2.9"></a><span id="l2.9">    *  of searches and we will receive a notification for them.</span>
<a href="#l2.10"></a><span id="l2.10">    */</span>
<a href="#l2.11"></a><span id="l2.11">   onSearching: function(aIsSearching) {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    // getDocumentElements() sets gSearchBundle</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-    getDocumentElements();</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-    if (this._tabInfo)</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+    if (this._tabInfo) {</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+      let searchBundle = document.getElementById(&quot;bundle_search&quot;);</span>
<a href="#l2.17"></a><span id="l2.17">       document.getElementById(&quot;tabmail&quot;).setTabThinking(</span>
<a href="#l2.18"></a><span id="l2.18">         this._tabInfo,</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-        aIsSearching &amp;&amp; gSearchBundle.getString(&quot;searchingMessage&quot;));</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+        aIsSearching &amp;&amp; searchBundle.getString(&quot;searchingMessage&quot;));</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+    }</span>
<a href="#l2.22"></a><span id="l2.22">   },</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24">   /**</span>
<a href="#l2.25"></a><span id="l2.25">    * Things we do on creating a view:</span>
<a href="#l2.26"></a><span id="l2.26">    * - notify the observer service so that custom column handler providers can</span>
<a href="#l2.27"></a><span id="l2.27">    *   add their custom columns to our view.</span>
<a href="#l2.28"></a><span id="l2.28">    */</span>
<a href="#l2.29"></a><span id="l2.29">   onCreatedView: function FolderDisplayWidget_onCreatedView() {</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineat">@@ -887,18 +887,16 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.31"></a><span id="l2.31">     // makeActive will restore the folder state</span>
<a href="#l2.32"></a><span id="l2.32">     if (!this._savedColumnStates) {</span>
<a href="#l2.33"></a><span id="l2.33">       // get the default for this folder</span>
<a href="#l2.34"></a><span id="l2.34">       this._savedColumnStates = this._getDefaultColumnsForCurrentFolder();</span>
<a href="#l2.35"></a><span id="l2.35">       // and save it so it doesn't wiggle if the inbox/prototype changes</span>
<a href="#l2.36"></a><span id="l2.36">       this._persistColumnStates(this._savedColumnStates);</span>
<a href="#l2.37"></a><span id="l2.37">     }</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-    // the quick-search gets nuked when we show a new folder</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-    ClearQSIfNecessary();</span>
<a href="#l2.41"></a><span id="l2.41">     // update the quick-search relative to whether it's incoming/outgoing</span>
<a href="#l2.42"></a><span id="l2.42">     onSearchFolderTypeChanged(this.view.isOutgoingFolder);</span>
<a href="#l2.43"></a><span id="l2.43"> </span>
<a href="#l2.44"></a><span id="l2.44">     if (this.active)</span>
<a href="#l2.45"></a><span id="l2.45">       this.makeActive();</span>
<a href="#l2.46"></a><span id="l2.46">   },</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48">   /**</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineat">@@ -1433,19 +1431,16 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l2.50"></a><span id="l2.50">         let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l2.51"></a><span id="l2.51">         if (searchInput &amp;&amp; this._savedQuickSearch) {</span>
<a href="#l2.52"></a><span id="l2.52">           searchInput.searchMode = this._savedQuickSearch.searchMode;</span>
<a href="#l2.53"></a><span id="l2.53">           if (this._savedQuickSearch.text) {</span>
<a href="#l2.54"></a><span id="l2.54">             searchInput.value = this._savedQuickSearch.text;</span>
<a href="#l2.55"></a><span id="l2.55">             searchInput.showingSearchCriteria = false;</span>
<a href="#l2.56"></a><span id="l2.56">             searchInput.clearButtonHidden = false;</span>
<a href="#l2.57"></a><span id="l2.57">           }</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-          else {</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-            searchInput.setSearchCriteriaText();</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-          }</span>
<a href="#l2.61"></a><span id="l2.61">         }</span>
<a href="#l2.62"></a><span id="l2.62">       }</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64">       // Always restore the column state if we have persisted state.  We restore</span>
<a href="#l2.65"></a><span id="l2.65">       //  state on folder entry, in which case we were probably not inactive.</span>
<a href="#l2.66"></a><span id="l2.66">       this._restoreColumnStates();</span>
<a href="#l2.67"></a><span id="l2.67"> </span>
<a href="#l2.68"></a><span id="l2.68">       // the tab mode knows whether we are folder or message display, which</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mail/base/content/glodaFacetBindings.css</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,31 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+#query-explanation {</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+  -moz-binding: url('chrome://messenger/content/glodaFacetBindings.xml#query-explanation');</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+}</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+.facets {</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+  -moz-binding: url('chrome://messenger/content/glodaFacetBindings.xml#facets');</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+}</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+.facetious[type=&quot;discrete&quot;] {</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  -moz-binding: url('chrome://messenger/content/glodaFacetBindings.xml#facet-discrete');</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+}</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+.facetious[type=&quot;boolean&quot;] {</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  -moz-binding: url('chrome://messenger/content/glodaFacetBindings.xml#facet-boolean');</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+}</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+.facetious[type=&quot;boolean-filtered&quot;] {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+  -moz-binding: url('chrome://messenger/content/glodaFacetBindings.xml#facet-boolean-filtered');</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+}</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+.facetious[type=&quot;date&quot;] {</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+  -moz-binding: url('chrome://messenger/content/glodaFacetBindings.xml#facet-date');</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+}</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+.results[type=&quot;message&quot;] {</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  -moz-binding: url('chrome://messenger/content/glodaFacetBindings.xml#results-message');</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+}</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+.message {</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  -moz-binding: url('chrome://messenger/content/glodaFacetBindings.xml#result-message');</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mail/base/content/glodaFacetBindings.xml</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,1029 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+&lt;!-- ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+  - Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+  -</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+  - The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+  - 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  - the License. You may obtain a copy of the License at</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  - http://www.mozilla.org/MPL/</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  -</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  - Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  - WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+  - for the specific language governing rights and limitations under the</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  - License.</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+  -</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+  - The Original Code is Thunderbird Global Database.</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+  -</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+  - The Initial Developer of the Original Code is</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+  - Mozilla Messaging, Inc.</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  - Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  - the Initial Developer. All Rights Reserved.</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+  -</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+  - Contributor(s):</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+  -   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+  -   David Ascher &lt;dascher@mozillamessaging.com&gt;</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  -   Bryan Clark &lt;clarkbw@gnome.org&gt;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+  -</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  - either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  - or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+  - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+  - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+  - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  - decision by deleting the provisions above and replace them with the notice</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+  - and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+  - the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+  - the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  - ***** END LICENSE BLOCK ***** --&gt;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+&lt;bindings id=&quot;glodaFacetBindings&quot;</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+          xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+          xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+          xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+          xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+          xmlns:svg=&quot;http://www.w3.org/2000/svg&quot;&gt;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+&lt;!-- ===== Constraints ===== --&gt;</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+&lt;binding id=&quot;query-explanation&quot;&gt;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+  &lt;content&gt;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  &lt;/content&gt;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+    &lt;!-- Indicate that we are based on a fulltext search--&gt;</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+    &lt;method name=&quot;setFulltext&quot;&gt;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+      &lt;parameter name=&quot;aMsgSearcher&quot; /&gt;</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+        while (this.lastChild)</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+          this.removeChild(this.lastChild);</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+        let dis = this;</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+        function spanify(aText, aClass) {</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+          let span = document.createElement(&quot;span&quot;);</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+          span.setAttribute(&quot;class&quot;, aClass);</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+          span.textContent = aText;</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+          dis.appendChild(span);</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+          return span;</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+        }</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+        let labelFormat = glodaFacetStrings.get(</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+          &quot;glodaFacetView.constraints.query.fulltext.label&quot;);</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+        let [labelPre, labelPost] = labelFormat.split(&quot;#1&quot;);</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+        // trim both; we rely on CSS to handle the spacing</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+        labelPre = labelPre.trim();</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+        labelPost = labelPost.trim();</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+        if (labelPre)</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+          spanify(labelPre, &quot;explanation-fulltext-label&quot;);</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+        let criteriaText = glodaFacetStrings.get(</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+          &quot;glodaFacetView.constraints.query.fulltext.&quot; +</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+          (aMsgSearcher.andTerms ? &quot;and&quot; : &quot;or&quot;) + &quot;JoinWord&quot;);</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+        for each (let [iTerm, term] in Iterator(aMsgSearcher.fulltextTerms)) {</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+          if (iTerm)</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+            spanify(criteriaText, &quot;explanation-fulltext-criteria&quot;);</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+          spanify(term, &quot;explanation-fulltext-term&quot;);</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+        }</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+        if (labelPost)</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+          spanify(labelPost, &quot;explanation-fulltext-label&quot;);</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+        if (aMsgSearcher.fulltextTerms.length &gt; 1) {</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+          spanify(</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+            glodaFacetStrings.get(&quot;glodaFacetView.constraints.query.fulltext.&quot; +</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+              (aMsgSearcher.andTerms ? &quot;changeToOrLabel&quot; : &quot;changeToAndLabel&quot;)),</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+            &quot;explanation-change-label&quot;)</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+          .onclick = function() {</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+            FacetContext.toggleFulltextCriteria();</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+          };</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+        }</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+    &lt;method name=&quot;setQuery&quot;&gt;</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+      &lt;parameter name=&quot;aMsgQuery&quot; /&gt;</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+      try {</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+        while (this.lastChild)</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+          this.removeChild(this.lastChild);</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+        let dis = this;</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+        function spanify(aText, aClass) {</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+          let span = document.createElement(&quot;span&quot;);</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+          span.setAttribute(&quot;class&quot;, aClass);</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+          span.textContent = aText;</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+          dis.appendChild(span);</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+          return span;</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+        }</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+        let label = glodaFacetStrings.get(</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+          &quot;glodaFacetView.constraints.query.initial&quot;);</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+        spanify(label, &quot;explanation-query-label&quot;);</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+        let constraintStrings = [];</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+        for each (let constraint in aMsgQuery._constraints) {</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+          if (constraint[0] != 1) return; // no idea what this is about</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+          if (constraint[1].attributeName == 'involves') {</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+            let involvesLabel = glodaFacetStrings.get(</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+              &quot;glodaFacetView.constraints.query.involves.label&quot;);</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+            involvesLabel = involvesLabel.replace(&quot;#1&quot;, constraint[2].value)</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+            spanify(involvesLabel, &quot;explanation-query-involves&quot;);</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+          } else if (constraint[1].attributeName == 'tag') {</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+            let tagLabel = glodaFacetStrings.get(</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+              &quot;glodaFacetView.constraints.query.tagged.label&quot;);</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+            let tag = constraint[2];</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+            let _msgTagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;].</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+                                      getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+            let tagNode = document.createElement(&quot;span&quot;);</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+            let colorClass = &quot;blc-&quot; + _msgTagService.getColorForKey(tag.key).substr(1);</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+            tagNode.setAttribute(&quot;class&quot;, &quot;message-tag tag &quot; + colorClass);</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+            tagNode.textContent = tag.tag;</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+            spanify(tagLabel, &quot;explanation-query-tagged&quot;);</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+            this.appendChild(tagNode);</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+          }</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+        }</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+        label = label + constraintStrings.join(', '); // XXX l10n?</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+      } catch (e) {</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+        logException(e);</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+      }</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+&lt;!-- ===== Facets ===== --&gt;</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+&lt;binding id=&quot;facets&quot;&gt;</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+  &lt;content&gt;</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+  &lt;/content&gt;</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+    &lt;method name=&quot;clearFacets&quot;&gt;</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+        while (this.lastChild != null)</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+          this.removeChild(this.lastChild);</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+    &lt;method name=&quot;addFacet&quot;&gt;</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+      &lt;parameter name=&quot;aType&quot; /&gt;</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+      &lt;parameter name=&quot;aAttrDef&quot; /&gt;</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+      &lt;parameter name=&quot;aArgs&quot; /&gt;</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+        let facets = this;</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+        let facet = document.createElement(&quot;div&quot;);</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+        facet.attrDef = aAttrDef;</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+        facet.nounDef = aAttrDef.objectNounDef;</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+        for each (let [key, value] in Iterator(aArgs)) {</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+          facet[key] = value;</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+        }</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+        facet.setAttribute(&quot;class&quot;, &quot;facetious&quot;);</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+        facet.setAttribute(&quot;type&quot;, aType);</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+        facet.setAttribute(&quot;name&quot;, aAttrDef.attributeName);</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+        facets.appendChild(facet);</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+        return facet;</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+&lt;binding id=&quot;facet-base&quot;&gt;</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+    &lt;method name=&quot;brushItems&quot;&gt;</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+    &lt;method name=&quot;clearBrushedItems&quot;&gt;</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+&lt;!--</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+  - A boolean facet; we presume orderedGroups contains at most two entries, and</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+  -  that their group values consist of true or false.</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+  -</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+  - The implication of this UI is that you only want to filter to true values</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+  -  and would never want to filter out the false values.  Consistent with this</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+  -  assumption we disable the UI if there are no true values.</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+  -</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+  - This depressingly</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+  --&gt;</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+&lt;binding id=&quot;facet-boolean&quot;</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+         extends=&quot;chrome://messenger/content/glodaFacetBindings.xml#facet-base&quot;&gt;</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+  &lt;content&gt;</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+    &lt;html:span anonid=&quot;bubble&quot; class=&quot;facet-checkbox-bubble&quot;&gt;</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+      &lt;html:input anonid=&quot;checkbox&quot; type=&quot;checkbox&quot; /&gt;</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+      &lt;html:span anonid=&quot;label&quot; class=&quot;facet-checkbox-label&quot; /&gt;</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+      &lt;html:span anonid=&quot;count&quot; class=&quot;facet-checkbox-count&quot; /&gt;</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+    &lt;/html:span&gt;</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+  &lt;/content&gt;</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+    &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+      this.bubble = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+                                                            &quot;bubble&quot;);</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+      this.checkbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+                                                              &quot;checkbox&quot;);</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+      this.labelNode = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+                                                               &quot;label&quot;);</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+      this.countNode = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+                                                               &quot;count&quot;);</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+      let dis = this;</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+      this.bubble.addEventListener(&quot;click&quot;, function (event) {</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+        return dis.bubbleClicked(event);</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+      }, true);</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+      this.extraSetup();</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+      if (&quot;faceter&quot; in this)</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+        this.build(true);</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+    ]]&gt;&lt;/constructor&gt;</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+    &lt;field name=&quot;canUpdate&quot; readonly=&quot;true&quot;&gt;true&lt;/field&gt;</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+    &lt;property name=&quot;disabled&quot;&gt;</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+      &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+        return this.getAttribute(&quot;disabled&quot;) == &quot;true&quot;;</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+      ]]&gt;&lt;/getter&gt;</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+      &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+        if (val) {</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+          this.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+          this.checkbox.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+        }</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+        else {</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+          this.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+          this.checkbox.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+        }</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+      ]]&gt;&lt;/setter&gt;</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+    &lt;/property&gt;</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+    &lt;property name=&quot;checked&quot;&gt;</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+      &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+        return this.getAttribute(&quot;checked&quot;) == &quot;true&quot;;</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+      ]]&gt;&lt;/getter&gt;</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+      &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+        if (this.checked == val)</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+          return;</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+        this.checkbox.checked = val;</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+        if (val) {</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+          // the XBL inherits magic appears to fail if we explicitly check the</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+          //  box itself rather than via our click handler, presumably because</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+          //  we unshadow something.  So manually apply changes ourselves.</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+          this.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+          this.checkbox.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+          if (!this.disabled)</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+            FacetContext.addFacetConstraint(this.faceter, this.attrDef, true,</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+                                            this.trueGroups);</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+        }</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+        else {</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+          this.removeAttribute(&quot;checked&quot;);</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+          this.checkbox.removeAttribute(&quot;checked&quot;);</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+          if (!this.disabled)</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+            FacetContext.removeFacetConstraint(this.faceter);</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+        }</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+        this.checkStateChanged();</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineplus">+      ]]&gt;&lt;/setter&gt;</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+    &lt;/property&gt;</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+    &lt;method name=&quot;extraSetup&quot;&gt;</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+    &lt;method name=&quot;checkStateChanged&quot;&gt;</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+    &lt;method name=&quot;build&quot;&gt;</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+      &lt;parameter name=&quot;aFirstTime&quot; /&gt;</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+        if (aFirstTime) {</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+          this.labelNode.textContent = this.attrDef.strings.facetLabel;</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+          this.checkbox.setAttribute(&quot;aria-label&quot;,</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+                                     this.attrDef.strings.facetLabel);</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineplus">+        }</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineplus">+</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineplus">+        // If we do not currently have a constraint applied and there is only</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineplus">+        //  one (or no) group, then: disable us, but reflect the underlying</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineplus">+        //  state of the data (checked or non-checked)</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineplus">+        if (!this.faceter.constraint &amp;&amp; (this.orderedGroups.length &lt;= 1)){</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineplus">+          this.disabled = true;</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+          let count = 0;</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+          if (this.orderedGroups.length) {</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+            // true case?</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+            if (this.orderedGroups[0][0]) {</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+              count = this.orderedGroups[0][1].length;</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineplus">+              this.checked = true;</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+            }</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+            else {</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineplus">+              this.checked = false;</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineplus">+            }</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineplus">+          }</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineplus">+          this.countNode.textContent = count.toLocaleString();</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+          return;</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+        }</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineplus">+        // if we were disabled checked before, clear ourselves out</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineplus">+        if (this.disabled &amp;&amp; this.checked)</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineplus">+          this.checked = false;</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineplus">+        this.disabled = false;</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineplus">+</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineplus">+        // if we are here, we have our 2 groups, find true...</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineplus">+        // (note: it is possible to get jerked around by null values</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+        //  currently, so leave a reasonable failure case)</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+        this.trueValues = [];</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineplus">+        this.trueGroups = [true];</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+        for each (let [, groupPair] in Iterator(this.orderedGroups)) {</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+          if (groupPair[0] == true)</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineplus">+            this.trueValues = groupPair[1];</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineplus">+        }</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineplus">+</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineplus">+        this.countNode.textContent = this.trueValues.length.toLocaleString();</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+    &lt;method name=&quot;bubbleClicked&quot;&gt;</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineplus">+      &lt;parameter name=&quot;event&quot; /&gt;</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+      if (!this.disabled)</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+        this.checked = !this.checked;</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+      event.stopPropagation();</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineplus">+&lt;!--</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+  - A check-box with filter-box front-end to a standard discrete faceter.  If</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+  -  there are no non-null values, we disable the UI.  If there are non-null</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+  -  values the checkbox is enabled and the filter is hidden.  Once you check</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+  -  the box we apply the facet and show the filtering mechanism.</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineplus">+  --&gt;</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineplus">+&lt;binding id=&quot;facet-boolean-filtered&quot;</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+         extends=&quot;chrome://messenger/content/glodaFacetBindings.xml#facet-boolean&quot;&gt;</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineplus">+  &lt;content&gt;</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineplus">+    &lt;html:span anonid=&quot;bubble&quot; class=&quot;facet-checkbox-bubble&quot;&gt;</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineplus">+      &lt;html:input anonid=&quot;checkbox&quot; type=&quot;checkbox&quot;</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineplus">+                  xbl:inherits=&quot;checked,disabled&quot;/&gt;</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineplus">+      &lt;html:span anonid=&quot;label&quot; class=&quot;facet-checkbox-label&quot; /&gt;</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineplus">+      &lt;html:span anonid=&quot;count&quot; class=&quot;facet-checkbox-count&quot; /&gt;</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineplus">+    &lt;/html:span&gt;</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineplus">+    &lt;html:select anonid=&quot;filter&quot; class=&quot;facet-filter-list&quot; /&gt;</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineplus">+  &lt;/content&gt;</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineplus">+    &lt;method name=&quot;extraSetup&quot;&gt;</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineplus">+        this.filterNode = document.getAnonymousElementByAttribute(</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineplus">+                            this, &quot;anonid&quot;, &quot;filter&quot;);</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineplus">+        this.groupDisplayProperty = this.getAttribute(&quot;groupDisplayProperty&quot;);</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineplus">+</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineplus">+        let dis = this;</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineplus">+        this.filterNode.addEventListener(&quot;change&quot;, function(event) {</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineplus">+          return dis.filterChanged(event);</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineplus">+        }, false);</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineplus">+</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineplus">+        this.selectedValue = &quot;all&quot;;</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineplus">+    &lt;method name=&quot;build&quot;&gt;</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineplus">+      &lt;parameter name=&quot;aFirstTime&quot; /&gt;</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineplus">+        if (aFirstTime) {</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineplus">+          this.labelNode.textContent = this.attrDef.strings.facetLabel;</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineplus">+          this.checkbox.setAttribute(&quot;aria-label&quot;,</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineplus">+                                     this.attrDef.strings.facetLabel);</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+        }</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineplus">+</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineplus">+        // Only update count if anything other than &quot;all&quot; is selected.</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineplus">+        //  Otherwise we lose the set of attachment types in our select box,</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineplus">+        //  and that makes us sad.  We do want to update on &quot;all&quot; though</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+        //  because other facets may further reduce the number of attachments</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+        //  we see.  (Or if this is not just being used for attachments, it</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+        //  still holds.)</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+        if (this.selectedValue != &quot;all&quot;) {</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineplus">+          let count = 0;</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+          for each (let [, groupPair] in Iterator(this.orderedGroups)) {</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+            if (groupPair[0] != null)</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineplus">+              count += groupPair[1].length;</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineplus">+          }</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineplus">+          this.countNode.textContent = count.toLocaleString();</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineplus">+          return;</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineplus">+        }</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineplus">+</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineplus">+        while (this.filterNode.lastChild)</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineplus">+          this.filterNode.removeChild(this.filterNode.lastChild);</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineplus">+        let allNode = document.createElement(&quot;option&quot;);</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineplus">+        allNode.textContent =</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineplus">+          glodaFacetStrings.get(&quot;glodaFacetView.facets.filter.&quot; +</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineplus">+                                this.attrDef.attributeName + &quot;.allLabel&quot;);</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineplus">+        allNode.setAttribute(&quot;value&quot;, &quot;all&quot;);</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineplus">+        if (this.selectedValue == &quot;all&quot;)</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineplus">+          allNode.setAttribute(&quot;selected&quot;, &quot;selected&quot;);</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineplus">+        this.filterNode.appendChild(allNode);</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+        // if we are here, we have our 2 groups, find true...</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineplus">+        // (note: it is possible to get jerked around by null values</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineplus">+        //  currently, so leave a reasonable failure case)</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineplus">+        // empty true groups is for the checkbox</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineplus">+        this.trueGroups = [];</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineplus">+        // the real true groups is the actual true values for our explicit</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineplus">+        //  filtering</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineplus">+        this.realTrueGroups = [];</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineplus">+        this.trueValues = [];</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineplus">+        this.falseValues = [];</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineplus">+        let selectNodes = [];</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineplus">+        for each (let [, groupPair] in Iterator(this.orderedGroups)) {</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineplus">+          if (groupPair[0] == null)</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineplus">+            this.falseValues.push.apply(this.falseValues, groupPair[1]);</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineplus">+          else {</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineplus">+            this.trueValues.push.apply(this.trueValues, groupPair[1]);</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineplus">+</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+            let groupValue = groupPair[0];</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineplus">+            let selNode = document.createElement(&quot;option&quot;);</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineplus">+            selNode.textContent = groupValue[this.groupDisplayProperty];</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineplus">+            selNode.setAttribute(&quot;value&quot;, this.realTrueGroups.length);</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineplus">+            if (this.selectedValue == groupValue.category)</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineplus">+              selNode.setAttribute(&quot;selected&quot;, &quot;selected&quot;);</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineplus">+            selectNodes.push(selNode);</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineplus">+</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineplus">+            this.realTrueGroups.push(groupValue);</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineplus">+          }</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineplus">+        }</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineplus">+        selectNodes.sort(function(a, b) {</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineplus">+          return a.textContent.localeCompare(b.textContent);</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineplus">+        })</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineplus">+        for each (let [, selNode] in Iterator(selectNodes)) {</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineplus">+          this.filterNode.appendChild(selNode);</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineplus">+        }</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineplus">+</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineplus">+        this.disabled = !this.trueValues.length;</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineplus">+</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineplus">+        this.countNode.textContent = this.trueValues.length.toLocaleString();</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineplus">+    &lt;method name=&quot;checkStateChanged&quot;&gt;</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineplus">+        // if they un-check us, revert our value to all.</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineplus">+        if (!this.checked)</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineplus">+          this.selectedValue = &quot;all&quot;;</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineplus">+    &lt;method name=&quot;filterChanged&quot;&gt;</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineplus">+      &lt;parameter name=&quot;event&quot; /&gt;</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineplus">+        if (!this.checked)</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineplus">+          return;</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineplus">+        if (this.filterNode.value == &quot;all&quot;) {</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineplus">+          this.selectedValue = &quot;all&quot;;</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineplus">+          FacetContext.addFacetConstraint(this.faceter, this.attrDef, true,</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineplus">+                                          this.trueGroups, false, true);</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineplus">+        }</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineplus">+        else {</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineplus">+          let groupValue = this.realTrueGroups[parseInt(this.filterNode.value)];</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineplus">+          this.selectedValue = groupValue.category;</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineplus">+          FacetContext.addFacetConstraint(this.faceter, this.attrDef, true,</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineplus">+                                          [groupValue], false, true);</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineplus">+        }</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.488"></a><span id="l4.488" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineplus">+</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineplus">+&lt;binding id=&quot;facet-discrete&quot;&gt;</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineplus">+  &lt;content&gt;</span>
<a href="#l4.494"></a><span id="l4.494" class="difflineplus">+  &lt;!-- without this explicit div here, the sibling selectors used to span</span>
<a href="#l4.495"></a><span id="l4.495" class="difflineplus">+       included-label/included and excluded-label/excluded fail to apply.</span>
<a href="#l4.496"></a><span id="l4.496" class="difflineplus">+       so. magic! (this is why our binding node's class is facetious. --&gt;</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineplus">+  &lt;html:div class=&quot;facet&quot;&gt;</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineplus">+    &lt;html:h2 anonid=&quot;name&quot;&gt;&lt;/html:h2&gt;</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineplus">+    &lt;html:ul anonid=&quot;included&quot; class=&quot;facet-included barry&quot;&gt;&lt;/html:ul&gt;</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineplus">+    &lt;html:ul anonid=&quot;excluded&quot; class=&quot;facet-excluded barry&quot;&gt;&lt;/html:ul&gt;</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineplus">+    &lt;html:ul anonid=&quot;candidates&quot; class=&quot;barry&quot;&gt;&lt;/html:ul&gt;</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineplus">+  &lt;/html:div&gt;</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineplus">+  &lt;/content&gt;</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineplus">+    &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineplus">+      if (&quot;faceter&quot; in this)</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineplus">+        this.build(true);</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineplus">+    ]]&gt;&lt;/constructor&gt;</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineplus">+    &lt;field name=&quot;canUpdate&quot; readonly=&quot;true&quot;&gt;false&lt;/field&gt;</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineplus">+    &lt;method name=&quot;lockSize&quot;&gt;</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.512"></a><span id="l4.512" class="difflineplus">+        return;</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineplus">+        if (this.style.paddingBottom != &quot;0px&quot;) {</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineplus">+          let $this = $(this);</span>
<a href="#l4.515"></a><span id="l4.515" class="difflineplus">+          let height = ($this.height() + 60) + &quot;px&quot;;</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineplus">+          let width = $this.width() + &quot;px&quot;;</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineplus">+          this.style.minWidth = width;</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineplus">+          this.style.minHeight = height;</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineplus">+          this.style.maxWidth = width;</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineplus">+          this.style.maxHeight = height;</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineplus">+          this.style.paddingBottom = &quot;0px&quot;;</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineplus">+        }</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineplus">+    &lt;method name=&quot;build&quot;&gt;</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineplus">+      &lt;parameter name=&quot;aFirstTime&quot; /&gt;</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineplus">+        // -- Header Building</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineplus">+        let nameNode = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineplus">+                                                               &quot;name&quot;);</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineplus">+        nameNode.textContent = this.attrDef.strings.facetLabel;</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineplus">+        nameNode.setAttribute(&quot;title&quot;, this.attrDef.strings.facetTooltip);</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineplus">+</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineplus">+</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineplus">+        this.inclList = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineplus">+                                                                &quot;included&quot;);</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineplus">+        this.exclList = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineplus">+                                                                &quot;excluded&quot;);</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineplus">+</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineplus">+        this.inclList.setAttribute(&quot;state&quot;, &quot;empty&quot;);</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineplus">+        this.exclList.setAttribute(&quot;state&quot;, &quot;empty&quot;);</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineplus">+</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineplus">+        // -- House-cleaning</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineplus">+        // -- All/Top mode decision</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineplus">+        // to simplify our logic, we always need an other group sentinel even</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineplus">+        //  if we are operating in &quot;all&quot; mode.</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineplus">+        this.otherGroupObject = {};</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineplus">+        this.modes = [&quot;all&quot;];</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineplus">+        if (this.maxDisplayRows &gt;= this.orderedGroups.length) {</span>
<a href="#l4.550"></a><span id="l4.550" class="difflineplus">+          this.mode = &quot;all&quot;;</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineplus">+        }</span>
<a href="#l4.552"></a><span id="l4.552" class="difflineplus">+        else {</span>
<a href="#l4.553"></a><span id="l4.553" class="difflineplus">+          // top mode must be used</span>
<a href="#l4.554"></a><span id="l4.554" class="difflineplus">+          this.modes.push(&quot;top&quot;);</span>
<a href="#l4.555"></a><span id="l4.555" class="difflineplus">+          this.mode = &quot;top&quot;;</span>
<a href="#l4.556"></a><span id="l4.556" class="difflineplus">+          this.topGroups = FacetUtils.makeTopGroups(this.attrDef,</span>
<a href="#l4.557"></a><span id="l4.557" class="difflineplus">+                                                    this.orderedGroups,</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineplus">+                                                    this.maxDisplayRows,</span>
<a href="#l4.559"></a><span id="l4.559" class="difflineplus">+                                                    this.otherGroupObject);</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineplus">+        }</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineplus">+</span>
<a href="#l4.562"></a><span id="l4.562" class="difflineplus">+        // -- Row Building</span>
<a href="#l4.563"></a><span id="l4.563" class="difflineplus">+        this.buildRows();</span>
<a href="#l4.564"></a><span id="l4.564" class="difflineplus">+</span>
<a href="#l4.565"></a><span id="l4.565" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineplus">+    &lt;method name=&quot;buildRows&quot;&gt;</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.569"></a><span id="l4.569" class="difflineplus">+        let nounDef = this.nounDef;</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineplus">+        let useGroups = (this.mode == &quot;all&quot;) ? this.orderedGroups</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineplus">+                                             : this.topGroups;</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineplus">+</span>
<a href="#l4.573"></a><span id="l4.573" class="difflineplus">+        // -- empty all of our display buckets...</span>
<a href="#l4.574"></a><span id="l4.574" class="difflineplus">+        let root = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l4.575"></a><span id="l4.575" class="difflineplus">+                                                           &quot;candidates&quot;);</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineplus">+        while (root.lastChild)</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineplus">+          root.removeChild(root.lastChild);</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineplus">+</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineplus">+        let inclList = this.inclList, exclList = this.exclList;</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineplus">+        while (inclList.lastChild)</span>
<a href="#l4.581"></a><span id="l4.581" class="difflineplus">+          inclList.removeChild(inclList.lastChild);</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineplus">+        while (exclList.lastChild)</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineplus">+          exclList.removeChild(exclList.lastChild);</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineplus">+</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineplus">+        // for our bar-graph thing we need to find the largest group size</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineplus">+        let maxGroupSize = 0;</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineplus">+        for each (let [, groupPair] in Iterator(useGroups)) {</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineplus">+          maxGroupSize = Math.max(maxGroupSize, groupPair[1].length);</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineplus">+        }</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineplus">+</span>
<a href="#l4.591"></a><span id="l4.591" class="difflineplus">+        for each (let [, groupPair] in Iterator(useGroups)) {</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineplus">+          let [groupValue, groupItems] = groupPair;</span>
<a href="#l4.593"></a><span id="l4.593" class="difflineplus">+          let li = document.createElement(&quot;li&quot;);</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineplus">+          li.setAttribute(&quot;class&quot;, &quot;bar&quot;);</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineplus">+          li.groupValue = groupValue;</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineplus">+          li.groupItems = groupItems;</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineplus">+</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineplus">+          let label = document.createElement(&quot;a&quot;);</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineplus">+          label.setAttribute(&quot;class&quot;, &quot;bar-link&quot;);</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineplus">+          // The null value is a special indicator for 'none'</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineplus">+          if (groupValue == null) {</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineplus">+            label.textContent =</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineplus">+              glodaFacetStrings.get(&quot;glodaFacetView.facets.noneLabel&quot;);</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineplus">+          }</span>
<a href="#l4.605"></a><span id="l4.605" class="difflineplus">+          // Top mode uses a sentinel value for the 'other' case</span>
<a href="#l4.606"></a><span id="l4.606" class="difflineplus">+          else if (groupValue == this.otherGroupObject) {</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineplus">+            label.textContent = glodaFacetStrings.get(</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineplus">+                                  &quot;glodaFacetView.facets.mode.top.otherLabel&quot;,</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineplus">+                                  [this.otherGroupObject.count.toLocaleString(),</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineplus">+                                   ]);</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineplus">+          }</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineplus">+          // Otherwise stringify the group object</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineplus">+          else {</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineplus">+            // XXX do a better job of truncation</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineplus">+            label.textContent = (&quot;userVisibleString&quot; in nounDef) ?</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineplus">+                                  nounDef.userVisibleString(groupValue) :</span>
<a href="#l4.617"></a><span id="l4.617" class="difflineplus">+                                  groupValue.toLocaleString().substring(0, 80);</span>
<a href="#l4.618"></a><span id="l4.618" class="difflineplus">+          }</span>
<a href="#l4.619"></a><span id="l4.619" class="difflineplus">+</span>
<a href="#l4.620"></a><span id="l4.620" class="difflineplus">+          li.appendChild(label);</span>
<a href="#l4.621"></a><span id="l4.621" class="difflineplus">+</span>
<a href="#l4.622"></a><span id="l4.622" class="difflineplus">+          let barSpan = document.createElement(&quot;span&quot;);</span>
<a href="#l4.623"></a><span id="l4.623" class="difflineplus">+          let percent = Math.floor(100 * groupItems.length / maxGroupSize);</span>
<a href="#l4.624"></a><span id="l4.624" class="difflineplus">+          barSpan.setAttribute(&quot;class&quot;, &quot;bar-percent&quot;);</span>
<a href="#l4.625"></a><span id="l4.625" class="difflineplus">+          barSpan.setAttribute(&quot;style&quot;, &quot;width: &quot; + percent +  &quot;%&quot;);</span>
<a href="#l4.626"></a><span id="l4.626" class="difflineplus">+          barSpan.textContent = percent + &quot;%&quot;;</span>
<a href="#l4.627"></a><span id="l4.627" class="difflineplus">+          li.appendChild(barSpan);</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineplus">+</span>
<a href="#l4.629"></a><span id="l4.629" class="difflineplus">+          let excludeSpan = document.createElement(&quot;span&quot;);</span>
<a href="#l4.630"></a><span id="l4.630" class="difflineplus">+          excludeSpan.setAttribute(&quot;class&quot;, &quot;bar-exclude&quot;);</span>
<a href="#l4.631"></a><span id="l4.631" class="difflineplus">+          li.appendChild(excludeSpan);</span>
<a href="#l4.632"></a><span id="l4.632" class="difflineplus">+</span>
<a href="#l4.633"></a><span id="l4.633" class="difflineplus">+          root.appendChild(li);</span>
<a href="#l4.634"></a><span id="l4.634" class="difflineplus">+        }</span>
<a href="#l4.635"></a><span id="l4.635" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.636"></a><span id="l4.636" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.637"></a><span id="l4.637" class="difflineplus">+    &lt;method name=&quot;brushItems&quot;&gt;</span>
<a href="#l4.638"></a><span id="l4.638" class="difflineplus">+      &lt;parameter name=&quot;aItems&quot; /&gt;</span>
<a href="#l4.639"></a><span id="l4.639" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.640"></a><span id="l4.640" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.641"></a><span id="l4.641" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.642"></a><span id="l4.642" class="difflineplus">+    &lt;method name=&quot;clearBrushedItems&quot;&gt;</span>
<a href="#l4.643"></a><span id="l4.643" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.644"></a><span id="l4.644" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.645"></a><span id="l4.645" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.646"></a><span id="l4.646" class="difflineplus">+    &lt;method name=&quot;afterListVisible&quot;&gt;</span>
<a href="#l4.647"></a><span id="l4.647" class="difflineplus">+      &lt;parameter name=&quot;aInclude&quot; /&gt;</span>
<a href="#l4.648"></a><span id="l4.648" class="difflineplus">+      &lt;parameter name=&quot;aCallback&quot; /&gt;</span>
<a href="#l4.649"></a><span id="l4.649" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.650"></a><span id="l4.650" class="difflineplus">+        let listNode = aInclude ? this.inclList : this.exclList;</span>
<a href="#l4.651"></a><span id="l4.651" class="difflineplus">+</span>
<a href="#l4.652"></a><span id="l4.652" class="difflineplus">+        // if there are already things displayed, no need</span>
<a href="#l4.653"></a><span id="l4.653" class="difflineplus">+        if (listNode.childElementCount) {</span>
<a href="#l4.654"></a><span id="l4.654" class="difflineplus">+          aCallback();</span>
<a href="#l4.655"></a><span id="l4.655" class="difflineplus">+          return;</span>
<a href="#l4.656"></a><span id="l4.656" class="difflineplus">+        }</span>
<a href="#l4.657"></a><span id="l4.657" class="difflineplus">+</span>
<a href="#l4.658"></a><span id="l4.658" class="difflineplus">+        listNode.setAttribute(&quot;state&quot;, &quot;some&quot;);</span>
<a href="#l4.659"></a><span id="l4.659" class="difflineplus">+        $(listNode)</span>
<a href="#l4.660"></a><span id="l4.660" class="difflineplus">+          .hide()</span>
<a href="#l4.661"></a><span id="l4.661" class="difflineplus">+          .slideDown(&quot;fast&quot;, aCallback);</span>
<a href="#l4.662"></a><span id="l4.662" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.663"></a><span id="l4.663" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.664"></a><span id="l4.664" class="difflineplus">+    &lt;method name=&quot;barClicked&quot;&gt;</span>
<a href="#l4.665"></a><span id="l4.665" class="difflineplus">+      &lt;parameter name=&quot;aBarNode&quot; /&gt;</span>
<a href="#l4.666"></a><span id="l4.666" class="difflineplus">+      &lt;parameter name=&quot;aInclude&quot; /&gt;</span>
<a href="#l4.667"></a><span id="l4.667" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.668"></a><span id="l4.668" class="difflineplus">+        let groupValue = aBarNode.groupValue;</span>
<a href="#l4.669"></a><span id="l4.669" class="difflineplus">+        let groupItems = aBarNode.groupItems;</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineplus">+</span>
<a href="#l4.671"></a><span id="l4.671" class="difflineplus">+        // The 'other' object has special interaction semantics given that it is</span>
<a href="#l4.672"></a><span id="l4.672" class="difflineplus">+        //  in fact an aggregation of a bunch of other groups.</span>
<a href="#l4.673"></a><span id="l4.673" class="difflineplus">+        // Clicking on it inclusively results in excluding all of the displayed</span>
<a href="#l4.674"></a><span id="l4.674" class="difflineplus">+        //  top groups.  This allows us to keep displaying the facet while also</span>
<a href="#l4.675"></a><span id="l4.675" class="difflineplus">+        //  having stable behavior if the user starts excluding single groups.</span>
<a href="#l4.676"></a><span id="l4.676" class="difflineplus">+        //  (Our rule is that we only have one active constraint per attribute</span>
<a href="#l4.677"></a><span id="l4.677" class="difflineplus">+        //  at a time, so if we treated the other inclusion as an inclusion, the</span>
<a href="#l4.678"></a><span id="l4.678" class="difflineplus">+        //  subsequent exclude would knock the inclusion off the chart.</span>
<a href="#l4.679"></a><span id="l4.679" class="difflineplus">+        // Clicking on it exclusively results in excluding all of the groups in</span>
<a href="#l4.680"></a><span id="l4.680" class="difflineplus">+        //  the 'other' group.  We do this for the same rationale as in the</span>
<a href="#l4.681"></a><span id="l4.681" class="difflineplus">+        //  inclusion case; we need subsequent excludes to not do weird things</span>
<a href="#l4.682"></a><span id="l4.682" class="difflineplus">+        //  (or complicate the implementation).</span>
<a href="#l4.683"></a><span id="l4.683" class="difflineplus">+        // (If we start allowing multiple inclusion, we will keep these</span>
<a href="#l4.684"></a><span id="l4.684" class="difflineplus">+        //  semantics; we will simply remove things from the inclusion set when</span>
<a href="#l4.685"></a><span id="l4.685" class="difflineplus">+        //  excluded.  Easy peasy.)</span>
<a href="#l4.686"></a><span id="l4.686" class="difflineplus">+        if (groupValue == this.otherGroupObject) {</span>
<a href="#l4.687"></a><span id="l4.687" class="difflineplus">+          if (aInclude) {</span>
<a href="#l4.688"></a><span id="l4.688" class="difflineplus">+            // build up the list of non-other group values.  since other is</span>
<a href="#l4.689"></a><span id="l4.689" class="difflineplus">+            //  always last, this is not so hard.</span>
<a href="#l4.690"></a><span id="l4.690" class="difflineplus">+            let groupValues = [];</span>
<a href="#l4.691"></a><span id="l4.691" class="difflineplus">+            for (let iGroup = 0; iGroup &lt; this.topGroups.length - 1; iGroup++) {</span>
<a href="#l4.692"></a><span id="l4.692" class="difflineplus">+              groupValues.push(this.topGroups[iGroup][0]);</span>
<a href="#l4.693"></a><span id="l4.693" class="difflineplus">+            }</span>
<a href="#l4.694"></a><span id="l4.694" class="difflineplus">+</span>
<a href="#l4.695"></a><span id="l4.695" class="difflineplus">+            FacetContext.addFacetConstraint(this.faceter, this.attrDef, false,</span>
<a href="#l4.696"></a><span id="l4.696" class="difflineplus">+                                            groupValues);</span>
<a href="#l4.697"></a><span id="l4.697" class="difflineplus">+            return;</span>
<a href="#l4.698"></a><span id="l4.698" class="difflineplus">+          }</span>
<a href="#l4.699"></a><span id="l4.699" class="difflineplus">+          // exclusive case, exclude all the values in the group... we already</span>
<a href="#l4.700"></a><span id="l4.700" class="difflineplus">+          //  know who they are, though from the sentinel object.</span>
<a href="#l4.701"></a><span id="l4.701" class="difflineplus">+          FacetContext.addFacetConstraint(this.faceter, this.attrDef, false,</span>
<a href="#l4.702"></a><span id="l4.702" class="difflineplus">+                                          this.otherGroupObject.groupValues);</span>
<a href="#l4.703"></a><span id="l4.703" class="difflineplus">+          return;</span>
<a href="#l4.704"></a><span id="l4.704" class="difflineplus">+        }</span>
<a href="#l4.705"></a><span id="l4.705" class="difflineplus">+</span>
<a href="#l4.706"></a><span id="l4.706" class="difflineplus">+        // When clicking on something we want to animate it flying up into the</span>
<a href="#l4.707"></a><span id="l4.707" class="difflineplus">+        //  appropriate list (included/excluded).  This depends on the list</span>
<a href="#l4.708"></a><span id="l4.708" class="difflineplus">+        //  being visible, which may also need animation.</span>
<a href="#l4.709"></a><span id="l4.709" class="difflineplus">+        let dis = this;</span>
<a href="#l4.710"></a><span id="l4.710" class="difflineplus">+        this.afterListVisible(aInclude, function() {</span>
<a href="#l4.711"></a><span id="l4.711" class="difflineplus">+          // figure out our origin location prior to adding the target or it</span>
<a href="#l4.712"></a><span id="l4.712" class="difflineplus">+          //  will shift us down.</span>
<a href="#l4.713"></a><span id="l4.713" class="difflineplus">+          let $barNode = $(aBarNode);</span>
<a href="#l4.714"></a><span id="l4.714" class="difflineplus">+          let origin = $barNode.offset();</span>
<a href="#l4.715"></a><span id="l4.715" class="difflineplus">+</span>
<a href="#l4.716"></a><span id="l4.716" class="difflineplus">+          // clone the node into its target location</span>
<a href="#l4.717"></a><span id="l4.717" class="difflineplus">+          let targetNode = aBarNode.cloneNode(true);</span>
<a href="#l4.718"></a><span id="l4.718" class="difflineplus">+          targetNode.groupValue = groupValue;</span>
<a href="#l4.719"></a><span id="l4.719" class="difflineplus">+          targetNode.groupItems = groupItems;</span>
<a href="#l4.720"></a><span id="l4.720" class="difflineplus">+          targetNode.setAttribute(aInclude ? &quot;included&quot; : &quot;excluded&quot;, &quot;true&quot;);</span>
<a href="#l4.721"></a><span id="l4.721" class="difflineplus">+          targetNode.removeAttribute(aInclude ? &quot;excluded&quot; : &quot;included&quot;)</span>
<a href="#l4.722"></a><span id="l4.722" class="difflineplus">+</span>
<a href="#l4.723"></a><span id="l4.723" class="difflineplus">+          let targetParent = aInclude ? dis.inclList : dis.exclList;</span>
<a href="#l4.724"></a><span id="l4.724" class="difflineplus">+          targetParent.appendChild(targetNode);</span>
<a href="#l4.725"></a><span id="l4.725" class="difflineplus">+</span>
<a href="#l4.726"></a><span id="l4.726" class="difflineplus">+          // create a flying clone</span>
<a href="#l4.727"></a><span id="l4.727" class="difflineplus">+          let flyingNode = aBarNode.cloneNode(true);</span>
<a href="#l4.728"></a><span id="l4.728" class="difflineplus">+</span>
<a href="#l4.729"></a><span id="l4.729" class="difflineplus">+          // animate the flying clone... flying!</span>
<a href="#l4.730"></a><span id="l4.730" class="difflineplus">+          let $targetNode = $(targetNode);</span>
<a href="#l4.731"></a><span id="l4.731" class="difflineplus">+          let dest = $targetNode.offset();</span>
<a href="#l4.732"></a><span id="l4.732" class="difflineplus">+</span>
<a href="#l4.733"></a><span id="l4.733" class="difflineplus">+          let $flyingNode = $(flyingNode)</span>
<a href="#l4.734"></a><span id="l4.734" class="difflineplus">+            .appendTo(&quot;body&quot;)</span>
<a href="#l4.735"></a><span id="l4.735" class="difflineplus">+            .css(&quot;position&quot;, &quot;absolute&quot;)</span>
<a href="#l4.736"></a><span id="l4.736" class="difflineplus">+            .css(&quot;width&quot;, $barNode.width())</span>
<a href="#l4.737"></a><span id="l4.737" class="difflineplus">+            .css(&quot;height&quot;, $barNode.height())</span>
<a href="#l4.738"></a><span id="l4.738" class="difflineplus">+            .css(&quot;top&quot;, origin.top)</span>
<a href="#l4.739"></a><span id="l4.739" class="difflineplus">+            .css(&quot;left&quot;, origin.left)</span>
<a href="#l4.740"></a><span id="l4.740" class="difflineplus">+            .css(&quot;zIndex&quot;, 1000)</span>
<a href="#l4.741"></a><span id="l4.741" class="difflineplus">+            .animate({</span>
<a href="#l4.742"></a><span id="l4.742" class="difflineplus">+                top: dest.top,</span>
<a href="#l4.743"></a><span id="l4.743" class="difflineplus">+                left: dest.left</span>
<a href="#l4.744"></a><span id="l4.744" class="difflineplus">+              },</span>
<a href="#l4.745"></a><span id="l4.745" class="difflineplus">+              // have a velocity of 1 pixel every 4ms</span>
<a href="#l4.746"></a><span id="l4.746" class="difflineplus">+              Math.abs(dest.top - origin.top) * 6, function() {</span>
<a href="#l4.747"></a><span id="l4.747" class="difflineplus">+                $barNode.remove();</span>
<a href="#l4.748"></a><span id="l4.748" class="difflineplus">+                $targetNode.show();</span>
<a href="#l4.749"></a><span id="l4.749" class="difflineplus">+                $flyingNode.remove();</span>
<a href="#l4.750"></a><span id="l4.750" class="difflineplus">+</span>
<a href="#l4.751"></a><span id="l4.751" class="difflineplus">+                setTimeout(function() {</span>
<a href="#l4.752"></a><span id="l4.752" class="difflineplus">+                    FacetContext.addFacetConstraint(dis.faceter, dis.attrDef,</span>
<a href="#l4.753"></a><span id="l4.753" class="difflineplus">+                                                    aInclude, [groupValue]);</span>
<a href="#l4.754"></a><span id="l4.754" class="difflineplus">+                  }, 50);</span>
<a href="#l4.755"></a><span id="l4.755" class="difflineplus">+              });</span>
<a href="#l4.756"></a><span id="l4.756" class="difflineplus">+</span>
<a href="#l4.757"></a><span id="l4.757" class="difflineplus">+          // hide the target (cloned) node</span>
<a href="#l4.758"></a><span id="l4.758" class="difflineplus">+          $(targetNode).hide();</span>
<a href="#l4.759"></a><span id="l4.759" class="difflineplus">+</span>
<a href="#l4.760"></a><span id="l4.760" class="difflineplus">+          // hide the original node and remove its JS properties</span>
<a href="#l4.761"></a><span id="l4.761" class="difflineplus">+          $(aBarNode).css(&quot;visibility&quot;, &quot;hidden&quot;);</span>
<a href="#l4.762"></a><span id="l4.762" class="difflineplus">+          delete aBarNode.groupValue;</span>
<a href="#l4.763"></a><span id="l4.763" class="difflineplus">+          delete aBarNode.groupItems;</span>
<a href="#l4.764"></a><span id="l4.764" class="difflineplus">+        });</span>
<a href="#l4.765"></a><span id="l4.765" class="difflineplus">+</span>
<a href="#l4.766"></a><span id="l4.766" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.767"></a><span id="l4.767" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.768"></a><span id="l4.768" class="difflineplus">+    &lt;method name=&quot;barHovered&quot;&gt;</span>
<a href="#l4.769"></a><span id="l4.769" class="difflineplus">+      &lt;parameter name=&quot;aBarNode&quot; /&gt;</span>
<a href="#l4.770"></a><span id="l4.770" class="difflineplus">+      &lt;parameter name=&quot;aInclude&quot; /&gt;</span>
<a href="#l4.771"></a><span id="l4.771" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.772"></a><span id="l4.772" class="difflineplus">+        let groupValue = aBarNode.groupValue;</span>
<a href="#l4.773"></a><span id="l4.773" class="difflineplus">+        let groupItems = aBarNode.groupItems;</span>
<a href="#l4.774"></a><span id="l4.774" class="difflineplus">+</span>
<a href="#l4.775"></a><span id="l4.775" class="difflineplus">+        FacetContext.hoverFacet(this.faceter, this.attrDef, groupValue, groupItems);</span>
<a href="#l4.776"></a><span id="l4.776" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.777"></a><span id="l4.777" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.778"></a><span id="l4.778" class="difflineplus">+    &lt;!-- HoverGone! HoverGone!</span>
<a href="#l4.779"></a><span id="l4.779" class="difflineplus">+         We know it's gone, but where has it gone? --&gt;</span>
<a href="#l4.780"></a><span id="l4.780" class="difflineplus">+    &lt;method name=&quot;barHoverGone&quot;&gt;</span>
<a href="#l4.781"></a><span id="l4.781" class="difflineplus">+      &lt;parameter name=&quot;aBarNode&quot; /&gt;</span>
<a href="#l4.782"></a><span id="l4.782" class="difflineplus">+      &lt;parameter name=&quot;aInclude&quot; /&gt;</span>
<a href="#l4.783"></a><span id="l4.783" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.784"></a><span id="l4.784" class="difflineplus">+        let groupValue = aBarNode.groupValue;</span>
<a href="#l4.785"></a><span id="l4.785" class="difflineplus">+        let groupItems = aBarNode.groupItems;</span>
<a href="#l4.786"></a><span id="l4.786" class="difflineplus">+</span>
<a href="#l4.787"></a><span id="l4.787" class="difflineplus">+        FacetContext.unhoverFacet(this.faceter, this.attrDef, groupValue, groupItems);</span>
<a href="#l4.788"></a><span id="l4.788" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.789"></a><span id="l4.789" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.790"></a><span id="l4.790" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l4.791"></a><span id="l4.791" class="difflineplus">+  &lt;handlers&gt;</span>
<a href="#l4.792"></a><span id="l4.792" class="difflineplus">+    &lt;handler event=&quot;click&quot;&gt;&lt;![CDATA[</span>
<a href="#l4.793"></a><span id="l4.793" class="difflineplus">+      // we dispatch based on the class of the thing we clicked on.</span>
<a href="#l4.794"></a><span id="l4.794" class="difflineplus">+      // there are other ways we could accomplish this, but they all sorta suck.</span>
<a href="#l4.795"></a><span id="l4.795" class="difflineplus">+      let nodeClasses = event.originalTarget.getAttribute(&quot;class&quot;);</span>
<a href="#l4.796"></a><span id="l4.796" class="difflineplus">+      if (!nodeClasses)</span>
<a href="#l4.797"></a><span id="l4.797" class="difflineplus">+        return;</span>
<a href="#l4.798"></a><span id="l4.798" class="difflineplus">+</span>
<a href="#l4.799"></a><span id="l4.799" class="difflineplus">+      let nodeClass = nodeClasses.split(&quot; &quot;)[0];</span>
<a href="#l4.800"></a><span id="l4.800" class="difflineplus">+      if (nodeClass == &quot;bar-exclude&quot;)</span>
<a href="#l4.801"></a><span id="l4.801" class="difflineplus">+        this.barClicked(event.originalTarget.parentNode, false);</span>
<a href="#l4.802"></a><span id="l4.802" class="difflineplus">+      else if (nodeClass == &quot;bar-link&quot;)</span>
<a href="#l4.803"></a><span id="l4.803" class="difflineplus">+        this.barClicked(event.originalTarget.parentNode, true);</span>
<a href="#l4.804"></a><span id="l4.804" class="difflineplus">+    ]]&gt;&lt;/handler&gt;</span>
<a href="#l4.805"></a><span id="l4.805" class="difflineplus">+    &lt;handler event=&quot;mouseover&quot;&gt;&lt;![CDATA[</span>
<a href="#l4.806"></a><span id="l4.806" class="difflineplus">+      // we dispatch based on the class of the thing we clicked on.</span>
<a href="#l4.807"></a><span id="l4.807" class="difflineplus">+      // there are other ways we could accomplish this, but they all sorta suck.</span>
<a href="#l4.808"></a><span id="l4.808" class="difflineplus">+      let nodeClasses = event.originalTarget.getAttribute(&quot;class&quot;);</span>
<a href="#l4.809"></a><span id="l4.809" class="difflineplus">+      if (!nodeClasses)</span>
<a href="#l4.810"></a><span id="l4.810" class="difflineplus">+        return;</span>
<a href="#l4.811"></a><span id="l4.811" class="difflineplus">+</span>
<a href="#l4.812"></a><span id="l4.812" class="difflineplus">+      let nodeClass = nodeClasses.split(&quot; &quot;)[0];</span>
<a href="#l4.813"></a><span id="l4.813" class="difflineplus">+      if (nodeClass == &quot;bar-link&quot;)</span>
<a href="#l4.814"></a><span id="l4.814" class="difflineplus">+        this.barHovered(event.originalTarget.parentNode, true);</span>
<a href="#l4.815"></a><span id="l4.815" class="difflineplus">+    ]]&gt;&lt;/handler&gt;</span>
<a href="#l4.816"></a><span id="l4.816" class="difflineplus">+    &lt;handler event=&quot;mouseout&quot;&gt;&lt;![CDATA[</span>
<a href="#l4.817"></a><span id="l4.817" class="difflineplus">+      // we dispatch based on the class of the thing we clicked on.</span>
<a href="#l4.818"></a><span id="l4.818" class="difflineplus">+      // there are other ways we could accomplish this, but they all sorta suck.</span>
<a href="#l4.819"></a><span id="l4.819" class="difflineplus">+      let nodeClasses = event.originalTarget.getAttribute(&quot;class&quot;);</span>
<a href="#l4.820"></a><span id="l4.820" class="difflineplus">+      if (!nodeClasses)</span>
<a href="#l4.821"></a><span id="l4.821" class="difflineplus">+        return;</span>
<a href="#l4.822"></a><span id="l4.822" class="difflineplus">+</span>
<a href="#l4.823"></a><span id="l4.823" class="difflineplus">+      let nodeClass = nodeClasses.split(&quot; &quot;)[0];</span>
<a href="#l4.824"></a><span id="l4.824" class="difflineplus">+      if (nodeClass == &quot;bar-link&quot;)</span>
<a href="#l4.825"></a><span id="l4.825" class="difflineplus">+        this.barHoverGone(event.originalTarget.parentNode, true);</span>
<a href="#l4.826"></a><span id="l4.826" class="difflineplus">+    ]]&gt;&lt;/handler&gt;</span>
<a href="#l4.827"></a><span id="l4.827" class="difflineplus">+  &lt;/handlers&gt;</span>
<a href="#l4.828"></a><span id="l4.828" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l4.829"></a><span id="l4.829" class="difflineplus">+</span>
<a href="#l4.830"></a><span id="l4.830" class="difflineplus">+&lt;binding id=&quot;facet-date&quot;&gt;</span>
<a href="#l4.831"></a><span id="l4.831" class="difflineplus">+  &lt;content&gt;</span>
<a href="#l4.832"></a><span id="l4.832" class="difflineplus">+    &lt;html:div class=&quot;facet&quot;&gt;</span>
<a href="#l4.833"></a><span id="l4.833" class="difflineplus">+      &lt;html:h2 anonid=&quot;name&quot;&gt;&lt;/html:h2&gt;</span>
<a href="#l4.834"></a><span id="l4.834" class="difflineplus">+      &lt;!-- we need to do this because of something protovis is doing where</span>
<a href="#l4.835"></a><span id="l4.835" class="difflineplus">+           it attempts to re-interpret the text and the html namespace no</span>
<a href="#l4.836"></a><span id="l4.836" class="difflineplus">+           longer exists in that context. --&gt;</span>
<a href="#l4.837"></a><span id="l4.837" class="difflineplus">+      &lt;html:div anonid=&quot;canvas&quot; class=&quot;date-vis-frame&quot;&gt;&lt;/html:div&gt;</span>
<a href="#l4.838"></a><span id="l4.838" class="difflineplus">+    &lt;/html:div&gt;</span>
<a href="#l4.839"></a><span id="l4.839" class="difflineplus">+  &lt;/content&gt;</span>
<a href="#l4.840"></a><span id="l4.840" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l4.841"></a><span id="l4.841" class="difflineplus">+    &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l4.842"></a><span id="l4.842" class="difflineplus">+      this.canvasNode = document.getAnonymousElementByAttribute(</span>
<a href="#l4.843"></a><span id="l4.843" class="difflineplus">+                                   this, &quot;anonid&quot;, &quot;canvas&quot;);</span>
<a href="#l4.844"></a><span id="l4.844" class="difflineplus">+      this.vis = null;</span>
<a href="#l4.845"></a><span id="l4.845" class="difflineplus">+      if (&quot;faceter&quot; in this)</span>
<a href="#l4.846"></a><span id="l4.846" class="difflineplus">+        this.build(true);</span>
<a href="#l4.847"></a><span id="l4.847" class="difflineplus">+    ]]&gt;&lt;/constructor&gt;</span>
<a href="#l4.848"></a><span id="l4.848" class="difflineplus">+    &lt;field name=&quot;canUpdate&quot; readonly=&quot;true&quot;&gt;true&lt;/field&gt;</span>
<a href="#l4.849"></a><span id="l4.849" class="difflineplus">+    &lt;method name=&quot;build&quot;&gt;</span>
<a href="#l4.850"></a><span id="l4.850" class="difflineplus">+      &lt;parameter name=&quot;aFirstTime&quot; /&gt;</span>
<a href="#l4.851"></a><span id="l4.851" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.852"></a><span id="l4.852" class="difflineplus">+        if (!this.vis) {</span>
<a href="#l4.853"></a><span id="l4.853" class="difflineplus">+          this.vis = new DateFacetVis(this, this.canvasNode);</span>
<a href="#l4.854"></a><span id="l4.854" class="difflineplus">+          this.vis.build();</span>
<a href="#l4.855"></a><span id="l4.855" class="difflineplus">+        }</span>
<a href="#l4.856"></a><span id="l4.856" class="difflineplus">+        else {</span>
<a href="#l4.857"></a><span id="l4.857" class="difflineplus">+          while (this.canvasNode.lastChild)</span>
<a href="#l4.858"></a><span id="l4.858" class="difflineplus">+            this.canvasNode.removeChild(this.canvasNode.lastChild);</span>
<a href="#l4.859"></a><span id="l4.859" class="difflineplus">+          this.vis.rebuild();</span>
<a href="#l4.860"></a><span id="l4.860" class="difflineplus">+        }</span>
<a href="#l4.861"></a><span id="l4.861" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.862"></a><span id="l4.862" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.863"></a><span id="l4.863" class="difflineplus">+    &lt;method name=&quot;brushItems&quot;&gt;</span>
<a href="#l4.864"></a><span id="l4.864" class="difflineplus">+      &lt;parameter name=&quot;aItems&quot; /&gt;</span>
<a href="#l4.865"></a><span id="l4.865" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.866"></a><span id="l4.866" class="difflineplus">+        this.vis.hoverItems(aItems);</span>
<a href="#l4.867"></a><span id="l4.867" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.868"></a><span id="l4.868" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.869"></a><span id="l4.869" class="difflineplus">+    &lt;method name=&quot;clearBrushedItems&quot;&gt;</span>
<a href="#l4.870"></a><span id="l4.870" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.871"></a><span id="l4.871" class="difflineplus">+        this.vis.clearHover();</span>
<a href="#l4.872"></a><span id="l4.872" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.873"></a><span id="l4.873" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.874"></a><span id="l4.874" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l4.875"></a><span id="l4.875" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l4.876"></a><span id="l4.876" class="difflineplus">+</span>
<a href="#l4.877"></a><span id="l4.877" class="difflineplus">+&lt;!-- ===== Results ===== --&gt;</span>
<a href="#l4.878"></a><span id="l4.878" class="difflineplus">+</span>
<a href="#l4.879"></a><span id="l4.879" class="difflineplus">+&lt;binding id=&quot;results-message&quot;&gt;</span>
<a href="#l4.880"></a><span id="l4.880" class="difflineplus">+  &lt;content&gt;</span>
<a href="#l4.881"></a><span id="l4.881" class="difflineplus">+    &lt;html:div class=&quot;results-message-header&quot;&gt;</span>
<a href="#l4.882"></a><span id="l4.882" class="difflineplus">+      &lt;html:h2 class=&quot;results-message-count&quot; anonid=&quot;count&quot;&gt;&lt;/html:h2&gt;</span>
<a href="#l4.883"></a><span id="l4.883" class="difflineplus">+      &lt;html:span class=&quot;results-message-showall&quot; anonid=&quot;showall&quot;</span>
<a href="#l4.884"></a><span id="l4.884" class="difflineplus">+            onclick=&quot;FacetContext.showActiveSetInTab()&quot;&gt;&lt;/html:span&gt;</span>
<a href="#l4.885"></a><span id="l4.885" class="difflineplus">+    &lt;/html:div&gt;</span>
<a href="#l4.886"></a><span id="l4.886" class="difflineplus">+    &lt;html:div class=&quot;messages&quot; anonid=&quot;messages&quot;&gt;</span>
<a href="#l4.887"></a><span id="l4.887" class="difflineplus">+    &lt;/html:div&gt;</span>
<a href="#l4.888"></a><span id="l4.888" class="difflineplus">+  &lt;/content&gt;</span>
<a href="#l4.889"></a><span id="l4.889" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l4.890"></a><span id="l4.890" class="difflineplus">+    &lt;method name=&quot;setMessages&quot;&gt;</span>
<a href="#l4.891"></a><span id="l4.891" class="difflineplus">+      &lt;parameter name=&quot;aMessages&quot; /&gt;</span>
<a href="#l4.892"></a><span id="l4.892" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.893"></a><span id="l4.893" class="difflineplus">+        // -- Count</span>
<a href="#l4.894"></a><span id="l4.894" class="difflineplus">+        let countNode = document.getAnonymousElementByAttribute(</span>
<a href="#l4.895"></a><span id="l4.895" class="difflineplus">+                          this, &quot;anonid&quot;, &quot;count&quot;);</span>
<a href="#l4.896"></a><span id="l4.896" class="difflineplus">+        let messagesPlural = glodaFacetStrings.get(</span>
<a href="#l4.897"></a><span id="l4.897" class="difflineplus">+          &quot;glodaFacetView.results.message.countLabelMessagePlurals&quot;);</span>
<a href="#l4.898"></a><span id="l4.898" class="difflineplus">+        let countLabel = glodaFacetStrings.get(</span>
<a href="#l4.899"></a><span id="l4.899" class="difflineplus">+          &quot;glodaFacetView.results.message.countLabel&quot;);</span>
<a href="#l4.900"></a><span id="l4.900" class="difflineplus">+        // display set</span>
<a href="#l4.901"></a><span id="l4.901" class="difflineplus">+        countLabel = countLabel.replace(&quot;#1&quot;,</span>
<a href="#l4.902"></a><span id="l4.902" class="difflineplus">+          aMessages.length.toLocaleString());</span>
<a href="#l4.903"></a><span id="l4.903" class="difflineplus">+        countLabel = countLabel.replace(&quot;#2&quot;,</span>
<a href="#l4.904"></a><span id="l4.904" class="difflineplus">+          PluralForm.get(aMessages.length, messagesPlural));</span>
<a href="#l4.905"></a><span id="l4.905" class="difflineplus">+        // active set</span>
<a href="#l4.906"></a><span id="l4.906" class="difflineplus">+        countLabel = countLabel.replace(&quot;#3&quot;,</span>
<a href="#l4.907"></a><span id="l4.907" class="difflineplus">+          FacetContext.activeSet.length.toLocaleString());</span>
<a href="#l4.908"></a><span id="l4.908" class="difflineplus">+        countLabel = countLabel.replace(&quot;#4&quot;,</span>
<a href="#l4.909"></a><span id="l4.909" class="difflineplus">+          PluralForm.get(FacetContext.activeSet.length, messagesPlural));</span>
<a href="#l4.910"></a><span id="l4.910" class="difflineplus">+        countNode.textContent = countLabel;</span>
<a href="#l4.911"></a><span id="l4.911" class="difflineplus">+</span>
<a href="#l4.912"></a><span id="l4.912" class="difflineplus">+        // -- Show All</span>
<a href="#l4.913"></a><span id="l4.913" class="difflineplus">+        let showNode = document.getAnonymousElementByAttribute(</span>
<a href="#l4.914"></a><span id="l4.914" class="difflineplus">+                          this, &quot;anonid&quot;, &quot;showall&quot;);</span>
<a href="#l4.915"></a><span id="l4.915" class="difflineplus">+        showNode.textContent = glodaFacetStrings.get(</span>
<a href="#l4.916"></a><span id="l4.916" class="difflineplus">+          &quot;glodaFacetView.results.message.showAllInList.label&quot;);</span>
<a href="#l4.917"></a><span id="l4.917" class="difflineplus">+        showNode.setAttribute(&quot;title&quot;,</span>
<a href="#l4.918"></a><span id="l4.918" class="difflineplus">+          glodaFacetStrings.get(</span>
<a href="#l4.919"></a><span id="l4.919" class="difflineplus">+            &quot;glodaFacetView.results.message.showAllInList.tooltip&quot;));</span>
<a href="#l4.920"></a><span id="l4.920" class="difflineplus">+</span>
<a href="#l4.921"></a><span id="l4.921" class="difflineplus">+        let messagesNode = document.getAnonymousElementByAttribute(</span>
<a href="#l4.922"></a><span id="l4.922" class="difflineplus">+                             this, &quot;anonid&quot;, &quot;messages&quot;);</span>
<a href="#l4.923"></a><span id="l4.923" class="difflineplus">+        while (messagesNode.lastChild)</span>
<a href="#l4.924"></a><span id="l4.924" class="difflineplus">+          messagesNode.removeChild(messagesNode.lastChild);</span>
<a href="#l4.925"></a><span id="l4.925" class="difflineplus">+</span>
<a href="#l4.926"></a><span id="l4.926" class="difflineplus">+        // -- Messages</span>
<a href="#l4.927"></a><span id="l4.927" class="difflineplus">+        for each (let [, message] in Iterator(aMessages)) {</span>
<a href="#l4.928"></a><span id="l4.928" class="difflineplus">+          let msgNode = document.createElement(&quot;message&quot;);</span>
<a href="#l4.929"></a><span id="l4.929" class="difflineplus">+          msgNode.message = message;</span>
<a href="#l4.930"></a><span id="l4.930" class="difflineplus">+          msgNode.setAttribute(&quot;class&quot;, &quot;message&quot;);</span>
<a href="#l4.931"></a><span id="l4.931" class="difflineplus">+          messagesNode.appendChild(msgNode);</span>
<a href="#l4.932"></a><span id="l4.932" class="difflineplus">+        }</span>
<a href="#l4.933"></a><span id="l4.933" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.934"></a><span id="l4.934" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.935"></a><span id="l4.935" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l4.936"></a><span id="l4.936" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l4.937"></a><span id="l4.937" class="difflineplus">+</span>
<a href="#l4.938"></a><span id="l4.938" class="difflineplus">+&lt;binding id=&quot;result-message&quot;&gt;</span>
<a href="#l4.939"></a><span id="l4.939" class="difflineplus">+  &lt;content&gt;</span>
<a href="#l4.940"></a><span id="l4.940" class="difflineplus">+    &lt;html:div class=&quot;message-header&quot;&gt;</span>
<a href="#l4.941"></a><span id="l4.941" class="difflineplus">+      &lt;html:div class=&quot;message-meta&quot;&gt;</span>
<a href="#l4.942"></a><span id="l4.942" class="difflineplus">+        &lt;html:div anonid=&quot;oldestMessageDate&quot; class=&quot;message-oldestMessageDate&quot;&gt;&lt;/html:div&gt;</span>
<a href="#l4.943"></a><span id="l4.943" class="difflineplus">+        &lt;html:div anonid=&quot;attachments&quot; class=&quot;message-attachments&quot;&gt;&lt;/html:div&gt;</span>
<a href="#l4.944"></a><span id="l4.944" class="difflineplus">+      &lt;/html:div&gt;</span>
<a href="#l4.945"></a><span id="l4.945" class="difflineplus">+      &lt;html:div anonid=&quot;subject&quot; class=&quot;message-subject&quot;&gt;&lt;/html:div&gt;</span>
<a href="#l4.946"></a><span id="l4.946" class="difflineplus">+      &lt;html:div class=&quot;message-addressing&quot;&gt;</span>
<a href="#l4.947"></a><span id="l4.947" class="difflineplus">+        &lt;html:span anonid=&quot;author&quot; class=&quot;message-author&quot;&gt;&lt;/html:span&gt;</span>
<a href="#l4.948"></a><span id="l4.948" class="difflineplus">+        &lt;html:span anonid=&quot;writes&quot; class=&quot;message-writes&quot;&gt;&lt;/html:span&gt;</span>
<a href="#l4.949"></a><span id="l4.949" class="difflineplus">+        &lt;html:div anonid=&quot;recipients&quot; class=&quot;message-recipients&quot;/&gt;</span>
<a href="#l4.950"></a><span id="l4.950" class="difflineplus">+        &lt;html:span anonid=&quot;date&quot; class=&quot;message-date&quot;&gt;&lt;/html:span&gt;</span>
<a href="#l4.951"></a><span id="l4.951" class="difflineplus">+      &lt;/html:div&gt;</span>
<a href="#l4.952"></a><span id="l4.952" class="difflineplus">+      &lt;html:div anonid=&quot;tags&quot; class=&quot;message-tags&quot;&gt;&lt;/html:div&gt;</span>
<a href="#l4.953"></a><span id="l4.953" class="difflineplus">+    &lt;/html:div&gt;</span>
<a href="#l4.954"></a><span id="l4.954" class="difflineplus">+    &lt;html:pre anonid=&quot;snippet&quot; class=&quot;message-body&quot;&gt;&lt;/html:pre&gt;</span>
<a href="#l4.955"></a><span id="l4.955" class="difflineplus">+  &lt;/content&gt;</span>
<a href="#l4.956"></a><span id="l4.956" class="difflineplus">+  &lt;implementation&gt;</span>
<a href="#l4.957"></a><span id="l4.957" class="difflineplus">+    &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l4.958"></a><span id="l4.958" class="difflineplus">+      this.build();</span>
<a href="#l4.959"></a><span id="l4.959" class="difflineplus">+    ]]&gt;&lt;/constructor&gt;</span>
<a href="#l4.960"></a><span id="l4.960" class="difflineplus">+    &lt;method name=&quot;build&quot;&gt;</span>
<a href="#l4.961"></a><span id="l4.961" class="difflineplus">+      &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.962"></a><span id="l4.962" class="difflineplus">+        let message = this.message;</span>
<a href="#l4.963"></a><span id="l4.963" class="difflineplus">+        let dis = this;</span>
<a href="#l4.964"></a><span id="l4.964" class="difflineplus">+        function anonElem(aAnonId) {</span>
<a href="#l4.965"></a><span id="l4.965" class="difflineplus">+          return document.getAnonymousElementByAttribute(dis, &quot;anonid&quot;,</span>
<a href="#l4.966"></a><span id="l4.966" class="difflineplus">+                                                         aAnonId);</span>
<a href="#l4.967"></a><span id="l4.967" class="difflineplus">+        }</span>
<a href="#l4.968"></a><span id="l4.968" class="difflineplus">+</span>
<a href="#l4.969"></a><span id="l4.969" class="difflineplus">+        // -- eventify</span>
<a href="#l4.970"></a><span id="l4.970" class="difflineplus">+        this.onclick = function(aEvent) {</span>
<a href="#l4.971"></a><span id="l4.971" class="difflineplus">+          FacetContext.showConversationInTab(message,</span>
<a href="#l4.972"></a><span id="l4.972" class="difflineplus">+                                             aEvent.button == 1);</span>
<a href="#l4.973"></a><span id="l4.973" class="difflineplus">+        }</span>
<a href="#l4.974"></a><span id="l4.974" class="difflineplus">+</span>
<a href="#l4.975"></a><span id="l4.975" class="difflineplus">+        // -- l10n poking</span>
<a href="#l4.976"></a><span id="l4.976" class="difflineplus">+        anonElem(&quot;writes&quot;).textContent =</span>
<a href="#l4.977"></a><span id="l4.977" class="difflineplus">+          glodaFacetStrings.get(&quot;glodaFacetView.result.message.writesLabel&quot;);</span>
<a href="#l4.978"></a><span id="l4.978" class="difflineplus">+</span>
<a href="#l4.979"></a><span id="l4.979" class="difflineplus">+        // -- Content Poking</span>
<a href="#l4.980"></a><span id="l4.980" class="difflineplus">+        anonElem(&quot;subject&quot;).textContent = message.subject;</span>
<a href="#l4.981"></a><span id="l4.981" class="difflineplus">+        anonElem(&quot;author&quot;).textContent = message.from.toLocaleString();</span>
<a href="#l4.982"></a><span id="l4.982" class="difflineplus">+        anonElem(&quot;date&quot;).textContent = message.date.toLocaleString();</span>
<a href="#l4.983"></a><span id="l4.983" class="difflineplus">+</span>
<a href="#l4.984"></a><span id="l4.984" class="difflineplus">+        // - Recipients</span>
<a href="#l4.985"></a><span id="l4.985" class="difflineplus">+        let recipientsNode = anonElem(&quot;recipients&quot;);</span>
<a href="#l4.986"></a><span id="l4.986" class="difflineplus">+        if (message.recipients) {</span>
<a href="#l4.987"></a><span id="l4.987" class="difflineplus">+          for each (let [, recip] in Iterator(message.recipients)) {</span>
<a href="#l4.988"></a><span id="l4.988" class="difflineplus">+            let recipNode = document.createElement(&quot;span&quot;);</span>
<a href="#l4.989"></a><span id="l4.989" class="difflineplus">+            recipNode.setAttribute(&quot;class&quot;, &quot;message-recipient&quot;);</span>
<a href="#l4.990"></a><span id="l4.990" class="difflineplus">+            recipNode.textContent = recip.toLocaleString();</span>
<a href="#l4.991"></a><span id="l4.991" class="difflineplus">+            recipientsNode.appendChild(recipNode);</span>
<a href="#l4.992"></a><span id="l4.992" class="difflineplus">+          }</span>
<a href="#l4.993"></a><span id="l4.993" class="difflineplus">+        }</span>
<a href="#l4.994"></a><span id="l4.994" class="difflineplus">+        // - Tags</span>
<a href="#l4.995"></a><span id="l4.995" class="difflineplus">+        let tagsNode = anonElem(&quot;tags&quot;);</span>
<a href="#l4.996"></a><span id="l4.996" class="difflineplus">+        if (&quot;tags&quot; in message &amp;&amp; message.tags.length) {</span>
<a href="#l4.997"></a><span id="l4.997" class="difflineplus">+          let _msgTagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;].</span>
<a href="#l4.998"></a><span id="l4.998" class="difflineplus">+                                    getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l4.999"></a><span id="l4.999" class="difflineplus">+          for each (let [, tag] in Iterator(message.tags)) {</span>
<a href="#l4.1000"></a><span id="l4.1000" class="difflineplus">+            let tagNode = document.createElement(&quot;span&quot;);</span>
<a href="#l4.1001"></a><span id="l4.1001" class="difflineplus">+            let colorClass = &quot;blc-&quot; + _msgTagService.getColorForKey(tag.key).substr(1);</span>
<a href="#l4.1002"></a><span id="l4.1002" class="difflineplus">+            tagNode.setAttribute(&quot;class&quot;, &quot;message-tag tag &quot; + colorClass);</span>
<a href="#l4.1003"></a><span id="l4.1003" class="difflineplus">+            tagNode.textContent = tag.tag;</span>
<a href="#l4.1004"></a><span id="l4.1004" class="difflineplus">+            tagsNode.appendChild(tagNode);</span>
<a href="#l4.1005"></a><span id="l4.1005" class="difflineplus">+          }</span>
<a href="#l4.1006"></a><span id="l4.1006" class="difflineplus">+        }</span>
<a href="#l4.1007"></a><span id="l4.1007" class="difflineplus">+</span>
<a href="#l4.1008"></a><span id="l4.1008" class="difflineplus">+        // - Body</span>
<a href="#l4.1009"></a><span id="l4.1009" class="difflineplus">+        if (message.indexedBodyText) {</span>
<a href="#l4.1010"></a><span id="l4.1010" class="difflineplus">+          let bodyText = message.indexedBodyText;</span>
<a href="#l4.1011"></a><span id="l4.1011" class="difflineplus">+          // start assuming it's just one line that we want to show</span>
<a href="#l4.1012"></a><span id="l4.1012" class="difflineplus">+          let idxNewline = -1;</span>
<a href="#l4.1013"></a><span id="l4.1013" class="difflineplus">+          for (let newlineCount = 0; newlineCount &lt; 5; newlineCount++) {</span>
<a href="#l4.1014"></a><span id="l4.1014" class="difflineplus">+            let idxNextNewline = bodyText.indexOf(&quot;\n&quot;, idxNewline+1);</span>
<a href="#l4.1015"></a><span id="l4.1015" class="difflineplus">+            if (idxNextNewline == -1)</span>
<a href="#l4.1016"></a><span id="l4.1016" class="difflineplus">+              break;</span>
<a href="#l4.1017"></a><span id="l4.1017" class="difflineplus">+            idxNewline = idxNextNewline;</span>
<a href="#l4.1018"></a><span id="l4.1018" class="difflineplus">+          }</span>
<a href="#l4.1019"></a><span id="l4.1019" class="difflineplus">+          if (idxNewline &gt; -1)</span>
<a href="#l4.1020"></a><span id="l4.1020" class="difflineplus">+            anonElem(&quot;snippet&quot;).textContent = bodyText.substring(0, idxNewline);</span>
<a href="#l4.1021"></a><span id="l4.1021" class="difflineplus">+          else</span>
<a href="#l4.1022"></a><span id="l4.1022" class="difflineplus">+            anonElem(&quot;snippet&quot;).textContent = bodyText;</span>
<a href="#l4.1023"></a><span id="l4.1023" class="difflineplus">+        }</span>
<a href="#l4.1024"></a><span id="l4.1024" class="difflineplus">+</span>
<a href="#l4.1025"></a><span id="l4.1025" class="difflineplus">+        // - Misc attributes</span>
<a href="#l4.1026"></a><span id="l4.1026" class="difflineplus">+        if (!message.read)</span>
<a href="#l4.1027"></a><span id="l4.1027" class="difflineplus">+          this.setAttribute(&quot;unread&quot;, &quot;true&quot;);</span>
<a href="#l4.1028"></a><span id="l4.1028" class="difflineplus">+      ]]&gt;&lt;/body&gt;</span>
<a href="#l4.1029"></a><span id="l4.1029" class="difflineplus">+    &lt;/method&gt;</span>
<a href="#l4.1030"></a><span id="l4.1030" class="difflineplus">+  &lt;/implementation&gt;</span>
<a href="#l4.1031"></a><span id="l4.1031" class="difflineplus">+&lt;/binding&gt;</span>
<a href="#l4.1032"></a><span id="l4.1032" class="difflineplus">+</span>
<a href="#l4.1033"></a><span id="l4.1033" class="difflineplus">+&lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mail/base/content/glodaFacetTab.js</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,106 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/StringBundle.js&quot;);</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/gloda/facet.js&quot;);</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+// needed by search.xml to use us</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/gloda/msg_search.js&quot;);</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+var glodaFacetTabType = {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+  name: &quot;glodaFacet&quot;,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  perTabPanel: &quot;iframe&quot;,</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  strings:</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+    new StringBundle(&quot;chrome://messenger/locale/glodaFacetView.properties&quot;),</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+  modes: {</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+    glodaFacet: {</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+      // this is what get exposed on the tab for icon purposes</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+      type: &quot;glodaSearch&quot;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+    }</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+  },</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+  openTab: function glodaFacetTabType_openTab(aTab, aArgs) {</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+    // we have no browser until our XUL document loads</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+    aTab.browser = null;</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+    if (&quot;query&quot; in aArgs) {</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+      aTab.query = aArgs.query;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+      aTab.collection = aTab.query.getCollection();</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+      aTab.title = this.strings.get(&quot;glodaFacetView.tab.query.label&quot;);</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+      aTab.searchString = null;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+    }</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+    else if (&quot;searcher&quot; in aArgs) {</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+      aTab.searcher = aArgs.searcher;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+      aTab.collection = aTab.searcher.getCollection();</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+      aTab.query = aTab.searcher.query;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+      let searchString = aTab.searcher.searchString;</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+      aTab.title = aTab.glodaSearchInputValue = aTab.searchString =</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+        searchString;</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+    }</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+    else if (&quot;collection&quot; in aArgs) {</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+      aTab.collection = aArgs.collection;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+      aTab.title = this.strings.get(&quot;glodaFacetView.tab.query.label&quot;);</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+      aTab.searchString = null;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+    }</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+    function xulLoadHandler() {</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+      aTab.panel.contentWindow.removeEventListener(&quot;load&quot;, xulLoadHandler,</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+                                                   false);</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+      aTab.panel.contentWindow.tab = aTab;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+      aTab.browser = aTab.panel.contentDocument.getElementById(&quot;browser&quot;);</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+      aTab.browser.setAttribute(&quot;src&quot;,</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+        &quot;chrome://messenger/content/glodaFacetView.xhtml&quot;);</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+    }</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+    aTab.panel.contentWindow.addEventListener(&quot;load&quot;, xulLoadHandler, false);</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+    aTab.panel.setAttribute(&quot;src&quot;,</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+      &quot;chrome://messenger/content/glodaFacetViewWrapper.xul&quot;);</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+  },</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+  closeTab: function glodaFacetTabType_closeTab(aTab) {</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+  },</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+  saveTabState: function glodaFacetTabType_saveTabState(aTab) {</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+    // nothing to do; we are not multiplexed</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+  },</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+  showTab: function glodaFacetTabType_showTab(aTab) {</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+    // nothing to do; we are not multiplexed</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+  },</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+  getBrowser: function(aTab) {</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+    return aTab.browser;</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+  }</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+};</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+/**</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+ * The glodaSearch tab mode has a UI widget outside of the mailTabType's</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+ *  display panel, the #glodaSearchInput textbox.  This means we need to use a</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+ *  tab monitor so that we can appropriately update the contents of the textbox.</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+ * Every time a tab is changed, we save the state of the text box and restore</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+ *  its previous value for the tab we are switching to, as well as whether this</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+ *  value is a change to the currently-used value (if it is a glodaSearch) tab.</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+ *  The behaviour rationale for this is that the glodaSearchInput is like the</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+ *  URL bar.  When you are on a glodaSearch tab, we need to show you your</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+ *  current value, including any &quot;uncommitted&quot; (you haven't hit enter yet)</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+ *  changes.  It's not entirely clear that imitating this behaviour on</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+ *  non-glodaSearch tabs makes a lot of sense, but it is consistent, so we do</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+ *  so.  The counter-example to this choice is the search box in firefox, but</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+ *  it never updates when you switch tabs, so it is arguably less of a fit.</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+ */</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+var glodaFacetTabMonitor = {</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+  onTabTitleChanged: function() {},</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+  onTabSwitched: function glodaFacetTabMonitor_onTabSwitch(aTab, aOldTab) {</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+    let inputNode = document.getElementById(&quot;glodaSearchInput&quot;);</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+    if (!inputNode)</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+      return;</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+    // save the current search field value</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+    if (aOldTab)</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+      aOldTab.glodaSearchInputValue = inputNode.value;</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+    // load (or clear if there is none) the persisted search field value</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+    inputNode.value = aTab.glodaSearchInputValue || &quot;&quot;;</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+    // If the mode is glodaSearch and the search is unchanged, then we want to</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+    //  set the icon state of the input box to be the 'clear' icon.</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+    if (aTab.mode.name == &quot;glodaFacet&quot;) {</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+      if (aTab.searchString == aTab.glodaSearchInputValue)</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+        inputNode._searchIcons.selectedIndex = 1;</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+    }</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+  }</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mail/base/content/glodaFacetView.css</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,491 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ *</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+ *</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ * License.</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+ *</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+ * The Original Code is Thunderbird Global Database.</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+ *</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+ *</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+ *   David Ascher &lt;dascher@mozillamessaging.com&gt;</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+ *   Bryan Clark &lt;clarkbw@gnome.org&gt;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+ *</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+ *</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+body {</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+  background: #ffffff;</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+  font-family: sans-serif;</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+  padding: 0;</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+  margin: 0;</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+  height: 100%;</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+  width: 100%;</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+  font-family: sans-serif;</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+}</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+/* ===== Query Explanation ===== */</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+#query-explanation {</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+  display: block;</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+  position: absolute;</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+  top: 0;</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+  left: 20.5em;</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+  height: 2.5em;</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  font-size: 110%;</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+  margin-left: 0;</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+  padding: 2px;</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+  padding-left: 0;</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+  padding-top: 1em;</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+  font-size: medium;</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+}</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+.explanation-fulltext-label {</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+  font-size: 120%;</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+  color: #3465a4;</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+  margin: 0 0.1em;</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+}</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineplus">+</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+.explanation-fulltext-term {</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+  font-size: large;</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+  color: black;</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+  margin: 0 0.1em;</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+}</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+.explanation-fulltext-criteria {</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+  font-size: medium;</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineplus">+  color: #888;</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+  margin: 0 0.1em;</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+}</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+.explanation-change-label {</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+  font-size: 80%;</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+  color: black;</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+  margin: 0 0.1em;</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+}</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+.explanation-query-label {</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+  margin-top: 1ex;</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+}</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineplus">+</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+.explanation-query-label,</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+.explanation-query-involves,</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+.explanation-query-tagged {</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+  color: #3465a4;</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+  margin-right: 0.5ex;</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+}</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+/* ===== Facets ===== */</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineplus">+</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineplus">+h1, h2, h3 {</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineplus">+  color: #3465a4;</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineplus">+}</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineplus">+</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+#filter-header-label {</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+  font-size: 120%;</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+  margin: 0;</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+  margin-top: 1em;</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+}</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+.explanation-change-label {</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+  margin-left: 1em;</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineplus">+  font-size: 80%;</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+  border: 1px solid grey;</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+  -moz-border-radius: 4px;</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+  padding: 3px;</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+}</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+.explanation-change-label:hover {</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+  cursor: pointer;</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+  background-color: #aed5ff;</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+}</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+.facetious[uninitialized] {</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineplus">+  display: none;</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+}</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+.facets-sidebar {</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+  display: block;</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+  position: absolute;</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineplus">+  top: 0;</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+  left: 0;</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+  bottom: 0;</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+  width: 20em;</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+  height: 100%;</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+  background-color: #eeeeee;</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+  padding: 4px;</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+  padding-left: 1em;</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineplus">+  font-size: 90%;</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+}</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+.facetious {</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+  display: inline-block;</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+  padding: 2px;</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+}</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+.facet &gt; h2 {</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+  display: inline;</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+  margin: 0;</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+  font-size: medium;</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+}</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+.facet-included[state=&quot;empty&quot;],</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+.facet-excluded[state=&quot;empty&quot;] {</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+  display: none;</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+}</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+#facet-date {</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+  position: fixed;</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+  bottom: -4px;</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+  left: 20em;</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+  padding: 0px;</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+  background-color: rgba(255,255,255,0.6);</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+  display: block;</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+}</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+/* === Boolean Facet === */</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+.facetious[type=&quot;boolean&quot;][disabled] {</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+  color: #888888;</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+}</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+.facet-checkbox-bubble {</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+  padding: 2px;</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+  padding-right: 6px;</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+  border: solid transparent 1px;</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+  cursor: pointer;</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+  color: #333;</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+  font-size: 90%;</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+}</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+.facetious[type=&quot;boolean&quot;][disabled] &gt; .facet-checkbox-bubble,</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+.facetious[type=&quot;boolean-filtered&quot;][disabled] &gt; .facet-checkbox-bubble {</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+  cursor: default;</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+  color: #777;</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+}</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+.facetious[type=&quot;boolean&quot;]:not([disabled]):hover &gt; .facet-checkbox-bubble,</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+.facetious[type=&quot;boolean-filtered&quot;]:not([disabled]):hover &gt; .facet-checkbox-bubble {</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+  background-color: #aed5ff;</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+  border: solid #3465a4 1px;</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+  -moz-border-radius: 4px;</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+}</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineplus">+</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+.facet-checkbox-label {</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+}</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+.facet-checkbox-count {</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineplus">+}</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineplus">+.facet-checkbox-count:before {</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+  content: &quot; (&quot;;</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+}</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+.facet-checkbox-count:after {</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+  content: &quot;)&quot;;</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineplus">+}</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+/* === Boolean Filtered === */</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+.facetious[type=&quot;boolean-filtered&quot;]:not([checked]) &gt; .facet-filter-list {</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineplus">+  display: none</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+}</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+.facet-filter-list {</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+  display: block;</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+}</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineplus">+</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+/* === Discrete Facet === */</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+/*</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineplus">+ * Our basis for the bar-chart comes from:</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineplus">+ *  http://www.alistapart.com/articles/accessibledatavisualization/</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineplus">+ * Thank you, Wilson Miner.</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineplus">+ */</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineplus">+.barry {</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+  border-top: 1px solid #EEE;</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineplus">+  margin: 0;</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+  padding: 4px;</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+}</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+.facet-modes {</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+  font-size: 80%;</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+  cursor: pointer;</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+  color: #888888;</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+}</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+.facet-modes:before {</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineplus">+  font-weight: normal;</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+  content: &quot;( &quot;;</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineplus">+}</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineplus">+.facet-mode:not(:first-child):before {</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineplus">+  font-weight: normal;</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+  content: &quot; | &quot;;</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineplus">+}</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineplus">+</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineplus">+.facet-modes:after {</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+  font-weight: normal;</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+  content: &quot; )&quot;;</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineplus">+}</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineplus">+</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineplus">+.facet-mode[selected] {</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineplus">+  font-weight: bold;</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineplus">+}</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineplus">+</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineplus">+.bar {</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineplus">+  position: relative;</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineplus">+  display: block;</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineplus">+  border-bottom: 1px solid #EEE;</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+  _zoom: 1;</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineplus">+  cursor: pointer;</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineplus">+  font-size: 80%;</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineplus">+}</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineplus">+</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineplus">+.bar[included] {</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineplus">+  background-color: #efffef;</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineplus">+}</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineplus">+</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+.bar[excluded] {</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineplus">+  text-decoration: line-through;</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineplus">+}</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineplus">+</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineplus">+</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineplus">+.bar:hover {</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineplus">+  background: #e8e8e8;</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+}</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineplus">+</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineplus">+.bar-link {</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+  color: #2D7BB2;</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+  text-decoration: none;</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+  display: block;</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineplus">+  padding: 0.3em 2em 0.3em 0.5em;</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineplus">+  position: relative;</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineplus">+  z-index: 2;</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineplus">+}</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineplus">+</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineplus">+.bar:hover &gt; .bar-link {</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineplus">+  color: #333;</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineplus">+}</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineplus">+</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineplus">+.bar-percent {</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineplus">+  display: block;</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineplus">+  position: absolute;</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineplus">+  top: 0;</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineplus">+  left: 0;</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+  height: 100%;</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+  background: #e9f2f5;</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineplus">+  text-indent: -9999px;</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineplus">+  overflow: hidden;</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineplus">+  line-height: 1.6em;</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineplus">+}</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineplus">+</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineplus">+.bar:hover &gt; .bar-percent {</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+  background: #ceeaf5;</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineplus">+}</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineplus">+</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineplus">+.bar-exclude {</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+  display: block;</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineplus">+  visibility: hidden;</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineplus">+  background-image: url(&quot;chrome://messenger/skin/icons/thread-ignored.png&quot;);</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineplus">+  position: absolute;</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineplus">+  top: 0.3em;</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineplus">+  right: 2px;</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineplus">+  width: 16px;</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineplus">+  height: 16px;</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineplus">+  z-index: 3;</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+}</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineplus">+</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineplus">+.bar:hover &gt; .bar-exclude {</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineplus">+  visibility: visible;</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineplus">+}</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineplus">+</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineplus">+.bar-exclude:hover {</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineplus">+  background-color: #ffffcc;</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineplus">+}</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineplus">+</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineplus">+/* ===== Results ===== */</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineplus">+</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineplus">+.results {</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineplus">+  margin-left: 20.5em;</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineplus">+  margin-top: 3em;</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineplus">+}</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineplus">+</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineplus">+.results-message-header {</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineplus">+  background-color: #dcddde;</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineplus">+  border-top: 2px solid #ccc;</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineplus">+  padding: 2px;</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineplus">+}</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineplus">+</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineplus">+.results-message-count {</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineplus">+  display: inline;</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineplus">+  margin: 0;</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineplus">+  font-size: medium;</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineplus">+}</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineplus">+.results-message-showall {</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineplus">+  margin-left: 1em;</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineplus">+  cursor: pointer;</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineplus">+  font-size: 80%;</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineplus">+}</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineplus">+</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineplus">+/* ===== Messages ===== */</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineplus">+</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineplus">+.message {</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineplus">+  display: block;</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineplus">+  font-family: sans-serif;</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineplus">+  font-size: 80%;</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineplus">+  padding-top: 3px;</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineplus">+  padding-bottom: 3px;</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineplus">+  margin-right: 1em;</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineplus">+  border: 1px solid transparent;</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineplus">+  -moz-border-radius: 3px;</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineplus">+  border-bottom: 1px solid #ddd;</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineplus">+  display: block;</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineplus">+  color: #555;</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineplus">+  background-color: #ffffff;</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineplus">+}</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineplus">+</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineplus">+.message:hover {</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineplus">+  border-color: grey;</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineplus">+  background: #efefef;</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+  cursor: pointer;</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineplus">+}</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineplus">+</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineplus">+.message:focus {</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineplus">+  border: 1px dotted #111;</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineplus">+  padding: 1em 0px;</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineplus">+}</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineplus">+.message[unread=&quot;true&quot;]:focus {</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineplus">+  border: 1px dotted #111;</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineplus">+  padding: 1em 0px;</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineplus">+}</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineplus">+.message:focus:last-child {</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineplus">+  border: 1px dotted #111;</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineplus">+  padding: 1em 0px;</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineplus">+}</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineplus">+.message:focus:first-child {</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineplus">+  border: 1px dotted #111;</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineplus">+  padding: 1em 0px;</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineplus">+}</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineplus">+.message:last-child {</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineplus">+  border-bottom: 1px solid transparent;</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineplus">+}</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineplus">+.message:last-child:hover {</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineplus">+  border-bottom: 1px solid;</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineplus">+}</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineplus">+</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineplus">+</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineplus">+.message {</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineplus">+  display: block;</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineplus">+  padding: 0.2em 0em;</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineplus">+  padding-right: 1em;</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineplus">+}</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineplus">+</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineplus">+.message-header,</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineplus">+.message-body {</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineplus">+  margin-left: 24px;</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineplus">+  font-size: 95%;</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineplus">+}</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineplus">+</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineplus">+.message-header {</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineplus">+  margin-bottom: 0.5em;</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineplus">+}</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineplus">+.message-meta {</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineplus">+  float: right;</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineplus">+  padding-left: 2em;</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineplus">+  text-align: right;</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineplus">+  color: #999;</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineplus">+  font-size: 90%;</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineplus">+}</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineplus">+.message-attachments {</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineplus">+  padding-right: 18px;</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineplus">+  background: url(&quot;chrome://messenger/skin/icons/attachment.png&quot;) transparent no-repeat center right;</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineplus">+  display: none;</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineplus">+}</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineplus">+.message-attachments[count] {</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineplus">+  display: inline;</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineplus">+}</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineplus">+.message-attachments:before {</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineplus">+  content: &quot;(&quot;;</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineplus">+}</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineplus">+.message-attachments:after {</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineplus">+  content: &quot;)&quot;;</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineplus">+}</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineplus">+.message-writes {</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineplus">+  font-size: 90%;</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineplus">+  color: #777;</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineplus">+}</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineplus">+.message-date {</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineplus">+  color: #999; font-size: 90%; }</span>
<a href="#l6.451"></a><span id="l6.451" class="difflineplus">+.message-date:before {</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineplus">+  content: &quot;\2014  &quot;;</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineplus">+}</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineplus">+</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineplus">+.message-recipients {</span>
<a href="#l6.456"></a><span id="l6.456" class="difflineplus">+  display: inline;</span>
<a href="#l6.457"></a><span id="l6.457" class="difflineplus">+  color: #222;</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineplus">+}</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineplus">+.message-recipient:first-child:before {</span>
<a href="#l6.460"></a><span id="l6.460" class="difflineplus">+  content: &quot;&quot;;</span>
<a href="#l6.461"></a><span id="l6.461" class="difflineplus">+}</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineplus">+.message-recipient:after {</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineplus">+  content: &quot;, &quot;;</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineplus">+}</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineplus">+.message-recipient:last-child:after {</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineplus">+  content: &quot;&quot;;</span>
<a href="#l6.467"></a><span id="l6.467" class="difflineplus">+}</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineplus">+</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineplus">+.message-subject {</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineplus">+  white-space: nowrap;</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineplus">+  overflow: hidden;</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineplus">+  font-size: 115%;</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineplus">+  font-weight: bold;</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineplus">+  color: #555;</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineplus">+}</span>
<a href="#l6.476"></a><span id="l6.476" class="difflineplus">+.message-body {</span>
<a href="#l6.477"></a><span id="l6.477" class="difflineplus">+  color: #555;</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineplus">+  padding-left: 1em;</span>
<a href="#l6.479"></a><span id="l6.479" class="difflineplus">+  font-family: monospace;</span>
<a href="#l6.480"></a><span id="l6.480" class="difflineplus">+  font-size: 110%;</span>
<a href="#l6.481"></a><span id="l6.481" class="difflineplus">+}</span>
<a href="#l6.482"></a><span id="l6.482" class="difflineplus">+</span>
<a href="#l6.483"></a><span id="l6.483" class="difflineplus">+.message-tag {</span>
<a href="#l6.484"></a><span id="l6.484" class="difflineplus">+  -moz-margin-start: 0px;</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineplus">+  background-image: url(&quot;chrome://messenger/skin/tagbg.png&quot;);</span>
<a href="#l6.486"></a><span id="l6.486" class="difflineplus">+  color: black;</span>
<a href="#l6.487"></a><span id="l6.487" class="difflineplus">+  -moz-border-radius: 2px;</span>
<a href="#l6.488"></a><span id="l6.488" class="difflineplus">+  padding: 1px 3px;</span>
<a href="#l6.489"></a><span id="l6.489" class="difflineplus">+  margin-right: 3px;</span>
<a href="#l6.490"></a><span id="l6.490" class="difflineplus">+}</span>
<a href="#l6.491"></a><span id="l6.491" class="difflineplus">+.message-folder {</span>
<a href="#l6.492"></a><span id="l6.492" class="difflineplus">+  background-color: #faf0b8;</span>
<a href="#l6.493"></a><span id="l6.493" class="difflineplus">+  border: 1px solid #ede4af;</span>
<a href="#l6.494"></a><span id="l6.494" class="difflineplus">+}</span>
<a href="#l6.495"></a><span id="l6.495" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/mail/base/content/glodaFacetView.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,489 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ *</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+ *</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+ * License.</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+ *</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ * The Original Code is Thunderbird Global Database.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+ *</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+ *</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+ *</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ *</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+/*</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+ * This file provides the global context for the faceting environment.  In the</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+ *  Model View Controller (paradigm), we are the view and the XBL widgets are</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+ *  the the view and controller.</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+ *</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+ * Because much of the work related to faceting is not UI-specific, we try and</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+ *  push as much of it into mailnews/db/gloda/facet.js.  In some cases we may</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+ *  get it wrong and it may eventually want to migrate.</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+ */</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+Cu.import(&quot;resource://app/modules/StringBundle.js&quot;);</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+Cu.import(&quot;resource://app/modules/PluralForm.jsm&quot;);</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+Cu.import(&quot;resource://app/modules/errUtils.js&quot;);</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+Cu.import(&quot;resource://app/modules/gloda/public.js&quot;);</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+Cu.import(&quot;resource://app/modules/gloda/facet.js&quot;);</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+const glodaFacetStrings =</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+  new StringBundle(&quot;chrome://messenger/locale/glodaFacetView.properties&quot;);</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+/**</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+ *</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+ */</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+function ActiveConstraint(aFaceter, aAttrDef, aInclusive, aGroupValues,</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+                          aRanged) {</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+  this.faceter = aFaceter;</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+  this.attrDef = aAttrDef;</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+  this.inclusive = aInclusive;</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+  this.ranged = Boolean(aRanged);</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  this.groupValues = aGroupValues;</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+  this._makeQuery();</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+}</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+ActiveConstraint.prototype = {</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+  _makeQuery: function() {</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+    // have the faceter make the query and the invert decision for us if it</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+    //  implements the makeQuery method.</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+    if (&quot;makeQuery&quot; in this.faceter) {</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+      [this.query, this.invertQuery] = this.faceter.makeQuery(this.groupValues,</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+                                                              this.inclusive);</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+      return;</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+    }</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+    let query = this.query = Gloda.newQuery(Gloda.NOUN_MESSAGE);</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+    let constraintFunc;</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+    // If the facet definition references a queryHelper defined by the noun</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+    //  type, use that instead of the standard constraint function.</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+    if (&quot;queryHelper&quot; in this.attrDef.facet)</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+      constraintFunc = query[this.attrDef.boundName +</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+                             this.attrDef.facet.queryHelper];</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+    else</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+      constraintFunc = query[this.ranged ? (this.attrDef.boundName + &quot;Range&quot;)</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+                                         : this.attrDef.boundName];</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+    constraintFunc.apply(query, this.groupValues);</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+    this.invertQuery = !this.inclusive;</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+  },</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+  /**</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+   * Adjust the constraint given the incoming faceting constraint desired.</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+   *  Mainly, if the inclusive flag is the same as what we already have, we</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+   *  just append the new values to the existing set of values.  If it is not</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+   *  the same, we replace them.</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+   */</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+  adjust: function(aInclusive, aGroupValues) {</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+    if (aInclusive == this.inclusive) {</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+      this.groupValues = this.groupValues.concat(aGroupValues);</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+      this._makeQuery();</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+      return;</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+    }</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+    this.inclusive = aInclusive;</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+    this.groupValues = aGroupValues;</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+    this._makeQuery();</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+  },</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+  /**</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+   * Replace the existing constraints with the new constraint.</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+   */</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+  replace: function(aInclusive, aGroupValues) {</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+    this.inclusive = aInclusive;</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+    this.groupValues = aGroupValues;</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+    this._makeQuery();</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+  },</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+  /**</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+   * Filter the items against our constraint.</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+   */</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+  sieve: function(aItems) {</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+    let query = this.query;</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+    let expectedResult = !this.invertQuery;</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+    let outItems = [];</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+    for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+      if (query.test(item) == expectedResult)</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+        outItems.push(item);</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+    }</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+    return outItems;</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+  }</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+};</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+var FacetContext = {</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+  facetDriver: new FacetDriver(Gloda.lookupNounDef(&quot;message&quot;),</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+                               window),</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+  /**</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+   * The root collection which our active set is a subset of.  We hold onto this</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+   *  for garbage collection reasons, although the tab that owns us should also</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+   *  be holding on.</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+   */</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+  _collection: null,</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+  set collection(aCollection) {</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+    this._collection = aCollection;</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+  },</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+  get collection() {</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+    return this._collection;</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+  },</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+  /**</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+   * List of the current working set</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+   */</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+  _activeSet: null,</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+  get activeSet() {</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+    return this._activeSet;</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+  },</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+  initialBuild: function() {</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+    let queryExplanation = document.getElementById(&quot;query-explanation&quot;);</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+    if (this.searcher)</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+      queryExplanation.setFulltext(this.searcher);</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+    else</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+      queryExplanation.setQuery(this.collection.query);</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+    // we like to sort them so should clone the list</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+    this.faceters = this.facetDriver.faceters.concat();</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+    this.everFaceted = false;</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+    this.build(this._collection.items);</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+  },</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+  build: function(aNewSet) {</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+    this._activeSet = aNewSet;</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+    this.facetDriver.go(this._activeSet, this.facetingCompleted, this);</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+  },</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+  /**</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+   * Attempt to figure out a reasonable number of rows to limit each facet to</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+   *  display.  While the number will ordinarily be dominated by the maximum</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+   *  number of rows we believe the user can easily scan, this may also be</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+   *  impacted by layout concerns (since we want to avoid scrolling).</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+   */</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+  planLayout: function() {</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+    // XXX arbitrary!</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+    this.maxDisplayRows = 8;</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+    this.maxMessagesToShow = 8;</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+  },</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+  _groupCountComparator: function(a, b) {</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+    return b.groupCount - a.groupCount;</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+  },</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+  /**</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+   * Tells the UI about all the facets when notified by the |facetDriver| when</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+   *  it is done faceting everything.</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+   */</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+  facetingCompleted: function() {</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+    this.planLayout();</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+    let uiFacets = document.getElementById(&quot;facets&quot;);</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+    if (!this.everFaceted) {</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+      this.everFaceted = true;</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+      this.faceters.sort(this._groupCountComparator);</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+      for each (let [, faceter] in Iterator(this.faceters)) {</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+        let attrName = faceter.attrDef.attributeName;</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+        let explicitBinding = document.getElementById(&quot;facet-&quot; + attrName);</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+        if (explicitBinding) {</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+          explicitBinding.faceter = faceter;</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+          explicitBinding.attrDef = faceter.attrDef;</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+          explicitBinding.nounDef = faceter.attrDef.objectNounDef;</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+          explicitBinding.orderedGroups = faceter.orderedGroups;</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+          // explicit booleans should always be displayed for consistency</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+          if (faceter.groupCount &gt;= 1 ||</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+              faceter.type == &quot;boolean&quot;) {</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+            explicitBinding.build(true);</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+            explicitBinding.removeAttribute(&quot;uninitialized&quot;);</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+          }</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+          faceter.xblNode = explicitBinding;</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+          continue;</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+        }</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+        // ignore facets that do not vary!</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+        if (faceter.groupCount &lt;= 1) {</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+          faceter.xblNode = null;</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+          continue;</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+        }</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+        faceter.xblNode = uiFacets.addFacet(faceter.type, faceter.attrDef, {</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+          faceter: faceter,</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+          orderedGroups: faceter.orderedGroups,</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+          maxDisplayRows: this.maxDisplayRows,</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+        });</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+      }</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+    }</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+    else {</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+      for each (let [, faceter] in Iterator(this.faceters)) {</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineplus">+        // Do not bother with un-displayed facets, or that are locked by a</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+        //  constraint.  But do bother if the widget can be updated without</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+        //  losing important data.</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+        if (!faceter.xblNode ||</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+            (faceter.constraint &amp;&amp; !faceter.xblNode.canUpdate))</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+          continue;</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+        // hide things that have 0/1 groups now and are not constrained and not</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+        //  boolean</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+        if (faceter.groupCount &lt;= 1 &amp;&amp; !faceter.constraint &amp;&amp;</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+            (faceter.type != &quot;boolean&quot;))</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+          $(faceter.xblNode).hide();</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+        // otherwise, update</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+        else {</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+          faceter.xblNode.orderedGroups = faceter.orderedGroups;</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+          faceter.xblNode.build(false);</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+          $(faceter.xblNode).show();</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineplus">+        }</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+      }</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+    }</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineplus">+    let results = document.getElementById(&quot;results&quot;);</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+    let numMessageToShow = Math.min(this.maxMessagesToShow,</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+                                    this._activeSet.length);</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+    results.setMessages(this._activeSet.slice(0, numMessageToShow));</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+  },</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineplus">+</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+  _HOVER_STABILITY_DURATION_MS: 100,</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineplus">+  _brushedFacet: null,</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+  _brushedGroup: null,</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+  _brushedItems: null,</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+  _brushTimeout: null,</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+  hoverFacet: function(aFaceter, aAttrDef, aGroupValue, aGroupItems) {</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+    // bail if we are already brushing this item</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+    if (this._brushedFacet == aFaceter &amp;&amp; this._brushedGroup == aGroupValue)</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+      return;</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineplus">+    this._brushedFacet = aFaceter;</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+    this._brushedGroup = aGroupValue;</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineplus">+    this._brushedItems = aGroupItems;</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineplus">+</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineplus">+    if (this._brushTimeout != null)</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineplus">+      clearTimeout(this._brushTimeout);</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineplus">+    this._brushTimeout = setTimeout(this._timeoutHoverWrapper,</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineplus">+                                    this._HOVER_STABILITY_DURATION_MS, this);</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineplus">+</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineplus">+  },</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineplus">+  _timeoutHover: function() {</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineplus">+    this._brushTimeout = null;</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+    for each (let [, faceter] in Iterator(this.faceters)) {</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+      if (faceter == this._brushedFacet || !faceter.xblNode)</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+        continue;</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineplus">+      if (this._brushedItems != null)</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineplus">+        faceter.xblNode.brushItems(this._brushedItems);</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineplus">+      else</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+        faceter.xblNode.clearBrushedItems();</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineplus">+    }</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+  },</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+  _timeoutHoverWrapper: function(aThis) {</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+    aThis._timeoutHover();</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+  },</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineplus">+  unhoverFacet: function(aFaceter, aAttrDef, aGroupValue, aGroupItems) {</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineplus">+    // have we already brushed from some other source already?  ignore then.</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineplus">+    if (this._brushedFacet != aFaceter || this._brushedGroup != aGroupValue)</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineplus">+      return;</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineplus">+</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineplus">+    // reuse hover facet to null everyone out</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+    this.hoverFacet(null, null, null, null);</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+  },</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+  /**</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineplus">+   * Maps attribute names to their corresponding |ActiveConstraint|, if they</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineplus">+   *  have one.</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineplus">+   */</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineplus">+  _activeConstraints: {},</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineplus">+  /**</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineplus">+   * Called by facets when the user does some clicking and wants to impose a new</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineplus">+   *  constraint.</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+   *</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineplus">+   * @param aFaceter</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+   * @param aAttrDef</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+   * @param {Boolean} aInclusive</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineplus">+   * @param aGroupValues</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineplus">+   * @param aRanged Is it a ranged constraint?  (Currently only for dates)</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineplus">+   * @param aNukeExisting Do we need to replace the existing constraint and</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+   *     re-sieve everything?  This currently only happens for dates, where</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+   *     our display allows a click to actually make our range more generic</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+   *     than it currently is.  (But this only matters if we already have</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+   *     a date constraint applied.)</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+   */</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+  addFacetConstraint: function(aFaceter, aAttrDef, aInclusive, aGroupValues,</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+                               aRanged, aNukeExisting) {</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineplus">+    let attrName = aAttrDef.attributeName;</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineplus">+    let constraint;</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineplus">+    let needToSieveAll = false;</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineplus">+    if (attrName in this._activeConstraints) {</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineplus">+      constraint = this._activeConstraints[attrName];</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineplus">+</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineplus">+      needToSieveAll = true;</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineplus">+      if (aNukeExisting)</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineplus">+        constraint.replace(aInclusive, aGroupValues);</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineplus">+      else</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineplus">+        constraint.adjust(aInclusive, aGroupValues);</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineplus">+    }</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineplus">+    else {</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineplus">+      constraint = this._activeConstraints[attrName] =</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineplus">+        new ActiveConstraint(aFaceter, aAttrDef, aInclusive, aGroupValues,</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineplus">+                             aRanged);</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineplus">+    }</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineplus">+    aFaceter.constraint = constraint;</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineplus">+</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineplus">+    // Given our current implementation, we can only be further constraining our</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineplus">+    //  active set, so we can just sieve the existing active set with the</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineplus">+    //  (potentially updated) constraint.  In some cases, it would be much</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineplus">+    //  cheaper to use the facet's knowledge about the items in the groups, but</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineplus">+    //  for now let's keep a single code-path for how we refine the active set.</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineplus">+    this.build(needToSieveAll ? this._sieveAll()</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineplus">+                              : constraint.sieve(this.activeSet));</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineplus">+  },</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineplus">+</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineplus">+  removeFacetConstraint: function(aFaceter) {</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineplus">+    let attrName = aFaceter.attrDef.attributeName;</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineplus">+    delete this._activeConstraints[attrName];</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineplus">+    aFaceter.constraint = null;</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineplus">+</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineplus">+    // we definitely need to re-sieve everybody in this case...</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineplus">+    this.build(this._sieveAll());</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineplus">+  },</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineplus">+</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineplus">+  /**</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineplus">+   * Sieve the items from the underlying collection against all constraints,</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineplus">+   *  returning the value.</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineplus">+   */</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineplus">+  _sieveAll: function() {</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineplus">+    let items = this.collection.items;</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineplus">+</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineplus">+    for each (let [, constraint] in Iterator(this._activeConstraints)) {</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+      items = constraint.sieve(items);</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineplus">+    }</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineplus">+</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineplus">+    return items;</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineplus">+  },</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineplus">+</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineplus">+  toggleFulltextCriteria: function() {</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineplus">+    this.tab.searcher.andTerms = !this.tab.searcher.andTerms;</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+    this.collection = this.tab.searcher.getCollection(this);</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineplus">+  },</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineplus">+</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineplus">+  /**</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineplus">+   * Show the active message set in a glodaList tab, closing the current tab.</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineplus">+   */</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineplus">+  showActiveSetInTab: function() {</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineplus">+    let tabmail = this.rootWin.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineplus">+    tabmail.openTab(&quot;glodaList&quot;, {</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineplus">+      collection: Gloda.explicitCollection(Gloda.NOUN_MESSAGE, this.activeSet),</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineplus">+      title: this.tab.title</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineplus">+    });</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineplus">+    tabmail.closeTab(this.tab);</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineplus">+  },</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineplus">+</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineplus">+  /**</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineplus">+   * Show the conversation in a new glodaList tab.</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+   *</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineplus">+   * @param {GlodaConversation} aConversation The conversation to show.</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineplus">+   * @param {Boolean} [aBackground] Whether it should be in the background.</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineplus">+   */</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineplus">+  showConversationInTab: function(aMessage, aBackground) {</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineplus">+    let tabmail = this.rootWin.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineplus">+    tabmail.openTab(&quot;glodaList&quot;, {</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineplus">+      conversation: aMessage.conversation,</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineplus">+      message: aMessage,</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineplus">+      title: aMessage.conversation.subject,</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineplus">+      background: aBackground</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineplus">+    });</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineplus">+  },</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineplus">+</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineplus">+  /**</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineplus">+   * Show the message in a new tab.</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineplus">+   *</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineplus">+   * @param {GlodaMessage} aMessage The message to show.</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineplus">+   * @param {Boolean} [aBackground] Whether it should be in the background.</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineplus">+   */</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineplus">+  showMessageInTab: function(aMessage, aBackground) {</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineplus">+    let tabmail = this.rootWin.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineplus">+    let msgHdr = aMessage.folderMessage;</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineplus">+    if (!msgHdr)</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineplus">+      throw new Error(&quot;Unable to translate gloda message to message header.&quot;);</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineplus">+    tabmail.openTab(&quot;message&quot;, {</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineplus">+      msgHdr: msgHdr,</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineplus">+      background: aBackground</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineplus">+    });</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineplus">+  },</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineplus">+</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineplus">+  onItemsAdded: function(aItems, aCollection) {</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineplus">+  },</span>
<a href="#l7.447"></a><span id="l7.447" class="difflineplus">+  onItemsModified: function(aItems, aCollection) {</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineplus">+  },</span>
<a href="#l7.449"></a><span id="l7.449" class="difflineplus">+  onItemsRemoved: function(aItems, aCollection) {</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineplus">+  },</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineplus">+  onQueryCompleted: function(aCollection) {</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineplus">+    this.initialBuild();</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineplus">+  }</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineplus">+};</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineplus">+</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineplus">+/**</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineplus">+ * addEventListener betrayals compel us to establish our link with the</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineplus">+ *  outside world from inside.  NeilAway suggests the problem might have</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineplus">+ *  been the registration of the listener prior to initiating the load.  Which</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineplus">+ *  is odd considering it works for the XUL case, but I could see how that might</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineplus">+ *  differ.  Anywho, this works for now and is a delightful reference to boot.</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineplus">+ */</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineplus">+function reachOutAndTouchFrame() {</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineplus">+  let us = window.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineplus">+                 .getInterface(Ci.nsIWebNavigation)</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineplus">+                 .QueryInterface(Ci.nsIDocShellTreeItem);</span>
<a href="#l7.467"></a><span id="l7.467" class="difflineplus">+</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineplus">+  FacetContext.rootWin = us.rootTreeItem</span>
<a href="#l7.469"></a><span id="l7.469" class="difflineplus">+                    .QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineplus">+                    .getInterface(Ci.nsIDOMWindow);</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineplus">+</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineplus">+  let parentWin = us.parent</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineplus">+                    .QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineplus">+                    .getInterface(Ci.nsIDOMWindow);</span>
<a href="#l7.475"></a><span id="l7.475" class="difflineplus">+  let aTab = FacetContext.tab = parentWin.tab;</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineplus">+  parentWin.tab = null;</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineplus">+</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineplus">+  // we need to hook the context up as a listener in all cases since</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineplus">+  //  removal notifications are required.</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineplus">+  if (&quot;searcher&quot; in aTab) {</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineplus">+    FacetContext.searcher = aTab.searcher;</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineplus">+    aTab.searcher.listener = FacetContext;</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineplus">+  }</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineplus">+  else {</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineplus">+    FacetContext.searcher = null;</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineplus">+    aTab.collection.listener = FacetContext;</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineplus">+  }</span>
<a href="#l7.488"></a><span id="l7.488" class="difflineplus">+  FacetContext.collection = aTab.collection;</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineplus">+</span>
<a href="#l7.490"></a><span id="l7.490" class="difflineplus">+  // if it has already completed, we need to prod things</span>
<a href="#l7.491"></a><span id="l7.491" class="difflineplus">+  if (aTab.query.completed)</span>
<a href="#l7.492"></a><span id="l7.492" class="difflineplus">+    FacetContext.initialBuild();</span>
<a href="#l7.493"></a><span id="l7.493" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/mail/base/content/glodaFacetView.xhtml</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,57 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.1//EN&quot;</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+  &quot;http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd&quot; [</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+&lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot; &gt;</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+%brandDTD;</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+&lt;!ENTITY % aboutDTD SYSTEM &quot;chrome://global/locale/about.dtd&quot; &gt;</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+%aboutDTD;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+&lt;!ENTITY % globalDTD SYSTEM &quot;chrome://global/locale/global.dtd&quot;&gt;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+%globalDTD;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+&lt;!ENTITY % facetViewDTD SYSTEM &quot;chrome://messenger/locale/glodaFacetView.dtd&quot;&gt;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+%facetViewDTD;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+]&gt;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+    xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+    version=&quot;-//W3C//DTD XHTML 1.1//EN&quot; xml:lang=&quot;en&quot;&gt;</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+&lt;head&gt;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+  &lt;!-- XBL bindings CSS --&gt;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+  &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+      href=&quot;chrome://messenger/content/glodaFacetBindings.css&quot;</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+      type=&quot;text/css&quot;&gt;&lt;/link&gt;</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+  &lt;link rel=&quot;stylesheet&quot; media=&quot;screen&quot; type=&quot;text/css&quot;</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+        href=&quot;chrome://messenger/skin/tagColors.css&quot;/&gt;</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+  &lt;!-- Themes --&gt;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+  &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+      href=&quot;chrome://messenger/content/glodaFacetView.css&quot;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+      type=&quot;text/css&quot;&gt;&lt;/link&gt;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+  &lt;!-- Global Context --&gt;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  &lt;script type=&quot;application/javascript;version=1.8&quot;</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+      src=&quot;chrome://messenger/content/glodaFacetView.js&quot;&gt;&lt;/script&gt;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+  &lt;!-- Libs --&gt;</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+  &lt;script type=&quot;application/javascript;version=1.8&quot;</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+      src=&quot;chrome://messenger/content/jquery.js&quot;&gt;&lt;/script&gt;</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+  &lt;script type=&quot;application/javascript;version=1.8&quot;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+      src=&quot;chrome://messenger/content/protovis-r2.6-modded.js&quot;&gt;&lt;/script&gt;</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+  &lt;!-- Facet Binding Stuff that doesn't belong in XBL --&gt;</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+  &lt;script type=&quot;application/javascript;version=1.8&quot;</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+      src=&quot;chrome://messenger/content/glodaFacetVis.js&quot;&gt;&lt;/script&gt;</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+&lt;/head&gt;</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+&lt;body onload=&quot;reachOutAndTouchFrame()&quot;&gt;</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  &lt;div class=&quot;facets facets-sidebar&quot; id=&quot;facets&quot;&gt;</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+    &lt;h1 id=&quot;filter-header-label&quot;&gt;&amp;glodaFacetView.filters.label;&lt;/h1&gt;</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+    &lt;div id=&quot;facet-fromMe&quot; class=&quot;facetious&quot; type=&quot;boolean&quot; attr=&quot;fromMe&quot;</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+         uninitialized=&quot;true&quot; /&gt;</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+    &lt;div id=&quot;facet-toMe&quot; class=&quot;facetious&quot; type=&quot;boolean&quot; attr=&quot;toMe&quot;</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+         uninitialized=&quot;true&quot; /&gt;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+    &lt;div id=&quot;facet-star&quot; class=&quot;facetious&quot; type=&quot;boolean&quot; attr=&quot;star&quot;</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+         uninitialized=&quot;true&quot;/&gt;&lt;br /&gt;</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+    &lt;div id=&quot;facet-attachmentTypes&quot; class=&quot;facetious&quot; type=&quot;boolean-filtered&quot;</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+         attr=&quot;attachmentTypes&quot;</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+         groupDisplayProperty=&quot;categoryLabel&quot;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+         uninitialized=&quot;true&quot;/&gt;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+  &lt;/div&gt;</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+  &lt;div id=&quot;query-explanation&quot; /&gt;</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+  &lt;div class=&quot;results&quot; id=&quot;results&quot; type=&quot;message&quot; /&gt;</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+  &lt;div id=&quot;facet-date&quot; class=&quot;facetious&quot; type=&quot;date&quot; /&gt;</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+&lt;/body&gt;</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/mail/base/content/glodaFacetViewWrapper.xul</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,29 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://global/skin&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+&lt;window id=&quot;window&quot; xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+      src=&quot;chrome://global/content/viewZoomOverlay.js&quot;/&gt;</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+  &lt;script type=&quot;application/javascript;version=1.8&quot;&gt;&lt;![CDATA[</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+    function getBrowser() {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+        return document.getElementById('browser');</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    }</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  ]]&gt;&lt;/script&gt;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+  &lt;commandset id=&quot;selectEditMenuItems&quot;&gt;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+    &lt;command id=&quot;cmd_fullZoomReduce&quot; oncommand=&quot;ZoomManager.reduce();&quot;/&gt;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+    &lt;command id=&quot;cmd_fullZoomEnlarge&quot; oncommand=&quot;ZoomManager.enlarge();&quot;/&gt;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+    &lt;command id=&quot;cmd_fullZoomReset&quot; oncommand=&quot;ZoomManager.reset();&quot;/&gt;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+  &lt;/commandset&gt;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+  &lt;keyset&gt;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+    &lt;!--move to locale--&gt;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+    &lt;key id=&quot;key_fullZoomEnlarge&quot; key=&quot;+&quot;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+         command=&quot;cmd_fullZoomEnlarge&quot; modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+    &lt;key id=&quot;key_fullZoomEnlarge2&quot; key=&quot;=&quot;</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+         command=&quot;cmd_fullZoomEnlarge&quot; modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+    &lt;key id=&quot;key_fullZoomReduce&quot; key=&quot;-&quot;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+         command=&quot;cmd_fullZoomReduce&quot; modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+    &lt;key id=&quot;key_fullZoomReset&quot; key=&quot;0&quot;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+         command=&quot;cmd_fullZoomReset&quot; modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+  &lt;/keyset&gt;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+  &lt;browser id=&quot;browser&quot;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+           flex=&quot;1&quot; /&gt;</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+&lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/mail/base/content/glodaFacetVis.js</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,407 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+/****** BEGIN LICENSE BLOCK *****</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+ *</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+ *</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+ * License.</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+ *</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+ * The Original Code is Thunderbird Global Database.</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+ *</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+ *</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+ *</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+ *</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+/*</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+ * Facet visualizations that would be awkward in XBL.  Allegedly because the</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+ *  interaciton idiom of a protovis-based visualization is entirely different</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+ *  from XBL, but also a lot because of the lack of good syntax highlighting.</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+ */</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+/**</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+ * A date facet visualization abstraction.</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+ */</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+function DateFacetVis(aBinding, aCanvasNode) {</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+  this.binding = aBinding;</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+  this.canvasNode = aCanvasNode;</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+  this.faceter = aBinding.faceter;</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+  this.attrDef = this.faceter.attrDef;</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+}</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+DateFacetVis.prototype = {</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+  build: function() {</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+    this.allowedSpace = document.documentElement.clientWidth -</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+                        this.canvasNode.getBoundingClientRect().left;</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+    this.render();</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+  },</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+  rebuild: function() {</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+    this.render();</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+  },</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+  _MIN_BAR_SIZE_PX: 9,</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+  _BAR_SPACING_PX: 1,</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+  _MAX_BAR_SIZE_PX: 15,</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+  _AXIS_FONT: &quot;10px sans-serif&quot;,</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+  _AXIS_HEIGHT_NO_LABEL_PX: 6,</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+  _AXIS_HEIGHT_WITH_LABEL_PX: 14,</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+  _AXIS_VERT_SPACING_PX: 1,</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+  _AXIS_HORIZ_MIN_SPACING_PX: 4,</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+  _MAX_DAY_COUNT_LABEL_DISPLAY: 10,</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+  /**</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+   * Figure out how to chunk things given the linear space in pixels.  In an</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+   *  ideal world we would not use pixels, avoiding tying ourselves to assumed</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+   *  pixel densities, but we do not live there.  Reality wants crisp graphics</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+   *  and does not have enough pixels that you can ignore the pixel coordinate</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+   *  space and have things still look sharp (and good).</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+   *</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+   * Because of our love of sharpness, we will potentially under-use the space</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+   *  allocated to us.</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+   *</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+   * @param aPixels The number of linear content pixels we have to work with.</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+   *     You are in charge of the borders and such, so you subtract that off</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+   *     before you pass it in.</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+   * @return An object with attributes:</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+   */</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+  makeIdealScaleGivenSpace: function(aPixels) {</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+    let facet = this.faceter;</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+    // build a scale and have it grow the edges based on the span</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+    let scale = pv.Scales.dateTime(facet.oldest, facet.newest);</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+    const Span = pv.Scales.DateTimeScale.Span;</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+    const MS_MIN = 60*1000, MS_HOUR = 60*MS_MIN, MS_DAY = 24*MS_HOUR,</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+          MS_WEEK = 7*MS_DAY, MS_MONTHISH = 31*MS_DAY, MS_YEARISH = 366*MS_DAY;</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+    const roughMap = {};</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+    roughMap[Span.DAYS] = MS_DAY;</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+    roughMap[Span.WEEKS] = MS_WEEK;</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+    // we overestimate since we want to slightly underestimate pixel usage</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+    //  in enoughPix's rough estimate</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+    roughMap[Span.MONTHS] = MS_MONTHISH;</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+    roughMap[Span.YEARS] = MS_YEARISH;</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+    const minBarPix = this._MIN_BAR_SIZE_PX + this._BAR_SPACING_PX;</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+    let delta = facet.newest.valueOf() - facet.oldest.valueOf();</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+    let span, rules, barPixBudget;</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+    // evil side-effect land</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+    function enoughPix(aSpan) {</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+      span = aSpan;</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+      // do a rough guestimate before doing something potentially expensive...</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+      barPixBudget = Math.floor(aPixels / (delta / roughMap[span]));</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+      if (barPixBudget &lt; (minBarPix + 1))</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+        return false;</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+      rules = scale.ruleValues(span);</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+      // + 0 because we want to over-estimate slightly for niceness rounding</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+      //  reasons</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+      barPixBudget = Math.floor(aPixels / (rules.length + 0));</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+      delta = scale.max().valueOf() - scale.min().valueOf();</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+      return barPixBudget &gt; minBarPix;</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+    }</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+    // day is our smallest unit</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+    const ALLOWED_SPANS = [Span.DAYS, Span.WEEKS, Span.MONTHS, Span.YEARS];</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+    for each (let [, trySpan] in Iterator(ALLOWED_SPANS)) {</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+      if (enoughPix(trySpan)) {</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+        // do the equivalent of nice() for our chosen span</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+        scale.min(scale.round(scale.min(), trySpan, false));</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+        scale.max(scale.round(scale.max(), trySpan, true));</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+        // try again for paranoia, but mainly for the side-effect...</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+        if (enoughPix(trySpan))</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+          break;</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+      }</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+    }</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+    // - Figure out our labeling strategy</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+    // normalize the symbols into an explicit ordering</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+    let spandex = ALLOWED_SPANS.indexOf(span);</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+    // from least-specific to most-specific</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+    let labelTiers = [];</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+    // add year spans in all cases, although whether we draw bars depends on if</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+    //  we are in year mode or not</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+    labelTiers.push({</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+      rules: (span == Span.YEARS) ? rules : scale.ruleValues(Span.YEARS, true),</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+      label: [&quot;%Y&quot;, &quot;%y&quot;, null], // we should not hit the null case...</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+      boost: (span == Span.YEARS),</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+      noFringe: (span == Span.YEARS)</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+    });</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+    // add month spans if we are days or weeks...</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+    if (spandex &lt; 2) {</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+      labelTiers.push({</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+        rules: scale.ruleValues(Span.MONTHS, true),</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+        // try to use the full month, falling back to the short month</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+        label: [&quot;%B&quot;, &quot;%b&quot;, null],</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+        boost: false</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+      });</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+    }</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+    // add week spans if our granularity is days...</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+    if (span == Span.DAYS) {</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+      let numDays = delta / MS_DAY;</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+      // find out how many days we are talking about and add days if it's small</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+      //  enough, display both the date and the day of the week</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+      if (numDays &lt;= this._MAX_DAY_COUNT_LABEL_DISPLAY) {</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+        labelTiers.push({</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+          rules: rules,</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+          label: [&quot;%d&quot;, null],</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+          boost: true, noFringe: true</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+        });</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+        labelTiers.push({</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+          rules: rules,</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+          label: [&quot;%a&quot;, null],</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+          boost: true, noFringe: true</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+        });</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+      }</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineplus">+      // show the weeks since we're at greater than a day time-scale</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineplus">+      else {</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineplus">+        labelTiers.push({</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineplus">+          rules: scale.ruleValues(Span.WEEKS, true),</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineplus">+          // labeling weeks is nonsensical; no one understands ISO weeks</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineplus">+          //  numbers.</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineplus">+          label: [null],</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineplus">+          boost: false</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineplus">+        });</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineplus">+      }</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineplus">+    }</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineplus">+</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineplus">+    return {</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineplus">+      scale: scale, span: span, rules: rules, barPixBudget: barPixBudget,</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineplus">+      labelTiers: labelTiers</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineplus">+    };</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineplus">+  },</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+  render: function() {</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+    let {scale: scale, span: span, rules: rules, barPixBudget: barPixBudget,</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineplus">+         labelTiers: labelTiers} =</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineplus">+      this.makeIdealScaleGivenSpace(this.allowedSpace);</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineplus">+</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineplus">+    barPixBudget = Math.floor(barPixBudget);</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineplus">+</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineplus">+    let minBarPix = this._MIN_BAR_SIZE_PX + this._BAR_SPACING_PX;</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineplus">+    let maxBarPix = this._MAX_BAR_SIZE_PX + this._BAR_SPACING_PX;</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineplus">+</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineplus">+    let barPix = Math.max(minBarPix, Math.min(maxBarPix, barPixBudget));</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineplus">+    let width = barPix * (rules.length - 1);</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineplus">+</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineplus">+    let totalAxisLabelHeight = 0;</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineplus">+</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineplus">+    // we need to do some font-metric calculations, so create a canvas...</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineplus">+    let fontMetricCanvas = document.createElement(&quot;canvas&quot;);</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineplus">+    let ctx = fontMetricCanvas.getContext(&quot;2d&quot;);</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineplus">+    // do the labeling logic,</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+    for each (let [, labelTier] in Iterator(labelTiers)) {</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineplus">+      let labelRules = labelTier.rules;</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineplus">+      let perLabelBudget = width / (labelRules.length - 1);</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineplus">+      for each (let [, labelFormat] in Iterator(labelTier.label)) {</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineplus">+        let maxWidth = 0;</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+        let displayValues = [];</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+        for (let iRule = 0; iRule &lt; labelRules.length - 1; iRule++) {</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineplus">+          // is this at the either edge of the display?  in that case, it might</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineplus">+          //  be partial...</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineplus">+          let fringe = (labelRules.length &gt; 2) &amp;&amp;</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineplus">+                       ((iRule == 0) || (iRule == labelRules.length - 2));</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineplus">+          let labelStartDate = labelRules[iRule];</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineplus">+          let labelEndDate = labelRules[iRule + 1];</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineplus">+          let labelText = labelFormat ?</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineplus">+                            labelStartDate.toLocaleFormat(labelFormat) : null;</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineplus">+          let labelStartNorm = Math.max(0, scale.normalize(labelStartDate));</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineplus">+          let labelEndNorm = Math.min(1, scale.normalize(labelEndDate));</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineplus">+          let labelBudget = (labelEndNorm - labelStartNorm) * width;</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineplus">+          if (labelText) {</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineplus">+            let labelWidth = ctx.measureText(labelText).width;</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineplus">+            // discard labels at the fringe who don't fit in our budget</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineplus">+            if (fringe &amp;&amp; !labelTier.noFringe &amp;&amp; labelWidth &gt; labelBudget)</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineplus">+              labelText = null;</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineplus">+            else</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineplus">+              maxWidth = Math.max(labelWidth, maxWidth);</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineplus">+          }</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineplus">+</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineplus">+          displayValues.push([labelStartNorm, labelEndNorm, labelText,</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineplus">+                              labelStartDate, labelEndDate]);</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+        }</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineplus">+        // there needs to be space between the labels.  (we may be over-padding</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineplus">+        //  here if there is only one label with the maximum width...)</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineplus">+        maxWidth += this._AXIS_HORIZ_MIN_SPACING_PX;</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineplus">+</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineplus">+        if (labelTier.boost &amp;&amp; (maxWidth &gt; perLabelBudget)) {</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineplus">+          // we only boost labels that are the same span as the bins, so rules</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineplus">+          //  === labelRules at this point.  (and barPix === perLabelBudget)</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineplus">+          barPix = perLabelBudget = maxWidth;</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineplus">+          width = barPix * (labelRules.length - 1);</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineplus">+        }</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineplus">+        if (maxWidth &lt;= perLabelBudget) {</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineplus">+          labelTier.displayValues = displayValues;</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineplus">+          labelTier.displayLabel = labelFormat != null;</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineplus">+          labelTier.vertHeight = labelFormat ? this._AXIS_HEIGHT_WITH_LABEL_PX</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineplus">+                                             : this._AXIS_HEIGHT_NO_LABEL_PX;</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineplus">+          labelTier.vertOffset = totalAxisLabelHeight;</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineplus">+          totalAxisLabelHeight += labelTier.vertHeight +</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineplus">+                                  this._AXIS_VERT_SPACING_PX;</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineplus">+</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineplus">+          break;</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineplus">+        }</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineplus">+      }</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineplus">+    }</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineplus">+    let barWidth = barPix - this._BAR_SPACING_PX;</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineplus">+    let barSpacing = this._BAR_SPACING_PX;</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineplus">+</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineplus">+    width = barPix * (rules.length - 1);</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineplus">+    // we ideally want this to be the same size as the max rows translates to...</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineplus">+    let height = 100;</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+    let ch = height - totalAxisLabelHeight;</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineplus">+</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineplus">+    let [bins, maxBinSize] = this.binBySpan(scale, span, rules);</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineplus">+</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineplus">+    // build empty bins for our hot bins</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineplus">+    this.emptyBins = [0 for each (bin in bins)];</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineplus">+</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineplus">+    let binScale = maxBinSize ? (ch / maxBinSize) : 1;</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineplus">+</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineplus">+    let vis = this.vis = new pv.Panel().canvas(this.canvasNode)</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineplus">+      // dimensions</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineplus">+      .width(width).height(height)</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineplus">+      // margins</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineplus">+      .bottom(totalAxisLabelHeight);</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineplus">+</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineplus">+    let faceter = this.faceter;</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineplus">+    // bin bars...</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineplus">+    vis.add(pv.Bar)</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineplus">+      .data(bins)</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineplus">+      .bottom(0)</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineplus">+      .height(function (d) Math.floor(d.items.length * binScale))</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineplus">+      .width(function() barWidth)</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineplus">+      .left(function() this.index * barPix)</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineplus">+      .fillStyle(&quot;#e9f2f5&quot;)</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineplus">+      .event(&quot;mouseover&quot;, function(d) this.fillStyle(&quot;#ceeaf5&quot;))</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineplus">+      .event(&quot;mouseout&quot;, function(d) this.fillStyle(&quot;#e9f2f5&quot;))</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineplus">+      .event(&quot;click&quot;, function(d)</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineplus">+        FacetContext.addFacetConstraint(faceter, faceter.attrDef, true,</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineplus">+                                        [[d.startDate, d.endDate]],</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineplus">+                                        true, true));</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineplus">+</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineplus">+    this.hotBars = vis.add(pv.Bar)</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineplus">+      .data(this.emptyBins)</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineplus">+      .bottom(0)</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineplus">+      .height(function (d) Math.floor(d * binScale))</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineplus">+      .width(function() barWidth)</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineplus">+      .left(function() this.index * barPix)</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineplus">+      .fillStyle(&quot;#ceeaf5&quot;);</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineplus">+</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineplus">+    for each (let [, labelTier] in Iterator(labelTiers)) {</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineplus">+      let labelBar = vis.add(pv.Bar)</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineplus">+        .data(labelTier.displayValues)</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineplus">+        .bottom(-totalAxisLabelHeight + labelTier.vertOffset)</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineplus">+        .height(labelTier.vertHeight)</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineplus">+        .left(function(d) Math.floor(width * d[0]))</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineplus">+        .width(function(d)</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineplus">+                 Math.floor(width * d[1]) - Math.floor(width * d[0]) - 1)</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineplus">+        .fillStyle(&quot;#dddddd&quot;)</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineplus">+        .event(&quot;mouseover&quot;, function(d) this.fillStyle(&quot;#ceeaf5&quot;))</span>
<a href="#l10.332"></a><span id="l10.332" class="difflineplus">+        .event(&quot;mouseout&quot;, function(d) this.fillStyle(&quot;#dddddd&quot;))</span>
<a href="#l10.333"></a><span id="l10.333" class="difflineplus">+        .event(&quot;click&quot;, function(d)</span>
<a href="#l10.334"></a><span id="l10.334" class="difflineplus">+          FacetContext.addFacetConstraint(faceter, faceter.attrDef, true,</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineplus">+                                          [[d[3], d[4]]], true, true));</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineplus">+</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineplus">+      if (labelTier.displayLabel) {</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineplus">+        labelBar.anchor(&quot;top&quot;).add(pv.Label)</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineplus">+          .font(this._AXIS_FONT)</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineplus">+          .textAlign(&quot;center&quot;)</span>
<a href="#l10.341"></a><span id="l10.341" class="difflineplus">+          .textBaseline(&quot;top&quot;)</span>
<a href="#l10.342"></a><span id="l10.342" class="difflineplus">+          .textStyle(&quot;#888888&quot;)</span>
<a href="#l10.343"></a><span id="l10.343" class="difflineplus">+          .text(function(d) d[2]);</span>
<a href="#l10.344"></a><span id="l10.344" class="difflineplus">+      }</span>
<a href="#l10.345"></a><span id="l10.345" class="difflineplus">+    }</span>
<a href="#l10.346"></a><span id="l10.346" class="difflineplus">+</span>
<a href="#l10.347"></a><span id="l10.347" class="difflineplus">+</span>
<a href="#l10.348"></a><span id="l10.348" class="difflineplus">+    vis.render();</span>
<a href="#l10.349"></a><span id="l10.349" class="difflineplus">+  },</span>
<a href="#l10.350"></a><span id="l10.350" class="difflineplus">+</span>
<a href="#l10.351"></a><span id="l10.351" class="difflineplus">+  hoverItems: function(aItems) {</span>
<a href="#l10.352"></a><span id="l10.352" class="difflineplus">+    let itemToBin = this.itemToBin;</span>
<a href="#l10.353"></a><span id="l10.353" class="difflineplus">+    let bins = this.emptyBins.concat();</span>
<a href="#l10.354"></a><span id="l10.354" class="difflineplus">+    for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l10.355"></a><span id="l10.355" class="difflineplus">+      if (item.id in itemToBin)</span>
<a href="#l10.356"></a><span id="l10.356" class="difflineplus">+        bins[itemToBin[item.id]]++;</span>
<a href="#l10.357"></a><span id="l10.357" class="difflineplus">+    }</span>
<a href="#l10.358"></a><span id="l10.358" class="difflineplus">+    this.hotBars.data(bins);</span>
<a href="#l10.359"></a><span id="l10.359" class="difflineplus">+    this.vis.render();</span>
<a href="#l10.360"></a><span id="l10.360" class="difflineplus">+  },</span>
<a href="#l10.361"></a><span id="l10.361" class="difflineplus">+</span>
<a href="#l10.362"></a><span id="l10.362" class="difflineplus">+  clearHover: function() {</span>
<a href="#l10.363"></a><span id="l10.363" class="difflineplus">+    this.hotBars.data(this.emptyBins);</span>
<a href="#l10.364"></a><span id="l10.364" class="difflineplus">+    this.vis.render();</span>
<a href="#l10.365"></a><span id="l10.365" class="difflineplus">+  },</span>
<a href="#l10.366"></a><span id="l10.366" class="difflineplus">+</span>
<a href="#l10.367"></a><span id="l10.367" class="difflineplus">+  /**</span>
<a href="#l10.368"></a><span id="l10.368" class="difflineplus">+   * Bin items at the given span granularity with the set of rules generated</span>
<a href="#l10.369"></a><span id="l10.369" class="difflineplus">+   *  for the given span.  This could equally as well be done as a pre-built</span>
<a href="#l10.370"></a><span id="l10.370" class="difflineplus">+   *  array of buckets with a linear scan of items and a calculation of what</span>
<a href="#l10.371"></a><span id="l10.371" class="difflineplus">+   *  bucket they should be placed in.</span>
<a href="#l10.372"></a><span id="l10.372" class="difflineplus">+   */</span>
<a href="#l10.373"></a><span id="l10.373" class="difflineplus">+  binBySpan: function(aScale, aSpan, aRules, aItems) {</span>
<a href="#l10.374"></a><span id="l10.374" class="difflineplus">+    let bins = [];</span>
<a href="#l10.375"></a><span id="l10.375" class="difflineplus">+    let maxBinSize = 0;</span>
<a href="#l10.376"></a><span id="l10.376" class="difflineplus">+    let binCount = aRules.length - 1;</span>
<a href="#l10.377"></a><span id="l10.377" class="difflineplus">+    let itemToBin = this.itemToBin = {};</span>
<a href="#l10.378"></a><span id="l10.378" class="difflineplus">+</span>
<a href="#l10.379"></a><span id="l10.379" class="difflineplus">+    // We used to break this out by case, but that was a lot of code, and it was</span>
<a href="#l10.380"></a><span id="l10.380" class="difflineplus">+    //  somewhat ridiculous.  So now we just do the simple, if somewhat more</span>
<a href="#l10.381"></a><span id="l10.381" class="difflineplus">+    //  expensive thing.  Reviewer, feel free to thank me.</span>
<a href="#l10.382"></a><span id="l10.382" class="difflineplus">+    // We do a pass through the rules, mapping each rounded rule to a bin.  We</span>
<a href="#l10.383"></a><span id="l10.383" class="difflineplus">+    //  then do a pass through all of the items, rounding them down and using</span>
<a href="#l10.384"></a><span id="l10.384" class="difflineplus">+    //  that to perform a lookup against the map.  We could special-case the</span>
<a href="#l10.385"></a><span id="l10.385" class="difflineplus">+    //  rounding, but I doubt it's worth it.</span>
<a href="#l10.386"></a><span id="l10.386" class="difflineplus">+    let binMap = {};</span>
<a href="#l10.387"></a><span id="l10.387" class="difflineplus">+    for (let iRule = 0; iRule &lt; binCount; iRule++) {</span>
<a href="#l10.388"></a><span id="l10.388" class="difflineplus">+      let binStartDate = aRules[iRule], binEndDate = aRules[iRule+1];</span>
<a href="#l10.389"></a><span id="l10.389" class="difflineplus">+      binMap[binStartDate.valueOf().toString()] = iRule;</span>
<a href="#l10.390"></a><span id="l10.390" class="difflineplus">+      bins.push({items: [],</span>
<a href="#l10.391"></a><span id="l10.391" class="difflineplus">+                 startDate: binStartDate,</span>
<a href="#l10.392"></a><span id="l10.392" class="difflineplus">+                 endDate: binEndDate});</span>
<a href="#l10.393"></a><span id="l10.393" class="difflineplus">+    }</span>
<a href="#l10.394"></a><span id="l10.394" class="difflineplus">+    let attrKey = this.attrDef.boundName;</span>
<a href="#l10.395"></a><span id="l10.395" class="difflineplus">+    for each (let [, item] in Iterator(this.faceter.validItems)) {</span>
<a href="#l10.396"></a><span id="l10.396" class="difflineplus">+      let val = item[attrKey];</span>
<a href="#l10.397"></a><span id="l10.397" class="difflineplus">+      // round it to the rule...</span>
<a href="#l10.398"></a><span id="l10.398" class="difflineplus">+      val = aScale.round(val, aSpan, false);</span>
<a href="#l10.399"></a><span id="l10.399" class="difflineplus">+      // which we can then map...</span>
<a href="#l10.400"></a><span id="l10.400" class="difflineplus">+      let itemBin = binMap[val.valueOf().toString()];</span>
<a href="#l10.401"></a><span id="l10.401" class="difflineplus">+      itemToBin[item.id] = itemBin;</span>
<a href="#l10.402"></a><span id="l10.402" class="difflineplus">+      bins[itemBin].items.push(item);</span>
<a href="#l10.403"></a><span id="l10.403" class="difflineplus">+    }</span>
<a href="#l10.404"></a><span id="l10.404" class="difflineplus">+    for each (let [, bin] in Iterator(bins)) {</span>
<a href="#l10.405"></a><span id="l10.405" class="difflineplus">+      maxBinSize = Math.max(bin.items.length, maxBinSize);</span>
<a href="#l10.406"></a><span id="l10.406" class="difflineplus">+    }</span>
<a href="#l10.407"></a><span id="l10.407" class="difflineplus">+</span>
<a href="#l10.408"></a><span id="l10.408" class="difflineplus">+    return [bins, maxBinSize];</span>
<a href="#l10.409"></a><span id="l10.409" class="difflineplus">+  }</span>
<a href="#l10.410"></a><span id="l10.410" class="difflineplus">+</span>
<a href="#l10.411"></a><span id="l10.411" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1674,17 +1674,17 @@ function CreateToolbarTooltip(document, </span>
<a href="#l11.4"></a><span id="l11.4">   if (tn.hasAttribute(&quot;label&quot;)) {</span>
<a href="#l11.5"></a><span id="l11.5">     event.target.setAttribute(&quot;label&quot;, tn.getAttribute(&quot;label&quot;));</span>
<a href="#l11.6"></a><span id="l11.6">     return true;</span>
<a href="#l11.7"></a><span id="l11.7">   }</span>
<a href="#l11.8"></a><span id="l11.8">   return false;</span>
<a href="#l11.9"></a><span id="l11.9"> }</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> /**</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">- * Displays message &quot;folder&quot;s, mail &quot;message&quot;s, and &quot;glodaSearch&quot; results.  The</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+ * Displays message &quot;folder&quot;s, mail &quot;message&quot;s, and &quot;glodaList&quot; results.  The</span>
<a href="#l11.14"></a><span id="l11.14">  *  commonality is that they all use the &quot;mailContent&quot; panel's folder tree,</span>
<a href="#l11.15"></a><span id="l11.15">  *  thread tree, and message pane objects.  This happens for historical reasons,</span>
<a href="#l11.16"></a><span id="l11.16">  *  likely involving the fact that prior to the introduction of this</span>
<a href="#l11.17"></a><span id="l11.17">  *  abstraction, everything was always stored in global objects.  For the 3.0</span>
<a href="#l11.18"></a><span id="l11.18">  *  release cycle we considered avoiding this 'multiplexed' style of operation</span>
<a href="#l11.19"></a><span id="l11.19">  *  but decided against moving to making each tab be indepdendent because of</span>
<a href="#l11.20"></a><span id="l11.20">  *  presumed complexity.</span>
<a href="#l11.21"></a><span id="l11.21">  *</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -1949,75 +1949,83 @@ let mailTabType = {</span>
<a href="#l11.23"></a><span id="l11.23">           aTab.title += &quot; - &quot; + aMsgHdr.folder.server.prettyName;</span>
<a href="#l11.24"></a><span id="l11.24">       },</span>
<a href="#l11.25"></a><span id="l11.25">       getBrowser: function(aTab) {</span>
<a href="#l11.26"></a><span id="l11.26">         // Message tabs always use the messagepane browser.</span>
<a href="#l11.27"></a><span id="l11.27">         return document.getElementById(&quot;messagepane&quot;);</span>
<a href="#l11.28"></a><span id="l11.28">       }</span>
<a href="#l11.29"></a><span id="l11.29">     },</span>
<a href="#l11.30"></a><span id="l11.30">     /**</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-     * The glodaSearch view displays a gloda-backed nsMsgDBView with only the</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+     * The glodaList view displays a gloda-backed nsMsgDBView with only the</span>
<a href="#l11.33"></a><span id="l11.33">      *  thread pane and (potentially) the message pane displayed; the folder</span>
<a href="#l11.34"></a><span id="l11.34">      *  pane is forced hidden.</span>
<a href="#l11.35"></a><span id="l11.35">      */</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-    glodaSearch: {</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+    glodaList: {</span>
<a href="#l11.38"></a><span id="l11.38">       type: &quot;glodaSearch&quot;,</span>
<a href="#l11.39"></a><span id="l11.39">       /// The set of panes that are legal to be displayed in this mode</span>
<a href="#l11.40"></a><span id="l11.40">       legalPanes: {</span>
<a href="#l11.41"></a><span id="l11.41">         folder: false,</span>
<a href="#l11.42"></a><span id="l11.42">         thread: true,</span>
<a href="#l11.43"></a><span id="l11.43">         message: true,</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-        glodaFacets: false,</span>
<a href="#l11.45"></a><span id="l11.45">       },</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+      /**</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+       * The default set of columns to show.  This really should just be for</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+       *  boot-strapping and should be persisted after that...</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+       */</span>
<a href="#l11.50"></a><span id="l11.50">       desiredColumnStates: {</span>
<a href="#l11.51"></a><span id="l11.51">         flaggedCol: {</span>
<a href="#l11.52"></a><span id="l11.52">           visible: true,</span>
<a href="#l11.53"></a><span id="l11.53">         },</span>
<a href="#l11.54"></a><span id="l11.54">         subjectCol: {</span>
<a href="#l11.55"></a><span id="l11.55">           visible: true,</span>
<a href="#l11.56"></a><span id="l11.56">         },</span>
<a href="#l11.57"></a><span id="l11.57">         senderCol: {</span>
<a href="#l11.58"></a><span id="l11.58">           visible: true,</span>
<a href="#l11.59"></a><span id="l11.59">         },</span>
<a href="#l11.60"></a><span id="l11.60">         dateCol: {</span>
<a href="#l11.61"></a><span id="l11.61">           visible: true,</span>
<a href="#l11.62"></a><span id="l11.62">         },</span>
<a href="#l11.63"></a><span id="l11.63">       },</span>
<a href="#l11.64"></a><span id="l11.64">       /**</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-       * Open a new tab whose view is backed by a gloda search.</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+       * Open a new folder-display-style tab showing the contents of a gloda</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+       *  query/collection.  You must pass one of 'query'/'collection'/</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+       *  'conversation'</span>
<a href="#l11.69"></a><span id="l11.69">        *</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-       * @param searchString</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-       * @param facetString</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-       *     - everything:</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-       *     - subject:</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-       *     - involves:</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-       *     - to:</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-       *     - from:</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-       *     - body:</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-       * @param location Either a GlodaFolder or the string &quot;everywhere&quot;.</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+       * @param {GlodaQuery} [aArgs.query] An un-triggered gloda query to use.</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+       *     Alternatively, if you already have a collection, you can pass that</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+       *     instead as 'collection'.</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+       * @param {GlodaCollection} [aArgs.collection] A gloda collection to</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+       *     display.</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+       * @param {GlodaConversation} [aArgs.conversation] A conversation whose</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+       *     messages you want to display.</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+       * @param {GlodaMessage} [aArgs.message] The message to select in the</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+       *     conversation, if provided.</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+       * @param aArgs.title The title to give to the tab.  If this is not user</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+       *     content (a search string, a message subject, etc.), make sure you</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+       *     are using a localized string.</span>
<a href="#l11.91"></a><span id="l11.91">        *</span>
<a href="#l11.92"></a><span id="l11.92">        * XXX This needs to handle opening in the background</span>
<a href="#l11.93"></a><span id="l11.93">        */</span>
<a href="#l11.94"></a><span id="l11.94">       openTab: function(aTab, aArgs) {</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-        // make sure the search string bundle is loaded</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-        getDocumentElements();</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-        aTab.title = gSearchBundle.getFormattedString(&quot;glodaSearchTabTitle&quot;,</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-                                                      [aArgs.searchString]);</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-        aTab.glodaSearchInputValue = aArgs.searchString;</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-        aTab.searchString = aArgs.searchString;</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-        aTab.facetString = aArgs.facetString;</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-        aTab.glodaSynView = new GlodaSyntheticSearchView(aArgs.searchString,</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-                                                         aArgs.facetString,</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-                                                         aArgs.location);</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+        aTab.glodaSynView = new GlodaSyntheticView(aArgs);</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+        aTab.title = aArgs.title;</span>
<a href="#l11.108"></a><span id="l11.108"> </span>
<a href="#l11.109"></a><span id="l11.109">         this.openTab(aTab, false, new MessagePaneDisplayWidget());</span>
<a href="#l11.110"></a><span id="l11.110">         aTab.folderDisplay.show(aTab.glodaSynView);</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+        // XXX persist column states in preferences or session store or other</span>
<a href="#l11.112"></a><span id="l11.112">         aTab.folderDisplay.setColumnStates(aTab.mode.desiredColumnStates);</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-        aTab.folderDisplay.makeActive();</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+        let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+        if (!background)</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+          aTab.folderDisplay.makeActive();</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+        if (&quot;message&quot; in aArgs) {</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+          let hdr = aArgs.message.folderMessage;</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+          if (hdr)</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+            aTab.folderDisplay.selectMessage(hdr);</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+        }</span>
<a href="#l11.123"></a><span id="l11.123">       },</span>
<a href="#l11.124"></a><span id="l11.124">       getBrowser: function(aTab) {</span>
<a href="#l11.125"></a><span id="l11.125">         // If we are currently a thread summary, we want to select the multi</span>
<a href="#l11.126"></a><span id="l11.126">         // message browser rather than the message pane.</span>
<a href="#l11.127"></a><span id="l11.127">         return gMessageDisplay.singleMessageDisplay ?</span>
<a href="#l11.128"></a><span id="l11.128">                document.getElementById(&quot;messagepane&quot;) :</span>
<a href="#l11.129"></a><span id="l11.129">                document.getElementById(&quot;multimessage&quot;);</span>
<a href="#l11.130"></a><span id="l11.130">       }</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineat">@@ -2161,17 +2169,16 @@ let mailTabType = {</span>
<a href="#l11.132"></a><span id="l11.132">    *     the value is true, then the pane is legal.  Omitted pane keys imply</span>
<a href="#l11.133"></a><span id="l11.133">    *     that the pane is illegal.  Keys are:</span>
<a href="#l11.134"></a><span id="l11.134">    *     - folder: The folder (tree) pane.</span>
<a href="#l11.135"></a><span id="l11.135">    *     - thread: The thread pane.</span>
<a href="#l11.136"></a><span id="l11.136">    *     - accountCentral: While it's in a deck with the thread pane, this</span>
<a href="#l11.137"></a><span id="l11.137">    *        is distinct from the thread pane because some other things depend</span>
<a href="#l11.138"></a><span id="l11.138">    *        on whether it's actually the thread pane we are showing.</span>
<a href="#l11.139"></a><span id="l11.139">    *     - message: The message pane.  Required/assumed to be true for now.</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">-   *     - glodaFacets: The gloda search facets pane.</span>
<a href="#l11.141"></a><span id="l11.141">    * @param aVisibleStates A dictionary where each value indicates whether the</span>
<a href="#l11.142"></a><span id="l11.142">    *     pane should be 'visible' (not collapsed).  Only panes that are governed</span>
<a href="#l11.143"></a><span id="l11.143">    *     by splitters are options here.  Keys are:</span>
<a href="#l11.144"></a><span id="l11.144">    *     - folder: The folder (tree) pane.</span>
<a href="#l11.145"></a><span id="l11.145">    *     - message: The message pane.</span>
<a href="#l11.146"></a><span id="l11.146">    */</span>
<a href="#l11.147"></a><span id="l11.147">   _setPaneStates: function mailTabType_setPaneStates(aLegalStates,</span>
<a href="#l11.148"></a><span id="l11.148">                                                      aVisibleStates) {</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineat">@@ -2248,20 +2255,16 @@ let mailTabType = {</span>
<a href="#l11.150"></a><span id="l11.150"> </span>
<a href="#l11.151"></a><span id="l11.151">     // we are responsible for updating the keybinding; view_init takes care of</span>
<a href="#l11.152"></a><span id="l11.152">     //  updating the menu item (on demand)</span>
<a href="#l11.153"></a><span id="l11.153">     let messagePaneToggleKey = document.getElementById(&quot;key_toggleMessagePane&quot;);</span>
<a href="#l11.154"></a><span id="l11.154">     if (aLegalStates.thread)</span>
<a href="#l11.155"></a><span id="l11.155">       messagePaneToggleKey.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l11.156"></a><span id="l11.156">     else</span>
<a href="#l11.157"></a><span id="l11.157">       messagePaneToggleKey.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineminus">-    // -- gloda facets</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-    document.getElementById(&quot;glodaSearchFacets&quot;).hidden =</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-      !aLegalStates.glodaFacets;</span>
<a href="#l11.162"></a><span id="l11.162">   },</span>
<a href="#l11.163"></a><span id="l11.163"> </span>
<a href="#l11.164"></a><span id="l11.164">   showTab: function(aTab) {</span>
<a href="#l11.165"></a><span id="l11.165">     // Set the messagepane as the primary browser for content.</span>
<a href="#l11.166"></a><span id="l11.166">     document.getElementById(&quot;messagepane&quot;).setAttribute(&quot;type&quot;,</span>
<a href="#l11.167"></a><span id="l11.167">                                                         &quot;content-primary&quot;);</span>
<a href="#l11.168"></a><span id="l11.168"> </span>
<a href="#l11.169"></a><span id="l11.169">     aTab.folderDisplay.makeActive();</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineat">@@ -2294,52 +2297,16 @@ let mailTabType = {</span>
<a href="#l11.171"></a><span id="l11.171">   doCommand: function(aTab, aCommand) {</span>
<a href="#l11.172"></a><span id="l11.172">     DefaultController.doCommand(aCommand, aTab);</span>
<a href="#l11.173"></a><span id="l11.173">   },</span>
<a href="#l11.174"></a><span id="l11.174"> </span>
<a href="#l11.175"></a><span id="l11.175">   onEvent: function(aTab, aEvent) {</span>
<a href="#l11.176"></a><span id="l11.176">     DefaultController.onEvent(aEvent);</span>
<a href="#l11.177"></a><span id="l11.177">   }</span>
<a href="#l11.178"></a><span id="l11.178"> };</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-/**</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">- * The glodaSearch tab mode has a UI widget outside of the mailTabType's</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineminus">- *  display panel, the #glodaSearchInput textbox.  This means we need to use a</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">- *  tab monitor so that we can appropriately update the contents of the textbox.</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">- * Every time a tab is changed, we save the state of the text box and restore</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">- *  its previous value for the tab we are switching to, as well as whether this</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">- *  value is a change to the currently-used value (if it is a glodaSearch) tab.</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">- *  The behaviour rationale for this is that the glodaSearchInput is like the</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineminus">- *  URL bar.  When you are on a glodaSearch tab, we need to show you your</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineminus">- *  current value, including any &quot;uncommitted&quot; (you haven't hit enter yet)</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">- *  changes.  It's not entirely clear that imitating this behaviour on</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">- *  non-glodaSearch tabs makes a lot of sense, but it is consistent, so we do</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">- *  so.  The counter-example to this choice is the search box in firefox, but</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">- *  it never updates when you switch tabs, so it is arguably less of a fit.</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">- */</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineminus">-var glodaSearchTabMonitor = {</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineminus">-  onTabTitleChanged: function() {},</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineminus">-  onTabSwitched: function glodaSearchTabMonitor_onTabSwitch(aTab, aOldTab) {</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineminus">-    let inputNode = document.getElementById(&quot;glodaSearchInput&quot;);</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineminus">-    if (!inputNode)</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineminus">-      return;</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineminus">-    // save the current search field value</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-    if (aOldTab)</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-      aOldTab.glodaSearchInputValue = inputNode.value;</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineminus">-    // load (or clear if there is none) the persisted search field value</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-    inputNode.value = aTab.glodaSearchInputValue || &quot;&quot;;</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-    // If the mode is glodaSearch and the search is unchanged, then we want to</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineminus">-    //  set the icon state of the input box to be the 'clear' icon.</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineminus">-    if (aTab.mode.name == &quot;glodaSearch&quot;) {</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineminus">-      if (aTab.searchString == aTab.glodaSearchInputValue)</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-        inputNode._searchIcons.selectedIndex = 1;</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineminus">-    }</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineminus">-  }</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineminus">-};</span>
<a href="#l11.215"></a><span id="l11.215"> </span>
<a href="#l11.216"></a><span id="l11.216"> </span>
<a href="#l11.217"></a><span id="l11.217"> function MsgOpenNewWindowForFolder(folderURI, msgKeyToSelect)</span>
<a href="#l11.218"></a><span id="l11.218"> {</span>
<a href="#l11.219"></a><span id="l11.219">   if (folderURI) {</span>
<a href="#l11.220"></a><span id="l11.220">     window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l11.221"></a><span id="l11.221">                       &quot;chrome,all,dialog=no&quot;, folderURI, msgKeyToSelect);</span>
<a href="#l11.222"></a><span id="l11.222">     return;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/base/content/messenger.css</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/base/content/messenger.css</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -159,29 +159,25 @@ searchterm {</span>
<a href="#l12.4"></a><span id="l12.4"> .ruleactiontarget[type=&quot;replytomessage&quot;] {</span>
<a href="#l12.5"></a><span id="l12.5">   -moz-binding: url(&quot;chrome://messenger/content/searchWidgets.xml#ruleactiontarget-replyto&quot;);</span>
<a href="#l12.6"></a><span id="l12.6"> }</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> dummy.usesMailWidgets {</span>
<a href="#l12.9"></a><span id="l12.9">   -moz-binding: url(&quot;chrome://messenger/content/mailWidgets.xml#dummy&quot;);</span>
<a href="#l12.10"></a><span id="l12.10"> }</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-#glodaSearchInput {</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+#searchInput {</span>
<a href="#l12.14"></a><span id="l12.14">   -moz-binding: url(&quot;chrome://messenger/content/search.xml#glodaSearch&quot;);</span>
<a href="#l12.15"></a><span id="l12.15"> }</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-#glodaSearchFacets {</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-  -moz-binding: url(&quot;chrome://messenger/content/search.xml#glodaFacets&quot;);</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-}</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-#searchInput {</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+#oldsearchInput {</span>
<a href="#l12.23"></a><span id="l12.23">   -moz-binding: url(&quot;chrome://messenger/content/search.xml#searchbar&quot;);</span>
<a href="#l12.24"></a><span id="l12.24"> }</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-#quick-search-button {</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+.quick-search-button {</span>
<a href="#l12.28"></a><span id="l12.28">   -moz-binding: url(&quot;chrome://messenger/content/search.xml#searchBarDropMarker&quot;);</span>
<a href="#l12.29"></a><span id="l12.29">   cursor: default;</span>
<a href="#l12.30"></a><span id="l12.30">   -moz-user-focus: none;</span>
<a href="#l12.31"></a><span id="l12.31"> }</span>
<a href="#l12.32"></a><span id="l12.32"> </span>
<a href="#l12.33"></a><span id="l12.33"> .quick-search-clearbutton{</span>
<a href="#l12.34"></a><span id="l12.34">   cursor: default;</span>
<a href="#l12.35"></a><span id="l12.35">   -moz-user-focus: none;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/base/content/messenger.xul</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/base/content/messenger.xul</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -35,16 +35,18 @@</span>
<a href="#l13.4"></a><span id="l13.4"> # decision by deleting the provisions above and replace them with the notice</span>
<a href="#l13.5"></a><span id="l13.5"> # and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l13.6"></a><span id="l13.6"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l13.7"></a><span id="l13.7"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l13.8"></a><span id="l13.8"> #</span>
<a href="#l13.9"></a><span id="l13.9"> # ***** END LICENSE BLOCK *****</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> &lt;?xml-stylesheet href=&quot;chrome://messenger/skin/mailWindow1.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://gloda/content/glodacomplete.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+</span>
<a href="#l13.14"></a><span id="l13.14"> </span>
<a href="#l13.15"></a><span id="l13.15"> &lt;?xul-overlay href=&quot;chrome://communicator/content/utilityOverlay.xul&quot;?&gt;</span>
<a href="#l13.16"></a><span id="l13.16"> &lt;?xul-overlay href=&quot;chrome://messenger/content/msgHdrViewOverlay.xul&quot;?&gt;</span>
<a href="#l13.17"></a><span id="l13.17"> &lt;?xul-overlay href=&quot;chrome://messenger/content/mailWindowOverlay.xul&quot;?&gt;</span>
<a href="#l13.18"></a><span id="l13.18"> &lt;?xul-overlay href=&quot;chrome://messenger/content/extraCustomizeItems.xul&quot;?&gt;</span>
<a href="#l13.19"></a><span id="l13.19"> &lt;?xul-overlay href=&quot;chrome://messenger/content/mailOverlay.xul&quot;?&gt;</span>
<a href="#l13.20"></a><span id="l13.20"> &lt;?xul-overlay href=&quot;chrome://messenger/content/editContactOverlay.xul&quot;?&gt;</span>
<a href="#l13.21"></a><span id="l13.21"> &lt;?xul-overlay href=&quot;chrome://messenger/content/specialTabs.xul&quot;?&gt;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -85,22 +87,23 @@</span>
<a href="#l13.23"></a><span id="l13.23"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/widgetglue.js&quot;/&gt;</span>
<a href="#l13.24"></a><span id="l13.24"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/commandglue.js&quot;/&gt;</span>
<a href="#l13.25"></a><span id="l13.25"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/shareglue.js&quot;/&gt;</span>
<a href="#l13.26"></a><span id="l13.26"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/msgViewNavigation.js&quot;/&gt;</span>
<a href="#l13.27"></a><span id="l13.27"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailWindow.js&quot;/&gt;</span>
<a href="#l13.28"></a><span id="l13.28"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/selectionsummaries.js&quot;/&gt;</span>
<a href="#l13.29"></a><span id="l13.29"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/msgMail3PaneWindow.js&quot;/&gt;</span>
<a href="#l13.30"></a><span id="l13.30"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/specialTabs.js&quot;/&gt;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+&lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/glodaFacetTab.js&quot;/&gt;</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+&lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/searchBar.js&quot;/&gt;</span>
<a href="#l13.33"></a><span id="l13.33"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mail3PaneWindowCommands.js&quot;/&gt;</span>
<a href="#l13.34"></a><span id="l13.34"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://global/content/contentAreaUtils.js&quot;/&gt;</span>
<a href="#l13.35"></a><span id="l13.35"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://communicator/content/nsContextMenu.js&quot;/&gt;</span>
<a href="#l13.36"></a><span id="l13.36"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/mailContextMenus.js&quot;/&gt;</span>
<a href="#l13.37"></a><span id="l13.37"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/accountUtils.js&quot;/&gt;</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-&lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/searchBar.js&quot;/&gt;</span>
<a href="#l13.39"></a><span id="l13.39"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/folderPane.js&quot;/&gt;</span>
<a href="#l13.40"></a><span id="l13.40"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/phishingDetector.js&quot;/&gt;</span>
<a href="#l13.41"></a><span id="l13.41"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://communicator/content/contentAreaClick.js&quot;/&gt;</span>
<a href="#l13.42"></a><span id="l13.42"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://global/content/nsDragAndDrop.js&quot;/&gt;</span>
<a href="#l13.43"></a><span id="l13.43"> &lt;script type=&quot;application/x-javascript&quot; src=&quot;chrome://messenger/content/editContactOverlay.js&quot;/&gt;</span>
<a href="#l13.44"></a><span id="l13.44"> </span>
<a href="#l13.45"></a><span id="l13.45"> </span>
<a href="#l13.46"></a><span id="l13.46"> &lt;!-- move needed functions into a single js file --&gt;</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineat">@@ -339,26 +342,16 @@</span>
<a href="#l13.48"></a><span id="l13.48">                         &lt;treecol id=&quot;totalCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l13.49"></a><span id="l13.49">                                  label=&quot;&amp;totalColumn.label;&quot; tooltiptext=&quot;&amp;totalColumn.tooltip;&quot;/&gt;</span>
<a href="#l13.50"></a><span id="l13.50">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l13.51"></a><span id="l13.51">                         &lt;treecol id=&quot;locationCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l13.52"></a><span id="l13.52">                                  label=&quot;&amp;locationColumn.label;&quot; tooltiptext=&quot;&amp;locationColumn.tooltip;&quot;/&gt;</span>
<a href="#l13.53"></a><span id="l13.53">                         &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l13.54"></a><span id="l13.54">                         &lt;treecol id=&quot;idCol&quot; persist=&quot;width&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l13.55"></a><span id="l13.55">                                  label=&quot;&amp;idColumn.label;&quot; tooltiptext=&quot;&amp;idColumn.tooltip;&quot;/&gt;</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-                        &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-                        &lt;treecol id=&quot;glodaWhyCol&quot; persist=&quot;width&quot; flex=&quot;1&quot;</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-                                 hidden=&quot;true&quot; ignoreincolumnpicker=&quot;true&quot;</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-                                 label=&quot;&amp;glodaWhyColumn.label;&quot;</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-                                 tooltiptext=&quot;&amp;glodaWhyColumn.tooltip;&quot;/&gt;</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-                        &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-                        &lt;treecol id=&quot;glodaScoreCol&quot; persist=&quot;width&quot; flex=&quot;1&quot;</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-                                 hidden=&quot;true&quot; ignoreincolumnpicker=&quot;true&quot;</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-                                 label=&quot;&amp;glodaScoreColumn.label;&quot;</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-                                 tooltiptext=&quot;&amp;glodaScoreColumn.tooltip;&quot;/&gt;</span>
<a href="#l13.66"></a><span id="l13.66">                       &lt;/treecols&gt;</span>
<a href="#l13.67"></a><span id="l13.67">                     &lt;treechildren ondraggesture=&quot;ThreadPaneOnDragStart(event);&quot;</span>
<a href="#l13.68"></a><span id="l13.68">                                   ondragover=&quot;ThreadPaneOnDragOver(event);&quot;</span>
<a href="#l13.69"></a><span id="l13.69">                                   ondrop=&quot;ThreadPaneOnDrop(event);&quot;/&gt;</span>
<a href="#l13.70"></a><span id="l13.70">                   &lt;/tree&gt;</span>
<a href="#l13.71"></a><span id="l13.71">                  &lt;/vbox&gt;</span>
<a href="#l13.72"></a><span id="l13.72">                 &lt;/hbox&gt;</span>
<a href="#l13.73"></a><span id="l13.73">                 &lt;!-- extensions may overlay in additional panels; don't assume that there are only 2! --&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -274,18 +274,21 @@ function OnLoadMessenger()</span>
<a href="#l14.4"></a><span id="l14.4">   // Do this before LoadPostAccountWizard since that code selects the first</span>
<a href="#l14.5"></a><span id="l14.5">   //  folder for display, and we want gFolderDisplay setup and ready to handle</span>
<a href="#l14.6"></a><span id="l14.6">   //  that event chain.</span>
<a href="#l14.7"></a><span id="l14.7">   // Also, we definitely need to register the tab type prior to the call to</span>
<a href="#l14.8"></a><span id="l14.8">   //  specialTabs.openSpecialTabsOnStartup below.</span>
<a href="#l14.9"></a><span id="l14.9">   let tabmail = document.getElementById('tabmail');</span>
<a href="#l14.10"></a><span id="l14.10">   if (tabmail)</span>
<a href="#l14.11"></a><span id="l14.11">   {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+    // mailTabType is defined in mailWindowOverlay.js</span>
<a href="#l14.13"></a><span id="l14.13">     tabmail.registerTabType(mailTabType);</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-    tabmail.registerTabMonitor(glodaSearchTabMonitor);</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+    // glodaFacetTab* in glodaFacetTab.js</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+    tabmail.registerTabType(glodaFacetTabType);</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+    tabmail.registerTabMonitor(glodaFacetTabMonitor);</span>
<a href="#l14.18"></a><span id="l14.18">     tabmail.registerTabMonitor(QuickSearchTabMonitor);</span>
<a href="#l14.19"></a><span id="l14.19">     tabmail.registerTabMonitor(statusMessageCountsMonitor);</span>
<a href="#l14.20"></a><span id="l14.20">     tabmail.openFirstTab();</span>
<a href="#l14.21"></a><span id="l14.21">   }</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23">   // verifyAccounts returns true if the callback won't be called</span>
<a href="#l14.24"></a><span id="l14.24">   // We also don't want the account wizard to open if any sort of account exists</span>
<a href="#l14.25"></a><span id="l14.25">   if (verifyAccounts(LoadPostAccountWizard, false))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/base/content/search.xml</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/base/content/search.xml</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -18,16 +18,18 @@</span>
<a href="#l15.4"></a><span id="l15.4">   -</span>
<a href="#l15.5"></a><span id="l15.5">   - The Initial Developer of the Original Code is</span>
<a href="#l15.6"></a><span id="l15.6">   - Netscape Communications Corporation.</span>
<a href="#l15.7"></a><span id="l15.7">   - Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l15.8"></a><span id="l15.8">   - the Initial Developer. All Rights Reserved.</span>
<a href="#l15.9"></a><span id="l15.9">   -</span>
<a href="#l15.10"></a><span id="l15.10">   - Contributor(s):</span>
<a href="#l15.11"></a><span id="l15.11">   -   Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+  -   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  -   David Ascher &lt;dascher@mozillamessaging.com&gt;</span>
<a href="#l15.14"></a><span id="l15.14">   -</span>
<a href="#l15.15"></a><span id="l15.15">   - Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l15.16"></a><span id="l15.16">   - either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l15.17"></a><span id="l15.17">   - or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l15.18"></a><span id="l15.18">   - in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l15.19"></a><span id="l15.19">   - of those above. If you wish to allow use of your version of this file only</span>
<a href="#l15.20"></a><span id="l15.20">   - under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l15.21"></a><span id="l15.21">   - use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -47,180 +49,308 @@</span>
<a href="#l15.23"></a><span id="l15.23"> &lt;bindings id=&quot;SearchBindings&quot;</span>
<a href="#l15.24"></a><span id="l15.24">    xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l15.25"></a><span id="l15.25">    xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l15.26"></a><span id="l15.26">    xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l15.27"></a><span id="l15.27">    xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29">   &lt;!--</span>
<a href="#l15.30"></a><span id="l15.30">     - The glodaSearch binding implements a gloda-backed search mechanism.  The</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-    -  actual search logic comes from the glodaSearch tab mode in the</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-    -  mailTabType definition.  This binding serves as a means to display and </span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-    -  alter the current search query if a &quot;glodaSearch&quot; tab is displayed, or</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-    -  enter a search query and spawn a new &quot;glodaSearch&quot; tab if one is</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-    -  currently not displayed.  The &quot;glodaFacets&quot; binding also is used to</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-    -  display/modify the parameters of the search when on a &quot;glodaSearch&quot; tab.</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+    -  actual search logic comes from the glodaFacet tab mode in the</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+    -  glodaFacetTabType definition.  This binding serves as a means to display</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+    -  and alter the current search query if a &quot;glodaFacet&quot; tab is displayed,</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+    -  or enter a search query and spawn a new &quot;glodaFacet&quot; tab if one is</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+    -  currently not displayed.</span>
<a href="#l15.42"></a><span id="l15.42">     --&gt;</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-  &lt;binding id=&quot;glodaSearch&quot; extends=&quot;chrome://global/content/bindings/textbox.xml#search-textbox&quot;&gt;</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+  &lt;binding id=&quot;glodaSearch&quot; extends=&quot;chrome://global/content/bindings/autocomplete.xml#autocomplete&quot;&gt;</span>
<a href="#l15.45"></a><span id="l15.45">     &lt;resources&gt;</span>
<a href="#l15.46"></a><span id="l15.46">       &lt;stylesheet src=&quot;chrome://messenger/skin/searchBox.css&quot;/&gt;</span>
<a href="#l15.47"></a><span id="l15.47">     &lt;/resources&gt;</span>
<a href="#l15.48"></a><span id="l15.48"> </span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+    &lt;content&gt;</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+      &lt;xul:button anonid=&quot;quick-search-button&quot; class=&quot;quick-search-button&quot; type=&quot;menu&quot; chromedir=&quot;&amp;locale.dir;&quot;&gt;</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+        &lt;xul:menupopup anonid=&quot;quick-search-menupopup&quot;</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+                   class=&quot;quick-search-menupopup&quot;</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+                   persist=&quot;value&quot;</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+                   onpopupshowing=&quot;this.parentNode.parentNode.updatePopup();&quot;</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+                   popupalign=&quot;topleft&quot;</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+                   popupanchor=&quot;bottomleft&quot;&gt;</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+          &lt;xul:menuitem anonid=&quot;searchGlobalMenu&quot;</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+                    class=&quot;quick-search-menu&quot;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+                    value=&quot;global&quot;</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+                    label=&quot;&amp;searchEverywhere.label;&quot;</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+                    type=&quot;radio&quot;</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+                    oncommand=&quot;this.parentNode.parentNode.parentNode.changeMode(this)&quot;/&gt;</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+          &lt;xul:menuseparator/&gt;</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+        &lt;/xul:menupopup&gt;</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+      &lt;/xul:button&gt;</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+      &lt;xul:hbox class=&quot;quick-search-textbox textbox-input-box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+        &lt;html:input class=&quot;textbox-input&quot; flex=&quot;1&quot; anonid=&quot;input&quot; allowevents=&quot;true&quot;</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+                    xbl:inherits=&quot;onfocus,onblur,oninput,value,type,maxlength,disabled,size,readonly,tabindex,accesskey&quot;/&gt;</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+      &lt;/xul:hbox&gt;</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+      &lt;xul:toolbarbutton anonid=&quot;quick-search-clearbutton&quot; xbl:inherits=&quot;&quot;</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+                         disabled=&quot;true&quot; class=&quot;quick-search-clearbutton&quot;</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+                         onclick=&quot;this.parentNode.value = ''; this.parentNode.select(); return false;&quot; </span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+                         chromedir=&quot;&amp;locale.dir;&quot;/&gt;</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+                         &lt;!--XXX update search if not global--&gt;</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+    &lt;/content&gt;</span>
<a href="#l15.77"></a><span id="l15.77">     &lt;handlers&gt;</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-      &lt;handler event=&quot;command&quot;&gt;&lt;![CDATA[</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-        if (this.value) {</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-          let searchString = this.value;</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-          let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineminus">-          // If the current tab is a gloda search tab, reset the value</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-          //  to the initial search value.  Otherwise, clear it.  This</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-          //  is the value that is going to be saved with the current</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-          //  tab when we switch back to it next.</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineminus">-          if (tabmail.currentTabInfo.mode.name == &quot;glodaSearch&quot;)</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineminus">-            this.value = tabmail.currentTabInfo.searchString;</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-          else</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-            this.value = &quot;&quot;;</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-          // open a new tab with our dude</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-          tabmail.openTab(&quot;glodaSearch&quot;, {searchString: searchString,</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-              facetString: &quot;everything&quot;, locationString: &quot;everywhere&quot;});</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+      &lt;handler event=&quot;input&quot;&gt;</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+        &lt;![CDATA[</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+        try {</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+          if (this.searchMode != &quot;global&quot;) { // it's a quick search</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+            let dis = this;</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+            clearTimeout(this.timeoutHandler);</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+            this.timeoutHandler = setTimeout(this.onTimeout, this.timeout, dis);</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+          }</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+        } catch (e) {</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+          logException(e);</span>
<a href="#l15.103"></a><span id="l15.103">         }</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineminus">-      ]]&gt;&lt;/handler&gt;</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineplus">+        ]]&gt;</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineplus">+      &lt;/handler&gt;</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+      &lt;!-- For the next two, we need to get in on the bubbling phase, as</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+           otherwise we'll be doing searches when autocomplete results are</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineplus">+           being selected. --&gt;</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_ENTER&quot;</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineplus">+        phase=&quot;bubbling&quot; action=&quot;return this.doSearch();&quot;/&gt;</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineplus">+      &lt;handler event=&quot;keypress&quot; keycode=&quot;VK_RETURN&quot;</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+        phase=&quot;bubbling&quot; action=&quot;try {this.doSearch();} catch (e) { logException(e);} return true;&quot;/&gt;</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+      &lt;handler event=&quot;input&quot;&gt;</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+        &lt;![CDATA[ </span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+          if (!this.value) </span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+            this.clearButtonHidden = true;</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+          else </span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+            this.clearButtonHidden = false;</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineplus">+        ]]&gt;&lt;/handler&gt;</span>
<a href="#l15.121"></a><span id="l15.121">     &lt;/handlers&gt;</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-  &lt;/binding&gt;</span>
<a href="#l15.123"></a><span id="l15.123"> </span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-  &lt;!--</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-    - The glodaFacets binding is used to display additional search constraints</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-    -  on a &quot;glodaSearch&quot; tab's gloda-backed search.  Because we live in the</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-    -  &quot;mailContent&quot; panel reused by the &quot;glodaSearch&quot; tab mode, we are always</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-    -  present, even when we should not be displayed (namely for &quot;folder&quot; and</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-    -  &quot;message&quot; tab modes).  We leave it up to the mailTabType and glodaSearch</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-    -  tab mode to ensure that we are shown/hidden at the right times.  (We</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-    -  could do this ourselves as a tabmail tab monitor, but it is more</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineminus">-    -  intuitive to have our behaviour/relationship made explicit.)</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineminus">-    --&gt;</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineminus">-  &lt;binding id=&quot;glodaFacets&quot;&gt;</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineminus">-    &lt;resources&gt;</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-      &lt;stylesheet src=&quot;chrome://messenger/skin/searchBox.css&quot;/&gt;</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-    &lt;/resources&gt;</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineminus">-    &lt;content orientation=&quot;horizontal&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineminus">-      &lt;xul:label control=&quot;glodaFacetType&quot; value=&quot;&amp;glodaSearchBar.facet.label;&quot;/&gt;</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineminus">-      &lt;xul:menulist id=&quot;glodaFacetType&quot;&gt;</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineminus">-        &lt;xul:menupopup&gt;</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineminus">-          &lt;xul:menuitem label=&quot;&amp;glodaSearchFacet.everything.label;&quot;</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineminus">-                        value=&quot;everything&quot;/&gt;</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineminus">-          &lt;xul:menuitem label=&quot;&amp;glodaSearchFacet.subject.label;&quot;</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-                        value=&quot;subject&quot;/&gt;</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineminus">-          &lt;xul:menuitem label=&quot;&amp;glodaSearchFacet.involves.label;&quot;</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-                        value=&quot;involves&quot;/&gt;</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineminus">-          &lt;xul:menuitem label=&quot;&amp;glodaSearchFacet.to.label;&quot;</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-                        value=&quot;to&quot;/&gt;</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineminus">-          &lt;xul:menuitem label=&quot;&amp;glodaSearchFacet.from.label;&quot;</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineminus">-                        value=&quot;from&quot;/&gt;</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineminus">-          &lt;xul:menuitem label=&quot;&amp;glodaSearchFacet.body.label;&quot;</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineminus">-                        value=&quot;body&quot;/&gt;</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineminus">-        &lt;/xul:menupopup&gt;</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineminus">-      &lt;/xul:menulist&gt;</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineminus">-      &lt;xul:label control=&quot;glodaFacetLocation&quot;</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineminus">-                 value=&quot;&amp;glodaSearchBar.location.label;&quot;/&gt;</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineminus">-      &lt;xul:menulist id=&quot;glodaFacetLocation&quot; anonid=&quot;glodaFacetLocation&quot;&gt;</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineminus">-        &lt;xul:menupopup&gt;</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineminus">-          &lt;xul:menuitem label=&quot;&amp;glodaSearchFacet.everywhere.label;&quot; value=&quot;everywhere&quot;/&gt;</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineminus">-          &lt;xul:menuitem anonid=&quot;currentFolder&quot; label=&quot;&quot; value=&quot;currentFolder&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineminus">-          &lt;xul:menu label=&quot;&amp;glodaSearchFacet.folder.label;&quot;&gt;</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineminus">-            &lt;xul:menupopup type=&quot;folder&quot;/&gt;</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineminus">-          &lt;/xul:menu&gt;</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineminus">-        &lt;/xul:menupopup&gt;</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">-      &lt;/xul:menulist&gt;</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineminus">-    &lt;/content&gt;</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineplus">+    &lt;implementation implements=&quot;nsIObserver&quot;&gt;</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineplus">+      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineplus">+        this.build();</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineplus">+      ]]&gt;&lt;/constructor&gt;</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineplus">+      &lt;method name=&quot;onTimeout&quot;&gt;</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineplus">+        &lt;parameter name=&quot;dis&quot;/&gt;</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineplus">+        try {</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineplus">+          dis.doSearch();</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineplus">+        } catch (e) {</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineplus">+          logException(e);</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineplus">+        }</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineplus">+        ]]&gt;</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineplus">+      &lt;method name=&quot;updatePopup&quot;&gt;</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineplus">+        try {</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineplus">+          // disable the create virtual folder menu item if the current radio</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineplus">+          // value is set to Find in message since you can't really  create a VF from find</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineplus">+          // in message</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineplus">+          if (this.searchMode == &quot;global&quot; || this.value == &quot;&quot;)</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineplus">+            this.saveAsVirtualFolder.setAttribute('disabled', 'true');</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineplus">+          else</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineplus">+            this.saveAsVirtualFolder.removeAttribute('disabled');</span>
<a href="#l15.193"></a><span id="l15.193"> </span>
<a href="#l15.194"></a><span id="l15.194" class="difflineminus">-    &lt;implementation&gt;</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineminus">-      &lt;constructor&gt;</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineminus">-        &lt;![CDATA[</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineminus">-          this._facetTypeNode =</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineminus">-            document.getAnonymousElementByAttribute(this, &quot;id&quot;,</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineminus">-                                                    &quot;glodaFacetType&quot;);</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineminus">-          this._facetLocationNode =</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineminus">-            document.getAnonymousElementByAttribute(this, &quot;id&quot;,</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineminus">-                                                    &quot;glodaFacetLocation&quot;);</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineminus">-          this._currentFolderNode =</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineminus">-            document.getAnonymousElementByAttribute(this, &quot;anonid&quot;,</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineminus">-                                                    &quot;currentFolder&quot;);</span>
<a href="#l15.206"></a><span id="l15.206" class="difflineplus">+          //let hideQuickSearchModes = this.searchMode == &quot;global&quot; ? &quot;true&quot; : &quot;false&quot;;</span>
<a href="#l15.207"></a><span id="l15.207" class="difflineplus">+          //for each (let child in this.menupopup.childNodes) {</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineplus">+          //  if (child.hasAttribute(&quot;quicksearch&quot;)) {</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineplus">+          //    child.setAttribute(&quot;collapsed&quot;, hideQuickSearchModes)</span>
<a href="#l15.210"></a><span id="l15.210" class="difflineplus">+          //  }</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineplus">+          //}</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineplus">+        } catch (e) {</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineplus">+          logException(e);</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineplus">+        }</span>
<a href="#l15.215"></a><span id="l15.215">         ]]&gt;</span>
<a href="#l15.216"></a><span id="l15.216" class="difflineminus">-      &lt;/constructor&gt;</span>
<a href="#l15.217"></a><span id="l15.217" class="difflineminus">-      &lt;method name=&quot;updateStateFromCurrentTab&quot;&gt;</span>
<a href="#l15.218"></a><span id="l15.218" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l15.219"></a><span id="l15.219" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l15.220"></a><span id="l15.220" class="difflineplus">+      &lt;method name=&quot;build&quot;&gt;</span>
<a href="#l15.221"></a><span id="l15.221">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineminus">-        /**</span>
<a href="#l15.223"></a><span id="l15.223" class="difflineminus">-         * Update our display state to match the state of the current tab.</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineminus">-         */</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineminus">-          let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineminus">-          let tabInfo = tabMail.currentTabInfo;</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineplus">+        const Cu = Components.utils;</span>
<a href="#l15.228"></a><span id="l15.228" class="difflineplus">+        Cu.import(&quot;resource://gre/modules/errUtils.js&quot;);</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineplus">+        try {</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineplus">+          Cu.import(&quot;resource://app/modules/StringBundle.js&quot;);</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineplus">+          Cu.import(&quot;resource://app/modules/quickSearchManager.js&quot;);</span>
<a href="#l15.232"></a><span id="l15.232" class="difflineplus">+  </span>
<a href="#l15.233"></a><span id="l15.233" class="difflineplus">+          this.glodaCompleter =</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineplus">+            Components.classes[&quot;@mozilla.org/autocomplete/search;1?name=gloda&quot;].</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineplus">+                      getService(). //Components.interfaces.nsIAutoCompleteSearch)</span>
<a href="#l15.236"></a><span id="l15.236" class="difflineplus">+                      wrappedJSObject;</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineplus">+  </span>
<a href="#l15.238"></a><span id="l15.238" class="difflineplus">+          var observerSvc = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineplus">+                            .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineplus">+          observerSvc.addObserver(this, &quot;autocomplete-did-enter-text&quot;, false);</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineplus">+  </span>
<a href="#l15.242"></a><span id="l15.242" class="difflineplus">+          this.quickSearchStrings = new StringBundle(&quot;chrome://messenger/locale/quickSearch.properties&quot;);</span>
<a href="#l15.243"></a><span id="l15.243" class="difflineplus">+  </span>
<a href="#l15.244"></a><span id="l15.244" class="difflineplus">+          let quickSearchModes = QuickSearchManager.getSearchModes();</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineplus">+          for (let i = 0; i &lt; quickSearchModes.length; i++) {</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineplus">+            let searchMode = quickSearchModes[i];</span>
<a href="#l15.247"></a><span id="l15.247" class="difflineplus">+            let value = searchMode[&quot;value&quot;];</span>
<a href="#l15.248"></a><span id="l15.248" class="difflineplus">+            let label = searchMode[&quot;label&quot;];</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineplus">+            let menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l15.250"></a><span id="l15.250" class="difflineplus">+            menuitem.setAttribute(&quot;value&quot;, String(value));</span>
<a href="#l15.251"></a><span id="l15.251" class="difflineplus">+            menuitem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l15.252"></a><span id="l15.252" class="difflineplus">+            menuitem.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l15.253"></a><span id="l15.253" class="difflineplus">+            menuitem.setAttribute(&quot;quicksearch&quot;, &quot;true&quot;);</span>
<a href="#l15.254"></a><span id="l15.254" class="difflineplus">+            menuitem.setAttribute(&quot;oncommand&quot;, &quot;this.parentNode.parentNode.parentNode.changeMode(this)&quot;);</span>
<a href="#l15.255"></a><span id="l15.255" class="difflineplus">+            this.menupopup.appendChild(menuitem);</span>
<a href="#l15.256"></a><span id="l15.256" class="difflineplus">+          }</span>
<a href="#l15.257"></a><span id="l15.257" class="difflineplus">+          </span>
<a href="#l15.258"></a><span id="l15.258" class="difflineplus">+          let separator = document.createElement(&quot;menuseparator&quot;);</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineplus">+          this.menupopup.appendChild(separator);</span>
<a href="#l15.260"></a><span id="l15.260" class="difflineplus">+          let saveAsVF = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l15.261"></a><span id="l15.261" class="difflineplus">+          saveAsVF.setAttribute(&quot;anonid&quot;, &quot;quick-search-save-as-virtual-folder&quot;);</span>
<a href="#l15.262"></a><span id="l15.262" class="difflineplus">+          saveAsVF.setAttribute(&quot;label&quot;, this.quickSearchStrings.get(&quot;saveAsVirtualFolder.label&quot;));</span>
<a href="#l15.263"></a><span id="l15.263" class="difflineplus">+          saveAsVF.setAttribute(&quot;oncommand&quot;,</span>
<a href="#l15.264"></a><span id="l15.264" class="difflineplus">+                                &quot;gFolderTreeController.newVirtualFolder(this.parentNode.parentNode.parentNode.value,\</span>
<a href="#l15.265"></a><span id="l15.265" class="difflineplus">+                                gFolderDisplay.view.search.session.searchTerms);&quot;);</span>
<a href="#l15.266"></a><span id="l15.266"> </span>
<a href="#l15.267"></a><span id="l15.267" class="difflineminus">-          this._facetTypeNode.value = tabInfo.facetString;</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineminus">-          if (typeof(tabInfo.location) == &quot;string&quot;)</span>
<a href="#l15.269"></a><span id="l15.269" class="difflineminus">-            this._facetLocationNode.value = tabInfo.location;</span>
<a href="#l15.270"></a><span id="l15.270" class="difflineplus">+          this.menupopup.appendChild(saveAsVF);</span>
<a href="#l15.271"></a><span id="l15.271" class="difflineplus">+          this.updateSaveItem();</span>
<a href="#l15.272"></a><span id="l15.272" class="difflineplus">+        } catch (e) {</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineplus">+          logException(e);</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineplus">+        }</span>
<a href="#l15.275"></a><span id="l15.275">         ]]&gt;&lt;/body&gt;</span>
<a href="#l15.276"></a><span id="l15.276">       &lt;/method&gt;</span>
<a href="#l15.277"></a><span id="l15.277" class="difflineminus">-      &lt;method name=&quot;setLocationFacetToFolder&quot;&gt;</span>
<a href="#l15.278"></a><span id="l15.278" class="difflineplus">+</span>
<a href="#l15.279"></a><span id="l15.279" class="difflineplus">+      &lt;method name=&quot;observe&quot;&gt;</span>
<a href="#l15.280"></a><span id="l15.280" class="difflineplus">+      &lt;parameter name=&quot;aSubject&quot;/&gt;</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineplus">+      &lt;parameter name=&quot;aTopic&quot;/&gt;</span>
<a href="#l15.282"></a><span id="l15.282" class="difflineplus">+      &lt;parameter name=&quot;aData&quot;/&gt;</span>
<a href="#l15.283"></a><span id="l15.283">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.284"></a><span id="l15.284" class="difflineminus">-        /**</span>
<a href="#l15.285"></a><span id="l15.285" class="difflineminus">-         * Update our display state to match the state of the current tab.</span>
<a href="#l15.286"></a><span id="l15.286" class="difflineminus">-         */</span>
<a href="#l15.287"></a><span id="l15.287" class="difflineminus">-          let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l15.288"></a><span id="l15.288" class="difflineminus">-          let tabInfo = tabMail.currentTabInfo;</span>
<a href="#l15.289"></a><span id="l15.289" class="difflineplus">+        try {</span>
<a href="#l15.290"></a><span id="l15.290" class="difflineplus">+          if (aTopic == &quot;autocomplete-did-enter-text&quot;) {</span>
<a href="#l15.291"></a><span id="l15.291" class="difflineplus">+            let selectedIndex = this.autocompletePopup.selectedIndex;</span>
<a href="#l15.292"></a><span id="l15.292" class="difflineplus">+            let row = this.glodaCompleter.curResult.getObjectAt(selectedIndex);</span>
<a href="#l15.293"></a><span id="l15.293" class="difflineplus">+            if (row == null) {</span>
<a href="#l15.294"></a><span id="l15.294" class="difflineplus">+              this.applyConstraints();</span>
<a href="#l15.295"></a><span id="l15.295" class="difflineplus">+              return;</span>
<a href="#l15.296"></a><span id="l15.296" class="difflineplus">+            }</span>
<a href="#l15.297"></a><span id="l15.297" class="difflineplus">+            let theQuery = Gloda.newQuery(Gloda.NOUN_MESSAGE);</span>
<a href="#l15.298"></a><span id="l15.298" class="difflineplus">+            let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l15.299"></a><span id="l15.299" class="difflineplus">+            if (row.fullText) {</span>
<a href="#l15.300"></a><span id="l15.300" class="difflineplus">+              tabmail.openTab(&quot;glodaFacet&quot;, {</span>
<a href="#l15.301"></a><span id="l15.301" class="difflineplus">+                searcher: new GlodaMsgSearcher(null, row.item, row.andTerms)</span>
<a href="#l15.302"></a><span id="l15.302" class="difflineplus">+              });</span>
<a href="#l15.303"></a><span id="l15.303" class="difflineplus">+            } else {</span>
<a href="#l15.304"></a><span id="l15.304" class="difflineplus">+              if (row.nounDef.name == &quot;tag&quot;) {</span>
<a href="#l15.305"></a><span id="l15.305" class="difflineplus">+                theQuery = theQuery.tags(row.item);</span>
<a href="#l15.306"></a><span id="l15.306" class="difflineplus">+              } else if (row.nounDef.name == &quot;identity&quot;) {</span>
<a href="#l15.307"></a><span id="l15.307" class="difflineplus">+                theQuery = theQuery.involves(row.item); </span>
<a href="#l15.308"></a><span id="l15.308" class="difflineplus">+              }</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineplus">+              tabmail.openTab(&quot;glodaFacet&quot;, {</span>
<a href="#l15.310"></a><span id="l15.310" class="difflineplus">+                query: theQuery</span>
<a href="#l15.311"></a><span id="l15.311" class="difflineplus">+              });</span>
<a href="#l15.312"></a><span id="l15.312" class="difflineplus">+            }</span>
<a href="#l15.313"></a><span id="l15.313"> </span>
<a href="#l15.314"></a><span id="l15.314" class="difflineminus">-          this._facetTypeNode.value = tabInfo.facetString;</span>
<a href="#l15.315"></a><span id="l15.315" class="difflineminus">-          if (typeof(tabInfo.location) == &quot;string&quot;)</span>
<a href="#l15.316"></a><span id="l15.316" class="difflineminus">-            this._facetLocationNode.value = tabInfo.location;</span>
<a href="#l15.317"></a><span id="l15.317" class="difflineplus">+            this.applyConstraints();</span>
<a href="#l15.318"></a><span id="l15.318" class="difflineplus">+          }</span>
<a href="#l15.319"></a><span id="l15.319" class="difflineplus">+        } catch (e) {</span>
<a href="#l15.320"></a><span id="l15.320" class="difflineplus">+          logException(e);</span>
<a href="#l15.321"></a><span id="l15.321" class="difflineplus">+        }</span>
<a href="#l15.322"></a><span id="l15.322">         ]]&gt;&lt;/body&gt;</span>
<a href="#l15.323"></a><span id="l15.323" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l15.324"></a><span id="l15.324"> </span>
<a href="#l15.325"></a><span id="l15.325" class="difflineplus">+      &lt;method name=&quot;applyConstraints&quot;&gt;</span>
<a href="#l15.326"></a><span id="l15.326" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.327"></a><span id="l15.327" class="difflineplus">+          ]]&gt;</span>
<a href="#l15.328"></a><span id="l15.328" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l15.329"></a><span id="l15.329">       &lt;/method&gt;</span>
<a href="#l15.330"></a><span id="l15.330" class="difflineminus">-    &lt;/implementation&gt;</span>
<a href="#l15.331"></a><span id="l15.331" class="difflineplus">+</span>
<a href="#l15.332"></a><span id="l15.332" class="difflineplus">+      &lt;method name=&quot;updateEmptyText&quot;&gt;</span>
<a href="#l15.333"></a><span id="l15.333" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.334"></a><span id="l15.334" class="difflineplus">+        try {</span>
<a href="#l15.335"></a><span id="l15.335" class="difflineplus">+          // extract the label value from the menu item</span>
<a href="#l15.336"></a><span id="l15.336" class="difflineplus">+          let menuItem = this.menupopup.getElementsByAttribute('value',</span>
<a href="#l15.337"></a><span id="l15.337" class="difflineplus">+                          this.searchMode)[0];</span>
<a href="#l15.338"></a><span id="l15.338" class="difflineplus">+          this.emptyText = menuItem.getAttribute('label');</span>
<a href="#l15.339"></a><span id="l15.339" class="difflineplus">+        } catch (e) {</span>
<a href="#l15.340"></a><span id="l15.340" class="difflineplus">+          logException(e);</span>
<a href="#l15.341"></a><span id="l15.341" class="difflineplus">+        }</span>
<a href="#l15.342"></a><span id="l15.342" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l15.343"></a><span id="l15.343" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l15.344"></a><span id="l15.344" class="difflineplus">+</span>
<a href="#l15.345"></a><span id="l15.345" class="difflineplus">+      &lt;method name=&quot;updateSaveItem&quot;&gt;</span>
<a href="#l15.346"></a><span id="l15.346" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.347"></a><span id="l15.347" class="difflineplus">+          let disabled = true;</span>
<a href="#l15.348"></a><span id="l15.348" class="difflineplus">+          this.saveAsVirtualFolder.setAttribute(&quot;disabled&quot;, disabled)</span>
<a href="#l15.349"></a><span id="l15.349" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l15.350"></a><span id="l15.350" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l15.351"></a><span id="l15.351" class="difflineplus">+</span>
<a href="#l15.352"></a><span id="l15.352"> </span>
<a href="#l15.353"></a><span id="l15.353" class="difflineminus">-    &lt;handlers&gt;</span>
<a href="#l15.354"></a><span id="l15.354" class="difflineminus">-      &lt;handler event=&quot;command&quot; phase=&quot;bubble&quot;&gt;&lt;![CDATA[</span>
<a href="#l15.355"></a><span id="l15.355" class="difflineminus">-        // Have widgetNode be our immediate child, with nodes being a list of</span>
<a href="#l15.356"></a><span id="l15.356" class="difflineminus">-        //  the descendent nodes between eventNode and the actual target.</span>
<a href="#l15.357"></a><span id="l15.357" class="difflineminus">-        // This allows us to know which of our widgets actually got clicked on,</span>
<a href="#l15.358"></a><span id="l15.358" class="difflineminus">-        //  plus makes subsequent processing easier.  (Alternatively, we could</span>
<a href="#l15.359"></a><span id="l15.359" class="difflineminus">-        //  register a command listener on each of our widgets, but that is</span>
<a href="#l15.360"></a><span id="l15.360" class="difflineminus">-        //  arguably just as ugly.) </span>
<a href="#l15.361"></a><span id="l15.361" class="difflineminus">-        let nodes = [];</span>
<a href="#l15.362"></a><span id="l15.362" class="difflineminus">-        let widgetNode = event.originalTarget;</span>
<a href="#l15.363"></a><span id="l15.363" class="difflineminus">-        while (widgetNode.parentNode != this) {</span>
<a href="#l15.364"></a><span id="l15.364" class="difflineminus">-          nodes.unshift(widgetNode);</span>
<a href="#l15.365"></a><span id="l15.365" class="difflineminus">-          widgetNode = widgetNode.parentNode;</span>
<a href="#l15.366"></a><span id="l15.366" class="difflineminus">-        }</span>
<a href="#l15.367"></a><span id="l15.367" class="difflineminus">-</span>
<a href="#l15.368"></a><span id="l15.368" class="difflineminus">-        // -- Type Facet</span>
<a href="#l15.369"></a><span id="l15.369" class="difflineminus">-        if (widgetNode == this._facetTypeNode) {</span>
<a href="#l15.370"></a><span id="l15.370" class="difflineminus">-</span>
<a href="#l15.371"></a><span id="l15.371" class="difflineplus">+      &lt;method name=&quot;doSearch&quot;&gt;</span>
<a href="#l15.372"></a><span id="l15.372" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.373"></a><span id="l15.373" class="difflineplus">+      try {</span>
<a href="#l15.374"></a><span id="l15.374" class="difflineplus">+        dump(&quot;doing search, value = &quot; + this.value + &quot;\n&quot;);</span>
<a href="#l15.375"></a><span id="l15.375" class="difflineplus">+        if (this.searchMode == 'global') // faceted search</span>
<a href="#l15.376"></a><span id="l15.376" class="difflineplus">+        {</span>
<a href="#l15.377"></a><span id="l15.377" class="difflineplus">+          if (this.value) {</span>
<a href="#l15.378"></a><span id="l15.378" class="difflineplus">+            let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l15.379"></a><span id="l15.379" class="difflineplus">+            // If the current tab is a gloda search tab, reset the value</span>
<a href="#l15.380"></a><span id="l15.380" class="difflineplus">+            //  to the initial search value.  Otherwise, clear it.  This</span>
<a href="#l15.381"></a><span id="l15.381" class="difflineplus">+            //  is the value that is going to be saved with the current</span>
<a href="#l15.382"></a><span id="l15.382" class="difflineplus">+            //  tab when we switch back to it next.</span>
<a href="#l15.383"></a><span id="l15.383" class="difflineplus">+            let searchString = this.value;</span>
<a href="#l15.384"></a><span id="l15.384" class="difflineplus">+            if (tabmail.currentTabInfo.mode.name == &quot;glodaFacet&quot;)</span>
<a href="#l15.385"></a><span id="l15.385" class="difflineplus">+              this.value = tabmail.currentTabInfo.searchString;</span>
<a href="#l15.386"></a><span id="l15.386" class="difflineplus">+            else</span>
<a href="#l15.387"></a><span id="l15.387" class="difflineplus">+              this.value = &quot;&quot;;</span>
<a href="#l15.388"></a><span id="l15.388" class="difflineplus">+            // open a new tab with our dude</span>
<a href="#l15.389"></a><span id="l15.389" class="difflineplus">+            tabmail.openTab(&quot;glodaFacet&quot;, {</span>
<a href="#l15.390"></a><span id="l15.390" class="difflineplus">+              searcher: new GlodaMsgSearcher(null, searchString)</span>
<a href="#l15.391"></a><span id="l15.391" class="difflineplus">+            });</span>
<a href="#l15.392"></a><span id="l15.392" class="difflineplus">+          }</span>
<a href="#l15.393"></a><span id="l15.393" class="difflineplus">+        } else { // quick search</span>
<a href="#l15.394"></a><span id="l15.394" class="difflineplus">+          if (! this.value)</span>
<a href="#l15.395"></a><span id="l15.395" class="difflineplus">+            gFolderDisplay.view.search.userTerms = null</span>
<a href="#l15.396"></a><span id="l15.396" class="difflineplus">+          else</span>
<a href="#l15.397"></a><span id="l15.397" class="difflineplus">+            gFolderDisplay.view.search.quickSearch(Number(this.searchMode), this.value);</span>
<a href="#l15.398"></a><span id="l15.398">         }</span>
<a href="#l15.399"></a><span id="l15.399" class="difflineminus">-        // -- Location Facet</span>
<a href="#l15.400"></a><span id="l15.400" class="difflineminus">-        else if (widgetNode == this._facetLocationNode) {</span>
<a href="#l15.401"></a><span id="l15.401" class="difflineminus">-          if (event.originalTarget._folder) {</span>
<a href="#l15.402"></a><span id="l15.402" class="difflineminus">-            let folder = event.originalTarget._folder;</span>
<a href="#l15.403"></a><span id="l15.403" class="difflineminus">-            this._currentFolderNode.label =</span>
<a href="#l15.404"></a><span id="l15.404" class="difflineminus">-              [node._folder.prettiestName</span>
<a href="#l15.405"></a><span id="l15.405" class="difflineminus">-               for each ([, node] in Iterator(nodes))</span>
<a href="#l15.406"></a><span id="l15.406" class="difflineminus">-               if (node._folder)].join(&quot;/&quot;);</span>
<a href="#l15.407"></a><span id="l15.407" class="difflineminus">-            this._currentFolderNode.hidden = false;</span>
<a href="#l15.408"></a><span id="l15.408" class="difflineminus">-            this._facetLocationNode.selectedItem = this._currentFolderNode;</span>
<a href="#l15.409"></a><span id="l15.409" class="difflineminus">-          }</span>
<a href="#l15.410"></a><span id="l15.410" class="difflineminus">-        }</span>
<a href="#l15.411"></a><span id="l15.411" class="difflineplus">+      } catch (e) {</span>
<a href="#l15.412"></a><span id="l15.412" class="difflineplus">+        logException(e);</span>
<a href="#l15.413"></a><span id="l15.413" class="difflineplus">+      }</span>
<a href="#l15.414"></a><span id="l15.414" class="difflineplus">+          ]]&gt;</span>
<a href="#l15.415"></a><span id="l15.415" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l15.416"></a><span id="l15.416" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l15.417"></a><span id="l15.417"> </span>
<a href="#l15.418"></a><span id="l15.418" class="difflineminus">-        dump(&quot;Selected folder: &quot; + event.originalTarget._folder + &quot;\n&quot;);</span>
<a href="#l15.419"></a><span id="l15.419" class="difflineminus">-        dump(&quot;event: &quot; + event + &quot;\n&quot;);</span>
<a href="#l15.420"></a><span id="l15.420" class="difflineminus">-        dump(&quot;target: &quot; + event.originalTarget + &quot;\n&quot;);</span>
<a href="#l15.421"></a><span id="l15.421" class="difflineminus">-        dump(&quot;event target id: &quot; + event.originalTarget.id + &quot;\n&quot;);</span>
<a href="#l15.422"></a><span id="l15.422" class="difflineminus">-        dump(&quot;event tag: &quot; + event.originalTarget.tagName + &quot;\n&quot;);</span>
<a href="#l15.423"></a><span id="l15.423" class="difflineminus">-      ]]&gt;&lt;/handler&gt;</span>
<a href="#l15.424"></a><span id="l15.424" class="difflineminus">-    &lt;/handlers&gt;</span>
<a href="#l15.425"></a><span id="l15.425" class="difflineplus">+      &lt;method name=&quot;changeMode&quot;&gt;</span>
<a href="#l15.426"></a><span id="l15.426" class="difflineplus">+      &lt;parameter name=&quot;aMenuItem&quot; /&gt;</span>
<a href="#l15.427"></a><span id="l15.427" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.428"></a><span id="l15.428" class="difflineplus">+          var oldSearchMode = this.searchMode;</span>
<a href="#l15.429"></a><span id="l15.429" class="difflineplus">+          this.searchMode = aMenuItem.value;</span>
<a href="#l15.430"></a><span id="l15.430" class="difflineplus">+          if (oldSearchMode != this.searchMode) // the search mode just changed so we need to redo the quick search</span>
<a href="#l15.431"></a><span id="l15.431" class="difflineplus">+            this.doSearch();</span>
<a href="#l15.432"></a><span id="l15.432" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l15.433"></a><span id="l15.433" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l15.434"></a><span id="l15.434" class="difflineplus">+      &lt;field name=&quot;timeout&quot;&gt;200&lt;/field&gt;</span>
<a href="#l15.435"></a><span id="l15.435" class="difflineplus">+      &lt;field name=&quot;glodaCompleter&quot;&gt;null&lt;/field&gt;</span>
<a href="#l15.436"></a><span id="l15.436" class="difflineplus">+      &lt;field name=&quot;ignoreClick&quot;&gt;false&lt;/field&gt;</span>
<a href="#l15.437"></a><span id="l15.437" class="difflineplus">+      &lt;field name=&quot;quickSearchStrings&quot;&gt;null&lt;/field&gt;</span>
<a href="#l15.438"></a><span id="l15.438" class="difflineplus">+      &lt;field name=&quot;mQuickSearchMode&quot;&gt;null&lt;/field&gt;</span>
<a href="#l15.439"></a><span id="l15.439" class="difflineplus">+      &lt;field name=&quot;timeoutHandler&quot;&gt;null&lt;/field&gt;</span>
<a href="#l15.440"></a><span id="l15.440" class="difflineplus">+      &lt;property name=&quot;searchMode&quot; onget=&quot;return this.mQuickSearchMode;&quot;</span>
<a href="#l15.441"></a><span id="l15.441" class="difflineplus">+                onset=&quot;this.mQuickSearchMode = val;</span>
<a href="#l15.442"></a><span id="l15.442" class="difflineplus">+                       dump('val = ' + val + ' \n');</span>
<a href="#l15.443"></a><span id="l15.443" class="difflineplus">+                       dump('typeof val = ' + typeof(val) + ' \n');</span>
<a href="#l15.444"></a><span id="l15.444" class="difflineplus">+                       this.menupopup.setAttribute('value', val);</span>
<a href="#l15.445"></a><span id="l15.445" class="difflineplus">+                       this.updateEmptyText(); &quot;/&gt;</span>
<a href="#l15.446"></a><span id="l15.446"> </span>
<a href="#l15.447"></a><span id="l15.447" class="difflineplus">+      &lt;property name=&quot;autocompletePopup&quot; readonly=&quot;true&quot; onget=&quot;return document.getElementById(this.getAttribute('autocompletepopup'))&quot;/&gt;</span>
<a href="#l15.448"></a><span id="l15.448" class="difflineplus">+</span>
<a href="#l15.449"></a><span id="l15.449" class="difflineplus">+</span>
<a href="#l15.450"></a><span id="l15.450" class="difflineplus">+      &lt;property name=&quot;showingSearchCriteria&quot; onget=&quot;return this.getAttribute('searchCriteria') == 'true';&quot;</span>
<a href="#l15.451"></a><span id="l15.451" class="difflineplus">+                onset=&quot;this.setAttribute('searchCriteria', val); return val;&quot;/&gt;</span>
<a href="#l15.452"></a><span id="l15.452" class="difflineplus">+      &lt;property name=&quot;menupopup&quot; readonly=&quot;true&quot; onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'quick-search-menupopup')&quot;/&gt;</span>
<a href="#l15.453"></a><span id="l15.453" class="difflineplus">+      &lt;property name=&quot;saveAsVirtualFolder&quot; readonly=&quot;true&quot; onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'quick-search-save-as-virtual-folder')&quot;/&gt;</span>
<a href="#l15.454"></a><span id="l15.454" class="difflineplus">+      &lt;property name=&quot;clearButtonHidden&quot; onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'quick-search-clearbutton').getAttribute('clearButtonHidden') == 'true';&quot;</span>
<a href="#l15.455"></a><span id="l15.455" class="difflineplus">+                onset=&quot;document.getAnonymousElementByAttribute(this, 'anonid', 'quick-search-clearbutton').setAttribute('clearButtonHidden', val); return val;&quot;/&gt;</span>
<a href="#l15.456"></a><span id="l15.456" class="difflineplus">+</span>
<a href="#l15.457"></a><span id="l15.457" class="difflineplus">+    &lt;/implementation&gt;</span>
<a href="#l15.458"></a><span id="l15.458">   &lt;/binding&gt;</span>
<a href="#l15.459"></a><span id="l15.459"> </span>
<a href="#l15.460"></a><span id="l15.460" class="difflineminus">-</span>
<a href="#l15.461"></a><span id="l15.461">   &lt;binding id=&quot;searchbar&quot; extends=&quot;chrome://global/content/bindings/textbox.xml#timed-textbox&quot;&gt;</span>
<a href="#l15.462"></a><span id="l15.462">     &lt;resources&gt;</span>
<a href="#l15.463"></a><span id="l15.463">       &lt;stylesheet src=&quot;chrome://messenger/skin/searchBox.css&quot;/&gt;</span>
<a href="#l15.464"></a><span id="l15.464">     &lt;/resources&gt;</span>
<a href="#l15.465"></a><span id="l15.465">     &lt;content&gt; </span>
<a href="#l15.466"></a><span id="l15.466">       &lt;children/&gt;</span>
<a href="#l15.467"></a><span id="l15.467">       &lt;xul:hbox class=&quot;quick-search-textbox textbox-input-box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l15.468"></a><span id="l15.468">         &lt;html:input class=&quot;textbox-input&quot; flex=&quot;1&quot; anonid=&quot;input&quot; allowevents=&quot;true&quot;</span>
<a href="#l15.469"></a><span id="l15.469" class="difflineat">@@ -253,27 +383,21 @@</span>
<a href="#l15.470"></a><span id="l15.470">             // Error condition, something went wrong - try and recover from it.</span>
<a href="#l15.471"></a><span id="l15.471">             this.mQuickSearchMode =</span>
<a href="#l15.472"></a><span id="l15.472">               QuickSearchConstants.kQuickSearchFromOrSubject.toString();</span>
<a href="#l15.473"></a><span id="l15.473"> </span>
<a href="#l15.474"></a><span id="l15.474">             selectedMenuItem =</span>
<a href="#l15.475"></a><span id="l15.475">               qsmenu.getElementsByAttribute('value', this.searchMode)[0];</span>
<a href="#l15.476"></a><span id="l15.476">           }</span>
<a href="#l15.477"></a><span id="l15.477">           selectedMenuItem.setAttribute('checked', 'true');</span>
<a href="#l15.478"></a><span id="l15.478" class="difflineminus">-</span>
<a href="#l15.479"></a><span id="l15.479" class="difflineminus">-          this.setSearchCriteriaText();</span>
<a href="#l15.480"></a><span id="l15.480">         ]]&gt;</span>
<a href="#l15.481"></a><span id="l15.481">       &lt;/constructor&gt;</span>
<a href="#l15.482"></a><span id="l15.482" class="difflineminus">-</span>
<a href="#l15.483"></a><span id="l15.483">       &lt;property name=&quot;showingSearchCriteria&quot; onget=&quot;return this.getAttribute('searchCriteria') == 'true';&quot;</span>
<a href="#l15.484"></a><span id="l15.484">                 onset=&quot;this.setAttribute('searchCriteria', val); return val;&quot;/&gt;</span>
<a href="#l15.485"></a><span id="l15.485"> </span>
<a href="#l15.486"></a><span id="l15.486" class="difflineminus">-      &lt;property name=&quot;clearButtonHidden&quot; onget=&quot;return document.getElementById('quick-search-clearbutton').getAttribute('clearButtonHidden') == 'true';&quot;</span>
<a href="#l15.487"></a><span id="l15.487" class="difflineminus">-                onset=&quot;document.getElementById('quick-search-clearbutton').setAttribute('clearButtonHidden', val); return val;&quot;/&gt;</span>
<a href="#l15.488"></a><span id="l15.488" class="difflineminus">-</span>
<a href="#l15.489"></a><span id="l15.489">       &lt;field name=&quot;mQuickSearchMode&quot;&gt;null&lt;/field&gt;</span>
<a href="#l15.490"></a><span id="l15.490"> </span>
<a href="#l15.491"></a><span id="l15.491">       // DND Observer</span>
<a href="#l15.492"></a><span id="l15.492">       &lt;field name=&quot;searchInputDNDObserver&quot; readonly=&quot;true&quot;&gt;&lt;![CDATA[</span>
<a href="#l15.493"></a><span id="l15.493">       ({</span>
<a href="#l15.494"></a><span id="l15.494">         inputSearch: this,</span>
<a href="#l15.495"></a><span id="l15.495"> </span>
<a href="#l15.496"></a><span id="l15.496">         onDrop: function (aEvent, aXferData, aDragSession)</span>
<a href="#l15.497"></a><span id="l15.497" class="difflineat">@@ -295,40 +419,45 @@</span>
<a href="#l15.498"></a><span id="l15.498">       })</span>
<a href="#l15.499"></a><span id="l15.499">       ]]&gt;&lt;/field&gt;</span>
<a href="#l15.500"></a><span id="l15.500"> </span>
<a href="#l15.501"></a><span id="l15.501">       &lt;property name=&quot;searchMode&quot; onget=&quot;return this.mQuickSearchMode;&quot;</span>
<a href="#l15.502"></a><span id="l15.502">                 onset=&quot;this.mQuickSearchMode = val; document.getElementById('quick-search-menupopup').setAttribute('value', val);&quot;/&gt;</span>
<a href="#l15.503"></a><span id="l15.503"> </span>
<a href="#l15.504"></a><span id="l15.504">       &lt;method name=&quot;setSearchCriteriaText&quot;&gt;</span>
<a href="#l15.505"></a><span id="l15.505">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.506"></a><span id="l15.506" class="difflineplus">+    try {</span>
<a href="#l15.507"></a><span id="l15.507">           this.showingSearchCriteria = true;</span>
<a href="#l15.508"></a><span id="l15.508"> </span>
<a href="#l15.509"></a><span id="l15.509">           let qsmenu = document.getElementById('quick-search-menupopup');</span>
<a href="#l15.510"></a><span id="l15.510"> </span>
<a href="#l15.511"></a><span id="l15.511">           // extract the label value from the menu item</span>
<a href="#l15.512"></a><span id="l15.512">           let menuItem = qsmenu.getElementsByAttribute('value',</span>
<a href="#l15.513"></a><span id="l15.513">                                                        this.searchMode)[0];</span>
<a href="#l15.514"></a><span id="l15.514" class="difflineminus">-</span>
<a href="#l15.515"></a><span id="l15.515" class="difflineplus">+          logElement(menuItem);</span>
<a href="#l15.516"></a><span id="l15.516">           if (typeof menuItem == &quot;undefined&quot;) {</span>
<a href="#l15.517"></a><span id="l15.517">             // Error condition, something went wrong - try and recover from it.</span>
<a href="#l15.518"></a><span id="l15.518">             this.mQuickSearchMode =</span>
<a href="#l15.519"></a><span id="l15.519">               QuickSearchConstants.kQuickSearchFromOrSubject.toString();</span>
<a href="#l15.520"></a><span id="l15.520"> </span>
<a href="#l15.521"></a><span id="l15.521">             let selectedMenuItem =</span>
<a href="#l15.522"></a><span id="l15.522">               qsmenu.getElementsByAttribute('value', this.searchMode)[0];</span>
<a href="#l15.523"></a><span id="l15.523"> </span>
<a href="#l15.524"></a><span id="l15.524">             selectedMenuItem.setAttribute('checked', 'true');</span>
<a href="#l15.525"></a><span id="l15.525"> </span>
<a href="#l15.526"></a><span id="l15.526">             this.inputField.value = selectedMenuItem.getAttribute('label');</span>
<a href="#l15.527"></a><span id="l15.527">           }</span>
<a href="#l15.528"></a><span id="l15.528" class="difflineminus">-          else</span>
<a href="#l15.529"></a><span id="l15.529" class="difflineplus">+          else {</span>
<a href="#l15.530"></a><span id="l15.530">             this.inputField.value = menuItem.getAttribute('label');</span>
<a href="#l15.531"></a><span id="l15.531" class="difflineplus">+          }</span>
<a href="#l15.532"></a><span id="l15.532"> </span>
<a href="#l15.533"></a><span id="l15.533">          this.clearButtonHidden = true;</span>
<a href="#l15.534"></a><span id="l15.534" class="difflineplus">+    } catch (e) {</span>
<a href="#l15.535"></a><span id="l15.535" class="difflineplus">+      logException(e);</span>
<a href="#l15.536"></a><span id="l15.536" class="difflineplus">+    }</span>
<a href="#l15.537"></a><span id="l15.537">         ]]&gt;&lt;/body&gt;</span>
<a href="#l15.538"></a><span id="l15.538">       &lt;/method&gt;</span>
<a href="#l15.539"></a><span id="l15.539"> </span>
<a href="#l15.540"></a><span id="l15.540">       &lt;method name=&quot;openmenupopup&quot;&gt;</span>
<a href="#l15.541"></a><span id="l15.541">         &lt;body&gt;</span>
<a href="#l15.542"></a><span id="l15.542">           &lt;![CDATA[</span>
<a href="#l15.543"></a><span id="l15.543">             document.getElementById('quick-search-menupopup').click();</span>
<a href="#l15.544"></a><span id="l15.544">             return false;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/base/content/searchBar.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/base/content/searchBar.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -18,16 +18,18 @@</span>
<a href="#l16.4"></a><span id="l16.4">  * Netscape Communications Corporation.</span>
<a href="#l16.5"></a><span id="l16.5">  * Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l16.6"></a><span id="l16.6">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l16.7"></a><span id="l16.7">  *</span>
<a href="#l16.8"></a><span id="l16.8">  * Contributor(s):</span>
<a href="#l16.9"></a><span id="l16.9">  *   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l16.10"></a><span id="l16.10">  *   Scott MacGregor &lt;mscott@mozilla.org&gt;</span>
<a href="#l16.11"></a><span id="l16.11">  *   David Bienvenu &lt;bienvenu@nventure.com&gt;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+ *   David Ascher &lt;dascher@mozillamessaging.com&gt;</span>
<a href="#l16.14"></a><span id="l16.14">  *</span>
<a href="#l16.15"></a><span id="l16.15">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l16.16"></a><span id="l16.16">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l16.17"></a><span id="l16.17">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l16.18"></a><span id="l16.18">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l16.19"></a><span id="l16.19">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l16.20"></a><span id="l16.20">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l16.21"></a><span id="l16.21">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -35,224 +37,63 @@</span>
<a href="#l16.23"></a><span id="l16.23">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l16.24"></a><span id="l16.24">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l16.25"></a><span id="l16.25">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l16.26"></a><span id="l16.26">  *</span>
<a href="#l16.27"></a><span id="l16.27">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29"> Components.utils.import(&quot;resource://app/modules/quickSearchManager.js&quot;);</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-var gSearchBundle;</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-var gStatusBar = null;</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-var gIgnoreFocus = false;</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-var gIgnoreClick = false;</span>
<a href="#l16.35"></a><span id="l16.35"> </span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-// change/add constants in QuickSearchConstants in quickSearchManager.js first</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-// ideally these should go away in favor of everyone using QuickSearchConstants</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-const kQuickSearchSubject = QuickSearchConstants.kQuickSearchSubject;</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-const kQuickSearchFrom = QuickSearchConstants.kQuickSearchFrom;</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-const kQuickSearchFromOrSubject =</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-  QuickSearchConstants.kQuickSearchFromOrSubject;</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-const kQuickSearchBody = QuickSearchConstants.kQuickSearchBody;</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-const kQuickSearchRecipient = QuickSearchConstants.kQuickSearchRecipient;</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-const kQuickSearchRecipientOrSubject =</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-  QuickSearchConstants.kQuickSearchRecipientOrSubject;</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+var gSearchBundle;</span>
<a href="#l16.47"></a><span id="l16.47"> </span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+var gStatusBar = null;</span>
<a href="#l16.49"></a><span id="l16.49"> </span>
<a href="#l16.50"></a><span id="l16.50"> /**</span>
<a href="#l16.51"></a><span id="l16.51">  * We are exclusively concerned with disabling the quick-search box when a</span>
<a href="#l16.52"></a><span id="l16.52">  *  tab is being displayed that lacks quick search abilities.</span>
<a href="#l16.53"></a><span id="l16.53">  */</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+</span>
<a href="#l16.55"></a><span id="l16.55"> var QuickSearchTabMonitor = {</span>
<a href="#l16.56"></a><span id="l16.56">   onTabTitleChanged: function() {</span>
<a href="#l16.57"></a><span id="l16.57">   },</span>
<a href="#l16.58"></a><span id="l16.58"> </span>
<a href="#l16.59"></a><span id="l16.59">   onTabSwitched: function (aTab, aOldTab) {</span>
<a href="#l16.60"></a><span id="l16.60">     let searchInput = document.getElementById(&quot;searchInput&quot;);</span>
<a href="#l16.61"></a><span id="l16.61"> </span>
<a href="#l16.62"></a><span id="l16.62">     if (searchInput) {</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-      let newTabEligible = aTab.mode.tabType == mailTabType;</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+      let newTabEligible = ((aTab.mode.tabType == mailTabType) ||</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+                            (aTab.mode.tabType == glodaFacetTabType));</span>
<a href="#l16.66"></a><span id="l16.66">       searchInput.disabled = !newTabEligible;</span>
<a href="#l16.67"></a><span id="l16.67">       if (!newTabEligible)</span>
<a href="#l16.68"></a><span id="l16.68">         searchInput.value = &quot;&quot;;</span>
<a href="#l16.69"></a><span id="l16.69">     }</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-  },</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+  }</span>
<a href="#l16.72"></a><span id="l16.72"> };</span>
<a href="#l16.73"></a><span id="l16.73"> </span>
<a href="#l16.74"></a><span id="l16.74"> </span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+// XXX never called?</span>
<a href="#l16.76"></a><span id="l16.76"> function SetQSStatusText(aNumHits)</span>
<a href="#l16.77"></a><span id="l16.77"> {</span>
<a href="#l16.78"></a><span id="l16.78">   var statusMsg;</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+  gSearchBundle = document.getElementById(&quot;bundle_search&quot;);</span>
<a href="#l16.80"></a><span id="l16.80">   // if there are no hits, it means no matches were found in the search.</span>
<a href="#l16.81"></a><span id="l16.81">   if (aNumHits == 0)</span>
<a href="#l16.82"></a><span id="l16.82">     statusMsg = gSearchBundle.getString(&quot;searchFailureMessage&quot;);</span>
<a href="#l16.83"></a><span id="l16.83">   else</span>
<a href="#l16.84"></a><span id="l16.84">   {</span>
<a href="#l16.85"></a><span id="l16.85">     if (aNumHits == 1)</span>
<a href="#l16.86"></a><span id="l16.86">       statusMsg = gSearchBundle.getString(&quot;searchSuccessMessage&quot;);</span>
<a href="#l16.87"></a><span id="l16.87">     else</span>
<a href="#l16.88"></a><span id="l16.88">       statusMsg = gSearchBundle.getFormattedString(&quot;searchSuccessMessages&quot;, [aNumHits]);</span>
<a href="#l16.89"></a><span id="l16.89">   }</span>
<a href="#l16.90"></a><span id="l16.90"> </span>
<a href="#l16.91"></a><span id="l16.91">   statusFeedback.showStatusString(statusMsg);</span>
<a href="#l16.92"></a><span id="l16.92"> }</span>
<a href="#l16.93"></a><span id="l16.93"> </span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-function getDocumentElements()</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-{</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-  gSearchBundle = document.getElementById(&quot;bundle_search&quot;);</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-  gStatusBar = document.getElementById('statusbar-icon');</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-  GetSearchInput();</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-}</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-function onEnterInSearchBar()</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-{</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-  if (!gSearchInput)</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-    return;</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineminus">-  // nothing changes while showing the criteria</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineminus">-  if (gSearchInput.showingSearchCriteria)</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineminus">-    return;</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineminus">-</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-  if (!gSearchInput || gSearchInput.value == &quot;&quot;)</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineminus">-     gFolderDisplay.view.search.userTerms = null;</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-  else</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineminus">-     gFolderDisplay.view.search.quickSearch(gSearchInput.searchMode,</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineminus">-                                            gSearchInput.value);</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineminus">-}</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineminus">-</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineminus">-</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineminus">-function onSearchKeyPress()</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineminus">-{</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineminus">-  if (gSearchInput.showingSearchCriteria)</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineminus">-    gSearchInput.showingSearchCriteria = false;</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineminus">-}</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineminus">-</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-function onSearchInputFocus(event)</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineminus">-{</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineminus">-  GetSearchInput();</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineminus">-  // search bar has focus, ...clear the showing search criteria flag</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineminus">-  if (gSearchInput.showingSearchCriteria)</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineminus">-  {</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineminus">-    gSearchInput.value = &quot;&quot;;</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineminus">-    gSearchInput.showingSearchCriteria = false;</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineminus">-  }</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineminus">-</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineminus">-  if (gIgnoreFocus) // got focus via mouse click, don't need to anything else</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineminus">-    gIgnoreFocus = false;</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineminus">-  else</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineminus">-    gSearchInput.select();</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineminus">-}</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineminus">-</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineminus">-function onSearchInputMousedown(event)</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineminus">-{</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineminus">-  GetSearchInput();</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineminus">-  if (gSearchInput.hasAttribute(&quot;focused&quot;))</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineminus">-    // If the search input is focused already, ignore the click so that</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineminus">-    // onSearchInputBlur does nothing.</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineminus">-    gIgnoreClick = true;</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineminus">-  else</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineminus">-  {</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineminus">-    gIgnoreFocus = true;</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineminus">-    gIgnoreClick = false;</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineminus">-  }</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineminus">-}</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineminus">-</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineminus">-function onSearchInputClick(event)</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineminus">-{</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineminus">-  if (!gIgnoreClick)</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineminus">-    // Triggers onSearchInputBlur(), but focus returns to field.</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineminus">-    gSearchInput.select();</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineminus">-}</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineminus">-</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineminus">-function onSearchInputBlur(event)</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineminus">-{</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineminus">-  // If we're doing something else, don't process the blur.</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineminus">-  if (gIgnoreClick)</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineminus">-    return;</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineminus">-</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineminus">-  if (!gSearchInput.value)</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineminus">-    gSearchInput.showingSearchCriteria = true;</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineminus">-</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineminus">-  if (gSearchInput.showingSearchCriteria)</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineminus">-    gSearchInput.setSearchCriteriaText();</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineminus">-}</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineminus">-</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineminus">-function onClearSearch()</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineminus">-{</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineminus">-  // If we're not showing search criteria, then we need to clear up.</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineminus">-  if (!gSearchInput.showingSearchCriteria)</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineminus">-  {</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineminus">-    Search(&quot;&quot;);</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineminus">-    // Hide the clear button</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineminus">-    gSearchInput.clearButtonHidden = true;</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineminus">-    gIgnoreClick = true;</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineminus">-    gSearchInput.select();</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineminus">-    gIgnoreClick = false;</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineminus">-  }</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineminus">-}</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineminus">-</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineminus">-// called from commandglue.js in cases where the view is being changed and QS</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineminus">-// needs to be cleared.</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineminus">-function ClearQSIfNecessary()</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineminus">-{</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineminus">-  if (!gSearchInput || gSearchInput.showingSearchCriteria)</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineminus">-    return;</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineminus">-  gSearchInput.setSearchCriteriaText();</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineminus">-}</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineminus">-</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineminus">-function Search(str)</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineminus">-{</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineminus">-  if (gSearchInput.showingSearchCriteria &amp;&amp; str != &quot;&quot;)</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineminus">-    return;</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineminus">-</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineminus">-  gSearchInput.value = str;  //on input does not get fired for some reason</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineminus">-  onEnterInSearchBar();</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineminus">-}</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineminus">-</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineminus">-// helper methods for the quick search drop down menu</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineminus">-function changeQuickSearchMode(aMenuItem)</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineminus">-{</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineminus">-  // extract the label and set the search input to match it</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineminus">-  var oldSearchMode = gSearchInput.searchMode;</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineminus">-  gSearchInput.searchMode = aMenuItem.value;</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineminus">-</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineminus">-  if (gSearchInput.value == &quot;&quot; || gSearchInput.showingSearchCriteria)</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineminus">-  {</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineminus">-    gSearchInput.showingSearchCriteria = true;</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineminus">-    if (gSearchInput.value) //</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineminus">-      gSearchInput.setSearchCriteriaText();</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineminus">-  }</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineminus">-</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineminus">-  // if the search box is empty, set showing search criteria to true so it shows up when focus moves out of the box</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineminus">-  if (!gSearchInput.value)</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineminus">-    gSearchInput.showingSearchCriteria = true;</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineminus">-  else if (gSearchInput.showingSearchCriteria) // if we are showing criteria text and the box isn't empty, change the criteria text</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineminus">-    gSearchInput.setSearchCriteriaText();</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineminus">-  else if (oldSearchMode != gSearchInput.searchMode) // the search mode just changed so we need to redo the quick search</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineminus">-    onEnterInSearchBar();</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineminus">-}</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineminus">-</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineminus">-function saveViewAsVirtualFolder()</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineminus">-{</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineminus">-  gFolderTreeController.newVirtualFolder(gSearchInput.value,</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineminus">-                                         gFolderDisplay.view.search.session.searchTerms);</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineminus">-}</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineminus">-</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineminus">-function InitQuickSearchPopup()</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineminus">-{</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineminus">-  // disable the create virtual folder menu item if the current radio</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineminus">-  // value is set to Find in message since you can't really  create a VF from find</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineminus">-  // in message</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineminus">-</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineminus">-  GetSearchInput();</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineminus">-  if (!gSearchInput ||gSearchInput.value == &quot;&quot; || gSearchInput.showingSearchCriteria)</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineminus">-    document.getElementById('quickSearchSaveAsVirtualFolder').setAttribute('disabled', 'true');</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineminus">-  else</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineminus">-    document.getElementById('quickSearchSaveAsVirtualFolder').removeAttribute('disabled');</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineminus">-}</span>
<a href="#l16.247"></a><span id="l16.247"> </span>
<a href="#l16.248"></a><span id="l16.248"> /**</span>
<a href="#l16.249"></a><span id="l16.249">  * If switching from an &quot;incoming&quot; (Inbox, etc.) type of mail folder,</span>
<a href="#l16.250"></a><span id="l16.250">  * to an &quot;outbound&quot; (Sent, Drafts etc.)  type, and the current search</span>
<a href="#l16.251"></a><span id="l16.251">  * type contains 'Sender', then switch it to the equivalent</span>
<a href="#l16.252"></a><span id="l16.252">  * 'Recipient' search type by default. Vice versa when switching from</span>
<a href="#l16.253"></a><span id="l16.253">  * outbound to incoming folder type.</span>
<a href="#l16.254"></a><span id="l16.254">  * @param isOutboundFolder  Bool</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineat">@@ -267,29 +108,29 @@ function onSearchFolderTypeChanged(isOut</span>
<a href="#l16.256"></a><span id="l16.256"> </span>
<a href="#l16.257"></a><span id="l16.257">   GetSearchInput();</span>
<a href="#l16.258"></a><span id="l16.258"> </span>
<a href="#l16.259"></a><span id="l16.259">   if (!gSearchInput)</span>
<a href="#l16.260"></a><span id="l16.260">     return;</span>
<a href="#l16.261"></a><span id="l16.261"> </span>
<a href="#l16.262"></a><span id="l16.262">   if (isOutboundFolder)</span>
<a href="#l16.263"></a><span id="l16.263">   {</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineminus">-    if (gSearchInput.searchMode == kQuickSearchFromOrSubject)</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineminus">-      newSearchType = kQuickSearchRecipientOrSubject;</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineminus">-    else if (gSearchInput.searchMode == kQuickSearchFrom)</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineminus">-      newSearchType = kQuickSearchRecipient;</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineplus">+    if (gSearchInput.searchMode == QuickSearchConstants.kQuickSearchFromOrSubject)</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineplus">+      newSearchType = QuickSearchConstants.kQuickSearchRecipientOrSubject;</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineplus">+    else if (gSearchInput.searchMode == QuickSearchConstants.kQuickSearchFrom)</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineplus">+      newSearchType = QuickSearchConstants.kQuickSearchRecipient;</span>
<a href="#l16.272"></a><span id="l16.272">     else</span>
<a href="#l16.273"></a><span id="l16.273">       return;</span>
<a href="#l16.274"></a><span id="l16.274">   }</span>
<a href="#l16.275"></a><span id="l16.275">   else</span>
<a href="#l16.276"></a><span id="l16.276">   {</span>
<a href="#l16.277"></a><span id="l16.277" class="difflineminus">-    if (gSearchInput.searchMode == kQuickSearchRecipientOrSubject)</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineminus">-      newSearchType = kQuickSearchFromOrSubject;</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineminus">-    else if (gSearchInput.searchMode == kQuickSearchRecipient)</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineminus">-      newSearchType = kQuickSearchFrom;</span>
<a href="#l16.281"></a><span id="l16.281" class="difflineplus">+    if (gSearchInput.searchMode == QuickSearchConstants.kQuickSearchRecipientOrSubject)</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineplus">+      newSearchType = QuickSearchConstants.kQuickSearchFromOrSubject;</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineplus">+    else if (gSearchInput.searchMode == QuickSearchConstants.kQuickSearchRecipient)</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineplus">+      newSearchType = QuickSearchConstants.kQuickSearchFrom;</span>
<a href="#l16.285"></a><span id="l16.285">     else</span>
<a href="#l16.286"></a><span id="l16.286">       return;</span>
<a href="#l16.287"></a><span id="l16.287">   }</span>
<a href="#l16.288"></a><span id="l16.288">   var newMenuItem = quickSearchMenu.getElementsByAttribute('value', newSearchType).item(0);</span>
<a href="#l16.289"></a><span id="l16.289">   if (newMenuItem)</span>
<a href="#l16.290"></a><span id="l16.290">   {</span>
<a href="#l16.291"></a><span id="l16.291">     // If a menu item is already checked, need to uncheck it first:</span>
<a href="#l16.292"></a><span id="l16.292">     var checked = quickSearchMenu.getElementsByAttribute('checked', 'true').item(0);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/base/content/tabmail.xml</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/base/content/tabmail.xml</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -412,16 +412,19 @@</span>
<a href="#l17.4"></a><span id="l17.4">           }</span>
<a href="#l17.5"></a><span id="l17.5">         ]]&gt;&lt;/body&gt;</span>
<a href="#l17.6"></a><span id="l17.6">       &lt;/method&gt;</span>
<a href="#l17.7"></a><span id="l17.7">       &lt;method name=&quot;openTab&quot;&gt;</span>
<a href="#l17.8"></a><span id="l17.8">         &lt;parameter name=&quot;aTabModeName&quot;/&gt;</span>
<a href="#l17.9"></a><span id="l17.9">         &lt;parameter name=&quot;aArgs&quot;/&gt;</span>
<a href="#l17.10"></a><span id="l17.10">         &lt;body&gt;</span>
<a href="#l17.11"></a><span id="l17.11">             &lt;![CDATA[</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+        try {</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+          if (!(aTabModeName in this.tabModes))</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+            throw new Error(&quot;No such tab mode: &quot; + aTabModeName);</span>
<a href="#l17.15"></a><span id="l17.15">           let tabMode = this.tabModes[aTabModeName];</span>
<a href="#l17.16"></a><span id="l17.16">           // if we are already at our limit for this mode, show an existing one</span>
<a href="#l17.17"></a><span id="l17.17">           if (tabMode.tabs.length == tabMode.maxTabs) {</span>
<a href="#l17.18"></a><span id="l17.18">             let desiredTab = tabMode.tabs[0];</span>
<a href="#l17.19"></a><span id="l17.19">             this.tabContainer.selectedIndex = this.tabInfo.indexOf(desiredTab);</span>
<a href="#l17.20"></a><span id="l17.20">             return;</span>
<a href="#l17.21"></a><span id="l17.21">           }</span>
<a href="#l17.22"></a><span id="l17.22"> </span>
<a href="#l17.23"></a><span id="l17.23" class="difflineat">@@ -518,16 +521,17 @@</span>
<a href="#l17.24"></a><span id="l17.24">           t.setAttribute('type', tab.mode.type);</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26">           if (!background)</span>
<a href="#l17.27"></a><span id="l17.27">             // Update the toolbar status - we don't need to do menus as they</span>
<a href="#l17.28"></a><span id="l17.28">             // do themselves when we open them.</span>
<a href="#l17.29"></a><span id="l17.29">             UpdateMailToolbar(&quot;tabmail&quot;);</span>
<a href="#l17.30"></a><span id="l17.30"> </span>
<a href="#l17.31"></a><span id="l17.31">           return tab;</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+          } catch (e) { logException(e);}</span>
<a href="#l17.33"></a><span id="l17.33">         ]]&gt;&lt;/body&gt;</span>
<a href="#l17.34"></a><span id="l17.34">       &lt;/method&gt;</span>
<a href="#l17.35"></a><span id="l17.35">       &lt;method name=&quot;selectTabByMode&quot;&gt;</span>
<a href="#l17.36"></a><span id="l17.36">         &lt;parameter name=&quot;aTabModeName&quot;/&gt;</span>
<a href="#l17.37"></a><span id="l17.37">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l17.38"></a><span id="l17.38">           let tabMode = this.tabModes[aTabModeName];</span>
<a href="#l17.39"></a><span id="l17.39">           if (tabMode.tabs.length) {</span>
<a href="#l17.40"></a><span id="l17.40">             let desiredTab = tabMode.tabs[0];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/base/jar.mn</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/base/jar.mn</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -55,17 +55,17 @@ messenger.jar:</span>
<a href="#l18.4"></a><span id="l18.4"> *   content/messenger/msgPrintEngine.xul            (content/msgPrintEngine.xul)</span>
<a href="#l18.5"></a><span id="l18.5">     content/messenger/searchBar.js                  (content/searchBar.js)</span>
<a href="#l18.6"></a><span id="l18.6">     content/messenger/phishingDetector.js           (content/phishingDetector.js)</span>
<a href="#l18.7"></a><span id="l18.7"> *   content/messenger/mail-offline.js               (content/mail-offline.js)</span>
<a href="#l18.8"></a><span id="l18.8">     content/messenger/about-footer.png              (content/about-footer.png)</span>
<a href="#l18.9"></a><span id="l18.9">     content/messenger/aboutDialog.css               (content/aboutDialog.css)</span>
<a href="#l18.10"></a><span id="l18.10"> *   content/messenger/credits.xhtml                 (content/credits.xhtml)</span>
<a href="#l18.11"></a><span id="l18.11">     content/messenger/messenger.css                 (content/messenger.css)</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-*   content/messenger/search.xml                    (content/search.xml)</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+    content/messenger/search.xml                    (content/search.xml)</span>
<a href="#l18.14"></a><span id="l18.14">     content/messenger/tabmail.xml                   (content/tabmail.xml)</span>
<a href="#l18.15"></a><span id="l18.15">     content/messenger/tabmail.css                   (content/tabmail.css)</span>
<a href="#l18.16"></a><span id="l18.16"> *   content/messenger/newmailalert.xul              (content/newmailalert.xul)</span>
<a href="#l18.17"></a><span id="l18.17">     content/messenger/newmailalert.js               (content/newmailalert.js)</span>
<a href="#l18.18"></a><span id="l18.18">     content/messenger/newTagDialog.xul              (content/newTagDialog.xul)</span>
<a href="#l18.19"></a><span id="l18.19">     content/messenger/newTagDialog.js               (content/newTagDialog.js)</span>
<a href="#l18.20"></a><span id="l18.20"> *   content/messenger/viewSourceOverlay.xul         (content/viewSourceOverlay.xul)</span>
<a href="#l18.21"></a><span id="l18.21"> *   content/messenger/configEditorOverlay.xul       (content/configEditorOverlay.xul)</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineat">@@ -75,15 +75,23 @@ messenger.jar:</span>
<a href="#l18.23"></a><span id="l18.23"> #ifdef XP_MACOSX</span>
<a href="#l18.24"></a><span id="l18.24">     content/messenger/macMenuOverlay.xul            (content/macMenuOverlay.xul)</span>
<a href="#l18.25"></a><span id="l18.25"> #endif</span>
<a href="#l18.26"></a><span id="l18.26"> *   content/messenger/baseMenuOverlay.xul           (content/baseMenuOverlay.xul)</span>
<a href="#l18.27"></a><span id="l18.27">     content/messenger/selectionsummaries.js         (content/selectionsummaries.js)</span>
<a href="#l18.28"></a><span id="l18.28">     content/messenger/multimessageview.css          (content/multimessageview.css)</span>
<a href="#l18.29"></a><span id="l18.29">     content/messenger/sharedsummary.css             (content/sharedsummary.css)</span>
<a href="#l18.30"></a><span id="l18.30">     content/messenger/multimessageview.xhtml        (content/multimessageview.xhtml)</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+    content/messenger/glodaFacetTab.js              (content/glodaFacetTab.js)</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+    content/messenger/glodaFacetViewWrapper.xul     (content/glodaFacetViewWrapper.xul)</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+    content/messenger/glodaFacetView.xhtml          (content/glodaFacetView.xhtml)</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+    content/messenger/glodaFacetView.js             (content/glodaFacetView.js)</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+    content/messenger/glodaFacetView.css            (content/glodaFacetView.css)</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+    content/messenger/glodaFacetBindings.css        (content/glodaFacetBindings.css)</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+    content/messenger/glodaFacetBindings.xml        (content/glodaFacetBindings.xml)</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+    content/messenger/glodaFacetVis.js              (content/glodaFacetVis.js)</span>
<a href="#l18.39"></a><span id="l18.39"> </span>
<a href="#l18.40"></a><span id="l18.40"> comm.jar:</span>
<a href="#l18.41"></a><span id="l18.41"> % content communicator %content/communicator/ xpcnativewrappers=yes</span>
<a href="#l18.42"></a><span id="l18.42"> *  content/communicator/contentAreaClick.js         (content/contentAreaClick.js)</span>
<a href="#l18.43"></a><span id="l18.43"> *  content/communicator/utilityOverlay.xul          (content/utilityOverlay.xul)</span>
<a href="#l18.44"></a><span id="l18.44"> *  content/communicator/utilityOverlay.js           (content/utilityOverlay.js)</span>
<a href="#l18.45"></a><span id="l18.45"> *  content/communicator/nsContextMenu.js            (content/nsContextMenu.js)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">new file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- /dev/null</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/gloda.properties</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -0,0 +1,151 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineplus">+#</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+#</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+# License.</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+#</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+# The Original Code is Thunderbird Global Database</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+#</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+# Mozilla Messaging, Inc.</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+#</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+# Contributor(s):</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+#   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+#</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+#</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+# LOCALIZATION NOTE (*.facetLabel): These are the labels used to label the facet</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+#  displays in the global search facet display mechanism.  Like thread pane</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+#  column headers these should be relatively short but can take advantage of</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+#  attributes with longer displays to be slightly longer.  For example, the</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+#  conversation attribute is larger than most attributes, so can have a slightly</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+#  longer label.  You can and should use the facetTooltip to provide a better</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+#  and longer explanation of what the facet attribute is.</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+# LOCALIZATION NOTE (*.facetTooltip): These are the tooltips that will be</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+#  displayed if you hover over the facet's label.  These should be longer than</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+#  the facetLabel and reduce confusion about what the facet is, but do not</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+#  need to be a book on the subject.</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.folder.*): Stores the message folder in</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+#  which the message is stored.</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+gloda.message.attr.folder.facetLabel=Mail Folder</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+gloda.message.attr.folder.facetTooltip=The folder where the message is stored.</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.conversation.*): Stores the conversation</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+#  the message belongs to.  The conversation is currently expressed using the</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+#  subject of the message that initiated it.</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+gloda.message.attr.conversation.facetLabel=Conversation Subject</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+gloda.message.attr.conversation.facetTooltip=The subject of the conversation the message belongs to.</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.fromMe.*): Stores everyone involved</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+#  with the message.  This means from/to/cc/bcc.</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+gloda.message.attr.fromMe.facetLabel=From Me</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+gloda.message.attr.fromMe.facetTooltip=Messages where I was the author.</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.toMe.*): Stores everyone involved</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+#  with the message.  This means from/to/cc/bcc.</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+gloda.message.attr.toMe.facetLabel=To Me</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+gloda.message.attr.toMe.facetTooltip=Messages where I was on the To or Cc lines.</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.involves.*): Stores everyone involved</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+#  with the message.  This means from/to/cc/bcc.</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+gloda.message.attr.involves.facetLabel=People</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineplus">+gloda.message.attr.involves.facetTooltip=People explicitly involved in the message by being listed on the From, To, Cc, or Bcc lines.</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineplus">+</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.date.*): Stores the date of the message.</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineplus">+#  Thunderbird normally stores the date the message claims it was composed</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+#  according to the &quot;Date&quot; header.  This is not the same as when the message</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+#  was sent or when it was eventually received by the user.  In the future we</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+#  may change this to be one of the other dates, but not anytime soon.</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+gloda.message.attr.date.facetLabel=Date</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+gloda.message.attr.date.facetTooltip=The date the message claims it was authored.</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.attachmentTypes.*): Stores the list of</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineplus">+#  MIME types (ex: image/png, text/plain) of real attachments (not just part of</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+#  the message content but explicitly named attachments) on the message.</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+#  Although we hope to be able to provide localized human-readable explanations</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+#  of the MIME type (ex: &quot;PowerPoint document&quot;), I don't know if that is going</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+#  to happen.</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+gloda.message.attr.attachmentTypes.facetLabel=Attachments</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+gloda.message.attr.attachmentTypes.facetTooltip=The type of attachments found on the message, if any.</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.mailing-list.*): Stores the mailing</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+#  lists detected in the message.  This will normally be the e-mail address of</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+#  the mailing list and only be detected in messages received from the mailing</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+#  list.  Extensions may contribute additional detected mailing-list-like</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineplus">+#  things.</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+gloda.message.attr.mailing-list.facetLabel=Mail List Involved</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+gloda.message.attr.mailing-list.facetTooltip=If the message was sent via a mailing list, the e-mail address associated with the mailing list.</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineplus">+</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.tag.*): Stores the tags applied to the</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+#  message.  Notably, gmail's labels are not currently exposed via IMAP and we</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+#  do not do anything clever with gmail, so this is indepdendent of gmail</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineplus">+#  labels.  This may change in the future, but it's a safe bet it's not</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineplus">+#  happening on Thunderbird's side prior to 3.0.</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineplus">+gloda.message.attr.tag.facetLabel=Tags</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineplus">+gloda.message.attr.tag.facetTooltip=Tags applied to the message.</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineplus">+</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.tag.*): Stores whether the message is</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineplus">+#  starred or not, as indicated by a pretty star icon.  In the past, the icon</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineplus">+#  used to be a flag.  The IMAP terminology continues to be &quot;flagged&quot;.</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineplus">+gloda.message.attr.star.facetLabel=Starred</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineplus">+gloda.message.attr.star.facetTooltip=Is the message starred / flagged?</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineplus">+</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.read.*): Stores whether the user has</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineplus">+#  read the message or not.</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineplus">+gloda.message.attr.read.facetLabel=Read</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineplus">+gloda.message.attr.read.facetTooltip=Is the message marked read, or is it unread?</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineplus">+</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.repliedTo.*): Stores whether we believe</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineplus">+#  the user has ever replied to the message.  We normally show a little icon in</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineplus">+#  the thread pane when this is the case.</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineplus">+gloda.message.attr.repliedTo.facetLabel=Replied To</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineplus">+gloda.message.attr.repliedTo.facetTooltip=Has this message been replied to?</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineplus">+</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineplus">+# LOCALIZATION NOTE (gloda.message.attr.forwarded.*): Stores whether we believe</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineplus">+#  the user has ever forwarded the message.  We normally show a little icon in</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineplus">+#  the thread pane when this is the case.</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineplus">+gloda.message.attr.forwarded.facetLabel=Forwarded</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineplus">+gloda.message.attr.forwarded.facetTooltip=Has this message been forwarded to anyone?</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineplus">+</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineplus">+# LOCALIZATION NOTE (gloda.mimetype.category.*.label): Map categories of MIME</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineplus">+#  types defined in mimeTypeCategories.js to labels.</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineplus">+# LOCALIZATION NOTE (gloda.mimetype.category.archives.label): Archive is</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineplus">+#  referring to things like zip files, tar files, tar.gz files, etc.</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineplus">+gloda.mimetype.category.archives.label=Archives</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineplus">+gloda.mimetype.category.documents.label=Documents</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineplus">+gloda.mimetype.category.images.label=Images</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineplus">+# LOCALIZATION NOTE (gloda.mimetype.category.media.label): Media is meant to</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineplus">+#  encompass both audio and video.  This is because video and audio streams are</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineplus">+#  frequently stored in the same type of container and we cannot rely on the</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineplus">+#  sending e-mail client to have been clever enough to figure out what was</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineplus">+#  really in the file.  So we group them together.</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineplus">+gloda.mimetype.category.media.label=Media (Audio, Video)</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineplus">+gloda.mimetype.category.pdf.label=PDF Files</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineplus">+# LOCALIZATION NOTE (gloda.mimetype.category.other.label): Other is the category</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineplus">+#  for MIME types that we don't really know what it is.</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineplus">+gloda.mimetype.category.other.label=Other</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">new file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- /dev/null</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/glodaFacetView.dtd</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -0,0 +1,4 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (glodaFacetView.filters.label): Label at the top of the</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineplus">+     faceting sidebar.  Serves as a header both for the checkboxes under it as</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineplus">+     well for labeled facets with multiple options. --&gt;</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineplus">+&lt;!ENTITY glodaFacetView.filters.label &quot;Filters&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">new file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- /dev/null</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/glodaFacetView.properties</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -0,0 +1,115 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineplus">+#</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+#</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+# License.</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+#</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+# The Original Code is Thunderbird Global Database</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+#</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+# Mozilla Messaging, Inc.</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+#</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+# Contributor(s):</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+#   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+#</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+#</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+# LOCALIZATION NOTE (glodaFacetView.tab.query.label): The title to display for</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+#  tabs that are based on a gloda (global database) query or collection rather</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+#  than a user search.  In the case of a user search, we just display the</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+#  search string they entered.  At some point we might try and explain what</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+#  the query/collection is an automatic fashion, but not today.</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+glodaFacetView.tab.query.label=Search</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.constraints.query.fulltext.label):</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+#  The label to display to describe when our base query was a fulltext search</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+#  across messages.  The value is displayed following the label.</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+glodaFacetView.constraints.query.fulltext.label=Searching for #1</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+glodaFacetView.constraints.query.fulltext.andJoinWord=and</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+glodaFacetView.constraints.query.fulltext.orJoinWord=or</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+glodaFacetView.constraints.query.fulltext.changeToAndLabel=require all terms instead</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+glodaFacetView.constraints.query.fulltext.changeToOrLabel=require any of the terms instead</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.constraints.query.initial):</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineplus">+#  The label to display to describe when our base query is not a full-text</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineplus">+#  search.  Additional labels are appended describing each constraint.</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+glodaFacetView.constraints.query.initial=Searching for messages</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.constraints.query.involves.label):</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineplus">+#  The label to display to describe when our base query was on messages</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+#  involving a given contact from the address book.  The value is displayed</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+#  where the #1 is.</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+glodaFacetView.constraints.query.involves.label=involving #1</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineplus">+</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.constraints.query.contact.label):</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+#  The label to display to describe when our base query was on messages</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineplus">+#  tagged with a specific tag.  The tag is displayed following the label.</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+glodaFacetView.constraints.query.tagged.label=tagged:</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+# LOCALIZATION NOTE (glodaFacetView.facets.mode.top.otherLabel): The label to</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+#  use for the &quot;other&quot; category where we lump everything that is not one of the</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+#  top groups.  Includes an argument which is the number of groups that are</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineplus">+#  collapsed into this group.</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+glodaFacetView.facets.mode.top.otherLabel=Other (%S)</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineplus">+</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineplus">+# LOCALIZATION NOTE (glodaFacetView.facets.noneLabel): The text to display when</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineplus">+#  a facet needs to indicate that an attribute omitted a value or was otherwise</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+#  empty.</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+glodaFacetView.facets.noneLabel=None</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineplus">+# LOCALIZATION NOTE (glodaFacetView.facets.filter.attachmentTypes.allLabel):</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineplus">+#  The label to use when all types of attachments are being displayed.</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineplus">+glodaFacetView.facets.filter.attachmentTypes.allLabel=Any Kind</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineplus">+</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineplus">+# LOCALIZATION NOTE (glodaFacetView.result.message.writesLabel): Used in the</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineplus">+#  faceted search message display to delinate the author of a message and the</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineplus">+#  recipients.  An example usage is  &quot;Alice writes Bob, Chuck, Don&quot;.</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineplus">+glodaFacetView.result.message.writesLabel=writes</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineplus">+</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.results.message.countLabel): Displays the</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineplus">+#  number of messages displayed in the result area out of the number of</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineplus">+#  messages in the active set (the set of messages remaining after the</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineplus">+#  application of the facet constraints.)  It takes the following arguments,</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineplus">+#  you do not have to use all of them.</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineplus">+# #1: The number of messages displayed in the result area.</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineplus">+# #2: The pluralized form of &quot;messages&quot; (or whatever you provide in</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineplus">+#      glodaFacetView.results.message.countLabelMessagePlurals) as it</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineplus">+#      applies to #1 (the number of messages in the result area.)</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineplus">+# #3: The number of messages in the active set.</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineplus">+# #4: The pluralized form of &quot;messages&quot; as it applies to #3.</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineplus">+glodaFacetView.results.message.countLabel=Top #1 #2 out of #3</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.results.message.countLabelMessagePlurals):</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineplus">+#  The plural forms of &quot;messages&quot; or whatever you choose.  See</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineplus">+#  https://developer.mozilla.org/en/Localization_and_Plurals for details on</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineplus">+#  how this stuff works.</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineplus">+glodaFacetView.results.message.countLabelMessagePlurals=message;messages</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.results.message.showAllInList.label): The</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineplus">+#  label for the button/link that causes us to display all of the messages in</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineplus">+#  the active set in a new thread pane display tab, closing the current faceting</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineplus">+#  tab.</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineplus">+glodaFacetView.results.message.showAllInList.label=Show all as list</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineplus">+# LOCALIZATION NOTE(glodaFacetView.results.message.showAllInList.tooltip): The</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineplus">+#  tooltip to display when hovering over the showAllInList label.</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineplus">+glodaFacetView.results.message.showAllInList.tooltip=Show all of the messages in the active set in a new tab, closing this tab.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messenger.dtd</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messenger.dtd</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -561,38 +561,16 @@ you can use these alternative items. Oth</span>
<a href="#l22.4"></a><span id="l22.4"> &lt;!ENTITY folderContextSettings.accesskey &quot;e&quot;&gt;</span>
<a href="#l22.5"></a><span id="l22.5"> </span>
<a href="#l22.6"></a><span id="l22.6"> &lt;!-- Search Bar --&gt;</span>
<a href="#l22.7"></a><span id="l22.7"> &lt;!ENTITY SearchNameOrEmail.label &quot;Name or Email contains:&quot;&gt;</span>
<a href="#l22.8"></a><span id="l22.8"> &lt;!ENTITY SearchNameOrEmail.accesskey &quot;N&quot;&gt;</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10"> &lt;!-- Gloda Search Bar --&gt;</span>
<a href="#l22.11"></a><span id="l22.11"> &lt;!ENTITY glodaSearchBar.emptyText &quot;Search messages…&quot;&gt;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-&lt;!ENTITY glodaSearchBar.facet.label &quot;Search:&quot;&gt;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-&lt;!-- LOCALIZATION NOTE (glodaSearchFacet.*) labels specify search constraints.</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-       &quot;everything&quot; searches over subject, involves, body, and attachments.</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-       &quot;subject&quot; searches only messages subjects.</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-       &quot;involves&quot; searches only message to/from/cc/bcc.</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-       &quot;to&quot; searches only message to/cc.</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-       &quot;from&quot; searches only message using &quot;from&quot; (the message author).</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">-       &quot;body&quot; searches only message bodies, which does not include message</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-           attachment names or the content of the attachments.  Message body</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-           basically means a message part with a content-type of text/*.</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-    --&gt;</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.everything.label &quot;Everything&quot;&gt;</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.subject.label &quot;Subject&quot;&gt;</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.involves.label &quot;Involves (from,to,cc,bcc)&quot;&gt;</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.to.label &quot;To, CC&quot;&gt;</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.from.label &quot;From&quot;&gt;</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.body.label &quot;Message Text&quot;&gt;</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.attachmentNames.label &quot;Attachment Names&quot;&gt;</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-&lt;!ENTITY glodaSearchBar.location.label &quot;Location:&quot;&gt;</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.everywhere.label &quot;All Folders&quot;&gt;</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-&lt;!ENTITY glodaSearchFacet.folder.label &quot;In a specific folder…&quot;&gt;</span>
<a href="#l22.34"></a><span id="l22.34"> </span>
<a href="#l22.35"></a><span id="l22.35"> &lt;!-- Quick Search Menu Bar --&gt;</span>
<a href="#l22.36"></a><span id="l22.36"> &lt;!ENTITY searchSubjectMenu.label &quot;Subject&quot;&gt;</span>
<a href="#l22.37"></a><span id="l22.37"> &lt;!ENTITY searchFromMenu.label &quot;From&quot;&gt;</span>
<a href="#l22.38"></a><span id="l22.38"> &lt;!ENTITY searchSubjectOrFromMenu.label &quot;Subject or From&quot;&gt;</span>
<a href="#l22.39"></a><span id="l22.39"> &lt;!ENTITY searchRecipient.label &quot;To or Cc&quot;&gt;</span>
<a href="#l22.40"></a><span id="l22.40"> &lt;!ENTITY searchSubjectOrRecipientMenu.label &quot;Subject, To or Cc&quot;&gt;</span>
<a href="#l22.41"></a><span id="l22.41"> &lt;!ENTITY searchMessageBody.label &quot;Entire Message&quot;&gt;</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineat">@@ -613,25 +591,16 @@ you can use these alternative items. Oth</span>
<a href="#l22.43"></a><span id="l22.43"> &lt;!ENTITY unreadColumn.label &quot;Unread&quot;&gt;</span>
<a href="#l22.44"></a><span id="l22.44"> &lt;!ENTITY totalColumn.label &quot;Total&quot;&gt;</span>
<a href="#l22.45"></a><span id="l22.45"> &lt;!ENTITY readColumn.label &quot;Read&quot;&gt;</span>
<a href="#l22.46"></a><span id="l22.46"> &lt;!ENTITY receivedColumn.label &quot;Received&quot;&gt;</span>
<a href="#l22.47"></a><span id="l22.47"> &lt;!ENTITY starredColumn.label &quot;Starred&quot;&gt;</span>
<a href="#l22.48"></a><span id="l22.48"> &lt;!ENTITY locationColumn.label &quot;Location&quot;&gt;</span>
<a href="#l22.49"></a><span id="l22.49"> &lt;!ENTITY idColumn.label &quot;Order Received&quot;&gt;</span>
<a href="#l22.50"></a><span id="l22.50"> &lt;!ENTITY attachmentColumn.label &quot;Attachments&quot;&gt;</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-&lt;!-- LOCALIZATION NOTE (glodaWhyColumn.label): explains why a message is</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-     present in the gloda search results.  The values can be found in</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-     messenger.properties with a prefix of &quot;glodaSearch_results_why_&quot;. --&gt;</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineminus">-&lt;!ENTITY glodaWhyColumn.label &quot;Why&quot;&gt;</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-&lt;!-- LOCALIZATION NOTE (glodaScoreColumn.label): provides the numerical</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-     score assigned to the message as a result of the search.  The column</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-     primarily exists to be sorted by, and its contents will probably have</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-     little meaning for most users. --&gt;</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineminus">-&lt;!ENTITY glodaScoreColumn.label &quot;Score&quot;&gt;</span>
<a href="#l22.60"></a><span id="l22.60"> </span>
<a href="#l22.61"></a><span id="l22.61"> &lt;!-- Thread Pane Tooltips --&gt;</span>
<a href="#l22.62"></a><span id="l22.62"> &lt;!ENTITY columnChooser.tooltip &quot;Click to select columns to display&quot;&gt;</span>
<a href="#l22.63"></a><span id="l22.63"> &lt;!ENTITY threadColumn.tooltip &quot;Click to display message threads&quot;&gt;</span>
<a href="#l22.64"></a><span id="l22.64"> &lt;!ENTITY fromColumn.tooltip &quot;Click to sort by from&quot;&gt;</span>
<a href="#l22.65"></a><span id="l22.65"> &lt;!ENTITY recipientColumn.tooltip &quot;Click to sort by recipient&quot;&gt;</span>
<a href="#l22.66"></a><span id="l22.66"> &lt;!ENTITY subjectColumn.tooltip &quot;Click to sort by subject&quot;&gt;</span>
<a href="#l22.67"></a><span id="l22.67"> &lt;!ENTITY dateColumn.tooltip &quot;Click to sort by date&quot;&gt;</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineat">@@ -644,18 +613,16 @@ you can use these alternative items. Oth</span>
<a href="#l22.69"></a><span id="l22.69"> &lt;!ENTITY unreadColumn.tooltip &quot;Number of unread messages in thread&quot;&gt;</span>
<a href="#l22.70"></a><span id="l22.70"> &lt;!ENTITY totalColumn.tooltip &quot;Total number of messages in thread&quot;&gt;</span>
<a href="#l22.71"></a><span id="l22.71"> &lt;!ENTITY readColumn.tooltip &quot;Click to sort by read&quot;&gt;</span>
<a href="#l22.72"></a><span id="l22.72"> &lt;!ENTITY receivedColumn.tooltip &quot;Click to sort by date received&quot;&gt;</span>
<a href="#l22.73"></a><span id="l22.73"> &lt;!ENTITY starredColumn.tooltip &quot;Click to sort by star&quot;&gt;</span>
<a href="#l22.74"></a><span id="l22.74"> &lt;!ENTITY locationColumn.tooltip &quot;Click to sort by location&quot;&gt;</span>
<a href="#l22.75"></a><span id="l22.75"> &lt;!ENTITY idColumn.tooltip &quot;Click to sort by order received&quot;&gt;</span>
<a href="#l22.76"></a><span id="l22.76"> &lt;!ENTITY attachmentColumn.tooltip &quot;Click to sort by attachments&quot;&gt;</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineminus">-&lt;!ENTITY glodaWhyColumn.tooltip &quot;Click to sort by why the message is in your search results&quot;&gt;</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineminus">-&lt;!ENTITY glodaScoreColumn.tooltip &quot;Click to sort by the search score&quot;&gt;</span>
<a href="#l22.79"></a><span id="l22.79"> </span>
<a href="#l22.80"></a><span id="l22.80"> &lt;!-- Thread Pane Context Menu --&gt;</span>
<a href="#l22.81"></a><span id="l22.81"> &lt;!ENTITY contextOpenNewWindow.label &quot;Open Message in New Window&quot;&gt;</span>
<a href="#l22.82"></a><span id="l22.82"> &lt;!ENTITY contextOpenNewWindow.accesskey &quot;W&quot;&gt;</span>
<a href="#l22.83"></a><span id="l22.83"> &lt;!ENTITY contextOpenNewTab.label &quot;Open Message in New Tab&quot;&gt;</span>
<a href="#l22.84"></a><span id="l22.84"> &lt;!ENTITY contextOpenNewTab.accesskey &quot;T&quot;&gt;</span>
<a href="#l22.85"></a><span id="l22.85"> &lt;!ENTITY contextEditAsNew.label &quot;Edit As New…&quot;&gt;</span>
<a href="#l22.86"></a><span id="l22.86"> &lt;!ENTITY contextEditAsNew.accesskey &quot;E&quot;&gt;</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineat">@@ -698,16 +665,17 @@ you can use these alternative items. Oth</span>
<a href="#l22.88"></a><span id="l22.88"> &lt;!ENTITY removePhishingBarButton1.label &quot;Ignore Warning&quot;&gt;</span>
<a href="#l22.89"></a><span id="l22.89"> &lt;!ENTITY reportPhishingError1.label &quot;This message doesn't appear to be a scam.&quot;&gt;</span>
<a href="#l22.90"></a><span id="l22.90"> </span>
<a href="#l22.91"></a><span id="l22.91"> &lt;!-- Message Header Button Box (to show hidden email addresses) --&gt;</span>
<a href="#l22.92"></a><span id="l22.92"> &lt;!ENTITY more.label &quot;more&quot;&gt;</span>
<a href="#l22.93"></a><span id="l22.93"> </span>
<a href="#l22.94"></a><span id="l22.94"> &lt;!-- Quick Search Bar --&gt;</span>
<a href="#l22.95"></a><span id="l22.95"> &lt;!ENTITY quickSearchCmd.key &quot;k&quot;&gt;</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineplus">+&lt;!ENTITY searchEverywhere.label &quot;Search everywhere&quot;&gt;</span>
<a href="#l22.97"></a><span id="l22.97"> </span>
<a href="#l22.98"></a><span id="l22.98"> &lt;!-- Message Header Context Menu --&gt;</span>
<a href="#l22.99"></a><span id="l22.99"> &lt;!ENTITY AddToAddressBook.label &quot;Add to Address Book…&quot;&gt;</span>
<a href="#l22.100"></a><span id="l22.100"> &lt;!ENTITY AddToAddressBook.accesskey &quot;B&quot;&gt;</span>
<a href="#l22.101"></a><span id="l22.101"> &lt;!ENTITY AddDirectlyToAddressBook.label &quot;Add to Address Book&quot;&gt;</span>
<a href="#l22.102"></a><span id="l22.102"> &lt;!ENTITY AddDirectlyToAddressBook.accesskey &quot;B&quot;&gt;</span>
<a href="#l22.103"></a><span id="l22.103"> &lt;!ENTITY EditContact.label &quot;Edit Contact…&quot;&gt;</span>
<a href="#l22.104"></a><span id="l22.104"> &lt;!ENTITY EditContact.accesskey &quot;E&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -493,28 +493,16 @@ headerFieldYou=You</span>
<a href="#l23.4"></a><span id="l23.4"> # Shown when content tabs are being loaded.</span>
<a href="#l23.5"></a><span id="l23.5"> loadingTab=Loading…</span>
<a href="#l23.6"></a><span id="l23.6"> </span>
<a href="#l23.7"></a><span id="l23.7"> applyToCollapsedMsgsTitle=Confirm Delete of Messages in Collapsed Thread(s)</span>
<a href="#l23.8"></a><span id="l23.8"> applyToCollapsedMsgs=Warning - this will delete messages in collapsed thread(s)</span>
<a href="#l23.9"></a><span id="l23.9"> applyToCollapsedAlwaysAskCheckbox=Always ask me before deleting messages in collapsed threads</span>
<a href="#l23.10"></a><span id="l23.10"> applyNowButton=Apply</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-#LOCALIZATION NOTE (glodaSearch_results_why_*):  These strings populate the</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-# glodaWhyColumn when performing a gloda-backed search, explaining why a</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-# specific result is present in the search.  Because of how the message grouping</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-# mechanism works, this value is both the value in the &quot;Why&quot; column as well as</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-# the header for the group (when sorting/grouping on the why column.)  Short</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-# strings are preferable so the why column can be understood without taking up</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-# too much space.</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-glodaSearch_results_why_contact=Contact</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">-glodaSearch_results_why_subject=Subject</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-glodaSearch_results_why_body=Body</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-glodaSearch_results_why_attachment=Attachment</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-</span>
<a href="#l23.24"></a><span id="l23.24"> mailServerLoginFailedTitle=Login Failed</span>
<a href="#l23.25"></a><span id="l23.25"> # LOCALIZATION NOTE (mailServerLoginFailedTitle): Insert &quot;%S&quot; in your</span>
<a href="#l23.26"></a><span id="l23.26"> # translation where you wish to display the hostname of the server to which</span>
<a href="#l23.27"></a><span id="l23.27"> # login failed.</span>
<a href="#l23.28"></a><span id="l23.28"> mailServerLoginFailed=Login to server %S failed.</span>
<a href="#l23.29"></a><span id="l23.29"> mailServerLoginFailedRetryButton=&amp;Retry</span>
<a href="#l23.30"></a><span id="l23.30"> mailServerLoginFailedEnterNewPasswordButton=&amp;Enter New Password</span>
<a href="#l23.31"></a><span id="l23.31"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">new file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineminus">--- /dev/null</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/quickSearch.properties</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineat">@@ -0,0 +1,8 @@</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineplus">+searchEverywhere.label=Search everywhere</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineplus">+searchSubject.label=Subject filter</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineplus">+searchFrom.label=From filter</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineplus">+searchFromOrSubject.label=Subject or From filter</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineplus">+searchRecipient.label=To or Cc filter</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineplus">+searchRecipientOrSubject.label=Subject, To, or Cc filter</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineplus">+searchBody.label=Entire message filter</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+saveAsVirtualFolder.label=Save search as virtual folder</span>
<a href="#l24.13"></a><span id="l24.13">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/search.properties</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/search.properties</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -16,12 +16,8 @@ searchSuccessMessages=%S matches found</span>
<a href="#l25.4"></a><span id="l25.4"> searchFailureMessage=No matches found</span>
<a href="#l25.5"></a><span id="l25.5"> labelForStopButton=Stop</span>
<a href="#l25.6"></a><span id="l25.6"> labelForSearchButton=Search</span>
<a href="#l25.7"></a><span id="l25.7"> labelForStopButton.accesskey=S</span>
<a href="#l25.8"></a><span id="l25.8"> labelForSearchButton.accesskey=S</span>
<a href="#l25.9"></a><span id="l25.9"> </span>
<a href="#l25.10"></a><span id="l25.10"> moreButtonTooltipText=Add a new rule</span>
<a href="#l25.11"></a><span id="l25.11"> lessButtonTooltipText=Remove this rule</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-# LOCALIZATION NOTE (glodaSearchTabTitle): The title to use for global database</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-#  search tabs.  Include &quot;%S&quot; where you want the search string to be inserted.</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-glodaSearchTabTitle=Search: %S</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mail/locales/jar.mn</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mail/locales/jar.mn</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -90,16 +90,20 @@</span>
<a href="#l26.4"></a><span id="l26.4">   locale/@AB_CD@/messenger/textImportMsgs.properties                    (%chrome/messenger/textImportMsgs.properties)</span>
<a href="#l26.5"></a><span id="l26.5">   locale/@AB_CD@/messenger/appleMailImportMsgs.properties               (%chrome/messenger/appleMailImportMsgs.properties)</span>
<a href="#l26.6"></a><span id="l26.6">   locale/@AB_CD@/messenger/comm4xMailImportMsgs.properties              (%chrome/messenger/comm4xMailImportMsgs.properties)</span>
<a href="#l26.7"></a><span id="l26.7">   locale/@AB_CD@/messenger/eudoraImportMsgs.properties                  (%chrome/messenger/eudoraImportMsgs.properties)</span>
<a href="#l26.8"></a><span id="l26.8">   locale/@AB_CD@/messenger/oeImportMsgs.properties                      (%chrome/messenger/oeImportMsgs.properties)</span>
<a href="#l26.9"></a><span id="l26.9">   locale/@AB_CD@/messenger/outlookImportMsgs.properties                 (%chrome/messenger/outlookImportMsgs.properties)</span>
<a href="#l26.10"></a><span id="l26.10">   locale/@AB_CD@/messenger/shutdownWindow.properties                    (%chrome/messenger/shutdownWindow.properties)</span>
<a href="#l26.11"></a><span id="l26.11">   locale/@AB_CD@/messenger/configEditorOverlay.dtd                      (%chrome/messenger/configEditorOverlay.dtd)</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+  locale/@AB_CD@/messenger/quickSearch.properties                       (%chrome/messenger/quickSearch.properties)</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+  locale/@AB_CD@/messenger/gloda.properties                             (%chrome/messenger/gloda.properties)</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+  locale/@AB_CD@/messenger/glodaFacetView.properties                    (%chrome/messenger/glodaFacetView.properties)</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+  locale/@AB_CD@/messenger/glodaFacetView.dtd                           (%chrome/messenger/glodaFacetView.dtd)</span>
<a href="#l26.16"></a><span id="l26.16">   locale/@AB_CD@/messenger/addressbook/abMainWindow.dtd                 (%chrome/messenger/addressbook/abMainWindow.dtd)</span>
<a href="#l26.17"></a><span id="l26.17">   locale/@AB_CD@/messenger/addressbook/abNewCardDialog.dtd              (%chrome/messenger/addressbook/abNewCardDialog.dtd)</span>
<a href="#l26.18"></a><span id="l26.18">   locale/@AB_CD@/messenger/addressbook/abContactsPanel.dtd              (%chrome/messenger/addressbook/abContactsPanel.dtd)</span>
<a href="#l26.19"></a><span id="l26.19">   locale/@AB_CD@/messenger/addressbook/abAddressBookNameDialog.dtd      (%chrome/messenger/addressbook/abAddressBookNameDialog.dtd)</span>
<a href="#l26.20"></a><span id="l26.20">   locale/@AB_CD@/messenger/addressbook/abCardOverlay.dtd                (%chrome/messenger/addressbook/abCardOverlay.dtd)</span>
<a href="#l26.21"></a><span id="l26.21">   locale/@AB_CD@/messenger/addressbook/abCardViewOverlay.dtd            (%chrome/messenger/addressbook/abCardViewOverlay.dtd)</span>
<a href="#l26.22"></a><span id="l26.22">   locale/@AB_CD@/messenger/addressbook/abDirTreeOverlay.dtd             (%chrome/messenger/addressbook/abDirTreeOverlay.dtd)</span>
<a href="#l26.23"></a><span id="l26.23">   locale/@AB_CD@/messenger/addressbook/abResultsPaneOverlay.dtd         (%chrome/messenger/addressbook/abResultsPaneOverlay.dtd)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mail/themes/pinstripe/mail/searchBox.css</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mail/themes/pinstripe/mail/searchBox.css</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -32,21 +32,17 @@</span>
<a href="#l27.4"></a><span id="l27.4"> # decision by deleting the provisions above and replace them with the notice</span>
<a href="#l27.5"></a><span id="l27.5"> # and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l27.6"></a><span id="l27.6"> # the provisions above, a recipient may use your version of this file under</span>
<a href="#l27.7"></a><span id="l27.7"> # the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l27.8"></a><span id="l27.8"> #</span>
<a href="#l27.9"></a><span id="l27.9"> # ***** END LICENSE BLOCK *****</span>
<a href="#l27.10"></a><span id="l27.10"> */</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-#searchInput[searchCriteria=&quot;true&quot;]  {</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-  color: grey;</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-}</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">-</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineminus">-#quick-search-button {</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineplus">+.quick-search-button {</span>
<a href="#l27.18"></a><span id="l27.18">   -moz-margin-start: -10px;</span>
<a href="#l27.19"></a><span id="l27.19">   -moz-margin-end: 4px;</span>
<a href="#l27.20"></a><span id="l27.20">   margin-bottom: 0;</span>
<a href="#l27.21"></a><span id="l27.21">   margin-top: 0;</span>
<a href="#l27.22"></a><span id="l27.22"> }</span>
<a href="#l27.23"></a><span id="l27.23"> </span>
<a href="#l27.24"></a><span id="l27.24"> .quick-search-button-image {</span>
<a href="#l27.25"></a><span id="l27.25">   padding: 0px;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/base/src/dbViewWrapper.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/base/src/dbViewWrapper.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -1815,17 +1815,17 @@ DBViewWrapper.prototype = {</span>
<a href="#l28.4"></a><span id="l28.4">     this._mailViewData = aData;</span>
<a href="#l28.5"></a><span id="l28.5"> </span>
<a href="#l28.6"></a><span id="l28.6">     // - update the search terms</span>
<a href="#l28.7"></a><span id="l28.7">     // (this triggers a view update if we are not in a batch)</span>
<a href="#l28.8"></a><span id="l28.8">     this.search.viewTerms = mailViewDef.makeTerms(this.search.session,</span>
<a href="#l28.9"></a><span id="l28.9">                                                   aData);</span>
<a href="#l28.10"></a><span id="l28.10"> </span>
<a href="#l28.11"></a><span id="l28.11">     // - persist the view to the folder.</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-    if (!aDoNotPersist) {</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+    if (!aDoNotPersist &amp;&amp; this.displayedFolder) {</span>
<a href="#l28.14"></a><span id="l28.14">       let msgDatabase = this.displayedFolder.msgDatabase;</span>
<a href="#l28.15"></a><span id="l28.15">       if (msgDatabase) {</span>
<a href="#l28.16"></a><span id="l28.16">         let dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l28.17"></a><span id="l28.17">         dbFolderInfo.setUint32Property(MailViewConstants.kViewCurrent,</span>
<a href="#l28.18"></a><span id="l28.18">                                        this._mailViewIndex);</span>
<a href="#l28.19"></a><span id="l28.19">         // _mailViewData attempts to be sane and be the tag name, as opposed to</span>
<a href="#l28.20"></a><span id="l28.20">         //  magic-value &quot;:&quot;-prefixed value historically stored on disk.  Because</span>
<a href="#l28.21"></a><span id="l28.21">         //  we want to be forwards and backwards compatible, we put this back on</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineat">@@ -1896,16 +1896,18 @@ DBViewWrapper.prototype = {</span>
<a href="#l28.23"></a><span id="l28.23">    * @param aMessageId The message-id of the message you want.</span>
<a href="#l28.24"></a><span id="l28.24">    * @return The first nsIMsgDBHdr found in any of the underlying folders with</span>
<a href="#l28.25"></a><span id="l28.25">    *     the given message header, null if none are found.  The fact that we</span>
<a href="#l28.26"></a><span id="l28.26">    *     return something does not guarantee that it is actually visible in the</span>
<a href="#l28.27"></a><span id="l28.27">    *     view.  (The search may be filtering it out.)</span>
<a href="#l28.28"></a><span id="l28.28">    */</span>
<a href="#l28.29"></a><span id="l28.29">   getMsgHdrForMessageID: function DBViewWrapper_getMsgHdrForMessageID(</span>
<a href="#l28.30"></a><span id="l28.30">       aMessageId) {</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+    if (this._syntheticView)</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+      return this._syntheticView.getMsgHdrForMessageID(aMessageId);</span>
<a href="#l28.33"></a><span id="l28.33">     if (!this._underlyingFolders)</span>
<a href="#l28.34"></a><span id="l28.34">       return null;</span>
<a href="#l28.35"></a><span id="l28.35">     for (let [, folder] in Iterator(this._underlyingFolders)) {</span>
<a href="#l28.36"></a><span id="l28.36">       let msgHdr = folder.msgDatabase.getMsgHdrForMessageID(aMessageId);</span>
<a href="#l28.37"></a><span id="l28.37">       if (msgHdr)</span>
<a href="#l28.38"></a><span id="l28.38">         return msgHdr;</span>
<a href="#l28.39"></a><span id="l28.39">     }</span>
<a href="#l28.40"></a><span id="l28.40">     return null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/base/src/quickSearchManager.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/base/src/quickSearchManager.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -48,45 +48,85 @@</span>
<a href="#l29.4"></a><span id="l29.4"> </span>
<a href="#l29.5"></a><span id="l29.5"> EXPORTED_SYMBOLS = ['QuickSearchManager', 'QuickSearchConstants'];</span>
<a href="#l29.6"></a><span id="l29.6"> </span>
<a href="#l29.7"></a><span id="l29.7"> const Cc = Components.classes;</span>
<a href="#l29.8"></a><span id="l29.8"> const Ci = Components.interfaces;</span>
<a href="#l29.9"></a><span id="l29.9"> const Cr = Components.results;</span>
<a href="#l29.10"></a><span id="l29.10"> const Cu = Components.utils;</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+Cu.import(&quot;resource://app/modules/errUtils.js&quot;);</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+try {</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+  Cu.import(&quot;resource://app/modules/StringBundle.js&quot;);</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+} catch (e) {</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineplus">+  logException(e);</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+}</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineplus">+</span>
<a href="#l29.20"></a><span id="l29.20"> const nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l29.21"></a><span id="l29.21"> const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l29.22"></a><span id="l29.22"> const nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l29.23"></a><span id="l29.23"> </span>
<a href="#l29.24"></a><span id="l29.24"> /**</span>
<a href="#l29.25"></a><span id="l29.25">  * Constants originally found in searchBar.js bundled together into a single</span>
<a href="#l29.26"></a><span id="l29.26">  *  name-space contribution.</span>
<a href="#l29.27"></a><span id="l29.27">  *</span>
<a href="#l29.28"></a><span id="l29.28">  * These constants are used by quick-search-menupopup.  The state of</span>
<a href="#l29.29"></a><span id="l29.29">  *  quick-search-menupopup is persisted to localstore.rdf, so new values need</span>
<a href="#l29.30"></a><span id="l29.30">  *  new constants.</span>
<a href="#l29.31"></a><span id="l29.31">  */</span>
<a href="#l29.32"></a><span id="l29.32"> var QuickSearchConstants = {</span>
<a href="#l29.33"></a><span id="l29.33">   kQuickSearchSubject: 0,</span>
<a href="#l29.34"></a><span id="l29.34">   kQuickSearchFrom: 1,</span>
<a href="#l29.35"></a><span id="l29.35">   kQuickSearchFromOrSubject: 2,</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineminus">-  kQuickSearchBody: 3,</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineminus">-  // there used to be a kQuickSearchHighlight = 4, apparently removed</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineminus">-  kQuickSearchRecipient: 5,</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineminus">-  kQuickSearchRecipientOrSubject: 6,</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineplus">+  kQuickSearchRecipient: 3,</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineplus">+  kQuickSearchRecipientOrSubject: 4,</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineplus">+  kQuickSearchBody: 5</span>
<a href="#l29.43"></a><span id="l29.43"> };</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineplus">+const kQuickSearchCount = 6;</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineplus">+</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineplus">+var QuickSearchLabels = null; // populated dynamically from properties files</span>
<a href="#l29.47"></a><span id="l29.47"> </span>
<a href="#l29.48"></a><span id="l29.48"> /**</span>
<a href="#l29.49"></a><span id="l29.49">  * All quick search logic that takes us from a search string (and search mode)</span>
<a href="#l29.50"></a><span id="l29.50">  *  to a set of search terms goes in here.  Check out FolderDisplayWidget for</span>
<a href="#l29.51"></a><span id="l29.51">  *  display concerns involving views, or DBViewWrapper and SearchSpec for the</span>
<a href="#l29.52"></a><span id="l29.52">  *  actual nsIMsgDBView-related logic.</span>
<a href="#l29.53"></a><span id="l29.53">  */</span>
<a href="#l29.54"></a><span id="l29.54"> var QuickSearchManager = {</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineplus">+</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineplus">+  _modeLabels: {},</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineplus">+</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineplus">+  /** populate an associative array containing the labels from a properties file</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineplus">+  **/</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineplus">+  </span>
<a href="#l29.61"></a><span id="l29.61" class="difflineplus">+  loadLabels: function QuickSearchManager_loadLabels() {</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineplus">+    const quickSearchStrings =</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineplus">+      new StringBundle(&quot;chrome://messenger/locale/quickSearch.properties&quot;);</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineplus">+    this._modeLabels[QuickSearchConstants.kQuickSearchSubject] = quickSearchStrings.get(&quot;searchSubject.label&quot;);</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineplus">+    this._modeLabels[QuickSearchConstants.kQuickSearchFrom] = quickSearchStrings.get(&quot;searchFrom.label&quot;);</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineplus">+    this._modeLabels[QuickSearchConstants.kQuickSearchFromOrSubject] = quickSearchStrings.get(&quot;searchFromOrSubject.label&quot;);</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineplus">+    this._modeLabels[QuickSearchConstants.kQuickSearchRecipient] = quickSearchStrings.get(&quot;searchRecipient.label&quot;);</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineplus">+    this._modeLabels[QuickSearchConstants.kQuickSearchRecipientOrSubject] = quickSearchStrings.get(&quot;searchRecipientOrSubject.label&quot;);</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineplus">+    this._modeLabels[QuickSearchConstants.kQuickSearchBody] = quickSearchStrings.get(&quot;searchBody.label&quot;);</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineplus">+  },</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineplus">+  </span>
<a href="#l29.72"></a><span id="l29.72" class="difflineplus">+  /** create the structure that the UI needs to fully describe a quick search</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineplus">+      mode.</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineplus">+      </span>
<a href="#l29.75"></a><span id="l29.75" class="difflineplus">+      @return a list of array objects mapping 'value' to the constant specified in</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineplus">+      QuickSearchConstants, and 'label' to a localized string.</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineplus">+  **/</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineplus">+  getSearchModes: function QuickSearchManager_getSearchModes() {</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineplus">+    let modes =[];</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineplus">+    for (let i = 0; i &lt; kQuickSearchCount; i++)</span>
<a href="#l29.81"></a><span id="l29.81" class="difflineplus">+      modes.push({'value': i, 'label': this._modeLabels[i]});</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineplus">+    return modes;</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineplus">+  },</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineplus">+</span>
<a href="#l29.85"></a><span id="l29.85">   /**</span>
<a href="#l29.86"></a><span id="l29.86">    * Create the search terms for the given quick-search configuration.  This is</span>
<a href="#l29.87"></a><span id="l29.87">    *  intended to basically be directly used in the service of the UI without</span>
<a href="#l29.88"></a><span id="l29.88">    *  pre-processing.  If you want to add extra logic, probably add it in here</span>
<a href="#l29.89"></a><span id="l29.89">    *  (with appropriate refactoring.)</span>
<a href="#l29.90"></a><span id="l29.90">    * Callers should strongly consider using DBViewWrapper's search attribute</span>
<a href="#l29.91"></a><span id="l29.91">    *  (which is a SearchSpec)'s quickSearch method which in turn calls us.  The</span>
<a href="#l29.92"></a><span id="l29.92">    *  DBViewWrapper may in turn be embedded in a FolderDisplayWidget.  So an</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineat">@@ -178,9 +218,11 @@ var QuickSearchManager = {</span>
<a href="#l29.94"></a><span id="l29.94">         term.op = nsMsgSearchOp.Contains;</span>
<a href="#l29.95"></a><span id="l29.95">         term.booleanAnd = false;</span>
<a href="#l29.96"></a><span id="l29.96">         searchTerms.push(term);</span>
<a href="#l29.97"></a><span id="l29.97">       }</span>
<a href="#l29.98"></a><span id="l29.98">     }</span>
<a href="#l29.99"></a><span id="l29.99"> </span>
<a href="#l29.100"></a><span id="l29.100">     return searchTerms.length ? searchTerms : null;</span>
<a href="#l29.101"></a><span id="l29.101">   }</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineminus">-};</span>
<a href="#l29.103"></a><span id="l29.103">\ No newline at end of file</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineplus">+};</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineplus">+</span>
<a href="#l29.106"></a><span id="l29.106" class="difflineplus">+QuickSearchManager.loadLabels();</span>
<a href="#l29.107"></a><span id="l29.107">\ No newline at end of file</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/base/util/errUtils.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/base/util/errUtils.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -86,16 +86,17 @@ function Stringifier() {};</span>
<a href="#l30.4"></a><span id="l30.4"> Stringifier.prototype = {</span>
<a href="#l30.5"></a><span id="l30.5">   dumpObj: function (o, name) {</span>
<a href="#l30.6"></a><span id="l30.6">     this._reset();</span>
<a href="#l30.7"></a><span id="l30.7">     this._append(this.objectTreeAsString(o, true, true, 0));</span>
<a href="#l30.8"></a><span id="l30.8">     dump(this._asString());</span>
<a href="#l30.9"></a><span id="l30.9">   },</span>
<a href="#l30.10"></a><span id="l30.10"> </span>
<a href="#l30.11"></a><span id="l30.11">   dumpDOM: function(node, level, recursive) {</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+    this._reset();</span>
<a href="#l30.13"></a><span id="l30.13">     let s = this.DOMNodeAsString(node, level, recursive);</span>
<a href="#l30.14"></a><span id="l30.14">     dump(s);</span>
<a href="#l30.15"></a><span id="l30.15">   },</span>
<a href="#l30.16"></a><span id="l30.16"> </span>
<a href="#l30.17"></a><span id="l30.17">   dumpEvent: function(event) {</span>
<a href="#l30.18"></a><span id="l30.18">     dump(this.eventAsString(event));</span>
<a href="#l30.19"></a><span id="l30.19">   },</span>
<a href="#l30.20"></a><span id="l30.20"> </span>
<a href="#l30.21"></a><span id="l30.21" class="difflineat">@@ -196,17 +197,17 @@ Stringifier.prototype = {</span>
<a href="#l30.22"></a><span id="l30.22">                 s += pfx + tee + i + &quot; (&quot; + t + &quot;) &quot; + o[i].length + &quot; chars\n&quot;;</span>
<a href="#l30.23"></a><span id="l30.23">               else</span>
<a href="#l30.24"></a><span id="l30.24">                 s += pfx + tee + i + &quot; (&quot; + t + &quot;) '&quot; + o[i] + &quot;'\n&quot;;</span>
<a href="#l30.25"></a><span id="l30.25">               break;</span>
<a href="#l30.26"></a><span id="l30.26">             default:</span>
<a href="#l30.27"></a><span id="l30.27">               s += pfx + tee + i + &quot; (&quot; + t + &quot;) &quot; + o[i] + &quot;\n&quot;;</span>
<a href="#l30.28"></a><span id="l30.28">           }</span>
<a href="#l30.29"></a><span id="l30.29">         } catch (ex) {</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineminus">-          s += pfx + tee + i + &quot; (exception) &quot; + ex + &quot;\n&quot;;</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+          s += pfx + tee + &quot; (exception) &quot; + ex + &quot;\n&quot;;</span>
<a href="#l30.32"></a><span id="l30.32">         }</span>
<a href="#l30.33"></a><span id="l30.33">         if (!compress)</span>
<a href="#l30.34"></a><span id="l30.34">           s += pfx + &quot;|\n&quot;;</span>
<a href="#l30.35"></a><span id="l30.35">       }</span>
<a href="#l30.36"></a><span id="l30.36">     }</span>
<a href="#l30.37"></a><span id="l30.37">     s += pfx + &quot;*\n&quot;;</span>
<a href="#l30.38"></a><span id="l30.38">     return s;</span>
<a href="#l30.39"></a><span id="l30.39">   },</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineat">@@ -214,22 +215,20 @@ Stringifier.prototype = {</span>
<a href="#l30.41"></a><span id="l30.41">   _repeatStr: function (str, aCount) {</span>
<a href="#l30.42"></a><span id="l30.42">     let res = &quot;&quot;;</span>
<a href="#l30.43"></a><span id="l30.43">     while (--aCount &gt;= 0)</span>
<a href="#l30.44"></a><span id="l30.44">       res += str;</span>
<a href="#l30.45"></a><span id="l30.45">     return res;</span>
<a href="#l30.46"></a><span id="l30.46">   },</span>
<a href="#l30.47"></a><span id="l30.47"> </span>
<a href="#l30.48"></a><span id="l30.48">   DOMNodeAsString: function(node, level, recursive) {</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineminus">-    this._reset();</span>
<a href="#l30.50"></a><span id="l30.50">     if (level === undefined)</span>
<a href="#l30.51"></a><span id="l30.51">       level = 0</span>
<a href="#l30.52"></a><span id="l30.52">     if (recursive === undefined)</span>
<a href="#l30.53"></a><span id="l30.53">       recursive = true;</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineminus">-</span>
<a href="#l30.55"></a><span id="l30.55">     this._append(this._repeatStr(&quot; &quot;, 2*level) + &quot;&lt;&quot; + node.nodeName + &quot;\n&quot;);</span>
<a href="#l30.56"></a><span id="l30.56"> </span>
<a href="#l30.57"></a><span id="l30.57">     if (node.nodeType == 3) {</span>
<a href="#l30.58"></a><span id="l30.58">         this._append(this._repeatStr(&quot; &quot;, (2*level) + 4) + node.nodeValue + &quot;'\n&quot;);</span>
<a href="#l30.59"></a><span id="l30.59">     }</span>
<a href="#l30.60"></a><span id="l30.60">     else {</span>
<a href="#l30.61"></a><span id="l30.61">       if (node.attributes) {</span>
<a href="#l30.62"></a><span id="l30.62">         for (let i = 0; i &lt; node.attributes.length; i++) {</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineat">@@ -239,17 +238,17 @@ Stringifier.prototype = {</span>
<a href="#l30.64"></a><span id="l30.64">         }</span>
<a href="#l30.65"></a><span id="l30.65">       }</span>
<a href="#l30.66"></a><span id="l30.66">       if (node.childNodes.length == 0) {</span>
<a href="#l30.67"></a><span id="l30.67">         this._append(this._repeatStr(&quot; &quot;, (2*level)) + &quot;/&gt;\n&quot;);</span>
<a href="#l30.68"></a><span id="l30.68">       }</span>
<a href="#l30.69"></a><span id="l30.69">       else if (recursive) {</span>
<a href="#l30.70"></a><span id="l30.70">         this._append(this._repeatStr(&quot; &quot;, (2*level)) + &quot;&gt;\n&quot;);</span>
<a href="#l30.71"></a><span id="l30.71">         for (let i = 0; i &lt; node.childNodes.length; i++) {</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineminus">-          this.dumpDOM(node.childNodes[i], level + 1);</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineplus">+          this._append(this.DOMNodeAsString(node.childNodes[i], level + 1));</span>
<a href="#l30.74"></a><span id="l30.74">         }</span>
<a href="#l30.75"></a><span id="l30.75">         this._append(this._repeatStr(&quot; &quot;, 2*level) + &quot;&lt;/&quot; + node.nodeName + &quot;&gt;\n&quot;);</span>
<a href="#l30.76"></a><span id="l30.76">       }</span>
<a href="#l30.77"></a><span id="l30.77">     }</span>
<a href="#l30.78"></a><span id="l30.78">     return this._asString();</span>
<a href="#l30.79"></a><span id="l30.79">   },</span>
<a href="#l30.80"></a><span id="l30.80"> </span>
<a href="#l30.81"></a><span id="l30.81">   eventAsString: function (event) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/db/gloda/components/glautocomp.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/db/gloda/components/glautocomp.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -37,53 +37,64 @@</span>
<a href="#l31.4"></a><span id="l31.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l31.5"></a><span id="l31.5"> </span>
<a href="#l31.6"></a><span id="l31.6"> const Cc = Components.classes;</span>
<a href="#l31.7"></a><span id="l31.7"> const Ci = Components.interfaces;</span>
<a href="#l31.8"></a><span id="l31.8"> const Cr = Components.results;</span>
<a href="#l31.9"></a><span id="l31.9"> const Cu = Components.utils;</span>
<a href="#l31.10"></a><span id="l31.10"> </span>
<a href="#l31.11"></a><span id="l31.11"> Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-var LOG = null;</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+Cu.import(&quot;resource://gre/modules/errUtils.js&quot;);</span>
<a href="#l31.15"></a><span id="l31.15"> </span>
<a href="#l31.16"></a><span id="l31.16"> var Gloda = null;</span>
<a href="#l31.17"></a><span id="l31.17"> var GlodaUtils = null;</span>
<a href="#l31.18"></a><span id="l31.18"> var MultiSuffixTree = null;</span>
<a href="#l31.19"></a><span id="l31.19"> var TagNoun = null;</span>
<a href="#l31.20"></a><span id="l31.20"> var FreeTagNoun = null;</span>
<a href="#l31.21"></a><span id="l31.21"> </span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+function ResultRowFullText(aItem, words, typeForStyle, andTerms) {</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineplus">+  this.item = aItem;</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineplus">+  this.words = words;</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineplus">+  this.andTerms = andTerms;</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineplus">+  this.typeForStyle = &quot;gloda-fulltext-&quot; + typeForStyle;</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineplus">+}</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineplus">+ResultRowFullText.prototype = {</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineplus">+  multi: false,</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineplus">+  fullText: true</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+};</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+</span>
<a href="#l31.33"></a><span id="l31.33"> function ResultRowSingle(aItem, aCriteriaType, aCriteria, aExplicitNounID) {</span>
<a href="#l31.34"></a><span id="l31.34">   this.nounID = aExplicitNounID || aItem.NOUN_ID;</span>
<a href="#l31.35"></a><span id="l31.35">   this.nounDef = Gloda._nounIDToDef[this.nounID];</span>
<a href="#l31.36"></a><span id="l31.36">   this.criteriaType = aCriteriaType;</span>
<a href="#l31.37"></a><span id="l31.37">   this.criteria = aCriteria;</span>
<a href="#l31.38"></a><span id="l31.38">   this.item = aItem;</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineplus">+  this.typeForStyle = &quot;gloda-single-&quot; + this.nounDef.name;</span>
<a href="#l31.40"></a><span id="l31.40"> }</span>
<a href="#l31.41"></a><span id="l31.41"> ResultRowSingle.prototype = {</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineminus">-  multi: false</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineplus">+  multi: false,</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineplus">+  fullText: false</span>
<a href="#l31.45"></a><span id="l31.45"> };</span>
<a href="#l31.46"></a><span id="l31.46"> </span>
<a href="#l31.47"></a><span id="l31.47"> function ResultRowMulti(aNounID, aCriteriaType, aCriteria, aQuery) {</span>
<a href="#l31.48"></a><span id="l31.48">   this.nounID = aNounID;</span>
<a href="#l31.49"></a><span id="l31.49">   this.nounDef = Gloda._nounIDToDef[aNounID];</span>
<a href="#l31.50"></a><span id="l31.50">   this.criteriaType = aCriteriaType;</span>
<a href="#l31.51"></a><span id="l31.51">   this.criteria = aCriteria;</span>
<a href="#l31.52"></a><span id="l31.52">   this.collection = aQuery.getCollection(this);</span>
<a href="#l31.53"></a><span id="l31.53">   this.collection.becomeExplicit();</span>
<a href="#l31.54"></a><span id="l31.54">   this.renderer = null;</span>
<a href="#l31.55"></a><span id="l31.55"> }</span>
<a href="#l31.56"></a><span id="l31.56"> ResultRowMulti.prototype = {</span>
<a href="#l31.57"></a><span id="l31.57">   multi: true,</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineplus">+  typeForStyle: &quot;gloda-multi&quot;,</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineplus">+  fullText: false,</span>
<a href="#l31.60"></a><span id="l31.60">   onItemsAdded: function(aItems) {</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineminus">-    LOG.debug(&quot;RRM onItemsAdded: &quot; + aItems.length + &quot;: &quot; + aItems);</span>
<a href="#l31.62"></a><span id="l31.62">     if (this.renderer) {</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineminus">-      LOG.debug(&quot;RRM rendering...&quot;);</span>
<a href="#l31.64"></a><span id="l31.64">       for each (let [iItem, item] in Iterator(aItems)) {</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineminus">-        LOG.debug(&quot;RRM ...&quot; + item);</span>
<a href="#l31.66"></a><span id="l31.66">         this.renderer.renderItem(item);</span>
<a href="#l31.67"></a><span id="l31.67">       }</span>
<a href="#l31.68"></a><span id="l31.68">     }</span>
<a href="#l31.69"></a><span id="l31.69">   },</span>
<a href="#l31.70"></a><span id="l31.70">   onItemsModified: function(aItems) {</span>
<a href="#l31.71"></a><span id="l31.71">   },</span>
<a href="#l31.72"></a><span id="l31.72">   onItemsRemoved: function(aItems) {</span>
<a href="#l31.73"></a><span id="l31.73">   },</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineat">@@ -105,25 +116,22 @@ nsAutoCompleteGlodaResult.prototype = {</span>
<a href="#l31.75"></a><span id="l31.75">   getObjectAt: function(aIndex) {</span>
<a href="#l31.76"></a><span id="l31.76">     return this._results[aIndex];</span>
<a href="#l31.77"></a><span id="l31.77">   },</span>
<a href="#l31.78"></a><span id="l31.78">   markPending: function ACGR_markPending(aCompleter) {</span>
<a href="#l31.79"></a><span id="l31.79">     this._pendingCount++;</span>
<a href="#l31.80"></a><span id="l31.80">   },</span>
<a href="#l31.81"></a><span id="l31.81">   markCompleted: function ACGR_markCompleted(aCompleter) {</span>
<a href="#l31.82"></a><span id="l31.82">     if (--this._pendingCount == 0) {</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineminus">-      LOG.debug(&quot;Notifying completion.&quot;);</span>
<a href="#l31.84"></a><span id="l31.84">       this.listener.onSearchResult(this.completer, this);</span>
<a href="#l31.85"></a><span id="l31.85">     }</span>
<a href="#l31.86"></a><span id="l31.86">   },</span>
<a href="#l31.87"></a><span id="l31.87">   addRows: function ACGR_addRows(aRows) {</span>
<a href="#l31.88"></a><span id="l31.88">     if (!aRows.length)</span>
<a href="#l31.89"></a><span id="l31.89">       return;</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineminus">-    LOG.debug(&quot;Adding &quot; + aRows.length + &quot; rows (&quot; + this._pendingCount +</span>
<a href="#l31.91"></a><span id="l31.91" class="difflineminus">-              &quot; jobs still pending)&quot;);</span>
<a href="#l31.92"></a><span id="l31.92">     this._results.push.apply(this._results, aRows); </span>
<a href="#l31.93"></a><span id="l31.93">     this.listener.onSearchResult(this.completer, this);</span>
<a href="#l31.94"></a><span id="l31.94">   },</span>
<a href="#l31.95"></a><span id="l31.95">   // ==== nsIAutoCompleteResult</span>
<a href="#l31.96"></a><span id="l31.96">   searchString: null,</span>
<a href="#l31.97"></a><span id="l31.97">   get searchResult() {</span>
<a href="#l31.98"></a><span id="l31.98">     if (this._problem)</span>
<a href="#l31.99"></a><span id="l31.99">       return Ci.nsIAutoCompleteResult.RESULT_FAILURE;</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineat">@@ -152,36 +160,33 @@ nsAutoCompleteGlodaResult.prototype = {</span>
<a href="#l31.101"></a><span id="l31.101">     if (thing.value) // identity</span>
<a href="#l31.102"></a><span id="l31.102">       return thing.contact.name;</span>
<a href="#l31.103"></a><span id="l31.103">     else</span>
<a href="#l31.104"></a><span id="l31.104">       return thing.name || thing.subject;</span>
<a href="#l31.105"></a><span id="l31.105">   },</span>
<a href="#l31.106"></a><span id="l31.106">   // rich uses this to be the &quot;type&quot;</span>
<a href="#l31.107"></a><span id="l31.107">   getStyleAt: function(aIndex) {</span>
<a href="#l31.108"></a><span id="l31.108">     let row = this._results[aIndex];</span>
<a href="#l31.109"></a><span id="l31.109" class="difflineminus">-    if (row.multi)</span>
<a href="#l31.110"></a><span id="l31.110" class="difflineminus">-      return &quot;gloda-multi&quot;;</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineminus">-    else</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineminus">-      return &quot;gloda-single-&quot; + row.nounDef.name;</span>
<a href="#l31.113"></a><span id="l31.113" class="difflineplus">+    return row.typeForStyle;</span>
<a href="#l31.114"></a><span id="l31.114">   },</span>
<a href="#l31.115"></a><span id="l31.115">   // rich uses this to be the icon</span>
<a href="#l31.116"></a><span id="l31.116">   getImageAt: function(aIndex) {</span>
<a href="#l31.117"></a><span id="l31.117">     let thing = this._results[aIndex];</span>
<a href="#l31.118"></a><span id="l31.118">     if (!thing.value)</span>
<a href="#l31.119"></a><span id="l31.119">       return null;</span>
<a href="#l31.120"></a><span id="l31.120"> </span>
<a href="#l31.121"></a><span id="l31.121">     let md5hash = GlodaUtils.md5HashString(thing.value);</span>
<a href="#l31.122"></a><span id="l31.122">     let gravURL = &quot;http://www.gravatar.com/avatar/&quot; + md5hash +</span>
<a href="#l31.123"></a><span id="l31.123">                                 &quot;?d=identicon&amp;s=32&amp;r=g&quot;;</span>
<a href="#l31.124"></a><span id="l31.124">     return gravURL;</span>
<a href="#l31.125"></a><span id="l31.125">   },</span>
<a href="#l31.126"></a><span id="l31.126">   removeValueAt: function() {},</span>
<a href="#l31.127"></a><span id="l31.127"> </span>
<a href="#l31.128"></a><span id="l31.128">   _stop: function() {</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineminus">-  },</span>
<a href="#l31.130"></a><span id="l31.130" class="difflineplus">+  }</span>
<a href="#l31.131"></a><span id="l31.131"> };</span>
<a href="#l31.132"></a><span id="l31.132"> </span>
<a href="#l31.133"></a><span id="l31.133"> const MAX_POPULAR_CONTACTS = 200;</span>
<a href="#l31.134"></a><span id="l31.134"> </span>
<a href="#l31.135"></a><span id="l31.135"> /**</span>
<a href="#l31.136"></a><span id="l31.136">  * Complete contacts/identities based on name/email.  Instant phase is based on</span>
<a href="#l31.137"></a><span id="l31.137">  *  a suffix-tree built of popular contacts/identities.  Delayed phase relies</span>
<a href="#l31.138"></a><span id="l31.138">  *  on a LIKE search of all known contacts.</span>
<a href="#l31.139"></a><span id="l31.139" class="difflineat">@@ -197,17 +202,16 @@ ContactIdentityCompleter.prototype = {</span>
<a href="#l31.140"></a><span id="l31.140">   _popularitySorter: function(a, b){ return b.popularity - a.popularity; },</span>
<a href="#l31.141"></a><span id="l31.141">   complete: function ContactIdentityCompleter_complete(aResult, aString) {</span>
<a href="#l31.142"></a><span id="l31.142">     if (aString.length &lt; 3)</span>
<a href="#l31.143"></a><span id="l31.143">       return false;</span>
<a href="#l31.144"></a><span id="l31.144"> </span>
<a href="#l31.145"></a><span id="l31.145">     let matches;</span>
<a href="#l31.146"></a><span id="l31.146">     if (this.suffixTree) {</span>
<a href="#l31.147"></a><span id="l31.147">       matches = this.suffixTree.findMatches(aString.toLowerCase());</span>
<a href="#l31.148"></a><span id="l31.148" class="difflineminus">-      LOG.debug(&quot;CIC: Suffix Tree found &quot; + matches.length + &quot; matches.&quot;)</span>
<a href="#l31.149"></a><span id="l31.149">     }</span>
<a href="#l31.150"></a><span id="l31.150">     else</span>
<a href="#l31.151"></a><span id="l31.151">       matches = [];</span>
<a href="#l31.152"></a><span id="l31.152"> </span>
<a href="#l31.153"></a><span id="l31.153">     // let's filter out duplicates due to identity/contact double-hits by</span>
<a href="#l31.154"></a><span id="l31.154">     //  establishing a map based on the contact id for these guys.</span>
<a href="#l31.155"></a><span id="l31.155">     // let's also favor identities as we do it, because that gets us the</span>
<a href="#l31.156"></a><span id="l31.156">     //  most accurate gravat, potentially</span>
<a href="#l31.157"></a><span id="l31.157" class="difflineat">@@ -226,23 +230,21 @@ ContactIdentityCompleter.prototype = {</span>
<a href="#l31.158"></a><span id="l31.158"> </span>
<a href="#l31.159"></a><span id="l31.159">     let rows = [new ResultRowSingle(match, &quot;text&quot;, aResult.searchString)</span>
<a href="#l31.160"></a><span id="l31.160">                 for each ([iMatch, match] in Iterator(matches))];</span>
<a href="#l31.161"></a><span id="l31.161">     aResult.addRows(rows);</span>
<a href="#l31.162"></a><span id="l31.162"> </span>
<a href="#l31.163"></a><span id="l31.163">     // - match against database contacts / identities</span>
<a href="#l31.164"></a><span id="l31.164">     let pending = {contactToThing: contactToThing, pendingCount: 2};</span>
<a href="#l31.165"></a><span id="l31.165">     </span>
<a href="#l31.166"></a><span id="l31.166" class="difflineminus">-    LOG.debug(&quot;CIC: issuing contact LIKE query&quot;);</span>
<a href="#l31.167"></a><span id="l31.167">     let contactQuery = Gloda.newQuery(Gloda.NOUN_CONTACT);</span>
<a href="#l31.168"></a><span id="l31.168">     contactQuery.nameLike(contactQuery.WILD, aString, contactQuery.WILD);</span>
<a href="#l31.169"></a><span id="l31.169">     pending.contactColl = contactQuery.getCollection(this, aResult);</span>
<a href="#l31.170"></a><span id="l31.170">     pending.contactColl.becomeExplicit();</span>
<a href="#l31.171"></a><span id="l31.171"> </span>
<a href="#l31.172"></a><span id="l31.172" class="difflineminus">-    LOG.debug(&quot;CIC: issuing identity LIKE query&quot;);</span>
<a href="#l31.173"></a><span id="l31.173">     let identityQuery = Gloda.newQuery(Gloda.NOUN_IDENTITY);</span>
<a href="#l31.174"></a><span id="l31.174">     identityQuery.kind(&quot;email&quot;).valueLike(identityQuery.WILD, aString,</span>
<a href="#l31.175"></a><span id="l31.175">         identityQuery.WILD);</span>
<a href="#l31.176"></a><span id="l31.176">     pending.identityColl = identityQuery.getCollection(this, aResult);</span>
<a href="#l31.177"></a><span id="l31.177">     pending.identityColl.becomeExplicit();</span>
<a href="#l31.178"></a><span id="l31.178">     </span>
<a href="#l31.179"></a><span id="l31.179">     aResult._contactCompleterPending = pending;</span>
<a href="#l31.180"></a><span id="l31.180"> </span>
<a href="#l31.181"></a><span id="l31.181" class="difflineat">@@ -252,17 +254,16 @@ ContactIdentityCompleter.prototype = {</span>
<a href="#l31.182"></a><span id="l31.182">   },</span>
<a href="#l31.183"></a><span id="l31.183">   onItemsModified: function(aItems, aCollection) {</span>
<a href="#l31.184"></a><span id="l31.184">   },</span>
<a href="#l31.185"></a><span id="l31.185">   onItemsRemoved: function(aItems, aCollection) {</span>
<a href="#l31.186"></a><span id="l31.186">   },</span>
<a href="#l31.187"></a><span id="l31.187">   onQueryCompleted: function(aCollection) {</span>
<a href="#l31.188"></a><span id="l31.188">     // handle the initial setup case...</span>
<a href="#l31.189"></a><span id="l31.189">     if (aCollection.data == null) {</span>
<a href="#l31.190"></a><span id="l31.190" class="difflineminus">-      LOG.debug(&quot;CIC: Initial query found &quot; + aCollection.items.length);</span>
<a href="#l31.191"></a><span id="l31.191">       // cheat and explicitly add our own contact...</span>
<a href="#l31.192"></a><span id="l31.192">       if (!(Gloda.myContact.id in this.contactCollection._idMap))</span>
<a href="#l31.193"></a><span id="l31.193">         this.contactCollection._onItemsAdded([Gloda.myContact]);</span>
<a href="#l31.194"></a><span id="l31.194">         </span>
<a href="#l31.195"></a><span id="l31.195">       // the set of identities owned by the contacts is automatically loaded as part</span>
<a href="#l31.196"></a><span id="l31.196">       //  of the contact loading...</span>
<a href="#l31.197"></a><span id="l31.197">       // (but only if we actually have any contacts)</span>
<a href="#l31.198"></a><span id="l31.198">       this.identityCollection =</span>
<a href="#l31.199"></a><span id="l31.199" class="difflineat">@@ -285,18 +286,16 @@ ContactIdentityCompleter.prototype = {</span>
<a href="#l31.200"></a><span id="l31.200">       //  passed through to concat.  identityMails will likewise be undefined.</span>
<a href="#l31.201"></a><span id="l31.201">       this.suffixTree = new MultiSuffixTree(contactNames.concat(identityMails),</span>
<a href="#l31.202"></a><span id="l31.202">         this.contactCollection.items.concat(this.identityCollection &amp;&amp;</span>
<a href="#l31.203"></a><span id="l31.203">           this.identityCollection.items));</span>
<a href="#l31.204"></a><span id="l31.204">       </span>
<a href="#l31.205"></a><span id="l31.205">       return;</span>
<a href="#l31.206"></a><span id="l31.206">     }</span>
<a href="#l31.207"></a><span id="l31.207">     </span>
<a href="#l31.208"></a><span id="l31.208" class="difflineminus">-    LOG.debug(&quot;CIC: LIKE query found &quot; + aCollection.items.length);</span>
<a href="#l31.209"></a><span id="l31.209" class="difflineminus">-    </span>
<a href="#l31.210"></a><span id="l31.210">     // handle the completion case</span>
<a href="#l31.211"></a><span id="l31.211">     let result = aCollection.data;</span>
<a href="#l31.212"></a><span id="l31.212">     let pending = result._contactCompleterPending;</span>
<a href="#l31.213"></a><span id="l31.213">     </span>
<a href="#l31.214"></a><span id="l31.214">     if (--pending.pendingCount == 0) {</span>
<a href="#l31.215"></a><span id="l31.215">       let possibleDudes = [];</span>
<a href="#l31.216"></a><span id="l31.216">       </span>
<a href="#l31.217"></a><span id="l31.217">       let contactToThing = pending.contactToThing;</span>
<a href="#l31.218"></a><span id="l31.218" class="difflineat">@@ -332,19 +331,16 @@ ContactIdentityCompleter.prototype = {</span>
<a href="#l31.219"></a><span id="l31.219">       result.markCompleted(this);</span>
<a href="#l31.220"></a><span id="l31.220">       </span>
<a href="#l31.221"></a><span id="l31.221">       // the collections no longer care about the result, make it clear.</span>
<a href="#l31.222"></a><span id="l31.222">       delete pending.identityColl.data;</span>
<a href="#l31.223"></a><span id="l31.223">       delete pending.contactColl.data;</span>
<a href="#l31.224"></a><span id="l31.224">       // the result object no longer needs us or our data</span>
<a href="#l31.225"></a><span id="l31.225">       delete result._contactCompleterPending;</span>
<a href="#l31.226"></a><span id="l31.226">     }</span>
<a href="#l31.227"></a><span id="l31.227" class="difflineminus">-    else {</span>
<a href="#l31.228"></a><span id="l31.228" class="difflineminus">-      LOG.debug(&quot;ignoring... pending is still: &quot; + pending.pendingCount);</span>
<a href="#l31.229"></a><span id="l31.229" class="difflineminus">-    }</span>
<a href="#l31.230"></a><span id="l31.230">   }</span>
<a href="#l31.231"></a><span id="l31.231"> };</span>
<a href="#l31.232"></a><span id="l31.232"> </span>
<a href="#l31.233"></a><span id="l31.233"> /**</span>
<a href="#l31.234"></a><span id="l31.234">  * Complete tags that are used on contacts.</span>
<a href="#l31.235"></a><span id="l31.235">  */</span>
<a href="#l31.236"></a><span id="l31.236"> function ContactTagCompleter() {</span>
<a href="#l31.237"></a><span id="l31.237">   FreeTagNoun.populateKnownFreeTags();</span>
<a href="#l31.238"></a><span id="l31.238" class="difflineat">@@ -352,39 +348,35 @@ function ContactTagCompleter() {</span>
<a href="#l31.239"></a><span id="l31.239">   FreeTagNoun.addListener(this);</span>
<a href="#l31.240"></a><span id="l31.240"> }</span>
<a href="#l31.241"></a><span id="l31.241"> ContactTagCompleter.prototype = {</span>
<a href="#l31.242"></a><span id="l31.242">   _buildSuffixTree: function() {</span>
<a href="#l31.243"></a><span id="l31.243">     let tagNames = [], tags = [];</span>
<a href="#l31.244"></a><span id="l31.244">     for (let [tagName, tag] in Iterator(FreeTagNoun.knownFreeTags)) {</span>
<a href="#l31.245"></a><span id="l31.245">       tagNames.push(tagName.toLowerCase());</span>
<a href="#l31.246"></a><span id="l31.246">       tags.push(tag);</span>
<a href="#l31.247"></a><span id="l31.247" class="difflineminus">-      LOG.debug(&quot;contact tag: &quot; + tagName);</span>
<a href="#l31.248"></a><span id="l31.248">     }</span>
<a href="#l31.249"></a><span id="l31.249">     this._suffixTree = new MultiSuffixTree(tagNames, tags);</span>
<a href="#l31.250"></a><span id="l31.250">     this._suffixTreeDirty = false;</span>
<a href="#l31.251"></a><span id="l31.251">   },</span>
<a href="#l31.252"></a><span id="l31.252">   onFreeTagAdded: function(aTag) {</span>
<a href="#l31.253"></a><span id="l31.253">     this._suffixTreeDirty = true;</span>
<a href="#l31.254"></a><span id="l31.254">   },</span>
<a href="#l31.255"></a><span id="l31.255">   complete: function ContactTagCompleter_complete(aResult, aString) {</span>
<a href="#l31.256"></a><span id="l31.256">     // now is not the best time to do this; have onFreeTagAdded use a timer.</span>
<a href="#l31.257"></a><span id="l31.257">     if (this._suffixTreeDirty)</span>
<a href="#l31.258"></a><span id="l31.258">       this._buildSuffixTree();</span>
<a href="#l31.259"></a><span id="l31.259">     </span>
<a href="#l31.260"></a><span id="l31.260">     if (aString.length &lt; 2)</span>
<a href="#l31.261"></a><span id="l31.261">       return false; // no async mechanism that will add new rows</span>
<a href="#l31.262"></a><span id="l31.262">     </span>
<a href="#l31.263"></a><span id="l31.263" class="difflineminus">-    LOG.debug(&quot;Completing on contact tags...&quot;);</span>
<a href="#l31.264"></a><span id="l31.264" class="difflineminus">-    </span>
<a href="#l31.265"></a><span id="l31.265">     tags = this._suffixTree.findMatches(aString.toLowerCase());</span>
<a href="#l31.266"></a><span id="l31.266">     let rows = [];</span>
<a href="#l31.267"></a><span id="l31.267">     for each (let [iTag, tag] in Iterator(tags)) {</span>
<a href="#l31.268"></a><span id="l31.268">       let query = Gloda.newQuery(Gloda.NOUN_CONTACT);</span>
<a href="#l31.269"></a><span id="l31.269" class="difflineminus">-      LOG.debug(&quot;  checking for contact tag: &quot; + tag.name);</span>
<a href="#l31.270"></a><span id="l31.270">       query.freeTags(tag);</span>
<a href="#l31.271"></a><span id="l31.271">       let resRow = new ResultRowMulti(Gloda.NOUN_CONTACT, &quot;tag&quot;, tag.name,</span>
<a href="#l31.272"></a><span id="l31.272">                                       query);</span>
<a href="#l31.273"></a><span id="l31.273">       rows.push(resRow);</span>
<a href="#l31.274"></a><span id="l31.274">     }</span>
<a href="#l31.275"></a><span id="l31.275">     aResult.addRows(rows);</span>
<a href="#l31.276"></a><span id="l31.276">     </span>
<a href="#l31.277"></a><span id="l31.277">     return false; // no async mechanism that will add new rows</span>
<a href="#l31.278"></a><span id="l31.278" class="difflineat">@@ -400,107 +392,121 @@ function MessageTagCompleter() {</span>
<a href="#l31.279"></a><span id="l31.279"> MessageTagCompleter.prototype = {</span>
<a href="#l31.280"></a><span id="l31.280">   _buildSuffixTree: function MessageTagCompleter__buildSufficeTree() {</span>
<a href="#l31.281"></a><span id="l31.281">     let tagNames = [], tags = [];</span>
<a href="#l31.282"></a><span id="l31.282">     let tagArray = TagNoun.getAllTags();</span>
<a href="#l31.283"></a><span id="l31.283">     for (let iTag = 0; iTag &lt; tagArray.length; iTag++) {</span>
<a href="#l31.284"></a><span id="l31.284">       let tag = tagArray[iTag];</span>
<a href="#l31.285"></a><span id="l31.285">       tagNames.push(tag.tag.toLowerCase());</span>
<a href="#l31.286"></a><span id="l31.286">       tags.push(tag);</span>
<a href="#l31.287"></a><span id="l31.287" class="difflineminus">-      LOG.debug(&quot;message tag: &quot; + tag.tag);</span>
<a href="#l31.288"></a><span id="l31.288">     }</span>
<a href="#l31.289"></a><span id="l31.289">     this._suffixTree = new MultiSuffixTree(tagNames, tags);</span>
<a href="#l31.290"></a><span id="l31.290">     this._suffixTreeDirty = false;</span>
<a href="#l31.291"></a><span id="l31.291">   },</span>
<a href="#l31.292"></a><span id="l31.292">   complete: function MessageTagCompleter_complete(aResult, aString) {</span>
<a href="#l31.293"></a><span id="l31.293">     if (aString.length &lt; 2)</span>
<a href="#l31.294"></a><span id="l31.294">       return false;</span>
<a href="#l31.295"></a><span id="l31.295">     </span>
<a href="#l31.296"></a><span id="l31.296" class="difflineminus">-    LOG.debug(&quot;Completing on message tags...&quot;);</span>
<a href="#l31.297"></a><span id="l31.297" class="difflineminus">-    </span>
<a href="#l31.298"></a><span id="l31.298">     tags = this._suffixTree.findMatches(aString.toLowerCase());</span>
<a href="#l31.299"></a><span id="l31.299">     let rows = [];</span>
<a href="#l31.300"></a><span id="l31.300">     for each (let [, tag] in Iterator(tags)) {</span>
<a href="#l31.301"></a><span id="l31.301" class="difflineminus">-      LOG.debug(&quot; found message tag: &quot; + tag.tag);</span>
<a href="#l31.302"></a><span id="l31.302">       let resRow = new ResultRowSingle(tag, &quot;tag&quot;, tag.tag, TagNoun.id);</span>
<a href="#l31.303"></a><span id="l31.303">       rows.push(resRow);</span>
<a href="#l31.304"></a><span id="l31.304">     }</span>
<a href="#l31.305"></a><span id="l31.305">     aResult.addRows(rows);</span>
<a href="#l31.306"></a><span id="l31.306">     </span>
<a href="#l31.307"></a><span id="l31.307">     return false; // no async mechanism that will add new rows</span>
<a href="#l31.308"></a><span id="l31.308">   }</span>
<a href="#l31.309"></a><span id="l31.309"> };</span>
<a href="#l31.310"></a><span id="l31.310"> </span>
<a href="#l31.311"></a><span id="l31.311" class="difflineplus">+/**</span>
<a href="#l31.312"></a><span id="l31.312" class="difflineplus">+ * Complete with helpful hints about full-text search</span>
<a href="#l31.313"></a><span id="l31.313" class="difflineplus">+ */</span>
<a href="#l31.314"></a><span id="l31.314" class="difflineplus">+function FullTextCompleter() {</span>
<a href="#l31.315"></a><span id="l31.315" class="difflineplus">+}</span>
<a href="#l31.316"></a><span id="l31.316" class="difflineplus">+FullTextCompleter.prototype = {</span>
<a href="#l31.317"></a><span id="l31.317" class="difflineplus">+  complete: function FullTextCompleter_complete(aResult, aString) {</span>
<a href="#l31.318"></a><span id="l31.318" class="difflineplus">+    if (aString.length &lt; 2)</span>
<a href="#l31.319"></a><span id="l31.319" class="difflineplus">+      return false;</span>
<a href="#l31.320"></a><span id="l31.320" class="difflineplus">+    let rows = [];</span>
<a href="#l31.321"></a><span id="l31.321" class="difflineplus">+    let words = aString.trim().replace(/\s+/g, ' ').split(' ');</span>
<a href="#l31.322"></a><span id="l31.322" class="difflineplus">+    let numWords = words.length;</span>
<a href="#l31.323"></a><span id="l31.323" class="difflineplus">+    if (numWords == 1) {</span>
<a href="#l31.324"></a><span id="l31.324" class="difflineplus">+      let resRow = new ResultRowFullText(aString, words, &quot;single&quot;, false);</span>
<a href="#l31.325"></a><span id="l31.325" class="difflineplus">+      rows.push(resRow);</span>
<a href="#l31.326"></a><span id="l31.326" class="difflineplus">+    } else {</span>
<a href="#l31.327"></a><span id="l31.327" class="difflineplus">+      let resRow = new ResultRowFullText(aString, words, &quot;all&quot;, true);</span>
<a href="#l31.328"></a><span id="l31.328" class="difflineplus">+      rows.push(resRow);</span>
<a href="#l31.329"></a><span id="l31.329" class="difflineplus">+      resRow = new ResultRowFullText(aString, words, &quot;any&quot;, false);</span>
<a href="#l31.330"></a><span id="l31.330" class="difflineplus">+      rows.push(resRow);</span>
<a href="#l31.331"></a><span id="l31.331" class="difflineplus">+    }</span>
<a href="#l31.332"></a><span id="l31.332" class="difflineplus">+    aResult.addRows(rows);</span>
<a href="#l31.333"></a><span id="l31.333" class="difflineplus">+    return false; // no async mechanism that will add new rows</span>
<a href="#l31.334"></a><span id="l31.334" class="difflineplus">+  }</span>
<a href="#l31.335"></a><span id="l31.335" class="difflineplus">+};</span>
<a href="#l31.336"></a><span id="l31.336" class="difflineplus">+</span>
<a href="#l31.337"></a><span id="l31.337"> function nsAutoCompleteGloda() {</span>
<a href="#l31.338"></a><span id="l31.338">   this.wrappedJSObject = this;</span>
<a href="#l31.339"></a><span id="l31.339" class="difflineminus">-</span>
<a href="#l31.340"></a><span id="l31.340" class="difflineminus">-  // set up our awesome globals!</span>
<a href="#l31.341"></a><span id="l31.341" class="difflineminus">-  if (Gloda === null) {</span>
<a href="#l31.342"></a><span id="l31.342" class="difflineminus">-    let loadNS = {};</span>
<a href="#l31.343"></a><span id="l31.343" class="difflineminus">-</span>
<a href="#l31.344"></a><span id="l31.344" class="difflineminus">-    Cu.import(&quot;resource://app/modules/gloda/public.js&quot;, loadNS);</span>
<a href="#l31.345"></a><span id="l31.345" class="difflineminus">-    Gloda = loadNS.Gloda;</span>
<a href="#l31.346"></a><span id="l31.346" class="difflineminus">-</span>
<a href="#l31.347"></a><span id="l31.347" class="difflineminus">-    Cu.import(&quot;resource://app/modules/gloda/utils.js&quot;, loadNS);</span>
<a href="#l31.348"></a><span id="l31.348" class="difflineminus">-    GlodaUtils = loadNS.GlodaUtils;</span>
<a href="#l31.349"></a><span id="l31.349" class="difflineminus">-    Cu.import(&quot;resource://app/modules/gloda/suffixtree.js&quot;, loadNS);</span>
<a href="#l31.350"></a><span id="l31.350" class="difflineminus">-    MultiSuffixTree = loadNS.MultiSuffixTree;</span>
<a href="#l31.351"></a><span id="l31.351" class="difflineminus">-    Cu.import(&quot;resource://app/modules/gloda/noun_tag.js&quot;, loadNS);</span>
<a href="#l31.352"></a><span id="l31.352" class="difflineminus">-    TagNoun = loadNS.TagNoun;</span>
<a href="#l31.353"></a><span id="l31.353" class="difflineminus">-    Cu.import(&quot;resource://app/modules/gloda/noun_freetag.js&quot;, loadNS);</span>
<a href="#l31.354"></a><span id="l31.354" class="difflineminus">-    FreeTagNoun = loadNS.FreeTagNoun;</span>
<a href="#l31.355"></a><span id="l31.355" class="difflineminus">-</span>
<a href="#l31.356"></a><span id="l31.356" class="difflineminus">-    Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;, loadNS);</span>
<a href="#l31.357"></a><span id="l31.357" class="difflineminus">-    LOG = loadNS[&quot;Log4Moz&quot;].repository.getLogger(&quot;gloda.autocomp&quot;);</span>
<a href="#l31.358"></a><span id="l31.358" class="difflineminus">-  }</span>
<a href="#l31.359"></a><span id="l31.359" class="difflineplus">+  try {</span>
<a href="#l31.360"></a><span id="l31.360" class="difflineplus">+    // set up our awesome globals!</span>
<a href="#l31.361"></a><span id="l31.361" class="difflineplus">+    if (Gloda === null) {</span>
<a href="#l31.362"></a><span id="l31.362" class="difflineplus">+      let loadNS = {};</span>
<a href="#l31.363"></a><span id="l31.363" class="difflineplus">+      Cu.import(&quot;resource://app/modules/gloda/public.js&quot;, loadNS);</span>
<a href="#l31.364"></a><span id="l31.364" class="difflineplus">+      Gloda = loadNS.Gloda;</span>
<a href="#l31.365"></a><span id="l31.365" class="difflineplus">+  </span>
<a href="#l31.366"></a><span id="l31.366" class="difflineplus">+      Cu.import(&quot;resource://app/modules/gloda/utils.js&quot;, loadNS);</span>
<a href="#l31.367"></a><span id="l31.367" class="difflineplus">+      GlodaUtils = loadNS.GlodaUtils;</span>
<a href="#l31.368"></a><span id="l31.368" class="difflineplus">+      Cu.import(&quot;resource://app/modules/gloda/suffixtree.js&quot;, loadNS);</span>
<a href="#l31.369"></a><span id="l31.369" class="difflineplus">+      MultiSuffixTree = loadNS.MultiSuffixTree;</span>
<a href="#l31.370"></a><span id="l31.370" class="difflineplus">+      Cu.import(&quot;resource://app/modules/gloda/noun_tag.js&quot;, loadNS);</span>
<a href="#l31.371"></a><span id="l31.371" class="difflineplus">+      TagNoun = loadNS.TagNoun;</span>
<a href="#l31.372"></a><span id="l31.372" class="difflineplus">+      Cu.import(&quot;resource://app/modules/gloda/noun_freetag.js&quot;, loadNS);</span>
<a href="#l31.373"></a><span id="l31.373" class="difflineplus">+      FreeTagNoun = loadNS.FreeTagNoun;</span>
<a href="#l31.374"></a><span id="l31.374" class="difflineplus">+  </span>
<a href="#l31.375"></a><span id="l31.375" class="difflineplus">+      Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;, loadNS);</span>
<a href="#l31.376"></a><span id="l31.376" class="difflineplus">+      LOG = loadNS[&quot;Log4Moz&quot;].repository.getLogger(&quot;gloda.autocomp&quot;);</span>
<a href="#l31.377"></a><span id="l31.377" class="difflineplus">+    }</span>
<a href="#l31.378"></a><span id="l31.378"> </span>
<a href="#l31.379"></a><span id="l31.379" class="difflineminus">-  LOG.debug(&quot;initializing completers&quot;);</span>
<a href="#l31.380"></a><span id="l31.380" class="difflineminus">-</span>
<a href="#l31.381"></a><span id="l31.381" class="difflineminus">-  this.completers = [];</span>
<a href="#l31.382"></a><span id="l31.382" class="difflineminus">-  </span>
<a href="#l31.383"></a><span id="l31.383" class="difflineminus">-  this.curResult = null;</span>
<a href="#l31.384"></a><span id="l31.384" class="difflineplus">+    this.completers = [];</span>
<a href="#l31.385"></a><span id="l31.385" class="difflineplus">+    this.curResult = null;</span>
<a href="#l31.386"></a><span id="l31.386"> </span>
<a href="#l31.387"></a><span id="l31.387" class="difflineminus">-dump(&quot;init CIC\n&quot;);</span>
<a href="#l31.388"></a><span id="l31.388" class="difflineminus">-  LOG.debug(&quot;initializing ContactIdentityCompleter&quot;);</span>
<a href="#l31.389"></a><span id="l31.389" class="difflineminus">-  try {</span>
<a href="#l31.390"></a><span id="l31.390" class="difflineminus">-  this.completers.push(new ContactIdentityCompleter());</span>
<a href="#l31.391"></a><span id="l31.391" class="difflineminus">-  } catch (ex) {dump(&quot;CICEX: &quot; + ex.fileName + &quot;:&quot; + ex.lineNumber + &quot;: &quot; + ex);}</span>
<a href="#l31.392"></a><span id="l31.392" class="difflineminus">-dump(&quot;init CTC\n&quot;);</span>
<a href="#l31.393"></a><span id="l31.393" class="difflineminus">-  LOG.debug(&quot;initializing ContactTagCompleter&quot;);</span>
<a href="#l31.394"></a><span id="l31.394" class="difflineminus">-  this.completers.push(new ContactTagCompleter());</span>
<a href="#l31.395"></a><span id="l31.395" class="difflineminus">-dump(&quot;init MTC\n&quot;);</span>
<a href="#l31.396"></a><span id="l31.396" class="difflineminus">-  LOG.debug(&quot;initializing MessageTagCompleter&quot;);</span>
<a href="#l31.397"></a><span id="l31.397" class="difflineminus">-  try {</span>
<a href="#l31.398"></a><span id="l31.398" class="difflineminus">-  this.completers.push(new MessageTagCompleter());</span>
<a href="#l31.399"></a><span id="l31.399" class="difflineminus">-  } catch (ex) {dump(&quot;MTCEX: &quot; + ex.fileName + &quot;:&quot; + ex.lineNumber + &quot;: &quot; + ex);}</span>
<a href="#l31.400"></a><span id="l31.400" class="difflineminus">-  </span>
<a href="#l31.401"></a><span id="l31.401" class="difflineminus">-  LOG.debug(&quot;initialized completers&quot;);</span>
<a href="#l31.402"></a><span id="l31.402" class="difflineplus">+    this.completers.push(new FullTextCompleter());</span>
<a href="#l31.403"></a><span id="l31.403" class="difflineplus">+    this.completers.push(new ContactIdentityCompleter());</span>
<a href="#l31.404"></a><span id="l31.404" class="difflineplus">+    this.completers.push(new ContactTagCompleter());</span>
<a href="#l31.405"></a><span id="l31.405" class="difflineplus">+    this.completers.push(new MessageTagCompleter());</span>
<a href="#l31.406"></a><span id="l31.406" class="difflineplus">+  } catch (e) {</span>
<a href="#l31.407"></a><span id="l31.407" class="difflineplus">+    logException(e);</span>
<a href="#l31.408"></a><span id="l31.408" class="difflineplus">+  }</span>
<a href="#l31.409"></a><span id="l31.409"> }</span>
<a href="#l31.410"></a><span id="l31.410"> </span>
<a href="#l31.411"></a><span id="l31.411"> nsAutoCompleteGloda.prototype = {</span>
<a href="#l31.412"></a><span id="l31.412">   classDescription: &quot;AutoCompleteGloda&quot;,</span>
<a href="#l31.413"></a><span id="l31.413">   contractID: &quot;@mozilla.org/autocomplete/search;1?name=gloda&quot;,</span>
<a href="#l31.414"></a><span id="l31.414" class="difflineminus">-  classID: Components.ID(&quot;{3bbe4d77-3f70-4252-9500-bc00c26f476c}&quot;),</span>
<a href="#l31.415"></a><span id="l31.415" class="difflineplus">+  classID: Components.ID(&quot;{3bbe4d77-3f70-4252-9500-bc00c26f476d}&quot;),</span>
<a href="#l31.416"></a><span id="l31.416">   QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l31.417"></a><span id="l31.417">       Components.interfaces.nsIAutoCompleteSearch]),</span>
<a href="#l31.418"></a><span id="l31.418"> </span>
<a href="#l31.419"></a><span id="l31.419">   startSearch: function(aString, aParam, aResult, aListener) {</span>
<a href="#l31.420"></a><span id="l31.420" class="difflineminus">-    let result = new nsAutoCompleteGlodaResult(aListener, this, aString);</span>
<a href="#l31.421"></a><span id="l31.421" class="difflineminus">-    // save this for hacky access to the search.  I somewhat suspect we simply</span>
<a href="#l31.422"></a><span id="l31.422" class="difflineminus">-    //  should not be using the formal autocomplete mechanism at all.</span>
<a href="#l31.423"></a><span id="l31.423" class="difflineminus">-    this.curResult = result;</span>
<a href="#l31.424"></a><span id="l31.424" class="difflineminus">-    </span>
<a href="#l31.425"></a><span id="l31.425" class="difflineminus">-    for each (let [iCompleter, completer] in Iterator(this.completers)) {</span>
<a href="#l31.426"></a><span id="l31.426" class="difflineminus">-      // they will return true if they have something pending.</span>
<a href="#l31.427"></a><span id="l31.427" class="difflineminus">-      if (completer.complete(result, aString))</span>
<a href="#l31.428"></a><span id="l31.428" class="difflineminus">-        result.markPending(completer);</span>
<a href="#l31.429"></a><span id="l31.429" class="difflineplus">+    try {</span>
<a href="#l31.430"></a><span id="l31.430" class="difflineplus">+      let result = new nsAutoCompleteGlodaResult(aListener, this, aString);</span>
<a href="#l31.431"></a><span id="l31.431" class="difflineplus">+      // save this for hacky access to the search.  I somewhat suspect we simply</span>
<a href="#l31.432"></a><span id="l31.432" class="difflineplus">+      //  should not be using the formal autocomplete mechanism at all.</span>
<a href="#l31.433"></a><span id="l31.433" class="difflineplus">+      this.curResult = result;</span>
<a href="#l31.434"></a><span id="l31.434" class="difflineplus">+      </span>
<a href="#l31.435"></a><span id="l31.435" class="difflineplus">+      for each (let [iCompleter, completer] in Iterator(this.completers)) {</span>
<a href="#l31.436"></a><span id="l31.436" class="difflineplus">+        // they will return true if they have something pending.</span>
<a href="#l31.437"></a><span id="l31.437" class="difflineplus">+        if (completer.complete(result, aString))</span>
<a href="#l31.438"></a><span id="l31.438" class="difflineplus">+          result.markPending(completer);</span>
<a href="#l31.439"></a><span id="l31.439" class="difflineplus">+      }</span>
<a href="#l31.440"></a><span id="l31.440" class="difflineplus">+      </span>
<a href="#l31.441"></a><span id="l31.441" class="difflineplus">+      aListener.onSearchResult(this, result);</span>
<a href="#l31.442"></a><span id="l31.442" class="difflineplus">+    } catch (e) {</span>
<a href="#l31.443"></a><span id="l31.443" class="difflineplus">+      logException(e);</span>
<a href="#l31.444"></a><span id="l31.444">     }</span>
<a href="#l31.445"></a><span id="l31.445" class="difflineminus">-    </span>
<a href="#l31.446"></a><span id="l31.446" class="difflineminus">-    aListener.onSearchResult(this, result);</span>
<a href="#l31.447"></a><span id="l31.447">   },</span>
<a href="#l31.448"></a><span id="l31.448"> </span>
<a href="#l31.449"></a><span id="l31.449">   stopSearch: function() {</span>
<a href="#l31.450"></a><span id="l31.450" class="difflineminus">-  },</span>
<a href="#l31.451"></a><span id="l31.451" class="difflineplus">+  }</span>
<a href="#l31.452"></a><span id="l31.452"> };</span>
<a href="#l31.453"></a><span id="l31.453"> </span>
<a href="#l31.454"></a><span id="l31.454"> function NSGetModule(compMgr, fileSpec) {</span>
<a href="#l31.455"></a><span id="l31.455">   return XPCOMUtils.generateModule([nsAutoCompleteGloda]);</span>
<a href="#l31.456"></a><span id="l31.456"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/db/gloda/content/glodacomplete.css</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/db/gloda/content/glodacomplete.css</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -1,37 +1,62 @@</span>
<a href="#l32.4"></a><span id="l32.4"> textbox[type=&quot;glodacomplete&quot;] {</span>
<a href="#l32.5"></a><span id="l32.5">   -moz-binding: url(&quot;chrome://global/content/bindings/autocomplete.xml#autocomplete&quot;);</span>
<a href="#l32.6"></a><span id="l32.6" class="difflineplus">+  width: 400px;</span>
<a href="#l32.7"></a><span id="l32.7"> }</span>
<a href="#l32.8"></a><span id="l32.8"> </span>
<a href="#l32.9"></a><span id="l32.9"> panel[type=&quot;glodacomplete-richlistbox&quot;] {</span>
<a href="#l32.10"></a><span id="l32.10">   -moz-binding: url(&quot;chrome://gloda/content/glodacomplete.xml#glodacomplete-rich-result-popup&quot;);</span>
<a href="#l32.11"></a><span id="l32.11"> }</span>
<a href="#l32.12"></a><span id="l32.12"> </span>
<a href="#l32.13"></a><span id="l32.13"> .autocomplete-richlistbox {</span>
<a href="#l32.14"></a><span id="l32.14">   -moz-binding: url(&quot;chrome://global/content/bindings/autocomplete.xml#autocomplete-richlistbox&quot;);</span>
<a href="#l32.15"></a><span id="l32.15">   -moz-user-focus: ignore;</span>
<a href="#l32.16"></a><span id="l32.16">   -moz-appearance: none;</span>
<a href="#l32.17"></a><span id="l32.17"> }</span>
<a href="#l32.18"></a><span id="l32.18"> </span>
<a href="#l32.19"></a><span id="l32.19"> .autocomplete-richlistbox &gt; scrollbox {</span>
<a href="#l32.20"></a><span id="l32.20">   overflow-x: hidden !important;</span>
<a href="#l32.21"></a><span id="l32.21"> }</span>
<a href="#l32.22"></a><span id="l32.22"> </span>
<a href="#l32.23"></a><span id="l32.23" class="difflineplus">+.parameters {</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineplus">+  font-style: italic;</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineplus">+  margin-left: 1em;</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineplus">+}</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineplus">+.picture {</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineplus">+  margin: 1ex;</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineplus">+  margin-right: 1em;</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineplus">+}</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineplus">+</span>
<a href="#l32.32"></a><span id="l32.32"> .autocomplete-richlistitem[type=&quot;gloda-single-tag&quot;] {</span>
<a href="#l32.33"></a><span id="l32.33">   -moz-binding: url(&quot;chrome://gloda/content/glodacomplete.xml#gloda-single-tag-item&quot;);</span>
<a href="#l32.34"></a><span id="l32.34">   overflow: -moz-hidden-unscrollable;</span>
<a href="#l32.35"></a><span id="l32.35"> }</span>
<a href="#l32.36"></a><span id="l32.36"> </span>
<a href="#l32.37"></a><span id="l32.37"> .autocomplete-richlistitem[type=&quot;gloda-single-identity&quot;] {</span>
<a href="#l32.38"></a><span id="l32.38">   -moz-binding: url(&quot;chrome://gloda/content/glodacomplete.xml#gloda-single-identity-item&quot;);</span>
<a href="#l32.39"></a><span id="l32.39">   -moz-box-orient: vertical;</span>
<a href="#l32.40"></a><span id="l32.40">   overflow: -moz-hidden-unscrollable;</span>
<a href="#l32.41"></a><span id="l32.41"> }</span>
<a href="#l32.42"></a><span id="l32.42"> </span>
<a href="#l32.43"></a><span id="l32.43" class="difflineplus">+.autocomplete-richlistitem[type=&quot;gloda-fulltext-single&quot;] {</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineplus">+  -moz-binding: url(&quot;chrome://gloda/content/glodacomplete.xml#gloda-fulltext-single-item&quot;);</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineplus">+  overflow: -moz-hidden-unscrollable;</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineplus">+}</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineplus">+</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineplus">+.autocomplete-richlistitem[type=&quot;gloda-fulltext-any&quot;] {</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineplus">+  -moz-binding: url(&quot;chrome://gloda/content/glodacomplete.xml#gloda-fulltext-any-item&quot;);</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+  overflow: -moz-hidden-unscrollable;</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+}</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineplus">+</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineplus">+.autocomplete-richlistitem[type=&quot;gloda-fulltext-all&quot;] {</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineplus">+  -moz-binding: url(&quot;chrome://gloda/content/glodacomplete.xml#gloda-fulltext-all-item&quot;);</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineplus">+  overflow: -moz-hidden-unscrollable;</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineplus">+}</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineplus">+</span>
<a href="#l32.58"></a><span id="l32.58"> richlistitem[type=&quot;gloda-contact-chunk&quot;] {</span>
<a href="#l32.59"></a><span id="l32.59">   -moz-binding: url(&quot;chrome://gloda/content/glodacomplete.xml#gloda-contact-chunk&quot;);</span>
<a href="#l32.60"></a><span id="l32.60">   -moz-box-orient: vertical;</span>
<a href="#l32.61"></a><span id="l32.61">   overflow: -moz-hidden-unscrollable;</span>
<a href="#l32.62"></a><span id="l32.62"> }</span>
<a href="#l32.63"></a><span id="l32.63"> </span>
<a href="#l32.64"></a><span id="l32.64"> .autocomplete-richlistitem[type=&quot;gloda-multi&quot;] {</span>
<a href="#l32.65"></a><span id="l32.65">   -moz-binding: url(&quot;chrome://gloda/content/glodacomplete.xml#gloda-multi-item&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/db/gloda/content/glodacomplete.xml</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/db/gloda/content/glodacomplete.xml</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -355,27 +355,134 @@</span>
<a href="#l33.4"></a><span id="l33.4">             return &quot;tag &quot; + this.row.item.tag;</span>
<a href="#l33.5"></a><span id="l33.5">           ]]&gt;</span>
<a href="#l33.6"></a><span id="l33.6">         &lt;/getter&gt;</span>
<a href="#l33.7"></a><span id="l33.7">       &lt;/property&gt;</span>
<a href="#l33.8"></a><span id="l33.8">       </span>
<a href="#l33.9"></a><span id="l33.9">       &lt;method name=&quot;_adjustAcItem&quot;&gt;</span>
<a href="#l33.10"></a><span id="l33.10">         &lt;body&gt;</span>
<a href="#l33.11"></a><span id="l33.11">           &lt;![CDATA[</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-          this._explanation.value = &quot;messages tagged &quot; + this.row.item.tag;</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+          this._explanation.value = &quot;messages tagged &quot; + this.row.item.tag; // XXX l10n</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+          ]]&gt;</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+    &lt;/implementation&gt;</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+  &lt;/binding&gt;</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineplus">+</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineplus">+  &lt;binding id=&quot;gloda-fulltext-single-item&quot; extends=&quot;chrome://gloda/content/glodacomplete.xml#glodacomplete-base-richlistitem&quot;&gt;</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineplus">+    &lt;content orient=&quot;vertical&quot;&gt;</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineplus">+      &lt;xul:description anonid=&quot;explanation&quot;/&gt;</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineplus">+      &lt;xul:description anonid=&quot;parameters&quot;/&gt;</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+    &lt;/content&gt;</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineplus">+    &lt;implementation implements=&quot;nsIDOMXULSelectControlItemElement&quot;&gt;</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+      &lt;constructor&gt;</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineplus">+        &lt;![CDATA[</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineplus">+            this._explanation = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;explanation&quot;);</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineplus">+</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+            this._adjustAcItem();</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+          ]]&gt;</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineplus">+      &lt;/constructor&gt;</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+      </span>
<a href="#l33.35"></a><span id="l33.35" class="difflineplus">+      &lt;property name=&quot;label&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+        &lt;getter&gt;</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineplus">+            return &quot;full text search: &quot; + this.row.item;</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineplus">+          ]]&gt;</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineplus">+        &lt;/getter&gt;</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+      </span>
<a href="#l33.43"></a><span id="l33.43" class="difflineplus">+      &lt;method name=&quot;_adjustAcItem&quot;&gt;</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineplus">+          try {</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineplus">+            this._explanation.value = &quot;messages mentioning &quot; + this.row.item; // XXX l10n</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineplus">+            } catch (e) {</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineplus">+            logException(e);</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+            }</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+          ]]&gt;</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineplus">+    &lt;/implementation&gt;</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineplus">+  &lt;/binding&gt;</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineplus">+</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineplus">+</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineplus">+</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineplus">+  &lt;binding id=&quot;gloda-fulltext-any-item&quot; extends=&quot;chrome://gloda/content/glodacomplete.xml#glodacomplete-base-richlistitem&quot;&gt;</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+    &lt;content orient=&quot;vertical&quot;&gt;</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineplus">+      &lt;xul:description anonid=&quot;explanation&quot;/&gt;</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineplus">+      &lt;xul:description anonid=&quot;parameters&quot; class=&quot;parameters&quot;/&gt;</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineplus">+    &lt;/content&gt;</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineplus">+    &lt;implementation implements=&quot;nsIDOMXULSelectControlItemElement&quot;&gt;</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+      &lt;constructor&gt;</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineplus">+        &lt;![CDATA[</span>
<a href="#l33.67"></a><span id="l33.67" class="difflineplus">+            this._explanation = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;explanation&quot;);</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineplus">+            this._parameters = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;parameters&quot;);</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineplus">+</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineplus">+            this._adjustAcItem();</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineplus">+          ]]&gt;</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineplus">+      &lt;/constructor&gt;</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineplus">+      </span>
<a href="#l33.74"></a><span id="l33.74" class="difflineplus">+      &lt;property name=&quot;label&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineplus">+        &lt;getter&gt;</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineplus">+            return &quot;full text search: &quot; + this.row.item;</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineplus">+          ]]&gt;</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineplus">+        &lt;/getter&gt;</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineplus">+      </span>
<a href="#l33.82"></a><span id="l33.82" class="difflineplus">+      &lt;method name=&quot;_adjustAcItem&quot;&gt;</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineplus">+          this._explanation.value = &quot;messages with ANY of: &quot;</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineplus">+          this._parameters.value = this.row.words.join(&quot;, &quot;); // XXX l10n</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineplus">+          ]]&gt;</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineplus">+        &lt;/body&gt;</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineplus">+    &lt;/implementation&gt;</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineplus">+  &lt;/binding&gt;</span>
<a href="#l33.92"></a><span id="l33.92" class="difflineplus">+</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineplus">+  &lt;binding id=&quot;gloda-fulltext-all-item&quot; extends=&quot;chrome://gloda/content/glodacomplete.xml#glodacomplete-base-richlistitem&quot;&gt;</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineplus">+    &lt;content orient=&quot;vertical&quot;&gt;</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineplus">+      &lt;xul:description anonid=&quot;explanation&quot;/&gt;</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineplus">+      &lt;xul:description anonid=&quot;parameters&quot; class=&quot;parameters&quot;/&gt;</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineplus">+    &lt;/content&gt;</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineplus">+    &lt;implementation implements=&quot;nsIDOMXULSelectControlItemElement&quot;&gt;</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineplus">+      &lt;constructor&gt;</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineplus">+        &lt;![CDATA[</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineplus">+            this._explanation = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;explanation&quot;);</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineplus">+            this._parameters = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;parameters&quot;);</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineplus">+</span>
<a href="#l33.104"></a><span id="l33.104" class="difflineplus">+            this._adjustAcItem();</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineplus">+          ]]&gt;</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineplus">+      &lt;/constructor&gt;</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineplus">+      </span>
<a href="#l33.108"></a><span id="l33.108" class="difflineplus">+      &lt;property name=&quot;label&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineplus">+        &lt;getter&gt;</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l33.111"></a><span id="l33.111" class="difflineplus">+            return &quot;full text search: &quot; + this.row.item;</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineplus">+          ]]&gt;</span>
<a href="#l33.113"></a><span id="l33.113" class="difflineplus">+        &lt;/getter&gt;</span>
<a href="#l33.114"></a><span id="l33.114" class="difflineplus">+      &lt;/property&gt;</span>
<a href="#l33.115"></a><span id="l33.115" class="difflineplus">+      </span>
<a href="#l33.116"></a><span id="l33.116" class="difflineplus">+      &lt;method name=&quot;_adjustAcItem&quot;&gt;</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineplus">+        &lt;body&gt;</span>
<a href="#l33.118"></a><span id="l33.118" class="difflineplus">+          &lt;![CDATA[</span>
<a href="#l33.119"></a><span id="l33.119" class="difflineplus">+          this._explanation.value = &quot;messages with ALL of: &quot;</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineplus">+          this._parameters.value = this.row.words.join(&quot;, &quot;); // XXX l10n</span>
<a href="#l33.121"></a><span id="l33.121">           ]]&gt;</span>
<a href="#l33.122"></a><span id="l33.122">         &lt;/body&gt;</span>
<a href="#l33.123"></a><span id="l33.123">       &lt;/method&gt;</span>
<a href="#l33.124"></a><span id="l33.124">     &lt;/implementation&gt;</span>
<a href="#l33.125"></a><span id="l33.125">   &lt;/binding&gt;</span>
<a href="#l33.126"></a><span id="l33.126"> </span>
<a href="#l33.127"></a><span id="l33.127">   &lt;binding id=&quot;gloda-single-identity-item&quot; extends=&quot;chrome://gloda/content/glodacomplete.xml#glodacomplete-base-richlistitem&quot;&gt;</span>
<a href="#l33.128"></a><span id="l33.128">     &lt;content&gt;</span>
<a href="#l33.129"></a><span id="l33.129">       &lt;xul:hbox&gt;</span>
<a href="#l33.130"></a><span id="l33.130" class="difflineminus">-	    &lt;xul:image anonid=&quot;picture&quot;/&gt;</span>
<a href="#l33.131"></a><span id="l33.131" class="difflineplus">+	    &lt;xul:image anonid=&quot;picture&quot; class=&quot;picture&quot;/&gt;</span>
<a href="#l33.132"></a><span id="l33.132"> 	    &lt;xul:vbox&gt;</span>
<a href="#l33.133"></a><span id="l33.133"> 	      &lt;xul:hbox&gt;</span>
<a href="#l33.134"></a><span id="l33.134"> 	        &lt;xul:hbox anonid=&quot;name-box&quot; class=&quot;ac-title&quot; flex=&quot;1&quot;</span>
<a href="#l33.135"></a><span id="l33.135"> 	                  onunderflow=&quot;_doUnderflow('_name');&quot;&gt;</span>
<a href="#l33.136"></a><span id="l33.136"> 	          &lt;xul:description anonid=&quot;name&quot; class=&quot;ac-normal-text ac-comment&quot;</span>
<a href="#l33.137"></a><span id="l33.137"> 	                           xbl:inherits=&quot;selected&quot;/&gt;</span>
<a href="#l33.138"></a><span id="l33.138"> 	        &lt;/xul:hbox&gt;</span>
<a href="#l33.139"></a><span id="l33.139"> 	        &lt;xul:label anonid=&quot;name-overflow-ellipsis&quot; xbl:inherits=&quot;selected&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/db/gloda/modules/collection.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/collection.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -592,16 +592,17 @@ GlodaCollection.prototype = {</span>
<a href="#l34.4"></a><span id="l34.4">       catch (ex) {</span>
<a href="#l34.5"></a><span id="l34.5">         LOG.error(&quot;caught exception from listener in onItemsRemoved: &quot; +</span>
<a href="#l34.6"></a><span id="l34.6">             ex.fileName + &quot;:&quot; + ex.lineNumber + &quot;: &quot; + ex);</span>
<a href="#l34.7"></a><span id="l34.7">       }</span>
<a href="#l34.8"></a><span id="l34.8">     }</span>
<a href="#l34.9"></a><span id="l34.9">   },</span>
<a href="#l34.10"></a><span id="l34.10"> </span>
<a href="#l34.11"></a><span id="l34.11">   _onQueryCompleted: function gloda_coll_onQueryCompleted() {</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineplus">+    this.query.completed = true;</span>
<a href="#l34.13"></a><span id="l34.13">     if (this._listener &amp;&amp; this._listener.onQueryCompleted)</span>
<a href="#l34.14"></a><span id="l34.14">       this._listener.onQueryCompleted(this);</span>
<a href="#l34.15"></a><span id="l34.15">   }</span>
<a href="#l34.16"></a><span id="l34.16"> };</span>
<a href="#l34.17"></a><span id="l34.17"> </span>
<a href="#l34.18"></a><span id="l34.18"> /**</span>
<a href="#l34.19"></a><span id="l34.19">  * Create an LRU cache collection for the given noun with the given size.</span>
<a href="#l34.20"></a><span id="l34.20">  * @constructor</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datamodel.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datamodel.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -201,16 +201,20 @@ GlodaConversation.prototype = {</span>
<a href="#l35.4"></a><span id="l35.4">     let query = new GlodaMessage.prototype.NOUN_DEF.queryClass();</span>
<a href="#l35.5"></a><span id="l35.5">     query.conversation(this._id).orderBy(&quot;date&quot;);</span>
<a href="#l35.6"></a><span id="l35.6">     return query.getCollection(aListener, aData);</span>
<a href="#l35.7"></a><span id="l35.7">   },</span>
<a href="#l35.8"></a><span id="l35.8"> </span>
<a href="#l35.9"></a><span id="l35.9">   toString: function gloda_conversation_toString() {</span>
<a href="#l35.10"></a><span id="l35.10">     return &quot;Conversation:&quot; + this._id;</span>
<a href="#l35.11"></a><span id="l35.11">   },</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+  toLocaleString: function gloda_conversation_toLocaleString() {</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+    return this._subject;</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+  }</span>
<a href="#l35.16"></a><span id="l35.16"> };</span>
<a href="#l35.17"></a><span id="l35.17"> </span>
<a href="#l35.18"></a><span id="l35.18"> function GlodaFolder(aDatastore, aID, aURI, aDirtyStatus, aPrettyName,</span>
<a href="#l35.19"></a><span id="l35.19">                      aIndexingPriority) {</span>
<a href="#l35.20"></a><span id="l35.20">   this._datastore = aDatastore;</span>
<a href="#l35.21"></a><span id="l35.21">   this._id = aID;</span>
<a href="#l35.22"></a><span id="l35.22">   this._uri = aURI;</span>
<a href="#l35.23"></a><span id="l35.23">   this._dirtyStatus = aDirtyStatus;</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineat">@@ -260,24 +264,35 @@ GlodaFolder.prototype = {</span>
<a href="#l35.25"></a><span id="l35.25">       this._datastore.updateFolderDirtyStatus(this);</span>
<a href="#l35.26"></a><span id="l35.26">     }</span>
<a href="#l35.27"></a><span id="l35.27">   },</span>
<a href="#l35.28"></a><span id="l35.28">   get name() { return this._prettyName; },</span>
<a href="#l35.29"></a><span id="l35.29">   toString: function gloda_folder_toString() {</span>
<a href="#l35.30"></a><span id="l35.30">     return &quot;Folder:&quot; + this._id;</span>
<a href="#l35.31"></a><span id="l35.31">   },</span>
<a href="#l35.32"></a><span id="l35.32"> </span>
<a href="#l35.33"></a><span id="l35.33" class="difflineplus">+  toLocaleString: function gloda_folder_toLocaleString() {</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+    let xpcomFolder = this.getXPCOMFolder(this.kActivityFolderOnlyNoData);</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineplus">+    if (!xpcomFolder)</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+      return this._prettyName;</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineplus">+    return xpcomFolder.prettiestName +</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineplus">+      &quot; (&quot; + xpcomFolder.rootFolder.prettiestName + &quot;)&quot;;</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineplus">+  },</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineplus">+</span>
<a href="#l35.41"></a><span id="l35.41">   get indexingPriority() {</span>
<a href="#l35.42"></a><span id="l35.42">     return this._indexingPriority;</span>
<a href="#l35.43"></a><span id="l35.43">   },</span>
<a href="#l35.44"></a><span id="l35.44"> </span>
<a href="#l35.45"></a><span id="l35.45">   /** We are going to index this folder. */</span>
<a href="#l35.46"></a><span id="l35.46">   kActivityIndexing: 0,</span>
<a href="#l35.47"></a><span id="l35.47">   /** Asking for the folder to perform header retrievals. */</span>
<a href="#l35.48"></a><span id="l35.48">   kActivityHeaderRetrieval: 1,</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineplus">+  /** We only want the folder for its metadata but are not going to open it. */</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineplus">+  kActivityFolderOnlyNoData: 2,</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineplus">+</span>
<a href="#l35.52"></a><span id="l35.52"> </span>
<a href="#l35.53"></a><span id="l35.53">   /** Is this folder known to be actively used for indexing? */</span>
<a href="#l35.54"></a><span id="l35.54">   _activeIndexing: false,</span>
<a href="#l35.55"></a><span id="l35.55">   /** Get our indexing status. */</span>
<a href="#l35.56"></a><span id="l35.56">   get indexing() {</span>
<a href="#l35.57"></a><span id="l35.57">     return this._activeIndexing;</span>
<a href="#l35.58"></a><span id="l35.58">   },</span>
<a href="#l35.59"></a><span id="l35.59">   /**</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineat">@@ -319,16 +334,19 @@ GlodaFolder.prototype = {</span>
<a href="#l35.61"></a><span id="l35.61">         //  that independently and only for header retrieval.</span>
<a href="#l35.62"></a><span id="l35.62">         this.indexing = true;</span>
<a href="#l35.63"></a><span id="l35.63">         break;</span>
<a href="#l35.64"></a><span id="l35.64">       case this.kActivityHeaderRetrieval:</span>
<a href="#l35.65"></a><span id="l35.65">         if (this._activeHeaderRetrievalLastStamp === 0)</span>
<a href="#l35.66"></a><span id="l35.66">           this._datastore.markFolderLive(this);</span>
<a href="#l35.67"></a><span id="l35.67">         this._activeHeaderRetrievalLastStamp = Date.now();</span>
<a href="#l35.68"></a><span id="l35.68">         break;</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineplus">+      case this.kActivityFolderOnlyNoData:</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineplus">+        // we don't have to do anything here.</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineplus">+        break;</span>
<a href="#l35.72"></a><span id="l35.72">     }</span>
<a href="#l35.73"></a><span id="l35.73"> </span>
<a href="#l35.74"></a><span id="l35.74">     return this._xpcomFolder;</span>
<a href="#l35.75"></a><span id="l35.75">   },</span>
<a href="#l35.76"></a><span id="l35.76"> </span>
<a href="#l35.77"></a><span id="l35.77">   /**</span>
<a href="#l35.78"></a><span id="l35.78">    * How many milliseconds must a folder have not had any header retrieval</span>
<a href="#l35.79"></a><span id="l35.79">    *  activity before it's okay to lose the database reference?</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineat">@@ -623,16 +641,22 @@ GlodaIdentity.prototype = {</span>
<a href="#l35.81"></a><span id="l35.81">   get uniqueValue() {</span>
<a href="#l35.82"></a><span id="l35.82">     return this._kind + &quot;@&quot; + this._value;</span>
<a href="#l35.83"></a><span id="l35.83">   },</span>
<a href="#l35.84"></a><span id="l35.84"> </span>
<a href="#l35.85"></a><span id="l35.85">   toString: function gloda_identity_toString() {</span>
<a href="#l35.86"></a><span id="l35.86">     return &quot;Identity:&quot; + this._kind + &quot;:&quot; + this._value;</span>
<a href="#l35.87"></a><span id="l35.87">   },</span>
<a href="#l35.88"></a><span id="l35.88"> </span>
<a href="#l35.89"></a><span id="l35.89" class="difflineplus">+  toLocaleString: function gloda_identity_toLocaleString() {</span>
<a href="#l35.90"></a><span id="l35.90" class="difflineplus">+    if (this.contact.name == this.value)</span>
<a href="#l35.91"></a><span id="l35.91" class="difflineplus">+      return this.value;</span>
<a href="#l35.92"></a><span id="l35.92" class="difflineplus">+    return this.contact.name + &quot; : &quot; + this.value;</span>
<a href="#l35.93"></a><span id="l35.93" class="difflineplus">+  },</span>
<a href="#l35.94"></a><span id="l35.94" class="difflineplus">+</span>
<a href="#l35.95"></a><span id="l35.95">   get abCard() {</span>
<a href="#l35.96"></a><span id="l35.96">     // for our purposes, the address book only speaks email</span>
<a href="#l35.97"></a><span id="l35.97">     if (this._kind != &quot;email&quot;)</span>
<a href="#l35.98"></a><span id="l35.98">       return false;</span>
<a href="#l35.99"></a><span id="l35.99">     let card = GlodaUtils.getCardForEmail(this._value);</span>
<a href="#l35.100"></a><span id="l35.100">     if (card)</span>
<a href="#l35.101"></a><span id="l35.101">       this._hasAddressBookCard = true;</span>
<a href="#l35.102"></a><span id="l35.102">     return card;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -548,17 +548,17 @@ var GlodaDatastore = {</span>
<a href="#l36.4"></a><span id="l36.4">   kConstraintIn: 1,</span>
<a href="#l36.5"></a><span id="l36.5">   kConstraintRanges: 2,</span>
<a href="#l36.6"></a><span id="l36.6">   kConstraintEquals: 3,</span>
<a href="#l36.7"></a><span id="l36.7">   kConstraintStringLike: 4,</span>
<a href="#l36.8"></a><span id="l36.8">   kConstraintFulltext: 5,</span>
<a href="#l36.9"></a><span id="l36.9"> </span>
<a href="#l36.10"></a><span id="l36.10">   /* ******************* SCHEMA ******************* */</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-  _schemaVersion: 12,</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+  _schemaVersion: 13,</span>
<a href="#l36.14"></a><span id="l36.14">   _schema: {</span>
<a href="#l36.15"></a><span id="l36.15">     tables: {</span>
<a href="#l36.16"></a><span id="l36.16"> </span>
<a href="#l36.17"></a><span id="l36.17">       // ----- Messages</span>
<a href="#l36.18"></a><span id="l36.18">       folderLocations: {</span>
<a href="#l36.19"></a><span id="l36.19">         columns: [</span>
<a href="#l36.20"></a><span id="l36.20">           [&quot;id&quot;, &quot;INTEGER PRIMARY KEY&quot;],</span>
<a href="#l36.21"></a><span id="l36.21">           [&quot;folderURI&quot;, &quot;TEXT NOT NULL&quot;],</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineat">@@ -983,16 +983,19 @@ var GlodaDatastore = {</span>
<a href="#l36.23"></a><span id="l36.23"> </span>
<a href="#l36.24"></a><span id="l36.24">     aDBConnection.schemaVersion = this._schemaVersion;</span>
<a href="#l36.25"></a><span id="l36.25">   },</span>
<a href="#l36.26"></a><span id="l36.26"> </span>
<a href="#l36.27"></a><span id="l36.27">   /**</span>
<a href="#l36.28"></a><span id="l36.28">    * Create a table for a noun, replete with data binding.</span>
<a href="#l36.29"></a><span id="l36.29">    */</span>
<a href="#l36.30"></a><span id="l36.30">   createNounTable: function gloda_ds_createTableIfNotExists(aNounDef) {</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineplus">+    // give it a _jsonText attribute if appropriate...</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineplus">+    if (aNounDef.allowsArbitraryAttrs)</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineplus">+      aNounDef.schema.columns.push(['jsonAttributes', 'STRING', '_jsonText']);</span>
<a href="#l36.34"></a><span id="l36.34">     // check if the table exists</span>
<a href="#l36.35"></a><span id="l36.35">     if (!this.asyncConnection.tableExists(aNounDef.tableName)) {</span>
<a href="#l36.36"></a><span id="l36.36">       // it doesn't! create it (and its potentially many variants)</span>
<a href="#l36.37"></a><span id="l36.37">       try {</span>
<a href="#l36.38"></a><span id="l36.38">         this._createTableSchema(this.asyncConnection, aNounDef.tableName,</span>
<a href="#l36.39"></a><span id="l36.39">                                 aNounDef.schema);</span>
<a href="#l36.40"></a><span id="l36.40">       }</span>
<a href="#l36.41"></a><span id="l36.41">       catch (ex) {</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineat">@@ -1023,17 +1026,25 @@ var GlodaDatastore = {</span>
<a href="#l36.43"></a><span id="l36.43">    */</span>
<a href="#l36.44"></a><span id="l36.44">   _migrate: function gloda_ds_migrate(aDBService, aDBFile, aDBConnection,</span>
<a href="#l36.45"></a><span id="l36.45">                                       aCurVersion, aNewVersion) {</span>
<a href="#l36.46"></a><span id="l36.46"> </span>
<a href="#l36.47"></a><span id="l36.47">     // version 12:</span>
<a href="#l36.48"></a><span id="l36.48">     // - notability column added</span>
<a href="#l36.49"></a><span id="l36.49">     // version 13:</span>
<a href="#l36.50"></a><span id="l36.50">     // - we are adding a new fulltext index column. blow away!</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineminus">-    if (aCurVersion &lt; 13) {</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineplus">+    // - note that I screwed up and failed to mark the schema change; apparently</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineplus">+    //   no database will claim to be version 13...</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineplus">+    // version 14:</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineplus">+    // - new attributes: forwarded, repliedTo, bcc, recipients</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineplus">+    // - altered fromMeTo and fromMeCc to fromMe</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineplus">+    // - altered toMe and ccMe to just be toMe</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineplus">+    // - exposes bcc to cc-related attributes</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineplus">+    // - MIME type DB schema overhaul</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineplus">+    if (aCurVersion &lt; 14) {</span>
<a href="#l36.61"></a><span id="l36.61">       aDBConnection.close();</span>
<a href="#l36.62"></a><span id="l36.62">       aDBFile.remove(false);</span>
<a href="#l36.63"></a><span id="l36.63">       this._log.warn(&quot;Global database has been purged due to schema change.&quot;);</span>
<a href="#l36.64"></a><span id="l36.64">       return this._createDB(aDBService, aDBFile);</span>
<a href="#l36.65"></a><span id="l36.65">     }</span>
<a href="#l36.66"></a><span id="l36.66"> </span>
<a href="#l36.67"></a><span id="l36.67">     aDBConnection.schemaVersion = aNewVersion;</span>
<a href="#l36.68"></a><span id="l36.68"> </span>
<a href="#l36.69"></a><span id="l36.69" class="difflineat">@@ -2094,17 +2105,17 @@ var GlodaDatastore = {</span>
<a href="#l36.70"></a><span id="l36.70">       date = null;</span>
<a href="#l36.71"></a><span id="l36.71">     else</span>
<a href="#l36.72"></a><span id="l36.72">       date = new Date(aRow.getInt64(4) / 1000);</span>
<a href="#l36.73"></a><span id="l36.73">     if (aRow.getTypeOfIndex(7) == Ci.mozIStorageValueArray.VALUE_TYPE_NULL)</span>
<a href="#l36.74"></a><span id="l36.74">       jsonText = undefined;</span>
<a href="#l36.75"></a><span id="l36.75">     else</span>
<a href="#l36.76"></a><span id="l36.76">       jsonText = aRow.getString(7);</span>
<a href="#l36.77"></a><span id="l36.77">     // only queryFromQuery queries will have these columns</span>
<a href="#l36.78"></a><span id="l36.78" class="difflineminus">-    if (aRow.numEntries == 14) {</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineplus">+    if (aRow.numEntries &gt;= 14) {</span>
<a href="#l36.80"></a><span id="l36.80">       if (aRow.getTypeOfIndex(9) == Ci.mozIStorageValueArray.VALUE_TYPE_NULL)</span>
<a href="#l36.81"></a><span id="l36.81">         subject = undefined;</span>
<a href="#l36.82"></a><span id="l36.82">       else</span>
<a href="#l36.83"></a><span id="l36.83">         subject = aRow.getString(9);</span>
<a href="#l36.84"></a><span id="l36.84">       if (aRow.getTypeOfIndex(10) == Ci.mozIStorageValueArray.VALUE_TYPE_NULL)</span>
<a href="#l36.85"></a><span id="l36.85">         indexedBodyText = undefined;</span>
<a href="#l36.86"></a><span id="l36.86">       else</span>
<a href="#l36.87"></a><span id="l36.87">         indexedBodyText = aRow.getString(10);</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineat">@@ -2975,17 +2986,17 @@ var GlodaDatastore = {</span>
<a href="#l36.89"></a><span id="l36.89">       // we don't want to overwrite the existing listener or its data, but this</span>
<a href="#l36.90"></a><span id="l36.90">       //  does raise the question about what should happen if we get passed in</span>
<a href="#l36.91"></a><span id="l36.91">       //  a different listener and/or data.</span>
<a href="#l36.92"></a><span id="l36.92">       if (aListenerData !== undefined)</span>
<a href="#l36.93"></a><span id="l36.93">         collection.data = aListenerData;</span>
<a href="#l36.94"></a><span id="l36.94">     }</span>
<a href="#l36.95"></a><span id="l36.95">     if (aListenerData) {</span>
<a href="#l36.96"></a><span id="l36.96">       if (collection.dataStack)</span>
<a href="#l36.97"></a><span id="l36.97" class="difflineminus">-        collection.dataStack.push(aListenerData)</span>
<a href="#l36.98"></a><span id="l36.98" class="difflineplus">+        collection.dataStack.push(aListenerData);</span>
<a href="#l36.99"></a><span id="l36.99">       else</span>
<a href="#l36.100"></a><span id="l36.100">         collection.dataStack = [aListenerData];</span>
<a href="#l36.101"></a><span id="l36.101">     }</span>
<a href="#l36.102"></a><span id="l36.102"> </span>
<a href="#l36.103"></a><span id="l36.103">     statement.executeAsync(new QueryFromQueryCallback(statement, aNounDef,</span>
<a href="#l36.104"></a><span id="l36.104">       collection));</span>
<a href="#l36.105"></a><span id="l36.105">     statement.finalize();</span>
<a href="#l36.106"></a><span id="l36.106">     return collection;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/db/gloda/modules/dbview.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/dbview.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -35,158 +35,122 @@</span>
<a href="#l37.4"></a><span id="l37.4">  *</span>
<a href="#l37.5"></a><span id="l37.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l37.6"></a><span id="l37.6"> </span>
<a href="#l37.7"></a><span id="l37.7"> /*</span>
<a href="#l37.8"></a><span id="l37.8">  * This file is charged with providing you a way to have a pretty gloda-backed</span>
<a href="#l37.9"></a><span id="l37.9">  *  nsIMsgDBView.</span>
<a href="#l37.10"></a><span id="l37.10">  */</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-EXPORTED_SYMBOLS = [&quot;GlodaSyntheticSearchView&quot;, &quot;GlodaViewFactory&quot;];</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+EXPORTED_SYMBOLS = [&quot;GlodaSyntheticView&quot;];</span>
<a href="#l37.14"></a><span id="l37.14"> </span>
<a href="#l37.15"></a><span id="l37.15"> const Cc = Components.classes;</span>
<a href="#l37.16"></a><span id="l37.16"> const Ci = Components.interfaces;</span>
<a href="#l37.17"></a><span id="l37.17"> const Cr = Components.results;</span>
<a href="#l37.18"></a><span id="l37.18"> const Cu = Components.utils;</span>
<a href="#l37.19"></a><span id="l37.19"> </span>
<a href="#l37.20"></a><span id="l37.20"> Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l37.21"></a><span id="l37.21"> </span>
<a href="#l37.22"></a><span id="l37.22"> Cu.import(&quot;resource://app/modules/gloda/public.js&quot;);</span>
<a href="#l37.23"></a><span id="l37.23"> Cu.import(&quot;resource://app/modules/gloda/msg_search.js&quot;);</span>
<a href="#l37.24"></a><span id="l37.24"> </span>
<a href="#l37.25"></a><span id="l37.25" class="difflineminus">-function GlodaScoreColumn(aSearcher) {</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineminus">-  this.searcher = aSearcher;</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineminus">-}</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineminus">-GlodaScoreColumn.prototype = {</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineminus">-  id: &quot;glodaScoreCol&quot;,</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineminus">-  bindToView: function (aDBView) {</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineminus">-    this.dbView = aDBView;</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineminus">-  },</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineplus">+/**</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineplus">+ * Create a synthetic view suitable for passing to |FolderDisplayWidget.show|.</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineplus">+ * You must pass a query, collection, or conversation in.</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineplus">+ *</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineplus">+ * @param {GlodaQuery} [aArgs.query] A gloda query to run.</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineplus">+ * @param {GlodaCollection} [aArgs.collection] An already-populated collection</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineplus">+ *     to display.  Do not call getCollection on a query and hand us that.  We</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineplus">+ *     will not register ourselves as a listener and things will not work.</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineplus">+ * @param {GlodaConversation} [aArgs.conversation] A conversation whose messages</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineplus">+ *     you want to display.</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineplus">+ */</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineplus">+function GlodaSyntheticView(aArgs) {</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineplus">+  if (&quot;query&quot; in aArgs) {</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineplus">+    this.query = aArgs.query;</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineplus">+    this.collection = this.query.getCollection(this);</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineplus">+    this.completed = false;</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineplus">+  }</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineplus">+  else if (&quot;collection&quot; in aArgs) {</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineplus">+    this.query = null;</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineplus">+    this.collection = aArgs.collection;</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineplus">+    this.completed = true;</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineplus">+  }</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineplus">+  else if (&quot;conversation&quot; in aArgs) {</span>
<a href="#l37.56"></a><span id="l37.56" class="difflineplus">+    this.collection = aArgs.conversation.getMessagesCollection(this);</span>
<a href="#l37.57"></a><span id="l37.57" class="difflineplus">+    this.query = this.collection.query;</span>
<a href="#l37.58"></a><span id="l37.58" class="difflineplus">+    this.completed = false;</span>
<a href="#l37.59"></a><span id="l37.59" class="difflineplus">+  }</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineplus">+  else {</span>
<a href="#l37.61"></a><span id="l37.61" class="difflineplus">+    throw new Error(&quot;You need to pass a query or collection&quot;);</span>
<a href="#l37.62"></a><span id="l37.62" class="difflineplus">+  }</span>
<a href="#l37.63"></a><span id="l37.63"> </span>
<a href="#l37.64"></a><span id="l37.64" class="difflineminus">-  getCellText: function(row, col) {</span>
<a href="#l37.65"></a><span id="l37.65" class="difflineminus">-    let folder = this.dbView.getFolderForViewIndex(row);</span>
<a href="#l37.66"></a><span id="l37.66" class="difflineminus">-    let key = this.dbView.getKeyAt(row);</span>
<a href="#l37.67"></a><span id="l37.67" class="difflineminus">-    return &quot;&quot; + this.searcher.scoresByUriAndKey[folder.URI + &quot;-&quot; + key];</span>
<a href="#l37.68"></a><span id="l37.68" class="difflineminus">-  },</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineminus">-  getSortLongForRow:   function(hdr) {</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineminus">-    return this.searcher.scoresByUriAndKey[</span>
<a href="#l37.71"></a><span id="l37.71" class="difflineminus">-      hdr.folder.URI + &quot;-&quot; + hdr.messageKey] || 0;</span>
<a href="#l37.72"></a><span id="l37.72" class="difflineminus">-  },</span>
<a href="#l37.73"></a><span id="l37.73" class="difflineminus">-  isString: function() {</span>
<a href="#l37.74"></a><span id="l37.74" class="difflineminus">-    return false;</span>
<a href="#l37.75"></a><span id="l37.75" class="difflineminus">-  },</span>
<a href="#l37.76"></a><span id="l37.76" class="difflineminus">-</span>
<a href="#l37.77"></a><span id="l37.77" class="difflineminus">-  getCellProperties:   function(row, col, props){},</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineminus">-  getRowProperties:    function(row, props){},</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineminus">-  getImageSrc:         function(row, col) {return null;},</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineminus">-  getSortStringForRow: function(hdr) {</span>
<a href="#l37.81"></a><span id="l37.81" class="difflineminus">-    return null;</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineminus">-  },</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineminus">-};</span>
<a href="#l37.84"></a><span id="l37.84" class="difflineminus">-</span>
<a href="#l37.85"></a><span id="l37.85" class="difflineminus">-function GlodaWhyColumn(aSearcher) {</span>
<a href="#l37.86"></a><span id="l37.86" class="difflineminus">-  this.searcher = aSearcher;</span>
<a href="#l37.87"></a><span id="l37.87" class="difflineplus">+  this.customColumns = [];</span>
<a href="#l37.88"></a><span id="l37.88"> }</span>
<a href="#l37.89"></a><span id="l37.89" class="difflineminus">-GlodaWhyColumn.prototype = {</span>
<a href="#l37.90"></a><span id="l37.90" class="difflineminus">-  id: &quot;glodaWhyCol&quot;,</span>
<a href="#l37.91"></a><span id="l37.91" class="difflineminus">-  bindToView: function (aDBView) {</span>
<a href="#l37.92"></a><span id="l37.92" class="difflineminus">-    this.dbView = aDBView;</span>
<a href="#l37.93"></a><span id="l37.93" class="difflineminus">-  },</span>
<a href="#l37.94"></a><span id="l37.94" class="difflineminus">-</span>
<a href="#l37.95"></a><span id="l37.95" class="difflineminus">-  getCellText: function(row, col) {</span>
<a href="#l37.96"></a><span id="l37.96" class="difflineminus">-    let folder = this.dbView.getFolderForViewIndex(row);</span>
<a href="#l37.97"></a><span id="l37.97" class="difflineminus">-    let key = this.dbView.getKeyAt(row);</span>
<a href="#l37.98"></a><span id="l37.98" class="difflineminus">-    return this.searcher.whysByUriAndKey[folder.URI + &quot;-&quot; + key] || &quot;&quot;;</span>
<a href="#l37.99"></a><span id="l37.99" class="difflineminus">-  },</span>
<a href="#l37.100"></a><span id="l37.100" class="difflineminus">-  getSortStringForRow: function(hdr) {</span>
<a href="#l37.101"></a><span id="l37.101" class="difflineminus">-    return this.searcher.whysByUriAndKey[hdr.folder.URI + &quot;-&quot; + hdr.messageKey]</span>
<a href="#l37.102"></a><span id="l37.102" class="difflineminus">-      || &quot;&quot;;</span>
<a href="#l37.103"></a><span id="l37.103" class="difflineminus">-  },</span>
<a href="#l37.104"></a><span id="l37.104" class="difflineminus">-  isString: function() {</span>
<a href="#l37.105"></a><span id="l37.105" class="difflineminus">-    return true;</span>
<a href="#l37.106"></a><span id="l37.106" class="difflineminus">-  },</span>
<a href="#l37.107"></a><span id="l37.107" class="difflineminus">-</span>
<a href="#l37.108"></a><span id="l37.108" class="difflineminus">-  getCellProperties:   function(row, col, props){},</span>
<a href="#l37.109"></a><span id="l37.109" class="difflineminus">-  getRowProperties:    function(row, props){},</span>
<a href="#l37.110"></a><span id="l37.110" class="difflineminus">-  getImageSrc:         function(row, col) {return null;},</span>
<a href="#l37.111"></a><span id="l37.111" class="difflineminus">-  getSortLongForRow:   function(hdr) {return 0;}</span>
<a href="#l37.112"></a><span id="l37.112" class="difflineminus">-};</span>
<a href="#l37.113"></a><span id="l37.113" class="difflineminus">-</span>
<a href="#l37.114"></a><span id="l37.114" class="difflineminus">-function GlodaSyntheticSearchView(aSearchString, aFacetString, aLocation) {</span>
<a href="#l37.115"></a><span id="l37.115" class="difflineminus">-  this.searcher = new GlodaMsgSearcher(this, aSearchString.split(&quot; &quot;));</span>
<a href="#l37.116"></a><span id="l37.116" class="difflineminus">-</span>
<a href="#l37.117"></a><span id="l37.117" class="difflineminus">-  this._whyColumn = new GlodaWhyColumn(this.searcher);</span>
<a href="#l37.118"></a><span id="l37.118" class="difflineminus">-  this._scoreColumn = new GlodaScoreColumn(this.searcher);</span>
<a href="#l37.119"></a><span id="l37.119" class="difflineminus">-</span>
<a href="#l37.120"></a><span id="l37.120" class="difflineminus">-  this.customColumns = [this._whyColumn, this._scoreColumn];</span>
<a href="#l37.121"></a><span id="l37.121" class="difflineminus">-</span>
<a href="#l37.122"></a><span id="l37.122" class="difflineminus">-  this.collection = null;</span>
<a href="#l37.123"></a><span id="l37.123" class="difflineminus">-  this._whyMap = {};</span>
<a href="#l37.124"></a><span id="l37.124" class="difflineminus">-  this._scoreMap = {};</span>
<a href="#l37.125"></a><span id="l37.125" class="difflineminus">-</span>
<a href="#l37.126"></a><span id="l37.126" class="difflineminus">-  this.searchString = aSearchString;</span>
<a href="#l37.127"></a><span id="l37.127" class="difflineminus">-  this.facetString = aFacetString;</span>
<a href="#l37.128"></a><span id="l37.128" class="difflineminus">-  this.location = aLocation;</span>
<a href="#l37.129"></a><span id="l37.129" class="difflineminus">-}</span>
<a href="#l37.130"></a><span id="l37.130" class="difflineminus">-GlodaSyntheticSearchView.prototype = {</span>
<a href="#l37.131"></a><span id="l37.131" class="difflineminus">-  defaultSort: [[&quot;glodaScoreCol&quot;, Ci.nsMsgViewSortOrder.descending]],</span>
<a href="#l37.132"></a><span id="l37.132" class="difflineplus">+GlodaSyntheticView.prototype = {</span>
<a href="#l37.133"></a><span id="l37.133" class="difflineplus">+  defaultSort: [[&quot;dateCol&quot;, Ci.nsMsgViewSortOrder.descending]],</span>
<a href="#l37.134"></a><span id="l37.134"> </span>
<a href="#l37.135"></a><span id="l37.135">   /**</span>
<a href="#l37.136"></a><span id="l37.136">    * Request the search be performed and notification provided to</span>
<a href="#l37.137"></a><span id="l37.137">    *  aSearchListener.  If results are already available, they should</span>
<a href="#l37.138"></a><span id="l37.138">    *  be provided to aSearchListener without re-performing the search.</span>
<a href="#l37.139"></a><span id="l37.139">    */</span>
<a href="#l37.140"></a><span id="l37.140">   search: function(aSearchListener, aCompletionCallback) {</span>
<a href="#l37.141"></a><span id="l37.141">     this.searchListener = aSearchListener;</span>
<a href="#l37.142"></a><span id="l37.142">     this.completionCallback = aCompletionCallback;</span>
<a href="#l37.143"></a><span id="l37.143"> </span>
<a href="#l37.144"></a><span id="l37.144">     this.searchListener.onNewSearch();</span>
<a href="#l37.145"></a><span id="l37.145" class="difflineminus">-    if (this.collection) {</span>
<a href="#l37.146"></a><span id="l37.146" class="difflineplus">+    if (this.completed) {</span>
<a href="#l37.147"></a><span id="l37.147">       this.reportResults(this.collection.items);</span>
<a href="#l37.148"></a><span id="l37.148">       // we're not really aborting, but it closes things out nicely</span>
<a href="#l37.149"></a><span id="l37.149">       this.abortSearch();</span>
<a href="#l37.150"></a><span id="l37.150">       return;</span>
<a href="#l37.151"></a><span id="l37.151">     }</span>
<a href="#l37.152"></a><span id="l37.152" class="difflineminus">-</span>
<a href="#l37.153"></a><span id="l37.153" class="difflineminus">-    this.collection = this.searcher.go();</span>
<a href="#l37.154"></a><span id="l37.154">   },</span>
<a href="#l37.155"></a><span id="l37.155"> </span>
<a href="#l37.156"></a><span id="l37.156">   abortSearch: function() {</span>
<a href="#l37.157"></a><span id="l37.157">     if (this.searchListener)</span>
<a href="#l37.158"></a><span id="l37.158">       this.searchListener.onSearchDone(Cr.NS_OK);</span>
<a href="#l37.159"></a><span id="l37.159">     if (this.completionCallback)</span>
<a href="#l37.160"></a><span id="l37.160">       this.completionCallback();</span>
<a href="#l37.161"></a><span id="l37.161">     this.searchListener = null;</span>
<a href="#l37.162"></a><span id="l37.162">     this.completionCallback = null;</span>
<a href="#l37.163"></a><span id="l37.163">   },</span>
<a href="#l37.164"></a><span id="l37.164"> </span>
<a href="#l37.165"></a><span id="l37.165">   reportResults: function(aItems) {</span>
<a href="#l37.166"></a><span id="l37.166">     for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l37.167"></a><span id="l37.167">       let hdr = item.folderMessage;</span>
<a href="#l37.168"></a><span id="l37.168" class="difflineminus">-      this.searchListener.onSearchHit(hdr, hdr.folder);</span>
<a href="#l37.169"></a><span id="l37.169" class="difflineplus">+      if (hdr)</span>
<a href="#l37.170"></a><span id="l37.170" class="difflineplus">+        this.searchListener.onSearchHit(hdr, hdr.folder);</span>
<a href="#l37.171"></a><span id="l37.171">     }</span>
<a href="#l37.172"></a><span id="l37.172">   },</span>
<a href="#l37.173"></a><span id="l37.173"> </span>
<a href="#l37.174"></a><span id="l37.174" class="difflineplus">+  /**</span>
<a href="#l37.175"></a><span id="l37.175" class="difflineplus">+   * Helper function used by |DBViewWrapper.getMsgHdrForMessageID| since there</span>
<a href="#l37.176"></a><span id="l37.176" class="difflineplus">+   *  are no actual backing folders for it to check.</span>
<a href="#l37.177"></a><span id="l37.177" class="difflineplus">+   */</span>
<a href="#l37.178"></a><span id="l37.178" class="difflineplus">+  getMsgHdrForMessageID: function(aMessageId) {</span>
<a href="#l37.179"></a><span id="l37.179" class="difflineplus">+    for each (let [, item] in this.collection.items) {</span>
<a href="#l37.180"></a><span id="l37.180" class="difflineplus">+      if (item.messageId == aMessageId) {</span>
<a href="#l37.181"></a><span id="l37.181" class="difflineplus">+        let hdr = item.folderMessage;</span>
<a href="#l37.182"></a><span id="l37.182" class="difflineplus">+        if (hdr)</span>
<a href="#l37.183"></a><span id="l37.183" class="difflineplus">+          return hdr;</span>
<a href="#l37.184"></a><span id="l37.184" class="difflineplus">+      }</span>
<a href="#l37.185"></a><span id="l37.185" class="difflineplus">+    }</span>
<a href="#l37.186"></a><span id="l37.186" class="difflineplus">+    return null;</span>
<a href="#l37.187"></a><span id="l37.187" class="difflineplus">+  },</span>
<a href="#l37.188"></a><span id="l37.188" class="difflineplus">+</span>
<a href="#l37.189"></a><span id="l37.189">   // --- collection listener</span>
<a href="#l37.190"></a><span id="l37.190">   onItemsAdded: function(aItems, aCollection) {</span>
<a href="#l37.191"></a><span id="l37.191">     if (this.searchListener)</span>
<a href="#l37.192"></a><span id="l37.192">       this.reportResults(aItems);</span>
<a href="#l37.193"></a><span id="l37.193">   },</span>
<a href="#l37.194"></a><span id="l37.194">   onItemsModified: function(aItems, aCollection) {</span>
<a href="#l37.195"></a><span id="l37.195">   },</span>
<a href="#l37.196"></a><span id="l37.196">   onItemsRemoved: function(aItems, aCollection) {</span>
<a href="#l37.197"></a><span id="l37.197">   },</span>
<a href="#l37.198"></a><span id="l37.198">   onQueryCompleted: function(aCollection) {</span>
<a href="#l37.199"></a><span id="l37.199" class="difflineplus">+    this.completed = true;</span>
<a href="#l37.200"></a><span id="l37.200">     this.searchListener.onSearchDone(Cr.NS_OK);</span>
<a href="#l37.201"></a><span id="l37.201">     if (this.completionCallback)</span>
<a href="#l37.202"></a><span id="l37.202">       this.completionCallback();</span>
<a href="#l37.203"></a><span id="l37.203">   },</span>
<a href="#l37.204"></a><span id="l37.204"> };</span>
<a href="#l37.205"></a><span id="l37.205" class="difflineminus">-</span>
<a href="#l37.206"></a><span id="l37.206" class="difflineminus">-var GlodaViewFactory = {</span>
<a href="#l37.207"></a><span id="l37.207" class="difflineminus">-  kFacetEverything: &quot;everything&quot;,</span>
<a href="#l37.208"></a><span id="l37.208" class="difflineminus">-  kFacetSubject: &quot;subject&quot;,</span>
<a href="#l37.209"></a><span id="l37.209" class="difflineminus">-  kFacetBody: &quot;body&quot;,</span>
<a href="#l37.210"></a><span id="l37.210" class="difflineminus">-  kFacetAttachments: &quot;attachments&quot;,</span>
<a href="#l37.211"></a><span id="l37.211" class="difflineminus">-  kFacetInvolves: &quot;involves&quot;,</span>
<a href="#l37.212"></a><span id="l37.212" class="difflineminus">-  kFacetTo: &quot;to&quot;,</span>
<a href="#l37.213"></a><span id="l37.213" class="difflineminus">-  kFacetFrom: &quot;from&quot;,</span>
<a href="#l37.214"></a><span id="l37.214" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/db/gloda/modules/explattr.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/explattr.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -45,34 +45,36 @@</span>
<a href="#l38.4"></a><span id="l38.4"> EXPORTED_SYMBOLS = ['GlodaExplicitAttr'];</span>
<a href="#l38.5"></a><span id="l38.5"> </span>
<a href="#l38.6"></a><span id="l38.6"> const Cc = Components.classes;</span>
<a href="#l38.7"></a><span id="l38.7"> const Ci = Components.interfaces;</span>
<a href="#l38.8"></a><span id="l38.8"> const Cr = Components.results;</span>
<a href="#l38.9"></a><span id="l38.9"> const Cu = Components.utils;</span>
<a href="#l38.10"></a><span id="l38.10"> </span>
<a href="#l38.11"></a><span id="l38.11"> Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineplus">+Cu.import(&quot;resource://app/modules/StringBundle.js&quot;);</span>
<a href="#l38.13"></a><span id="l38.13"> </span>
<a href="#l38.14"></a><span id="l38.14"> Cu.import(&quot;resource://app/modules/gloda/utils.js&quot;);</span>
<a href="#l38.15"></a><span id="l38.15"> Cu.import(&quot;resource://app/modules/gloda/gloda.js&quot;);</span>
<a href="#l38.16"></a><span id="l38.16"> Cu.import(&quot;resource://app/modules/gloda/noun_tag.js&quot;);</span>
<a href="#l38.17"></a><span id="l38.17"> </span>
<a href="#l38.18"></a><span id="l38.18"> </span>
<a href="#l38.19"></a><span id="l38.19" class="difflineplus">+const nsMsgMessageFlags_Replied = Ci.nsMsgMessageFlags.Replied;</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineplus">+const nsMsgMessageFlags_Forwarded = Ci.nsMsgMessageFlags.Forwarded;</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineplus">+</span>
<a href="#l38.22"></a><span id="l38.22"> const EXT_BUILTIN = &quot;built-in&quot;;</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineminus">-const FA_TAG = &quot;TAG&quot;;</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineminus">-const FA_STAR = &quot;STAR&quot;;</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineminus">-const FA_READ = &quot;READ&quot;;</span>
<a href="#l38.26"></a><span id="l38.26"> </span>
<a href="#l38.27"></a><span id="l38.27"> /**</span>
<a href="#l38.28"></a><span id="l38.28">  * @namespace Explicit attribute provider.  Indexes/defines attributes that are</span>
<a href="#l38.29"></a><span id="l38.29">  *  explicitly a result of user action.  This dubiously includes marking a</span>
<a href="#l38.30"></a><span id="l38.30">  *  message as read.</span>
<a href="#l38.31"></a><span id="l38.31">  */</span>
<a href="#l38.32"></a><span id="l38.32"> var GlodaExplicitAttr = {</span>
<a href="#l38.33"></a><span id="l38.33">   providerName: &quot;gloda.explattr&quot;,</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+  strings: new StringBundle(&quot;chrome://messenger/locale/gloda.properties&quot;),</span>
<a href="#l38.35"></a><span id="l38.35">   _log: null,</span>
<a href="#l38.36"></a><span id="l38.36">   _msgTagService: null,</span>
<a href="#l38.37"></a><span id="l38.37"> </span>
<a href="#l38.38"></a><span id="l38.38">   init: function gloda_explattr_init() {</span>
<a href="#l38.39"></a><span id="l38.39">     this._log =  Log4Moz.repository.getLogger(&quot;gloda.explattr&quot;);</span>
<a href="#l38.40"></a><span id="l38.40"> </span>
<a href="#l38.41"></a><span id="l38.41">     this._msgTagService = Cc[&quot;@mozilla.org/messenger/tagservice;1&quot;].</span>
<a href="#l38.42"></a><span id="l38.42">                           getService(Ci.nsIMsgTagService);</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineat">@@ -88,72 +90,101 @@ var GlodaExplicitAttr = {</span>
<a href="#l38.44"></a><span id="l38.44"> </span>
<a href="#l38.45"></a><span id="l38.45">   /** Boost for starred messages. */</span>
<a href="#l38.46"></a><span id="l38.46">   NOTABILITY_STARRED: 16,</span>
<a href="#l38.47"></a><span id="l38.47">   /** Boost for tagged messages, first tag. */</span>
<a href="#l38.48"></a><span id="l38.48">   NOTABILITY_TAGGED_FIRST: 8,</span>
<a href="#l38.49"></a><span id="l38.49">   /** Boost for tagged messages, each additional tag. */</span>
<a href="#l38.50"></a><span id="l38.50">   NOTABILITY_TAGGED_ADDL: 1,</span>
<a href="#l38.51"></a><span id="l38.51"> </span>
<a href="#l38.52"></a><span id="l38.52" class="difflineminus">-  _attrTag: null,</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineminus">-  _attrStar: null,</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineminus">-  _attrRead: null,</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineminus">-</span>
<a href="#l38.56"></a><span id="l38.56">   defineAttributes: function() {</span>
<a href="#l38.57"></a><span id="l38.57">     // Tag</span>
<a href="#l38.58"></a><span id="l38.58">     this._attrTag = Gloda.defineAttribute({</span>
<a href="#l38.59"></a><span id="l38.59">                         provider: this,</span>
<a href="#l38.60"></a><span id="l38.60">                         extensionName: Gloda.BUILT_IN,</span>
<a href="#l38.61"></a><span id="l38.61">                         attributeType: Gloda.kAttrExplicit,</span>
<a href="#l38.62"></a><span id="l38.62">                         attributeName: &quot;tag&quot;,</span>
<a href="#l38.63"></a><span id="l38.63">                         bindName: &quot;tags&quot;,</span>
<a href="#l38.64"></a><span id="l38.64">                         singular: false,</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineplus">+                        facet: true,</span>
<a href="#l38.66"></a><span id="l38.66">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l38.67"></a><span id="l38.67">                         objectNoun: Gloda.NOUN_TAG,</span>
<a href="#l38.68"></a><span id="l38.68">                         parameterNoun: null,</span>
<a href="#l38.69"></a><span id="l38.69">                         // Property change notifications that we care about:</span>
<a href="#l38.70"></a><span id="l38.70">                         propertyChanges: [&quot;keywords&quot;],</span>
<a href="#l38.71"></a><span id="l38.71">                         }); // not-tested</span>
<a href="#l38.72"></a><span id="l38.72"> </span>
<a href="#l38.73"></a><span id="l38.73">     // Star</span>
<a href="#l38.74"></a><span id="l38.74">     this._attrStar = Gloda.defineAttribute({</span>
<a href="#l38.75"></a><span id="l38.75">                         provider: this,</span>
<a href="#l38.76"></a><span id="l38.76">                         extensionName: Gloda.BUILT_IN,</span>
<a href="#l38.77"></a><span id="l38.77">                         attributeType: Gloda.kAttrExplicit,</span>
<a href="#l38.78"></a><span id="l38.78">                         attributeName: &quot;star&quot;,</span>
<a href="#l38.79"></a><span id="l38.79">                         bindName: &quot;starred&quot;,</span>
<a href="#l38.80"></a><span id="l38.80">                         singular: true,</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineplus">+                        facet: true,</span>
<a href="#l38.82"></a><span id="l38.82">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l38.83"></a><span id="l38.83">                         objectNoun: Gloda.NOUN_BOOLEAN,</span>
<a href="#l38.84"></a><span id="l38.84">                         parameterNoun: null,</span>
<a href="#l38.85"></a><span id="l38.85">                         }); // tested-by: test_attributes_explicit</span>
<a href="#l38.86"></a><span id="l38.86">     // Read/Unread</span>
<a href="#l38.87"></a><span id="l38.87">     this._attrRead = Gloda.defineAttribute({</span>
<a href="#l38.88"></a><span id="l38.88">                         provider: this,</span>
<a href="#l38.89"></a><span id="l38.89">                         extensionName: Gloda.BUILT_IN,</span>
<a href="#l38.90"></a><span id="l38.90">                         attributeType: Gloda.kAttrExplicit,</span>
<a href="#l38.91"></a><span id="l38.91">                         attributeName: &quot;read&quot;,</span>
<a href="#l38.92"></a><span id="l38.92">                         singular: true,</span>
<a href="#l38.93"></a><span id="l38.93">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l38.94"></a><span id="l38.94">                         objectNoun: Gloda.NOUN_BOOLEAN,</span>
<a href="#l38.95"></a><span id="l38.95">                         parameterNoun: null,</span>
<a href="#l38.96"></a><span id="l38.96">                         }); // tested-by: test_attributes_explicit</span>
<a href="#l38.97"></a><span id="l38.97"> </span>
<a href="#l38.98"></a><span id="l38.98" class="difflineplus">+    /**</span>
<a href="#l38.99"></a><span id="l38.99" class="difflineplus">+     * Has this message been replied to by the user.</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineplus">+     */</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineplus">+    this._attrRepliedTo = Gloda.defineAttribute({</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineplus">+      provider: this,</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineplus">+      extensionName: Gloda.BUILT_IN,</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineplus">+      attributeType: Gloda.kAttrExplicit,</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineplus">+      attributeName: &quot;repliedTo&quot;,</span>
<a href="#l38.106"></a><span id="l38.106" class="difflineplus">+      singular: true,</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineplus">+      subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l38.108"></a><span id="l38.108" class="difflineplus">+      objectNoun: Gloda.NOUN_BOOLEAN,</span>
<a href="#l38.109"></a><span id="l38.109" class="difflineplus">+      parameterNoun: null,</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineplus">+    }); // tested-by: test_attributes_explicit</span>
<a href="#l38.111"></a><span id="l38.111" class="difflineplus">+</span>
<a href="#l38.112"></a><span id="l38.112" class="difflineplus">+    /**</span>
<a href="#l38.113"></a><span id="l38.113" class="difflineplus">+     * Has this user forwarded this message to someone.</span>
<a href="#l38.114"></a><span id="l38.114" class="difflineplus">+     */</span>
<a href="#l38.115"></a><span id="l38.115" class="difflineplus">+    this._attrForwarded = Gloda.defineAttribute({</span>
<a href="#l38.116"></a><span id="l38.116" class="difflineplus">+      provider: this,</span>
<a href="#l38.117"></a><span id="l38.117" class="difflineplus">+      extensionName: Gloda.BUILT_IN,</span>
<a href="#l38.118"></a><span id="l38.118" class="difflineplus">+      attributeType: Gloda.kAttrExplicit,</span>
<a href="#l38.119"></a><span id="l38.119" class="difflineplus">+      attributeName: &quot;forwarded&quot;,</span>
<a href="#l38.120"></a><span id="l38.120" class="difflineplus">+      singular: true,</span>
<a href="#l38.121"></a><span id="l38.121" class="difflineplus">+      subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l38.122"></a><span id="l38.122" class="difflineplus">+      objectNoun: Gloda.NOUN_BOOLEAN,</span>
<a href="#l38.123"></a><span id="l38.123" class="difflineplus">+      parameterNoun: null,</span>
<a href="#l38.124"></a><span id="l38.124" class="difflineplus">+    }); // tested-by: test_attributes_explicit</span>
<a href="#l38.125"></a><span id="l38.125">   },</span>
<a href="#l38.126"></a><span id="l38.126"> </span>
<a href="#l38.127"></a><span id="l38.127">   process: function Gloda_explattr_process(aGlodaMessage, aRawReps, aIsNew,</span>
<a href="#l38.128"></a><span id="l38.128">                                            aCallbackHandle) {</span>
<a href="#l38.129"></a><span id="l38.129">     let aMsgHdr = aRawReps.header;</span>
<a href="#l38.130"></a><span id="l38.130"> </span>
<a href="#l38.131"></a><span id="l38.131">     aGlodaMessage.starred = aMsgHdr.isFlagged;</span>
<a href="#l38.132"></a><span id="l38.132">     if (aGlodaMessage.starred)</span>
<a href="#l38.133"></a><span id="l38.133">       aGlodaMessage.notability += this.NOTABILITY_STARRED;</span>
<a href="#l38.134"></a><span id="l38.134"> </span>
<a href="#l38.135"></a><span id="l38.135">     aGlodaMessage.read = aMsgHdr.isRead;</span>
<a href="#l38.136"></a><span id="l38.136"> </span>
<a href="#l38.137"></a><span id="l38.137" class="difflineplus">+    let flags = aMsgHdr.flags;</span>
<a href="#l38.138"></a><span id="l38.138" class="difflineplus">+    aGlodaMessage.repliedTo = Boolean(flags &amp; nsMsgMessageFlags_Replied);</span>
<a href="#l38.139"></a><span id="l38.139" class="difflineplus">+    aGlodaMessage.forwarded = Boolean(flags &amp; nsMsgMessageFlags_Forwarded);</span>
<a href="#l38.140"></a><span id="l38.140" class="difflineplus">+</span>
<a href="#l38.141"></a><span id="l38.141">     let tags = aGlodaMessage.tags = [];</span>
<a href="#l38.142"></a><span id="l38.142"> </span>
<a href="#l38.143"></a><span id="l38.143">     // -- Tag</span>
<a href="#l38.144"></a><span id="l38.144">     // build a map of the keywords</span>
<a href="#l38.145"></a><span id="l38.145">     let keywords = aMsgHdr.getStringProperty(&quot;keywords&quot;);</span>
<a href="#l38.146"></a><span id="l38.146">     let keywordList = keywords.split(' ');</span>
<a href="#l38.147"></a><span id="l38.147">     let keywordMap = {};</span>
<a href="#l38.148"></a><span id="l38.148">     for (let iKeyword = 0; iKeyword &lt; keywordList.length; iKeyword++) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1">new file mode 100644</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineminus">--- /dev/null</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineplus">+++ b/mailnews/db/gloda/modules/facet.js</span>
<a href="#l39.4"></a><span id="l39.4" class="difflineat">@@ -0,0 +1,595 @@</span>
<a href="#l39.5"></a><span id="l39.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l39.6"></a><span id="l39.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l39.7"></a><span id="l39.7" class="difflineplus">+ *</span>
<a href="#l39.8"></a><span id="l39.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l39.9"></a><span id="l39.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l39.10"></a><span id="l39.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l39.11"></a><span id="l39.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineplus">+ *</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineplus">+ * License.</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineplus">+ *</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineplus">+ * The Original Code is Thunderbird Global Database.</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineplus">+ *</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineplus">+ *</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineplus">+ *</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l39.37"></a><span id="l39.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineplus">+ *</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineplus">+</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineplus">+/*</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineplus">+ * This file provides faceting logic.</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineplus">+ */</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineplus">+</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineplus">+let EXPORTED_SYMBOLS = [&quot;FacetDriver&quot;, &quot;FacetUtils&quot;];</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineplus">+</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineplus">+const Cc = Components.classes;</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineplus">+const Cr = Components.results;</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineplus">+</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineplus">+Cu.import(&quot;resource://app/modules/gloda/public.js&quot;);</span>
<a href="#l39.54"></a><span id="l39.54" class="difflineplus">+</span>
<a href="#l39.55"></a><span id="l39.55" class="difflineplus">+/**</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineplus">+ * Decides the appropriate faceters for the noun type and drives the faceting</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineplus">+ *  process.  This class and the faceters are intended to be reusable so that</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineplus">+ *  you only need one instance per faceting session.  (Although each faceting</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineplus">+ *  pass is accordingly destructive to previous results.)</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineplus">+ *</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineplus">+ * Our strategy for faceting is to process one attribute at a time across all</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineplus">+ *  the items in the provided set.  The alternative would be to iterate over</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineplus">+ *  the items and then iterate over the attributes on each item.  While both</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineplus">+ *  approaches have caching downsides</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineplus">+ */</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineplus">+function FacetDriver(aNounDef, aWindow) {</span>
<a href="#l39.67"></a><span id="l39.67" class="difflineplus">+  this.nounDef = aNounDef;</span>
<a href="#l39.68"></a><span id="l39.68" class="difflineplus">+  this._window = aWindow;</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineplus">+</span>
<a href="#l39.70"></a><span id="l39.70" class="difflineplus">+  this._makeFaceters();</span>
<a href="#l39.71"></a><span id="l39.71" class="difflineplus">+}</span>
<a href="#l39.72"></a><span id="l39.72" class="difflineplus">+FacetDriver.prototype = {</span>
<a href="#l39.73"></a><span id="l39.73" class="difflineplus">+  /**</span>
<a href="#l39.74"></a><span id="l39.74" class="difflineplus">+   * Populate |this.faceters| with a set of faceters appropriate to the noun</span>
<a href="#l39.75"></a><span id="l39.75" class="difflineplus">+   *  definition associated with this instance.</span>
<a href="#l39.76"></a><span id="l39.76" class="difflineplus">+   */</span>
<a href="#l39.77"></a><span id="l39.77" class="difflineplus">+  _makeFaceters: function() {</span>
<a href="#l39.78"></a><span id="l39.78" class="difflineplus">+    let faceters = this.faceters = [];</span>
<a href="#l39.79"></a><span id="l39.79" class="difflineplus">+    for each (let [, attrDef] in Iterator(this.nounDef.attribsByBoundName)) {</span>
<a href="#l39.80"></a><span id="l39.80" class="difflineplus">+      // ignore attributes that do not want to be faceted</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineplus">+      if (!attrDef.facet)</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineplus">+        continue;</span>
<a href="#l39.83"></a><span id="l39.83" class="difflineplus">+</span>
<a href="#l39.84"></a><span id="l39.84" class="difflineplus">+      let facetType = attrDef.facet.type;</span>
<a href="#l39.85"></a><span id="l39.85" class="difflineplus">+</span>
<a href="#l39.86"></a><span id="l39.86" class="difflineplus">+      if (attrDef.singular) {</span>
<a href="#l39.87"></a><span id="l39.87" class="difflineplus">+        if (facetType == &quot;date&quot;)</span>
<a href="#l39.88"></a><span id="l39.88" class="difflineplus">+          faceters.push(new DateFaceter(attrDef));</span>
<a href="#l39.89"></a><span id="l39.89" class="difflineplus">+        else</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineplus">+          faceters.push(new DiscreteFaceter(attrDef));</span>
<a href="#l39.91"></a><span id="l39.91" class="difflineplus">+      }</span>
<a href="#l39.92"></a><span id="l39.92" class="difflineplus">+      else {</span>
<a href="#l39.93"></a><span id="l39.93" class="difflineplus">+        if (facetType == &quot;nonempty?&quot;)</span>
<a href="#l39.94"></a><span id="l39.94" class="difflineplus">+          faceters.push(new NonEmptySetFaceter(attrDef));</span>
<a href="#l39.95"></a><span id="l39.95" class="difflineplus">+        else</span>
<a href="#l39.96"></a><span id="l39.96" class="difflineplus">+          faceters.push(new DiscreteSetFaceter(attrDef));</span>
<a href="#l39.97"></a><span id="l39.97" class="difflineplus">+      }</span>
<a href="#l39.98"></a><span id="l39.98" class="difflineplus">+    }</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineplus">+  },</span>
<a href="#l39.100"></a><span id="l39.100" class="difflineplus">+  /**</span>
<a href="#l39.101"></a><span id="l39.101" class="difflineplus">+   * Asynchronously facet the provided items, calling the provided callback when</span>
<a href="#l39.102"></a><span id="l39.102" class="difflineplus">+   *  completed.</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineplus">+   */</span>
<a href="#l39.104"></a><span id="l39.104" class="difflineplus">+  go: function FacetDriver_go(aItems, aCallback, aCallbackThis) {</span>
<a href="#l39.105"></a><span id="l39.105" class="difflineplus">+    this.items = aItems;</span>
<a href="#l39.106"></a><span id="l39.106" class="difflineplus">+    this.callback = aCallback;</span>
<a href="#l39.107"></a><span id="l39.107" class="difflineplus">+    this.callbackThis = aCallbackThis;</span>
<a href="#l39.108"></a><span id="l39.108" class="difflineplus">+</span>
<a href="#l39.109"></a><span id="l39.109" class="difflineplus">+    this._nextFaceter = 0;</span>
<a href="#l39.110"></a><span id="l39.110" class="difflineplus">+    this._drive();</span>
<a href="#l39.111"></a><span id="l39.111" class="difflineplus">+  },</span>
<a href="#l39.112"></a><span id="l39.112" class="difflineplus">+</span>
<a href="#l39.113"></a><span id="l39.113" class="difflineplus">+  _MAX_FACETING_TIMESLICE_MS: 100,</span>
<a href="#l39.114"></a><span id="l39.114" class="difflineplus">+  _FACETING_YIELD_DURATION_MS: 0,</span>
<a href="#l39.115"></a><span id="l39.115" class="difflineplus">+  _driveWrapper: function(aThis) {</span>
<a href="#l39.116"></a><span id="l39.116" class="difflineplus">+    aThis._drive();</span>
<a href="#l39.117"></a><span id="l39.117" class="difflineplus">+  },</span>
<a href="#l39.118"></a><span id="l39.118" class="difflineplus">+  _drive: function() {</span>
<a href="#l39.119"></a><span id="l39.119" class="difflineplus">+    let start = Date.now();</span>
<a href="#l39.120"></a><span id="l39.120" class="difflineplus">+</span>
<a href="#l39.121"></a><span id="l39.121" class="difflineplus">+    while (this._nextFaceter &lt; this.faceters.length) {</span>
<a href="#l39.122"></a><span id="l39.122" class="difflineplus">+      let faceter = this.faceters[this._nextFaceter++];</span>
<a href="#l39.123"></a><span id="l39.123" class="difflineplus">+      // for now we facet in one go, but the long-term plan allows for them to</span>
<a href="#l39.124"></a><span id="l39.124" class="difflineplus">+      //  be generators.</span>
<a href="#l39.125"></a><span id="l39.125" class="difflineplus">+      faceter.facetItems(this.items);</span>
<a href="#l39.126"></a><span id="l39.126" class="difflineplus">+</span>
<a href="#l39.127"></a><span id="l39.127" class="difflineplus">+      let delta = Date.now() - start;</span>
<a href="#l39.128"></a><span id="l39.128" class="difflineplus">+      if (delta &gt; this._MAX_FACETING_TIMESLICE_MS) {</span>
<a href="#l39.129"></a><span id="l39.129" class="difflineplus">+        this._window.setTimeout(this._driveWrapper,</span>
<a href="#l39.130"></a><span id="l39.130" class="difflineplus">+                                this._FACETING_YIELD_DURATION_MS,</span>
<a href="#l39.131"></a><span id="l39.131" class="difflineplus">+                                this);</span>
<a href="#l39.132"></a><span id="l39.132" class="difflineplus">+        return;</span>
<a href="#l39.133"></a><span id="l39.133" class="difflineplus">+      }</span>
<a href="#l39.134"></a><span id="l39.134" class="difflineplus">+    }</span>
<a href="#l39.135"></a><span id="l39.135" class="difflineplus">+</span>
<a href="#l39.136"></a><span id="l39.136" class="difflineplus">+    // we only get here once we are done with the faceters</span>
<a href="#l39.137"></a><span id="l39.137" class="difflineplus">+    this.callback.call(this.callbackThis);</span>
<a href="#l39.138"></a><span id="l39.138" class="difflineplus">+  }</span>
<a href="#l39.139"></a><span id="l39.139" class="difflineplus">+};</span>
<a href="#l39.140"></a><span id="l39.140" class="difflineplus">+</span>
<a href="#l39.141"></a><span id="l39.141" class="difflineplus">+var FacetUtils = {</span>
<a href="#l39.142"></a><span id="l39.142" class="difflineplus">+  _groupSizeComparator: function(a, b) {</span>
<a href="#l39.143"></a><span id="l39.143" class="difflineplus">+    return b[1].length - a[1].length;</span>
<a href="#l39.144"></a><span id="l39.144" class="difflineplus">+  },</span>
<a href="#l39.145"></a><span id="l39.145" class="difflineplus">+</span>
<a href="#l39.146"></a><span id="l39.146" class="difflineplus">+  /**</span>
<a href="#l39.147"></a><span id="l39.147" class="difflineplus">+   * Given a list where each entry is a tuple of [group object, list of items</span>
<a href="#l39.148"></a><span id="l39.148" class="difflineplus">+   *  belonging to that group], produce a new list of the top grouped items plus</span>
<a href="#l39.149"></a><span id="l39.149" class="difflineplus">+   *  an &quot;other&quot; category.</span>
<a href="#l39.150"></a><span id="l39.150" class="difflineplus">+   *</span>
<a href="#l39.151"></a><span id="l39.151" class="difflineplus">+   * @param aAttrDef The attribute for the facet we are working with.</span>
<a href="#l39.152"></a><span id="l39.152" class="difflineplus">+   * @param aGroups The list of groups built for the facet.</span>
<a href="#l39.153"></a><span id="l39.153" class="difflineplus">+   * @param aMaxCount The number of result rows you want back.  We will provide</span>
<a href="#l39.154"></a><span id="l39.154" class="difflineplus">+   *     the aMaxCount-1 rows plus an &quot;other&quot; row which we put last.</span>
<a href="#l39.155"></a><span id="l39.155" class="difflineplus">+   * @param aOtherSentinel An object to use as the other sentinel object and the</span>
<a href="#l39.156"></a><span id="l39.156" class="difflineplus">+   *     count of the number of groups that went into the other group.  The</span>
<a href="#l39.157"></a><span id="l39.157" class="difflineplus">+   *     count is found in the 'count' attribute of this object.</span>
<a href="#l39.158"></a><span id="l39.158" class="difflineplus">+   */</span>
<a href="#l39.159"></a><span id="l39.159" class="difflineplus">+  makeTopGroups: function FacetUtils_makeTopGroups(aAttrDef, aGroups,</span>
<a href="#l39.160"></a><span id="l39.160" class="difflineplus">+                                                   aMaxCount, aOtherSentinel) {</span>
<a href="#l39.161"></a><span id="l39.161" class="difflineplus">+    let nounDef = aAttrDef.objectNounDef;</span>
<a href="#l39.162"></a><span id="l39.162" class="difflineplus">+    let realGroupsToUse = aMaxCount - 1;</span>
<a href="#l39.163"></a><span id="l39.163" class="difflineplus">+</span>
<a href="#l39.164"></a><span id="l39.164" class="difflineplus">+    let orderedBySize = aGroups.concat();</span>
<a href="#l39.165"></a><span id="l39.165" class="difflineplus">+    orderedBySize.sort(this._groupSizeComparator);</span>
<a href="#l39.166"></a><span id="l39.166" class="difflineplus">+</span>
<a href="#l39.167"></a><span id="l39.167" class="difflineplus">+    // - get the real groups to use and order them by the attribute comparator</span>
<a href="#l39.168"></a><span id="l39.168" class="difflineplus">+    let outGroups = orderedBySize.slice(0, realGroupsToUse);</span>
<a href="#l39.169"></a><span id="l39.169" class="difflineplus">+    let comparator = nounDef.comparator;</span>
<a href="#l39.170"></a><span id="l39.170" class="difflineplus">+    function comparatorHelper(a, b) {</span>
<a href="#l39.171"></a><span id="l39.171" class="difflineplus">+      return comparator(a[0], b[0]);</span>
<a href="#l39.172"></a><span id="l39.172" class="difflineplus">+    }</span>
<a href="#l39.173"></a><span id="l39.173" class="difflineplus">+    outGroups.sort(comparatorHelper);</span>
<a href="#l39.174"></a><span id="l39.174" class="difflineplus">+</span>
<a href="#l39.175"></a><span id="l39.175" class="difflineplus">+    // - build the 'other' group</span>
<a href="#l39.176"></a><span id="l39.176" class="difflineplus">+    let otherItems, otherGroupValues;</span>
<a href="#l39.177"></a><span id="l39.177" class="difflineplus">+    // If the attribute is singular, we can just concatenate everybody together</span>
<a href="#l39.178"></a><span id="l39.178" class="difflineplus">+    if (aAttrDef.singular) {</span>
<a href="#l39.179"></a><span id="l39.179" class="difflineplus">+      // Since concat can take multiple arrays, build a list of all of the items</span>
<a href="#l39.180"></a><span id="l39.180" class="difflineplus">+      //  except for the first one who we will issue the concat call against.</span>
<a href="#l39.181"></a><span id="l39.181" class="difflineplus">+      //  (We could also just use an empty array as the base.)</span>
<a href="#l39.182"></a><span id="l39.182" class="difflineplus">+      let iGroup = realGroupsToUse;</span>
<a href="#l39.183"></a><span id="l39.183" class="difflineplus">+      otherGroupValues = [orderedBySize[iGroup][0]];</span>
<a href="#l39.184"></a><span id="l39.184" class="difflineplus">+      let firstItemList = orderedBySize[iGroup++][1];</span>
<a href="#l39.185"></a><span id="l39.185" class="difflineplus">+      let otherItemLists = [];</span>
<a href="#l39.186"></a><span id="l39.186" class="difflineplus">+      for (; iGroup &lt; orderedBySize.length; iGroup++) {</span>
<a href="#l39.187"></a><span id="l39.187" class="difflineplus">+        otherGroupValues.push(orderedBySize[iGroup][0]);</span>
<a href="#l39.188"></a><span id="l39.188" class="difflineplus">+        otherItemLists.push(orderedBySize[iGroup][1]);</span>
<a href="#l39.189"></a><span id="l39.189" class="difflineplus">+      }</span>
<a href="#l39.190"></a><span id="l39.190" class="difflineplus">+</span>
<a href="#l39.191"></a><span id="l39.191" class="difflineplus">+      otherItems = firstItemList.concat.apply(firstItemList, otherItemLists);</span>
<a href="#l39.192"></a><span id="l39.192" class="difflineplus">+    }</span>
<a href="#l39.193"></a><span id="l39.193" class="difflineplus">+    // For non-singular attributes, we need to uniqify the contents.  If we</span>
<a href="#l39.194"></a><span id="l39.194" class="difflineplus">+    //  naively concatenated all the items, we might end up with duplicates.</span>
<a href="#l39.195"></a><span id="l39.195" class="difflineplus">+    else {</span>
<a href="#l39.196"></a><span id="l39.196" class="difflineplus">+      let idsSeen = {};</span>
<a href="#l39.197"></a><span id="l39.197" class="difflineplus">+      otherItems = [];</span>
<a href="#l39.198"></a><span id="l39.198" class="difflineplus">+      otherGroupValues = [];</span>
<a href="#l39.199"></a><span id="l39.199" class="difflineplus">+      for (let iGroup = realGroupsToUse; iGroup &lt; orderedBySize.length;</span>
<a href="#l39.200"></a><span id="l39.200" class="difflineplus">+           iGroup++) {</span>
<a href="#l39.201"></a><span id="l39.201" class="difflineplus">+        otherGroupValues.push(orderedBySize[iGroup][0]);</span>
<a href="#l39.202"></a><span id="l39.202" class="difflineplus">+        for each (let [, item] in Iterator(orderedBySize[iGroup][1])) {</span>
<a href="#l39.203"></a><span id="l39.203" class="difflineplus">+          if (!(item.id in idsSeen)) {</span>
<a href="#l39.204"></a><span id="l39.204" class="difflineplus">+            idsSeen[item.id] = true;</span>
<a href="#l39.205"></a><span id="l39.205" class="difflineplus">+            otherItems.push(item);</span>
<a href="#l39.206"></a><span id="l39.206" class="difflineplus">+          }</span>
<a href="#l39.207"></a><span id="l39.207" class="difflineplus">+        }</span>
<a href="#l39.208"></a><span id="l39.208" class="difflineplus">+      }</span>
<a href="#l39.209"></a><span id="l39.209" class="difflineplus">+    }</span>
<a href="#l39.210"></a><span id="l39.210" class="difflineplus">+</span>
<a href="#l39.211"></a><span id="l39.211" class="difflineplus">+    aOtherSentinel.count = orderedBySize.length - realGroupsToUse;</span>
<a href="#l39.212"></a><span id="l39.212" class="difflineplus">+    aOtherSentinel.groupValues = otherGroupValues;</span>
<a href="#l39.213"></a><span id="l39.213" class="difflineplus">+    outGroups.push([aOtherSentinel, otherItems]);</span>
<a href="#l39.214"></a><span id="l39.214" class="difflineplus">+</span>
<a href="#l39.215"></a><span id="l39.215" class="difflineplus">+    return outGroups;</span>
<a href="#l39.216"></a><span id="l39.216" class="difflineplus">+  }</span>
<a href="#l39.217"></a><span id="l39.217" class="difflineplus">+};</span>
<a href="#l39.218"></a><span id="l39.218" class="difflineplus">+</span>
<a href="#l39.219"></a><span id="l39.219" class="difflineplus">+/**</span>
<a href="#l39.220"></a><span id="l39.220" class="difflineplus">+ * Facet discrete things like message authors, boolean values, etc.  Only</span>
<a href="#l39.221"></a><span id="l39.221" class="difflineplus">+ *  appropriate for use on singular values.  Use |DiscreteSetFaceter| for</span>
<a href="#l39.222"></a><span id="l39.222" class="difflineplus">+ *  non-singular values.</span>
<a href="#l39.223"></a><span id="l39.223" class="difflineplus">+ */</span>
<a href="#l39.224"></a><span id="l39.224" class="difflineplus">+function DiscreteFaceter(aAttrDef) {</span>
<a href="#l39.225"></a><span id="l39.225" class="difflineplus">+  this.attrDef = aAttrDef;</span>
<a href="#l39.226"></a><span id="l39.226" class="difflineplus">+}</span>
<a href="#l39.227"></a><span id="l39.227" class="difflineplus">+DiscreteFaceter.prototype = {</span>
<a href="#l39.228"></a><span id="l39.228" class="difflineplus">+  type: &quot;discrete&quot;,</span>
<a href="#l39.229"></a><span id="l39.229" class="difflineplus">+  /**</span>
<a href="#l39.230"></a><span id="l39.230" class="difflineplus">+   * Facet the given set of items, deferring to the appropriate helper method</span>
<a href="#l39.231"></a><span id="l39.231" class="difflineplus">+   */</span>
<a href="#l39.232"></a><span id="l39.232" class="difflineplus">+  facetItems: function(aItems) {</span>
<a href="#l39.233"></a><span id="l39.233" class="difflineplus">+    if (this.attrDef.objectNounDef.isPrimitive)</span>
<a href="#l39.234"></a><span id="l39.234" class="difflineplus">+      return this.facetPrimitiveItems(aItems);</span>
<a href="#l39.235"></a><span id="l39.235" class="difflineplus">+    else</span>
<a href="#l39.236"></a><span id="l39.236" class="difflineplus">+      return this.facetComplexItems(aItems);</span>
<a href="#l39.237"></a><span id="l39.237" class="difflineplus">+  },</span>
<a href="#l39.238"></a><span id="l39.238" class="difflineplus">+  /**</span>
<a href="#l39.239"></a><span id="l39.239" class="difflineplus">+   * Facet an attribute whose value is primitive, meaning that it is a raw</span>
<a href="#l39.240"></a><span id="l39.240" class="difflineplus">+   *  numeric value or string, rather than a complex object.</span>
<a href="#l39.241"></a><span id="l39.241" class="difflineplus">+   */</span>
<a href="#l39.242"></a><span id="l39.242" class="difflineplus">+  facetPrimitiveItems: function(aItems) {</span>
<a href="#l39.243"></a><span id="l39.243" class="difflineplus">+    let attrKey = this.attrDef.boundName;</span>
<a href="#l39.244"></a><span id="l39.244" class="difflineplus">+    let nounDef = this.attrDef.objectNounDef;</span>
<a href="#l39.245"></a><span id="l39.245" class="difflineplus">+</span>
<a href="#l39.246"></a><span id="l39.246" class="difflineplus">+    let valStrToVal = {};</span>
<a href="#l39.247"></a><span id="l39.247" class="difflineplus">+    let groups = this.groups = {};</span>
<a href="#l39.248"></a><span id="l39.248" class="difflineplus">+    this.groupCount = 0;</span>
<a href="#l39.249"></a><span id="l39.249" class="difflineplus">+</span>
<a href="#l39.250"></a><span id="l39.250" class="difflineplus">+    for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l39.251"></a><span id="l39.251" class="difflineplus">+      let val = (attrKey in item) ? item[attrKey] : null;</span>
<a href="#l39.252"></a><span id="l39.252" class="difflineplus">+      if (val in groups)</span>
<a href="#l39.253"></a><span id="l39.253" class="difflineplus">+        groups[val].push(item);</span>
<a href="#l39.254"></a><span id="l39.254" class="difflineplus">+      else {</span>
<a href="#l39.255"></a><span id="l39.255" class="difflineplus">+        groups[val] = [item];</span>
<a href="#l39.256"></a><span id="l39.256" class="difflineplus">+        valStrToVal[val] = val;</span>
<a href="#l39.257"></a><span id="l39.257" class="difflineplus">+        this.groupCount++;</span>
<a href="#l39.258"></a><span id="l39.258" class="difflineplus">+      }</span>
<a href="#l39.259"></a><span id="l39.259" class="difflineplus">+    }</span>
<a href="#l39.260"></a><span id="l39.260" class="difflineplus">+</span>
<a href="#l39.261"></a><span id="l39.261" class="difflineplus">+    let orderedGroups = [[valStrToVal[key], items] for each</span>
<a href="#l39.262"></a><span id="l39.262" class="difflineplus">+                         ([key, items] in Iterator(groups))];</span>
<a href="#l39.263"></a><span id="l39.263" class="difflineplus">+    let comparator = nounDef.comparator;</span>
<a href="#l39.264"></a><span id="l39.264" class="difflineplus">+    function comparatorHelper(a, b) {</span>
<a href="#l39.265"></a><span id="l39.265" class="difflineplus">+      return comparator(a[0], b[0]);</span>
<a href="#l39.266"></a><span id="l39.266" class="difflineplus">+    }</span>
<a href="#l39.267"></a><span id="l39.267" class="difflineplus">+    orderedGroups.sort(comparatorHelper);</span>
<a href="#l39.268"></a><span id="l39.268" class="difflineplus">+    this.orderedGroups = orderedGroups;</span>
<a href="#l39.269"></a><span id="l39.269" class="difflineplus">+  },</span>
<a href="#l39.270"></a><span id="l39.270" class="difflineplus">+  /**</span>
<a href="#l39.271"></a><span id="l39.271" class="difflineplus">+   * Facet an attribute whose value is a complex object that can be identified</span>
<a href="#l39.272"></a><span id="l39.272" class="difflineplus">+   *  by its 'id' attribute.  This is the case where the value is itself a noun</span>
<a href="#l39.273"></a><span id="l39.273" class="difflineplus">+   *  instance.</span>
<a href="#l39.274"></a><span id="l39.274" class="difflineplus">+   */</span>
<a href="#l39.275"></a><span id="l39.275" class="difflineplus">+  facetComplexItems: function(aItems) {</span>
<a href="#l39.276"></a><span id="l39.276" class="difflineplus">+    let attrKey = this.attrDef.boundName;</span>
<a href="#l39.277"></a><span id="l39.277" class="difflineplus">+    let nounDef = this.attrDef.objectNounDef;</span>
<a href="#l39.278"></a><span id="l39.278" class="difflineplus">+    let idAttr = this.attrDef.facet.groupIdAttr;</span>
<a href="#l39.279"></a><span id="l39.279" class="difflineplus">+</span>
<a href="#l39.280"></a><span id="l39.280" class="difflineplus">+    let groups = this.groups = {};</span>
<a href="#l39.281"></a><span id="l39.281" class="difflineplus">+    let groupMap = this.groupMap = {};</span>
<a href="#l39.282"></a><span id="l39.282" class="difflineplus">+    this.groupCount = 0;</span>
<a href="#l39.283"></a><span id="l39.283" class="difflineplus">+</span>
<a href="#l39.284"></a><span id="l39.284" class="difflineplus">+    for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l39.285"></a><span id="l39.285" class="difflineplus">+      let val = (attrKey in item) ? item[attrKey] : null;</span>
<a href="#l39.286"></a><span id="l39.286" class="difflineplus">+      let valId = (val == null) ? null : val[idAttr];</span>
<a href="#l39.287"></a><span id="l39.287" class="difflineplus">+      if (valId in groupMap) {</span>
<a href="#l39.288"></a><span id="l39.288" class="difflineplus">+        groups[valId].push(item);</span>
<a href="#l39.289"></a><span id="l39.289" class="difflineplus">+      }</span>
<a href="#l39.290"></a><span id="l39.290" class="difflineplus">+      else {</span>
<a href="#l39.291"></a><span id="l39.291" class="difflineplus">+        groupMap[valId] = val;</span>
<a href="#l39.292"></a><span id="l39.292" class="difflineplus">+        groups[valId] = [item];</span>
<a href="#l39.293"></a><span id="l39.293" class="difflineplus">+        this.groupCount++;</span>
<a href="#l39.294"></a><span id="l39.294" class="difflineplus">+      }</span>
<a href="#l39.295"></a><span id="l39.295" class="difflineplus">+    }</span>
<a href="#l39.296"></a><span id="l39.296" class="difflineplus">+</span>
<a href="#l39.297"></a><span id="l39.297" class="difflineplus">+    let orderedGroups = [[groupMap[key], items] for each</span>
<a href="#l39.298"></a><span id="l39.298" class="difflineplus">+                         ([key, items] in Iterator(groups))];</span>
<a href="#l39.299"></a><span id="l39.299" class="difflineplus">+    let comparator = nounDef.comparator;</span>
<a href="#l39.300"></a><span id="l39.300" class="difflineplus">+    function comparatorHelper(a, b) {</span>
<a href="#l39.301"></a><span id="l39.301" class="difflineplus">+      return comparator(a[0], b[0]);</span>
<a href="#l39.302"></a><span id="l39.302" class="difflineplus">+    }</span>
<a href="#l39.303"></a><span id="l39.303" class="difflineplus">+    orderedGroups.sort(comparatorHelper);</span>
<a href="#l39.304"></a><span id="l39.304" class="difflineplus">+    this.orderedGroups = orderedGroups;</span>
<a href="#l39.305"></a><span id="l39.305" class="difflineplus">+  },</span>
<a href="#l39.306"></a><span id="l39.306" class="difflineplus">+};</span>
<a href="#l39.307"></a><span id="l39.307" class="difflineplus">+</span>
<a href="#l39.308"></a><span id="l39.308" class="difflineplus">+/**</span>
<a href="#l39.309"></a><span id="l39.309" class="difflineplus">+ * Facet sets of discrete items.  For example, tags applied to messages.</span>
<a href="#l39.310"></a><span id="l39.310" class="difflineplus">+ *</span>
<a href="#l39.311"></a><span id="l39.311" class="difflineplus">+ * The main differences between us and |DiscreteFaceter| are:</span>
<a href="#l39.312"></a><span id="l39.312" class="difflineplus">+ * - The empty set is notable.</span>
<a href="#l39.313"></a><span id="l39.313" class="difflineplus">+ * - Specific set configurations could be interesting, but are not low-hanging</span>
<a href="#l39.314"></a><span id="l39.314" class="difflineplus">+ *    fruit.</span>
<a href="#l39.315"></a><span id="l39.315" class="difflineplus">+ */</span>
<a href="#l39.316"></a><span id="l39.316" class="difflineplus">+function DiscreteSetFaceter(aAttrDef) {</span>
<a href="#l39.317"></a><span id="l39.317" class="difflineplus">+  this.attrDef = aAttrDef;</span>
<a href="#l39.318"></a><span id="l39.318" class="difflineplus">+}</span>
<a href="#l39.319"></a><span id="l39.319" class="difflineplus">+DiscreteSetFaceter.prototype = {</span>
<a href="#l39.320"></a><span id="l39.320" class="difflineplus">+  type: &quot;discrete&quot;,</span>
<a href="#l39.321"></a><span id="l39.321" class="difflineplus">+  /**</span>
<a href="#l39.322"></a><span id="l39.322" class="difflineplus">+   * Facet the given set of items, deferring to the appropriate helper method</span>
<a href="#l39.323"></a><span id="l39.323" class="difflineplus">+   */</span>
<a href="#l39.324"></a><span id="l39.324" class="difflineplus">+  facetItems: function(aItems) {</span>
<a href="#l39.325"></a><span id="l39.325" class="difflineplus">+    if (this.attrDef.objectNounDef.isPrimitive)</span>
<a href="#l39.326"></a><span id="l39.326" class="difflineplus">+      return this.facetPrimitiveItems(aItems);</span>
<a href="#l39.327"></a><span id="l39.327" class="difflineplus">+    else</span>
<a href="#l39.328"></a><span id="l39.328" class="difflineplus">+      return this.facetComplexItems(aItems);</span>
<a href="#l39.329"></a><span id="l39.329" class="difflineplus">+  },</span>
<a href="#l39.330"></a><span id="l39.330" class="difflineplus">+  /**</span>
<a href="#l39.331"></a><span id="l39.331" class="difflineplus">+   * Facet an attribute whose value is primitive, meaning that it is a raw</span>
<a href="#l39.332"></a><span id="l39.332" class="difflineplus">+   *  numeric value or string, rather than a complex object.</span>
<a href="#l39.333"></a><span id="l39.333" class="difflineplus">+   */</span>
<a href="#l39.334"></a><span id="l39.334" class="difflineplus">+  facetPrimitiveItems: function(aItems) {</span>
<a href="#l39.335"></a><span id="l39.335" class="difflineplus">+    let attrKey = this.attrDef.boundName;</span>
<a href="#l39.336"></a><span id="l39.336" class="difflineplus">+    let nounDef = this.attrDef.objectNounDef;</span>
<a href="#l39.337"></a><span id="l39.337" class="difflineplus">+</span>
<a href="#l39.338"></a><span id="l39.338" class="difflineplus">+    let groups = this.groups = {};</span>
<a href="#l39.339"></a><span id="l39.339" class="difflineplus">+    let valStrToVal = {};</span>
<a href="#l39.340"></a><span id="l39.340" class="difflineplus">+    this.groupCount = 0;</span>
<a href="#l39.341"></a><span id="l39.341" class="difflineplus">+</span>
<a href="#l39.342"></a><span id="l39.342" class="difflineplus">+    for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l39.343"></a><span id="l39.343" class="difflineplus">+      let vals = (attrKey in item) ? item[attrKey] : null;</span>
<a href="#l39.344"></a><span id="l39.344" class="difflineplus">+      if (vals == null || vals.length == 0) {</span>
<a href="#l39.345"></a><span id="l39.345" class="difflineplus">+        vals = [null];</span>
<a href="#l39.346"></a><span id="l39.346" class="difflineplus">+      }</span>
<a href="#l39.347"></a><span id="l39.347" class="difflineplus">+      for each (let [, val] in Iterator(vals)) {</span>
<a href="#l39.348"></a><span id="l39.348" class="difflineplus">+        if (val in groups)</span>
<a href="#l39.349"></a><span id="l39.349" class="difflineplus">+          groups[val].push(item);</span>
<a href="#l39.350"></a><span id="l39.350" class="difflineplus">+        else {</span>
<a href="#l39.351"></a><span id="l39.351" class="difflineplus">+          groups[val] = [item];</span>
<a href="#l39.352"></a><span id="l39.352" class="difflineplus">+          valStrToVal[val] = val;</span>
<a href="#l39.353"></a><span id="l39.353" class="difflineplus">+          this.groupCount++;</span>
<a href="#l39.354"></a><span id="l39.354" class="difflineplus">+        }</span>
<a href="#l39.355"></a><span id="l39.355" class="difflineplus">+      }</span>
<a href="#l39.356"></a><span id="l39.356" class="difflineplus">+    }</span>
<a href="#l39.357"></a><span id="l39.357" class="difflineplus">+</span>
<a href="#l39.358"></a><span id="l39.358" class="difflineplus">+    let orderedGroups = [[valStrToVal[key], items] for each</span>
<a href="#l39.359"></a><span id="l39.359" class="difflineplus">+                         ([key, items] in Iterator(groups))];</span>
<a href="#l39.360"></a><span id="l39.360" class="difflineplus">+    let comparator = nounDef.comparator;</span>
<a href="#l39.361"></a><span id="l39.361" class="difflineplus">+    function comparatorHelper(a, b) {</span>
<a href="#l39.362"></a><span id="l39.362" class="difflineplus">+      return comparator(a[0], b[0]);</span>
<a href="#l39.363"></a><span id="l39.363" class="difflineplus">+    }</span>
<a href="#l39.364"></a><span id="l39.364" class="difflineplus">+    orderedGroups.sort(comparatorHelper);</span>
<a href="#l39.365"></a><span id="l39.365" class="difflineplus">+    this.orderedGroups = orderedGroups;</span>
<a href="#l39.366"></a><span id="l39.366" class="difflineplus">+  },</span>
<a href="#l39.367"></a><span id="l39.367" class="difflineplus">+  /**</span>
<a href="#l39.368"></a><span id="l39.368" class="difflineplus">+   * Facet an attribute whose value is a complex object that can be identified</span>
<a href="#l39.369"></a><span id="l39.369" class="difflineplus">+   *  by its 'id' attribute.  This is the case where the value is itself a noun</span>
<a href="#l39.370"></a><span id="l39.370" class="difflineplus">+   *  instance.</span>
<a href="#l39.371"></a><span id="l39.371" class="difflineplus">+   */</span>
<a href="#l39.372"></a><span id="l39.372" class="difflineplus">+  facetComplexItems: function(aItems) {</span>
<a href="#l39.373"></a><span id="l39.373" class="difflineplus">+    let attrKey = this.attrDef.boundName;</span>
<a href="#l39.374"></a><span id="l39.374" class="difflineplus">+    let nounDef = this.attrDef.objectNounDef;</span>
<a href="#l39.375"></a><span id="l39.375" class="difflineplus">+    let idAttr = this.attrDef.facet.groupIdAttr;</span>
<a href="#l39.376"></a><span id="l39.376" class="difflineplus">+</span>
<a href="#l39.377"></a><span id="l39.377" class="difflineplus">+    let groups = this.groups = {};</span>
<a href="#l39.378"></a><span id="l39.378" class="difflineplus">+    let groupMap = this.groupMap = {};</span>
<a href="#l39.379"></a><span id="l39.379" class="difflineplus">+    this.groupCount = 0;</span>
<a href="#l39.380"></a><span id="l39.380" class="difflineplus">+</span>
<a href="#l39.381"></a><span id="l39.381" class="difflineplus">+    for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l39.382"></a><span id="l39.382" class="difflineplus">+      let vals = (attrKey in item) ? item[attrKey] : null;</span>
<a href="#l39.383"></a><span id="l39.383" class="difflineplus">+      if (vals == null || vals.length == 0) {</span>
<a href="#l39.384"></a><span id="l39.384" class="difflineplus">+        vals = [null];</span>
<a href="#l39.385"></a><span id="l39.385" class="difflineplus">+      }</span>
<a href="#l39.386"></a><span id="l39.386" class="difflineplus">+      for each (let [, val] in Iterator(vals)) {</span>
<a href="#l39.387"></a><span id="l39.387" class="difflineplus">+        let valId = (val == null) ? null : val[idAttr];</span>
<a href="#l39.388"></a><span id="l39.388" class="difflineplus">+        if (valId in groupMap) {</span>
<a href="#l39.389"></a><span id="l39.389" class="difflineplus">+          groups[valId].push(item);</span>
<a href="#l39.390"></a><span id="l39.390" class="difflineplus">+        }</span>
<a href="#l39.391"></a><span id="l39.391" class="difflineplus">+        else {</span>
<a href="#l39.392"></a><span id="l39.392" class="difflineplus">+          groupMap[valId] = val;</span>
<a href="#l39.393"></a><span id="l39.393" class="difflineplus">+          groups[valId] = [item];</span>
<a href="#l39.394"></a><span id="l39.394" class="difflineplus">+          this.groupCount++;</span>
<a href="#l39.395"></a><span id="l39.395" class="difflineplus">+        }</span>
<a href="#l39.396"></a><span id="l39.396" class="difflineplus">+      }</span>
<a href="#l39.397"></a><span id="l39.397" class="difflineplus">+    }</span>
<a href="#l39.398"></a><span id="l39.398" class="difflineplus">+</span>
<a href="#l39.399"></a><span id="l39.399" class="difflineplus">+    let orderedGroups = [[groupMap[key], items] for each</span>
<a href="#l39.400"></a><span id="l39.400" class="difflineplus">+                         ([key, items] in Iterator(groups))];</span>
<a href="#l39.401"></a><span id="l39.401" class="difflineplus">+    let comparator = nounDef.comparator;</span>
<a href="#l39.402"></a><span id="l39.402" class="difflineplus">+    function comparatorHelper(a, b) {</span>
<a href="#l39.403"></a><span id="l39.403" class="difflineplus">+      return comparator(a[0], b[0]);</span>
<a href="#l39.404"></a><span id="l39.404" class="difflineplus">+    }</span>
<a href="#l39.405"></a><span id="l39.405" class="difflineplus">+    orderedGroups.sort(comparatorHelper);</span>
<a href="#l39.406"></a><span id="l39.406" class="difflineplus">+    this.orderedGroups = orderedGroups;</span>
<a href="#l39.407"></a><span id="l39.407" class="difflineplus">+  },</span>
<a href="#l39.408"></a><span id="l39.408" class="difflineplus">+};</span>
<a href="#l39.409"></a><span id="l39.409" class="difflineplus">+</span>
<a href="#l39.410"></a><span id="l39.410" class="difflineplus">+/**</span>
<a href="#l39.411"></a><span id="l39.411" class="difflineplus">+ * Given a non-singular attribute, facet it as if it were a boolean based on</span>
<a href="#l39.412"></a><span id="l39.412" class="difflineplus">+ *  whether there is anything in the list (set).</span>
<a href="#l39.413"></a><span id="l39.413" class="difflineplus">+ */</span>
<a href="#l39.414"></a><span id="l39.414" class="difflineplus">+function NonEmptySetFaceter(aAttrDef) {</span>
<a href="#l39.415"></a><span id="l39.415" class="difflineplus">+  this.attrDef = aAttrDef;</span>
<a href="#l39.416"></a><span id="l39.416" class="difflineplus">+}</span>
<a href="#l39.417"></a><span id="l39.417" class="difflineplus">+NonEmptySetFaceter.prototype = {</span>
<a href="#l39.418"></a><span id="l39.418" class="difflineplus">+  type: &quot;boolean&quot;,</span>
<a href="#l39.419"></a><span id="l39.419" class="difflineplus">+  /**</span>
<a href="#l39.420"></a><span id="l39.420" class="difflineplus">+   * Facet the given set of items, deferring to the appropriate helper method</span>
<a href="#l39.421"></a><span id="l39.421" class="difflineplus">+   */</span>
<a href="#l39.422"></a><span id="l39.422" class="difflineplus">+  facetItems: function(aItems) {</span>
<a href="#l39.423"></a><span id="l39.423" class="difflineplus">+    let attrKey = this.attrDef.boundName;</span>
<a href="#l39.424"></a><span id="l39.424" class="difflineplus">+    let nounDef = this.attrDef.objectNounDef;</span>
<a href="#l39.425"></a><span id="l39.425" class="difflineplus">+</span>
<a href="#l39.426"></a><span id="l39.426" class="difflineplus">+    let trueValues = [];</span>
<a href="#l39.427"></a><span id="l39.427" class="difflineplus">+    let falseValues = [];</span>
<a href="#l39.428"></a><span id="l39.428" class="difflineplus">+</span>
<a href="#l39.429"></a><span id="l39.429" class="difflineplus">+    let groups = this.groups = {};</span>
<a href="#l39.430"></a><span id="l39.430" class="difflineplus">+    this.groupCount = 0;</span>
<a href="#l39.431"></a><span id="l39.431" class="difflineplus">+</span>
<a href="#l39.432"></a><span id="l39.432" class="difflineplus">+    for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l39.433"></a><span id="l39.433" class="difflineplus">+      let vals = (attrKey in item) ? item[attrKey] : null;</span>
<a href="#l39.434"></a><span id="l39.434" class="difflineplus">+      if (vals == null || vals.length == 0)</span>
<a href="#l39.435"></a><span id="l39.435" class="difflineplus">+        falseValues.push(item);</span>
<a href="#l39.436"></a><span id="l39.436" class="difflineplus">+      else</span>
<a href="#l39.437"></a><span id="l39.437" class="difflineplus">+        trueValues.push(item);</span>
<a href="#l39.438"></a><span id="l39.438" class="difflineplus">+    }</span>
<a href="#l39.439"></a><span id="l39.439" class="difflineplus">+</span>
<a href="#l39.440"></a><span id="l39.440" class="difflineplus">+    this.orderedGroups = [];</span>
<a href="#l39.441"></a><span id="l39.441" class="difflineplus">+    if (trueValues.length)</span>
<a href="#l39.442"></a><span id="l39.442" class="difflineplus">+      this.orderedGroups.push([true, trueValues]);</span>
<a href="#l39.443"></a><span id="l39.443" class="difflineplus">+    if (falseValues.length)</span>
<a href="#l39.444"></a><span id="l39.444" class="difflineplus">+      this.orderedGroups.push([false, falseValues]);</span>
<a href="#l39.445"></a><span id="l39.445" class="difflineplus">+    this.groupCount = this.orderedGroups.length;</span>
<a href="#l39.446"></a><span id="l39.446" class="difflineplus">+  },</span>
<a href="#l39.447"></a><span id="l39.447" class="difflineplus">+  makeQuery: function(aGroupValues, aInclusive) {</span>
<a href="#l39.448"></a><span id="l39.448" class="difflineplus">+    let query = this.query = Gloda.newQuery(Gloda.NOUN_MESSAGE);</span>
<a href="#l39.449"></a><span id="l39.449" class="difflineplus">+</span>
<a href="#l39.450"></a><span id="l39.450" class="difflineplus">+    let constraintFunc = query[this.attrDef.boundName];</span>
<a href="#l39.451"></a><span id="l39.451" class="difflineplus">+    constraintFunc.call(query);</span>
<a href="#l39.452"></a><span id="l39.452" class="difflineplus">+</span>
<a href="#l39.453"></a><span id="l39.453" class="difflineplus">+    // Our query is always for non-empty lists (at this time), so we want to</span>
<a href="#l39.454"></a><span id="l39.454" class="difflineplus">+    //  invert if they're excluding 'true' or including 'false', which means !=.</span>
<a href="#l39.455"></a><span id="l39.455" class="difflineplus">+    let invert = aGroupValues[0] != aInclusive;</span>
<a href="#l39.456"></a><span id="l39.456" class="difflineplus">+</span>
<a href="#l39.457"></a><span id="l39.457" class="difflineplus">+    return [query, invert];</span>
<a href="#l39.458"></a><span id="l39.458" class="difflineplus">+  }</span>
<a href="#l39.459"></a><span id="l39.459" class="difflineplus">+};</span>
<a href="#l39.460"></a><span id="l39.460" class="difflineplus">+</span>
<a href="#l39.461"></a><span id="l39.461" class="difflineplus">+</span>
<a href="#l39.462"></a><span id="l39.462" class="difflineplus">+/**</span>
<a href="#l39.463"></a><span id="l39.463" class="difflineplus">+ * Facet dates.  We build a hierarchical nested structure of year, month, and</span>
<a href="#l39.464"></a><span id="l39.464" class="difflineplus">+ *  day nesting levels.  This decision was made speculatively in the hopes that</span>
<a href="#l39.465"></a><span id="l39.465" class="difflineplus">+ *  it would allow us to do clustered analysis and that there might be a benefit</span>
<a href="#l39.466"></a><span id="l39.466" class="difflineplus">+ *  for that.  For example, if you search for &quot;Christmas&quot;, we might notice</span>
<a href="#l39.467"></a><span id="l39.467" class="difflineplus">+ *  clusters of messages around December of each year.  We could then present</span>
<a href="#l39.468"></a><span id="l39.468" class="difflineplus">+ *  these in a list as likely candidates, rather than a graphical timeline.</span>
<a href="#l39.469"></a><span id="l39.469" class="difflineplus">+ *  Alternately, it could be used to inform a non-linear visualization.  As it</span>
<a href="#l39.470"></a><span id="l39.470" class="difflineplus">+ *  stands (as of this writing), it's just a complicating factor.</span>
<a href="#l39.471"></a><span id="l39.471" class="difflineplus">+ */</span>
<a href="#l39.472"></a><span id="l39.472" class="difflineplus">+function DateFaceter(aAttrDef) {</span>
<a href="#l39.473"></a><span id="l39.473" class="difflineplus">+  this.attrDef = aAttrDef;</span>
<a href="#l39.474"></a><span id="l39.474" class="difflineplus">+}</span>
<a href="#l39.475"></a><span id="l39.475" class="difflineplus">+DateFaceter.prototype = {</span>
<a href="#l39.476"></a><span id="l39.476" class="difflineplus">+  type: &quot;date&quot;,</span>
<a href="#l39.477"></a><span id="l39.477" class="difflineplus">+  /**</span>
<a href="#l39.478"></a><span id="l39.478" class="difflineplus">+   *</span>
<a href="#l39.479"></a><span id="l39.479" class="difflineplus">+   */</span>
<a href="#l39.480"></a><span id="l39.480" class="difflineplus">+  facetItems: function(aItems) {</span>
<a href="#l39.481"></a><span id="l39.481" class="difflineplus">+    let attrKey = this.attrDef.boundName;</span>
<a href="#l39.482"></a><span id="l39.482" class="difflineplus">+    let nounDef = this.attrDef.objectNounDef;</span>
<a href="#l39.483"></a><span id="l39.483" class="difflineplus">+</span>
<a href="#l39.484"></a><span id="l39.484" class="difflineplus">+    let years = this.years = {_subCount: 0};</span>
<a href="#l39.485"></a><span id="l39.485" class="difflineplus">+    // generally track the time range</span>
<a href="#l39.486"></a><span id="l39.486" class="difflineplus">+    let oldest = null, newest = null;</span>
<a href="#l39.487"></a><span id="l39.487" class="difflineplus">+</span>
<a href="#l39.488"></a><span id="l39.488" class="difflineplus">+    let validItems = this.validItems = [];</span>
<a href="#l39.489"></a><span id="l39.489" class="difflineplus">+</span>
<a href="#l39.490"></a><span id="l39.490" class="difflineplus">+    // just cheat and put us at the front...</span>
<a href="#l39.491"></a><span id="l39.491" class="difflineplus">+    this.groupCount = aItems.length ? 1000 : 0;</span>
<a href="#l39.492"></a><span id="l39.492" class="difflineplus">+    this.orderedGroups = null;</span>
<a href="#l39.493"></a><span id="l39.493" class="difflineplus">+</span>
<a href="#l39.494"></a><span id="l39.494" class="difflineplus">+    /** The number of items with a null/missing attribute. */</span>
<a href="#l39.495"></a><span id="l39.495" class="difflineplus">+    this.missing = 0;</span>
<a href="#l39.496"></a><span id="l39.496" class="difflineplus">+</span>
<a href="#l39.497"></a><span id="l39.497" class="difflineplus">+    /**</span>
<a href="#l39.498"></a><span id="l39.498" class="difflineplus">+     * The number of items with a date that is unreasonably far in the past or</span>
<a href="#l39.499"></a><span id="l39.499" class="difflineplus">+     *  in the future.  Old-wise, we are concerned about incorrectly formatted</span>
<a href="#l39.500"></a><span id="l39.500" class="difflineplus">+     *  messages (spam) that end up placed around the UNIX epoch.  New-wise,</span>
<a href="#l39.501"></a><span id="l39.501" class="difflineplus">+     *  we are concerned about messages that can't be explained by users who</span>
<a href="#l39.502"></a><span id="l39.502" class="difflineplus">+     *  don't know how to set their clocks (both the current user and people</span>
<a href="#l39.503"></a><span id="l39.503" class="difflineplus">+     *  sending them mail), mainly meaning spam.</span>
<a href="#l39.504"></a><span id="l39.504" class="difflineplus">+     * We want to avoid having our clever time-scale logic being made useless by</span>
<a href="#l39.505"></a><span id="l39.505" class="difflineplus">+     *  these unreasonable messages.</span>
<a href="#l39.506"></a><span id="l39.506" class="difflineplus">+     */</span>
<a href="#l39.507"></a><span id="l39.507" class="difflineplus">+    this.unreasonable = 0;</span>
<a href="#l39.508"></a><span id="l39.508" class="difflineplus">+    // feb 1, 1970</span>
<a href="#l39.509"></a><span id="l39.509" class="difflineplus">+    let tooOld = new Date(1970, 1, 1);</span>
<a href="#l39.510"></a><span id="l39.510" class="difflineplus">+    // 3 days from now</span>
<a href="#l39.511"></a><span id="l39.511" class="difflineplus">+    let tooNew = new Date(Date.now() + 3 * 24 * 60 * 60 * 1000);</span>
<a href="#l39.512"></a><span id="l39.512" class="difflineplus">+</span>
<a href="#l39.513"></a><span id="l39.513" class="difflineplus">+    for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l39.514"></a><span id="l39.514" class="difflineplus">+      let val = (attrKey in item) ? item[attrKey] : null;</span>
<a href="#l39.515"></a><span id="l39.515" class="difflineplus">+      // -- missing</span>
<a href="#l39.516"></a><span id="l39.516" class="difflineplus">+      if (val == null) {</span>
<a href="#l39.517"></a><span id="l39.517" class="difflineplus">+        this.missing++;</span>
<a href="#l39.518"></a><span id="l39.518" class="difflineplus">+        continue;</span>
<a href="#l39.519"></a><span id="l39.519" class="difflineplus">+      }</span>
<a href="#l39.520"></a><span id="l39.520" class="difflineplus">+</span>
<a href="#l39.521"></a><span id="l39.521" class="difflineplus">+      // -- unreasonable</span>
<a href="#l39.522"></a><span id="l39.522" class="difflineplus">+      if (val &lt; tooOld || val &gt; tooNew) {</span>
<a href="#l39.523"></a><span id="l39.523" class="difflineplus">+        this.unreasonable++;</span>
<a href="#l39.524"></a><span id="l39.524" class="difflineplus">+        continue;</span>
<a href="#l39.525"></a><span id="l39.525" class="difflineplus">+      }</span>
<a href="#l39.526"></a><span id="l39.526" class="difflineplus">+</span>
<a href="#l39.527"></a><span id="l39.527" class="difflineplus">+      this.validItems.push(item);</span>
<a href="#l39.528"></a><span id="l39.528" class="difflineplus">+</span>
<a href="#l39.529"></a><span id="l39.529" class="difflineplus">+      // -- time range</span>
<a href="#l39.530"></a><span id="l39.530" class="difflineplus">+      if (oldest == null)</span>
<a href="#l39.531"></a><span id="l39.531" class="difflineplus">+        oldest = newest = val;</span>
<a href="#l39.532"></a><span id="l39.532" class="difflineplus">+      else if (val &lt; oldest)</span>
<a href="#l39.533"></a><span id="l39.533" class="difflineplus">+        oldest = val;</span>
<a href="#l39.534"></a><span id="l39.534" class="difflineplus">+      else if (val &gt; newest)</span>
<a href="#l39.535"></a><span id="l39.535" class="difflineplus">+        newest = val;</span>
<a href="#l39.536"></a><span id="l39.536" class="difflineplus">+</span>
<a href="#l39.537"></a><span id="l39.537" class="difflineplus">+      // -- bucket</span>
<a href="#l39.538"></a><span id="l39.538" class="difflineplus">+      // - year</span>
<a href="#l39.539"></a><span id="l39.539" class="difflineplus">+      let year, valYear = val.getYear();</span>
<a href="#l39.540"></a><span id="l39.540" class="difflineplus">+      if (valYear in years) {</span>
<a href="#l39.541"></a><span id="l39.541" class="difflineplus">+        year = years[valYear];</span>
<a href="#l39.542"></a><span id="l39.542" class="difflineplus">+        year._dateCount++;</span>
<a href="#l39.543"></a><span id="l39.543" class="difflineplus">+      }</span>
<a href="#l39.544"></a><span id="l39.544" class="difflineplus">+      else {</span>
<a href="#l39.545"></a><span id="l39.545" class="difflineplus">+        year = years[valYear] = {</span>
<a href="#l39.546"></a><span id="l39.546" class="difflineplus">+          _dateCount: 1,</span>
<a href="#l39.547"></a><span id="l39.547" class="difflineplus">+          _subCount: 0</span>
<a href="#l39.548"></a><span id="l39.548" class="difflineplus">+        };</span>
<a href="#l39.549"></a><span id="l39.549" class="difflineplus">+        years._subCount++;</span>
<a href="#l39.550"></a><span id="l39.550" class="difflineplus">+      }</span>
<a href="#l39.551"></a><span id="l39.551" class="difflineplus">+</span>
<a href="#l39.552"></a><span id="l39.552" class="difflineplus">+      // - month</span>
<a href="#l39.553"></a><span id="l39.553" class="difflineplus">+      let month, valMonth = val.getMonth();</span>
<a href="#l39.554"></a><span id="l39.554" class="difflineplus">+      if (valMonth in year) {</span>
<a href="#l39.555"></a><span id="l39.555" class="difflineplus">+        month = year[valMonth];</span>
<a href="#l39.556"></a><span id="l39.556" class="difflineplus">+        month._dateCount++;</span>
<a href="#l39.557"></a><span id="l39.557" class="difflineplus">+      }</span>
<a href="#l39.558"></a><span id="l39.558" class="difflineplus">+      else {</span>
<a href="#l39.559"></a><span id="l39.559" class="difflineplus">+        month = year[valMonth] = {</span>
<a href="#l39.560"></a><span id="l39.560" class="difflineplus">+          _dateCount: 1,</span>
<a href="#l39.561"></a><span id="l39.561" class="difflineplus">+          _subCount: 0</span>
<a href="#l39.562"></a><span id="l39.562" class="difflineplus">+        };</span>
<a href="#l39.563"></a><span id="l39.563" class="difflineplus">+        year._subCount++;</span>
<a href="#l39.564"></a><span id="l39.564" class="difflineplus">+      }</span>
<a href="#l39.565"></a><span id="l39.565" class="difflineplus">+</span>
<a href="#l39.566"></a><span id="l39.566" class="difflineplus">+      // - day</span>
<a href="#l39.567"></a><span id="l39.567" class="difflineplus">+      let valDate = val.getDate();</span>
<a href="#l39.568"></a><span id="l39.568" class="difflineplus">+      if (valDate in month) {</span>
<a href="#l39.569"></a><span id="l39.569" class="difflineplus">+        month[valDate].push(item);</span>
<a href="#l39.570"></a><span id="l39.570" class="difflineplus">+      }</span>
<a href="#l39.571"></a><span id="l39.571" class="difflineplus">+      else {</span>
<a href="#l39.572"></a><span id="l39.572" class="difflineplus">+        month[valDate] = [item];</span>
<a href="#l39.573"></a><span id="l39.573" class="difflineplus">+      }</span>
<a href="#l39.574"></a><span id="l39.574" class="difflineplus">+    }</span>
<a href="#l39.575"></a><span id="l39.575" class="difflineplus">+</span>
<a href="#l39.576"></a><span id="l39.576" class="difflineplus">+    this.oldest = oldest;</span>
<a href="#l39.577"></a><span id="l39.577" class="difflineplus">+    this.newest = newest;</span>
<a href="#l39.578"></a><span id="l39.578" class="difflineplus">+  },</span>
<a href="#l39.579"></a><span id="l39.579" class="difflineplus">+</span>
<a href="#l39.580"></a><span id="l39.580" class="difflineplus">+  _unionMonth: function(aMonthObj) {</span>
<a href="#l39.581"></a><span id="l39.581" class="difflineplus">+    let dayItemLists = [];</span>
<a href="#l39.582"></a><span id="l39.582" class="difflineplus">+    for each (let [key, dayItemList] in Iterator(aMonthObj)) {</span>
<a href="#l39.583"></a><span id="l39.583" class="difflineplus">+      if (typeof(key) == &quot;string&quot; &amp;&amp; key[0] == '_')</span>
<a href="#l39.584"></a><span id="l39.584" class="difflineplus">+        continue;</span>
<a href="#l39.585"></a><span id="l39.585" class="difflineplus">+      dayItemLists.push(dayItemList);</span>
<a href="#l39.586"></a><span id="l39.586" class="difflineplus">+    }</span>
<a href="#l39.587"></a><span id="l39.587" class="difflineplus">+    return Array.concat.apply([], dayItemLists);</span>
<a href="#l39.588"></a><span id="l39.588" class="difflineplus">+  },</span>
<a href="#l39.589"></a><span id="l39.589" class="difflineplus">+</span>
<a href="#l39.590"></a><span id="l39.590" class="difflineplus">+  _unionYear: function(aYearObj) {</span>
<a href="#l39.591"></a><span id="l39.591" class="difflineplus">+    let monthItemLists = [];</span>
<a href="#l39.592"></a><span id="l39.592" class="difflineplus">+    for each (let [key, monthObj] in Iterator(aYearObj)) {</span>
<a href="#l39.593"></a><span id="l39.593" class="difflineplus">+      if (typeof(key) == &quot;string&quot; &amp;&amp; key[0] == '_')</span>
<a href="#l39.594"></a><span id="l39.594" class="difflineplus">+        continue;</span>
<a href="#l39.595"></a><span id="l39.595" class="difflineplus">+      monthItemLists.push(this._unionMonth(monthObj));</span>
<a href="#l39.596"></a><span id="l39.596" class="difflineplus">+    }</span>
<a href="#l39.597"></a><span id="l39.597" class="difflineplus">+    return Array.concat.apply([], monthItemLists);</span>
<a href="#l39.598"></a><span id="l39.598" class="difflineplus">+  }</span>
<a href="#l39.599"></a><span id="l39.599" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/db/gloda/modules/fundattr.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/fundattr.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -38,16 +38,17 @@</span>
<a href="#l40.4"></a><span id="l40.4"> EXPORTED_SYMBOLS = ['GlodaFundAttr'];</span>
<a href="#l40.5"></a><span id="l40.5"> </span>
<a href="#l40.6"></a><span id="l40.6"> const Cc = Components.classes;</span>
<a href="#l40.7"></a><span id="l40.7"> const Ci = Components.interfaces;</span>
<a href="#l40.8"></a><span id="l40.8"> const Cr = Components.results;</span>
<a href="#l40.9"></a><span id="l40.9"> const Cu = Components.utils;</span>
<a href="#l40.10"></a><span id="l40.10"> </span>
<a href="#l40.11"></a><span id="l40.11"> Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineplus">+Cu.import(&quot;resource://app/modules/StringBundle.js&quot;);</span>
<a href="#l40.13"></a><span id="l40.13"> </span>
<a href="#l40.14"></a><span id="l40.14"> Cu.import(&quot;resource://app/modules/gloda/utils.js&quot;);</span>
<a href="#l40.15"></a><span id="l40.15"> Cu.import(&quot;resource://app/modules/gloda/gloda.js&quot;);</span>
<a href="#l40.16"></a><span id="l40.16"> Cu.import(&quot;resource://app/modules/gloda/datastore.js&quot;);</span>
<a href="#l40.17"></a><span id="l40.17"> </span>
<a href="#l40.18"></a><span id="l40.18"> Cu.import(&quot;resource://app/modules/gloda/noun_mimetype.js&quot;);</span>
<a href="#l40.19"></a><span id="l40.19"> </span>
<a href="#l40.20"></a><span id="l40.20"> </span>
<a href="#l40.21"></a><span id="l40.21" class="difflineat">@@ -55,57 +56,49 @@ Cu.import(&quot;resource://app/modules/gloda/</span>
<a href="#l40.22"></a><span id="l40.22">  * @namespace The Gloda Fundamental Attribute provider is a special attribute</span>
<a href="#l40.23"></a><span id="l40.23">  *  provider; it provides attributes that the rest of the providers should be</span>
<a href="#l40.24"></a><span id="l40.24">  *  able to assume exist.  Also, it may end up accessing things at a lower level</span>
<a href="#l40.25"></a><span id="l40.25">  *  than most extension providers should do.  In summary, don't mimic this code</span>
<a href="#l40.26"></a><span id="l40.26">  *  unless you won't complain when your code breaks.</span>
<a href="#l40.27"></a><span id="l40.27">  */</span>
<a href="#l40.28"></a><span id="l40.28"> var GlodaFundAttr = {</span>
<a href="#l40.29"></a><span id="l40.29">   providerName: &quot;gloda.fundattr&quot;,</span>
<a href="#l40.30"></a><span id="l40.30" class="difflineplus">+  strings: new StringBundle(&quot;chrome://messenger/locale/gloda.properties&quot;),</span>
<a href="#l40.31"></a><span id="l40.31">   _log: null,</span>
<a href="#l40.32"></a><span id="l40.32"> </span>
<a href="#l40.33"></a><span id="l40.33">   init: function gloda_explattr_init() {</span>
<a href="#l40.34"></a><span id="l40.34">     this._log =  Log4Moz.repository.getLogger(&quot;gloda.fundattr&quot;);</span>
<a href="#l40.35"></a><span id="l40.35"> </span>
<a href="#l40.36"></a><span id="l40.36">     try {</span>
<a href="#l40.37"></a><span id="l40.37">       this.defineAttributes();</span>
<a href="#l40.38"></a><span id="l40.38">     }</span>
<a href="#l40.39"></a><span id="l40.39">     catch (ex) {</span>
<a href="#l40.40"></a><span id="l40.40">       this._log.error(&quot;Error in init: &quot; + ex);</span>
<a href="#l40.41"></a><span id="l40.41">       throw ex;</span>
<a href="#l40.42"></a><span id="l40.42">     }</span>
<a href="#l40.43"></a><span id="l40.43">   },</span>
<a href="#l40.44"></a><span id="l40.44"> </span>
<a href="#l40.45"></a><span id="l40.45">   POPULARITY_FROM_ME_TO: 10,</span>
<a href="#l40.46"></a><span id="l40.46">   POPULARITY_FROM_ME_CC: 4,</span>
<a href="#l40.47"></a><span id="l40.47" class="difflineplus">+  POPULARITY_FROM_ME_BCC: 3,</span>
<a href="#l40.48"></a><span id="l40.48">   POPULARITY_TO_ME: 5,</span>
<a href="#l40.49"></a><span id="l40.49">   POPULARITY_CC_ME: 1,</span>
<a href="#l40.50"></a><span id="l40.50" class="difflineplus">+  POPULARITY_BCC_ME: 1,</span>
<a href="#l40.51"></a><span id="l40.51"> </span>
<a href="#l40.52"></a><span id="l40.52">   /** Boost for messages 'I' sent */</span>
<a href="#l40.53"></a><span id="l40.53">   NOTABILITY_FROM_ME: 10,</span>
<a href="#l40.54"></a><span id="l40.54">   /** Boost for messages involving 'me'. */</span>
<a href="#l40.55"></a><span id="l40.55">   NOTABILITY_INVOLVING_ME: 1,</span>
<a href="#l40.56"></a><span id="l40.56">   /** Boost for message from someone in 'my' address book. */</span>
<a href="#l40.57"></a><span id="l40.57">   NOTABILITY_FROM_IN_ADDR_BOOK: 10,</span>
<a href="#l40.58"></a><span id="l40.58">   /** Boost for the first person involved in my address book. */</span>
<a href="#l40.59"></a><span id="l40.59">   NOTABILITY_INVOLVING_ADDR_BOOK_FIRST: 8,</span>
<a href="#l40.60"></a><span id="l40.60">   /** Boost for each additional person involved in my address book. */</span>
<a href="#l40.61"></a><span id="l40.61">   NOTABILITY_INVOLVING_ADDR_BOOK_ADDL: 2,</span>
<a href="#l40.62"></a><span id="l40.62"> </span>
<a href="#l40.63"></a><span id="l40.63" class="difflineminus">-  _attrConvSubject: null,</span>
<a href="#l40.64"></a><span id="l40.64" class="difflineminus">-  _attrFolder: null,</span>
<a href="#l40.65"></a><span id="l40.65" class="difflineminus">-  _attrBody: null,</span>
<a href="#l40.66"></a><span id="l40.66" class="difflineminus">-  _attrFrom: null,</span>
<a href="#l40.67"></a><span id="l40.67" class="difflineminus">-  _attrFromMe: null,</span>
<a href="#l40.68"></a><span id="l40.68" class="difflineminus">-  _attrTo: null,</span>
<a href="#l40.69"></a><span id="l40.69" class="difflineminus">-  _attrToMe: null,</span>
<a href="#l40.70"></a><span id="l40.70" class="difflineminus">-  _attrCc: null,</span>
<a href="#l40.71"></a><span id="l40.71" class="difflineminus">-  _attrCcMe: null,</span>
<a href="#l40.72"></a><span id="l40.72" class="difflineminus">-  _attrDate: null,</span>
<a href="#l40.73"></a><span id="l40.73" class="difflineminus">-</span>
<a href="#l40.74"></a><span id="l40.74">   defineAttributes: function() {</span>
<a href="#l40.75"></a><span id="l40.75">     /* ***** Conversations ***** */</span>
<a href="#l40.76"></a><span id="l40.76">     // conversation: subjectMatches</span>
<a href="#l40.77"></a><span id="l40.77">     this._attrConvSubject = Gloda.defineAttribute({</span>
<a href="#l40.78"></a><span id="l40.78">       provider: this,</span>
<a href="#l40.79"></a><span id="l40.79">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l40.80"></a><span id="l40.80">       attributeType: Gloda.kAttrDerived,</span>
<a href="#l40.81"></a><span id="l40.81">       attributeName: &quot;subjectMatches&quot;,</span>
<a href="#l40.82"></a><span id="l40.82" class="difflineat">@@ -119,16 +112,17 @@ var GlodaFundAttr = {</span>
<a href="#l40.83"></a><span id="l40.83">     /* ***** Messages ***** */</span>
<a href="#l40.84"></a><span id="l40.84">     // folder</span>
<a href="#l40.85"></a><span id="l40.85">     this._attrFolder = Gloda.defineAttribute({</span>
<a href="#l40.86"></a><span id="l40.86">       provider: this,</span>
<a href="#l40.87"></a><span id="l40.87">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l40.88"></a><span id="l40.88">       attributeType: Gloda.kAttrFundamental,</span>
<a href="#l40.89"></a><span id="l40.89">       attributeName: &quot;folder&quot;,</span>
<a href="#l40.90"></a><span id="l40.90">       singular: true,</span>
<a href="#l40.91"></a><span id="l40.91" class="difflineplus">+      facet: true,</span>
<a href="#l40.92"></a><span id="l40.92">       special: Gloda.kSpecialColumn,</span>
<a href="#l40.93"></a><span id="l40.93">       specialColumnName: &quot;folderID&quot;,</span>
<a href="#l40.94"></a><span id="l40.94">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l40.95"></a><span id="l40.95">       objectNoun: Gloda.NOUN_FOLDER,</span>
<a href="#l40.96"></a><span id="l40.96">       }); // tested-by: test_attributes_fundamental</span>
<a href="#l40.97"></a><span id="l40.97">     this._attrFolder = Gloda.defineAttribute({</span>
<a href="#l40.98"></a><span id="l40.98">       provider: this,</span>
<a href="#l40.99"></a><span id="l40.99">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l40.100"></a><span id="l40.100" class="difflineat">@@ -267,92 +261,118 @@ var GlodaFundAttr = {</span>
<a href="#l40.101"></a><span id="l40.101">                         provider: this,</span>
<a href="#l40.102"></a><span id="l40.102">                         extensionName: Gloda.BUILT_IN,</span>
<a href="#l40.103"></a><span id="l40.103">                         attributeType: Gloda.kAttrFundamental,</span>
<a href="#l40.104"></a><span id="l40.104">                         attributeName: &quot;cc&quot;,</span>
<a href="#l40.105"></a><span id="l40.105">                         singular: false,</span>
<a href="#l40.106"></a><span id="l40.106">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l40.107"></a><span id="l40.107">                         objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l40.108"></a><span id="l40.108">                         }); // not-tested</span>
<a href="#l40.109"></a><span id="l40.109" class="difflineplus">+    /**</span>
<a href="#l40.110"></a><span id="l40.110" class="difflineplus">+     * Bcc'ed recipients; only makes sense for sent messages.</span>
<a href="#l40.111"></a><span id="l40.111" class="difflineplus">+     */</span>
<a href="#l40.112"></a><span id="l40.112" class="difflineplus">+    this._attrBcc = Gloda.defineAttribute({</span>
<a href="#l40.113"></a><span id="l40.113" class="difflineplus">+      provider: this,</span>
<a href="#l40.114"></a><span id="l40.114" class="difflineplus">+      extensionName: Gloda.BUILT_IN,</span>
<a href="#l40.115"></a><span id="l40.115" class="difflineplus">+      attributeType: Gloda.kAttrFundamental,</span>
<a href="#l40.116"></a><span id="l40.116" class="difflineplus">+      attributeName: &quot;bcc&quot;,</span>
<a href="#l40.117"></a><span id="l40.117" class="difflineplus">+      singular: false,</span>
<a href="#l40.118"></a><span id="l40.118" class="difflineplus">+      facet: true,</span>
<a href="#l40.119"></a><span id="l40.119" class="difflineplus">+      subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l40.120"></a><span id="l40.120" class="difflineplus">+      objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l40.121"></a><span id="l40.121" class="difflineplus">+    }); // not-tested</span>
<a href="#l40.122"></a><span id="l40.122"> </span>
<a href="#l40.123"></a><span id="l40.123">     // Date.  now lives on the row.</span>
<a href="#l40.124"></a><span id="l40.124">     this._attrDate = Gloda.defineAttribute({</span>
<a href="#l40.125"></a><span id="l40.125">                         provider: this,</span>
<a href="#l40.126"></a><span id="l40.126">                         extensionName: Gloda.BUILT_IN,</span>
<a href="#l40.127"></a><span id="l40.127">                         attributeType: Gloda.kAttrFundamental,</span>
<a href="#l40.128"></a><span id="l40.128">                         attributeName: &quot;date&quot;,</span>
<a href="#l40.129"></a><span id="l40.129">                         singular: true,</span>
<a href="#l40.130"></a><span id="l40.130" class="difflineplus">+                        facet: {</span>
<a href="#l40.131"></a><span id="l40.131" class="difflineplus">+                          type: &quot;date&quot;,</span>
<a href="#l40.132"></a><span id="l40.132" class="difflineplus">+                        },</span>
<a href="#l40.133"></a><span id="l40.133">                         special: Gloda.kSpecialColumn,</span>
<a href="#l40.134"></a><span id="l40.134">                         specialColumnName: &quot;date&quot;,</span>
<a href="#l40.135"></a><span id="l40.135">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l40.136"></a><span id="l40.136">                         objectNoun: Gloda.NOUN_DATE,</span>
<a href="#l40.137"></a><span id="l40.137">                         }); // tested-by: test_attributes_fundamental</span>
<a href="#l40.138"></a><span id="l40.138"> </span>
<a href="#l40.139"></a><span id="l40.139">     // Attachment MIME Types</span>
<a href="#l40.140"></a><span id="l40.140">     this._attrAttachmentTypes = Gloda.defineAttribute({</span>
<a href="#l40.141"></a><span id="l40.141">       provider: this,</span>
<a href="#l40.142"></a><span id="l40.142">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l40.143"></a><span id="l40.143">       attributeType: Gloda.kAttrFundamental,</span>
<a href="#l40.144"></a><span id="l40.144">       attributeName: &quot;attachmentTypes&quot;,</span>
<a href="#l40.145"></a><span id="l40.145">       singular: false,</span>
<a href="#l40.146"></a><span id="l40.146" class="difflineplus">+      facet: {</span>
<a href="#l40.147"></a><span id="l40.147" class="difflineplus">+        type: &quot;default&quot;,</span>
<a href="#l40.148"></a><span id="l40.148" class="difflineplus">+        // This will group the MIME types by their category.</span>
<a href="#l40.149"></a><span id="l40.149" class="difflineplus">+        groupIdAttr: &quot;category&quot;,</span>
<a href="#l40.150"></a><span id="l40.150" class="difflineplus">+        queryHelper: &quot;Category&quot;,</span>
<a href="#l40.151"></a><span id="l40.151" class="difflineplus">+      },</span>
<a href="#l40.152"></a><span id="l40.152">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l40.153"></a><span id="l40.153">       objectNoun: Gloda.NOUN_MIME_TYPE,</span>
<a href="#l40.154"></a><span id="l40.154">       });</span>
<a href="#l40.155"></a><span id="l40.155"> </span>
<a href="#l40.156"></a><span id="l40.156">     // --- Optimization</span>
<a href="#l40.157"></a><span id="l40.157" class="difflineminus">-    // Involves.  Means any of from/to/cc.  The queries get ugly enough without</span>
<a href="#l40.158"></a><span id="l40.158" class="difflineminus">-    //   this that it seems to justify the cost, especially given the frequent</span>
<a href="#l40.159"></a><span id="l40.159" class="difflineminus">-    //   use case.  (In fact, post-filtering for the specific from/to/cc is</span>
<a href="#l40.160"></a><span id="l40.160" class="difflineminus">-    //   probably justifiable rather than losing this attribute...)</span>
<a href="#l40.161"></a><span id="l40.161" class="difflineplus">+    /**</span>
<a href="#l40.162"></a><span id="l40.162" class="difflineplus">+     * Involves means any of from/to/cc/bcc.  The queries get ugly enough</span>
<a href="#l40.163"></a><span id="l40.163" class="difflineplus">+     *  without this that it seems to justify the cost, especially given the</span>
<a href="#l40.164"></a><span id="l40.164" class="difflineplus">+     *  frequent use case.  (In fact, post-filtering for the specific from/to/cc</span>
<a href="#l40.165"></a><span id="l40.165" class="difflineplus">+     *  is probably justifiable rather than losing this attribute...)</span>
<a href="#l40.166"></a><span id="l40.166" class="difflineplus">+     */</span>
<a href="#l40.167"></a><span id="l40.167">     this._attrInvolves = Gloda.defineAttribute({</span>
<a href="#l40.168"></a><span id="l40.168">       provider: this,</span>
<a href="#l40.169"></a><span id="l40.169">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l40.170"></a><span id="l40.170">       attributeType: Gloda.kAttrOptimization,</span>
<a href="#l40.171"></a><span id="l40.171">       attributeName: &quot;involves&quot;,</span>
<a href="#l40.172"></a><span id="l40.172">       singular: false,</span>
<a href="#l40.173"></a><span id="l40.173" class="difflineplus">+      facet: true,</span>
<a href="#l40.174"></a><span id="l40.174">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l40.175"></a><span id="l40.175">       objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l40.176"></a><span id="l40.176">       }); // not-tested</span>
<a href="#l40.177"></a><span id="l40.177"> </span>
<a href="#l40.178"></a><span id="l40.178" class="difflineminus">-    // From Me To</span>
<a href="#l40.179"></a><span id="l40.179" class="difflineminus">-    this._attrFromMeTo = Gloda.defineAttribute({</span>
<a href="#l40.180"></a><span id="l40.180" class="difflineplus">+    /**</span>
<a href="#l40.181"></a><span id="l40.181" class="difflineplus">+     * Any of to/cc/bcc.</span>
<a href="#l40.182"></a><span id="l40.182" class="difflineplus">+     */</span>
<a href="#l40.183"></a><span id="l40.183" class="difflineplus">+    this._attrRecipients = Gloda.defineAttribute({</span>
<a href="#l40.184"></a><span id="l40.184">       provider: this,</span>
<a href="#l40.185"></a><span id="l40.185">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l40.186"></a><span id="l40.186">       attributeType: Gloda.kAttrOptimization,</span>
<a href="#l40.187"></a><span id="l40.187" class="difflineminus">-      attributeName: &quot;fromMeTo&quot;,</span>
<a href="#l40.188"></a><span id="l40.188" class="difflineplus">+      attributeName: &quot;recipients&quot;,</span>
<a href="#l40.189"></a><span id="l40.189">       singular: false,</span>
<a href="#l40.190"></a><span id="l40.190">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l40.191"></a><span id="l40.191" class="difflineplus">+      objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l40.192"></a><span id="l40.192" class="difflineplus">+      }); // not-tested</span>
<a href="#l40.193"></a><span id="l40.193" class="difflineplus">+</span>
<a href="#l40.194"></a><span id="l40.194" class="difflineplus">+    // From Me (To/Cc/Bcc)</span>
<a href="#l40.195"></a><span id="l40.195" class="difflineplus">+    this._attrFromMe = Gloda.defineAttribute({</span>
<a href="#l40.196"></a><span id="l40.196" class="difflineplus">+      provider: this,</span>
<a href="#l40.197"></a><span id="l40.197" class="difflineplus">+      extensionName: Gloda.BUILT_IN,</span>
<a href="#l40.198"></a><span id="l40.198" class="difflineplus">+      attributeType: Gloda.kAttrOptimization,</span>
<a href="#l40.199"></a><span id="l40.199" class="difflineplus">+      attributeName: &quot;fromMe&quot;,</span>
<a href="#l40.200"></a><span id="l40.200" class="difflineplus">+      singular: false,</span>
<a href="#l40.201"></a><span id="l40.201" class="difflineplus">+      // The interesting thing to a facet is whether the message is from me.</span>
<a href="#l40.202"></a><span id="l40.202" class="difflineplus">+      facet: {</span>
<a href="#l40.203"></a><span id="l40.203" class="difflineplus">+        type: &quot;nonempty?&quot;</span>
<a href="#l40.204"></a><span id="l40.204" class="difflineplus">+      },</span>
<a href="#l40.205"></a><span id="l40.205" class="difflineplus">+      subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l40.206"></a><span id="l40.206">       objectNoun: Gloda.NOUN_PARAM_IDENTITY,</span>
<a href="#l40.207"></a><span id="l40.207">       }); // not-tested</span>
<a href="#l40.208"></a><span id="l40.208" class="difflineminus">-    // From Me Cc</span>
<a href="#l40.209"></a><span id="l40.209" class="difflineminus">-    this._attrFromMeCc = Gloda.defineAttribute({</span>
<a href="#l40.210"></a><span id="l40.210" class="difflineminus">-      provider: this,</span>
<a href="#l40.211"></a><span id="l40.211" class="difflineminus">-      extensionName: Gloda.BUILT_IN,</span>
<a href="#l40.212"></a><span id="l40.212" class="difflineminus">-      attributeType: Gloda.kAttrOptimization,</span>
<a href="#l40.213"></a><span id="l40.213" class="difflineminus">-      attributeName: &quot;fromMeCc&quot;,</span>
<a href="#l40.214"></a><span id="l40.214" class="difflineminus">-      singular: false,</span>
<a href="#l40.215"></a><span id="l40.215" class="difflineminus">-      subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l40.216"></a><span id="l40.216" class="difflineminus">-      objectNoun: Gloda.NOUN_PARAM_IDENTITY,</span>
<a href="#l40.217"></a><span id="l40.217" class="difflineminus">-      }); // not-tested</span>
<a href="#l40.218"></a><span id="l40.218" class="difflineminus">-    // To Me</span>
<a href="#l40.219"></a><span id="l40.219" class="difflineplus">+    // To/Cc/Bcc Me</span>
<a href="#l40.220"></a><span id="l40.220">     this._attrToMe = Gloda.defineAttribute({</span>
<a href="#l40.221"></a><span id="l40.221">       provider: this,</span>
<a href="#l40.222"></a><span id="l40.222">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l40.223"></a><span id="l40.223">       attributeType: Gloda.kAttrFundamental,</span>
<a href="#l40.224"></a><span id="l40.224">       attributeName: &quot;toMe&quot;,</span>
<a href="#l40.225"></a><span id="l40.225" class="difflineminus">-      singular: false,</span>
<a href="#l40.226"></a><span id="l40.226" class="difflineminus">-      subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l40.227"></a><span id="l40.227" class="difflineminus">-      objectNoun: Gloda.NOUN_PARAM_IDENTITY,</span>
<a href="#l40.228"></a><span id="l40.228" class="difflineminus">-      }); // not-tested</span>
<a href="#l40.229"></a><span id="l40.229" class="difflineminus">-    // Cc Me</span>
<a href="#l40.230"></a><span id="l40.230" class="difflineminus">-    this._attrCcMe = Gloda.defineAttribute({</span>
<a href="#l40.231"></a><span id="l40.231" class="difflineminus">-      provider: this,</span>
<a href="#l40.232"></a><span id="l40.232" class="difflineminus">-      extensionName: Gloda.BUILT_IN,</span>
<a href="#l40.233"></a><span id="l40.233" class="difflineminus">-      attributeType: Gloda.kAttrFundamental,</span>
<a href="#l40.234"></a><span id="l40.234" class="difflineminus">-      attributeName: &quot;ccMe&quot;,</span>
<a href="#l40.235"></a><span id="l40.235" class="difflineplus">+      // The interesting thing to a facet is whether the message is to me.</span>
<a href="#l40.236"></a><span id="l40.236" class="difflineplus">+      facet: {</span>
<a href="#l40.237"></a><span id="l40.237" class="difflineplus">+        type: &quot;nonempty?&quot;</span>
<a href="#l40.238"></a><span id="l40.238" class="difflineplus">+      },</span>
<a href="#l40.239"></a><span id="l40.239">       singular: false,</span>
<a href="#l40.240"></a><span id="l40.240">       subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l40.241"></a><span id="l40.241">       objectNoun: Gloda.NOUN_PARAM_IDENTITY,</span>
<a href="#l40.242"></a><span id="l40.242">       }); // not-tested</span>
<a href="#l40.243"></a><span id="l40.243"> </span>
<a href="#l40.244"></a><span id="l40.244"> </span>
<a href="#l40.245"></a><span id="l40.245">     // -- Mailing List</span>
<a href="#l40.246"></a><span id="l40.246">     // Non-singular, but a hard call.  Namely, it is obvious that a message can</span>
<a href="#l40.247"></a><span id="l40.247" class="difflineat">@@ -372,21 +392,24 @@ var GlodaFundAttr = {</span>
<a href="#l40.248"></a><span id="l40.248">     //  by the user.</span>
<a href="#l40.249"></a><span id="l40.249">     this._attrList = Gloda.defineAttribute({</span>
<a href="#l40.250"></a><span id="l40.250">                         provider: this,</span>
<a href="#l40.251"></a><span id="l40.251">                         extensionName: Gloda.BUILT_IN,</span>
<a href="#l40.252"></a><span id="l40.252">                         attributeType: Gloda.kAttrFundamental,</span>
<a href="#l40.253"></a><span id="l40.253">                         attributeName: &quot;mailing-list&quot;,</span>
<a href="#l40.254"></a><span id="l40.254">                         bindName: &quot;mailingLists&quot;,</span>
<a href="#l40.255"></a><span id="l40.255">                         singular: false,</span>
<a href="#l40.256"></a><span id="l40.256" class="difflineplus">+                        facet: true,</span>
<a href="#l40.257"></a><span id="l40.257">                         subjectNouns: [Gloda.NOUN_MESSAGE],</span>
<a href="#l40.258"></a><span id="l40.258">                         objectNoun: Gloda.NOUN_IDENTITY,</span>
<a href="#l40.259"></a><span id="l40.259">                         }); // not-tested, not-implemented</span>
<a href="#l40.260"></a><span id="l40.260">   },</span>
<a href="#l40.261"></a><span id="l40.261"> </span>
<a href="#l40.262"></a><span id="l40.262" class="difflineplus">+  RE_LIST_POST: /&lt;mailto:([^&gt;]+)&gt;/,</span>
<a href="#l40.263"></a><span id="l40.263" class="difflineplus">+</span>
<a href="#l40.264"></a><span id="l40.264">   /**</span>
<a href="#l40.265"></a><span id="l40.265">    *</span>
<a href="#l40.266"></a><span id="l40.266">    * Specializations:</span>
<a href="#l40.267"></a><span id="l40.267">    * - Mailing Lists.  Replies to a message on a mailing list frequently only</span>
<a href="#l40.268"></a><span id="l40.268">    *   have the list-serve as the 'to', so we try to generate a synthetic 'to'</span>
<a href="#l40.269"></a><span id="l40.269">    *   based on the author of the parent message when possible.  (The 'possible'</span>
<a href="#l40.270"></a><span id="l40.270">    *   part is that we may not have a copy of the parent message at the time of</span>
<a href="#l40.271"></a><span id="l40.271">    *   processing.)</span>
<a href="#l40.272"></a><span id="l40.272" class="difflineat">@@ -408,33 +431,47 @@ var GlodaFundAttr = {</span>
<a href="#l40.273"></a><span id="l40.273">       author = aMsgHdr.getStringProperty(&quot;replyTo&quot;);</span>
<a href="#l40.274"></a><span id="l40.274">     }</span>
<a href="#l40.275"></a><span id="l40.275">     catch (ex) {</span>
<a href="#l40.276"></a><span id="l40.276">     }</span>
<a href="#l40.277"></a><span id="l40.277">     */</span>
<a href="#l40.278"></a><span id="l40.278">     if (author == null || author == &quot;&quot;)</span>
<a href="#l40.279"></a><span id="l40.279">       author = aMsgHdr.mime2DecodedAuthor;</span>
<a href="#l40.280"></a><span id="l40.280"> </span>
<a href="#l40.281"></a><span id="l40.281" class="difflineminus">-    let [authorIdentities, toIdentities, ccIdentities] =</span>
<a href="#l40.282"></a><span id="l40.282" class="difflineplus">+    let normalizedListPost = &quot;&quot;;</span>
<a href="#l40.283"></a><span id="l40.283" class="difflineplus">+    if (aMimeMsg.has(&quot;list-post&quot;)) {</span>
<a href="#l40.284"></a><span id="l40.284" class="difflineplus">+      let match = this.RE_LIST_POST.exec(aMimeMsg.get(&quot;list-post&quot;));</span>
<a href="#l40.285"></a><span id="l40.285" class="difflineplus">+      if (match)</span>
<a href="#l40.286"></a><span id="l40.286" class="difflineplus">+        normalizedListPost = &quot;&lt;&quot; + match[1] + &quot;&gt;&quot;;</span>
<a href="#l40.287"></a><span id="l40.287" class="difflineplus">+    }</span>
<a href="#l40.288"></a><span id="l40.288" class="difflineplus">+</span>
<a href="#l40.289"></a><span id="l40.289" class="difflineplus">+    let [authorIdentities, toIdentities, ccIdentities, bccIdentities,</span>
<a href="#l40.290"></a><span id="l40.290" class="difflineplus">+         listIdentities] =</span>
<a href="#l40.291"></a><span id="l40.291">       yield aCallbackHandle.pushAndGo(</span>
<a href="#l40.292"></a><span id="l40.292">         Gloda.getOrCreateMailIdentities(aCallbackHandle,</span>
<a href="#l40.293"></a><span id="l40.293">                                         author, aMsgHdr.mime2DecodedRecipients,</span>
<a href="#l40.294"></a><span id="l40.294" class="difflineminus">-                                        aMsgHdr.ccList));</span>
<a href="#l40.295"></a><span id="l40.295" class="difflineplus">+                                        aMsgHdr.ccList, aMsgHdr.bccList,</span>
<a href="#l40.296"></a><span id="l40.296" class="difflineplus">+                                        normalizedListPost));</span>
<a href="#l40.297"></a><span id="l40.297"> </span>
<a href="#l40.298"></a><span id="l40.298">     if (authorIdentities.length == 0) {</span>
<a href="#l40.299"></a><span id="l40.299">       this._log.error(&quot;Message with subject '&quot; + aMsgHdr.mime2DecodedSubject +</span>
<a href="#l40.300"></a><span id="l40.300">                       &quot;' somehow lacks a valid author.  Bailing.&quot;);</span>
<a href="#l40.301"></a><span id="l40.301">       return; // being a generator, this generates an exception; we like.</span>
<a href="#l40.302"></a><span id="l40.302">     }</span>
<a href="#l40.303"></a><span id="l40.303">     let authorIdentity = authorIdentities[0];</span>
<a href="#l40.304"></a><span id="l40.304">     aGlodaMessage.from = authorIdentity;</span>
<a href="#l40.305"></a><span id="l40.305"> </span>
<a href="#l40.306"></a><span id="l40.306" class="difflineminus">-    // -- To, Cc</span>
<a href="#l40.307"></a><span id="l40.307" class="difflineplus">+    // -- To, Cc, Bcc</span>
<a href="#l40.308"></a><span id="l40.308">     aGlodaMessage.to = toIdentities;</span>
<a href="#l40.309"></a><span id="l40.309">     aGlodaMessage.cc = ccIdentities;</span>
<a href="#l40.310"></a><span id="l40.310" class="difflineplus">+    aGlodaMessage.bcc = bccIdentities;</span>
<a href="#l40.311"></a><span id="l40.311" class="difflineplus">+</span>
<a href="#l40.312"></a><span id="l40.312" class="difflineplus">+    // -- Mailing List</span>
<a href="#l40.313"></a><span id="l40.313" class="difflineplus">+    if (listIdentities.length)</span>
<a href="#l40.314"></a><span id="l40.314" class="difflineplus">+      aGlodaMessage.mailingLists = listIdentities;</span>
<a href="#l40.315"></a><span id="l40.315"> </span>
<a href="#l40.316"></a><span id="l40.316">     // -- Attachments</span>
<a href="#l40.317"></a><span id="l40.317">     let attachmentTypes = [];</span>
<a href="#l40.318"></a><span id="l40.318">     for each (let [, attachment] in Iterator(aMimeMsg.allAttachments)) {</span>
<a href="#l40.319"></a><span id="l40.319">       // We don't care about would-be attachments that are not user-intended</span>
<a href="#l40.320"></a><span id="l40.320">       //  attachments but rather artifacts of the message content.</span>
<a href="#l40.321"></a><span id="l40.321">       // We also want to avoid dealing with obviously bogus mime types.</span>
<a href="#l40.322"></a><span id="l40.322">       //  (If you don't have a &quot;/&quot;, you are probably bogus.)</span>
<a href="#l40.323"></a><span id="l40.323" class="difflineat">@@ -455,24 +492,24 @@ var GlodaFundAttr = {</span>
<a href="#l40.324"></a><span id="l40.324">     yield Gloda.kWorkDone;</span>
<a href="#l40.325"></a><span id="l40.325">   },</span>
<a href="#l40.326"></a><span id="l40.326"> </span>
<a href="#l40.327"></a><span id="l40.327">   optimize: function gloda_fundattr_optimize(aGlodaMessage, aRawReps,</span>
<a href="#l40.328"></a><span id="l40.328">       aIsNew, aCallbackHandle) {</span>
<a href="#l40.329"></a><span id="l40.329"> </span>
<a href="#l40.330"></a><span id="l40.330">     let aMsgHdr = aRawReps.header;</span>
<a href="#l40.331"></a><span id="l40.331"> </span>
<a href="#l40.332"></a><span id="l40.332" class="difflineplus">+    // for simplicity this is used for both involves and recipients</span>
<a href="#l40.333"></a><span id="l40.333">     let involvesIdentities = {};</span>
<a href="#l40.334"></a><span id="l40.334">     let involves = aGlodaMessage.involves || [];</span>
<a href="#l40.335"></a><span id="l40.335" class="difflineplus">+    let recipients = aGlodaMessage.recipients || [];</span>
<a href="#l40.336"></a><span id="l40.336"> </span>
<a href="#l40.337"></a><span id="l40.337" class="difflineminus">-    // me specialization optimizations</span>
<a href="#l40.338"></a><span id="l40.338" class="difflineplus">+    // 'me' specialization optimizations</span>
<a href="#l40.339"></a><span id="l40.339">     let toMe = aGlodaMessage.toMe || [];</span>
<a href="#l40.340"></a><span id="l40.340" class="difflineminus">-    let fromMeTo = aGlodaMessage.fromMeTo || [];</span>
<a href="#l40.341"></a><span id="l40.341" class="difflineminus">-    let ccMe = aGlodaMessage.ccMe || [];</span>
<a href="#l40.342"></a><span id="l40.342" class="difflineminus">-    let fromMeCc = aGlodaMessage.fromMeCc || [];</span>
<a href="#l40.343"></a><span id="l40.343" class="difflineplus">+    let fromMe = aGlodaMessage.fromMe || [];</span>
<a href="#l40.344"></a><span id="l40.344"> </span>
<a href="#l40.345"></a><span id="l40.345">     let myIdentities = Gloda.myIdentities; // needless optimization?</span>
<a href="#l40.346"></a><span id="l40.346">     let authorIdentity = aGlodaMessage.from;</span>
<a href="#l40.347"></a><span id="l40.347">     let isFromMe = authorIdentity.id in myIdentities;</span>
<a href="#l40.348"></a><span id="l40.348"> </span>
<a href="#l40.349"></a><span id="l40.349">     // The fulltext search column for the author.  We want to have in here:</span>
<a href="#l40.350"></a><span id="l40.350">     // - The e-mail address and display name as enclosed on the message.</span>
<a href="#l40.351"></a><span id="l40.351">     // - The name per the address book card for this e-mail address, if we have</span>
<a href="#l40.352"></a><span id="l40.352" class="difflineat">@@ -495,16 +532,17 @@ var GlodaFundAttr = {</span>
<a href="#l40.353"></a><span id="l40.353">     involves.push(authorIdentity);</span>
<a href="#l40.354"></a><span id="l40.354">     involvesIdentities[authorIdentity.id] = true;</span>
<a href="#l40.355"></a><span id="l40.355"> </span>
<a href="#l40.356"></a><span id="l40.356">     let involvedAddrBookCount = 0;</span>
<a href="#l40.357"></a><span id="l40.357"> </span>
<a href="#l40.358"></a><span id="l40.358">     for each (let [,toIdentity] in Iterator(aGlodaMessage.to)) {</span>
<a href="#l40.359"></a><span id="l40.359">       if (!(toIdentity.id in involvesIdentities)) {</span>
<a href="#l40.360"></a><span id="l40.360">         involves.push(toIdentity);</span>
<a href="#l40.361"></a><span id="l40.361" class="difflineplus">+        recipients.push(toIdentity);</span>
<a href="#l40.362"></a><span id="l40.362">         involvesIdentities[toIdentity.id] = true;</span>
<a href="#l40.363"></a><span id="l40.363">         let toCard = toIdentity.abCard;</span>
<a href="#l40.364"></a><span id="l40.364">         if (toCard) {</span>
<a href="#l40.365"></a><span id="l40.365">           involvedAddrBookCount++;</span>
<a href="#l40.366"></a><span id="l40.366">           // @testpoint gloda.noun.message.attr.recipientsMatch</span>
<a href="#l40.367"></a><span id="l40.367">           aGlodaMessage._indexRecipients += ' ' + toCard.displayName;</span>
<a href="#l40.368"></a><span id="l40.368">         }</span>
<a href="#l40.369"></a><span id="l40.369">       }</span>
<a href="#l40.370"></a><span id="l40.370" class="difflineat">@@ -512,63 +550,89 @@ var GlodaFundAttr = {</span>
<a href="#l40.371"></a><span id="l40.371">       // optimization attribute to-me ('I' am the parameter)</span>
<a href="#l40.372"></a><span id="l40.372">       if (toIdentity.id in myIdentities) {</span>
<a href="#l40.373"></a><span id="l40.373">         toMe.push([toIdentity, authorIdentity]);</span>
<a href="#l40.374"></a><span id="l40.374">         if (aIsNew)</span>
<a href="#l40.375"></a><span id="l40.375">           authorIdentity.contact.popularity += this.POPULARITY_TO_ME;</span>
<a href="#l40.376"></a><span id="l40.376">       }</span>
<a href="#l40.377"></a><span id="l40.377">       // optimization attribute from-me-to ('I' am the parameter)</span>
<a href="#l40.378"></a><span id="l40.378">       if (isFromMe) {</span>
<a href="#l40.379"></a><span id="l40.379" class="difflineminus">-        fromMeTo.push([authorIdentity, toIdentity]);</span>
<a href="#l40.380"></a><span id="l40.380" class="difflineplus">+        fromMe.push([authorIdentity, toIdentity]);</span>
<a href="#l40.381"></a><span id="l40.381">         // also, popularity</span>
<a href="#l40.382"></a><span id="l40.382">         if (aIsNew)</span>
<a href="#l40.383"></a><span id="l40.383">           toIdentity.contact.popularity += this.POPULARITY_FROM_ME_TO;</span>
<a href="#l40.384"></a><span id="l40.384">       }</span>
<a href="#l40.385"></a><span id="l40.385">     }</span>
<a href="#l40.386"></a><span id="l40.386">     for each (let [,ccIdentity] in Iterator(aGlodaMessage.cc)) {</span>
<a href="#l40.387"></a><span id="l40.387">       if (!(ccIdentity.id in involvesIdentities)) {</span>
<a href="#l40.388"></a><span id="l40.388">         involves.push(ccIdentity);</span>
<a href="#l40.389"></a><span id="l40.389" class="difflineplus">+        recipients.push(ccIdentity);</span>
<a href="#l40.390"></a><span id="l40.390">         involvesIdentities[ccIdentity.id] = true;</span>
<a href="#l40.391"></a><span id="l40.391">         let ccCard = ccIdentity.abCard;</span>
<a href="#l40.392"></a><span id="l40.392">         if (ccCard) {</span>
<a href="#l40.393"></a><span id="l40.393">           involvedAddrBookCount++;</span>
<a href="#l40.394"></a><span id="l40.394">           // @testpoint gloda.noun.message.attr.recipientsMatch</span>
<a href="#l40.395"></a><span id="l40.395">           aGlodaMessage._indexRecipients += ' ' + ccCard.displayName;</span>
<a href="#l40.396"></a><span id="l40.396">         }</span>
<a href="#l40.397"></a><span id="l40.397">       }</span>
<a href="#l40.398"></a><span id="l40.398">       // optimization attribute cc-me ('I' am the parameter)</span>
<a href="#l40.399"></a><span id="l40.399">       if (ccIdentity.id in myIdentities) {</span>
<a href="#l40.400"></a><span id="l40.400" class="difflineminus">-        ccMe.push([ccIdentity, authorIdentity]);</span>
<a href="#l40.401"></a><span id="l40.401" class="difflineplus">+        toMe.push([ccIdentity, authorIdentity]);</span>
<a href="#l40.402"></a><span id="l40.402">         if (aIsNew)</span>
<a href="#l40.403"></a><span id="l40.403">           authorIdentity.contact.popularity += this.POPULARITY_CC_ME;</span>
<a href="#l40.404"></a><span id="l40.404">       }</span>
<a href="#l40.405"></a><span id="l40.405">       // optimization attribute from-me-to ('I' am the parameter)</span>
<a href="#l40.406"></a><span id="l40.406">       if (isFromMe) {</span>
<a href="#l40.407"></a><span id="l40.407" class="difflineminus">-        fromMeCc.push([authorIdentity, ccIdentity]);</span>
<a href="#l40.408"></a><span id="l40.408" class="difflineplus">+        fromMe.push([authorIdentity, ccIdentity]);</span>
<a href="#l40.409"></a><span id="l40.409">         // also, popularity</span>
<a href="#l40.410"></a><span id="l40.410">         if (aIsNew)</span>
<a href="#l40.411"></a><span id="l40.411">           ccIdentity.contact.popularity += this.POPULARITY_FROM_ME_CC;</span>
<a href="#l40.412"></a><span id="l40.412">       }</span>
<a href="#l40.413"></a><span id="l40.413">     }</span>
<a href="#l40.414"></a><span id="l40.414" class="difflineplus">+    // just treat bcc like cc; the intent is the same although the exact</span>
<a href="#l40.415"></a><span id="l40.415" class="difflineplus">+    //  semantics differ.</span>
<a href="#l40.416"></a><span id="l40.416" class="difflineplus">+    for each (let [,bccIdentity] in Iterator(aGlodaMessage.bcc)) {</span>
<a href="#l40.417"></a><span id="l40.417" class="difflineplus">+      if (!(bccIdentity.id in involvesIdentities)) {</span>
<a href="#l40.418"></a><span id="l40.418" class="difflineplus">+        involves.push(bccIdentity);</span>
<a href="#l40.419"></a><span id="l40.419" class="difflineplus">+        recipients.push(bccIdentity);</span>
<a href="#l40.420"></a><span id="l40.420" class="difflineplus">+        involvesIdentities[bccIdentity.id] = true;</span>
<a href="#l40.421"></a><span id="l40.421" class="difflineplus">+        let bccCard = bccIdentity.abCard;</span>
<a href="#l40.422"></a><span id="l40.422" class="difflineplus">+        if (bccCard) {</span>
<a href="#l40.423"></a><span id="l40.423" class="difflineplus">+          involvedAddrBookCount++;</span>
<a href="#l40.424"></a><span id="l40.424" class="difflineplus">+          // @testpoint gloda.noun.message.attr.recipientsMatch</span>
<a href="#l40.425"></a><span id="l40.425" class="difflineplus">+          aGlodaMessage._indexRecipients += ' ' + bccCard.displayName;</span>
<a href="#l40.426"></a><span id="l40.426" class="difflineplus">+        }</span>
<a href="#l40.427"></a><span id="l40.427" class="difflineplus">+      }</span>
<a href="#l40.428"></a><span id="l40.428" class="difflineplus">+      // optimization attribute cc-me ('I' am the parameter)</span>
<a href="#l40.429"></a><span id="l40.429" class="difflineplus">+      if (bccIdentity.id in myIdentities) {</span>
<a href="#l40.430"></a><span id="l40.430" class="difflineplus">+        toMe.push([bccIdentity, authorIdentity]);</span>
<a href="#l40.431"></a><span id="l40.431" class="difflineplus">+        if (aIsNew)</span>
<a href="#l40.432"></a><span id="l40.432" class="difflineplus">+          authorIdentity.contact.popularity += this.POPULARITY_BCC_ME;</span>
<a href="#l40.433"></a><span id="l40.433" class="difflineplus">+      }</span>
<a href="#l40.434"></a><span id="l40.434" class="difflineplus">+      // optimization attribute from-me-to ('I' am the parameter)</span>
<a href="#l40.435"></a><span id="l40.435" class="difflineplus">+      if (isFromMe) {</span>
<a href="#l40.436"></a><span id="l40.436" class="difflineplus">+        fromMe.push([authorIdentity, bccIdentity]);</span>
<a href="#l40.437"></a><span id="l40.437" class="difflineplus">+        // also, popularity</span>
<a href="#l40.438"></a><span id="l40.438" class="difflineplus">+        if (aIsNew)</span>
<a href="#l40.439"></a><span id="l40.439" class="difflineplus">+          bccIdentity.contact.popularity += this.POPULARITY_FROM_ME_BCC;</span>
<a href="#l40.440"></a><span id="l40.440" class="difflineplus">+      }</span>
<a href="#l40.441"></a><span id="l40.441" class="difflineplus">+    }</span>
<a href="#l40.442"></a><span id="l40.442"> </span>
<a href="#l40.443"></a><span id="l40.443">     if (involvedAddrBookCount)</span>
<a href="#l40.444"></a><span id="l40.444">       aGlodaMessage.notability += this.NOTABILITY_INVOLVING_ADDR_BOOK_FIRST +</span>
<a href="#l40.445"></a><span id="l40.445">         (involvedAddrBookCount - 1) * this.NOTABILITY_INVOLVING_ADDR_BOOK_ADDL;</span>
<a href="#l40.446"></a><span id="l40.446"> </span>
<a href="#l40.447"></a><span id="l40.447">     aGlodaMessage.involves = involves;</span>
<a href="#l40.448"></a><span id="l40.448" class="difflineplus">+    aGlodaMessage.recipients = recipients;</span>
<a href="#l40.449"></a><span id="l40.449">     if (toMe.length) {</span>
<a href="#l40.450"></a><span id="l40.450">       aGlodaMessage.toMe = toMe;</span>
<a href="#l40.451"></a><span id="l40.451">       aGlodaMessage.notability += this.NOTABILITY_INVOLVING_ME;</span>
<a href="#l40.452"></a><span id="l40.452">     }</span>
<a href="#l40.453"></a><span id="l40.453" class="difflineminus">-    if (fromMeTo.length)</span>
<a href="#l40.454"></a><span id="l40.454" class="difflineminus">-      aGlodaMessage.fromMeTo = fromMeTo;</span>
<a href="#l40.455"></a><span id="l40.455" class="difflineminus">-    if (ccMe.length)</span>
<a href="#l40.456"></a><span id="l40.456" class="difflineminus">-      aGlodaMessage.ccMe = ccMe;</span>
<a href="#l40.457"></a><span id="l40.457" class="difflineminus">-    if (fromMeCc.length)</span>
<a href="#l40.458"></a><span id="l40.458" class="difflineminus">-      aGlodaMessage.fromMeCc = fromMeCc;</span>
<a href="#l40.459"></a><span id="l40.459" class="difflineplus">+    if (fromMe.length)</span>
<a href="#l40.460"></a><span id="l40.460" class="difflineplus">+      aGlodaMessage.fromMe = fromMe;</span>
<a href="#l40.461"></a><span id="l40.461"> </span>
<a href="#l40.462"></a><span id="l40.462">     if (aRawReps.bodyLines &amp;&amp;</span>
<a href="#l40.463"></a><span id="l40.463">         this.contentWhittle({}, aRawReps.bodyLines, aRawReps.content)) {</span>
<a href="#l40.464"></a><span id="l40.464">       // we were going to do something here?</span>
<a href="#l40.465"></a><span id="l40.465">     }</span>
<a href="#l40.466"></a><span id="l40.466"> </span>
<a href="#l40.467"></a><span id="l40.467">     yield Gloda.kWorkDone;</span>
<a href="#l40.468"></a><span id="l40.468">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/gloda.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -346,20 +346,26 @@ var Gloda = {</span>
<a href="#l41.4"></a><span id="l41.4">    * If the identities need to be created, they will also result in the</span>
<a href="#l41.5"></a><span id="l41.5">    *  creation of a gloda contact.  If a display name was provided with the</span>
<a href="#l41.6"></a><span id="l41.6">    *  e-mail address, it will become the name of the gloda contact.  If a</span>
<a href="#l41.7"></a><span id="l41.7">    *  display name was not provided, the e-mail address will also serve as the</span>
<a href="#l41.8"></a><span id="l41.8">    *  contact name.</span>
<a href="#l41.9"></a><span id="l41.9">    * This method uses the indexer's callback handle mechanism, and does not</span>
<a href="#l41.10"></a><span id="l41.10">    *  obey traditional return semantics.</span>
<a href="#l41.11"></a><span id="l41.11">    *</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineplus">+   * We normalize all e-mail addresses to be lowercase as a normative measure.</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+   *</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineplus">+   * @param aCallbackHandle The GlodaIndexer callback handle (or equivalent)</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineplus">+   *   that you are operating under.</span>
<a href="#l41.16"></a><span id="l41.16">    * @param ... One or more strings.  Each string can contain zero or more</span>
<a href="#l41.17"></a><span id="l41.17">    *   e-mail addresses with display name.  If more than one address is given,</span>
<a href="#l41.18"></a><span id="l41.18">    *   they should be comma-delimited.  For example</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineminus">-   *   '&quot;Bob Smith&quot; &lt;bob@smith.com&gt;' is an address with display name.</span>
<a href="#l41.20"></a><span id="l41.20" class="difflineplus">+   *   '&quot;Bob Smith&quot; &lt;bob@smith.com&gt;' is an address with display name.  Mime</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineplus">+   *   header decoding is performed, but is ignorant of any folder-level</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineplus">+   *   character set overrides.</span>
<a href="#l41.23"></a><span id="l41.23">    * @returns via the callback handle mechanism, a list containing one sub-list</span>
<a href="#l41.24"></a><span id="l41.24">    *   for each string argument passed.  Each sub-list containts zero or more</span>
<a href="#l41.25"></a><span id="l41.25">    *   GlodaIdentity instances corresponding to the addresses provided.</span>
<a href="#l41.26"></a><span id="l41.26">    */</span>
<a href="#l41.27"></a><span id="l41.27">   getOrCreateMailIdentities:</span>
<a href="#l41.28"></a><span id="l41.28">       function gloda_ns_getOrCreateMailIdentities(aCallbackHandle) {</span>
<a href="#l41.29"></a><span id="l41.29">     let addresses = {};</span>
<a href="#l41.30"></a><span id="l41.30">     let resultLists = [];</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineat">@@ -369,17 +375,17 @@ var Gloda = {</span>
<a href="#l41.32"></a><span id="l41.32">       let aMailAddresses = arguments[iArg];</span>
<a href="#l41.33"></a><span id="l41.33">       let parsed = GlodaUtils.parseMailAddresses(aMailAddresses);</span>
<a href="#l41.34"></a><span id="l41.34"> </span>
<a href="#l41.35"></a><span id="l41.35">       let resultList = [];</span>
<a href="#l41.36"></a><span id="l41.36">       resultLists.push(resultList);</span>
<a href="#l41.37"></a><span id="l41.37"> </span>
<a href="#l41.38"></a><span id="l41.38">       let identities = [];</span>
<a href="#l41.39"></a><span id="l41.39">       for (let iAddress = 0; iAddress &lt; parsed.count; iAddress++) {</span>
<a href="#l41.40"></a><span id="l41.40" class="difflineminus">-        let address = parsed.addresses[iAddress];</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineplus">+        let address = parsed.addresses[iAddress].toLowerCase();</span>
<a href="#l41.42"></a><span id="l41.42">         if (address in addresses)</span>
<a href="#l41.43"></a><span id="l41.43">           addresses[address].push(resultList);</span>
<a href="#l41.44"></a><span id="l41.44">         else</span>
<a href="#l41.45"></a><span id="l41.45">           addresses[address] = [parsed.names[iAddress], resultList];</span>
<a href="#l41.46"></a><span id="l41.46">       }</span>
<a href="#l41.47"></a><span id="l41.47">     }</span>
<a href="#l41.48"></a><span id="l41.48"> </span>
<a href="#l41.49"></a><span id="l41.49">     let addressList = [address for (address in addresses)];</span>
<a href="#l41.50"></a><span id="l41.50" class="difflineat">@@ -508,29 +514,29 @@ var Gloda = {</span>
<a href="#l41.51"></a><span id="l41.51">       if (!fallbackName)</span>
<a href="#l41.52"></a><span id="l41.52">         fallbackName = msgIdentity.email;</span>
<a href="#l41.53"></a><span id="l41.53"> </span>
<a href="#l41.54"></a><span id="l41.54">       let emailAddress = msgIdentity.email;</span>
<a href="#l41.55"></a><span id="l41.55">       let replyTo = msgIdentity.replyTo;</span>
<a href="#l41.56"></a><span id="l41.56"> </span>
<a href="#l41.57"></a><span id="l41.57">       // find the identities if they exist, flag to create them if they don't</span>
<a href="#l41.58"></a><span id="l41.58">       if (emailAddress) {</span>
<a href="#l41.59"></a><span id="l41.59" class="difflineminus">-        parsed = GlodaUtils.parseMailAddresses(emailAddress);</span>
<a href="#l41.60"></a><span id="l41.60" class="difflineplus">+        let parsed = GlodaUtils.parseMailAddresses(emailAddress);</span>
<a href="#l41.61"></a><span id="l41.61">         if (!(parsed.addresses[0] in myEmailAddresses)) {</span>
<a href="#l41.62"></a><span id="l41.62">           let identity = GlodaDatastore.getIdentity(&quot;email&quot;,</span>
<a href="#l41.63"></a><span id="l41.63">                                                     parsed.addresses[0]);</span>
<a href="#l41.64"></a><span id="l41.64">           if (identity)</span>
<a href="#l41.65"></a><span id="l41.65">             existingIdentities.push(identity);</span>
<a href="#l41.66"></a><span id="l41.66">           else</span>
<a href="#l41.67"></a><span id="l41.67">             identitiesToCreate.push(parsed.addresses[0]);</span>
<a href="#l41.68"></a><span id="l41.68">           myEmailAddresses[parsed.addresses[0]] = true;</span>
<a href="#l41.69"></a><span id="l41.69">         }</span>
<a href="#l41.70"></a><span id="l41.70">       }</span>
<a href="#l41.71"></a><span id="l41.71">       if (replyTo) {</span>
<a href="#l41.72"></a><span id="l41.72" class="difflineminus">-        parsed = GlodaUtils.parseMailAddresses(replyTo);</span>
<a href="#l41.73"></a><span id="l41.73" class="difflineplus">+        let parsed = GlodaUtils.parseMailAddresses(replyTo);</span>
<a href="#l41.74"></a><span id="l41.74">         if (!(parsed.addresses[0] in myEmailAddresses)) {</span>
<a href="#l41.75"></a><span id="l41.75">           let identity = GlodaDatastore.getIdentity(&quot;email&quot;,</span>
<a href="#l41.76"></a><span id="l41.76">                                                     parsed.addresses[0]);</span>
<a href="#l41.77"></a><span id="l41.77">           if (identity)</span>
<a href="#l41.78"></a><span id="l41.78">             existingIdentities.push(identity);</span>
<a href="#l41.79"></a><span id="l41.79">           else</span>
<a href="#l41.80"></a><span id="l41.80">             identitiesToCreate.push(parsed.addresses[0]);</span>
<a href="#l41.81"></a><span id="l41.81">           myEmailAddresses[parsed.addresses[0]] = true;</span>
<a href="#l41.82"></a><span id="l41.82" class="difflineat">@@ -775,50 +781,58 @@ var Gloda = {</span>
<a href="#l41.83"></a><span id="l41.83"> </span>
<a href="#l41.84"></a><span id="l41.84">   _managedToJSON: function gloda_ns_managedToJSON(aItem) {</span>
<a href="#l41.85"></a><span id="l41.85">     return aItem.id;</span>
<a href="#l41.86"></a><span id="l41.86">   },</span>
<a href="#l41.87"></a><span id="l41.87"> </span>
<a href="#l41.88"></a><span id="l41.88">   /**</span>
<a href="#l41.89"></a><span id="l41.89">    * Define a noun.  Takes a dictionary with the following keys/values:</span>
<a href="#l41.90"></a><span id="l41.90">    *</span>
<a href="#l41.91"></a><span id="l41.91" class="difflineminus">-   * @param name The name of the noun.  This is not a display name (anything</span>
<a href="#l41.92"></a><span id="l41.92" class="difflineminus">-   *     being displayed needs to be localized, after all), but simply the</span>
<a href="#l41.93"></a><span id="l41.93" class="difflineminus">-   *     canonical name for debugging purposes and for people to pass to</span>
<a href="#l41.94"></a><span id="l41.94" class="difflineplus">+   * @param aNounDef.name The name of the noun.  This is not a display name</span>
<a href="#l41.95"></a><span id="l41.95" class="difflineplus">+   *     (anything being displayed needs to be localized, after all), but simply</span>
<a href="#l41.96"></a><span id="l41.96" class="difflineplus">+   *     the canonical name for debugging purposes and for people to pass to</span>
<a href="#l41.97"></a><span id="l41.97">    *     lookupNoun.  The suggested convention is lower-case-dash-delimited,</span>
<a href="#l41.98"></a><span id="l41.98">    *     with names being singular (since it's a single noun we are referring</span>
<a href="#l41.99"></a><span id="l41.99">    *     to.)</span>
<a href="#l41.100"></a><span id="l41.100" class="difflineminus">-   * @param class The 'class' to which an instance of the noun will belong (aka</span>
<a href="#l41.101"></a><span id="l41.101" class="difflineminus">-   *     will pass an instanceof test).</span>
<a href="#l41.102"></a><span id="l41.102" class="difflineminus">-   * @param allowsArbitraryAttrs Is this a 'first class noun'/can it be a subject, AKA can</span>
<a href="#l41.103"></a><span id="l41.103" class="difflineminus">-   *     this noun have attributes stored on it that relate it to other things?</span>
<a href="#l41.104"></a><span id="l41.104" class="difflineminus">-   *     For example, a message is first-class; we store attributes of</span>
<a href="#l41.105"></a><span id="l41.105" class="difflineminus">-   *     messages.  A date is not first-class now, nor is it likely to be; we</span>
<a href="#l41.106"></a><span id="l41.106" class="difflineminus">-   *     will not store attributes about a date, although dates will be the</span>
<a href="#l41.107"></a><span id="l41.107" class="difflineminus">-   *     objects of other subjects.  (For example: we might associate a date</span>
<a href="#l41.108"></a><span id="l41.108" class="difflineminus">-   *     with a calendar event, but the date is an attribute of the calendar</span>
<a href="#l41.109"></a><span id="l41.109" class="difflineminus">-   *     event and not vice versa.)</span>
<a href="#l41.110"></a><span id="l41.110" class="difflineminus">-   * @param usesParameter A boolean indicating whether this noun requires use</span>
<a href="#l41.111"></a><span id="l41.111" class="difflineminus">-   *     of the 'parameter' BLOB storage field on the attribute bindings in the</span>
<a href="#l41.112"></a><span id="l41.112" class="difflineminus">-   *     database to persist itself.  Use of parameters should be limited</span>
<a href="#l41.113"></a><span id="l41.113" class="difflineminus">-   *     to a reasonable number of values (16-32 is okay, more than that is</span>
<a href="#l41.114"></a><span id="l41.114" class="difflineminus">-   *     pushing it and 256 should be considered an absolute upper bound)</span>
<a href="#l41.115"></a><span id="l41.115" class="difflineminus">-   *     because of the database organization.  When false, your toParamAndValue</span>
<a href="#l41.116"></a><span id="l41.116" class="difflineminus">-   *     function is expected to return null for the parameter and likewise your</span>
<a href="#l41.117"></a><span id="l41.117" class="difflineminus">-   *     fromParamAndValue should expect ignore and generally ignore the</span>
<a href="#l41.118"></a><span id="l41.118" class="difflineminus">-   *     argument.</span>
<a href="#l41.119"></a><span id="l41.119" class="difflineminus">-   * @param toParamAndValue A function that takes an instantiated noun</span>
<a href="#l41.120"></a><span id="l41.120" class="difflineplus">+   * @param aNounDef.class The 'class' to which an instance of the noun will</span>
<a href="#l41.121"></a><span id="l41.121" class="difflineplus">+   *     belong (aka will pass an instanceof test).  You may also provide this</span>
<a href="#l41.122"></a><span id="l41.122" class="difflineplus">+   *     as 'clazz' if the keyword makes your IDE angry.</span>
<a href="#l41.123"></a><span id="l41.123" class="difflineplus">+   * @param aNounDef.allowsArbitraryAttrs Is this a 'first class noun'/can it be</span>
<a href="#l41.124"></a><span id="l41.124" class="difflineplus">+   *     a subject, AKA can this noun have attributes stored on it that relate</span>
<a href="#l41.125"></a><span id="l41.125" class="difflineplus">+   *     it to other things?  For example, a message is first-class; we store</span>
<a href="#l41.126"></a><span id="l41.126" class="difflineplus">+   *     attributes of messages.  A date is not first-class now, nor is it</span>
<a href="#l41.127"></a><span id="l41.127" class="difflineplus">+   *     likely to be; we will not store attributes about a date, although dates</span>
<a href="#l41.128"></a><span id="l41.128" class="difflineplus">+   *     will be the objects of other subjects.  (For example: we might</span>
<a href="#l41.129"></a><span id="l41.129" class="difflineplus">+   *     associate a date with a calendar event, but the date is an attribute of</span>
<a href="#l41.130"></a><span id="l41.130" class="difflineplus">+   *     the calendar event and not vice versa.)</span>
<a href="#l41.131"></a><span id="l41.131" class="difflineplus">+   * @param aNounDef.usesParameter A boolean indicating whether this noun</span>
<a href="#l41.132"></a><span id="l41.132" class="difflineplus">+   *     requires use of the 'parameter' BLOB storage field on the attribute</span>
<a href="#l41.133"></a><span id="l41.133" class="difflineplus">+   *     bindings in the database to persist itself.  Use of parameters should</span>
<a href="#l41.134"></a><span id="l41.134" class="difflineplus">+   *     be limited to a reasonable number of values (16-32 is okay, more than</span>
<a href="#l41.135"></a><span id="l41.135" class="difflineplus">+   *     that is pushing it and 256 should be considered an absolute upper</span>
<a href="#l41.136"></a><span id="l41.136" class="difflineplus">+   *     bound) because of the database organization.  When false, your</span>
<a href="#l41.137"></a><span id="l41.137" class="difflineplus">+   *     toParamAndValue function is expected to return null for the parameter</span>
<a href="#l41.138"></a><span id="l41.138" class="difflineplus">+   *     and likewise your fromParamAndValue should expect ignore and generally</span>
<a href="#l41.139"></a><span id="l41.139" class="difflineplus">+   *     ignore the argument.</span>
<a href="#l41.140"></a><span id="l41.140" class="difflineplus">+   * @param aNounDef.toParamAndValue A function that takes an instantiated noun</span>
<a href="#l41.141"></a><span id="l41.141">    *     instance and returns a 2-element list of [parameter, value] where</span>
<a href="#l41.142"></a><span id="l41.142">    *     parameter may only be non-null if you passed a usesParameter of true.</span>
<a href="#l41.143"></a><span id="l41.143">    *     Parameter may be of any type (BLOB), and value must be numeric (pass</span>
<a href="#l41.144"></a><span id="l41.144">    *     0 if you don't need the value).</span>
<a href="#l41.145"></a><span id="l41.145">    *</span>
<a href="#l41.146"></a><span id="l41.146" class="difflineminus">-   * @param schema Unsupported mechanism by which you can define a table that</span>
<a href="#l41.147"></a><span id="l41.147" class="difflineminus">-   *     corresponds to this noun.  The table will be created if it does not</span>
<a href="#l41.148"></a><span id="l41.148" class="difflineminus">-   *     exist.</span>
<a href="#l41.149"></a><span id="l41.149" class="difflineplus">+   * @param aNounDef.isPrimitive True when the noun instance is a raw numeric</span>
<a href="#l41.150"></a><span id="l41.150" class="difflineplus">+   *     value/string/boolean.  False when the instance is an object.  When</span>
<a href="#l41.151"></a><span id="l41.151" class="difflineplus">+   *     false, it is assumed the attribute that serves as a unique identifier</span>
<a href="#l41.152"></a><span id="l41.152" class="difflineplus">+   *     for the value is &quot;id&quot; unless 'idAttr' is provided.</span>
<a href="#l41.153"></a><span id="l41.153" class="difflineplus">+   * @param [aNounDef.idAttr=&quot;id&quot;] For non-primitive nouns, this is the</span>
<a href="#l41.154"></a><span id="l41.154" class="difflineplus">+   *     attribute on the object that uniquely identifies it.</span>
<a href="#l41.155"></a><span id="l41.155" class="difflineplus">+   *</span>
<a href="#l41.156"></a><span id="l41.156" class="difflineplus">+   * @param aNounDef.schema Unsupported mechanism by which you can define a</span>
<a href="#l41.157"></a><span id="l41.157" class="difflineplus">+   *     table that corresponds to this noun.  The table will be created if it</span>
<a href="#l41.158"></a><span id="l41.158" class="difflineplus">+   *     does not exist.</span>
<a href="#l41.159"></a><span id="l41.159">    *     - name The table name; don't conflict with other things!</span>
<a href="#l41.160"></a><span id="l41.160">    *     - columns A list of [column name, sqlite type] tuples.  You should</span>
<a href="#l41.161"></a><span id="l41.161">    *       always include a definition like [&quot;id&quot;, &quot;INTEGER PRIMARY KEY&quot;] for</span>
<a href="#l41.162"></a><span id="l41.162">    *       now (and it should be the first column name too.)  If you care about</span>
<a href="#l41.163"></a><span id="l41.163">    *       how the attributes are poked into your object (for example, you want</span>
<a href="#l41.164"></a><span id="l41.164">    *       underscores used for some of them because the attributes should be</span>
<a href="#l41.165"></a><span id="l41.165">    *       immutable), then you can include a third string that is the name of</span>
<a href="#l41.166"></a><span id="l41.166">    *       the attribute to use.</span>
<a href="#l41.167"></a><span id="l41.167" class="difflineat">@@ -832,16 +846,25 @@ var Gloda = {</span>
<a href="#l41.168"></a><span id="l41.168">       aNounID = this._nextNounID++;</span>
<a href="#l41.169"></a><span id="l41.169">     aNounDef.id = aNounID;</span>
<a href="#l41.170"></a><span id="l41.170"> </span>
<a href="#l41.171"></a><span id="l41.171">     // Let people whose editors get angry about illegal attribute names use</span>
<a href="#l41.172"></a><span id="l41.172">     //  clazz instead of class.</span>
<a href="#l41.173"></a><span id="l41.173">     if (aNounDef.clazz)</span>
<a href="#l41.174"></a><span id="l41.174">       aNounDef.class = aNounDef.clazz;</span>
<a href="#l41.175"></a><span id="l41.175"> </span>
<a href="#l41.176"></a><span id="l41.176" class="difflineplus">+    if (!(&quot;idAttr&quot; in aNounDef))</span>
<a href="#l41.177"></a><span id="l41.177" class="difflineplus">+      aNounDef.idAttr = &quot;id&quot;;</span>
<a href="#l41.178"></a><span id="l41.178" class="difflineplus">+    if (!(&quot;comparator&quot; in aNounDef)) {</span>
<a href="#l41.179"></a><span id="l41.179" class="difflineplus">+      aNounDef.comparator = function() {</span>
<a href="#l41.180"></a><span id="l41.180" class="difflineplus">+        throw new Error(&quot;Noun type '&quot; + aNounDef.name +</span>
<a href="#l41.181"></a><span id="l41.181" class="difflineplus">+                        &quot;' lacks a real comparator.&quot;);</span>
<a href="#l41.182"></a><span id="l41.182" class="difflineplus">+      };</span>
<a href="#l41.183"></a><span id="l41.183" class="difflineplus">+    }</span>
<a href="#l41.184"></a><span id="l41.184" class="difflineplus">+</span>
<a href="#l41.185"></a><span id="l41.185">     // We allow nouns to have data tables associated with them where we do all</span>
<a href="#l41.186"></a><span id="l41.186">     //  the legwork.  The schema attribute is the gateway to this magical world</span>
<a href="#l41.187"></a><span id="l41.187">     //  of functionality.  Said door is officially unsupported.</span>
<a href="#l41.188"></a><span id="l41.188">     if (aNounDef.schema) {</span>
<a href="#l41.189"></a><span id="l41.189">       if (aNounDef.schema.name)</span>
<a href="#l41.190"></a><span id="l41.190">         aNounDef.tableName = &quot;ext_&quot; + aNounDef.schema.name;</span>
<a href="#l41.191"></a><span id="l41.191">       else</span>
<a href="#l41.192"></a><span id="l41.192">         aNounDef.tableName = &quot;ext_&quot; + aNounDef.name;</span>
<a href="#l41.193"></a><span id="l41.193" class="difflineat">@@ -1002,75 +1025,159 @@ var Gloda = {</span>
<a href="#l41.194"></a><span id="l41.194">    *  own noun_*.js files.  There are some trade-offs to be made, and I think</span>
<a href="#l41.195"></a><span id="l41.195">    *  we can deal with those once we start to integrate lightning/calendar and</span>
<a href="#l41.196"></a><span id="l41.196">    *  our noun space gets large and more heterogeneous.</span>
<a href="#l41.197"></a><span id="l41.197">    */</span>
<a href="#l41.198"></a><span id="l41.198">   _initAttributes: function gloda_ns_initAttributes() {</span>
<a href="#l41.199"></a><span id="l41.199">     this.defineNoun({</span>
<a href="#l41.200"></a><span id="l41.200">       name: &quot;bool&quot;,</span>
<a href="#l41.201"></a><span id="l41.201">       clazz: Boolean, allowsArbitraryAttrs: false,</span>
<a href="#l41.202"></a><span id="l41.202" class="difflineplus">+      isPrimitive: true,</span>
<a href="#l41.203"></a><span id="l41.203" class="difflineplus">+      // favor true before false</span>
<a href="#l41.204"></a><span id="l41.204" class="difflineplus">+      comparator: function gloda_bool_comparator(a, b) {</span>
<a href="#l41.205"></a><span id="l41.205" class="difflineplus">+        if (a == null) {</span>
<a href="#l41.206"></a><span id="l41.206" class="difflineplus">+          if (b == null)</span>
<a href="#l41.207"></a><span id="l41.207" class="difflineplus">+            return 0;</span>
<a href="#l41.208"></a><span id="l41.208" class="difflineplus">+          else</span>
<a href="#l41.209"></a><span id="l41.209" class="difflineplus">+            return 1;</span>
<a href="#l41.210"></a><span id="l41.210" class="difflineplus">+        }</span>
<a href="#l41.211"></a><span id="l41.211" class="difflineplus">+        else if (b == null) {</span>
<a href="#l41.212"></a><span id="l41.212" class="difflineplus">+          return -1;</span>
<a href="#l41.213"></a><span id="l41.213" class="difflineplus">+        }</span>
<a href="#l41.214"></a><span id="l41.214" class="difflineplus">+        return b - a;</span>
<a href="#l41.215"></a><span id="l41.215" class="difflineplus">+      },</span>
<a href="#l41.216"></a><span id="l41.216">       toParamAndValue: function(aBool) {</span>
<a href="#l41.217"></a><span id="l41.217">         return [null, aBool ? 1 : 0];</span>
<a href="#l41.218"></a><span id="l41.218">       }}, this.NOUN_BOOLEAN);</span>
<a href="#l41.219"></a><span id="l41.219">     this.defineNoun({</span>
<a href="#l41.220"></a><span id="l41.220">       name: &quot;number&quot;,</span>
<a href="#l41.221"></a><span id="l41.221">       clazz: Number, allowsArbitraryAttrs: false, continuous: true,</span>
<a href="#l41.222"></a><span id="l41.222" class="difflineplus">+      isPrimitive: true,</span>
<a href="#l41.223"></a><span id="l41.223" class="difflineplus">+      comparator: function gloda_number_comparator(a, b) {</span>
<a href="#l41.224"></a><span id="l41.224" class="difflineplus">+        if (a == null) {</span>
<a href="#l41.225"></a><span id="l41.225" class="difflineplus">+          if (b == null)</span>
<a href="#l41.226"></a><span id="l41.226" class="difflineplus">+            return 0;</span>
<a href="#l41.227"></a><span id="l41.227" class="difflineplus">+          else</span>
<a href="#l41.228"></a><span id="l41.228" class="difflineplus">+            return 1;</span>
<a href="#l41.229"></a><span id="l41.229" class="difflineplus">+        }</span>
<a href="#l41.230"></a><span id="l41.230" class="difflineplus">+        else if (b == null) {</span>
<a href="#l41.231"></a><span id="l41.231" class="difflineplus">+          return -1;</span>
<a href="#l41.232"></a><span id="l41.232" class="difflineplus">+        }</span>
<a href="#l41.233"></a><span id="l41.233" class="difflineplus">+        return a - b;</span>
<a href="#l41.234"></a><span id="l41.234" class="difflineplus">+      },</span>
<a href="#l41.235"></a><span id="l41.235">       toParamAndValue: function(aNum) {</span>
<a href="#l41.236"></a><span id="l41.236">         return [null, aNum];</span>
<a href="#l41.237"></a><span id="l41.237">       }}, this.NOUN_NUMBER);</span>
<a href="#l41.238"></a><span id="l41.238">     this.defineNoun({</span>
<a href="#l41.239"></a><span id="l41.239">       name: &quot;string&quot;,</span>
<a href="#l41.240"></a><span id="l41.240">       clazz: String, allowsArbitraryAttrs: false,</span>
<a href="#l41.241"></a><span id="l41.241" class="difflineplus">+      isPrimitive: true,</span>
<a href="#l41.242"></a><span id="l41.242" class="difflineplus">+      comparator: function gloda_string_comparator(a, b) {</span>
<a href="#l41.243"></a><span id="l41.243" class="difflineplus">+        if (a == null) {</span>
<a href="#l41.244"></a><span id="l41.244" class="difflineplus">+          if (b == null)</span>
<a href="#l41.245"></a><span id="l41.245" class="difflineplus">+            return 0;</span>
<a href="#l41.246"></a><span id="l41.246" class="difflineplus">+          else</span>
<a href="#l41.247"></a><span id="l41.247" class="difflineplus">+            return 1;</span>
<a href="#l41.248"></a><span id="l41.248" class="difflineplus">+        }</span>
<a href="#l41.249"></a><span id="l41.249" class="difflineplus">+        else if (b == null) {</span>
<a href="#l41.250"></a><span id="l41.250" class="difflineplus">+          return -1;</span>
<a href="#l41.251"></a><span id="l41.251" class="difflineplus">+        }</span>
<a href="#l41.252"></a><span id="l41.252" class="difflineplus">+        return a.localeCompare(b);</span>
<a href="#l41.253"></a><span id="l41.253" class="difflineplus">+      },</span>
<a href="#l41.254"></a><span id="l41.254">       toParamAndValue: function(aString) {</span>
<a href="#l41.255"></a><span id="l41.255">         return [null, aString];</span>
<a href="#l41.256"></a><span id="l41.256">       }}, this.NOUN_STRING);</span>
<a href="#l41.257"></a><span id="l41.257">     this.defineNoun({</span>
<a href="#l41.258"></a><span id="l41.258">       name: &quot;date&quot;,</span>
<a href="#l41.259"></a><span id="l41.259">       clazz: Date, allowsArbitraryAttrs: false, continuous: true,</span>
<a href="#l41.260"></a><span id="l41.260" class="difflineplus">+      isPrimitive: true,</span>
<a href="#l41.261"></a><span id="l41.261" class="difflineplus">+      comparator: function gloda_data_comparator(a, b) {</span>
<a href="#l41.262"></a><span id="l41.262" class="difflineplus">+        if (a == null) {</span>
<a href="#l41.263"></a><span id="l41.263" class="difflineplus">+          if (b == null)</span>
<a href="#l41.264"></a><span id="l41.264" class="difflineplus">+            return 0;</span>
<a href="#l41.265"></a><span id="l41.265" class="difflineplus">+          else</span>
<a href="#l41.266"></a><span id="l41.266" class="difflineplus">+            return 1;</span>
<a href="#l41.267"></a><span id="l41.267" class="difflineplus">+        }</span>
<a href="#l41.268"></a><span id="l41.268" class="difflineplus">+        else if (b == null) {</span>
<a href="#l41.269"></a><span id="l41.269" class="difflineplus">+          return -1;</span>
<a href="#l41.270"></a><span id="l41.270" class="difflineplus">+        }</span>
<a href="#l41.271"></a><span id="l41.271" class="difflineplus">+        return a - b;</span>
<a href="#l41.272"></a><span id="l41.272" class="difflineplus">+      },</span>
<a href="#l41.273"></a><span id="l41.273">       toParamAndValue: function(aDate) {</span>
<a href="#l41.274"></a><span id="l41.274">         return [null, aDate.valueOf() * 1000];</span>
<a href="#l41.275"></a><span id="l41.275">       }}, this.NOUN_DATE);</span>
<a href="#l41.276"></a><span id="l41.276">     this.defineNoun({</span>
<a href="#l41.277"></a><span id="l41.277">       name: &quot;fulltext&quot;,</span>
<a href="#l41.278"></a><span id="l41.278">       clazz: String, allowsArbitraryAttrs: false, continuous: false,</span>
<a href="#l41.279"></a><span id="l41.279" class="difflineplus">+      isPrimitive: true,</span>
<a href="#l41.280"></a><span id="l41.280" class="difflineplus">+      comparator: function gloda_fulltext_comparator(a, b) {</span>
<a href="#l41.281"></a><span id="l41.281" class="difflineplus">+        throw new Error(&quot;Fulltext nouns are not comparable!&quot;);</span>
<a href="#l41.282"></a><span id="l41.282" class="difflineplus">+      },</span>
<a href="#l41.283"></a><span id="l41.283">       // as noted on NOUN_FULLTEXT, we just pass the string around.  it never</span>
<a href="#l41.284"></a><span id="l41.284">       //  hits the database, so it's okay.</span>
<a href="#l41.285"></a><span id="l41.285">       toParamAndValue: function(aString) {</span>
<a href="#l41.286"></a><span id="l41.286">         return [null, aString];</span>
<a href="#l41.287"></a><span id="l41.287">       }}, this.NOUN_FULLTEXT);</span>
<a href="#l41.288"></a><span id="l41.288"> </span>
<a href="#l41.289"></a><span id="l41.289">     this.defineNoun({</span>
<a href="#l41.290"></a><span id="l41.290">       name: &quot;folder&quot;,</span>
<a href="#l41.291"></a><span id="l41.291">       clazz: GlodaFolder,</span>
<a href="#l41.292"></a><span id="l41.292">       allowsArbitraryAttrs: false,</span>
<a href="#l41.293"></a><span id="l41.293" class="difflineplus">+      isPrimitive: false,</span>
<a href="#l41.294"></a><span id="l41.294" class="difflineplus">+      comparator: function gloda_folder_comparator(a, b) {</span>
<a href="#l41.295"></a><span id="l41.295" class="difflineplus">+        if (a == null) {</span>
<a href="#l41.296"></a><span id="l41.296" class="difflineplus">+          if (b == null)</span>
<a href="#l41.297"></a><span id="l41.297" class="difflineplus">+            return 0;</span>
<a href="#l41.298"></a><span id="l41.298" class="difflineplus">+          else</span>
<a href="#l41.299"></a><span id="l41.299" class="difflineplus">+            return 1;</span>
<a href="#l41.300"></a><span id="l41.300" class="difflineplus">+        }</span>
<a href="#l41.301"></a><span id="l41.301" class="difflineplus">+        else if (b == null) {</span>
<a href="#l41.302"></a><span id="l41.302" class="difflineplus">+          return -1;</span>
<a href="#l41.303"></a><span id="l41.303" class="difflineplus">+        }</span>
<a href="#l41.304"></a><span id="l41.304" class="difflineplus">+        return a.name.localeCompare(b.name);</span>
<a href="#l41.305"></a><span id="l41.305" class="difflineplus">+      },</span>
<a href="#l41.306"></a><span id="l41.306">       toParamAndValue: function(aFolderOrGlodaFolder) {</span>
<a href="#l41.307"></a><span id="l41.307">         if (aFolderOrGlodaFolder instanceof GlodaFolder)</span>
<a href="#l41.308"></a><span id="l41.308">           return [null, aFolderOrGlodaFolder.id];</span>
<a href="#l41.309"></a><span id="l41.309">         else</span>
<a href="#l41.310"></a><span id="l41.310">           return [null, GlodaDatastore._mapFolder(aFolderOrGlodaFolder).id];</span>
<a href="#l41.311"></a><span id="l41.311">       }}, this.NOUN_FOLDER);</span>
<a href="#l41.312"></a><span id="l41.312">     this.defineNoun({</span>
<a href="#l41.313"></a><span id="l41.313">       name: &quot;conversation&quot;,</span>
<a href="#l41.314"></a><span id="l41.314">       clazz: GlodaConversation,</span>
<a href="#l41.315"></a><span id="l41.315">       allowsArbitraryAttrs: false,</span>
<a href="#l41.316"></a><span id="l41.316" class="difflineplus">+      isPrimitive: false,</span>
<a href="#l41.317"></a><span id="l41.317">       cache: true, cacheCost: 512,</span>
<a href="#l41.318"></a><span id="l41.318">       tableName: &quot;conversations&quot;,</span>
<a href="#l41.319"></a><span id="l41.319">       attrTableName: &quot;messageAttributes&quot;, attrIDColumnName: &quot;conversationID&quot;,</span>
<a href="#l41.320"></a><span id="l41.320">       datastore: GlodaDatastore,</span>
<a href="#l41.321"></a><span id="l41.321">       objFromRow: GlodaDatastore._conversationFromRow,</span>
<a href="#l41.322"></a><span id="l41.322" class="difflineplus">+      comparator: function gloda_conversation_comparator(a, b) {</span>
<a href="#l41.323"></a><span id="l41.323" class="difflineplus">+        if (a == null) {</span>
<a href="#l41.324"></a><span id="l41.324" class="difflineplus">+          if (b == null)</span>
<a href="#l41.325"></a><span id="l41.325" class="difflineplus">+            return 0;</span>
<a href="#l41.326"></a><span id="l41.326" class="difflineplus">+          else</span>
<a href="#l41.327"></a><span id="l41.327" class="difflineplus">+            return 1;</span>
<a href="#l41.328"></a><span id="l41.328" class="difflineplus">+        }</span>
<a href="#l41.329"></a><span id="l41.329" class="difflineplus">+        else if (b == null) {</span>
<a href="#l41.330"></a><span id="l41.330" class="difflineplus">+          return -1;</span>
<a href="#l41.331"></a><span id="l41.331" class="difflineplus">+        }</span>
<a href="#l41.332"></a><span id="l41.332" class="difflineplus">+        return a.subject.localeCompare(b.subject);</span>
<a href="#l41.333"></a><span id="l41.333" class="difflineplus">+      },</span>
<a href="#l41.334"></a><span id="l41.334">       toParamAndValue: function(aConversation) {</span>
<a href="#l41.335"></a><span id="l41.335">         if (aConversation instanceof GlodaConversation)</span>
<a href="#l41.336"></a><span id="l41.336">           return [null, aConversation.id];</span>
<a href="#l41.337"></a><span id="l41.337">         else // assume they're just passing the id directly</span>
<a href="#l41.338"></a><span id="l41.338">           return [null, aConversation];</span>
<a href="#l41.339"></a><span id="l41.339">       }}, this.NOUN_CONVERSATION);</span>
<a href="#l41.340"></a><span id="l41.340">     this.defineNoun({</span>
<a href="#l41.341"></a><span id="l41.341">       name: &quot;message&quot;,</span>
<a href="#l41.342"></a><span id="l41.342">       clazz: GlodaMessage,</span>
<a href="#l41.343"></a><span id="l41.343">       allowsArbitraryAttrs: true,</span>
<a href="#l41.344"></a><span id="l41.344" class="difflineplus">+      isPrimitive: false,</span>
<a href="#l41.345"></a><span id="l41.345">       cache: true, cacheCost: 2048,</span>
<a href="#l41.346"></a><span id="l41.346">       tableName: &quot;messages&quot;,</span>
<a href="#l41.347"></a><span id="l41.347">       // we will always have a fulltext row, even for messages where we don't</span>
<a href="#l41.348"></a><span id="l41.348">       //  have the body available.  this is because we want the subject indexed.</span>
<a href="#l41.349"></a><span id="l41.349">       dbQueryJoinMagic:</span>
<a href="#l41.350"></a><span id="l41.350">         &quot; INNER JOIN messagesText ON messages.id = messagesText.rowid&quot;,</span>
<a href="#l41.351"></a><span id="l41.351">       attrTableName: &quot;messageAttributes&quot;, attrIDColumnName: &quot;messageID&quot;,</span>
<a href="#l41.352"></a><span id="l41.352">       datastore: GlodaDatastore, objFromRow: GlodaDatastore._messageFromRow,</span>
<a href="#l41.353"></a><span id="l41.353" class="difflineat">@@ -1084,52 +1191,98 @@ var Gloda = {</span>
<a href="#l41.354"></a><span id="l41.354">           return [null, aMessage.id];</span>
<a href="#l41.355"></a><span id="l41.355">         else // assume they're just passing the id directly</span>
<a href="#l41.356"></a><span id="l41.356">           return [null, aMessage];</span>
<a href="#l41.357"></a><span id="l41.357">       }}, this.NOUN_MESSAGE);</span>
<a href="#l41.358"></a><span id="l41.358">     this.defineNoun({</span>
<a href="#l41.359"></a><span id="l41.359">       name: &quot;contact&quot;,</span>
<a href="#l41.360"></a><span id="l41.360">       clazz: GlodaContact,</span>
<a href="#l41.361"></a><span id="l41.361">       allowsArbitraryAttrs: true,</span>
<a href="#l41.362"></a><span id="l41.362" class="difflineplus">+      isPrimitive: false,</span>
<a href="#l41.363"></a><span id="l41.363">       cache: true, cacheCost: 128,</span>
<a href="#l41.364"></a><span id="l41.364">       tableName: &quot;contacts&quot;,</span>
<a href="#l41.365"></a><span id="l41.365">       attrTableName: &quot;contactAttributes&quot;, attrIDColumnName: &quot;contactID&quot;,</span>
<a href="#l41.366"></a><span id="l41.366">       datastore: GlodaDatastore, objFromRow: GlodaDatastore._contactFromRow,</span>
<a href="#l41.367"></a><span id="l41.367">       dbAttribAdjuster: GlodaDatastore.adjustAttributes,</span>
<a href="#l41.368"></a><span id="l41.368">       objInsert: GlodaDatastore.insertContact,</span>
<a href="#l41.369"></a><span id="l41.369">       objUpdate: GlodaDatastore.updateContact,</span>
<a href="#l41.370"></a><span id="l41.370" class="difflineplus">+      comparator: function gloda_contact_comparator(a, b) {</span>
<a href="#l41.371"></a><span id="l41.371" class="difflineplus">+        if (a == null) {</span>
<a href="#l41.372"></a><span id="l41.372" class="difflineplus">+          if (b == null)</span>
<a href="#l41.373"></a><span id="l41.373" class="difflineplus">+            return 0;</span>
<a href="#l41.374"></a><span id="l41.374" class="difflineplus">+          else</span>
<a href="#l41.375"></a><span id="l41.375" class="difflineplus">+            return 1;</span>
<a href="#l41.376"></a><span id="l41.376" class="difflineplus">+        }</span>
<a href="#l41.377"></a><span id="l41.377" class="difflineplus">+        else if (b == null) {</span>
<a href="#l41.378"></a><span id="l41.378" class="difflineplus">+          return -1;</span>
<a href="#l41.379"></a><span id="l41.379" class="difflineplus">+        }</span>
<a href="#l41.380"></a><span id="l41.380" class="difflineplus">+        return a.name.localeCompare(b.name);</span>
<a href="#l41.381"></a><span id="l41.381" class="difflineplus">+      },</span>
<a href="#l41.382"></a><span id="l41.382">       toParamAndValue: function(aContact) {</span>
<a href="#l41.383"></a><span id="l41.383">         if (aContact instanceof GlodaContact)</span>
<a href="#l41.384"></a><span id="l41.384">           return [null, aContact.id];</span>
<a href="#l41.385"></a><span id="l41.385">         else // assume they're just passing the id directly</span>
<a href="#l41.386"></a><span id="l41.386">           return [null, aContact];</span>
<a href="#l41.387"></a><span id="l41.387">       }}, this.NOUN_CONTACT);</span>
<a href="#l41.388"></a><span id="l41.388">     this.defineNoun({</span>
<a href="#l41.389"></a><span id="l41.389">       name: &quot;identity&quot;,</span>
<a href="#l41.390"></a><span id="l41.390">       clazz: GlodaIdentity,</span>
<a href="#l41.391"></a><span id="l41.391">       allowsArbitraryAttrs: false,</span>
<a href="#l41.392"></a><span id="l41.392" class="difflineplus">+      isPrimitive: false,</span>
<a href="#l41.393"></a><span id="l41.393">       cache: true, cacheCost: 128,</span>
<a href="#l41.394"></a><span id="l41.394">       usesUniqueValue: true,</span>
<a href="#l41.395"></a><span id="l41.395">       tableName: &quot;identities&quot;,</span>
<a href="#l41.396"></a><span id="l41.396">       datastore: GlodaDatastore, objFromRow: GlodaDatastore._identityFromRow,</span>
<a href="#l41.397"></a><span id="l41.397" class="difflineplus">+      comparator: function gloda_identity_comparator(a, b) {</span>
<a href="#l41.398"></a><span id="l41.398" class="difflineplus">+        if (a == null) {</span>
<a href="#l41.399"></a><span id="l41.399" class="difflineplus">+          if (b == null)</span>
<a href="#l41.400"></a><span id="l41.400" class="difflineplus">+            return 0;</span>
<a href="#l41.401"></a><span id="l41.401" class="difflineplus">+          else</span>
<a href="#l41.402"></a><span id="l41.402" class="difflineplus">+            return 1;</span>
<a href="#l41.403"></a><span id="l41.403" class="difflineplus">+        }</span>
<a href="#l41.404"></a><span id="l41.404" class="difflineplus">+        else if (b == null) {</span>
<a href="#l41.405"></a><span id="l41.405" class="difflineplus">+          return -1;</span>
<a href="#l41.406"></a><span id="l41.406" class="difflineplus">+        }</span>
<a href="#l41.407"></a><span id="l41.407" class="difflineplus">+        return a.contact.name.localeCompare(b.contact.name);</span>
<a href="#l41.408"></a><span id="l41.408" class="difflineplus">+      },</span>
<a href="#l41.409"></a><span id="l41.409">       toParamAndValue: function(aIdentity) {</span>
<a href="#l41.410"></a><span id="l41.410">         if (aIdentity instanceof GlodaIdentity)</span>
<a href="#l41.411"></a><span id="l41.411">           return [null, aIdentity.id];</span>
<a href="#l41.412"></a><span id="l41.412">         else // assume they're just passing the id directly</span>
<a href="#l41.413"></a><span id="l41.413">           return [null, aIdentity];</span>
<a href="#l41.414"></a><span id="l41.414">       }}, this.NOUN_IDENTITY);</span>
<a href="#l41.415"></a><span id="l41.415"> </span>
<a href="#l41.416"></a><span id="l41.416">     // parameterized identity is just two identities; we store the first one</span>
<a href="#l41.417"></a><span id="l41.417">     //  (whose value set must be very constrainted, like the 'me' identities)</span>
<a href="#l41.418"></a><span id="l41.418">     //  as the parameter, the second (which does not need to be constrained)</span>
<a href="#l41.419"></a><span id="l41.419">     //  as the value.</span>
<a href="#l41.420"></a><span id="l41.420">     this.defineNoun({</span>
<a href="#l41.421"></a><span id="l41.421">       name: &quot;parameterized-identity&quot;,</span>
<a href="#l41.422"></a><span id="l41.422">       clazz: null,</span>
<a href="#l41.423"></a><span id="l41.423">       allowsArbitraryAttrs: false,</span>
<a href="#l41.424"></a><span id="l41.424" class="difflineplus">+      comparator: function gloda_fulltext_comparator(a, b) {</span>
<a href="#l41.425"></a><span id="l41.425" class="difflineplus">+        if (a == null) {</span>
<a href="#l41.426"></a><span id="l41.426" class="difflineplus">+          if (b == null)</span>
<a href="#l41.427"></a><span id="l41.427" class="difflineplus">+            return 0;</span>
<a href="#l41.428"></a><span id="l41.428" class="difflineplus">+          else</span>
<a href="#l41.429"></a><span id="l41.429" class="difflineplus">+            return 1;</span>
<a href="#l41.430"></a><span id="l41.430" class="difflineplus">+        }</span>
<a href="#l41.431"></a><span id="l41.431" class="difflineplus">+        else if (b == null) {</span>
<a href="#l41.432"></a><span id="l41.432" class="difflineplus">+          return -1;</span>
<a href="#l41.433"></a><span id="l41.433" class="difflineplus">+        }</span>
<a href="#l41.434"></a><span id="l41.434" class="difflineplus">+        // First sort by the first identity in the tuple</span>
<a href="#l41.435"></a><span id="l41.435" class="difflineplus">+        // Since our general use-case is for the first guy to be &quot;me&quot;, we only</span>
<a href="#l41.436"></a><span id="l41.436" class="difflineplus">+        //  compare the identity value, not the name.</span>
<a href="#l41.437"></a><span id="l41.437" class="difflineplus">+        let fic = a[0].value.localeCompare(b[0].value);</span>
<a href="#l41.438"></a><span id="l41.438" class="difflineplus">+        if (fic)</span>
<a href="#l41.439"></a><span id="l41.439" class="difflineplus">+          return fic;</span>
<a href="#l41.440"></a><span id="l41.440" class="difflineplus">+        // Next compare the second identity in the tuple, but use the contact</span>
<a href="#l41.441"></a><span id="l41.441" class="difflineplus">+        //  this time to be consistent with our identity comparator.</span>
<a href="#l41.442"></a><span id="l41.442" class="difflineplus">+        return a[1].contact.name.localeCompare(b[1].contact.name);</span>
<a href="#l41.443"></a><span id="l41.443" class="difflineplus">+      },</span>
<a href="#l41.444"></a><span id="l41.444">       computeDelta: function(aCurValues, aOldValues) {</span>
<a href="#l41.445"></a><span id="l41.445">         let oldMap = {};</span>
<a href="#l41.446"></a><span id="l41.446">         for each (let [, tupe] in Iterator(aOldValues)) {</span>
<a href="#l41.447"></a><span id="l41.447">           let [originIdentity, targetIdentity] = tupe;</span>
<a href="#l41.448"></a><span id="l41.448">           let targets = oldMap[originIdentity];</span>
<a href="#l41.449"></a><span id="l41.449">           if (targets === undefined)</span>
<a href="#l41.450"></a><span id="l41.450">             targets = oldMap[originIdentity] = {};</span>
<a href="#l41.451"></a><span id="l41.451">           targets[targetIdentity] = true;</span>
<a href="#l41.452"></a><span id="l41.452" class="difflineat">@@ -1264,53 +1417,76 @@ var Gloda = {</span>
<a href="#l41.453"></a><span id="l41.453">           }</span>
<a href="#l41.454"></a><span id="l41.454">           this._constraints.push(constraint);</span>
<a href="#l41.455"></a><span id="l41.455">           return this;</span>
<a href="#l41.456"></a><span id="l41.456">         };</span>
<a href="#l41.457"></a><span id="l41.457"> </span>
<a href="#l41.458"></a><span id="l41.458">         aSubjectNounDef.queryClass.prototype[aAttrDef.boundName + &quot;Like&quot;] =</span>
<a href="#l41.459"></a><span id="l41.459">           likeConstrainer;</span>
<a href="#l41.460"></a><span id="l41.460">       }</span>
<a href="#l41.461"></a><span id="l41.461" class="difflineplus">+</span>
<a href="#l41.462"></a><span id="l41.462" class="difflineplus">+      // - Custom helpers provided by the noun type...</span>
<a href="#l41.463"></a><span id="l41.463" class="difflineplus">+      if (&quot;queryHelpers&quot; in objectNounDef) {</span>
<a href="#l41.464"></a><span id="l41.464" class="difflineplus">+        for each (let [name, helper] in Iterator(objectNounDef.queryHelpers)) {</span>
<a href="#l41.465"></a><span id="l41.465" class="difflineplus">+          // we need a new closure...</span>
<a href="#l41.466"></a><span id="l41.466" class="difflineplus">+          let helperFunc = helper;</span>
<a href="#l41.467"></a><span id="l41.467" class="difflineplus">+          aSubjectNounDef.queryClass.prototype[aAttrDef.boundName + name] =</span>
<a href="#l41.468"></a><span id="l41.468" class="difflineplus">+            function() {</span>
<a href="#l41.469"></a><span id="l41.469" class="difflineplus">+              return helperFunc.call(this, aAttrDef, arguments);</span>
<a href="#l41.470"></a><span id="l41.470" class="difflineplus">+            };</span>
<a href="#l41.471"></a><span id="l41.471" class="difflineplus">+        }</span>
<a href="#l41.472"></a><span id="l41.472" class="difflineplus">+      }</span>
<a href="#l41.473"></a><span id="l41.473">     }</span>
<a href="#l41.474"></a><span id="l41.474">   },</span>
<a href="#l41.475"></a><span id="l41.475"> </span>
<a href="#l41.476"></a><span id="l41.476">   /**</span>
<a href="#l41.477"></a><span id="l41.477" class="difflineplus">+   * Names of attribute-specific localized strings and the JS attribute they are</span>
<a href="#l41.478"></a><span id="l41.478" class="difflineplus">+   *  exposed as in the attribute's &quot;strings&quot; attribute (if the provider has a</span>
<a href="#l41.479"></a><span id="l41.479" class="difflineplus">+   *  string bundle exposed on its &quot;strings&quot; attribute).  They are rooted at</span>
<a href="#l41.480"></a><span id="l41.480" class="difflineplus">+   *  &quot;gloda.SUBJECT-NOUN-NAME.attr.ATTR-NAME.*&quot;.</span>
<a href="#l41.481"></a><span id="l41.481" class="difflineplus">+   */</span>
<a href="#l41.482"></a><span id="l41.482" class="difflineplus">+  _ATTR_LOCALIZED_STRINGS: {</span>
<a href="#l41.483"></a><span id="l41.483" class="difflineplus">+    facetLabel: &quot;facetLabel&quot;,</span>
<a href="#l41.484"></a><span id="l41.484" class="difflineplus">+    facetTooltip: &quot;facetTooltip&quot;,</span>
<a href="#l41.485"></a><span id="l41.485" class="difflineplus">+  },</span>
<a href="#l41.486"></a><span id="l41.486" class="difflineplus">+  /**</span>
<a href="#l41.487"></a><span id="l41.487">    * Define an attribute and all its meta-data.  Takes a single dictionary as</span>
<a href="#l41.488"></a><span id="l41.488">    *  its argument, with the following required properties:</span>
<a href="#l41.489"></a><span id="l41.489">    *</span>
<a href="#l41.490"></a><span id="l41.490" class="difflineminus">-   * @param provider The object instance providing a 'process' method.</span>
<a href="#l41.491"></a><span id="l41.491" class="difflineminus">-   * @param extensionName The name of the extension providing these attributes.</span>
<a href="#l41.492"></a><span id="l41.492" class="difflineminus">-   * @param attributeType The type of attribute, one of the values from the</span>
<a href="#l41.493"></a><span id="l41.493" class="difflineminus">-   *     kAttr* enumeration.</span>
<a href="#l41.494"></a><span id="l41.494" class="difflineminus">-   * @param attributeName The name of the attribute, which also doubles as the</span>
<a href="#l41.495"></a><span id="l41.495" class="difflineminus">-   *     bound property name if you pass 'bind' a value of true.  You are</span>
<a href="#l41.496"></a><span id="l41.496" class="difflineplus">+   * @param aAttrDef.provider The object instance providing a 'process' method.</span>
<a href="#l41.497"></a><span id="l41.497" class="difflineplus">+   * @param aAttrDef.extensionName The name of the extension providing these</span>
<a href="#l41.498"></a><span id="l41.498" class="difflineplus">+   *     attributes.</span>
<a href="#l41.499"></a><span id="l41.499" class="difflineplus">+   * @param aAttrDef.attributeType The type of attribute, one of the values from</span>
<a href="#l41.500"></a><span id="l41.500" class="difflineplus">+   *     the kAttr* enumeration.</span>
<a href="#l41.501"></a><span id="l41.501" class="difflineplus">+   * @param aAttrDef.attributeName The name of the attribute, which also doubles</span>
<a href="#l41.502"></a><span id="l41.502" class="difflineplus">+   *     as the bound property name if you pass 'bind' a value of true.  You are</span>
<a href="#l41.503"></a><span id="l41.503">    *     responsible for avoiding collisions, which presumably will mean</span>
<a href="#l41.504"></a><span id="l41.504">    *     checking/updating a wiki page in the future, or just prefixing your</span>
<a href="#l41.505"></a><span id="l41.505">    *     attribute name with your extension name or something like that.</span>
<a href="#l41.506"></a><span id="l41.506" class="difflineminus">-   * @param bind Should this attribute be 'bound' as a convenience attribute</span>
<a href="#l41.507"></a><span id="l41.507" class="difflineminus">-   *     on the subject's object (true/false)?  For example, with an</span>
<a href="#l41.508"></a><span id="l41.508" class="difflineplus">+   * @param aAttrDef.bind Should this attribute be 'bound' as a convenience</span>
<a href="#l41.509"></a><span id="l41.509" class="difflineplus">+   *     attribute on the subject's object (true/false)?  For example, with an</span>
<a href="#l41.510"></a><span id="l41.510">    *     attributeName of &quot;foo&quot; and passing true for 'bind' with a subject noun</span>
<a href="#l41.511"></a><span id="l41.511" class="difflineminus">-   *     of NOUN_MESSAGE, GlodaMessage instances will expose a &quot;foo&quot; getter</span>
<a href="#l41.512"></a><span id="l41.512" class="difflineminus">-   *     that returns the value of the attribute.  If 'singular' is true, this</span>
<a href="#l41.513"></a><span id="l41.513" class="difflineminus">-   *     means an instance of the object class corresponding to the noun type or</span>
<a href="#l41.514"></a><span id="l41.514" class="difflineminus">-   *     null if the attribute does not exist.  If 'singular' is false, this</span>
<a href="#l41.515"></a><span id="l41.515" class="difflineminus">-   *     means a list of instances of the object class corresponding to the noun</span>
<a href="#l41.516"></a><span id="l41.516" class="difflineminus">-   *     type, where the list may be empty if no instances of the attribute are</span>
<a href="#l41.517"></a><span id="l41.517" class="difflineplus">+   *     of NOUN_MESSAGE, GlodaMessage instances will expose a &quot;foo&quot; getter that</span>
<a href="#l41.518"></a><span id="l41.518" class="difflineplus">+   *     returns the value of the attribute.  If 'singular' is true, this means</span>
<a href="#l41.519"></a><span id="l41.519" class="difflineplus">+   *     an instance of the object class corresponding to the noun type or null</span>
<a href="#l41.520"></a><span id="l41.520" class="difflineplus">+   *     if the attribute does not exist.  If 'singular' is false, this means a</span>
<a href="#l41.521"></a><span id="l41.521" class="difflineplus">+   *     list of instances of the object class corresponding to the noun type,</span>
<a href="#l41.522"></a><span id="l41.522" class="difflineplus">+   *     where the list may be empty if no instances of the attribute are</span>
<a href="#l41.523"></a><span id="l41.523">    *     present.</span>
<a href="#l41.524"></a><span id="l41.524" class="difflineminus">-   * @param bindName Optional override of attributeName for purposes of the</span>
<a href="#l41.525"></a><span id="l41.525" class="difflineminus">-   *     binding property's name.</span>
<a href="#l41.526"></a><span id="l41.526" class="difflineminus">-   * @param singular Is the attribute going to happen at most once (true),</span>
<a href="#l41.527"></a><span id="l41.527" class="difflineminus">-   *     or potentially multiple times (false).  This affects whether</span>
<a href="#l41.528"></a><span id="l41.528" class="difflineminus">-   *     the binding  returns a list or just a single item (which is null when</span>
<a href="#l41.529"></a><span id="l41.529" class="difflineplus">+   * @param aAttrDef.bindName Optional override of attributeName for purposes of</span>
<a href="#l41.530"></a><span id="l41.530" class="difflineplus">+   *     the binding property's name.</span>
<a href="#l41.531"></a><span id="l41.531" class="difflineplus">+   * @param aAttrDef.singular Is the attribute going to happen at most once</span>
<a href="#l41.532"></a><span id="l41.532" class="difflineplus">+   *     (true), or potentially multiple times (false).  This affects whether</span>
<a href="#l41.533"></a><span id="l41.533" class="difflineplus">+   *     the binding returns a list or just a single item (which is null when</span>
<a href="#l41.534"></a><span id="l41.534">    *     the attribute is not present).</span>
<a href="#l41.535"></a><span id="l41.535" class="difflineminus">-   * @param subjectNouns A list of object types (NOUNs) that this attribute can</span>
<a href="#l41.536"></a><span id="l41.536" class="difflineminus">-   *     be set on.  Each element in the list should be one of the NOUN_*</span>
<a href="#l41.537"></a><span id="l41.537" class="difflineminus">-   *     constants or a dynamically registered noun type.</span>
<a href="#l41.538"></a><span id="l41.538" class="difflineminus">-   * @param objectNoun The object type (one of the NOUN_* constants or a</span>
<a href="#l41.539"></a><span id="l41.539" class="difflineminus">-   *     dynamically registered noun types) that is the 'object' in the</span>
<a href="#l41.540"></a><span id="l41.540" class="difflineplus">+   * @param aAttrDef.subjectNouns A list of object types (NOUNs) that this</span>
<a href="#l41.541"></a><span id="l41.541" class="difflineplus">+   *     attribute can be set on.  Each element in the list should be one of the</span>
<a href="#l41.542"></a><span id="l41.542" class="difflineplus">+   *     NOUN_* constants or a dynamically registered noun type.</span>
<a href="#l41.543"></a><span id="l41.543" class="difflineplus">+   * @param aAttrDef.objectNoun The object type (one of the NOUN_* constants or</span>
<a href="#l41.544"></a><span id="l41.544" class="difflineplus">+   *     a dynamically registered noun types) that is the 'object' in the</span>
<a href="#l41.545"></a><span id="l41.545">    *     traditional RDF triple.  More pragmatically, in the database row used</span>
<a href="#l41.546"></a><span id="l41.546">    *     to represent an attribute, we store the subject (ex: message ID),</span>
<a href="#l41.547"></a><span id="l41.547">    *     attribute ID, and an integer which is the integer representation of the</span>
<a href="#l41.548"></a><span id="l41.548">    *     'object' whose type you are defining right here.</span>
<a href="#l41.549"></a><span id="l41.549">    */</span>
<a href="#l41.550"></a><span id="l41.550">   defineAttribute: function gloda_ns_defineAttribute(aAttrDef) {</span>
<a href="#l41.551"></a><span id="l41.551">     // ensure required properties exist on aAttrDef</span>
<a href="#l41.552"></a><span id="l41.552">     if (!(&quot;provider&quot; in aAttrDef) ||</span>
<a href="#l41.553"></a><span id="l41.553" class="difflineat">@@ -1333,16 +1509,17 @@ var Gloda = {</span>
<a href="#l41.554"></a><span id="l41.554">     // - first time we've seen a provider init logic</span>
<a href="#l41.555"></a><span id="l41.555">     if (!(aAttrDef.provider.providerName in this._attrProviders)) {</span>
<a href="#l41.556"></a><span id="l41.556">       this._attrProviders[aAttrDef.provider.providerName] = [];</span>
<a href="#l41.557"></a><span id="l41.557">       if (aAttrDef.provider.contentWhittle)</span>
<a href="#l41.558"></a><span id="l41.558">         whittlerRegistry.registerWhittler(aAttrDef.provider);</span>
<a href="#l41.559"></a><span id="l41.559">     }</span>
<a href="#l41.560"></a><span id="l41.560"> </span>
<a href="#l41.561"></a><span id="l41.561">     let compoundName = aAttrDef.extensionName + &quot;:&quot; + aAttrDef.attributeName;</span>
<a href="#l41.562"></a><span id="l41.562" class="difflineplus">+    // -- Database Definition</span>
<a href="#l41.563"></a><span id="l41.563">     let attrDBDef;</span>
<a href="#l41.564"></a><span id="l41.564">     if (compoundName in GlodaDatastore._attributeDBDefs) {</span>
<a href="#l41.565"></a><span id="l41.565">       // the existence of the GlodaAttributeDBDef means that either it has</span>
<a href="#l41.566"></a><span id="l41.566">       //  already been fully defined, or has been loaded from the database but</span>
<a href="#l41.567"></a><span id="l41.567">       //  not yet 'bound' to a provider (and had important meta-info that</span>
<a href="#l41.568"></a><span id="l41.568">       //  doesn't go in the db copied over)</span>
<a href="#l41.569"></a><span id="l41.569">       attrDBDef = GlodaDatastore._attributeDBDefs[compoundName];</span>
<a href="#l41.570"></a><span id="l41.570">     }</span>
<a href="#l41.571"></a><span id="l41.571" class="difflineat">@@ -1368,16 +1545,62 @@ var Gloda = {</span>
<a href="#l41.572"></a><span id="l41.572">     if (&quot;bindName&quot; in aAttrDef)</span>
<a href="#l41.573"></a><span id="l41.573">       aAttrDef.boundName = aAttrDef.bindName;</span>
<a href="#l41.574"></a><span id="l41.574">     else</span>
<a href="#l41.575"></a><span id="l41.575">       aAttrDef.boundName = aAttrDef.attributeName;</span>
<a href="#l41.576"></a><span id="l41.576"> </span>
<a href="#l41.577"></a><span id="l41.577">     aAttrDef.objectNounDef = this._nounIDToDef[aAttrDef.objectNoun];</span>
<a href="#l41.578"></a><span id="l41.578">     aAttrDef.objectNounDef.objectNounOfAttributes.push(aAttrDef);</span>
<a href="#l41.579"></a><span id="l41.579"> </span>
<a href="#l41.580"></a><span id="l41.580" class="difflineplus">+    // No facet attribute means no facet desired; set an explicit null so that</span>
<a href="#l41.581"></a><span id="l41.581" class="difflineplus">+    //  code can check without doing an &quot;in&quot; check.</span>
<a href="#l41.582"></a><span id="l41.582" class="difflineplus">+    if (!(&quot;facet&quot; in aAttrDef))</span>
<a href="#l41.583"></a><span id="l41.583" class="difflineplus">+      aAttrDef.facet = null;</span>
<a href="#l41.584"></a><span id="l41.584" class="difflineplus">+    // Promote &quot;true&quot; facet values to the defaults.  Where attributes have</span>
<a href="#l41.585"></a><span id="l41.585" class="difflineplus">+    //  specified values, make sure we fill in any missing defaults.</span>
<a href="#l41.586"></a><span id="l41.586" class="difflineplus">+    else {</span>
<a href="#l41.587"></a><span id="l41.587" class="difflineplus">+      if (aAttrDef.facet == true) {</span>
<a href="#l41.588"></a><span id="l41.588" class="difflineplus">+        aAttrDef.facet = {</span>
<a href="#l41.589"></a><span id="l41.589" class="difflineplus">+          type: &quot;default&quot;,</span>
<a href="#l41.590"></a><span id="l41.590" class="difflineplus">+          groupIdAttr: aAttrDef.objectNounDef.idAttr</span>
<a href="#l41.591"></a><span id="l41.591" class="difflineplus">+        };</span>
<a href="#l41.592"></a><span id="l41.592" class="difflineplus">+      }</span>
<a href="#l41.593"></a><span id="l41.593" class="difflineplus">+      else {</span>
<a href="#l41.594"></a><span id="l41.594" class="difflineplus">+        if (!(&quot;groupIdAttr&quot; in aAttrDef.facet))</span>
<a href="#l41.595"></a><span id="l41.595" class="difflineplus">+          aAttrDef.facet.groupIdAttr = aAttrDef.objectNounDef.idAttr;</span>
<a href="#l41.596"></a><span id="l41.596" class="difflineplus">+      }</span>
<a href="#l41.597"></a><span id="l41.597" class="difflineplus">+    }</span>
<a href="#l41.598"></a><span id="l41.598" class="difflineplus">+</span>
<a href="#l41.599"></a><span id="l41.599" class="difflineplus">+    // -- L10n.</span>
<a href="#l41.600"></a><span id="l41.600" class="difflineplus">+    // If the provider has a string bundle, populate a &quot;strings&quot; attribute with</span>
<a href="#l41.601"></a><span id="l41.601" class="difflineplus">+    //  our standard attribute strings that can be UI exposed.</span>
<a href="#l41.602"></a><span id="l41.602" class="difflineplus">+    if (&quot;strings&quot; in aAttrDef.provider) {</span>
<a href="#l41.603"></a><span id="l41.603" class="difflineplus">+      let bundle = aAttrDef.provider.strings;</span>
<a href="#l41.604"></a><span id="l41.604" class="difflineplus">+      let attrStrings = aAttrDef.strings = {};</span>
<a href="#l41.605"></a><span id="l41.605" class="difflineplus">+      // we use the first subject the attribute applies to as the basis of</span>
<a href="#l41.606"></a><span id="l41.606" class="difflineplus">+      //  where to get the string from.  Mainly because we currently don't have</span>
<a href="#l41.607"></a><span id="l41.607" class="difflineplus">+      //  any attributes with multiple subjects nor a use-case where we expose</span>
<a href="#l41.608"></a><span id="l41.608" class="difflineplus">+      //  multiple noun types via the UI.  (Just messages right now.)</span>
<a href="#l41.609"></a><span id="l41.609" class="difflineplus">+      let canonicalSubject = this._nounIDToDef[aAttrDef.subjectNouns[0]];</span>
<a href="#l41.610"></a><span id="l41.610" class="difflineplus">+      let propRoot = &quot;gloda.&quot; + canonicalSubject.name + &quot;.attr.&quot; +</span>
<a href="#l41.611"></a><span id="l41.611" class="difflineplus">+                       aAttrDef.attributeName + &quot;.&quot;;</span>
<a href="#l41.612"></a><span id="l41.612" class="difflineplus">+      for each (let [propName, attrName] in</span>
<a href="#l41.613"></a><span id="l41.613" class="difflineplus">+                Iterator(this._ATTR_LOCALIZED_STRINGS)) {</span>
<a href="#l41.614"></a><span id="l41.614" class="difflineplus">+        try {</span>
<a href="#l41.615"></a><span id="l41.615" class="difflineplus">+          attrStrings[attrName] = bundle.get(propRoot + propName);</span>
<a href="#l41.616"></a><span id="l41.616" class="difflineplus">+        }</span>
<a href="#l41.617"></a><span id="l41.617" class="difflineplus">+        catch (ex) {</span>
<a href="#l41.618"></a><span id="l41.618" class="difflineplus">+          // do nothing.  nsIStringBundle throws exceptions because it is a</span>
<a href="#l41.619"></a><span id="l41.619" class="difflineplus">+          //  standard nsresult type of API and our helper buddy does nothing</span>
<a href="#l41.620"></a><span id="l41.620" class="difflineplus">+          //  to help us.  (StringBundle.js, that is.)</span>
<a href="#l41.621"></a><span id="l41.621" class="difflineplus">+        }</span>
<a href="#l41.622"></a><span id="l41.622" class="difflineplus">+      }</span>
<a href="#l41.623"></a><span id="l41.623" class="difflineplus">+    }</span>
<a href="#l41.624"></a><span id="l41.624" class="difflineplus">+</span>
<a href="#l41.625"></a><span id="l41.625" class="difflineplus">+    // -- Subject Noun Binding</span>
<a href="#l41.626"></a><span id="l41.626">     for (let iSubject = 0; iSubject &lt; aAttrDef.subjectNouns.length;</span>
<a href="#l41.627"></a><span id="l41.627">            iSubject++) {</span>
<a href="#l41.628"></a><span id="l41.628">       let subjectType = aAttrDef.subjectNouns[iSubject];</span>
<a href="#l41.629"></a><span id="l41.629">       let subjectNounDef = this._nounIDToDef[subjectType];</span>
<a href="#l41.630"></a><span id="l41.630">       this._bindAttribute(aAttrDef, subjectNounDef);</span>
<a href="#l41.631"></a><span id="l41.631"> </span>
<a href="#l41.632"></a><span id="l41.632">       // update the provider maps...</span>
<a href="#l41.633"></a><span id="l41.633">       if (this._attrProviderOrderByNoun[subjectType]</span>
<a href="#l41.634"></a><span id="l41.634" class="difflineat">@@ -1751,18 +1974,22 @@ var Gloda = {</span>
<a href="#l41.635"></a><span id="l41.635">    *</span>
<a href="#l41.636"></a><span id="l41.636">    * @param aItems The non-empty list of items to score.</span>
<a href="#l41.637"></a><span id="l41.637">    * @param aContext A noun-specific dictionary that we just pass to the funcs.</span>
<a href="#l41.638"></a><span id="l41.638">    * @param aExtraScoreFuncs A list of extra scoring functions to apply.</span>
<a href="#l41.639"></a><span id="l41.639">    * @returns A list of integer scores equal in length to aItems.</span>
<a href="#l41.640"></a><span id="l41.640">    */</span>
<a href="#l41.641"></a><span id="l41.641">   scoreNounItems: function gloda_ns_grokNounItem(aItems, aContext,</span>
<a href="#l41.642"></a><span id="l41.642">                                                  aExtraScoreFuncs) {</span>
<a href="#l41.643"></a><span id="l41.643" class="difflineplus">+    let scores = [];</span>
<a href="#l41.644"></a><span id="l41.644" class="difflineplus">+    // bail if there is nothing to score</span>
<a href="#l41.645"></a><span id="l41.645" class="difflineplus">+    if (!aItems.length)</span>
<a href="#l41.646"></a><span id="l41.646" class="difflineplus">+      return scores;</span>
<a href="#l41.647"></a><span id="l41.647" class="difflineplus">+</span>
<a href="#l41.648"></a><span id="l41.648">     let itemNounDef = aItems[0].NOUN_DEF;</span>
<a href="#l41.649"></a><span id="l41.649" class="difflineminus">-    let scores = [];</span>
<a href="#l41.650"></a><span id="l41.650">     if (aExtraScoreFuncs == null)</span>
<a href="#l41.651"></a><span id="l41.651">       aExtraScoreFuncs = [];</span>
<a href="#l41.652"></a><span id="l41.652"> </span>
<a href="#l41.653"></a><span id="l41.653">     for each (let [, item] in Iterator(aItems)) {</span>
<a href="#l41.654"></a><span id="l41.654">       let score = 0;</span>
<a href="#l41.655"></a><span id="l41.655">       let attrProviders = this._attrProviderOrderByNoun[itemNounDef.id];</span>
<a href="#l41.656"></a><span id="l41.656">       for (let iProvider = 0; iProvider &lt; attrProviders.length; iProvider++) {</span>
<a href="#l41.657"></a><span id="l41.657">         let provider = attrProviders[iProvider];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/db/gloda/modules/index_ab.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/index_ab.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l42.4"></a><span id="l42.4"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l42.5"></a><span id="l42.5">  *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l42.6"></a><span id="l42.6">  *</span>
<a href="#l42.7"></a><span id="l42.7">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l42.8"></a><span id="l42.8">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l42.9"></a><span id="l42.9">  * the License. You may obtain a copy of the License at</span>
<a href="#l42.10"></a><span id="l42.10">  * http://www.mozilla.org/MPL/</span>
<a href="#l42.11"></a><span id="l42.11" class="difflineminus">- * </span>
<a href="#l42.12"></a><span id="l42.12" class="difflineplus">+ *</span>
<a href="#l42.13"></a><span id="l42.13">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l42.14"></a><span id="l42.14">  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l42.15"></a><span id="l42.15">  * for the specific language governing rights and limitations under the</span>
<a href="#l42.16"></a><span id="l42.16">  * License.</span>
<a href="#l42.17"></a><span id="l42.17">  *</span>
<a href="#l42.18"></a><span id="l42.18">  * The Original Code is Thunderbird Global Database.</span>
<a href="#l42.19"></a><span id="l42.19">  *</span>
<a href="#l42.20"></a><span id="l42.20">  * The Initial Developer of the Original Code is</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineat">@@ -27,17 +27,17 @@</span>
<a href="#l42.22"></a><span id="l42.22">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l42.23"></a><span id="l42.23">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l42.24"></a><span id="l42.24">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l42.25"></a><span id="l42.25">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l42.26"></a><span id="l42.26">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l42.27"></a><span id="l42.27">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l42.28"></a><span id="l42.28">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l42.29"></a><span id="l42.29">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineminus">- * </span>
<a href="#l42.31"></a><span id="l42.31" class="difflineplus">+ *</span>
<a href="#l42.32"></a><span id="l42.32">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l42.33"></a><span id="l42.33"> </span>
<a href="#l42.34"></a><span id="l42.34"> EXPORTED_SYMBOLS = ['GlodaABIndexer', 'GlodaABAttrs'];</span>
<a href="#l42.35"></a><span id="l42.35"> </span>
<a href="#l42.36"></a><span id="l42.36"> const Cc = Components.classes;</span>
<a href="#l42.37"></a><span id="l42.37"> const Ci = Components.interfaces;</span>
<a href="#l42.38"></a><span id="l42.38"> const Cr = Components.results;</span>
<a href="#l42.39"></a><span id="l42.39"> const Cu = Components.utils;</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineat">@@ -56,58 +56,59 @@ Cu.import(&quot;resource://app/modules/gloda/</span>
<a href="#l42.41"></a><span id="l42.41"> </span>
<a href="#l42.42"></a><span id="l42.42"> var GlodaABIndexer = {</span>
<a href="#l42.43"></a><span id="l42.43">   _log: null,</span>
<a href="#l42.44"></a><span id="l42.44"> </span>
<a href="#l42.45"></a><span id="l42.45">   name: &quot;ab_indexer&quot;,</span>
<a href="#l42.46"></a><span id="l42.46">   enable: function() {</span>
<a href="#l42.47"></a><span id="l42.47">     if (this._log == null)</span>
<a href="#l42.48"></a><span id="l42.48">       this._log =  Log4Moz.repository.getLogger(&quot;gloda.ab_indexer&quot;);</span>
<a href="#l42.49"></a><span id="l42.49" class="difflineminus">-  </span>
<a href="#l42.50"></a><span id="l42.50" class="difflineplus">+</span>
<a href="#l42.51"></a><span id="l42.51">     let abManager = Cc[&quot;@mozilla.org/abmanager;1&quot;].getService(Ci.nsIAbManager);</span>
<a href="#l42.52"></a><span id="l42.52">     abManager.addAddressBookListener(this, Ci.nsIAbListener.itemChanged);</span>
<a href="#l42.53"></a><span id="l42.53">   },</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineminus">-  </span>
<a href="#l42.55"></a><span id="l42.55" class="difflineplus">+</span>
<a href="#l42.56"></a><span id="l42.56">   disable: function() {</span>
<a href="#l42.57"></a><span id="l42.57">     let abManager = Cc[&quot;@mozilla.org/abmanager;1&quot;].getService(Ci.nsIAbManager);</span>
<a href="#l42.58"></a><span id="l42.58">     abManager.removeAddressBookListener(this);</span>
<a href="#l42.59"></a><span id="l42.59">   },</span>
<a href="#l42.60"></a><span id="l42.60"> </span>
<a href="#l42.61"></a><span id="l42.61">   get workers() {</span>
<a href="#l42.62"></a><span id="l42.62">     return [[&quot;ab-card&quot;, this._worker_index_card]];</span>
<a href="#l42.63"></a><span id="l42.63">   },</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineminus">-  </span>
<a href="#l42.65"></a><span id="l42.65" class="difflineplus">+</span>
<a href="#l42.66"></a><span id="l42.66">   _worker_index_card: function(aJob, aCallbackHandle) {</span>
<a href="#l42.67"></a><span id="l42.67">     let card = aJob.id;</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineminus">-    </span>
<a href="#l42.69"></a><span id="l42.69" class="difflineplus">+</span>
<a href="#l42.70"></a><span id="l42.70">     if (card.primaryEmail) {</span>
<a href="#l42.71"></a><span id="l42.71">       // load the identity</span>
<a href="#l42.72"></a><span id="l42.72">       let query = Gloda.newQuery(Gloda.NOUN_IDENTITY);</span>
<a href="#l42.73"></a><span id="l42.73">       query.kind(&quot;email&quot;);</span>
<a href="#l42.74"></a><span id="l42.74" class="difflineminus">-      query.value(card.primaryEmail);</span>
<a href="#l42.75"></a><span id="l42.75" class="difflineplus">+      // we currently normalize all e-mail addresses to be lowercase</span>
<a href="#l42.76"></a><span id="l42.76" class="difflineplus">+      query.value(card.primaryEmail.toLowerCase());</span>
<a href="#l42.77"></a><span id="l42.77">       let identityCollection = query.getCollection(aCallbackHandle);</span>
<a href="#l42.78"></a><span id="l42.78">       yield Gloda.kWorkAsync;</span>
<a href="#l42.79"></a><span id="l42.79" class="difflineminus">-      </span>
<a href="#l42.80"></a><span id="l42.80" class="difflineplus">+</span>
<a href="#l42.81"></a><span id="l42.81">       if (identityCollection.items.length) {</span>
<a href="#l42.82"></a><span id="l42.82">         let identity = identityCollection.items[0];</span>
<a href="#l42.83"></a><span id="l42.83" class="difflineminus">-  </span>
<a href="#l42.84"></a><span id="l42.84" class="difflineplus">+</span>
<a href="#l42.85"></a><span id="l42.85">         this._log.debug(&quot;Found identity, processing card.&quot;);</span>
<a href="#l42.86"></a><span id="l42.86">         yield aCallbackHandle.pushAndGo(</span>
<a href="#l42.87"></a><span id="l42.87">             Gloda.grokNounItem(identity.contact, card, false, false,</span>
<a href="#l42.88"></a><span id="l42.88">                                aCallbackHandle));</span>
<a href="#l42.89"></a><span id="l42.89">         this._log.debug(&quot;Done processing card.&quot;);</span>
<a href="#l42.90"></a><span id="l42.90">       }</span>
<a href="#l42.91"></a><span id="l42.91">     }</span>
<a href="#l42.92"></a><span id="l42.92" class="difflineminus">-    </span>
<a href="#l42.93"></a><span id="l42.93" class="difflineplus">+</span>
<a href="#l42.94"></a><span id="l42.94">     yield GlodaIndexer.kWorkDone;</span>
<a href="#l42.95"></a><span id="l42.95">   },</span>
<a href="#l42.96"></a><span id="l42.96" class="difflineminus">-  </span>
<a href="#l42.97"></a><span id="l42.97" class="difflineplus">+</span>
<a href="#l42.98"></a><span id="l42.98">   initialSweep: function() {</span>
<a href="#l42.99"></a><span id="l42.99">   },</span>
<a href="#l42.100"></a><span id="l42.100" class="difflineminus">-  </span>
<a href="#l42.101"></a><span id="l42.101" class="difflineplus">+</span>
<a href="#l42.102"></a><span id="l42.102">   /* ------ nsIAbListener ------ */</span>
<a href="#l42.103"></a><span id="l42.103">   onItemAdded: function ab_indexer_onItemAdded(aParentDir, aItem) {</span>
<a href="#l42.104"></a><span id="l42.104">   },</span>
<a href="#l42.105"></a><span id="l42.105">   onItemRemoved: function ab_indexer_onItemRemoved(aParentDir, aItem) {</span>
<a href="#l42.106"></a><span id="l42.106">   },</span>
<a href="#l42.107"></a><span id="l42.107">   onItemPropertyChanged: function ab_indexer_onItemPropertyChanged(aItem,</span>
<a href="#l42.108"></a><span id="l42.108">       aProperty, aOldValue, aNewValue) {</span>
<a href="#l42.109"></a><span id="l42.109">     if (aProperty == null &amp;&amp; aItem instanceof Ci.nsIAbCard) {</span>
<a href="#l42.110"></a><span id="l42.110" class="difflineat">@@ -122,26 +123,26 @@ var GlodaABIndexer = {</span>
<a href="#l42.111"></a><span id="l42.111"> GlodaIndexer.registerIndexer(GlodaABIndexer);</span>
<a href="#l42.112"></a><span id="l42.112"> </span>
<a href="#l42.113"></a><span id="l42.113"> var GlodaABAttrs = {</span>
<a href="#l42.114"></a><span id="l42.114">   providerName: &quot;gloda.ab_attr&quot;,</span>
<a href="#l42.115"></a><span id="l42.115">   _log: null,</span>
<a href="#l42.116"></a><span id="l42.116"> </span>
<a href="#l42.117"></a><span id="l42.117">   init: function() {</span>
<a href="#l42.118"></a><span id="l42.118">     this._log =  Log4Moz.repository.getLogger(&quot;gloda.abattrs&quot;);</span>
<a href="#l42.119"></a><span id="l42.119" class="difflineminus">-    </span>
<a href="#l42.120"></a><span id="l42.120" class="difflineplus">+</span>
<a href="#l42.121"></a><span id="l42.121">     try {</span>
<a href="#l42.122"></a><span id="l42.122">       this.defineAttributes();</span>
<a href="#l42.123"></a><span id="l42.123">     }</span>
<a href="#l42.124"></a><span id="l42.124">     catch (ex) {</span>
<a href="#l42.125"></a><span id="l42.125">       this._log.error(&quot;Error in init: &quot; + ex);</span>
<a href="#l42.126"></a><span id="l42.126">       throw ex;</span>
<a href="#l42.127"></a><span id="l42.127">     }</span>
<a href="#l42.128"></a><span id="l42.128">   },</span>
<a href="#l42.129"></a><span id="l42.129" class="difflineminus">-  </span>
<a href="#l42.130"></a><span id="l42.130" class="difflineplus">+</span>
<a href="#l42.131"></a><span id="l42.131">   defineAttributes: function() {</span>
<a href="#l42.132"></a><span id="l42.132">     /* ***** Contacts ***** */</span>
<a href="#l42.133"></a><span id="l42.133">     this._attrIdentityContact = Gloda.defineAttribute({</span>
<a href="#l42.134"></a><span id="l42.134">       provider: this,</span>
<a href="#l42.135"></a><span id="l42.135">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l42.136"></a><span id="l42.136">       attributeType: Gloda.kAttrDerived,</span>
<a href="#l42.137"></a><span id="l42.137">       attributeName: &quot;identities&quot;,</span>
<a href="#l42.138"></a><span id="l42.138">       singular: false,</span>
<a href="#l42.139"></a><span id="l42.139" class="difflineat">@@ -190,17 +191,17 @@ var GlodaABAttrs = {</span>
<a href="#l42.140"></a><span id="l42.140">       provider: this,</span>
<a href="#l42.141"></a><span id="l42.141">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l42.142"></a><span id="l42.142">       attributeType: Gloda.kAttrDerived,</span>
<a href="#l42.143"></a><span id="l42.143">       attributeName: &quot;contact&quot;,</span>
<a href="#l42.144"></a><span id="l42.144">       singular: true,</span>
<a href="#l42.145"></a><span id="l42.145">       special: Gloda.kSpecialColumnParent,</span>
<a href="#l42.146"></a><span id="l42.146">       specialColumnName: &quot;contactID&quot;, // the column in the db</span>
<a href="#l42.147"></a><span id="l42.147">       idStorageAttributeName: &quot;_contactID&quot;,</span>
<a href="#l42.148"></a><span id="l42.148" class="difflineminus">-      valueStorageAttributeName: &quot;_contact&quot;, </span>
<a href="#l42.149"></a><span id="l42.149" class="difflineplus">+      valueStorageAttributeName: &quot;_contact&quot;,</span>
<a href="#l42.150"></a><span id="l42.150">       subjectNouns: [Gloda.NOUN_IDENTITY],</span>
<a href="#l42.151"></a><span id="l42.151">       objectNoun: Gloda.NOUN_CONTACT,</span>
<a href="#l42.152"></a><span id="l42.152">       }); // tested-by: test_attributes_fundamental</span>
<a href="#l42.153"></a><span id="l42.153">     this._attrIdentityKind = Gloda.defineAttribute({</span>
<a href="#l42.154"></a><span id="l42.154">       provider: this,</span>
<a href="#l42.155"></a><span id="l42.155">       extensionName: Gloda.BUILT_IN,</span>
<a href="#l42.156"></a><span id="l42.156">       attributeType: Gloda.kAttrFundamental,</span>
<a href="#l42.157"></a><span id="l42.157">       attributeName: &quot;kind&quot;,</span>
<a href="#l42.158"></a><span id="l42.158" class="difflineat">@@ -240,39 +241,39 @@ var GlodaABAttrs = {</span>
<a href="#l42.159"></a><span id="l42.159">                         }); // not-tested</span>
<a href="#l42.160"></a><span id="l42.160">     // we need to find any existing bound freetag attributes, and use them to</span>
<a href="#l42.161"></a><span id="l42.161">     //  populate to FreeTagNoun's understanding</span>
<a href="#l42.162"></a><span id="l42.162">     for (let freeTagName in this._attrFreeTag.parameterBindings) {</span>
<a href="#l42.163"></a><span id="l42.163">       this._log.debug(&quot;Telling FreeTagNoun about: &quot; + freeTagName);</span>
<a href="#l42.164"></a><span id="l42.164">       FreeTagNoun.getFreeTag(freeTagName);</span>
<a href="#l42.165"></a><span id="l42.165">     }</span>
<a href="#l42.166"></a><span id="l42.166">   },</span>
<a href="#l42.167"></a><span id="l42.167" class="difflineminus">-  </span>
<a href="#l42.168"></a><span id="l42.168" class="difflineplus">+</span>
<a href="#l42.169"></a><span id="l42.169">   process: function(aContact, aCard, aIsNew, aCallbackHandle) {</span>
<a href="#l42.170"></a><span id="l42.170">     if (aContact.NOUN_ID != Gloda.NOUN_CONTACT) {</span>
<a href="#l42.171"></a><span id="l42.171">       this._log.warning(&quot;Somehow got a non-contact: &quot; + aContact);</span>
<a href="#l42.172"></a><span id="l42.172">       return; // this will produce an exception; we like.</span>
<a href="#l42.173"></a><span id="l42.173">     }</span>
<a href="#l42.174"></a><span id="l42.174" class="difflineminus">-    </span>
<a href="#l42.175"></a><span id="l42.175" class="difflineplus">+</span>
<a href="#l42.176"></a><span id="l42.176">     // update the name</span>
<a href="#l42.177"></a><span id="l42.177">     if (aCard.displayName &amp;&amp; aCard.displayName != aContact.name)</span>
<a href="#l42.178"></a><span id="l42.178">       aContact.name = aCard.displayName;</span>
<a href="#l42.179"></a><span id="l42.179" class="difflineminus">-  </span>
<a href="#l42.180"></a><span id="l42.180" class="difflineplus">+</span>
<a href="#l42.181"></a><span id="l42.181">     aContact.freeTags = [];</span>
<a href="#l42.182"></a><span id="l42.182" class="difflineminus">-    </span>
<a href="#l42.183"></a><span id="l42.183" class="difflineplus">+</span>
<a href="#l42.184"></a><span id="l42.184">     let tags = null;</span>
<a href="#l42.185"></a><span id="l42.185">     try {</span>
<a href="#l42.186"></a><span id="l42.186">       tags = aCard.getProperty(&quot;Categories&quot;, null);</span>
<a href="#l42.187"></a><span id="l42.187">     } catch (ex) {</span>
<a href="#l42.188"></a><span id="l42.188">       this._log.error(&quot;Problem accessing property: &quot; + ex);</span>
<a href="#l42.189"></a><span id="l42.189">     }</span>
<a href="#l42.190"></a><span id="l42.190">     if (tags) {</span>
<a href="#l42.191"></a><span id="l42.191">       for each (let [iTagName, tagName] in Iterator(tags.split(&quot;,&quot;))) {</span>
<a href="#l42.192"></a><span id="l42.192">         tagName = tagName.trim();</span>
<a href="#l42.193"></a><span id="l42.193">         if (tagName) {</span>
<a href="#l42.194"></a><span id="l42.194">           aContact.freeTags.push(FreeTagNoun.getFreeTag(tagName));</span>
<a href="#l42.195"></a><span id="l42.195">         }</span>
<a href="#l42.196"></a><span id="l42.196">       }</span>
<a href="#l42.197"></a><span id="l42.197">     }</span>
<a href="#l42.198"></a><span id="l42.198" class="difflineminus">-    </span>
<a href="#l42.199"></a><span id="l42.199" class="difflineplus">+</span>
<a href="#l42.200"></a><span id="l42.200">     yield Gloda.kWorkDone;</span>
<a href="#l42.201"></a><span id="l42.201">   }</span>
<a href="#l42.202"></a><span id="l42.202"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/db/gloda/modules/indexer.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/indexer.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -346,16 +346,22 @@ var GlodaIndexer = {</span>
<a href="#l43.4"></a><span id="l43.4">   _INDEX_IDLE_ADJUSTMENT_TIME: 5000,</span>
<a href="#l43.5"></a><span id="l43.5"> </span>
<a href="#l43.6"></a><span id="l43.6">   /**</span>
<a href="#l43.7"></a><span id="l43.7">    * The time delay in milliseconds before we should schedule our initial sweep.</span>
<a href="#l43.8"></a><span id="l43.8">    */</span>
<a href="#l43.9"></a><span id="l43.9">   _INITIAL_SWEEP_DELAY: 10000,</span>
<a href="#l43.10"></a><span id="l43.10"> </span>
<a href="#l43.11"></a><span id="l43.11">   /**</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineplus">+   * How many milliseconds in the future should we schedule indexing to start</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+   *  when turning on indexing (and it was not previously active).</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+   */</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+  _INDEX_KICKOFF_DELAY: 200,</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+  /**</span>
<a href="#l43.18"></a><span id="l43.18">    * The time interval, in milliseconds, of pause between indexing batches.  The</span>
<a href="#l43.19"></a><span id="l43.19">    *  maximum processor consumption is determined by this constant and the</span>
<a href="#l43.20"></a><span id="l43.20">    *  active |_cpuTargetIndexTime|.</span>
<a href="#l43.21"></a><span id="l43.21">    *</span>
<a href="#l43.22"></a><span id="l43.22">    * For current constants, that puts us at 50% while the user is active and 83%</span>
<a href="#l43.23"></a><span id="l43.23">    *  when idle.</span>
<a href="#l43.24"></a><span id="l43.24">    */</span>
<a href="#l43.25"></a><span id="l43.25">   _INDEX_INTERVAL: 32,</span>
<a href="#l43.26"></a><span id="l43.26" class="difflineat">@@ -681,17 +687,17 @@ var GlodaIndexer = {</span>
<a href="#l43.27"></a><span id="l43.27">    */</span>
<a href="#l43.28"></a><span id="l43.28">   set indexing(aShouldIndex) {</span>
<a href="#l43.29"></a><span id="l43.29">     if (!this._indexingDesired &amp;&amp; aShouldIndex) {</span>
<a href="#l43.30"></a><span id="l43.30">       this._indexingDesired = true;</span>
<a href="#l43.31"></a><span id="l43.31">       if (this.enabled &amp;&amp; !this._indexingActive &amp;&amp; !this._suppressIndexing) {</span>
<a href="#l43.32"></a><span id="l43.32">         this._log.info(&quot;+++ Indexing Queue Processing Commencing&quot;);</span>
<a href="#l43.33"></a><span id="l43.33">         this._indexingActive = true;</span>
<a href="#l43.34"></a><span id="l43.34">         this._timer.initWithCallback(this._wrapCallbackDriver,</span>
<a href="#l43.35"></a><span id="l43.35" class="difflineminus">-                                     this._INDEX_INTERVAL,</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineplus">+                                     this._INDEX_KICKOFF_DELAY,</span>
<a href="#l43.37"></a><span id="l43.37">                                      Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l43.38"></a><span id="l43.38">       }</span>
<a href="#l43.39"></a><span id="l43.39">     }</span>
<a href="#l43.40"></a><span id="l43.40">   },</span>
<a href="#l43.41"></a><span id="l43.41"> </span>
<a href="#l43.42"></a><span id="l43.42">   _suppressIndexing: false,</span>
<a href="#l43.43"></a><span id="l43.43">   /**</span>
<a href="#l43.44"></a><span id="l43.44">    * Set whether or not indexing should be suppressed.  This is to allow us to</span>
<a href="#l43.45"></a><span id="l43.45" class="difflineat">@@ -705,17 +711,17 @@ var GlodaIndexer = {</span>
<a href="#l43.46"></a><span id="l43.46"> </span>
<a href="#l43.47"></a><span id="l43.47">     // re-start processing if we are no longer suppressing, there is work yet</span>
<a href="#l43.48"></a><span id="l43.48">     //  to do, and the indexing process had actually stopped.</span>
<a href="#l43.49"></a><span id="l43.49">     if (!this._suppressIndexing &amp;&amp; this._indexingDesired &amp;&amp;</span>
<a href="#l43.50"></a><span id="l43.50">         !this._indexingActive) {</span>
<a href="#l43.51"></a><span id="l43.51">         this._log.info(&quot;+++ Indexing Queue Processing Resuming&quot;);</span>
<a href="#l43.52"></a><span id="l43.52">         this._indexingActive = true;</span>
<a href="#l43.53"></a><span id="l43.53">         this._timer.initWithCallback(this._wrapCallbackDriver,</span>
<a href="#l43.54"></a><span id="l43.54" class="difflineminus">-                                     this._INDEX_INTERVAL,</span>
<a href="#l43.55"></a><span id="l43.55" class="difflineplus">+                                     this._INDEX_KICKOFF_DELAY,</span>
<a href="#l43.56"></a><span id="l43.56">                                      Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l43.57"></a><span id="l43.57">     }</span>
<a href="#l43.58"></a><span id="l43.58">   },</span>
<a href="#l43.59"></a><span id="l43.59"> </span>
<a href="#l43.60"></a><span id="l43.60">   /**</span>
<a href="#l43.61"></a><span id="l43.61">    * Our timer-driven callback to schedule our first initial indexing sweep.</span>
<a href="#l43.62"></a><span id="l43.62">    *  Because it is invoked by an nsITimer it operates without the benefit of</span>
<a href="#l43.63"></a><span id="l43.63">    *  a 'this' context and must use GlodaIndexer instead of this.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1">new file mode 100644</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineminus">--- /dev/null</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineplus">+++ b/mailnews/db/gloda/modules/mimeTypeCategories.js</span>
<a href="#l44.4"></a><span id="l44.4" class="difflineat">@@ -0,0 +1,200 @@</span>
<a href="#l44.5"></a><span id="l44.5" class="difflineplus">+/*</span>
<a href="#l44.6"></a><span id="l44.6" class="difflineplus">+ * This file wants to be a data file of some sort.  It might do better as a real</span>
<a href="#l44.7"></a><span id="l44.7" class="difflineplus">+ *  raw JSON file.  It is trying to be one right now, but it obviously is not.</span>
<a href="#l44.8"></a><span id="l44.8" class="difflineplus">+ */</span>
<a href="#l44.9"></a><span id="l44.9" class="difflineplus">+</span>
<a href="#l44.10"></a><span id="l44.10" class="difflineplus">+let EXPORTED_SYMBOLS = ['MimeCategoryMapping'];</span>
<a href="#l44.11"></a><span id="l44.11" class="difflineplus">+</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineplus">+/**</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+ * Input data structure to allow us to build a fast mapping from mime type to</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+ *  category name.  The keys in MimeCategoryMapping are the top-level</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+ *  categories.  Each value can either be a list of MIME types or a nested</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+ *  object which recursively defines sub-categories.  We currently do not use</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+ *  the sub-categories.  They are just there to try and organize the MIME types</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineplus">+ *  a little and open the door to future enhancements.</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineplus">+ *</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineplus">+ * Do _not_ add additional top-level categories unless you have added</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineplus">+ *  corresponding entries to gloda.properties under the</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineplus">+ *  &quot;gloda.mimetype.category&quot; branch and are making sure localizers are aware</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineplus">+ *  of the change and have time to localize it.</span>
<a href="#l44.24"></a><span id="l44.24" class="difflineplus">+ *</span>
<a href="#l44.25"></a><span id="l44.25" class="difflineplus">+ * Entries with wildcards in them are part of a fallback strategy by the</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineplus">+ *  |mimeTypeNoun| and do not actually use regular expressions or anything like</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineplus">+ *  that.  Everything is a straight string lookup.  Given &quot;foo/bar&quot; we look for</span>
<a href="#l44.28"></a><span id="l44.28" class="difflineplus">+ *  &quot;foo/bar&quot;, then &quot;foo/*&quot;, and finally &quot;*&quot;.</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineplus">+ */</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineplus">+let MimeCategoryMapping = {</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineplus">+  archives: [</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineplus">+    &quot;application/java-archive&quot;,</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineplus">+    &quot;application/x-java-archive&quot;,</span>
<a href="#l44.34"></a><span id="l44.34" class="difflineplus">+    &quot;application/x-jar&quot;,</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineplus">+    &quot;application/x-java-jnlp-file&quot;,</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineplus">+</span>
<a href="#l44.37"></a><span id="l44.37" class="difflineplus">+    &quot;application/mac-binhex40&quot;,</span>
<a href="#l44.38"></a><span id="l44.38" class="difflineplus">+    &quot;application/vnd.ms-cab-compressed&quot;,</span>
<a href="#l44.39"></a><span id="l44.39" class="difflineplus">+</span>
<a href="#l44.40"></a><span id="l44.40" class="difflineplus">+    &quot;application/x-arc&quot;,</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineplus">+    &quot;application/x-arj&quot;,</span>
<a href="#l44.42"></a><span id="l44.42" class="difflineplus">+    &quot;application/x-compress&quot;,</span>
<a href="#l44.43"></a><span id="l44.43" class="difflineplus">+    &quot;application/x-compressed-tar&quot;,</span>
<a href="#l44.44"></a><span id="l44.44" class="difflineplus">+    &quot;application/x-cpio&quot;,</span>
<a href="#l44.45"></a><span id="l44.45" class="difflineplus">+    &quot;application/x-cpio-compressed&quot;,</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineplus">+    &quot;application/x-deb&quot;,</span>
<a href="#l44.47"></a><span id="l44.47" class="difflineplus">+</span>
<a href="#l44.48"></a><span id="l44.48" class="difflineplus">+    &quot;application/x-bittorrent&quot;,</span>
<a href="#l44.49"></a><span id="l44.49" class="difflineplus">+</span>
<a href="#l44.50"></a><span id="l44.50" class="difflineplus">+    &quot;application/x-rar&quot;,</span>
<a href="#l44.51"></a><span id="l44.51" class="difflineplus">+    &quot;application/x-rar-compressed&quot;,</span>
<a href="#l44.52"></a><span id="l44.52" class="difflineplus">+    &quot;application/x-7z-compressed&quot;,</span>
<a href="#l44.53"></a><span id="l44.53" class="difflineplus">+    &quot;application/zip&quot;,</span>
<a href="#l44.54"></a><span id="l44.54" class="difflineplus">+    &quot;application/x-zip-compressed&quot;,</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineplus">+    &quot;application/x-zip&quot;,</span>
<a href="#l44.56"></a><span id="l44.56" class="difflineplus">+</span>
<a href="#l44.57"></a><span id="l44.57" class="difflineplus">+    &quot;application/x-bzip&quot;,</span>
<a href="#l44.58"></a><span id="l44.58" class="difflineplus">+    &quot;application/x-bzip-compressed-tar&quot;,</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineplus">+    &quot;application/x-bzip2&quot;,</span>
<a href="#l44.60"></a><span id="l44.60" class="difflineplus">+    &quot;application/x-gzip&quot;,</span>
<a href="#l44.61"></a><span id="l44.61" class="difflineplus">+    &quot;application/x-tar&quot;,</span>
<a href="#l44.62"></a><span id="l44.62" class="difflineplus">+    &quot;application/x-tar-gz&quot;,</span>
<a href="#l44.63"></a><span id="l44.63" class="difflineplus">+    &quot;application/x-tarz&quot;,</span>
<a href="#l44.64"></a><span id="l44.64" class="difflineplus">+  ],</span>
<a href="#l44.65"></a><span id="l44.65" class="difflineplus">+  documents: {</span>
<a href="#l44.66"></a><span id="l44.66" class="difflineplus">+    database: [</span>
<a href="#l44.67"></a><span id="l44.67" class="difflineplus">+      &quot;application/vnd.ms-access&quot;,</span>
<a href="#l44.68"></a><span id="l44.68" class="difflineplus">+      &quot;application/x-msaccess&quot;,</span>
<a href="#l44.69"></a><span id="l44.69" class="difflineplus">+      &quot;application/msaccess&quot;,</span>
<a href="#l44.70"></a><span id="l44.70" class="difflineplus">+      &quot;application/vnd.msaccess&quot;,</span>
<a href="#l44.71"></a><span id="l44.71" class="difflineplus">+      &quot;application/x-msaccess&quot;,</span>
<a href="#l44.72"></a><span id="l44.72" class="difflineplus">+      &quot;application/mdb&quot;,</span>
<a href="#l44.73"></a><span id="l44.73" class="difflineplus">+      &quot;application/x-mdb&quot;,</span>
<a href="#l44.74"></a><span id="l44.74" class="difflineplus">+</span>
<a href="#l44.75"></a><span id="l44.75" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.database&quot;,</span>
<a href="#l44.76"></a><span id="l44.76" class="difflineplus">+</span>
<a href="#l44.77"></a><span id="l44.77" class="difflineplus">+    ],</span>
<a href="#l44.78"></a><span id="l44.78" class="difflineplus">+    graphics: [</span>
<a href="#l44.79"></a><span id="l44.79" class="difflineplus">+      &quot;application/postscript&quot;,</span>
<a href="#l44.80"></a><span id="l44.80" class="difflineplus">+      &quot;application/x-bzpostscript&quot;,</span>
<a href="#l44.81"></a><span id="l44.81" class="difflineplus">+      &quot;application/x-dvi&quot;,</span>
<a href="#l44.82"></a><span id="l44.82" class="difflineplus">+      &quot;application/x-gzdvi&quot;,</span>
<a href="#l44.83"></a><span id="l44.83" class="difflineplus">+</span>
<a href="#l44.84"></a><span id="l44.84" class="difflineplus">+      &quot;application/illustrator&quot;,</span>
<a href="#l44.85"></a><span id="l44.85" class="difflineplus">+</span>
<a href="#l44.86"></a><span id="l44.86" class="difflineplus">+      &quot;application/vnd.corel-draw&quot;,</span>
<a href="#l44.87"></a><span id="l44.87" class="difflineplus">+      &quot;application/cdr&quot;,</span>
<a href="#l44.88"></a><span id="l44.88" class="difflineplus">+      &quot;application/coreldraw&quot;,</span>
<a href="#l44.89"></a><span id="l44.89" class="difflineplus">+      &quot;application/x-cdr&quot;,</span>
<a href="#l44.90"></a><span id="l44.90" class="difflineplus">+      &quot;application/x-coreldraw&quot;,</span>
<a href="#l44.91"></a><span id="l44.91" class="difflineplus">+      &quot;image/cdr&quot;,</span>
<a href="#l44.92"></a><span id="l44.92" class="difflineplus">+      &quot;image/x-cdr&quot;,</span>
<a href="#l44.93"></a><span id="l44.93" class="difflineplus">+      &quot;zz-application/zz-winassoc-cdr&quot;,</span>
<a href="#l44.94"></a><span id="l44.94" class="difflineplus">+</span>
<a href="#l44.95"></a><span id="l44.95" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.graphics&quot;,</span>
<a href="#l44.96"></a><span id="l44.96" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.graphics-template&quot;,</span>
<a href="#l44.97"></a><span id="l44.97" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.image&quot;,</span>
<a href="#l44.98"></a><span id="l44.98" class="difflineplus">+</span>
<a href="#l44.99"></a><span id="l44.99" class="difflineplus">+      &quot;application/x-dia-diagram&quot;,</span>
<a href="#l44.100"></a><span id="l44.100" class="difflineplus">+    ],</span>
<a href="#l44.101"></a><span id="l44.101" class="difflineplus">+    presentation: [</span>
<a href="#l44.102"></a><span id="l44.102" class="difflineplus">+      &quot;application/vnd.ms-powerpoint.presentation.macroenabled.12&quot;,</span>
<a href="#l44.103"></a><span id="l44.103" class="difflineplus">+      &quot;application/vnd.ms-powerpoint.template.macroenabled.12&quot;,</span>
<a href="#l44.104"></a><span id="l44.104" class="difflineplus">+      &quot;application/vnd.ms-powerpoint&quot;,</span>
<a href="#l44.105"></a><span id="l44.105" class="difflineplus">+      &quot;application/powerpoint&quot;,</span>
<a href="#l44.106"></a><span id="l44.106" class="difflineplus">+      &quot;application/mspowerpoint&quot;,</span>
<a href="#l44.107"></a><span id="l44.107" class="difflineplus">+      &quot;application/x-mspowerpoint&quot;,</span>
<a href="#l44.108"></a><span id="l44.108" class="difflineplus">+      &quot;application/vnd.openxmlformats-officedocument.presentationml.presentation&quot;,</span>
<a href="#l44.109"></a><span id="l44.109" class="difflineplus">+      &quot;application/vnd.openxmlformats-officedocument.presentationml.template&quot;,</span>
<a href="#l44.110"></a><span id="l44.110" class="difflineplus">+</span>
<a href="#l44.111"></a><span id="l44.111" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.presentation&quot;,</span>
<a href="#l44.112"></a><span id="l44.112" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.presentation-template&quot;</span>
<a href="#l44.113"></a><span id="l44.113" class="difflineplus">+    ],</span>
<a href="#l44.114"></a><span id="l44.114" class="difflineplus">+    spreadsheet: [</span>
<a href="#l44.115"></a><span id="l44.115" class="difflineplus">+      &quot;application/vnd.lotus-1-2-3&quot;,</span>
<a href="#l44.116"></a><span id="l44.116" class="difflineplus">+      &quot;application/x-lotus123&quot;,</span>
<a href="#l44.117"></a><span id="l44.117" class="difflineplus">+      &quot;application/x-123&quot;,</span>
<a href="#l44.118"></a><span id="l44.118" class="difflineplus">+      &quot;application/lotus123&quot;,</span>
<a href="#l44.119"></a><span id="l44.119" class="difflineplus">+      &quot;application/wk1&quot;,</span>
<a href="#l44.120"></a><span id="l44.120" class="difflineplus">+</span>
<a href="#l44.121"></a><span id="l44.121" class="difflineplus">+      &quot;application/x-quattropro&quot;,</span>
<a href="#l44.122"></a><span id="l44.122" class="difflineplus">+</span>
<a href="#l44.123"></a><span id="l44.123" class="difflineplus">+      &quot;application/vnd.ms-excel.sheet.binary.macroenabled.12&quot;,</span>
<a href="#l44.124"></a><span id="l44.124" class="difflineplus">+      &quot;application/vnd.ms-excel.sheet.macroenabled.12&quot;,</span>
<a href="#l44.125"></a><span id="l44.125" class="difflineplus">+      &quot;application/vnd.ms-excel.template.macroenabled.12&quot;,</span>
<a href="#l44.126"></a><span id="l44.126" class="difflineplus">+      &quot;application/vnd.ms-excel&quot;,</span>
<a href="#l44.127"></a><span id="l44.127" class="difflineplus">+      &quot;application/msexcel&quot;,</span>
<a href="#l44.128"></a><span id="l44.128" class="difflineplus">+      &quot;application/x-msexcel&quot;,</span>
<a href="#l44.129"></a><span id="l44.129" class="difflineplus">+      &quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;,</span>
<a href="#l44.130"></a><span id="l44.130" class="difflineplus">+      &quot;application/vnd.openxmlformats-officedocument.spreadsheetml.template&quot;,</span>
<a href="#l44.131"></a><span id="l44.131" class="difflineplus">+</span>
<a href="#l44.132"></a><span id="l44.132" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.formula&quot;,</span>
<a href="#l44.133"></a><span id="l44.133" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.formula-template&quot;,</span>
<a href="#l44.134"></a><span id="l44.134" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.chart&quot;,</span>
<a href="#l44.135"></a><span id="l44.135" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.chart-template&quot;,</span>
<a href="#l44.136"></a><span id="l44.136" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.spreadsheet&quot;,</span>
<a href="#l44.137"></a><span id="l44.137" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.spreadsheet-template&quot;,</span>
<a href="#l44.138"></a><span id="l44.138" class="difflineplus">+</span>
<a href="#l44.139"></a><span id="l44.139" class="difflineplus">+      &quot;application/x-gnumeric&quot;,</span>
<a href="#l44.140"></a><span id="l44.140" class="difflineplus">+    ],</span>
<a href="#l44.141"></a><span id="l44.141" class="difflineplus">+    wordProcessor: [</span>
<a href="#l44.142"></a><span id="l44.142" class="difflineplus">+      &quot;application/msword&quot;,</span>
<a href="#l44.143"></a><span id="l44.143" class="difflineplus">+      &quot;application/vnd.ms-word&quot;,</span>
<a href="#l44.144"></a><span id="l44.144" class="difflineplus">+      &quot;application/x-msword&quot;,</span>
<a href="#l44.145"></a><span id="l44.145" class="difflineplus">+      &quot;application/msword-template&quot;,</span>
<a href="#l44.146"></a><span id="l44.146" class="difflineplus">+      &quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;,</span>
<a href="#l44.147"></a><span id="l44.147" class="difflineplus">+      &quot;application/vnd.openxmlformats-officedocument.wordprocessingml.template&quot;,</span>
<a href="#l44.148"></a><span id="l44.148" class="difflineplus">+      &quot;application/vnd.ms-word.document.macroenabled.12&quot;,</span>
<a href="#l44.149"></a><span id="l44.149" class="difflineplus">+      &quot;application/vnd.ms-word.template.macroenabled.12&quot;,</span>
<a href="#l44.150"></a><span id="l44.150" class="difflineplus">+      &quot;application/x-mswrite&quot;,</span>
<a href="#l44.151"></a><span id="l44.151" class="difflineplus">+      &quot;application/x-pocket-word&quot;,</span>
<a href="#l44.152"></a><span id="l44.152" class="difflineplus">+</span>
<a href="#l44.153"></a><span id="l44.153" class="difflineplus">+      &quot;application/rtf&quot;,</span>
<a href="#l44.154"></a><span id="l44.154" class="difflineplus">+      &quot;text/rtf&quot;,</span>
<a href="#l44.155"></a><span id="l44.155" class="difflineplus">+</span>
<a href="#l44.156"></a><span id="l44.156" class="difflineplus">+</span>
<a href="#l44.157"></a><span id="l44.157" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.text&quot;,</span>
<a href="#l44.158"></a><span id="l44.158" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.text-master&quot;,</span>
<a href="#l44.159"></a><span id="l44.159" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.text-template&quot;,</span>
<a href="#l44.160"></a><span id="l44.160" class="difflineplus">+      &quot;application/vnd.oasis.opendocument.text-web&quot;,</span>
<a href="#l44.161"></a><span id="l44.161" class="difflineplus">+</span>
<a href="#l44.162"></a><span id="l44.162" class="difflineplus">+      &quot;application/vnd.wordperfect&quot;,</span>
<a href="#l44.163"></a><span id="l44.163" class="difflineplus">+</span>
<a href="#l44.164"></a><span id="l44.164" class="difflineplus">+      &quot;application/x-abiword&quot;,</span>
<a href="#l44.165"></a><span id="l44.165" class="difflineplus">+      &quot;application/x-amipro&quot;,</span>
<a href="#l44.166"></a><span id="l44.166" class="difflineplus">+    ],</span>
<a href="#l44.167"></a><span id="l44.167" class="difflineplus">+    suite: [</span>
<a href="#l44.168"></a><span id="l44.168" class="difflineplus">+      &quot;application/vnd.ms-works&quot;</span>
<a href="#l44.169"></a><span id="l44.169" class="difflineplus">+    ],</span>
<a href="#l44.170"></a><span id="l44.170" class="difflineplus">+  },</span>
<a href="#l44.171"></a><span id="l44.171" class="difflineplus">+  images: [</span>
<a href="#l44.172"></a><span id="l44.172" class="difflineplus">+    &quot;image/*&quot;</span>
<a href="#l44.173"></a><span id="l44.173" class="difflineplus">+  ],</span>
<a href="#l44.174"></a><span id="l44.174" class="difflineplus">+  media: {</span>
<a href="#l44.175"></a><span id="l44.175" class="difflineplus">+    audio: [</span>
<a href="#l44.176"></a><span id="l44.176" class="difflineplus">+      &quot;audio/*&quot;,</span>
<a href="#l44.177"></a><span id="l44.177" class="difflineplus">+    ],</span>
<a href="#l44.178"></a><span id="l44.178" class="difflineplus">+    video: [</span>
<a href="#l44.179"></a><span id="l44.179" class="difflineplus">+      &quot;video/*&quot;,</span>
<a href="#l44.180"></a><span id="l44.180" class="difflineplus">+    ],</span>
<a href="#l44.181"></a><span id="l44.181" class="difflineplus">+    container: [</span>
<a href="#l44.182"></a><span id="l44.182" class="difflineplus">+      &quot;application/ogg&quot;,</span>
<a href="#l44.183"></a><span id="l44.183" class="difflineplus">+</span>
<a href="#l44.184"></a><span id="l44.184" class="difflineplus">+      &quot;application/smil&quot;,</span>
<a href="#l44.185"></a><span id="l44.185" class="difflineplus">+      &quot;application/vnd.ms-asf&quot;,</span>
<a href="#l44.186"></a><span id="l44.186" class="difflineplus">+      &quot;application/vnd.rn-realmedia&quot;,</span>
<a href="#l44.187"></a><span id="l44.187" class="difflineplus">+      &quot;application/x-matroska&quot;,</span>
<a href="#l44.188"></a><span id="l44.188" class="difflineplus">+      &quot;application/x-quicktime-media-link&quot;,</span>
<a href="#l44.189"></a><span id="l44.189" class="difflineplus">+      &quot;application/x-quicktimeplayer&quot;,</span>
<a href="#l44.190"></a><span id="l44.190" class="difflineplus">+    ]</span>
<a href="#l44.191"></a><span id="l44.191" class="difflineplus">+  },</span>
<a href="#l44.192"></a><span id="l44.192" class="difflineplus">+  other: [</span>
<a href="#l44.193"></a><span id="l44.193" class="difflineplus">+    &quot;*&quot;</span>
<a href="#l44.194"></a><span id="l44.194" class="difflineplus">+  ],</span>
<a href="#l44.195"></a><span id="l44.195" class="difflineplus">+  pdf: [</span>
<a href="#l44.196"></a><span id="l44.196" class="difflineplus">+    &quot;application/pdf&quot;,</span>
<a href="#l44.197"></a><span id="l44.197" class="difflineplus">+    &quot;application/x-pdf&quot;,</span>
<a href="#l44.198"></a><span id="l44.198" class="difflineplus">+    &quot;image/pdf&quot;,</span>
<a href="#l44.199"></a><span id="l44.199" class="difflineplus">+    &quot;file/pdf&quot;,</span>
<a href="#l44.200"></a><span id="l44.200" class="difflineplus">+</span>
<a href="#l44.201"></a><span id="l44.201" class="difflineplus">+    &quot;application/x-bzpdf&quot;,</span>
<a href="#l44.202"></a><span id="l44.202" class="difflineplus">+    &quot;application/x-gzpdf&quot;,</span>
<a href="#l44.203"></a><span id="l44.203" class="difflineplus">+  ],</span>
<a href="#l44.204"></a><span id="l44.204" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/db/gloda/modules/msg_search.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/msg_search.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -83,17 +83,17 @@ const OFFSET_FUZZSCORE_SQL_SNIPPET =</span>
<a href="#l45.4"></a><span id="l45.4"> const FUZZSCORE_SQL_SNIPPET =</span>
<a href="#l45.5"></a><span id="l45.5">   &quot;(&quot; + OFFSET_FUZZSCORE_SQL_SNIPPET + &quot; + notability)&quot;;</span>
<a href="#l45.6"></a><span id="l45.6"> </span>
<a href="#l45.7"></a><span id="l45.7"> const DASCORE_SQL_SNIPPET =</span>
<a href="#l45.8"></a><span id="l45.8">   &quot;((&quot; + FUZZSCORE_SQL_SNIPPET + &quot; * &quot; + FUZZSCORE_TIMESTAMP_FACTOR +</span>
<a href="#l45.9"></a><span id="l45.9">     &quot;) + date)&quot;;</span>
<a href="#l45.10"></a><span id="l45.10"> </span>
<a href="#l45.11"></a><span id="l45.11"> const FULLTEXT_QUERY_EXPLICIT_SQL =</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-  &quot;SELECT messages.*, offsets(messagesText) AS osets &quot; +</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+  &quot;SELECT messages.*, messagesText.*, offsets(messagesText) AS osets &quot; +</span>
<a href="#l45.14"></a><span id="l45.14">     &quot;FROM messages, messagesText WHERE messagesText MATCH ?&quot; +</span>
<a href="#l45.15"></a><span id="l45.15">     &quot; AND messages.id == messagesText.docid&quot;;</span>
<a href="#l45.16"></a><span id="l45.16"> </span>
<a href="#l45.17"></a><span id="l45.17"> </span>
<a href="#l45.18"></a><span id="l45.18"> function identityFunc(x) {</span>
<a href="#l45.19"></a><span id="l45.19">   return x;</span>
<a href="#l45.20"></a><span id="l45.20"> }</span>
<a href="#l45.21"></a><span id="l45.21"> </span>
<a href="#l45.22"></a><span id="l45.22" class="difflineat">@@ -178,55 +178,106 @@ function scoreOffsets(aMessage, aContext</span>
<a href="#l45.23"></a><span id="l45.23">     score += Math.min(termIncidence.map(oneLessMaxZero).reduce(reduceSum, 0),</span>
<a href="#l45.24"></a><span id="l45.24">                       COLUMN_MULTIPLE_MATCH_LIMIT[iColumn]) *</span>
<a href="#l45.25"></a><span id="l45.25">              COLUMN_MULTIPLE_MATCH_SCORES[iColumn];</span>
<a href="#l45.26"></a><span id="l45.26">   }</span>
<a href="#l45.27"></a><span id="l45.27"> </span>
<a href="#l45.28"></a><span id="l45.28">   return score;</span>
<a href="#l45.29"></a><span id="l45.29"> }</span>
<a href="#l45.30"></a><span id="l45.30"> </span>
<a href="#l45.31"></a><span id="l45.31" class="difflineplus">+/**</span>
<a href="#l45.32"></a><span id="l45.32" class="difflineplus">+ * The searcher basically looks like a query, but is specialized for fulltext</span>
<a href="#l45.33"></a><span id="l45.33" class="difflineplus">+ *  search against messages.  Most of the explicit specialization involves</span>
<a href="#l45.34"></a><span id="l45.34" class="difflineplus">+ *  crafting a SQL query that attempts to order the matches by likelihood that</span>
<a href="#l45.35"></a><span id="l45.35" class="difflineplus">+ *  the user was looking for it.  This is based on full-text matches combined</span>
<a href="#l45.36"></a><span id="l45.36" class="difflineplus">+ *  with an explicit (generic) interest score value placed on the message at</span>
<a href="#l45.37"></a><span id="l45.37" class="difflineplus">+ *  indexing time.  This is followed by using the more generic gloda scoring</span>
<a href="#l45.38"></a><span id="l45.38" class="difflineplus">+ *  mechanism to explicitly score the messages given the search context in</span>
<a href="#l45.39"></a><span id="l45.39" class="difflineplus">+ *  addition to the more generic score adjusting rules.</span>
<a href="#l45.40"></a><span id="l45.40" class="difflineplus">+ */</span>
<a href="#l45.41"></a><span id="l45.41" class="difflineplus">+function GlodaMsgSearcher(aListener, aSearchString, aAndTerms) {</span>
<a href="#l45.42"></a><span id="l45.42" class="difflineplus">+  this.listener = aListener;</span>
<a href="#l45.43"></a><span id="l45.43"> </span>
<a href="#l45.44"></a><span id="l45.44" class="difflineminus">-function GlodaMsgSearcher(aViewWrapper, aFulltextTerms) {</span>
<a href="#l45.45"></a><span id="l45.45" class="difflineminus">-  this.viewWrapper = aViewWrapper;</span>
<a href="#l45.46"></a><span id="l45.46" class="difflineminus">-</span>
<a href="#l45.47"></a><span id="l45.47" class="difflineminus">-  this.fulltextTerms = aFulltextTerms;</span>
<a href="#l45.48"></a><span id="l45.48" class="difflineplus">+  this.searchString = aSearchString;</span>
<a href="#l45.49"></a><span id="l45.49" class="difflineplus">+  this.fulltextTerms = this.parseSearchString(aSearchString);</span>
<a href="#l45.50"></a><span id="l45.50" class="difflineplus">+  this.andTerms = (aAndTerms != null) ? aAndTerms : true;</span>
<a href="#l45.51"></a><span id="l45.51"> </span>
<a href="#l45.52"></a><span id="l45.52">   this.query = null;</span>
<a href="#l45.53"></a><span id="l45.53">   this.collection = null;</span>
<a href="#l45.54"></a><span id="l45.54"> </span>
<a href="#l45.55"></a><span id="l45.55" class="difflineminus">-  this.scoresByUriAndKey = {};</span>
<a href="#l45.56"></a><span id="l45.56" class="difflineminus">-  this.whysByUriAndKey = {};</span>
<a href="#l45.57"></a><span id="l45.57" class="difflineplus">+  this.scoresById = {};</span>
<a href="#l45.58"></a><span id="l45.58"> }</span>
<a href="#l45.59"></a><span id="l45.59"> GlodaMsgSearcher.prototype = {</span>
<a href="#l45.60"></a><span id="l45.60">   /**</span>
<a href="#l45.61"></a><span id="l45.61">    * Number of messages to retrieve initially.</span>
<a href="#l45.62"></a><span id="l45.62">    */</span>
<a href="#l45.63"></a><span id="l45.63" class="difflineminus">-  retrievalLimit: 100,</span>
<a href="#l45.64"></a><span id="l45.64" class="difflineplus">+  retrievalLimit: 400,</span>
<a href="#l45.65"></a><span id="l45.65" class="difflineplus">+</span>
<a href="#l45.66"></a><span id="l45.66" class="difflineplus">+  parseSearchString: function GlodaMsgSearcher_parseSearchString(aSearchString) {</span>
<a href="#l45.67"></a><span id="l45.67" class="difflineplus">+    aSearchString = aSearchString.trim();</span>
<a href="#l45.68"></a><span id="l45.68" class="difflineplus">+    let terms = [];</span>
<a href="#l45.69"></a><span id="l45.69" class="difflineplus">+    while (aSearchString) {</span>
<a href="#l45.70"></a><span id="l45.70" class="difflineplus">+      if (aSearchString[0] == '&quot;') {</span>
<a href="#l45.71"></a><span id="l45.71" class="difflineplus">+        let endIndex = aSearchString.indexOf(aSearchString[0], 1);</span>
<a href="#l45.72"></a><span id="l45.72" class="difflineplus">+        // eat the quote if it has no friend</span>
<a href="#l45.73"></a><span id="l45.73" class="difflineplus">+        if (endIndex == -1) {</span>
<a href="#l45.74"></a><span id="l45.74" class="difflineplus">+          aSearchString = aSearchString.substring(1);</span>
<a href="#l45.75"></a><span id="l45.75" class="difflineplus">+          continue;</span>
<a href="#l45.76"></a><span id="l45.76" class="difflineplus">+        }</span>
<a href="#l45.77"></a><span id="l45.77" class="difflineplus">+</span>
<a href="#l45.78"></a><span id="l45.78" class="difflineplus">+        terms.push(aSearchString.substring(1, endIndex).trim());</span>
<a href="#l45.79"></a><span id="l45.79" class="difflineplus">+        aSearchString = aSearchString.substring(endIndex + 1);</span>
<a href="#l45.80"></a><span id="l45.80" class="difflineplus">+        continue;</span>
<a href="#l45.81"></a><span id="l45.81" class="difflineplus">+      }</span>
<a href="#l45.82"></a><span id="l45.82" class="difflineplus">+</span>
<a href="#l45.83"></a><span id="l45.83" class="difflineplus">+      let spaceIndex = aSearchString.indexOf(&quot; &quot;);</span>
<a href="#l45.84"></a><span id="l45.84" class="difflineplus">+      if (spaceIndex == -1) {</span>
<a href="#l45.85"></a><span id="l45.85" class="difflineplus">+        terms.push(aSearchString);</span>
<a href="#l45.86"></a><span id="l45.86" class="difflineplus">+        break;</span>
<a href="#l45.87"></a><span id="l45.87" class="difflineplus">+      }</span>
<a href="#l45.88"></a><span id="l45.88" class="difflineplus">+</span>
<a href="#l45.89"></a><span id="l45.89" class="difflineplus">+      terms.push(aSearchString.substring(0, spaceIndex));</span>
<a href="#l45.90"></a><span id="l45.90" class="difflineplus">+      aSearchString = aSearchString.substring(spaceIndex+1);</span>
<a href="#l45.91"></a><span id="l45.91" class="difflineplus">+    }</span>
<a href="#l45.92"></a><span id="l45.92" class="difflineplus">+</span>
<a href="#l45.93"></a><span id="l45.93" class="difflineplus">+    return terms;</span>
<a href="#l45.94"></a><span id="l45.94" class="difflineplus">+  },</span>
<a href="#l45.95"></a><span id="l45.95"> </span>
<a href="#l45.96"></a><span id="l45.96">   buildFulltextQuery: function GlodaMsgSearcher_buildFulltextQuery() {</span>
<a href="#l45.97"></a><span id="l45.97">     let query = Gloda.newQuery(Gloda.NOUN_MESSAGE, {</span>
<a href="#l45.98"></a><span id="l45.98">       noMagic: true,</span>
<a href="#l45.99"></a><span id="l45.99">       explicitSQL: FULLTEXT_QUERY_EXPLICIT_SQL,</span>
<a href="#l45.100"></a><span id="l45.100" class="difflineminus">-      // osets is 0-based column number 9 (volatile to column changes)</span>
<a href="#l45.101"></a><span id="l45.101" class="difflineminus">-      // dascore becomes 0-based column number 10</span>
<a href="#l45.102"></a><span id="l45.102" class="difflineplus">+      // osets is 0-based column number 14 (volatile to column changes)</span>
<a href="#l45.103"></a><span id="l45.103" class="difflineplus">+      // dascore becomes 0-based column number 15</span>
<a href="#l45.104"></a><span id="l45.104">       outerWrapColumns: [DASCORE_SQL_SNIPPET + &quot; AS dascore&quot;],</span>
<a href="#l45.105"></a><span id="l45.105">       // save the offset column for extra analysis</span>
<a href="#l45.106"></a><span id="l45.106" class="difflineminus">-      stashColumns: [9]</span>
<a href="#l45.107"></a><span id="l45.107" class="difflineplus">+      stashColumns: [14]</span>
<a href="#l45.108"></a><span id="l45.108">     });</span>
<a href="#l45.109"></a><span id="l45.109"> </span>
<a href="#l45.110"></a><span id="l45.110" class="difflineminus">-    query.fulltextMatches(this.fulltextTerms.join(&quot; &quot;));</span>
<a href="#l45.111"></a><span id="l45.111" class="difflineplus">+    let fulltextQueryString;</span>
<a href="#l45.112"></a><span id="l45.112" class="difflineplus">+    if (this.andTerms)</span>
<a href="#l45.113"></a><span id="l45.113" class="difflineplus">+      fulltextQueryString = '&quot;' + this.fulltextTerms.join('&quot; &quot;') + '&quot;';</span>
<a href="#l45.114"></a><span id="l45.114" class="difflineplus">+    else</span>
<a href="#l45.115"></a><span id="l45.115" class="difflineplus">+      fulltextQueryString = '&quot;' + this.fulltextTerms.join('&quot; OR &quot;') + '&quot;';</span>
<a href="#l45.116"></a><span id="l45.116" class="difflineplus">+</span>
<a href="#l45.117"></a><span id="l45.117" class="difflineplus">+    query.fulltextMatches(fulltextQueryString);</span>
<a href="#l45.118"></a><span id="l45.118">     query.orderBy('-dascore');</span>
<a href="#l45.119"></a><span id="l45.119">     query.limit(this.retrievalLimit);</span>
<a href="#l45.120"></a><span id="l45.120"> </span>
<a href="#l45.121"></a><span id="l45.121">     return query;</span>
<a href="#l45.122"></a><span id="l45.122">   },</span>
<a href="#l45.123"></a><span id="l45.123"> </span>
<a href="#l45.124"></a><span id="l45.124" class="difflineminus">-  go: function GlodaMsgSearcher_go() {</span>
<a href="#l45.125"></a><span id="l45.125" class="difflineplus">+  getCollection: function GlodaMsgSearcher_getCollection(</span>
<a href="#l45.126"></a><span id="l45.126" class="difflineplus">+      aListenerOverride, aData) {</span>
<a href="#l45.127"></a><span id="l45.127" class="difflineplus">+    if (aListenerOverride)</span>
<a href="#l45.128"></a><span id="l45.128" class="difflineplus">+      this.listener = aListenerOverride;</span>
<a href="#l45.129"></a><span id="l45.129" class="difflineplus">+</span>
<a href="#l45.130"></a><span id="l45.130">     this.query = this.buildFulltextQuery();</span>
<a href="#l45.131"></a><span id="l45.131" class="difflineminus">-    this.collection = this.query.getCollection(this);</span>
<a href="#l45.132"></a><span id="l45.132" class="difflineplus">+    this.collection = this.query.getCollection(this, aData);</span>
<a href="#l45.133"></a><span id="l45.133" class="difflineplus">+    this.completed = false;</span>
<a href="#l45.134"></a><span id="l45.134"> </span>
<a href="#l45.135"></a><span id="l45.135">     return this.collection;</span>
<a href="#l45.136"></a><span id="l45.136">   },</span>
<a href="#l45.137"></a><span id="l45.137"> </span>
<a href="#l45.138"></a><span id="l45.138">   onItemsAdded: function GlodaMsgSearcher_onItemsAdded(aItems, aCollection) {</span>
<a href="#l45.139"></a><span id="l45.139">     let scores = Gloda.scoreNounItems(</span>
<a href="#l45.140"></a><span id="l45.140">       aItems,</span>
<a href="#l45.141"></a><span id="l45.141">       {</span>
<a href="#l45.142"></a><span id="l45.142" class="difflineat">@@ -234,23 +285,30 @@ GlodaMsgSearcher.prototype = {</span>
<a href="#l45.143"></a><span id="l45.143">         stashedColumns: aCollection.stashedColumns</span>
<a href="#l45.144"></a><span id="l45.144">       },</span>
<a href="#l45.145"></a><span id="l45.145">       [scoreOffsets]);</span>
<a href="#l45.146"></a><span id="l45.146">     let actualItems = [];</span>
<a href="#l45.147"></a><span id="l45.147">     for (let i = 0; i &lt; aItems.length; i++) {</span>
<a href="#l45.148"></a><span id="l45.148">       let item = aItems[i];</span>
<a href="#l45.149"></a><span id="l45.149">       let score = scores[i];</span>
<a href="#l45.150"></a><span id="l45.150"> </span>
<a href="#l45.151"></a><span id="l45.151" class="difflineminus">-      let hdr = item.folderMessage;</span>
<a href="#l45.152"></a><span id="l45.152" class="difflineminus">-      if (hdr) {</span>
<a href="#l45.153"></a><span id="l45.153" class="difflineminus">-        this.scoresByUriAndKey[hdr.folder.URI + &quot;-&quot; + hdr.messageKey] = score;</span>
<a href="#l45.154"></a><span id="l45.154" class="difflineminus">-        actualItems.push(item);</span>
<a href="#l45.155"></a><span id="l45.155" class="difflineminus">-      }</span>
<a href="#l45.156"></a><span id="l45.156" class="difflineplus">+      this.scoresById[item.id] = score;</span>
<a href="#l45.157"></a><span id="l45.157">     }</span>
<a href="#l45.158"></a><span id="l45.158"> </span>
<a href="#l45.159"></a><span id="l45.159" class="difflineminus">-    this.viewWrapper.onItemsAdded(actualItems, aCollection);</span>
<a href="#l45.160"></a><span id="l45.160" class="difflineplus">+    if (this.listener)</span>
<a href="#l45.161"></a><span id="l45.161" class="difflineplus">+      this.listener.onItemsAdded(actualItems, aCollection);</span>
<a href="#l45.162"></a><span id="l45.162" class="difflineplus">+  },</span>
<a href="#l45.163"></a><span id="l45.163" class="difflineplus">+  onItemsModified: function GlodaMsgSearcher_onItemsModified(aItems,</span>
<a href="#l45.164"></a><span id="l45.164" class="difflineplus">+                                                             aCollection) {</span>
<a href="#l45.165"></a><span id="l45.165" class="difflineplus">+    if (this.listener)</span>
<a href="#l45.166"></a><span id="l45.166" class="difflineplus">+      this.listener.onItemsModified(aItems, aCollection);</span>
<a href="#l45.167"></a><span id="l45.167">   },</span>
<a href="#l45.168"></a><span id="l45.168" class="difflineminus">-  onItemsModified: function GlodaMsgSearcher_onItemsModified() {},</span>
<a href="#l45.169"></a><span id="l45.169" class="difflineminus">-  onItemsRemoved: function GlodaMsgSearcher_onItemsRemoved() {},</span>
<a href="#l45.170"></a><span id="l45.170" class="difflineplus">+  onItemsRemoved: function GlodaMsgSearcher_onItemsRemoved(aItems,</span>
<a href="#l45.171"></a><span id="l45.171" class="difflineplus">+                                                           aCollection) {</span>
<a href="#l45.172"></a><span id="l45.172" class="difflineplus">+    if (this.listener)</span>
<a href="#l45.173"></a><span id="l45.173" class="difflineplus">+      this.listener.onItemsRemoved(aItems, aCollection);</span>
<a href="#l45.174"></a><span id="l45.174" class="difflineplus">+  },</span>
<a href="#l45.175"></a><span id="l45.175">   onQueryCompleted: function GlodaMsgSearcher_onQueryCompleted(aCollection) {</span>
<a href="#l45.176"></a><span id="l45.176" class="difflineminus">-    this.viewWrapper.onQueryCompleted(aCollection);</span>
<a href="#l45.177"></a><span id="l45.177" class="difflineplus">+    this.completed = true;</span>
<a href="#l45.178"></a><span id="l45.178" class="difflineplus">+    if (this.listener)</span>
<a href="#l45.179"></a><span id="l45.179" class="difflineplus">+      this.listener.onQueryCompleted(aCollection);</span>
<a href="#l45.180"></a><span id="l45.180">   },</span>
<a href="#l45.181"></a><span id="l45.181" class="difflineminus">-};</span>
<a href="#l45.182"></a><span id="l45.182">\ No newline at end of file</span>
<a href="#l45.183"></a><span id="l45.183" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mailnews/db/gloda/modules/noun_freetag.js</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/noun_freetag.js</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l46.4"></a><span id="l46.4"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l46.5"></a><span id="l46.5">  *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l46.6"></a><span id="l46.6">  *</span>
<a href="#l46.7"></a><span id="l46.7">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l46.8"></a><span id="l46.8">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l46.9"></a><span id="l46.9">  * the License. You may obtain a copy of the License at</span>
<a href="#l46.10"></a><span id="l46.10">  * http://www.mozilla.org/MPL/</span>
<a href="#l46.11"></a><span id="l46.11" class="difflineminus">- * </span>
<a href="#l46.12"></a><span id="l46.12" class="difflineplus">+ *</span>
<a href="#l46.13"></a><span id="l46.13">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l46.14"></a><span id="l46.14">  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l46.15"></a><span id="l46.15">  * for the specific language governing rights and limitations under the</span>
<a href="#l46.16"></a><span id="l46.16">  * License.</span>
<a href="#l46.17"></a><span id="l46.17">  *</span>
<a href="#l46.18"></a><span id="l46.18">  * The Original Code is Thunderbird Global Database.</span>
<a href="#l46.19"></a><span id="l46.19">  *</span>
<a href="#l46.20"></a><span id="l46.20">  * The Initial Developer of the Original Code is</span>
<a href="#l46.21"></a><span id="l46.21" class="difflineat">@@ -27,17 +27,17 @@</span>
<a href="#l46.22"></a><span id="l46.22">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l46.23"></a><span id="l46.23">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l46.24"></a><span id="l46.24">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l46.25"></a><span id="l46.25">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l46.26"></a><span id="l46.26">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l46.27"></a><span id="l46.27">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l46.28"></a><span id="l46.28">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l46.29"></a><span id="l46.29">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l46.30"></a><span id="l46.30" class="difflineminus">- * </span>
<a href="#l46.31"></a><span id="l46.31" class="difflineplus">+ *</span>
<a href="#l46.32"></a><span id="l46.32">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l46.33"></a><span id="l46.33"> </span>
<a href="#l46.34"></a><span id="l46.34"> EXPORTED_SYMBOLS = ['FreeTag', 'FreeTagNoun'];</span>
<a href="#l46.35"></a><span id="l46.35"> </span>
<a href="#l46.36"></a><span id="l46.36"> const Cc = Components.classes;</span>
<a href="#l46.37"></a><span id="l46.37"> const Ci = Components.interfaces;</span>
<a href="#l46.38"></a><span id="l46.38"> const Cr = Components.results;</span>
<a href="#l46.39"></a><span id="l46.39"> const Cu = Components.utils;</span>
<a href="#l46.40"></a><span id="l46.40" class="difflineat">@@ -59,54 +59,67 @@ FreeTag.prototype = {</span>
<a href="#l46.41"></a><span id="l46.41"> /**</span>
<a href="#l46.42"></a><span id="l46.42">  * @namespace Tag noun provider.  Since the tag unique value is stored as a</span>
<a href="#l46.43"></a><span id="l46.43">  *  parameter, we are an odd case and semantically confused.</span>
<a href="#l46.44"></a><span id="l46.44">  */</span>
<a href="#l46.45"></a><span id="l46.45"> var FreeTagNoun = {</span>
<a href="#l46.46"></a><span id="l46.46">   _log: Log4Moz.repository.getLogger(&quot;gloda.noun.freetag&quot;),</span>
<a href="#l46.47"></a><span id="l46.47"> </span>
<a href="#l46.48"></a><span id="l46.48">   name: &quot;freetag&quot;,</span>
<a href="#l46.49"></a><span id="l46.49" class="difflineminus">-  class: FreeTag,</span>
<a href="#l46.50"></a><span id="l46.50" class="difflineplus">+  clazz: FreeTag,</span>
<a href="#l46.51"></a><span id="l46.51">   allowsArbitraryAttrs: false,</span>
<a href="#l46.52"></a><span id="l46.52">   usesParameter: true,</span>
<a href="#l46.53"></a><span id="l46.53" class="difflineminus">-  </span>
<a href="#l46.54"></a><span id="l46.54" class="difflineplus">+</span>
<a href="#l46.55"></a><span id="l46.55">   _listeners: [],</span>
<a href="#l46.56"></a><span id="l46.56">   addListener: function(aListener) {</span>
<a href="#l46.57"></a><span id="l46.57">     this._listeners.push(aListener);</span>
<a href="#l46.58"></a><span id="l46.58">   },</span>
<a href="#l46.59"></a><span id="l46.59">   removeListener: function(aListener) {</span>
<a href="#l46.60"></a><span id="l46.60">     let index = this._listeners.indexOf(aListener);</span>
<a href="#l46.61"></a><span id="l46.61">     if (index &gt;=0)</span>
<a href="#l46.62"></a><span id="l46.62">       this._listeners.splice(index, 1);</span>
<a href="#l46.63"></a><span id="l46.63">   },</span>
<a href="#l46.64"></a><span id="l46.64" class="difflineminus">-  </span>
<a href="#l46.65"></a><span id="l46.65" class="difflineplus">+</span>
<a href="#l46.66"></a><span id="l46.66">   populateKnownFreeTags: function() {</span>
<a href="#l46.67"></a><span id="l46.67">     for each (let [,attr] in Iterator(this.objectNounOfAttributes)) {</span>
<a href="#l46.68"></a><span id="l46.68">       let attrDB = attr.dbDef;</span>
<a href="#l46.69"></a><span id="l46.69">       for (let param in attrDB.parameterBindings) {</span>
<a href="#l46.70"></a><span id="l46.70">         this.getFreeTag(param);</span>
<a href="#l46.71"></a><span id="l46.71">       }</span>
<a href="#l46.72"></a><span id="l46.72">     }</span>
<a href="#l46.73"></a><span id="l46.73">   },</span>
<a href="#l46.74"></a><span id="l46.74" class="difflineminus">-  </span>
<a href="#l46.75"></a><span id="l46.75" class="difflineplus">+</span>
<a href="#l46.76"></a><span id="l46.76">   knownFreeTags: {},</span>
<a href="#l46.77"></a><span id="l46.77">   getFreeTag: function(aTagName) {</span>
<a href="#l46.78"></a><span id="l46.78">     let tag = this.knownFreeTags[aTagName];</span>
<a href="#l46.79"></a><span id="l46.79">     if (!tag) {</span>
<a href="#l46.80"></a><span id="l46.80">       tag = this.knownFreeTags[aTagName] = new FreeTag(aTagName);</span>
<a href="#l46.81"></a><span id="l46.81">       for each (let [iListener, listener] in Iterator(this._listeners))</span>
<a href="#l46.82"></a><span id="l46.82">         listener.onFreeTagAdded(tag);</span>
<a href="#l46.83"></a><span id="l46.83">     }</span>
<a href="#l46.84"></a><span id="l46.84">     return tag;</span>
<a href="#l46.85"></a><span id="l46.85">   },</span>
<a href="#l46.86"></a><span id="l46.86"> </span>
<a href="#l46.87"></a><span id="l46.87" class="difflineplus">+  comparator: function gloda_noun_freetag_comparator(a, b) {</span>
<a href="#l46.88"></a><span id="l46.88" class="difflineplus">+    if (a == null) {</span>
<a href="#l46.89"></a><span id="l46.89" class="difflineplus">+      if (b == null)</span>
<a href="#l46.90"></a><span id="l46.90" class="difflineplus">+        return 0;</span>
<a href="#l46.91"></a><span id="l46.91" class="difflineplus">+      else</span>
<a href="#l46.92"></a><span id="l46.92" class="difflineplus">+        return 1;</span>
<a href="#l46.93"></a><span id="l46.93" class="difflineplus">+    }</span>
<a href="#l46.94"></a><span id="l46.94" class="difflineplus">+    else if (b == null) {</span>
<a href="#l46.95"></a><span id="l46.95" class="difflineplus">+      return -1;</span>
<a href="#l46.96"></a><span id="l46.96" class="difflineplus">+    }</span>
<a href="#l46.97"></a><span id="l46.97" class="difflineplus">+    return a.name.localeCompare(b.name);</span>
<a href="#l46.98"></a><span id="l46.98" class="difflineplus">+  },</span>
<a href="#l46.99"></a><span id="l46.99" class="difflineplus">+</span>
<a href="#l46.100"></a><span id="l46.100">   toParamAndValue: function gloda_noun_freetag_toParamAndValue(aTag) {</span>
<a href="#l46.101"></a><span id="l46.101">     return [aTag.name, null];</span>
<a href="#l46.102"></a><span id="l46.102">   },</span>
<a href="#l46.103"></a><span id="l46.103" class="difflineminus">-  </span>
<a href="#l46.104"></a><span id="l46.104" class="difflineplus">+</span>
<a href="#l46.105"></a><span id="l46.105">   toJSON: function gloda_noun_freetag_toJSON(aTag) {</span>
<a href="#l46.106"></a><span id="l46.106">     return aTag.name;</span>
<a href="#l46.107"></a><span id="l46.107">   },</span>
<a href="#l46.108"></a><span id="l46.108">   fromJSON: function gloda_noun_freetag_fromJSON(aTagName) {</span>
<a href="#l46.109"></a><span id="l46.109">     return this.getFreeTag(aTagName);</span>
<a href="#l46.110"></a><span id="l46.110">   },</span>
<a href="#l46.111"></a><span id="l46.111"> };</span>
<a href="#l46.112"></a><span id="l46.112"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mailnews/db/gloda/modules/noun_mimetype.js</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/noun_mimetype.js</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -38,33 +38,37 @@</span>
<a href="#l47.4"></a><span id="l47.4"> EXPORTED_SYMBOLS = ['MimeType', 'MimeTypeNoun'];</span>
<a href="#l47.5"></a><span id="l47.5"> </span>
<a href="#l47.6"></a><span id="l47.6"> const Cc = Components.classes;</span>
<a href="#l47.7"></a><span id="l47.7"> const Ci = Components.interfaces;</span>
<a href="#l47.8"></a><span id="l47.8"> const Cr = Components.results;</span>
<a href="#l47.9"></a><span id="l47.9"> const Cu = Components.utils;</span>
<a href="#l47.10"></a><span id="l47.10"> </span>
<a href="#l47.11"></a><span id="l47.11"> Cu.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineplus">+Cu.import(&quot;resource://app/modules/StringBundle.js&quot;);</span>
<a href="#l47.13"></a><span id="l47.13"> </span>
<a href="#l47.14"></a><span id="l47.14"> const LOG = Log4Moz.repository.getLogger(&quot;gloda.noun.mimetype&quot;);</span>
<a href="#l47.15"></a><span id="l47.15"> </span>
<a href="#l47.16"></a><span id="l47.16"> Cu.import(&quot;resource://app/modules/gloda/gloda.js&quot;);</span>
<a href="#l47.17"></a><span id="l47.17"> </span>
<a href="#l47.18"></a><span id="l47.18" class="difflineplus">+let CategoryStringMap = {};</span>
<a href="#l47.19"></a><span id="l47.19" class="difflineplus">+</span>
<a href="#l47.20"></a><span id="l47.20"> /**</span>
<a href="#l47.21"></a><span id="l47.21">  * Mime type abstraction that exists primarily so we can map mime types to</span>
<a href="#l47.22"></a><span id="l47.22">  *  integer id's.</span>
<a href="#l47.23"></a><span id="l47.23">  *</span>
<a href="#l47.24"></a><span id="l47.24">  * Instances of this class should only be retrieved via |MimeTypeNoun|; no one</span>
<a href="#l47.25"></a><span id="l47.25">  *  should ever create an instance directly.</span>
<a href="#l47.26"></a><span id="l47.26">  */</span>
<a href="#l47.27"></a><span id="l47.27" class="difflineminus">-function MimeType(aID, aType, aSubType, aFullType) {</span>
<a href="#l47.28"></a><span id="l47.28" class="difflineplus">+function MimeType(aID, aType, aSubType, aFullType, aCategory) {</span>
<a href="#l47.29"></a><span id="l47.29">   this._id = aID;</span>
<a href="#l47.30"></a><span id="l47.30">   this._type = aType;</span>
<a href="#l47.31"></a><span id="l47.31">   this._subType = aSubType;</span>
<a href="#l47.32"></a><span id="l47.32">   this._fullType = aFullType;</span>
<a href="#l47.33"></a><span id="l47.33" class="difflineplus">+  this._category = aCategory;</span>
<a href="#l47.34"></a><span id="l47.34"> }</span>
<a href="#l47.35"></a><span id="l47.35"> </span>
<a href="#l47.36"></a><span id="l47.36"> MimeType.prototype = {</span>
<a href="#l47.37"></a><span id="l47.37">   /**</span>
<a href="#l47.38"></a><span id="l47.38">    * The integer id we have associated with the mime type.  This is stable for</span>
<a href="#l47.39"></a><span id="l47.39">    *  the lifetime of the database, which means that anything in the Gloda</span>
<a href="#l47.40"></a><span id="l47.40">    *  database can use this without fear.  Things not persisted in the database</span>
<a href="#l47.41"></a><span id="l47.41">    *  should use the actual string mime type, retrieval via |fullType|.</span>
<a href="#l47.42"></a><span id="l47.42" class="difflineat">@@ -73,142 +77,315 @@ MimeType.prototype = {</span>
<a href="#l47.43"></a><span id="l47.43">   /**</span>
<a href="#l47.44"></a><span id="l47.44">    * The first part of the MIME type; &quot;text/plain&quot; gets you &quot;text&quot;.</span>
<a href="#l47.45"></a><span id="l47.45">    */</span>
<a href="#l47.46"></a><span id="l47.46">   get type() { return this._type; },</span>
<a href="#l47.47"></a><span id="l47.47">   set fullType(aFullType) {</span>
<a href="#l47.48"></a><span id="l47.48">     if (!this._fullType) {</span>
<a href="#l47.49"></a><span id="l47.49">       this._fullType = aFullType;</span>
<a href="#l47.50"></a><span id="l47.50">       [this._type, this._subType] = this._fullType.split(&quot;/&quot;);</span>
<a href="#l47.51"></a><span id="l47.51" class="difflineplus">+      this._category =</span>
<a href="#l47.52"></a><span id="l47.52" class="difflineplus">+        MimeTypeNoun._getCategoryForMimeType(aFullType, this._type);</span>
<a href="#l47.53"></a><span id="l47.53">     }</span>
<a href="#l47.54"></a><span id="l47.54">   },</span>
<a href="#l47.55"></a><span id="l47.55">   /**</span>
<a href="#l47.56"></a><span id="l47.56">    * If the |fullType| is &quot;text/plain&quot;, subType is &quot;plain&quot;.</span>
<a href="#l47.57"></a><span id="l47.57">    */</span>
<a href="#l47.58"></a><span id="l47.58">   get subType() { return this._subType; },</span>
<a href="#l47.59"></a><span id="l47.59">   /**</span>
<a href="#l47.60"></a><span id="l47.60">    * The full MIME type; &quot;text/plain&quot; returns &quot;text/plain&quot;.</span>
<a href="#l47.61"></a><span id="l47.61">    */</span>
<a href="#l47.62"></a><span id="l47.62">   get fullType() { return this._fullType; },</span>
<a href="#l47.63"></a><span id="l47.63">   toString: function () {</span>
<a href="#l47.64"></a><span id="l47.64">     return this.fullType;</span>
<a href="#l47.65"></a><span id="l47.65" class="difflineplus">+  },</span>
<a href="#l47.66"></a><span id="l47.66" class="difflineplus">+</span>
<a href="#l47.67"></a><span id="l47.67" class="difflineplus">+  /**</span>
<a href="#l47.68"></a><span id="l47.68" class="difflineplus">+   * @return the category we believe this mime type belongs to.  This category</span>
<a href="#l47.69"></a><span id="l47.69" class="difflineplus">+   *     name should never be shown directly to the user.  Instead, use</span>
<a href="#l47.70"></a><span id="l47.70" class="difflineplus">+   *     |categoryLabel| to get the localized name for the category.  The</span>
<a href="#l47.71"></a><span id="l47.71" class="difflineplus">+   *     category mapping comes from mimeTypesCategories.js.</span>
<a href="#l47.72"></a><span id="l47.72" class="difflineplus">+   */</span>
<a href="#l47.73"></a><span id="l47.73" class="difflineplus">+  get category() {</span>
<a href="#l47.74"></a><span id="l47.74" class="difflineplus">+    return this._category;</span>
<a href="#l47.75"></a><span id="l47.75" class="difflineplus">+  },</span>
<a href="#l47.76"></a><span id="l47.76" class="difflineplus">+  /**</span>
<a href="#l47.77"></a><span id="l47.77" class="difflineplus">+   * @return The localized label for the category from gloda.properties in the</span>
<a href="#l47.78"></a><span id="l47.78" class="difflineplus">+   *     &quot;gloda.mimetype.category.CATEGORY.label&quot; definition using the value</span>
<a href="#l47.79"></a><span id="l47.79" class="difflineplus">+   *     from |category|.</span>
<a href="#l47.80"></a><span id="l47.80" class="difflineplus">+   */</span>
<a href="#l47.81"></a><span id="l47.81" class="difflineplus">+  get categoryLabel() {</span>
<a href="#l47.82"></a><span id="l47.82" class="difflineplus">+    return CategoryStringMap[this._category];</span>
<a href="#l47.83"></a><span id="l47.83">   }</span>
<a href="#l47.84"></a><span id="l47.84"> };</span>
<a href="#l47.85"></a><span id="l47.85"> </span>
<a href="#l47.86"></a><span id="l47.86"> /**</span>
<a href="#l47.87"></a><span id="l47.87" class="difflineminus">- * @namespace Mime type noun provider.</span>
<a href="#l47.88"></a><span id="l47.88" class="difflineplus">+ * Mime type noun provider.</span>
<a href="#l47.89"></a><span id="l47.89">  *</span>
<a href="#l47.90"></a><span id="l47.90">  * The set of MIME Types is sufficiently limited that we can keep them all in</span>
<a href="#l47.91"></a><span id="l47.91">  *  memory.  In theory it is also sufficiently limited that we could use the</span>
<a href="#l47.92"></a><span id="l47.92">  *  parameter mechanism in the database.  However, it is more efficient, for</span>
<a href="#l47.93"></a><span id="l47.93">  *  both space and performance reasons, to store the specific mime type as a</span>
<a href="#l47.94"></a><span id="l47.94">  *  value.  For future-proofing reasons, we opt to use a database table to</span>
<a href="#l47.95"></a><span id="l47.95">  *  persist the mapping rather than a hard-coded list.  A preferences file or</span>
<a href="#l47.96"></a><span id="l47.96">  *  other text file would arguably suffice, but for consistency reasons, the</span>
<a href="#l47.97"></a><span id="l47.97">  *  database is not a bad thing.</span>
<a href="#l47.98"></a><span id="l47.98">  */</span>
<a href="#l47.99"></a><span id="l47.99"> var MimeTypeNoun = {</span>
<a href="#l47.100"></a><span id="l47.100">   name: &quot;mime-type&quot;,</span>
<a href="#l47.101"></a><span id="l47.101">   clazz: MimeType, // gloda supports clazz as well as class</span>
<a href="#l47.102"></a><span id="l47.102">   allowsArbitraryAttrs: false,</span>
<a href="#l47.103"></a><span id="l47.103"> </span>
<a href="#l47.104"></a><span id="l47.104" class="difflineplus">+  _strings: new StringBundle(&quot;chrome://messenger/locale/gloda.properties&quot;),</span>
<a href="#l47.105"></a><span id="l47.105" class="difflineplus">+</span>
<a href="#l47.106"></a><span id="l47.106">   // note! update test_noun_mimetype if you change our internals!</span>
<a href="#l47.107"></a><span id="l47.107">   _mimeTypes: {},</span>
<a href="#l47.108"></a><span id="l47.108">   _mimeTypesByID: {},</span>
<a href="#l47.109"></a><span id="l47.109" class="difflineminus">-  TYPE_BLOCK_SIZE: 8096, // bet you were expecting a power of 2!</span>
<a href="#l47.110"></a><span id="l47.110" class="difflineminus">-    // (we can fix this next time we bump the database schema version and have</span>
<a href="#l47.111"></a><span id="l47.111" class="difflineminus">-    //  to resort to blowing the database away.)</span>
<a href="#l47.112"></a><span id="l47.112" class="difflineplus">+  TYPE_BLOCK_SIZE: 16384,</span>
<a href="#l47.113"></a><span id="l47.113">   _mimeTypeHighID: {},</span>
<a href="#l47.114"></a><span id="l47.114" class="difflineplus">+  _mimeTypeRangeDummyObjects: {},</span>
<a href="#l47.115"></a><span id="l47.115">   _highID: 0,</span>
<a href="#l47.116"></a><span id="l47.116"> </span>
<a href="#l47.117"></a><span id="l47.117">   // we now use the exciting 'schema' mechanism of defineNoun to get our table</span>
<a href="#l47.118"></a><span id="l47.118">   //  created for us, plus some helper methods that we simply don't use.</span>
<a href="#l47.119"></a><span id="l47.119">   schema: {</span>
<a href="#l47.120"></a><span id="l47.120">     name: 'mimeTypes',</span>
<a href="#l47.121"></a><span id="l47.121">     columns: [['id', 'INTEGER PRIMARY KEY', '_id'],</span>
<a href="#l47.122"></a><span id="l47.122">               ['mimeType', 'TEXT', 'fullType']],</span>
<a href="#l47.123"></a><span id="l47.123">   },</span>
<a href="#l47.124"></a><span id="l47.124"> </span>
<a href="#l47.125"></a><span id="l47.125">   _init: function() {</span>
<a href="#l47.126"></a><span id="l47.126">     LOG.debug(&quot;loading MIME types&quot;);</span>
<a href="#l47.127"></a><span id="l47.127" class="difflineplus">+    this._loadCategoryMapping();</span>
<a href="#l47.128"></a><span id="l47.128">     this._loadMimeTypes();</span>
<a href="#l47.129"></a><span id="l47.129">   },</span>
<a href="#l47.130"></a><span id="l47.130"> </span>
<a href="#l47.131"></a><span id="l47.131" class="difflineminus">-  _loadMimeTypes: function() {</span>
<a href="#l47.132"></a><span id="l47.132" class="difflineplus">+  /**</span>
<a href="#l47.133"></a><span id="l47.133" class="difflineplus">+   * A map from MIME type to category name.</span>
<a href="#l47.134"></a><span id="l47.134" class="difflineplus">+   */</span>
<a href="#l47.135"></a><span id="l47.135" class="difflineplus">+  _mimeTypeToCategory: {},</span>
<a href="#l47.136"></a><span id="l47.136" class="difflineplus">+  /**</span>
<a href="#l47.137"></a><span id="l47.137" class="difflineplus">+   * Load the contents of mimeTypeCategories.js and populate</span>
<a href="#l47.138"></a><span id="l47.138" class="difflineplus">+   */</span>
<a href="#l47.139"></a><span id="l47.139" class="difflineplus">+  _loadCategoryMapping: function MimeTypeNoun__loadCategoryMapping() {</span>
<a href="#l47.140"></a><span id="l47.140" class="difflineplus">+    let mimecatNS = {};</span>
<a href="#l47.141"></a><span id="l47.141" class="difflineplus">+    Cu.import(&quot;resource://app/modules/gloda/mimeTypeCategories.js&quot;,</span>
<a href="#l47.142"></a><span id="l47.142" class="difflineplus">+              mimecatNS);</span>
<a href="#l47.143"></a><span id="l47.143" class="difflineplus">+    let mcm = mimecatNS.MimeCategoryMapping;</span>
<a href="#l47.144"></a><span id="l47.144" class="difflineplus">+</span>
<a href="#l47.145"></a><span id="l47.145" class="difflineplus">+    let mimeTypeToCategory = this._mimeTypeToCategory;</span>
<a href="#l47.146"></a><span id="l47.146" class="difflineplus">+</span>
<a href="#l47.147"></a><span id="l47.147" class="difflineplus">+    function procMapObj(aSubTree, aCategories) {</span>
<a href="#l47.148"></a><span id="l47.148" class="difflineplus">+      for each (let [key, value] in Iterator(aSubTree)) {</span>
<a href="#l47.149"></a><span id="l47.149" class="difflineplus">+        // Add this category to our nested categories list.  Use concat since</span>
<a href="#l47.150"></a><span id="l47.150" class="difflineplus">+        //  the list will be long-lived and each list needs to be distinct.</span>
<a href="#l47.151"></a><span id="l47.151" class="difflineplus">+        let categories = aCategories.concat();</span>
<a href="#l47.152"></a><span id="l47.152" class="difflineplus">+        categories.push(key);</span>
<a href="#l47.153"></a><span id="l47.153" class="difflineplus">+</span>
<a href="#l47.154"></a><span id="l47.154" class="difflineplus">+        if (categories.length == 1) {</span>
<a href="#l47.155"></a><span id="l47.155" class="difflineplus">+          CategoryStringMap[key] =</span>
<a href="#l47.156"></a><span id="l47.156" class="difflineplus">+            MimeTypeNoun._strings.get(</span>
<a href="#l47.157"></a><span id="l47.157" class="difflineplus">+              &quot;gloda.mimetype.category.&quot; + key + &quot;.label&quot;);</span>
<a href="#l47.158"></a><span id="l47.158" class="difflineplus">+        }</span>
<a href="#l47.159"></a><span id="l47.159" class="difflineplus">+</span>
<a href="#l47.160"></a><span id="l47.160" class="difflineplus">+        // Is it an array?  (We do not have isArray in 1.9.1 and since it comes</span>
<a href="#l47.161"></a><span id="l47.161" class="difflineplus">+        //  from another JS module, it has its own Array global, so instanceof</span>
<a href="#l47.162"></a><span id="l47.162" class="difflineplus">+        //  fails us.)  If it is, just process this depth</span>
<a href="#l47.163"></a><span id="l47.163" class="difflineplus">+        if (&quot;length&quot; in value) {</span>
<a href="#l47.164"></a><span id="l47.164" class="difflineplus">+          for each (let [, mimeTypeStr] in Iterator(value)) {</span>
<a href="#l47.165"></a><span id="l47.165" class="difflineplus">+            mimeTypeToCategory[mimeTypeStr] = categories;</span>
<a href="#l47.166"></a><span id="l47.166" class="difflineplus">+          }</span>
<a href="#l47.167"></a><span id="l47.167" class="difflineplus">+        }</span>
<a href="#l47.168"></a><span id="l47.168" class="difflineplus">+        // it's yet another sub-tree branch</span>
<a href="#l47.169"></a><span id="l47.169" class="difflineplus">+        else {</span>
<a href="#l47.170"></a><span id="l47.170" class="difflineplus">+          procMapObj(value, categories);</span>
<a href="#l47.171"></a><span id="l47.171" class="difflineplus">+        }</span>
<a href="#l47.172"></a><span id="l47.172" class="difflineplus">+      }</span>
<a href="#l47.173"></a><span id="l47.173" class="difflineplus">+    }</span>
<a href="#l47.174"></a><span id="l47.174" class="difflineplus">+</span>
<a href="#l47.175"></a><span id="l47.175" class="difflineplus">+    procMapObj(mimecatNS.MimeCategoryMapping, []);</span>
<a href="#l47.176"></a><span id="l47.176" class="difflineplus">+  },</span>
<a href="#l47.177"></a><span id="l47.177" class="difflineplus">+</span>
<a href="#l47.178"></a><span id="l47.178" class="difflineplus">+  /**</span>
<a href="#l47.179"></a><span id="l47.179" class="difflineplus">+   * Lookup the category associated with a MIME type given its full type and</span>
<a href="#l47.180"></a><span id="l47.180" class="difflineplus">+   *  type.  (So, &quot;foo/bar&quot; and &quot;foo&quot; for &quot;foo/bar&quot;.)</span>
<a href="#l47.181"></a><span id="l47.181" class="difflineplus">+   */</span>
<a href="#l47.182"></a><span id="l47.182" class="difflineplus">+  _getCategoryForMimeType:</span>
<a href="#l47.183"></a><span id="l47.183" class="difflineplus">+      function MimeTypeNoun__getCategoryForMimeType(aFullType, aType) {</span>
<a href="#l47.184"></a><span id="l47.184" class="difflineplus">+    if (aFullType in this._mimeTypeToCategory)</span>
<a href="#l47.185"></a><span id="l47.185" class="difflineplus">+      return this._mimeTypeToCategory[aFullType][0];</span>
<a href="#l47.186"></a><span id="l47.186" class="difflineplus">+    let wildType = aType + &quot;/*&quot;;</span>
<a href="#l47.187"></a><span id="l47.187" class="difflineplus">+    if (wildType in this._mimeTypeToCategory)</span>
<a href="#l47.188"></a><span id="l47.188" class="difflineplus">+      return this._mimeTypeToCategory[wildType][0];</span>
<a href="#l47.189"></a><span id="l47.189" class="difflineplus">+    return this._mimeTypeToCategory[&quot;*&quot;][0];</span>
<a href="#l47.190"></a><span id="l47.190" class="difflineplus">+  },</span>
<a href="#l47.191"></a><span id="l47.191" class="difflineplus">+</span>
<a href="#l47.192"></a><span id="l47.192" class="difflineplus">+  /**</span>
<a href="#l47.193"></a><span id="l47.193" class="difflineplus">+   * In order to allow the gloda query mechanism to avoid hitting the database,</span>
<a href="#l47.194"></a><span id="l47.194" class="difflineplus">+   *  we need to either define the noun type as cachable and have a super-large</span>
<a href="#l47.195"></a><span id="l47.195" class="difflineplus">+   *  cache or simply have a collection with every MIME type in it that stays</span>
<a href="#l47.196"></a><span id="l47.196" class="difflineplus">+   *  alive forever.</span>
<a href="#l47.197"></a><span id="l47.197" class="difflineplus">+   * This is that collection.  It is initialized by |_loadMimeTypes|.  As new</span>
<a href="#l47.198"></a><span id="l47.198" class="difflineplus">+   *  MIME types are created, we add them to the collection.</span>
<a href="#l47.199"></a><span id="l47.199" class="difflineplus">+   */</span>
<a href="#l47.200"></a><span id="l47.200" class="difflineplus">+  _universalCollection: null,</span>
<a href="#l47.201"></a><span id="l47.201" class="difflineplus">+</span>
<a href="#l47.202"></a><span id="l47.202" class="difflineplus">+  /**</span>
<a href="#l47.203"></a><span id="l47.203" class="difflineplus">+   * Kick off a query of all the mime types in our database, leaving</span>
<a href="#l47.204"></a><span id="l47.204" class="difflineplus">+   *  |_processMimeTypes| to actually do the legwork.</span>
<a href="#l47.205"></a><span id="l47.205" class="difflineplus">+   */</span>
<a href="#l47.206"></a><span id="l47.206" class="difflineplus">+  _loadMimeTypes: function MimeTypeNoun__loadMimeTypes() {</span>
<a href="#l47.207"></a><span id="l47.207">     // get all the existing mime types!</span>
<a href="#l47.208"></a><span id="l47.208">     let query = Gloda.newQuery(this.id);</span>
<a href="#l47.209"></a><span id="l47.209">     let nullFunc = function() {};</span>
<a href="#l47.210"></a><span id="l47.210" class="difflineminus">-    query.getCollection({</span>
<a href="#l47.211"></a><span id="l47.211" class="difflineminus">-      onItemsAdded: nullFunc, onItemsModified: nullFunc, onItemsRemoved: null,</span>
<a href="#l47.212"></a><span id="l47.212" class="difflineplus">+    this._universalCollection = query.getCollection({</span>
<a href="#l47.213"></a><span id="l47.213" class="difflineplus">+      onItemsAdded: nullFunc, onItemsModified: nullFunc,</span>
<a href="#l47.214"></a><span id="l47.214" class="difflineplus">+      onItemsRemoved: nullFunc,</span>
<a href="#l47.215"></a><span id="l47.215">       onQueryCompleted: function (aCollection) {</span>
<a href="#l47.216"></a><span id="l47.216">         MimeTypeNoun._processMimeTypes(aCollection.items);</span>
<a href="#l47.217"></a><span id="l47.217">       }</span>
<a href="#l47.218"></a><span id="l47.218" class="difflineminus">-    }, null).becomeExplicit();</span>
<a href="#l47.219"></a><span id="l47.219" class="difflineplus">+    }, null);</span>
<a href="#l47.220"></a><span id="l47.220">   },</span>
<a href="#l47.221"></a><span id="l47.221"> </span>
<a href="#l47.222"></a><span id="l47.222" class="difflineminus">-  _processMimeTypes: function(aMimeTypes) {</span>
<a href="#l47.223"></a><span id="l47.223" class="difflineplus">+  /**</span>
<a href="#l47.224"></a><span id="l47.224" class="difflineplus">+   * For the benefit of our Category queryHelper, we need dummy ranged objects</span>
<a href="#l47.225"></a><span id="l47.225" class="difflineplus">+   *  that cover the numerical address space allocated to the category.  We</span>
<a href="#l47.226"></a><span id="l47.226" class="difflineplus">+   *  can't use a real object for the upper-bound because the upper-bound is</span>
<a href="#l47.227"></a><span id="l47.227" class="difflineplus">+   *  constantly growing and there is the chance the query might get persisted,</span>
<a href="#l47.228"></a><span id="l47.228" class="difflineplus">+   *  which means these values need to be long-lived.  Unfortunately, our</span>
<a href="#l47.229"></a><span id="l47.229" class="difflineplus">+   *  solution to this problem (dummy objects) complicates the second case,</span>
<a href="#l47.230"></a><span id="l47.230" class="difflineplus">+   *  should it ever occur.  (Because the dummy objects cannot be persisted</span>
<a href="#l47.231"></a><span id="l47.231" class="difflineplus">+   *  on their own... but there are other issues that will come up that we will</span>
<a href="#l47.232"></a><span id="l47.232" class="difflineplus">+   *  just have to deal with then.)</span>
<a href="#l47.233"></a><span id="l47.233" class="difflineplus">+   */</span>
<a href="#l47.234"></a><span id="l47.234" class="difflineplus">+  _createCategoryDummies: function (aId, aCategory) {</span>
<a href="#l47.235"></a><span id="l47.235" class="difflineplus">+    let blockBottom = aId - (aId % this.TYPE_BLOCK_SIZE);</span>
<a href="#l47.236"></a><span id="l47.236" class="difflineplus">+    let blockTop = blockBottom + this.TYPE_BLOCK_SIZE - 1;</span>
<a href="#l47.237"></a><span id="l47.237" class="difflineplus">+    this._mimeTypeRangeDummyObjects[aCategory] = [</span>
<a href="#l47.238"></a><span id="l47.238" class="difflineplus">+      new MimeType(blockBottom, &quot;!category-dummy!&quot;, aCategory,</span>
<a href="#l47.239"></a><span id="l47.239" class="difflineplus">+                   &quot;!category-dummy!/&quot; + aCategory, aCategory),</span>
<a href="#l47.240"></a><span id="l47.240" class="difflineplus">+      new MimeType(blockTop, &quot;!category-dummy!&quot;, aCategory,</span>
<a href="#l47.241"></a><span id="l47.241" class="difflineplus">+                   &quot;!category-dummy!/&quot; + aCategory, aCategory)</span>
<a href="#l47.242"></a><span id="l47.242" class="difflineplus">+    ];</span>
<a href="#l47.243"></a><span id="l47.243" class="difflineplus">+  },</span>
<a href="#l47.244"></a><span id="l47.244" class="difflineplus">+</span>
<a href="#l47.245"></a><span id="l47.245" class="difflineplus">+  _processMimeTypes: function MimeTypeNoun__processMimeTypes(aMimeTypes) {</span>
<a href="#l47.246"></a><span id="l47.246">     for each (let [, mimeType] in Iterator(aMimeTypes)) {</span>
<a href="#l47.247"></a><span id="l47.247">       if (mimeType.id &gt; this._highID)</span>
<a href="#l47.248"></a><span id="l47.248">         this._highID = mimeType.id;</span>
<a href="#l47.249"></a><span id="l47.249">       this._mimeTypes[mimeType] = mimeType;</span>
<a href="#l47.250"></a><span id="l47.250">       this._mimeTypesByID[mimeType.id] = mimeType;</span>
<a href="#l47.251"></a><span id="l47.251"> </span>
<a href="#l47.252"></a><span id="l47.252">       let typeBlock = mimeType.id - (mimeType.id % this.TYPE_BLOCK_SIZE);</span>
<a href="#l47.253"></a><span id="l47.253" class="difflineminus">-      let blockHighID = this._mimeTypeHighID[mimeType.type];</span>
<a href="#l47.254"></a><span id="l47.254" class="difflineplus">+      let blockHighID = (mimeType.category in this._mimeTypeHighID) ?</span>
<a href="#l47.255"></a><span id="l47.255" class="difflineplus">+                          this._mimeTypeHighID[mimeType.category] : undefined;</span>
<a href="#l47.256"></a><span id="l47.256" class="difflineplus">+      // create the dummy range objects</span>
<a href="#l47.257"></a><span id="l47.257" class="difflineplus">+      if (blockHighID === undefined)</span>
<a href="#l47.258"></a><span id="l47.258" class="difflineplus">+        this._createCategoryDummies(mimeType.id, mimeType.category);</span>
<a href="#l47.259"></a><span id="l47.259">       if ((blockHighID === undefined) || mimeType.id &gt; blockHighID)</span>
<a href="#l47.260"></a><span id="l47.260" class="difflineminus">-        this._mimeTypeHighID[mimeType.type] = mimeType.id;</span>
<a href="#l47.261"></a><span id="l47.261" class="difflineplus">+        this._mimeTypeHighID[mimeType.category] = mimeType.id;</span>
<a href="#l47.262"></a><span id="l47.262">     }</span>
<a href="#l47.263"></a><span id="l47.263">   },</span>
<a href="#l47.264"></a><span id="l47.264"> </span>
<a href="#l47.265"></a><span id="l47.265" class="difflineminus">-  _addNewMimeType: function(aMimeTypeName) {</span>
<a href="#l47.266"></a><span id="l47.266" class="difflineplus">+  _addNewMimeType: function MimeTypeNoun__addNewMimeType(aMimeTypeName) {</span>
<a href="#l47.267"></a><span id="l47.267">     let [typeName, subTypeName] = aMimeTypeName.split(&quot;/&quot;);</span>
<a href="#l47.268"></a><span id="l47.268" class="difflineplus">+    let category = this._getCategoryForMimeType(aMimeTypeName, typeName);</span>
<a href="#l47.269"></a><span id="l47.269"> </span>
<a href="#l47.270"></a><span id="l47.270" class="difflineminus">-    if (!(typeName in this._mimeTypeHighID)) {</span>
<a href="#l47.271"></a><span id="l47.271" class="difflineplus">+    if (!(category in this._mimeTypeHighID)) {</span>
<a href="#l47.272"></a><span id="l47.272">       let nextID = this._highID - (this._highID % this.TYPE_BLOCK_SIZE) +</span>
<a href="#l47.273"></a><span id="l47.273">         this.TYPE_BLOCK_SIZE;</span>
<a href="#l47.274"></a><span id="l47.274" class="difflineminus">-      this._mimeTypeHighID[typeName] = nextID;</span>
<a href="#l47.275"></a><span id="l47.275" class="difflineplus">+      this._mimeTypeHighID[category] = nextID;</span>
<a href="#l47.276"></a><span id="l47.276" class="difflineplus">+      this._createCategoryDummies(nextID, category);</span>
<a href="#l47.277"></a><span id="l47.277">     }</span>
<a href="#l47.278"></a><span id="l47.278"> </span>
<a href="#l47.279"></a><span id="l47.279" class="difflineminus">-    let nextID = ++this._mimeTypeHighID[typeName];</span>
<a href="#l47.280"></a><span id="l47.280" class="difflineplus">+    let nextID = ++this._mimeTypeHighID[category];</span>
<a href="#l47.281"></a><span id="l47.281"> </span>
<a href="#l47.282"></a><span id="l47.282" class="difflineminus">-    let mimeType = new MimeType(nextID, typeName, subTypeName, aMimeTypeName);</span>
<a href="#l47.283"></a><span id="l47.283" class="difflineplus">+    let mimeType = new MimeType(nextID, typeName, subTypeName, aMimeTypeName,</span>
<a href="#l47.284"></a><span id="l47.284" class="difflineplus">+                                category);</span>
<a href="#l47.285"></a><span id="l47.285">     if (mimeType.id &gt; this._highID)</span>
<a href="#l47.286"></a><span id="l47.286">       this._highID = mimeType.id;</span>
<a href="#l47.287"></a><span id="l47.287"> </span>
<a href="#l47.288"></a><span id="l47.288">     this._mimeTypes[aMimeTypeName] = mimeType;</span>
<a href="#l47.289"></a><span id="l47.289">     this._mimeTypesByID[nextID] = mimeType;</span>
<a href="#l47.290"></a><span id="l47.290"> </span>
<a href="#l47.291"></a><span id="l47.291" class="difflineminus">-    // as great as the gloda extension mechanisms are, we don't think it makes</span>
<a href="#l47.292"></a><span id="l47.292" class="difflineplus">+    // As great as the gloda extension mechanisms are, we don't think it makes</span>
<a href="#l47.293"></a><span id="l47.293">     //  a lot of sense to use them in this case.  So we directly trigger object</span>
<a href="#l47.294"></a><span id="l47.294">     //  insertion without any of the grokNounItem stuff.</span>
<a href="#l47.295"></a><span id="l47.295">     this.objInsert.call(this.datastore, mimeType);</span>
<a href="#l47.296"></a><span id="l47.296" class="difflineplus">+    // Since we bypass grokNounItem and its fun, we need to explicitly add the</span>
<a href="#l47.297"></a><span id="l47.297" class="difflineplus">+    //  new MIME-type to _universalCollection ourselves.  Don't try this at</span>
<a href="#l47.298"></a><span id="l47.298" class="difflineplus">+    //  home, kids.</span>
<a href="#l47.299"></a><span id="l47.299" class="difflineplus">+    this._universalCollection._onItemsAdded([mimeType]);</span>
<a href="#l47.300"></a><span id="l47.300"> </span>
<a href="#l47.301"></a><span id="l47.301">     return mimeType;</span>
<a href="#l47.302"></a><span id="l47.302">   },</span>
<a href="#l47.303"></a><span id="l47.303"> </span>
<a href="#l47.304"></a><span id="l47.304">   /**</span>
<a href="#l47.305"></a><span id="l47.305">    * Map a mime type to a |MimeType| instance, creating it if necessary.</span>
<a href="#l47.306"></a><span id="l47.306">    *</span>
<a href="#l47.307"></a><span id="l47.307">    * @param aMimeTypeName The mime type.  It may optionally include parameters</span>
<a href="#l47.308"></a><span id="l47.308">    *     (which will be ignored).  A mime type is of the form &quot;type/subtype&quot;.</span>
<a href="#l47.309"></a><span id="l47.309">    *     A type with parameters would look like 'type/subtype; param=&quot;value&quot;'.</span>
<a href="#l47.310"></a><span id="l47.310">    */</span>
<a href="#l47.311"></a><span id="l47.311" class="difflineminus">-  getMimeType: function(aMimeTypeName) {</span>
<a href="#l47.312"></a><span id="l47.312" class="difflineplus">+  getMimeType: function MimeTypeNoun_getMimeType(aMimeTypeName) {</span>
<a href="#l47.313"></a><span id="l47.313">     // first, lose any parameters</span>
<a href="#l47.314"></a><span id="l47.314">     let semiIndex = aMimeTypeName.indexOf(&quot;;&quot;);</span>
<a href="#l47.315"></a><span id="l47.315">     if (semiIndex &gt;= 0)</span>
<a href="#l47.316"></a><span id="l47.316">       aMimeTypeName = aMimeTypeName.substring(0, semiIndex);</span>
<a href="#l47.317"></a><span id="l47.317">     aMimeTypeName = aMimeTypeName.trim().toLowerCase();</span>
<a href="#l47.318"></a><span id="l47.318"> </span>
<a href="#l47.319"></a><span id="l47.319">     if (aMimeTypeName in this._mimeTypes)</span>
<a href="#l47.320"></a><span id="l47.320">       return this._mimeTypes[aMimeTypeName];</span>
<a href="#l47.321"></a><span id="l47.321">     else</span>
<a href="#l47.322"></a><span id="l47.322">       return this._addNewMimeType(aMimeTypeName);</span>
<a href="#l47.323"></a><span id="l47.323">   },</span>
<a href="#l47.324"></a><span id="l47.324"> </span>
<a href="#l47.325"></a><span id="l47.325" class="difflineplus">+  /**</span>
<a href="#l47.326"></a><span id="l47.326" class="difflineplus">+   * Query helpers contribute additional functions to the query object for the</span>
<a href="#l47.327"></a><span id="l47.327" class="difflineplus">+   *  attributes that use the noun type.  For example, we define Category, so</span>
<a href="#l47.328"></a><span id="l47.328" class="difflineplus">+   *  for the &quot;attachmentTypes&quot; attribute, &quot;attachmentTypesCategory&quot; would be</span>
<a href="#l47.329"></a><span id="l47.329" class="difflineplus">+   *  exposed.</span>
<a href="#l47.330"></a><span id="l47.330" class="difflineplus">+   */</span>
<a href="#l47.331"></a><span id="l47.331" class="difflineplus">+  queryHelpers: {</span>
<a href="#l47.332"></a><span id="l47.332" class="difflineplus">+    /**</span>
<a href="#l47.333"></a><span id="l47.333" class="difflineplus">+     * Query for MIME type categories based on one or more MIME type objects</span>
<a href="#l47.334"></a><span id="l47.334" class="difflineplus">+     *  passed in.  We want the range to span the entire block allocated to the</span>
<a href="#l47.335"></a><span id="l47.335" class="difflineplus">+     *  category.</span>
<a href="#l47.336"></a><span id="l47.336" class="difflineplus">+     *</span>
<a href="#l47.337"></a><span id="l47.337" class="difflineplus">+     * @param aAttrDef The attribute that is using us.</span>
<a href="#l47.338"></a><span id="l47.338" class="difflineplus">+     * @param aArguments The actual arguments object that</span>
<a href="#l47.339"></a><span id="l47.339" class="difflineplus">+     */</span>
<a href="#l47.340"></a><span id="l47.340" class="difflineplus">+    Category: function(aAttrDef, aArguments) {</span>
<a href="#l47.341"></a><span id="l47.341" class="difflineplus">+      let rangePairs = [];</span>
<a href="#l47.342"></a><span id="l47.342" class="difflineplus">+      // If there are no arguments then we want to fall back to the 'in'</span>
<a href="#l47.343"></a><span id="l47.343" class="difflineplus">+      //  constraint which matches on any attachment.</span>
<a href="#l47.344"></a><span id="l47.344" class="difflineplus">+      if (aArguments.length == 0)</span>
<a href="#l47.345"></a><span id="l47.345" class="difflineplus">+        return this._inConstraintHelper(aAttrDef, []);</span>
<a href="#l47.346"></a><span id="l47.346" class="difflineplus">+</span>
<a href="#l47.347"></a><span id="l47.347" class="difflineplus">+      for (let iArg = 0; iArg &lt; aArguments.length; iArg++) {</span>
<a href="#l47.348"></a><span id="l47.348" class="difflineplus">+        let arg = aArguments[iArg];</span>
<a href="#l47.349"></a><span id="l47.349" class="difflineplus">+        rangePairs.push(MimeTypeNoun._mimeTypeRangeDummyObjects[arg.category]);</span>
<a href="#l47.350"></a><span id="l47.350" class="difflineplus">+      }</span>
<a href="#l47.351"></a><span id="l47.351" class="difflineplus">+      return this._rangedConstraintHelper(aAttrDef, rangePairs);</span>
<a href="#l47.352"></a><span id="l47.352" class="difflineplus">+    }</span>
<a href="#l47.353"></a><span id="l47.353" class="difflineplus">+  },</span>
<a href="#l47.354"></a><span id="l47.354" class="difflineplus">+</span>
<a href="#l47.355"></a><span id="l47.355" class="difflineplus">+  comparator: function gloda_noun_mimeType_comparator(a, b) {</span>
<a href="#l47.356"></a><span id="l47.356" class="difflineplus">+    if (a == null) {</span>
<a href="#l47.357"></a><span id="l47.357" class="difflineplus">+      if (b == null)</span>
<a href="#l47.358"></a><span id="l47.358" class="difflineplus">+        return 0;</span>
<a href="#l47.359"></a><span id="l47.359" class="difflineplus">+      else</span>
<a href="#l47.360"></a><span id="l47.360" class="difflineplus">+        return 1;</span>
<a href="#l47.361"></a><span id="l47.361" class="difflineplus">+    }</span>
<a href="#l47.362"></a><span id="l47.362" class="difflineplus">+    else if (b == null) {</span>
<a href="#l47.363"></a><span id="l47.363" class="difflineplus">+      return -1;</span>
<a href="#l47.364"></a><span id="l47.364" class="difflineplus">+    }</span>
<a href="#l47.365"></a><span id="l47.365" class="difflineplus">+    return a.fullType.localeCompare(b.fullType);</span>
<a href="#l47.366"></a><span id="l47.366" class="difflineplus">+  },</span>
<a href="#l47.367"></a><span id="l47.367" class="difflineplus">+</span>
<a href="#l47.368"></a><span id="l47.368">   toParamAndValue: function gloda_noun_mimeType_toParamAndValue(aMimeType) {</span>
<a href="#l47.369"></a><span id="l47.369">     return [null, aMimeType.id];</span>
<a href="#l47.370"></a><span id="l47.370">   },</span>
<a href="#l47.371"></a><span id="l47.371">   toJSON: function gloda_noun_mimeType_toJSON(aMimeType) {</span>
<a href="#l47.372"></a><span id="l47.372">     return aMimeType.id;</span>
<a href="#l47.373"></a><span id="l47.373">   },</span>
<a href="#l47.374"></a><span id="l47.374">   fromJSON: function gloda_noun_mimeType_fromJSON(aMimeTypeID) {</span>
<a href="#l47.375"></a><span id="l47.375">     return this._mimeTypesByID[aMimeTypeID];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mailnews/db/gloda/modules/noun_tag.js</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/noun_tag.js</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l48.4"></a><span id="l48.4"> /* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l48.5"></a><span id="l48.5">  *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l48.6"></a><span id="l48.6">  *</span>
<a href="#l48.7"></a><span id="l48.7">  * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l48.8"></a><span id="l48.8">  * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l48.9"></a><span id="l48.9">  * the License. You may obtain a copy of the License at</span>
<a href="#l48.10"></a><span id="l48.10">  * http://www.mozilla.org/MPL/</span>
<a href="#l48.11"></a><span id="l48.11" class="difflineminus">- * </span>
<a href="#l48.12"></a><span id="l48.12" class="difflineplus">+ *</span>
<a href="#l48.13"></a><span id="l48.13">  * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l48.14"></a><span id="l48.14">  * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l48.15"></a><span id="l48.15">  * for the specific language governing rights and limitations under the</span>
<a href="#l48.16"></a><span id="l48.16">  * License.</span>
<a href="#l48.17"></a><span id="l48.17">  *</span>
<a href="#l48.18"></a><span id="l48.18">  * The Original Code is Thunderbird Global Database.</span>
<a href="#l48.19"></a><span id="l48.19">  *</span>
<a href="#l48.20"></a><span id="l48.20">  * The Initial Developer of the Original Code is</span>
<a href="#l48.21"></a><span id="l48.21" class="difflineat">@@ -27,60 +27,77 @@</span>
<a href="#l48.22"></a><span id="l48.22">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l48.23"></a><span id="l48.23">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l48.24"></a><span id="l48.24">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l48.25"></a><span id="l48.25">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l48.26"></a><span id="l48.26">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l48.27"></a><span id="l48.27">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l48.28"></a><span id="l48.28">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l48.29"></a><span id="l48.29">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l48.30"></a><span id="l48.30" class="difflineminus">- * </span>
<a href="#l48.31"></a><span id="l48.31" class="difflineplus">+ *</span>
<a href="#l48.32"></a><span id="l48.32">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l48.33"></a><span id="l48.33"> </span>
<a href="#l48.34"></a><span id="l48.34"> EXPORTED_SYMBOLS = ['TagNoun'];</span>
<a href="#l48.35"></a><span id="l48.35"> </span>
<a href="#l48.36"></a><span id="l48.36"> const Cc = Components.classes;</span>
<a href="#l48.37"></a><span id="l48.37"> const Ci = Components.interfaces;</span>
<a href="#l48.38"></a><span id="l48.38"> const Cr = Components.results;</span>
<a href="#l48.39"></a><span id="l48.39"> const Cu = Components.utils;</span>
<a href="#l48.40"></a><span id="l48.40"> </span>
<a href="#l48.41"></a><span id="l48.41"> Cu.import(&quot;resource://app/modules/gloda/gloda.js&quot;);</span>
<a href="#l48.42"></a><span id="l48.42"> </span>
<a href="#l48.43"></a><span id="l48.43"> /**</span>
<a href="#l48.44"></a><span id="l48.44">  * @namespace Tag noun provider.</span>
<a href="#l48.45"></a><span id="l48.45">  */</span>
<a href="#l48.46"></a><span id="l48.46"> var TagNoun = {</span>
<a href="#l48.47"></a><span id="l48.47">   name: &quot;tag&quot;,</span>
<a href="#l48.48"></a><span id="l48.48" class="difflineminus">-  class: Ci.nsIMsgTag,</span>
<a href="#l48.49"></a><span id="l48.49" class="difflineplus">+  clazz: Ci.nsIMsgTag,</span>
<a href="#l48.50"></a><span id="l48.50">   usesParameter: true,</span>
<a href="#l48.51"></a><span id="l48.51">   allowsArbitraryAttrs: false,</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineplus">+  idAttr: &quot;key&quot;,</span>
<a href="#l48.53"></a><span id="l48.53">   _msgTagService: null,</span>
<a href="#l48.54"></a><span id="l48.54">   _tagMap: null,</span>
<a href="#l48.55"></a><span id="l48.55" class="difflineminus">-  </span>
<a href="#l48.56"></a><span id="l48.56" class="difflineplus">+</span>
<a href="#l48.57"></a><span id="l48.57">   _init: function () {</span>
<a href="#l48.58"></a><span id="l48.58">     this._msgTagService = Cc[&quot;@mozilla.org/messenger/tagservice;1&quot;].</span>
<a href="#l48.59"></a><span id="l48.59">                           getService(Ci.nsIMsgTagService);</span>
<a href="#l48.60"></a><span id="l48.60">     this._updateTagMap();</span>
<a href="#l48.61"></a><span id="l48.61">   },</span>
<a href="#l48.62"></a><span id="l48.62" class="difflineminus">-  </span>
<a href="#l48.63"></a><span id="l48.63" class="difflineplus">+</span>
<a href="#l48.64"></a><span id="l48.64">   getAllTags: function gloda_noun_tag_getAllTags() {</span>
<a href="#l48.65"></a><span id="l48.65">     return this._msgTagService.getAllTags({});</span>
<a href="#l48.66"></a><span id="l48.66">   },</span>
<a href="#l48.67"></a><span id="l48.67" class="difflineminus">-  </span>
<a href="#l48.68"></a><span id="l48.68" class="difflineplus">+</span>
<a href="#l48.69"></a><span id="l48.69">   _updateTagMap: function gloda_noun_tag_updateTagMap() {</span>
<a href="#l48.70"></a><span id="l48.70">     this._tagMap = {};</span>
<a href="#l48.71"></a><span id="l48.71">     let tagArray = this._msgTagService.getAllTags({});</span>
<a href="#l48.72"></a><span id="l48.72">     for (let iTag = 0; iTag &lt; tagArray.length; iTag++) {</span>
<a href="#l48.73"></a><span id="l48.73">       let tag = tagArray[iTag];</span>
<a href="#l48.74"></a><span id="l48.74">       this._tagMap[tag.key] = tag;</span>
<a href="#l48.75"></a><span id="l48.75">     }</span>
<a href="#l48.76"></a><span id="l48.76">   },</span>
<a href="#l48.77"></a><span id="l48.77" class="difflineminus">-  </span>
<a href="#l48.78"></a><span id="l48.78" class="difflineplus">+</span>
<a href="#l48.79"></a><span id="l48.79" class="difflineplus">+  comparator: function gloda_noun_tag_comparator(a, b) {</span>
<a href="#l48.80"></a><span id="l48.80" class="difflineplus">+    if (a == null) {</span>
<a href="#l48.81"></a><span id="l48.81" class="difflineplus">+      if (b == null)</span>
<a href="#l48.82"></a><span id="l48.82" class="difflineplus">+        return 0;</span>
<a href="#l48.83"></a><span id="l48.83" class="difflineplus">+      else</span>
<a href="#l48.84"></a><span id="l48.84" class="difflineplus">+        return 1;</span>
<a href="#l48.85"></a><span id="l48.85" class="difflineplus">+    }</span>
<a href="#l48.86"></a><span id="l48.86" class="difflineplus">+    else if (b == null) {</span>
<a href="#l48.87"></a><span id="l48.87" class="difflineplus">+      return -1;</span>
<a href="#l48.88"></a><span id="l48.88" class="difflineplus">+    }</span>
<a href="#l48.89"></a><span id="l48.89" class="difflineplus">+    return a.tag.localeCompare(b.tag);</span>
<a href="#l48.90"></a><span id="l48.90" class="difflineplus">+  },</span>
<a href="#l48.91"></a><span id="l48.91" class="difflineplus">+  userVisibleString: function gloda_noun_tag_userVisibleString(aTag) {</span>
<a href="#l48.92"></a><span id="l48.92" class="difflineplus">+    return aTag.tag;</span>
<a href="#l48.93"></a><span id="l48.93" class="difflineplus">+  },</span>
<a href="#l48.94"></a><span id="l48.94" class="difflineplus">+</span>
<a href="#l48.95"></a><span id="l48.95">   // we cannot be an attribute value</span>
<a href="#l48.96"></a><span id="l48.96" class="difflineminus">-  </span>
<a href="#l48.97"></a><span id="l48.97" class="difflineplus">+</span>
<a href="#l48.98"></a><span id="l48.98">   toParamAndValue: function gloda_noun_tag_toParamAndValue(aTag) {</span>
<a href="#l48.99"></a><span id="l48.99">     return [aTag.key, null];</span>
<a href="#l48.100"></a><span id="l48.100">   },</span>
<a href="#l48.101"></a><span id="l48.101">   toJSON: function gloda_noun_tag_toJSON(aTag) {</span>
<a href="#l48.102"></a><span id="l48.102">     return aTag.key;</span>
<a href="#l48.103"></a><span id="l48.103">   },</span>
<a href="#l48.104"></a><span id="l48.104">   fromJSON: function gloda_noun_tag_fromJSON(aTagKey, aIgnored) {</span>
<a href="#l48.105"></a><span id="l48.105">     let tag = this._tagMap[aTagKey];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mailnews/db/gloda/modules/query.js</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/query.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -130,16 +130,17 @@ GlodaQueryClass.prototype = {</span>
<a href="#l49.4"></a><span id="l49.4">    * Return a collection asynchronously populated by this collection.  You must</span>
<a href="#l49.5"></a><span id="l49.5">    *  provide a listener to receive notifications from the collection as it</span>
<a href="#l49.6"></a><span id="l49.6">    *  receives updates.  The listener object should implement onItemsAdded,</span>
<a href="#l49.7"></a><span id="l49.7">    *  onItemsModified, and onItemsRemoved methods, all of which take a single</span>
<a href="#l49.8"></a><span id="l49.8">    *  argument which is the list of items which have been added, modified, or</span>
<a href="#l49.9"></a><span id="l49.9">    *  removed respectively.</span>
<a href="#l49.10"></a><span id="l49.10">    */</span>
<a href="#l49.11"></a><span id="l49.11">   getCollection: function gloda_query_getCollection(aListener, aData) {</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineplus">+    this.completed = false;</span>
<a href="#l49.13"></a><span id="l49.13">     return this._nounDef.datastore.queryFromQuery(this, aListener, aData);</span>
<a href="#l49.14"></a><span id="l49.14">   },</span>
<a href="#l49.15"></a><span id="l49.15"> </span>
<a href="#l49.16"></a><span id="l49.16">   /**</span>
<a href="#l49.17"></a><span id="l49.17">    * Test whether the given first-class noun instance satisfies this query.</span>
<a href="#l49.18"></a><span id="l49.18">    *</span>
<a href="#l49.19"></a><span id="l49.19">    * @testpoint gloda.query.test</span>
<a href="#l49.20"></a><span id="l49.20">    */</span>
<a href="#l49.21"></a><span id="l49.21" class="difflineat">@@ -152,16 +153,17 @@ GlodaQueryClass.prototype = {</span>
<a href="#l49.22"></a><span id="l49.22">       let curQuery = unionQueries[iUnion];</span>
<a href="#l49.23"></a><span id="l49.23"> </span>
<a href="#l49.24"></a><span id="l49.24">       // assume success until a specific (or) constraint proves us wrong</span>
<a href="#l49.25"></a><span id="l49.25">       let querySatisfied = true;</span>
<a href="#l49.26"></a><span id="l49.26">       for (let iConstraint = 0; iConstraint &lt; curQuery._constraints.length;</span>
<a href="#l49.27"></a><span id="l49.27">            iConstraint++) {</span>
<a href="#l49.28"></a><span id="l49.28">         let constraint = curQuery._constraints[iConstraint];</span>
<a href="#l49.29"></a><span id="l49.29">         let [constraintType, attrDef] = constraint;</span>
<a href="#l49.30"></a><span id="l49.30" class="difflineplus">+        let boundName = attrDef ? attrDef.boundName : &quot;id&quot;;</span>
<a href="#l49.31"></a><span id="l49.31">         let constraintValues = constraint.slice(2);</span>
<a href="#l49.32"></a><span id="l49.32"> </span>
<a href="#l49.33"></a><span id="l49.33">         if (constraintType === GlodaDatastore.kConstraintIdIn) {</span>
<a href="#l49.34"></a><span id="l49.34">           if (constraintValues.indexOf(aObj.id) == -1) {</span>
<a href="#l49.35"></a><span id="l49.35">             querySatisfied = false;</span>
<a href="#l49.36"></a><span id="l49.36">             break;</span>
<a href="#l49.37"></a><span id="l49.37">           }</span>
<a href="#l49.38"></a><span id="l49.38">         }</span>
<a href="#l49.39"></a><span id="l49.39" class="difflineat">@@ -171,20 +173,28 @@ GlodaQueryClass.prototype = {</span>
<a href="#l49.40"></a><span id="l49.40">           let objectNounDef = attrDef.objectNounDef;</span>
<a href="#l49.41"></a><span id="l49.41"> </span>
<a href="#l49.42"></a><span id="l49.42">           // if they provide an equals comparator, use that.</span>
<a href="#l49.43"></a><span id="l49.43">           // (note: the next case has better optimization possibilities than</span>
<a href="#l49.44"></a><span id="l49.44">           //  this mechanism, but of course has higher initialization costs or</span>
<a href="#l49.45"></a><span id="l49.45">           //  code complexity costs...)</span>
<a href="#l49.46"></a><span id="l49.46">           if (objectNounDef.equals) {</span>
<a href="#l49.47"></a><span id="l49.47">             let testValues;</span>
<a href="#l49.48"></a><span id="l49.48" class="difflineminus">-            if (attrDef.singular)</span>
<a href="#l49.49"></a><span id="l49.49" class="difflineminus">-              testValues = [aObj[attrDef.boundName]];</span>
<a href="#l49.50"></a><span id="l49.50" class="difflineplus">+            if (!(boundName in aObj))</span>
<a href="#l49.51"></a><span id="l49.51" class="difflineplus">+              testValues = [];</span>
<a href="#l49.52"></a><span id="l49.52" class="difflineplus">+            else if (attrDef.singular)</span>
<a href="#l49.53"></a><span id="l49.53" class="difflineplus">+              testValues = [aObj[boundName]];</span>
<a href="#l49.54"></a><span id="l49.54">             else</span>
<a href="#l49.55"></a><span id="l49.55" class="difflineminus">-              testValues = aObj[attrDef.boundName];</span>
<a href="#l49.56"></a><span id="l49.56" class="difflineplus">+              testValues = aObj[boundName];</span>
<a href="#l49.57"></a><span id="l49.57" class="difflineplus">+</span>
<a href="#l49.58"></a><span id="l49.58" class="difflineplus">+            // If there are no constraints, then we are just testing for there</span>
<a href="#l49.59"></a><span id="l49.59" class="difflineplus">+            //  being a value.  Succeed (continue) in that case.</span>
<a href="#l49.60"></a><span id="l49.60" class="difflineplus">+            if (constraintValues.length == 0 &amp;&amp; testValues.length &amp;&amp;</span>
<a href="#l49.61"></a><span id="l49.61" class="difflineplus">+                testValues[0] != null)</span>
<a href="#l49.62"></a><span id="l49.62" class="difflineplus">+              continue;</span>
<a href="#l49.63"></a><span id="l49.63"> </span>
<a href="#l49.64"></a><span id="l49.64">             let foundMatch = false;</span>
<a href="#l49.65"></a><span id="l49.65">             for each (let [,testValue] in Iterator(testValues)) {</span>
<a href="#l49.66"></a><span id="l49.66">               for each (let [,value] in Iterator(constraintValues)) {</span>
<a href="#l49.67"></a><span id="l49.67">                 if (objectNounDef.equals(testValue, value)) {</span>
<a href="#l49.68"></a><span id="l49.68">                   foundMatch = true;</span>
<a href="#l49.69"></a><span id="l49.69">                   break;</span>
<a href="#l49.70"></a><span id="l49.70">                 }</span>
<a href="#l49.71"></a><span id="l49.71" class="difflineat">@@ -199,20 +209,28 @@ GlodaQueryClass.prototype = {</span>
<a href="#l49.72"></a><span id="l49.72">           }</span>
<a href="#l49.73"></a><span id="l49.73">           // otherwise, we need to convert everyone to their param/value form</span>
<a href="#l49.74"></a><span id="l49.74">           //  in order to test for equality</span>
<a href="#l49.75"></a><span id="l49.75">           else {</span>
<a href="#l49.76"></a><span id="l49.76">             // let's just do the simple, obvious thing for now.  which is</span>
<a href="#l49.77"></a><span id="l49.77">             //  what we did in the prior case but exploding values using</span>
<a href="#l49.78"></a><span id="l49.78">             //  toParamAndValue, and then comparing.</span>
<a href="#l49.79"></a><span id="l49.79">             let testValues;</span>
<a href="#l49.80"></a><span id="l49.80" class="difflineminus">-            if (attrDef.singular)</span>
<a href="#l49.81"></a><span id="l49.81" class="difflineminus">-              testValues = [aObj[attrDef.boundName]];</span>
<a href="#l49.82"></a><span id="l49.82" class="difflineplus">+            if (!(boundName in aObj))</span>
<a href="#l49.83"></a><span id="l49.83" class="difflineplus">+              testValues = [];</span>
<a href="#l49.84"></a><span id="l49.84" class="difflineplus">+            else if (attrDef.singular)</span>
<a href="#l49.85"></a><span id="l49.85" class="difflineplus">+              testValues = [aObj[boundName]];</span>
<a href="#l49.86"></a><span id="l49.86">             else</span>
<a href="#l49.87"></a><span id="l49.87" class="difflineminus">-              testValues = aObj[attrDef.boundName];</span>
<a href="#l49.88"></a><span id="l49.88" class="difflineplus">+              testValues = aObj[boundName];</span>
<a href="#l49.89"></a><span id="l49.89" class="difflineplus">+</span>
<a href="#l49.90"></a><span id="l49.90" class="difflineplus">+            // If there are no constraints, then we are just testing for there</span>
<a href="#l49.91"></a><span id="l49.91" class="difflineplus">+            //  being a value.  Succeed (continue) in that case.</span>
<a href="#l49.92"></a><span id="l49.92" class="difflineplus">+            if (constraintValues.length == 0 &amp;&amp; testValues.length &amp;&amp;</span>
<a href="#l49.93"></a><span id="l49.93" class="difflineplus">+                testValues[0] != null)</span>
<a href="#l49.94"></a><span id="l49.94" class="difflineplus">+              continue;</span>
<a href="#l49.95"></a><span id="l49.95"> </span>
<a href="#l49.96"></a><span id="l49.96">             let foundMatch = false;</span>
<a href="#l49.97"></a><span id="l49.97">             for each (let [,testValue] in Iterator(testValues)) {</span>
<a href="#l49.98"></a><span id="l49.98">               let [aParam, aValue] = objectNounDef.toParamAndValue(testValue);</span>
<a href="#l49.99"></a><span id="l49.99">               for each (let [,value] in Iterator(constraintValues)) {</span>
<a href="#l49.100"></a><span id="l49.100">                 let [bParam, bValue] = objectNounDef.toParamAndValue(value);</span>
<a href="#l49.101"></a><span id="l49.101">                 if (aParam == bParam &amp;&amp; aValue == bValue) {</span>
<a href="#l49.102"></a><span id="l49.102">                   foundMatch = true;</span>
<a href="#l49.103"></a><span id="l49.103" class="difflineat">@@ -228,20 +246,22 @@ GlodaQueryClass.prototype = {</span>
<a href="#l49.104"></a><span id="l49.104">             }</span>
<a href="#l49.105"></a><span id="l49.105">           }</span>
<a href="#l49.106"></a><span id="l49.106">         }</span>
<a href="#l49.107"></a><span id="l49.107">         // @testpoint gloda.query.test.kConstraintRanges</span>
<a href="#l49.108"></a><span id="l49.108">         else if (constraintType === GlodaDatastore.kConstraintRanges) {</span>
<a href="#l49.109"></a><span id="l49.109">           let objectNounDef = attrDef.objectNounDef;</span>
<a href="#l49.110"></a><span id="l49.110"> </span>
<a href="#l49.111"></a><span id="l49.111">           let testValues;</span>
<a href="#l49.112"></a><span id="l49.112" class="difflineminus">-          if (attrDef.singular)</span>
<a href="#l49.113"></a><span id="l49.113" class="difflineminus">-            testValues = [aObj[attrDef.boundName]];</span>
<a href="#l49.114"></a><span id="l49.114" class="difflineplus">+          if (!(boundName in aObj))</span>
<a href="#l49.115"></a><span id="l49.115" class="difflineplus">+              testValues = [];</span>
<a href="#l49.116"></a><span id="l49.116" class="difflineplus">+          else if (attrDef.singular)</span>
<a href="#l49.117"></a><span id="l49.117" class="difflineplus">+            testValues = [aObj[boundName]];</span>
<a href="#l49.118"></a><span id="l49.118">           else</span>
<a href="#l49.119"></a><span id="l49.119" class="difflineminus">-            testValues = aObj[attrDef.boundName];</span>
<a href="#l49.120"></a><span id="l49.120" class="difflineplus">+            testValues = aObj[boundName];</span>
<a href="#l49.121"></a><span id="l49.121"> </span>
<a href="#l49.122"></a><span id="l49.122">           let foundMatch = false;</span>
<a href="#l49.123"></a><span id="l49.123">           for each (let [,testValue] in Iterator(testValues)) {</span>
<a href="#l49.124"></a><span id="l49.124">             let [tParam, tValue] = objectNounDef.toParamAndValue(testValue);</span>
<a href="#l49.125"></a><span id="l49.125">             for each (let [,rangeTuple] in Iterator(constraintValues)) {</span>
<a href="#l49.126"></a><span id="l49.126">               let [lowerRValue, upperRValue] = rangeTuple;</span>
<a href="#l49.127"></a><span id="l49.127">               if (lowerRValue == null) {</span>
<a href="#l49.128"></a><span id="l49.128">                 let [upperParam, upperValue] =</span>
<a href="#l49.129"></a><span id="l49.129" class="difflineat">@@ -277,17 +297,17 @@ GlodaQueryClass.prototype = {</span>
<a href="#l49.130"></a><span id="l49.130">           if (!foundMatch) {</span>
<a href="#l49.131"></a><span id="l49.131">             querySatisfied = false;</span>
<a href="#l49.132"></a><span id="l49.132">             break;</span>
<a href="#l49.133"></a><span id="l49.133">           }</span>
<a href="#l49.134"></a><span id="l49.134">         }</span>
<a href="#l49.135"></a><span id="l49.135">         // @testpoint gloda.query.test.kConstraintStringLike</span>
<a href="#l49.136"></a><span id="l49.136">         else if (constraintType === GlodaDatastore.kConstraintStringLike) {</span>
<a href="#l49.137"></a><span id="l49.137">           let curIndex = 0;</span>
<a href="#l49.138"></a><span id="l49.138" class="difflineminus">-          let value = aObj[attrDef.boundName];</span>
<a href="#l49.139"></a><span id="l49.139" class="difflineplus">+          let value = (boundName in aObj) ? aObj[boundName] : &quot;&quot;;</span>
<a href="#l49.140"></a><span id="l49.140">           // the attribute must be singular, we don't support arrays of strings.</span>
<a href="#l49.141"></a><span id="l49.141">           for each (let [iValuePart, valuePart] in Iterator(constraintValues)) {</span>
<a href="#l49.142"></a><span id="l49.142">             if (typeof valuePart == &quot;string&quot;) {</span>
<a href="#l49.143"></a><span id="l49.143">               let index = value.indexOf(valuePart);</span>
<a href="#l49.144"></a><span id="l49.144">               // if curIndex is null, we just need any match</span>
<a href="#l49.145"></a><span id="l49.145">               // if it's not null, it must match the offset of our found match</span>
<a href="#l49.146"></a><span id="l49.146">               if (curIndex === null) {</span>
<a href="#l49.147"></a><span id="l49.147">                 if (index == -1)</span>
<a href="#l49.148"></a><span id="l49.148" class="difflineat">@@ -327,16 +347,47 @@ GlodaQueryClass.prototype = {</span>
<a href="#l49.149"></a><span id="l49.149">           break;</span>
<a href="#l49.150"></a><span id="l49.150">       }</span>
<a href="#l49.151"></a><span id="l49.151"> </span>
<a href="#l49.152"></a><span id="l49.152">       if (querySatisfied)</span>
<a href="#l49.153"></a><span id="l49.153">         return true;</span>
<a href="#l49.154"></a><span id="l49.154">     }</span>
<a href="#l49.155"></a><span id="l49.155">     return false;</span>
<a href="#l49.156"></a><span id="l49.156">   },</span>
<a href="#l49.157"></a><span id="l49.157" class="difflineplus">+</span>
<a href="#l49.158"></a><span id="l49.158" class="difflineplus">+  /**</span>
<a href="#l49.159"></a><span id="l49.159" class="difflineplus">+   * Helper code for noun definitions of queryHelpers that want to build a</span>
<a href="#l49.160"></a><span id="l49.160" class="difflineplus">+   *  traditional in/equals constraint.  The goal is to let them build a range</span>
<a href="#l49.161"></a><span id="l49.161" class="difflineplus">+   *  without having to know how we structure |_constraints|.</span>
<a href="#l49.162"></a><span id="l49.162" class="difflineplus">+   *</span>
<a href="#l49.163"></a><span id="l49.163" class="difflineplus">+   * @protected</span>
<a href="#l49.164"></a><span id="l49.164" class="difflineplus">+   */</span>
<a href="#l49.165"></a><span id="l49.165" class="difflineplus">+  _inConstraintHelper:</span>
<a href="#l49.166"></a><span id="l49.166" class="difflineplus">+      function gloda_query__discreteConstraintHelper(aAttrDef, aValues) {</span>
<a href="#l49.167"></a><span id="l49.167" class="difflineplus">+    let constraint =</span>
<a href="#l49.168"></a><span id="l49.168" class="difflineplus">+      [GlodaDatastore.kConstraintIn, aAttrDef].concat(aValues);</span>
<a href="#l49.169"></a><span id="l49.169" class="difflineplus">+    this._constraints.push(constraint);</span>
<a href="#l49.170"></a><span id="l49.170" class="difflineplus">+    return this;</span>
<a href="#l49.171"></a><span id="l49.171" class="difflineplus">+  },</span>
<a href="#l49.172"></a><span id="l49.172" class="difflineplus">+</span>
<a href="#l49.173"></a><span id="l49.173" class="difflineplus">+  /**</span>
<a href="#l49.174"></a><span id="l49.174" class="difflineplus">+   * Helper code for noun definitions of queryHelpers that want to build a</span>
<a href="#l49.175"></a><span id="l49.175" class="difflineplus">+   *  range.  The goal is to let them build a range without having to know how</span>
<a href="#l49.176"></a><span id="l49.176" class="difflineplus">+   *  we structure |_constraints| or requiring them to mark themselves as</span>
<a href="#l49.177"></a><span id="l49.177" class="difflineplus">+   *  continuous to get a &quot;Range&quot;.</span>
<a href="#l49.178"></a><span id="l49.178" class="difflineplus">+   *</span>
<a href="#l49.179"></a><span id="l49.179" class="difflineplus">+   * @protected</span>
<a href="#l49.180"></a><span id="l49.180" class="difflineplus">+   */</span>
<a href="#l49.181"></a><span id="l49.181" class="difflineplus">+  _rangedConstraintHelper:</span>
<a href="#l49.182"></a><span id="l49.182" class="difflineplus">+      function gloda_query__rangedConstraintHelper(aAttrDef, aRanges) {</span>
<a href="#l49.183"></a><span id="l49.183" class="difflineplus">+    let constraint =</span>
<a href="#l49.184"></a><span id="l49.184" class="difflineplus">+      [GlodaDatastore.kConstraintRanges, aAttrDef].concat(aRanges);</span>
<a href="#l49.185"></a><span id="l49.185" class="difflineplus">+    this._constraints.push(constraint);</span>
<a href="#l49.186"></a><span id="l49.186" class="difflineplus">+    return this;</span>
<a href="#l49.187"></a><span id="l49.187" class="difflineplus">+  }</span>
<a href="#l49.188"></a><span id="l49.188"> };</span>
<a href="#l49.189"></a><span id="l49.189"> </span>
<a href="#l49.190"></a><span id="l49.190"> /**</span>
<a href="#l49.191"></a><span id="l49.191">  * @class A query that never matches anything.</span>
<a href="#l49.192"></a><span id="l49.192">  *</span>
<a href="#l49.193"></a><span id="l49.193">  * Collections corresponding to this query are intentionally frozen in time and</span>
<a href="#l49.194"></a><span id="l49.194">  *  do not want to be notified of any updates.  We need the collection to be</span>
<a href="#l49.195"></a><span id="l49.195">  *  registered with the collection manager so that the noun instances in the</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mailnews/db/gloda/modules/utils.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/utils.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -59,16 +59,19 @@ var GlodaUtils = {</span>
<a href="#l50.4"></a><span id="l50.4"> </span>
<a href="#l50.5"></a><span id="l50.5">   _headerParser: null,</span>
<a href="#l50.6"></a><span id="l50.6"> </span>
<a href="#l50.7"></a><span id="l50.7">   /**</span>
<a href="#l50.8"></a><span id="l50.8">    * Parses an RFC 2822 list of e-mail addresses and returns an object with</span>
<a href="#l50.9"></a><span id="l50.9">    *  4 attributes, as described below.  We will use the example of the user</span>
<a href="#l50.10"></a><span id="l50.10">    *  passing an argument of '&quot;Bob Smith&quot; &lt;bob@company.com&gt;'.</span>
<a href="#l50.11"></a><span id="l50.11">    *</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineplus">+   * This method (by way of nsIMsgHeaderParser) takes care of decoding mime</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+   *  headers, but is not aware of folder-level character set overrides.</span>
<a href="#l50.14"></a><span id="l50.14" class="difflineplus">+   *</span>
<a href="#l50.15"></a><span id="l50.15">    * count: the number of addresses parsed. (ex: 1)</span>
<a href="#l50.16"></a><span id="l50.16">    * addresses: a list of e-mail addresses (ex: [&quot;bob@company.com&quot;])</span>
<a href="#l50.17"></a><span id="l50.17">    * names: a list of names (ex: [&quot;Bob Smith&quot;])</span>
<a href="#l50.18"></a><span id="l50.18">    * fullAddresses: aka the list of name and e-mail together (ex: ['&quot;Bob Smith&quot;</span>
<a href="#l50.19"></a><span id="l50.19">    *  &lt;bob@company.com&gt;']).</span>
<a href="#l50.20"></a><span id="l50.20">    *</span>
<a href="#l50.21"></a><span id="l50.21">    * This method is a convenience wrapper around nsIMsgHeaderParser.</span>
<a href="#l50.22"></a><span id="l50.22">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/resources/glodaTestHelper.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/resources/glodaTestHelper.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -33,16 +33,18 @@</span>
<a href="#l51.4"></a><span id="l51.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l51.5"></a><span id="l51.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l51.6"></a><span id="l51.6">  *</span>
<a href="#l51.7"></a><span id="l51.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l51.8"></a><span id="l51.8"> </span>
<a href="#l51.9"></a><span id="l51.9"> // -- Pull in the POP3 fake-server / local account helper code</span>
<a href="#l51.10"></a><span id="l51.10"> load(&quot;../../test_mailnewslocal/unit/head_maillocal.js&quot;);</span>
<a href="#l51.11"></a><span id="l51.11"> </span>
<a href="#l51.12"></a><span id="l51.12" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/errUtils.js&quot;);</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+</span>
<a href="#l51.14"></a><span id="l51.14"> /**</span>
<a href="#l51.15"></a><span id="l51.15">  * Create a 'me' identity of &quot;me@localhost&quot; for the benefit of Gloda.  At the</span>
<a href="#l51.16"></a><span id="l51.16">  *  time of this writing, Gloda only initializes Gloda.myIdentities and</span>
<a href="#l51.17"></a><span id="l51.17">  *  Gloda.myContact at startup with no event-driven updates.  As such, this</span>
<a href="#l51.18"></a><span id="l51.18">  *  function needs to be called prior to gloda startup.</span>
<a href="#l51.19"></a><span id="l51.19">  */</span>
<a href="#l51.20"></a><span id="l51.20"> function createMeIdentity() {</span>
<a href="#l51.21"></a><span id="l51.21">   var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l51.22"></a><span id="l51.22" class="difflineat">@@ -870,19 +872,21 @@ QueryExpectationListener.prototype = {</span>
<a href="#l51.23"></a><span id="l51.23">                   &quot;&quot;) + &quot;\n&quot;);</span>
<a href="#l51.24"></a><span id="l51.24">           }</span>
<a href="#l51.25"></a><span id="l51.25">           throw ex;</span>
<a href="#l51.26"></a><span id="l51.26">         }</span>
<a href="#l51.27"></a><span id="l51.27">       }</span>
<a href="#l51.28"></a><span id="l51.28">       this.nextIndex++;</span>
<a href="#l51.29"></a><span id="l51.29"> </span>
<a href="#l51.30"></a><span id="l51.30">       // make sure the query's test method agrees with the database about this</span>
<a href="#l51.31"></a><span id="l51.31" class="difflineminus">-      if (!aCollection.query.test(item))</span>
<a href="#l51.32"></a><span id="l51.32" class="difflineplus">+      if (!aCollection.query.test(item)) {</span>
<a href="#l51.33"></a><span id="l51.33" class="difflineplus">+        logObject(item);</span>
<a href="#l51.34"></a><span id="l51.34">         do_throw(&quot;Query test returned false when it should have been true on &quot; +</span>
<a href="#l51.35"></a><span id="l51.35">                  &quot;extracted: &quot; + glodaStringRep + &quot; item: &quot; + item);</span>
<a href="#l51.36"></a><span id="l51.36" class="difflineplus">+      }</span>
<a href="#l51.37"></a><span id="l51.37">     }</span>
<a href="#l51.38"></a><span id="l51.38">   },</span>
<a href="#l51.39"></a><span id="l51.39">   onItemsModified: function query_expectation_onItemsModified(aItems,</span>
<a href="#l51.40"></a><span id="l51.40">       aCollection) {</span>
<a href="#l51.41"></a><span id="l51.41">   },</span>
<a href="#l51.42"></a><span id="l51.42">   onItemsRemoved: function query_expectation_onItemsRemoved(aItems,</span>
<a href="#l51.43"></a><span id="l51.43">       aCollection) {</span>
<a href="#l51.44"></a><span id="l51.44">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_query_core.js</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_query_core.js</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -54,17 +54,18 @@ var WidgetProvider = {</span>
<a href="#l52.4"></a><span id="l52.4"> };</span>
<a href="#l52.5"></a><span id="l52.5"> </span>
<a href="#l52.6"></a><span id="l52.6"> var WidgetNoun;</span>
<a href="#l52.7"></a><span id="l52.7"> function setup_test_noun_and_attributes() {</span>
<a href="#l52.8"></a><span id="l52.8">   // --- noun</span>
<a href="#l52.9"></a><span id="l52.9">   WidgetNoun = Gloda.defineNoun({</span>
<a href="#l52.10"></a><span id="l52.10">     name: &quot;widget&quot;,</span>
<a href="#l52.11"></a><span id="l52.11">     clazz: Widget,</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-    allowArbitraryAttrs: true,</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+    allowsArbitraryAttrs: true,</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineplus">+    //cache: true, cacheCost: 32,</span>
<a href="#l52.15"></a><span id="l52.15">     schema: {</span>
<a href="#l52.16"></a><span id="l52.16">       columns: [['id', 'INTEGER PRIMARY KEY'],</span>
<a href="#l52.17"></a><span id="l52.17">                 ['intCol', 'NUMBER', 'inum'],</span>
<a href="#l52.18"></a><span id="l52.18">                 ['dateCol', 'NUMBER', 'date'],</span>
<a href="#l52.19"></a><span id="l52.19">                 ['strCol', 'STRING', 'str'],</span>
<a href="#l52.20"></a><span id="l52.20">                 ['notabilityCol', 'NUMBER', 'notability'],</span>
<a href="#l52.21"></a><span id="l52.21">                 ['textOne', 'STRING', 'text1'],</span>
<a href="#l52.22"></a><span id="l52.22">                 ['textTwo', 'STRING', 'text2']],</span>
<a href="#l52.23"></a><span id="l52.23" class="difflineat">@@ -77,60 +78,60 @@ function setup_test_noun_and_attributes(</span>
<a href="#l52.24"></a><span id="l52.24">   });</span>
<a href="#l52.25"></a><span id="l52.25"> </span>
<a href="#l52.26"></a><span id="l52.26">   EXT_NAME = &quot;test&quot;;</span>
<a href="#l52.27"></a><span id="l52.27"> </span>
<a href="#l52.28"></a><span id="l52.28">   // --- special (on-row) attributes</span>
<a href="#l52.29"></a><span id="l52.29">   Gloda.defineAttribute({</span>
<a href="#l52.30"></a><span id="l52.30">     provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l52.31"></a><span id="l52.31">     attributeType: Gloda.kAttrFundamental,</span>
<a href="#l52.32"></a><span id="l52.32" class="difflineminus">-    attributeName: &quot;intCol&quot;,</span>
<a href="#l52.33"></a><span id="l52.33" class="difflineplus">+    attributeName: &quot;inum&quot;,</span>
<a href="#l52.34"></a><span id="l52.34">     singular: true,</span>
<a href="#l52.35"></a><span id="l52.35">     special: Gloda.kSpecialColumn,</span>
<a href="#l52.36"></a><span id="l52.36">     specialColumnName: &quot;intCol&quot;,</span>
<a href="#l52.37"></a><span id="l52.37">     subjectNouns: [WidgetNoun.id],</span>
<a href="#l52.38"></a><span id="l52.38">     objectNoun: Gloda.NOUN_NUMBER</span>
<a href="#l52.39"></a><span id="l52.39">   });</span>
<a href="#l52.40"></a><span id="l52.40">   Gloda.defineAttribute({</span>
<a href="#l52.41"></a><span id="l52.41">     provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l52.42"></a><span id="l52.42">     attributeType: Gloda.kAttrFundamental,</span>
<a href="#l52.43"></a><span id="l52.43" class="difflineminus">-    attributeName: &quot;dateCol&quot;,</span>
<a href="#l52.44"></a><span id="l52.44" class="difflineplus">+    attributeName: &quot;date&quot;,</span>
<a href="#l52.45"></a><span id="l52.45">     singular: true,</span>
<a href="#l52.46"></a><span id="l52.46">     special: Gloda.kSpecialColumn,</span>
<a href="#l52.47"></a><span id="l52.47">     specialColumnName: &quot;dateCol&quot;,</span>
<a href="#l52.48"></a><span id="l52.48">     subjectNouns: [WidgetNoun.id],</span>
<a href="#l52.49"></a><span id="l52.49">     objectNoun: Gloda.NOUN_DATE</span>
<a href="#l52.50"></a><span id="l52.50">   });</span>
<a href="#l52.51"></a><span id="l52.51">   Gloda.defineAttribute({</span>
<a href="#l52.52"></a><span id="l52.52">     provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l52.53"></a><span id="l52.53">     attributeType: Gloda.kAttrFundamental,</span>
<a href="#l52.54"></a><span id="l52.54" class="difflineminus">-    attributeName: &quot;strCol&quot;,</span>
<a href="#l52.55"></a><span id="l52.55" class="difflineplus">+    attributeName: &quot;str&quot;,</span>
<a href="#l52.56"></a><span id="l52.56">     singular: true,</span>
<a href="#l52.57"></a><span id="l52.57">     special: Gloda.kSpecialString,</span>
<a href="#l52.58"></a><span id="l52.58">     specialColumnName: &quot;strCol&quot;,</span>
<a href="#l52.59"></a><span id="l52.59">     subjectNouns: [WidgetNoun.id],</span>
<a href="#l52.60"></a><span id="l52.60">     objectNoun: Gloda.NOUN_STRING</span>
<a href="#l52.61"></a><span id="l52.61">   });</span>
<a href="#l52.62"></a><span id="l52.62"> </span>
<a href="#l52.63"></a><span id="l52.63"> </span>
<a href="#l52.64"></a><span id="l52.64">   // --- fulltext attributes</span>
<a href="#l52.65"></a><span id="l52.65">   Gloda.defineAttribute({</span>
<a href="#l52.66"></a><span id="l52.66">     provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l52.67"></a><span id="l52.67">     attributeType: Gloda.kAttrFundamental,</span>
<a href="#l52.68"></a><span id="l52.68" class="difflineminus">-    attributeName: &quot;fulltextOne&quot;,</span>
<a href="#l52.69"></a><span id="l52.69" class="difflineplus">+    attributeName: &quot;text1&quot;,</span>
<a href="#l52.70"></a><span id="l52.70">     singular: true,</span>
<a href="#l52.71"></a><span id="l52.71">     special: Gloda.kSpecialFulltext,</span>
<a href="#l52.72"></a><span id="l52.72">     specialColumnName: &quot;fulltextOne&quot;,</span>
<a href="#l52.73"></a><span id="l52.73">     subjectNouns: [WidgetNoun.id],</span>
<a href="#l52.74"></a><span id="l52.74">     objectNoun: Gloda.NOUN_FULLTEXT</span>
<a href="#l52.75"></a><span id="l52.75">   });</span>
<a href="#l52.76"></a><span id="l52.76">   Gloda.defineAttribute({</span>
<a href="#l52.77"></a><span id="l52.77">     provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l52.78"></a><span id="l52.78">     attributeType: Gloda.kAttrFundamental,</span>
<a href="#l52.79"></a><span id="l52.79" class="difflineminus">-    attributeName: &quot;fulltextTwo&quot;,</span>
<a href="#l52.80"></a><span id="l52.80" class="difflineplus">+    attributeName: &quot;text2&quot;,</span>
<a href="#l52.81"></a><span id="l52.81">     singular: true,</span>
<a href="#l52.82"></a><span id="l52.82">     special: Gloda.kSpecialFulltext,</span>
<a href="#l52.83"></a><span id="l52.83">     specialColumnName: &quot;fulltextTwo&quot;,</span>
<a href="#l52.84"></a><span id="l52.84">     subjectNouns: [WidgetNoun.id],</span>
<a href="#l52.85"></a><span id="l52.85">     objectNoun: Gloda.NOUN_FULLTEXT</span>
<a href="#l52.86"></a><span id="l52.86">   });</span>
<a href="#l52.87"></a><span id="l52.87">   Gloda.defineAttribute({</span>
<a href="#l52.88"></a><span id="l52.88">     provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l52.89"></a><span id="l52.89" class="difflineat">@@ -148,16 +149,25 @@ function setup_test_noun_and_attributes(</span>
<a href="#l52.90"></a><span id="l52.90">     provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l52.91"></a><span id="l52.91">     attributeType: Gloda.kAttrFundamental,</span>
<a href="#l52.92"></a><span id="l52.92">     attributeName: &quot;singleIntAttr&quot;,</span>
<a href="#l52.93"></a><span id="l52.93">     singular: true,</span>
<a href="#l52.94"></a><span id="l52.94">     subjectNouns: [WidgetNoun.id],</span>
<a href="#l52.95"></a><span id="l52.95">     objectNoun: Gloda.NOUN_NUMBER</span>
<a href="#l52.96"></a><span id="l52.96">   });</span>
<a href="#l52.97"></a><span id="l52.97"> </span>
<a href="#l52.98"></a><span id="l52.98" class="difflineplus">+  Gloda.defineAttribute({</span>
<a href="#l52.99"></a><span id="l52.99" class="difflineplus">+    provider: WidgetProvider, extensionName: EXT_NAME,</span>
<a href="#l52.100"></a><span id="l52.100" class="difflineplus">+    attributeType: Gloda.kAttrFundamental,</span>
<a href="#l52.101"></a><span id="l52.101" class="difflineplus">+    attributeName: &quot;multiIntAttr&quot;,</span>
<a href="#l52.102"></a><span id="l52.102" class="difflineplus">+    singular: false,</span>
<a href="#l52.103"></a><span id="l52.103" class="difflineplus">+    subjectNouns: [WidgetNoun.id],</span>
<a href="#l52.104"></a><span id="l52.104" class="difflineplus">+    objectNoun: Gloda.NOUN_NUMBER</span>
<a href="#l52.105"></a><span id="l52.105" class="difflineplus">+  });</span>
<a href="#l52.106"></a><span id="l52.106" class="difflineplus">+</span>
<a href="#l52.107"></a><span id="l52.107">   next_test();</span>
<a href="#l52.108"></a><span id="l52.108"> }</span>
<a href="#l52.109"></a><span id="l52.109"> </span>
<a href="#l52.110"></a><span id="l52.110"> /* ===== Tests ===== */</span>
<a href="#l52.111"></a><span id="l52.111"> </span>
<a href="#l52.112"></a><span id="l52.112"> ALPHABET = &quot;abcdefghijklmnopqrstuvwxyz&quot;;</span>
<a href="#l52.113"></a><span id="l52.113"> function test_lots_of_string_constraints() {</span>
<a href="#l52.114"></a><span id="l52.114">   let stringConstraints = [];</span>
<a href="#l52.115"></a><span id="l52.115" class="difflineat">@@ -169,21 +179,67 @@ function test_lots_of_string_constraints</span>
<a href="#l52.116"></a><span id="l52.116">                            ALPHABET[i % ALPHABET.length] +</span>
<a href="#l52.117"></a><span id="l52.117">                            // throw in something that will explode if not quoted</span>
<a href="#l52.118"></a><span id="l52.118">                            // (and use an uneven number of things so if we fail</span>
<a href="#l52.119"></a><span id="l52.119">                            // to quote it won't get quietly eaten.)</span>
<a href="#l52.120"></a><span id="l52.120">                            &quot;'&quot; + '&quot;');</span>
<a href="#l52.121"></a><span id="l52.121">   }</span>
<a href="#l52.122"></a><span id="l52.122"> </span>
<a href="#l52.123"></a><span id="l52.123">   let query = Gloda.newQuery(WidgetNoun.id);</span>
<a href="#l52.124"></a><span id="l52.124" class="difflineminus">-  query.strCol.apply(query, stringConstraints);</span>
<a href="#l52.125"></a><span id="l52.125" class="difflineplus">+  query.str.apply(query, stringConstraints);</span>
<a href="#l52.126"></a><span id="l52.126"> </span>
<a href="#l52.127"></a><span id="l52.127">   queryExpect(query, []);</span>
<a href="#l52.128"></a><span id="l52.128"> }</span>
<a href="#l52.129"></a><span id="l52.129"> </span>
<a href="#l52.130"></a><span id="l52.130" class="difflineplus">+/* === Query === */</span>
<a href="#l52.131"></a><span id="l52.131" class="difflineplus">+</span>
<a href="#l52.132"></a><span id="l52.132" class="difflineplus">+/**</span>
<a href="#l52.133"></a><span id="l52.133" class="difflineplus">+ * Use a counter so that each test can have its own unique value for intCol so</span>
<a href="#l52.134"></a><span id="l52.134" class="difflineplus">+ *  that it can use that as a constraint.  Otherwise we would need to purge</span>
<a href="#l52.135"></a><span id="l52.135" class="difflineplus">+ *  between every test.  That's not an unreasonable alternative, but this works.</span>
<a href="#l52.136"></a><span id="l52.136" class="difflineplus">+ * Every test should increment this before using it.</span>
<a href="#l52.137"></a><span id="l52.137" class="difflineplus">+ */</span>
<a href="#l52.138"></a><span id="l52.138" class="difflineplus">+var testUnique = 100;</span>
<a href="#l52.139"></a><span id="l52.139" class="difflineplus">+</span>
<a href="#l52.140"></a><span id="l52.140" class="difflineplus">+/**</span>
<a href="#l52.141"></a><span id="l52.141" class="difflineplus">+ * Widgets with multiIntAttr populated with one or more values.</span>
<a href="#l52.142"></a><span id="l52.142" class="difflineplus">+ */</span>
<a href="#l52.143"></a><span id="l52.143" class="difflineplus">+var nonSingularWidgets;</span>
<a href="#l52.144"></a><span id="l52.144" class="difflineplus">+/**</span>
<a href="#l52.145"></a><span id="l52.145" class="difflineplus">+ * Widgets with multiIntAttr unpopulated.</span>
<a href="#l52.146"></a><span id="l52.146" class="difflineplus">+ */</span>
<a href="#l52.147"></a><span id="l52.147" class="difflineplus">+var singularWidgets;</span>
<a href="#l52.148"></a><span id="l52.148" class="difflineplus">+</span>
<a href="#l52.149"></a><span id="l52.149" class="difflineplus">+function setup_non_singular_values() {</span>
<a href="#l52.150"></a><span id="l52.150" class="difflineplus">+  testUnique++;</span>
<a href="#l52.151"></a><span id="l52.151" class="difflineplus">+  let origin = new Date(&quot;2007/01/01&quot;);</span>
<a href="#l52.152"></a><span id="l52.152" class="difflineplus">+  nonSingularWidgets = [</span>
<a href="#l52.153"></a><span id="l52.153" class="difflineplus">+    new Widget(testUnique, origin, &quot;ns1&quot;, 0, &quot;&quot;, &quot;&quot;),</span>
<a href="#l52.154"></a><span id="l52.154" class="difflineplus">+    new Widget(testUnique, origin, &quot;ns2&quot;, 0, &quot;&quot;, &quot;&quot;),</span>
<a href="#l52.155"></a><span id="l52.155" class="difflineplus">+  ];</span>
<a href="#l52.156"></a><span id="l52.156" class="difflineplus">+  singularWidgets = [</span>
<a href="#l52.157"></a><span id="l52.157" class="difflineplus">+    new Widget(testUnique, origin, &quot;s1&quot;, 0, &quot;&quot;, &quot;&quot;),</span>
<a href="#l52.158"></a><span id="l52.158" class="difflineplus">+    new Widget(testUnique, origin, &quot;s2&quot;, 0, &quot;&quot;, &quot;&quot;),</span>
<a href="#l52.159"></a><span id="l52.159" class="difflineplus">+  ];</span>
<a href="#l52.160"></a><span id="l52.160" class="difflineplus">+  nonSingularWidgets[0].multiIntAttr = [1, 2];</span>
<a href="#l52.161"></a><span id="l52.161" class="difflineplus">+  nonSingularWidgets[1].multiIntAttr = [3];</span>
<a href="#l52.162"></a><span id="l52.162" class="difflineplus">+  singularWidgets[0].multiIntAttr = [];</span>
<a href="#l52.163"></a><span id="l52.163" class="difflineplus">+  // and don't bother setting it on singularWidgets[1]</span>
<a href="#l52.164"></a><span id="l52.164" class="difflineplus">+</span>
<a href="#l52.165"></a><span id="l52.165" class="difflineplus">+  runOnIndexingComplete(next_test);</span>
<a href="#l52.166"></a><span id="l52.166" class="difflineplus">+  GenericIndexer.indexNewObjects(nonSingularWidgets.concat(singularWidgets));</span>
<a href="#l52.167"></a><span id="l52.167" class="difflineplus">+}</span>
<a href="#l52.168"></a><span id="l52.168" class="difflineplus">+</span>
<a href="#l52.169"></a><span id="l52.169" class="difflineplus">+function test_query_has_value_for_non_singular() {</span>
<a href="#l52.170"></a><span id="l52.170" class="difflineplus">+  let query = Gloda.newQuery(WidgetNoun.id);</span>
<a href="#l52.171"></a><span id="l52.171" class="difflineplus">+  query.inum(testUnique);</span>
<a href="#l52.172"></a><span id="l52.172" class="difflineplus">+  query.multiIntAttr();</span>
<a href="#l52.173"></a><span id="l52.173" class="difflineplus">+  queryExpect(query, nonSingularWidgets);</span>
<a href="#l52.174"></a><span id="l52.174" class="difflineplus">+}</span>
<a href="#l52.175"></a><span id="l52.175" class="difflineplus">+</span>
<a href="#l52.176"></a><span id="l52.176"> /* === Search === */</span>
<a href="#l52.177"></a><span id="l52.177"> /*</span>
<a href="#l52.178"></a><span id="l52.178">  * The conceit of our search is that more recent messages are better than older</span>
<a href="#l52.179"></a><span id="l52.179">  *  messages.  But at the same time, we care about some messages more than</span>
<a href="#l52.180"></a><span id="l52.180">  *  others (in general), and we care about messages that match search terms</span>
<a href="#l52.181"></a><span id="l52.181">  *  more strongly too.  So we introduce a general 'score' heuristic which we</span>
<a href="#l52.182"></a><span id="l52.182">  *  then apply to message timestamps to make them appear more recent.  We</span>
<a href="#l52.183"></a><span id="l52.183">  *  then order by this 'date score' hybrid, which we dub &quot;dascore&quot;.  Such a</span>
<a href="#l52.184"></a><span id="l52.184" class="difflineat">@@ -306,16 +362,18 @@ function test_search_ranking_idiom_score</span>
<a href="#l52.185"></a><span id="l52.185"> }</span>
<a href="#l52.186"></a><span id="l52.186"> </span>
<a href="#l52.187"></a><span id="l52.187"> </span>
<a href="#l52.188"></a><span id="l52.188"> /* ===== Driver ===== */</span>
<a href="#l52.189"></a><span id="l52.189"> </span>
<a href="#l52.190"></a><span id="l52.190"> var tests = [</span>
<a href="#l52.191"></a><span id="l52.191">   setup_test_noun_and_attributes,</span>
<a href="#l52.192"></a><span id="l52.192">   test_lots_of_string_constraints,</span>
<a href="#l52.193"></a><span id="l52.193" class="difflineplus">+  setup_non_singular_values,</span>
<a href="#l52.194"></a><span id="l52.194" class="difflineplus">+  test_query_has_value_for_non_singular,</span>
<a href="#l52.195"></a><span id="l52.195">   setup_search_ranking_idiom,</span>
<a href="#l52.196"></a><span id="l52.196">   test_search_ranking_idiom_offsets,</span>
<a href="#l52.197"></a><span id="l52.197">   test_search_ranking_idiom_score,</span>
<a href="#l52.198"></a><span id="l52.198"> ];</span>
<a href="#l52.199"></a><span id="l52.199"> </span>
<a href="#l52.200"></a><span id="l52.200"> function run_test() {</span>
<a href="#l52.201"></a><span id="l52.201">   // use mbox injection so we get multiple folders...</span>
<a href="#l52.202"></a><span id="l52.202">   injectMessagesUsing(INJECT_MBOX);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

