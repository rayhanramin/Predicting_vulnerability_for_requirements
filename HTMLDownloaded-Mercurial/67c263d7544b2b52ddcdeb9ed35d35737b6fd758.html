<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25546:67c263d7544b2b52ddcdeb9ed35d35737b6fd758</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 67c263d7544b2b52ddcdeb9ed35d35737b6fd758" />
<meta property="og:url" content="/comm-central/rev/67c263d7544b2b52ddcdeb9ed35d35737b6fd758" />
<meta property="og:description" content="Bug 1491228 - refactored mbox&lt;-&gt;maildir conversion, also fixing bug 1135309 (don't use &quot;From -&quot; for maildir files). r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 67c263d7544b2b52ddcdeb9ed35d35737b6fd758 &#x2620;
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/67c263d7544b2b52ddcdeb9ed35d35737b6fd758">shortlog</a> |
<a href="/comm-central/log/67c263d7544b2b52ddcdeb9ed35d35737b6fd758">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/67c263d7544b2b52ddcdeb9ed35d35737b6fd758">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/67c263d7544b2b52ddcdeb9ed35d35737b6fd758">files</a> |
changeset |
<a href="/comm-central/raw-rev/67c263d7544b2b52ddcdeb9ed35d35737b6fd758">raw</a>  | <a href="/comm-central/archive/67c263d7544b2b52ddcdeb9ed35d35737b6fd758.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1491228">Bug 1491228</a> - refactored mbox&lt;-&gt;maildir conversion, also fixing <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1135309">bug 1135309</a> (don't use &quot;From -&quot; for maildir files). r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">
<tr><td colspan="2" style="background:#ff3333;"><strong>&#x2620;&#x2620; backed out by <a style="font-family: monospace" href="/comm-central/rev/6c36a1eb8323">6c36a1eb8323</a> &#x2620; &#x2620;</strong></td></tr>
<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#67;&#97;&#109;&#112;&#98;&#101;&#108;&#108;&#32;&#60;&#98;&#101;&#110;&#99;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 11 Jan 2019 10:48:08 +0200</td></tr>

<tr>
 <td>changeset 25546</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/67c263d7544b2b52ddcdeb9ed35d35737b6fd758">67c263d7544b2b52ddcdeb9ed35d35737b6fd758</a></td>
</tr>



<tr>
<td>parent 25545</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1ff4cbc59aae01ffd7fbb94852cbf07223e7806b">1ff4cbc59aae01ffd7fbb94852cbf07223e7806b</a>
</td>
</tr>

<tr>
<td>child 25547</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/10ad26e5d74d555404b4ad902e898681d6afd756">10ad26e5d74d555404b4ad902e898681d6afd756</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=67c263d7544b2b52ddcdeb9ed35d35737b6fd758">15335</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Fri, 11 Jan 2019 08:51:07 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@67c263d7544b [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=67c263d7544b2b52ddcdeb9ed35d35737b6fd758">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=67c263d7544b2b52ddcdeb9ed35d35737b6fd758&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=67c263d7544b2b52ddcdeb9ed35d35737b6fd758&newProject=comm-central&newRevision=67c263d7544b2b52ddcdeb9ed35d35737b6fd758&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=67c263d7544b2b52ddcdeb9ed35d35737b6fd758&newProject=comm-central&newRevision=67c263d7544b2b52ddcdeb9ed35d35737b6fd758&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=67c263d7544b2b52ddcdeb9ed35d35737b6fd758&newProject=comm-central&newRevision=67c263d7544b2b52ddcdeb9ed35d35737b6fd758&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1491228">1491228</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1135309">1135309</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1491228">Bug 1491228</a> - refactored mbox&lt;-&gt;maildir conversion, also fixing <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1135309">bug 1135309</a> (don't use &quot;From -&quot; for maildir files). r=mkmelin

Solidifies interface between main thread and worker.
Handles a larger variety of &quot;From &quot; separator lines (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1491228">Bug 1491228</a>).
Is now tolerant of unquoted &quot;From &quot; lines in message bodies.
Unit tests for various mbox forms added.
The output maildir messages no longer include the &quot;From &quot; line
(<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1135309">Bug 1135309</a>).</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/test/unit/test_mailstoreConverter.js">mailnews/base/test/unit/test_mailstoreConverter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/test/unit/test_mailstoreConverter.js">file</a> |
<a href="/comm-central/annotate/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/test/unit/test_mailstoreConverter.js">annotate</a> |
<a href="/comm-central/diff/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/test/unit/test_mailstoreConverter.js">diff</a> |
<a href="/comm-central/comparison/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/test/unit/test_mailstoreConverter.js">comparison</a> |
<a href="/comm-central/log/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/test/unit/test_mailstoreConverter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/util/converterWorker.js">mailnews/base/util/converterWorker.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/util/converterWorker.js">file</a> |
<a href="/comm-central/annotate/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/util/converterWorker.js">annotate</a> |
<a href="/comm-central/diff/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/util/converterWorker.js">diff</a> |
<a href="/comm-central/comparison/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/util/converterWorker.js">comparison</a> |
<a href="/comm-central/log/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/util/converterWorker.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/util/mailstoreConverter.jsm">mailnews/base/util/mailstoreConverter.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/util/mailstoreConverter.jsm">file</a> |
<a href="/comm-central/annotate/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/util/mailstoreConverter.jsm">annotate</a> |
<a href="/comm-central/diff/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/util/mailstoreConverter.jsm">diff</a> |
<a href="/comm-central/comparison/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/util/mailstoreConverter.jsm">comparison</a> |
<a href="/comm-central/log/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/base/util/mailstoreConverter.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_mboxrd">mailnews/test/data/mbox_mboxrd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_mboxrd">file</a> |
<a href="/comm-central/annotate/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_mboxrd">annotate</a> |
<a href="/comm-central/diff/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_mboxrd">diff</a> |
<a href="/comm-central/comparison/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_mboxrd">comparison</a> |
<a href="/comm-central/log/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_mboxrd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_modern">mailnews/test/data/mbox_modern</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_modern">file</a> |
<a href="/comm-central/annotate/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_modern">annotate</a> |
<a href="/comm-central/diff/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_modern">diff</a> |
<a href="/comm-central/comparison/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_modern">comparison</a> |
<a href="/comm-central/log/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_modern">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_unquoted">mailnews/test/data/mbox_unquoted</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_unquoted">file</a> |
<a href="/comm-central/annotate/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_unquoted">annotate</a> |
<a href="/comm-central/diff/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_unquoted">diff</a> |
<a href="/comm-central/comparison/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_unquoted">comparison</a> |
<a href="/comm-central/log/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/mbox_unquoted">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/readme.txt">mailnews/test/data/readme.txt</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/readme.txt">file</a> |
<a href="/comm-central/annotate/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/readme.txt">annotate</a> |
<a href="/comm-central/diff/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/readme.txt">diff</a> |
<a href="/comm-central/comparison/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/readme.txt">comparison</a> |
<a href="/comm-central/log/67c263d7544b2b52ddcdeb9ed35d35737b6fd758/mailnews/test/data/readme.txt">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/test/unit/test_mailstoreConverter.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_mailstoreConverter.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -7,127 +7,105 @@ ChromeUtils.import(&quot;resource://gre/modul</span>
<a href="#l1.4"></a><span id="l1.4"> ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l1.5"></a><span id="l1.5"> ChromeUtils.import(&quot;resource:///modules/mailstoreConverter.jsm&quot;);</span>
<a href="#l1.6"></a><span id="l1.6"> ChromeUtils.import(&quot;resource://gre/modules/Log.jsm&quot;);</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> var log = Log.repository.getLogger(&quot;MailStoreConverter&quot;);</span>
<a href="#l1.9"></a><span id="l1.9"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l1.10"></a><span id="l1.10">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-var gMsgHdrs = [];</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-// {nsIMsgLocalMailFolder} folder carrying messages for the pop server.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-var gInbox;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-// {nsIMsgAccount} Account to convert.</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-var gAccount;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-// Server for the account to convert.</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-var gServer;</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-var copyListenerWrap = {</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-  SetMessageKey: function(aKey) {</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-    let hdr = gInbox.GetMessageHeader(aKey);</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-    gMsgHdrs.push({hdr: hdr, ID: hdr.messageId});</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-  },</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-  OnStopCopy: function(aStatus) {</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-    // Check: message successfully copied.</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-    Assert.equal(aStatus, 0);</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-  }</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-};</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-var EventTarget = function () {</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-  this.dispatchEvent = function(aEvent) {</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-    if (aEvent.type == &quot;progress&quot;) {</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-      log.trace(&quot;Progress: &quot; + aEvent.detail);</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-    }</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-  };</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-};</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-function copyFileMessage(aFile, aDestFolder, aIsDraftOrTemplate)</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-{</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-  let listener = new PromiseTestUtils.PromiseCopyListener(copyListenerWrap);</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-  MailServices.copy.CopyFileMessage(aFile, aDestFolder, null, aIsDraftOrTemplate,</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-                                    0, &quot;&quot;, listener, null);</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-  return listener.promise;</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-}</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-/**</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">- * Check that conversion worked for the given source.</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">- * @param aSource - mbox source directory</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">- * @param aTarget - maildir target directory</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">- */</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-function checkConversion(aSource, aTarget) {</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-  let sourceContents = aSource.directoryEntries;</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-  while (sourceContents.hasMoreElements()) {</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-    let sourceContent = sourceContents.getNext().QueryInterface(Ci.nsIFile);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-    let sourceContentName = sourceContent.leafName;</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-    let ext = sourceContentName.substr(-4);</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-    let targetFile = FileUtils.File(OS.Path.join(aTarget.path,sourceContentName));</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-    log.debug(&quot;Checking path: &quot; + targetFile.path);</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-    if (ext == &quot;.dat&quot;) {</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-      Assert.ok(targetFile.exists());</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-    } else if (sourceContent.isDirectory()) {</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-      Assert.ok(targetFile.exists());</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-      checkConversion(sourceContent, targetFile);</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-    } else if (ext != &quot;.msf&quot;) {</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-      Assert.ok(targetFile.exists());</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-      let cur = FileUtils.File(OS.Path.join(targetFile.path,&quot;cur&quot;));</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-      Assert.ok(cur.exists());</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-      let tmp = FileUtils.File(OS.Path.join(targetFile.path,&quot;tmp&quot;));</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-      Assert.ok(tmp.exists());</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-      if (targetFile.leafName == &quot;Inbox&quot;) {</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-        let curContents = cur.directoryEntries;</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-        let curContentsCount = 0;</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-        while (curContents.hasMoreElements()) {</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-          let curContent = curContents.getNext();</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-          curContentsCount++;</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-        }</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-        // We had 1000 msgs in the old folder. We should have that after</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-        // conversion too.</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-        Assert.equal(curContentsCount, 1000);</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-      }</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-    }</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-  }</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-}</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-</span>
<a href="#l1.88"></a><span id="l1.88"> function run_test() {</span>
<a href="#l1.89"></a><span id="l1.89">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l1.90"></a><span id="l1.90"> </span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-  // {nsIMsgIncomingServer} pop server for the test.</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-  gServer = MailServices.accounts.createIncomingServer(&quot;test&quot;,&quot;localhost&quot;,</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-                                                       &quot;pop3&quot;);</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-  gAccount = MailServices.accounts.createAccount();</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-  gAccount.incomingServer = gServer;</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-  gServer.QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-  gServer.valid = true;</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-  gInbox = gAccount.incomingServer.rootFolder</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-    .getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+  add_task(async function() {</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+    await doMboxTest(&quot;test1&quot;, &quot;../../../data/mbox_modern&quot;, 2);</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+    await doMboxTest(&quot;test2&quot;, &quot;../../../data/mbox_mboxrd&quot;, 2);</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+    await doMboxTest(&quot;test3&quot;, &quot;../../../data/mbox_unquoted&quot;, 2);</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+    // Ideas for more tests:</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+    // - check a really big mbox</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+    // - check with really huge message (larger than one chunk)</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+    // - check mbox with &quot;From &quot; line on chunk boundary</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+    // - add tests for maildir-&gt;mbox conversion</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+    // - check that round-trip conversion preserves messages</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+    // - check that conversions preserve message body (ie that the</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+    //   &quot;From &quot; line escaping scheme is reversable)</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+  });</span>
<a href="#l1.114"></a><span id="l1.114"> </span>
<a href="#l1.115"></a><span id="l1.115">   run_next_test();</span>
<a href="#l1.116"></a><span id="l1.116"> }</span>
<a href="#l1.117"></a><span id="l1.117"> </span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-add_task(async function setupMessages() {</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-  let msgFile = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+/**</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+ * Helper to create a server, account and inbox, and install an</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+ * mbox file.</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+ * @return {nsIMsgIncomingServer} a server.</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+ */</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+function setupServer(srvName, mboxFilename) {</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+  // {nsIMsgIncomingServer} pop server for the test.</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+  let server = MailServices.accounts.createIncomingServer(srvName,&quot;localhost&quot;,</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+                                                       &quot;pop3&quot;);</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+  let account= MailServices.accounts.createAccount();</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+  account.incomingServer = server;</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+  server.QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+  server.valid = true;</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+  let inbox = account.incomingServer.rootFolder</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+    .getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l1.136"></a><span id="l1.136"> </span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-  // Add 1000 messages to the &quot;Inbox&quot; folder.</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-  for (let i = 0; i &lt; 1000; i++) {</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-    await copyFileMessage(msgFile, gInbox, false);</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-  }</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-});</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+  // install the mbox file</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+  let mboxFile = do_get_file(mboxFilename);</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+  mboxFile.copyTo( inbox.filePath.parent, inbox.filePath.leafName)</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+  // TODO: is there some way to make folder rescan the mbox?</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+  // We don't need it for this, but would be nice to do things properly.</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+  return server;</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+}</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+</span>
<a href="#l1.151"></a><span id="l1.151"> </span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-add_task(function testMaildirConversion() {</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+/**</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+ * Perform an mbox-&gt;maildir conversion test.</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+ *</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+ * @param {string} srvName - A unique server name to use for the test.</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+ * @param {string} mboxFilename - mbox file to install and convert.</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+ * @param {number} expectCnt - Number of messages expected.</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+ * @return {nsIMsgIncomingServer} a server.</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+ */</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+async function doMboxTest(srvName, mboxFilename, expectCnt) {</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+  // set up an account+server+inbox and copy in the test mbox file</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+  let server = setupServer(srvName, mboxFilename);</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+</span>
<a href="#l1.165"></a><span id="l1.165">   let mailstoreContractId = Services.prefs.getCharPref(</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-    &quot;mail.server.&quot; + gServer.key + &quot;.storeContractID&quot;);</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-  do_test_pending();</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineminus">-  let pConverted = convertMailStoreTo(mailstoreContractId, gServer,</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-                                      new EventTarget());</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-  let originalRootFolder = gServer.rootFolder.filePath;</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-  pConverted.then(function(aVal) {</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-    log.debug(&quot;Conversion done: &quot; + originalRootFolder.path + &quot; =&gt; &quot; + aVal);</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-    let newRootFolder = gServer.rootFolder.filePath;</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-    checkConversion(originalRootFolder, newRootFolder);</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-    do_test_finished();</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-  }).catch(function(aReason) {</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-    log.error(&quot;Conversion Failed: &quot; + aReason.error);</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-    ok(false); // Fail the test!</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-  });</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-});</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+    &quot;mail.server.&quot; + server.key + &quot;.storeContractID&quot;);</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+  let aVal = await convertMailStoreTo(</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineplus">+    mailstoreContractId, server, new EventTarget());</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineplus">+  // NOTE: convertMailStoreTo() will suppress exceptions in it's</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+  // worker, which makes unittest failures trickier to read...</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineplus">+</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineplus">+  let originalRootFolder = server.rootFolder.filePath;</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+  // Converted. Now find resulting Inbox/cur directory so</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+  // we can count the messages there.</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+  let inbox = server.rootFolder</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+    .getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+  // NOTE: the conversion updates the path of the root folder,</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+  // but _not_ the path of the inbox...</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+  // Ideally, we'd just use inbox.filePath here, but</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+  // instead we'll have compose the path manually.</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+  let curDir = server.rootFolder.filePath;</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+  curDir.append(inbox.filePath.leafName);</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+  curDir.append(&quot;cur&quot;);</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+  // Sanity check.</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+  Assert.ok(curDir.isDirectory(), &quot;'cur' directory created&quot; );</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+  // Check number of messages in Inbox/cur is what we expect.</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+  let cnt = 0;</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+  let it = curDir.directoryEntries;</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+  while (it.hasMoreElements()) {</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+    let curContent = it.getNext();</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+    cnt++;</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+  }</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+  Assert.equal(cnt, expectCnt, &quot;expected number of messages (&quot; + mboxFilename + &quot;)&quot;);</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+}</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/util/converterWorker.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/util/converterWorker.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,314 +1,483 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.5"></a><span id="l2.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.6"></a><span id="l2.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+/* eslint-env mozilla/chrome-worker, node */</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+</span>
<a href="#l2.10"></a><span id="l2.10"> /**</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineminus">- * This worker performs one of a set of operations requested by</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">- * mailstoreConverter.jsm. The possible operations are:</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">- * - copy a file (.dat or .msf)</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">- * - split a mbox file out into a maildir</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">- * - join the contents of a maildir into a mbox file</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">- * - create a subfolder (.sbd dir)</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">- * - handle a .mozmsgs directory</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+ * This worker will perform mbox&lt;-&gt;maildir conversions on a tree of</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+ * directories. It operates purely at the filesystem level.</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+ *</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+ * The initial message data should pass in these params to control</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+ * the conversion:</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+ *</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+ * srcType  - source mailstore type ('mbox' or 'maildir')</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+ * destType - destination mailstore type ('maildir' or 'mbox')</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+ * srcRoot  - root path of source (eg &quot;.../ImapMail/imap.example.com&quot;)</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+ * destRoot - root path of destination (eg &quot;/tmp/imap.example.com-maildir&quot;)</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+ *</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+ * The conversion is non-destructive - srcRoot will be left untouched.</span>
<a href="#l2.30"></a><span id="l2.30">  *</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">- * The caller relies on each worker to send the right number (and type)</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">- * of update notifications for the operation that worker is responsible</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">- * for.</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">- * The caller counts notifications to detect when the overall mailstore</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">- * conversion is complete.</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+ * The worker will post progess messages back to the main thread of</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+ * the form:</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+ *</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+ *   {&quot;msg&quot;: &quot;progress&quot;, &quot;val&quot;: val, &quot;total&quot;: total}</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+ *</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+ * Where `val` is the current progress, out of `total`.</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+ * The units used for val and total are undefined.</span>
<a href="#l2.43"></a><span id="l2.43">  *</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">- * Currently, the worker decides which operation it is responsible for</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">- * performing by looking at:</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">- *  - the name of the source</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">- *  - the type of the source (file or directory),</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">- *  - xpcom interface of the source mailstore (maildir or mbox).</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">- * Since mailstoreConverter.jsm is already scanning the store</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">- * and making these decisions, it would probably make sense to have it</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">- * specify the operation type explicitly rather than repeating the</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">- * logic here so the worker can decide.</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+ * When the conversion is complete, before exiting, the worker sends a</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+ * message of the form:</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+ *</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+ *   {&quot;msg&quot;: &quot;success&quot;}</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+ *</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+ * Errors are posted back to the main thread via the standard</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+ * &quot;error&quot; event.</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+ *</span>
<a href="#l2.61"></a><span id="l2.61">  */</span>
<a href="#l2.62"></a><span id="l2.62"> </span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-self.importScripts(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-self.addEventListener(&quot;message&quot;, function(e) {</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+importScripts(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+/**</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+ * Merge all the messages in a maildir into a single mbox file.</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+ *</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+ * @param {String} maildir              - Path to the source maildir.</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+ * @param {String} mboxFilename         - Path of the mbox file to create.</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+ * @param {Function(Number)} progressFn - Function to be invoked regularly with</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+ *                                        progress updates. Param is number of</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+ *                                        &quot;units&quot; processed since last update.</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+ */</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+function maildirToMBox(maildir, mboxFilename, progressFn) {</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+  // Helper to format dates</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+  // eg &quot;Thu Jan 18 12:34:56 2018&quot;</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+  let fmtUTC = function(d) {</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+    const dayNames = [&quot;Sun&quot;, &quot;Mon&quot;, &quot;Tue&quot;, &quot;Wed&quot;, &quot;Thu&quot;, &quot;Fri&quot;, &quot;Sat&quot;];</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+    const monthNames = [&quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;,</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+      &quot;May&quot;, &quot;Jun&quot;, &quot;Jul&quot;, &quot;Aug&quot;,</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+      &quot;Sep&quot;, &quot;Oct&quot;, &quot;Nov&quot;, &quot;Dec&quot;];</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+    return dayNames[d.getUTCDay()] +</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+      &quot; &quot; + monthNames[d.getUTCMonth()] +</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+      &quot; &quot; + d.getUTCDate().toString().padStart(2) +</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+      &quot; &quot; + d.getUTCHours().toString().padStart(2, &quot;0&quot;) +</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+      &quot;:&quot; + d.getUTCMinutes().toString().padStart(2, &quot;0&quot;) +</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+      &quot;:&quot; + d.getUTCSeconds().toString().padStart(2, &quot;0&quot;) +</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+      &quot; &quot; + d.getUTCFullYear();</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+  };</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+  let encoder = new TextEncoder();</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+  let mboxFile = OS.File.open(mboxFilename, {write: true, create: true}, {});</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+  // Iterate over all the message files in &quot;cur&quot;.</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+  let curPath = OS.Path.join(maildir, &quot;cur&quot;);</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+  let iterator = new OS.File.DirectoryIterator(curPath);</span>
<a href="#l2.99"></a><span id="l2.99">   try {</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-    // {String} sourceFile - path to file or directory encountered.</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-    var sourceFile = e.data[1];</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-    // {String} dest - path to directory in which the new files or directories</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-    // need to be created.</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-    var dest = e.data[0];</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-    // {String} destFile - name of the file or directory encountered.</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-    var destFile = e.data[2];</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-    var mailstoreContractId = e.data[3];</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-    var tmpDir = e.data[4];</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-    var serverType = e.data[5];</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-    var stat = OS.File.stat(sourceFile);</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+    let files = [];</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+    if (&quot;winCreationDate&quot; in OS.File.DirectoryIterator.Entry.prototype) {</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+      // Under Windows, additional information allow us to sort files immediately</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+      // without having to perform additional I/O.</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+      iterator.forEach(function(ent) {</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+        files.push({path: ent.path, creationDate: ent.winCreationDate});</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+      });</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+    } else {</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+      // Under other OSes, we need to call OS.File.stat</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+      iterator.forEach(function(ent) {</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+        files.push({path: ent.path, creationDate: OS.File.stat(ent.path).creationDate});</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+      });</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+    }</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+    // Sort by creation time.</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+    files.sort(function(a, b) {</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+        return a.creationDate - b.creationDate;</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+    });</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+    for (let ent of files) {</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+      let inFile = OS.File.open(ent.path);</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+      try {</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+        let raw = inFile.read();</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+        // Old converter had a bug where maildir messages included the</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+        // leading &quot;From &quot; marker, so we need to cope with any</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+        // cases of this left in the wild.</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+        if (String.fromCharCode.apply(null, raw.slice(0, 5)) != &quot;From &quot;) {</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+          // Write the separator line.</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+          // Technically, timestamp should be the reception time of the</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+          // message, but we don't really want to have to parse the</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+          // message here and nothing is likely to rely on iterator.</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+          let sepLine = &quot;From - &quot; + fmtUTC(new Date()) + &quot;\n&quot;;</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+          mboxFile.write(encoder.encode(sepLine));</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+        }</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+        mboxFile.write(raw);</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+      } finally {</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+        inFile.close();</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+      }</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+      // Maildir progress is one per message.</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+      progressFn(1);</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+    }</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+  } finally {</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+    iterator.close();</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+    mboxFile.close();</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+  }</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+}</span>
<a href="#l2.157"></a><span id="l2.157"> </span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-    if (stat.isDir &amp;&amp; sourceFile.substr(-8) == &quot;.mozmsgs&quot;) {</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-      // it's an OS search integration dir.</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-      // A no-op for now. Maildir/OS search integration is still</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-      // a little undecided (see bug 1144478).</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-      return;</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-    }</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+/**</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+ * Split an mbox file up into a maildir.</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+ *</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+ * @param {String} mboxPath             - Path of the mbox file to split.</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+ * @param {String} maildirPath          - Path of the maildir to create.</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+ * @param {Function(Number)} progressFn - Function to be invoked regularly with</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+ *                                        progress updates. One parameter is</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+ *                                        passed - the number of &quot;cost units&quot;</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+ *                                        since the previous update.</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+ */</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+function mboxToMaildir(mboxPath, maildirPath, progressFn) {</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+  // Create the maildir structure.</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+  OS.File.makeDir(maildirPath);</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+  let curDirPath = OS.Path.join(maildirPath, &quot;cur&quot;);</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+  let tmpDirPath = OS.Path.join(maildirPath, &quot;tmp&quot;);</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+  OS.File.makeDir(curDirPath);</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+  OS.File.makeDir(tmpDirPath);</span>
<a href="#l2.181"></a><span id="l2.181"> </span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-    if (stat.isDir &amp;&amp; sourceFile.substr(-4) == &quot;.sbd&quot;) {</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-      // it's a subfolder</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-      OS.File.makeDir(dest, {from: tmpDir});</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineminus">-      OS.File.makeDir(OS.Path.join(dest, destFile), {from: tmpDir});</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+  let decoder = new TextDecoder();</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+  let encoder = new TextEncoder();</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+  const CHUNK_SIZE = 10000000;</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+  // SAFE_MARGIN is how much to keep back between chunks in order to</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+  // cope with separator lines which might span chunks.</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+  const SAFE_MARGIN = 100;</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+  // A regexp to match mbox separator lines.</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+  // We support lines like:</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+  // &quot;From &quot;</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+  // &quot;From MAILER-DAEMON Fri Jul  8 12:08:34 2011&quot;</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+  // &quot;From - Mon Jul 11 12:08:34 2011&quot;</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+  // &quot;From bob@example.com Fri Jul  8 12:08:34 2011&quot;</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+  // we also require a message header on the next line, in order</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+  // to better cope with unescaped &quot;From &quot; lines in the message body.</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineplus">+  // note: the first subexpression matches the separator line, so</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+  // it can be removed from the input.</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+  let sepRE = /^((?:From \r?\n)|(?:From [\S]+ \S{3} \S{3} [ \d]\d \d\d:\d\d:\d\d \d{4}\r?\n))[\x21-\x7E]+:/gm;</span>
<a href="#l2.205"></a><span id="l2.205"> </span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-      // Send message to &quot;mailstoreConverter.jsm&quot; indicating that a directory</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-      // was created.</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-      // This would indicate &quot;progress&quot; for an imap account but not for a pop</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-      // account if the number of messages in the pop account is more than 0 and</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-      // mailstore type is mbox.</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-      // This would indicate &quot;progress&quot; for a pop account if the number of</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-      // messages in the pop account is 0 and the mailstore type is</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-      // mbox.</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-      // This would indicate &quot;progress&quot; for pop or imap account if the noumber</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-      // of messages in the account is 0.</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-      self.postMessage([&quot;dir&quot;, sourceFile]);</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-      return;</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+  // Use timestamp as starting name for output messages, incrementing</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+  // by one for each.</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+  let ident = Date.now();</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+  let outFile = null;</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+  let writeToMsg = function(text) {</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+    if (outFile === null) {</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+      let outPath = OS.Path.join(curDirPath, ident.toString());</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+      ident += 1;</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+      outFile = OS.File.open(outPath, {write: true, create: true}, {});</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+    }</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+    let raw = encoder.encode(text);</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+    outFile.write(raw);</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+    // for mbox-&gt;maildir conversion, progress measured in bytes</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineplus">+    progressFn(raw.byteLength);</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineplus">+  };</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+  let closeExistingMsg = function() {</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+    if (outFile) {</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+      outFile.close();</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+      outFile = null;</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+    }</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+  };</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+  let mboxFile = OS.File.open(mboxPath);</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+  let buf = &quot;&quot;;</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+  let eof = false;</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+  while (!eof) {</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+    let raw = mboxFile.read(CHUNK_SIZE);</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+    buf = buf + decoder.decode(raw);</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+    eof = (raw.byteLength &lt; CHUNK_SIZE);</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+    let pos = 0;</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+    sepRE.lastIndex = 0;  // start at beginning of buf</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+    let m = null;</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+    while ((m = sepRE.exec(buf)) !== null) {</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+      // Output everything up to the line separator.</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+      if (m.index &gt; pos) {</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+        writeToMsg(buf.substring(pos, m.index));</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+      }</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+      pos = m.index;</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineplus">+      pos += m[1].length;  // skip the &quot;From &quot; line</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineplus">+      closeExistingMsg();</span>
<a href="#l2.261"></a><span id="l2.261">     }</span>
<a href="#l2.262"></a><span id="l2.262"> </span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-    if (mailstoreContractId == &quot;@mozilla.org/msgstore/maildirstore;1&quot; &amp;&amp;</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-        stat.isDir &amp;&amp; sourceFile.substr(-4) != &quot;.sbd&quot;) {</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-      // copy messages from maildir -&gt; mbox</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-      // Create a directory with path 'dest'.</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-      OS.File.makeDir(dest, {from: tmpDir});</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-      // If the file with path 'dest/destFile' does not exist, create it,</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-      // open it for writing. This is the mbox msg file with the same name as</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">-      // 'sourceFile'.</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-      let mboxFile;</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">-      if (!OS.File.exists(OS.Path.join(dest,destFile))) {</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineminus">-        mboxFile = OS.File.open(OS.Path.join(dest,destFile), {write: true,</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineminus">-          create: true}, {});</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-      }</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-      // If length of 'e.data' is greater than 6, we know that e.data carries</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-      // maildir msg file names.</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-      if (e.data.length &gt; 6) {</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-        for(let msgCount = 0; msgCount &lt; e.data.length - 6; msgCount++) {</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-          let n = e.data[msgCount + 6];</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-          // Open the file 'sourceFile/cur/msgFile' for reading.</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-          let msgFileOpen = OS.File.open(OS.Path.join(sourceFile, &quot;cur&quot;, n));</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineminus">-          mboxFile.write(msgFileOpen.read());</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineminus">-          msgFileOpen.close();</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineminus">-</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-          // Send a message to &quot;mailstoreConverter.jsm&quot; indicating that a</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-          // msg was copied. This would indicate &quot;progress&quot; for both imap and</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineminus">-          // pop accounts if mailstore type is maildir and the no. of</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineminus">-          // msgs in the account is greater than zero.</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-          self.postMessage([&quot;copied&quot;, OS.Path.join(sourceFile, &quot;cur&quot;, n)]);</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-        }</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+    // Deal with whatever is left in the buffer.</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+    let endPos = buf.length;</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+    if (!eof) {</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+      // Keep back enough to cope with separator lines crossing</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+      // chunk boundaries.</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+      endPos -= SAFE_MARGIN;</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+      if (endPos &lt; pos) {</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+        endPos = pos;</span>
<a href="#l2.303"></a><span id="l2.303">       }</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-      mboxFile.close();</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-      // Send a message to &quot;mailstoreConverter.jsm&quot; indicating that an mbox msg</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-      // file was created. This would indicate &quot;progress&quot; for both imap and pop</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineminus">-      // accounts if mailstore type is maildir and the no. of messages in</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineminus">-      // the account is 0.</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineminus">-      self.postMessage([&quot;file&quot;, sourceFile, e.data.length]);</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-      return;</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineminus">-    }</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineminus">-</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineminus">-</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-    // If a file is encountered, then if it is a .dat file, copy the</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineminus">-    // file to the directory whose path is in 'dest'.</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineminus">-    // For Local Folders, pop3, and movemail accounts, when the .msf files</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineminus">-    // are copied, something goes wrong with the .msf files and the messages</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineminus">-    // don't show up. Thunderbird automatically creates .msf files. So to</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineminus">-    // resolve this, .msf files are not copied for Local Folders, pop3 and</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineminus">-    // movemail accounts.</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineminus">-    let ext = sourceFile.substr(-4);</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineminus">-    if (!stat.isDir &amp;&amp; ((ext == &quot;.msf&quot;) || (ext == &quot;.dat&quot;))) {</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineminus">-      if (ext == &quot;.dat&quot; || (serverType == &quot;imap&quot; || serverType == &quot;nntp&quot;)) {</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineminus">-        // If the directory with path 'dest' does not exist, create it.</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineminus">-        if (!OS.File.exists(dest)) {</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineminus">-          OS.File.makeDir(dest, {from: tmpDir});</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineminus">-        }</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-        OS.File.copy(sourceFile, OS.Path.join(dest,destFile));</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-      }</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineminus">-</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineminus">-      // Send a message to &quot;mailstoreConverter.jsm&quot; indicating that a .msf or</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-      // .dat file was copied.</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-      // This is used to indicate progress on IMAP accounts if mailstore</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-      // type is mbox.</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineminus">-      // This is used to indicate progress on pop accounts if the no. of msgs</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineminus">-      // in the account is 0 and mailstore type is mbox.</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineminus">-      // This is used to indicate progress on pop and imap accounts if the</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineminus">-      // no. of msgs in the account is 0 and mailstore type is maildir.</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineminus">-      self.postMessage([&quot;msfdat&quot;, sourceFile]);</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineminus">-      return;</span>
<a href="#l2.343"></a><span id="l2.343">     }</span>
<a href="#l2.344"></a><span id="l2.344"> </span>
<a href="#l2.345"></a><span id="l2.345" class="difflineminus">-    // All other files are assumed to be mbox.</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineminus">-    if (!stat.isDir &amp;&amp; mailstoreContractId != &quot;@mozilla.org/msgstore/maildirstore;1&quot;) {</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineminus">-      // An mbox message file is encountered. Split it up into a maildir.</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+    if (endPos &gt; pos) {</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+      writeToMsg(buf.substring(pos, endPos));</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+    }</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+    buf = buf.substring(endPos);</span>
<a href="#l2.352"></a><span id="l2.352"> </span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">-      const constNoOfBytes = 10000000;</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineminus">-      // (TODO: check this doesn't bound the size of messages we can convert!)</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineminus">-</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineminus">-      // Create a directory with path 'dest'.</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineminus">-      OS.File.makeDir(dest, {from: tmpDir});</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineplus">+  }</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineplus">+  closeExistingMsg();</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineplus">+}</span>
<a href="#l2.361"></a><span id="l2.361"> </span>
<a href="#l2.362"></a><span id="l2.362" class="difflineminus">-      // Create a directory with same name as the file encountered in the</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineminus">-      // directory with path 'dest'.</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineminus">-      // In this directory create a directory with name &quot;cur&quot; and a directory</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-      // with name &quot;tmp&quot;.</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineminus">-      OS.File.makeDir(OS.Path.join(dest, destFile));</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineminus">-      OS.File.makeDir(OS.Path.join(dest, destFile, &quot;cur&quot;));</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-      OS.File.makeDir(OS.Path.join(dest, destFile, &quot;tmp&quot;));</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-      let decoder = new TextDecoder();</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineminus">-      let encoder = new TextEncoder();</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+/**</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+ * Check if directory is a subfolder directory.</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+ *</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+ * @param {String} name     - Name of directory to check.</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+ * @returns {Boolean}       - true if subfolder.</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineplus">+ */</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+function isSBD(name) {</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+  return name.substr(-4) == &quot;.sbd&quot;;</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+}</span>
<a href="#l2.381"></a><span id="l2.381"> </span>
<a href="#l2.382"></a><span id="l2.382" class="difflineminus">-      // File to which the message is to be copied.</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineminus">-      let targetFile = null;</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineminus">-      // Get a timestamp for file name.</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineminus">-      let name = Date.now();</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineminus">-      // No. of bytes to be read from the source file.</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineminus">-      // Needs to be a large size to read in chunks.</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineminus">-      let noOfBytes = constNoOfBytes;</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineminus">-      // 'text' holds the string that was read.</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineminus">-      let text = null;</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineminus">-      // Index of last match in 'text'.</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-      let lastMatchIndex;</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineminus">-      // Current position in the source file before reading bytes from it.</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineminus">-      let position;</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineminus">-      // New position in the source file after reading bytes from it.</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineminus">-      let nextPos;</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineminus">-      // New length of the text read from source file.</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineminus">-      let nextLen;</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineminus">-      // Position in the file after reading the bytes in the previous</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineminus">-      // iteration.</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineminus">-      let prevPos = 0;</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineminus">-      // Length of the text read from source file in the previous</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineminus">-      // iteration.</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineminus">-      let prevLen = 0;</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineminus">-      // Bytes read from the source file are decoded into a string and</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineminus">-      // assigned to 'textNew'.</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineminus">-      let textNew;</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineplus">+/**</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+ * Check if file is a type which should be copied verbatim as part of a</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+ * conversion.</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineplus">+ *</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineplus">+ * @param {String} name     - Name of file to check.</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineplus">+ * @returns {Boolean}       - true if file should be copied verbatim.</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+ */</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineplus">+function isFileToCopy(name) {</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineplus">+  let ext4 = name.substr(-4);</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineplus">+  if (ext4 == &quot;.msf&quot; || ext4 == &quot;.dat&quot;) {</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineplus">+    return true;</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineplus">+  }</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineplus">+  return false;</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineplus">+}</span>
<a href="#l2.422"></a><span id="l2.422"> </span>
<a href="#l2.423"></a><span id="l2.423" class="difflineminus">-      // Read the file. Since the files can be large, we read it in chunks.</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineminus">-      let sourceFileOpen = OS.File.open(sourceFile);</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineminus">-      while (true) {</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineminus">-        position = sourceFileOpen.getPosition();</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineminus">-        let array = sourceFileOpen.read(noOfBytes);</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineminus">-        textNew = decoder.decode(array);</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineminus">-        nextPos = sourceFileOpen.getPosition();</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineminus">-        nextLen = textNew.length;</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineminus">-</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineminus">-        if (nextPos == prevPos &amp;&amp; nextLen == prevLen) {</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineminus">-          // Reached the last message in the source file.</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineminus">-          if (text !== null) {</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineminus">-            // Array to hold indices of &quot;From -&quot; matches found within 'text'.</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineminus">-            let lastPos = [];</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineminus">-            // Regular expression to find &quot;From - &quot; at beginning of lines.</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineminus">-            let regexpLast = /^(From - )/gm;</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineminus">-            let resultLast = regexpLast.exec(text);</span>
<a href="#l2.440"></a><span id="l2.440" class="difflineminus">-            while (resultLast !== null) {</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineminus">-              lastPos[lastPos.length] = resultLast.index;</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineminus">-              resultLast = regexpLast.exec(text);</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineminus">-            }</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineplus">+/**</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineplus">+ * Check if file is an mbox.</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineplus">+ * (actually we can't really tell if it's an mbox or not just from the name.</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineplus">+ * we just assume it is, if it's not .msf or .dat).</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineplus">+ *</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineplus">+ * @param {String} name     - Name of file to check.</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineplus">+ * @returns {Boolean}       - true if file is an mbox</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineplus">+ */</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineplus">+function isMBoxName(name) {</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineplus">+  let ext4 = name.substr(-4);</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineplus">+  if (ext4 == &quot;.msf&quot; || ext4 == &quot;.dat&quot;) {</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineplus">+    return false;</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineplus">+  }</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineplus">+  // Assume all other files are mbox.</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineplus">+  return true;</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineplus">+}</span>
<a href="#l2.460"></a><span id="l2.460"> </span>
<a href="#l2.461"></a><span id="l2.461" class="difflineminus">-            // Create a maildir message file in 'dest/destFile/cur/'</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineminus">-            // and open it for writing.</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineminus">-            targetFile = OS.File.open(OS.Path.join(dest, destFile, &quot;cur&quot;,</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineminus">-              name.toString()), {write: true, create: true}, {});</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineminus">-</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineminus">-            // Extract the text in 'text' between 'lastPos[0]' ie the</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineminus">-            // index of the first &quot;From - &quot; match and the end of 'text'.</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineminus">-            targetFile.write(encoder.encode(text.substring(lastPos[0],</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineminus">-              text.length)));</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineminus">-            targetFile.close();</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineminus">-</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineminus">-            // Send a message indicating that a message was copied.</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineminus">-            // This indicates progress for a pop account if the no. of msgs</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineminus">-            // in the account is more than 0 and mailstore type is mbox.</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineminus">-            self.postMessage([&quot;copied&quot;, name, position]);</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineminus">-          }</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineminus">-</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineminus">-          break;</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineminus">-        }  else {</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineminus">-          // We might have more messages in the source file.</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineminus">-          prevPos = nextPos;</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineminus">-          prevLen = nextLen;</span>
<a href="#l2.483"></a><span id="l2.483" class="difflineminus">-          text = textNew;</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineminus">-        }</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineminus">-</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineminus">-        // Array to hold indices of &quot;From -&quot; matches found within 'text'.</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineminus">-        let msgPos = [];</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineminus">-        // Regular expression to find &quot;From - &quot; at beginning of lines.</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineminus">-        let regexp = /^(From - )/gm;</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineminus">-        let result = regexp.exec(text);</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineminus">-        while (result !== null) {</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineminus">-          msgPos[msgPos.length] = result.index;</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineminus">-          result = regexp.exec(text);</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineminus">-        }</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineplus">+/**</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineplus">+ * Check if directory is a maildir (by looking for a &quot;cur&quot; subdir).</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineplus">+ *</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineplus">+ * @param {String} dir    - Path of directory to check.</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineplus">+ * @returns {Boolean}     - true if directory is a maildir.</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineplus">+ */</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineplus">+function isMaildir(dir) {</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineplus">+  try {</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineplus">+    let cur = OS.Path.join(dir, &quot;cur&quot;);</span>
<a href="#l2.504"></a><span id="l2.504" class="difflineplus">+    let fi = OS.File.stat(cur);</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineplus">+    return fi.isDir;</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineplus">+  } catch (ex) {</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineplus">+    if (ex instanceof OS.File.Error &amp;&amp; ex.becauseNoSuchFile) {</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineplus">+      // &quot;cur&quot; does not exist - not a maildir.</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineplus">+      return false;</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineplus">+    }</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineplus">+    throw ex; // Other error.</span>
<a href="#l2.512"></a><span id="l2.512" class="difflineplus">+  }</span>
<a href="#l2.513"></a><span id="l2.513" class="difflineplus">+}</span>
<a href="#l2.514"></a><span id="l2.514"> </span>
<a href="#l2.515"></a><span id="l2.515" class="difflineminus">-        if (msgPos.length &gt; 1) {</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineminus">-          // More than one &quot;From - &quot; match is found.</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineminus">-          noOfBytes = constNoOfBytes;</span>
<a href="#l2.518"></a><span id="l2.518" class="difflineminus">-          for (let i = 0; i &lt; msgPos.length - 1; i++) {</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineminus">-            // Create and open a new file in 'dest/destFile/cur'</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineminus">-            // to hold the next mail.</span>
<a href="#l2.521"></a><span id="l2.521" class="difflineminus">-            targetFile = OS.File.open(OS.Path.join(dest, destFile, &quot;cur&quot;,</span>
<a href="#l2.522"></a><span id="l2.522" class="difflineminus">-              name.toString()), {write: true, create: true}, {});</span>
<a href="#l2.523"></a><span id="l2.523" class="difflineminus">-            // Extract the text lying between consecutive indices, encode</span>
<a href="#l2.524"></a><span id="l2.524" class="difflineminus">-            // it and write it.</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineminus">-            targetFile.write(encoder.encode(text.substring(msgPos[i],</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineminus">-              msgPos[i + 1])));</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineminus">-            targetFile.close();</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineminus">-</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineminus">-            // Send a message indicating that a mail was copied.</span>
<a href="#l2.530"></a><span id="l2.530" class="difflineminus">-            // This indicates progress for a pop account if the no. of msgs</span>
<a href="#l2.531"></a><span id="l2.531" class="difflineminus">-            // in the account is more than 0 and mailstore type is mbox.</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineminus">-            self.postMessage([&quot;copied&quot;, name, position + msgPos[i],</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineminus">-              position + msgPos[i + 1]]);</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineplus">+/**</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineplus">+ * Count the number of messages in the &quot;cur&quot; dir of maildir.</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineplus">+ *</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineplus">+ * @param {String} maildir  - Path of maildir.</span>
<a href="#l2.538"></a><span id="l2.538" class="difflineplus">+ * @returns {Number}        - number of messages found.</span>
<a href="#l2.539"></a><span id="l2.539" class="difflineplus">+ */</span>
<a href="#l2.540"></a><span id="l2.540" class="difflineplus">+function countMaildirMsgs(maildir) {</span>
<a href="#l2.541"></a><span id="l2.541" class="difflineplus">+  let cur = OS.Path.join(maildir, &quot;cur&quot;);</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineplus">+  let iterator = new OS.File.DirectoryIterator(cur);</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineplus">+  let count = 0;</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineplus">+  try {</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineplus">+    iterator.forEach(function(ent) { count++; });</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineplus">+  } finally {</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineplus">+    iterator.close();</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineplus">+  }</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineplus">+  return count;</span>
<a href="#l2.550"></a><span id="l2.550" class="difflineplus">+}</span>
<a href="#l2.551"></a><span id="l2.551"> </span>
<a href="#l2.552"></a><span id="l2.552" class="difflineminus">-            // Increment 'name' to get a new file name.</span>
<a href="#l2.553"></a><span id="l2.553" class="difflineminus">-            // Cannot use Date.now() because it is possible to get the</span>
<a href="#l2.554"></a><span id="l2.554" class="difflineminus">-            // same timestamp as before.</span>
<a href="#l2.555"></a><span id="l2.555" class="difflineminus">-            name++;</span>
<a href="#l2.556"></a><span id="l2.556" class="difflineminus">-</span>
<a href="#l2.557"></a><span id="l2.557" class="difflineminus">-            // Set index of the (i+1)th &quot;From - &quot; match found in 'text'.</span>
<a href="#l2.558"></a><span id="l2.558" class="difflineminus">-            lastMatchIndex = msgPos[i + 1];</span>
<a href="#l2.559"></a><span id="l2.559" class="difflineminus">-          }</span>
<a href="#l2.560"></a><span id="l2.560" class="difflineminus">-</span>
<a href="#l2.561"></a><span id="l2.561" class="difflineminus">-          // Now 'lastMatchIndex' holds the index of the last match found in</span>
<a href="#l2.562"></a><span id="l2.562" class="difflineminus">-          // 'text'. So we move the position in the file to 'position +</span>
<a href="#l2.563"></a><span id="l2.563" class="difflineminus">-          // lastMatchIndex' from the beginning of the file.</span>
<a href="#l2.564"></a><span id="l2.564" class="difflineminus">-          // This ensures that the next 'text' starts from &quot;From - &quot;</span>
<a href="#l2.565"></a><span id="l2.565" class="difflineminus">-          // and that there is at least 1 match every time.</span>
<a href="#l2.566"></a><span id="l2.566" class="difflineminus">-          sourceFileOpen.setPosition(position + lastMatchIndex,</span>
<a href="#l2.567"></a><span id="l2.567" class="difflineminus">-            OS.File.POS_START);</span>
<a href="#l2.568"></a><span id="l2.568" class="difflineminus">-        } else {</span>
<a href="#l2.569"></a><span id="l2.569" class="difflineminus">-          // If 1 match is found increase the no. of bytes to be extracted by</span>
<a href="#l2.570"></a><span id="l2.570" class="difflineminus">-          // 1000000 and move the position in the file to 'position', i.e. the</span>
<a href="#l2.571"></a><span id="l2.571" class="difflineminus">-          // position in the file before reading the bytes.</span>
<a href="#l2.572"></a><span id="l2.572" class="difflineminus">-          sourceFileOpen.setPosition(position, OS.File.POS_START);</span>
<a href="#l2.573"></a><span id="l2.573" class="difflineminus">-          noOfBytes = noOfBytes + 1000000;</span>
<a href="#l2.574"></a><span id="l2.574" class="difflineplus">+/**</span>
<a href="#l2.575"></a><span id="l2.575" class="difflineplus">+ * Recursively calculate the 'cost' of a hierarchy of maildir folders.</span>
<a href="#l2.576"></a><span id="l2.576" class="difflineplus">+ * This is the figure used for progress updates.</span>
<a href="#l2.577"></a><span id="l2.577" class="difflineplus">+ * For maildir, cost is 1 per message.</span>
<a href="#l2.578"></a><span id="l2.578" class="difflineplus">+ *</span>
<a href="#l2.579"></a><span id="l2.579" class="difflineplus">+ * @param {String} srcPath  - Path of root dir containing maildirs.</span>
<a href="#l2.580"></a><span id="l2.580" class="difflineplus">+ * @returns {Number}        - calculated conversion cost.</span>
<a href="#l2.581"></a><span id="l2.581" class="difflineplus">+ */</span>
<a href="#l2.582"></a><span id="l2.582" class="difflineplus">+function calcMaildirCost(srcPath) {</span>
<a href="#l2.583"></a><span id="l2.583" class="difflineplus">+  let cost = 0;</span>
<a href="#l2.584"></a><span id="l2.584" class="difflineplus">+  let iterator = new OS.File.DirectoryIterator(srcPath);</span>
<a href="#l2.585"></a><span id="l2.585" class="difflineplus">+  try {</span>
<a href="#l2.586"></a><span id="l2.586" class="difflineplus">+    iterator.forEach(function(ent) {</span>
<a href="#l2.587"></a><span id="l2.587" class="difflineplus">+      if (ent.isDir) {</span>
<a href="#l2.588"></a><span id="l2.588" class="difflineplus">+        if (isSBD(ent.name)) {</span>
<a href="#l2.589"></a><span id="l2.589" class="difflineplus">+          // Recurse into subfolder.</span>
<a href="#l2.590"></a><span id="l2.590" class="difflineplus">+          cost += calcMaildirCost(ent.path);</span>
<a href="#l2.591"></a><span id="l2.591" class="difflineplus">+        } else if (isMaildir(ent.path)) {</span>
<a href="#l2.592"></a><span id="l2.592" class="difflineplus">+          // Looks like a maildir. Cost is number of messages.</span>
<a href="#l2.593"></a><span id="l2.593" class="difflineplus">+          cost += countMaildirMsgs(ent.path);</span>
<a href="#l2.594"></a><span id="l2.594">         }</span>
<a href="#l2.595"></a><span id="l2.595">       }</span>
<a href="#l2.596"></a><span id="l2.596" class="difflineplus">+    });</span>
<a href="#l2.597"></a><span id="l2.597" class="difflineplus">+  } finally {</span>
<a href="#l2.598"></a><span id="l2.598" class="difflineplus">+    iterator.close();</span>
<a href="#l2.599"></a><span id="l2.599" class="difflineplus">+  }</span>
<a href="#l2.600"></a><span id="l2.600" class="difflineplus">+  return cost;</span>
<a href="#l2.601"></a><span id="l2.601" class="difflineplus">+}</span>
<a href="#l2.602"></a><span id="l2.602"> </span>
<a href="#l2.603"></a><span id="l2.603" class="difflineminus">-      // Send a message indicating that a message file was encountered.</span>
<a href="#l2.604"></a><span id="l2.604" class="difflineminus">-      // This indicates progress for an imap account if mailstore type is</span>
<a href="#l2.605"></a><span id="l2.605" class="difflineminus">-      // mbox.</span>
<a href="#l2.606"></a><span id="l2.606" class="difflineminus">-      // This indicates progress for a pop account if mailstore type is</span>
<a href="#l2.607"></a><span id="l2.607" class="difflineminus">-      // mbox and the no. of msgs in the account is 0.</span>
<a href="#l2.608"></a><span id="l2.608" class="difflineminus">-      self.postMessage([&quot;file&quot;, sourceFile, textNew.length]);</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineminus">-      return;</span>
<a href="#l2.610"></a><span id="l2.610" class="difflineplus">+/**</span>
<a href="#l2.611"></a><span id="l2.611" class="difflineplus">+ * Recursively calculate the 'cost' of a hierarchy of mbox folders.</span>
<a href="#l2.612"></a><span id="l2.612" class="difflineplus">+ * This is the figure used for progress updates.</span>
<a href="#l2.613"></a><span id="l2.613" class="difflineplus">+ * For mbox, cost is the total byte size of data. This avoids the need to</span>
<a href="#l2.614"></a><span id="l2.614" class="difflineplus">+ * parse the mbox files to count the number of messages.</span>
<a href="#l2.615"></a><span id="l2.615" class="difflineplus">+ * Note that this byte count cost is not 100% accurate because it includes</span>
<a href="#l2.616"></a><span id="l2.616" class="difflineplus">+ * the &quot;From &quot; lines which are not written into the maildir files. But it's</span>
<a href="#l2.617"></a><span id="l2.617" class="difflineplus">+ * definitely close enough to give good user feedback.</span>
<a href="#l2.618"></a><span id="l2.618" class="difflineplus">+ *</span>
<a href="#l2.619"></a><span id="l2.619" class="difflineplus">+ * @param {String} srcPath  - Path of root dir containing maildirs.</span>
<a href="#l2.620"></a><span id="l2.620" class="difflineplus">+ * @returns {Number}        - calculated conversion cost.</span>
<a href="#l2.621"></a><span id="l2.621" class="difflineplus">+ */</span>
<a href="#l2.622"></a><span id="l2.622" class="difflineplus">+function calcMBoxCost(srcPath) {</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineplus">+  let cost = 0;</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineplus">+  let iterator = new OS.File.DirectoryIterator(srcPath);</span>
<a href="#l2.625"></a><span id="l2.625" class="difflineplus">+  try {</span>
<a href="#l2.626"></a><span id="l2.626" class="difflineplus">+    iterator.forEach(function(ent) {</span>
<a href="#l2.627"></a><span id="l2.627" class="difflineplus">+      if (ent.isDir) {</span>
<a href="#l2.628"></a><span id="l2.628" class="difflineplus">+        if (isSBD(ent.name)) {</span>
<a href="#l2.629"></a><span id="l2.629" class="difflineplus">+          // Recurse into .sbd subfolder.</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineplus">+          cost += calcMBoxCost(ent.path);</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineplus">+        }</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineplus">+      } else if (isMBoxName(ent.name)) {</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineplus">+        let fi = OS.File.stat(ent.path);</span>
<a href="#l2.634"></a><span id="l2.634" class="difflineplus">+        cost += fi.size;</span>
<a href="#l2.635"></a><span id="l2.635" class="difflineplus">+      }</span>
<a href="#l2.636"></a><span id="l2.636" class="difflineplus">+    });</span>
<a href="#l2.637"></a><span id="l2.637" class="difflineplus">+  } finally {</span>
<a href="#l2.638"></a><span id="l2.638" class="difflineplus">+    iterator.close();</span>
<a href="#l2.639"></a><span id="l2.639" class="difflineplus">+  }</span>
<a href="#l2.640"></a><span id="l2.640" class="difflineplus">+  return cost;</span>
<a href="#l2.641"></a><span id="l2.641" class="difflineplus">+}</span>
<a href="#l2.642"></a><span id="l2.642" class="difflineplus">+</span>
<a href="#l2.643"></a><span id="l2.643" class="difflineplus">+/**</span>
<a href="#l2.644"></a><span id="l2.644" class="difflineplus">+ * Recursively convert a tree of mbox-based folders to maildirs.</span>
<a href="#l2.645"></a><span id="l2.645" class="difflineplus">+ *</span>
<a href="#l2.646"></a><span id="l2.646" class="difflineplus">+ * @param {String} srcPath              - Root path containing mboxes.</span>
<a href="#l2.647"></a><span id="l2.647" class="difflineplus">+ * @param {String} destPath             - Where to create destination root.</span>
<a href="#l2.648"></a><span id="l2.648" class="difflineplus">+ * @param {Function(Number)} progressFn - Function to be invoked regularly with</span>
<a href="#l2.649"></a><span id="l2.649" class="difflineplus">+ *                                        progress updates (called with number of</span>
<a href="#l2.650"></a><span id="l2.650" class="difflineplus">+ *                                        cost &quot;units&quot; since last update)</span>
<a href="#l2.651"></a><span id="l2.651" class="difflineplus">+ */</span>
<a href="#l2.652"></a><span id="l2.652" class="difflineplus">+function convertTreeMBoxToMaildir(srcPath, destPath, progressFn) {</span>
<a href="#l2.653"></a><span id="l2.653" class="difflineplus">+  OS.File.makeDir(destPath);</span>
<a href="#l2.654"></a><span id="l2.654" class="difflineplus">+</span>
<a href="#l2.655"></a><span id="l2.655" class="difflineplus">+  let iterator = new OS.File.DirectoryIterator(srcPath);</span>
<a href="#l2.656"></a><span id="l2.656" class="difflineplus">+  try {</span>
<a href="#l2.657"></a><span id="l2.657" class="difflineplus">+    iterator.forEach(function(ent) {</span>
<a href="#l2.658"></a><span id="l2.658" class="difflineplus">+      let dest = OS.Path.join(destPath, ent.name);</span>
<a href="#l2.659"></a><span id="l2.659" class="difflineplus">+      if (ent.isDir) {</span>
<a href="#l2.660"></a><span id="l2.660" class="difflineplus">+        if (isSBD(ent.name)) {</span>
<a href="#l2.661"></a><span id="l2.661" class="difflineplus">+          // Recurse into .sbd subfolder.</span>
<a href="#l2.662"></a><span id="l2.662" class="difflineplus">+          convertTreeMBoxToMaildir(ent.path, dest, progressFn);</span>
<a href="#l2.663"></a><span id="l2.663" class="difflineplus">+        }</span>
<a href="#l2.664"></a><span id="l2.664" class="difflineplus">+      } else if (isFileToCopy(ent.name)) {</span>
<a href="#l2.665"></a><span id="l2.665" class="difflineplus">+        OS.File.copy(ent.path, dest);</span>
<a href="#l2.666"></a><span id="l2.666" class="difflineplus">+      } else if (isMBoxName(ent.name)) {</span>
<a href="#l2.667"></a><span id="l2.667" class="difflineplus">+        // It's an mbox. Convert iterator.</span>
<a href="#l2.668"></a><span id="l2.668" class="difflineplus">+        mboxToMaildir(ent.path, dest, progressFn);</span>
<a href="#l2.669"></a><span id="l2.669" class="difflineplus">+      }</span>
<a href="#l2.670"></a><span id="l2.670" class="difflineplus">+    });</span>
<a href="#l2.671"></a><span id="l2.671" class="difflineplus">+  } finally {</span>
<a href="#l2.672"></a><span id="l2.672" class="difflineplus">+    iterator.close();</span>
<a href="#l2.673"></a><span id="l2.673" class="difflineplus">+  }</span>
<a href="#l2.674"></a><span id="l2.674" class="difflineplus">+}</span>
<a href="#l2.675"></a><span id="l2.675" class="difflineplus">+</span>
<a href="#l2.676"></a><span id="l2.676" class="difflineplus">+/**</span>
<a href="#l2.677"></a><span id="l2.677" class="difflineplus">+ * Recursively convert a tree of maildir-based folders to mbox.</span>
<a href="#l2.678"></a><span id="l2.678" class="difflineplus">+ *</span>
<a href="#l2.679"></a><span id="l2.679" class="difflineplus">+ * @param {String} srcPath              - Root path containing maildirs.</span>
<a href="#l2.680"></a><span id="l2.680" class="difflineplus">+ * @param {String} destPath             - Where to create destination root.</span>
<a href="#l2.681"></a><span id="l2.681" class="difflineplus">+ * @param {Function(Number)} progressFn - Function to be invoked regularly with</span>
<a href="#l2.682"></a><span id="l2.682" class="difflineplus">+ *                                        progress updates (called with number of</span>
<a href="#l2.683"></a><span id="l2.683" class="difflineplus">+ *                                        cost &quot;units&quot; since last update)</span>
<a href="#l2.684"></a><span id="l2.684" class="difflineplus">+ */</span>
<a href="#l2.685"></a><span id="l2.685" class="difflineplus">+function convertTreeMaildirToMBox(srcPath, destPath, progressFn) {</span>
<a href="#l2.686"></a><span id="l2.686" class="difflineplus">+  OS.File.makeDir(destPath);</span>
<a href="#l2.687"></a><span id="l2.687" class="difflineplus">+</span>
<a href="#l2.688"></a><span id="l2.688" class="difflineplus">+  let iterator = new OS.File.DirectoryIterator(srcPath);</span>
<a href="#l2.689"></a><span id="l2.689" class="difflineplus">+  try {</span>
<a href="#l2.690"></a><span id="l2.690" class="difflineplus">+    iterator.forEach(function(ent) {</span>
<a href="#l2.691"></a><span id="l2.691" class="difflineplus">+      let dest = OS.Path.join(destPath, ent.name);</span>
<a href="#l2.692"></a><span id="l2.692" class="difflineplus">+      if (ent.isDir) {</span>
<a href="#l2.693"></a><span id="l2.693" class="difflineplus">+        if (isSBD(ent.name)) {</span>
<a href="#l2.694"></a><span id="l2.694" class="difflineplus">+          // Recurse into .sbd subfolder.</span>
<a href="#l2.695"></a><span id="l2.695" class="difflineplus">+          convertTreeMaildirToMBox(ent.path, dest, progressFn);</span>
<a href="#l2.696"></a><span id="l2.696" class="difflineplus">+        } else if (isMaildir(ent.path)) {</span>
<a href="#l2.697"></a><span id="l2.697" class="difflineplus">+          // It's a maildir - convert iterator.</span>
<a href="#l2.698"></a><span id="l2.698" class="difflineplus">+          maildirToMBox(ent.path, dest, progressFn);</span>
<a href="#l2.699"></a><span id="l2.699" class="difflineplus">+        }</span>
<a href="#l2.700"></a><span id="l2.700" class="difflineplus">+      } else if (isFileToCopy(ent.name)) {</span>
<a href="#l2.701"></a><span id="l2.701" class="difflineplus">+        OS.File.copy(ent.path, dest);</span>
<a href="#l2.702"></a><span id="l2.702" class="difflineplus">+      }</span>
<a href="#l2.703"></a><span id="l2.703" class="difflineplus">+    });</span>
<a href="#l2.704"></a><span id="l2.704" class="difflineplus">+  } finally {</span>
<a href="#l2.705"></a><span id="l2.705" class="difflineplus">+    iterator.close();</span>
<a href="#l2.706"></a><span id="l2.706" class="difflineplus">+  }</span>
<a href="#l2.707"></a><span id="l2.707" class="difflineplus">+}</span>
<a href="#l2.708"></a><span id="l2.708" class="difflineplus">+</span>
<a href="#l2.709"></a><span id="l2.709" class="difflineplus">+self.addEventListener(&quot;message&quot;, function(e) {</span>
<a href="#l2.710"></a><span id="l2.710" class="difflineplus">+  try {</span>
<a href="#l2.711"></a><span id="l2.711" class="difflineplus">+    // Unpack the request params from the main thread.</span>
<a href="#l2.712"></a><span id="l2.712" class="difflineplus">+    let srcType = e.data.srcType;</span>
<a href="#l2.713"></a><span id="l2.713" class="difflineplus">+    let destType = e.data.destType;</span>
<a href="#l2.714"></a><span id="l2.714" class="difflineplus">+    let srcRoot = e.data.srcRoot;</span>
<a href="#l2.715"></a><span id="l2.715" class="difflineplus">+    let destRoot = e.data.destRoot;</span>
<a href="#l2.716"></a><span id="l2.716" class="difflineplus">+    // destRoot will be a temporary dir, so if it all goes pear-shaped</span>
<a href="#l2.717"></a><span id="l2.717" class="difflineplus">+    // we can just bail out without cleaning up.</span>
<a href="#l2.718"></a><span id="l2.718" class="difflineplus">+</span>
<a href="#l2.719"></a><span id="l2.719" class="difflineplus">+    // Configure the conversion.</span>
<a href="#l2.720"></a><span id="l2.720" class="difflineplus">+    let costFn = null;</span>
<a href="#l2.721"></a><span id="l2.721" class="difflineplus">+    let convertFn = null;</span>
<a href="#l2.722"></a><span id="l2.722" class="difflineplus">+    if (srcType == &quot;maildir&quot; &amp;&amp; destType == &quot;mbox&quot;) {</span>
<a href="#l2.723"></a><span id="l2.723" class="difflineplus">+      costFn = calcMaildirCost;</span>
<a href="#l2.724"></a><span id="l2.724" class="difflineplus">+      convertFn = convertTreeMaildirToMBox;</span>
<a href="#l2.725"></a><span id="l2.725" class="difflineplus">+    } else if (srcType == &quot;mbox&quot; &amp;&amp; destType == &quot;maildir&quot;) {</span>
<a href="#l2.726"></a><span id="l2.726" class="difflineplus">+      costFn = calcMBoxCost;</span>
<a href="#l2.727"></a><span id="l2.727" class="difflineplus">+      convertFn = convertTreeMBoxToMaildir;</span>
<a href="#l2.728"></a><span id="l2.728" class="difflineplus">+    } else {</span>
<a href="#l2.729"></a><span id="l2.729" class="difflineplus">+      throw new Error(`Unsupported conversion: ${srcType} =&gt; ${destType}`);</span>
<a href="#l2.730"></a><span id="l2.730">     }</span>
<a href="#l2.731"></a><span id="l2.731"> </span>
<a href="#l2.732"></a><span id="l2.732" class="difflineminus">-    // Should never get here, but the above rules are a little</span>
<a href="#l2.733"></a><span id="l2.733" class="difflineminus">-    // complex. So just in case.</span>
<a href="#l2.734"></a><span id="l2.734" class="difflineminus">-    throw new Error(&quot;Unhandled source: &quot; + sourceFile);</span>
<a href="#l2.735"></a><span id="l2.735" class="difflineplus">+    // Go!</span>
<a href="#l2.736"></a><span id="l2.736" class="difflineplus">+    let totalCost = costFn(srcRoot);</span>
<a href="#l2.737"></a><span id="l2.737" class="difflineplus">+    let v = 0;</span>
<a href="#l2.738"></a><span id="l2.738" class="difflineplus">+    let progressFn = function(n) {</span>
<a href="#l2.739"></a><span id="l2.739" class="difflineplus">+      v += n;</span>
<a href="#l2.740"></a><span id="l2.740" class="difflineplus">+      self.postMessage({&quot;msg&quot;: &quot;progress&quot;, &quot;val&quot;: v, &quot;total&quot;: totalCost});</span>
<a href="#l2.741"></a><span id="l2.741" class="difflineplus">+    };</span>
<a href="#l2.742"></a><span id="l2.742" class="difflineplus">+    convertFn(srcRoot, destRoot, progressFn);</span>
<a href="#l2.743"></a><span id="l2.743"> </span>
<a href="#l2.744"></a><span id="l2.744" class="difflineminus">-  } catch (e) {</span>
<a href="#l2.745"></a><span id="l2.745" class="difflineplus">+    // We fake a final progress update, with exactly 100% completed.</span>
<a href="#l2.746"></a><span id="l2.746" class="difflineplus">+    // Our byte-counting on mbox-&gt;maildir conversion will fall slightly short:</span>
<a href="#l2.747"></a><span id="l2.747" class="difflineplus">+    // The total is estimated from the mbox filesize, but progress is tracked</span>
<a href="#l2.748"></a><span id="l2.748" class="difflineplus">+    // by counting bytes as they are written out - and the mbox &quot;From &quot; lines</span>
<a href="#l2.749"></a><span id="l2.749" class="difflineplus">+    // are _not_ written out to the maildir files.</span>
<a href="#l2.750"></a><span id="l2.750" class="difflineplus">+    // This is still accurate enough to provide progress to the user, but we</span>
<a href="#l2.751"></a><span id="l2.751" class="difflineplus">+    // don't want the GUI left showing &quot;progress 97% - conversion complete!&quot;</span>
<a href="#l2.752"></a><span id="l2.752" class="difflineplus">+    // or anything silly like that.</span>
<a href="#l2.753"></a><span id="l2.753" class="difflineplus">+    self.postMessage({&quot;msg&quot;: &quot;progress&quot;, &quot;val&quot;: totalCost, &quot;total&quot;: totalCost});</span>
<a href="#l2.754"></a><span id="l2.754" class="difflineplus">+</span>
<a href="#l2.755"></a><span id="l2.755" class="difflineplus">+    // Let the main thread know we succeeded.</span>
<a href="#l2.756"></a><span id="l2.756" class="difflineplus">+    self.postMessage({&quot;msg&quot;: &quot;success&quot;});</span>
<a href="#l2.757"></a><span id="l2.757" class="difflineplus">+</span>
<a href="#l2.758"></a><span id="l2.758" class="difflineplus">+  } catch (err) {</span>
<a href="#l2.759"></a><span id="l2.759">     // We try-catch the error because otherwise the error from File.OS is</span>
<a href="#l2.760"></a><span id="l2.760">     // not properly propagated back to the worker error handling.</span>
<a href="#l2.761"></a><span id="l2.761" class="difflineminus">-    throw new Error(e);</span>
<a href="#l2.762"></a><span id="l2.762" class="difflineplus">+    throw new Error(err);</span>
<a href="#l2.763"></a><span id="l2.763">   }</span>
<a href="#l2.764"></a><span id="l2.764"> });</span>
<a href="#l2.765"></a><span id="l2.765" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/util/mailstoreConverter.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/util/mailstoreConverter.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,531 +1,311 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> var EXPORTED_SYMBOLS = [&quot;convertMailStoreTo&quot;, &quot;terminateWorkers&quot;];</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l3.13"></a><span id="l3.13"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.14"></a><span id="l3.14"> ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l3.15"></a><span id="l3.15"> ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l3.16"></a><span id="l3.16"> ChromeUtils.import(&quot;resource://gre/modules/Log.jsm&quot;);</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-var log = Log.repository.getLogger(&quot;MailStoreConverter&quot;);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+let log = Log.repository.getLogger(&quot;MailStoreConverter&quot;);</span>
<a href="#l3.20"></a><span id="l3.20"> log.level = Log.Level.Debug;</span>
<a href="#l3.21"></a><span id="l3.21"> log.addAppender(new Log.DumpAppender(new Log.BasicFormatter()));</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-// Array to hold workers.</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-var gConverterWorkerArray = [];</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+let gConverterWorker = null;</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28"> /**</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">- * Creates &quot;Converter&quot; folder in tmp dir, moves the folder hierarchy of the</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">- * account root folder creating the same folder hierarchy in Converter</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">- * folder in tmp dir, copies the .msf and .dat files to proper places in</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">- * Converter folder, parses the mbox files and creates corresponding folders</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">- * and maildir files in proper places in &quot;Converter&quot; folder and returns a</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">- * promise.</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">- * @param aMailstoreContractId          - account mailstore contract id</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">- * @param {nsIMsgIncominserver} aServer - server for the account</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">- * @param aEventTarget                  - target on which the &quot;progress&quot;</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">- *                                        event will be dispatched</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">- * @return {Promise}                    - new root folder path of the converted</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">- *                                        server.</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+ * Sets a server to use a different type of mailstore, converting</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+ * all the existing data.</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+ *</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+ * @param {String} aMailstoreContractId - XPCOM id of new mailstore type.</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+ * @param {nsIMsgServer} aServer        - server to migrate.</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+ * @param aEventTarget                  - if set, element to send progress events.</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+ *</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+ * @returns {Promise} - Resolves with a string containing the new root</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+ *                     directory for the migrated server.</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+ *                     Rejects with a string error message.</span>
<a href="#l3.51"></a><span id="l3.51">  */</span>
<a href="#l3.52"></a><span id="l3.52"> function convertMailStoreTo(aMailstoreContractId, aServer, aEventTarget) {</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-  // {nsIMsgfolder} account root folder.</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-  var accountRootFolder = aServer.rootFolder.filePath;</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-  // {nsIFile} tmp dir.</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-  var tmpDir = FileUtils.getDir(&quot;TmpD&quot;, [], false);</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-  // Array to hold path to the Converter folder in tmp dir.</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-  var pathArray;</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-  // No. of messages that have been copied in case of a pop account, movemail</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-  // account, Local Folders account or any account with maildir mailstore type</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-  // having at least 1 message.</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-  // No. of files and folders that have been copied in case of a pop account,</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-  // movemail account, Local Folders account or any account with maildir</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-  // mailstore type having 0 messages.</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-  // No. of files and folders that have been copied in case of an imap account</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-  // or an nntp account.</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-  var progressValue = 0;</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-  // No. of files and folders in original account root folder for imap account</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-  // if mailstore type is mbox, or an nntp account.</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-  // No. of files and folders in original account root folder for a pop</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-  // account, Local Folders account or movemail account if no. of msgs is 0</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-  // and mailstore type is mbox.</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-  // No. of files and folders in any non nntp account if no. of msgs is</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-  // 0 and mailstore type is maildir.</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-  // No. of messages in a pop account, Local Folders account or movemail</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-  // account if no. of msgs is more than 0 and mailstore type is mbox.</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-  // No. of messages in any non nntp account if no. of msgs is more than 0 and</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-  // mailstore type is maildir.</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-  var totalCount = 0;</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-  // If there are zero msgs in the account &quot;zeroMessages&quot; is true else it is</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-  // false.</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-  var zeroMessages = false;</span>
<a href="#l3.83"></a><span id="l3.83"> </span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-  // No. of files and folders in original account root folder for imap account.</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-  // We use a progress bar to show the status of the conversion process.</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-  // So, we need a value as the maximum value of the progress bar to measure the</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-  // progress.</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-  // During the conversion there are three kinds of files or folders that can be</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-  // encountered.</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-  // 1. A directory - This simply requires a directory to be created in the right</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-  //                  place. So this a single step.</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-  // 2. A .msf or a .dat file - This simply requires the file to be copied to the</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-  //                            right place. This too is a single step.</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-  // 3. A message file - A message file contains several messages and each one</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-  //                     needs to be copied to a separate file in the right</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-  //                     place. So parsing a parsing a message file consists of</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-  //                     several steps.</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-  //</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-  // So, it's the parsing of message files that is actually time consuming and</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-  // dealing with a directory, .msf, .dat file takes very little time.</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-  //</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-  // So it makes more sense to measure progress as the no. of messages copied.</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-  // But for an imap account, getTotalMessages(true) does not give the no. of</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-  // messages actually present in the account root folder, but gives the no. of</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-  // messages shown on Thunderbird which is less than the no. of messages</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-  // actually present in the account root folder. So can't use that.</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-  //</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-  // But we still need a way to measure progress for an imap account.</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-  // So we measure progress by the total no. of files and folders in the account</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-  // root folder and we increment the value of the progress bar every time a</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-  // .msf, .dat, or a message file or a directory is encountered during</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-  // conversion.</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-  /**</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-   * Count no. of files and folders in the account root folder for imap</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-   * accounts.</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-   * @param {nsIMsgFolder} aFolder - account root folder.</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-   */</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-  var countImapFileFolders = function(aFolder) {</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-    var count = 0;</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-    var contents = aFolder.directoryEntries;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-    while (contents.hasMoreElements()) {</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-      var content = contents.getNext()</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-                            .QueryInterface(Ci.nsIFile);</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-      if (content.isDirectory()) {</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-        // Don't count Windows Search integration dir.</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-        if (content.leafName.substr(-8) != &quot;.mozmsgs&quot;) {</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-          count = count + 1 + countImapFileFolders(content);</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-        }</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-      } else {</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-        count++;</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-      }</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-    }</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-    return count;</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-  }</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-  /**</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-   * Count the no. of msgs in account root folder if the mailstore type is</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-   * maildir.</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-   * @param {nsIMsgFolder} aFolder - account root folder.</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-   */</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-  var countMaildirMsgs = function(aFolder) {</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-    var count = 0;</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-    var contents = aFolder.directoryEntries;</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-    while (contents.hasMoreElements()) {</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-      var content = contents.getNext().QueryInterface(Ci.nsIFile);</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-      if (!content.isDirectory()) {</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-        continue;</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-      }</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-      if (content.leafName.substr(-8) == &quot;.mozmsgs&quot;) {</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-        // Windows Search integration dir. Ignore.</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-        continue;</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-      }</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-      if (content.leafName.substr(-4) == &quot;.sbd&quot;) {</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-        // A subfolder. Recurse into it.</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-        count = count + countMaildirMsgs(content);</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-      } else {</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-        // We assume everything else is an actual maildir, and count the messages.</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-        var cur = FileUtils.File(OS.Path.join(content.path,&quot;cur&quot;));</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-        var curContents = cur.directoryEntries;</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-        while (curContents.hasMoreElements()) {</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-          curContents.getNext();</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-          count++;</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-        }</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-      }</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-    }</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-    return count;</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-  }</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-  /**</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-   * Count the no. of files and folders in account root folder if the mailstore</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-   * type is maildir and the no. of msgs in the account is 0.</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-   * @param {nsIMsgFolder} aFolder - account root folder.</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-   */</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-  var countMaildirZeroMsgs = function(aFolder) {</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-    var count = 0;</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-    var contents = aFolder.directoryEntries;</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-    while (contents.hasMoreElements()) {</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-      var content = contents.getNext().QueryInterface(Ci.nsIFile);</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-      if (!content.isDirectory()) {</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-        count++;</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-      } else if (content.leafName.substr(-4) == &quot;.sbd&quot;) {</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-        // A subfolder. Recurse into it.</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-        count = count + 1 + countMaildirMsgs(content);</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-      } else if (content.leafName.substr(-8) != &quot;.mozmsgs&quot;) {</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-        // Assume any other dir is an actual maildir.</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-        count++;</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-      }</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-    }</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-    return count;</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-  }</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-  var isMaildir = (aMailstoreContractId == &quot;@mozilla.org/msgstore/maildirstore;1&quot;);</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-  var conversionOk; // Resolve callback function.</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-  var conversionFailed; // Reject callback function.</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-  /**</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-   * Moves the folder hierarchy of the account root folder creating the same</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-   * folder hierarchy in Converter folder in tmp dir, copies the .msf</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-   * and .dat files to proper places in Converter folder, parses the mbox</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-   * files and creates corresponding folders and maildir files in proper</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-   * places in &quot;Converter&quot; folder and resolves the promise returned by</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-   * convertmailStoreTo().</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-   *</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-   * @param {nsIFile} aFolder   - account root folder. Folder from where the</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-   *                              files and directories are to be migrated.</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-   * @param {nsIFile} aDestPath - &quot;Converter&quot; folder. Folder into which the</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-   *                              files directories are to be migrated.</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-   */</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-  var subDir = function(aFolder, aDestPath) {</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-    let contents = aFolder.directoryEntries;</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-    // For each file in the source folder...</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-    while (contents.hasMoreElements()) {</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-      let content = contents.getNext()</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-                            .QueryInterface(Ci.nsIFile);</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-      // Data to be passed to the worker. Initially &quot;dataArray&quot; contains</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-      // path of the directory in which the files and directories are to be</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-      // migrated, path of the file or directory encountered, name of the file</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-      // or directory encountered and the mailstore type, path of tmp dir,</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-      // server type.</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-      let dataArray = [</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-        aDestPath.path,</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-        content.path,</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-        content.leafName,</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-        aMailstoreContractId,</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-        tmpDir.path,</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-        aServer.type</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-      ];</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-      if (content.isDirectory()) {</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-        if (content.leafName.substr(-4) != &quot;.sbd&quot; &amp;&amp; content.leafName.substr(-8) != &quot;.mozmsgs&quot;) {</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-          // Assume it's a maildir, and grab the list of messages.</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-          // Array to hold unsorted list of maildir msg filenames.</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-          let dataArrayUnsorted = [];</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-          // &quot;cur&quot; directory inside the maildir msg folder.</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-          let cur = FileUtils.File(OS.Path.join(content.path,&quot;cur&quot;));</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-          // Msg files inside &quot;cur&quot; directory.</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-          let msgs = cur.directoryEntries;</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-          while (msgs.hasMoreElements()) {</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-            // Add filenames as integers into 'dataArrayUnsorted'.</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-            // TODO: this'll break if maildir scheme changes! (eg .eml extension)</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-            let msg = msgs.getNext()</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-                          .QueryInterface(Ci.nsIFile);</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-            dataArrayUnsorted.push(parseInt(msg.leafName));</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-          }</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-          dataArrayUnsorted.sort()</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-          // Add the maildir msg filenames into 'dataArray' in a sorted order.</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-          for (let elem of dataArrayUnsorted) {</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-            dataArray.push(elem.toString());</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-          }</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-        }</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-      }</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-      // Set up the worker.</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-      let converterWorker = new ChromeWorker(</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">-        &quot;resource:///modules/converterWorker.js&quot;);</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineminus">-      gConverterWorkerArray.push(converterWorker);</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">-      log.debug(&quot;Processing &quot; + content.path + &quot; =&gt; : &quot; + aDestPath.path);</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-      converterWorker.addEventListener(&quot;message&quot;, function(e) {</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-        var responseWorker = e.data[0];</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-        log.debug(&quot;Type of file or folder encountered: &quot; + e.data);</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+  let accountRootFolder = aServer.rootFolder.filePath;</span>
<a href="#l3.267"></a><span id="l3.267"> </span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-        // Dispatch the &quot;progress&quot; event on the event target and increment</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-        // &quot;progressValue&quot; every time.</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-        //</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-        // mbox:</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-        // - IMAP: a file or folder is copied.</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-        //   This is because we cannot get the no. of messages actually present</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineminus">-        //   in an imap account so we need some  other way to measure the</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-        //   progress.</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-        // - POP: a msg is copied if the no. of msgs in the account is more than</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-        //   0. A file or folder is copied if the no. of msgs in the account is 0.</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-        // - NNTP: a file or folder is copied.</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-        // - MOVEMAIL: Same as POP.</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-        // - NONE (LOCAL FOLDERS): Same as POP.</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-        //</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-        // maildir:</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-        // - A msg is copied if the no. of msgs in the account is more than 0.</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-        // - A file or folder is copied if the no. of msgs in the account is 0.</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-        let popOrLocalOrMoveMailOrMaildir =</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-           aServer.type == &quot;pop3&quot; || aServer.type == &quot;none&quot; ||</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-           aServer.type == &quot;movemail&quot; || isMaildir;</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-        if (((responseWorker == &quot;copied&quot; || (responseWorker != &quot;copied&quot; &amp;&amp; zeroMessages))</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-                                         &amp;&amp; popOrLocalOrMoveMailOrMaildir)</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-           ||</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">-             (responseWorker != &quot;copied&quot; &amp;&amp; !popOrLocalOrMoveMailOrMaildir)</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineminus">-           ||</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-             (responseWorker != &quot;copied&quot; &amp;&amp; aServer.type == &quot;nntp&quot;)</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-           ) {</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-          progressValue++;</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-          log.debug(&quot;Progress: &quot; + progressValue);</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-          let event = new Event(&quot;progress&quot;);</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-          event.detail = parseInt((progressValue/totalCount) * 100);</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-          aEventTarget.dispatchEvent(event);</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-          if (progressValue == totalCount) {</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-            log.info(&quot;Migration completed. Migrated &quot; + totalCount + &quot; items&quot;);</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineminus">-            // Migration is complete, get path of parent of account root</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-            // folder into &quot;parentPath&quot; check if Converter folder already</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineminus">-            // exists in &quot;parentPath&quot;. If yes, remove it.</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineminus">-            let lastSlash = accountRootFolder.path.lastIndexOf(&quot;/&quot;);</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineminus">-            let parentPath = accountRootFolder.parent.path;</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineminus">-            log.info(&quot;Path to parent folder of account root&quot; +</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineminus">-                     &quot; folder: &quot; + parentPath);</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineminus">-</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-            let parent = new FileUtils.File(parentPath);</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-            log.info(&quot;Path to parent folder of account root folder: &quot; +</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineminus">-              parent.path);</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineminus">-</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-            var converterFolder = new FileUtils.File(OS.Path.join(parent.path,</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineminus">-              dir.leafName));</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineminus">-            if (converterFolder.exists()) {</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineminus">-              log.info(&quot;Converter folder exists in &quot; + parentPath +</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-                       &quot;. Removing already existing folder&quot;);</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-              converterFolder.remove(true);</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-            }</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-            // Move Converter folder into the parent of account root folder.</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-            try {</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineminus">-              dir.moveTo(parent, dir.leafName);</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineminus">-              // {nsIFile} new account root folder.</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineminus">-              var newRootFolder = new FileUtils.File(OS.Path.join(parent.path,</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-                dir.leafName));</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineminus">-              log.info(&quot;Path to new account root folder: &quot; +</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineminus">-                       newRootFolder.path);</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineminus">-            } catch (e) {</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineminus">-              // Cleanup.</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineminus">-              log.error(e);</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-              var newRootFolder = new FileUtils.File(OS.Path.join(parent.path,</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-                dir.leafName));</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-              log.error(&quot;Trying to remove converter folder: &quot; +</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineminus">-                newRootFolder.path);</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineminus">-              newRootFolder.remove(true);</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineminus">-              conversionFailed(e);</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineminus">-            }</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineminus">-</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineminus">-            // If the account is imap then copy the msf file for the original</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineminus">-            // root folder and rename the copy with the name of the new root</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineminus">-            // folder.</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineminus">-            if (aServer.type != &quot;pop3&quot; &amp;&amp; aServer.type != &quot;none&quot; &amp;&amp;</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineminus">-              aServer.type != &quot;movemail&quot;) {</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineminus">-              let converterFolderMsf = new FileUtils.File(OS.Path.join(</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineminus">-                parent.path,dir.leafName + &quot;.msf&quot;));</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">-              if (converterFolderMsf.exists()) {</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">-                converterFolderMsf.remove(true);</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-              }</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineminus">-</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineminus">-              let oldRootFolderMsf = new FileUtils.File(OS.Path.join(</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineminus">-                parent.path,accountRootFolder.leafName + &quot;.msf&quot;));</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineminus">-              if (oldRootFolderMsf.exists()) {</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineminus">-                oldRootFolderMsf.copyTo(parent, converterFolderMsf.leafName);</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineminus">-              }</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineminus">-            }</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineminus">-</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineminus">-            if (aServer.type == &quot;nntp&quot;) {</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineminus">-              let converterFolderNewsrc = new FileUtils.File(OS.Path.join(</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineminus">-                parent.path,&quot;newsrc-&quot; + dir.leafName));</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineminus">-              if (converterFolderNewsrc.exists()) {</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineminus">-                converterFolderNewsrc.remove(true);</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineminus">-              }</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-              let oldNewsrc = new FileUtils.File(OS.Path.join(parent.path,</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineminus">-                &quot;newsrc-&quot; + accountRootFolder.leafName));</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineminus">-              if (oldNewsrc.exists()) {</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineminus">-                oldNewsrc.copyTo(parent, converterFolderNewsrc.leafName);</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineminus">-              }</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineminus">-            }</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineminus">-</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineminus">-            aServer.rootFolder.filePath = newRootFolder;</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineminus">-            aServer.localPath = newRootFolder;</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineminus">-            log.info(&quot;Path to account root folder: &quot; +</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineminus">-                     aServer.rootFolder.filePath.path);</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-            // Set various preferences.</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineminus">-            let p1 = &quot;mail.server.&quot; + aServer.key + &quot;.directory&quot;;</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">-            let p2 = &quot;mail.server.&quot; + aServer.key + &quot;.directory-rel&quot;;</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineminus">-            let p3 = &quot;mail.server.&quot; + aServer.key + &quot;.newsrc.file&quot;;</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineminus">-            let p4 = &quot;mail.server.&quot; + aServer.key + &quot;.newsrc.file-rel&quot;;</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineminus">-            let p5 = &quot;mail.server.&quot; + aServer.key + &quot;.storeContractID&quot;;</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineminus">-            Services.prefs.setCharPref(p1, newRootFolder.path);</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineminus">-            log.info(p1 + &quot;: &quot; + newRootFolder.path)</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineminus">-</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineminus">-            // The directory-rel pref is of the form &quot;[ProfD]Mail/pop.gmail.com</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineminus">-            // &quot; (pop accounts) or &quot;[ProfD]ImapMail/imap.gmail.com&quot; (imap</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineminus">-            // accounts) ie the last slash &quot;/&quot; is followed by the root folder</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineminus">-            // name. So, replace the old root folder name that follows the last</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineminus">-            // slash with the new root folder name to set the correct value of</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineminus">-            // directory-rel pref.</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineminus">-            let directoryRel = Services.prefs.getCharPref(p2);</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineminus">-            lastSlash = directoryRel.lastIndexOf(&quot;/&quot;);</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineminus">-            directoryRel = directoryRel.slice(0, lastSlash) + &quot;/&quot; +</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineminus">-                                              newRootFolder.leafName;</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineminus">-            Services.prefs.setCharPref(p2, directoryRel);</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineminus">-            log.info(p2 + &quot;: &quot; + directoryRel);</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineminus">-</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineminus">-            if (aServer.type == &quot;nntp&quot;) {</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineminus">-              let newNewsrc = FileUtils.File(OS.Path.join(parent.path,</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineminus">-                &quot;newsrc-&quot; + newRootFolder.leafName));</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineminus">-              Services.prefs.setCharPref(p3, newNewsrc.path);</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineminus">-</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineminus">-              // The newsrc.file-rel pref is of the form &quot;[ProfD]News/newsrc-</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-              // news.mozilla.org&quot; ie the last slash &quot;/&quot; is followed by the</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineminus">-              // newsrc file name. So, replace the old newsrc file name that</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineminus">-              // follows the last slash with the new newsrc file name to set</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-              // the correct value of newsrc.file-rel pref.</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineminus">-              let newsrcRel = Services.prefs.getCharPref(p4);</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineminus">-              lastSlash = newsrcRel.lastIndexOf(&quot;/&quot;);</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-              newsrcRel = newsrcRel.slice(0, lastSlash) + &quot;/&quot; +</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-                                          newNewsrc.leafName;</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-              Services.prefs.setCharPref(p4, newsrcRel);</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-              log.info(p4 + &quot;: &quot; + newsrcRel);</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineminus">-            }</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineminus">-</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineminus">-            Services.prefs.setCharPref(p5, isMaildir ?</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-              &quot;@mozilla.org/msgstore/berkeleystore;1&quot; :</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-              &quot;@mozilla.org/msgstore/maildirstore;1&quot;);</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineminus">-            Services.prefs.savePrefFile(null);</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineminus">-            log.info(&quot;Conversion done!&quot;);</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineminus">-</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineminus">-            // Resolve the promise with the path of the new account root</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineminus">-            // folder.</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineminus">-            conversionOk(newRootFolder.path);</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineminus">-          }</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineminus">-        }</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-      });</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineminus">-</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineminus">-      converterWorker.addEventListener(&quot;error&quot;, function(e) {</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-        let reasonString =</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineminus">-          &quot;Error at &quot; + e.filename + &quot;:&quot; + e.lineno + &quot; - &quot; +  e.message;</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineminus">-        log.error(reasonString);</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineminus">-        terminateWorkers();</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineminus">-        // Cleanup.</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineminus">-        log.error(&quot;Trying to remove converter folder: &quot; +</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineminus">-          aDestPath.path);</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineminus">-        aDestPath.remove(true);</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineminus">-        conversionFailed(e.message);</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineminus">-      });</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineminus">-</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineminus">-      // Kick off the worker.</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineminus">-      converterWorker.postMessage(dataArray);</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineminus">-</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineminus">-      if (content.isDirectory()) {</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineminus">-        if (content.leafName.substr(-4) == &quot;.sbd&quot;) {</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-          let dirNew = new FileUtils.File(OS.Path.join(aDestPath.path,</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineminus">-            content.leafName));</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-          subDir(content, dirNew);</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-        }</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineminus">-      }</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineminus">-    }</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineplus">+  let srcType = null;</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineplus">+  let destType = null;</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineplus">+  if (aMailstoreContractId == &quot;@mozilla.org/msgstore/maildirstore;1&quot;) {</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineplus">+    srcType = &quot;maildir&quot;;</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineplus">+    destType = &quot;mbox&quot;;</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineplus">+  } else {</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineplus">+    srcType = &quot;mbox&quot;;</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+    destType = &quot;maildir&quot;;</span>
<a href="#l3.465"></a><span id="l3.465">   }</span>
<a href="#l3.466"></a><span id="l3.466"> </span>
<a href="#l3.467"></a><span id="l3.467" class="difflineminus">-  /**</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineminus">-   * Checks if Converter folder exists in tmp dir, removes it and creates a new</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineminus">-   * &quot;Converter&quot; folder.</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineminus">-   * @param {nsIFile} aFolder - account root folder.</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-   */</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineminus">-  var createTmpConverterFolder = function(aFolder) {</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineminus">-    let tmpFolder;</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineminus">-    switch (aMailstoreContractId) {</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-      case &quot;@mozilla.org/msgstore/maildirstore;1&quot;: {</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineminus">-        if (aFolder.leafName.substr(-8) == &quot;-maildir&quot;) {</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineminus">-          tmpFolder = new FileUtils.File(OS.Path.join(tmpDir.path,</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineminus">-            aFolder.leafName.substr(0, aFolder.leafName.length - 8) + &quot;-mbox&quot;));</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineminus">-        } else {</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineminus">-          tmpFolder = new FileUtils.File(OS.Path.join(tmpDir.path,</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineminus">-            aFolder.leafName + &quot;-mbox&quot;));</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineminus">-        }</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineminus">-</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineminus">-        if (tmpFolder.exists()) {</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineminus">-          log.info(&quot;Temporary Converter folder &quot; + tmpFolder.path +</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineminus">-                   &quot;exists in tmp dir. Removing it&quot;);</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineminus">-          tmpFolder.remove(true);</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineminus">-        }</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineminus">-        return FileUtils.getDir(&quot;TmpD&quot;, [tmpFolder.leafName], true);</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineminus">-      }</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineminus">-</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-      case &quot;@mozilla.org/msgstore/berkeleystore;1&quot;: {</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineminus">-        if (aFolder.leafName.substr(-5) == &quot;-mbox&quot;) {</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-          tmpFolder = new FileUtils.File(OS.Path.join(tmpDir.path,</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineminus">-            aFolder.leafName.substr(0, aFolder.leafName.length - 5) +</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineminus">-              &quot;-maildir&quot;));</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineminus">-        } else {</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineminus">-          tmpFolder = new FileUtils.File(OS.Path.join(tmpDir.path,</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineminus">-            aFolder.leafName + &quot;-maildir&quot;));</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineminus">-        }</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineminus">-</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineminus">-        if (tmpFolder.exists()) {</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineminus">-          log.info(&quot;Temporary Converter folder &quot; + tmpFolder.path +</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineminus">-                   &quot;exists in tmp dir. Removing it&quot;);</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineminus">-          tmpFolder.remove(true);</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineminus">-        }</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineminus">-        return FileUtils.getDir(&quot;TmpD&quot;, [tmpFolder.leafName], true);</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineminus">-      }</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineminus">-</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineminus">-      default: {</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineminus">-        throw new Error(&quot;Unexpected mailstoreContractId: &quot; +</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineminus">-                        aMailstoreContractId);</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineminus">-      }</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineminus">-    }</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineminus">-  }</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineminus">-</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineminus">-  if (isMaildir &amp;&amp; aServer.type != &quot;nntp&quot;) {</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineminus">-</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineminus">-    // TODO: why can't maildir count use aServer.rootFolder.getTotalMessages(true)?</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineminus">-    totalCount = countMaildirMsgs(accountRootFolder);</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineminus">-    if (totalCount == 0) {</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineminus">-      totalCount = countMaildirZeroMsgs(accountRootFolder);</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineminus">-      zeroMessages = true;</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineminus">-    }</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineminus">-  } else if (aServer.type == &quot;pop3&quot; ||</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineminus">-             aServer.type == &quot;none&quot; || // none: Local Folders.</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-             aServer.type == &quot;movemail&quot;) {</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineminus">-    totalCount = aServer.rootFolder.getTotalMessages(true);</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineminus">-    if (totalCount == 0) {</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineminus">-      totalCount = countImapFileFolders(accountRootFolder);</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineminus">-      zeroMessages = true;</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineminus">-    }</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineminus">-  } else if (aServer.type == &quot;imap&quot; || aServer.type == &quot;nntp&quot;) {</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineminus">-    totalCount = countImapFileFolders(accountRootFolder);</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineminus">-  }</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineminus">-  log.debug(&quot;totalCount = &quot; + totalCount + &quot; (zeroMessages = &quot; + zeroMessages + &quot;)&quot;);</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineminus">-</span>
<a href="#l3.538"></a><span id="l3.538">   // Go offline before conversion, so there aren't messages coming in during</span>
<a href="#l3.539"></a><span id="l3.539">   // the process.</span>
<a href="#l3.540"></a><span id="l3.540">   Services.io.offline = true;</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineminus">-  let dir = createTmpConverterFolder(accountRootFolder);</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineplus">+  let destDir = createTmpConverterFolder(accountRootFolder, aMailstoreContractId);</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineplus">+</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineplus">+  // Return a promise that will complete once the worker is done.</span>
<a href="#l3.545"></a><span id="l3.545">   return new Promise(function(resolve, reject) {</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineminus">-    conversionOk = resolve;</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineminus">-    conversionFailed = reject;</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineminus">-    subDir(accountRootFolder, dir);</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineplus">+</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineplus">+    let worker = new ChromeWorker(&quot;resource:///modules/converterWorker.js&quot;);</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineplus">+    gConverterWorker = worker;</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineplus">+</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineplus">+    // Helper to log error, clean up and return failure.</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineplus">+    let bailout = function(e) {</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineplus">+      let reasonString =</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineplus">+        &quot;ERROR &quot; + e.filename + &quot;:&quot; + e.lineno + &quot; - &quot; + e.message;</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineplus">+      log.error(reasonString);</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineplus">+      // Cleanup.</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineplus">+      log.error(&quot;Trying to remove converter folder: &quot; + destDir.path);</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineplus">+      destDir.remove(true);</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineplus">+      reject(e.message);</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineplus">+    };</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineplus">+</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineplus">+    // Handle exceptions thrown by the worker thread.</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineplus">+    worker.addEventListener(&quot;error&quot;, bailout);</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineplus">+</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineplus">+    // Handle updates from the worker thread.</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineplus">+    worker.addEventListener(&quot;message&quot;, function(e) {</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineplus">+      let response = e.data;</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineplus">+      // log.debug(&quot;WORKER SAYS: &quot; + JSON.stringify(response) + &quot;\n&quot;);</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineplus">+      if (response.msg == &quot;progress&quot;) {</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineplus">+        let val = response.val;</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineplus">+        let total = response.total;</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineplus">+</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineplus">+        // Send the percentage completion to the GUI.</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineplus">+        // XXX TODO: should probably check elapsed time, and throttle</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineplus">+        // the events to avoid spending all our time drawing!</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineplus">+        let ev = new Event(&quot;progress&quot;);</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineplus">+        ev.detail = parseInt((val / total) * 100);</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineplus">+        if (aEventTarget) {</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineplus">+          aEventTarget.dispatchEvent(ev);</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineplus">+        }</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineplus">+      }</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineplus">+      if (response.msg == &quot;success&quot;) {</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineplus">+        // If we receive this, the worker has completed, without errors.</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineplus">+        let storeTypeIDs = {</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineplus">+          &quot;mbox&quot;: &quot;@mozilla.org/msgstore/berkeleystore;1&quot;,</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineplus">+          &quot;maildir&quot;: &quot;@mozilla.org/msgstore/maildirstore;1&quot;,</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineplus">+        };</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineplus">+        let newStoreTypeID = storeTypeIDs[destType];</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineplus">+</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineplus">+        try {</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineplus">+          let finalRoot = installNewRoot(aServer, destDir, newStoreTypeID);</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineplus">+          log.info(&quot;Conversion complete. Converted dir installed as: &quot; + finalRoot);</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineplus">+          resolve(finalRoot);</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineplus">+        } catch (e) {</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineplus">+          bailout(e);</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineplus">+        }</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineplus">+      }</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineplus">+    });</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineplus">+</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineplus">+    // Kick off the worker.</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineplus">+    worker.postMessage({</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineplus">+      &quot;srcType&quot;: srcType,</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineplus">+      &quot;destType&quot;: destType,</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineplus">+      &quot;srcRoot&quot;: accountRootFolder.path,</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineplus">+      &quot;destRoot&quot;: destDir.path,</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineplus">+    });</span>
<a href="#l3.609"></a><span id="l3.609">   });</span>
<a href="#l3.610"></a><span id="l3.610"> }</span>
<a href="#l3.611"></a><span id="l3.611"> </span>
<a href="#l3.612"></a><span id="l3.612"> /**</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineminus">- * Terminate all workers.</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineplus">+ * Checks if Converter folder exists in tmp dir, removes it and creates a new</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineplus">+ * &quot;Converter&quot; folder.</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineplus">+ * @param {nsIFile} aFolder             - account root folder.</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineplus">+ * @param {String} aMailstoreContractId - XPCOM id of dest mailstore type</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineplus">+ *</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineplus">+ * @returns {nsIFile} - the new tmp directory to use as converter dest.</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineplus">+ */</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineplus">+function createTmpConverterFolder(aFolder, aMailstoreContractId) {</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineplus">+  let tmpDir = FileUtils.getDir(&quot;TmpD&quot;, [], false);</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineplus">+  let tmpFolder;</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineplus">+  switch (aMailstoreContractId) {</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineplus">+    case &quot;@mozilla.org/msgstore/maildirstore;1&quot;: {</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineplus">+      if (aFolder.leafName.substr(-8) == &quot;-maildir&quot;) {</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineplus">+        tmpFolder = new FileUtils.File(OS.Path.join(tmpDir.path,</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineplus">+          aFolder.leafName.substr(0, aFolder.leafName.length - 8) + &quot;-mbox&quot;));</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineplus">+      } else {</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineplus">+        tmpFolder = new FileUtils.File(OS.Path.join(tmpDir.path,</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineplus">+          aFolder.leafName + &quot;-mbox&quot;));</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineplus">+      }</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineplus">+</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineplus">+      if (tmpFolder.exists()) {</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineplus">+        log.info(&quot;Temporary Converter folder &quot; + tmpFolder.path +</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineplus">+                  &quot; exists in tmp dir. Removing it&quot;);</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineplus">+        tmpFolder.remove(true);</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineplus">+      }</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineplus">+      return FileUtils.getDir(&quot;TmpD&quot;, [tmpFolder.leafName], true);</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineplus">+    }</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineplus">+</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineplus">+    case &quot;@mozilla.org/msgstore/berkeleystore;1&quot;: {</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineplus">+      if (aFolder.leafName.substr(-5) == &quot;-mbox&quot;) {</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineplus">+        tmpFolder = new FileUtils.File(OS.Path.join(tmpDir.path,</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineplus">+          aFolder.leafName.substr(0, aFolder.leafName.length - 5) +</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineplus">+            &quot;-maildir&quot;));</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineplus">+      } else {</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineplus">+        tmpFolder = new FileUtils.File(OS.Path.join(tmpDir.path,</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineplus">+          aFolder.leafName + &quot;-maildir&quot;));</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineplus">+      }</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineplus">+</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineplus">+      if (tmpFolder.exists()) {</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineplus">+        log.info(&quot;Temporary Converter folder &quot; + tmpFolder.path +</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineplus">+                  &quot;exists in tmp dir. Removing it&quot;);</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineplus">+        tmpFolder.remove(true);</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineplus">+      }</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineplus">+      return FileUtils.getDir(&quot;TmpD&quot;, [tmpFolder.leafName], true);</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineplus">+    }</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineplus">+</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineplus">+    default: {</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineplus">+      throw new Error(&quot;Unexpected mailstoreContractId: &quot; +</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineplus">+                      aMailstoreContractId);</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineplus">+    }</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineplus">+  }</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineplus">+}</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineplus">+</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineplus">+</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineplus">+/**</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineplus">+ * Switch server over to use the newly-converted directory tree.</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineplus">+ * Moves the converted directory into an appropriate place for the server.</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineplus">+ *</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineplus">+ * @param {nsIMsgServer} server   - server to migrate.</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineplus">+ * @param {String} dir            - dir of converted mailstore to install</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineplus">+ *                                  (will be moved by this function).</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineplus">+ * @param {String} newStoreTypeID - XPCOM id of new mailstore type.</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineplus">+ * @returns {String} new location of dir.</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineplus">+ */</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineplus">+function installNewRoot(server, dir, newStoreTypeID) {</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineplus">+  let accountRootFolder = server.rootFolder.filePath;</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineplus">+</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineplus">+  // Migration is complete, get path of parent of account root</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineplus">+  // folder into &quot;parentPath&quot; check if Converter folder already</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineplus">+  // exists in &quot;parentPath&quot;. If yes, remove it.</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineplus">+  let lastSlash = accountRootFolder.path.lastIndexOf(&quot;/&quot;);</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineplus">+  let parentPath = accountRootFolder.parent.path;</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineplus">+  log.info(&quot;Path to parent folder of account root&quot; +</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineplus">+            &quot; folder: &quot; + parentPath);</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineplus">+</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineplus">+  let parent = new FileUtils.File(parentPath);</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineplus">+  log.info(&quot;Path to parent folder of account root folder: &quot; +</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineplus">+    parent.path);</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineplus">+</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineplus">+  let converterFolder = new FileUtils.File(OS.Path.join(parent.path,</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineplus">+    dir.leafName));</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineplus">+  if (converterFolder.exists()) {</span>
<a href="#l3.696"></a><span id="l3.696" class="difflineplus">+    log.info(&quot;Converter folder exists in &quot; + parentPath +</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineplus">+              &quot;. Removing already existing folder&quot;);</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineplus">+    converterFolder.remove(true);</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineplus">+  }</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineplus">+</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineplus">+  // Move Converter folder into the parent of account root folder.</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineplus">+  try {</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineplus">+    dir.moveTo(parent, dir.leafName);</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineplus">+    // {nsIFile} new account root folder.</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineplus">+    log.info(&quot;Path to new account root folder: &quot; +</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineplus">+              converterFolder.path);</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineplus">+  } catch (e) {</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineplus">+    // Cleanup.</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineplus">+    log.error(e);</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineplus">+    log.error(&quot;Trying to remove converter folder: &quot; +</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineplus">+      converterFolder.path);</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineplus">+    converterFolder.remove(true);</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineplus">+    throw e;</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineplus">+  }</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineplus">+</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineplus">+  // If the account is imap then copy the msf file for the original</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineplus">+  // root folder and rename the copy with the name of the new root</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineplus">+  // folder.</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineplus">+  if (server.type != &quot;pop3&quot; &amp;&amp; server.type != &quot;none&quot; &amp;&amp;</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineplus">+    server.type != &quot;movemail&quot;) {</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineplus">+    let converterFolderMsf = new FileUtils.File(OS.Path.join(</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineplus">+      parent.path, dir.leafName + &quot;.msf&quot;));</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineplus">+    if (converterFolderMsf.exists()) {</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineplus">+      converterFolderMsf.remove(true);</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineplus">+    }</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineplus">+</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineplus">+    let oldRootFolderMsf = new FileUtils.File(OS.Path.join(</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineplus">+      parent.path, accountRootFolder.leafName + &quot;.msf&quot;));</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineplus">+    if (oldRootFolderMsf.exists()) {</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineplus">+      oldRootFolderMsf.copyTo(parent, converterFolderMsf.leafName);</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineplus">+    }</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineplus">+  }</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineplus">+</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineplus">+  if (server.type == &quot;nntp&quot;) {</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineplus">+    let converterFolderNewsrc = new FileUtils.File(OS.Path.join(</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineplus">+      parent.path, &quot;newsrc-&quot; + dir.leafName));</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineplus">+    if (converterFolderNewsrc.exists()) {</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineplus">+      converterFolderNewsrc.remove(true);</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineplus">+    }</span>
<a href="#l3.740"></a><span id="l3.740" class="difflineplus">+    let oldNewsrc = new FileUtils.File(OS.Path.join(parent.path,</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineplus">+      &quot;newsrc-&quot; + accountRootFolder.leafName));</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineplus">+    if (oldNewsrc.exists()) {</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineplus">+      oldNewsrc.copyTo(parent, converterFolderNewsrc.leafName);</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineplus">+    }</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineplus">+  }</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineplus">+</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineplus">+  server.rootFolder.filePath = converterFolder;</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineplus">+  server.localPath = converterFolder;</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineplus">+  log.info(&quot;Path to account root folder: &quot; +</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineplus">+            server.rootFolder.filePath.path);</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineplus">+</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineplus">+  // Set various preferences.</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineplus">+  let p1 = &quot;mail.server.&quot; + server.key + &quot;.directory&quot;;</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineplus">+  let p2 = &quot;mail.server.&quot; + server.key + &quot;.directory-rel&quot;;</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineplus">+  let p3 = &quot;mail.server.&quot; + server.key + &quot;.newsrc.file&quot;;</span>
<a href="#l3.756"></a><span id="l3.756" class="difflineplus">+  let p4 = &quot;mail.server.&quot; + server.key + &quot;.newsrc.file-rel&quot;;</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineplus">+  let p5 = &quot;mail.server.&quot; + server.key + &quot;.storeContractID&quot;;</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineplus">+</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineplus">+  Services.prefs.setCharPref(p1, converterFolder.path);</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineplus">+  log.info(p1 + &quot;: &quot; + converterFolder.path);</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineplus">+</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineplus">+  // The directory-rel pref is of the form &quot;[ProfD]Mail/pop.gmail.com</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineplus">+  // &quot; (pop accounts) or &quot;[ProfD]ImapMail/imap.gmail.com&quot; (imap</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineplus">+  // accounts) ie the last slash &quot;/&quot; is followed by the root folder</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineplus">+  // name. So, replace the old root folder name that follows the last</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineplus">+  // slash with the new root folder name to set the correct value of</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineplus">+  // directory-rel pref.</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineplus">+  let directoryRel = Services.prefs.getCharPref(p2);</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineplus">+  lastSlash = directoryRel.lastIndexOf(&quot;/&quot;);</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineplus">+  directoryRel = directoryRel.slice(0, lastSlash) + &quot;/&quot; +</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineplus">+                                    converterFolder.leafName;</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineplus">+  Services.prefs.setCharPref(p2, directoryRel);</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineplus">+  log.info(p2 + &quot;: &quot; + directoryRel);</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineplus">+</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineplus">+  if (server.type == &quot;nntp&quot;) {</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineplus">+    let newNewsrc = FileUtils.File(OS.Path.join(parent.path,</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineplus">+      &quot;newsrc-&quot; + converterFolder.leafName));</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineplus">+    Services.prefs.setCharPref(p3, newNewsrc.path);</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineplus">+</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineplus">+    // The newsrc.file-rel pref is of the form &quot;[ProfD]News/newsrc-</span>
<a href="#l3.781"></a><span id="l3.781" class="difflineplus">+    // news.mozilla.org&quot; ie the last slash &quot;/&quot; is followed by the</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineplus">+    // newsrc file name. So, replace the old newsrc file name that</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineplus">+    // follows the last slash with the new newsrc file name to set</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineplus">+    // the correct value of newsrc.file-rel pref.</span>
<a href="#l3.785"></a><span id="l3.785" class="difflineplus">+    let newsrcRel = Services.prefs.getCharPref(p4);</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineplus">+    lastSlash = newsrcRel.lastIndexOf(&quot;/&quot;);</span>
<a href="#l3.787"></a><span id="l3.787" class="difflineplus">+    newsrcRel = newsrcRel.slice(0, lastSlash) + &quot;/&quot; +</span>
<a href="#l3.788"></a><span id="l3.788" class="difflineplus">+                                newNewsrc.leafName;</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineplus">+    Services.prefs.setCharPref(p4, newsrcRel);</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineplus">+    log.info(p4 + &quot;: &quot; + newsrcRel);</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineplus">+  }</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineplus">+</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineplus">+  Services.prefs.setCharPref(p5, newStoreTypeID);</span>
<a href="#l3.794"></a><span id="l3.794" class="difflineplus">+</span>
<a href="#l3.795"></a><span id="l3.795" class="difflineplus">+  Services.prefs.savePrefFile(null);</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineplus">+</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineplus">+  return converterFolder.path;</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineplus">+}</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineplus">+</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineplus">+/**</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineplus">+ * Terminate any workers involved in the conversion process.</span>
<a href="#l3.802"></a><span id="l3.802">  */</span>
<a href="#l3.803"></a><span id="l3.803"> function terminateWorkers() {</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineminus">-  for (let worker of gConverterWorkerArray) {</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineminus">-    worker.terminate();</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineplus">+  // We're only using a single worker right now.</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineplus">+  if (gConverterWorker !== null) {</span>
<a href="#l3.808"></a><span id="l3.808" class="difflineplus">+    gConverterWorker.terminate();</span>
<a href="#l3.809"></a><span id="l3.809" class="difflineplus">+    gConverterWorker = null;</span>
<a href="#l3.810"></a><span id="l3.810">   }</span>
<a href="#l3.811"></a><span id="l3.811"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mailnews/test/data/mbox_mboxrd</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+From MAILER-DAEMON Fri Jul  8 12:08:34 2011</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+From: Author &lt;author@example.com&gt;</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+To: Recipient &lt;recipient@example.com&gt;</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+Subject: Sample message 1</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+This is the body.</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+&gt;From (should be escaped).</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+There are 3 lines.</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+From MAILER-DAEMON Fri Jul  8 12:08:34 2011</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+From: Author &lt;author@example.com&gt;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+To: Recipient &lt;recipient@example.com&gt;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+Subject: Sample message 2</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+This is the second body.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mailnews/test/data/mbox_modern</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,20 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+From - Fri Aug 24 11:55:47 2018</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+From: Author &lt;author@example.com&gt;</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+To: Recipient &lt;recipient@example.com&gt;</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+Subject: Sample message 1</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+Date: Fri, 24 Aug 2018 11:55:47 +0000</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+Later versions of Thunderbird quote things by prefixing</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+a space,like this:</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+ From </span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+ From - Fri Aug 24 11:55:47 2018</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+This could cause problems, if a reader decides to split the message</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+here.</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+From - Thu Aug 23 09:10:23 2018</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+From: Author &lt;author@example.com&gt;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+To: Recipient &lt;recipient@example.com&gt;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+Subject: Sample message 2</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+Date: Thu, 23 Aug 2018 09:10:23 +0000</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+This is the second body.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mailnews/test/data/mbox_unquoted</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,18 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+From </span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+From: Author &lt;author@example.com&gt;</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+To: Recipient &lt;recipient@example.com&gt;</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+Subject: Sample message 1</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+Date: Wed, 22 Aug 2005 17:20:08 +0000</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+Earlier versions of Thunderbird don't seem to quote things like this:</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+From </span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+This could cause problems, if a reader decides to split the message</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+here.</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+From </span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+From: Author &lt;author@example.com&gt;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+To: Recipient &lt;recipient@example.com&gt;</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+Subject: Sample message 2</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+Date: Thu, 23 Aug 2005 11:17:43 +0000</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+This is the second body.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/test/data/readme.txt</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/test/data/readme.txt</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -54,8 +54,50 @@ This is a file which is known as the MIM</span>
<a href="#l7.4"></a><span id="l7.4"> nested multipart/* and message/* segments; as its explanation describes:</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6">   This is a demonstration of multi-part mail with encapsulated messages.  This</span>
<a href="#l7.7"></a><span id="l7.7">   is a very complex message whose purpose it is to exercise software using the</span>
<a href="#l7.8"></a><span id="l7.8">   new multi-part message standard.</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10"> The original source of this file is unknown, but a copy can be found at</span>
<a href="#l7.11"></a><span id="l7.11"> &lt;http://sourceforge.net/projects/kmmail/files/MIME%20Torture%20Tests/&gt;.</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+mbox_modern</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+-----------</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+A simple mbox in the form that Thunderbird currently seems to save (as</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+of Nov 2018).</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+Separator lines are of the form:</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+From - Fri Aug 24 11:55:47 2018</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+Lines beginning with &quot;From &quot; within the message body are escaped</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+by prefixing a space.</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+mbox_unquoted</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+-------------</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+Old-style mbox. This seems to be what Thunderbird was storing back around</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+2005, and so there are likely to be a bunch of these out in the wild.</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+Separator lines are lines containing only: &quot;From &quot;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+Lines within the message body beginning with &quot;From &quot; are not escaped in</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+any way.</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+mbox_mboxrd</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+-----------</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+Example of the mboxrd variant, taken from the wikipedia mbox page.</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+Separator lines are of the form:</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+From MAILER-DAEMON Fri Jul  8 12:08:34 2011</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+(note that MAILER-DAEMON is a special case - this is where an</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+email address usually goes, but MAILER-DAEMON can be used instead).</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+&quot;From &quot; lines within the message body are escaped by prefixing with</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+a '&gt;' char.</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

